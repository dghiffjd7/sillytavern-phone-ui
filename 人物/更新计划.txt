v0.1
群聊 ✔
v0.2
动态✔
v0.3
流式+定时
v0.4
交互
v0.5
手机

这个项目是在完成一个通过Silly Tavern加载的手机前端页面，而现在的任务为给这个前端页面debug、增加功能以及优化。
你可以通过BrowserTools MCP查看目前Silly Tavern的页面和console。*注意不要使用别的Browser MCP*
关于Silly Tavern的世界书相关逻辑可以参考，关于其他方面可参考，并请详细阅读cursorrules。
首先需要解决：
1.
更改完后可通过git add . git commit git push进行更新
且在更新之后，我会自己测试。
请注意要修改的文件为手机-动态1.html，其他版本不要做任何更动。


npx @agentdeskai/browser-tools-server@latest 




可能要维修的bug：
更改群名称‘港区’消失
回复时，第二个群聊没有红点（多群组待测试）


我们之前有添加类似这样的逻辑，比如AI回传’使用者和角色的聊天/私聊‘即为正常私聊，而出现角色和角色之间的对话，如’角色和角色的聊天/私聊‘则创建一个名称为’角色和角色的私聊‘的**私聊界面**。
以及众多调用QQ_Msg_Parse的地方，为什么会调用多次？这些调用有什么区别？可不可以统一直接防止重复调用的问题？

现在经过我和其他使用者的测试下来，我们的优先级处理逻辑似乎还有些没有达到标准。首先注意我们互动内容的状况，先是发送给AI的请求，在使用者没有打开关键词检测且没有发送&&这个特殊符号的时候，我们发送给AI的请求就
绝对是请求线上格式，而不会请求任何互动内容。但是现在有时候我们没有输入&&的时候，似乎还是会发送互动请求。以及在收到AI回复的处理当中，我们这套优先级逻辑旨在于只要AI不是空回复，我们就能够处理任何完全或不完全
标签的回复，我们的模糊匹配不成功的情况下的提取有效内容，是只要AI回复的content当中有任何有效的聊天/群聊/动态/评论讯息，不管多少都提取出来输出到对应的界面当中，但是现在还是很常发生AI回复多格式或不符合线上格式
就直接重新发送请求了，这些情况应该落到提取有效消息或模糊匹配上，确保我们每一次发送请求回复的内容都能够被提取出来，不浪费。

这个项目是在完成一个通过Silly Tavern加载的手机前端页面，而现在的任务为给这个前端页面debug、增加功能以及优化。
请留意酒馆之间自带的特殊机制，如预设、世界书、表格插件扩展等等
在开发的过程中请牢记，在每次进行更改前，请详细检查整个文件，找出问题的源头并进行解决，而不是添加可能出现更多问题的临时补丁，并且请注意以下核心逻辑*非常重要！*。
请牢记我们处理AI回复等状况的逻辑：
1. 使用者发送讯息状况：
在使用者没有发送特殊符号&&以及没有开启互动内容检测关键词设定或开启了但没有发送包含关键词的讯息时：
    a. 发送私聊--请求私聊回复以及一定概率群聊及动态回复
    b. 发送群聊--请求群聊回复以及一定概率私聊及动态回复
    c. 发送动态评论--请求动态评论回复及私聊或群聊深入讨论
请确保私聊的独立性，在使用者向角色发送私聊时，如果角色没有将该讯息分享出去（群聊或动态），则其他角色是不会知道也看不到这些讯息的。
使用者发送&&或开启互动关键词检测并发送包含关键词的讯息--先请求当下页面的简短回复（如使用者在私聊中发送互动请求，则该角色会先通过私聊发送简短讯息回复。动态则是在动态评论中简短回复。）然后直接请求回复互动内容
2. 非互动内容AI回复消息后我们的处理方式：
    A. 先判断是否符合线上格式
        a. 符合：直接提取并清理多余标签（consider、thinking等等）后输出所有有效内容，分别放入各界面。（有效内容包含：使用者和角色的私聊、群聊、动态/评论、角色和角色的私聊、AI新创建的群组等等）
        b. 不符合：先尝试模糊匹配，若匹配不成功再尝试提取有效内容（依据线上格式标签，标签不完全则调用修补函数），清理多余标签后放入各界面
            一. 不符合线上格式且没有任何线上格式的标签（找不到任何私聊、群聊、动态、评论等信息），但是有content标签包裹，且里面有大量内容--清理多余标签后输出到互动空间
            二. 不符合线上格式且无任何线上格式标签，且找不到content标签，则重新发送请求**重传成本高，最后手段**
3. 互动内容AI回复消息后我们的处理方式：
    A. 寻找content标签--清理包含的多余标签--输出到互动空间（输出互动内容前要先输出当下页面的简短回复）
    B. content标签不完全--修补content标签--清理多余标签后输出到互动空间
    C. 完全没有content标签--检测是否有大量文本--有大量文本则清理多余标签后输出
    D. 以上皆失败--重新发送请求**最后手段**
**以及请注意以上处理逻辑备选方案的优先级，及主要逻辑成功后就不用再执行备选方案，只有主要逻辑失败后才会执行备选方案**
如：判断是否符合线上格式失败后--模糊匹配，如果匹配成功则不需要再执行模糊匹配机制。

在进行任何更动时，都请将我们的核心逻辑纳入考量，并且采取向后兼容形式进行更改，确保尽量不要影响到现有的功能。


这个项目是在完成一个通过Silly Tavern加载的手机前端页面，而现在的任务为给这个前端页面debug、增加功能以及优化。
请留意酒馆之间自带的特殊机制，如预设、世界书、表格插件扩展等等
现在请仔细检查文件，特别是聊天讯息加载以及保存的部分，可参考能够顺利运作的动态、分组、创建/删除群聊内容保存加载，但要注意到这些与聊天消息备份的区别。
目前聊天讯息备份使用的世界书名称是‘手机-聊天消息备份’，里面有部分历史聊天资料。
但是现在的问题在于，聊天讯息保存更新到世界书，以及从对应世界书加载皆失败，请确认是否有重复逻辑、缺失的逻辑、时机问题等等。


