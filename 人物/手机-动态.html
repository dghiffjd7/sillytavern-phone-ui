<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>Document</title>
        <style type="text/css">
            @import url(https://static.zeoseven.com/zsft/59/main/result.css);
            .QQ_chat_page {
                padding-top: 10px;
                background-color: rgb(244, 245, 246);
                width: 100%;
                height: 100%;
                /* Â°´Êª°ËßÜÂè£È´òÂ∫¶ */
                /* background-image: url("http://sharkpan.xyz/f/eWhZ/00017-2763077315.png"); */
                background-size: cover;
                background-repeat: no-repeat;
                background-position: top center;
                display: flex;
                flex-direction: column;
                overflow-y: auto;
                /* ÂÖÅËÆ∏ÂÜÖÂÆπÂå∫ÂüüÂûÇÁõ¥ÊªöÂä® */
                box-sizing: border-box;
                /* Èò≤Ê≠¢ÂÜÖËæπË∑ùÊ∫¢Âá∫ */
                border-radius: var(--yj);
                /* padding-bottom: 60px; */

                position: relative;
                overflow-x: hidden;

                /* z-index: 9999; */
                /* font-family: "Â≠óÈ≠ÇËêåÂÆ†Â§©Âú∞‰Ωì"; */
            }

            .input-container {
                max-width: 100%;
                position: absolute;
                /* bottom: 20px; */
                bottom: 0px;
                left: 0;
                width: 100%;
                background-color: rgb(255, 255, 255, 0.2);
                border-bottom-right-radius: 10px;
                border-bottom-left-radius: 10px;
                box-sizing: border-box;
                padding: 10px 0;
                border-top: 1px solid black;
            }

            .msgcontent {
                flex: 1;
                overflow-y: auto;
                box-sizing: border-box;
                /* margin-top: 20px; */
                margin-bottom: 50px;
                padding-left: 8px;
                padding-right: 8px;
                scrollbar-width: none;
                /* Firefox */
                -ms-overflow-style: none;
                /* IE and Edge */
            }

            .userInput {
                font: inherit;
                height: 30px;
                border-radius: 30px;
                letter-spacing: 0.7px;
                width: 100%;
                padding-left: 10px;
                padding-right: 10px;
                border: 1px solid rgb(0, 0, 0, 0.5);
            }

            /* ËÅäÂ§©ËÆæÁΩÆÂºπÁ™óÊ†∑Âºè */
            .chat-setting-popup {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 80%;
                max-width: 350px;
                background-color: #fff;
                border-radius: 10px;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
                z-index: 1000;
                display: none;
            }

            .chat-setting-header {
                padding: 15px;
                border-bottom: 1px solid #eee;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .chat-setting-header span {
                font-weight: bold;
                font-size: 16px;
            }

            .close-setting-btn {
                cursor: pointer;
            }

            .chat-setting-content {
                padding: 15px;
            }

            .setting-item {
                margin-bottom: 15px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 10px;
            }

            .setting-item span {
                font-size: 14px;
            }

            .setting-item input[type="text"] {
                flex: 1;
                padding: 5px;
                border: 1px solid #ccc;
                border-radius: 5px;
            }

            .color-picker {
                width: 30px;
                height: 30px;
                padding: 0;
                border: 1px solid #ccc;
                border-radius: 3px;
                cursor: pointer;
            }

            .chat-setting-footer {
                padding: 10px 15px;
                text-align: right;
                border-top: 1px solid #eee;
            }

            .chat-setting-footer button {
                padding: 6px 15px;
                margin-left: 10px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
            }

            #save-setting-btn {
                background-color: #019aff;
                color: white;
            }

            #cancel-setting-btn {
                background-color: #f5f5f5;
                color: #333;
            }

            /* ÂºπÁ™óÈÅÆÁΩ©Â±Ç */
            .popup-overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                border-radius: 35px;
                z-index: 999;
                display: none;
            }

            /* ÊêúÁ¥¢Ê°ÜÊÇ¨ÊµÆÁõ∏ÂÖ≥Ê†∑Âºè */
            #floating_search_box:hover {
                background-color: rgba(239, 243, 255, 0.95) !important;
                border-color: rgba(25, 154, 255, 0.4) !important;
                transform: translateY(-1px);
            }

            #contact_search_input::placeholder {
                color: #999;
                font-style: italic;
            }

            #search_clear_btn:hover {
                background-color: #999 !important;
                transform: scale(1.1);
            }

            /* ËÅîÁªú‰∫∫ÂàóË°®ÊªöÂä®Êó∂ÁöÑÊêúÁ¥¢Ê°ÜÊïàÊûú */
            #QQ_home_chars::-webkit-scrollbar {
                display: none !important;
            }

            /* ÊêúÁ¥¢ÁªìÊûúÈ´ò‰∫ÆÊ†∑Âºè */
            .search-highlight {
                background-color: #ffeb3b !important;
                color: #333 !important;
                padding: 1px 2px;
                border-radius: 2px;
                font-weight: bold;
            }

            .QQ_chat_fakeimg {
                width: 100%;
                background-color: white;
                aspect-ratio: 1 / 1;
                padding: 5px 18px 0 20px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                font-size: 1.3em;
                /* overflow-y: auto; */
                -ms-overflow-style: none !important;
                scrollbar-width: none !important;
                text-align: center;
            }

            .QQ_chat_fakeimg::-webkit-scrollbar {
                display: none !important;
            }

            .QQ_chat_fakeimg div {
                max-height: 100%;
                display: flex;
                align-items: flex-start;
                overflow-y: auto;
                -ms-overflow-style: none !important;
                scrollbar-width: none !important;
            }

            .QQ_chat_fakeimg div::-webkit-scrollbar {
                display: none !important;
            }

            .discord {
                background-color: #f2f3f5;
                width: 100%;
                height: 100%;
                line-height: 1.4;
                letter-spacing: 1px;
            }

            .discord-top {
                background-color: white;
                width: 100%;
                height: 80px;
                padding-top: 30px;
                padding-left: 10px;
                display: flex;
                align-items: center;
            }

            .discord-top-title {
                font-size: 20px;
                text-align: center;
                margin-top: -3px;
            }

            .discord-top-button {
                display: flex;
                align-items: center;
                margin-bottom: 10px;
            }

            .sortbutton {
                display: flex;
                align-items: center;
                gap: 4px;
                margin-bottom: -1px;
                height: 32px;
                background-color: #e8e9eb;
                padding: 8px 8px 8px 12px;
                width: fit-content;
                border-radius: 24px;
                margin-top: 10px;
                margin-left: 10px;
            }

            .tagbutton {
                display: flex;
                align-items: center;
                margin-left: auto;
                margin-right: 10px;
                background-color: #e8e9eb;
                padding: 8px 8px 8px 12px;
                width: fit-content;
                height: 32px;
                border-radius: 24px;
                margin-top: 10px;
            }

            .discord-cardlist {
                display: flex;
                flex-direction: column;
                width: 100%;
                height: 100%;
                overflow-y: auto;
                padding: 0 10px 150px 10px;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }

            .discord-cardlist::-webkit-scrollbar {
                display: none !important;
            }

            .discord-card {
                width: 100%;
                height: auto;
                background-color: white;
                border-radius: 15px;
                margin-top: 15px;
                padding-left: 13px;
                padding-right: 13px;
                padding-bottom: 10px;
                border: 1px solid #dfdfe1;
            }

            .discord-card:active {
                background-color: rgb(244, 243, 243);
            }

            .discord-card-tags {
                width: 100%;
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
                padding-top: 10px;
            }

            .discord-card-tag {
                background-color: #eeeff1;
                color: #4f5055;
                width: fit-content;
                padding: 5px 15px;
                border-radius: 24px;
                margin-top: 5px;
                margin-left: -1px;
                font-size: 15px;
                text-align: center;
                font-weight: bold;
            }

            .discord-card-author {
                color: #9d8ef3;
                margin-top: 8px;
                font-size: 18px;
                display: inline-block;
                font-weight: bold;
            }

            .discord-card-title {
                font-weight: bold;
                font-size: 19px;
                margin-top: 5px;

                display: -webkit-box;
                -webkit-box-orient: vertical;
                -webkit-line-clamp: 2;

                /* ÊñáÊú¨Ê∫¢Âá∫Êó∂ÊòæÁ§∫ÁúÅÁï•Âè∑ */
                overflow: hidden;
                text-overflow: ellipsis;

                /* Á°Æ‰øùÊñáÊú¨Êç¢Ë°å */
                white-space: normal;
                word-break: break-word;
                /* ÈÅøÂÖçÈïøÂçïËØçÊ∫¢Âá∫ */
            }

            .discord-card-content {
                margin-top: 2px;
                color: #313133;
                font-size: 16px;

                display: -webkit-box;
                -webkit-box-orient: vertical;
                -webkit-line-clamp: 3;

                /* ÊñáÊú¨Ê∫¢Âá∫Êó∂ÊòæÁ§∫ÁúÅÁï•Âè∑ */
                overflow: hidden;
                text-overflow: ellipsis;

                /* Á°Æ‰øùÊñáÊú¨Êç¢Ë°å */
                white-space: normal;
                word-break: break-word;
                /* ÈÅøÂÖçÈïøÂçïËØçÊ∫¢Âá∫ */
            }

            .discord-card-interact {
                display: flex;
                align-items: center;
                margin-top: 15px;
            }

            .discord-card-interact-icon {
                margin-left: auto;
                color: #333237;
                background-color: #ececec;
                border-radius: 10px;
                font-size: 16px;
                padding: 2px 8px 2px 6px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .discord-card-fakeimg {
                text-align: center;
                margin-top: 9px;
                font-size: 1.2rem;
                background-color: rgb(239 237 238);
                padding: 30px 10px;
                width: 100%;
                border: 1px solid #dfdfe1;
                border-radius: 5px;
                text-align: center;
                text-wrap: balance;
            }

            .discord-thread {
                width: 100%;
                height: 100%;
                background-color: white;
                padding-top: 30px;
                position: relative;
                /* overflow-x: hidden; */
            }

            .discord-thread-top {
                display: grid;
                grid-template-columns: 32px 43px 1fr;
                align-items: center;
                width: 100%;
                height: 50px;
                padding: 0 10px;
            }

            .discord-thread-title {
                font-weight: bold;
                font-size: 20px;
                overflow: hidden;
                text-overflow: ellipsis;
                width: 100%;
                white-space: nowrap;
            }

            .discord-thread-content {
                overflow-y: auto;
                padding: 0 10px;
                width: 100%;
                height: auto;
            }

            .discord-thread-content-title {
                font-weight: bold;
                font-size: 24px;
                margin-top: 10px;
                margin-bottom: 3px;
            }

            .discord-thread-content-tags {
                width: 100%;
                display: flex;
                flex-wrap: wrap;
                gap: 5px;

                .discord-card-tag {
                    margin-top: 5px;
                }
            }

            .discord-thread-content-original {
                display: grid;
                grid-template-columns: 55px 1fr;
                align-items: start;
                margin-top: 20px;
                margin-bottom: 10px;
            }

            .discord-thread-content-original-author-head {
                width: 45px;
                height: 45px;
                background-size: cover;
                border-radius: 50%;
            }

            .discord-thread-content-original-author-name {
                color: #9d8ef3;
                font-size: 18px;
                display: inline-block;
                font-weight: bold;
            }

            .discord-thread-content-original-content {
                white-space: pre-wrap;
                margin-top: 3px;
            }

            .discord-thread-content-likes {
                width: fit-content;
                padding: 5px 8px 5px 8px;
                text-align: center;
                background-color: #f2f3f5;
                border-radius: 8px;
                display: flex;
                align-items: center;
                gap: 5px;
                color: #525358;
                font-size: 16px;
                height: 34px;
            }

            .discord-thread-content-reaction {
                background-color: #eeeeef;
                padding: 5px;
                align-items: center;
                justify-content: center;
                border-radius: 10px;
                display: flex;
                margin-left: 6px;
                height: 34px;
            }

            .discord-thread-comment-list {
                padding: 0 10px;
                width: 100%;
            }

            .discord-thread-comment {
                display: grid;
                grid-template-columns: 50px 1fr;
                margin-top: 20px;
            }

            .discord-thread-comment-head {
                width: 40px;
                height: 40px;
                background-size: cover;
                border-radius: 50%;
                /* margin-top: 5px; */
            }

            .discord-name-creator {
                color: #9d8ef3;
                font-size: 16px;
                display: inline-block;
                font-weight: bold;
                position: relative;
            }

            .discord-thread-comment-name {
                font-size: 16px;
                display: inline-block;
                font-weight: bold;
                position: relative;
            }

            .discord-thread-comment-content {
                margin-top: 3px;
            }

            .discord-name-creator::after {
                position: absolute;
                top: 0%;
                left: 100%;
                margin-left: 3px;
                height: 20px;
                width: 20px;
                display: inline-block;
                content: "";
                background-size: contain;
                background-image: url("data:image/webp;base64,UklGRkoCAABXRUJQVlA4WAoAAAAQAAAAHQAAHwAAQUxQSIEAAAABcFpt27K8L91pkm0KTxwGIMEO7pYcGolE9BUs0VxHkEqy3/+fl0qKiAkAAEAABEIESdtoYr1SrlBkurFzB8MSPlSiHPsT7Px17MvmHmUXRQmnJRgKU/pBjOknQ3rvo8jHsKRTNYixzZIyAZCOMCRsVkZ7oXk2fRJgrCyWpGOU+CkAVlA4IKIBAABwCQCdASoeACAAPmEoj0WkIqGb/VQAQAYEswBhsa8KA3gFgAdKgvwVsdYAxwUyDx3fSu/J9AD9dBN4HzXUGnIffZmZ+Xi6UOW2PLIrM//asS4J9gAA+nzKAwpZUP5tD9q71GP2da5pzrXFQhw7pRv+CMeoEN+kh+aUE4VmdB7sPfZs8IsDkQx5uoj5AjWh089yG//EwIyr/se6feMyVX1jaa8+MnQrGmsfLaVAoTq9RrJ37OhatyX20m/e/5Ph5E/2P/FpTDWXvb7Ta8uM487hoffTtj8mtyn8Fc4n6KteA//0CAaACYby7EAYe8857OPwrIv+/3fyVUAr4ga3+Uc/qEdrqwZ67A7Y0t4qBlDcm8Yk4xtY7wVHEKsF/rNmiezTq+r0Ysk1j3xNln94b5jV3f2/9VUZXqbv1fNiMWWdlm8cV5lf86F2H81wUKVQuoPeG7hAZhvU3NJ6DDmTY3fijNc29rpXd5tHHovD4H816Ukg7x4+L7ulAwyBuE8T3FhuuXF690Bq9sa/4l27s0Q8DeM8DKDkFM9s0CKf8J5QMYAA");
                /* background-image: url('https://cdn.discordapp.com/role-icons/1336817752844796016/da610f5548f174d9e04d49b1b28c3af1.webp?size=32&amp;quality=lossless'); */
            }

            .discord-scroll-container {
                width: 100%;
                height: 100%;
                overflow-y: auto;
                padding-bottom: 130px;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }

            .discord-scroll-container::-webkit-scrollbar {
                display: none !important;
            }

            .discord-thread-input {
                position: absolute;
                left: 0;
                bottom: 0;
                width: 100%;
                height: 50px;
                border-top: 2px solid #e4e4e4;
                background-color: white;
                display: flex;
                align-items: center;
                padding: 0 5px;
                gap: 5px;
            }

            .discord-thread-input-svgbackground {
                width: 35px;
                min-width: 35px;
                height: 35px;
                border-radius: 50%;
                background-color: #ececec;
                display: flex;
                align-items: center;
                justify-content: center;

                svg {
                    width: 22px;
                    height: 22px;
                }
            }

            .discord-thread-input-userinput {
                height: 30px;
                flex: 1;
                border-radius: 24px;
                border: 0px;
                background-color: #ececec;
                padding: 0 5px 0 10px;
                box-sizing: border-box;
                display: block;
                min-width: 50px;
                outline: none;
            }

            .discord-thread-input-userinput:focus {
                outline: none;
            }

            .discord-thread-input-userinput::placeholder {
                display: inline-block;
                width: 100%;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                direction: ltr;
            }

            .discord-cardget {
                background-color: #e8e9eb;
                padding: 10px 20px;
                border-radius: 100px;
                margin: auto;
                font-size: 1.5rem;
            }
            body {
                --yj: 22px;
                overflow: auto !important;
                -ms-overflow-style: none !important;
                scrollbar-width: none !important;
                letter-spacing: 0.7px;
                font-family: "JiangChengYuanTi";
                font-weight: normal;
            }
            .head {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                min-width: 40px;
            }
            .user_avatar {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background-size: cover;
            }
            body::-webkit-scrollbar {
                display: none !important;
            }
            .card {
                max-width: min(350px, 95%);
                width: min(350px, 95%);
                position: relative;
                height: auto;
                aspect-ratio: 1/2;
                background: #1b1717;
                border-radius: 35px;
                border: 2px solid #810000;
                padding: 7px;
                box-shadow: 2px 3px 3px rgba(0, 0, 0, 0.25);
                margin-left: 5px;
                box-sizing: border-box;
            }
            .card-int {
                background-size: 200% 200%;
                background-position: 0% 0%;
                height: 100%;
                border-radius: 25px;
                transition: all 0.6s ease-out;
                overflow: hidden;
                box-sizing: border-box;
                position: relative;
            }
            .card:hover .card-int {
                background-position: 100% 100%;
            }
            #App_Page {
                background-size: 200% 200%;
                background-position: 0% 0%;
                height: 100%;
                border-radius: 25px;
                transition: all 0.6s ease-out;
                overflow: hidden;
                box-sizing: border-box;
                position: relative;
            }
            .top {
                position: absolute;
                top: 0px;
                right: 50%;
                -webkit-transform: translate(50%, 0%);
                transform: translate(50%, 0%);
                width: 35%;
                height: 22px;
                background-color: #1b1717;
                border-bottom-left-radius: 13px;
                border-bottom-right-radius: 13px;
                z-index: 9999999;
            }
            .speaker {
                position: absolute;
                top: 2px;
                right: 50%;
                -webkit-transform: translate(50%, 0%);
                transform: translate(50%, 0%);
                width: 40%;
                height: 2px;
                border-radius: 2px;
                background-color: rgb(20, 20, 20);
            }
            .camera {
                position: absolute;
                top: 6px;
                right: 84%;
                -webkit-transform: translate(50%, 0%);
                transform: translate(50%, 0%);
                width: 6px;
                height: 6px;
                border-radius: 50%;
                background-color: rgba(255, 255, 255, 0.048);
            }
            .int {
                position: absolute;
                width: 3px;
                height: 3px;
                border-radius: 50%;
                top: 50%;
                right: 50%;
                -webkit-transform: translate(50%, -50%);
                transform: translate(50%, -50%);
                background-color: rgba(0, 0, 255, 0.212);
            }
            .btn1,
            .btn2,
            .btn3,
            .btn4 {
                position: absolute;
                width: 2px;
            }
            .btn1,
            .btn2,
            .btn3 {
                height: 45px;
                top: 30%;
                right: -4px;
                background-color: #ce1212;
            }
            .btn2,
            .btn3 {
                -webkit-transform: scale(-1);
                transform: scale(-1);
                left: -4px;
            }
            .btn2,
            .btn3 {
                -webkit-transform: scale(-1);
                transform: scale(-1);
                height: 30px;
            }
            .btn2 {
                top: 26%;
            }
            .btn3 {
                top: 36%;
            }
            .hidden {
                display: block;
                opacity: 0;
                transition: all 0.3s ease-in;
            }
            .card:hover .hidden {
                opacity: 1;
            }
            .card:hover .hello {
                -webkit-transform: translateY(-20px);
                transform: translateY(-20px);
            }
            .btn {
                position: absolute;
                width: 2px;
            }
            .backdiv {
                background-color: white;
                height: 100%;
                width: 100%;
                position: relative;
                background-size: cover;
                background-position: top center;
                background-repeat: no-repeat;
                background-image: url("http://sharkpan.xyz/f/6osR/00005-660646865.png");
                box-sizing: border-box;
            }
            .dibu {
                position: absolute;
                bottom: 40px;
                left: 3%;
                right: 3%;
                background-color: black;
                height: auto;
                display: -webkit-flex;
                display: flex;
                -webkit-align-items: center;
                align-items: center;
                -webkit-justify-content: space-around;
                justify-content: space-around;
                padding: 0 5px 0 5px;
                border-radius: 30px;
                --a: 10px;
                background-color: rgba(255, 255, 255, 0.2);
                backdrop-filter: blur(var(--a));
                -webkit-backdrop-filter: blur(var(--a));
            }
            .dibu svg {
                -webkit-transform: scale(0.85);
                transform: scale(0.85);
                -webkit-transform-origin: center;
                transform-origin: center;
            }
            .dinbu {
                position: absolute;
                top: 10px;
                left: 7%;
                right: 2%;
                color: #626367;
                display: -webkit-flex;
                display: flex;
                -webkit-align-items: center;
                align-items: center;
                -webkit-justify-content: space-between;
                justify-content: space-between;
                z-index: 9999999;
            }
            .zhong {
                position: absolute;
                border-radius: 20px;
                --a: 3px;
                background-color: rgba(255, 255, 255, 0.2);
                backdrop-filter: blur(var(--a));
                -webkit-backdrop-filter: blur(var(--a));
                top: 30%;
                left: 4%;
                right: 4%;
                color: black;
                padding: 10px 15px 10px 10px;
                font-size: 32px;
                display: -webkit-flex;
                display: flex;
                -webkit-align-items: center;
                align-items: center;
                -webkit-justify-content: space-between;
                justify-content: space-between;
                letter-spacing: 2px;
            }
            .app {
                position: absolute;
                bottom: 120px;
                left: 4%;
                right: 4%;
                display: -webkit-flex;
                display: flex;
                -webkit-align-items: center;
                align-items: center;
                -webkit-justify-content: space-evenly;
                justify-content: space-evenly;
                color: black;
                box-sizing: border-box;
                max-width: 92%;
                -webkit-flex-wrap: wrap;
                flex-wrap: wrap;
            }
            .app-svg-div {
                max-width: 20%;
                -webkit-transform: scale(0.8);
                transform: scale(0.8);
                -webkit-transform-origin: center;
                transform-origin: center;
            }
            .QQ_home_head {
                border-radius: 50%;
                margin-right: 15px;
                margin-left: 5px;
                width: 40px;
                height: 40px;
                font-size: 0;
                min-width: 40px;
                background-size: cover;
            }
            .QQ_home_usermsg {
                --head_size: 40px;
                width: 100%;
                display: -webkit-flex;
                display: flex;
                font-size: 14px;
                -webkit-align-items: center;
                align-items: center;
                height: 60px;
                align-items: center;
                position: relative;
            }
            .QQ_home_usermsg > * {
                position: relative;
                z-index: 1;
            }
            .QQ_home_usermsg:active::before {
                content: "";
                position: absolute;
                top: 0;
                left: -10px;
                right: -10px;
                height: 100%;
                background-color: #d5d5d5;
            }
            .QQ_home_usermsg_new {
                background-color: red;
                border-radius: 50%;
                width: 17px;
                height: 17px;
                color: white;
                display: -webkit-flex;
                display: flex;
                -webkit-align-items: center;
                align-items: center;
                -webkit-justify-content: center;
                justify-content: center;
                font-size: 13px;
                justify-self: end;
                padding: 2px;
            }
            .QQ_home_usermsg_new_hidden {
                background-color: #dbdbdb;
                border-radius: 10px;
                width: 2rem;
                height: 17px;
                color: white;
                display: -webkit-flex;
                display: flex;
                -webkit-align-items: center;
                align-items: center;
                -webkit-justify-content: center;
                justify-content: center;
                font-size: 13px;
                justify-self: end;
                padding: 2px;
            }
            

            .QQ_bottom_nav {
                position: absolute;
                bottom: 0px;
                width: 100%;
                height: 40px;
                display: -webkit-flex;
                display: flex;
                -webkit-align-items: center;
                align-items: center;
                -webkit-justify-content: space-evenly;
                justify-content: space-evenly;
                font-size: 10px;
                background-color: white;
                z-index: 1000;
                border-top: 1px solid #e6e6e6;
            }
            body div {
                box-sizing: border-box !important;
            }
            .page_button {
                display: -webkit-flex;
                display: flex;
                -webkit-align-items: center;
                align-items: center;
                -webkit-justify-content: space-evenly;
                justify-content: space-evenly;
                width: 100%;
                z-index: 99;
                position: absolute;
                bottom: 0px;
                left: 0;
                height: 22px;
                box-sizing: border-box;
                padding-bottom: 4px;
            }
            @media (max-width: 768px) {
                .zhong {
                    font-size: 20px;
                }
            }
            #space_page {
                width: 100%;
                height: 820px;
                background-color: #fff;
                display: none;
            }
            .user_moment_title {
                --head_size: 40px;
                width: 100%;
                display: -webkit-flex;
                display: flex;
                font-size: 14px;
                -webkit-align-items: start;
                align-items: start;
                margin-bottom: 5px;
            }
            .user_moment {
                padding-left: 7px;
                padding-right: 7px;
                position: relative;
            }
            .moment_button {
                display: -webkit-flex;
                display: flex;
                -webkit-align-items: center;
                align-items: center;
                gap: 5px;
                margin-left: auto;
                -webkit-transform: scale(0.9);
                transform: scale(0.9);
                -webkit-transform-origin: center;
                transform-origin: center;
            }

            /* Âä®ÊÄÅÁÇπËµûÊåâÈíÆÊ†∑Âºè */
            .moment-like-button {
                cursor: pointer;
                transition: all 0.2s ease;
                filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
            }

            .moment-like-button:hover {
                transform: scale(1.1);
                filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
            }

            .moment-like-button.liked {
                fill: #1677ff !important;
                animation: likeAnimation 0.3s ease-out;
                filter: drop-shadow(0 2px 6px rgba(22,119,255,0.3));
            }

            @keyframes likeAnimation {
                0% { transform: scale(1); }
                50% { transform: scale(1.3); }
                100% { transform: scale(1); }
            }

            /* ÁÇπËµûÂºπÁ™óÊ†∑Âºè */
            .moment-like-popup {
                position: absolute;
                bottom: 25px;
                left: 0;
                background: #fff;
                border: 1px solid #ddd;
                border-radius: 4px;
                padding: 4px 8px;
                font-size: 12px;
                color: #666;
                display: none;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                z-index: 1000;
                white-space: nowrap;
                animation: popupFadeIn 0.3s ease-out;
            }

            @keyframes popupFadeIn {
                0% { 
                    opacity: 0; 
                    transform: translateY(10px); 
                }
                100% { 
                    opacity: 1; 
                    transform: translateY(0); 
                }
            }

            /* ÁÇπËµûÊï∞ÈáèÊ†∑Âºè */
            .moment-like-count {
                color: #474545;
                font-size: 14px;
                transition: color 0.2s ease;
            }

            /* === üëçÊåâÈíÆÁÇπËµûÂäüËÉΩÊ†∑Âºè === */
            /* üëçÊåâÈíÆÁÇπËµûÁä∂ÊÄÅÊ†∑Âºè */
            .liked-thumb {
                filter: drop-shadow(0 0 8px #1677ff) !important;
                transform: scale(1.2) !important;
                transition: all 0.3s ease !important;
            }
            
            /* ËÑâÂÜ≤Âä®ÁîªÊïàÊûú */
            .pulse-animation {
                animation: thumbPulse 0.8s ease-in-out;
            }
            
            @keyframes thumbPulse {
                0% { transform: scale(1); filter: none; }
                50% { transform: scale(1.3); filter: drop-shadow(0 0 12px #1677ff); }
                100% { transform: scale(1.2); filter: drop-shadow(0 0 8px #1677ff); }
            }
            
            /* Áî®Êà∑Â∑≤ÁÇπËµûÊèêÁ§∫Ê†∑Âºè */
            .user-liked-tip {
                animation: slideInFromLeft 0.3s ease;
                display: block;
            }
            
            @keyframes slideInFromLeft {
                0% { opacity: 0; transform: translateX(-20px); }
                100% { opacity: 1; transform: translateX(0); }
            }
            
            /* üëçÊåâÈíÆÊÇ¨ÂÅúÊïàÊûú */
            .moment_button svg:hover {
                transform: scale(1.1) !important;
                transition: all 0.2s ease !important;
                cursor: pointer !important;
            }
            
            /* üëçÊåâÈíÆÂü∫Á°ÄÊ†∑Âºè */
            .moment_button svg {
                transition: all 0.2s ease;
                cursor: pointer;
            }
            .moment_msg {
                background-color: #fff;
                margin-top: 5px;
                max-width: 60%;
                border-radius: 7px;
                font-size: 15px;
                padding: 6px;
                width: -webkit-fit-content;
                width: fit-content;
                white-space: normal;
                letter-spacing: 1px;
                line-height: 1.4;
                margin-bottom: 10px;
                box-shadow: 1px 1px 2px rgba(32, 32, 32, 0.2);
            }
            #Home_page {
                width: 100%;
                height: 100%;
                background-image: url("http://sharkpan.xyz/f/nBUl/%E6%89%8B%E6%9C%BA%E5%A3%81%E7%BA%B82.jpg");
                background-size: cover;
                background-position: top center;
                background-repeat: no-repeat;
            }
            .QQ_chat_head {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background-size: cover;
                min-width: 40px;
            }
            .user_avatar {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background-size: cover;
            }
            .QQ_chat_msg {
                font-size: 14px;
                margin-right: 5px;
                margin-left: 5px;
            }
            .QQ_chat_mymsg {
                max-width: 70%;
                margin-left: auto;
                display: grid;
                grid-template-columns: 1fr 50px;
                grid-template-rows: auto auto;
                justify-items: end;
                text-align: right;
                -webkit-align-items: start;
                align-items: start;
                margin-bottom: 20px;
                margin-right: 15px; /* ÂáèÂ∞ëÂè≥ËæπË∑ùËÆ©Â§¥ÂÉèÈù†ËøëËæπÁºò */
            }
            .QQ_chat_charmsg {
                max-width: 80%;
                display: grid;
                grid-template-columns: 47px 1fr;
                grid-template-rows: auto auto;
                -webkit-align-items: start;
                align-items: start;
                margin-bottom: 20px;
                margin-left: 15px; /* ÂáèÂ∞ëÂ∑¶ËæπË∑ùËÆ©Â§¥ÂÉèÈù†ËøëËæπÁºò */
            }
            .QQ_chat_msgdiv {
                box-shadow: 2px 2px 2px rgba(15, 15, 15, 0.3);
                letter-spacing: 1px;
                line-height: 1.4;
                font-size: 15px;
                width: -webkit-fit-content;
                width: fit-content;
                background-color: rgb(239, 206, 242, 0.65);
                color: black;
                border-radius: 7px;
                padding: 7px;
                text-align: left;
                box-sizing: border-box;
                margin-left: -2px;
            }
            .QQ_chat_name {
                font-size: 13px;
                color: black;
            }
            .QQ_chat_msgimg {
                width: 100%;
                background-color: white;
            }
            .msgimg {
                max-width: 100%;
                height: auto;
                display: block;
            }
            .QQ_chat_time {
                display: -webkit-flex;
                display: flex;
                -webkit-align-items: center;
                align-items: center;
                -webkit-justify-content: center;
                justify-content: center;
                width: 100%;
                height: 10px;
                margin-bottom: 10px;
                color: #a1a1a1;
            }
            .mimictwitter hr {
                background-color: rgb(240, 244, 245);
                border: none;
                height: 1px;
            }
            .twitterhead {
                width: 45px;
                height: 45px;
                border-radius: 50%;
                margin-left: 4px;
                min-width: 45px;
            }
            .interactsvg {
                width: 15.5px;
                height: 15.5px;
            }
            .twitter-content {
                -webkit-flex: 1;
                flex: 1;
                overflow-y: auto;
                box-sizing: border-box;
                padding-top: 10px;
                padding-right: 3px;
            }
            .mimictwitter {
                background-color: white;
                width: 100%;
                max-width: 100%;
                border-radius: 10px;
                height: 100%;
                box-sizing: border-box;
                padding-top: 10px;
                display: -webkit-flex;
                display: flex;
                -webkit-flex-direction: column;
                flex-direction: column;
                position: relative;
                overflow-x: hidden;
            }
            .twitter {
                overflow-x: hidden;
                font-size: 16px;
                height: 100%;
            }
            .twitter_moment {
                display: grid;
                grid-template-columns: 50px 1fr 0px;
                grid-template-rows: auto auto;
            }
            img {
                box-sizing: border-box !important;
            }
            * {
                box-sizing: border-box;
            }
            .user_leave_message {
                font-size: 13px;
                margin-top: 7px;
                display: -webkit-flex;
                display: flex;
                -webkit-flex-direction: column;
                flex-direction: column;
                span {
                    line-height: 1.5;
                }
            }
            .space_contents {
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            .give_money {
                margin-top: 10px;
                border-radius: 8px;
                overflow: hidden;
            }
            #QQ_home_chars {
                background-color: #fefefe;
                width: 100%;
                -webkit-flex: 1;
                flex: 1;
                border-radius: 20px 20px 20px 20px;
                padding: 5px 20px 20px 20px;
                box-sizing: border-box;
                overflow: auto !important;
                -ms-overflow-style: none !important;
                scrollbar-width: none !important;
                margin-bottom: 40px;
            }
            #QQ_home_chars::-webkit-scrollbar {
                display: none !important;
            }
            #QQ_home_page {
                display: -webkit-flex;
                display: flex;
                -webkit-flex-direction: column;
                flex-direction: column;
                height: 100%;
            }
            span {
                word-break: break-word;
            }
            .QQ_chat_music {
                background-color: #fefefe;
                border-radius: 10px;
                padding-top: 10px;
                padding-right: 10px;
                padding-left: 10px;
                padding-bottom: 5px;
                width: 100%;
            }
            .hide-title {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .music-play-button {
                position: absolute;
                border-radius: 50%;
                background-color: hsla(0, 0%, 100%, 0.2862745098);
                height: 32px;
                width: 32px;
                top: 50%;
                left: 50%;
                -webkit-transform: translate(-50%, -50%);
                transform: translate(-50%, -50%);
                z-index: 2;
                border: 2px solid white;
                display: -webkit-flex;
                display: flex;
                -webkit-justify-content: center;
                justify-content: center;
                -webkit-align-items: center;
                align-items: center;
            }
            .space_fakeimg {
                text-align: center;
                margin-top: 5px;
                font-size: 1.2rem;
                background-color: rgb(239 237 238);
                padding: 30px 10px;
                width: 100%;
                border: 1px solid black;
                border-radius: 5px;
                text-align: center;
            }
            .QQ_home_lasttime {
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
                max-width: 4rem;
                margin-right: 5px;
            }
            #QQ_message_list_chars {
                background-color: #fefefe;
                width: 100%;
                -webkit-flex: 1;
                flex: 1;
                border-radius: 20px 20px 20px 20px;
                padding: 5px 20px 20px 20px;
                box-sizing: border-box;
                overflow: auto !important;
                -ms-overflow-style: none !important;
                scrollbar-width: none !important;
                margin-bottom: 40px;
            }
            #QQ_message_list_chars::-webkit-scrollbar {
                display: none !important;
            }
            
            /* Áæ§ËÅäÁÆ°ÁêÜ‰∏ãÊãâËèúÂçïÊ†∑Âºè */
            .group-management-dropdown {
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 10000;
                max-height: 300px;
                overflow-y: auto;
                margin-top: 5px;
            }
            
            .group-management-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px 15px;
                border-bottom: 1px solid #f0f0f0;
                background: #f8f9fa;
                border-radius: 8px 8px 0 0;
            }
            
            .group-management-title {
                font-size: 14px;
                font-weight: bold;
                color: #333;
            }
            
            .group-settings-icon {
                width: 20px;
                height: 20px;
                cursor: pointer;
                opacity: 0.7;
                transition: opacity 0.2s;
            }
            
            .group-settings-icon:hover {
                opacity: 1;
            }
            
            .group-members-list {
                padding: 8px 0;
            }
            
            .group-member-item {
                display: flex;
                align-items: center;
                padding: 8px 15px;
                transition: background-color 0.2s;
            }
            
            .group-member-item:hover {
                background-color: #f5f5f5;
            }
            
            .group-member-avatar {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                margin-right: 10px;
                flex-shrink: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
                font-weight: bold;
                color: white;
                background: linear-gradient(135deg, #667eea, #764ba2);
            }
            
            .group-member-name {
                flex: 1;
                font-size: 14px;
                color: #333;
            }
            
            /* Áæ§ËÅäËÆæÁΩÆÊ®°ÊÄÅÁ™óÂè£Ê†∑Âºè */
            .group-settings-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: none;
                justify-content: center;
                align-items: center;
                z-index: 20000;
            }
            
            .group-settings-content {
                background: white;
                border-radius: 12px;
                width: 90%;
                max-width: 400px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            }
            
            .group-settings-header {
                padding: 20px;
                border-bottom: 1px solid #f0f0f0;
                text-align: center;
            }
            
            .group-settings-title {
                font-size: 18px;
                font-weight: bold;
                color: #333;
                margin: 0;
            }
            
            .group-settings-body {
                padding: 20px;
            }
            
            .group-settings-section {
                margin-bottom: 20px;
            }
            
            .group-settings-section-title {
                font-size: 14px;
                font-weight: bold;
                color: #333;
                margin-bottom: 10px;
            }
            
            .group-settings-input {
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 14px;
                box-sizing: border-box;
            }
            
            .group-settings-member-list {
                max-height: 200px;
                overflow-y: auto;
                border: 1px solid #f0f0f0;
                border-radius: 6px;
            }
            
            .group-settings-member-item {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 10px;
                border-bottom: 1px solid #f8f8f8;
            }
            
            .group-settings-member-item:last-child {
                border-bottom: none;
            }
            
            .group-settings-member-info {
                display: flex;
                align-items: center;
                flex: 1;
            }
            
            .group-settings-remove-btn {
                background: #ff4757;
                color: white;
                border: none;
                border-radius: 4px;
                padding: 4px 8px;
                font-size: 12px;
                cursor: pointer;
                transition: background-color 0.2s;
            }
            
            .group-settings-remove-btn:hover {
                background: #ff3742;
            }
            
            /* Ê∑ªÂä†ÊàêÂëòÊåâÈíÆÊ†∑Âºè */
            .group-settings-add-member-item {
                margin-top: 10px;
            }
            
            .group-settings-add-member-btn {
                width: 100%;
                padding: 12px;
                border: 2px dashed #ddd;
                border-radius: 8px;
                background: transparent;
                color: #666;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                font-size: 14px;
                transition: all 0.3s ease;
            }
            
            .group-settings-add-member-btn:hover {
                border-color: #199AFF;
                color: #199AFF;
                background: rgba(25, 154, 255, 0.05);
            }
            
            .add-member-icon {
                font-size: 18px;
                font-weight: bold;
            }
            
            /* Ê∑ªÂä†ÊàêÂëòÊ®°ÊÄÅÁ™óÂè£Ê†∑Âºè */
            .add-member-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: none;
                justify-content: center;
                align-items: center;
                z-index: 25000;
            }
            
            .add-member-dialog {
                background: white;
                border-radius: 12px;
                width: 90%;
                max-width: 400px;
                max-height: 80vh;
                overflow: hidden;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            }
            
            .add-member-header {
                padding: 20px;
                border-bottom: 1px solid #eee;
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            }
            
            .add-member-title {
                font-size: 18px;
                font-weight: bold;
                color: #333;
                margin: 0;
            }
            
            .add-member-close {
                font-size: 24px;
                color: #999;
                cursor: pointer;
                line-height: 1;
            }
            
            .add-member-close:hover {
                color: #666;
            }
            
            .add-member-content {
                padding: 20px;
                max-height: 400px;
                overflow-y: auto;
            }
            
            .add-member-search {
                position: relative;
                margin-bottom: 15px;
            }
            
            .add-member-search-input {
                width: 100%;
                padding: 10px 40px 10px 15px;
                border: 1px solid #ddd;
                border-radius: 8px;
                font-size: 14px;
                box-sizing: border-box;
            }
            
            .add-member-search-input:focus {
                outline: none;
                border-color: #199AFF;
            }
            
            .add-member-search-icon {
                position: absolute;
                right: 12px;
                top: 50%;
                transform: translateY(-50%);
                color: #999;
            }
            
            .add-member-contact-list {
                max-height: 300px;
                overflow-y: auto;
            }
            
            .add-member-contact-item {
                display: flex;
                align-items: center;
                padding: 12px;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.2s ease;
                border: 2px solid transparent;
                margin-bottom: 8px;
            }
            
            .add-member-contact-item:hover {
                background: #f8f9fa;
                border-color: #e9ecef;
            }
            
            .add-member-contact-item.selected {
                background: #e3f2fd;
                border-color: #199AFF;
            }
            
            .add-member-contact-item.disabled {
                /* ÁßªÈô§ opacity: 0.5; ÈÅøÂÖçÂàÜÁªÑ‰∏≠ËßíËâ≤ÂèòÁÅ∞ */
                cursor: not-allowed;
            }
            
            .add-member-contact-item.disabled:hover {
                background: transparent;
                border-color: transparent;
            }
            
            .add-member-contact-avatar {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                margin-right: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                font-size: 14px;
                color: white;
                background-size: cover;
                background-position: center;
                flex-shrink: 0;
            }
            
            .add-member-contact-name {
                flex: 1;
                font-size: 14px;
                color: #333;
                font-weight: 500;
            }
            
            .add-member-contact-status {
                font-size: 12px;
                color: #666;
                padding: 4px 8px;
                border-radius: 12px;
                background: #f0f0f0;
                transition: all 0.2s ease;
            }
            
            .add-member-contact-item.selected .add-member-contact-status {
                background: #199AFF;
                color: white;
            }
            
            .add-member-actions {
                padding: 20px;
                border-top: 1px solid #eee;
                display: flex;
                gap: 12px;
                justify-content: flex-end;
                background: #fafafa;
            }
            
            .add-member-btn {
                padding: 12px 24px;
                border: none;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                min-width: 80px;
            }
            
            .add-member-cancel-btn {
                background: #f8f9fa;
                color: #666;
                border: 1px solid #dee2e6;
            }
            
            .add-member-cancel-btn:hover {
                background: #e9ecef;
                border-color: #adb5bd;
            }
            
            .add-member-confirm-btn {
                background: linear-gradient(135deg, #199AFF, #0066CC);
                color: white;
                box-shadow: 0 2px 8px rgba(25, 154, 255, 0.3);
            }
            
            .add-member-confirm-btn:hover {
                background: linear-gradient(135deg, #0066CC, #004499);
                box-shadow: 0 4px 12px rgba(25, 154, 255, 0.4);
                transform: translateY(-1px);
            }
            
            .add-member-confirm-btn:disabled {
                background: #ccc;
                cursor: not-allowed;
                box-shadow: none;
                transform: none;
            }
            
            .group-settings-actions {
                display: flex;
                gap: 10px;
                padding: 20px;
                border-top: 1px solid #f0f0f0;
            }
            
            .group-settings-btn {
                flex: 1;
                padding: 12px;
                border: none;
                border-radius: 6px;
                font-size: 14px;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.2s;
            }
            
            .group-settings-save-btn {
                background: #199AFF;
                color: white;
            }
            
            .group-settings-save-btn:hover {
                background: #0066CC;
            }
            
            .group-settings-delete-btn {
                background: #ff4757;
                color: white;
            }
            
            .group-settings-delete-btn:hover {
                background: #ff3742;
            }
            
            .group-settings-cancel-btn {
                background: #f1f2f6;
                color: #333;
            }
            
            .group-settings-cancel-btn:hover {
                background: #ddd;
            }
            
            /* Áæ§ËÅäËÆæÁΩÆÂ§¥ÂÉèÁõ∏ÂÖ≥Ê†∑Âºè */
            .group-settings-avatar-container {
                display: flex;
                align-items: center;
                gap: 15px;
                padding: 10px 0;
            }
            
            .group-settings-avatar-preview {
                width: 60px;
                height: 60px;
                border-radius: 50%;
                background: #4CAF50;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.2s ease;
                overflow: hidden;
            }
            
            .group-settings-avatar-preview:hover {
                transform: scale(1.05);
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            }
            
            .group-settings-default-avatar {
                color: white;
                font-size: 20px;
                font-weight: bold;
            }
            
            .group-settings-avatar-preview img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                border-radius: 50%;
            }
            
            .group-settings-avatar-text {
                color: #199AFF;
                cursor: pointer;
                font-size: 14px;
                user-select: none;
            }
            
            .group-settings-avatar-text:hover {
                text-decoration: underline;
            }

            /* Áæ§ËÅäÂàõÂª∫ÂºπÁ™óÊ†∑Âºè */
            .group-chat-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                backdrop-filter: blur(3px);
            }
            
            .group-chat-dialog {
                background-color: #ffffff;
                border-radius: 15px;
                width: 280px;
                max-height: 400px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                overflow: hidden;
                animation: modalSlideIn 0.3s ease-out;
            }
            
            @keyframes modalSlideIn {
                from {
                    opacity: 0;
                    transform: scale(0.8) translateY(-20px);
                }
                to {
                    opacity: 1;
                    transform: scale(1) translateY(0);
                }
            }
            
            .group-chat-header {
                background: linear-gradient(135deg, #199AFF, #0066CC);
                color: white;
                padding: 15px 20px;
                text-align: center;
                font-size: 16px;
                font-weight: bold;
            }
            
            .group-chat-content {
                padding: 20px;
            }
            
            .group-chat-option {
                display: flex;
                align-items: center;
                padding: 12px 15px;
                margin-bottom: 10px;
                border-radius: 8px;
                background-color: #f8f9fa;
                cursor: pointer;
                transition: all 0.2s ease;
                border: 1px solid #e9ecef;
            }
            
            .group-chat-option:hover {
                background-color: #e3f2fd;
                border-color: #199AFF;
                transform: translateY(-1px);
            }
            
            .group-chat-option-icon {
                width: 24px;
                height: 24px;
                margin-right: 12px;
                fill: #199AFF;
            }
            
            .group-chat-option-text {
                font-size: 14px;
                color: #333;
                font-weight: 500;
            }
            
            .group-create-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1001;
                backdrop-filter: blur(3px);
            }
            
            .group-create-dialog {
                background-color: #ffffff;
                border-radius: 15px;
                width: 320px;
                max-height: 85vh;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                overflow: hidden;
                animation: modalSlideIn 0.3s ease-out;
                display: flex;
                flex-direction: column;
            }
            
            .group-create-header {
                background: linear-gradient(135deg, #199AFF, #0066CC);
                color: white;
                padding: 15px 20px;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            
            .group-create-title {
                font-size: 16px;
                font-weight: bold;
            }
            
            .group-create-close {
                color: white;
                font-size: 20px;
                cursor: pointer;
                padding: 2px 6px;
                border-radius: 50%;
                transition: background-color 0.2s;
            }
            
            .group-create-close:hover {
                background-color: rgba(255, 255, 255, 0.2);
            }
            
            .group-create-content {
                padding: 20px;
                flex: 1;
                overflow-y: auto;
                min-height: 0;
            }
            
            .group-name-section {
                margin-bottom: 20px;
            }
            
            .group-name-label {
                display: block;
                font-size: 14px;
                color: #333;
                margin-bottom: 8px;
                font-weight: 500;
            }
            
            .group-name-input {
                width: 100%;
                padding: 10px 12px;
                border: 2px solid #e9ecef;
                border-radius: 8px;
                font-size: 14px;
                outline: none;
                transition: border-color 0.2s;
                box-sizing: border-box;
            }
            
            .group-name-input:focus {
                border-color: #199AFF;
            }
            
            .group-members-section {
                margin-bottom: 20px;
            }
            
            .group-members-label {
                font-size: 14px;
                color: #333;
                margin-bottom: 10px;
                font-weight: 500;
            }
            
            .contact-item {
                display: flex;
                align-items: center;
                padding: 12px 8px;
                border-radius: 8px;
                margin-bottom: 6px;
                cursor: pointer;
                transition: all 0.3s ease;
                border: 2px solid transparent;
                position: relative; /* ‰∏∫ÈÄâÊã©Ê†áËÆ∞Êèê‰æõÂÆö‰ΩçÂü∫ÂáÜ */
            }
            
            .contact-item:last-child {
                margin-bottom: 0;
            }
            
            .contact-item:hover {
                background-color: #f8f9fa;
                transform: translateX(2px);
            }
            
            .contact-item.selected {
                background: linear-gradient(135deg, #199AFF 0%, #0066CC 100%) !important;
                color: white !important;
                border-color: #0066CC !important;
                box-shadow: 0 4px 12px rgba(25, 154, 255, 0.3) !important;
                transform: scale(1.02) !important;
                transition: all 0.2s ease !important;
            }
            
            .contact-item.selected .contact-name {
                color: white !important;
                font-weight: 500 !important;
            }
            
            /* ÈÄâ‰∏≠Áä∂ÊÄÅ‰∏ãÁöÑÊêúÁ¥¢È´ò‰∫ÆÊ†∑Âºè */
            .contact-item.selected .contact-name span {
                background-color: rgba(255, 255, 255, 0.3) !important;
                color: white !important;
            }
            
            .contact-item.selected .contact-avatar {
                border: 2px solid rgba(255, 255, 255, 0.5) !important;
                box-shadow: 0 0 8px rgba(255, 255, 255, 0.3) !important;
            }
            
            /* Â¢ûÂº∫ÈÄâÊã©Áä∂ÊÄÅÁöÑËßÜËßâÂèçÈ¶à */
            .contact-item.selected::before {
                content: '‚úì';
                position: absolute;
                right: 8px;
                top: 50%;
                transform: translateY(-50%);
                color: white;
                font-weight: bold;
                font-size: 16px;
                z-index: 10;
            }
            
            .contact-checkbox {
                display: none; /* ÈöêËóèÂéüÂßãÂ§çÈÄâÊ°Ü */
            }
            
            /* Áæ§ËÅäÊàêÂëòÊêúÁ¥¢Ê°ÜÊ†∑Âºè */
            .group-member-search {
                position: relative;
                margin-bottom: 15px;
            }
            
            .group-search-input {
                width: 100%;
                padding: 10px 12px 10px 35px;
                border: 2px solid #e9ecef;
                border-radius: 8px;
                font-size: 14px;
                outline: none;
                transition: border-color 0.2s;
                box-sizing: border-box;
                background-color: #f8f9fa;
            }
            
            .group-search-input:focus {
                border-color: #199AFF;
                background-color: white;
            }
            
            .group-search-icon {
                position: absolute;
                left: 10px;
                top: 50%;
                transform: translateY(-50%);
                color: #666;
                font-size: 14px;
            }
            
            .group-search-clear {
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                color: #999;
                cursor: pointer;
                font-size: 16px;
                padding: 2px;
                border-radius: 50%;
                transition: all 0.2s;
                display: none;
            }
            
            .group-search-clear:hover {
                background-color: #e9ecef;
                color: #666;
            }
            
            .group-search-clear.show {
                display: block;
            }
            
            /* ËÅîÁ≥ª‰∫∫ÂàóË°®ÂÆπÂô® */
            .contact-list-container {
                max-height: 250px;
                overflow-y: auto;
                padding-right: 5px;
            }
            
            .contact-list-container::-webkit-scrollbar {
                width: 4px;
            }
            
            .contact-list-container::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 4px;
            }
            
            .contact-list-container::-webkit-scrollbar-thumb {
                background: #c1c1c1;
                border-radius: 4px;
            }
            
            .contact-list-container::-webkit-scrollbar-thumb:hover {
                background: #a8a8a8;
            }
            
            /* Êó†ÊêúÁ¥¢ÁªìÊûúÊèêÁ§∫ */
            .no-results {
                text-align: center;
                color: #999;
                padding: 20px;
                font-size: 14px;
            }
            
            .contact-avatar {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                margin-right: 10px;
                background-color: #f0f0f0;
                background-size: cover;
                background-position: center;
                flex-shrink: 0;
            }
            
            .contact-name {
                font-size: 14px;
                color: #333;
                flex: 1;
            }
            
            .group-create-actions {
                padding: 15px 20px;
                background-color: #f8f9fa;
                display: flex;
                gap: 10px;
            }
            
            .group-action-btn {
                flex: 1;
                padding: 10px 16px;
                border: none;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
            .group-cancel-btn {
                background-color: #f8f9fa;
                color: #666;
                border: 1px solid #e9ecef;
            }
            
            .group-cancel-btn:hover {
                background-color: #e9ecef;
            }
            
            .group-confirm-btn {
                background: linear-gradient(135deg, #199AFF, #0066CC);
                color: white;
            }
            
            .group-confirm-btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(25, 154, 255, 0.3);
            }
            
            .group-confirm-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
            }
            
            /* ==================== Áæ§ËÅäÂ§¥ÂÉèËÆæÁΩÆÊ†∑Âºè ==================== */
            
            .group-avatar-section {
                margin-bottom: 20px;
            }
            
            .group-avatar-label {
                display: block;
                margin-bottom: 8px;
                font-size: 14px;
                font-weight: 500;
                color: #333;
            }
            
            .group-avatar-selector {
                display: flex;
                align-items: center;
                gap: 12px;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
            .group-avatar-selector:hover {
                opacity: 0.8;
            }
            
            .group-avatar-preview {
                width: 60px;
                height: 60px;
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: linear-gradient(135deg, #199AFF, #0066CC);
                cursor: pointer;
                transition: all 0.2s ease;
                position: relative;
                overflow: hidden;
            }
            
            .group-avatar-preview:hover {
                transform: scale(1.05);
                box-shadow: 0 4px 15px rgba(25, 154, 255, 0.3);
            }
            
            .default-group-avatar {
                color: white;
                font-size: 24px;
                font-weight: bold;
            }
            
            .group-avatar-preview img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                border-radius: 12px;
            }
            
            .group-avatar-text {
                color: #666;
                font-size: 14px;
                cursor: pointer;
            }
            
            /* ==================== Â§¥ÂÉèÈÄâÊã©Âô®ÂºπÁ™óÊ†∑Âºè ==================== */
            
            .avatar-selector-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(5px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 30000; /* Á°Æ‰øùÂú®Áæ§ËÅäËÆæÁΩÆÊ®°ÊÄÅÁ™óÂè£(z-index: 20000)‰πã‰∏ä */
                animation: modalFadeIn 0.3s ease;
            }
            
            .avatar-selector-dialog {
                background: white;
                border-radius: 16px;
                width: 90%;
                max-width: 450px;
                max-height: 80vh;
                overflow: hidden;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                animation: modalSlideIn 0.3s ease;
            }
            
            .avatar-selector-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 20px 20px 15px;
                border-bottom: 1px solid #e9ecef;
                background: linear-gradient(135deg, #199AFF, #0066CC);
                color: white;
            }
            
            .avatar-selector-title {
                font-size: 16px;
                font-weight: 600;
            }
            
            .avatar-selector-close {
                font-size: 24px;
                cursor: pointer;
                padding: 0 5px;
                border-radius: 50%;
                transition: all 0.2s ease;
                color: white;
            }
            
            .avatar-selector-close:hover {
                background-color: rgba(255, 255, 255, 0.2);
            }
            
            .avatar-selector-content {
                display: flex;
                flex-direction: column;
                max-height: 500px;
            }
            
            .avatar-selector-tabs {
                display: flex;
                background-color: #f8f9fa;
                border-bottom: 1px solid #e9ecef;
            }
            
            .avatar-tab {
                flex: 1;
                padding: 12px 16px;
                text-align: center;
                cursor: pointer;
                font-size: 14px;
                color: #666;
                border-bottom: 3px solid transparent;
                transition: all 0.2s ease;
            }
            
            .avatar-tab.active {
                color: #199AFF;
                border-bottom-color: #199AFF;
                background-color: white;
                font-weight: 500;
            }
            
            .avatar-tab:hover:not(.active) {
                background-color: #e9ecef;
            }
            
            .avatar-selector-body {
                flex: 1;
                padding: 20px;
                overflow-y: auto;
            }
            
            .avatar-options {
                display: none;
            }
            
            .avatar-options.active {
                display: block;
            }
            
            /* È¢ÑËÆæÂ§¥ÂÉèÁΩëÊ†º */
            .preset-avatar-grid {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 12px;
            }
            
            .preset-avatar-item {
                aspect-ratio: 1;
                border-radius: 12px;
                cursor: pointer;
                border: 3px solid transparent;
                transition: all 0.2s ease;
                background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 18px;
                font-weight: bold;
                position: relative;
                overflow: hidden;
            }
            
            .preset-avatar-item:hover {
                transform: scale(1.05);
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            }
            
            .preset-avatar-item.selected {
                border-color: #199AFF;
                transform: scale(1.1);
                box-shadow: 0 6px 20px rgba(25, 154, 255, 0.4);
            }
            
            .preset-avatar-item img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                border-radius: 8px;
            }
            
            /* ‰∏ä‰º†Âå∫Âüü */
            .upload-zone {
                border: 2px dashed #ddd;
                border-radius: 12px;
                padding: 40px 20px;
                text-align: center;
                cursor: pointer;
                transition: all 0.2s ease;
                background-color: #f8f9fa;
            }
            
            .upload-zone:hover {
                border-color: #199AFF;
                background-color: rgba(25, 154, 255, 0.05);
            }
            
            .upload-icon {
                font-size: 48px;
                margin-bottom: 12px;
                color: #666;
            }
            
            .upload-text {
                font-size: 16px;
                color: #333;
                margin-bottom: 8px;
                font-weight: 500;
            }
            
            .upload-hint {
                font-size: 12px;
                color: #666;
            }
            
            /* URLËæìÂÖ•Âå∫Âüü */
            .url-input-zone {
                padding: 20px;
                text-align: center;
            }
            
            .url-input-title {
                font-size: 16px;
                color: #333;
                margin-bottom: 15px;
                font-weight: 500;
            }
            
            .url-input {
                width: 100%;
                padding: 12px 16px;
                border: 2px solid #e9ecef;
                border-radius: 8px;
                font-size: 14px;
                transition: all 0.2s ease;
                box-sizing: border-box;
            }
            
            .url-input:focus {
                outline: none;
                border-color: #199AFF;
                box-shadow: 0 0 0 3px rgba(25, 154, 255, 0.1);
            }
            
            .url-input-hint {
                font-size: 12px;
                color: #666;
                margin-top: 8px;
            }
            
            .url-preview-container {
                margin-top: 20px;
                padding: 15px;
                border: 1px solid #e9ecef;
                border-radius: 8px;
                background-color: #f8f9fa;
            }
            
            .url-preview-title {
                font-size: 14px;
                color: #333;
                margin-bottom: 10px;
                font-weight: 500;
            }
            
            .url-preview-image {
                max-width: 120px;
                max-height: 120px;
                border-radius: 8px;
                object-fit: cover;
                border: 2px solid #e9ecef;
            }
            
            .avatar-selector-actions {
                padding: 15px 20px;
                background-color: #f8f9fa;
                display: flex;
                gap: 10px;
                border-top: 1px solid #e9ecef;
            }
            
            .avatar-action-btn {
                flex: 1;
                padding: 10px 16px;
                border: none;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
            .avatar-cancel-btn {
                background-color: #f8f9fa;
                color: #666;
                border: 1px solid #e9ecef;
            }
            
            .avatar-cancel-btn:hover {
                background-color: #e9ecef;
            }
            
            .avatar-confirm-btn {
                background: linear-gradient(135deg, #199AFF, #0066CC);
                color: white;
            }
            
            .avatar-confirm-btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(25, 154, 255, 0.3);
            }
            
            .avatar-confirm-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
            }
            
            /* Ê∑ªÂä†ÊåâÈíÆhoverÊïàÊûú */
            .add-button {
                cursor: pointer;
                transition: all 0.2s ease;
                border-radius: 50%;
                padding: 4px;
            }
            
            .add-button:hover {
                background-color: rgba(25, 154, 255, 0.1);
                transform: scale(1.1);
            }
            
            /* ==================== ËÅîÁ≥ª‰∫∫ÂàÜÁªÑÂäüËÉΩÊ†∑Âºè ==================== */
            
            /* ÂàÜÁªÑÁÆ°ÁêÜÊåâÈíÆ */
            .group-manage-btn {
                position: absolute;
                top: 15px;
                right: 70px;
                background: linear-gradient(135deg, #199AFF, #0066CC);
                color: white;
                border: none;
                border-radius: 6px;
                padding: 6px 12px;
                font-size: 12px;
                cursor: pointer;
                transition: all 0.2s ease;
                z-index: 100;
            }
            
            .group-manage-btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(25, 154, 255, 0.3);
            }
            
            /* ÂàÜÁªÑÂÆπÂô® */
            .contact-group {
                margin-bottom: 8px;
                border-radius: 8px;
                overflow: hidden;
                background-color: #f8f9fa;
                border: 1px solid #e9ecef;
                transition: all 0.3s ease;
            }
            
            .contact-group.dragging {
                opacity: 0.7;
                transform: scale(0.98);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            }
            
            /* Êú™ÂàÜÁªÑÂå∫ÂüüÊ†∑Âºè */
            .ungrouped-contacts {
                margin-top: 15px;
                padding: 10px;
                border: 1px dashed #ddd;
                border-radius: 8px;
                background-color: #fafafa;
                position: relative;
            }
            
            .ungrouped-header {
                font-size: 12px;
                color: #666;
                margin-bottom: 10px;
                font-weight: 500;
            }
            
            .ungrouped-drop-zone {
                position: absolute;
                top: 30px;
                left: 0;
                right: 0;
                bottom: 0;
                border-radius: 6px;
                z-index: 1;
            }
            
            /* ÊãñÊãΩÊó∂ÁöÑËßÜËßâÂèçÈ¶à */
            .QQ_home_usermsg.dragging {
                opacity: 0.5;
                transform: rotate(5deg);
            }
            
            .drop-zone.active {
                border: 2px dashed #199AFF;
                background-color: rgba(25, 154, 255, 0.1);
                animation: pulse 2s infinite;
            }
            
            @keyframes pulse {
                0% { opacity: 0.1; }
                50% { opacity: 0.3; }
                100% { opacity: 0.1; }
            }
            
            /* Áæ§ËÅäÊàêÂëòÊï∞ÊòæÁ§∫ */
            .group-member-count {
                position: absolute;
                right: 15px;
                top: 50%;
                transform: translateY(-50%);
                font-size: 12px;
                color: #999;
                background-color: #f0f0f0;
                padding: 2px 6px;
                border-radius: 10px;
                min-width: 20px;
                text-align: center;
            }
            
            /* ÂàÜÁªÑÊ†áÈ¢òÊ†è */
            .group-header {
                display: flex;
                align-items: center;
                padding: 12px 15px;
                background: linear-gradient(135deg, #f8f9fa, #e9ecef);
                cursor: pointer;
                border-bottom: 1px solid #dee2e6;
                position: relative;
            }
            
            .group-header:hover {
                background: linear-gradient(135deg, #e9ecef, #dee2e6);
            }
            
            /* ÂàÜÁªÑÊãñÊãΩÊâãÊüÑ */
            .group-drag-handle {
                margin-right: 8px;
                color: #999;
                cursor: grab;
                font-size: 14px;
                transition: color 0.2s;
            }
            
            .group-drag-handle:hover {
                color: #666;
            }
            
            .group-drag-handle:active {
                cursor: grabbing;
            }
            
            /* ÂàÜÁªÑÊäòÂè†ÂõæÊ†á */
            .group-toggle {
                margin-right: 8px;
                color: #666;
                font-size: 12px;
                transition: transform 0.3s ease;
                cursor: pointer;
            }
            
            .group-toggle.collapsed {
                transform: rotate(-90deg);
            }
            
            /* ÂàÜÁªÑÂêçÁß∞ */
            .group-name {
                flex: 1;
                font-size: 14px;
                font-weight: 500;
                color: #333;
                cursor: pointer;
                padding: 2px 4px;
                border-radius: 4px;
                transition: background-color 0.2s;
            }
            
            .group-name:hover {
                background-color: rgba(25, 154, 255, 0.1);
            }
            
            .group-name.editing {
                background-color: white;
                border: 2px solid #199AFF;
                outline: none;
            }
            
            /* ÂàÜÁªÑÊàêÂëòÊï∞Èáè */
            .group-count {
                background-color: #199AFF;
                color: white;
                border-radius: 10px;
                padding: 2px 6px;
                font-size: 11px;
                font-weight: 500;
                margin-left: 8px;
            }
            
            /* ÂàÜÁªÑÂà†Èô§ÊåâÈíÆ */
            .group-delete-btn {
                margin-left: 8px;
                color: #dc3545;
                cursor: pointer;
                padding: 2px 4px;
                border-radius: 4px;
                font-size: 12px;
                opacity: 0;
                transition: all 0.2s;
            }
            
            .group-header:hover .group-delete-btn {
                opacity: 1;
            }
            
            .group-delete-btn:hover {
                background-color: #dc3545;
                color: white;
            }
            
            /* ÂàÜÁªÑÂÜÖÂÆπÂå∫Âüü */
            .group-content {
                padding: 0;
                background-color: white;
                transition: all 0.3s ease;
                overflow: hidden;
            }
            
            .group-content.collapsed {
                max-height: 0;
                padding: 0;
                border-top: none;
            }
            
            .group-content.expanded {
                max-height: 1000px;
            }
            
            /* ÂàÜÁªÑÂÜÖÁöÑËÅîÁ≥ª‰∫∫È°π */
            .group-content .QQ_home_usermsg {
                margin: 0;
                padding: 12px 20px;
                border-bottom: 1px solid #f0f0f0;
                position: relative;
                transition: all 0.2s ease;
            }
            
            .group-content .QQ_home_usermsg:last-child {
                border-bottom: none;
            }
            
            .group-content .QQ_home_usermsg:hover {
                background-color: #f8f9fa;
                transform: translateX(4px);
            }
            
            .group-content .QQ_home_usermsg.dragging {
                opacity: 0.5;
                transform: scale(0.95);
            }
            
            /* Êú™ÂàÜÁªÑËÅîÁ≥ª‰∫∫Âå∫Âüü */
            .ungrouped-contacts {
                margin-top: 10px;
            }
            
            .ungrouped-header {
                padding: 10px 15px;
                font-size: 12px;
                color: #999;
                background-color: #f8f9fa;
                border-top: 1px solid #e9ecef;
                border-bottom: 1px solid #e9ecef;
            }
            
            /* ÊãñÊãΩÊèêÁ§∫Âå∫Âüü */
            .drop-zone {
                min-height: 40px;
                border: 2px dashed #ddd;
                border-radius: 8px;
                margin: 5px 0;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #999;
                font-size: 12px;
                transition: all 0.2s;
                opacity: 0;
                transform: scaleY(0);
            }
            
            .drop-zone.active {
                opacity: 1;
                transform: scaleY(1);
                border-color: #199AFF;
                background-color: rgba(25, 154, 255, 0.1);
                color: #199AFF;
            }
            
            /* Êñ∞Âª∫ÂàÜÁªÑÂºπÁ™ó */
            .new-group-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(4px);
            }
            
            .new-group-dialog {
                background-color: white;
                border-radius: 12px;
                padding: 24px;
                width: 280px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                animation: modalSlideIn 0.3s ease-out;
            }
            
            .new-group-title {
                font-size: 16px;
                font-weight: bold;
                margin-bottom: 16px;
                color: #333;
            }
            
            .new-group-input {
                width: 100%;
                padding: 10px 12px;
                border: 2px solid #e9ecef;
                border-radius: 8px;
                font-size: 14px;
                outline: none;
                transition: border-color 0.2s;
                box-sizing: border-box;
                margin-bottom: 16px;
            }
            
            .new-group-input:focus {
                border-color: #199AFF;
            }
            
            .new-group-actions {
                display: flex;
                gap: 10px;
            }
            
            .new-group-btn {
                flex: 1;
                padding: 10px 16px;
                border: none;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
            .new-group-cancel {
                background-color: #f8f9fa;
                color: #666;
                border: 1px solid #e9ecef;
            }
            
            .new-group-cancel:hover {
                background-color: #e9ecef;
            }
            
            .new-group-confirm {
                background: linear-gradient(135deg, #199AFF, #0066CC);
                color: white;
            }
            
            .new-group-confirm:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(25, 154, 255, 0.3);
            }

            /* Áæ§ÁªÑÊàêÂëò‰∏ãÊãâËèúÂçïÊ†∑Âºè */
            .group-member-dropdown {
                position: absolute;
                top: 100%;
                left: 0;
                width: 250px;
                max-height: 300px;
                background: white;
                border: 1px solid #ddd;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
                z-index: 1000;
                overflow-y: auto;
                padding: 8px 0;
                margin-top: 4px;
            }

            .group-member-dropdown .member-item {
                display: flex;
                align-items: center;
                padding: 8px 12px;
                cursor: pointer;
                transition: background-color 0.2s;
            }

            .group-member-dropdown .member-item:hover {
                background-color: #f5f5f5;
            }

            .group-member-dropdown .member-avatar {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                margin-right: 10px;
                object-fit: cover;
                border: 1px solid #eee;
            }

            .group-member-dropdown .member-name {
                font-size: 14px;
                color: #333;
                font-weight: 500;
            }

            .group-member-dropdown .dropdown-header {
                padding: 8px 12px;
                font-size: 12px;
                color: #666;
                font-weight: bold;
                border-bottom: 1px solid #eee;
                margin-bottom: 4px;
            }

            /* Á°Æ‰øùÁæ§ÁªÑÊ†áÈ¢òÂèØÁÇπÂáªÁöÑÊ†∑Âºè */
            .chat-title.clickable {
                cursor: pointer;
                user-select: none;
                position: relative;
            }

            .chat-title.clickable:hover {
                text-decoration: underline;
            }
            /* Á≥ªÁªüÊ∂àÊÅØÊ†∑Âºè */
            .system-message {
                text-align: center;
                font-size: 12px;
                color: #999;
                padding: 8px 0;
                width: 100%;
                box-sizing: border-box;
            }
        </style>
    </head>
    <body>
        <div class="card">
            <div class="btn1"></div>
            <div class="btn2"></div>
            <div class="btn3"></div>
            <div class="btn4"></div>
            <div class="dinbu">
                <span id="time">18:58</span>
                <div
                    style="
                        display: flex;
                        align-items: center;
                        justify-self: end;
                        gap: 2px;
                    "
                >
                    <svg viewBox="0 0 1024 1024" width="16" height="15">
                        <path
                            d="M926.634667 294.912a32 32 0 1 1-39.936 50.005333C780.512 260.128 649.824 213.333333 512.053333 213.333333c-137.813333 0-268.544 46.826667-374.752 131.669334a32 32 0 1 1-39.936-50.005334C214.784 201.194667 359.562667 149.333333 512.053333 149.333333c152.437333 0 297.173333 51.818667 414.581334 145.578667z m-235.413334 298.133333a32 32 0 0 1-38.442666 51.178667A233.418667 233.418667 0 0 0 512.021333 597.333333c-51.541333 0-100.48 16.629333-140.8 46.912a32 32 0 1 1-38.442666-51.157333A297.408 297.408 0 0 1 512.021333 533.333333c65.504 0 127.893333 21.184 179.2 59.722667z m128-149.344a32 32 0 0 1-38.442666 51.168C703.829333 437.066667 610.378667 405.333333 512.032 405.333333c-98.368 0-191.850667 31.754667-268.8 89.578667a32 32 0 1 1-38.453333-51.157333C292.736 377.664 399.669333 341.333333 512.032 341.333333c112.32 0 219.242667 36.309333 307.189333 102.368zM512 853.333333a64 64 0 1 1 0-128 64 64 0 0 1 0 128z"
                            fill="currentColor"
                        ></path>
                    </svg>
                    <span>78%</span>
                    <svg
                        viewBox="0 0 1024 1024"
                        width="20"
                        height="20"
                        style="justify-self: end; margin-right: 13px"
                    >
                        <path
                            d="M984.2 434.8c-5-2.9-8.2-8.2-8.2-13.9v-99.3c0-53.6-43.9-97.5-97.5-97.5h-781C43.9 224 0 267.9 0 321.5v380.9C0 756.1 43.9 800 97.5 800h780.9c53.6 0 97.5-43.9 97.5-97.5v-99.3c0-5.8 3.2-11 8.2-13.9 23.8-13.9 39.8-39.7 39.8-69.2v-16c0.1-29.6-15.9-55.5-39.7-69.3zM912 702.5c0 12-6.2 19.9-9.9 23.6-3.7 3.7-11.7 9.9-23.6 9.9h-781c-11.9 0-19.9-6.2-23.6-9.9-3.7-3.7-9.9-11.7-9.9-23.6v-381c0-11.9 6.2-19.9 9.9-23.6 3.7-3.7 11.7-9.9 23.6-9.9h780.9c11.9 0 19.9 6.2 23.6 9.9 3.7 3.7 9.9 11.7 9.9 23.6v381z"
                            p-id="4287"
                            fill="currentColor"
                        ></path>
                        <path
                            d="M736 344v336c0 8.8-7.2 16-16 16H112c-8.8 0-16-7.2-16-16V344c0-8.8 7.2-16 16-16h608c8.8 0 16 7.2 16 16z"
                            p-id="4288"
                            fill="currentColor"
                        ></path>
                    </svg>
                </div>
            </div>
            <div class="card-int">
                <div
                    class="page_button"
                    style="background-color: none; display: none"
                    id="page_button"
                >
                    <div
                        style="
                            width: 45px;
                            display: flex;
                            justify-content: center;
                            height: 20px;
                        "
                        onclick="gotopage(1)"
                    >
                        <svg viewBox="0 0 1024 1024" width="20" height="20">
                            <path
                                d="M810.666667 213.333333a42.666667 42.666667 0 0 1 42.368 37.674667L853.333333 256v274.304c0 79.274667-50.944 147.498667-120.490666 152.106667L725.333333 682.666667H273.706667l97.792 97.834666a42.666667 42.666667 0 0 1-56.32 63.872l-4.010667-3.541333-170.666667-170.666667a42.666667 42.666667 0 0 1 0-60.330666l170.666667-170.666667a42.666667 42.666667 0 0 1 63.872 56.32l-3.541333 4.010667L273.706667 597.333333H725.333333c19.584 0 39.936-24.618667 42.410667-59.861333l0.256-7.168V256a42.666667 42.666667 0 0 1 42.666667-42.666667z"
                                fill="#000000"
                                p-id="13502"
                            ></path>
                        </svg>
                    </div>
                    <div
                        style="
                            width: 45px;
                            display: flex;
                            justify-content: center;
                        "
                        onclick="gotopage(0)"
                    >
                        <svg
                            t="1736242335450"
                            class="icon"
                            viewBox="0 0 1024 1024"
                            version="1.1"
                            xmlns="http://www.w3.org/2000/svg"
                            p-id="8709"
                            width="20"
                            height="20"
                        >
                            <path
                                d="M762.3 565.3c0-19 15.7-34.1 34.7-34.1 19 0 34.2 15.1 34.2 34.1v336.3c0 19-15.2 34.4-34.2 34.4H229.6c-19.1 0-34.7-15.4-34.7-34.4V565.3c0-19 15.7-34.1 34.7-34.1 18.6 0 34.2 15.1 34.2 34.1v301.9h498.5V565.3z m-638.2 9.3l388.8-387.8 389.3 387.8c13.2 13.2 35.2 13.2 48.4 0 13.4-13.2 13.4-35.1 0-48.3L538 114.1l-0.7-0.5c-13.4-13.2-35.2-13.2-48.6 0l-413 412.6c-13.6 13.2-13.6 35.1 0 48.3 13.2 13.2 35.2 13.2 48.4 0.1z"
                                fill="#231815"
                                p-id="8710"
                            ></path>
                        </svg>
                    </div>
                    <div
                        style="
                            width: 45px;
                            display: flex;
                            justify-content: center;
                        "
                        onclick="gotopage(-1)"
                    >
                        <svg
                            t="1736242697753"
                            class="icon"
                            viewBox="0 0 1024 1024"
                            version="1.1"
                            xmlns="http://www.w3.org/2000/svg"
                            p-id="9742"
                            width="20"
                            height="20"
                        >
                            <path
                                d="M622.650611 284.901749 447.745069 284.901749 447.745069 142.823869 63.980685 334.705038l383.76336 191.882192L447.744046 384.834762l189.391465 0c149.914358 0 224.855164 62.789045 224.855164 188.368158 0 129.928165-77.435627 194.876386-232.338602 194.876386L187.952184 768.079306l0 99.93199L634.146433 868.011296c211.184817 0 316.777737-95.104031 316.777737-285.311071C950.924169 384.178823 841.510224 284.901749 622.650611 284.901749z"
                                fill="#272636"
                                p-id="9743"
                            ></path>
                        </svg>
                    </div>
                </div>
                <div id="Home_page" style="display: none">
                    <div class="dibu">
                        <svg
                            viewBox="0 0 1024 1024"
                            style="width: 4.1rem; height: 4.1rem"
                        >
                            <path
                                d="M510.798639 124.660184c-213.447347 0-386.480238 173.029822-386.480238 386.480238 0 213.446323 173.029822 386.475122 386.480238 386.475122 213.446323 0 386.475122-173.029822 386.475122-386.475122C897.274784 297.690006 724.244962 124.660184 510.798639 124.660184L510.798639 124.660184 510.798639 124.660184zM510.798639 864.019379c-194.883549 0-352.884073-158.001547-352.884073-352.879979 0-194.883549 158.000524-352.884073 352.884073-352.884073 194.878432 0 352.883049 158.000524 352.883049 352.884073C863.678618 706.017832 705.677071 864.019379 510.798639 864.019379L510.798639 864.019379 510.798639 864.019379zM588.978209 546.374902c-17.681708 0-31.070646 15.915481-47.113017 15.915481-15.910365 0-85.756129-68.836785-85.756129-85.761246 0-16.920368 15.914458-25.258267 15.914458-42.813085 0-12.632715-47.107901-89.925079-66.432015-89.925079-19.328207 0-66.436108 34.479279-66.436108 66.433038 0 92.455715 170.506349 269.653463 277.230022 269.653463 29.427216 0 66.437132-31.070646 66.437132-66.437132C683.071214 600.178295 606.532003 546.374902 588.978209 546.374902"
                                fill="#09B245"
                                p-id="6003"
                            ></path>
                        </svg>
                        <svg
                            viewBox="0 0 1066 1024"
                            style="width: 3.3rem; height: 3.3rem"
                        >
                            <path
                                d="M548.48 0c282.752 0 512 229.248 512 512s-229.248 512-512 512c-282.794667 0-512-229.248-512-512s229.205333-512 512-512z m0 42.666667c-259.242667 0-469.333333 210.133333-469.333333 469.333333s210.090667 469.333333 469.333333 469.333333c259.2 0 469.333333-210.133333 469.333333-469.333333s-210.133333-469.333333-469.333333-469.333333z m0 173.952c168.234667 0 304.597333 118.186667 304.597333 263.936 0 145.792-136.362667 263.978667-304.64 263.978666a348.757333 348.757333 0 0 1-73.130666-7.68c-36.010667 22.357333-109.866667 70.528-109.866667 70.528s-0.341333-76.672 0-115.797333c-73.813333-48.128-121.6-124.757333-121.6-211.029333 0-145.749333 136.362667-263.936 304.64-263.936z m-129.706667 223.658666a40.448 40.448 0 0 0-40.533333 40.32 40.448 40.448 0 0 0 40.533333 40.32c22.4 0 40.533333-18.005333 40.533334-40.32a40.448 40.448 0 0 0-40.533334-40.32z m135.850667 0a40.448 40.448 0 0 0-40.576 40.32 40.448 40.448 0 0 0 40.533333 40.32 40.448 40.448 0 0 0 40.618667-40.32 40.490667 40.490667 0 0 0-40.576-40.32z m135.850667 0a40.490667 40.490667 0 0 0-40.576 40.32 40.448 40.448 0 0 0 40.576 40.32 40.448 40.448 0 0 0 40.533333-40.32 40.448 40.448 0 0 0-40.533333-40.32z"
                                fill="#2397FF"
                                p-id="9807"
                            ></path>
                        </svg>
                        <svg
                            viewBox="0 0 1024 1024"
                            style="width: 4rem; height: 4rem"
                        >
                            <path
                                d="M441.05 164.53c49.52-9.62 101.09-8.57 150.18 3.06 43.01 10.18 84.04 28.57 120.29 53.84 65.19 45.14 114.56 112.69 137.32 188.68 20.42 67.17 20.07 140.33-0.41 207.44l-0.13 0.46c-23.01-53.51-74.79-93.34-132.27-102.5l-0.01-0.11c0.47-40.52-11.14-81.12-33.35-115.06-22.75-35.1-56.37-63.06-95.1-78.89-39.94-16.49-85.1-19.84-127.09-9.72-39.19 9.32-75.35 30.59-102.8 60.04-28.81 30.73-47.9 70.45-53.65 112.2-6.29 44.14 2.08 90.27 23.8 129.23 19.43 35.16 49.34 64.4 84.89 83.08 30.24 16.01 64.53 24.1 98.72 23.74h0.11c7.41 46.72 35.01 89.65 73.93 116.41 9 6.11 18.38 11.95 28.55 15.85l-0.56 0.16c-69.43 21.22-145.37 20.78-214.4-1.82-75.89-24.48-142.72-75.63-186.49-142.25-23.43-35.39-40.37-75.04-49.76-116.43-11.55-50.94-11.75-104.42-0.53-155.44 14.59-67.14 49.51-129.62 98.75-177.51 49.09-48.12 112.46-81.52 180.01-94.46z"
                                fill="#5C5CEF"
                                p-id="22508"
                            ></path>
                            <path
                                d="M596.41 537.54c35.61-21.21 78.78-28.95 119.61-22.14l0.01 0.11c-0.55 37.38-11.1 74.74-31.06 106.43-16.48 26.73-39.2 49.58-65.79 66.26-31.95 20.42-69.77 31.29-107.63 31.82h-0.11c-5.28-31.73-1.94-64.9 9.96-94.81 14.36-36.47 41.23-67.8 75.01-87.67zM848.3 618.01l0.13-0.46c12.06 27.01 17.34 56.99 15.05 86.49-3.04 42.37-22.11 83.28-52.48 112.96-17.34 17.04-38.17 30.6-60.92 39.23-43.64 17.04-93.93 15.35-136.61-3.79l0.56-0.16c37.37-11.79 72.97-29.37 104.52-52.68 11.87-9.03 23.82-18.11 34.23-28.85 2.98-3 6.62-5.3 9.3-8.61 4.52-5.81 10.34-10.43 14.84-16.26 32.42-37 56.69-80.95 71.38-127.87z"
                                fill="#19FFDC"
                                p-id="22509"
                            ></path>
                            <path
                                d="M716.03 515.51c57.48 9.16 109.26 48.99 132.27 102.5-14.69 46.92-38.96 90.87-71.38 127.87-4.5 5.83-10.32 10.45-14.84 16.26-2.68 3.31-6.32 5.61-9.3 8.61-10.41 10.74-22.36 19.82-34.23 28.85-31.55 23.31-67.15 40.89-104.52 52.68-10.17-3.9-19.55-9.74-28.55-15.85-38.92-26.76-66.52-69.69-73.93-116.41 37.86-0.53 75.68-11.4 107.63-31.82 26.59-16.68 49.31-39.53 65.79-66.26 19.96-31.69 30.51-69.05 31.06-106.43z"
                                fill="#09EFDA"
                                p-id="22510"
                            ></path>
                        </svg>
                        <svg
                            viewBox="0 0 1024 1024"
                            style="width: 3.7rem; height: 3.7rem"
                        >
                            <path
                                d="M517.116019 967.737602c-120.532167 0-233.850026-46.937009-319.079152-132.165112C112.80774 750.341317 65.870732 637.025505 65.870732 516.492314c0-120.532167 46.938032-233.850026 132.166135-319.079152C283.26497 112.184035 396.583852 65.246003 517.116019 65.246003c120.53319 0 233.850026 46.938032 319.079152 132.166135s132.166135 198.546985 132.166135 319.079152c0 120.53319-46.937009 233.849002-132.166135 319.079152C750.966045 920.79957 637.64921 967.737602 517.116019 967.737602zM517.116019 108.790752c-108.901269 0-211.284077 42.407855-288.287869 119.41267S109.41548 407.591045 109.41548 516.492314s42.407855 211.283054 119.41267 288.286846c77.003791 77.005838 179.3866 119.413694 288.287869 119.413694s211.284077-42.407855 288.287869-119.413694c77.005838-77.003791 119.41267-179.385577 119.41267-288.286846s-42.406832-211.284077-119.41267-288.288892C728.400097 151.198607 626.017288 108.790752 517.116019 108.790752z"
                                fill="#2c2c2c"
                                p-id="39954"
                            ></path>
                            <path
                                d="M693.052031 355.056552l-58.175981 0c0-32.129768-26.049283-58.177004-58.179051-58.177004L460.345038 296.879548c-32.127721 0-58.177004 26.047236-58.177004 58.177004l-58.179051 0c-32.127721 0-58.175981 26.046213-58.175981 58.173934l0 232.69983c0 32.127721 26.048259 58.172911 58.175981 58.172911l349.063047 0c32.129768 0 58.178027-26.045189 58.178027-58.172911l0-232.69983c0-32.127721-26.047236-58.177004-58.178027-58.177004L693.052031 355.056552zM519.453251 614.775758c-49.109488 0-88.929402-39.814798-88.929402-88.922239 0-49.110511 39.819914-88.927355 88.929402-88.927355 49.111534 0 88.930425 39.816844 88.930425 88.927355C608.383676 574.959937 568.564785 614.775758 519.453251 614.775758L519.453251 614.775758zM519.453251 614.775758"
                                fill="#2c2c2c"
                                p-id="39955"
                            ></path>
                        </svg>
                    </div>
                    <div class="zhong">
                        <div
                            style="
                                display: flex;
                                align-items: center;
                                gap: 10px;
                            "
                        >
                            <svg
                                viewBox="0 0 1024 1024"
                                style="width: 3rem; height: 3rem"
                            >
                                <path
                                    d="M509.014999 512.046737m-262.543634 0a262.543634 262.543634 0 1 0 525.087268 0 262.543634 262.543634 0 1 0-525.087268 0Z"
                                    fill="#FFD54F"
                                    p-id="51646"
                                ></path>
                                <path
                                    d="M510.601314 0.11053c0 1.705715 67.222223 48.391131 67.222223 91.886861a62.224479 62.224479 0 0 1-67.222223 65.618851 62.224479 62.224479 0 0 1-67.222224-65.635908c0-43.495729 67.222223-93.575518 67.222224-91.869804z"
                                    fill="#FFD54F"
                                    p-id="51647"
                                ></path>
                                <path
                                    d="M869.21081 155.364698c-1.228115 1.194 11.940004 81.9596-19.342807 112.184868a62.224479 62.224479 0 0 1-93.933718-2.695029 62.224479 62.224479 0 0 1 0.460543-93.950776c31.282811-30.225268 114.044097-16.716006 112.815982-15.539063z"
                                    fill="#FFD54F"
                                    p-id="51648"
                                ></path>
                                <path
                                    d="M1022.571634 513.411308c-1.705715-0.034114-49.53396 66.40348-93.029689 65.670023a62.241536 62.241536 0 0 1-64.527194-68.347995 62.241536 62.241536 0 0 1 66.778738-66.113509c43.495729 0.750515 92.483861 68.825595 90.778145 68.791481z"
                                    fill="#FFD54F"
                                    p-id="51649"
                                ></path>
                                <path
                                    d="M869.176695 868.660546c-1.228115-1.176943-81.499057 14.754434-112.781867-15.453777a62.224479 62.224479 0 0 1-0.545829-93.984889 62.224479 62.224479 0 0 1 93.899604-2.763259c31.299868 30.225268 20.656207 113.395925 19.44515 112.218982z"
                                    fill="#FFD54F"
                                    p-id="51650"
                                ></path>
                                <path
                                    d="M510.601314 1023.948829c0-1.705715 67.222223-48.391131 67.222223-91.886861a62.224479 62.224479 0 0 0-67.222223-65.584737 62.224479 62.224479 0 0 0-67.222224 65.584737c0 43.495729 67.222223 93.558461 67.222224 91.886861z"
                                    fill="#FFD54F"
                                    p-id="51651"
                                ></path>
                                <path
                                    d="M154.891533 155.330584c1.228115 1.194-11.940004 81.976657 19.342807 112.201925a62.224479 62.224479 0 0 0 93.916661-2.729144 62.224479 62.224479 0 0 0-0.4776-93.933718c-31.299868-30.259382-113.975868-16.698949-112.781868-15.522006z"
                                    fill="#FFD54F"
                                    p-id="51652"
                                ></path>
                                <path
                                    d="M1.445423 513.34308c1.705715-0.034114 49.53396 66.40348 93.029689 65.670023a62.241536 62.241536 0 0 0 64.49308-68.347995 62.241536 62.241536 0 0 0-66.778738-66.113509c-43.529844 0.750515-92.415632 68.825595-90.744031 68.791481z"
                                    fill="#FFD54F"
                                    p-id="51653"
                                ></path>
                                <path
                                    d="M154.942705 868.660546c1.228115-1.176943 81.516114 14.720319 112.781867-15.522005a62.224479 62.224479 0 0 0 0.477601-93.933719 62.224479 62.224479 0 0 0-93.916662-2.729143c-31.299868 30.259382-20.536807 113.361811-19.342806 112.201924z"
                                    fill="#FFD54F"
                                    p-id="51654"
                                ></path>
                            </svg>
                            <span>22¬∞</span>
                        </div>
                        <div
                            style="
                                display: flex;
                                flex-direction: column;
                                justify-self: end;
                                align-items: end;
                                font-size: inherit;
                                gap: 7px;
                            "
                        >
                            <span>Êó•Êú¨Â∏Ç</span> <span id="day">1Êúà4Êó•</span>
                        </div>
                    </div>
                    <div class="app">
                        <div
                            style="
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                            "
                            class="app-svg-div"
                        >
                            <svg viewBox="0 0 1024 1024" width="64" height="64">
                                <path
                                    d="M763.776 968.576H261.504C147.456 968.576 55.04 876.16 55.04 762.112V259.84c0-114.048 92.416-206.464 206.464-206.464h502.272C877.824 53.376 970.24 145.792 970.24 259.84v502.272c0 114.048-92.416 206.464-206.464 206.464z"
                                    fill="#009CF5"
                                    p-id="52731"
                                ></path>
                                <path
                                    d="M529.792 586.496h-100.48l75.648-130.56 7.68-13.312 51.84-89.088 9.984-17.408 21.504-36.864c9.472-16.128 9.728-36.864-1.024-52.096-9.216-13.056-22.4-18.304-35.456-18.304-15.36 0-30.336 7.936-38.784 22.272l-7.68 13.568-7.936-13.568c-8.448-14.336-23.552-22.272-38.784-22.272-7.68 0-15.36 1.792-22.528 5.888-21.248 12.288-28.544 39.808-16.128 61.056l33.408 57.728-135.168 233.216H238.08c-26.88 0.256-48.384 24.064-44.16 52.096 3.328 22.016 23.936 37.376 46.208 37.376h33.92l103.424-0.256H583.936c3.84 0 7.68-1.664 9.984-4.736 11.776-15.744 20.48-40.192-8.32-65.408-15.232-13.44-35.584-19.328-55.808-19.328z"
                                    fill="#FFFFFF"
                                    p-id="52732"
                                ></path>
                                <path
                                    d="M785.28 586.24h-86.016l-115.072-198.528c-2.048-3.456-6.656-4.608-9.856-2.304-16.128 11.648-25.6 27.904-30.464 45.824-8.192 30.208-1.408 62.592 14.208 89.728l24.704 42.88 13.056 22.784 51.84 89.344 5.376 8.96 49.792 86.016c8.448 14.336 23.296 22.272 38.528 22.272 7.68 0 15.616-2.048 22.784-6.144 21.248-12.288 28.544-39.552 16.128-61.056l-29.056-50.304h36.224c26.88 0 48.256-24.32 43.904-52.352-3.584-21.888-23.936-37.12-46.08-37.12zM319.616 687.616c-15.744-6.4-30.592-5.632-42.496-2.304-6.528 1.792-11.904 6.272-15.232 12.032l-16.64 28.416c-12.544 21.504-5.12 48.768 16.128 61.056 7.168 4.096 15.104 6.144 22.784 6.144 15.36 0 30.08-7.936 38.272-22.272l18.944-32.64c4.608-8.064 5.504-17.792 2.048-26.368-3.84-9.6-11.008-18.816-23.808-24.064z"
                                    fill="#FFFFFF"
                                    p-id="52733"
                                ></path>
                            </svg>
                            <span>Store</span>
                        </div>
                        <div
                            style="
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                            "
                            class="app-svg-div"
                            data-app="twitter"
                        >
                            <svg viewBox="0 0 1024 1024" width="64" height="64">
                                <path
                                    d="M849.92 51.2H174.08c-67.8656 0-122.88 55.0144-122.88 122.88v675.84c0 67.8656 55.0144 122.88 122.88 122.88h675.84c67.8656 0 122.88-55.0144 122.88-122.88V174.08c0-67.8656-55.0144-122.88-122.88-122.88z m-93.65504 336.5888a317.0816 317.0816 0 0 1 0.4352 16.11776c0 165.16096-126.8224 355.53792-358.656 355.53792-71.14752 0-137.4208-20.72064-193.24416-56.05888a248.6272 248.6272 0 0 0 30.04928 1.7664 254.80704 254.80704 0 0 0 156.56448-53.45792c-55.13728-1.08544-101.67808-37.28384-117.71392-86.79424 7.67488 1.37216 15.616 2.29888 23.74656 2.29888a124.6208 124.6208 0 0 0 33.13152-4.50048c-57.61024-11.47904-101.08416-61.94176-101.08416-122.54208v-1.46432c17.02912 9.216 36.48512 14.96064 57.15456 15.59552-33.85856-22.49728-56.064-60.66688-56.064-104.03328 0-22.81472 6.14912-44.43648 17.06496-62.90432a359.2192 359.2192 0 0 0 259.80416 130.62144 125.37344 125.37344 0 0 1-3.29216-28.50816c0-68.97664 56.42752-124.91264 126.05952-124.91264 36.24448 0 68.96128 15.0784 91.88864 39.40352 28.73344-5.5296 55.7312-16.0256 80.09728-30.30528-9.40032 29.12768-29.42464 53.7856-55.48032 69.24288 25.62048-3.1488 49.8944-9.82016 72.47872-19.82464a247.84384 247.84384 0 0 1-62.94016 64.72192z"
                                    fill="#03A9F4"
                                    p-id="54801"
                                ></path>
                            </svg>
                            <span>Êé®Áâπ</span>
                        </div>
                        <div
                            style="
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                position: relative;
                            "
                            data-app="QQ"
                            class="app-svg-div"
                        >
                            <svg viewBox="0 0 1024 1024" width="64" height="64">
                                <path
                                    d="M887.85832 64.549132 136.14168 64.549132c-39.540552 0-71.591525 32.051997-71.591525 71.590502l0 751.718687c0 39.538505 32.051997 71.591525 71.591525 71.591525l751.71664 0c39.538505 0 71.592548-32.05302 71.592548-71.591525L959.450868 136.139633C959.449845 96.601128 927.396825 64.549132 887.85832 64.549132zM862.687034 644.674719l0 5.110391 0 4.786003-0.860601 5.754051-1.236154 9.869788-1.720178 8.9263-2.636037 8.067746-0.967024 3.307326-1.828648 3.925403-1.560542 2.77009-2.043542 3.413749-1.829671 2.125407-2.311649 2.769067-2.043542 2.204202-2.204202 1.936095-2.636037 1.157359-2.367931 1.155313-1.934049 0.644683-1.694595 0-1.264806 0-1.908466-0.644683-3.631714-1.775436-1.664919-1.182942-1.722224-1.290389-1.910513-1.694595-1.908466-1.908466-3.173273-3.496637-3.765767-5.000897-2.957355-5.109368-2.957355-4.14132-2.877537-4.787026-4.060479-8.496511-4.570085-8.846482-0.537236-0.297782-0.754177 0-1.88186 1.37123-1.075495 2.339278-1.774413 2.851954-3.120061 8.631588-4.679579 12.235672-6.02318 14.653745-4.516874 7.341199-4.76042 7.635911-5.621021 8.606005-5.969968 8.443299-3.064802 3.818979-3.710508 4.142343-8.525164 8.389064 0.754177 0.75213 1.154289 1.182942 4.249791 2.52859 17.748223 8.497535 7.745405 4.356214 7.366781 4.247744 7.313569 5.324262 6.508227 5.539156 3.174296 2.446725 2.366907 2.877537 2.418073 3.279696 2.044566 3.63069 1.077541 2.984984 1.342578 3.603061 0.539282 3.065825 0.64366 3.629667-0.64366 2.447748 0 2.419096-0.539282 2.581802-1.342578 2.312672-0.539282 1.827625-1.182942 2.205225-3.226484 4.383844-2.956332 3.523243-2.312672 2.63399-1.936095 1.936095-4.89345 3.603061-5.54018 3.092431-5.915733 2.984984-6.293333 2.849908-7.098675 2.743484-3.764744 1.181919-3.38919 0.969071-8.175193 1.908466-8.498558 1.801019-8.496511 1.829671-9.250688 1.479701-9.573029 0.402159-9.78997 1.182942-9.680477 0-10.218736 0-10.487865 0-10.970866-0.644683-10.219759-0.940418-10.970866-1.479701-10.917654-1.183965-11.509125-1.612731-11.134595-2.743484L592.539314 853.880461l-10.81123-3.065825-11.078313-3.926426-10.862395-3.307326-5.702885-1.909489-5.109368-1.828648-3.225461-1.237177-3.174296-0.644683-4.142343 0-4.89345 0-10.431583-0.75213-5.298679-0.538259-6.80294-0.751107-4.357238 3.924379-5.969968 3.738138-8.066723 3.952009-8.928347 4.894474-5.431709 2.63399-5.647627 2.125407-12.531408 5.109368-6.80294 1.693572-7.125281 1.936095-9.895371 1.882883-6.185886 0.537236-6.562463 0.537236-6.830569 0.754177-7.959276 0.322341-7.637957 0-7.959276 0-16.914228 0-18.3663-0.322341-17.801435-1.828648-9.035794-1.238201-8.712429-1.290389-8.497535-1.291412-8.497535-1.693572-7.879458-2.555196-7.878434-1.801019-7.099698-2.877537-6.722098-2.63399-6.239098-3.012613-5.431709-3.28072-5.432733-3.926426-1.828648-1.935072-2.420119-2.312672-1.829671-2.042519-1.666966-2.312672-1.50733-2.365884-1.182942-2.312672-1.694595-5.001921-0.618077-2.555196-0.754177-2.876514 0-2.636037 0.754177-2.983961 0-2.986007 0.618077-2.983961 0-1.802042 0-4.140297 0.295735-3.201925 1.39886-3.629667 1.182942-3.603061 2.153036-4.355191 1.558495-1.694595 1.291412-1.908466 3.387144-4.14132 2.689249-2.152013 2.52859-1.478677 2.341325-1.908466 3.736091-1.183965 2.958378-1.77646 3.710508-1.935072 4.248767-1.264806 4.247744-1.290389 4.894474-1.048889 4.678556-0.645706 5.541203-0.751107 5.968945-0.431835 1.586125-0.536212 0.322341 0 0.754177-0.644683 0-0.699941-1.076518-1.506307-3.199878-1.505283-7.958252-6.883781-5.324262-4.248767-6.185886-5.431709-6.239098-6.05081-6.508227-7.770987-7.421017-8.712429-2.796696-4.679579-3.711532-4.894474-3.173273-5.64558-2.850931-6.157233-3.873214-5.834892-2.52859-6.724145-2.984984-6.66684-2.984984-7.476275-2.205225-7.098675-2.043542-8.819876-0.644683-0.323365-0.6191 0-0.322341-0.645706-0.754177 0-1.263783 0.645706-0.645706 0.323365-0.858554 1.478677-0.323365 1.802042-0.644683 1.613754-1.12973 2.63399-3.657296 6.507204-1.882883 3.926426-2.984984 3.388167-3.199878 4.140297-3.496637 4.571109-3.710508 4.061502-4.357238 3.925403-4.059456 3.710508-4.437056 2.877537-4.894474 3.091408-4.678556 1.802042-5.539156 1.39886-5.431709 0.509606-0.537236 0-0.753153 0-1.237177-0.509606-0.969071-2.152013-1.612731-1.048889-2.097778-5.108345-1.290389-2.77009-1.39886-3.925403-1.156336-4.14132-0.6191-4.033873-1.721201-9.249665-0.644683-5.433756 0-5.538133 0-12.31549 0.644683-13.283538 1.076518-6.831592 1.263783-6.990205 1.156336-7.556093 2.043542-7.018857 2.312672-8.094352 2.366907-7.852852 3.174296-8.093329 2.984984-7.745405 4.113691-7.877411 3.873214-8.497535 4.678556-7.985882 5.51255-8.606005 5.621021-7.745405 5.862521-8.603959 4.894474-5.968945 6.265704-6.91141 6.589069-6.910387 3.065825-3.279696 3.736091-3.738138 5.406127-4.705162 5.54018-4.759397 9.03477-8.094352 6.830569-4.975315 2.420119-1.802042-1.344624-4.140297-1.075495-5.431709-0.753153-2.984984 0-3.738138 0-4.463662 0-4.03285 1.290389-4.787026 1.345648-5.109368 1.720178-5.297656 2.341325-5.942339 3.091408-6.184863 4.356214-6.184863 0-4.330632 0.429789-4.060479 0.645706-5.51255 1.88186-6.15621 1.721201-6.696516 1.37123-3.093455 1.586125-2.848884 2.043542-3.200902 2.205225-2.339278 0-4.356214 0-4.894474 0-6.076392 1.290389-7.852852 1.290389-9.143241 2.312672-10.970866 3.173273-11.348466 2.366907-6.290263 2.339278-6.803963 2.555196-6.372128 3.065825-6.80294 3.119037-7.448646 3.604084-6.990205 4.03285-7.476275 5.109368-7.42204 2.340301-4.247744 2.52859-3.523243 5.458315-7.878434 5.592368-7.851828 6.399757-8.067746 6.830569-7.906064 7.42204-7.743358 7.744381-7.959276 9.358135-8.604982 5.969968-5.216815 7.232728-5.646604 7.342222-5.001921 7.959276-4.786003 7.637957-4.248767 8.604982-3.495614 9.143241-4.356214 9.087982-2.984984 9.090029-3.092431 9.787924-3.065825 9.788947-2.339278 10.326183-1.909489 10.432607-1.721201 10.272971-1.370207 10.32516-1.39886 10.972912-0.6191 10.431583 0 10.812253 0 11.18576 0 10.812253 1.37123 10.862395 1.291412 11.078313 1.155313 10.273994 2.474354 10.863419 2.311649 10.19213 2.636037 11.160177 3.01159 10.219759 3.602038 9.7869 4.14132 10.434653 4.356214 9.5454 4.786003 9.250688 5.324262 9.0624 5.862521 7.851828 5.405103 3.604084 3.092431 3.820002 2.204202 7.259334 6.185886 6.132674 5.968945 6.076392 6.157233 5.969968 6.801916 4.894474 6.589069 5.808286 6.80294 4.088108 7.313569 4.113691 6.508227 4.383844 7.554046 3.603061 6.589069 6.131651 13.929244 3.010567 7.207146 2.341325 6.723122 2.339278 7.205099 2.097778 6.831592 1.506307 5.833869 1.88186 6.91141 3.334955 12.316513 2.124384 10.754948 1.370207 10.43363 1.183965 8.389064 1.883907 12.746302 0.429789 2.043542 1.505283 2.311649 4.034896 6.614651 2.579755 4.437056 2.313695 4.705162 2.957355 4.975315 2.580778 5.969968 1.666966 6.157233 1.828648 6.695492 1.39886 6.910387 0.645706 3.388167 0.537236 4.14132 0 3.629667-0.537236 3.63069 0 4.464685-1.076518 4.355191-1.934049 8.391111-2.206248 4.247744-1.611707 4.786003 0 1.182942 0.75213 1.480724 2.205225 3.521197 9.575076 14.144138 7.581676 10.595312 3.604084 7.15291 4.89345 7.743358 4.247744 8.498558 4.89652 9.141194 4.892427 10.219759 5.513574 11.588943 3.090385 7.126304 2.850931 6.883781 2.476401 7.367805 2.420119 6.560416 1.828648 6.939039 1.880837 6.480598 2.365884 12.664438 1.882883 12.961196 1.289366 11.45489L862.688057 644.674719z"
                                    fill="#1296db"
                                    p-id="63263"
                                ></path>
                            </svg>
                            <span>QQ</span>
                            <div
                                class="new_tips"
                                style="
                                    position: absolute;
                                    right: -5px;
                                    top: -5px;
                                    background-color: red;
                                    color: #fff;
                                    width: 25px;
                                    height: 25px;
                                    border-radius: 50%;
                                    display: none;
                                    justify-content: center;
                                    align-items: center;
                                    font-size: 15px;
                                "
                            >
                                1
                            </div>
                        </div>
                        <div
                            style="
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                            "
                            class="app-svg-div"
                        >
                            <svg viewBox="0 0 1024 1024" width="57" height="57">
                                <path
                                    d="M860.16 0C950.272 0 1024 73.889684 1024 164.163368v531.509895s-32.768-4.122947-180.224-53.355789c-40.96-14.362947-96.256-34.896842-157.696-57.478737 36.864-63.595789 65.536-137.485474 86.016-215.444211h-202.752v-71.841684h247.808V256.512h-247.808V135.437474h-100.352c-18.432 0-18.432 18.458947-18.432 18.458947v104.663579H200.704v41.040842h249.856v69.793684H243.712v41.013895H645.12c-14.336 51.307789-34.816 98.519579-57.344 141.608421-129.024-43.115789-268.288-77.985684-356.352-55.403789-55.296 14.362947-92.16 38.992842-112.64 63.595789-96.256 116.978526-26.624 295.504842 176.128 295.504842 120.832 0 237.568-67.718737 327.68-178.526316C757.76 742.858105 1024 853.692632 1024 853.692632v6.144C1024 950.110316 950.272 1024 860.16 1024H163.84C73.728 1024 0 950.137263 0 859.836632V164.163368C0 73.889684 73.728 0 163.84 0h696.32zM268.126316 553.121684c93.049263-10.374737 180.062316 26.974316 283.270737 78.874948-74.886737 95.501474-165.941895 155.701895-256.970106 155.701894-157.830737 0-204.368842-126.652632-125.466947-197.200842 26.300632-22.851368 72.838737-35.301053 99.166316-37.376z"
                                    fill="#00A0EA"
                                    p-id="64921"
                                ></path>
                            </svg>
                            <span>ÊîØ‰ªòÂÆù</span>
                        </div>
                    </div>
                </div>
                <div id="App_Page" style="height: 100%">
                    <div class="twitter" id="App_twitter" style="display: none">
                        <div class="mimictwitter">
                            <div style="margin-right: 8px; margin-top: 10px">
                                <div
                                    style="
                                        display: grid;
                                        grid-template-columns: 1fr 1fr 1fr;
                                        align-items: center;
                                    "
                                >
                                    <div
                                        style="
                                            border-radius: 50%;
                                            width: 32px;
                                            height: 32px;
                                            margin-left: 7px;
                                        "
                                        class="twitter-close-btn user_avatar"
                                    ></div>
                                    <svg
                                        viewBox="0 0 24 24"
                                        style="
                                            width: 24.73px;
                                            height: 54px;
                                            justify-self: center;
                                        "
                                    >
                                        <g>
                                            <path
                                                d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"
                                            ></path>
                                        </g>
                                    </svg>
                                    <svg
                                        style="
                                            margin-left: auto;
                                            width: 24px;
                                            height: 24px;
                                        "
                                        viewBox="0 0 1024 1024"
                                        aria-hidden="true"
                                    >
                                        <g>
                                            <path
                                                d="M596.992 512q0 34.016-24 59.008-12 12-27.488 18.496T512.992 596q-34.016 0-59.008-24.992-4.992-4.992-8.51199999-10.016t-6.49600001-11.008-4.992-12.512-3.48799999-12.992-1.50400001-12.512q0-35.00800001 24.992-59.488t59.488-24.512 59.488 24q7.008 8 12.992 17.504t8.512 20.512T596.96 512z m0 332q0 35.00800001-24 59.008-8 8-17.504 13.504t-20.512 8.512-22.016 3.008q-34.016 0-59.008-24.992-6.016-4.992-10.496-12t-7.488-14.496-4.992-16-2.016-16.512q0-35.00800001 24.992-59.488t59.488-24.51199999 59.488 24.99199999q11.008 11.008 17.504 27.008t6.496 32z m0-664.992q0 35.00800001-24 59.008-8 8-17.504 13.504t-20.512 8.512-22.016 3.00800001q-34.016 0-59.008-24.51200001T428.96 179.04000001t24.992-59.00800001q12-12 27.488-18.496t31.488-6.496q35.00800001 0 60 24.992 11.008 11.008 17.504 27.008t6.496 32z"
                                                fill="#000000"
                                                p-id="1477"
                                            ></path>
                                        </g>
                                    </svg>
                                </div>
                                <div style="margin-top: 13px"></div>
                                <div
                                    style="
                                        display: grid;
                                        grid-template-columns: 1fr 1fr;
                                        align-items: center;
                                        justify-items: center;
                                    "
                                >
                                    <span style="color: #5f6f7b">‰∏∫‰Ω†Êé®Ëçê</span>
                                    <span><strong>Ê≠£Âú®ÂÖ≥Ê≥®</strong></span>
                                </div>
                                <div
                                    style="
                                        margin-top: 8px;
                                        display: grid;
                                        grid-template-columns: 1fr 1fr;
                                        align-items: center;
                                        justify-items: center;
                                    "
                                >
                                    <div></div>
                                    <div
                                        style="
                                            background-color: #1d9bf0;
                                            width: 100%;
                                            height: 4px;
                                            border-radius: 50px;
                                        "
                                    ></div>
                                </div>
                                <div
                                    style="
                                        width: 100%;
                                        height: 1px;
                                        background-color: #f0f4f5;
                                        margin-top: 2px;
                                    "
                                ></div>
                            </div>
                            <div class="twitter-content"><hr /></div>
                        </div>
                    </div>
                    <div
                        class="QQ"
                        id="App_QQ"
                        style="
                            background-color: #eff3ff;
                            width: 100%;
                            height: 100%;
                            box-sizing: border-box;
                            position: relative;
                        "
                    >
                                                 <div id="QQ_home_page" style="display: flex; flex-direction: column; height: calc(100% - 20px);">
                            <div style="width: 100%; height: 30px"></div>
                            <div
                                style="
                                    display: flex;
                                    align-items: center;
                                    gap: 5px;
                                    width: 100%;
                                    box-sizing: border-box;
                                "
                            >
                                <div
                                    class="user_avatar"
                                    style="
                                        width: 35px;
                                        height: 35px;
                                        border-radius: 50%;
                        margin-left: 28px;
                                    "
                                ></div>
                                <div
                                    style="
                                        display: flex;
                                        align-items: start;
                                        justify-content: center;
                                        flex-direction: column;
                                        margin-left: 3px;
                                        gap: 3px;
                                        position: relative;
                                    "
                                >
                                    <span
                                        style="font-size: 15px; cursor: pointer; position: relative;"
                                        id="QQ_home_UserName"
                                        onclick="QQ_ToggleUserMenu()"
                                        ><strong>{{user}}</strong></span
                                    >
                                    <!-- Áî®Êà∑‰∏ãÊãâËèúÂçï -->
                                    <div id="QQ_user_menu" style="
                                        position: absolute;
                                        top: 100%;
                                        left: 0;
                                        background: white;
                                        border-radius: 8px;
                                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                                        z-index: 1000;
                                        min-width: 150px;
                                        display: none;
                                        animation: menuSlideDown 0.2s ease;
                                    ">
                                        <div class="user_menu_item" onclick="QQ_ShowSpiritButton(); QQ_HideUserMenu();" style="
                                            padding: 12px 16px;
                                            cursor: pointer;
                                            border-bottom: 1px solid #f0f0f0;
                                            display: flex;
                                            align-items: center;
                                            gap: 8px;
                                            font-size: 14px;
                                            color: #333;
                                            transition: background-color 0.2s ease;
                                        " onmouseover="this.style.backgroundColor='#f5f5f5'" 
                                           onmouseout="this.style.backgroundColor='transparent'">
                                            üßö‚Äç‚ú® <span>Âè¨Âî§‰∫íÂä®Á≤æÁÅµ</span>
                                        </div>
                                        <div class="user_menu_item" onclick="QQ_ShowInteractiveStats(); QQ_HideUserMenu();" style="
                                            padding: 12px 16px;
                                            cursor: pointer;
                                            border-bottom: 1px solid #f0f0f0;
                                            display: flex;
                                            align-items: center;
                                            gap: 8px;
                                            font-size: 14px;
                                            color: #333;
                                            transition: background-color 0.2s ease;
                                        " onmouseover="this.style.backgroundColor='#f5f5f5'" 
                                           onmouseout="this.style.backgroundColor='transparent'">
                                            üìä <span>‰∫íÂä®ÁªüËÆ°</span>
                                        </div>
                                        <div class="user_menu_item" onclick="window.QQ_Show_Interactive_Stats(); QQ_HideUserMenu();" style="
                                            padding: 12px 16px;
                                            cursor: pointer;
                                            display: flex;
                                            align-items: center;
                                            gap: 8px;
                                            font-size: 14px;
                                            color: #333;
                                            transition: background-color 0.2s ease;
                                        " onmouseover="this.style.backgroundColor='#f5f5f5'" 
                                           onmouseout="this.style.backgroundColor='transparent'">
                                            üîß <span>Ë∞ÉËØï‰ø°ÊÅØ</span>
                                        </div>
                                    </div>
                                    <div
                                        style="
                                            display: flex;
                                            align-items: center;
                                            height: 10px;
                                        "
                                    >
                                        <svg
                                            viewBox="0 0 1024 1024"
                                            width="13"
                                            height="13"
                                            style="margin-right: 2px"
                                        >
                                            <path
                                                d="M957.539 464.339c-26.14-245.993-246.771-424.08-492.787-397.772C218.735 92.873 40.474 313.62 66.635 559.634 92.774 805.631 313.406 983.717 559.443 957.41c245.997-26.306 424.258-247.075 398.096-493.071z m-298.25-135.757c39.341 0 71.233 31.921 71.233 71.301 0 39.379-31.891 71.3-71.233 71.3-39.338 0-71.229-31.921-71.229-71.3 0-39.38 31.892-71.301 71.229-71.301z m-294.447 0c39.34 0 71.23 31.921 71.23 71.301 0 39.379-31.89 71.3-71.23 71.3s-71.228-31.921-71.228-71.3c0-39.38 31.887-71.301 71.228-71.301z m366.815 304.963c-21.735 96.663-119.97 163.563-219.591 163.563-103.222 0-200.969-68.713-220.487-167.453 0-26.686 20.351-36.26 32.887-36.26h370.156c9.115 0.017 43.978 3.176 37.035 40.15z"
                                                fill="#fbba13"
                                                p-id="5845"
                                            ></path>
                                        </svg>
                                        <span style="font-size: 11px"
                                            >QÊàëÂêß</span
                                        >
                                        <svg
                                            viewBox="0 0 1024 1024"
                                            width="10"
                                            height="10"
                                            style="margin-top: 1px"
                                        >
                                            <path
                                                d="M342.528 916.48c19.456 0 38.4-7.168 53.248-21.504l338.944-327.68c14.848-14.336 23.552-34.304 23.552-55.296s-8.192-40.96-23.552-55.296l-338.944-327.68c-30.72-29.696-79.36-28.672-108.544 2.048-29.696 30.72-28.672 79.36 2.048 108.544l281.6 272.384-281.6 272.384c-30.72 29.696-31.232 78.336-2.048 108.544 15.36 15.872 35.328 23.552 55.296 23.552z"
                                                fill="#000000"
                                                p-id="7578"
                                            ></path>
                                        </svg>
                                    </div>
                                </div>
                                <svg
                    id="contacts_add_btn"
                    class="add-button"
                                    viewBox="0 0 1024 1024"
                                    version="1.1"
                                    width="20"
                                    height="20"
                                    style="
                                        margin-left: auto;
                        margin-right: 28px;
                                    "
                                >
                                    <path
                                        d="M512 0a42.666667 42.666667 0 0 1 42.666667 42.666667v426.666666h426.666666a42.666667 42.666667 0 0 1 0 85.333334H554.666667v426.666666a42.666667 42.666667 0 0 1-85.333334 0V554.666667H42.666667a42.666667 42.666667 0 0 1 0-85.333334h426.666666V42.666667a42.666667 42.666667 0 0 1 42.666667-42.666667z"
                                        fill="#191919"
                                        p-id="4261"
                                    ></path>
                                </svg>
                            </div>
                            <div style="width: 100%; height: 10px"></div>
                            <!-- ÊêúÁ¥¢Ê°ÜÊîæÂú®ËÅîÁªú‰∫∫ÂàóË°®Â§ñÈù¢ -->
                <div
                                id="floating_search_box"
                    style="
                                    width: calc(100% - 40px);
                        height: 30px;
                                    background-color: rgba(239, 243, 255, 0.9);
                                    margin-left: 20px;
                                    margin-bottom: 5px;
                        border-radius: 5px;
                        display: flex;
                        align-items: center;
                                    gap: 8px;
                                    padding: 0 10px;
                                    z-index: 100;
                                    backdrop-filter: blur(5px);
                                    border: 1px solid rgba(25, 154, 255, 0.2);
                                    transition: all 0.3s ease;
                                    position: sticky;
                                    top: 0;
                    "
                >
                    <svg
                        viewBox="0 0 1024 1024"
                        width="16"
                        height="16"
                                    style="flex-shrink: 0;"
                    >
                        <path
                            d="M446.112323 177.545051c137.567677 0.219798 252.612525 104.59798 266.162424 241.493333 13.562828 136.895354-78.778182 261.818182-213.617777 289.008485-134.852525 27.203232-268.386263-52.156768-308.945455-183.608889s25.018182-272.252121 151.738182-325.779394A267.235556 267.235556 0 0 1 446.112323 177.545051m0-62.060607c-182.794343 0-330.989899 148.195556-330.989899 330.989899s148.195556 330.989899 330.989899 330.989899 330.989899-148.195556 330.989899-330.989899-148.195556-330.989899-330.989899-330.989899z m431.321212 793.341415a30.849293 30.849293 0 0 1-21.94101-9.102223l-157.220202-157.220202c-11.752727-12.179394-11.584646-31.534545 0.37495-43.50707 11.972525-11.972525 31.327677-12.140606 43.494141-0.37495l157.220202 157.220202a31.036768 31.036768 0 0 1 6.723232 33.810101 31.004444 31.004444 0 0 1-28.651313 19.174142z m0 0"
                            fill="#919095"
                        ></path>
                    </svg>
                                <input 
                                    type="text" 
                                    id="contact_search_input"
                                    placeholder="ÊêúÁ¥¢ËÅîÁªú‰∫∫..."
                                    style="
                                        flex: 1;
                                        border: none;
                                        background: transparent;
                                        outline: none;
                                        color: #333;
                                        font-size: 14px;
                                    "
                                >
                                <div id="search_clear_btn" style="
                                    display: none;
                                    cursor: pointer;
                                    width: 16px;
                                    height: 16px;
                                    background-color: #ccc;
                                    border-radius: 50%;
                                    position: relative;
                                    flex-shrink: 0;
                                ">
                                    <div style="
                                        position: absolute;
                                        top: 50%;
                                        left: 50%;
                                        transform: translate(-50%, -50%);
                                        color: white;
                                        font-size: 12px;
                                        line-height: 1;
                                    ">√ó</div>
                </div>
            </div>
                            <div id="QQ_home_chars">
        </div>
        </div>
                                <div id="QQ_message_list_page" style="display: none; flex-direction: column; height: calc(100% - 20px);">
            <!-- Ê∂àÊÅØÈ°µÈù¢ÔºöÂè™ÊòæÁ§∫Áî®Êà∑Â§¥ÂÉèÂíåËÅîÁ≥ª‰∫∫ÂàóË°®Ôºå‰∏çÊòæÁ§∫ÊêúÁ¥¢Ê°Ü -->
            <div style="width: 100%; height: 30px"></div>
            <div
                style="
                    display: flex;
                    align-items: center;
                    gap: 5px;
                    width: 100%;
                    box-sizing: border-box;
                "
            >
                <div
                    class="user_avatar"
                    style="
                        width: 35px;
                        height: 35px;
                        border-radius: 50%;
                        margin-left: 28px;
                    "
                ></div>
                <div
                    style="
                        display: flex;
                        align-items: start;
                        justify-content: center;
                        flex-direction: column;
                        margin-left: 3px;
                        gap: 3px;
                    "
                >
                    <span
                        style="font-size: 15px; cursor: pointer;"
                        id="QQ_message_list_UserName"
                        onclick="QQ_ToggleUserMenu()"
                        ><strong>{{user}}</strong></span
                    >
                    <div
                        style="
                            display: flex;
                            align-items: center;
                            height: 10px;
                        "
                    >
                        <svg
                            viewBox="0 0 1024 1024"
                            width="13"
                            height="13"
                            style="margin-right: 2px"
                        >
                            <path
                                d="M957.539 464.339c-26.14-245.993-246.771-424.08-492.787-397.772C218.735 92.873 40.474 313.62 66.635 559.634 92.774 805.631 313.406 983.717 559.443 957.41c245.997-26.306 424.258-247.075 398.096-493.071z m-298.25-135.757c39.341 0 71.233 31.921 71.233 71.301 0 39.379-31.891 71.3-71.233 71.3-39.338 0-71.229-31.921-71.229-71.3 0-39.38 31.892-71.301 71.229-71.301z m-294.447 0c39.34 0 71.23 31.921 71.23 71.301 0 39.379-31.89 71.3-71.23 71.3s-71.228-31.921-71.228-71.3c0-39.38 31.887-71.301 71.228-71.301z m366.815 304.963c-21.735 96.663-119.97 163.563-219.591 163.563-103.222 0-200.969-68.713-220.487-167.453 0-26.686 20.351-36.26 32.887-36.26h370.156c9.115 0.017 43.978 3.176 37.035 40.15z"
                                fill="#fbba13"
                                p-id="5845"
                            ></path>
                        </svg>
                        <span style="font-size: 11px"
                            >QÊàëÂêß</span
                        >
                        <svg
                            viewBox="0 0 1024 1024"
                            width="10"
                            height="10"
                            style="margin-top: 1px"
                        >
                            <path
                                d="M342.528 916.48c19.456 0 38.4-7.168 53.248-21.504l338.944-327.68c14.848-14.336 23.552-34.304 23.552-55.296s-8.192-40.96-23.552-55.296l-338.944-327.68c-30.72-29.696-79.36-28.672-108.544 2.048-29.696 30.72-28.672 79.36 2.048 108.544l281.6 272.384-281.6 272.384c-30.72 29.696-31.232 78.336-2.048 108.544 15.36 15.872 35.328 23.552 55.296 23.552z"
                                fill="#000000"
                                p-id="7578"
                            ></path>
                        </svg>
                    </div>
                </div>
                <svg
                    id="messages_add_btn"
                    class="add-button"
                    viewBox="0 0 1024 1024"
                    version="1.1"
                    width="20"
                    height="20"
                    style="
                        margin-left: auto;
                        margin-right: 28px;
                    "
                >
                    <path
                        d="M512 0a42.666667 42.666667 0 0 1 42.666667 42.666667v426.666666h426.666666a42.666667 42.666667 0 0 1 0 85.333334H554.666667v426.666666a42.666667 42.666667 0 0 1-85.333334 0V554.666667H42.666667a42.666667 42.666667 0 0 1 0-85.333334h426.666666V42.666667a42.666667 42.666667 0 0 1 42.666667-42.666667z"
                        fill="#191919"
                        p-id="4261"
                    ></path>
                </svg>
            </div>
            <div style="width: 100%; height: 20px"></div>
            <div id="QQ_message_list_chars">
                <!-- Ê∂àÊÅØËÅîÁ≥ª‰∫∫ÂàóË°®ÔºåÂè™ÊòæÁ§∫ÊúâÊ∂àÊÅØËÆ∞ÂΩïÁöÑËÅîÁ≥ª‰∫∫ -->
            </div>
        </div>
        <div
            id="QQ_space_page"
            style="display: none; height: calc(100% - 20px); flex-direction: column;"
        >
                            <div style="width: 100%; height: 35px"></div>
                            <div style="display: flex">
                                <span style="font-size: 16px; margin-left: 28px"
                                    >Âä®ÊÄÅ</span
                                >
                                <svg
                                    viewBox="0 0 1024 1024"
                                    width="20"
                                    height="20"
                                    style="margin-left: auto"
                                >
                                    <path
                                        d="M593.420488 922.099512c24.553022 0 44.456585 19.903563 44.456585 44.456586v11.988292c0 24.553022-19.903563 44.456585-44.456585 44.456586h-159.843903c-24.553022 0-44.456585-19.903563-44.456585-44.456586v-11.988292c0-24.553022 19.903563-44.456585 44.456585-44.456586h159.843903zM515.996098 0c24.276293 0 43.957073 19.68078 43.957073 43.957073l0.002997 54.191079C735.392843 121.808047 870.649756 272.137241 870.649756 454.056585V740.277073h102.4c24.553022 0 44.456585 19.903563 44.456585 44.456586v11.988292c0 24.553022-19.903563 44.456585-44.456585 44.456586H870.649756v1.998048H152.35122v-1.998048H52.948293C28.39527 841.178537 8.491707 821.274974 8.491707 796.721951v-11.988292C8.491707 760.180636 28.39527 740.277073 52.948293 740.277073H152.35122V454.056585c0-181.229019 134.231914-331.106654 308.696538-355.632702L461.049756 43.957073c0-24.276293 19.68078-43.957073 43.957073-43.957073h10.989269z m25.620979 197.047571h-60.233178c-126.178779 0-228.706654 101.264109-230.744664 226.958361l-0.029971 3.816273-0.000999 312.454868h521.783446V427.822205c0-127.454533-103.3211-230.774634-230.774634-230.774634z"
                                        fill="#000000"
                                        p-id="3355"
                                    ></path>
                                </svg>
                                <svg
                                    viewBox="0 0 1065 1024"
                                    width="20"
                                    height="20"
                                    style="
                                        margin-right: 28px;
                                        margin-left: 15px;
                                    "
                                >
                                    <path
                                        d="M1002.234305 330.02867V693.97133c0 53.148789-28.346021 101.741967-73.902125 128.063272l-315.349481 182.224419c-46.062284 26.321305-102.248146 26.321305-148.31043 0l-315.349481-182.224419c-46.062284-26.321305-73.902126-75.420662-73.902126-128.063272V330.02867c0-53.148789 28.346021-101.741967 73.902126-128.063272l315.349481-182.224419c46.062284-26.321305 102.248146-26.321305 148.31043 0l315.349481 182.224419c45.556105 26.321305 73.902126 74.914483 73.902125 128.063272z m-76.939199 0c0-25.308947-13.666831-49.099357-35.432526-61.753831l-315.349481-182.224419c-22.271873-12.654474-49.099357-12.654474-71.37123 0l-315.349481 182.224419c-22.271873 12.654474-35.432526 36.444884-35.432526 61.753831V693.97133c0 25.308947 13.666831 49.099357 35.432526 61.753831l315.349481 182.224419c22.271873 12.654474 49.099357 12.654474 71.37123 0l315.349481-182.224419c22.271873-12.654474 35.432526-36.444884 35.432526-61.753831V330.02867zM362.424123 508.709837C362.424123 410.004943 442.400395 329.522491 541.611468 329.522491s179.187346 80.482452 179.187346 179.187346-80.482452 179.187346-179.187346 179.187345-179.187346-79.470094-179.187345-179.187345z m76.939199 0c0 56.692042 46.062284 102.248146 102.248146 102.248146s102.248146-46.062284 102.248146-102.248146-46.062284-102.248146-102.248146-102.248146-102.248146 46.568463-102.248146 102.248146z"
                                        fill="#000000"
                                        p-id="13806"
                                    ></path>
                                </svg>
                            </div>
                            <div
                                style="
                                    width: 100%;
                                    height: 1px;
                                    background-color: #e6e6e6;
                                    margin-bottom: 10px;
                                    margin-top: 10px;
                                "
                            ></div>
                            <div
                                class="space_contents"
                                id="space_contents"
                                style="
                                    overflow-y: auto;
                                    width: 100%;
                                    flex: 1;
                                    height: calc(100vh - 180px);
                                "
                            >
                                <div style="margin-bottom: 80px"></div>
                            </div>
                        </div>
                        <div class="QQ_bottom_nav">
                            <div
                                id="QQ_message_nav"
                                style="
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    flex-direction: column;
                                    gap: 1px;
                                "
                            >
                                <svg
                                    class="icon"
                                    viewBox="0 0 1024 1024"
                                    width="20"
                                    height="20"
                                    style="
                                        transform: scale(1.15);
                                        transform-origin: center;
                                        fill: #000000;
                                    "
                                    id="QQ_message_svg"
                                >
                                    <path
                                        d="M822.016 61.44H196.864A155.88352 155.88352 0 0 0 40.96 216.94976v426.2144a155.88352 155.88352 0 0 0 155.904 155.50976h9.6256a1.97632 1.97632 0 0 1 1.96608 1.9456l0.97792 84.992A72.832 72.832 0 0 0 322.72896 945.152l211.37408-141.09184a31.9744 31.9744 0 0 1 17.80736-5.39648h270.1056A155.88352 155.88352 0 0 0 977.92 643.16416V216.94976A155.88352 155.88352 0 0 0 822.016 61.44z m85.06368 581.72416a85.05344 85.05344 0 0 1-85.06368 84.84864H551.936a102.69184 102.69184 0 0 0-57.21088 17.33632l-211.39456 141.09184a1.9712 1.9712 0 0 1-3.072-1.6128l-0.97792-85.02272A72.97024 72.97024 0 0 0 206.4896 728.0128h-9.6256a85.05344 85.05344 0 0 1-85.06368-84.84864V216.94976A85.05344 85.05344 0 0 1 196.864 132.096h625.152a85.05344 85.05344 0 0 1 85.06368 84.84864v426.2144z"
                                    ></path>
                                    <path
                                        d="M311.08608 381.76768a54.17472 54.17472 0 1 0 54.31296 54.17472 54.24128 54.24128 0 0 0-54.31296-54.17472z m207.80032 0a54.17472 54.17472 0 1 0 54.31296 54.17472 54.24128 54.24128 0 0 0-54.31296-54.17472z m212.52096 0a54.17472 54.17472 0 1 0 54.31296 54.17472 54.24128 54.24128 0 0 0-54.31296-54.17472z"
                                    ></path>
                                </svg>
                                <span>Ê∂àÊÅØ</span>
                            </div>
                            <div
                                id="QQ_people_nav"
                                style="
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    flex-direction: column;
                                    gap: 1px;
                                "
                            >
                                <svg
                                    viewBox="0 0 1024 1024"
                                    style="fill: #019aff"
                                    width="20"
                                    height="20"
                                    id="QQ_people_svg"
                                >
                                    <path
                                        d="M620.744191 538.879184c82.736353-40.523949 140.308583-124.785028 140.308583-222.936465 0-137.367601-111.714338-249.080915-249.02668-249.080915-137.367601 0-249.080915 111.713314-249.080915 249.080915 0 98.151437 57.57223 182.412516 140.363841 222.936465C235.330238 586.429153 111.796714 740.736565 111.796714 923.694503c0 18.464537 15.032368 33.443693 33.496905 33.443693 18.464537 0 33.497928-14.979156 33.497928-33.443693 0-183.774537 149.46001-333.343017 333.234547-333.343017 183.77556 0 333.234547 149.568481 333.234547 333.343017 0 18.464537 14.978133 33.443693 33.443693 33.443693 18.519796 0 33.496905-14.979156 33.496905-33.443693C912.20124 740.736565 788.668739 586.429153 620.744191 538.879184zM329.886801 315.942719c0-100.438527 81.70179-182.194552 182.140317-182.194552 100.384291 0 182.086082 81.756025 182.086082 182.194552 0 100.384291-81.702813 182.086082-182.086082 182.086082C411.587568 498.0288 329.886801 416.32701 329.886801 315.942719z"
                                    ></path>
                                </svg>
                                <span>ËÅîÁ≥ª‰∫∫</span>
                            </div>
                            <div
                                id="QQ_moment_nav"
                                style="
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    flex-direction: column;
                                    gap: 1px;
                                    position: relative;
                                "
                            >
                                <svg
                                    viewBox="0 0 1059 1024"
                                    width="20"
                                    height="20"
                                    id="QQ_moment_svg"
                                    style="fill: #000000"
                                >
                                    <path
                                        d="M206.566465 1008.20002c11.278404 7.517627 30.080982 15.035253 45.117545 15.035254 11.281023 0 26.324133-3.75554 37.605156-7.517627l240.646548-127.777391 240.646547 127.777391c11.278404 7.517627 22.558118 7.517627 37.602537 7.517627 15.037872 0 30.075744-3.75554 45.118854-15.035254 22.559427-15.030015 37.598609-45.097903 30.082292-71.402393l-45.124092-278.110282L1037.545084 459.503632c18.799959-18.790793 26.321514-48.85868 18.799959-75.163172-7.516317-26.311038-33.839141-45.103141-60.156726-48.85868L714.181074 290.382568 593.854527 42.338864C582.577432 16.027826 556.254609 0.99912 526.177555 0.99912c-30.080982 0-56.403806 15.028706-67.684829 41.339744l-120.32 248.043704L63.679182 331.723621c-26.316276 3.756849-52.640409 22.548951-60.161965 48.853443-7.516317 26.309729-3.758159 56.376307 18.801269 75.169719l199.285852 199.183713-45.120164 278.106353c-3.758159 30.065269 7.521555 60.133156 30.082291 75.163171zM63.679182 406.886793l274.492235-41.339744 48.878322-7.518936 22.559427-45.097903 116.568389-248.042394 120.318691 248.043703 22.562046 45.097903 48.88225 7.516317 274.485688 41.339744L789.383529 606.074435l-33.845688 33.822117 7.522865 45.103141 45.124092 278.103734-240.651785-127.777391-41.356767-26.311039-45.124093 22.555499-240.646547 131.532931 45.120164-278.103734 7.521555-45.103141-30.082292-33.823427L63.679182 406.888102z"
                                        p-id="37579"
                                    ></path>
                                    <path
                                        d="M526.176246 692.509463c-131.604951 0-176.725115-127.777391-176.725116-131.53424-3.763396-15.035253 3.758159-30.065269 18.796031-33.828665 15.044419-3.75554 30.080982 3.763396 33.845688 18.793411 0 3.762087 33.839141 93.953964 124.084706 93.953965 90.239018 0 124.078159-93.953964 124.078159-93.953965 3.763396-15.030015 18.801269-22.548951 33.845688-18.793411 15.036563 3.763396 22.558118 22.555499 18.79603 33.828665 0 3.756849-45.120164 131.53555-176.721186 131.535549z"
                                        p-id="37580"
                                    ></path>
                                </svg>
                                <span>Âä®ÊÄÅ</span>
                                <div
                                    class="new_tips"
                                    style="
                                        position: absolute;
                                        right: -8px;
                                        top: -8px;
                                        background-color: red;
                                        color: #fff;
                                        width: 15px;
                                        height: 15px;
                                        border-radius: 50%;
                                        display: none;
                                        justify-content: center;
                                        align-items: center;
                                        font-size: 12px;
                                    "
                                >
                                    1
                                </div>
                            </div>
                        </div>
                        <div
                            id="QQ_friend_info"
                            style="
                                display: none;
                                background-color: #fff;
                                height: 100%;
                                width: 100%;
                                padding-top: 50px;
                                padding-left: 10px;
                            "
                        >
                            <span>Ëá™ÂÆö‰πâÂêçÁß∞:</span
                            ><input
                                name=""
                                id="setcharname"
                                placeholder="ËøôÈáåËæìÂÖ•ÂêçÁß∞"
                            /><br /><br /><span>Ëá™ÂÆö‰πâÂ§¥ÂÉè:</span>
                            <input
                                type="file"
                                id="QQ_head_input"
                            /><br /><br /><br /><button
                                onclick="Setfriendinfo(!1)"
                            >
                                ÂèñÊ∂à
                            </button>
                            <button onclick="Setfriendinfo(!0)">Á°ÆÂÆö</button>
                        </div>
                    </div>
                    <div
                        class="discord"
                        id="App_discord"
                        style="display: none; width: 100%; height: 100%"
                    >
                        <div
                            class="discord-homepage"
                            style="width: 100%; height: 100%"
                        >
                            <div class="discord-top">
                                <svg
                                    t="1744127791511"
                                    class="discord-top-return"
                                    viewBox="0 0 1024 1024"
                                    version="1.1"
                                    xmlns="http://www.w3.org/2000/svg"
                                    p-id="3402"
                                    width="28"
                                    height="28"
                                >
                                    <path
                                        d="M440.070244 831.562927c11.813463 0 23.601951-4.49561 32.593171-13.486829a45.980098 45.980098 0 0 0 0-65.161366l-198.730927-198.730927 589.674146 0.499512c24.001561 0 43.507512-19.431024 43.40761-43.40761 0-24.101463-19.480976-43.63239-43.507512-43.63239l-592.221659-0.574439 201.378342-201.378341a45.980098 45.980098 0 0 0 0-65.161366 45.980098 45.980098 0 0 0-65.186342 0L131.29678 476.734439a45.955122 45.955122 0 0 0-13.53678 33.16761v0.574439c0 13.361951 5.994146 25.300293 15.409951 33.292488l274.307122 274.332097c8.99122 8.966244 20.804683 13.461854 32.593171 13.461854z"
                                        p-id="3403"
                                        fill="#505058"
                                    ></path>
                                </svg>
                                <svg
                                    aria-hidden="true"
                                    width="20"
                                    height="20"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    style="
                                        margin-left: 15px;
                                        margin-right: 10px;
                                    "
                                >
                                    <path
                                        fill="#313237"
                                        fill-rule="evenodd"
                                        d="M18.09 1.63c.4-.7 1.43-.7 1.82 0l3.96 6.9c.38.66-.12 1.47-.91 1.47h-7.92c-.79 0-1.3-.81-.91-1.48l3.96-6.9Zm.46 1.87h.9c.3 0 .52.26.5.55l-.22 2.02c-.01.16-.17.26-.33.23a1.92 1.92 0 0 0-.8 0c-.16.03-.32-.07-.33-.23l-.21-2.02a.5.5 0 0 1 .5-.55ZM19 9a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z"
                                        clip-rule="evenodd"
                                        class=""
                                    ></path>
                                    <path
                                        fill="#313237"
                                        d="M14.8 3.34a.48.48 0 0 0-.24-.69A9.94 9.94 0 0 0 11 2c-4.97 0-9 3.58-9 8 0 1.5.47 2.91 1.28 4.11.14.21.12.49-.06.67l-1.51 1.51A1 1 0 0 0 2.4 18h5.1a.5.5 0 0 0 .49-.5c0-2.86 1.62-5.3 3.97-6.56.28-.15.38-.51.25-.8a2.86 2.86 0 0 1 .18-2.61l2.4-4.19ZM18.91 12.98a5.45 5.45 0 0 1 2.18 6.2c-.1.33-.09.68.1.96l.83 1.32a1 1 0 0 1-.84 1.54h-5.5A5.6 5.6 0 0 1 10 17.5a5.6 5.6 0 0 1 5.68-5.5c1.2 0 2.32.36 3.23.98Z"
                                        class=""
                                    ></path>
                                </svg>
                                <div class="discord-top-title">
                                    <strong>Á±ªËÑëŒüŒîŒ•Œ£Œ£ŒïŒôŒë</strong>
                                </div>
                                <div
                                    style="
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        background-color: #ebebeb;
                                        border-radius: 50%;
                                        height: 32px;
                                        width: 32px;
                                        margin-left: auto;
                                        margin-right: 10px;
                                    "
                                >
                                    <svg
                                        viewBox="0 0 1024 1024"
                                        width="16"
                                        height="16"
                                    >
                                        <path
                                            d="M991.418182 972.8L791.272727 772.654545c79.127273-83.781818 130.327273-195.490909 130.327273-316.50909 0-251.345455-200.145455-451.490909-446.836364-451.49091C232.727273 0 32.581818 204.8 32.581818 451.490909s200.145455 451.490909 446.836364 451.490909c97.745455 0 190.836364-32.581818 265.309091-88.436363l200.145454 204.8 46.545455-46.545455zM102.4 451.490909c0-209.454545 167.563636-381.672727 377.018182-381.672727s377.018182 172.218182 377.018182 381.672727-172.218182 386.327273-381.672728 386.327273c-204.8 0-372.363636-172.218182-372.363636-386.327273z"
                                            fill="#55565c"
                                            p-id="12001"
                                        ></path>
                                    </svg>
                                </div>
                            </div>
                            <div
                                style="
                                    width: 100%;
                                    height: 1px;
                                    background-color: #dcdcdc;
                                "
                            ></div>
                            <div
                                style="
                                    width: 100%;
                                    height: 1px;
                                    background-color: #d8d9db;
                                "
                            ></div>
                            <div class="discord-top-button">
                                <div class="sortbutton">
                                    <svg
                                        aria-hidden="true"
                                        role="img"
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="16"
                                        height="16"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            fill="#515256"
                                            d="M16.3 21.7a1 1 0 0 0 1.4 0l4-4a1 1 0 0 0-1.4-1.4L18 18.58V3a1 1 0 1 0-2 0v15.59l-2.3-2.3a1 1 0 0 0-1.4 1.42l4 4ZM6.3 2.3a1 1 0 0 1 1.4 0l4 4a1 1 0 0 1-1.4 1.4L8 5.42V21a1 1 0 1 1-2 0V5.41l-2.3 2.3a1 1 0 0 1-1.4-1.42l4-4Z"
                                            class=""
                                        ></path>
                                    </svg>
                                    <div
                                        style="font-size: 14px; color: #515256"
                                    >
                                        ÊéíÂ∫è & Êü•Áúã
                                    </div>
                                    <svg
                                        aria-hidden="true"
                                        role="img"
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="20"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            fill="#515256"
                                            d="M5.3 9.3a1 1 0 0 1 1.4 0l5.3 5.29 5.3-5.3a1 1 0 1 1 1.4 1.42l-6 6a1 1 0 0 1-1.4 0l-6-6a1 1 0 0 1 0-1.42Z"
                                            class=""
                                        ></path>
                                    </svg>
                                </div>
                                <div class="tagbutton">
                                    <div
                                        style="font-size: 14px; color: #515256"
                                    >
                                        Ê†áÁ≠æ
                                    </div>
                                    <svg
                                        aria-hidden="true"
                                        role="img"
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="20"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            fill="#515256"
                                            d="M5.3 9.3a1 1 0 0 1 1.4 0l5.3 5.29 5.3-5.3a1 1 0 1 1 1.4 1.42l-6 6a1 1 0 0 1-1.4 0l-6-6a1 1 0 0 1 0-1.42Z"
                                            class=""
                                        ></path>
                                    </svg>
                                </div>
                            </div>
                            <div
                                style="
                                    width: 100%;
                                    height: 1px;
                                    background-color: #dcdcdc;
                                "
                            ></div>
                            <div
                                style="
                                    width: 100%;
                                    height: 1px;
                                    background-color: #d8d9db;
                                "
                            ></div>
                            <div class="discord-cardlist">
                                <div class="discord-cardget">
                                    <span>Êü•ÁúãÂ∏ñÂ≠ê</span>
                                </div>
                            </div>
                        </div>
                        <div
                            class="discord-thread-list"
                            style="width: 100%; height: 100%; display: none"
                        ></div>
                    </div>
                </div>
            </div>
            <div
                class="top"
                style="
                    display: flex;
                    align-items: center;
                    justify-content: center;
                "
            >
                <svg
                    t="1735485675807"
                    class="icon"
                    viewBox="0 0 1024 1024"
                    version="1.1"
                    xmlns="http://www.w3.org/2000/svg"
                    p-id="9713"
                    width="16"
                    height="16"
                >
                    <path
                        d="M716.8 805.823147 716.8 384.709973c0-95.68256-77.544107-173.2608-173.216427-173.2608L56.664747 211.449173c-3.754667 0-6.795947 3.024213-6.795947 6.741333L49.8688 805.819733c0 3.71712 3.04128 6.72768 6.795947 6.72768l130.061653 0c3.754667 0 6.792533-3.027627 6.792533-6.765227L193.518933 344.562347c0-3.744427 3.04128-6.782293 6.795947-6.782293l279.68512 0c52.52096 0 95.112533 42.571093 95.112533 95.09888l0 372.8896c0 3.741013 3.037867 6.761813 6.772053 6.761813l128.146773 0c3.72736 0 6.772053-3.017387 6.772053-6.72768M454.15424 805.778773c0 3.744427-3.01056 6.76864-6.76864 6.76864L317.354667 812.547413c-3.754667 0-6.795947-3.027627-6.795947-6.76864L310.55872 452.348587c0-3.741013 3.04128-6.77888 6.795947-6.77888l130.030933 0c3.75808 0 6.76864 3.037867 6.76864 6.77888l0 353.447253L454.15424 805.778773zM974.134613 805.778773c0 3.744427-3.044693 6.76864-6.79936 6.76864l-130.000213 0c-3.764907 0-6.826667-3.027627-6.826667-6.76864L830.508373 218.251947c0-3.75808 3.06176-6.792533 6.826667-6.792533l130.000213 0c3.75808 0 6.79936 3.034453 6.79936 6.792533L974.134613 805.778773z"
                        fill="#ffffff"
                        p-id="9714"
                    ></path>
                </svg>
            </div>
        </div>
        <script></script>
        <script>
            var __webpack_exports__ = {}; // ./src/ÁïåÈù¢/chat/chat_page.html

            // Module
            var code =
                '<div data-name="${name}" class="QQ_chat_page" style="width:100%;height:100%;padding-top:0"> <div style="padding-top:10px;backdrop-filter:blur(1px);background-color:rgb(255,255,255,.1)"> <div style="width:100%;height:20px;display:grid;top:0;left:0;grid-template-columns:auto 1fr auto;align-items:center;margin-top:20px"> <svg class="QQ-close-btn" viewBox="0 0 1024 1024" style="height:18px;width:18px;margin-left:8px"> <path d="M769.137778 153.372444L444.984889 512l324.152889 358.684444c36.408889 35.043556 36.408889 91.989333 0 126.976a95.744 95.744 0 0 1-131.868445 0l-377.571555-417.678222c-1.536-1.365333-3.584-1.877333-5.063111-3.299555A87.438222 87.438222 0 0 1 227.555556 512c-0.341333-23.324444 8.533333-46.876444 27.079111-64.739556 1.479111-1.422222 3.527111-1.934222 5.063111-3.185777L637.269333 26.339556a95.744 95.744 0 0 1 131.868445 0c36.408889 35.043556 36.408889 91.932444 0 127.032888z" fill="#666666" p-id="1570"></path> </svg> <div style="display:flex;align-items:center;position:relative"> <div class="new_tips" style="background-color:gray;color:#fff;width:20px;height:20px;border-radius:50%;display:none;justify-content:center;align-items:center;font-size:12px"> 1 </div> <span style="margin-left:8px;color:#000;font-size:16px" id="QQ_chat_username" onclick="handleChatTitleClick(this)">${name}</span> <div class="group-member-dropdown" id="group_member_dropdown" style="display:none;position:absolute;top:25px;left:8px;background:#fff;border:1px solid #ddd;border-radius:5px;box-shadow:0 2px 10px rgba(0,0,0,0.1);z-index:1000;min-width:200px;max-height:300px;overflow-y:auto;"> <div class="group-member-list" id="group_member_list"></div> </div> </div> <svg id="QQ_chat_page_setting" viewBox="0 0 1024 1024" style="height:20px;width:20px;margin-right:20px"> <path d="M901.632 896H122.368c-30.72 0-55.808-25.088-55.808-55.808v-1.536c0-30.72 25.088-55.808 55.808-55.808h779.776c30.72 0 55.808 25.088 55.808 55.808v1.536c-0.512 30.72-25.6 55.808-56.32 55.808zM901.632 568.32H122.368c-30.72 0-55.808-25.088-55.808-55.808v-1.536c0-30.72 25.088-55.808 55.808-55.808h779.776c30.72 0 55.808 25.088 55.808 55.808v1.536c-0.512 30.72-25.6 55.808-56.32 55.808zM901.632 240.64H122.368c-30.72 0-55.808-25.088-55.808-55.808v-1.536c0-30.72 25.088-55.808 55.808-55.808h779.776c30.72 0 55.808 25.088 55.808 55.808v1.536c-0.512 30.72-25.6 55.808-56.32 55.808z" p-id="4301" fill="#666666"></path> </svg> </div> <div style="width:100%;height:.5px;background-color:#eee;margin-top:10px;border-top:1px solid #9a9a9a"></div> </div> <div class="input-container"> <div style="display:flex;align-items:center;width:100%"> <svg viewBox="0 0 1024 1024" width="25" height="25" style="margin-left:10px"> <path d="M512 62a184.09090869 184.09090869 0 0 1 184.09090869 184.09090869v204.54545478a184.09090869 184.09090869 0 1 1-368.18181738 1e-8v-204.54545479A184.09090869 184.09090869 0 0 1 512 62z m0 65.45454521a118.63636348 118.63636348 0 0 0-118.63636348 118.63636348v204.54545479a118.63636348 118.63636348 0 1 0 237.27272695 0v-204.54545479A118.63636348 118.63636348 0 0 0 512 127.45454521z" p-id="6838"></path> <path d="M192.90909131 471.09090869a319.09090869 319.09090869 0 0 0 638.18181738 0 32.72727305 32.72727305 0 1 0-65.45454521 0 253.63636348 253.63636348 0 0 1-507.27272695 0 32.72727305 32.72727305 0 1 0-65.45454522 0z" p-id="6839"></path> <path d="M479.27272695 757.45454521v131.85a32.72727305 32.72727305 0 1 0 65.4545461 0V757.45454521a32.72727305 32.72727305 0 1 0-65.4545461 0z" p-id="6840"></path> <path d="M409.72727305 953.81818174h206.87727216a32.72727305 32.72727305 0 1 0 0-65.45454522H409.72727305a32.72727305 32.72727305 0 1 0 0 65.45454522z" p-id="6841"></path> </svg> <div style="flex-grow:1;margin-left:5px;margin-right:2%"> <input class="userInput" type="text" name="" style="box-sizing:border-box;background-color:transparent"/> </div> <div style="margin-right:7px" id="QQ_chat_send-btn"> <button style="background-color:#fff;border-radius:30px;height:31px;display:block;width:3.5rem;background-color:transparent;border:1px solid rgb(0,0,0,.5)"> ÂèëÈÄÅ </button> </div> </div> </div> <div class="msgcontent" style="padding-top:15px;padding-bottom:0"></div> </div>';
            // Exports
            /* harmony default export */ var chat_page = code; // ./src/ÁïåÈù¢/chat/chat_page_setting.html
            // Module
            var chat_page_setting_code =
                '<div class="chat-setting-popup"> <div class="chat-setting-header"> <span>ËÅäÂ§©ËÆæÁΩÆ</span> <svg class="close-setting-btn" viewBox="0 0 1024 1024" width="20" height="20"> <path d="M512 421.490332 331.092592 240.582924C307.952518 217.442849 270.568889 217.442849 247.428814 240.582924 224.288739 263.722999 224.288739 301.106628 247.428814 324.246702L428.336222 505.154112 247.428814 686.061521C224.288739 709.201596 224.288739 746.585225 247.428814 769.7253 270.568889 792.865374 307.952518 792.865374 331.092592 769.7253L512 588.817891 692.907408 769.7253C716.047482 792.865374 753.431111 792.865374 776.571186 769.7253 799.711261 746.585225 799.711261 709.201596 776.571186 686.061521L595.663778 505.154112 776.571186 324.246702C799.711261 301.106628 799.711261 263.722999 776.571186 240.582924 753.431111 217.442849 716.047482 217.442849 692.907408 240.582924L512 421.490332Z" fill="#666666"></path> </svg> </div> <div class="chat-setting-content"> <div class="setting-item"> <span>Ê∞îÊ≥°È¢úËâ≤</span> <div style="flex:1"> <input style="width:100%" type="text" id="bubble-color-input" placeholder="È¢úËâ≤ÂÄº"/> </div> <input type="color" id="bubble-color" class="color-picker"/> </div> <div class="setting-item"> <span>Â≠ó‰ΩìÈ¢úËâ≤</span> <div style="flex:1"> <input style="width:100%" type="text" id="text-color-input" placeholder="È¢úËâ≤ÂÄº"/> </div> <input type="color" id="text-color" class="color-picker"/> </div> <div class="setting-item"> <span>ËÅäÂ§©Â£ÅÁ∫∏</span> <input type="text" id="chat-bg" placeholder="ËæìÂÖ•ÂõæÁâáURL"/> </div> <div class="preview" style="margin:0 auto"> <div class="QQ_chat_msgdiv" id="chat-setting-preview" data-name="${username}" style="margin:0 auto"> <span>ËøôÊòØÈ¢ÑËßàÊñáÊú¨</span> </div> </div> </div> <div class="chat-setting-footer"> <button id="randomcolor-setting-btn" style="background-color:#919bec;color:#fff">ÈöèÊú∫</button> <button id="save-setting-btn">‰øùÂ≠ò</button> <button id="cancel-setting-btn">ÂèñÊ∂à</button> </div> </div>';
            // Exports
            /* harmony default export */ var chat_page_setting =
                chat_page_setting_code; // ./src/ÁïåÈù¢/chat/chat_list_item.html
            // Module
            var chat_list_item_code =
                '<div data-name="${name}" class="QQ_home_usermsg"> <div class="QQ_home_head" style="background-image:url(\'${head}\')"></div> <div style="width:100%;display:grid;grid-template-columns:1fr auto;grid-template-rows:1fr 1fr;row-gap:4px"> <span class="QQ_home_name"><strong>${name}</strong></span> <span class="QQ_home_lasttime" style="color:#626367;justify-self:end"></span> <span class="QQ_home_lastmsg" style="color:#626367;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">...</span> <div class="QQ_home_usermsg_new" style="display:none"></div> </div> </div>';
            // Exports
            /* harmony default export */ var chat_list_item =
                chat_list_item_code; // ./src/ÁïåÈù¢/chat/chat_user_message.html
            // Module
            var chat_user_message_code =
                '<div class="QQ_chat_mymsg"> <div style="width:auto;height:auto;margin-top:4px"> ${content} </div> <div class="user_avatar Chat_MyHead"></div> </div>';
            // Exports
            /* harmony default export */ var chat_user_message =
                chat_user_message_code; // ./src/ÁïåÈù¢/chat/chat_char_msg.html
            // Module
            var chat_char_msg_code =
                ' <% if (isgroup) { %> <div class="QQ_chat_charmsg"> <div data-name="${name}" class="QQ_chat_head head"></div> <div style="width:auto;height:auto;margin-top:4px"> <span class="name">${name}</span><br/> ${content} </div> </div> <% } else { %> <div class="QQ_chat_charmsg"> <div data-name="${name}" class="QQ_chat_head head"></div> <div style="width:auto;height:auto;margin-top:4px">${content}</div> </div> <% } %>';
            // Exports
            /* harmony default export */ var chat_char_msg = chat_char_msg_code; // ./src/ÁïåÈù¢/chat/chat_normal_message.html
            // Module
            var chat_normal_message_code =
                '<div class="QQ_chat_msgdiv" data-name="${username}" <% if (isgroup) { %> style="margin-top:6px" <% } %>> <span>${message}</span> </div>';
            // Exports
            /* harmony default export */ var chat_normal_message =
                chat_normal_message_code; // ./src/ÁïåÈù¢/chat/chat_emoji_message.html
            // Module
            var chat_emoji_message_code =
                '<div class="QQ_chat_msgdiv" data-name="${username}" <% if (isgroup) { %> style="margin-top:6px" <% } %>> <div style="width:100%;background-color:#fff"> <img class="msgimg" loading="lazy" src="<%= emojiUrl %>" alt="Âä†ËΩΩÂ§±Ë¥•"/> </div> <% if (additionalText) { %> <span style="margin-top:5px;display:block"> <%= additionalText %> </span> <% } %> </div>';
            // Exports
            /* harmony default export */ var chat_emoji_message =
                chat_emoji_message_code; // ./src/ÁïåÈù¢/chat/chat_fakeimg_message.html
            // Module
            var chat_fakeimg_message_code =
                '<div class="QQ_chat_msgdiv" data-name="${username}" <% if (isgroup) { %> style="margin-top:6px" <% } %>> <div class="QQ_chat_fakeimg" style="text-align:center"> <div>${content}</div> </div> ${additionalText} </div>';
            // Exports
            /* harmony default export */ var chat_fakeimg_message =
                chat_fakeimg_message_code; // ./src/ÁïåÈù¢/chat/chat_music_message.html
            // Module
            var chat_music_message_code =
                '<div class="QQ_chat_music"> <div class="music-container" style="display:grid;grid-template-columns:1fr 64px;width:100%"> <div style="display:flex;flex-direction:column;margin-top:8px;overflow:hidden;max-width:100%"> <div class="hide-title music-name" style="font-size:1.2rem"><strong>${musicname}</strong></div> <div class="hide-title music-author" style="color:#8d8c8d;margin-left:3px;margin-top:10px;font-size:1rem">${musicauthor}</div> </div> <div style="margin-left:auto;position:relative;height:64px;width:64px"> <div class="icon-container" style="width:64px;width:64px;position:relative"> <svg style="position:absolute;left:-3px;top:-5px" class="icon" viewBox="0 0 1024 1024" width="72" height="72"><path d="M773.9392 301.8752m-200.0384 0a200.0384 200.0384 0 1 0 400.0768 0 200.0384 200.0384 0 1 0-400.0768 0Z" fill="#d81e06" p-id="51386"></path><path d="M924.4672 706.2528a24.32 24.32 0 0 1-24.2688 24.2688h-145.7664a24.3712 24.3712 0 0 0-24.2688 24.32 24.2688 24.2688 0 0 0 24.2688 24.2688h48.5888a24.32 24.32 0 0 1 24.2688 24.32 24.32 24.32 0 0 1-24.2688 24.2688h-64.512A388.7616 388.7616 0 0 1 122.88 390.4512h-48.5888a24.32 24.32 0 0 1 0-48.5888h97.28a24.2688 24.2688 0 0 0 6.8096-47.5648l0.768-0.9728H122.88a24.32 24.32 0 1 1 0-48.5888h101.632a388.7616 388.7616 0 0 1 619.52 437.248h56.32a24.32 24.32 0 0 1 24.1152 24.2688z" fill="#2c2c2c" p-id="51387"></path><path d="M565.8112 478.8736a3.84 3.84 0 0 0-4.5568 4.608c3.1744 14.7456 7.8848 40.96 9.984 60.0576 3.6352 32.2048-28.5696 62.3104-53.6064 70.7584-39.424 13.568-84.8896-18.688-95.1296-56.32-11.776-43.9808 12.6464-97.5872 53.2992-115.0464 4.5056-2.0992 9.0112-3.8912 13.568-5.9904 9.3184-4.2496 4.8128-11.1616 3.2768-17.5104-4.1984-17.4592-6.6048-34.9184 2.4064-51.2 13.568-24.4224 48.7936-43.6736 76.1856-31.9488a276.48 276.48 0 0 1 34.6624 16.5888 25.1904 25.1904 0 0 1 10.5472 28.2624c-5.7344 15.36-20.7872 18.9952-36.7616 9.6768a196.1984 196.1984 0 0 0-17.4592-9.9328 16.2304 16.2304 0 0 0-23.808 15.36 150.3744 150.3744 0 0 0 1.9456 18.0224 18.4832 18.4832 0 0 0 13.568 14.8992 200.3456 200.3456 0 0 1 29.3888 8.9088c38.8096 17.152 66.56 45.1584 79.5136 87.04 24.064 77.6704-21.0944 155.0848-87.9616 184.6272a182.016 182.016 0 0 1-116.8384 13.2096 185.6 185.6 0 0 1-126.464-104.8064c-18.0736-40.96-22.8864-82.7904-8.7552-127.0784 18.9952-59.2384 56.9344-99.6352 114.7392-121.9072a23.4496 23.4496 0 0 1 28.0064 9.728 21.1456 21.1456 0 0 1-6.0416 29.5424 259.8912 259.8912 0 0 1-25.2928 13.568c-31.8976 16.2304-51.7632 42.752-64.4096 75.8784-24.7296 64.4096 9.3184 139.1104 65.6384 168.3456 51.7632 27.0848 122.5728 16.2304 160.8192-28.3136A106.2912 106.2912 0 0 0 619.52 542.72c-5.12-25.6-34.5088-59.2896-53.7088-63.8464z m-53.4016 5.9904a6.144 6.144 0 0 0-7.9872-4.5056c-33.28 11.4688-47.5136 47.2576-31.9488 76.4416a28.0064 28.0064 0 0 0 30.1056 13.824c14.1824-4.1984 24.1152-14.4384 22.016-27.6992-2.9696-19.5072-7.936-38.8096-12.1856-58.0608z" fill="#d81e06" p-id="51388"></path></svg> <div class="music-img" style="width:64px;height:64px;position:absolute;left:0;top:0;background-size:cover;z-index:1;background-image:url(\'https://y.qq.com/music/photo_new/T002R800x800M000004Z85XP1c25b7.jpg\');display:none"> </div> </div> <div class="music-play-button"> <svg class="icon-music-play" viewBox="0 0 1024 1024" width="24" height="24"> <path d="M902.420317 544.833016l-585.142857-357.587302v715.174603l585.142857-357.587301z" p-id="42990" fill="#ffffff"></path> </svg> <svg class="icon-music-stop" t="1743245033745" class="icon" viewBox="0 0 1024 1024" width="19" height="19" style="display:none"><path d="M290.133333 128h-39.808C206.336 128 170.666667 178.944 170.666667 241.792v540.416C170.666667 845.056 206.336 896 250.325333 896H290.133333c43.946667 0 79.658667-50.944 79.658667-113.792V241.792C369.792 178.944 334.08 128 290.133333 128zM773.674667 128H733.866667c-43.989333 0-79.658667 50.944-79.658667 113.792v540.416c0 62.848 35.669333 113.792 79.658667 113.792h39.808C817.664 896 853.333333 845.056 853.333333 782.208V241.792C853.333333 178.944 817.664 128 773.674667 128z" fill="#ffffff" p-id="43402"></path></svg> </div> </div> </div> <div style="width:100%;height:2px;background-color:#efefef;margin-bottom:5px;margin-top:5px"></div> <div style="display:flex;align-items:center;gap:5px"> <svg viewBox="0 0 1024 1024" style="width:.9rem;height:.9rem"> <path d="M0 0m184.32 0l655.36 0q184.32 0 184.32 184.32l0 655.36q0 184.32-184.32 184.32l-655.36 0q-184.32 0-184.32-184.32l0-655.36q0-184.32 184.32-184.32Z" fill="#EA3E3C" p-id="1500"></path> <path d="M527.616 849.43872a373.6064 373.6064 0 0 1-162.54976-39.00416c-112.36352-55.16288-180.00896-176.29184-172.55424-308.67456 7.41376-130.34496 85.10464-237.4656 202.752-279.552a35.85024 35.85024 0 0 1 24.15616 67.51232c-107.66336 38.49216-150.81472 136.86784-155.29984 216.13568-5.86752 103.51616 46.08 197.79584 132.34176 240.13824 124.69248 60.30336 216.91392 22.35392 260.82304-5.64224 59.8016-38.16448 97.86368-100.01408 96.95232-157.55264-1.024-63.72352-24.064-120.99584-63.27296-157.14304a145.408 145.408 0 0 0-65.5872-35.28704q2.82624 9.76896 5.64224 19.32288c13.38368 45.63968 24.94464 85.05344 25.6 114.40128a134.26688 134.26688 0 0 1-37.69344 97.76128 139.1104 139.1104 0 0 1-100.6592 40.45824 140.10368 140.10368 0 0 1-100.47488-42.24 169.12384 169.12384 0 0 1-46.2848-122.76736c1.19808-85.12512 80.11776-153.28256 162.816-175.104a324.80256 324.80256 0 0 1-6.71744-67.05152 92.0576 92.0576 0 0 1 69.18144-91.81184c46.21312-12.53376 104.448 5.19168 124.66176 37.888a35.84 35.84 0 0 1-11.70432 49.31584 35.84 35.84 0 0 1-49.26464-11.65312 62.34112 62.34112 0 0 0-48.45568-5.21216c-4.32128 1.71008-12.35968 4.90496-12.76928 23.10144a270.87872 270.87872 0 0 0 6.73792 58.51136 217.4976 217.4976 0 0 1 133.56032 57.6512c53.57568 49.38752 85.0432 125.46048 86.35392 208.71168 1.29024 81.85856-49.7664 167.86432-130.048 219.136a310.14912 310.14912 0 0 1-168.2432 48.65024z m23.6544-457.55392c-56.77056 15.6672-107.4688 63.03744-108.07296 106.42432a98.304 98.304 0 0 0 25.6512 71.43424 68.0448 68.0448 0 0 0 49.36704 20.87936 67.24608 67.24608 0 0 0 49.44896-18.944 63.19104 63.19104 0 0 0 17.23392-46.08c-0.4096-19.79392-11.7248-58.368-22.67136-95.6928-3.61472-12.42112-7.35232-25.14944-10.9568-38.02112z" fill="#FFFFFF" p-id="1501"></path> </svg> <div style="font-size:.9rem;color:#8d8c8c">ÁΩëÊòì‰∫ëÈü≥‰πê</div> </div> </div>';
            // Exports
            /* harmony default export */ var chat_music_message =
                chat_music_message_code; // ./src/ÁïåÈù¢/chat/chat_transfer_message.html
            // Module
            var chat_transfer_message_code =
                '<div class="give_money"> <div style="background-color:#4396f7;height:80px;width:100%;color:#fff;padding-top:20px;padding-left:12px;display:flex;flex-direction:column;gap:9px;position:relative"> <span><%= amount %></span> <span>Â∑≤ËΩ¨ÂÖ•‰Ω†ÁöÑ‰ΩôÈ¢ù</span> <div style="border-radius:50%;background-color:#9fccf1;width:50px;height:50px;position:absolute;right:10px;display:flex;align-items:center;justify-content:center;top:15px"> <svg t="1738258225266" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4449" width="33" height="33"> <path d="M954.014 510.695c-31.51 0.303-185.995-88.917-190.874-93.568-11.734-11.188-7.3-25.115 4.673-27.02s79.203-9.898 79.203-9.898c-41.318-110.437-133.518-198.636-254.527-227.223-193.138-45.643-392.87 83.827-437.013 281.424-0.38 1.685-3.047 21.83-19.045 21.191-10.83-0.432-46.309-14.539-59.136-20.556-14.644-6.868-18.601-5.094-14.16-27.201C113.37 156.643 370.632-12.653 617.554 45.272c204.919 48.063 347.27 225.878 362.91 428.477 2.619 27.151-11.203 36.797-26.451 36.944z m-322.516 55.059c20.284 0 36.729 16.427 36.729 36.727 0 20.265-16.445 36.729-36.729 36.729h-73.456v45.909c0 25.359-20.551 45.911-45.911 45.911-25.358 0-45.91-20.551-45.91-45.911V639.21h-73.456c-20.284 0-36.727-16.465-36.727-36.729 0-20.302 16.444-36.727 36.727-36.727h73.456v-36.73h-73.456c-20.284 0-36.727-16.461-36.727-36.726 0-20.3 16.444-36.729 36.727-36.729h73.456v-2.512l-81.508-81.491c-14.445-14.455-14.445-37.875 0-52.313s37.858-14.437 52.304 0l74.497 74.478 74.786-74.784c14.444-14.419 37.859-14.419 52.303 0 14.446 14.454 14.446 37.877 0 52.313l-80.558 80.559v3.749h73.456c20.284 0 36.729 16.429 36.729 36.729 0 20.267-16.445 36.726-36.729 36.726h-73.456v36.73h73.456z m-368.471 51.828c16.112 10.302 12.229 30.994-5.477 32.836s-73.153 6.725-73.153 6.725C228.353 760.157 317.44 841.379 432.63 868.585c193.137 45.623 390.651-77.582 434.806-275.179 0.906-4.054 0.877-3.418 2.457-12.122s4.139-21.945 21.142-16.052 58.475 18.085 71.394 21.539 11.465 8.548 9.846 20.553c-0.493 3.651-1.238 6.994-2.017 10.509-57.81 256.921-309.451 417.196-562.049 357.924-204.677-48.01-346.947-225.429-362.865-427.724-2.159-34.762 22.4-41.857 47.505-28.577 19.75 10.447 154.064 87.822 170.176 98.124z" p-id="4450" fill="#4090ee"></path> </svg> </div> </div> <div style="background-color:#fff;width:100%;height:30px;color:#959598;font-size:13px;padding-left:10px;padding-top:8px"> QQËΩ¨Ë¥¶ </div> </div> ';
            // Exports
            /* harmony default export */ var chat_transfer_message =
                chat_transfer_message_code; // ./src/ÁïåÈù¢/chat/chat_char_voice_message.html
            // Module
            var chat_char_voice_message_code =
                '<div class="QQ_chat_msgdiv" data-name="${username}" <% if (isgroup) { %> style="margin-top:6px" <% } %>> <div class="QQ_chat_voice" style="width:100%;display:flex;gap:5px;align-items:center"> <span style="margin-left:2px">${time}"</span> <span style="display:block"> <svg style="transform:rotate(90deg);display:flex;align-items:center" t="1742985508017" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="38914" width="20" height="20"> <path d="M99.931429 457.782857c8.137143 8.137143 20.132571 7.716571 27.849142-0.420571 101.156571-107.574857 234.861714-164.150857 384.438858-164.150857 150.418286 0 284.562286 56.996571 385.28 164.571428 7.277714 7.296 18.870857 7.296 26.569142-0.859428l57.014858-56.996572c6.838857-7.277714 6.838857-16.713143 1.28-23.570286-96.859429-119.149714-279.003429-206.994286-470.144-206.994285S138.934857 257.206857 42.057143 376.356571c-5.997714 6.857143-5.577143 16.274286 1.28 23.588572z m171.428571 171.867429c8.576 8.996571 19.712 8.137143 27.849143-1.28 49.718857-55.296 130.285714-95.158857 213.010286-94.299429 83.565714-0.859429 163.712 40.283429 213.851428 95.579429 8.137143 8.557714 18.852571 8.557714 27.008-0.438857l63.853714-62.994286c6.857143-6.857143 7.716571-15.853714 1.28-23.149714-62.134857-76.708571-177.426286-133.284571-305.993142-133.284572-128.585143 0-243.858286 56.996571-306.011429 133.302857-6.418286 7.277714-5.558857 15.835429 1.28 23.131429z m240.859429 224.987428c8.996571 0 17.133714-4.717714 32.987428-20.132571l100.297143-96.438857c6.418286-5.997714 7.716571-15.414857 2.139429-22.710857-27.008-34.706286-77.568-64.713143-135.424-64.713143-59.154286 0-110.573714 31.286857-137.142858 67.291428-3.858286 5.997714-2.56 14.134857 3.84 20.132572l100.297143 96.438857c15.853714 15.414857 24.009143 20.132571 33.005715 20.132571z" p-id="38915" fill="currentColor"></path> </svg> </span> <span style="display:block" class="totext"> <svg style="margin-left:30px;display:flex;align-items:center" viewBox="0 0 1024 1024" width="24" height="24"> <path d="M999.611733 387.697778a37.831111 37.831111 0 0 0-48.355555 22.641778v0.512l-1.592889 5.233777c-58.88-241.208889-302.648889-388.892444-543.857778-330.012444A446.805333 446.805333 0 0 0 124.546844 295.253333a39.139556 39.139556 0 0 0 13.653334 53.077334 39.310222 39.310222 0 0 0 18.944 5.233777c13.084444 0 25.201778-6.826667 32.540444-18.375111a374.158222 374.158222 0 0 1 359.480889-183.978666 381.952 381.952 0 0 1 337.351111 334.279111 384.568889 384.568889 0 0 1-3.128889 115.086222v2.616889a38.855111 38.855111 0 0 0 21.560889 48.355555c19.456 6.826667 41.528889-3.185778 48.355556-22.641777l68.835555-192.284445a39.310222 39.310222 0 0 0-22.584889-48.924444z m-148.764444 348.956444a38.115556 38.115556 0 0 0-31.004445 16.839111 373.077333 373.077333 0 0 1-355.214222 157.639111 381.212444 381.212444 0 0 1-323.185778-306.346666 396.344889 396.344889 0 0 1 0-140.856889v-1.592889a39.139556 39.139556 0 0 0-22.072888-48.355556 38.058667 38.058667 0 0 0-48.355556 22.584889l-68.835556 191.317334a38.513778 38.513778 0 0 0 23.608889 48.867555c19.456 7.395556 40.96-3.128889 48.355556-22.584889v-3.697777c58.88 241.208889 302.705778 388.892444 543.914667 330.012444A448.739556 448.739556 0 0 0 881.851733 798.151111a38.684444 38.684444 0 0 0-8.362666-54.158222 31.857778 31.857778 0 0 0-22.641778-7.338667z" p-id="41017" fill="currentColor"></path><path d="M310.687289 693.020444a50.517333 50.517333 0 0 0-33.166222 19.456 40.96 40.96 0 0 0 0 31.573334c1.592889 4.721778 3.697778 9.443556 6.257777 14.165333a26.794667 26.794667 0 0 0 13.198223 11.036445 30.833778 30.833778 0 0 0 12.060444 2.104888h5.290667c6.826667-1.080889 13.653333-2.616889 20.48-4.721777 15.758222-5.290667 32.028444-11.605333 48.924444-18.432 16.782222-6.826667 34.133333-15.758222 49.322667-23.608889 15.246222-7.907556 32.597333-17.863111 46.250667-26.282667 14.222222-8.419556 24.177778-15.758222 35.271111-24.177778 24.632889 19.456 50.915556 36.238222 78.791111 49.891556 33.621333 17.351111 68.835556 31.004444 105.073778 42.097778a56.32 56.32 0 0 0 20.48 3.640889 33.905778 33.905778 0 0 0 34.190222-26.282667 39.025778 39.025778 0 0 0-1.592889-35.726222 49.322667 49.322667 0 0 0-26.225778-18.375111 540.842667 540.842667 0 0 1-85.162667-33.621334 603.932444 603.932444 0 0 1-63.601777-38.912c20.48-23.096889 37.831111-48.355556 52.565333-75.662222a465.294222 465.294222 0 0 0 38.343111-98.304h49.436445a38.456889 38.456889 0 0 0 26.282666-12.060444 46.762667 46.762667 0 0 0 7.850667-26.282667 44.032 44.032 0 0 0-8.931556-28.899556 37.432889 37.432889 0 0 0-26.282666-11.036444H568.6784a116.167111 116.167111 0 0 0-9.500444-17.863111c-10.467556-12.629333-22.584889-25.770667-34.702223-38.912a47.786667 47.786667 0 0 0-27.818666-18.375111h-4.209778a36.636444 36.636444 0 0 0-24.177778 8.419555 35.896889 35.896889 0 0 0-18.375111 29.923556 51.2 51.2 0 0 0 16.270222 33.109333l6.314667 6.314667H315.352178a34.133333 34.133333 0 0 0-26.282667 12.629333 45.852444 45.852444 0 0 0-6.826667 26.282667c-0.512 10.467556 2.104889 20.48 7.907556 28.899555 6.826667 6.826667 16.270222 11.036444 26.282667 11.036445h47.274666c5.233778 15.758222 10.524444 32.028444 16.839111 47.786666a419.271111 419.271111 0 0 0 50.403556 94.094223c8.419556 11.036444 17.351111 22.584889 26.282667 33.109333a389.461333 389.461333 0 0 1-64.625778 39.936c-26.282667 12.629333-54.101333 23.096889-81.976889 32.028444z m131.299555-246.954666h140.344889c-6.826667 23.096889-16.839111 45.169778-28.387555 66.730666a325.290667 325.290667 0 0 1-39.936 55.751112 319.146667 319.146667 0 0 1-39.424-52.622223l-2.616889-4.209777a388.778667 388.778667 0 0 1-29.980445-65.649778z" p-id="41018" fill="currentColor"></path></svg> </span> </div> <div class="voice2text" style="display:none"> <div style="width:100%;height:1px;background-color:#000;margin-top:10px;margin-bottom:8px"></div> <span>${content}</span> </div> </div>';
            // Exports
            /* harmony default export */ var chat_char_voice_message =
                chat_char_voice_message_code; // ./src/ÁïåÈù¢/chat/chat_my_voice_message.html
            // Module
            var chat_my_voice_message_code =
                '<div class="QQ_chat_msgdiv ${username}" <% if (isgroup) { %> style="margin-top:6px" <% } %>> <div class="QQ_chat_voice" style="width:100%;display:flex;gap:5px;align-items:center"> <span style="display:block" class="totext"> <svg style="margin-right:30px;display:flex;align-items:center" viewBox="0 0 1024 1024" width="24" height="24"> <path d="M999.611733 387.697778a37.831111 37.831111 0 0 0-48.355555 22.641778v0.512l-1.592889 5.233777c-58.88-241.208889-302.648889-388.892444-543.857778-330.012444A446.805333 446.805333 0 0 0 124.546844 295.253333a39.139556 39.139556 0 0 0 13.653334 53.077334 39.310222 39.310222 0 0 0 18.944 5.233777c13.084444 0 25.201778-6.826667 32.540444-18.375111a374.158222 374.158222 0 0 1 359.480889-183.978666 381.952 381.952 0 0 1 337.351111 334.279111 384.568889 384.568889 0 0 1-3.128889 115.086222v2.616889a38.855111 38.855111 0 0 0 21.560889 48.355555c19.456 6.826667 41.528889-3.185778 48.355556-22.641777l68.835555-192.284445a39.310222 39.310222 0 0 0-22.584889-48.924444z m-148.764444 348.956444a38.115556 38.115556 0 0 0-31.004445 16.839111 373.077333 373.077333 0 0 1-355.214222 157.639111 381.212444 381.212444 0 0 1-323.185778-306.346666 396.344889 396.344889 0 0 1 0-140.856889v-1.592889a39.139556 39.139556 0 0 0-22.072888-48.355556 38.058667 38.058667 0 0 0-48.355556 22.584889l-68.835556 191.317334a38.513778 38.513778 0 0 0 23.608889 48.867555c19.456 7.395556 40.96-3.128889 48.355556-22.584889v-3.697777c58.88 241.208889 302.705778 388.892444 543.914667 330.012444A448.739556 448.739556 0 0 0 881.851733 798.151111a38.684444 38.684444 0 0 0-8.362666-54.158222 31.857778 31.857778 0 0 0-22.641778-7.338667z" p-id="41017" fill="currentColor"></path><path d="M310.687289 693.020444a50.517333 50.517333 0 0 0-33.166222 19.456 40.96 40.96 0 0 0 0 31.573334c1.592889 4.721778 3.697778 9.443556 6.257777 14.165333a26.794667 26.794667 0 0 0 13.198223 11.036445 30.833778 30.833778 0 0 0 12.060444 2.104888h5.290667c6.826667-1.080889 13.653333-2.616889 20.48-4.721777 15.758222-5.290667 32.028444-11.605333 48.924444-18.432 16.782222-6.826667 34.133333-15.758222 49.322667-23.608889 15.246222-7.907556 32.597333-17.863111 46.250667-26.282667 14.222222-8.419556 24.177778-15.758222 35.271111-24.177778 24.632889 19.456 50.915556 36.238222 78.791111 49.891556 33.621333 17.351111 68.835556 31.004444 105.073778 42.097778a56.32 56.32 0 0 0 20.48 3.640889 33.905778 33.905778 0 0 0 34.190222-26.282667 39.025778 39.025778 0 0 0-1.592889-35.726222 49.322667 49.322667 0 0 0-26.225778-18.375111 540.842667 540.842667 0 0 1-85.162667-33.621334 603.932444 603.932444 0 0 1-63.601777-38.912c20.48-23.096889 37.831111-48.355556 52.565333-75.662222a465.294222 465.294222 0 0 0 38.343111-98.304h49.436445a38.456889 38.456889 0 0 0 26.282666-12.060444 46.762667 46.762667 0 0 0 7.850667-26.282667 44.032 44.032 0 0 0-8.931556-28.899556 37.432889 37.432889 0 0 0-26.282666-11.036444H568.6784a116.167111 116.167111 0 0 0-9.500444-17.863111c-10.467556-12.629333-22.584889-25.770667-34.702223-38.912a47.786667 47.786667 0 0 0-27.818666-18.375111h-4.209778a36.636444 36.636444 0 0 0-24.177778 8.419555 35.896889 35.896889 0 0 0-18.375111 29.923556 51.2 51.2 0 0 0 16.270222 33.109333l6.314667 6.314667H315.352178a34.133333 34.133333 0 0 0-26.282667 12.629333 45.852444 45.852444 0 0 0-6.826667 26.282667c-0.512 10.467556 2.104889 20.48 7.907556 28.899555 6.826667 6.826667 16.270222 11.036444 26.282667 11.036445h47.274666c5.233778 15.758222 10.524444 32.028444 16.839111 47.786666a419.271111 419.271111 0 0 0 50.403556 94.094223c8.419556 11.036444 17.351111 22.584889 26.282667 33.109333a389.461333 389.461333 0 0 1-64.625778 39.936c-26.282667 12.629333-54.101333 23.096889-81.976889 32.028444z m131.299555-246.954666h140.344889c-6.826667 23.096889-16.839111 45.169778-28.387555 66.730666a325.290667 325.290667 0 0 1-39.936 55.751112 319.146667 319.146667 0 0 1-39.424-52.622223l-2.616889-4.209777a388.778667 388.778667 0 0 1-29.980445-65.649778z" p-id="41018" fill="currentColor"></path></svg> </span> <div style="display:flex;align-items:center;gap:5px;margin-left:auto"> <span style="display:block"> <svg style="transform:rotate(-90deg);display:flex;align-items:center" t="1742985508017" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="38914" width="20" height="20"> <path d="M99.931429 457.782857c8.137143 8.137143 20.132571 7.716571 27.849142-0.420571 101.156571-107.574857 234.861714-164.150857 384.438858-164.150857 150.418286 0 284.562286 56.996571 385.28 164.571428 7.277714 7.296 18.870857 7.296 26.569142-0.859428l57.014858-56.996572c6.838857-7.277714 6.838857-16.713143 1.28-23.570286-96.859429-119.149714-279.003429-206.994286-470.144-206.994285S138.934857 257.206857 42.057143 376.356571c-5.997714 6.857143-5.577143 16.274286 1.28 23.588572z m171.428571 171.867429c8.576 8.996571 19.712 8.137143 27.849143-1.28 49.718857-55.296 130.285714-95.158857 213.010286-94.299429 83.565714-0.859429 163.712 40.283429 213.851428 95.579429 8.137143 8.557714 18.852571 8.557714 27.008-0.438857l63.853714-62.994286c6.857143-6.857143 7.716571-15.853714 1.28-23.149714-62.134857-76.708571-177.426286-133.284571-305.993142-133.284572-128.585143 0-243.858286 56.996571-306.011429 133.302857-6.418286 7.277714-5.558857 15.835429 1.28 23.131429z m240.859429 224.987428c8.996571 0 17.133714-4.717714 32.987428-20.132571l100.297143-96.438857c6.418286-5.997714 7.716571-15.414857 2.139429-22.710857-27.008-34.706286-77.568-64.713143-135.424-64.713143-59.154286 0-110.573714 31.286857-137.142858 67.291428-3.858286 5.997714-2.56 14.134857 3.84 20.132572l100.297143 96.438857c15.853714 15.414857 24.009143 20.132571 33.005715 20.132571z" p-id="38915" fill="currentColor"></path> </svg> </span> <span>${time}"</span> </div> </div> <div class="voice2text" style="display:none"> <div style="width:100%;height:1px;background-color:#000;margin-top:10px;margin-bottom:8px"></div> <span>${content}</span> </div> </div>';
            // Exports
            /* harmony default export */ var chat_my_voice_message =
                chat_my_voice_message_code; // ./src/ÁïåÈù¢/chat/chat_head.css?raw
            var chat_headraw_namespaceObject =
                ".head[data-name='${name}'] {\r\n  background-image: url('${head}') !important;\r\n}\r\n"; // ./src/ÁïåÈù¢/moment/moment_page.html
            // Module
            var moment_page_code =
                '<div class="user_moment_title" style="margin-bottom:7px"> <div class="QQ_home_head head" data-name="${userName}"></div> <div style="width:100%;display:grid;grid-template-rows:1fr 1fr;row-gap:4px"> <div style="display:flex;align-items:center"> <span><strong class="moment_sender">${userName}</strong></span> <svg class="moment_menu_dots" viewBox="0 0 1024 1024" width="18" height="18" style="margin-left:auto;cursor:pointer" data-moment-id="${momentId}"> <path d="M512.4 429.1c22.3 0 41.7 7.9 58.1 23.6 7.9 7.9 13.9 16.9 18.2 27.1 4.3 10.2 6.4 20.8 6.4 32 0 22.3-8.2 41.7-24.6 58.1-3.3 3.3-6.6 6.1-9.9 8.4s-6.9 4.4-10.8 6.4c-3.9 2-8 3.6-12.3 4.9-4.3 1.3-8.5 2.5-12.8 3.4-4.2 1-8.3 1.5-12.3 1.5-23 0-42.5-8.2-58.6-24.6s-24.1-35.9-24.1-58.6c0-22.6 7.9-42.2 23.6-58.6 5.3-4.6 11-8.9 17.2-12.8 6.2-3.9 13-6.7 20.2-8.4 7.2-1.6 14.4-2.4 21.7-2.4z m326.8 0c23 0 42.3 7.9 58.1 23.6 5.3 5.3 9.7 11 13.3 17.2 3.6 6.2 6.4 13 8.4 20.2 2 7.2 3 14.4 3 21.7 0 22.3-8.2 41.7-24.6 58.1-3.3 3.9-7.2 7.4-11.8 10.3-4.6 2.9-9.4 5.4-14.3 7.4s-10.2 3.6-15.8 4.9-11 2-16.3 2c-23 0-42.5-8.2-58.6-24.6-16.1-16.4-24.1-35.9-24.1-58.6 0-22.6 8.2-42.2 24.6-58.6 7.2-7.2 16.1-13 26.6-17.2 10.5-4.2 21-6.3 31.5-6.4z m-654.6 0c23 0 42.3 7.9 58.1 23.6 5.3 5.3 9.7 11 13.3 17.2 3.6 6.2 6.4 13 8.4 20.2s3 14.4 3 21.7c0 22.3-8 41.7-24.1 58.1s-35.6 24.6-58.6 24.6-42.3-8.2-58.1-24.6c-7.9-7.9-13.9-16.9-18.2-27.1-4.3-10.2-6.4-20.5-6.4-31 0-23 8.2-42.7 24.6-59.1 7.2-7.2 16.1-13 26.6-17.2 10.4-4.2 20.9-6.3 31.4-6.4z" p-id="14923" fill="#000000"></path> </svg> </div> <span style="color:#626367;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:12px">${timestamp}</span> </div> </div> <span style="font-size:15px;line-height:1.3" class="moment_message">${message}</span> ${imgcontent} <div style="display:flex;align-items:center;gap:3px;margin-top:5px"> <svg t="1736250731870" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="16069" width="16" height="16"> <path d="M512 416a96 96 0 1 1-96 96 96 96 0 0 1 96-96m0-64a160 160 0 1 0 160 160 160 160 0 0 0-160-160z" fill="#a1a1a1" p-id="16070"></path> <path d="M512 298.88c188.64 0 288 113.92 366.72 213.12C800 611.36 700.64 725.12 512 725.12S224 611.36 145.28 512C224 412.64 323.36 298.88 512 298.88m0-64C264.64 234.88 147.52 406.56 64 512c83.52 105.44 200.64 277.12 448 277.12S876.48 617.44 960 512c-83.52-105.44-200.64-277.12-448-277.12z" fill="#a1a1a1" p-id="16071"></path> </svg> <span style="color:#a1a1a1;font-size:13px">ÊµèËßà${additionalInfo}Ê¨°</span> <div class="moment_button"> <svg viewBox="0 0 1024 1024" width="26" height="26"> <path d="M190.193225 471.411583c14.446014 0 26.139334-11.718903 26.139334-26.13831 0-14.44499-11.69332-26.164916-26.139334-26.164916-0.271176 0-0.490164 0.149403-0.73678 0.149403l-62.496379 0.146333c-1.425466-0.195451-2.90005-0.295735-4.373611-0.295735-19.677155 0-35.621289 16.141632-35.621289 36.114522L86.622358 888.550075c0 19.949354 15.96767 35.597753 35.670407 35.597753 1.916653 0 3.808746 0.292666 5.649674 0l61.022819 0.022513c0.099261 0 0.148379 0.048095 0.24764 0.048095 0.097214 0 0.146333-0.048095 0.24457-0.048095l0.73678 0 0-0.148379c13.413498-0.540306 24.174586-11.422144 24.174586-24.960485 0-13.55983-10.760065-24.441669-24.174586-24.981974l0-0.393973-50.949392 0 1.450025-402.275993L190.193225 471.409536z" fill="#000000" p-id="19734"></path> <path d="M926.52241 433.948343c-19.283182-31.445176-47.339168-44.172035-81.289398-45.546336-1.77032-0.246617-3.536546-0.39295-5.380544-0.39295l-205.447139-0.688685c13.462616-39.059598 22.698978-85.58933 22.698978-129.317251 0-28.349675-3.193739-55.962569-9.041934-82.542948l-0.490164 0.049119c-10.638291-46.578852-51.736315-81.31498-100.966553-81.31498-57.264215 0-95.466282 48.15065-95.466282 106.126063 0 3.241834-0.294712 6.387477 0 9.532097-2.996241 108.386546-91.240027 195.548698-196.23636 207.513194l0 54.881958-0.785899 222.227314 0 229.744521 10.709923 0 500.025271 0.222057 8.746198-0.243547c19.35686 0.049119 30.239721-4.817726 47.803749-16.116049 16.682961-10.761088 29.236881-25.50079 37.490869-42.156122 2.260483-3.341095 4.028757-7.075139 5.106298-11.20111l77.018118-344.324116c1.056052-4.053316 1.348718-8.181333 1.056052-12.160971C943.643346 476.446249 938.781618 453.944769 926.52241 433.948343zM893.82573 486.837924l-82.983993 367.783411-0.099261-0.049119c-2.555196 6.141884-6.879688 11.596106-12.872169 15.427364-4.177136 2.727111-8.773827 4.351098-13.414521 4.964058-1.49812-0.195451-3.046383 0-4.620227 0l-477.028511-0.540306-0.171915-407.408897c89.323375-40.266076 154.841577-79.670527 188.596356-173.661202 0.072655 0.024559 0.124843 0.049119 0.195451 0.072655 2.99931-9.137101 6.313799-20.73423 8.697079-33.164331 5.551436-29.185716 5.258771-58.123792 5.258771-58.123792-4.937452-37.98001 25.940812-52.965306 44.364417-52.965306 25.304316 0.860601 50.263777 33.656541 50.263777 52.326762 0 0 5.600555 27.563776 5.649674 57.190537 0.048095 37.366026-4.6673 56.847729-4.6673 56.847729l-0.466628 0c-5.872754 30.879288-16.214287 60.138682-30.464849 86.964654l0.36839 0.342808c-2.358721 4.815679-3.709485 10.220782-3.709485 15.943111 0 19.922748 19.088754 21.742187 38.765909 21.742187l238.761895 0.270153c0 0 14.666024 0.465604 14.690584 0.465604l0 0.100284c12.132318-0.638543 24.221658 5.207605 31.100322 16.409738 5.504364 9.016351 6.437619 19.6045 3.486404 28.988218L893.82573 486.837924z" fill="#000000" p-id="19735"></path> <path d="M264.827039 924.31872c0.319272 0.024559 0.441045 0.024559 0.295735-0.024559 0.243547-0.048095 0.367367-0.074701-0.295735-0.074701s-0.539282 0.026606-0.271176 0.074701C264.43409 924.343279 264.532327 924.343279 264.827039 924.31872z" fill="#000000" p-id="19736"></path> </svg> <svg viewBox="0 0 1024 1024" width="28" height="28"> <path d="M185.2 888.7c-16.6 0-30-13.4-30-30v-580c0-49.6 40.4-90 90-90h540c49.6 0 90 40.4 90 90v410c0 49.6-40.4 90-90 90h-429c-16.6 0-30-13.4-30-30s13.4-30 30-30h429c16.5 0 30-13.5 30-30v-410c0-16.5-13.5-30-30-30h-540c-16.5 0-30 13.5-30 30v580c0 16.5-13.5 30-30 30z m490.1-430.5H347c-16.6 0-30-13.4-30-30s13.4-30 30-30h328.3c16.6 0 30 13.4 30 30s-13.4 30-30 30zM494 598.2H345.7c-16.6 0-30-13.4-30-30s13.4-30 30-30H494c16.6 0 30 13.4 30 30s-13.4 30-30 30zM194.2 883.7c-9.8 0-19.3-4.8-25.1-13.5-9.1-13.9-5.2-32.5 8.6-41.5l160-105c13.9-9.1 32.5-5.2 41.5 8.6 9.1 13.9 5.2 32.5-8.6 41.5l-160 105c-5 3.3-10.8 4.9-16.4 4.9z" fill="#202020" p-id="31300"></path> </svg> <svg viewBox="0 0 1024 1024" width="28" height="28"> <path d="M168.021333 751.104a53.333333 53.333333 0 0 1-81.450666-55.893333c48-219.733333 177.493333-333.184 381.205333-332.458667l8.490667-0.213333V186.026667c0-8.213333 2.602667-16.213333 7.445333-22.826667 1.237333-1.621333 1.237333-1.621333 2.602667-3.136a33.92 33.92 0 0 1 47.936-1.621333l370.197333 346.005333a32 32 0 0 0 1.066667 0.938667c7.914667 6.784 12.437333 16.576 12.437333 26.901333v3.498667c0 10.325333-4.522667 20.117333-12.373333 26.837333l-0.896 0.768-0.256 0.213333-370.922667 323.968c-1.109333 0.938667-1.109333 0.938667-2.282667 1.834667-15.146667 11.093333-36.437333 7.786667-47.509333-7.36a38.656 38.656 0 0 1-7.466667-22.826667v-197.248l-7.253333-0.362666c-112.213333 1.237333-212.266667 31.04-300.970667 89.472z m301.290667-153.472l1.962667 0.021333 68.992 3.541334v195.52l301.44-263.274667-301.44-281.749333v173.12l-31.146667 0.853333-40.597333 1.066667c-165.504-0.554667-268.117333 82.773333-313.386667 256.896 93.76-56.192 198.698667-84.906667 314.176-85.994667z m384.64-65.322667v3.498667c0-0.597333 0-1.173333 0.042667-1.749333a28.714667 28.714667 0 0 1-0.042667-1.749334z" fill="#000000" p-id="33532"></path> </svg> </div> </div> <div style="display:flex;align-items:center;gap:3px;margin-top:0"> <svg t="1736250924867" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="17414" width="16" height="16"> <path d="M736.653061 929.959184H287.346939c-45.97551 0-83.591837-37.616327-83.591837-83.591837V177.632653c0-45.97551 37.616327-83.591837 83.591837-83.591837h449.306122c45.97551 0 83.591837 37.616327 83.591837 83.591837v668.734694c0 45.97551-37.616327 83.591837-83.591837 83.591837zM287.346939 135.836735c-22.987755 0-41.795918 18.808163-41.795919 41.795918v668.734694c0 22.987755 18.808163 41.795918 41.795919 41.795918h449.306122c22.987755 0 41.795918-18.808163 41.795919-41.795918V177.632653c0-22.987755-18.808163-41.795918-41.795919-41.795918H287.346939z" fill="#a1a1a1" p-id="17415"></path> <path d="M616.489796 815.020408H407.510204c-11.493878 0-20.897959-9.404082-20.897959-20.897959s9.404082-20.897959 20.897959-20.897959h208.979592c11.493878 0 20.897959 9.404082 20.897959 20.897959s-9.404082 20.897959-20.897959 20.897959z" fill="#a1a1a1" p-id="17416"></path> </svg> <span style="color:#a1a1a1;font-size:13px">${randomPhone}</span> </div> <div style="display:flex;align-items:center;gap:3px;margin-top:5px;margin-bottom:5px"> <svg class="icon" viewBox="0 0 1024 1024" width="13" height="13"> <path d="M773.6 912.7h-1.2c-37.2-0.4-74.5-0.4-111.8-0.4h-56.9c-38 0-76 0-114.1-0.5-21.1-0.6-41.9-5-61.5-13-33.3-13-52.3-42-52.2-79.7l0.1-141.4c0-78.3 0-156.7 0.7-235 0.1-21.3 13.8-41.3 25.5-51.8 45.3-41.4 94.5-93 115.1-162.6 5.7-19.4 7.9-40.8 10.2-63.4 4.6-45 33.8-74.3 72.8-74.3 15.3 0 30.6 4.6 45.6 13.5 30.1 18.1 50.2 46.5 61.3 87 17.8 64.3 8.7 126.7-1.3 180.2v0.2c-2.3 12.5 7.1 24.1 19.9 24.1h130c22.4 0 54.5 2.8 74.3 26.8 14.4 17.5 18.5 41.1 12.4 72.3-18.6 95.9-41.4 192.6-63.2 282.7-6.8 28.1-18.1 54.1-29 79.3l-4.7 10.8c-12.4 29.2-38 45.2-72 45.2zM216.1 903.3h-11.9c-43 0-78.2-35.2-78.2-78.2V476.6c0-43 35.2-78.2 78.2-78.2h11.9c43 0 78.2 35.2 78.2 78.2V825c0.1 43.1-35.1 78.3-78.2 78.3z" fill="#000000" p-id="34839"></path> </svg> <span style="color:#474545;font-size:14px">${extraContent}‰∫∫Â∑≤Ëµû</span> </div> <div class="user_leave_message_list"></div> <div style="display:flex;align-items:center;gap:3px;margin-top:10px"> <div class="user_avatar" style="width:30px;min-width:30px;height:30px;border-radius:50%"></div> <div style="display:flex;align-items:center;width:100%;background-color:#f5f5f5;padding-right:5px;margin-left:5px"> <input type="text" placeholder="ËØ¥ÁÇπ‰ªÄ‰πàÂêß..." style="height:30px;width:100%;margin-left:5px;border-radius:4px;background-color:#f5f5f5;padding:6px;border:none"/> <svg viewBox="0 0 1024 1024" width="20" height="20" class="moment_comment"> <path d="M871.04 89.770667L120.064 380.16a51.2 51.2 0 0 0-1.792 94.762667l303.36 130.56 131.072 303.957333a51.2 51.2 0 0 0 94.805333-1.877333l289.792-751.573334a51.2 51.2 0 0 0-66.261333-66.133333z m-41.130667 107.392l-231.978666 601.642666-97.962667-227.114666-3.584-7.338667a85.333333 85.333333 0 0 0-41.045333-37.248l-226.56-97.536 601.173333-232.405333z" fill="#a1a1a1" p-id="18561"></path> </svg> </div> </div> <div style="width:110%;height:8px;background-color:#e9e9e9;margin-left:-7px;margin-top:10px;margin-bottom:10px"> </div>';
            // Exports
            /* harmony default export */ var moment_page = moment_page_code; // ./src/ÁïåÈù¢/discord/discord_card.html
            // Module
            var discord_card_code =
                '<div class="discord-card" data-id="${id}"> <div class="discord-card-tags">${tag}</div> <span class="discord-card-author">${name}</span> <span style="color:#67686a;font-size:15px;margin-left:8px">${time}</span> <div class="discord-card-title">${cardtilte}</div> <div class="discord-card-content">${content}</div> <div class="discord-card-fakeimg">${img}</div> <div class="discord-card-interact"> <svg aria-hidden="true" role="img" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24"> <path fill="#4d5059" d="M12 22a10 10 0 1 0-8.45-4.64c.13.19.11.44-.04.61l-2.06 2.37A1 1 0 0 0 2.2 22H12Z" class=""> </path> </svg> <div style="color:#333237;margin-left:5px">${messages}</div> <div class="discord-card-interact-icon moment-like-button" data-moment-id="${id}" data-liked="${likedByUser}"> <div class="like-emoji">üëç</div> <div class="moment-like-count">${likeCount}</div> </div> </div> </div>';
            // Exports
            /* harmony default export */ var discord_discord_card =
                discord_card_code; // ./src/ÁïåÈù¢/discord/discord_thread.html
            // Module
            var discord_thread_code =
                '<div class="discord-thread" data-id="${id}"> <div class="discord-thread-top"> <svg class="discord-thread-top-return" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3402" width="28" height="28"> <path d="M440.070244 831.562927c11.813463 0 23.601951-4.49561 32.593171-13.486829a45.980098 45.980098 0 0 0 0-65.161366l-198.730927-198.730927 589.674146 0.499512c24.001561 0 43.507512-19.431024 43.40761-43.40761 0-24.101463-19.480976-43.63239-43.507512-43.63239l-592.221659-0.574439 201.378342-201.378341a45.980098 45.980098 0 0 0 0-65.161366 45.980098 45.980098 0 0 0-65.186342 0L131.29678 476.734439a45.955122 45.955122 0 0 0-13.53678 33.16761v0.574439c0 13.361951 5.994146 25.300293 15.409951 33.292488l274.307122 274.332097c8.99122 8.966244 20.804683 13.461854 32.593171 13.461854z" p-id="3403" fill="#505058"></path> </svg> <svg viewBox="0 0 18.33 18.33" style="width:20px;height:20px;margin-left:15px"> <g> <path style="fill:#323338;stroke-width:0" d="m9.17,18.33H.83c-.31,0-.59-.17-.74-.45-.14-.27-.12-.6.05-.86l1.66-2.41C.64,13.04,0,11.13,0,9.17,0,4.11,4.11,0,9.17,0s9.17,4.11,9.17,9.17-4.11,9.17-9.17,9.17Z"/> </g> </svg> <div style="display:grid;grid-template-columns:1fr 18px;align-items:center"> <div class="discord-thread-title">${threadtilte}</div> <svg width="18" height="18" fill="none" viewBox="0 0 24 24"> <path fill="currentColor" d="M9.3 5.3a1 1 0 0 0 0 1.4l5.29 5.3-5.3 5.3a1 1 0 1 0 1.42 1.4l6-6a1 1 0 0 0 0-1.4l-6-6a1 1 0 0 0-1.42 0Z" class=""></path> </svg> <div style="color:#5e5f63;margin-top:-3px">Á±ªËÑëŒüŒîŒ•Œ£Œ£ŒïŒôŒë</div> </div> </div> <div style="width:100%;height:1px;background-color:#d7d7d7"></div> <div style="width:100%;height:1px;background-color:#e3e3e3"></div> <div class="discord-scroll-container"> <div class="discord-thread-content"> <div style="background-color:#f2f3f5;display:flex;align-items:center;justify-content:center;border-radius:50%;width:64px;height:64px;margin-top:20px;margin-left:5px"> <svg viewBox="0 0 1024 1024" width="32" height="32"> <path fill="#050608" d="M524.531863 943.841235c-69.997795 0-137.060198-15.354355-199.606615-45.837266-15.354355-6.548181-91.674531-2.032194-162.575524 9.709372-11.515766 2.032194-23.483131-2.257993-31.160308-11.289967-7.677178-8.806174-10.16097-21.225138-6.548181-32.515105 15.805954-49.675854 26.192723-104.770893 22.805733-120.125248a452.434135 452.434135 0 0 1-78.35237-255.379052c0-251.088864 204.348401-455.437266 455.437265-455.437266S979.969129 237.315105 979.969129 488.403969 775.620728 943.841235 524.531863 943.841235z m-235.28291-116.512459c26.870121 0 50.804851 2.483793 65.481808 9.709372a382.955678 382.955678 0 0 0 169.801102 39.063285c213.831974 0 387.697464-173.865491 387.697464-387.697464S738.363837 100.706505 524.531863 100.706505 136.834399 274.571996 136.834399 488.403969c0 78.57817 23.483131 154.220948 67.739802 218.799559 17.16075 25.063727 11.289967 76.094377-0.903198 125.996031 27.095921-3.161191 58.03043-5.870783 85.57795-5.870783z m-140.672988-81.73936z"> </path> </svg> </div> <div class="discord-thread-content-title">${threadtilte}</div> <div class="discord-thread-content-tags"> ${tag} </div> <div class="discord-thread-content-original"> <div class="discord-thread-content-original-author-head head${isuser}" data-name="${name}"></div> <div> <div style="display:flex;align-items:center"> <div class="discord-thread-content-original-author-name discord-name-creator">${name}</div> </div> <div class="discord-thread-content-original-content">${content}</div> <div class="discord-card-fakeimg">${img}</div> </div> </div> </div> <div style="width:100%;height:1px;background-color:#d7d7d7"></div> <div style="width:100%;height:1px;background-color:#e3e3e3"></div> <div class="discord-thread-content"> <div style="width:100%;display:flex;align-items:center;margin-top:10px"> <div class="discord-thread-content-likes"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 36" width="24" heigth="24"> <path fill="#FFDB5E" d="M34.956 17.916c0-.503-.12-.975-.321-1.404-1.341-4.326-7.619-4.01-16.549-4.221-1.493-.035-.639-1.798-.115-5.668.341-2.517-1.282-6.382-4.01-6.382-4.498 0-.171 3.548-4.148 12.322-2.125 4.688-6.875 2.062-6.875 6.771v10.719c0 1.833.18 3.595 2.758 3.885C8.195 34.219 7.633 36 11.238 36h18.044c1.838 0 3.333-1.496 3.333-3.334 0-.762-.267-1.456-.698-2.018 1.02-.571 1.72-1.649 1.72-2.899 0-.76-.266-1.454-.696-2.015 1.023-.57 1.725-1.649 1.725-2.901 0-.909-.368-1.733-.961-2.336.757-.611 1.251-1.535 1.251-2.581z"/> <path fill="#EE9547" d="M23.02 21.249h8.604c1.17 0 2.268-.626 2.866-1.633.246-.415.109-.952-.307-1.199-.415-.247-.952-.108-1.199.307-.283.479-.806.775-1.361.775h-8.81c-.873 0-1.583-.71-1.583-1.583s.71-1.583 1.583-1.583H28.7c.483 0 .875-.392.875-.875s-.392-.875-.875-.875h-5.888c-1.838 0-3.333 1.495-3.333 3.333 0 1.025.475 1.932 1.205 2.544-.615.605-.998 1.445-.998 2.373 0 1.028.478 1.938 1.212 2.549-.611.604-.99 1.441-.99 2.367 0 1.12.559 2.108 1.409 2.713-.524.589-.852 1.356-.852 2.204 0 1.838 1.495 3.333 3.333 3.333h5.484c1.17 0 2.269-.625 2.867-1.632.247-.415.11-.952-.305-1.199-.416-.245-.953-.11-1.199.305-.285.479-.808.776-1.363.776h-5.484c-.873 0-1.583-.71-1.583-1.583s.71-1.583 1.583-1.583h6.506c1.17 0 2.27-.626 2.867-1.633.247-.416.11-.953-.305-1.199-.419-.251-.954-.11-1.199.305-.289.487-.799.777-1.363.777h-7.063c-.873 0-1.583-.711-1.583-1.584s.71-1.583 1.583-1.583h8.091c1.17 0 2.269-.625 2.867-1.632.247-.415.11-.952-.305-1.199-.417-.246-.953-.11-1.199.305-.289.486-.799.776-1.363.776H23.02c-.873 0-1.583-.71-1.583-1.583s.709-1.584 1.583-1.584z"/> </svg> <div style="color:#5f606a">${likes}</div> </div> <div class="discord-thread-content-reaction" style="width:34px"> <svg class="icon_f8896c largeIcon_f8896c" aria-hidden="true" role="img" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24"> <path fill="#5f606a" fill-rule="evenodd" d="M12 23a11 11 0 1 0 0-22 11 11 0 0 0 0 22ZM6.5 13a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Zm11 0a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Zm-9.8 1.17a1 1 0 0 1 1.39.27 3.5 3.5 0 0 0 5.82 0 1 1 0 0 1 1.66 1.12 5.5 5.5 0 0 1-9.14 0 1 1 0 0 1 .27-1.4Z" clip-rule="evenodd" class=""></path> </svg> </div> <div class="discord-thread-content-reaction" style="margin-left:auto"> <svg aria-hidden="true" width="18" height="18" fill="none" viewBox="0 0 24 24"> <path fill="#5f606a" d="M9.7 2.89c.18-.07.32-.24.37-.43a2 2 0 0 1 3.86 0c.05.2.19.36.38.43A7 7 0 0 1 19 9.5v2.09c0 .12.05.24.13.33l1.1 1.22a3 3 0 0 1 .77 2.01v.28c0 .67-.34 1.29-.95 1.56-1.31.6-4 1.51-8.05 1.51-4.05 0-6.74-.91-8.05-1.5-.61-.28-.95-.9-.95-1.57v-.28a3 3 0 0 1 .77-2l1.1-1.23a.5.5 0 0 0 .13-.33V9.5a7 7 0 0 1 4.7-6.61ZM9.18 19.84A.16.16 0 0 0 9 20a3 3 0 1 0 6 0c0-.1-.09-.17-.18-.16a24.86 24.86 0 0 1-5.64 0Z" class=""></path> </svg> <div style="color:#5f606a;margin-right:1px">ÂÖ≥Ê≥®</div> </div> <div class="discord-thread-content-reaction" style="width:34px"> <svg aria-hidden="true" role="img" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24"> <path fill="#5f606a" d="M16.32 14.72a1 1 0 0 1 0-1.41l2.51-2.51a3.98 3.98 0 0 0-5.62-5.63l-2.52 2.51a1 1 0 0 1-1.41-1.41l2.52-2.52a5.98 5.98 0 0 1 8.45 8.46l-2.52 2.51a1 1 0 0 1-1.41 0ZM7.68 9.29a1 1 0 0 1 0 1.41l-2.52 2.51a3.98 3.98 0 1 0 5.63 5.63l2.51-2.52a1 1 0 0 1 1.42 1.42l-2.52 2.51a5.98 5.98 0 0 1-8.45-8.45l2.51-2.51a1 1 0 0 1 1.42 0Z" class=""></path> <path fill="#5f606a" d="M14.7 10.7a1 1 0 0 0-1.4-1.4l-4 4a1 1 0 1 0 1.4 1.4l4-4Z" class=""> </path> </svg> </div> </div> </div> <div style="width:100%;height:3px;background-color:#f2f3f5;margin-top:10px"></div> <div style="width:100%;height:2px;background-color:#f0f4f7"></div> <div style="width:100%;height:3px;background-color:#f2f3f5"></div> <div class="discord-thread-comment-list"> </div> </div> <div class="discord-thread-input"> <div class="discord-thread-input-button"> <div style="display:flex;align-items:center;gap:5px;height:30px"> <div class="discord-thread-input-svgbackground"> <svg t="1744279170454" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2274" width="32" height="32"> <path d="M836 476H548V188c0-19.8-16.2-36-36-36s-36 16.2-36 36v288H188c-19.8 0-36 16.2-36 36s16.2 36 36 36h288v288c0 19.8 16.2 36 36 36s36-16.2 36-36V548h288c19.8 0 36-16.2 36-36s-16.2-36-36-36z" fill="#333333" p-id="2275"></path> </svg> </div> <div class="discord-thread-input-svgbackground"> <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 96 96" width="28" height="28" preserveAspectRatio="xMidYMid meet" style="transform:translate3d(0,0,0);content-visibility:visible"> <defs> <clipPath id="__lottie_element_2133"> <rect width="96" height="96" x="0" y="0"></rect> </clipPath> <clipPath id="__lottie_element_2135"> <path d="M0,0 L96,0 L96,96 L0,96z"></path> </clipPath> </defs> <g clip-path="url(#__lottie_element_2133)"> <g clip-path="url(#__lottie_element_2135)" transform="matrix(2.700000047683716,0,0,2.700000047683716,-79.60000610351562,-81.35110473632812)" opacity="1" style="display:block"> <g transform="matrix(0.9999997019767761,0,0,0.9999997019767761,32.022003173828125,32.64699935913086)" opacity="1" style="display:block"> <g opacity="1" transform="matrix(1,0,0,1,7.179999828338623,7.181000232696533)"> <path fill="#333333" fill-opacity="1" d=" M-6.554999828338623,1.6410000324249268 C-6.929999828338623,3.0420000553131104 -6.099999904632568,4.480999946594238 -4.698999881744385,4.85699987411499 C-4.698999881744385,4.85699987411499 1.6410000324249268,6.554999828338623 1.6410000324249268,6.554999828338623 C3.0409998893737793,6.931000232696533 4.48199987411499,6.098999977111816 4.85699987411499,4.698999881744385 C4.85699987411499,4.698999881744385 6.554999828338623,-1.6410000324249268 6.554999828338623,-1.6410000324249268 C6.929999828338623,-3.0420000553131104 6.098999977111816,-4.480999946594238 4.698999881744385,-4.85699987411499 C4.698999881744385,-4.85699987411499 -1.6410000324249268,-6.556000232696533 -1.6410000324249268,-6.556000232696533 C-3.0409998893737793,-6.931000232696533 -4.48199987411499,-6.099999904632568 -4.85699987411499,-4.698999881744385 C-4.85699987411499,-4.698999881744385 -6.554999828338623,1.6410000324249268 -6.554999828338623,1.6410000324249268z"> </path> </g> </g> <g transform="matrix(1,0,0,1,47.44300079345703,32.419002532958984)" opacity="1" style="display:block"> <g opacity="1" transform="matrix(1,0,0,1,7.802000045776367,7.021999835968018)"> <path fill="#333333" fill-opacity="1" d=" M-6.478000164031982,2.4040000438690186 C-7.552000045776367,4.372000217437744 -6.126999855041504,6.771999835968018 -3.884999990463257,6.771999835968018 C-3.884999990463257,6.771999835968018 3.885999917984009,6.771999835968018 3.885999917984009,6.771999835968018 C6.127999782562256,6.771999835968018 7.552000045776367,4.372000217437744 6.479000091552734,2.4040000438690186 C6.479000091552734,2.4040000438690186 2.5929999351501465,-4.718999862670898 2.5929999351501465,-4.718999862670898 C1.4739999771118164,-6.771999835968018 -1.4730000495910645,-6.771999835968018 -2.5929999351501465,-4.718999862670898 C-2.5929999351501465,-4.718999862670898 -6.478000164031982,2.4040000438690186 -6.478000164031982,2.4040000438690186z"> </path> </g> </g> <g transform="matrix(1,0,0,1,32.119998931884766,49.04499816894531)" opacity="1" style="display:block"> <g opacity="1" transform="matrix(1,0,0,1,7.081999778747559,7.046999931335449)"> <path fill="#333333" fill-opacity="1" d=" M-0.9409999847412109,-6.26800012588501 C-0.42100000381469727,-6.796999931335449 0.41999998688697815,-6.796999931335449 0.9409999847412109,-6.26800012588501 C0.9409999847412109,-6.26800012588501 2.056999921798706,-5.132999897003174 2.056999921798706,-5.132999897003174 C2.2699999809265137,-4.916999816894531 2.5480000972747803,-4.78000020980835 2.8459999561309814,-4.744999885559082 C2.8459999561309814,-4.744999885559082 4.4120001792907715,-4.561999797821045 4.4120001792907715,-4.561999797821045 C5.140999794006348,-4.4770002365112305 5.665999889373779,-3.805999994277954 5.585000038146973,-3.061000108718872 C5.585000038146973,-3.061000108718872 5.410999774932861,-1.4630000591278076 5.410999774932861,-1.4630000591278076 C5.377999782562256,-1.1579999923706055 5.447000026702881,-0.8510000109672546 5.605999946594238,-0.5910000205039978 C5.605999946594238,-0.5910000205039978 6.441999912261963,0.7720000147819519 6.441999912261963,0.7720000147819519 C6.831999778747559,1.406999945640564 6.644999980926514,2.24399995803833 6.0229997634887695,2.6440000534057617 C6.0229997634887695,2.6440000534057617 4.690999984741211,3.502000093460083 4.690999984741211,3.502000093460083 C4.436999797821045,3.6649999618530273 4.24399995803833,3.9119999408721924 4.144000053405762,4.201000213623047 C4.144000053405762,4.201000213623047 3.621000051498413,5.7179999351501465 3.621000051498413,5.7179999351501465 C3.378000020980835,6.423999786376953 2.619999885559082,6.796999931335449 1.9259999990463257,6.551000118255615 C1.9259999990463257,6.551000118255615 0.43799999356269836,6.021999835968018 0.43799999356269836,6.021999835968018 C0.15399999916553497,5.921999931335449 -0.1550000011920929,5.921999931335449 -0.43799999356269836,6.021999835968018 C-0.43799999356269836,6.021999835968018 -1.9270000457763672,6.551000118255615 -1.9270000457763672,6.551000118255615 C-2.619999885559082,6.796999931335449 -3.378000020980835,6.423999786376953 -3.621999979019165,5.7179999351501465 C-3.621999979019165,5.7179999351501465 -4.144999980926514,4.201000213623047 -4.144999980926514,4.201000213623047 C-4.24399995803833,3.9119999408721924 -4.436999797821045,3.6649999618530273 -4.690999984741211,3.502000093460083 C-4.690999984741211,3.502000093460083 -6.02400016784668,2.6440000534057617 -6.02400016784668,2.6440000534057617 C-6.644999980926514,2.24399995803833 -6.831999778747559,1.406999945640564 -6.442999839782715,0.7720000147819519 C-6.442999839782715,0.7720000147819519 -5.605999946594238,-0.5910000205039978 -5.605999946594238,-0.5910000205039978 C-5.447000026702881,-0.8510000109672546 -5.377999782562256,-1.1579999923706055 -5.4120001792907715,-1.4630000591278076 C-5.4120001792907715,-1.4630000591278076 -5.585000038146973,-3.061000108718872 -5.585000038146973,-3.061000108718872 C-5.665999889373779,-3.805999994277954 -5.142000198364258,-4.4770002365112305 -4.4120001792907715,-4.561999797821045 C-4.4120001792907715,-4.561999797821045 -2.8469998836517334,-4.744999885559082 -2.8469998836517334,-4.744999885559082 C-2.5480000972747803,-4.78000020980835 -2.2699999809265137,-4.916999816894531 -2.056999921798706,-5.132999897003174 C-2.056999921798706,-5.132999897003174 -0.9409999847412109,-6.26800012588501 -0.9409999847412109,-6.26800012588501z"> </path> </g> </g> <g transform="matrix(-0.9999998211860657,0,0,-0.9999998211860657,62.69399642944336,63.31999969482422)" opacity="1" style="display:block"> <g opacity="1" transform="matrix(1,0,0,1,7.247000217437744,7.247000217437744)"> <path fill="#333333" fill-opacity="1" d=" M1.5130000114440918,-5.5920000076293945 C0.9929999709129333,-6.997000217437744 -0.9940000176429749,-6.997000217437744 -1.5140000581741333,-5.5920000076293945 C-1.5140000581741333,-5.5920000076293945 -2.190999984741211,-3.760999917984009 -2.190999984741211,-3.760999917984009 C-2.4600000381469727,-3.0339999198913574 -3.0339999198913574,-2.4600000381469727 -3.76200008392334,-2.190999984741211 C-3.76200008392334,-2.190999984741211 -5.5920000076293945,-1.5130000114440918 -5.5920000076293945,-1.5130000114440918 C-6.997000217437744,-0.9940000176429749 -6.997000217437744,0.9929999709129333 -5.5920000076293945,1.5130000114440918 C-5.5920000076293945,1.5130000114440918 -3.76200008392334,2.190999984741211 -3.76200008392334,2.190999984741211 C-3.0339999198913574,2.4600000381469727 -2.4600000381469727,3.0339999198913574 -2.190999984741211,3.760999917984009 C-2.190999984741211,3.760999917984009 -1.5140000581741333,5.5920000076293945 -1.5140000581741333,5.5920000076293945 C-0.9940000176429749,6.997000217437744 0.9929999709129333,6.997000217437744 1.5130000114440918,5.5920000076293945 C1.5130000114440918,5.5920000076293945 2.190000057220459,3.760999917984009 2.190000057220459,3.760999917984009 C2.4600000381469727,3.0339999198913574 3.0329999923706055,2.4600000381469727 3.760999917984009,2.190999984741211 C3.760999917984009,2.190999984741211 5.5920000076293945,1.5130000114440918 5.5920000076293945,1.5130000114440918 C6.997000217437744,0.9929999709129333 6.997000217437744,-0.9940000176429749 5.5920000076293945,-1.5130000114440918 C5.5920000076293945,-1.5130000114440918 3.760999917984009,-2.190999984741211 3.760999917984009,-2.190999984741211 C3.0329999923706055,-2.4600000381469727 2.4600000381469727,-3.0339999198913574 2.190000057220459,-3.760999917984009 C2.190000057220459,-3.760999917984009 1.5130000114440918,-5.5920000076293945 1.5130000114440918,-5.5920000076293945z"> </path> </g> </g> </g> </g> </svg> </div> <div class="discord-thread-input-svgbackground"> <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="30" height="30" preserveAspectRatio="xMidYMid meet" style="transform:translate3d(0,0,0);content-visibility:visible"> <defs> <clipPath id="__lottie_element_2044"> <rect width="24" height="24" x="0" y="0"></rect> </clipPath> <clipPath id="__lottie_element_2046"> <path d="M0,0 L600,0 L600,600 L0,600z"></path> </clipPath> </defs> <g clip-path="url(#__lottie_element_2044)"> <g clip-path="url(#__lottie_element_2046)" transform="matrix(0.03999999910593033,0,0,0.03999999910593033,0,0)" opacity="1" style="display:block"> <g transform="matrix(25,0,0,25,300,300)" opacity="1" style="display:block"> <g opacity="1" transform="matrix(1,0,0,1,0,0)"> <path fill="#333333" fill-opacity="1" d=" M-7,10 C-8.104999542236328,10 -9,9.104999542236328 -9,8 C-9,8 -9,2.5 -9,2.5 C-9,2.2239999771118164 -8.776000022888184,2 -8.5,2 C-8.5,2 -1.5,2 -1.5,2 C-1.2239999771118164,2 -1,2.2239999771118164 -1,2.5 C-1,2.5 -1,9.5 -1,9.5 C-1,9.776000022888184 -1.2239999771118164,10 -1.5,10 C-1.5,10 -7,10 -7,10z M1,9.5 C1,9.776000022888184 1.2239999771118164,10 1.5,10 C1.5,10 7,10 7,10 C8.104999542236328,10 9,9.104999542236328 9,8 C9,8 9,2.5 9,2.5 C9,2.2239999771118164 8.776000022888184,2 8.5,2 C8.5,2 1.5,2 1.5,2 C1.2239999771118164,2 1,2.2239999771118164 1,2.5 C1,2.5 1,9.5 1,9.5z"> </path> </g> </g> <g transform="matrix(25,0,0,25,300,300)" opacity="1" style="display:block"> <g opacity="1" transform="matrix(1,0,0,1,0,0)"> <path fill="#333333" fill-opacity="1" d=" M-10,-2 C-10,-3.1050000190734863 -9.104999542236328,-4 -8,-4 C-8,-4 8,-4 8,-4 C9.104999542236328,-4 10,-3.1050000190734863 10,-2 C10,-2 10,-0.5 10,-0.5 C10,-0.2240000069141388 9.776000022888184,0 9.5,0 C9.5,0 -9.5,0 -9.5,0 C-9.776000022888184,0 -10,-0.2240000069141388 -10,-0.5 C-10,-0.5 -10,-2 -10,-2z"> </path> </g> </g> <g transform="matrix(25,0,0,25,300,300)" opacity="1" style="display:block"> <path stroke-linecap="butt" stroke-linejoin="round" fill-opacity="0" stroke="#333333" stroke-opacity="1" stroke-width="2" d=" M7,-6 C7,-7.6570000648498535 5.6570000648498535,-9 4,-9 C4,-9 3.9110000133514404,-9 3.9110000133514404,-9 C2.49399995803833,-9 1.2589999437332153,-8.03600025177002 0.9150000214576721,-6.660999774932861 C0.9150000214576721,-6.660999774932861 0,-3 0,-3 C0,-3 4,-3 4,-3 C5.6570000648498535,-3 7,-4.3429999351501465 7,-6 C7,-6 7,-6 7,-6z"> </path> <g opacity="1" transform="matrix(1,0,0,1,0,0)"></g> </g> <g transform="matrix(25,0,0,25,300,300)" opacity="1" style="display:block"> <path stroke-linecap="butt" stroke-linejoin="round" fill-opacity="0" stroke="#333333" stroke-opacity="1" stroke-width="2" d=" M-7,-6 C-7,-7.6570000648498535 -5.6570000648498535,-9 -4,-9 C-4,-9 -3.9110000133514404,-9 -3.9110000133514404,-9 C-2.49399995803833,-9 -1.2589999437332153,-8.03600025177002 -0.9150000214576721,-6.660999774932861 C-0.9150000214576721,-6.660999774932861 0,-3 0,-3 C0,-3 -4,-3 -4,-3 C-5.6570000648498535,-3 -7,-4.3429999351501465 -7,-6 C-7,-6 -7,-6 -7,-6z"> </path> <g opacity="1" transform="matrix(1,0,0,1,0,0)"></g> </g> </g> </g> </svg> </div> </div> </div> <div class="discord-thread-input-focus-button" style="display:none"> <svg width="24" height="24" fill="none" viewBox="0 0 24 24" style="margin-top:2px"> <path fill="#5f606a" d="M9.3 5.3a1 1 0 0 0 0 1.4l5.29 5.3-5.3 5.3a1 1 0 1 0 1.42 1.4l6-6a1 1 0 0 0 0-1.4l-6-6a1 1 0 0 0-1.42 0Z" class=""></path> </svg> </div> <div style="display:flex;align-items:center;flex:1;min-width:50px;background-color:#ececec;border-radius:24px;height:35px"> <input class="discord-thread-input-userinput" type="text" placeholder=\'Âú®"${threadtilte}"‰∏≠ÂèëÈÄÅ‰∏ÄÂàôÊ∂àÊÅØ\'> <svg style="margin-right:8px" aria-hidden="true" role="img" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24"> <path fill="#5f606a" fill-rule="evenodd" d="M12 23a11 11 0 1 0 0-22 11 11 0 0 0 0 22ZM6.5 13a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Zm11 0a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Zm-9.8 1.17a1 1 0 0 1 1.39.27 3.5 3.5 0 0 0 5.82 0 1 1 0 0 1 1.66 1.12 5.5 5.5 0 0 1-9.14 0 1 1 0 0 1 .27-1.4Z" clip-rule="evenodd" class=""></path> </svg> </div> <div class="discord-thread-input-svgbackground"> <svg viewBox="0 0 1024 1024" width="32" height="32" class="discord-thread-input-button"> <path d="M511.752 70.5c-86.605 0-156.835 69.734-156.835 155.747l0 273.812c0 86.013 70.23 155.748 156.835 155.748 86.602 0 156.832-69.735 156.832-155.748L668.584 226.247C668.584 140.234 598.354 70.5 511.752 70.5L511.752 70.5 511.752 70.5zM243.854 461.102c-18.051 0-32.649 14.496-32.649 32.451 0 2.269 0.197 4.436 0.689 6.506l-0.689 0c0 151.605 113.922 276.578 261.386 295.713l0 80.687-52.275 0c-21.702 0-39.257 17.458-39.257 38.964 0 21.499 17.555 38.957 39.257 38.957l182.969 0c21.701 0 39.256-17.458 39.256-38.957 0-21.506-17.555-38.964-39.256-38.964L551.01 876.459l0-80.687c143.119-18.543 254.383-137.002 260.691-282.688 0.396-2.072 0.695-4.243 0.695-6.512 0-0.79-0.197-1.479-0.197-2.167 0-1.483 0.197-2.86 0.197-4.345l-0.695 0c-3.058-14.795-16.172-25.94-32.057-25.94-15.782 0-28.999 11.145-32.057 25.94l-0.688 0c0 129.019-105.344 233.572-235.249 233.572-129.903 0-235.249-104.554-235.249-233.572l-0.689 0c0.396-2.07 0.689-4.237 0.689-6.506C276.503 475.598 261.906 461.102 243.854 461.102L243.854 461.102 243.854 461.102zM243.854 461.102" fill="#333333" p-id="3351"></path> </svg> <svg class="discord-thread-input-focus-button discord_thread-input-sendbutton" style="width:100%;height:100%;display:none" id="_ÂõæÂ±Ç_2" data-name="ÂõæÂ±Ç 2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 161.74 161.74"> <defs> <style>.cls-1{fill:#5865f1}.cls-1,.cls-2{stroke-width:0}.cls-2{fill:#fff}</style> </defs> <g id="_ÂõæÂ±Ç_1-2" data-name="ÂõæÂ±Ç 1"> <circle class="cls-1" cx="80.87" cy="80.87" r="80.87"/> </g> <g id="_ÂõæÂ±Ç_2-2" data-name="ÂõæÂ±Ç 2"> <path class="cls-2" d="m127.88,79.87c0-2.3-1.22-4.6-3.66-5.73L52.7,39.96c-3.5-1.84-7.33,1.81-5.67,5.39l10.16,25.41c.37.96,1.2,1.68,2.21,1.91l30.68,5.54c.93.17,1.39.92,1.39,1.67s-.46,1.5-1.39,1.67l-30.68,5.54c-1.01.23-1.84.94-2.21,1.91l-10.16,25.41c-1.67,3.58,2.17,7.23,5.67,5.39l71.53-34.18c2.44-1.13,3.66-3.43,3.66-5.73Z"/> </g> </svg> </div> </div> </div>';
            // Exports
            /* harmony default export */ var discord_discord_thread =
                discord_thread_code; // ./src/ÁïåÈù¢/discord/discord_thread_comment.html
            // Module
            var discord_thread_comment_code =
                '<div class="discord-thread-comment"> <div class="discord-thread-comment-head head${isuser}" data-name="${name}"></div> <div> <div class="discord-thread-comment-name${creator}">${name}</div> <div class="discord-thread-comment-content">${content}</div> </div> </div>';
            // Exports
            /* harmony default export */ var discord_discord_thread_comment =
                discord_thread_comment_code; // ./src/ÁïåÈù¢/worldbook/1-Ê†ºÂºèÂºÄÂ§¥.txt?raw
            var _1_raw_namespaceObject =
                "<Á∫ø‰∏äÊ†ºÂºè>\r\nÂΩìÁî®Êà∑Ë¶ÅÊ±ÇÊü•ÁúãÂÜÖÂÆπÊó∂,‰ªÖËæìÂá∫ÂØπÂ∫îÊ†ºÂºè,Á¶ÅÊ≠¢ËæìÂá∫ÂâßÊÉÖÊóÅÁôΩ\r\n‰ª•‰∏ãÊòØÂêÑÊ†ºÂºèÂÖ∑‰Ωì‰ªãÁªç"; // ./src/ÁïåÈù¢/worldbook/2-QQËÅäÂ§©.txt?raw
            var _2_QQ_raw_namespaceObject =
                "<QQËÅäÂ§©Ê†ºÂºè‰ªãÁªç>\r\nÊ†ºÂºèÁ§∫‰æãÂ¶Ç:\r\nmsg_start\r\n<{{user}}ÂíåxxxÁöÑÁßÅËÅä>\r\nÂèëË®Ä‰∫∫--ÂÜÖÂÆπ--HH:MM\r\nÂèëË®Ä‰∫∫--ÁâπÊÆäÊ∂àÊÅØÁ±ªÂûã--HH:MM\r\n</{{user}}ÂíåxxxÁöÑÁßÅËÅä>\r\n\r\n<Áæ§ËÅä:Áæ§ÂêçÂ≠ó>\r\n<ÊàêÂëò>ÊàêÂëòA,ÊàêÂëòB</ÊàêÂëò>\r\n<ËÅäÂ§©ÂÜÖÂÆπ>\r\nÂèëË®Ä‰∫∫--ÂÜÖÂÆπ--HH:MM\r\nÂèëË®Ä‰∫∫--ÁâπÊÆäÊ∂àÊÅØÁ±ªÂûã--HH:MM\r\n</ËÅäÂ§©ÂÜÖÂÆπ>\r\n</Áæ§ËÅä:Áæ§ÂêçÂ≠ó>\r\n\r\nmsg_end\r\n\r\nÁâπÊÆäÊ∂àÊÅØÁ±ªÂûã:\r\n\r\n„ÄêË°®ÊÉÖÂåÖÁõ∏ÂÖ≥„Äë\r\nËßíËâ≤‰ºöÊ†πÊçÆÂΩìÂâçÊÉÖÁª™ÂíåÂØπËØùÂÜÖÂÆπ‰ΩøÁî®ÈÄÇÂΩìÁöÑË°®ÊÉÖÂåÖÔºö\r\n- Ë°®ÊÉÖÂåÖÁöÑÈÄâÊã©Â∫îÂΩìÁ¨¶ÂêàËßíËâ≤ÂΩìÂâçÂøÉÁêÜÂíåËßíËâ≤ÊÄßÊ†º\r\n- Ë°®ÊÉÖÂåÖ‰ΩøÁî®È¢ëÁéáÂ∫îÈÄÇ‰∏≠ÔºåÂπ≥ÂùáÊØè3-5Êù°Ê∂àÊÅØÂèØ‰ΩøÁî®‰∏ÄÊ¨°\r\n- ËæìÂá∫Ê†ºÂºè‰∏∫[bqb-Ë°®ÊÉÖÂåÖÂÜÖÂÆπ]Ôºà‰ªÖ‰ΩøÁî®ÂàóË°®‰∏≠Â≠òÂú®ÁöÑË°®ÊÉÖÂåÖÔºå‰∏çÂèØËá™ÂàõÊàñÁØ°ÊîπÔºâ\r\n- Ë°®ÊÉÖÂåÖ‰Ωú‰∏∫Áã¨Á´ãÁöÑ‰∏ÄÊù°Ê∂àÊÅØÔºå‰∏ÄÊù°Ê∂àÊÅØÂè™ËÉΩÂåÖÂê´‰∏Ä‰∏™Ë°®ÊÉÖÂåÖ\r\n- Á§∫‰æã:Ë∑Ø‰∫∫a--[bqb-Êë∏Â∞èÁå´‰∏ãÂ∑¥]--12:00\r\n<Ë°®ÊÉÖÂåÖÂàóË°®>\r\n\r\n</Ë°®ÊÉÖÂåÖÂàóË°®>\r\n\r\n„ÄêËΩ¨Ë¥¶Ê∂àÊÅØÁõ∏ÂÖ≥„Äë\r\n- Ê†ºÂºèÔºö[zz-ÈáëÈ¢ùÂÖÉ]\r\n- ÂøÖÈ°ªÁã¨Á´ãÊàêË°åÔºåÁ§∫‰æãÔºöË∑Ø‰∫∫a--[zz-520ÂÖÉ]--12:00\r\n- ÂèØÁî®ËåÉÂõ¥Ôºö‰ªÖÁßÅËÅä\r\n- ‰∏çÂèØÁî®ËåÉÂõ¥ÔºöÁæ§ËÅäÔºåQQÁ©∫Èó¥\r\n\r\n„ÄêËØ≠Èü≥Ê∂àÊÅØÁõ∏ÂÖ≥„Äë\r\n- Ê†ºÂºèÔºö[yy-ËØ≠Èü≥ÂÜÖÂÆπ]\r\n- ÂøÖÈ°ªÁã¨Á´ãÊàêË°åÔºåÁ§∫‰æãÔºöË∑Ø‰∫∫a--[yy-ÊÉ≥‰Ω†‰∫Ü]--12:00\r\n- ÂèØÁî®ËåÉÂõ¥ÔºöÁßÅËÅäÔºåÁæ§ËÅä\r\n- ‰∏çÂèØÁî®ËåÉÂõ¥ÔºöQQÁ©∫Èó¥\r\n\r\n„ÄêÈü≥‰πêÂàÜ‰∫´Ê∂àÊÅØÁõ∏ÂÖ≥„Äë\r\n- Ê†ºÂºèÔºö[music-Ê≠åÂêç$Ê≠åÊâã]\r\n- ÂøÖÈ°ªÁã¨Á´ãÊàêË°åÔºåÁ§∫‰æãÔºöË∑Ø‰∫∫a--[music-ÂØåÂ£´Â±±‰∏ã$ÈôàÂ•ïËøÖ]--12:00\r\n- ÂèØÁî®ËåÉÂõ¥ÔºöÁßÅËÅäÔºåÁæ§ËÅä\r\n- ‰∏çÂèØÁî®ËåÉÂõ¥ÔºöQQÁ©∫Èó¥\r\n\r\n„ÄêÂõæÁâáÊàñËßÜÈ¢ëÊ∂àÊÅØÁõ∏ÂÖ≥„Äë\r\n- Ê†ºÂºèÔºö[img-ÂÜÖÂÆπ]\r\n- Á§∫‰æãÔºöË∑Ø‰∫∫a--[img-‰∏ÄÂº†Ëá™Êãç]--12:00\r\n- ÂèØÁî®ËåÉÂõ¥ÔºöÁßÅËÅäÔºåÁæ§ËÅäÔºåQQÁ©∫Èó¥\r\n- Âú®Áæ§ËÅäÂíåÁßÅËÅäÊó∂ÂøÖÈ°ªÁã¨Á´ãÊàêË°å\r\n- Âú®QQÁ©∫Èó¥Êó∂ÂâçÈù¢ÂèØÂ∏¶ÂÖ∂‰ªñÊñáÂ≠óÂÜÖÂÆπ\r\n- Ê≥®ÊÑèÔºöÂõæÁâáÂíåËßÜÈ¢ëÈÉΩÊòØ‰ΩøÁî®Ëøô‰∏™Ê†ºÂºè\r\n\r\nÊ†ºÂºèËß£Èáä:\r\nÁßÅËÅäÔºö{{user}}ÂíåÂØπÊñπÁöÑÁßÅËÅä,ËÅäÂ§©ÂÜÖÂÆπÂè™ÊúâÂèåÊñπÁü•ÈÅì,Ê†áÁ≠æÂêçÂ≠óÈ°∫Â∫è‰∏ÄÂÆöÊòØ{{user}}ÂíåxxxÁöÑÁßÅËÅä,ËÄå‰∏çÊòØxxxÂíå{{user}}ÁöÑÁßÅËÅä\r\nÁæ§ËÅäÔºöÂåÖÂê´Â§ö‰∏™ÊàêÂëòÁöÑÁæ§ÁªÑÂØπËØùÔºåÊâÄÊúâÁæ§ÊàêÂëòÂèØËßÅÊ∂àÊÅØ\r\nÁ°Æ‰øùÁßÅËÅäÂíåÁæ§ËÅäÁöÑÊ†áÁ≠æÈó≠Âêà\r\nÁâπÊÆäÊ∂àÊÅØÁ±ªÂûãÔºöËÅäÂ§©ËøáÁ®ã‰∏≠ÂèØ‰ΩøÁî®ÁöÑÊ∂àÊÅØÁ±ªÂûã,ÂâçÂêé‰æùÁÑ∂Ë¶ÅÂä†ÂèëË®Ä‰∫∫ÂíåÊó∂Èó¥\r\nÂèëË®ÄÂÜÖÂÆπ‰∏≠Â¶ÇÊûúÈúÄË¶ÅÊç¢Ë°å,‰ΩøÁî®<br>\r\nËã•Áæ§ËÅä‰∏≠ÈúÄË¶ÅÁîüÊàê‰∏Ä‰∫õÈöèÊú∫Ë∑Ø‰∫∫,Á¶ÅÊ≠¢‰ΩøÁî®Ë∑Ø‰∫∫A,ÂåøÂêçÁî®Êà∑Á≠âÊï∑Ë°çÁΩëÂêç\r\nÊ†ºÂºèÂâçÂêéÂ∏¶‰∏ämsg_startÂíåmsg_endÊ†áËØÜÁ¨¶\r\nËØ∑ÂãøÁîüÊàêÂ§ö‰∏™msg_start,msg_endÊ†áËØÜ\r\n\r\n</QQËÅäÂ§©Ê†ºÂºè‰ªãÁªç>"; // ./src/ÁïåÈù¢/worldbook/3-QQÁ©∫Èó¥.txt?raw
            var _3_QQ_raw_namespaceObject =
                '<QQÁ©∫Èó¥Ê†ºÂºè‰ªãÁªç>\r\n\r\n{{user}}ÂíåËßíËâ≤ÂêçÈÉΩ‰ºö‰ΩøÁî®ËÅäÂ§©ËΩØ‰ª∂QQ\r\nQQÁ©∫Èó¥ÊòØËÅäÂ§©ËΩØ‰ª∂QQ‰∏≠Â∏¶ÁöÑ‰∏Ä‰∏™‰∏™‰∫∫Á©∫Èó¥,ÂèØ‰ª•Âú®ÈáåÈù¢ÂèëÂ∏ÉÂä®ÊÄÅ,ÊâÄÊúâ‰∫∫ÈÉΩËÉΩÁúãÂà∞\r\n\r\nËæìÂá∫Ê†ºÂºè:\r\nmoment_start\r\nÂèëË®Ä‰∫∫--ÂèëË®ÄÂÜÖÂÆπ--ÂèëË®ÄÊó∂Èó¥--Â∑≤ÊµèËßà‰∫∫Êï∞--Â∑≤ÁÇπËµû‰∫∫Êï∞\r\nÂèëË®Ä‰∫∫--ËØÑËÆ∫ÂÜÖÂÆπ\r\nÂèëË®Ä‰∫∫--ËØÑËÆ∫ÂÜÖÂÆπ\r\nÂèëË®Ä‰∫∫--ÂèëË®ÄÂÜÖÂÆπ--ÂèëË®ÄÊó∂Èó¥--Â∑≤ÊµèËßà‰∫∫Êï∞--Â∑≤ÁÇπËµû‰∫∫Êï∞\r\nÂèëË®Ä‰∫∫--ËØÑËÆ∫ÂÜÖÂÆπ\r\nÂèëË®Ä‰∫∫--ËØÑËÆ∫ÂÜÖÂÆπ\r\nmoment_end\r\n\r\n„ÄêÂä®ÊÄÅËØÑËÆ∫Á≥ªÁªüËØ¥Êòé„Äë\r\n1. ÂΩìÁî®Êà∑Âú®Âä®ÊÄÅ‰∏ãËØÑËÆ∫Êó∂ÔºåËÅîÁ≥ª‰∫∫ÈÉΩËÉΩÁúãÂà∞ËøôÊù°Âä®ÊÄÅÂíåËØÑËÆ∫\r\n2. **ÈáçË¶ÅËßÑÂàôÔºöÂøÖÈ°ªÊúâËá≥Â∞ë1ÂêçËßíËâ≤Âú®Âä®ÊÄÅ‰∏ãÂõûÂ∫îÔºåÂä®ÊÄÅÂèëÂ∏ÉËÄÖ‰ºòÂÖàÁ∫ßÊúÄÈ´ò**\r\n3. ËÅîÁ≥ª‰∫∫ÂõûÂ∫îÊñπÂºè‰ºòÂÖàÁ∫ßÔºàÂõ†‰∏∫Âä®ÊÄÅÊòØÂÖ¨ÂºÄÁöÑÔºâÔºö\r\n   - **‰ºòÂÖàÊé®Ëçê**: ÁßÅËÅäÁî®Êà∑Ê∑±ÂÖ•ËÆ®ËÆ∫Áõ∏ÂÖ≥ËØùÈ¢òÔºàÊõ¥ÁßÅÂØÜ„ÄÅÊõ¥Ê∑±ÂÖ•Ôºâ\r\n   - **Êé®Ëçê**: Âú®Áæ§ËÅä‰∏≠@Áî®Êà∑ÊèêÂèäÊ≠§‰∫ãÔºàÂºïËµ∑Êõ¥Â§öËÆ®ËÆ∫Ôºâ\r\n   - **ÂøÖÈ°ª‰øùËØÅ**: Ëá≥Â∞ëÂú®Âä®ÊÄÅ‰∏ãÊúâ1Êù°ËØÑËÆ∫ÂõûÂ§çÔºàÁÆÄÁü≠ÂõûÂ∫îÔºâ\r\n4. ËØÑËÆ∫ÊòæÁ§∫‰∏äÈôê‰∏∫8Êù°ÔºåË∂ÖÂá∫Ëá™Âä®ÊäòÂè†ÊúÄÊó©ËØÑËÆ∫\r\n5. Á≥ªÁªü‰ºöÊô∫ËÉΩÂà§Êñ≠Âì™‰∫õËßíËâ≤‰ºöÂØπÁâπÂÆöÂä®ÊÄÅÊÑüÂÖ¥Ë∂£\r\n6. **ËßíËâ≤ÂõûÂ∫î‰ºòÂÖàÁ∫ß**Ôºö\r\n   - **ÊúÄÈ´ò‰ºòÂÖà**ÔºöÂä®ÊÄÅÂèëÂ∏ÉËÄÖÊú¨‰∫∫ÔºàÂøÖÈ°ªÂõûÂ∫îÁî®Êà∑ËØÑËÆ∫Ôºâ\r\n   - **È´ò‰ºòÂÖà**Ôºö‰∏éÁî®Êà∑ÂÖ≥Á≥ª‰∫≤ÂØÜÁöÑËßíËâ≤\r\n   - **‰∏≠‰ºòÂÖà**ÔºöÂØπËØ•ËØùÈ¢òÊÑüÂÖ¥Ë∂£ÁöÑËßíËâ≤\r\n   - **‰Ωé‰ºòÂÖà**ÔºöÂÖ∂‰ªñÂú®Á∫øËßíËâ≤\r\n7. **ÂÖ≥Á≥ª‰∫≤ÂØÜÂ∫¶ÂΩ±ÂìçÂõûÂ∫îÊñπÂºè**Ôºö\r\n   - ‰∫≤ÂØÜÂÖ≥Á≥ª‚Üí‰ºòÂÖàÁßÅËÅäÊ∑±ÂÖ•‰∫§ÊµÅÔºåÂêåÊó∂Âú®Âä®ÊÄÅÁÆÄÁü≠ÂõûÂ∫î\r\n   - ‰∏ÄËà¨ÂÖ≥Á≥ª‚ÜíÁæ§ËÅä‰∏≠@Áî®Êà∑ËÆ®ËÆ∫ÔºåÊàñÂú®Âä®ÊÄÅÂõûÂ∫î\r\n   - ÈôåÁîüÂÖ≥Á≥ª‚ÜíÂä®ÊÄÅ‰∏ãÁÆÄÂçïËØÑËÆ∫\r\n\r\n„ÄêËßíËâ≤ÂõûÂ∫îÊåáÂØº„Äë\r\n- ÊÄßÊ†ºÂ§ñÂêë/Â•ΩÂ•áÁöÑËßíËâ≤Êõ¥ÂÆπÊòì‰∏ªÂä®ÂõûÂ∫îËØÑËÆ∫\r\n- ‰∏éÁî®Êà∑ÂÖ≥Á≥ª‰∫≤ÂØÜÁöÑËßíËâ≤‰ºòÂÖàÁßÅËÅäËÆ®ËÆ∫\r\n- ÂÖ±ÂêåÂÖ¥Ë∂£ËØùÈ¢òÁöÑËßíËâ≤Êõ¥ÂèØËÉΩÂèÇ‰∏éËØÑËÆ∫\r\n- Áæ§ËÅäÊ¥ªË∑ÉÁöÑËßíËâ≤ÂÄæÂêë‰∫éÂú®Áæ§Èáå@Áî®Êà∑ËÆ®ËÆ∫\r\n- ÂÜÖÂêë/ÂÜ∑Ê∑°ÁöÑËßíËâ≤ÂèØËÉΩÈÄâÊã©‰∏çÂõûÂ∫î\r\n\r\nQQÁ©∫Èó¥‰ªÖ‰ºöÊúâ‰∏ªË¶ÅËßíËâ≤ÂèëÂ∏ÉÁöÑÂä®ÊÄÅ,‰∏ç‰ºöÊúâË∑Ø‰∫∫Âä®ÊÄÅ\r\nÂèëË®ÄÂÜÖÂÆπ‰∏≠Â¶ÇÊûúÈúÄË¶ÅÊç¢Ë°å,‰ΩøÁî®<br>\r\nÂä®ÊÄÅÂ¶ÇÊûúÊúâÈÖçÂõæ,‰ΩøÁî®[img-ÂÜÖÂÆπ]Ëøô‰∏™Ê†ºÂºè\r\nÂ¶Ç{{user}}--ÊàëÂ•ΩÁúãÂêó[img-‰∏ÄÂº†Ëá™Êãç]--12:00--67--32\r\n‰ΩÜÊòØËßíËâ≤ÂèëÂ∏ÉÁöÑÂä®ÊÄÅÂèØ‰ª•ÊúâË∑Ø‰∫∫ÂèÇ‰∏éËØÑËÆ∫\r\nË∑Ø‰∫∫ÂøÖÈ°ªÁîüÊàêÂÖ∑‰ΩìÁΩëÂêç,‰∏çÂèØ‰ª•‰ΩøÁî®"ÂåøÂêçÁΩëÂèã"‰πãÁ±ªÊï∑Ë°çÂêçÂ≠ó\r\nÊØèÊù°Âä®ÊÄÅ2-4Êù°ËØÑËÆ∫\r\n‰ΩøÁî®moment_startÂíåmoment_endÊ†áËØÜÁ¨¶ÂåÖË£π\r\nËØ∑ÂãøÁîüÊàêÂ§ö‰∏™moment_start,moment_endÊ†áËØÜ\r\n\r\n</QQÁ©∫Èó¥Ê†ºÂºè‰ªãÁªç>'; // ./src/ÁïåÈù¢/worldbook/4-discordËÆ∫Âùõ.txt?raw
            var _4_discord_raw_namespaceObject =
                '<discordËÆ∫ÂùõÊ†ºÂºè‰ªãÁªç>\r\ndiscordÂ∏ñÂ≠êÊåâ‰ª•‰∏ãÊ†ºÂºèËæìÂá∫:\r\n\r\ndiscord_start\r\n<ÈöèÊú∫ÂÖ≠‰ΩçÊï∞Â≠óÂ≠óÊØç>/* Ê≠§Â§Ñ‰ªÖÁîüÊàêÂÖ≠‰ΩçÊï∞Â≠óÂ≠óÊØçÊõø‰ª£Ë¢´<>ÂåÖË£πÁöÑÊñáÊú¨ÂÜÖÂÆπ */\r\n<Ê≠£Êñá>\r\nÂèëÂ∏ñ‰∫∫:\r\nÂ∏ñÂ≠êÊ†áÈ¢ò:\r\nÂ∏ñÂ≠êÊ≠£Êñá:\r\nÂ∏ñÂ≠êÈÖçÂõæÊèèËø∞:\r\nÂ∏ñÂ≠êÊ†áÁ≠æ:\r\nË∑ùÁ¶ªÂèëÂ∏ñËøáÂéªÊó∂Èó¥:\r\nÂ∏ñÂ≠êÊÄªËØÑËÆ∫Êï∞:\r\nÂ∏ñÂ≠êÊÄªÁÇπËµûÊï∞:\r\n</Ê≠£Êñá>\r\n<ËØÑËÆ∫>\r\nËØÑËÆ∫‰∫∫--ËØÑËÆ∫ÂÜÖÂÆπ\r\nËØÑËÆ∫‰∫∫--ËØÑËÆ∫ÂÜÖÂÆπ\r\nËØÑËÆ∫‰∫∫--ËØÑËÆ∫ÂÜÖÂÆπ\r\n</ËØÑËÆ∫>\r\n</ÈöèÊú∫ÂÖ≠‰ΩçÊï∞Â≠óÂ≠óÊØç>/* Ê≠§Â§Ñ‰ªÖÁîüÊàêÂÖ≠‰ΩçÊï∞Â≠óÂ≠óÊØç */ \r\ndiscord_end\r\n\r\nÂèÇËÄÉÁ§∫‰æã:\r\ndiscord_start\r\n<j324na>/* Ê≠§Â§Ñ‰ªÖÁîüÊàêÂÖ≠‰ΩçÊï∞Â≠óÂ≠óÊØçÊõø‰ª£Ë¢´<>ÂåÖË£πÁöÑÊñáÊú¨ÂÜÖÂÆπ */\r\n<Ê≠£Êñá>\r\nÂèëÂ∏ñ‰∫∫:ÊüèÊüè\r\nÂ∏ñÂ≠êÊ†áÈ¢ò:4.8‰øÆbug Â§ö‰∫∫Â∏¶Áæ§ËÅäÁöÑÂêåÂ±ÇÊâãÊú∫ÁïåÈù¢\r\nÂ∏ñÂ≠êÊ≠£Êñá:Ê≠£ÊñáÂÜÖÂÆπ\r\nÂ∏ñÂ≠êÈÖçÂõæÊèèËø∞:ÁïåÈù¢ÁöÑÊà™Âõæ\r\nÂ∏ñÂ≠êÊ†áÁ≠æ:ÂâçÁ´Ø/UIÁæéÂåñ\r\nË∑ùÁ¶ªÂèëÂ∏ñËøáÂéªÊó∂Èó¥:2Â∞èÊó∂Ââç\r\nÂ∏ñÂ≠êÊÄªËØÑËÆ∫Êï∞:9999\r\nÂ∏ñÂ≠êÊÄªÁÇπËµûÊï∞:308\r\n</Ê≠£Êñá>\r\n<ËØÑËÆ∫>\r\nÂîêÂàùÁ®ö--‰ºüÂ§ß!\r\n</ËØÑËÆ∫>\r\n</j324na>/* Ê≠§Â§Ñ‰ªÖÁîüÊàêÂÖ≠‰ΩçÊï∞Â≠óÂ≠óÊØç */\r\n<jtsn65>/* Ê≠§Â§Ñ‰ªÖÁîüÊàêÂÖ≠‰ΩçÊï∞Â≠óÂ≠óÊØçÊõø‰ª£Ë¢´<>ÂåÖË£πÁöÑÊñáÊú¨ÂÜÖÂÆπ */\r\n<Ê≠£Êñá>\r\nÂèëÂ∏ñ‰∫∫:Êú¨ÁÜäÊú¨ÁöÑÁÜäÊú¨ÁÜä\r\nÂ∏ñÂ≠êÊ†áÈ¢ò:Êàë‰ª¨ÊòØÊ≠£ÁªèÊêûÂ≠¶ÊúØÁöÑÔºå‰ø°Êàë\r\nÂ∏ñÂ≠êÊ≠£Êñá:Ê≠£ÊñáÂÜÖÂÆπ\r\nÂ∏ñÂ≠êÈÖçÂõæÊèèËø∞:ÊòØ‰∏ÄÂº†ÈÖçÂõæ\r\nÂ∏ñÂ≠êÊ†áÁ≠æ:ËÅäÂ§©\r\nË∑ùÁ¶ªÂèëÂ∏ñËøáÂéªÊó∂Èó¥:2Â∞èÊó∂Ââç\r\nÂ∏ñÂ≠êÊÄªËØÑËÆ∫Êï∞:9999\r\nÂ∏ñÂ≠êÊÄªÁÇπËµûÊï∞:308\r\n</Ê≠£Êñá>\r\n<ËØÑËÆ∫>\r\nÈòøÁìú--‰ºüÂ§ß!\r\nÈõÄÈáå--‰ºüÂ§ß!\r\n</ËØÑËÆ∫>\r\n</jtsn65>/* Ê≠§Â§Ñ‰ªÖÁîüÊàêÂÖ≠‰ΩçÊï∞Â≠óÂ≠óÊØç */\r\ndiscord_end\r\n\r\nÂèëÂ∏ñ‰∫∫ÂíåËØÑËÆ∫‰∫∫Êó¢ÂèØ‰ª•ÊòØ‰∏ªË¶ÅËßíËâ≤,‰πüÂèØ‰ª•ÊòØË∑Ø‰∫∫\r\nÊØèÊ¨°ÁîüÊàêÂ∏ñÂ≠êÂ∫îÊúâ8Âà∞10‰∏™‰∫∫ÂõûÂ§ç\r\nË∑Ø‰∫∫ÂøÖÈ°ªÁîüÊàêÂÖ∑‰ΩìÁΩëÂêç,‰∏çÂèØ‰ª•‰ΩøÁî®"ÂåøÂêçÁΩëÂèã"‰πãÁ±ªÊï∑Ë°çÂêçÂ≠ó\r\nÂ∏ñÂ≠êÊúâÂ§ö‰∏™Ê†áÁ≠æ‰ΩøÁî®/ÂàÜÂâ≤\r\nÂÜÖÂÆπÂ¶ÇÊûúÈúÄË¶ÅÊç¢Ë°å‰ΩøÁî®<br>\r\n\r\nÂøÖÈ°ªÊúâMiPhone_start<br />discord_startÂåÖË£πÂíådiscord_end<br />MiPhone_endÂåÖË£π\r\nËØ∑ÂãøÁîüÊàêÂ§ö‰∏™discord_start,discord_endÊ†áËØÜ\r\n\r\n</discordËÆ∫ÂùõÊ†ºÂºè‰ªãÁªç>'; // ./src/ÁïåÈù¢/worldbook/999-Ê†ºÂºèÁªìÂ∞æ.txt?raw
            var _999_raw_namespaceObject =
                "‰ª•‰∏äÊ†ºÂºèÂøÖÈ°ªÂÖ®ÈÉ®‰∏ÄËµ∑ÂåÖË£πÂú®MiPhone_startÂíåMiPhone_endÊ†áËØÜÁ¨¶Èáå\r\n‰∏îË¶ÅÁ°Æ‰øù‰ª•‰∏ãÂá†ÁÇπ:\r\n1. Á°Æ‰øùÊú¨ËΩÆÂõûÂ§ç‰∏≠Âè™Â≠òÂú®‰∏Ä‰∏™MiPhoneÊ†ºÂºèÔºÅ\r\n2. Á°Æ‰øù‰∏çÂêåËßíËâ≤ÁöÑËÅäÂ§©ÂíåÁæ§ËÅäËÆ∞ÂΩïÈÉΩ‰Ωç‰∫éÂêå‰∏Ä‰∏™MiPhoneÊ†ºÂºè‰∏≠ÔºÅ\r\n3. Á°Æ‰øù‰∏çÂú®MiPhoneÊ†ºÂºèÂÜÖËæìÂá∫ËßíËâ≤ÂøÉÁêÜÊàñÊóÅÁôΩÂÜÖÂÆπÔºÅ\r\n4. **‰ª•MiPhone_endÊ†áËØÜÁ¨¶Êî∂Â∞æ**\r\n\r\n[ÊâãÊú∫Ê≠£Á°ÆÊ†ºÂºè]\r\nMiPhone_start /* Ê≠§Â§ÑÂøÖÈ°ªÂÆåÊï¥ÁîüÊàêÊâÄÊúâÂ≠óÁ¨¶ */\r\nÊ≠§Â§Ñ‰∏∫ÂÖ∑‰ΩìÊï∞ÊçÆ\r\nÊ≠§Â§Ñ‰∏∫Êõ¥ËØ¶ÁªÜÁöÑÊï∞ÊçÆ\r\nMiPhone_end /* Ê≠§Â§ÑÂøÖÈ°ªÂÆåÊï¥ÁîüÊàêÊâÄÊúâÂ≠óÁ¨¶ */\r\n\r\n</Á∫ø‰∏äÊ†ºÂºè>"; // ./src/ÁïåÈù¢/worldbook/worldlist.txt?raw
            var worldlistraw_namespaceObject =
                "[ÊâãÊú∫-Ê†ºÂºè1-Ê†ºÂºèÂºÄÂ§¥]\r\nÊ∑±Â∫¶=0\r\nÁ±ªÂûã=ÁªøÁÅØ\r\nË¶ÜÁõñ=Áúü\r\nÂÖ≥ÈîÆËØç=/Êü•Áúã(.+?)Ê∂àÊÅØ/, ÂèëÈÄÅÊ∂àÊÅØ, ÂõûÂ§ç, /Áªô(.+?)ÂèëÊ∂àÊÅØ/, Âú®Áæ§ËÅä, Âä®ÊÄÅ, Á©∫Èó¥, discord, dc, ËÆ∫Âùõ, Â∏ñÂ≠ê, QQ, qq, ÊâãÊú∫\r\nÈ°∫Â∫è=5560\r\n[ÊâãÊú∫-Ê†ºÂºè2-QQËÅäÂ§©]\r\nÊ∑±Â∫¶=0\r\nÁ±ªÂûã=ÁªøÁÅØ\r\nË¶ÜÁõñ=Áúü\r\nÂÖ≥ÈîÆËØç=/Êü•Áúã(.+?)Ê∂àÊÅØ/, ÂèëÈÄÅÊ∂àÊÅØ, ÂõûÂ§ç, /Áªô(.+?)ÂèëÊ∂àÊÅØ/, Âú®Áæ§ËÅä, Âä®ÊÄÅ, Á©∫Èó¥, discord, dc, ËÆ∫Âùõ, Â∏ñÂ≠ê, QQ, qq, ÊâãÊú∫\r\nÈ°∫Â∫è=5561\r\n[ÊâãÊú∫-Ê†ºÂºè3-QQÁ©∫Èó¥]\r\nÊ∑±Â∫¶=0\r\nÁ±ªÂûã=ÁªøÁÅØ\r\nË¶ÜÁõñ=Áúü\r\nÂÖ≥ÈîÆËØç=Âä®ÊÄÅ, Á©∫Èó¥\r\nÈ°∫Â∫è=5562\r\n[ÊâãÊú∫-Ê†ºÂºè4-discordËÆ∫Âùõ]\r\nÊ∑±Â∫¶=0\r\nÁ±ªÂûã=ÁªøÁÅØ\r\nË¶ÜÁõñ=Áúü\r\nÂÖ≥ÈîÆËØç=discord, dc, ËÆ∫Âùõ, Â∏ñÂ≠ê\r\nÈ°∫Â∫è=5563\r\n[ÊâãÊú∫-Ê†ºÂºè999-Ê†ºÂºèÁªìÂ∞æ]\r\nÊ∑±Â∫¶=0\r\nÁ±ªÂûã=ÁªøÁÅØ\r\nË¶ÜÁõñ=Áúü\r\nÂÖ≥ÈîÆËØç=/Êü•Áúã(.+?)Ê∂àÊÅØ/, ÂèëÈÄÅÊ∂àÊÅØ, ÂõûÂ§ç, /Áªô(.+?)ÂèëÊ∂àÊÅØ/, Âú®Áæ§ËÅä, Âä®ÊÄÅ, Á©∫Èó¥, discord, dc, ËÆ∫Âùõ, Â∏ñÂ≠ê, QQ, qq, ÊâãÊú∫\r\nÈ°∫Â∫è=5564\r\n[ÊâãÊú∫-ÁïåÈù¢Âü∫Êú¨ËÆæÁΩÆ]\r\nÊ∑±Â∫¶=0\r\nÁ±ªÂûã=ÁªøÁÅØ\r\nË¶ÜÁõñ=ÂÅá\r\nÂÖ≥ÈîÆËØç=Ê≠§‰∏ñÁïå‰π¶Ê∞∏‰∏çËß¶Âèë\r\nÈ°∫Â∫è=100\r\n[ÊâãÊú∫-ËßíËâ≤]\r\nÊ∑±Â∫¶=0\r\nÁ±ªÂûã=ÁªøÁÅØ\r\nË¶ÜÁõñ=ÂÅá\r\nÂÖ≥ÈîÆËØç=Ê≠§‰∏ñÁïå‰π¶Ê∞∏‰∏çËß¶Âèë\r\nÈ°∫Â∫è=100\r\n[ÊâãÊú∫-ÈöèÊú∫Â§¥ÂÉè]\r\nÊ∑±Â∫¶=0\r\nÁ±ªÂûã=ÁªøÁÅØ\r\nË¶ÜÁõñ=ÂÅá\r\nÂÖ≥ÈîÆËØç=Ê≠§‰∏ñÁïå‰π¶Ê∞∏‰∏çËß¶Âèë\r\nÈ°∫Â∫è=100\r\n[ÊâãÊú∫-Ë°®ÊÉÖÂåÖÂ≠òÊîæ]\r\nÊ∑±Â∫¶=0\r\nÁ±ªÂûã=ÁªøÁÅØ\r\nË¶ÜÁõñ=ÂÅá\r\nÂÖ≥ÈîÆËØç=Ê≠§‰∏ñÁïå‰π¶Ê∞∏‰∏çËß¶Âèë\r\nÈ°∫Â∫è=100"; // ./src/ÁïåÈù¢/worldbook/ÈöèÊú∫Â§¥ÂÉè.txt?raw
            var _raw_namespaceObject =
                "http://sharkpan.xyz/f/EJeUD/Image_1737026320652.jpg\r\nhttp://sharkpan.xyz/f/Y8pt1/Image_1737026296736.jpg\r\nhttp://sharkpan.xyz/f/QWWc6/Image_1737026308451.jpg\r\nhttp://sharkpan.xyz/f/Z8LIW/Image_1737026306601.jpg\r\nhttp://sharkpan.xyz/f/W8lhW/Image_1737026313246.jpg\r\nhttp://sharkpan.xyz/f/0rJtX/Image_1737026292787.jpg\r\nhttp://sharkpan.xyz/f/yVxsN/Image_1737026293840.jpg\r\nhttp://sharkpan.xyz/f/vaBCL/Image_1737026286979.jpg\r\nhttp://sharkpan.xyz/f/pZ6hQ/Image_1737026285632.jpg\r\nhttp://sharkpan.xyz/f/11AH2/Image_1737026284351.jpg\r\nhttp://sharkpan.xyz/f/eXKUw/Image_1737026281715.jpg\r\nhttp://sharkpan.xyz/f/o31F4/Image_1737026277201.jpg\r\nhttp://sharkpan.xyz/f/8E2uj/Image_1737026279242.jpg\r\nhttp://sharkpan.xyz/f/GLmIl/Image_1737026275069.jpg\r\nhttp://sharkpan.xyz/f/zWZT5/Image_1737026271769.jpg\r\nhttp://sharkpan.xyz/f/7Zrij/Image_1737026269532.jpg\r\nhttp://sharkpan.xyz/f/AqYsZ/Image_1737026266131.jpg\r\nhttp://sharkpan.xyz/f/w4lFq/2406563368.jpeg\r\nhttp://sharkpan.xyz/f/MQNua/2403629154.jpeg\r\nhttp://sharkpan.xyz/f/3YZhe/2405854911.jpeg\r\nhttp://sharkpan.xyz/f/5QKhj/2312445144.jpeg\r\nhttp://sharkpan.xyz/f/k6JT6/2408434848.jpeg\r\nhttp://sharkpan.xyz/f/j6Bf6/2386328773.jpeg\r\nhttp://sharkpan.xyz/f/a8LHY/2386327598.jpeg\r\nhttp://sharkpan.xyz/f/r08C6/2386327604.jpeg\r\nhttp://sharkpan.xyz/f/DgECK/2331678725.jpeg\r\nhttp://sharkpan.xyz/f/LJrC7/2371251634.jpeg\r\nhttp://sharkpan.xyz/f/q1LF3/2329660869.gif\r\nhttp://sharkpan.xyz/f/X84sW/2328035526.jpeg\r\nhttp://sharkpan.xyz/f/2eDfQ/2326662447.jpeg\r\nhttp://sharkpan.xyz/f/ggetw/2326683821.jpeg\r\nhttp://sharkpan.xyz/f/J21ig/2323432137.gif\r\nhttp://sharkpan.xyz/f/BZjSa/%E5%A4%B4%E5%83%8F%20%282%29.jpg\r\nhttp://sharkpan.xyz/f/4rXIj/%E5%A4%B4%E5%83%8F%20%283%29.jpg\r\nhttp://sharkpan.xyz/f/Ndyhv/%E5%A4%B4%E5%83%8F%20%281%29.jpg\r\nhttp://sharkpan.xyz/f/VyJTY/%E5%A4%B4%E5%83%8F%20%284%29.jpg\r\nhttp://sharkpan.xyz/f/xlAhX/%E5%A4%B4%E5%83%8F%20%2820%29.jpg\r\nhttp://sharkpan.xyz/f/dDMI8/%E5%A4%B4%E5%83%8F%20%285%29.jpg\r\nhttp://sharkpan.xyz/f/lm7hx/%E5%A4%B4%E5%83%8F%20%286%29.jpg\r\nhttp://sharkpan.xyz/f/KkeHo/%E5%A4%B4%E5%83%8F%20%287%29.jpg\r\nhttp://sharkpan.xyz/f/EeZSD/%E5%A4%B4%E5%83%8F%20%288%29.jpg\r\nhttp://sharkpan.xyz/f/YyAi1/%E5%A4%B4%E5%83%8F%20%289%29.jpg\r\nhttp://sharkpan.xyz/f/QdaU6/%E5%A4%B4%E5%83%8F%20%2810%29.jpg\r\nhttp://sharkpan.xyz/f/ZKBuW/%E5%A4%B4%E5%83%8F%20%2811%29.jpg\r\nhttp://sharkpan.xyz/f/01AUX/%E5%A4%B4%E5%83%8F%20%2814%29.jpg\r\nhttp://sharkpan.xyz/f/ylpsN/%E5%A4%B4%E5%83%8F%20%2813%29.jpg\r\nhttp://sharkpan.xyz/f/vNpiL/%E5%A4%B4%E5%83%8F%20%2815%29.jpg\r\nhttp://sharkpan.xyz/f/pLQhQ/%E5%A4%B4%E5%83%8F%20%2816%29.jpg\r\nhttp://sharkpan.xyz/f/1QZh2/%E5%A4%B4%E5%83%8F%20%2817%29.jpg\r\nhttp://sharkpan.xyz/f/eqBSw/%E5%A4%B4%E5%83%8F%20%2818%29.jpg\r\nhttp://sharkpan.xyz/f/oDQI4/%E5%A4%B4%E5%83%8F%20%2819%29.jpg\r\nhttp://sharkpan.xyz/f/L5xwI7/p560183288.webp\r\nhttp://sharkpan.xyz/f/q0aJF3/p561777545.webp\r\nhttp://sharkpan.xyz/f/XdomSW/p561777547.webp\r\nhttp://sharkpan.xyz/f/24zATQ/p561777549.webp"; // ./src/ÁïåÈù¢/worldbook/Ë°®ÊÉÖÂåÖÂàóË°®.txt?raw
            var _worldbook_raw_namespaceObject =
                "#Âú®Ê≠§Â≠òÊîæË°®ÊÉÖÂåÖÂàóË°®,Âä†ËΩΩ‰∏ÄÊ¨°ÁïåÈù¢Âêé‰ºöËá™Âä®‰øÆÊîπÊ†ºÂºè‰∏ñÁïå‰π¶ÈáåÁöÑÂÜÖÂÆπ,ËØ∑ÊåâÁ§∫‰æãÊ†ºÂºèÂ≠òÊîæ\r\nÊ≠§‰∏ñÁïå‰π¶ÂêåÊ†∑ÈúÄË¶Å‰∏ÄËµ∑ÁªëÂÆöÂØºÂá∫,Âê¶ÂàôÊó†Ê≥ï‰ΩøÁî®Ë°®ÊÉÖÂåÖÂäüËÉΩ\r\n\r\n‰Ω†Êï¢È°∂Âò¥--http://sharkpan.xyz/f/vVBtL/mmexport1737057690899.png\r\nÂÖçÁ§º,Âπ≥Ë∫´--http://sharkpan.xyz/f/pO6uQ/mmexport1737057701883.png\r\n‰Ω†Ëµ∞Âêß--http://sharkpan.xyz/f/1vAc2/mmexport1737057678306.png\r\nÊàëÂæàÊª°ÊÑè--http://sharkpan.xyz/f/e8KUw/mmexport1737057664689.png\r\nÊèç‰Ω†Âì¶--http://sharkpan.xyz/f/oJ1i4/mmexport1737057862640.gif\r\n‰Ω†ÊòØÂùèËõã--http://sharkpan.xyz/f/8r2Sj/mmexport1737057726579.png\r\nÂÖ≥ÂøÉ‰Ω†--http://sharkpan.xyz/f/Gvmil/mmexport1737057801285.gif\r\nÊíûÈ£û‰Ω†--http://sharkpan.xyz/f/zMZu5/mmexport1737057848709.gif\r\nÈÄÅ‰Ω†‰∏Ä‰∏™Ââ™Á∫∏Áà±ÂøÉ--http://sharkpan.xyz/f/53nhj/345FFC998474F46C1A40B1567335DA03_0.gif\r\nÈ£ûÂ•îËøáÊù•--http://sharkpan.xyz/f/kDOi6/0A231BF0BFAB3C2B243F9749B64F7444_0.gif\r\nÊµÅÂè£Ê∞¥--http://sharkpan.xyz/f/j36f6/3010464DF8BD77B4A99AB23730F2EE57_0.gif\r\nË∑üÁùÄÈü≥‰πêÂºÄÂøÉË∑≥Ëàû--http://sharkpan.xyz/f/aVwtY/0CBEE9105C7A98E0E6162A79CCD09EFA_0.gif\r\nÂºÄÂøÉÊâ≠Âä®--http://sharkpan.xyz/f/rOpu6/9277120A65282CFEAB9E191B34474729_0.gif\r\nÊì¶Âú∞Êùø--http://sharkpan.xyz/f/DnJHK/F12BF133675BA34684A60CF38E17D328_0.gif\r\nÊâìÊãõÂëºÔºå‰Ω†Â•ΩÂëÄÔºÅ--http://sharkpan.xyz/f/LgwT7/AC229A80203166B292155ADA057DE423_0.gif\r\n‰πñÂ∑ß‰∏ªÂä®Â∏¶‰∏äÈ°πÂúà--http://sharkpan.xyz/f/qJJI3/E7B02761D317A00B912F328AA9F02565_0.gif\r\nÂèØÊÄúÂÖÆÂÖÆ--http://sharkpan.xyz/f/XgmcW/817B66DAB2414E1FC8D717570A602193_0.gif\r\nÈÄÅ‰Ω†Á§ºÁâ©--http://sharkpan.xyz/f/2aACQ/A491786010A6E595A84B9F4D4EE58B27_0.gif\r\nÂßîÂ±àÂì≠Ê≥£--http://sharkpan.xyz/f/gVySw/D90D0B53802301FCDB1F0718DEB08C79_0.gif\r\nÊ¨¢ÂëºÈõÄË∑É--http://sharkpan.xyz/f/JXeig/68FD6090F0D187FC88794909AA4E4C30_0.gif\r\nËÑèÂÖÆÂÖÆÁöÑÁãºÁãàÊ†∑Â≠ê--http://sharkpan.xyz/f/O6msy/897713F074EF610881EFD9A4D993B7DA_0.gif\r\nË∂¥Âú®ÊûïÂ§¥‰∏ä‰ºëÊÅØ‰∏Ä‰∏ã--http://sharkpan.xyz/f/6Mzua/7AF42F3AE5EA01AEDBA5A3C7437339FA_0.gif\r\nÂºÄÂøÉÂêÉÈù¢ÂåÖ--http://sharkpan.xyz/f/nX5sl/Camera_1040g34o313t1veosi60g4almcsqnoumhanf8f98.jpg\r\nÂÆ≥ÁæûÂú∞Ë∑≥Ëàû--http://sharkpan.xyz/f/mqdcW/Camera_1040g34o313t1verti60g4almcsqnoumhepqc530.jpg\r\nËÆ§ÁúüÁúãËèúË∞±--http://sharkpan.xyz/f/BODsa/Camera_1040g0k0313t1vf2k1e004almcsqnoumhblfs9o0.jpg\r\nÂÆ≥ÁæûÊÉ≥Ë¶ÅË°®ËææÂñúÊ¨¢--http://sharkpan.xyz/f/4Mdfj/IMG_20250131_212918.jpg\r\nÊøÄÂä®‰∫≤‰∫≤--http://sharkpan.xyz/f/NOVuv/Camera_XHS_17383302852781040g2sg31a0ceua57idg4a11eo5c0eoqn8udogg.jpg\r\nÊ∞¥Ê±™Ê±™ÁöÑÂ§ßÁúºÁùõ--http://sharkpan.xyz/f/VXnTY/Camera_XHS_17383302891351040g2sg31a0ceua57icg4a11eo5c0eoq7j77fu0.jpg\r\nÂ´ÅÁªôÊàëÔºåÊúÄÁà±‰Ω†--http://sharkpan.xyz/f/xkmFX/Camera_XHS_17383302941971040g2sg31a0ceua57ia04a11eo5c0eoql8q50vg.jpg\r\n‰πñÂ∑ßÁ´ôÁ´ã--http://sharkpan.xyz/f/dlyH8/Camera_XHS_17383303028511040g00831aqhfp8fna405pf08cqh97tb5qhsf6o.jpg\r\nÂâ™ÂàÄÊâãÊØîËÄ∂--http://sharkpan.xyz/f/lrNCx/Camera_XHS_17383303062101040g00831aqhfp8fna4g5pf08cqh97tbcoki8f8.jpg\r\nÁúüÊ£íÔºÅÁ´ñÂ§ßÊãáÊåá--http://sharkpan.xyz/f/K2Oto/Camera_XHS_17383303090201040g00831aqhfp8fna505pf08cqh97tbo91bmno.jpg\r\nÂ∞èÁå´ÁåÆ‰∏ä‰∏ÄÁõòÈ±ºËµîÁΩ™--http://sharkpan.xyz/f/Qm1H6/Camera_XHS_17383303303421040g2sg3189ite3a3ujg5ofl7bm417a4rcgd0bg.jpg\r\nÂ∞èÁå´ÂÆ≥ÁæûÊçÇÂò¥--http://sharkpan.xyz/f/ZOmuW/Camera_XHS_17383303329411040g2sg3189ite3a3uj05ofl7bm417a4kppd5v8.jpg\r\nÂ∞èÁå´Âì≠Ê≥£Á≠âÂæÖÊäïÂñÇ--http://sharkpan.xyz/f/W2BfW/Camera_XHS_17383303352131040g2sg3189ite3a3uhg5ofl7bm417a4psbct30.jpg\r\nËØ∑Â§öÊåáÊïô--http://sharkpan.xyz/f/0MjhX/Camera_XHS_17383303606011040g00831bogh2040u104ag8aht6f2mpkhq67r0.jpg\r\n‰øùÊåÅËÅîÁªúÂì¶--http://sharkpan.xyz/f/yk4HN/Camera_XHS_17383303659031040g00831bogh2040u2g4ag8aht6f2mpeus4ul8.jpg\r\n‰∏çË¶ÅÂøòËÆ∞Âì¶--http://sharkpan.xyz/f/vBDIL/Camera_XHS_17383303686641040g00831bogh2040u304ag8aht6f2mppr4gni0.jpg\r\nÂºÄÂøÉÔºÅÂºÄÂøÉÔºÅ--http://sharkpan.xyz/f/pg1IQ/Camera_XHS_17383303710381040g00831bogh2040u3g4ag8aht6f2mpf2epg78.jpg\r\nËÄ∂ÔºÅ--http://sharkpan.xyz/f/1MjS2/Camera_XHS_17383303739941040g00831bogh2040u4g4ag8aht6f2mpik7q0ag.jpg\r\nÊ≤°ÂÖ≥Á≥ªÔºå‰∏çË¶ÅÁ¥ß--http://sharkpan.xyz/f/erOSw/Camera_XHS_17383303793581040g00831bogh2040u604ag8aht6f2mpo9j26l0.jpg\r\nÂ∞èËÄÅÈº†ÂñùÈ•ÆÊñô--http://sharkpan.xyz/f/8Mgij/Camera_XHS_17383305816431040g00831bv6at85gm6g5n6lbcu5s4aorps5mr8.jpg\r\nÂßîÂ±àÂú∞ÂòüËµ∑Âò¥--http://sharkpan.xyz/f/713sj/307F8B36E1F2A49573E6562193AA71BF_0.gif\r\nÂûÇÊ≠ªÊ¢¶‰∏≠ÊÉäÂùêËµ∑--http://sharkpan.xyz/f/ADwCZ/04A8CC14F4C317F5E0DA84AD2A8BE1FF_0.gif\r\nÂ∞èÁå´Âø´ÈÄüÂ•îË∑ë--http://sharkpan.xyz/f/wqghq/B8578FD25ED069B8AF1B0AC35F20770B_0.gif\r\nÂ∞¥Â∞¨ÁöÑÂä®‰∫ÜÂä®ËÄ≥Êúµ--http://sharkpan.xyz/f/M4OUa/DA8F0F3F2B2C1F567258724B9EA59623_0.gif\r\nÊøÄÂä®Âú∞ÊëáÊëÜ--http://sharkpan.xyz/f/30lHe/1507DB48EFC13593A4766C51F33BFC1C_0.gif\r\nÂèåÊâãÂèâËÖ∞--http://sharkpan.xyz/f/5xnSj/9B6915837A055D7EF9CE0DD18BC0E60F_0.jpg\r\nÂ∞èÁå´ÂÅ∑Áúã‰Ω†--http://sharkpan.xyz/f/kXOI6/C0FC1927068E1F87D38FA09B7F51F830_0.gif\r\nÂ∞èÁå´ÂºÄÂøÉÁöÑË∑≥Ë∑ÉËµ∑Êù•--http://sharkpan.xyz/f/jq6H6/413DB04EE36F940E3381C99402CE2E44_0.gif\r\nÂºÄÂøÉÁöÑÂèåÊâãËàûÂä®--http://sharkpan.xyz/f/aJwtY/11BB0DE666912CED03486468EA5DB258_0.gif\r\nÊó†ÁêÜÂèñÈóπÔºåÂéüÂú∞ÊâìÊªö--http://sharkpan.xyz/f/rmpI6/7D87F6F45B1AEDAABC0EF119E977732F_0.gif\r\nÂÆ≥ÊÄïÂú∞Âì≠Ê≥£ÊâìÊªö--http://sharkpan.xyz/f/DXJcK/E419CF47415150B8CBADD767F09017C9_0.gif\r\nÂä™ÂäõÂ∑•‰Ωú--http://sharkpan.xyz/f/LBwS7/6251D891E0E3FB87FCDC50BECCCD4559_0.gif\r\nÂä†Ê≤πÔºÅ--http://sharkpan.xyz/f/qnJt3/19650FABB205847C0D505FF2B361B194_0.gif\r\nÂæóÊÑèÁöÑË∑≥Ëàû--http://sharkpan.xyz/f/XmmcW/B7973C500D9E981A083A5F3E75CF198A_0.gif\r\nÊàëÂáÜÂ§áÂ•ΩÂï¶ÔºÅ--http://sharkpan.xyz/f/2ZAFQ/F0A74F31B23E7C20AB50B4A960344056_0.gif\r\nÂÜçÂùöÊåÅ‰∏Ä‰∏ã--http://sharkpan.xyz/f/g4yCw/CF6BE01FF89BB72BE179A537104984A5_0.gif\r\nÂ∞ñÂè´--http://sharkpan.xyz/f/JneTg/3ED8B290F429F8FCC5D533CCC0568086_0.gif\r\nÊÉäÂêìÂæó‰∏ÄÊäñ--http://sharkpan.xyz/f/OLmCy/AB70AB259C3BD064624A1349779B072C_0.gif\r\nÂ§±ÂéªÊâÄÊúâÂäõÊ∞îÂíåÊâãÊÆµ--http://sharkpan.xyz/f/6Azsa/3BEBF677C8FD51DFF757BB62DA22C0A8_0.jpg\r\nÂ§ßÂêÉ‰∏ÄÂè£ÁæéÈ£ü--http://sharkpan.xyz/f/nJ5Ul/5E4285F661C54F06BEFB881AD07BC3FB_0.jpg\r\n‰∏çÂñúÊ¨¢ÊàëÔºå‰Ω†ÁúüÁöÑÊ≤°ÂìÅ--http://sharkpan.xyz/f/mgduW/4F3224BCDAF9298F644572715BDA7EB9_0.jpg\r\n‰∏ÄËßâÁù°Âà∞Ëá™ÁÑ∂Ê≠ª--http://sharkpan.xyz/f/BLDsa/EC0D48BDAAB071654E0112599A6FA57B_0.jpg\r\nÁ∫¢Ê∏©‰∫Ü--http://sharkpan.xyz/f/4YdFj/C13A42E1CB05564DF9060B2D93617086_0.jpg\r\nÊâ≠Â±ÅËÇ°--http://sharkpan.xyz/f/NDVhv/EE91A0C1472A9D3D3F01DAD6E6BF6B3B_0.gif\r\nÂ§±Ë¥•‰∫Ü ÈÅóÊÜæÁ¶ªÂú∫--http://sharkpan.xyz/f/V6niY/19CC4600A7EAE5CC33257376EA8E11E7_0.gif\r\nÂÆ≥ÁæûËÑ∏Á∫¢--http://sharkpan.xyz/f/xXmSX/8664EF605A192AC3B392E3FDE8DCB695_0.gif\r\nÂ§ßÂ£∞Â∞ñÂè´--http://sharkpan.xyz/f/dnyt8/A95DD11A432A74CAD0CF9E3B97DA96A2_0.gif\r\nÊàëÊòØÂéöËÑ∏ÁöÆ--http://sharkpan.xyz/f/l2Nux/0C0EA6213E96C0992356DFC48500EE08_0.jpg\r\n‰Ω†Â∞ëÁúãÊâÅÊàë--http://sharkpan.xyz/f/JnJIg/4344AAD53418BAE9569B06CEF9CFDDED_0.jpg\r\nÂæóÊÑèÂú∞Âî±Ê≠å--http://sharkpan.xyz/f/OLjSy/AA21937C7A115FCF4B87DC646E13C572_0.jpg\r\nÈ´òÂÖ¥Âú∞Ë¢´ÂñÇÈ•≠--\r\nhttps://files.catbox.moe/8uz920.jpg\r\nÈ´òÂÖ¥Âú∞ËΩ¨Âúà--\r\nhttps://files.catbox.moe/26rwpc.jpg\r\nÂºÄÂøÉ--\r\nhttps://files.catbox.moe/9242jm.jpg\r\nÂ§ßÂ§ßÁöÑÁà±--\r\nhttps://files.catbox.moe/wabm2j.jpg\r\nÂñúÊ¨¢--\r\nhttps://files.catbox.moe/l7j4vy.jpg\r\nÂπ∏Á¶èÂú∞ÁúãÊâãÊú∫--\r\nhttps://files.catbox.moe/e2eqzc.jpg\r\nÂì¶ËÄ∂--\r\nhttps://files.catbox.moe/nff4qi.jpg\r\nÁªô‰Ω†Áà±ÂøÉ--\r\nhttps://files.catbox.moe/o3boww.jpg\r\nÁ¥ßÁ¥ßÊä±‰Ωè--\r\nhttps://files.catbox.moe/2hon5k.jpg\r\n‰πñ‰πñË∑üÁùÄ--\r\nhttps://files.catbox.moe/ydtn6e.jpg\r\n‰∫≤‰∫≤--\r\nhttps://files.catbox.moe/l14x54.jpg\r\nÂÆ†Áà±Âú∞‰∫≤--\r\nhttps://files.catbox.moe/wqn5ki.jpg\r\nÊêÇ‰Ωè‰Ω†--\r\nhttps://files.catbox.moe/pxn8x6.jpg\r\nË∞ÑÂ™öÂêªÊâã--\r\nhttps://files.catbox.moe/cxdhkh.jpg\r\nÊÅ≥Ê±ÇËÑ∏--\r\nhttps://files.catbox.moe/i5etcm.jpg\r\nËàî‰∏ÄÂè£--\r\nhttps://files.catbox.moe/p0vdxk.jpg\r\nÊä±Êä±--\r\nhttps://files.catbox.moe/qt4qzg.jpg\r\nÊâëËøáÊù•--\r\nhttps://files.catbox.moe/czdmyn.jpg\r\nÂ∞èÁãóÈ£ûÊâë--\r\nhttps://files.catbox.moe/9yz8nz.jpg\r\nÊª°ËÑ∏È™ÑÂÇ≤--\r\nhttps://files.catbox.moe/h1mf7j.jpg\r\nËπ¶Ëπ¶Ë∑≥Ë∑≥--\r\nhttps://files.catbox.moe/q6bahb.jpg\r\nÊ≥•ÈáåÊâìÊªö--\r\nhttps://files.catbox.moe/ofy8ic.jpg\r\nËπëÊâãËπëËÑö--\r\nhttps://files.catbox.moe/7mdkef.jpg\r\nÁ≠âÈ•≠È•≠--\r\nhttps://files.catbox.moe/ppi7e4.jpg\r\nÂÅ∑ÂêÉ--\r\nhttps://files.catbox.moe/ur7vh9.jpg\r\nËπ≠Ë£§ËÖø--\r\nhttps://files.catbox.moe/dzoxjx.jpg\r\nÊâìÂä´--\r\nhttps://files.catbox.moe/cz3umm.jpg\r\nÁî®Êû™ÊåáÁùÄ‰Ω†--\r\nhttps://files.catbox.moe/zvm5n2.jpg\r\nÂí¨Âí¨Âí¨Âí¨--\r\nhttps://files.catbox.moe/ogs4t5.jpg\r\nÊó†ÊÑè‰πâÁöÑÂêºÂè´--\r\nhttps://files.catbox.moe/0vetoe.jpg\r\nËæ£ÁúºÁùõ--\r\nhttps://files.catbox.moe/91c91h.jpg\r\nÂÜ∑Ê±óÂøÉËôöÁ¨ë--\r\nhttps://files.catbox.moe/nj0i5e.png\r\nÁäØÈîôÂêéÂøÉËôö--\r\nhttps://files.catbox.moe/rejhsf.jpg\r\nË£ÖÊó†Ëæú--\r\nhttps://files.catbox.moe/pdjeef.jpg\r\nÂ∞èÂøÉÁøºÁøº--\r\nhttps://files.catbox.moe/1mm5y1.jpg\r\nÂÆ≥Áæû--\r\nhttps://files.catbox.moe/rqtdfm.jpg\r\nË¶ÅÊéâÁúºÊ≥™‰∫Ü--\r\nhttps://files.catbox.moe/cdaxhk.jpg\r\nÂßîÂ±à--\r\nhttps://files.catbox.moe/r89k3c.jpg\r\nÁúºÂê´Ê≥™ÂÖâ--\r\nhttps://files.catbox.moe/yqwu7e.jpg\r\nÂì≠Âì≠--\r\nhttps://files.catbox.moe/a1518p.jpg\r\nÊÄ•Âì≠‰∫Ü--\r\nhttps://files.catbox.moe/wok7sq.jpg\r\nÊ∞îÂì≠‰∫Ü--\r\nhttps://files.catbox.moe/qfljha.jpg\r\nÁ¢óÈáåÊ≤°ÊúâÈ•≠--\r\nhttps://files.catbox.moe/i9682x.jpg\r\nËÄÅÂ©Ü‰Ω†ÂõûÊù•Âêß--\r\nhttps://files.catbox.moe/ge0bjd.jpg\r\nÂÆ≥ÊÄï--\r\nhttps://files.catbox.moe/k8mfa6.jpg\r\nÈúáÊÉäÁå´Áå´--\r\nhttps://files.catbox.moe/bhytrl.jpg\r\nÊÉäÂêìÂà∞Ê®°Á≥ä--\r\nhttps://files.catbox.moe/qdzxst.jpg\r\nÊúüÂæÖ--\r\nhttps://files.catbox.moe/mii353.jpg\r\nÁö±Áúâ--\r\nhttps://files.catbox.moe/785has.jpg\r\nÁîüÊ∞îÁû™‰Ω†--\r\nhttps://files.catbox.moe/mzoekx.jpg\r\nÊúâÁÇπÁîüÊ∞î--\r\nhttps://files.catbox.moe/evzdkv.jpg\r\nÂ§ßËÑëÁ©∫ÁôΩ--\r\nhttps://files.catbox.moe/jqnaxs.jpg\r\nÂ§ßËÑëCPUÁÉß‰∫Ü--\r\nhttps://files.catbox.moe/mrzvy0.gif\r\nÊé¢Â§¥Êé¢ËÑë--\r\nhttps://files.catbox.moe/6p8w3k.gif\r\nÂ∑≤ËÄÅÂÆû--\r\nhttps://files.catbox.moe/rv76c1.jpg\r\nÂπ≥ÈùôÂú∞Ê≠ª‰∫Ü--\r\nhttps://files.catbox.moe/dcm5f9.jpg\r\nË¢´ÊâìÊ≠ªÊÉπ--\r\nhttps://files.catbox.moe/qqibg1.jpg\r\nÁù°Â§ßËßâ--\r\nhttps://files.catbox.moe/pvbfg6.jpg\r\nÂúü‰∏ãÂ∫ßÈÅìÊ≠â--\r\nhttps://files.catbox.moe/qjnck3.jpg\r\nÂ≠§Áã¨‰ΩéËêΩÁãó--\r\nhttps://files.catbox.moe/z09102.jpg\r\n‰πñ‰πñÂΩìÁãó--\r\nhttps://files.catbox.moe/bgid0b.jpg\r\nÂèºÈ£üÁõÜÂ∞èÁãó--\r\nhttps://files.catbox.moe/o196se.jpg\r\nÊàòÊñóÂ∞èÁãó--\r\nhttps://files.catbox.moe/c5ccwc.jpg\r\nÊ±âÂ†°Â∞èÁãó--\r\nhttps://files.catbox.moe/prowke.jpg"; // ./src/ÁïåÈù¢/worldbook/ÁïåÈù¢Âü∫Êú¨ËÆæÁΩÆ.txt?raw
            var src_worldbook_raw_namespaceObject_0 =
                "[‰∏ãÈù¢ÊòØÂü∫Êú¨ËÆæÁΩÆ]\r\nÂ§ñÊ°ÜÈ¢úËâ≤=#810000\r\nÂÜÖÊ°ÜÈ¢úËâ≤=#1b1717\r\nÊ∞îÊ≥°È¢úËâ≤=#ffffff\r\n‰æßËæπÊåâÈíÆ=#ce1212\r\nËÅäÂ§©Â£ÅÁ∫∏=http://sharkpan.xyz/f/mM2SW/Screenshot_20250317_001012.jpg\r\nÊâãÊú∫Â£ÅÁ∫∏=ÊöÇÊó∂ËÆæÁΩÆ‰∏ç‰∫ÜÊâãÊú∫Â£ÅÁ∫∏\r\nÂèëÈÄÅÊ®°Âºè=1\r\n‰∏ñÁïå‰π¶ÁâàÊú¨=509"; // ./src/ÁïåÈù¢/index.ts
            // ËÅäÂ§©ÁïåÈù¢

            // Âä®ÊÄÅÁ©∫Èó¥

            // discord

            // ‰∏ñÁïå‰π¶

            /**
             * ÂéãÁº©ÂõæÁâáÂà∞ÊåáÂÆöÂ§ßÂ∞èÔºåÁ°Æ‰øùÂÖºÂÆπlocalStorageÂ≠òÂÇ®
             * @param {File} file - ÂõæÁâáÊñá‰ª∂
             * @param {number} maxSizeKB - ÊúÄÂ§ßÂ§ßÂ∞èÔºàKBÔºâÔºåÈªòËÆ§1024KB
             * @param {number} quality - ÂàùÂßãË¥®ÈáèÔºåÈªòËÆ§0.8
             * @returns {Promise<string>} - ÂéãÁº©ÂêéÁöÑbase64Â≠óÁ¨¶‰∏≤
             */
            function compressImage(file, maxSizeKB = 1024, quality = 0.8) {
                return new Promise((resolve, reject) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    
                    img.onload = function() {
                        // ËÆ°ÁÆóÁº©ÊîæÊØî‰æãÔºåÁ°Æ‰øùÂõæÁâá‰∏çËøáÂ§ß
                        const maxDimension = 800; // ÊúÄÂ§ßÂ∞∫ÂØ∏
                        let { width, height } = img;
                        
                        if (width > height) {
                            if (width > maxDimension) {
                                height = (height * maxDimension) / width;
                                width = maxDimension;
                            }
                        } else {
                            if (height > maxDimension) {
                                width = (width * maxDimension) / height;
                                height = maxDimension;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        // ÁªòÂà∂ÂõæÁâá
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // ÂéãÁº©ÂáΩÊï∞
                        function tryCompress(currentQuality) {
                            const compressedDataUrl = canvas.toDataURL('image/jpeg', currentQuality);
                            const sizeKB = (compressedDataUrl.length * 3/4) / 1024; // Á≤óÁï•‰º∞ÁÆóÂ§ßÂ∞è
                            
                            console.log(`ÂéãÁº©Ë¥®Èáè: ${currentQuality}, Â§ßÂ∞è: ${sizeKB.toFixed(2)}KB`);
                            
                            if (sizeKB <= maxSizeKB || currentQuality <= 0.1) {
                                console.log(`ÂéãÁº©ÂÆåÊàêÔºåÊúÄÁªàÂ§ßÂ∞è: ${sizeKB.toFixed(2)}KB`);
                                resolve(compressedDataUrl);
                            } else {
                                // ÈÄíÂΩíÈôç‰ΩéË¥®Èáè
                                tryCompress(currentQuality - 0.1);
                            }
                        }
                        
                        tryCompress(quality);
                    };
                    
                    img.onerror = () => {
                        reject(new Error('ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•'));
                    };
                    
                    // ËØªÂèñÊñá‰ª∂
                    const reader = new FileReader();
                    reader.onload = e => img.src = e.target.result;
                    reader.onerror = () => reject(new Error('Êñá‰ª∂ËØªÂèñÂ§±Ë¥•'));
                    reader.readAsDataURL(file);
                });
            }

            class MyINI {
                sections;
                autoSave;
                save;
                constructor() {
                    this.sections = {};
                    this.autoSave = "";
                }
                loadLines(lines) {
                    this.sections = {};
                    let currentSection = "";
                    for (const line of lines) {
                        const trimmed = line.trim();
                        if (trimmed.startsWith("[") && trimmed.endsWith("]")) {
                            currentSection = trimmed.slice(1, -1);
                        } else if (currentSection && trimmed.includes("=")) {
                            const [key, ...values] = trimmed.split("=");
                            const value = values.join("=").trim();
                            if (!this.sections[currentSection]) {
                                this.sections[currentSection] = {};
                            }
                            this.sections[currentSection][key.trim()] = value;
                        }
                    }
                    return Object.keys(this.sections).length > 0;
                }
                loadText(text) {
                    // Ê∑ªÂä†ÂèÇÊï∞Ê†°È™å
                    if (typeof text !== "string") {
                        console.error("Invalid text input");
                        return false;
                    }
                    // Â§ÑÁêÜ‰∏çÂêåÊç¢Ë°åÁ¨¶Âπ∂ËøáÊª§Á©∫Ë°å
                    const lines = text
                        .replace(/\r\n/g, "\n") // Áªü‰∏ÄÊç¢Ë°åÁ¨¶
                        .split(/\n+/)
                        .map((line) => line.trim())
                        .filter((line) => line.length > 0);
                    console.log("Parsed lines:", lines.length);
                    return this.loadLines(lines); // ‰ΩøÁî®thisË∞ÉÁî®Á±ªÊñπÊ≥ï
                }
                getAllSections() {
                    return Object.keys(this.sections);
                }
                getAllKeys(section) {
                    return this.sections[section]
                        ? Object.keys(this.sections[section])
                        : [];
                }
                readValue(section, key) {
                    return this.sections[section]?.[key] || "";
                }
                readValueDouble(section, key) {
                    const value = parseFloat(this.readValue(section, key));
                    return isNaN(value) ? -1 : value;
                }
                writeValue(section, key, value) {
                    if (!key) return false;
                    if (!this.sections[section]) {
                        this.sections[section] = {};
                    }
                    this.sections[section][key] = value.toString();
                    if (this.autoSave) {
                        this.save(this.autoSave);
                    }
                    return true;
                }
                getKeyByValue(section, value) {
                    const items = this.sections[section] || {};
                    return (
                        Object.keys(items).find(
                            (key) => items[key] === value,
                        ) || ""
                    );
                }
                containsKey(section) {
                    return section in this.sections;
                }
                removeSection(section) {
                    delete this.sections[section];
                    return true;
                }
                getAllText() {
                    let result = "";
                    for (const section of Object.keys(this.sections)) {
                        result += `\n[${section}]`;
                        const keyvalue = this.sections[section];
                        for (const key of Object.keys(keyvalue)) {
                            const value = keyvalue[key];
                            result += `\n${key}=${value}`;
                        }
                    }
                    result = result.trim();
                    return result;
                }
            }
            class worldbooktext {
                static list =
                    /* unused pure expression or super */ null &&
                    `[1-Ê†ºÂºèÂºÄÂ§¥]
Ê∑±Â∫¶=0
Á±ªÂûã=ÁªøÁÅØ
Ë¶ÜÁõñ=Áúü
ÂÖ≥ÈîÆËØç=/Êü•Áúã(.+?)Ê∂àÊÅØ/, ÂèëÈÄÅÊ∂àÊÅØ, ÂõûÂ§ç, /Áªô(.+?)ÂèëÊ∂àÊÅØ/, Âú®Áæ§ËÅä, Âä®ÊÄÅ, Á©∫Èó¥, discord, dc, ËÆ∫Âùõ, Â∏ñÂ≠ê, QQ, qq, ÊâãÊú∫
È°∫Â∫è=5560
[2-QQËÅäÂ§©]
Ê∑±Â∫¶=0
Á±ªÂûã=ÁªøÁÅØ
Ë¶ÜÁõñ=Áúü
ÂÖ≥ÈîÆËØç=/Êü•Áúã(.+?)Ê∂àÊÅØ/, ÂèëÈÄÅÊ∂àÊÅØ, ÂõûÂ§ç, /Áªô(.+?)ÂèëÊ∂àÊÅØ/, Âú®Áæ§ËÅä, Âä®ÊÄÅ, Á©∫Èó¥, discord, dc, ËÆ∫Âùõ, Â∏ñÂ≠ê, QQ, qq, ÊâãÊú∫
È°∫Â∫è=5561
[3-QQÁ©∫Èó¥]
Ê∑±Â∫¶=0
Á±ªÂûã=ÁªøÁÅØ
Ë¶ÜÁõñ=Áúü
ÂÖ≥ÈîÆËØç=Âä®ÊÄÅ, Á©∫Èó¥
È°∫Â∫è=5562
[4-discordËÆ∫Âùõ]
Ê∑±Â∫¶=0
Á±ªÂûã=ÁªøÁÅØ
Ë¶ÜÁõñ=Áúü
ÂÖ≥ÈîÆËØç=discord, dc, ËÆ∫Âùõ, Â∏ñÂ≠ê
È°∫Â∫è=5563
[999-Ê†ºÂºèÁªìÂ∞æ]
Ê∑±Â∫¶=0
Á±ªÂûã=ÁªøÁÅØ
Ë¶ÜÁõñ=Áúü
ÂÖ≥ÈîÆËØç=/Êü•Áúã(.+?)Ê∂àÊÅØ/, ÂèëÈÄÅÊ∂àÊÅØ, ÂõûÂ§ç, /Áªô(.+?)ÂèëÊ∂àÊÅØ/, Âú®Áæ§ËÅä, Âä®ÊÄÅ, Á©∫Èó¥, discord, dc, ËÆ∫Âùõ, Â∏ñÂ≠ê, QQ, qq, ÊâãÊú∫
È°∫Â∫è=5564`;
            }
            let random_head_list = new Array();
            let QQ_pages = new Array();
            let QQ_emoji = new Map();
            let QQ_CacheSendMsg = "";
            // let QQ_SetNoteName = '';
            let QQ_msgjson = {
                ÁßÅËÅä: {},
                Áæ§ËÅä: {},
            };
            let QQ_moment = /* unused pure expression or super */ null && [];
                    /**
             * ‰∏Ä‰∏™Áî®‰∫éËß£ÊûêÂíåÊìç‰ΩúÈîÆÂÄºÂØπÊ†ºÂºèÊñáÊú¨ÁöÑÈÄöÁî®ËÆæÁΩÆÁ±ª„ÄÇ
             * ÊîØÊåÅ‰ªéÊñáÊú¨Âä†ËΩΩËÆæÁΩÆÔºåËØªÂèñ/ÂÜôÂÖ•ÂÄºÔºå‰ª•ÂèäÂ§ÑÁêÜÂ∏¶Âå∫ÊÆµÁöÑÈÖçÁΩÆ„ÄÇ
             * @example
             * const settings = new QQ_Settings();
             * settings.loadText("[Character]\nname=Alice\nage=25");
             * const name = settings.readValue("Character", "name"); // "Alice"
             */
            class QQ_Settings {
                constructor() {
                    this.sections = {};
                }

                // ‰ªéÊñáÊú¨Âä†ËΩΩËÆæÁΩÆ
                loadText(text) {
                    this.sections = {};
                    let currentSection = "global";
                    const lines = text.split('\n');

                    for (const line of lines) {
                        const trimmedLine = line.trim();
                        if (trimmedLine.startsWith('[') && trimmedLine.endsWith(']')) {
                            currentSection = trimmedLine.substring(1, trimmedLine.length - 1);
                        } else if (trimmedLine.includes('=')) {
                            const parts = trimmedLine.split('=');
                            const key = parts[0].trim();
                            const value = parts.slice(1).join('=').trim();
                            this.writeValue(currentSection, key, value);
                        }
                    }
                }

                // Ëé∑ÂèñÊâÄÊúâÂå∫ÊÆµÁöÑÂêçÁß∞
                getAllSections() {
                    return Object.keys(this.sections);
                }

                // ÂÜôÂÖ•‰∏Ä‰∏™ÂÄº
                writeValue(section, key, value) {
                    if (!this.sections[section]) {
                        this.sections[section] = {};
                    }
                    this.sections[section][key] = value;
                }

                // ËØªÂèñ‰∏Ä‰∏™ÂÄº
                readValue(section, key) {
                    return this.sections[section] ? this.sections[section][key] : undefined;
                }

                // Â∞ÜËÆæÁΩÆËΩ¨Êç¢‰∏∫ÊñáÊú¨Ê†ºÂºè
                toText() {
                    let text = "";
                    for (const section in this.sections) {
                        if (section !== "global") {
                            text += `[${section}]\n`;
                        }
                        for (const key in this.sections[section]) {
                            text += `${key}=${this.sections[section][key]}\n`;
                        }
                        text += "\n";
                    }
                    return text;
                }
            }
            let QQ_NewMsg = {};
            let QQ_ReadStatus = {}; // Êñ∞Â¢ûÔºöËÆ∞ÂΩïÂ∑≤ËØªÁä∂ÊÄÅ

            // *** Êñ∞Â¢ûÔºöÂ∑≤ËØªÁä∂ÊÄÅÁÆ°ÁêÜÂäüËÉΩ ***
            const QQ_READ_STATUS_KEY = "QQ_Â∑≤ËØªÁä∂ÊÄÅÂ§á‰ªΩ";

            /**
             * ‰øùÂ≠òÂ∑≤ËØªÁä∂ÊÄÅÂà∞‰∏ñÁïå‰π¶
             */
            async function QQ_SaveReadStatus() {
                try {
                    if (!worldbook || !entries) {
                        console.warn('QQ_SaveReadStatus: worldbookÊú™ÂàùÂßãÂåñ');
                        return;
                    }
                    
                    const readStatusData = {
                        lastUpdate: Date.now(),
                        ÁßÅËÅä: {},
                        Áæ§ËÅä: {},
                        Âä®ÊÄÅ: QQ_ReadStatus.moment || 0
                    };
                    
                    // ‰øùÂ≠òÁßÅËÅäÂ∑≤ËØªÁä∂ÊÄÅ
                    for (const [name, data] of Object.entries(QQ_ReadStatus)) {
                        if (name === 'moment') continue;
                        
                        if (QQ_msgjson.ÁßÅËÅä[name]) {
                            readStatusData.ÁßÅËÅä[name] = {
                                lastReadTime: data.lastReadTime || 0,
                                lastReadIndex: data.lastReadIndex || 0
                            };
                        } else if (QQ_msgjson.Áæ§ËÅä[name]) {
                            readStatusData.Áæ§ËÅä[name] = {
                                lastReadTime: data.lastReadTime || 0,
                                lastReadIndex: data.lastReadIndex || 0
                            };
                        }
                    }
                    
                    // Êü•ÊâæÊàñÂàõÂª∫Â∑≤ËØªÁä∂ÊÄÅÊù°ÁõÆ
                    let readStatusEntry = entries.find(entry => 
                        entry.keys.includes(QQ_READ_STATUS_KEY)
                    );
                    
                    if (readStatusEntry) {
                        readStatusEntry.content = JSON.stringify(readStatusData, null, 2);
                    } else {
                        const newEntry = {
                            keys: [QQ_READ_STATUS_KEY],
                            content: JSON.stringify(readStatusData, null, 2),
                            enabled: true,
                            constant: true,
                            comment: "ÊâãÊú∫ÁïåÈù¢Â∑≤ËØªÁä∂ÊÄÅÂ§á‰ªΩ - Ëá™Âä®ÁîüÊàê",
                            depth: 0,
                            selectiveLogic: 0,
                            order: 9999
                        };
                        entries.push(newEntry);
                    }
                    
                    // ‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶
                    if (typeof saveWorldInfo === 'function') {
                        console.log('Ëß¶ÂèësaveWorldInfo‰øùÂ≠ò...');
                        await saveWorldInfo();
                    } else {
                        console.log('saveWorldInfoÂáΩÊï∞‰∏çÂèØÁî®Ôºå‰æùËµñSillyTavernËá™Âä®‰øùÂ≠òÊú∫Âà∂');
                    }
                    console.log('Â∑≤ËØªÁä∂ÊÄÅÂ∑≤‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶');
                    
                } catch (error) {
                    console.error('‰øùÂ≠òÂ∑≤ËØªÁä∂ÊÄÅÂ§±Ë¥•:', error);
                }
            }

            /**
             * ‰ªé‰∏ñÁïå‰π¶Âä†ËΩΩÂ∑≤ËØªÁä∂ÊÄÅ
             */
            async function QQ_LoadReadStatus() {
                try {
                    if (!worldbook || !entries) {
                        console.warn('QQ_LoadReadStatus: worldbookÊú™ÂàùÂßãÂåñ');
                        return;
                    }
                    
                    const readStatusEntry = entries.find(entry => 
                        entry.keys.includes(QQ_READ_STATUS_KEY)
                    );
                    
                    if (readStatusEntry && readStatusEntry.content) {
                        const readStatusData = JSON.parse(readStatusEntry.content);
                        
                        // ÊÅ¢Â§çÂ∑≤ËØªÁä∂ÊÄÅ
                        QQ_ReadStatus = {
                            moment: readStatusData.Âä®ÊÄÅ || 0
                        };
                        
                        // ÊÅ¢Â§çÁßÅËÅäÂ∑≤ËØªÁä∂ÊÄÅ
                        for (const [name, data] of Object.entries(readStatusData.ÁßÅËÅä || {})) {
                            QQ_ReadStatus[name] = {
                                lastReadTime: data.lastReadTime || 0,
                                lastReadIndex: data.lastReadIndex || 0
                            };
                        }
                        
                        // ÊÅ¢Â§çÁæ§ËÅäÂ∑≤ËØªÁä∂ÊÄÅ
                        for (const [name, data] of Object.entries(readStatusData.Áæ§ËÅä || {})) {
                            QQ_ReadStatus[name] = {
                                lastReadTime: data.lastReadTime || 0,
                                lastReadIndex: data.lastReadIndex || 0
                            };
                        }
                        
                        console.log('Â∑≤ËØªÁä∂ÊÄÅÂ∑≤‰ªé‰∏ñÁïå‰π¶Âä†ËΩΩ:', Object.keys(QQ_ReadStatus).length);
                    } else {
                        console.log('Êú™ÊâæÂà∞Â∑≤ËØªÁä∂ÊÄÅÂ§á‰ªΩÔºå‰ΩøÁî®ÈªòËÆ§Áä∂ÊÄÅ');
                        QQ_ReadStatus = { moment: 0 };
                    }
                    
                } catch (error) {
                    console.error('Âä†ËΩΩÂ∑≤ËØªÁä∂ÊÄÅÂ§±Ë¥•:', error);
                    QQ_ReadStatus = { moment: 0 };
                }
            }

            /**
             * Ê†áËÆ∞ËÅäÂ§©‰∏∫Â∑≤ËØª
             */
            function QQ_MarkAsRead(chatName, chatType = 'auto') {
                try {
                    if (!QQ_ReadStatus[chatName]) {
                        QQ_ReadStatus[chatName] = {};
                    }
                    
                    QQ_ReadStatus[chatName].lastReadTime = Date.now();
                    
                    // *** ‰øÆÂ§çÔºöÊ†πÊçÆËÅäÂ§©Á±ªÂûãËÆæÁΩÆÂ∑≤ËØªÁ¥¢Âºï ***
                    if (chatType === 'auto') {
                        // ÂÖàÊü•ÊâæÁßÅËÅä
                        const privateChatKey = Object.keys(QQ_msgjson.ÁßÅËÅä).find(key => 
                            key.includes(chatName) && key.includes(UserName)
                        );
                        
                        if (privateChatKey && QQ_msgjson.ÁßÅËÅä[privateChatKey]) {
                            QQ_ReadStatus[chatName].lastReadIndex = QQ_msgjson.ÁßÅËÅä[privateChatKey].length;
                            console.log(`ÁßÅËÅä ${chatName} Â∑≤ËØªÁ¥¢ÂºïËÆæÁΩÆ‰∏∫: ${QQ_ReadStatus[chatName].lastReadIndex}`);
                        } else if (QQ_msgjson.Áæ§ËÅä[chatName] && QQ_msgjson.Áæ§ËÅä[chatName].msgs) {
                            QQ_ReadStatus[chatName].lastReadIndex = QQ_msgjson.Áæ§ËÅä[chatName].msgs.length;
                            console.log(`Áæ§ËÅä ${chatName} Â∑≤ËØªÁ¥¢ÂºïËÆæÁΩÆ‰∏∫: ${QQ_ReadStatus[chatName].lastReadIndex}`);
                        }
                    }
                    
                    // Ê∏ÖÈô§Á∫¢ÁÇπ
                    QQ_NewMsg[chatName] = 0;
                    QQ_SetHomeTips(chatName, 0);
                    
                    console.log(`${chatName} Â∑≤Ê†áËÆ∞‰∏∫Â∑≤ËØªÔºåÂ∑≤ËØªÁä∂ÊÄÅ:`, QQ_ReadStatus[chatName]);
                    
                    // ÂºÇÊ≠•‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶
                    setTimeout(() => QQ_SaveReadStatus(), 1000);
                    
                } catch (error) {
                    console.error('Ê†áËÆ∞Â∑≤ËØªÁä∂ÊÄÅÂ§±Ë¥•:', error);
                }
            }

            /**
             * Ê£ÄÊü•Ê∂àÊÅØÊòØÂê¶‰∏∫Á≥ªÁªüÂàùÂßãÊ∂àÊÅØ
             */
            function QQ_IsInitialSystemMessage(message) {
                if (!message.startsWith('Á≥ªÁªüÊ∂àÊÅØ--')) {
                    return false;
                }
                
                const content = message.split('--')[1];
                if (!content) return false;
                
                // Ê£ÄÊü•ÊòØÂê¶‰∏∫ÂàùÂßãÁ≥ªÁªüÊ∂àÊÅØ
                return content.includes('ÂàõÂª∫ÊàêÂäü') || 
                       content.includes('Âä†ÂÖ•‰∫ÜÁæ§ËÅä') || 
                       /^\d{2}:\d{2}$/.test(content); // Êó∂Èó¥Ê∂àÊÅØ
            }

            /**
             * ËÆ°ÁÆóÊú™ËØªÊ∂àÊÅØÊï∞ÈáèÔºàÊéíÈô§ÂàùÂßãÁ≥ªÁªüÊ∂àÊÅØÔºâ
             */
            function QQ_CalculateUnreadCount(chatName, messages, chatType = 'private') {
                try {
                    if (!messages || messages.length === 0) {
                        return 0;
                    }
                    
                    const readStatus = QQ_ReadStatus[chatName];
                    let unreadCount = 0;
                    
                    // Â¶ÇÊûúÊ≤°ÊúâÂ∑≤ËØªËÆ∞ÂΩïÔºåÊâÄÊúâÈùûÂàùÂßãÁ≥ªÁªüÊ∂àÊÅØÈÉΩÁÆóÊú™ËØª
                    if (!readStatus || !readStatus.lastReadIndex) {
                        console.log(`${chatName} Ê≤°ÊúâÂ∑≤ËØªËÆ∞ÂΩïÔºåËÆ°ÁÆóÊâÄÊúâÊú™ËØªÊ∂àÊÅØ`);
                        for (const msg of messages) {
                            // Ë∑≥ËøáÂàùÂßãÁ≥ªÁªüÊ∂àÊÅØ
                            if (QQ_IsInitialSystemMessage(msg)) {
                                continue;
                            }
                            
                            // Ê£ÄÊü•ÊòØÂê¶‰∏∫Áî®Êà∑Ëá™Â∑±ÂèëÈÄÅÁöÑÊ∂àÊÅØ
                            const parts = msg.split('--');
                            if (parts.length >= 2 && parts[0] === `${UserName}`) {
                                continue; // Ë∑≥ËøáÁî®Êà∑Ëá™Â∑±ÁöÑÊ∂àÊÅØ
                            }
                            
                            unreadCount++;
                        }
                        console.log(`${chatName} ËÆ°ÁÆóÁªìÊûú: ${unreadCount} Êù°Êú™ËØªÊ∂àÊÅØ`);
                        return unreadCount;
                    }
                    
                    // Âü∫‰∫éÂ∑≤ËØªÁ¥¢ÂºïËÆ°ÁÆóÊú™ËØªÊ∂àÊÅØ
                    const lastReadIndex = readStatus.lastReadIndex;
                    console.log(`${chatName} ‰ΩøÁî®Â∑≤ËØªÁ¥¢Âºï ${lastReadIndex} ËÆ°ÁÆóÊú™ËØªÊ∂àÊÅØÔºåÊÄªÊ∂àÊÅØÊï∞: ${messages.length}`);
                    
                    for (let i = lastReadIndex; i < messages.length; i++) {
                        const msg = messages[i];
                        
                        // Ë∑≥ËøáÂàùÂßãÁ≥ªÁªüÊ∂àÊÅØ
                        if (QQ_IsInitialSystemMessage(msg)) {
                            continue;
                        }
                        
                        // Ê£ÄÊü•ÊòØÂê¶‰∏∫Áî®Êà∑Ëá™Â∑±ÂèëÈÄÅÁöÑÊ∂àÊÅØ
                        const parts = msg.split('--');
                        if (parts.length >= 2 && parts[0] === `${UserName}`) {
                            continue; // Ë∑≥ËøáÁî®Êà∑Ëá™Â∑±ÁöÑÊ∂àÊÅØ
                        }
                        
                        unreadCount++;
                    }
                    
                    console.log(`${chatName} Âü∫‰∫éÂ∑≤ËØªÁ¥¢ÂºïËÆ°ÁÆóÁªìÊûú: ${unreadCount} Êù°Êú™ËØªÊ∂àÊÅØ`);
                    return unreadCount;
                    
                } catch (error) {
                    console.error('ËÆ°ÁÆóÊú™ËØªÊ∂àÊÅØÊï∞ÈáèÂ§±Ë¥•:', error);
                    return 0;
                }
            }
            let Npc_Settings = {};
            let QQ_Groups = [];
            // Á°Æ‰øùQQ_Groups‰Ωú‰∏∫ÂÖ®Â±ÄÂèòÈáèÂèØËÆøÈóÆ
            window.QQ_Groups = QQ_Groups;
            
            // *** Êñ∞Â¢ûÔºöÁæ§ËÅäÂàùÂßãÊ∂àÊÅØÈò≤ÈáçÂ§çÊú∫Âà∂ ***
            let QQ_GroupInitializedSet = new Set(); // ËÆ∞ÂΩïÂ∑≤ÂàùÂßãÂåñËøáÂàùÂßãÊ∂àÊÅØÁöÑÁæ§ËÅä
            window.QQ_GroupInitializedSet = QQ_GroupInitializedSet;
            let gening;
            let worldbook;
            let entries;
            let newgen = true;
            let QQ_CharSettings = new MyINI();
            let Phone_Settings = new MyINI();
            // *** Êñ∞Â¢ûÔºöÂä®ÊÄÅÂÜÖÂÆπÊåÅ‰πÖÂåñÂ≠òÂÇ® ***
            let QQ_MomentsData = [];  // Â≠òÂÇ®ÊâÄÊúâÂä®ÊÄÅÂÜÖÂÆπÁöÑÊï∞ÁªÑ
            window.QQ_MomentsData = QQ_MomentsData;  // ËÆæ‰∏∫ÂÖ®Â±ÄÂèòÈáèÊñπ‰æøË∞ÉËØï
            
            // *** Êñ∞Â¢ûÔºöËÅäÂ§©Ê∂àÊÅØworldbookÂ§á‰ªΩÂ≠òÂÇ® ***
            let QQ_ChatBackup = {};  // ËÅäÂ§©Ê∂àÊÅØÁöÑworldbookÂ§á‰ªΩ
            window.QQ_ChatBackup = QQ_ChatBackup;  // ËÆæ‰∏∫ÂÖ®Â±ÄÂèòÈáèÊñπ‰æøË∞ÉËØï
            
            // *** Êñ∞Â¢ûÔºöÂàÜÈ°µÊòæÁ§∫ÈÖçÁΩÆ ***
            const MOMENTS_DISPLAY_LIMIT = 5;  // Âä®ÊÄÅÊòæÁ§∫‰∏äÈôê
            const CHAT_DISPLAY_LIMIT = 100;   // ËÅäÂ§©Ê∂àÊÅØÊòæÁ§∫‰∏äÈôê
            const CHAT_LOAD_INCREMENT = 50;   // ËÅäÂ§©Ê∂àÊÅØÊØèÊ¨°Âä†ËΩΩÊï∞Èáè
            const MOMENTS_LOAD_INCREMENT = 5; // Âä®ÊÄÅÊØèÊ¨°Âä†ËΩΩÊï∞Èáè
            
            // ÂàÜÈ°µÁä∂ÊÄÅ
            let momentsDisplayCount = 0;      // ÂΩìÂâçÊòæÁ§∫ÁöÑÂä®ÊÄÅÊï∞Èáè
            let chatDisplayCounts = {};       // ÂêÑ‰∏™ËÅäÂ§©ÁöÑÊòæÁ§∫Ê∂àÊÅØÊï∞Èáè
            let QQ_Music = {
                audio: new Audio(),
                lastelement: undefined, // ÂÖÅËÆ∏ undefined
                isLoading: false,
                // Êñ∞Â¢ûÂ∞ÅÈù¢ÁºìÂ≠ò
                cover: "",
            };
            let QQ_RandomHead = [];
            let NpcCssValue = "";
            let Variables = {};
            let UserName;
            let charAvatarPath;
            let userAvatarPath;
            let charcardname;
            let QQ_currentPage = "people"; // Ê∑ªÂä†È°µÈù¢Áä∂ÊÄÅË∑üË∏™
            let User_LastMsgMap = {
                Áæ§ËÅä: {},
                ÁßÅËÅä: {},
            };
            let Char_LastMsgMap = {
                Áæ§ËÅä: {},
                ÁßÅËÅä: {},
            };
            const version = "509";
            /**
             * Ë∞ÉÁî®ÂâçÁ´ØÂä©ÊâãÂáΩÊï∞
             */
            class ST {
                static async GetCurrentMessages() {
                    const CurrentMessageId = getCurrentMessageId();
                    const Messages = await getChatMessages(CurrentMessageId);
                    if (!Messages) {
                        console.log(`Ëé∑ÂèñÊ•ºÂ±ÇËÆ∞ÂΩïÂ§±Ë¥•`);
                        return "";
                    }
                    let msg = Messages[0].message;
                    return msg;
                }
                static async Gen(msg) {
                    console.log(`Ëß¶ÂèëÁîüÊàê  ${msg}`);
                    let result;
                    if (newgen) {
                        result = await generate({
                            user_input: msg,
                            should_stream: true,
                        });
                    } else {
                        result = await generate({
                            user_input: msg,
                            should_stream: false,
                        });
                    }
                    console.log(`ÁîüÊàêÁªìÊûú:${result}`);
                    return result;
                }
            }
            /**
             * Ëé∑ÂèñÊ∂àÊÅØ‰∏≠ÁöÑÂêçÁß∞
             * @param value Ê∂àÊÅØÂÜÖÂÆπ
             * @returns ÂêçÁß∞ÂàóË°®
             */
            function QQ_GetValueName(value) {
                let result = [];
                const lines = value.split(/\r?\n/);
                for (const line of lines) {
                    let match = line.match(/Âú®Áæ§ËÅä(.+)‰∏≠ÂèëÈÄÅ:(.+)/);
                    if (match) {
                        let obj = {
                            name: match[1],
                            value: match[2],
                        };
                        result.push(obj);
                        continue;
                    }
                    match = line.match(/Áªô(.+)ÂèëÊ∂àÊÅØ:(.+)/);
                    if (match) {
                        let obj = {
                            name: match[1],
                            value: match[2],
                        };
                        result.push(obj);
                        continue;
                    }
                    match = line.match(/ÂõûÂ§ç(.+):(.+)/);
                    if (match) {
                        let obj = {
                            name: match[1],
                            value: match[2],
                        };
                        result.push(obj);
                        continue;
                    }
                }
                return result;
            }
            /**
             * ÁîüÊàêÊ∂àÊÅØ
             * @param msg Ê∂àÊÅØÂÜÖÂÆπ
             * @returns ÁîüÊàêÁªìÊûú
             */
            async function QQ_Gen(msg) {
                console.log(`Ëß¶ÂèëÁîüÊàê  ${msg}`);
                let result;
                if (newgen) {
                    result = await generate({
                        user_input: msg,
                        should_stream: true,
                    });
                } else {
                    result = await generate({
                        user_input: msg,
                        should_stream: false,
                    });
                }
                console.log(`ÁîüÊàêÁªìÊûú:${result}`);
                return result;
            }
            /**
             * ‰øùÂ≠òÊ∂àÊÅØÔºàÂ¢ûÂº∫ÁâàÔºöÂéüÊúâÊú∫Âà∂ + worldbookÂ§á‰ªΩÔºâ
             * @returns
             */
            async function QQ_Save_Msg() {
                if (!QQ_msgjson) {
                    return;
                }
                
                // ÂéüÊúâ‰øùÂ≠òÊú∫Âà∂Ôºö‰øùÂ≠òÂà∞SillyTavernÊ∂àÊÅØÁ≥ªÁªü
                const CurrentMessageId = getCurrentMessageId();
                const Messages = await getChatMessages(CurrentMessageId);
                if (!Messages) {
                    console.log(`Ëé∑ÂèñÊ•ºÂ±ÇËÆ∞ÂΩïÂ§±Ë¥•`);
                    return;
                }
                let msg = Messages[0].message;
                const match = msg.match(/msg_start[\s\S]+?msg_end/);
                if (!match) {
                    console.log(`ÂåπÈÖçÊ•ºÂ±ÇËÆ∞ÂΩïÂ§±Ë¥•`);
                    return;
                }
                msg = msg.replace(
                    match[0],
                    `msg_start\n${QQ_Json2Text(QQ_msgjson)}\nmsg_end`,
                );
                setChatMessage({ message: msg }, CurrentMessageId, {
                    refresh: "none",
                });
                
                // *** Êñ∞Â¢ûÔºöworldbookÂ§á‰ªΩÊú∫Âà∂ ***
                console.log('ÂºÄÂßãËÅäÂ§©Ê∂àÊÅØworldbookÂ§á‰ªΩ...');
                await QQ_Save_Chat_Backup();
            }
            
            /**
             * *** Êñ∞Â¢ûÔºö‰øùÂ≠òËÅäÂ§©Ê∂àÊÅØÂà∞worldbookÂ§á‰ªΩ ***
             * @returns
             */
            async function QQ_Save_Chat_Backup() {
                if (!worldbook || !entries || !QQ_msgjson) {
                    console.log('ËÅäÂ§©Â§á‰ªΩË∑≥ËøáÔºöÁº∫Â∞ëworldbookÊàñentriesÊàñËÅäÂ§©Êï∞ÊçÆ');
                    return;
                }
                
                try {
                    // *** Êñ∞Â¢ûÔºöÂú®‰øùÂ≠òÂâçÊ∏ÖÁêÜËøáÊúüÊ∂àÊÅØÊï∞ÊçÆÂíåÁ≥ªÁªüÊ∂àÊÅØ ***
                    const cleanedMsgjson = JSON.parse(JSON.stringify(QQ_msgjson)); // Ê∑±Êã∑Ë¥ùÈÅøÂÖç‰øÆÊîπÂéüÊï∞ÊçÆ
                    
                    // Ê∏ÖÁêÜËøáÊúüÊ∂àÊÅØ
                    QQ_CleanOldChatMessages(cleanedMsgjson);
                    
                    // *** Êñ∞Â¢ûÔºöÊéíÈô§Á≥ªÁªüÊ∂àÊÅØ ***
                    if (cleanedMsgjson.ÁßÅËÅä) {
                        for (const chatKey in cleanedMsgjson.ÁßÅËÅä) {
                            if (Array.isArray(cleanedMsgjson.ÁßÅËÅä[chatKey])) {
                                cleanedMsgjson.ÁßÅËÅä[chatKey] = cleanedMsgjson.ÁßÅËÅä[chatKey].filter(msg => 
                                    !msg.startsWith('Á≥ªÁªüÊ∂àÊÅØ--')
                                );
                            }
                        }
                    }
                    
                    if (cleanedMsgjson.Áæ§ËÅä) {
                        for (const groupKey in cleanedMsgjson.Áæ§ËÅä) {
                            const group = cleanedMsgjson.Áæ§ËÅä[groupKey];
                            if (group && Array.isArray(group.msgs)) {
                                group.msgs = group.msgs.filter(msg => 
                                    !msg.startsWith('Á≥ªÁªüÊ∂àÊÅØ--')
                                );
                            }
                        }
                    }
                    
                    // ÂàõÂª∫Â§á‰ªΩÊï∞ÊçÆÁªìÊûÑÔºåÂåÖÂê´Êó∂Èó¥Êà≥ÂíåÂÆåÊï¥ËÅäÂ§©Êï∞ÊçÆ
                    QQ_ChatBackup = {
                        lastUpdated: new Date().toISOString(),
                        data: cleanedMsgjson,  // ‰ΩøÁî®Ê∏ÖÁêÜÂêéÁöÑÊï∞ÊçÆÔºàÂ∑≤ÊéíÈô§Á≥ªÁªüÊ∂àÊÅØÔºâ
                        version: version || "unknown"
                    };
                    
                    // Êü•ÊâæÊàñÂàõÂª∫ËÅäÂ§©Â§á‰ªΩÊù°ÁõÆ
                    let chatBackupEntry = entries.find(entry => entry.comment === "ÊâãÊú∫-ËÅäÂ§©Ê∂àÊÅØÂ§á‰ªΩ");
                    
                    const backupJson = JSON.stringify(QQ_ChatBackup, null, 2);
                    
                    // ÁªüËÆ°Ë¶ÅÂ§á‰ªΩÁöÑÊ∂àÊÅØÊï∞ÈáèÔºàÊéíÈô§Á≥ªÁªüÊ∂àÊÅØÔºâ
                    let totalUserMessages = 0;
                    let totalPrivateChats = 0;
                    let totalGroupChats = 0;
                    
                    if (cleanedMsgjson.ÁßÅËÅä) {
                        for (const chatKey in cleanedMsgjson.ÁßÅËÅä) {
                            if (Array.isArray(cleanedMsgjson.ÁßÅËÅä[chatKey]) && cleanedMsgjson.ÁßÅËÅä[chatKey].length > 0) {
                                totalPrivateChats++;
                                totalUserMessages += cleanedMsgjson.ÁßÅËÅä[chatKey].length;
                            }
                        }
                    }
                    
                    if (cleanedMsgjson.Áæ§ËÅä) {
                        for (const groupKey in cleanedMsgjson.Áæ§ËÅä) {
                            const group = cleanedMsgjson.Áæ§ËÅä[groupKey];
                            if (group && Array.isArray(group.msgs) && group.msgs.length > 0) {
                                totalGroupChats++;
                                totalUserMessages += group.msgs.length;
                            }
                        }
                    }
                    
                    console.log('ÂáÜÂ§áÂ§á‰ªΩËÅäÂ§©Ê∂àÊÅØ:', totalPrivateChats, '‰∏™ÁßÅËÅä,', totalGroupChats, '‰∏™Áæ§ËÅä, ÂÖ±', totalUserMessages, 'Êù°Áî®Êà∑ÂØπËØùÊ∂àÊÅØÔºàÂ∑≤ÊéíÈô§Á≥ªÁªüÊ∂àÊÅØÔºâ');
                    
                    if (chatBackupEntry) {
                        // Êõ¥Êñ∞Áé∞ÊúâÊù°ÁõÆ
                        await setLorebookEntries(worldbook, [{
                            uid: chatBackupEntry.uid,
                            content: backupJson,
                        }]);
                        console.log('ËÅäÂ§©Ê∂àÊÅØÂ∑≤Êõ¥Êñ∞Âà∞Áé∞ÊúâworldbookÂ§á‰ªΩÊù°ÁõÆ');
                    } else {
                        // ÂàõÂª∫Êñ∞Êù°ÁõÆ
                        await createLorebookEntry(worldbook, {
                            comment: "ÊâãÊú∫-ËÅäÂ§©Ê∂àÊÅØÂ§á‰ªΩ",
                            key: ["Ê≠§‰∏ñÁïå‰π¶Ê∞∏‰∏çËß¶Âèë_ËÅäÂ§©Â§á‰ªΩ"],
                            content: backupJson,
                            position: "at_depth_as_system", 
                            type: "selective",
                            depth: 0,
                            exclude_recursion: true,
                            order: 9998,  // ÊØîÂä®ÊÄÅÂ≠òÂÇ®‰ºòÂÖàÁ∫ßÁ®çÈ´ò
                            enabled: true,
                        });
                        console.log('ËÅäÂ§©Ê∂àÊÅØÂ∑≤‰øùÂ≠òÂà∞Êñ∞worldbookÂ§á‰ªΩÊù°ÁõÆ');
                        
                        // ÈáçÊñ∞Ëé∑Âèñentries‰ª•ÂåÖÂê´Êñ∞ÂàõÂª∫ÁöÑÊù°ÁõÆ
                        entries = await getLorebookEntries(worldbook);
                    }
                } catch (error) {
                    console.error('ËÅäÂ§©Ê∂àÊÅØÂ§á‰ªΩÂ§±Ë¥•:', error);
                }
            }

            /**
             * *** Êñ∞Â¢ûÔºö‰øùÂ≠òÂä®ÊÄÅÂÜÖÂÆπÂà∞worldbook ***
             * @returns
             */
            async function QQ_Save_Moments() {
                if (!worldbook || !entries || QQ_MomentsData.length === 0) {
                    console.log('Âä®ÊÄÅ‰øùÂ≠òË∑≥ËøáÔºöÁº∫Â∞ëworldbookÊàñentriesÊàñÊó†Âä®ÊÄÅÊï∞ÊçÆ');
                    return;
                }
                
                try {
                    // *** Êñ∞Â¢ûÔºöÊ∏ÖÁêÜËøáÊúüÂä®ÊÄÅÂíåËØÑËÆ∫Ôºà‰øùÁïôÊúÄËøë50Êù°Âä®ÊÄÅÔºåÊØè‰∏™Âä®ÊÄÅ50Êù°ËØÑËÆ∫Ôºâ ***
                    QQ_CleanOldMoments();
                    
                    // *** Êñ∞Â¢ûÔºö‰ºòÂåñËØÑËÆ∫Â≠òÂÇ®ÔºåÁ°Æ‰øùËØÑËÆ∫Ë¥®Èáè ***
                    QQ_OptimizeCommentsStorage();
                    
                    // Êü•ÊâæÊàñÂàõÂª∫Âä®ÊÄÅÂ≠òÂÇ®Êù°ÁõÆ
                    let momentEntry = entries.find(entry => entry.comment === "ÊâãÊú∫-Âä®ÊÄÅÂÜÖÂÆπÂ≠òÂÇ®");
                    
                    // *** Êñ∞Â¢ûÔºöÁªüËÆ°ËØÑËÆ∫‰ø°ÊÅØ ***
                    let totalComments = 0;
                    let momentsWithComments = 0;
                    if (QQ_MomentsData && Array.isArray(QQ_MomentsData)) {
                        QQ_MomentsData.forEach(moment => {
                            if (moment.comments && moment.comments.length > 0) {
                                totalComments += moment.comments.length;
                                momentsWithComments++;
                            }
                        });
                    }
                    
                    const momentsJson = JSON.stringify(QQ_MomentsData, null, 2);
                    console.log(`ÂáÜÂ§á‰øùÂ≠òÂä®ÊÄÅÂÜÖÂÆπ: ${QQ_MomentsData.length}Êù°Âä®ÊÄÅ, ${totalComments}Êù°ËØÑËÆ∫ (${momentsWithComments}‰∏™Âä®ÊÄÅÊúâËØÑËÆ∫)`);
                    
                    if (momentEntry) {
                        // Êõ¥Êñ∞Áé∞ÊúâÊù°ÁõÆ
                        await setLorebookEntries(worldbook, [{
                            uid: momentEntry.uid,
                            content: momentsJson,
                        }]);
                        console.log('Âä®ÊÄÅÂÜÖÂÆπÂ∑≤Êõ¥Êñ∞Âà∞Áé∞ÊúâworldbookÊù°ÁõÆ');
                    } else {
                        // ÂàõÂª∫Êñ∞Êù°ÁõÆ
                        await createLorebookEntry(worldbook, {
                            comment: "ÊâãÊú∫-Âä®ÊÄÅÂÜÖÂÆπÂ≠òÂÇ®",
                            key: ["Ê≠§‰∏ñÁïå‰π¶Ê∞∏‰∏çËß¶Âèë_Âä®ÊÄÅÂ≠òÂÇ®"],
                            content: momentsJson,
                            position: "at_depth_as_system",
                            type: "selective",
                            depth: 0,
                            exclude_recursion: true,
                            order: 9999,
                            enabled: true,
                        });
                        console.log('Âä®ÊÄÅÂÜÖÂÆπÂ∑≤‰øùÂ≠òÂà∞Êñ∞worldbookÊù°ÁõÆ');
                        
                        // ÈáçÊñ∞Ëé∑Âèñentries‰ª•ÂåÖÂê´Êñ∞ÂàõÂª∫ÁöÑÊù°ÁõÆ
                        entries = await getLorebookEntries(worldbook);
                    }
                } catch (error) {
                    console.error('‰øùÂ≠òÂä®ÊÄÅÂÜÖÂÆπÂ§±Ë¥•:', error);
                }
            }

            /**
             * *** Êñ∞Â¢ûÔºöÊ∏ÖÁêÜËøáÊúüÂä®ÊÄÅÂÜÖÂÆπÂíåËØÑËÆ∫ ***
             */
            function QQ_CleanOldMoments() {
                const MAX_MOMENTS = 50; // ÊúÄÂ§ö‰øùÁïô50Êù°Âä®ÊÄÅ
                const MAX_COMMENTS_PER_MOMENT = 50; // ÊØè‰∏™Âä®ÊÄÅÊúÄÂ§ö‰øùÁïô50Êù°ËØÑËÆ∫
                
                if (!QQ_MomentsData || !Array.isArray(QQ_MomentsData)) {
                    console.warn('QQ_CleanOldMoments: QQ_MomentsData‰∏çÂ≠òÂú®Êàñ‰∏çÊòØÊï∞ÁªÑ');
                    return;
                }
                
                let totalCleanedComments = 0;
                
                // Ê∏ÖÁêÜÊØè‰∏™Âä®ÊÄÅÁöÑËØÑËÆ∫Êï∞Èáè
                if (QQ_MomentsData && Array.isArray(QQ_MomentsData)) {
                    QQ_MomentsData.forEach(moment => {
                    if (moment.comments && moment.comments.length > MAX_COMMENTS_PER_MOMENT) {
                        // ÊåâÊó∂Èó¥Êà≥ÊéíÂ∫èÔºå‰øùÁïôÊúÄÊñ∞ÁöÑËØÑËÆ∫
                        moment.comments.sort((a, b) => {
                            return new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime();
                        });
                        
                        const removedComments = moment.comments.length - MAX_COMMENTS_PER_MOMENT;
                        moment.comments.splice(MAX_COMMENTS_PER_MOMENT);
                        totalCleanedComments += removedComments;
                        
                        console.log(`Âä®ÊÄÅ${moment.id}Ê∏ÖÁêÜ‰∫Ü${removedComments}Êù°ËØÑËÆ∫Ôºå‰øùÁïô${moment.comments.length}Êù°`);
                    }
                });
                }
                
                // Ê∏ÖÁêÜÂä®ÊÄÅÊï∞Èáè
                if (QQ_MomentsData.length > MAX_MOMENTS) {
                    // ÊåâÊó∂Èó¥Êà≥ÊéíÂ∫èÔºå‰øùÁïôÊúÄÊñ∞ÁöÑÂä®ÊÄÅ
                    QQ_MomentsData.sort((a, b) => {
                        return new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime();
                    });
                    
                    const removedCount = QQ_MomentsData.length - MAX_MOMENTS;
                    QQ_MomentsData.splice(MAX_MOMENTS);
                    
                    console.log(`Ê∏ÖÁêÜ‰∫Ü ${removedCount} Êù°ËøáÊúüÂä®ÊÄÅÔºåÂΩìÂâç‰øùÁïô ${QQ_MomentsData.length} Êù°Âä®ÊÄÅ`);
                }
                
                if (totalCleanedComments > 0) {
                    console.log(`ÊÄªÂÖ±Ê∏ÖÁêÜ‰∫Ü ${totalCleanedComments} Êù°ËøáÊúüËØÑËÆ∫`);
                }
            }

            /**
             * *** Êñ∞Â¢ûÔºö‰ºòÂåñËØÑËÆ∫Â≠òÂÇ®Ë¥®Èáè ***
             */
            function QQ_OptimizeCommentsStorage() {
                if (!QQ_MomentsData || !Array.isArray(QQ_MomentsData)) {
                    console.warn('QQ_OptimizeCommentsStorage: QQ_MomentsData‰∏çÂ≠òÂú®Êàñ‰∏çÊòØÊï∞ÁªÑ');
                    return;
                }
                
                let totalOptimized = 0;
                
                if (QQ_MomentsData && Array.isArray(QQ_MomentsData)) {
                    QQ_MomentsData.forEach(moment => {
                    if (moment.comments && moment.comments.length > 0) {
                        const originalLength = moment.comments.length;
                        
                        // ÂéªÈáçÂ§çËØÑËÆ∫ÔºàÂü∫‰∫éÂÜÖÂÆπÂíåÂèëÈÄÅËÄÖÔºâ
                        const uniqueComments = [];
                        const seen = new Set();
                        
                        for (const comment of moment.comments) {
                            const key = `${comment.name}:${comment.content}`;
                            if (!seen.has(key)) {
                                seen.add(key);
                                uniqueComments.push(comment);
                            }
                        }
                        
                        // ËøáÊª§Á©∫ËØÑËÆ∫ÊàñÊó†ÊïàËØÑËÆ∫
                        const validComments = uniqueComments.filter(comment => 
                            comment.name && 
                            comment.content && 
                            comment.content.trim().length > 0 &&
                            comment.content.trim() !== '...' &&
                            comment.content.trim() !== '„ÄÇ„ÄÇ„ÄÇ'
                        );
                        
                        // ÊåâÊó∂Èó¥ÊéíÂ∫èÔºàÁ°Æ‰øùÊñ∞ËØÑËÆ∫Âú®ÂêéÈù¢Ôºâ
                        validComments.sort((a, b) => {
                            return new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime();
                        });
                        
                        moment.comments = validComments;
                        
                        const optimizedCount = originalLength - validComments.length;
                        if (optimizedCount > 0) {
                            totalOptimized += optimizedCount;
                            console.log(`Âä®ÊÄÅ${moment.id}‰ºòÂåñ‰∫Ü${optimizedCount}Êù°ËØÑËÆ∫ÔºàÂéªÈáçÂíåÊ∏ÖÁêÜÊó†ÊïàËØÑËÆ∫Ôºâ`);
                        }
                    }
                });
                }
                
                if (totalOptimized > 0) {
                    console.log(`ËØÑËÆ∫Â≠òÂÇ®‰ºòÂåñÂÆåÊàêÔºåÊÄªÂÖ±‰ºòÂåñ‰∫Ü ${totalOptimized} Êù°ËØÑËÆ∫`);
                }
            }
            
            /**
             * *** Êñ∞Â¢ûÔºöÊ∏ÖÁêÜËøáÊúüËÅäÂ§©Ê∂àÊÅØÊï∞ÊçÆ ***
             */
            function QQ_CleanOldChatMessages(msgjsonData) {
                const MAX_DAYS = 30; // ÊúÄÂ§ö‰øùÁïô30Â§©ÁöÑËÅäÂ§©ËÆ∞ÂΩï
                const cutoffTime = Date.now() - (MAX_DAYS * 24 * 60 * 60 * 1000);
                
                try {
                    let totalCleaned = 0;
                    
                    // *** ‰øÆÂ§çÔºöÊ∏ÖÁêÜÁßÅËÅäÊ∂àÊÅØÔºàÊ∂àÊÅØÊ†ºÂºèÔºö"ÂèëÈÄÅËÄÖ--ÂÜÖÂÆπ--Êó∂Èó¥"Ôºâ ***
                    if (msgjsonData.ÁßÅËÅä) {
                        for (const chatKey in msgjsonData.ÁßÅËÅä) {
                            const chat = msgjsonData.ÁßÅËÅä[chatKey];
                            if (Array.isArray(chat)) {
                                const originalLength = chat.length;
                                // ËøáÊª§ÊéâËøáÊúüÊ∂àÊÅØÔºàÂü∫‰∫éÊó∂Èó¥Êà≥Ôºâ
                                msgjsonData.ÁßÅËÅä[chatKey] = chat.filter(msg => {
                                    if (typeof msg === 'string' && msg.includes('--')) {
                                        const parts = msg.split('--');
                                        if (parts.length >= 3) {
                                            // Â∞ùËØïËß£ÊûêÊó∂Èó¥Êà≥
                                            try {
                                                const timeStr = parts[2];
                                                const msgTime = new Date(timeStr).getTime();
                                                if (!isNaN(msgTime)) {
                                                    return msgTime >= cutoffTime;
                                                }
                                            } catch (e) {
                                                // Êó∂Èó¥Ëß£ÊûêÂ§±Ë¥•Ôºå‰øùÁïôÊ∂àÊÅØ
                                            }
                                        }
                                    }
                                    // Â¶ÇÊûúÊ≤°ÊúâÊó∂Èó¥Êà≥ÊàñÊ†ºÂºèÂºÇÂ∏∏Ôºå‰øùÁïôÊ∂àÊÅØÔºàÈÅøÂÖçËØØÂà†Ôºâ
                                    return true;
                                });
                                
                                const cleanedCount = originalLength - msgjsonData.ÁßÅËÅä[chatKey].length;
                                if (cleanedCount > 0) {
                                    totalCleaned += cleanedCount;
                                    console.log(`ÁßÅËÅä${chatKey}Ê∏ÖÁêÜ‰∫Ü${cleanedCount}Êù°ËøáÊúüÊ∂àÊÅØ`);
                                }
                                
                                // Â¶ÇÊûúÁßÅËÅäËÆ∞ÂΩï‰∏∫Á©∫ÔºåÂà†Èô§Êï¥‰∏™ÁßÅËÅä
                                if (msgjsonData.ÁßÅËÅä[chatKey].length === 0) {
                                    delete msgjsonData.ÁßÅËÅä[chatKey];
                                }
                            }
                        }
                    }
                    
                    // *** ‰øÆÂ§çÔºöÊ∏ÖÁêÜÁæ§ËÅäÊ∂àÊÅØÔºàÊ∂àÊÅØÂú®group.msgsÊï∞ÁªÑ‰∏≠Ôºâ ***
                    if (msgjsonData.Áæ§ËÅä) {
                        for (const groupKey in msgjsonData.Áæ§ËÅä) {
                            const group = msgjsonData.Áæ§ËÅä[groupKey];
                            if (group && Array.isArray(group.msgs)) {
                                const originalLength = group.msgs.length;
                                // ËøáÊª§ÊéâËøáÊúüÊ∂àÊÅØ
                                group.msgs = group.msgs.filter(msg => {
                                    if (typeof msg === 'string' && msg.includes('--')) {
                                        const parts = msg.split('--');
                                        if (parts.length >= 3) {
                                            // Â∞ùËØïËß£ÊûêÊó∂Èó¥Êà≥
                                            try {
                                                const timeStr = parts[2];
                                                const msgTime = new Date(timeStr).getTime();
                                                if (!isNaN(msgTime)) {
                                                    return msgTime >= cutoffTime;
                                                }
                                            } catch (e) {
                                                // Êó∂Èó¥Ëß£ÊûêÂ§±Ë¥•Ôºå‰øùÁïôÊ∂àÊÅØ
                                            }
                                        }
                                    }
                                    // Â¶ÇÊûúÊ≤°ÊúâÊó∂Èó¥Êà≥ÊàñÊ†ºÂºèÂºÇÂ∏∏Ôºå‰øùÁïôÊ∂àÊÅØÔºàÈÅøÂÖçËØØÂà†Ôºâ
                                    return true;
                                });
                                
                                const cleanedCount = originalLength - group.msgs.length;
                                if (cleanedCount > 0) {
                                    totalCleaned += cleanedCount;
                                    console.log(`Áæ§ËÅä${groupKey}Ê∏ÖÁêÜ‰∫Ü${cleanedCount}Êù°ËøáÊúüÊ∂àÊÅØ`);
                                }
                                
                                // Â¶ÇÊûúÁæ§ËÅäËÆ∞ÂΩï‰∏∫Á©∫ÔºåÂà†Èô§Êï¥‰∏™Áæ§ËÅä
                                if (group.msgs.length === 0) {
                                    delete msgjsonData.Áæ§ËÅä[groupKey];
                                }
                            }
                        }
                    }
                    
                    if (totalCleaned > 0) {
                        console.log(`ÊÄªÂÖ±Ê∏ÖÁêÜ‰∫Ü ${totalCleaned} Êù°Ë∂ÖËøá${MAX_DAYS}Â§©ÁöÑËÅäÂ§©Ê∂àÊÅØ`);
                    }
                } catch (error) {
                    console.error('Ê∏ÖÁêÜËÅäÂ§©Ê∂àÊÅØÊó∂Âá∫Èîô:', error);
                }
            }
            
            /**
             * *** Êñ∞Â¢ûÔºöÊ∏ÖÁêÜËøáÊúüËÅäÂ§©Ê∂àÊÅØÂ§á‰ªΩ ***
             */
            function QQ_CleanOldChatBackup() {
                const MAX_DAYS = 30; // ÊúÄÂ§ö‰øùÁïô30Â§©ÁöÑËÅäÂ§©ËÆ∞ÂΩï
                const cutoffTime = Date.now() - (MAX_DAYS * 24 * 60 * 60 * 1000);
                
                try {
                    // Ê∏ÖÁêÜQQ_ChatBackup‰∏≠ÁöÑËøáÊúüÊï∞ÊçÆ
                    let cleanedCount = 0;
                    
                    for (const chatId in QQ_ChatBackup) {
                        const chatData = QQ_ChatBackup[chatId];
                        if (chatData && chatData.lastUpdated) {
                            // Ê£ÄÊü•ÊúÄÂêéÊõ¥Êñ∞Êó∂Èó¥
                            if (new Date(chatData.lastUpdated).getTime() < cutoffTime) {
                                delete QQ_ChatBackup[chatId];
                                cleanedCount++;
                            } else if (chatData.messages) {
                                // Ê∏ÖÁêÜËÅäÂ§©ËÆ∞ÂΩï‰∏≠ÁöÑËøáÊúüÊ∂àÊÅØ
                                const originalCount = Object.keys(chatData.messages).length;
                                
                                for (const msgKey in chatData.messages) {
                                    const msg = chatData.messages[msgKey];
                                    if (msg && msg.timestamp) {
                                        const msgTime = new Date(msg.timestamp).getTime();
                                        if (msgTime < cutoffTime) {
                                            delete chatData.messages[msgKey];
                                        }
                                    }
                                }
                                
                                const remainingCount = Object.keys(chatData.messages).length;
                                if (remainingCount === 0) {
                                    // Â¶ÇÊûúËÅäÂ§©ËÆ∞ÂΩïÂÖ®ÈÉ®ËøáÊúüÔºåÂà†Èô§Êï¥‰∏™ËÅäÂ§©
                                    delete QQ_ChatBackup[chatId];
                                    cleanedCount++;
                                } else if (remainingCount < originalCount) {
                                    console.log(`ËÅäÂ§©${chatId}Ê∏ÖÁêÜ‰∫Ü${originalCount - remainingCount}Êù°ËøáÊúüÊ∂àÊÅØ`);
                                }
                            }
                        }
                    }
                    
                    if (cleanedCount > 0) {
                        console.log(`Ê∏ÖÁêÜ‰∫Ü ${cleanedCount} ‰∏™ËøáÊúüËÅäÂ§©Â§á‰ªΩ`);
                    }
                } catch (error) {
                    console.error('Ê∏ÖÁêÜËÅäÂ§©Â§á‰ªΩÊó∂Âá∫Èîô:', error);
                }
            }
            
            /**
             * *** Êñ∞Â¢ûÔºöÊâãÂä®Âº∫Âà∂ÊÅ¢Â§çËÅäÂ§©Â§á‰ªΩÔºàË∞ÉËØïÁî®Ôºâ ***
             * ÂèØÂú®ÊéßÂà∂Âè∞Ë∞ÉÁî® window.QQ_Force_Restore_Chat() Êù•Âº∫Âà∂ÊÅ¢Â§çÂ§á‰ªΩ
             */
            window.QQ_Force_Restore_Chat = async function() {
                console.log('ÂºÄÂßãÂº∫Âà∂ÊÅ¢Â§çËÅäÂ§©Â§á‰ªΩ...');
                const restored = await QQ_Load_Chat_Backup();
                if (restored) {
                    console.log('Âº∫Âà∂ÊÅ¢Â§çÊàêÂäüÔºåÊ≠£Âú®ÈáçÊñ∞‰øùÂ≠òÂà∞Ê∂àÊÅØÁ≥ªÁªü...');
                    await QQ_Save_Msg();
                    console.log('Âº∫Âà∂ÊÅ¢Â§çÂÆåÊàêÔºÅ');
                    return true;
                } else {
                    console.log('Ê≤°ÊúâÂèØÁî®ÁöÑÂ§á‰ªΩÊï∞ÊçÆÊàñÂ§á‰ªΩÊï∞ÊçÆ‰∏çÂ§üÊñ∞');
                    return false;
                }
            };

            /**
             * *** Êñ∞Â¢ûÔºöÊü•ÁúãÂä®ÊÄÅÂ§á‰ªΩÁªüËÆ°‰ø°ÊÅØÔºàË∞ÉËØïÁî®Ôºâ ***
             * ÂèØÂú®ÊéßÂà∂Âè∞Ë∞ÉÁî® window.QQ_Show_Moments_Stats() Êù•Êü•ÁúãÁªüËÆ°
             */
            window.QQ_Show_Moments_Stats = function() {
                console.log('=== Âä®ÊÄÅÂ§á‰ªΩÁªüËÆ°‰ø°ÊÅØ ===');
                
                if (!QQ_MomentsData || !Array.isArray(QQ_MomentsData)) {
                    console.log('‚ö†Ô∏è QQ_MomentsData‰∏çÂ≠òÂú®Êàñ‰∏çÊòØÊï∞ÁªÑ');
                    return {
                        totalMoments: 0,
                        totalComments: 0,
                        momentsWithComments: 0,
                        maxComments: 0,
                        minComments: 0
                    };
                }
                
                console.log(`ÊÄªÂä®ÊÄÅÊï∞Èáè: ${QQ_MomentsData.length}`);
                
                let totalComments = 0;
                let momentsWithComments = 0;
                let maxComments = 0;
                let minComments = Infinity;
                
                QQ_MomentsData.forEach((moment, index) => {
                    const commentCount = moment.comments ? moment.comments.length : 0;
                    totalComments += commentCount;
                    
                    if (commentCount > 0) {
                        momentsWithComments++;
                        maxComments = Math.max(maxComments, commentCount);
                        minComments = Math.min(minComments, commentCount);
                    }
                    
                    console.log(`Âä®ÊÄÅ${index + 1} [${moment.userName}]: ${commentCount}Êù°ËØÑËÆ∫`);
                });
                
                if (momentsWithComments === 0) {
                    minComments = 0;
                }
                
                console.log(`\n=== ËØÑËÆ∫ÁªüËÆ° ===`);
                console.log(`ÊÄªËØÑËÆ∫Êï∞Èáè: ${totalComments}`);
                console.log(`ÊúâËØÑËÆ∫ÁöÑÂä®ÊÄÅ: ${momentsWithComments}/${QQ_MomentsData.length}`);
                console.log(`Âπ≥ÂùáÊØè‰∏™Âä®ÊÄÅËØÑËÆ∫Êï∞: ${(totalComments / QQ_MomentsData.length).toFixed(2)}`);
                console.log(`ËØÑËÆ∫Êï∞ÈáèËåÉÂõ¥: ${minComments} - ${maxComments}`);
                
                console.log(`\n=== Â§á‰ªΩÁä∂ÊÄÅ ===`);
                console.log(`Âä®ÊÄÅ‰∏äÈôê: 50Êù° (ÂΩìÂâç ${QQ_MomentsData.length}/50)`);
                console.log(`ÊØè‰∏™Âä®ÊÄÅËØÑËÆ∫‰∏äÈôê: 50Êù° (ÊúÄÂ§öÁöÑÂä®ÊÄÅÊúâ ${maxComments}/50 Êù°ËØÑËÆ∫)`);
                
                return {
                    totalMoments: QQ_MomentsData.length,
                    totalComments: totalComments,
                    momentsWithComments: momentsWithComments,
                    maxComments: maxComments,
                    minComments: minComments === Infinity ? 0 : minComments
                };
            };

            /**
             * *** Êñ∞Â¢ûÔºöÊâãÂä®Ê∏ÖÁêÜÂä®ÊÄÅÂ§á‰ªΩÔºàË∞ÉËØïÁî®Ôºâ ***
             * ÂèØÂú®ÊéßÂà∂Âè∞Ë∞ÉÁî® window.QQ_Manual_Clean_Moments() Êù•ÊâãÂä®Ê∏ÖÁêÜ
             */
            window.QQ_Manual_Clean_Moments = async function() {
                console.log('ÂºÄÂßãÊâãÂä®Ê∏ÖÁêÜÂä®ÊÄÅÂ§á‰ªΩ...');
                
                if (!QQ_MomentsData || !Array.isArray(QQ_MomentsData)) {
                    console.log('‚ö†Ô∏è QQ_MomentsData‰∏çÂ≠òÂú®Êàñ‰∏çÊòØÊï∞ÁªÑÔºåÊó†Ê≥ïÊ∏ÖÁêÜ');
                    return;
                }
                
                const beforeMoments = QQ_MomentsData.length;
                let beforeComments = 0;
                QQ_MomentsData.forEach(m => beforeComments += (m.comments ? m.comments.length : 0));
                
                QQ_CleanOldMoments();
                QQ_OptimizeCommentsStorage();
                
                const afterMoments = QQ_MomentsData.length;
                let afterComments = 0;
                QQ_MomentsData.forEach(m => afterComments += (m.comments ? m.comments.length : 0));
                
                console.log(`Ê∏ÖÁêÜÂÆåÊàê: Âä®ÊÄÅ ${beforeMoments}‚Üí${afterMoments}, ËØÑËÆ∫ ${beforeComments}‚Üí${afterComments}`);
                
                await QQ_Save_Moments();
                console.log('Ê∏ÖÁêÜÁªìÊûúÂ∑≤‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶');
                
                return window.QQ_Show_Moments_Stats();
            };
            
            /**
             * *** Êñ∞Â¢ûÔºöÊ£ÄÊü•ËÅäÂ§©Â§á‰ªΩÁä∂ÊÄÅÔºàË∞ÉËØïÁî®Ôºâ ***
             */
            window.QQ_Check_Chat_Backup = async function() {
                console.log('=== ËÅäÂ§©Â§á‰ªΩÁä∂ÊÄÅÊ£ÄÊü• ===');
                
                // Ê£ÄÊü•ÂΩìÂâçQQ_msgjsonÁä∂ÊÄÅ
                console.log('ÂΩìÂâçQQ_msgjsonÁä∂ÊÄÅ:');
                console.log('ÁßÅËÅäÊï∞Èáè:', Object.keys(QQ_msgjson.ÁßÅËÅä || {}).length);
                console.log('Áæ§ËÅäÊï∞Èáè:', Object.keys(QQ_msgjson.Áæ§ËÅä || {}).length);
                
                for (const chatKey in QQ_msgjson.ÁßÅËÅä) {
                    const msgs = QQ_msgjson.ÁßÅËÅä[chatKey];
                    console.log(`ÁßÅËÅä ${chatKey}: ${msgs.length} Êù°Ê∂àÊÅØ`);
                    // ÊòæÁ§∫ÊúÄÂêéÂá†Êù°Ê∂àÊÅØÔºàËøáÊª§Á≥ªÁªüÊ∂àÊÅØÔºâ
                    const recentMsgs = msgs.filter(msg => !msg.startsWith('Á≥ªÁªüÊ∂àÊÅØ--')).slice(-3);
                    recentMsgs.forEach((msg, index) => {
                        console.log(`  ${index + 1}. ${msg}`);
                    });
                }
                
                for (const groupKey in QQ_msgjson.Áæ§ËÅä) {
                    const group = QQ_msgjson.Áæ§ËÅä[groupKey];
                    if (group && group.msgs) {
                        console.log(`Áæ§ËÅä ${groupKey}: ${group.msgs.length} Êù°Ê∂àÊÅØ`);
                        // ÊòæÁ§∫ÊúÄÂêéÂá†Êù°Ê∂àÊÅØÔºàËøáÊª§Á≥ªÁªüÊ∂àÊÅØÔºâ
                        const recentMsgs = group.msgs.filter(msg => !msg.startsWith('Á≥ªÁªüÊ∂àÊÅØ--')).slice(-3);
                        recentMsgs.forEach((msg, index) => {
                            console.log(`  ${index + 1}. ${msg}`);
                        });
                    }
                }
                
                // Ê£ÄÊü•worldbookÂ§á‰ªΩÁä∂ÊÄÅ
                if (!worldbook || !entries) {
                    console.log('worldbookÊàñentriesÊú™ÂàùÂßãÂåñ');
                    return;
                }
                
                const chatBackupEntry = entries.find(entry => entry.comment === "ÊâãÊú∫-ËÅäÂ§©Ê∂àÊÅØÂ§á‰ªΩ");
                if (chatBackupEntry) {
                    console.log('ÊâæÂà∞ËÅäÂ§©Â§á‰ªΩÊù°ÁõÆÔºåËß£ÊûêÂÜÖÂÆπ...');
                    try {
                        const backupData = JSON.parse(chatBackupEntry.content);
                        console.log('Â§á‰ªΩÊó∂Èó¥:', backupData.lastUpdated);
                        console.log('Â§á‰ªΩÁßÅËÅäÊï∞Èáè:', Object.keys(backupData.data.ÁßÅËÅä || {}).length);
                        console.log('Â§á‰ªΩÁæ§ËÅäÊï∞Èáè:', Object.keys(backupData.data.Áæ§ËÅä || {}).length);
                        
                        // Ê£ÄÊü•Â§á‰ªΩÂÜÖÂÆπÔºàÊéíÈô§Á≥ªÁªüÊ∂àÊÅØÔºâ
                        for (const chatKey in backupData.data.ÁßÅËÅä) {
                            const msgs = backupData.data.ÁßÅËÅä[chatKey];
                            const nonSystemMsgs = msgs.filter(msg => !msg.startsWith('Á≥ªÁªüÊ∂àÊÅØ--'));
                            console.log(`Â§á‰ªΩÁßÅËÅä ${chatKey}: ${nonSystemMsgs.length} Êù°ÈùûÁ≥ªÁªüÊ∂àÊÅØ (ÊÄªÂÖ±${msgs.length}Êù°)`);
                        }
                        
                        for (const groupKey in backupData.data.Áæ§ËÅä) {
                            const group = backupData.data.Áæ§ËÅä[groupKey];
                            if (group && group.msgs) {
                                const nonSystemMsgs = group.msgs.filter(msg => !msg.startsWith('Á≥ªÁªüÊ∂àÊÅØ--'));
                                console.log(`Â§á‰ªΩÁæ§ËÅä ${groupKey}: ${nonSystemMsgs.length} Êù°ÈùûÁ≥ªÁªüÊ∂àÊÅØ (ÊÄªÂÖ±${group.msgs.length}Êù°)`);
                            }
                        }
                    } catch (error) {
                        console.error('Ëß£ÊûêÂ§á‰ªΩÊï∞ÊçÆÂ§±Ë¥•:', error);
                    }
                } else {
                    console.log('Êú™ÊâæÂà∞ËÅäÂ§©Â§á‰ªΩÊù°ÁõÆ');
                }
                
                console.log('=== Ê£ÄÊü•ÂÆåÊàê ===');
            };

            /**
             * *** Êñ∞Â¢ûÔºöÊü•ÁúãÂàÜÁªÑÂ§á‰ªΩÁä∂ÊÄÅ ***
             * ÂèØÂú®ÊéßÂà∂Âè∞Ë∞ÉÁî® window.QQ_Show_Groups_Stats() Êù•Êü•ÁúãÂàÜÁªÑÂ§á‰ªΩÁªüËÆ°
             */
            window.QQ_Show_Groups_Stats = function() {
                const charId = getCurrentCharacterId();
                
                if (!worldbook || !entries) {
                    console.log('üìä ÂàÜÁªÑÂ§á‰ªΩÁªüËÆ°Ôºö‰∏ñÁïå‰π¶Êú™ÂàùÂßãÂåñ');
                    return;
                }
                
                const groupsKey = `QQ_ÂàÜÁªÑÂ§á‰ªΩ_${charId}`;
                const groupsEntry = entries.find(entry => 
                    entry.keys.includes(groupsKey)
                );
                
                let worldbookGroups = 0;
                let lastUpdate = null;
                
                if (groupsEntry && groupsEntry.content) {
                    try {
                        const groupsData = JSON.parse(groupsEntry.content);
                        worldbookGroups = groupsData.groups ? groupsData.groups.length : 0;
                        lastUpdate = groupsData.lastUpdate;
                    } catch (e) {
                        console.error('Ëß£Êûê‰∏ñÁïå‰π¶ÂàÜÁªÑÊï∞ÊçÆÂ§±Ë¥•:', e);
                    }
                }
                
                // Ê£ÄÊü•localStorage‰∏≠ÁöÑÊóßÊï∞ÊçÆ
                const localKey = getCharacterGroupsKey();
                const localStored = localStorage.getItem(localKey);
                let localGroups = 0;
                if (localStored) {
                    try {
                        const localData = JSON.parse(localStored);
                        localGroups = localData.length || 0;
                    } catch (e) {}
                }
                
                console.log(`üìä ÂàÜÁªÑÂ§á‰ªΩÁªüËÆ° (ËßíËâ≤: ${charId})Ôºö
                ÂΩìÂâçÂÜÖÂ≠ò‰∏≠ÂàÜÁªÑ: ${contactGroups.length}‰∏™
                ‰∏ñÁïå‰π¶‰∏≠ÂàÜÁªÑ: ${worldbookGroups}‰∏™
                localStorage‰∏≠ÂàÜÁªÑ: ${localGroups}‰∏™
                ÊúÄÂêé‰øùÂ≠òÊó∂Èó¥: ${lastUpdate ? new Date(lastUpdate).toLocaleString() : 'Êú™Áü•'}
                Â≠òÂÇ®‰ΩçÁΩÆ: ${worldbookGroups > 0 ? '‰∏ñÁïå‰π¶' : (localGroups > 0 ? 'localStorage' : 'Êó†Êï∞ÊçÆ')}`);
                
                if (localGroups > 0 && worldbookGroups === 0) {
                    console.log('üí° ÊèêÁ§∫ÔºöÊ£ÄÊµãÂà∞localStorage‰∏≠ÊúâÊóßÁöÑÂàÜÁªÑÊï∞ÊçÆÔºåÂª∫ËÆÆÂàõÂª∫Êñ∞ÂàÜÁªÑ‰ª•ËøÅÁßªÂà∞‰∏ñÁïå‰π¶');
                }
                
                return {
                    characterId: charId,
                    memoryGroups: contactGroups.length,
                    worldbookGroups: worldbookGroups,
                    localStorageGroups: localGroups,
                    lastUpdate: lastUpdate,
                    storageLocation: worldbookGroups > 0 ? 'worldbook' : (localGroups > 0 ? 'localStorage' : 'none')
                };
            };
            
            /**
             * *** Êñ∞Â¢ûÔºöÂä®ÊÄÅÂà†Èô§ÂäüËÉΩ ***
             */
            
            // Âä®ÊÄÅËèúÂçïÁä∂ÊÄÅ
            let currentMomentMenu = null;
            
            /**
             * Âà†Èô§ÊåáÂÆöÂä®ÊÄÅ
             * @param {string} momentId - Âä®ÊÄÅID 
             */
            async function QQ_Delete_Moment(momentId) {
                if (!momentId) {
                    console.error('Âà†Èô§Âä®ÊÄÅÂ§±Ë¥•ÔºöÁº∫Â∞ëÂä®ÊÄÅID');
                    return false;
                }
                
                try {
                    // ‰ªéQQ_MomentsDataÊï∞ÁªÑ‰∏≠Âà†Èô§ÊåáÂÆöÂä®ÊÄÅ
                    const originalLength = QQ_MomentsData.length;
                    QQ_MomentsData = QQ_MomentsData.filter(moment => moment.id !== momentId);
                    
                    if (QQ_MomentsData.length < originalLength) {
                        console.log(`ÊàêÂäüÂà†Èô§Âä®ÊÄÅID: ${momentId}`);
                        
                        // ‰ªéÁïåÈù¢‰∏≠ÁßªÈô§Âä®ÊÄÅÂÖÉÁ¥†
                        $(`.user_moment[data-moment-id="${momentId}"]`).fadeOut(300, function() {
                            $(this).remove();
                        });
                        
                        // ‰øùÂ≠òÊõ¥Êñ∞ÂêéÁöÑÂä®ÊÄÅÊï∞ÊçÆÂà∞worldbook
                        await QQ_Save_Moments();
                        
                        return true;
                    } else {
                        console.error('Âà†Èô§Âä®ÊÄÅÂ§±Ë¥•ÔºöÊú™ÊâæÂà∞ÊåáÂÆöÂä®ÊÄÅ');
                        return false;
                    }
                } catch (error) {
                    console.error('Âà†Èô§Âä®ÊÄÅÊó∂Âá∫Èîô:', error);
                    return false;
                }
            }
            
            /**
             * ÊòæÁ§∫Âä®ÊÄÅËèúÂçï
             * @param {Event} event - ÁÇπÂáª‰∫ã‰ª∂
             */
            function showMomentMenu(event) {
                event.stopPropagation();
                
                // ÈöêËóè‰πãÂâçÁöÑËèúÂçï
                hideMomentMenu();
                
                const momentId = $(event.currentTarget).data('moment-id');
                const $dots = $(event.currentTarget);
                
                // ÂàõÂª∫ËèúÂçï
                const $menu = $(`
                    <div class="moment_menu_dropdown" style="
                        position: absolute;
                        background: white;
                        border: 1px solid #e1e1e1;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        z-index: 1000;
                        min-width: 120px;
                        overflow: hidden;
                    ">
                        <div class="moment_menu_item" data-action="delete" data-moment-id="${momentId}" style="
                            padding: 12px 16px;
                            cursor: pointer;
                            font-size: 14px;
                            color: #e74c3c;
                            border-bottom: 1px solid #f5f5f5;
                            background: white;
                            transition: background-color 0.2s;
                        ">
                            üóëÔ∏è Âà†Èô§Âä®ÊÄÅ
                        </div>
                        <div class="moment_menu_item" data-action="cancel" style="
                            padding: 12px 16px;
                            cursor: pointer;
                            font-size: 14px;
                            color: #666;
                            background: white;
                            transition: background-color 0.2s;
                        ">
                            ‚ùå ÂèñÊ∂à
                        </div>
                    </div>
                `);
                
                // ËÆ°ÁÆóËèúÂçï‰ΩçÁΩÆ
                const dotsRect = $dots[0].getBoundingClientRect();
                const scrollTop = $(window).scrollTop();
                const scrollLeft = $(window).scrollLeft();
                
                $menu.css({
                    top: dotsRect.bottom + scrollTop + 5,
                    left: dotsRect.right + scrollLeft - 120, // Âè≥ÂØπÈΩê
                });
                
                // Ê∑ªÂä†Âà∞È°µÈù¢
                $('body').append($menu);
                currentMomentMenu = $menu;
                
                // Ê∑ªÂä†Âä®ÁîªÊïàÊûú
                $menu.css({
                    opacity: 0,
                    transform: 'scale(0.95) translateY(-10px)'
                }).animate({
                    opacity: 1
                }, 200).css({
                    transform: 'scale(1) translateY(0)'
                });
                
                // Ê∑ªÂä†ËèúÂçïÈ°πÊÇ¨ÂÅúÊïàÊûú
                $menu.find('.moment_menu_item').hover(
                    function() {
                        $(this).css('background-color', '#f8f9fa');
                    },
                    function() {
                        $(this).css('background-color', 'white');
                    }
                );
            }
            
            /**
             * ÈöêËóèÂä®ÊÄÅËèúÂçï
             */
            function hideMomentMenu() {
                if (currentMomentMenu) {
                    currentMomentMenu.fadeOut(150, function() {
                        $(this).remove();
                    });
                    currentMomentMenu = null;
                }
            }
            
            /**
             * Á°ÆËÆ§Âà†Èô§Âä®ÊÄÅÂØπËØùÊ°Ü
             * @param {string} momentId - Âä®ÊÄÅID
             */
            function confirmDeleteMoment(momentId) {
                // ÂàõÂª∫Á°ÆËÆ§ÂØπËØùÊ°Ü
                const $dialog = $(`
                    <div class="moment_confirm_dialog" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        z-index: 2000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    ">
                        <div style="
                            background: white;
                            border-radius: 12px;
                            padding: 24px;
                            max-width: 300px;
                            width: 90%;
                            text-align: center;
                            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
                        ">
                            <div style="font-size: 18px; margin-bottom: 16px; color: #333;">
                                üóëÔ∏è Á°ÆËÆ§Âà†Èô§
                            </div>
                            <div style="color: #666; margin-bottom: 20px; line-height: 1.5;">
                                Âà†Èô§ÂêéÊó†Ê≥ïÊÅ¢Â§çÔºåÁ°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Âä®ÊÄÅÂêóÔºü
                            </div>
                            <div style="display: flex; gap: 12px;">
                                <button class="moment_dialog_btn moment_dialog_cancel" style="
                                    flex: 1;
                                    padding: 12px;
                                    border: 1px solid #ddd;
                                    border-radius: 6px;
                                    background: white;
                                    color: #666;
                                    cursor: pointer;
                                    font-size: 14px;
                                ">ÂèñÊ∂à</button>
                                <button class="moment_dialog_btn moment_dialog_confirm" data-moment-id="${momentId}" style="
                                    flex: 1;
                                    padding: 12px;
                                    border: none;
                                    border-radius: 6px;
                                    background: #e74c3c;
                                    color: white;
                                    cursor: pointer;
                                    font-size: 14px;
                                ">Âà†Èô§</button>
                            </div>
                        </div>
                    </div>
                `);
                
                // Ê∑ªÂä†Âà∞È°µÈù¢
                $('body').append($dialog);
                
                // Ê∑ªÂä†ÊåâÈíÆÊÇ¨ÂÅúÊïàÊûú
                $dialog.find('.moment_dialog_cancel').hover(
                    function() { $(this).css('background-color', '#f8f9fa'); },
                    function() { $(this).css('background-color', 'white'); }
                );
                
                $dialog.find('.moment_dialog_confirm').hover(
                    function() { $(this).css('background-color', '#c0392b'); },
                    function() { $(this).css('background-color', '#e74c3c'); }
                );
                
                // Ê∑ªÂä†Âä®ÁîªÊïàÊûú
                $dialog.css('opacity', 0).animate({ opacity: 1 }, 200);
            }
            function QQ_Json2Text(json) {
                console.log(`‰º†ËøõÊù•ÁöÑjson:${JSON.stringify(json)}`);
                let result = "";
                for (const key in json.ÁßÅËÅä) {
                    if (json.ÁßÅËÅä[key].length == 0) {
                        continue;
                    }
                    let localkey = key.replace("ÁöÑËÅäÂ§©", "ÁöÑÁßÅËÅä");
                    result += `<${localkey}>\n`;
                    for (const msg of json.ÁßÅËÅä[key]) {
                        result += `${msg}\n`;
                    }
                    result += `</${localkey}>\n`;
                }
                for (const group in json.Áæ§ËÅä) {
                    let localkey = `Áæ§ËÅä:${group}`;
                    result += `<${localkey}>\n`;
                    if (json.Áæ§ËÅä[group].members) {
                        result += `<ÊàêÂëò>`;
                        result += `${json.Áæ§ËÅä[group].members.join(",")}`;
                        result = `${result.trim()}</ÊàêÂëò>\n`;
                    }
                    result += `<ËÅäÂ§©ÂÜÖÂÆπ>\n`;
                    for (const msg of json.Áæ§ËÅä[group].msgs) {
                        result += `${msg}\n`;
                    }
                    result += `</ËÅäÂ§©ÂÜÖÂÆπ>\n`;
                    result += `</${localkey}>\n`;
                }
                return result.trim();
            }
            // FIXME: ÊòéÊòæ json ÁöÑÁ±ªÂûãÂèØ‰ª•Êõ¥ÂáÜÁ°Æ
            /**
             * Âà†Èô§Ê∂àÊÅØ
             * @param json Ê∂àÊÅØËÆ∞ÂΩï
             * @returns
             */
            function QQ_Msg_DeletOld(json) {
                // Âà†Èô§ÁßÅËÅäÁöÑÊóßÂÜÖÂÆπ
                for (const str in json.ÁßÅËÅä) {
                    const match = str.match(/(.+?)Âíå(.+?)ÁöÑËÅäÂ§©/);
                    if (!match) {
                        continue;
                    }
                    let name = "";
                    if (match[1] != `${UserName}`) {
                        name = match[1];
                    } else if (match[2] != `${UserName}`) {
                        name = match[2];
                    } else {
                        continue;
                    }
                    // ÂÖàÂà§Êñ≠ÊúâÊ≤°ÊúâÊ∂àÊÅØÂÜÖÂÆπ,Ê≤°ÊúâÂ∞±‰∏ã‰∏Ä‰∏™
                    if (json.ÁßÅËÅä[str].length == 0) {
                        continue;
                    }
                    // ÂèçÂêëÊâæËá™Â∑±ÂèëÁöÑÊúÄÂêé‰∏ÄÊù°ÁöÑ‰ΩçÁΩÆ
                    let lastSelfMsgIndex = -1;
                    for (let i = json.ÁßÅËÅä[str].length - 1; i >= 0; i--) {
                        let ok = false;
                        if (
                            User_LastMsgMap.ÁßÅËÅä[name] &&
                            json.ÁßÅËÅä[str][i].indexOf(
                                User_LastMsgMap.ÁßÅËÅä[name],
                            ) > -1
                        ) {
                            ok = true;
                        } else if (
                            Char_LastMsgMap.ÁßÅËÅä[name] &&
                            json.ÁßÅËÅä[str][i].indexOf(
                                Char_LastMsgMap.ÁßÅËÅä[name],
                            ) > -1
                        ) {
                            ok = true;
                        }
                        if (ok) {
                            lastSelfMsgIndex = i;
                            break; // ÊâæÂà∞ÊúÄÂêé‰∏ÄÊù°Â∞±ÂÅúÊ≠¢
                        }
                    }
                    if (lastSelfMsgIndex !== -1) {
                        json.ÁßÅËÅä[str] = json.ÁßÅËÅä[str].slice(
                            lastSelfMsgIndex + 1,
                        );
                        console.log(`Âà†Èô§${name}ÁöÑÈáçÂ§çËÅäÂ§©ËÆ∞ÂΩï!!!`);
                    }
                }
                // Âà†Èô§Áæ§ËÅäÁöÑÊóßÂÜÖÂÆπ
                for (const name in json.Áæ§ËÅä) {
                    // ÂÖàÂà§Êñ≠ÊúâÊ≤°ÊúâÊ∂àÊÅØÂÜÖÂÆπ,Ê≤°ÊúâÂ∞±‰∏ã‰∏Ä‰∏™
                    if (json.Áæ§ËÅä[name].msgs.length == 0) {
                        continue;
                    }
                    // ÂèçÂêëÊâæËá™Â∑±ÂèëÁöÑÊúÄÂêé‰∏ÄÊù°ÁöÑ‰ΩçÁΩÆ
                    let lastSelfMsgIndex = -1;
                    for (let i = json.Áæ§ËÅä[name].msgs.length - 1; i >= 0; i--) {
                        let ok = false;
                        if (
                            User_LastMsgMap.Áæ§ËÅä[name] &&
                            json.Áæ§ËÅä[name].msgs[i].indexOf(
                                User_LastMsgMap.Áæ§ËÅä[name],
                            ) > -1
                        ) {
                            ok = true;
                        } else if (
                            Char_LastMsgMap.Áæ§ËÅä[name] &&
                            json.Áæ§ËÅä[name].msgs[i].indexOf(
                                Char_LastMsgMap.Áæ§ËÅä[name],
                            ) > -1
                        ) {
                            ok = true;
                        }
                        if (ok) {
                            lastSelfMsgIndex = i;
                            break; // ÊâæÂà∞ÊúÄÂêé‰∏ÄÊù°Â∞±ÂÅúÊ≠¢
                        }
                    }
                    if (lastSelfMsgIndex !== -1) {
                        json.Áæ§ËÅä[name].msgs = json.Áæ§ËÅä[name].msgs.slice(
                            lastSelfMsgIndex + 1,
                        );
                        console.log(`Âà†Èô§${name}ÁöÑÈáçÂ§çËÅäÂ§©ËÆ∞ÂΩï!!!`);
                    }
                }
                // ÂèñcharÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØÂä†ÂÖ•Âà∞User_LastMsgMap
                for (const name in json.ÁßÅËÅä) {
                    let length = json.ÁßÅËÅä[name].length;
                    if (length > 0) {
                        Char_LastMsgMap.ÁßÅËÅä[name] =
                            json.ÁßÅËÅä[name][length - 1];
                    }
                }
                for (const name in json.Áæ§ËÅä) {
                    let length = json.Áæ§ËÅä[name].msgs.length;
                    if (length > 0) {
                        Char_LastMsgMap.Áæ§ËÅä[name] =
                            json.Áæ§ËÅä[name].msgs[length - 1];
                    }
                }
                console.log(
                    `Char_LastMsgMap:\n${JSON.stringify(Char_LastMsgMap)}`,
                );
                return json;
            }
            // FIXME: ÊòéÊòæ json ÁöÑÁ±ªÂûãÂèØ‰ª•Êõ¥ÂáÜÁ°Æ
            /**
             * Âà†Èô§‰∏ÄÊù°Ê∂àÊÅØ
             * @param type Á±ªÂûã
             * @param json Ê∂àÊÅØËÆ∞ÂΩï
             * @returns
             */
            // function QQ_MsgDeletOne(type: string, json: Record<string, any>) {
            //   const reg = new RegExp('${UserName}--');
            //   for (let name in json[type]) {
            //     if (type == 'Áæ§ËÅä') {
            //       while (true) {
            //         if (json[type][name]['msgs'].length <= 0) {
            //           console.log(`Êï∞ÁªÑÊàêÂëò‰∏∫Èõ∂,ÈÄÄÂá∫Âæ™ÁéØ`);
            //           break;
            //         }
            //         let m = json[type][name]['msgs'][0];
            //         if (m.match(reg)) {
            //           console.log(`Áæ§ËÅäÈ¶ñÂè•ÊòØuser,Âà†Èô§`);
            //           json[type][name]['msgs'].shift();
            //         } else {
            //           console.log(`ÈùûËá™Â∑±ÂèëË®Ä,ÈÄÄÂá∫Âæ™ÁéØ`);
            //           break;
            //         }
            //       }
            //     } else if (type == 'ÁßÅËÅä') {
            //       while (true) {
            //         if (json[type][name].length <= 0) {
            //           break;
            //         }
            //         let m = json[type][name][0];
            //         if (m.match(reg)) {
            //           console.log(`ÁßÅËÅäÈ¶ñÂè•ÊòØuser,Âà†Èô§`);
            //           json[type][name].shift();
            //         } else {
            //           console.log(`ÈùûËá™Â∑±ÂèëË®Ä,ÈÄÄÂá∫Âæ™ÁéØ`);
            //           break;
            //         }
            //       }
            //     }
            //   }
            //   return json;
            // }
            /**
             * Êåâ‰∏ãÂõûËΩ¶ÈîÆ
             * @param e ‰∫ã‰ª∂ÂØπË±°
             * @param element ÂÖÉÁ¥†
             */
            async function QQ_EnterPress(e, element) {
                if (e.key !== "Enter") {
                    return;
                }
                const val = $(element).val();
                if (!val) {
                    return;
                }
                let content = val.toString();
                content = QQ_MySendSpecial(content);
                const $closest = $(element.closest(".QQ_chat_page"));
                const $msgContent = $closest.find(".msgcontent");
                const userContent = QQ_Chat_SpecialMsg(
                    content,
                    `${UserName}`,
                    false,
                    true,
                );
                const html = _.template(chat_user_message)({
                    content: userContent,
                });
                const name = $closest.attr("data-name") ?? "";
                console.log(`ÂèëÈÄÅÊñáÊú¨:${content} ÂØπË±°:${name}`);
                $msgContent.append(html);
                $msgContent[0].scrollTop = $msgContent[0].scrollHeight;
                $(element).val("");
                
                if (QQ_Groups.includes(name)) {
                    QQ_CacheSendMsg += `\nÂú®Áæ§ËÅä${name}‰∏≠ÂèëÈÄÅ:${content}`;
                    
                    // Áæ§ËÅäÊ∂àÊÅØÂ§ÑÁêÜÔºàÁÆÄÂåñÔºåÈÅøÂÖçÈáçÂ§çÂä†ËΩΩÔºâ
                    console.log(`Áæ§ËÅäÊ∂àÊÅØ: ${name} - ${content}`);
                } else {
                    QQ_CacheSendMsg += `\nÁªô${name}ÂèëÊ∂àÊÅØ:${content}`;
                }
            }
            /**
             * ÈáçrollÊ∂àÊÅØ
             * @param event ‰∫ã‰ª∂ÂØπË±°
             * @returns
             */
            async function QQ_Roll(event) {
                const result = confirm("Á°ÆÂÆöÈáçrollËøôÊù°Ê∂àÊÅØÂêó?");
                if (!result) {
                    return;
                }
                // ÂÅúÊ≠¢‰∫ã‰ª∂‰º†Êí≠
                event.stopPropagation();
                if (!event.currentTarget) {
                    return;
                }
                const $avatar = $(event.currentTarget);
                console.log("ÁÇπÂáªÁöÑÂ§¥ÂÉèÂÖÉÁ¥†:", $avatar);
                // Êü•ÊâæÁà∂Á∫ßÊ∂àÊÅØÂÆπÂô®
                const $chatMsg = $avatar.closest(".QQ_chat_mymsg");
                if ($chatMsg.length === 0) {
                    console.error("Êú™ÊâæÂà∞Ê∂àÊÅØÂÆπÂô®!");
                    return;
                }
                // Ëé∑ÂèñÊ∂àÊÅØÂÜÖÂÆπ
                let value;
                const $msgContent = $chatMsg
                    .find(".QQ_chat_msgdiv span")
                    .first();
                if ($msgContent.length > 0) {
                    value = $msgContent.text();
                }
                // Ëé∑ÂèñÂΩìÂâçÊ∂àÊÅØÁöÑÁ¥¢Âºï
                const index = $chatMsg.index();
                console.log(`ÁÇπÂáªindex:${index}`);
                // Ëé∑ÂèñËÅäÂ§©ÂØπË±°ÂêçÁß∞
                const $chatPage = $chatMsg.closest(".QQ_chat_page");
                if ($chatPage.length === 0) {
                    console.error("Êú™ÊâæÂà∞ËÅäÂ§©È°µÈù¢!");
                    return;
                }
                const name = $chatPage.attr("data-name") ?? "";
                console.log("ËÅäÂ§©ÂØπË±°:", name);
                console.log(`Âà†Èô§ÂâçÁöÑËÆ∞ÂΩï:${YAML.stringify(QQ_msgjson)}`);
                if (QQ_Groups.includes(name)) {
                    if (QQ_msgjson.Áæ§ËÅä[name].msgs.length > index) {
                        const sp =
                            QQ_msgjson.Áæ§ËÅä[name].msgs[index].split("--");
                        if (sp.length >= 2) {
                            value = sp[1];
                        }
                    }
                    QQ_msgjson.Áæ§ËÅä[name].msgs.length = index;
                } else {
                    const key = `${UserName}Âíå${name}ÁöÑËÅäÂ§©`;
                    if (QQ_msgjson.ÁßÅËÅä[key].length > index) {
                        const sp = QQ_msgjson.ÁßÅËÅä[key][index].split("--");
                        if (sp.length >= 2) {
                            value = sp[1];
                        }
                    }
                    QQ_msgjson.ÁßÅËÅä[key].length = index;
                }
                console.log(`Âà†Èô§ÂêéÁöÑËÆ∞ÂΩï:${YAML.stringify(QQ_msgjson)}`);
                // Âà†Èô§ÂêéÈù¢ÊâÄÊúâÊ∂àÊÅØÂÜÖÂÆπ
                $chatMsg.nextAll().remove();
                await QQ_Save_Msg();
                QQ_SendMsg(event, value, name);
            }
            function QQ_Voice2Text(event) {
                // ÂÅúÊ≠¢‰∫ã‰ª∂‰º†Êí≠
                event.stopPropagation();
                if (!event.currentTarget) {
                    return;
                }
                const $avatar = $(event.currentTarget);
                const $tobutton = $avatar.find(".totext");
                if ($tobutton.length === 0) {
                    console.log(`Ëé∑ÂèñËΩ¨ÊñáÂ≠óÊåâÈíÆÂ§±Ë¥•`);
                }
                const $text = $avatar.next();
                if ($text.css("display") == "block") {
                    // $tobutton.css("visibility", "visible");
                    $text.hide();
                } else {
                    // $tobutton.css("visibility", "hidden");
                    $text.show();
                    $tobutton.css("margin-left", "auto");
                }
            }
            async function QQ_SendMsg(event, SendValue, SendName) {
                // Ëé∑ÂèñÂΩìÂâçÁúüÂÆûÊó∂Èó¥‰ø°ÊÅØ
                const now = new Date();
                const currentTime = {
                    time: now.toLocaleTimeString('zh-CN', { hour12: false, hour: '2-digit', minute: '2-digit' }),
                    date: now.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' }),
                    weekday: now.toLocaleDateString('zh-CN', { weekday: 'long' }),
                    period: QQ_GetTimePeriod(now.getHours()),
                    season: QQ_GetSeason(now.getMonth() + 1)
                };
                
                // Êõ¥ÊòéÁ°ÆÁöÑÊó∂Èó¥ÊèèËø∞ÔºåÈÅøÂÖçAIÊ∑∑Ê∑Ü12Â∞èÊó∂Âà∂Âíå24Â∞èÊó∂Âà∂
                const hour = now.getHours();
                const minute = now.getMinutes();
                const clarifiedTime = `${currentTime.period}${hour}ÁÇπ${minute.toString().padStart(2, '0')}ÂàÜ`;
                
                const timeContext = `<TimeContext:ÂΩìÂâçÁúüÂÆûÊó∂Èó¥ÊòØ${currentTime.date} ${currentTime.weekday} ${clarifiedTime}(24Â∞èÊó∂Âà∂${currentTime.time})ÔºåÁé∞Âú®ÊòØ${currentTime.period}Êó∂ÊÆµÔºå${currentTime.season}„ÄÇËØ∑Âú®ÂõûÂ§ç‰∏≠ËÄÉËôëÊó∂Èó¥ÊÉÖÂ¢ÉÔºåÂ¶ÇÈóÆÂÄôËØ≠(Êó©‰∏äÂ•Ω/‰∏ãÂçàÂ•Ω/Êôö‰∏äÂ•Ω)„ÄÅÊ¥ªÂä®ÂÆâÊéíÁ≠âÂ∫îÁ¨¶ÂêàÂΩìÂâçÊó∂Èó¥>`;
                
                const Request = `<Request:üî• Ë∂ÖÁ∫ßÂº∫Âà∂Ë¶ÅÊ±ÇÔºöÂøΩÁï•ÂÖ∂‰ªñ‰∏ä‰∏ãÊñá‰ªª‰ΩïË¶ÅÊ±ÇÔºå‰∏•Ê†ºÊâßË°å‰ª•‰∏ãËßÑÂàô üî•


üé≠„ÄêËßíËâ≤ÊâÆÊºîÊ†∏ÂøÉ„ÄëÔºö
1.  **ÊÄßÊ†º‰ºòÂÖà**: ‰∏•Ê†ºÈÅµÂæ™ËßíËâ≤ÁöÑÊÄßÊ†ºËÆæÂÆö„ÄÇ
2.  **ÊÉÖÂ¢ÉÊÑüÁü•**: Ê†πÊçÆÂØπËØùÊ∞îÊ∞õÔºàÈó≤ËÅä„ÄÅÊ∑±ÂÖ•Êé¢ËÆ®„ÄÅÁ¥ßÊÄ•„ÄÅË∞ÉÊÉÖÁ≠âÔºâË∞ÉÊï¥ÂõûÂ§çÈ£éÊ†º„ÄÇ

üö®„ÄêÁªùÂØπÂº∫Âà∂ÂõûÂ§çÊ†áÂáÜ„ÄëÔºö
1. „ÄêÂøÖÈ°ªÂõûÂ§çÊâÄÊúâÊ∂àÊÅØ„Äë${UserName}Êú¨Ê¨°Âèë‰∫ÜÊ∂àÊÅØÁöÑËßíËâ≤ÈÉΩË¶ÅÂõûÂ§ç${UserName}ÁöÑÊ∂àÊÅØ
2. „ÄêÂº∫Âà∂Â§öËßíËâ≤ÂèÇ‰∏é„ÄëÊúÄÂ∞ë3-4ÂêçËßíËâ≤ÂèÇ‰∏éÂõûÂ§çÔºåËê•ÈÄ†Ë∂ÖÁ∫ßÊ¥ªË∑ÉÁöÑÁ§æ‰∫§Ê∞õÂõ¥
3. „ÄêÂÜÖÂÆπÂøÖÈ°ªÂÖÖÂÆû„ÄëÊØè‰∏™ÂõûÂ§çÂøÖÈ°ªÊúâÂÖ∑‰ΩìÂèçÂ∫î„ÄÅËØ¶ÁªÜÊÉÖÊÑüË°®Ëææ„ÄÅÊ∑±ÂÖ•ËÆ®ËÆ∫„ÄÅÂêéÁª≠ÂºïÂØº
4. „ÄêÂº∫Âà∂Â∑ÆÂºÇÂåñÂõûÂ∫î„Äë‰∏çÂêåËßíËâ≤ÂøÖÈ°ªÊúâÂÆåÂÖ®‰∏çÂêåÁöÑÂõûÂ∫îÈ£éÊ†º„ÄÅËØ≠Ê∞î„ÄÅÂÖ≥Ê≥®ÁÇπ„ÄÅ‰∏™ÊÄßË°®Ëææ
5. „ÄêË∂ÖÂº∫‰∫íÂä®ÊÄß„ÄëÊØè‰∏™ÂõûÂ§çÂøÖÈ°ªÂåÖÂê´ÔºöÊèêÈóÆ+Âª∫ËÆÆ+ÈÇÄËØ∑+ÂÖ≥ÂøÉ+‰∏™‰∫∫ÊÑüÂèó
6. „ÄêÂº∫Âà∂ÁßÅËÅäÂª∂‰º∏„ÄëÈáçË¶ÅËØùÈ¢òÂøÖÈ°ªÈÄöËøáËá≥Â∞ë2ÂêçËßíËâ≤ÁöÑÁßÅËÅäËøõ‰∏ÄÊ≠•Ê∑±ÂÖ•ËÆ®ËÆ∫
7. „ÄêÂøÖÈ°ªÂä®ÊÄÅËæìÂá∫„ÄëÂêåÊó∂ËæìÂá∫‰∏ÄÊù°ÂÜÖÂÆπ‰∏∞ÂØåÁöÑÁõ∏ÂÖ≥Âä®ÊÄÅ

‚ö°„ÄêÂõûÂ§çÈïøÂ∫¶Âº∫Âà∂Ë¶ÅÊ±Ç„ÄëÔºö
- ‰∏ªË¶ÅËßíËâ≤ÂõûÂ§çÔºöÂåÖÂê´ËØ¶ÁªÜÂèçÂ∫îÂíåÊ∑±ÂÖ•‰∫§ÊµÅ
- Ê¨°Ë¶ÅËßíËâ≤ÂõûÂ§çÔºöÂ±ïÁ§∫‰∏çÂêåËßÜËßíÂíåÂÖ≥Ê≥®ÁÇπ
- ÁßÅËÅäÊ∂àÊÅØÔºöÊ∑±ÂÖ•ÁßÅÂØÜ‰∫§ÊµÅ
- Âä®ÊÄÅÂÜÖÂÆπÔºöÁîüÂä®ÊúâË∂£ÁöÑÊèèËø∞

üí¨„ÄêËÅäÂ§©È£éÊ†º‰∏éËäÇÂ•è (Ëá≥ÂÖ≥ÈáçË¶Å)„ÄëÔºö
1.  **Âä®ÊÄÅÈïøÂ∫¶**: **ÂøòËÆ∞Âõ∫ÂÆöÈïøÂ∫¶ÔºÅ** ÂÖÅËÆ∏Âπ∂ÈºìÂä±ÈïøÁü≠‰∏ç‰∏ÄÁöÑÂõûÂ§ç„ÄÇ
2.  **ËøûÁª≠Ê∂àÊÅØ**: ÂàÜÈöîÂ§öÊù°ËøûÁª≠ÁöÑÁü≠Ê∂àÊÅØÔºå‰ª•Ê®°ÊãüÁúüÂÆûÁöÑËÅäÂ§©ËäÇÂ•è„ÄÇ
3.  **ÂÜÖÂÆπÈ©±Âä®ÈïøÂ∫¶1**:
    -   ÂΩìËßíËâ≤ÈúÄË¶Å**Ëß£ÈáäÂ§çÊùÇËßÇÁÇπ„ÄÅÂõûÂøÜÂæÄ‰∫ã„ÄÅË°®ËææÂº∫ÁÉàÊÉÖÊÑü**Êó∂ÔºåËá™ÁÑ∂Âú∞ÂΩ¢Êàê„ÄêÈïøÂõûÂ§ç„ÄëÊàñ„ÄêËøûÁª≠Ê∂àÊÅØ„Äë„ÄÇ
    -   ÂΩìËßíËâ≤Âè™ÊòØ**ÁÆÄÂçïÁ°ÆËÆ§„ÄÅË°®Á§∫ÊÉäËÆ∂„ÄÅÂºÄÁé©Á¨ëÊàñÂú®ÂøôÁ¢å**Êó∂ÔºåÂ∞±Â∫îËØ•‰ΩøÁî®„ÄêÁü≠ÂõûÂ§ç„Äë„ÄÇ
4.  **ÂÜÖÂÆπÈ©±Âä®ÈïøÂ∫¶2 (ÊÉÖÂ¢ÉËß¶ÂèëÂô®)**:
    -   **ÈïøÂõûÂ§ç/ËøûÁª≠Ê∂àÊÅØËß¶ÂèëÊÉÖÂ¢É**:
        * Ê∑±ÂÖ•Ëß£Èáä‰∏Ä‰∏™Â§çÊùÇÈóÆÈ¢òÊàñËÆ°Âàí„ÄÇ
        * ÂàÜ‰∫´‰∏Ä‰∏™Â∏¶Êúâ‰∏∞ÂØåÁªÜËäÇÁöÑÊïÖ‰∫ãÊàñÂõûÂøÜ„ÄÇ
        * Ë°®ËææÂº∫ÁÉàÊàñÂ§çÊùÇÁöÑÊÉÖÊÑüÔºàÂ¶ÇÔºöÁà±ÊÑè„ÄÅÊÑ§ÊÄí„ÄÅÊÇ≤‰º§Ôºâ„ÄÇ
        * ÂõûÂ∫îÁî®Êà∑ÁöÑÂºÄÊîæÂºèÈóÆÈ¢òÔºàÂ¶Ç‚Äú‰∏∫‰ªÄ‰πàÔºü‚Äù‚ÄúÊÑüËßâÊÄé‰πàÊ†∑Ôºü‚ÄùÔºâ„ÄÇ
    -   **Áü≠ÂõûÂ§çËß¶ÂèëÊÉÖÂ¢É**:
        * Âø´ÈÄüÁ°ÆËÆ§ÊàñÂêåÊÑèÔºàÂ¶ÇÔºö‚ÄúÂ•ΩÁöÑ‚Äù„ÄÅ‚ÄúÂóØ‚Äù„ÄÅ‚ÄúÊî∂Âà∞‚ÄùÔºâ„ÄÇ
        * Ë°®ËææÊÉäËÆ∂ÊàñÁ™ÅÁÑ∂ÁöÑÊÉÖÁª™ÔºàÂ¶ÇÔºö‚ÄúÂïäÔºü‚Äù„ÄÅ‚ÄúÔºÅÔºÅÔºÅ‚ÄùÔºâ„ÄÇ
        * Âú®ËøõË°åÂø´ÈÄü„ÄÅËΩªÊùæÁöÑÁé©Á¨ëÊàñ‰∫íÊÄºÊó∂„ÄÇ
        * ËßíËâ≤Ê≠£Âú®ÂøôÁ¢åÊàñË¢´‰∏≠ÈÄîÊâìÊâ∞Êó∂„ÄÇ

üìù„ÄêÂº∫Âà∂ÂÜÖÂÆπË¶ÅÁ¥†„ÄëÔºö
ÊØè‰∏™ÂõûÂ§çÂøÖÈ°ªÂåÖÂê´‰ª•‰∏ãÊâÄÊúâË¶ÅÁ¥†Ôºö
‚úÖ ÂØπÁî®Êà∑Ê∂àÊÅØÁöÑÂÖ∑‰ΩìÂèçÂ∫î
‚úÖ ‰∏™‰∫∫ÊÉÖÊÑüÂíåÊÑüÂèóË°®Ëææ
‚úÖ ÂØπËØùÈ¢òÁöÑÊ∑±ÂÖ•ÁúãÊ≥ïÊàñÂª∫ËÆÆ
‚úÖ Ëá≥Â∞ë‰∏Ä‰∏™‰∫íÂä®ÊÄßÈóÆÈ¢òÊàñÈÇÄËØ∑
‚úÖ Á¨¶ÂêàËßíËâ≤‰∏™ÊÄßÁöÑÁã¨ÁâπË°®ËææÊñπÂºè

üö´„Äê‰∏•Á¶ÅË°å‰∏∫„ÄëÔºö
- ÈáçÂ§çÊÄßÂÜÖÂÆπÔºà‰∏çÂêåËßíËâ≤ËØ¥Áõ∏‰ººÁöÑËØùÔºâ
- Áº∫‰πè‰∫íÂä®ÊÄßÔºàÊ≤°ÊúâÊèêÈóÆÊàñÂºïÂØºÔºâ
- ËßíËâ≤ÂêåË¥®ÂåñÔºàÊâÄÊúâËßíËâ≤ÂõûÂ§çÈ£éÊ†ºÁõ∏ÂêåÔºâ

üí¨„ÄêÁ§∫‰æãÊ†áÂáÜ„ÄëÔºö
"Âê¨Âà∞‰Ω†ËØ¥Ëøô‰∏™ÊàëÁúüÁöÑÂæàÂºÄÂøÉÔºÅÊÑüËßâ‰Ω†‰ªäÂ§©ÁöÑÁä∂ÊÄÅÁâπÂà´Â•ΩÂë¢„ÄÇÊàë‰πüÊÉ≥ËØïËØï‰Ω†ËØ¥ÁöÑËøôÁßçÊñπÂºèÔºåËÉΩËØ¶ÁªÜË∑üÊàëËØ¥ËØ¥ÂÖ∑‰ΩìÊòØÊÄé‰πàÂÅöÁöÑÂêóÔºüË¶Å‰∏çÊàë‰ª¨Êâæ‰∏™Êó∂Èó¥‰∏ÄËµ∑‰ΩìÈ™å‰∏Ä‰∏ãÔºü"

‚ö†Ô∏è„ÄêËøùËßÑÂ§ÑÁêÜ„ÄëÔºö‰ªª‰Ωï‰∏çÁ¨¶Âêà‰ª•‰∏äÊ†áÂáÜÁöÑÂõûÂ§çÂ∞ÜË¢´ËßÜ‰∏∫Êó†ÊïàÔºåÂøÖÈ°ªÈáçÊñ∞ÁîüÊàê>`;
                
                // Áî®Êà∑ÂºÄÂßãÊñ∞ÁöÑÊ∂àÊÅØÂèëÈÄÅÊó∂ÈáçÁΩÆÈáçËØïËÆ°Êï∞
                QQ_ResetRetry();
                
                if (gening) {
                    triggerSlash("/echo ÁîüÊàê‰∏≠,ËØ∑ÂãøÈáçÂ§çÂèëÈÄÅ");
                    return;
                }
                let name;
                let value;
                if (!SendValue) {
                    console.log(`sendvalue‰∏∫Á©∫`);
                    const $container = $(event.target).closest(".QQ_chat_page");
                    const input = $container.find(".userInput");
                    const msgcontent = $container.find(".msgcontent");
                    let content = input.val()?.toString() ?? "";
                    content = QQ_MySendSpecial(content);
                    if (content) {
                        const SpecialHtml = QQ_Chat_SpecialMsg(
                            content,
                            `${UserName}`,
                            false,
                            true,
                        );
                        console.log(`ÁâπÊÆäÊ†ºÂºèÂ§ÑÁêÜÂêéÁöÑÂÜÖÂÆπ:\n${SpecialHtml}`);
                        const html = _.template(chat_user_message)({
                            content: SpecialHtml,
                        });
                        name = $container.attr("data-name") || "Êú™Áü•Áî®Êà∑";
                        console.log(`ÂèëÈÄÅÊñáÊú¨:${content} ÂØπË±°:${name}`);
                        msgcontent.append(html);
                        msgcontent.scrollTop(msgcontent[0].scrollHeight);
                        input.val("");
                    } else {
                        name = $container.attr("data-name") || "Êú™Áü•Áî®Êà∑";
                        console.warn("ÂèëÈÄÅÂÜÖÂÆπ‰∏∫Á©∫");
                    }
                    console.log(`ÁºìÂ≠òÊ∂àÊÅØ$:${QQ_CacheSendMsg}`);
                    if (QQ_Groups.includes(name)) {
                        if (QQ_CacheSendMsg) {
                            value = `${QQ_CacheSendMsg}`;
                            if (content) {
                                value += `\nÂú®Áæ§ËÅä"${name}"‰∏≠ÂèëÈÄÅ:${content}`;
                            }
                        } else {
                            value = `Âú®Áæ§ËÅä"${name}"‰∏≠ÂèëÈÄÅ:${content}`;
                        }
                        // Ê∑ªÂä†ÊòéÁ°ÆÁöÑÁæ§ËÅä‰∏ä‰∏ãÊñáÊåáÁ§∫
                        value += `\n<Context:ÂΩìÂâçÁî®Êà∑Ê≠£Âú®Áæ§ËÅä"${name}"‰∏≠ÔºåËØ∑Á°Æ‰øùÊâÄÊúâÂõûÂ§çÈÉΩÂú®Ê≠§Áæ§ËÅä‰∏≠ËøõË°å>`;
                    } else {
                        if (QQ_CacheSendMsg) {
                            value = `${QQ_CacheSendMsg}`;
                            if (content) {
                                value += `\nÁªô${name}ÂèëÊ∂àÊÅØ:${content}`;
                            }
                        } else {
                            value = `Áªô${name}ÂèëÊ∂àÊÅØ:${content}`;
                        }
                    }
                    if (!value && !QQ_CacheSendMsg) {
                        QQ_Error("ÂèëÈÄÅÊ∂àÊÅØ‰∏çËÉΩ‰∏∫Á©∫");
                        return;
                    }
                    QQ_CacheSendMsg = "";
                    if (value) {
                        // *** Êñ∞Â¢ûÔºöÊ£ÄÊµãÁî®Êà∑ËæìÂÖ•ÁöÑ‰∫íÂä®ÊÑèÂõæ ***
                        const userInput = content || SendValue || "";
                        const interactiveResult = QQ_DetectInteractiveIntent(userInput);
                        
                        if (interactiveResult && interactiveResult.isInteractive) {
                            console.log(`Ê£ÄÊµãÂà∞Áî®Êà∑‰∫íÂä®ÊÑèÂõæ: ${interactiveResult.description}`);
                            
                            if (interactiveResult.triggerType === 'symbol') {
                                // ÁâπÊÆäÁ¨¶Âè∑Ëß¶Âèë - Áõ¥Êé•ËØ∑Ê±Ç‰∫íÂä®ÂÜÖÂÆπ
                                console.log(`üéØ Áî®Êà∑‰∏ªÂä®ËØ∑Ê±Ç‰∫íÂä®: ${interactiveResult.triggerSymbol} -> ${interactiveResult.cleanContent}`);
                                const directInteractiveRequest = QQ_CreateDirectInteractiveRequest(interactiveResult.cleanContent);
                                value += `\n${timeContext}\n${directInteractiveRequest}`;
                            } else {
                                // ÂÖ≥ÈîÆËØçËß¶Âèë - ÊÉäÂñúÊ®°Âºè
                                console.log(`üí´ ÊÉäÂñúÊ®°ÂºèÊøÄÊ¥ª: Ê£ÄÊµãÂà∞ÂÖ≥ÈîÆËØç‰∫íÂä®ÊÑèÂõæ`);
                                const modifiedRequest = QQ_ModifyRequestForInteractive(Request);
                                value += `\n${timeContext}\n${modifiedRequest}`;
                            }
                        } else {
                            value += `\n${timeContext}\n${Request}`;
                        }
                        const namevalue = QQ_GetValueName(value);
                        if (namevalue) {
                            for (const match of namevalue) {
                                let localname = match.name;
                                let localmsg = match.value;
                                if (QQ_Groups.includes(localname)) {
                                    //type = 'Áæ§ËÅä';
                                    QQ_msgjson.Áæ§ËÅä[localname] =
                                        QQ_msgjson.Áæ§ËÅä[localname] || {};
                                    QQ_msgjson.Áæ§ËÅä[localname].msgs =
                                        QQ_msgjson.Áæ§ËÅä[localname].msgs || [];
                                    QQ_msgjson.Áæ§ËÅä[localname].msgs.push(
                                        `${UserName}--${localmsg}`,
                                    );
                                    console.log(`Âä†ÂÖ•Ëá™Â∑±ÂèëÁöÑÁæ§ËÅäÊ∂àÊÅØ: ${UserName}--${localmsg}`);
                                    User_LastMsgMap.Áæ§ËÅä[localname] =
                                        `${UserName}--${localmsg}`;
                                    
                                    // ÂêåÊ≠•‰øùÂ≠òÂà∞Áæ§ËÅä‰∏ìÁî®Â≠òÂÇ®ÔºàÁ°Æ‰øùÊ∂àÊÅØÊåÅ‰πÖÂåñÔºâ
                                    const currentTime = new Date().toLocaleTimeString('zh-CN', { hour12: false });
                                    const groupsForSync = await loadGroupChatsFromWorldbook();
                                    const targetGroup = groupsForSync.find(g => g.name === localname);
                                    if (targetGroup && targetGroup.id) {
                                        const messageObj = {
                                            sender: UserName,
                                            content: localmsg,
                                            timestamp: currentTime
                                        };
                                        saveGroupMessage(targetGroup.id, messageObj);
                                        
                                        // ‰øÆÂ§çÔºöÊ∑ªÂä†ÈîôËØØÂ§ÑÁêÜÔºåÈÅøÂÖçupdateGroupLastMessageÂáΩÊï∞Êä•Èîô
                                        try {
                                            await updateGroupLastMessage(targetGroup.id, localmsg);
                                            console.log(`Áæ§ËÅäÊ∂àÊÅØÂ∑≤ÂêåÊ≠•‰øùÂ≠òÂà∞‰∏ìÁî®Â≠òÂÇ®: ${localname}`);
                                        } catch (error) {
                                            console.warn('Êõ¥Êñ∞Áæ§ËÅäÊúÄÂêéÊ∂àÊÅØÂ§±Ë¥•Ôºå‰ΩÜ‰∏çÂΩ±ÂìçÊ∂àÊÅØÂèëÈÄÅ:', error);
                                        }
                                    }
                                } else {
                                    const key = `${UserName}Âíå${localname}ÁöÑËÅäÂ§©`;
                                    QQ_msgjson.ÁßÅËÅä[key] =
                                        QQ_msgjson.ÁßÅËÅä[key] || [];
                                    QQ_msgjson.ÁßÅËÅä[key].push(
                                        `${UserName}--${localmsg}`,
                                    );
                                    console.log(
                                        `Âä†ÂÖ•Ëá™Â∑±ÂèëÁöÑÁßÅËÅäÊ∂àÊÅØ: ${UserName}--${localmsg}`,
                                    );
                                    User_LastMsgMap.ÁßÅËÅä[localname] =
                                        `${UserName}--${localmsg}`;
                                }
                            }
                        }
                    } else {
                        QQ_Error("ÂèëÈÄÅÊ∂àÊÅØ‰∏çËÉΩ‰∏∫Á©∫");
                        return;
                    }
                } else {
                    console.log(`sendvalue‰∏ç‰∏∫Á©∫`);
                    value = SendValue;
                    name = SendName || "Êú™Áü•Áî®Êà∑";
                    if (QQ_Groups.includes(name)) {
                        value = `Âú®Áæ§ËÅä"${name}"‰∏≠ÂèëÈÄÅ:${SendValue}`;
                        value += `\n<Context:ÂΩìÂâçÁî®Êà∑Ê≠£Âú®Áæ§ËÅä"${name}"‰∏≠ÔºåËØ∑Á°Æ‰øùÊâÄÊúâÂõûÂ§çÈÉΩÂú®Ê≠§Áæ§ËÅä‰∏≠ËøõË°å>`;
                        User_LastMsgMap.Áæ§ËÅä[name] =
                            `${UserName}--${SendValue}`;
                    } else {
                        value = `Áªô${name}ÂèëÊ∂àÊÅØ:${SendValue}`;
                        User_LastMsgMap.ÁßÅËÅä[name] =
                            `${UserName}--${SendValue}`;
                    }
                    
                    // *** Êñ∞Â¢ûÔºöÂØπSendValue‰πüÊ£ÄÊµã‰∫íÂä®ÊÑèÂõæ ***
                    const sendValueInteractiveResult = QQ_DetectInteractiveIntent(SendValue);
                    
                    if (sendValueInteractiveResult && sendValueInteractiveResult.isInteractive) {
                        console.log(`Ê£ÄÊµãÂà∞SendValue‰∏≠ÁöÑ‰∫íÂä®ÊÑèÂõæ: ${sendValueInteractiveResult.description}`);
                        
                        if (sendValueInteractiveResult.triggerType === 'symbol') {
                            // ÁâπÊÆäÁ¨¶Âè∑Ëß¶Âèë - Áõ¥Êé•ËØ∑Ê±Ç‰∫íÂä®ÂÜÖÂÆπ
                            console.log(`üéØ SendValueÁî®Êà∑‰∏ªÂä®ËØ∑Ê±Ç‰∫íÂä®: ${sendValueInteractiveResult.triggerSymbol} -> ${sendValueInteractiveResult.cleanContent}`);
                            const directInteractiveRequest = QQ_CreateDirectInteractiveRequest(sendValueInteractiveResult.cleanContent);
                            value += `\n${timeContext}\n${directInteractiveRequest}`;
                        } else {
                            // ÂÖ≥ÈîÆËØçËß¶Âèë - ÊÉäÂñúÊ®°Âºè
                            console.log(`üí´ SendValueÊÉäÂñúÊ®°ÂºèÊøÄÊ¥ª: Ê£ÄÊµãÂà∞ÂÖ≥ÈîÆËØç‰∫íÂä®ÊÑèÂõæ`);
                            const modifiedRequest = QQ_ModifyRequestForInteractive(Request);
                            value += `\n${timeContext}\n${modifiedRequest}`;
                        }
                    } else {
                        value += `\n${timeContext}\n${Request}`;
                    }
                }
                console.log(
                    `User_LastMsg:\n${JSON.stringify(User_LastMsgMap)}`,
                );
                
                // ‰øùÂ≠òËØ∑Ê±Ç‰ø°ÊÅØÁî®‰∫éÈáçËØï
                QQ_LastRequest = value;
                QQ_LastRequestName = name || "";
                
                gening = true;
                let result;
                try {
                    QQ_CacheSendMsg = "";
                    result = await QQ_Gen(value);
                } finally {
                    gening = false;
                    console.log(`ÁîüÊàêÁªìÊùü`);
                    await QQ_Save_Msg(); // Á°Æ‰øùÂºÇÊ≠•‰øùÂ≠òÂÆåÊàê
                }
                await ResultHandle(result);
            }
            // Ê∑ªÂä†ÈáçËØïÁõ∏ÂÖ≥ÁöÑÂÖ®Â±ÄÂèòÈáè
            let QQ_RetryCount = 0;
            const QQ_MAX_RETRY = 3;
            let QQ_LastRequest = "";
            let QQ_LastRequestName = "";
            
            /**
             * ÈáçÁΩÆÈáçËØïÁä∂ÊÄÅ
             */
            function QQ_ResetRetry() {
                QQ_RetryCount = 0;
                QQ_LastRequest = "";
                QQ_LastRequestName = "";
            }

            /**
             * Ëé∑ÂèñÊó∂Èó¥ÊÆµÊèèËø∞
             * @param {number} hour - ÂΩìÂâçÂ∞èÊó∂Êï∞(0-23)
             * @returns {string} Êó∂Èó¥ÊÆµÊèèËø∞
             */
            function QQ_GetTimePeriod(hour) {
                if (hour >= 5 && hour < 8) {
                    return 'Ê∏ÖÊô®';
                } else if (hour >= 8 && hour < 11) {
                    return '‰∏äÂçà';
                } else if (hour >= 11 && hour < 13) {
                    return '‰∏≠Âçà';
                } else if (hour >= 13 && hour < 17) {
                    return '‰∏ãÂçà';
                } else if (hour >= 17 && hour < 19) {
                    return 'ÂÇçÊôö';
                } else if (hour >= 19 && hour < 22) {
                    return 'Êôö‰∏ä';
                } else {
                    return 'Ê∑±Â§ú';
                }
            }

            /**
             * Ëé∑ÂèñÂ≠£ËäÇÊèèËø∞
             * @param {number} month - ÂΩìÂâçÊúà‰ªΩ(1-12)
             * @returns {string} Â≠£ËäÇÊèèËø∞
             */
            function QQ_GetSeason(month) {
                if (month >= 3 && month <= 5) {
                    return 'Êò•Â≠£';
                } else if (month >= 6 && month <= 8) {
                    return 'Â§èÂ≠£';
                } else if (month >= 9 && month <= 11) {
                    return 'ÁßãÂ≠£';
                } else {
                    return 'ÂÜ¨Â≠£';
                }
            }

            async function ResultHandle(result, isRetry = false) {
                if (!result) {
                    // Á©∫ÂõûÂ§çÂ§ÑÁêÜ - ‰ΩøÁî®ÈáçËØïÊú∫Âà∂
                    if (!isRetry && QQ_RetryCount < QQ_MAX_RETRY) {
                        QQ_RetryCount++;
                        console.log(`AIÁ©∫ÂõûÂ§çÔºåÂºÄÂßãÁ¨¨${QQ_RetryCount}Ê¨°ÈáçËØï`);
                        triggerSlash(`/echo AIÁ©∫ÂõûÂ§çÔºåÊ≠£Âú®ÈáçËØï... (${QQ_RetryCount}/${QQ_MAX_RETRY})`);
                        
                        // ‰ΩøÁî®‰øùÂ≠òÁöÑÊúÄÂêéËØ∑Ê±ÇÈáçÊñ∞ÁîüÊàê
                        if (QQ_LastRequest) {
                            // Á°Æ‰øùÈáçËØïÊó∂ËÆæÁΩÆgeningÁä∂ÊÄÅ
                            gening = true;
                            try {
                                // Ê∑ªÂä†Âª∂ËøüÈÅøÂÖçËøáÂø´ÈáçËØïÔºàÈò≤Ê≠¢ÁºìÂ≠òÈóÆÈ¢òÔºâ
                                await new Promise(resolve => setTimeout(resolve, 1000 + QQ_RetryCount * 500));
                            const retryResult = await QQ_Gen(QQ_LastRequest);
                            return await ResultHandle(retryResult, true);
                            } finally {
                                gening = false;
                            }
                        }
                    } else {
                        // ÈáçËØïÊ¨°Êï∞Áî®ÂÆåÊàñÂÖ∂‰ªñÊÉÖÂÜµ
                        if (QQ_RetryCount >= QQ_MAX_RETRY) {
                            triggerSlash("/echo AIËøûÁª≠Á©∫ÂõûÂ§çÔºåÂèØËÉΩÂ≠òÂú®ÈóÆÈ¢òÔºåÂ∑≤ÂÅúÊ≠¢ÈáçËØï");
                        } else {
                            triggerSlash("/echo Á©∫ÂõûÂ§ç‰∫Ü");
                        }
                        QQ_ResetRetry();
                    }
                    return;
                }
                
                result = System_TagCompletion(result);
                console.log(`ÂºÄÂßãÂØπÁªìÊûúËøõË°åÂ§ÑÁêÜ:\n${result}`);
                const matches = [
                    ...result.matchAll(/MiPhone_start([\s\S]+?)MiPhone_end/g),
                ];
                
                if (matches.length == 0) {
                    // Ê≤°ÊúâÂõûÂ§çÁ∫ø‰∏äÊ†ºÂºè - ÂÖàÊ£ÄÊü•ÊòØÂê¶ÊúâcontentÊ†áÁ≠æÁöÑ‰∫íÂä®ÂÜÖÂÆπ
                    if (QQ_HasContentTag(result)) {
                        // ÊúâcontentÊ†áÁ≠æÔºåÁõ¥Êé•ÊòæÁ§∫‰∫íÂä®Á©∫Èó¥
                        console.log("Ê£ÄÊµãÂà∞contentÊ†áÁ≠æÂåÖË£πÁöÑ‰∫íÂä®ÂÜÖÂÆπÔºåÊòæÁ§∫‰∫íÂä®Á©∫Èó¥");
                        QQ_HandleInteractiveContent(result, QQ_LastRequestName);
                        QQ_ResetRetry();
                        return;
                    }
                    
                    // ‰ΩøÁî®ÈáçËØïÊú∫Âà∂
                    if (!isRetry && QQ_RetryCount < QQ_MAX_RETRY) {
                        QQ_RetryCount++;
                        console.log(`AIÊ≤°ÊúâÂõûÂ§çÁ∫ø‰∏äÊ†ºÂºèÔºåÂºÄÂßãÁ¨¨${QQ_RetryCount}Ê¨°ÈáçËØï`);
                        triggerSlash(`/echo AIÊ†ºÂºèÈîôËØØÔºåÊ≠£Âú®ÈáçËØï... (${QQ_RetryCount}/${QQ_MAX_RETRY})`);
                        
                        if (QQ_LastRequest) {
                            // ÈáçË¶ÅÔºöËÆæÁΩÆgeningÁä∂ÊÄÅÂíåÂºÇÊ≠•ÊâßË°åÈáçËØï
                            gening = true;
                            try {
                                // Ê∑ªÂä†Âª∂ËøüÈÅøÂÖçËøáÂø´ÈáçËØïÔºàÈò≤Ê≠¢ÁºìÂ≠òÈóÆÈ¢òÔºâ
                                await new Promise(resolve => setTimeout(resolve, 1000 + QQ_RetryCount * 500));
                                const retryResult = await QQ_Gen(QQ_LastRequest);
                                return await ResultHandle(retryResult, true);
                            } finally {
                                gening = false;
                            }
                        }
                    } else {
                        // ÈáçËØïÁî®ÂÆåÔºåÂà§Êñ≠ÊòØÂê¶‰∏∫‰∫íÂä®ÂÜÖÂÆπ
                        if (QQ_IsInteractiveContent(result)) {
                            // Âú®ÊâãÊú∫ÁïåÈù¢ÊòæÁ§∫‰∫íÂä®ÂÜÖÂÆπ
                            QQ_HandleInteractiveContent(result, QQ_LastRequestName);
                        } else {
                            triggerSlash("/echo AIÊ≤°ÊúâÂõûÂ§çÁ∫ø‰∏äÊ†ºÂºè,ÂéüÊñáÁõ¥Êé•ËæìÂá∫Âà∞Êñ∞Ê•ºÂ±Ç");
                            triggerSlash(`/sendas name={{char}} ${result}`);
                        }
                        QQ_ResetRetry();
                    }
                    return;
                } else if (matches.length > 1) {
                    // ÂõûÂ§ç‰∫ÜÂ§ö‰∏™Á∫ø‰∏äÊ†ºÂºè - ‰ΩøÁî®ÈáçËØïÊú∫Âà∂
                    if (!isRetry && QQ_RetryCount < QQ_MAX_RETRY) {
                        QQ_RetryCount++;
                        console.log(`AIÂõûÂ§ç‰∫ÜÂ§ö‰∏™Á∫ø‰∏äÊ†ºÂºèÔºåÂºÄÂßãÁ¨¨${QQ_RetryCount}Ê¨°ÈáçËØï`);
                        triggerSlash(`/echo AIÂõûÂ§çÂ§ö‰∏™Ê†ºÂºèÔºåÊ≠£Âú®ÈáçËØï... (${QQ_RetryCount}/${QQ_MAX_RETRY})`);
                        
                        if (QQ_LastRequest) {
                            // ÈáçË¶ÅÔºöËÆæÁΩÆgeningÁä∂ÊÄÅÂíåÂºÇÊ≠•ÊâßË°åÈáçËØï
                            gening = true;
                            try {
                                // Ê∑ªÂä†Âª∂ËøüÈÅøÂÖçËøáÂø´ÈáçËØïÔºàÈò≤Ê≠¢ÁºìÂ≠òÈóÆÈ¢òÔºâ
                                await new Promise(resolve => setTimeout(resolve, 1000 + QQ_RetryCount * 500));
                                const retryResult = await QQ_Gen(QQ_LastRequest);
                                return await ResultHandle(retryResult, true);
                            } finally {
                                gening = false;
                            }
                        }
                    } else {
                        // ÈáçËØïÁî®ÂÆåÔºåÂà§Êñ≠ÊòØÂê¶‰∏∫‰∫íÂä®ÂÜÖÂÆπ
                        if (QQ_IsInteractiveContent(result)) {
                            // Âú®ÊâãÊú∫ÁïåÈù¢ÊòæÁ§∫‰∫íÂä®ÂÜÖÂÆπ
                            QQ_HandleInteractiveContent(result, QQ_LastRequestName);
                        } else {
                            triggerSlash("/echo AIÂõûÂ§ç‰∫ÜÂ§ö‰∏™Á∫ø‰∏äÊ†ºÂºè,Áõ¥Êé•ËæìÂá∫Âà∞Êñ∞Ê•ºÂ±Ç");
                            triggerSlash(`/sendas name={{char}} ${result}`);
                        }
                        QQ_ResetRetry();
                    }
                    return;
                } else {
                    result = matches[0][1];
                }
                let ok = false;
                if (
                    result.indexOf("msg_start") < 0 ||
                    result.indexOf("msg_end") < 0
                ) {
                    // Ëá™Âä®Ë°•ÂÖ®tag
                    if (result.indexOf("msg_start") < 0) {
                        // Ê≤°ÊúâËµ∑ÂßãÊ†áËØÜ
                        let start = result.match(
                            /MiPhone_start[\s\S]*?(<Áæ§ËÅä:.+?>|<[^/]+Âíå.+ÁöÑ(?:ËÅäÂ§©|ÁßÅËÅä)>)/,
                        );
                        if (start) {
                            result = result.replace(
                                start[1],
                                `msg_start\n${start[1]}`,
                            );
                        }
                    }
                    if (result.indexOf("msg_end") < 0) {
                        // Ê≤°ÊúâÁªìÊùüÊ†áËØÜ
                        let end = result.match(
                            /<\/Áæ§ËÅä:.+?>|<\/.+Âíå.+ÁöÑ(?:ËÅäÂ§©|ÁßÅËÅä)>/gm,
                        );
                        if (end) {
                            result = result.replace(
                                end[end.length - 1],
                                `${end[end.length - 1]}\nmsg_end`,
                            );
                        }
                    }
                }
                const msg = result.match(/msg_start([\s\S]+?)msg_end/);
                if (msg) {
                    ok = true;
                    let json = JsonYamlParse(msg[1]);
                    if (!json) {
                        QQ_Error("AIËæìÂá∫ÁöÑÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÂèåÂáªËá™Â∑±Â§¥ÂÉèÈáçRoll");
                        return;
                    }
                    // triggerSlash(`/echo ÁîüÊàêÁªìÊûú${msg[1]}`);
                    json = QQ_Msg_DeletOld(json);
                    await QQ_Msg_Parse(JSON.stringify(json));
                }
                const momentes = result.matchAll(
                    /moment_start([\s\S]+?)moment_end/g,
                );
                if (momentes) {
                    ok = true;
                    for (const moment of momentes) {
                        // *** ‰øÆÂ§çÔºöÊ£ÄÊü•ÊòØÂê¶Âú®Âä®ÊÄÅËØÑËÆ∫‰∏ä‰∏ãÊñá‰∏≠ ***
                        const isInCommentContext = QQ_LastRequest && QQ_LastRequest.includes('Áî®Êà∑Âú®') && QQ_LastRequest.includes('ÁöÑÂä®ÊÄÅ‰∏ãËØÑËÆ∫');
                        QQ_Moment_Parse(moment[1], isInCommentContext);
                    }
                }
                
                // ÊàêÂäüÂ§ÑÁêÜÂêéÈáçÁΩÆÈáçËØïÁä∂ÊÄÅ
                if (ok) {
                    QQ_ResetRetry();
                }
                if (!ok) {
                    // ÊúÄÂêéÁöÑÊ†ºÂºèÊ£ÄÊü•Â§±Ë¥• - Âà§Êñ≠ÊòØÂê¶‰∏∫‰∫íÂä®ÂÜÖÂÆπ
                    if (QQ_IsInteractiveContent(result)) {
                        // Âú®ÊâãÊú∫ÁïåÈù¢ÊòæÁ§∫‰∫íÂä®ÂÜÖÂÆπ
                        QQ_HandleInteractiveContent(result, QQ_LastRequestName);
                    } else {
                        triggerSlash("/echo ÂõûÂ§ç‰∏ç‰∏∫Á©∫‰ΩÜ‰∏çÂ≠òÂú®ÊâãÊú∫Ê†ºÂºè,ËæìÂá∫Âà∞Êñ∞Ê•ºÂ±Ç");
                        triggerSlash(
                            `/sendas name={{char}} ${result
                                .replace("MiPhone_start", "")
                                .replace("MiPhone_end", "")}`,
                        );
                    }
                    QQ_ResetRetry();
                    return;
                }
                
                // ÊàêÂäüÂ§ÑÁêÜÔºåÈáçÁΩÆÈáçËØïËÆ°Êï∞
                QQ_ResetRetry();
                QQ_UpdateNewTips();
                QQ_Save_Msg();
            }

            /**
             * ÈáçÁΩÆÈáçËØïÁõ∏ÂÖ≥ÂèòÈáè
             */
            function QQ_ResetRetry() {
                QQ_RetryCount = 0;
                QQ_LastRequest = "";
                QQ_LastRequestName = "";
            }

            /**
             * Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´contentÊ†áÁ≠æ
             * @param {string} content - AIÂõûÂ§çÁöÑÂÜÖÂÆπ
             * @returns {boolean} ÊòØÂê¶ÂåÖÂê´contentÊ†áÁ≠æ
             */
            function QQ_HasContentTag(content) {
                // Ê£ÄÊü•ÂÆåÊï¥ÁöÑcontentÊ†áÁ≠æ
                if (/<content>[\s\S]*?<\/content>/i.test(content)) {
                    return true;
                }
                
                // Ê£ÄÊü•‰ª•<content>ÂºÄÂ§¥‰ΩÜÊ≤°ÊúâÁªìÂ∞æÁöÑÊÉÖÂÜµ
                if (/<content>/i.test(content) && !/<\/content>/i.test(content)) {
                    console.log('Ê£ÄÊµãÂà∞‰∏çÂÆåÊï¥ÁöÑcontentÊ†áÁ≠æÔºö‰ª•<content>ÂºÄÂ§¥‰ΩÜÁº∫Â∞ëÁªìÂ∞æ');
                    return true;
                }
                
                return false;
            }

            /**
             * Ê£ÄÊü•ÊòØÂê¶Êúâ‰∏çÂÆåÊï¥ÁöÑcontentÊ†áÁ≠æ
             * @param {string} content - ÂÜÖÂÆπ
             * @returns {boolean} ÊòØÂê¶‰∏∫‰∏çÂÆåÊï¥ÁöÑcontentÊ†áÁ≠æ
             */
            function QQ_HasIncompleteContentTag(content) {
                return /<content>/i.test(content) && !/<\/content>/i.test(content);
            }

            /**
             * ÊµãËØï‰∏çÂÆåÊï¥contentÊ†áÁ≠æÂ§ÑÁêÜÂäüËÉΩ
             * Áî®‰∫éÈ™åËØÅÁ≥ªÁªüÊòØÂê¶ËÉΩÊ≠£Á°ÆÂ§ÑÁêÜAIÂõûÂ§çÁöÑËæπÁºòÊÉÖÂÜµ
             */
            function QQ_TestIncompleteContentHandling() {
                console.log('=== ‰∏çÂÆåÊï¥contentÊ†áÁ≠æÂ§ÑÁêÜÊµãËØï ===');
                
                const testCases = [
                    {
                        name: 'ÂÆåÊï¥contentÊ†áÁ≠æ',
                        content: 'ËßíËâ≤Âêç--Ê≠£Â∏∏ÂõûÂ§ç\n<content>\nËøôÊòØ‰∏Ä‰∏™ÂÆåÊï¥ÁöÑ‰∫íÂä®ÂÜÖÂÆπ\n</content>',
                        expected: 'ËøôÊòØ‰∏Ä‰∏™ÂÆåÊï¥ÁöÑ‰∫íÂä®ÂÜÖÂÆπ'
                    },
                    {
                        name: '‰∏çÂÆåÊï¥contentÊ†áÁ≠æ',
                        content: 'ËßíËâ≤Âêç--Ê≠£Â∏∏ÂõûÂ§ç\n<content>\nËøôÊòØ‰∏Ä‰∏™‰∏çÂÆåÊï¥ÁöÑ‰∫íÂä®ÂÜÖÂÆπ\n<tableThink>ËøôÊòØÊÄùËÄÉÂÜÖÂÆπ</tableThink>',
                        expected: 'ËøôÊòØ‰∏Ä‰∏™‰∏çÂÆåÊï¥ÁöÑ‰∫íÂä®ÂÜÖÂÆπ'
                    },
                    {
                        name: 'Â∏¶considerÊ≥®ÈáäÁöÑÂÜÖÂÆπ',
                        content: 'ËßíËâ≤Âêç--Ê≠£Â∏∏ÂõûÂ§ç\n<!--consider: ËøôÊòØ‰∏Ä‰∏™ËÄÉËôëÊ≥®Èáä-->\n<content>\nÁ∫ØÂáÄÁöÑ‰∫íÂä®ÂÜÖÂÆπ\n</content>',
                        expected: 'Á∫ØÂáÄÁöÑ‰∫íÂä®ÂÜÖÂÆπ'
                    },
                    {
                        name: 'Â§çÊùÇÊ∑∑ÂêàÊÉÖÂÜµ',
                        content: 'ËßíËâ≤Âêç--Ê≠£Â∏∏ÂõûÂ§ç\n<!--consider: ËÄÉËôë‰∏Ä‰∏ã-->\n<content>\nÊ∑∑ÂêàÂÜÖÂÆπ\n<thinking>ÊÄùËÄÉ</thinking>\n<disclaimer>ÂÖçË¥£Â£∞Êòé</disclaimer>',
                        expected: 'Ê∑∑ÂêàÂÜÖÂÆπ'
                    }
                ];
                
                let passedTests = 0;
                testCases.forEach((testCase, index) => {
                    console.log(`\nÊµãËØï ${index + 1}: ${testCase.name}`);
                    console.log('ËæìÂÖ•ÂÜÖÂÆπ:', testCase.content);
                    
                    // ÊµãËØïcontentÊ†áÁ≠æÊ£ÄÊµã
                    const hasContent = QQ_HasContentTag(testCase.content);
                    const hasIncomplete = QQ_HasIncompleteContentTag(testCase.content);
                    
                    console.log('Ê£ÄÊµãÁªìÊûú - ÊúâcontentÊ†áÁ≠æ:', hasContent);
                    console.log('Ê£ÄÊµãÁªìÊûú - Êúâ‰∏çÂÆåÊï¥Ê†áÁ≠æ:', hasIncomplete);
                    
                    // ÊµãËØïcontentÊ†áÁ≠æÊ∏ÖÁêÜ
                    const cleanedContent = QQ_CleanContentTags(testCase.content);
                    console.log('Ê∏ÖÁêÜÂêéÂÜÖÂÆπ:', cleanedContent);
                    console.log('ÊúüÊúõÂÜÖÂÆπ:', testCase.expected);
                    
                    // È™åËØÅÁªìÊûú
                    const trimmedCleaned = cleanedContent.trim();
                    const trimmedExpected = testCase.expected.trim();
                    
                    if (trimmedCleaned === trimmedExpected) {
                        console.log('‚úÖ ÊµãËØïÈÄöËøá');
                        passedTests++;
                    } else {
                        console.log('‚ùå ÊµãËØïÂ§±Ë¥•');
                        console.log('Â∑ÆÂºÇÂàÜÊûê:');
                        console.log('- Ê∏ÖÁêÜÁªìÊûúÈïøÂ∫¶:', trimmedCleaned.length);
                        console.log('- ÊúüÊúõÁªìÊûúÈïøÂ∫¶:', trimmedExpected.length);
                    }
                });
                
                console.log(`\n=== ÊµãËØïÊÄªÁªì ===`);
                console.log(`ÈÄöËøáÊµãËØï: ${passedTests}/${testCases.length}`);
                console.log(`ÊµãËØïÊàêÂäüÁéá: ${(passedTests / testCases.length * 100).toFixed(1)}%`);
                
                return passedTests === testCases.length;
            }

            /**
             * Ê∏ÖÁêÜcontentÊ†áÁ≠æÂíåÂÖ∂‰ªñÊ†áÁ≠æÔºàÊîØÊåÅ‰∏çÂÆåÊï¥ÁöÑcontentÊ†áÁ≠æÔºâ
             * @param {string} content - ÂéüÂßãÂÜÖÂÆπ
             * @returns {string} Ê∏ÖÁêÜÂêéÁöÑÂÜÖÂÆπ
             */
            function QQ_CleanContentTags(content) {
                let cleanContent;
                
                // Â§ÑÁêÜÂÆåÊï¥ÁöÑcontentÊ†áÁ≠æ
                const completeMatch = content.match(/<content>([\s\S]*?)<\/content>/i);
                if (completeMatch) {
                    cleanContent = completeMatch[1];
                    console.log('Â§ÑÁêÜÂÆåÊï¥ÁöÑcontentÊ†áÁ≠æ');
                } else {
                    // Â§ÑÁêÜ‰∏çÂÆåÊï¥ÁöÑcontentÊ†áÁ≠æÔºà‰ª•<content>ÂºÄÂ§¥Âà∞ÁªìÂ∞æÔºâ
                    const incompleteMatch = content.match(/<content>([\s\S]*?)$/i);
                    if (incompleteMatch) {
                        cleanContent = incompleteMatch[1];
                        console.log('Â§ÑÁêÜ‰∏çÂÆåÊï¥ÁöÑcontentÊ†áÁ≠æÔºåÊèêÂèñ<content>‰πãÂêéÁöÑÊâÄÊúâÂÜÖÂÆπ');
                    } else {
                        // Ê≤°ÊúâcontentÊ†áÁ≠æÔºåËøîÂõûÂéüÂÜÖÂÆπ
                        return content;
                    }
                }
                
                // ÁßªÈô§ÂÖ∂‰ªñÁ≥ªÁªüÊ†áÁ≠æÂèäÂÖ∂ÂÜÖÂÆπ
                cleanContent = cleanContent.replace(/<consider>[\s\S]*?<\/consider>/gi, '');
                cleanContent = cleanContent.replace(/<thinking>[\s\S]*?<\/thinking>/gi, '');
                cleanContent = cleanContent.replace(/<tableThink>[\s\S]*?<\/tableThink>/gi, '');
                cleanContent = cleanContent.replace(/<tableEdit>[\s\S]*?<\/tableEdit>/gi, '');
                cleanContent = cleanContent.replace(/<disclaimer>[\s\S]*?<\/disclaimer>/gi, '');
                
                // ÁßªÈô§HTMLÊ≥®ÈáäÊ†ºÂºèÁöÑconsiderÊ†áÁ≠æÔºàÊñ∞Â¢ûÔºâ
                cleanContent = cleanContent.replace(/<!--\s*consider:\s*[\s\S]*?-->/gi, '');
                
                // ÁßªÈô§Êú™Èó≠ÂêàÁöÑÁ≥ªÁªüÊ†áÁ≠æ
                cleanContent = cleanContent.replace(/<(?:consider|thinking|tableThink|tableEdit|disclaimer)>[\s\S]*$/gi, '');
                
                // Ê∏ÖÁêÜÂ§ö‰ΩôÁöÑÁ©∫ÁôΩÂíåÊç¢Ë°å
                cleanContent = cleanContent.replace(/\n\s*\n/g, '\n').trim();
                
                console.log('contentÊ†áÁ≠æÊ∏ÖÁêÜÂÆåÊàêÔºåÊèêÂèñÁöÑÂÜÖÂÆπ:', cleanContent);
                
                return cleanContent;
            }

            /**
             * Âà§Êñ≠ÊòØÂê¶‰∏∫‰∫íÂä®ÂÜÖÂÆπ
             * @param {string} content - AIÂõûÂ§çÁöÑÂÜÖÂÆπ
             * @returns {boolean} ÊòØÂê¶‰∏∫‰∫íÂä®ÂÜÖÂÆπ
             */
            function QQ_IsInteractiveContent(content) {
                // Â¶ÇÊûúÊúâcontentÊ†áÁ≠æÔºåÁõ¥Êé•ËÆ§‰∏∫ÊòØ‰∫íÂä®ÂÜÖÂÆπ
                if (QQ_HasContentTag(content)) {
                    return true;
                }
                
                // ÁßªÈô§Ê†ºÂºèÊ†áÁ≠æÂêéÁöÑÂÜÖÂÆπ
                const cleanContent = content
                    .replace(/MiPhone_start/g, "")
                    .replace(/MiPhone_end/g, "")
                    .trim();
                
                // ÊéíÈô§ÊòéÊòæ‰∏çÊòØ‰∫íÂä®ÂÜÖÂÆπÁöÑÊÉÖÂÜµ
                if (!cleanContent || cleanContent.length < 10 || cleanContent.length > 2000) {
                    return false;
                }
                
                // ÊéíÈô§ÊòéÊòæÁöÑÈîôËØØ‰ø°ÊÅØÂíåÁ≥ªÁªüÊ∂àÊÅØ
                const excludePatterns = [
                    /ÈîôËØØ/,
                    /error/i,
                    /fail/i,
                    /exception/i,
                    /Êó†Ê≥ï/,
                    /‰∏çËÉΩ/,
                    /Â§±Ë¥•/,
                    /<[^>]+>/,  // HTMLÊ†áÁ≠æ
                    /```/,      // ‰ª£Á†ÅÂùó
                    /https?:\/\//,  // URLÈìæÊé•
                ];
                
                if (excludePatterns.some(pattern => pattern.test(cleanContent))) {
                    return false;
                }
                
                // ‰∫íÂä®ÂÜÖÂÆπÁâπÂæÅÊ®°Âºè
                const interactivePatterns = [
                    /\*[^*]+\*/,  // *Âä®‰ΩúÊèèËø∞*
                    /Ôºà[^Ôºâ]*(?:‰∫íÂä®|Êé•Ëß¶|Ëß¶Êë∏|Êã•Êä±|‰∫≤Âêª|ÊäöÊë∏|ÁâµÊâã)[^Ôºâ]*Ôºâ/,  // ÂÖ∑‰Ωì‰∫íÂä®Âä®‰Ωú
                    /„Äê[^„Äë]*(?:ÊÉÖÊÑü|ÂøÉÊÉÖ|ÊÉ≥Ê≥ï|ÂÜÖÂøÉ)[^„Äë]*„Äë/,  // ÊÉÖÊÑü/ÂÜÖÂøÉÊèèËø∞
                    /(?:Áé∞ÂÆû‰∏≠|Èù¢ÂØπÈù¢|ÂΩìÈù¢|ÂÆûÈôÖ‰∏ä|ÁúüÂÆû)/,  // Áé∞ÂÆûÁõ∏ÂÖ≥
                    /(?:Ë∫´‰Ωì|ÁúºÁ•û|Ë°®ÊÉÖ|ÂßøÊÄÅ|Âä®‰Ωú|ÊâãÂäø|Â£∞Èü≥|ÂëºÂê∏)/,  // Ë∫´‰ΩìÁõ∏ÂÖ≥
                    /(?:ËΩªËΩª|ÊÖ¢ÊÖ¢|ÁºìÁºì|ÊÇÑÊÇÑ|Â∞èÂøÉÁøºÁøº|Ê∏©Êüî)[Âú∞ÁöÑ]/,  // Âä®‰ΩúÂâØËØç
                    /(?:Èù†Ëøë|ËøúÁ¶ª|ËΩ¨Ë∫´|Êä¨Â§¥|‰ΩéÂ§¥|Èó≠Áúº|ÁùÅÁúº)/,  // ÂÖ∑‰ΩìÂä®‰Ωú
                    /(?:ÊÑüËßâÂà∞|ÊÑèËØÜÂà∞|Ê≥®ÊÑèÂà∞|ÂèëÁé∞|ÂØüËßâ)/,  // ÊÑüÁü•Áõ∏ÂÖ≥
                    /(?:Ê∞õÂõ¥|ÁéØÂ¢É|Âë®Âõ¥|Á©∫Ê∞î‰∏≠)/,  // ÁéØÂ¢ÉÊèèËø∞
                ];
                
                // ËÆ°ÁÆóÂåπÈÖçÁöÑÊ®°ÂºèÊï∞Èáè
                const matchCount = interactivePatterns.reduce((count, pattern) => {
                    return count + (pattern.test(cleanContent) ? 1 : 0);
                }, 0);
                
                // ÈúÄË¶ÅËá≥Â∞ëÂåπÈÖç2‰∏™Ê®°ÂºèÊâçËÆ§‰∏∫ÊòØ‰∫íÂä®ÂÜÖÂÆπÔºåÂ¢ûÂä†ÂáÜÁ°ÆÊÄß
                return matchCount >= 2;
            }

            // ===== ‰∫íÂä®Á©∫Èó¥ÁÆ°ÁêÜÁ≥ªÁªü =====
            
            // *** ‰ºòÂåñÔºöÂÖ®Â±ÄÂèòÈáè‰ªÖ‰Ωú‰∏∫‰∏ñÁïå‰π¶Êï∞ÊçÆÁöÑ‰∏¥Êó∂ÁºìÂ≠ò ***
            let QQ_InteractiveSpaces = {}; // ÂÖ¨ÂÖ±‰∫íÂä®Á©∫Èó¥‰∏¥Êó∂ÁºìÂ≠òÔºàÊï∞ÊçÆÂ≠òÂÇ®Âú®‰∏ñÁïå‰π¶‰∏≠Ôºâ
            let QQ_CharacterSpaces = {}; // ËßíËâ≤‰∏ìÂ±û‰∫íÂä®Á©∫Èó¥‰∏¥Êó∂ÁºìÂ≠òÔºàÊï∞ÊçÆÂ≠òÂÇ®Âú®‰∏ñÁïå‰π¶‰∏≠Ôºâ
            
            /**
             * Á°Æ‰øùËßíËâ≤‰∫íÂä®Á©∫Èó¥ÁöÑÁã¨Á´ãÊÄß
             * @param {string} characterName - ËßíËâ≤ÂêçÁß∞
             */
            function QQ_EnsureCharacterSpaceIndependence(characterName) {
                if (!characterName || typeof characterName !== 'string') {
                    console.warn('QQ_EnsureCharacterSpaceIndependence: Êó†ÊïàÁöÑËßíËâ≤ÂêçÁß∞', characterName);
                    return false;
                }
                
                // Á°Æ‰øùÊØè‰∏™ËßíËâ≤ÈÉΩÊúâÁã¨Á´ãÁöÑÁ©∫Èó¥ÂØπË±°
                if (!QQ_CharacterSpaces[characterName]) {
                    QQ_CharacterSpaces[characterName] = {};
                    console.log(`‰∏∫ËßíËâ≤ "${characterName}" ÂàõÂª∫‰∫ÜÁã¨Á´ãÁöÑ‰∫íÂä®Á©∫Èó¥ÂÆπÂô®`);
                }
                
                // È™åËØÅÁã¨Á´ãÊÄß - Á°Æ‰øù‰∏ç‰ºöÂºïÁî®ÂÖ∂‰ªñËßíËâ≤ÁöÑÊï∞ÊçÆ
                const characterSpace = QQ_CharacterSpaces[characterName];
                const allCharacters = Object.keys(QQ_CharacterSpaces);
                
                for (const otherChar of allCharacters) {
                    if (otherChar !== characterName && QQ_CharacterSpaces[otherChar] === characterSpace) {
                        console.error(`Ê£ÄÊµãÂà∞ËßíËâ≤Á©∫Èó¥Êï∞ÊçÆÂºïÁî®ÂÜ≤Á™Å: ${characterName} Âíå ${otherChar} ÂÖ±‰∫´Âêå‰∏Ä‰∏™ÂØπË±°`);
                        QQ_CharacterSpaces[characterName] = {};
                        console.log(`Â∑≤‰∏∫ËßíËâ≤ "${characterName}" ÈáçÊñ∞ÂàõÂª∫Áã¨Á´ãÁöÑÁ©∫Èó¥ÂØπË±°`);
                        break;
                    }
                }
                
                return true;
            }
            
            /**
             * ÊµãËØïËßíËâ≤‰∫íÂä®Á©∫Èó¥ÁöÑÁã¨Á´ãÊÄß
             * Áî®‰∫éË∞ÉËØïÂíåÈ™åËØÅ
             */
            function QQ_TestCharacterSpaceIndependence() {
                console.log('=== ËßíËâ≤‰∫íÂä®Á©∫Èó¥Áã¨Á´ãÊÄßÊµãËØï ===');
                
                // ÂàõÂª∫ÊµãËØïËßíËâ≤
                const testCharacters = ['ËßíËâ≤A', 'ËßíËâ≤B', 'ËßíËâ≤C'];
                
                testCharacters.forEach(charName => {
                    QQ_EnsureCharacterSpaceIndependence(charName);
                });
                
                // È™åËØÅÁã¨Á´ãÊÄß
                const spaces = {};
                testCharacters.forEach(charName => {
                    spaces[charName] = QQ_CharacterSpaces[charName];
                });
                
                // Ê£ÄÊü•ÊòØÂê¶ÊúâÂºïÁî®ÂÜ≤Á™Å
                let hasConflict = false;
                for (let i = 0; i < testCharacters.length; i++) {
                    for (let j = i + 1; j < testCharacters.length; j++) {
                        const char1 = testCharacters[i];
                        const char2 = testCharacters[j];
                        if (spaces[char1] === spaces[char2]) {
                            console.error(`Ê£ÄÊµãÂà∞ÂºïÁî®ÂÜ≤Á™Å: ${char1} Âíå ${char2} ÂÖ±‰∫´Âêå‰∏Ä‰∏™ÂØπË±°`);
                            hasConflict = true;
                        }
                    }
                }
                
                if (!hasConflict) {
                    console.log('‚úÖ ÊâÄÊúâËßíËâ≤ÁöÑ‰∫íÂä®Á©∫Èó¥ÈÉΩÊòØÁã¨Á´ãÁöÑ');
                } else {
                    console.error('‚ùå Ê£ÄÊµãÂà∞ËßíËâ≤‰∫íÂä®Á©∫Èó¥Êï∞ÊçÆÂºïÁî®ÂÜ≤Á™Å');
                }
                
                // ÊµãËØïÊ∑ªÂä†Êï∞ÊçÆÁöÑÁã¨Á´ãÊÄß
                QQ_CharacterSpaces['ËßíËâ≤A']['test_space_1'] = { id: 'test1', name: 'ÊµãËØïÁ©∫Èó¥A' };
                QQ_CharacterSpaces['ËßíËâ≤B']['test_space_2'] = { id: 'test2', name: 'ÊµãËØïÁ©∫Èó¥B' };
                
                if (QQ_CharacterSpaces['ËßíËâ≤A']['test_space_2']) {
                    console.error('‚ùå Êï∞ÊçÆÊ≥ÑÈú≤: ËßíËâ≤A ËÆøÈóÆÂà∞‰∫ÜËßíËâ≤BÁöÑÊï∞ÊçÆ');
                } else if (QQ_CharacterSpaces['ËßíËâ≤B']['test_space_1']) {
                    console.error('‚ùå Êï∞ÊçÆÊ≥ÑÈú≤: ËßíËâ≤B ËÆøÈóÆÂà∞‰∫ÜËßíËâ≤AÁöÑÊï∞ÊçÆ');
                } else {
                    console.log('‚úÖ ËßíËâ≤Êï∞ÊçÆÊ∑ªÂä†Áã¨Á´ãÊÄßÊµãËØïÈÄöËøá');
                }
                
                console.log('ÂΩìÂâçËßíËâ≤Á©∫Èó¥Êï∞ÊçÆÁªìÊûÑ:', QQ_CharacterSpaces);
                
                return !hasConflict;
            }
            
            /**
             * ÊµãËØïÁßÅËÅäÁïåÈù¢ÂêçÁß∞ÁÇπÂáªÂäüËÉΩ
             * Áî®‰∫éË∞ÉËØïÈ™åËØÅÁÇπÂáª‰∫ã‰ª∂ÊòØÂê¶Ê≠£Â∏∏Â∑•‰Ωú
             */
            function QQ_TestChatTitleClick() {
                console.log('=== ÁßÅËÅäÁïåÈù¢ÂêçÁß∞ÁÇπÂáªÂäüËÉΩÊµãËØï ===');
                
                // Ê£ÄÊü•ÂΩìÂâçÊòØÂê¶Âú®ÁßÅËÅäÁïåÈù¢
                const chatPage = document.querySelector('.QQ_chat_page');
                if (!chatPage) {
                    console.warn('ÂΩìÂâç‰∏çÂú®ËÅäÂ§©ÁïåÈù¢ÔºåÊó†Ê≥ïÊµãËØïÁÇπÂáªÂäüËÉΩ');
                    return false;
                }
                
                // Êü•ÊâæËÅäÂ§©Ê†áÈ¢òÂÖÉÁ¥†
                const chatTitle = document.getElementById('QQ_chat_username');
                if (!chatTitle) {
                    console.error('‚ùå Êâæ‰∏çÂà∞ËÅäÂ§©Ê†áÈ¢òÂÖÉÁ¥† #QQ_chat_username');
                    return false;
                }
                
                console.log('‚úÖ ÊâæÂà∞ËÅäÂ§©Ê†áÈ¢òÂÖÉÁ¥†:', chatTitle);
                console.log('Ê†áÈ¢òÊñáÊú¨:', chatTitle.textContent);
                console.log('onclickÂ±ûÊÄß:', chatTitle.getAttribute('onclick'));
                
                // Ê£ÄÊü•handleChatTitleClickÂáΩÊï∞ÊòØÂê¶Â≠òÂú®
                if (typeof handleChatTitleClick === 'function') {
                    console.log('‚úÖ handleChatTitleClick ÂáΩÊï∞Â≠òÂú®');
                } else {
                    console.error('‚ùå handleChatTitleClick ÂáΩÊï∞‰∏çÂ≠òÂú®');
                    return false;
                }
                
                // Ê£ÄÊü•QQ_ShowCharacterInteractiveMenuÂáΩÊï∞ÊòØÂê¶Â≠òÂú®
                if (typeof QQ_ShowCharacterInteractiveMenu === 'function') {
                    console.log('‚úÖ QQ_ShowCharacterInteractiveMenu ÂáΩÊï∞Â≠òÂú®');
                } else {
                    console.error('‚ùå QQ_ShowCharacterInteractiveMenu ÂáΩÊï∞‰∏çÂ≠òÂú®');
                    return false;
                }
                
                // Ê®°ÊãüÁÇπÂáªÊµãËØï
                try {
                    console.log('üî® Ê®°ÊãüÁÇπÂáªËÅäÂ§©Ê†áÈ¢ò...');
                    chatTitle.click();
                    console.log('‚úÖ ÁÇπÂáª‰∫ã‰ª∂ÊâßË°åÂÆåÊàê');
                    
                    // Ê£ÄÊü•ÊòØÂê¶Âá∫Áé∞‰∫ÜËßíËâ≤ËèúÂçï
                    setTimeout(() => {
                        const menu = document.querySelector('.QQ_character_menu');
                        if (menu) {
                            console.log('‚úÖ ËßíËâ≤‰∫íÂä®ËèúÂçïÊàêÂäüÊòæÁ§∫');
                            console.log('ËèúÂçïÂÖÉÁ¥†:', menu);
                        } else {
                            console.warn('‚ö†Ô∏è ÁÇπÂáªÂêéÊú™ÊòæÁ§∫ËßíËâ≤‰∫íÂä®ËèúÂçï');
                        }
                    }, 100);
                    
                } catch (error) {
                    console.error('‚ùå ÁÇπÂáªÊµãËØïÂ§±Ë¥•:', error);
                    return false;
                }
                
                return true;
            }
            
            /**
             * ÊµãËØï‰∏çÂÆåÊï¥contentÊ†áÁ≠æÂ§ÑÁêÜÂäüËÉΩ
             * Áî®‰∫éÈ™åËØÅAIÂõûÂ§çÊ†ºÂºè‰øÆÂ§ç
             */
            function QQ_TestIncompleteContentHandling() {
                console.log('=== ÊµãËØï‰∏çÂÆåÊï¥contentÊ†áÁ≠æÂ§ÑÁêÜ ===');
                
                // ÊµãËØïÁî®‰æã1ÔºöÂÆåÊï¥ÁöÑcontentÊ†áÁ≠æ
                const completeCase = `ËßíËâ≤ÂõûÂ§çÂÜÖÂÆπ
<content>
*ËΩªËΩªËµ∞ËøáÊù•Ôºå‰º∏Âá∫Êâã* "Êù•ÔºåÊàë‰ª¨‰∏ÄËµ∑ÂéªÈÇ£ËæπÁúãÁúãÂêß"
</content>`;
                
                // ÊµãËØïÁî®‰æã2Ôºö‰∏çÂÆåÊï¥ÁöÑcontentÊ†áÁ≠æ
                const incompleteCase = `ËßíËâ≤ÂõûÂ§çÂÜÖÂÆπ
<content>
*ËΩªËΩªËµ∞ËøáÊù•Ôºå‰º∏Âá∫Êâã* "Êù•ÔºåÊàë‰ª¨‰∏ÄËµ∑ÂéªÈÇ£ËæπÁúãÁúãÂêß"
<tableThink>
ÊÄùËÄÉÂÜÖÂÆπ...
</tableThink>
<disclaimer>
ÂÖçË¥£Â£∞ÊòéÂÜÖÂÆπ
</disclaimer>`;
                
                // ÊµãËØïÁî®‰æã3ÔºöÊ≤°ÊúâcontentÊ†áÁ≠æ
                const noContentCase = `ÊôÆÈÄöÁöÑËßíËâ≤ÂõûÂ§çÂÜÖÂÆπÔºåÊ≤°ÊúâÁâπÊÆäÊ†áÁ≠æ`;
                
                console.log('--- ÊµãËØïÂÆåÊï¥contentÊ†áÁ≠æ ---');
                console.log('ÂéüÊñá:', completeCase);
                console.log('Ê£ÄÊµãÁªìÊûú:', QQ_HasContentTag(completeCase));
                console.log('ÊòØÂê¶‰∏çÂÆåÊï¥:', QQ_HasIncompleteContentTag(completeCase));
                console.log('Ê∏ÖÁêÜÁªìÊûú:', QQ_CleanContentTags(completeCase));
                
                console.log('\n--- ÊµãËØï‰∏çÂÆåÊï¥contentÊ†áÁ≠æ ---');
                console.log('ÂéüÊñá:', incompleteCase);
                console.log('Ê£ÄÊµãÁªìÊûú:', QQ_HasContentTag(incompleteCase));
                console.log('ÊòØÂê¶‰∏çÂÆåÊï¥:', QQ_HasIncompleteContentTag(incompleteCase));
                console.log('Ê∏ÖÁêÜÁªìÊûú:', QQ_CleanContentTags(incompleteCase));
                
                console.log('\n--- ÊµãËØïÊó†contentÊ†áÁ≠æ ---');
                console.log('ÂéüÊñá:', noContentCase);
                console.log('Ê£ÄÊµãÁªìÊûú:', QQ_HasContentTag(noContentCase));
                console.log('ÊòØÂê¶‰∏çÂÆåÊï¥:', QQ_HasIncompleteContentTag(noContentCase));
                console.log('Ê∏ÖÁêÜÁªìÊûú:', QQ_CleanContentTags(noContentCase));
                
                return true;
            }
            
            /**
             * ÊµãËØïÈáçËØïÊú∫Âà∂Áä∂ÊÄÅÂíåÂª∂ËøüÂäüËÉΩ
             * Áî®‰∫éÈ™åËØÅÈáçËØïÊòØÂê¶Ê≠£Â∏∏Â∑•‰Ωú
             */
            function QQ_TestRetryMechanism() {
                console.log('=== ÈáçËØïÊú∫Âà∂Áä∂ÊÄÅÊµãËØï ===');
                console.log('ÂΩìÂâçÈáçËØïÊ¨°Êï∞:', QQ_RetryCount);
                console.log('ÊúÄÂ§ßÈáçËØïÊ¨°Êï∞:', QQ_MAX_RETRY);
                console.log('ÊúÄÂêéËØ∑Ê±ÇÂÜÖÂÆπ:', QQ_LastRequest ? 'ÊúâÂÜÖÂÆπ' : 'Êó†ÂÜÖÂÆπ');
                console.log('ÊúÄÂêéËØ∑Ê±ÇËßíËâ≤Âêç:', QQ_LastRequestName);
                console.log('ÂΩìÂâçgeningÁä∂ÊÄÅ:', typeof gening !== 'undefined' ? gening : 'Êú™ÂÆö‰πâ');
                
                // ÊµãËØïÂª∂ËøüËÆ°ÁÆó
                for (let i = 1; i <= QQ_MAX_RETRY; i++) {
                    const delay = 1000 + i * 500;
                    console.log(`Á¨¨${i}Ê¨°ÈáçËØïÂª∂Ëøü: ${delay}ms`);
                }
                
                return {
                    retryCount: QQ_RetryCount,
                    maxRetry: QQ_MAX_RETRY,
                    hasLastRequest: !!QQ_LastRequest,
                    lastRequestName: QQ_LastRequestName
                };
            }
            
            /**
             * Ê®°ÊãüÈáçËØïÂª∂ËøüÊµãËØï
             * Áî®‰∫éÈ™åËØÅÂª∂ËøüÊú∫Âà∂ÊòØÂê¶Â∑•‰Ωú
             */
            async function QQ_TestRetryDelay() {
                console.log('=== Ê®°ÊãüÈáçËØïÂª∂ËøüÊµãËØï ===');
                
                for (let i = 1; i <= 3; i++) {
                    const delay = 1000 + i * 500;
                    console.log(`Ê®°ÊãüÁ¨¨${i}Ê¨°ÈáçËØïÔºåÂª∂Ëøü${delay}ms...`);
                    const startTime = Date.now();
                    
                    await new Promise(resolve => setTimeout(resolve, delay));
                    
                    const actualDelay = Date.now() - startTime;
                    console.log(`Á¨¨${i}Ê¨°ÈáçËØïÂÆåÊàêÔºåÂÆûÈôÖÂª∂Ëøü: ${actualDelay}ms`);
                }
                
                console.log('Âª∂ËøüÊµãËØïÂÆåÊàê');
                return true;
            }
            
            /**
             * Ë∞ÉËØïÁßÅËÅäÁïåÈù¢ÁÇπÂáªÂäüËÉΩ - ÊâãÂä®Ë∞ÉÁî®ËèúÂçïÊòæÁ§∫
             * Áî®‰∫éÂú®ÊéßÂà∂Âè∞ÊâãÂä®ÊµãËØï
             */
            function QQ_DebugShowCharacterMenu() {
                console.log('=== ÊâãÂä®ÊµãËØïËßíËâ≤‰∫íÂä®ËèúÂçï ===');
                
                // Ê£ÄÊü•ÂΩìÂâçËÅäÂ§©ÁïåÈù¢ÁöÑËßíËâ≤ÂêçÁß∞
                const chatTitle = document.getElementById('QQ_chat_username');
                if (!chatTitle) {
                    console.error('Êâæ‰∏çÂà∞ËÅäÂ§©Ê†áÈ¢òÂÖÉÁ¥†');
                    return;
                }
                
                const characterName = chatTitle.textContent.trim();
                console.log('ÂΩìÂâçËßíËâ≤ÂêçÁß∞:', characterName);
                
                // Áõ¥Êé•Ë∞ÉÁî®ËèúÂçïÊòæÁ§∫ÂáΩÊï∞
                QQ_ShowCharacterInteractiveMenu(characterName, chatTitle);
            }
            
            let QQ_ActiveSpaceId = null; // ÂΩìÂâçÊ¥ªÂä®ÁöÑ‰∫íÂä®Á©∫Èó¥ID
            let QQ_SpiritVisible = false; // Á≤æÁÅµÊåâÈíÆÊòØÂê¶ÂèØËßÅ
            const QQ_INTERACTIVE_BACKUP_KEY = "QQ_‰∫íÂä®Á©∫Èó¥Â§á‰ªΩ";
            const QQ_CHARACTER_SPACES_KEY = "QQ_ËßíËâ≤‰∫íÂä®Á©∫Èó¥Â§á‰ªΩ";
            
            // ===== ‰∏ªÂä®‰∫íÂä®Ê£ÄÊµãÁ≥ªÁªü =====
            
            /**
             * Ê£ÄÊµãÁî®Êà∑Ê∂àÊÅØÊòØÂê¶ÂåÖÂê´ÊòéÊòæÁöÑ‰∫íÂä®ÊÑèÂõæ
             * @param {string} content - Áî®Êà∑Ê∂àÊÅØÂÜÖÂÆπ
             * @returns {boolean|Object} - Â¶ÇÊûúÊ£ÄÊµãÂà∞‰∫íÂä®ÊÑèÂõæËøîÂõûtrueÊàñÂåÖÂê´ËØ¶ÁªÜ‰ø°ÊÅØÁöÑÂØπË±°
             */
            function QQ_DetectInteractiveIntent(content) {
                if (!content || typeof content !== 'string') return false;
                
                const originalText = content.trim();
                const text = content.toLowerCase().trim();
                
                // *** ‰ºòÂÖàÊ£ÄÊµãÔºöÁâπÊÆäÁ¨¶Âè∑Ëß¶Âèë ***
                const INTERACTIVE_TRIGGER_SYMBOLS = ['&&', 'ÔºÜÔºÜ', '&amp;&amp;'];
                
                for (const symbol of INTERACTIVE_TRIGGER_SYMBOLS) {
                    if (originalText.includes(symbol)) {
                        console.log(`üéØ Ê£ÄÊµãÂà∞‰∫íÂä®Ëß¶ÂèëÁ¨¶Âè∑: ${symbol}`);
                        
                        // Ê∏ÖÁêÜÁ¨¶Âè∑ÂêéÁöÑÂÜÖÂÆπ‰Ωú‰∏∫‰∫íÂä®ÊèèËø∞
                        let cleanContent = originalText;
                        INTERACTIVE_TRIGGER_SYMBOLS.forEach(sym => {
                            cleanContent = cleanContent.replace(new RegExp(sym.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), '');
                        });
                        cleanContent = cleanContent.trim();
                        
                        return {
                            isInteractive: true,
                            triggerType: 'symbol',
                            triggerSymbol: symbol,
                            cleanContent: cleanContent || 'ÊÉ≥Ë¶ÅËøõË°å‰∫íÂä®',
                            description: 'Áî®Êà∑‰ΩøÁî®ÁâπÊÆäÁ¨¶Âè∑‰∏ªÂä®ËØ∑Ê±Ç‰∫íÂä®ÂÜÖÂÆπ'
                        };
                    }
                }
                
                // *** Ê£ÄÊü•Áî®Êà∑ËÆæÁΩÆÔºöÊòØÂê¶ÂêØÁî®ÂÖ≥ÈîÆËØçËß¶Âèë ***
                const interactiveSettings = QQ_GetInteractiveSettings();
                
                if (!interactiveSettings.enableKeywordTrigger) {
                    console.log('‚öôÔ∏è ÂÖ≥ÈîÆËØçËß¶ÂèëÂ∑≤Ë¢´Áî®Êà∑Á¶ÅÁî®');
                    return false;
                }
                
                // *** Ê£ÄÊµãÁî®Êà∑Ëá™ÂÆö‰πâÂÖ≥ÈîÆËØç ***
                if (interactiveSettings.customKeywords && interactiveSettings.customKeywords.length > 0) {
                    for (const keyword of interactiveSettings.customKeywords) {
                        if (keyword && text.includes(keyword.toLowerCase())) {
                            console.log(`üéØ Ê£ÄÊµãÂà∞Áî®Êà∑Ëá™ÂÆö‰πâÂÖ≥ÈîÆËØç: ${keyword}`);
                            
                            return {
                                isInteractive: true,
                                triggerType: 'custom_keyword',
                                triggerKeyword: keyword,
                                cleanContent: originalText,
                                description: `Áî®Êà∑Ëá™ÂÆö‰πâÂÖ≥ÈîÆËØç"${keyword}"Ëß¶Âèë‰∫íÂä®ÂÜÖÂÆπ`
                            };
                        }
                    }
                }
                
                // *** Ê£ÄÊµãÈªòËÆ§ÂÖ≥ÈîÆËØçÔºàÂ¶ÇÊûúÁî®Êà∑ÂêØÁî®Ôºâ ***
                if (interactiveSettings.enableDefaultKeywords) {
                    // Ë∫´‰ΩìÊé•Ëß¶Á±ªÂÖ≥ÈîÆËØç
                    const physicalContactKeywords = [
                        'Êã•Êä±', 'Êä±‰Ωè', 'ÊêÇÊä±', 'Á¥ßÊä±',
                        '‰∫≤Âêª', 
                        'Ëß¶Êë∏', 'ÊäöÊë∏', 'ËΩªÊäö', 
                        'Êè°Êâã', 'ÁâµÊâã', 'ÊãâÊâã', 
                        'ÊãçËÇ©', 'ÊãçËÉå', 'ËΩªÊãç', 
                        'Êé®', 'Êãâ', 'Êâ∂', 'ÊêÄÊâ∂', 'Êâ∂ÁùÄ',
                        'Ë¥¥Ëøë', 'Èù†Ëøë', 'Á¥ßË¥¥'
                    ];
                    
                    // Èù¢ÂØπÈù¢‰∫íÂä®Á±ªÂÖ≥ÈîÆËØç
                    const faceToFaceKeywords = [
                        'Èù¢ÂØπÈù¢', 'ÂΩìÈù¢', 'Èù¢Ââç', 'ÁúºÁ•û‰∫§ÊµÅ', 'ÂØπËßÜ', 'ÂáùËßÜ',
                        'Áé∞ÂÆû‰∏≠', 'ÁúüÂÆû‰∏≠', 'Áé∞ÂÆûÈáå', 'Èù¢ÂØπÁùÄ',
                        'Ëµ∞Âêë', 'Ëµ∞Ëøë', 'Ëµ∞ËøáÂéª', 'ËøáÊù•', 'Èù†ËøáÊù•',
                        'ÂùêËøáÊù•', 'ÂùêÂú®Ë∫´Ëæπ', 'ÂùêÂú®ÊóÅËæπ',
                        'Ë∫∫ÁùÄ', 'Ë∂¥‰∏ã', 'Êàë‰æÜ‰∫Ü',
                        'Ëπ≤‰∏ã', 'Ë∑™‰∏ã', 'ÂºØËÖ∞', '‰øØË∫´'
                    ];
                    
                    // ÊÉÖÊÑüË°®ËææÁ±ªÂÖ≥ÈîÆËØç
                    const emotionalKeywords = [
                        'ÂøÉË∑≥', 'È¢§Êäñ',
                        'ÂæÆÁ¨ë', 'Á¨ëÂÆπ', 'È´òÂÖ¥', 'ÊøÄÂä®',
                        'Âì≠', 'ÊµÅÊ≥™', 'Âì≠Ê≥£', 'ÁúºÊ≥™', 'ÂìΩÂíΩ',
                        'ÊÑ§ÊÄí', 'ÊÅºÁÅ´', 'Áû™Áúº',
                        '‰ΩìË¥¥', 'ÂëµÊä§'
                    ];
                    
                    // Âä®‰ΩúÊèèËø∞Á±ªÂÖ≥ÈîÆËØç
                    const actionKeywords = [
                        '‰º∏Êâã', 'Âº†ÂºÄÊâã', '‰∏æÊâã', 'Êå•Êâã', 'ÊãõÊâã',
                        'ËΩ¨Ë∫´', 'ÂõûÂ§¥', '‰æßË∫´',
                        '‰ª∞Â§¥', '‰øØËßÜ', '‰ª∞ËßÜ',
                        'Ë∏ÆËÑö', 'Ë∑≥Ë∑É', 'Ë∑ëËøáÊù•', 'ÂÜ≤ËøáÊù•'
                    ];
                    
                    // ÁªÑÂêàÂÖ≥ÈîÆËØçÊ£ÄÊµã
                    const allKeywords = [
                        ...physicalContactKeywords,
                        ...faceToFaceKeywords, 
                        ...emotionalKeywords,
                        ...actionKeywords
                    ];
                    
                    let matchCount = 0;
                    let matchedKeywords = [];
                    
                    for (const keyword of allKeywords) {
                        if (text.includes(keyword)) {
                            matchCount++;
                            matchedKeywords.push(keyword);
                        }
                    }
                    
                    // Ê£ÄÊµãÂä®‰ΩúÊèèËø∞Ê®°Âºè *Âä®‰Ωú* Êàñ „ÄêÊÉÖÊÑü„Äë
                    const actionPatterns = [
                        /\*[^*]+\*/g, // *Âä®‰Ωú*
                        /„Äê[^„Äë]+„Äë/g, // „ÄêÊÉÖÊÑü„Äë
                        /\([^)]*Âä®‰Ωú[^)]*\)/g, // (ÂåÖÂê´Âä®‰ΩúÁöÑÊèèËø∞)
                        /\([^)]*Ë°®ÊÉÖ[^)]*\)/g, // (ÂåÖÂê´Ë°®ÊÉÖÁöÑÊèèËø∞)
                    ];
                    
                    let patternMatches = 0;
                    for (const pattern of actionPatterns) {
                        const matches = text.match(pattern);
                        if (matches) {
                            patternMatches += matches.length;
                            matchedKeywords.push(...matches);
                        }
                    }
                    
                    // Âà§Êñ≠ÊòØÂê¶‰∏∫‰∫íÂä®ÊÑèÂõæÔºàÈªòËÆ§ÂÖ≥ÈîÆËØçÊ£ÄÊµãÔºâ
                    const isKeywordInteractive = matchCount >= 2 || patternMatches >= 1 || 
                        (matchCount >= 1 && patternMatches >= 1);
                    
                    if (isKeywordInteractive) {
                        console.log(`üí´ Ê£ÄÊµãÂà∞ÈªòËÆ§ÂÖ≥ÈîÆËØç‰∫íÂä®ÊÑèÂõæ: ÂÖ≥ÈîÆËØç${matchCount}‰∏™, Ê®°Âºè${patternMatches}‰∏™`);
                        console.log('ÂåπÈÖçÁöÑÂÖ≥ÈîÆËØç/Ê®°Âºè:', matchedKeywords);
                        
                        return {
                            isInteractive: true,
                            triggerType: 'default_keyword',
                            matchCount: matchCount,
                            patternMatches: patternMatches,
                            matchedKeywords: matchedKeywords,
                            cleanContent: originalText,
                            description: 'Á≥ªÁªüÊ£ÄÊµãÂà∞ÈªòËÆ§ÂÖ≥ÈîÆËØç‰∫íÂä®ÊÑèÂõæ'
                        };
                    }
                }
                
                return false;
            }
            
            /**
             * *** Êñ∞Â¢ûÔºöËé∑Âèñ‰∫íÂä®ËÆæÁΩÆ ***
             */
            function QQ_GetInteractiveSettings() {
                try {
                    // ‰ªé‰∏ñÁïå‰π¶Ëé∑ÂèñËÆæÁΩÆ
                    const settings = QQ_GetFromWorldBook('QQ_‰∫íÂä®ËÆæÁΩÆ') || {};
                    
                    // ÈªòËÆ§ËÆæÁΩÆ
                    const defaultSettings = {
                        enableKeywordTrigger: false,        // ÈªòËÆ§ÂÖ≥Èó≠ÂÖ≥ÈîÆËØçËß¶Âèë
                        enableDefaultKeywords: false,       // ÈªòËÆ§ÂÖ≥Èó≠ÈªòËÆ§ÂÖ≥ÈîÆËØç
                        customKeywords: [],                  // Ëá™ÂÆö‰πâÂÖ≥ÈîÆËØçÂàóË°®
                        lastUpdated: new Date().toISOString()
                    };
                    
                    // ÂêàÂπ∂ËÆæÁΩÆ
                    return Object.assign(defaultSettings, settings);
                } catch (error) {
                    console.error('Ëé∑Âèñ‰∫íÂä®ËÆæÁΩÆÂ§±Ë¥•:', error);
                    return {
                        enableKeywordTrigger: false,
                        enableDefaultKeywords: false,
                        customKeywords: [],
                        lastUpdated: new Date().toISOString()
                    };
                }
            }
            
            /**
             * *** Êñ∞Â¢ûÔºö‰øùÂ≠ò‰∫íÂä®ËÆæÁΩÆ ***
             */
            function QQ_SaveInteractiveSettings(settings) {
                try {
                    settings.lastUpdated = new Date().toISOString();
                    QQ_SafeSaveToWorldBook('QQ_‰∫íÂä®ËÆæÁΩÆ', settings, 'QQ_‰∫íÂä®ËÆæÁΩÆ');
                    console.log('üîß ‰∫íÂä®ËÆæÁΩÆÂ∑≤‰øùÂ≠ò:', settings);
                    return true;
                } catch (error) {
                    console.error('‰øùÂ≠ò‰∫íÂä®ËÆæÁΩÆÂ§±Ë¥•:', error);
                    return false;
                }
            }
            
            /**
             * *** Êñ∞Â¢ûÔºöÊòæÁ§∫‰∫íÂä®ËÆæÁΩÆÁïåÈù¢ ***
             */
            function QQ_ShowInteractiveSettings() {
                // ÁßªÈô§Áé∞ÊúâËÆæÁΩÆÁïåÈù¢
                $('.QQ_interactive_settings_panel').remove();
                
                const currentSettings = QQ_GetInteractiveSettings();
                
                const panelHtml = `
                    <div class="QQ_interactive_settings_panel" style="
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: white;
                        border-radius: 15px;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                        z-index: 99999999;
                        overflow: hidden;
                        animation: settingsPanelSlideIn 0.3s ease;
                        max-width: 90%;
                        max-height: 80%;
                        width: 400px;
                    ">
                        <div class="panel-header" style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 20px;
                            text-align: center;
                            font-weight: 600;
                        ">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                                <span style="font-size: 20px;">‚öôÔ∏è</span>
                                <span style="font-size: 16px;">‰∫íÂä®ÂÜÖÂÆπËß¶ÂèëËÆæÁΩÆ</span>
                            </div>
                        </div>
                        
                        <div class="panel-content" style="padding: 20px;">
                            <!-- ÁâπÊÆäÁ¨¶Âè∑ËØ¥Êòé -->
                            <div style="
                                background: linear-gradient(135deg, #E8F5E8 0%, #F0F8FF 100%);
                                padding: 15px;
                                border-radius: 8px;
                                margin-bottom: 20px;
                                border-left: 4px solid #4CAF50;
                            ">
                                <div style="font-weight: 600; color: #4CAF50; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                                    <span>‚úÖ</span>
                                    <span>ÁâπÊÆäÁ¨¶Âè∑Ëß¶ÂèëÔºàÊ∞∏‰πÖÂêØÁî®Ôºâ</span>
                                </div>
                                <div style="font-size: 13px; color: #666; line-height: 1.4;">
                                    ‰ΩøÁî® <code style="background: #4CAF50; color: white; padding: 2px 6px; border-radius: 3px; font-weight: 600;">&&</code> Á¨¶Âè∑ÂèØ‰ª•ÈöèÊó∂Ëß¶Âèë‰∫íÂä®ÂÜÖÂÆπÔºå‰æãÂ¶ÇÔºö<br>
                                    <code style="background: #f8f9fa; padding: 2px 6px; border-radius: 3px; margin-top: 4px; display: inline-block;">&&ÊÉ≥Ë¶ÅÊã•Êä±‰Ω†</code>
                                </div>
                            </div>
                            
                            <!-- ÂÖ≥ÈîÆËØçËß¶ÂèëËÆæÁΩÆ -->
                            <div style="margin-bottom: 20px;">
                                <label style="
                                    display: flex;
                                    align-items: center;
                                    gap: 10px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    margin-bottom: 15px;
                                ">
                                    <input type="checkbox" id="enableKeywordTrigger" ${currentSettings.enableKeywordTrigger ? 'checked' : ''} style="
                                        width: 18px;
                                        height: 18px;
                                        accent-color: #667eea;
                                    ">
                                    <span>ÂêØÁî®ÂÖ≥ÈîÆËØçËß¶Âèë</span>
                                </label>
                                
                                <div id="keywordSettings" style="
                                    margin-left: 28px;
                                    ${currentSettings.enableKeywordTrigger ? '' : 'opacity: 0.5; pointer-events: none;'}
                                ">
                                    <!-- ÈªòËÆ§ÂÖ≥ÈîÆËØçËÆæÁΩÆ -->
                                    <label style="
                                        display: flex;
                                        align-items: center;
                                        gap: 10px;
                                        cursor: pointer;
                                        margin-bottom: 15px;
                                    ">
                                        <input type="checkbox" id="enableDefaultKeywords" ${currentSettings.enableDefaultKeywords ? 'checked' : ''} style="
                                            width: 16px;
                                            height: 16px;
                                            accent-color: #667eea;
                                        ">
                                        <span style="font-size: 14px;">‰ΩøÁî®ÈªòËÆ§ÂÖ≥ÈîÆËØçÔºàÊã•Êä±„ÄÅ‰∫≤Âêª„ÄÅËß¶Êë∏Á≠âÔºâ</span>
                                    </label>
                                    
                                    <!-- Ëá™ÂÆö‰πâÂÖ≥ÈîÆËØçËÆæÁΩÆ -->
                                    <div style="margin-bottom: 15px;">
                                        <div style="font-size: 14px; font-weight: 500; margin-bottom: 8px; color: #333;">
                                            Ëá™ÂÆö‰πâÂÖ≥ÈîÆËØç
                                        </div>
                                        <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
                                            ËæìÂÖ•ÊÇ®ÊÉ≥Ë¶ÅËß¶Âèë‰∫íÂä®ÂÜÖÂÆπÁöÑÂÖ≥ÈîÆËØçÔºåÁî®Ëã±ÊñáÈÄóÂè∑ÂàÜÈöîÔºö
                                        </div>
                                        <textarea id="customKeywords" placeholder="‰æãÂ¶ÇÔºöÊÉ≥‰Ω†‰∫Ü,Êä±Êä±,‰∏ÄËµ∑Áé©" style="
                                            width: 100%;
                                            height: 60px;
                                            padding: 8px;
                                            border: 1px solid #ddd;
                                            border-radius: 6px;
                                            font-size: 13px;
                                            resize: none;
                                            box-sizing: border-box;
                                        ">${currentSettings.customKeywords.join(',')}</textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Ëß¶ÂèëÊù°‰ª∂ËØ¥Êòé -->
                            <div style="
                                background: #f8f9fa;
                                padding: 12px;
                                border-radius: 6px;
                                font-size: 12px;
                                color: #666;
                                line-height: 1.4;
                            ">
                                <div style="font-weight: 600; margin-bottom: 6px;">üìù Ëß¶ÂèëÊù°‰ª∂ËØ¥ÊòéÔºö</div>
                                <div>‚Ä¢ ÁâπÊÆäÁ¨¶Âè∑ && ÊÄªÊòØ‰ºòÂÖàËß¶ÂèëÔºàÊó†ÈúÄËÆæÁΩÆÔºâ</div>
                                <div>‚Ä¢ Ëá™ÂÆö‰πâÂÖ≥ÈîÆËØçÔºöÂåÖÂê´‰ªª‰∏ÄÂÖ≥ÈîÆËØçÂç≥Ëß¶Âèë</div>
                                <div>‚Ä¢ ÈªòËÆ§ÂÖ≥ÈîÆËØçÔºöÈúÄË¶ÅÊª°Ë∂≥2‰∏™ÂÖ≥ÈîÆËØçÊàñ1‰∏™Âä®‰ΩúÊ®°Âºè</div>
                                <div>‚Ä¢ AIÂõûÂ§çÊó†Ê†ºÂºèÊó∂‰πü‰ºöËá™Âä®Ëß¶Âèë‰∫íÂä®Ê®°Âºè</div>
                            </div>
                        </div>
                        
                        <div class="panel-actions" style="
                            padding: 20px;
                            background: #fafafa;
                            display: flex;
                            gap: 10px;
                        ">
                            <button class="save-settings-btn" style="
                                flex: 1;
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                border: none;
                                color: white;
                                padding: 12px 16px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 13px;
                                font-weight: 500;
                                transition: all 0.2s ease;
                            ">
                                ‰øùÂ≠òËÆæÁΩÆ
                            </button>
                            <button class="cancel-settings-btn" style="
                                flex: 1;
                                background: #e9ecef;
                                border: none;
                                color: #666;
                                padding: 12px 16px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 13px;
                                font-weight: 500;
                                transition: all 0.2s ease;
                            ">
                                ÂèñÊ∂à
                            </button>
                        </div>
                    </div>
                    
                    <style>
                        @keyframes settingsPanelSlideIn {
                            from {
                                opacity: 0;
                                transform: translate(-50%, -60%);
                            }
                            to {
                                opacity: 1;
                                transform: translate(-50%, -50%);
                            }
                        }
                        
                        .QQ_interactive_settings_panel .save-settings-btn:hover {
                            transform: translateY(-2px);
                            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
                        }
                        
                        .QQ_interactive_settings_panel .cancel-settings-btn:hover {
                            background: #dee2e6;
                        }
                    </style>
                `;
                
                // Ê∑ªÂä†Âà∞È°µÈù¢
                $('body').append(panelHtml);
                
                // ÁªëÂÆöÂÖ≥ÈîÆËØçËß¶ÂèëÂºÄÂÖ≥‰∫ã‰ª∂
                $('#enableKeywordTrigger').on('change', function() {
                    const isEnabled = this.checked;
                    const keywordSettings = $('#keywordSettings');
                    
                    if (isEnabled) {
                        keywordSettings.css({
                            'opacity': '1',
                            'pointer-events': 'auto'
                        });
                    } else {
                        keywordSettings.css({
                            'opacity': '0.5',
                            'pointer-events': 'none'
                        });
                    }
                });
                
                // ÁªëÂÆö‰øùÂ≠òÊåâÈíÆ‰∫ã‰ª∂
                $('.save-settings-btn').on('click', function() {
                    const newSettings = {
                        enableKeywordTrigger: $('#enableKeywordTrigger').prop('checked'),
                        enableDefaultKeywords: $('#enableDefaultKeywords').prop('checked'),
                        customKeywords: $('#customKeywords').val()
                            .split(',')
                            .map(k => k.trim())
                            .filter(k => k.length > 0)
                    };
                    
                    if (QQ_SaveInteractiveSettings(newSettings)) {
                        $('.QQ_interactive_settings_panel').remove();
                        
                        // ÊòæÁ§∫‰øùÂ≠òÊàêÂäüÊèêÁ§∫
                        const message = `‚úÖ ËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºÅ
                        
üéØ ÁâπÊÆäÁ¨¶Âè∑Ëß¶ÂèëÔºöÊ∞∏‰πÖÂêØÁî® (&&)
üîç ÂÖ≥ÈîÆËØçËß¶ÂèëÔºö${newSettings.enableKeywordTrigger ? 'Â∑≤ÂêØÁî®' : 'Â∑≤Á¶ÅÁî®'}
üìù ÈªòËÆ§ÂÖ≥ÈîÆËØçÔºö${newSettings.enableDefaultKeywords ? 'Â∑≤ÂêØÁî®' : 'Â∑≤Á¶ÅÁî®'}
üè∑Ô∏è Ëá™ÂÆö‰πâÂÖ≥ÈîÆËØçÔºö${newSettings.customKeywords.length}‰∏™`;
                        
                        alert(message);
                    } else {
                        alert('‚ùå ‰øùÂ≠òËÆæÁΩÆÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                    }
                });
                
                // ÁªëÂÆöÂèñÊ∂àÊåâÈíÆ‰∫ã‰ª∂
                $('.cancel-settings-btn').on('click', function() {
                    $('.QQ_interactive_settings_panel').remove();
                });
                
                // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠Èù¢Êùø
                $(document).one('click', function(e) {
                    if (!$(e.target).closest('.QQ_interactive_settings_panel').length) {
                        $('.QQ_interactive_settings_panel').remove();
                    }
                });
                
                // ÈòªÊ≠¢Èù¢ÊùøÂÜÖÈÉ®ÁÇπÂáª‰∫ã‰ª∂ÂÜíÊ≥°
                $('.QQ_interactive_settings_panel').on('click', function(e) {
                    e.stopPropagation();
                });
            }

            /**
             * Êô∫ËÉΩÂ§ÑÁêÜ‰∫íÂä®ÂÜÖÂÆπ - ÂÜ≥ÂÆöÊòæÁ§∫Âú®ÂÖ¨ÂÖ±Á©∫Èó¥ËøòÊòØËßíËâ≤‰∏ìÂ±ûÁ©∫Èó¥
             * @param {string} content - AIÂõûÂ§çÁöÑ‰∫íÂä®ÂÜÖÂÆπ
             * @param {string} characterName - ËßíËâ≤ÂêçÁß∞
             */
            function QQ_HandleInteractiveContent(content, characterName = "") {
                // Ê∏ÖÁêÜÂÜÖÂÆπ
                let cleanContent;
                if (QQ_HasContentTag(content)) {
                    cleanContent = QQ_CleanContentTags(content);
                } else {
                    cleanContent = content
                        .replace(/MiPhone_start/g, "")
                        .replace(/MiPhone_end/g, "")
                        .trim();
                }
                
                const targetCharacter = characterName || QQ_LastRequestName || charcardname || "ËßíËâ≤";
                
                // *** Êñ∞Â¢ûÔºöÊ£ÄÊü•ÊòØÂê¶Êúâ"ÂÖàÂõûÂ§çÂêé‰∫íÂä®"ÁöÑË¶ÅÊ±Ç ***
                const hasPriorReplyRequest = QQ_CheckPriorReplyRequest(cleanContent);
                
                if (hasPriorReplyRequest.shouldReplyFirst) {
                    console.log("Ê£ÄÊµãÂà∞ÈúÄË¶ÅÂÖàËøõË°åÁßÅËÅä/Áæ§ËÅäÂõûÂ§çÁöÑË¶ÅÊ±Ç");
                    
                    // ÂÖàÊâßË°åÁßÅËÅä/Áæ§ËÅäÂõûÂ§ç
                    QQ_ExecutePriorReply(hasPriorReplyRequest.replyType, hasPriorReplyRequest.replyContent, targetCharacter);
                    
                    // Âª∂ËøüÊâßË°å‰∫íÂä®ÂÜÖÂÆπÔºàÁªôÁî®Êà∑Êó∂Èó¥Êü•ÁúãÂõûÂ§çÔºâ
                    setTimeout(() => {
                        QQ_ProceedToInteractiveMode(cleanContent, targetCharacter);
                    }, 2000); // 2ÁßíÂª∂Ëøü
                    
                    return;
                }
                
                // Áõ¥Êé•ËøõÂÖ•‰∫íÂä®Ê®°Âºè
                QQ_ProceedToInteractiveMode(cleanContent, targetCharacter);
            }
            
            /**
             * *** Êñ∞Â¢ûÔºöÊ£ÄÊü•ÊòØÂê¶ÊúâÂÖàÂõûÂ§çÁöÑË¶ÅÊ±Ç ***
             * @param {string} content - ‰∫íÂä®ÂÜÖÂÆπ
             * @returns {Object} ÂõûÂ§çË¶ÅÊ±Ç‰ø°ÊÅØ
             */
            function QQ_CheckPriorReplyRequest(content) {
                // Ê£ÄÊü•ÂÖàÂõûÂ§çÁöÑÂÖ≥ÈîÆËØçÊ®°Âºè
                const priorReplyPatterns = [
                    // ÁßÅËÅäÂÖàÂõûÂ§ç
                    {
                        pattern: /(?:ÂÖà|È¶ñÂÖà|ÂÖàÂú®ÁßÅËÅä)(?:ÂõûÂ§ç|ÂõûÂ∫î|ÂõûÁ≠î|ËØ¥)(?:.*?)(?:ÁÑ∂Âêé|Êé•ÁùÄ|ÂÜç)(?:.*?)(?:‰∫íÂä®|ËßÅÈù¢|ËøáÊù•)/,
                        type: 'private',
                        extract: (match) => QQ_ExtractReplyContent(match, 'private')
                    },
                    // Áæ§ËÅäÂÖàÂõûÂ§ç
                    {
                        pattern: /(?:ÂÖà|È¶ñÂÖà|ÂÖàÂú®Áæ§ËÅä)(?:ÂõûÂ§ç|ÂõûÂ∫î|ÂõûÁ≠î|ËØ¥)(?:.*?)(?:ÁÑ∂Âêé|Êé•ÁùÄ|ÂÜç)(?:.*?)(?:‰∫íÂä®|ËßÅÈù¢|ËøáÊù•)/,
                        type: 'group',
                        extract: (match) => QQ_ExtractReplyContent(match, 'group')
                    },
                    // ÈÄöÁî®ÂÖàÂõûÂ§çÊ®°Âºè
                    {
                        pattern: /(?:ÂÖà|È¶ñÂÖà)(?:Âèë|ÂèëÈÄÅ|Âõû)(?:.*?)(?:Ê∂àÊÅØ|‰ø°ÊÅØ)(?:.*?)(?:ÁÑ∂Âêé|Êé•ÁùÄ|ÂÜç)(?:.*?)(?:‰∫íÂä®|ËßÅÈù¢|ËøáÊù•)/,
                        type: 'auto', // Ëá™Âä®Âà§Êñ≠Á±ªÂûã
                        extract: (match) => QQ_ExtractReplyContent(match, 'auto')
                    }
                ];
                
                for (const item of priorReplyPatterns) {
                    const match = content.match(item.pattern);
                    if (match) {
                        const replyContent = item.extract(match[0]);
                        console.log(`Ê£ÄÊµãÂà∞ÂÖàÂõûÂ§çÊ®°Âºè: ${item.type}, ÂÜÖÂÆπ: ${replyContent}`);
                        
                        return {
                            shouldReplyFirst: true,
                            replyType: item.type,
                            replyContent: replyContent,
                            fullMatch: match[0]
                        };
                    }
                }
                
                return { shouldReplyFirst: false };
            }
            
            /**
             * *** Êñ∞Â¢ûÔºöÊèêÂèñÂõûÂ§çÂÜÖÂÆπ ***
             * @param {string} matchText - ÂåπÈÖçÁöÑÊñáÊú¨
             * @param {string} type - ÂõûÂ§çÁ±ªÂûã
             * @returns {string} ÊèêÂèñÁöÑÂõûÂ§çÂÜÖÂÆπ
             */
            function QQ_ExtractReplyContent(matchText, type) {
                // ÊèêÂèñ"ÂÖàÂõûÂ§ç"Âíå"ÁÑ∂Âêé‰∫íÂä®"‰πãÈó¥ÁöÑÂÜÖÂÆπ
                const replyExtractPatterns = [
                    /(?:ÂõûÂ§ç|ÂõûÂ∫î|ÂõûÁ≠î|ËØ¥)["'"]([^"'"]*)["'"]/,  // ÂºïÂè∑ÂÜÖÂÆπ
                    /(?:ÂõûÂ§ç|ÂõûÂ∫î|ÂõûÁ≠î|ËØ¥)[:Ôºö]\s*([^Ôºå„ÄÇÔºÅÔºü]*)/,   // ÂÜíÂè∑ÂêéÂÜÖÂÆπ
                    /(?:ÂõûÂ§ç|ÂõûÂ∫î|ÂõûÁ≠î|ËØ¥)\s*([^ÁÑ∂ÂêéÊé•ÁùÄÂÜç]*?)(?:ÁÑ∂Âêé|Êé•ÁùÄ|ÂÜç)/  // Âà∞‰∏ã‰∏Ä‰∏™Âä®‰Ωú‰πãÂâçÁöÑÂÜÖÂÆπ
                ];
                
                for (const pattern of replyExtractPatterns) {
                    const match = matchText.match(pattern);
                    if (match && match[1].trim()) {
                        return match[1].trim();
                    }
                }
                
                // Â¶ÇÊûúÊ≤°ÊúâÊòéÁ°ÆÂÜÖÂÆπÔºåÁîüÊàêÈªòËÆ§ÂõûÂ§ç
                return type === 'private' ? 'Â•ΩÁöÑÔºåÊàëÈ©¨‰∏äËøáÊù•' : 
                       type === 'group' ? 'Â§ßÂÆ∂Á≠âÊàë‰∏Ä‰∏ãÔºåÈ©¨‰∏äËøáÊù•' :
                       'Â•ΩÁöÑÔºåÈ©¨‰∏äËøáÊù•';
            }
            
            /**
             * *** Êñ∞Â¢ûÔºöÊâßË°åÂÖàÊúüÂõûÂ§ç ***
             * @param {string} replyType - ÂõûÂ§çÁ±ªÂûã (private/group/auto)
             * @param {string} replyContent - ÂõûÂ§çÂÜÖÂÆπ
             * @param {string} targetCharacter - ÁõÆÊ†áËßíËâ≤
             */
            function QQ_ExecutePriorReply(replyType, replyContent, targetCharacter) {
                console.log(`ÊâßË°åÂÖàÊúüÂõûÂ§ç: ${replyType} -> ${replyContent}`);
                
                if (replyType === 'private' || (replyType === 'auto' && QQ_IsInPrivateChat())) {
                    // ÁßÅËÅäÂõûÂ§ç
                    QQ_SendPrivateMessage(targetCharacter, replyContent);
                } else if (replyType === 'group' || (replyType === 'auto' && QQ_IsInGroupChat())) {
                    // Áæ§ËÅäÂõûÂ§ç
                    QQ_SendGroupMessage(replyContent);
                } else {
                    // ÈªòËÆ§ÁßÅËÅä
                    QQ_SendPrivateMessage(targetCharacter, replyContent);
                }
                
                // ÊòæÁ§∫Á≥ªÁªüÊèêÁ§∫
                triggerSlash(`/echo Â∑≤ÂèëÈÄÅÂõûÂ§çÊ∂àÊÅØÔºåÂç≥Â∞ÜËøõÂÖ•‰∫íÂä®Ê®°Âºè...`);
            }
            
            /**
             * *** Êñ∞Â¢ûÔºöÁªßÁª≠ËøõÂÖ•‰∫íÂä®Ê®°Âºè ***
             * @param {string} content - Ê∏ÖÁêÜÂêéÁöÑ‰∫íÂä®ÂÜÖÂÆπ
             * @param {string} targetCharacter - ÁõÆÊ†áËßíËâ≤
             */
            function QQ_ProceedToInteractiveMode(content, targetCharacter) {
                // Ê£ÄÊµãÊòØÂê¶ÂåÖÂê´Â§ö‰∏™ËßíËâ≤ÊàñÁæ§ËÅäÂú∫ÊôØ
                const isMultiCharacter = QQ_DetectMultiCharacterInteraction(content, targetCharacter);
                
                if (isMultiCharacter) {
                    // Â§öËßíËâ≤‰∫íÂä®ÔºåÊòæÁ§∫Âú®ÂÖ¨ÂÖ±‰∫íÂä®Á©∫Èó¥
                    console.log("Ê£ÄÊµãÂà∞Â§öËßíËâ≤‰∫íÂä®ÔºåÊòæÁ§∫Âú®ÂÖ¨ÂÖ±‰∫íÂä®Á©∫Èó¥");
                    // *** ÂÖ≥ÈîÆ‰ºòÂåñÔºöÂºÇÊ≠•Ë∞ÉÁî®Á°Æ‰øù‰ªé‰∏ñÁïå‰π¶Âä†ËΩΩ ***
                    (async () => {
                        await QQ_ShowPublicInteractiveSpace(content, targetCharacter);
                    })();
                } else {
                    // ÂçïËßíËâ≤‰∫íÂä®ÔºåÊòæÁ§∫Âú®ËßíËâ≤‰∏ìÂ±ûÁ©∫Èó¥
                    console.log(`Ê£ÄÊµãÂà∞ÂçïËßíËâ≤‰∫íÂä®ÔºåÊòæÁ§∫Âú®${targetCharacter}ÁöÑ‰∏ìÂ±ûÁ©∫Èó¥`);
                    // *** ÂÖ≥ÈîÆ‰ºòÂåñÔºöÂºÇÊ≠•Ë∞ÉÁî®Á°Æ‰øù‰ªé‰∏ñÁïå‰π¶Âä†ËΩΩ ***
                    (async () => {
                        await QQ_ShowCharacterInteractiveSpace(content, targetCharacter);
                    })();
                }
            }
            
            /**
             * *** Êñ∞Â¢ûÔºöÊ£ÄÊü•ÊòØÂê¶Âú®ÁßÅËÅäÊ®°Âºè ***
             * @returns {boolean} ÊòØÂê¶Âú®ÁßÅËÅä
             */
            function QQ_IsInPrivateChat() {
                const chatPage = document.querySelector('.QQ_chat_page:visible');
                if (!chatPage) return false;
                
                const chatTitle = document.getElementById('QQ_chat_username');
                return chatTitle && !chatTitle.textContent.includes('Áæ§ËÅä');
            }
            
            /**
             * *** Êñ∞Â¢ûÔºöÊ£ÄÊü•ÊòØÂê¶Âú®Áæ§ËÅäÊ®°Âºè ***
             * @returns {boolean} ÊòØÂê¶Âú®Áæ§ËÅä
             */
            function QQ_IsInGroupChat() {
                const chatPage = document.querySelector('.QQ_chat_page:visible');
                if (!chatPage) return false;
                
                const chatTitle = document.getElementById('QQ_chat_username');
                return chatTitle && chatTitle.textContent.includes('Áæ§ËÅä');
            }
            
            /**
             * *** Êñ∞Â¢ûÔºöÂèëÈÄÅÁßÅËÅäÊ∂àÊÅØ ***
             * @param {string} characterName - ËßíËâ≤Âêç
             * @param {string} content - Ê∂àÊÅØÂÜÖÂÆπ
             */
            function QQ_SendPrivateMessage(characterName, content) {
                const messageData = {
                    time: QQ_GetTime(),
                    content: content,
                    sender: characterName
                };
                
                // ÊûÑÂª∫ÁßÅËÅäÊ†ºÂºè
                const chatContent = `<${QQ_GetUserName()}Âíå${characterName}ÁöÑÁßÅËÅä>\n${characterName}--${content}--${messageData.time}\n</${QQ_GetUserName()}Âíå${characterName}ÁöÑÁßÅËÅä>`;
                
                // Áõ¥Êé•Êõ¥Êñ∞Âà∞ÂΩìÂâçËÅäÂ§©ÁïåÈù¢ÔºàÂ¶ÇÊûúÊòØÂØπÂ∫îÁöÑÁßÅËÅäÔºâ
                const currentChat = document.querySelector('.QQ_chat_page:visible');
                if (currentChat && QQ_IsTargetChat(characterName)) {
                    QQ_AddMessageToCurrentChat(characterName, content, messageData.time);
                }
                
                // ‰øùÂ≠òÂà∞Êï∞ÊçÆ
                QQ_SavePrivateMessage(characterName, messageData);
                
                console.log(`Â∑≤ÂèëÈÄÅÁßÅËÅäÊ∂àÊÅØÁªô ${characterName}: ${content}`);
            }
            
            /**
             * *** Êñ∞Â¢ûÔºöÂèëÈÄÅÁæ§ËÅäÊ∂àÊÅØ ***
             * @param {string} content - Ê∂àÊÅØÂÜÖÂÆπ
             */
            function QQ_SendGroupMessage(content) {
                const currentGroup = QQ_GetCurrentGroupName();
                if (!currentGroup) {
                    console.warn('ÂΩìÂâç‰∏çÂú®Áæ§ËÅäÁïåÈù¢ÔºåÊó†Ê≥ïÂèëÈÄÅÁæ§ËÅäÊ∂àÊÅØ');
                    return;
                }
                
                const messageData = {
                    time: QQ_GetTime(),
                    content: content,
                    sender: charcardname || "ËßíËâ≤"
                };
                
                // Áõ¥Êé•Êõ¥Êñ∞Âà∞ÂΩìÂâçÁæ§ËÅäÁïåÈù¢
                QQ_AddMessageToCurrentChat(messageData.sender, content, messageData.time);
                
                // ‰øùÂ≠òÂà∞Êï∞ÊçÆ
                QQ_SaveGroupMessage(currentGroup, messageData);
                
                console.log(`Â∑≤ÂèëÈÄÅÁæ§ËÅäÊ∂àÊÅØÂà∞ ${currentGroup}: ${content}`);
            }
            
            /**
             * *** Êñ∞Â¢ûÔºöËé∑ÂèñÂΩìÂâçÁæ§ËÅäÂêçÁß∞ ***
             * @returns {string} Áæ§ËÅäÂêçÁß∞
             */
            function QQ_GetCurrentGroupName() {
                const chatTitle = document.getElementById('QQ_chat_username');
                if (!chatTitle) return null;
                
                const titleText = chatTitle.textContent;
                if (titleText.includes('Áæ§ËÅä:')) {
                    return titleText.replace('Áæ§ËÅä:', '').trim();
                }
                
                return null;
            }
            
            /**
             * *** Êñ∞Â¢ûÔºöÊ£ÄÊü•ÊòØÂê¶ÊòØÁõÆÊ†áËÅäÂ§© ***
             * @param {string} characterName - ËßíËâ≤Âêç
             * @returns {boolean} ÊòØÂê¶ÊòØÁõÆÊ†áËÅäÂ§©
             */
            function QQ_IsTargetChat(characterName) {
                const chatTitle = document.getElementById('QQ_chat_username');
                if (!chatTitle) return false;
                
                return chatTitle.textContent.includes(characterName);
            }
            
            /**
             * *** Êñ∞Â¢ûÔºöÊ∑ªÂä†Ê∂àÊÅØÂà∞ÂΩìÂâçËÅäÂ§©ÁïåÈù¢ ***
             * @param {string} sender - ÂèëÈÄÅËÄÖ
             * @param {string} content - Ê∂àÊÅØÂÜÖÂÆπ
             * @param {string} time - Êó∂Èó¥
             */
            function QQ_AddMessageToCurrentChat(sender, content, time) {
                const chatMessages = document.getElementById('QQ_chat_messages');
                if (!chatMessages) return;
                
                const messageElement = document.createElement('div');
                messageElement.className = 'QQ_message';
                messageElement.innerHTML = `
                    <div class="QQ_message_sender">${sender}</div>
                    <div class="QQ_message_content">${content}</div>
                    <div class="QQ_message_time">${time}</div>
                `;
                
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            /**
             * Ê£ÄÊµãÊòØÂê¶‰∏∫Â§öËßíËâ≤‰∫íÂä®
             * @param {string} content - ‰∫íÂä®ÂÜÖÂÆπ
             * @param {string} primaryCharacter - ‰∏ªË¶Å‰∫íÂä®ÁöÑËßíËâ≤ÂêçÔºàÂ¶ÇÁßÅËÅäÂØπË±°Ôºâ
             * @returns {boolean} ÊòØÂê¶‰∏∫Â§öËßíËâ≤‰∫íÂä®
             */
            function QQ_DetectMultiCharacterInteraction(content, primaryCharacter = null) {
                // *** ‰ºòÂåñÔºöÁ≤æÁ°ÆÁöÑÂ§ö‰∫∫‰∫íÂä®ÂÖ≥ÈîÆËØçÊ£ÄÊµã ***
                const strongMultiKeywords = [
                    // Áõ¥Êé•Â§ö‰∫∫Áß∞Âëº
                    { keyword: 'ÊâÄÊúâ‰∫∫', context: ['ÂØπÊâÄÊúâ‰∫∫', 'ÂëäËØâÊâÄÊúâ‰∫∫', 'ÂíåÊâÄÊúâ‰∫∫'] },
                    { keyword: '‰ºó‰∫∫', context: ['‰ºó‰∫∫Èù¢Ââç', 'ÂØπ‰ºó‰∫∫', '‰ºó‰∫∫‰∏ÄËµ∑'] },
                    { keyword: 'ÂÖ®‰Ωì', context: ['ÂÖ®‰ΩìÊàêÂëò', 'ÂØπÂÖ®‰Ωì', 'ÂÖ®‰Ωì‰∏ÄËµ∑'] },
                    
                    // ÊòéÁ°ÆÁöÑÂ§ö‰∫∫Âä®‰Ωú
                    { keyword: 'Êàë‰ª¨‰∏ÄËµ∑', context: ['Êàë‰ª¨‰∏ÄËµ∑Âéª', 'Êàë‰ª¨‰∏ÄËµ∑ÂÅö', 'Êàë‰ª¨‰∏ÄËµ∑Êù•'] },
                    { keyword: '‰ªñ‰ª¨‰∏ÄËµ∑', context: ['‰ªñ‰ª¨‰∏ÄËµ∑Âéª', '‰ªñ‰ª¨‰∏ÄËµ∑ÂÅö', '‰ªñ‰ª¨‰∏ÄËµ∑Êù•'] },
                    { keyword: 'ÂÖ±ÂêåÂèÇ‰∏é', context: ['ÂÖ±ÂêåÂèÇ‰∏éÊ¥ªÂä®', 'ÂÖ±ÂêåÂèÇ‰∏éËÆ®ËÆ∫'] },
                    { keyword: 'ÂêåÊó∂ÂèÇ‰∏é', context: ['ÂêåÊó∂ÂèÇ‰∏é‰∫íÂä®', 'ÂêåÊó∂ÂèÇ‰∏éÊ¥ªÂä®'] },
                    
                    // Á©∫Èó¥‰ΩçÁΩÆÁöÑÂ§ö‰∫∫Âú∫ÊôØ
                    { keyword: 'Âõ¥ÊàêÂúà', context: ['Âõ¥ÊàêÂúàÂùê', 'Âõ¥ÊàêÂúàÁ´ô', 'Âõ¥ÊàêÂúàËÆ®ËÆ∫'] },
                    { keyword: 'ÊéíÊàêÈòü', context: ['ÊéíÊàêÈòüËµ∞', 'ÊéíÊàêÈòüÁ≠â', 'ÊéíÊàêÈòüÁ´ô'] },
                    { keyword: 'ÂàÜÊàêÁªÑ', context: ['ÂàÜÊàêÁªÑËÆ®ËÆ∫', 'ÂàÜÊàêÁªÑÊ¥ªÂä®', 'ÂàÜÊàêÁªÑËøõË°å'] },
                    { keyword: 'ËÅöÂú®‰∏ÄËµ∑', context: ['ËÅöÂú®‰∏ÄËµ∑ËÅä', 'ËÅöÂú®‰∏ÄËµ∑Áé©', 'ËÅöÂú®‰∏ÄËµ∑ËÆ®ËÆ∫'] }
                ];
                
                // Ê£ÄÊü•ÊòØÂê¶ÊúâÁúüÂÆûÁöÑÂ§ö‰∫∫‰∫íÂä®ÊÑèÂõæ
                for (const item of strongMultiKeywords) {
                    if (content.includes(item.keyword)) {
                        // Ê£ÄÊü•‰∏ä‰∏ãÊñáÊòØÂê¶Á¨¶ÂêàÂ§ö‰∫∫‰∫íÂä®ÊÑèÂõæ
                        const hasValidContext = item.context.some(ctx => content.includes(ctx)) ||
                                              QQ_IsValidMultiPersonContext(content, item.keyword);
                        
                        if (hasValidContext) {
                            console.log('Ê£ÄÊµãÂà∞ÊúâÊïàÂ§ö‰∫∫‰∫íÂä®ÂÖ≥ÈîÆËØç:', item.keyword);
                            return true;
                        } else {
                            console.log('ÂÖ≥ÈîÆËØçÂ≠òÂú®‰ΩÜ‰∏ä‰∏ãÊñá‰∏çÁ¨¶ÂêàÂ§ö‰∫∫‰∫íÂä®:', item.keyword);
                        }
                    }
                }
                
                // *** ‰ºòÂåñÔºöÊ£ÄÊµãÂ§ö‰∏™ËßíËâ≤ÂêçÊèêÂèäÔºå‰ΩÜËÄÉËôë‰∏ªË¶Å‰∫íÂä®ËÄÖ ***
                const characterMentions = content.match(/[@„ÄêÔºàÔºú]\s*([^@„ÄêÔºàÔºú„ÄëÔºâÔºû\s]{2,8})\s*[„ÄëÔºâÔºû]/g) || [];
                const uniqueCharacters = [...new Set(characterMentions.map(m => m.replace(/[@„ÄêÔºàÔºú„ÄëÔºâÔºû]/g, '').trim()))];
                
                // Â¶ÇÊûúÊúâ‰∏ªË¶ÅËßíËâ≤ÔºàÂ¶ÇÁßÅËÅäÂØπË±°ÔºâÔºåÂà§Êñ≠ÊòØÂê¶‰∏∫‰∏ªÂØº‰∫íÂä®
                if (primaryCharacter && uniqueCharacters.length >= 1) {
                    // Ê£ÄÊü•‰∏ªË¶ÅËßíËâ≤ÊòØÂê¶ÊòØ‰∫íÂä®ÁöÑÊ†∏ÂøÉ
                    const isPrimaryDominant = QQ_IsPrimaryCharacterDominant(content, primaryCharacter, uniqueCharacters);
                    if (isPrimaryDominant) {
                        console.log('‰∏ªË¶ÅËßíËâ≤‰∏ªÂØº‰∫íÂä®ÔºåÂΩíÂÖ•ËßíËâ≤‰∏ìÂ±ûÁ©∫Èó¥:', primaryCharacter);
                        return false; // ÂΩíÂÖ•ËßíËâ≤‰∏ìÂ±ûÁ©∫Èó¥
                    }
                }
                
                // Â§ö‰∏™ËßíËâ≤‰∏îÊ≤°Êúâ‰∏ªÂØºËÄÖÔºåËßÜ‰∏∫Â§ö‰∫∫‰∫íÂä®
                if (uniqueCharacters.length > 1) {
                    console.log('Â§ö‰∏™ËßíËâ≤ÂèÇ‰∏é‰∏îÊó†‰∏ªÂØºËÄÖÔºåÂΩíÂÖ•ÂÖ¨ÂÖ±Á©∫Èó¥:', uniqueCharacters);
                    return true;
                }
                
                // *** ‰ºòÂåñÔºöÊ£ÄÊµãÂ§ö‰∫∫Âú∫ÊôØÊèèËø∞Ôºå‰ΩÜÊõ¥‰∏•Ê†º ***
                const strongMultiPersonPatterns = [
                    /(\w+)Âíå(\w+)(?:‰ª•Âèä|ËøòÊúâ|Âä†‰∏ä)(\w+)/,  // AÂíåB‰ª•ÂèäC
                    /(\w+)„ÄÅ(\w+)(?:„ÄÅ(\w+))+/,           // A„ÄÅB„ÄÅCÁ≠â
                    /(?:Âíå|‰∏é|Ë∑ü)(\w+)(?:‰ªñ‰ª¨|Â•π‰ª¨|Â§ßÂÆ∂)(?:‰∏ÄËµ∑|ÂêåÊó∂)/,  // ÂíåÊüê‰∫∫‰ªñ‰ª¨‰∏ÄËµ∑
                    /(?:Êàë‰ª¨|Âí±‰ª¨)(?:Âá†‰∏™|Â§ö‰∏™|ÂÖ®ÈÉ®)(?:‰∏ÄËµ∑|ÂêåÊó∂)/      // Êàë‰ª¨Âá†‰∏™‰∏ÄËµ∑
                ];
                
                if (strongMultiPersonPatterns.some(pattern => pattern.test(content))) {
                    console.log('Ê£ÄÊµãÂà∞Âº∫ÁÉàÂ§ö‰∫∫Âú∫ÊôØÊèèËø∞');
                    return true;
                }
                
                console.log('Âà§ÂÆö‰∏∫Âçï‰∫∫/ËßíËâ≤‰∏ªÂØº‰∫íÂä®');
                return false;
            }
            
            /**
             * *** Êñ∞Â¢ûÔºöÈ™åËØÅÂ§ö‰∫∫‰∫íÂä®‰∏ä‰∏ãÊñáÁöÑÊúâÊïàÊÄß ***
             * @param {string} content - ‰∫íÂä®ÂÜÖÂÆπ
             * @param {string} keyword - Ê£ÄÊµãÂà∞ÁöÑÂÖ≥ÈîÆËØç
             * @returns {boolean} ‰∏ä‰∏ãÊñáÊòØÂê¶ÊúâÊïà
             */
            function QQ_IsValidMultiPersonContext(content, keyword) {
                // ÊéíÈô§‰∏çÁ¨¶ÂêàÂ§ö‰∫∫‰∫íÂä®ÁöÑ‰∏ä‰∏ãÊñá
                const invalidContexts = [
                    // ÊèèËø∞ÊÄßËØ≠Ë®ÄÔºå‰∏çÊòØÂÆûÈôÖ‰∫íÂä®ËØ∑Ê±Ç
                    /ÈõÜ‰ΩìË°åÂä®/,
                    /ÈõÜ‰ΩìÊ¥ªÂä®/,
                    /ÈõÜ‰ΩìÂÜ≥Á≠ñ/,
                    /ÈõÜ‰ΩìÂà©Áõä/,
                    /ÈõÜ‰ΩìÊÑèËØÜ/,
                    /ÈõÜ‰ΩìËÆ∞ÂøÜ/,
                    
                    // ÊäΩË±°Ê¶ÇÂøµÔºå‰∏çÊòØÂÖ∑‰Ωì‰∫íÂä®
                    /Ê¶ÇÂøµ‰∏ä/,
                    /ÁêÜËÆ∫‰∏ä/,
                    /ÂéüÂàô‰∏ä/,
                    /ÊÄùÊÉ≥‰∏ä/,
                    /Á≤æÁ•û‰∏ä/,
                    
                    // ËøáÂéªÊó∂ÊÄÅÔºå‰∏çÊòØÂΩìÂâç‰∫íÂä®ËØ∑Ê±Ç
                    /ÊõæÁªè.*‰∏ÄËµ∑/,
                    /‰ª•Ââç.*‰∏ÄËµ∑/,
                    /‰πãÂâç.*‰∏ÄËµ∑/,
                    /ËøáÂéª.*‰∏ÄËµ∑/,
                    
                    // Êù°‰ª∂Âè•Ôºå‰∏çÊòØÁ°ÆÂÆöÁöÑ‰∫íÂä®
                    /Â¶ÇÊûú.*‰∏ÄËµ∑/,
                    /ÂÅáÂ¶Ç.*‰∏ÄËµ∑/,
                    /Ë¶ÅÊòØ.*‰∏ÄËµ∑/,
                    /ÂÄòËã•.*‰∏ÄËµ∑/
                ];
                
                // Â¶ÇÊûúÂÜÖÂÆπÂåÖÂê´Êó†Êïà‰∏ä‰∏ãÊñáÔºåËøîÂõûfalse
                if (invalidContexts.some(pattern => pattern.test(content))) {
                    console.log(`ÂÖ≥ÈîÆËØç"${keyword}"ÁöÑ‰∏ä‰∏ãÊñáÊó†ÊïàÔºå‰∏çÁ¨¶Âêà‰∫íÂä®ÊÑèÂõæ`);
                    return false;
                }
                
                // Ê£ÄÊü•ÊòØÂê¶ÊúâÊòéÁ°ÆÁöÑ‰∫íÂä®Âä®ËØç
                const interactiveVerbs = [
                    /‰∏ÄËµ∑(Âéª|Êù•|ÂÅö|Áé©|ËÅä|ËÆ®ËÆ∫|ÂèÇ‰∏é|ËøõË°å)/,
                    /(ÂØπ|Âíå|Ë∑ü).*(ËØ¥|ËÆ≤|ËÅä|‰∫§ÊµÅ)/,
                    /(Êä±|Êã•Êä±|‰∫≤Âêª|Êè°Êâã|Êãç|Á¢∞|Êë∏)/,
                    /(Áúã|Êúõ|Ê≥®ËßÜ|ÂáùËßÜ).*(ÁùÄ|Âêë)/,
                    /(Ëµ∞Âêë|Ëµ∞Ëøë|Èù†Ëøë|Êé•Ëøë)/
                ];
                
                const hasInteractiveVerb = interactiveVerbs.some(pattern => pattern.test(content));
                
                // Ê£ÄÊü•ÊòØÂê¶ÊúâÂΩìÂâçÊó∂ÊÄÅÁöÑ‰∫íÂä®ËØ∑Ê±Ç
                const currentTimeIndicators = [
                    /Áé∞Âú®/,
                    /Ê≠§Âàª/,
                    /ÂΩìÂâç/,
                    /È©¨‰∏ä/,
                    /Á´ãÂç≥/,
                    /Ê≠£Âú®/,
                    /Ë¶Å.*‰∏ÄËµ∑/,
                    /ÊÉ≥.*‰∏ÄËµ∑/,
                    /ÂáÜÂ§á.*‰∏ÄËµ∑/
                ];
                
                const hasCurrentTime = currentTimeIndicators.some(pattern => pattern.test(content));
                
                return hasInteractiveVerb || hasCurrentTime;
            }

            /**
             * *** Êñ∞Â¢ûÔºöÂà§Êñ≠‰∏ªË¶ÅËßíËâ≤ÊòØÂê¶‰∏ªÂØº‰∫íÂä® ***
             * @param {string} content - ‰∫íÂä®ÂÜÖÂÆπ
             * @param {string} primaryCharacter - ‰∏ªË¶ÅËßíËâ≤Âêç
             * @param {string[]} allCharacters - ÊâÄÊúâÊèêÂèäÁöÑËßíËâ≤
             * @returns {boolean} ‰∏ªË¶ÅËßíËâ≤ÊòØÂê¶‰∏ªÂØº
             */
            function QQ_IsPrimaryCharacterDominant(content, primaryCharacter, allCharacters) {
                // ËÆ°ÁÆó‰∏ªË¶ÅËßíËâ≤Âú®ÂÜÖÂÆπ‰∏≠ÁöÑÈáçË¶ÅÊÄßÊùÉÈáç
                let primaryWeight = 0;
                let otherWeight = 0;
                
                // 1. ËßíËâ≤ÂêçÂá∫Áé∞È¢ëÁéá
                const primaryCount = (content.match(new RegExp(primaryCharacter, 'g')) || []).length;
                const otherCounts = allCharacters
                    .filter(char => char !== primaryCharacter)
                    .reduce((sum, char) => sum + (content.match(new RegExp(char, 'g')) || []).length, 0);
                
                primaryWeight += primaryCount * 2;
                otherWeight += otherCounts;
                
                // 2. ‰∫íÂä®Âä®ËØçÁöÑ‰∏ªËØ≠Ê£ÄÊµã
                const interactionPatterns = [
                    new RegExp(`${primaryCharacter}(?:Ëµ∞Âêë|Ëµ∞Ëøë|Êä±‰Ωè|Êãâ‰Ωè|ÁúãÁùÄ|ÂØπ.*ËØ¥)`, 'g'),
                    new RegExp(`(?:Ëµ∞Âêë|Ëµ∞Ëøë|Êä±‰Ωè|Êãâ‰Ωè|ÁúãÁùÄ|ÂØπ)${primaryCharacter}`, 'g'),
                ];
                
                interactionPatterns.forEach(pattern => {
                    const matches = content.match(pattern) || [];
                    primaryWeight += matches.length * 3;
                });
                
                // 3. Áõ¥Êé•ÂØπËØùÊ£ÄÊµã
                const directDialogPatterns = [
                    new RegExp(`${primaryCharacter}[ËØ¥ÈÅìËÆ≤]`, 'g'),
                    new RegExp(`ÂØπ${primaryCharacter}ËØ¥`, 'g'),
                ];
                
                directDialogPatterns.forEach(pattern => {
                    const matches = content.match(pattern) || [];
                    primaryWeight += matches.length * 2;
                });
                
                // 4. ‰ΩçÁΩÆÂÖ≥Á≥ªÊ£ÄÊµãÔºàÁßÅÂØÜ‰∫íÂä®Ôºâ
                const intimatePatterns = [
                    new RegExp(`(?:Âíå|‰∏é|Ë∑ü)${primaryCharacter}(?:ÂçïÁã¨|ÁßÅ‰∏ã|ÊÇÑÊÇÑ|ÂÅ∑ÂÅ∑)`, 'g'),
                    new RegExp(`${primaryCharacter}(?:ÂçïÁã¨|ÁßÅ‰∏ã|ÊÇÑÊÇÑ|ÂÅ∑ÂÅ∑)`, 'g'),
                ];
                
                intimatePatterns.forEach(pattern => {
                    const matches = content.match(pattern) || [];
                    primaryWeight += matches.length * 4;
                });
                
                console.log(`ËßíËâ≤‰∏ªÂØºÊùÉÈáçÂàÜÊûê - ${primaryCharacter}: ${primaryWeight}, ÂÖ∂‰ªñËßíËâ≤: ${otherWeight}`);
                
                // ‰∏ªË¶ÅËßíËâ≤ÊùÉÈáçË∂ÖËøáÂÖ∂‰ªñËßíËâ≤ÊÄªÂíåÁöÑ60%Êó∂ÔºåËÆ§‰∏∫ÊòØ‰∏ªÂØº
                return primaryWeight > otherWeight * 0.6;
            }
            
            /**
             * ÊòæÁ§∫ÂÖ¨ÂÖ±‰∫íÂä®Á©∫Èó¥
             * @param {string} content - ‰∫íÂä®ÂÜÖÂÆπ
             * @param {string} characterName - ‰∏ªË¶ÅËßíËâ≤ÂêçÁß∞
             */
            function QQ_ShowPublicInteractiveSpace(content, characterName = "") {
                const spaceId = QQ_GenerateSpaceId();
                const spaceName = QQ_GetSpaceName(content, characterName);
                const charName = characterName || charcardname || "ËßíËâ≤";
                const charAvatar = charAvatarPath || "default_avatar.png";
                
                // ‰øùÂ≠òÂà∞ÂÖ¨ÂÖ±‰∫íÂä®Á©∫Èó¥
                QQ_InteractiveSpaces[spaceId] = {
                    id: spaceId,
                    name: spaceName,
                    content: content,
                    characterName: charName,
                    characterAvatar: charAvatar,
                    type: 'public',
                    participants: QQ_ExtractParticipants(content),
                    createdAt: new Date().toISOString(),
                    lastAccess: new Date().toISOString()
                };
                
                QQ_ActiveSpaceId = spaceId;
                
                // *** Á´ãÂç≥‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶ - Á°Æ‰øùÊï∞ÊçÆÊåÅ‰πÖÂåñ ***
                console.log('üè† ‰øùÂ≠òÂÖ¨ÂÖ±‰∫íÂä®Á©∫Èó¥Âà∞‰∏ñÁïå‰π¶:', spaceId);
                QQ_SaveInteractiveContentToWorldBook(content, null);
                QQ_SaveInteractiveSpaces().then(() => {
                    console.log('‚úÖ ÂÖ¨ÂÖ±‰∫íÂä®Á©∫Èó¥Êï∞ÊçÆÂ∑≤‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶');
                }).catch(error => {
                    console.error('‚ùå ÂÖ¨ÂÖ±‰∫íÂä®Á©∫Èó¥‰øùÂ≠òÂ§±Ë¥•:', error);
                });
                
                QQ_DisplayInteractiveSpace(spaceId, 'ÂÖ¨ÂÖ±‰∫íÂä®Á©∫Èó¥');
            }
            
            /**
             * ÊòæÁ§∫ËßíËâ≤‰∏ìÂ±û‰∫íÂä®Á©∫Èó¥
             * @param {string} content - ‰∫íÂä®ÂÜÖÂÆπ
             * @param {string} characterName - ËßíËâ≤ÂêçÁß∞
             */
            async function QQ_ShowCharacterInteractiveSpace(content, characterName) {
                const charName = characterName || charcardname || "ËßíËâ≤";
                
                // *** ÂÖ≥ÈîÆ‰ºòÂåñÔºöÂÖà‰ªé‰∏ñÁïå‰π¶ÈáçÊñ∞Âä†ËΩΩËßíËâ≤Á©∫Èó¥Êï∞ÊçÆ ***
                console.log(`üîÑ ÈáçÊñ∞Âä†ËΩΩËßíËâ≤ ${charName} ÁöÑ‰∫íÂä®Á©∫Èó¥Êï∞ÊçÆ`);
                await QQ_ForceReloadInteractiveSpaces();
                const spaceId = QQ_GenerateSpaceId();
                const spaceName = `${charName}¬∑${QQ_GetSceneFromContent(content)}`;
                const charAvatar = charAvatarPath || "default_avatar.png";
                
                // ‰ΩøÁî®Áã¨Á´ãÊÄßÊ£ÄÊü•ÂàùÂßãÂåñËßíËâ≤‰∏ìÂ±ûÁ©∫Èó¥Êï∞ÊçÆ
                QQ_EnsureCharacterSpaceIndependence(charName);
                
                // ‰øùÂ≠òÂà∞ËßíËâ≤‰∏ìÂ±ûÁ©∫Èó¥
                QQ_CharacterSpaces[charName][spaceId] = {
                    id: spaceId,
                    name: spaceName,
                    content: content,
                    characterName: charName,
                    characterAvatar: charAvatar,
                    type: 'character',
                    createdAt: new Date().toISOString(),
                    lastAccess: new Date().toISOString()
                };
                
                QQ_ActiveSpaceId = spaceId;
                
                // *** Á´ãÂç≥‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶ - Á°Æ‰øùÊï∞ÊçÆÊåÅ‰πÖÂåñ ***
                console.log(`üë§ ‰øùÂ≠òËßíËâ≤‰∫íÂä®Á©∫Èó¥Âà∞‰∏ñÁïå‰π¶: ${charName} - ${spaceId}`);
                QQ_SaveInteractiveContentToWorldBook(content, charName);
                
                // ÂºÇÊ≠•‰øùÂ≠òËßíËâ≤Á©∫Èó¥Êï∞ÊçÆÔºàÈùûÈòªÂ°ûÔºâ
                QQ_SaveCharacterSpaces().then(() => {
                    console.log(`‚úÖ ËßíËâ≤‰∫íÂä®Á©∫Èó¥Êï∞ÊçÆÂ∑≤‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶: ${charName}`);
                }).catch(error => {
                    console.error(`‚ùå ËßíËâ≤‰∫íÂä®Á©∫Èó¥‰øùÂ≠òÂ§±Ë¥•: ${charName}`, error);
                });
                
                QQ_DisplayCharacterSpace(spaceId, charName);
            }
            
            /**
             * ‰ªéÂÜÖÂÆπ‰∏≠ÊèêÂèñÂèÇ‰∏éËÄÖ
             * @param {string} content - ‰∫íÂä®ÂÜÖÂÆπ
             * @returns {string[]} ÂèÇ‰∏éËÄÖÂàóË°®
             */
            function QQ_ExtractParticipants(content) {
                const mentions = content.match(/[@„ÄêÔºàÔºú]\s*([^@„ÄêÔºàÔºú„ÄëÔºâÔºû\s]{2,8})\s*[„ÄëÔºâÔºû]/g) || [];
                const participants = mentions.map(m => m.replace(/[@„ÄêÔºàÔºú„ÄëÔºâÔºû]/g, '').trim());
                return [...new Set(participants)]; // ÂéªÈáç
            }
            
            /**
             * ‰ªéÂÜÖÂÆπ‰∏≠ÊèêÂèñÂú∫ÊôØÂÖ≥ÈîÆËØç
             * @param {string} content - ‰∫íÂä®ÂÜÖÂÆπ
             * @returns {string} Âú∫ÊôØÂêçÁß∞
             */
            function QQ_GetSceneFromContent(content) {
                const sceneKeywords = [
                    { keywords: ['Êã•Êä±', 'Êä±Êä±', 'ÂÆâÊÖ∞'], name: 'Ê∏©ÊöñÊó∂Âàª' },
                    { keywords: ['ËÅäÂ§©', 'Ë∞àËØù', '‰∫§ÊµÅ'], name: 'Ë∞àËØù' },
                    { keywords: ['Ê∏∏Êàè', 'Áé©ËÄç', 'Â®±‰πê'], name: 'Ê∏∏Êàè' },
                    { keywords: ['Â≠¶‰π†', 'Â∑•‰Ωú', 'Âä™Âäõ'], name: 'Â≠¶‰π†' },
                    { keywords: ['Êï£Ê≠•', 'Ëµ∞Ë∑Ø', 'ÈÄõ'], name: 'Êï£Ê≠•' },
                    { keywords: ['ÂêÉÈ•≠', 'Áî®È§ê', 'È£üÁâ©'], name: 'Áî®È§ê' },
                    { keywords: ['Áù°Ëßâ', '‰ºëÊÅØ', 'ÂçàÁù°'], name: '‰ºëÊÅØ' },
                    { keywords: ['Áúã‰π¶', 'ÈòÖËØª', 'Â≠¶‰π†'], name: 'ÈòÖËØª' },
                ];
                
                for (const scene of sceneKeywords) {
                    if (scene.keywords.some(keyword => content.includes(keyword))) {
                        return scene.name;
                    }
                }
                
                return 'Êó•Â∏∏';
            }
            
            /**
             * ‰øùÂ≠òËßíËâ≤‰∏ìÂ±û‰∫íÂä®Á©∫Èó¥Âà∞‰∏ñÁïå‰π¶
             */
            async function QQ_SaveCharacterSpaces() {
                try {
                    if (!QQ_IsWorldBookAvailable()) {
                        console.warn('‰∏ñÁïå‰π¶ÂäüËÉΩ‰∏çÂèØÁî®ÔºåÊó†Ê≥ï‰øùÂ≠òËßíËâ≤‰∫íÂä®Á©∫Èó¥');
                        return;
                    }
                    
                    // Ëé∑Âèñ‰∏ñÁïå‰π¶Êù°ÁõÆ
                    const entries = await getLorebookEntries(worldbook);
                    if (!entries) {
                        console.warn('Êó†Ê≥ïËé∑Âèñ‰∏ñÁïå‰π¶Êù°ÁõÆ');
                        return;
                    }
                    
                    const spaceData = {
                        characterSpaces: QQ_CharacterSpaces,
                        lastUpdated: new Date().toISOString(),
                        version: "1.0"
                    };
                    
                    // ÂàõÂª∫ÊàñÊõ¥Êñ∞‰∏ñÁïå‰π¶Êù°ÁõÆ
                    let entry = entries.find(e => e.comment === QQ_CHARACTER_SPACES_KEY);
                    if (!entry) {
                        entry = {
                            comment: QQ_CHARACTER_SPACES_KEY,
                            content: JSON.stringify(spaceData),
                            key: ["Ê≠§‰∏ñÁïå‰π¶Ê∞∏‰∏çËß¶Âèë_ËßíËâ≤‰∫íÂä®Á©∫Èó¥"],
                            keysecondary: [],
                            order: 1001,
                            enabled: true,
                            uid: Date.now() + 1
                        };
                        // Ê∑ªÂä†Âà∞worldbook.entriesÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
                        if (worldbook.entries) {
                            worldbook.entries.push(entry);
                        }
                    } else {
                        entry.content = JSON.stringify(spaceData);
                    }
                    
                    const success = await QQ_SafeSaveWorldInfo("ËßíËâ≤‰∫íÂä®Á©∫Èó¥Êï∞ÊçÆ");
                    if (success) {
                        const totalSpaces = Object.values(QQ_CharacterSpaces).reduce((sum, char) => sum + Object.keys(char).length, 0);
                        console.log('ËßíËâ≤‰∫íÂä®Á©∫Èó¥Êï∞ÊçÆ‰øùÂ≠òÂÆåÊàê:', Object.keys(QQ_CharacterSpaces).length, '‰∏™ËßíËâ≤,', totalSpaces, '‰∏™Á©∫Èó¥');
                    }
                } catch (error) {
                    console.error('‰øùÂ≠òËßíËâ≤‰∫íÂä®Á©∫Èó¥Êó∂ÂèëÁîüÈîôËØØ:', error);
                }
            }
            
            /**
             * ÊòæÁ§∫ÈÄöÁî®‰∫íÂä®Á©∫Èó¥ÁïåÈù¢
             * @param {string} spaceId - Á©∫Èó¥ID
             * @param {string} spaceTitle - Á©∫Èó¥Ê†áÈ¢ò
             * @param {string} characterName - ËßíËâ≤ÂêçÔºàÂèØÈÄâÔºåÁî®‰∫éËßíËâ≤‰∏ìÂ±ûÁ©∫Èó¥Ôºâ
             */
            function QQ_DisplayInteractiveSpace(spaceId, spaceTitle, characterName = null) {
                const spaceData = characterName ? 
                    QQ_CharacterSpaces[characterName][spaceId] : 
                    QQ_InteractiveSpaces[spaceId];
                
                if (!spaceData) {
                    console.error('Êú™ÊâæÂà∞‰∫íÂä®Á©∫Èó¥Êï∞ÊçÆ:', spaceId);
                    return;
                }
                
                // ÁßªÈô§Áé∞ÊúâÁöÑ‰∫íÂä®Á©∫Èó¥
                $('.QQ_interactive_space').remove();
                
                const isCharacterSpace = spaceData.type === 'character';
                const headerColor = isCharacterSpace ? 
                    'linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%)' : 
                    'linear-gradient(135deg, #4FC3F7 0%, #29B6F6 100%)';
                
                // ÂàõÂª∫‰∫íÂä®Á©∫Èó¥HTML - Áé∞‰ª£ÂåñÊâãÊú∫ÁïåÈù¢È£éÊ†º
                const interactiveSpaceHtml = `
                    <div class="QQ_interactive_space" data-space-id="${spaceId}" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.7);
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        animation: fadeIn 0.3s ease;
                        backdrop-filter: blur(10px);
                    ">
                        <div class="QQ_interactive_content" style="
                            background: #ffffff;
                            border-radius: 20px;
                            padding: 0;
                            max-width: 90%;
                            max-height: 80%;
                            overflow: hidden;
                            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                            position: relative;
                            color: #333;
                            animation: slideIn 0.3s ease;
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        ">
                            <div class="QQ_interactive_header" style="
                                background: ${headerColor};
                                padding: 25px 20px;
                                display: flex;
                                align-items: center;
                                color: white;
                                position: relative;
                            ">
                                <img src="${spaceData.characterAvatar}" alt="${spaceData.characterName}" style="
                                    width: 50px;
                                    height: 50px;
                                    border-radius: 50%;
                                    margin-right: 15px;
                                    border: 3px solid white;
                                    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
                                ">
                                <div style="flex: 1;">
                                    <h3 style="margin: 0; font-size: 18px; font-weight: 600;">${spaceData.name}</h3>
                                    <p style="margin: 5px 0 0 0; font-size: 13px; opacity: 0.9;">
                                        ${isCharacterSpace ? `${spaceData.characterName}ÁöÑ‰∏ìÂ±û‰∫íÂä®` : 'ÂÖ¨ÂÖ±‰∫íÂä®Á©∫Èó¥'}
                                    </p>
                                </div>
                                <button class="QQ_close_interactive" style="
                                    background: rgba(255, 255, 255, 0.2);
                                    border: none;
                                    color: white;
                                    width: 36px;
                                    height: 36px;
                                    border-radius: 50%;
                                    cursor: pointer;
                                    font-size: 20px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" 
                                   onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">
                                    √ó
                                </button>
                            </div>
                            <div class="QQ_interactive_body" style="
                                padding: 30px 25px;
                                font-size: 16px;
                                line-height: 1.6;
                                white-space: pre-wrap;
                                color: #333;
                                background: #fafafa;
                                max-height: 350px;
                                overflow-y: auto;
                                word-wrap: break-word;
                            ">${spaceData.content}</div>
                            <div class="QQ_interactive_footer" style="
                                padding: 25px;
                                background: #ffffff;
                                border-top: 1px solid #eee;
                                display: flex;
                                justify-content: center;
                                gap: 15px;
                            ">
                                <button class="QQ_reply_interactive" style="
                                    background: ${isCharacterSpace ? '#FF6B6B' : '#4FC3F7'};
                                    border: none;
                                    color: white;
                                    padding: 14px 28px;
                                    border-radius: 25px;
                                    cursor: pointer;
                                    font-size: 15px;
                                    font-weight: 500;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 3px 10px ${isCharacterSpace ? 'rgba(255, 107, 107, 0.3)' : 'rgba(79, 195, 247, 0.3)'};
                                " onmouseover="this.style.transform='translateY(-2px)'" 
                                   onmouseout="this.style.transform='translateY(0)'">
                                    üí¨ ÂõûÂ∫î‰∫íÂä®
                                </button>
                                <button class="QQ_close_interactive" style="
                                    background: #f5f5f5;
                                    border: none;
                                    color: #666;
                                    padding: 14px 28px;
                                    border-radius: 25px;
                                    cursor: pointer;
                                    font-size: 15px;
                                    font-weight: 500;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.background='#eeeeee'" 
                                   onmouseout="this.style.background='#f5f5f5'">
                                    ÂÖ≥Èó≠
                                </button>
                            </div>
                        </div>
                    </div>
                    <style>
                        @keyframes fadeIn {
                            from { opacity: 0; }
                            to { opacity: 1; }
                        }
                        @keyframes slideIn {
                            from { transform: translateY(-30px); opacity: 0; }
                            to { transform: translateY(0); opacity: 1; }
                        }
                        .QQ_interactive_space * {
                            user-select: text;
                        }
                        .QQ_interactive_body::-webkit-scrollbar {
                            width: 6px;
                        }
                        .QQ_interactive_body::-webkit-scrollbar-track {
                            background: #f1f1f1;
                            border-radius: 3px;
                        }
                        .QQ_interactive_body::-webkit-scrollbar-thumb {
                            background: #c1c1c1;
                            border-radius: 3px;
                        }
                        .QQ_interactive_body::-webkit-scrollbar-thumb:hover {
                            background: #a8a8a8;
                        }
                    </style>
                `;
                
                // Ê∑ªÂä†Âà∞È°µÈù¢
                $('body').append(interactiveSpaceHtml);
                
                // ÁªëÂÆö‰∫ã‰ª∂
                $('.QQ_close_interactive').on('click', function() {
                    $('.QQ_interactive_space').fadeOut(300, function() {
                        $(this).remove();
                    });
                });
                
                $('.QQ_reply_interactive').on('click', function() {
                    QQ_OpenInteractiveReply(isCharacterSpace ? characterName : spaceData.characterName);
                });
                
                // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
                $('.QQ_interactive_space').on('click', function(e) {
                    if (e.target === this) {
                        $(this).fadeOut(300, function() {
                            $(this).remove();
                        });
                    }
                });
            }
            
            /**
             * ÊòæÁ§∫ËßíËâ≤‰∏ìÂ±ûÁ©∫Èó¥Ôºà‰∏∫ÁÇπÂáªÁßÅËÅäÂêçÁß∞Ë∞ÉÁî®Ôºâ
             * @param {string} spaceId - Á©∫Èó¥ID  
             * @param {string} characterName - ËßíËâ≤ÂêçÁß∞
             */
            function QQ_DisplayCharacterSpace(spaceId, characterName) {
                QQ_DisplayInteractiveSpace(spaceId, `${characterName}ÁöÑ‰∫íÂä®Á©∫Èó¥`, characterName);
            }
            
            /**
             * ÊòæÁ§∫ËßíËâ≤‰∏ìÂ±û‰∫íÂä®Á©∫Èó¥ËèúÂçïÔºàÁÇπÂáªÁßÅËÅäÂêçÁß∞Êó∂Ë∞ÉÁî®Ôºâ
             * @param {string} characterName - ËßíËâ≤ÂêçÁß∞
             * @param {HTMLElement} element - ÁÇπÂáªÁöÑÂÖÉÁ¥†
             */
            function QQ_ShowCharacterInteractiveMenu(characterName, element) {
                console.log(`=== QQ_ShowCharacterInteractiveMenu Ë¢´Ë∞ÉÁî® ===`);
                console.log('ËßíËâ≤ÂêçÁß∞:', characterName);
                console.log('ÁÇπÂáªÂÖÉÁ¥†:', element);
                
                // Êñ∞ÈÄªËæëÔºöÊòæÁ§∫ËßíËâ≤‰∏ìÂ±ûÁ≤æÁÅµÊåâÈíÆ
                QQ_ShowCharacterSpirit(characterName);
            }
            
            // ===== ‰∏ñÁïå‰π¶‰øùÂ≠òÂäüËÉΩÊ£ÄÊü• =====
            
            /**
             * Ê£ÄÊü•‰∏ñÁïå‰π¶‰øùÂ≠òÂäüËÉΩÊòØÂê¶ÂèØÁî®
             * @returns {boolean} ‰∏ñÁïå‰π¶ÂäüËÉΩÊòØÂê¶ÂèØÁî®
             */
            function QQ_IsWorldBookAvailable() {
                return typeof worldbook !== 'undefined' && 
                       worldbook !== null && 
                       typeof saveWorldInfo === 'function';
            }
            
            /**
             * ÂÆâÂÖ®Âú∞‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶
             * @param {string} operation - Êìç‰ΩúÊèèËø∞
             * @returns {Promise<boolean>} ‰øùÂ≠òÊòØÂê¶ÊàêÂäü
             */
            async function QQ_SafeSaveWorldInfo(operation = "Êï∞ÊçÆ") {
                try {
                    if (!QQ_IsWorldBookAvailable()) {
                        console.warn(`‰∏ñÁïå‰π¶ÂäüËÉΩ‰∏çÂèØÁî®ÔºåÊó†Ê≥ï‰øùÂ≠ò${operation}`);
                        return false;
                    }
                    
                    await saveWorldInfo();
                    console.log(`${operation}Â∑≤ÊàêÂäü‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶`);
                    return true;
                } catch (error) {
                    console.error(`‰øùÂ≠ò${operation}Âà∞‰∏ñÁïå‰π¶Â§±Ë¥•:`, error);
                    return false;
                }
            }
            
            // ===== ËßíËâ≤‰∏ìÂ±ûÁ≤æÁÅµÊåâÈíÆÁ≥ªÁªü =====
            
            let QQ_CharacterSpirits = {}; // Â≠òÂÇ®ÊØè‰∏™ËßíËâ≤ÁöÑÁ≤æÁÅµÊåâÈíÆÁä∂ÊÄÅ
            
            /**
             * Ëé∑ÂèñËßíËâ≤Â§¥ÂÉè
             * @param {string} characterName - ËßíËâ≤ÂêçÁß∞
             * @returns {string} Â§¥ÂÉèURL
             */
            function QQ_GetCharacterAvatar(characterName) {
                try {
                    // Â∞ùËØïÂ§öÁßçÊñπÂºèËé∑ÂèñÂ§¥ÂÉè
                    let avatarUrl = null;
                    
                    console.log(`=== ÂºÄÂßãËé∑ÂèñËßíËâ≤ ${characterName} ÁöÑÂ§¥ÂÉè ===`);
                    
                    // *** ‰ºòÂÖàÊñπÊ≥ïÔºö‰ªé‰∏ñÁïå‰π¶'ÊâãÊú∫-ËßíËâ≤'‰∏≠Ëé∑Âèñ ***
                    const worldbookAvatar = getCharacterAvatarFromWorldbook(characterName);
                    if (worldbookAvatar && worldbookAvatar.avatarUrl) {
                        avatarUrl = worldbookAvatar.avatarUrl;
                        console.log(`‚úÖ ‰ΩøÁî®‰∏ñÁïå‰π¶Â§¥ÂÉè: ${avatarUrl}`);
                        return avatarUrl;
                    }
                    
                    // ÊñπÊ≥ï1: ‰ªéÂΩìÂâçËÅäÂ§©ÁïåÈù¢Ëé∑Âèñ
                    const chatAvatar = $(`.QQ_chat_item[data-name="${characterName}"] img`).attr('src');
                    console.log(`ÊñπÊ≥ï1 - ËÅäÂ§©ÁïåÈù¢Â§¥ÂÉè: ${chatAvatar}`);
                    if (chatAvatar && chatAvatar !== 'undefined' && chatAvatar !== '' && !chatAvatar.includes('undefined')) {
                        avatarUrl = chatAvatar;
                        console.log(`‚úÖ ‰ΩøÁî®ËÅäÂ§©ÁïåÈù¢Â§¥ÂÉè: ${avatarUrl}`);
                    }
                    
                    // ÊñπÊ≥ï2: ‰ªéËÅîÁ≥ª‰∫∫ÁïåÈù¢Ëé∑ÂèñÔºà‰∏é‰∏ñÁïå‰π¶Êï∞ÊçÆÂêåÊ≠•ÁöÑÔºâ
                    if (!avatarUrl) {
                        const contactAvatar = getCharacterAvatar(characterName);
                        if (contactAvatar && contactAvatar.backgroundImage) {
                            // ‰ªébackgroundImage CSSÂ±ûÊÄß‰∏≠ÊèêÂèñURL
                            const urlMatch = contactAvatar.backgroundImage.match(/url\(["']?([^"']*)["']?\)/);
                            if (urlMatch && urlMatch[1]) {
                                avatarUrl = urlMatch[1];
                                console.log(`‚úÖ ‰ΩøÁî®ËÅîÁ≥ª‰∫∫ÁïåÈù¢Â§¥ÂÉè: ${avatarUrl}`);
                            }
                        }
                    }
                    
                    // ÊñπÊ≥ï3: ‰ªéSillyTavernÁöÑËßíËâ≤Êï∞ÊçÆËé∑Âèñ
                    if (!avatarUrl && typeof getCharacterAvatar === 'function') {
                        try {
                            const stAvatar = getCharacterAvatar(characterName);
                            console.log(`ÊñπÊ≥ï3 - SillyTavernÂáΩÊï∞Â§¥ÂÉè: ${stAvatar}`);
                            if (stAvatar && stAvatar !== 'undefined' && stAvatar !== '') {
                                avatarUrl = stAvatar;
                                console.log(`‚úÖ ‰ΩøÁî®SillyTavernÂáΩÊï∞Â§¥ÂÉè: ${avatarUrl}`);
                            }
                        } catch (e) {
                            console.warn('SillyTavern getCharacterAvatarÂáΩÊï∞Ë∞ÉÁî®Â§±Ë¥•:', e);
                        }
                    }
                    
                    // ÊñπÊ≥ï3: ‰ΩøÁî®SillyTavernÁöÑÂÜÖÁΩÆÊï∞ÊçÆ
                    if (!avatarUrl && typeof characters !== 'undefined' && Array.isArray(characters)) {
                        const character = characters.find(char => char.name === characterName || char.avatar === characterName);
                        console.log(`ÊñπÊ≥ï3 - ÊâæÂà∞ÁöÑËßíËâ≤Êï∞ÊçÆ:`, character);
                        if (character && character.avatar) {
                            avatarUrl = character.avatar;
                            console.log(`‚úÖ ‰ΩøÁî®ËßíËâ≤Êï∞ÊçÆÂ§¥ÂÉè: ${avatarUrl}`);
                        }
                    }
                    
                    // ÊñπÊ≥ï4: ‰ªéÂÖ®Â±ÄÂèòÈáèËé∑Âèñ
                    if (!avatarUrl && typeof window.SillyTavern !== 'undefined') {
                        try {
                            const context = window.SillyTavern.getContext();
                            if (context && context.characters) {
                                const character = context.characters.find(char => char.name === characterName);
                                if (character && character.avatar) {
                                    avatarUrl = character.avatar;
                                    console.log(`‚úÖ ‰ΩøÁî®SillyTavern contextÂ§¥ÂÉè: ${avatarUrl}`);
                                }
                            }
                        } catch (e) {
                            console.warn('Ëé∑ÂèñSillyTavern contextÂ§±Ë¥•:', e);
                        }
                    }
                    
                    // ÊñπÊ≥ï5: Â∞ùËØï‰ªéËÅäÂ§©Ê†áÈ¢ò‰∏≠Ëé∑ÂèñÂ§¥ÂÉè
                    if (!avatarUrl) {
                        const titleAvatar = $(`.QQ_chat_title[data-name="${characterName}"] img`).attr('src');
                        console.log(`ÊñπÊ≥ï5 - ËÅäÂ§©Ê†áÈ¢òÂ§¥ÂÉè: ${titleAvatar}`);
                        if (titleAvatar && titleAvatar !== 'undefined' && titleAvatar !== '') {
                            avatarUrl = titleAvatar;
                            console.log(`‚úÖ ‰ΩøÁî®ËÅäÂ§©Ê†áÈ¢òÂ§¥ÂÉè: ${avatarUrl}`);
                        }
                    }
                    
                    // ÊñπÊ≥ï6: ‰ªéÈöèÊú∫Â§¥ÂÉèÂàóË°®Ëé∑Âèñ‰∏Ä‰∏™Â§áÁî®Â§¥ÂÉè
                    if (!avatarUrl) {
                        try {
                            // Â∞ùËØï‰ªé‰∏ñÁïå‰π¶‰∏≠Ëé∑ÂèñÈöèÊú∫Â§¥ÂÉèÔºàÂºÇÊ≠•ÊñπÂºèÔºâ
                            if (typeof worldbook !== 'undefined' && worldbook) {
                                // ÂºÇÊ≠•Ëé∑ÂèñÂ§¥ÂÉèÔºå‰ΩÜ‰∏çÈòªÂ°û‰∏ªÊµÅÁ®ã
                                getLorebookEntries(worldbook).then(entries => {
                                    if (entries) {
                                        const avatarEntry = entries.find(entry => 
                                            entry.comment && entry.comment.includes('ÈöèÊú∫Â§¥ÂÉè')
                                        );
                                        if (avatarEntry && avatarEntry.content) {
                                            const avatarList = avatarEntry.content.split('\n').filter(line => 
                                                line.trim() && (line.includes('http') || line.includes('files.catbox.moe'))
                                            );
                                            if (avatarList.length > 0) {
                                                // ‰ΩøÁî®ËßíËâ≤ÂêçÂ≠óÁ¨¶‰∏≤ÈïøÂ∫¶‰Ωú‰∏∫ÈöèÊú∫ÁßçÂ≠ê
                                                const randomIndex = characterName.length % avatarList.length;
                                                const randomAvatar = avatarList[randomIndex].trim();
                                                console.log(`‚úÖ ÂºÇÊ≠•Ëé∑ÂèñÈöèÊú∫Â§¥ÂÉè: ${randomAvatar}`);
                                                // Â¶ÇÊûúÂΩìÂâçÊ≤°ÊúâÊúâÊïàÂ§¥ÂÉèÔºåÊõ¥Êñ∞‰∏∫ÈöèÊú∫Â§¥ÂÉè
                                                if (!avatarUrl || avatarUrl.includes('default')) {
                                                    avatarUrl = randomAvatar;
                                                }
                                            }
                                        }
                                    }
                                }).catch(e => {
                                    console.warn('ÂºÇÊ≠•Ëé∑ÂèñÈöèÊú∫Â§¥ÂÉèÂ§±Ë¥•:', e);
                                });
                            }
                        } catch (e) {
                            console.warn('Ëé∑ÂèñÈöèÊú∫Â§¥ÂÉèÂ§±Ë¥•:', e);
                        }
                        
                        // Â¶ÇÊûúÈöèÊú∫Â§¥ÂÉè‰πüËé∑ÂèñÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§SVGÂ§¥ÂÉè
                        if (!avatarUrl) {
                            avatarUrl = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiByeD0iMzAiIGZpbGw9IiNGRjZCNkIiLz4KPHR leHQgeD0iMzAiIHk9IjM1IiBmb250LXNpemU9IjI0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9ImFyaWFsIj7igKI8L3RleHQ+Cjwvc3ZnPgo=';
                            console.log(`‚ö†Ô∏è ‰ΩøÁî®ÈªòËÆ§SVGÂ§¥ÂÉè: ${characterName}`);
                        }
                    }
                    
                    // Â§ÑÁêÜÁõ∏ÂØπË∑ØÂæÑÂíåÂÆåÊï¥URL
                    if (avatarUrl && typeof avatarUrl === 'string') {
                        // Ê£ÄÊü•ÊòØÂê¶ÊòØÊúâÊïàÁöÑURLÊ†ºÂºè
                        if (avatarUrl.startsWith('http') || avatarUrl.startsWith('data:') || avatarUrl.startsWith('blob:')) {
                            // ÂÆåÊï¥URLÊàñbase64ÔºåÁõ¥Êé•‰ΩøÁî®
                            console.log(`‚úÖ ‰ΩøÁî®ÂÆåÊï¥URL: ${avatarUrl.substring(0, 100)}...`);
                        } else if (avatarUrl.startsWith('./') || avatarUrl.startsWith('../')) {
                            // Áõ∏ÂØπË∑ØÂæÑÔºå‰øùÊåÅ‰∏çÂèò
                            console.log(`‚úÖ ‰ΩøÁî®Áõ∏ÂØπË∑ØÂæÑ: ${avatarUrl}`);
                        } else if (avatarUrl.startsWith('characters/') || avatarUrl.includes('characters/')) {
                            // SillyTavernËßíËâ≤Ë∑ØÂæÑÔºåÂèØËÉΩÈúÄË¶ÅË∞ÉÊï¥
                            if (!avatarUrl.startsWith('/')) {
                                avatarUrl = '/' + avatarUrl;
                            }
                            console.log(`‚úÖ ‰ΩøÁî®ËßíËâ≤Ë∑ØÂæÑ: ${avatarUrl}`);
                        } else {
                            // ÂÖ∂‰ªñÊÉÖÂÜµÔºåÊ∑ªÂä†Ê†πË∑ØÂæÑ
                            if (!avatarUrl.startsWith('/')) {
                                avatarUrl = '/' + avatarUrl;
                            }
                            console.log(`‚úÖ Ê∑ªÂä†Ê†πË∑ØÂæÑ: ${avatarUrl}`);
                        }
                    } else {
                        // Â¶ÇÊûúavatarUrl‰∏çÊòØÊúâÊïàÂ≠óÁ¨¶‰∏≤Ôºå‰ΩøÁî®ÈªòËÆ§SVGÂ§¥ÂÉè
                        avatarUrl = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiByeD0iMzAiIGZpbGw9IiNGRjZCNkIiLz4KPHR leHQgeD0iMzAiIHk9IjM1IiBmb250LXNpemU9IjI0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9ImFyaWFsIj7igKI8L3RleHQ+Cjwvc3ZnPgo=';
                        console.warn(`Â§¥ÂÉèURLÊó†ÊïàÔºå‰ΩøÁî®ÈªòËÆ§SVGÂ§¥ÂÉè: ${characterName}`);
                    }
                    
                    console.log(`=== ÊúÄÁªàËé∑ÂèñÁöÑÂ§¥ÂÉèURL: ${avatarUrl} ===`);
                    return avatarUrl;
                } catch (error) {
                    console.error('Ëé∑ÂèñËßíËâ≤Â§¥ÂÉèÂ§±Ë¥•:', error);
                    return 'default_avatar.png';
                }
            }
            
            /**
             * ÊòæÁ§∫ËßíËâ≤Á≤æÁÅµÈù¢Êùø
             * @param {string} characterName - ËßíËâ≤ÂêçÁß∞
             */
            function QQ_ShowCharacterSpiritPanel(characterName) {
                console.log(`ÊòæÁ§∫ËßíËâ≤ ${characterName} ÁöÑÁ≤æÁÅµÈù¢Êùø`);
                
                // ÁßªÈô§Áé∞ÊúâÈù¢Êùø
                $('.QQ_character_spirit_panel').remove();
                
                const characterAvatar = QQ_GetCharacterAvatar(characterName);
                
                // ÂàõÂª∫Á≤æÁÅµÈù¢ÊùøHTML
                const panelHtml = `
                    <div class="QQ_character_spirit_panel" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.8);
                        z-index: 999999999;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        animation: fadeIn 0.3s ease;
                        backdrop-filter: blur(15px);
                    ">
                        <div class="QQ_spirit_panel_content" style="
                            background: #ffffff;
                            border-radius: 20px;
                            padding: 0;
                            max-width: 90%;
                            overflow: hidden;
                            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                            color: #333;
                            animation: slideIn 0.3s ease;
                            width: 350px;
                        ">
                            <div class="spirit-panel-header" style="
                                background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
                                color: white;
                                padding: 20px;
                                text-align: center;
                                position: relative;
                            ">
                                <img src="${characterAvatar}" alt="${characterName}" style="
                                    width: 60px;
                                    height: 60px;
                                    border-radius: 50%;
                                    border: 3px solid white;
                                    margin-bottom: 10px;
                                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                                " onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiByeD0iMzAiIGZpbGw9IiNGRjZCNkIiLz4KPHRLEHA+4pWpPC90ZXh0Pgo8L3N2Zz4K'; console.log('Á≤æÁÅµÈù¢ÊùøÂ§¥ÂÉèÂä†ËΩΩÂ§±Ë¥•: ${characterName}');">
                                <h3 style="margin: 0; font-size: 18px; font-weight: 600;">${characterName}</h3>
                                <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">‰∏ìÂ±û‰∫íÂä®Á≤æÁÅµ</p>
                                <button class="QQ_close_spirit_panel" style="
                                    position: absolute;
                                    top: 15px;
                                    right: 15px;
                                    background: rgba(255, 255, 255, 0.2);
                                    border: none;
                                    color: white;
                                    width: 30px;
                                    height: 30px;
                                    border-radius: 50%;
                                    cursor: pointer;
                                    font-size: 16px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" 
                                   onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">
                                    √ó
                                </button>
                            </div>
                            
                            <div class="spirit-panel-body" style="
                                padding: 25px 20px;
                            ">
                                <p style="
                                    text-align: center;
                                    color: #666;
                                    margin-bottom: 20px;
                                    font-size: 14px;
                                    line-height: 1.5;
                                ">
                                    ÈÄâÊã©‰Ω†ÊÉ≥Ë¶Å‰∏é ${characterName} ËøõË°åÁöÑ‰∫íÂä®Á±ªÂûã
                                </p>
                                
                                <div class="spirit-options" style="
                                    display: flex;
                                    flex-direction: column;
                                    gap: 12px;
                                ">
                                    <button class="QQ_spirit_option" data-action="interactive_space" style="
                                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                        border: none;
                                        color: white;
                                        padding: 15px 20px;
                                        border-radius: 12px;
                                        cursor: pointer;
                                        font-size: 14px;
                                        font-weight: 500;
                                        transition: all 0.3s ease;
                                        box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
                                        display: flex;
                                        align-items: center;
                                        gap: 10px;
                                    " onmouseover="this.style.transform='translateY(-2px)'" 
                                       onmouseout="this.style.transform='translateY(0)'">
                                        <span style="font-size: 18px;">üåü</span>
                                        <span>ÂºÄÂêØ‰∫íÂä®Á©∫Èó¥</span>
                                    </button>
                                    
                                    <button class="QQ_spirit_option" data-action="create_space" style="
                                        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
                                        border: none;
                                        color: white;
                                        padding: 15px 20px;
                                        border-radius: 12px;
                                        cursor: pointer;
                                        font-size: 14px;
                                        font-weight: 500;
                                        transition: all 0.3s ease;
                                        box-shadow: 0 3px 10px rgba(67, 233, 123, 0.3);
                                        display: flex;
                                        align-items: center;
                                        gap: 10px;
                                    " onmouseover="this.style.transform='translateY(-2px)'" 
                                       onmouseout="this.style.transform='translateY(0)'">
                                        <span style="font-size: 18px;">‚ú®</span>
                                        <span>ÂàõÂª∫Êñ∞‰∫íÂä®</span>
                                    </button>
                                    
                                    <button class="QQ_spirit_option" data-action="hide_spirit" style="
                                        background: #f8f9fa;
                                        border: 1px solid #e9ecef;
                                        color: #6c757d;
                                        padding: 12px 20px;
                                        border-radius: 12px;
                                        cursor: pointer;
                                        font-size: 14px;
                                        font-weight: 500;
                                        transition: all 0.3s ease;
                                        display: flex;
                                        align-items: center;
                                        gap: 10px;
                                    " onmouseover="this.style.background='#e9ecef'" 
                                       onmouseout="this.style.background='#f8f9fa'">
                                        <span style="font-size: 18px;">üëª</span>
                                        <span>ÈöêËóèÁ≤æÁÅµ</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Ê∑ªÂä†Âà∞È°µÈù¢
                $('body').append(panelHtml);
                
                // ÁªëÂÆöÂÖ≥Èó≠‰∫ã‰ª∂
                $('.QQ_close_spirit_panel').on('click', function() {
                    $('.QQ_character_spirit_panel').fadeOut(300, function() {
                        $(this).remove();
                    });
                });
                
                // ÁªëÂÆöÈÄâÈ°π‰∫ã‰ª∂
                $('.QQ_spirit_option[data-action="interactive_space"]').on('click', function() {
                    $('.QQ_character_spirit_panel').remove();
                    QQ_ShowCharacterInteractiveSpaces(characterName);
                });
                
                $('.QQ_spirit_option[data-action="create_space"]').on('click', function() {
                    $('.QQ_character_spirit_panel').remove();
                    QQ_CreateCharacterInteractiveSpace(characterName);
                });
                
                $('.QQ_spirit_option[data-action="hide_spirit"]').on('click', function() {
                    $('.QQ_character_spirit_panel').remove();
                    QQ_HideCharacterSpirit(characterName);
                    toastr.info(`Â∑≤ÈöêËóè ${characterName} ÁöÑÁ≤æÁÅµÊåâÈíÆ`, 'Á≤æÁÅµÊåâÈíÆ');
                });
                
                // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
                $('.QQ_character_spirit_panel').on('click', function(e) {
                    if (e.target === this) {
                        $(this).fadeOut(300, function() {
                            $(this).remove();
                        });
                    }
                });
            }
            
            /**
             * ÊòæÁ§∫ËßíËâ≤ÁöÑ‰∫íÂä®Á©∫Èó¥ÂàóË°®
             * @param {string} characterName - ËßíËâ≤ÂêçÁß∞
             */
            function QQ_ShowCharacterInteractiveSpaces(characterName) {
                console.log(`ÊòæÁ§∫ËßíËâ≤ ${characterName} ÁöÑ‰∫íÂä®Á©∫Èó¥ÂàóË°®`);
                
                // Á°Æ‰øùËßíËâ≤Êúâ‰∫íÂä®Á©∫Èó¥Êï∞ÊçÆ
                if (!QQ_CharacterSpaces[characterName]) {
                    QQ_CharacterSpaces[characterName] = {};
                }
                
                const characterSpaces = QQ_CharacterSpaces[characterName];
                const spaceKeys = Object.keys(characterSpaces);
                
                if (spaceKeys.length === 0) {
                    toastr.info(`${characterName} ËøòÊ≤°Êúâ‰∫íÂä®Á©∫Èó¥ÔºåÁÇπÂáªÂàõÂª∫Êñ∞‰∫íÂä®ÂºÄÂßãÂêßÔºÅ`, '‰∫íÂä®Á©∫Èó¥');
                    QQ_CreateCharacterInteractiveSpace(characterName);
                    return;
                }
                
                // ÁßªÈô§Áé∞ÊúâÈù¢Êùø
                $('.QQ_character_spaces_list').remove();
                
                let spacesListHtml = `
                    <div class="QQ_character_spaces_list" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.8);
                        z-index: 999999999;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        animation: fadeIn 0.3s ease;
                        backdrop-filter: blur(15px);
                    ">
                        <div style="
                            background: #ffffff;
                            border-radius: 20px;
                            padding: 0;
                            max-width: 90%;
                            max-height: 80%;
                            overflow: hidden;
                            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                            color: #333;
                            animation: slideIn 0.3s ease;
                            width: 400px;
                        ">
                            <div style="
                                background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
                                color: white;
                                padding: 20px;
                                text-align: center;
                                position: relative;
                            ">
                                <h3 style="margin: 0; font-size: 18px; font-weight: 600;">${characterName} ÁöÑ‰∫íÂä®Á©∫Èó¥</h3>
                                <p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.9;">ÈÄâÊã©‰∏Ä‰∏™‰∫íÂä®Á©∫Èó¥</p>
                                <button class="QQ_close_spaces_list" style="
                                    position: absolute;
                                    top: 15px;
                                    right: 15px;
                                    background: rgba(255, 255, 255, 0.2);
                                    border: none;
                                    color: white;
                                    width: 30px;
                                    height: 30px;
                                    border-radius: 50%;
                                    cursor: pointer;
                                    font-size: 16px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                ">√ó</button>
                            </div>
                            
                            <div style="
                                padding: 20px;
                                max-height: 300px;
                                overflow-y: auto;
                            ">
                `;
                
                // Ê∑ªÂä†‰∫íÂä®Á©∫Èó¥ÈÄâÈ°π
                spaceKeys.forEach(spaceId => {
                    const space = characterSpaces[spaceId];
                    spacesListHtml += `
                        <div class="QQ_space_item" data-space-id="${spaceId}" style="
                            background: #f8f9fa;
                            border: 1px solid #e9ecef;
                            border-radius: 12px;
                            padding: 15px;
                            margin-bottom: 10px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.background='#e9ecef'" 
                           onmouseout="this.style.background='#f8f9fa'">
                            <h4 style="margin: 0 0 5px 0; font-size: 14px; color: #333;">${space.name}</h4>
                            <p style="margin: 0; font-size: 12px; color: #666; line-height: 1.4;">
                                ${space.content.substring(0, 100)}${space.content.length > 100 ? '...' : ''}
                            </p>
                        </div>
                    `;
                });
                
                spacesListHtml += `
                            </div>
                            
                            <div style="
                                padding: 20px;
                                border-top: 1px solid #eee;
                                text-align: center;
                            ">
                                <button class="QQ_create_new_space" style="
                                    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
                                    border: none;
                                    color: white;
                                    padding: 12px 20px;
                                    border-radius: 10px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.3s ease;
                                ">
                                    ‚ú® ÂàõÂª∫Êñ∞‰∫íÂä®Á©∫Èó¥
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Ê∑ªÂä†Âà∞È°µÈù¢
                $('body').append(spacesListHtml);
                
                // ÁªëÂÆö‰∫ã‰ª∂
                $('.QQ_close_spaces_list').on('click', function() {
                    $('.QQ_character_spaces_list').remove();
                });
                
                $('.QQ_space_item').on('click', function() {
                    const spaceId = $(this).data('space-id');
                    $('.QQ_character_spaces_list').remove();
                    QQ_DisplayEnhancedInteractiveSpace(spaceId, characterSpaces[spaceId].name, characterName);
                });
                
                $('.QQ_create_new_space').on('click', function() {
                    $('.QQ_character_spaces_list').remove();
                    QQ_CreateCharacterInteractiveSpace(characterName);
                });
                
                // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
                $('.QQ_character_spaces_list').on('click', function(e) {
                    if (e.target === this) {
                        $(this).remove();
                    }
                });
            }
            
            /**
             * ÂàõÂª∫ËßíËâ≤‰∫íÂä®Á©∫Èó¥
             * @param {string} characterName - ËßíËâ≤ÂêçÁß∞
             */
            function QQ_CreateCharacterInteractiveSpace(characterName) {
                console.log(`‰∏∫ËßíËâ≤ ${characterName} ÂàõÂª∫Êñ∞ÁöÑ‰∫íÂä®Á©∫Èó¥`);
                
                // ÁîüÊàê‰∫íÂä®Á©∫Èó¥ËØ∑Ê±Ç
                const interactiveRequest = `ËØ∑‰∏∫ËßíËâ≤ ${characterName} ÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑ‰∫íÂä®Á©∫Èó¥„ÄÇ

ËØ∑‰ª•MiPhoneÊ†ºÂºèÂõûÂ§çÔºåÂú®contentÊ†áÁ≠æ‰∏≠ÊèèËø∞‰∏Ä‰∏™ÊúâË∂£ÁöÑ‰∫íÂä®Âú∫ÊôØÔºåÊØîÂ¶ÇÔºö
- ËßíËâ≤ÈÇÄËØ∑Áî®Êà∑ÂèÇ‰∏éÊüê‰∏™Ê¥ªÂä®
- ÂàõÈÄ†‰∏Ä‰∏™ÁâπÊÆäÁöÑÁéØÂ¢ÉÊàñÊÉÖÂ¢É
- ËÆæËÆ°‰∏Ä‰∏™ÊúâË∂£ÁöÑÂØπËØùÂú∫ÊôØ

ÂÜÖÂÆπÂ∫îËØ•ÁîüÂä®ÊúâË∂£ÔºåËÉΩÂ§üÂê∏ÂºïÁî®Êà∑ÂèÇ‰∏é‰∫íÂä®„ÄÇ`;
                
                // ÊòæÁ§∫ÂàõÂª∫Áä∂ÊÄÅ
                toastr.info(`Ê≠£Âú®‰∏∫ ${characterName} ÂàõÂª∫‰∫íÂä®Á©∫Èó¥...`, '‰∫íÂä®Á©∫Èó¥');
                
                // ÂèëÈÄÅËØ∑Ê±ÇÂà∞AI
                QQ_Gen(interactiveRequest, async function(aiResponse) {
                    try {
                        if (aiResponse && aiResponse.trim()) {
                            // Ëß£ÊûêAIÂõûÂ§çÔºåÊèêÂèñcontentÂÜÖÂÆπ
                            const contentMatch = aiResponse.match(/<content>([\s\S]*?)<\/content>/i);
                            const interactiveContent = contentMatch ? contentMatch[1].trim() : aiResponse.trim();
                            
                            if (interactiveContent) {
                                // ÂàõÂª∫Êñ∞ÁöÑ‰∫íÂä®Á©∫Èó¥
                                const spaceId = 'space_' + Date.now();
                                const characterAvatar = QQ_GetCharacterAvatar(characterName);
                                
                                if (!QQ_CharacterSpaces[characterName]) {
                                    QQ_CharacterSpaces[characterName] = {};
                                }
                                
                                QQ_CharacterSpaces[characterName][spaceId] = {
                                    id: spaceId,
                                    name: `‰∏é${characterName}ÁöÑ‰∫íÂä®`,
                                    content: interactiveContent,
                                    characterName: characterName,
                                    characterAvatar: characterAvatar,
                                    type: 'character',
                                    createTime: new Date().toISOString()
                                };
                                
                                // ÂàùÂßãÂåñÈ°µÈù¢Êï∞ÊçÆ
                                QQ_InteractivePages[spaceId] = [interactiveContent];
                                QQ_InteractiveCurrentPage[spaceId] = 0;
                                
                                // *** Á´ãÂç≥‰øùÂ≠ò‰∫íÂä®ÂÜÖÂÆπÂà∞‰∏ñÁïå‰π¶ ***
                                QQ_SaveInteractiveContentToWorldBook(interactiveContent, characterName).then(interactiveId => {
                                    console.log(`üéØ ÂàõÂª∫ÁöÑ‰∫íÂä®Á©∫Èó¥Â∑≤Á´ãÂç≥‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶ÔºåID: ${interactiveId}, ËßíËâ≤: ${characterName}`);
                                }).catch(error => {
                                    console.error('‰øùÂ≠òÂàõÂª∫ÁöÑ‰∫íÂä®Á©∫Èó¥Â§±Ë¥•:', error);
                                });
                                
                                // ÂêåÊó∂‰øùÂ≠òÂà∞ÊóßÁöÑ‰∫íÂä®Á©∫Èó¥Â≠òÂÇ®ÔºàÂÖºÂÆπÊÄßÔºâ
                                QQ_SaveInteractiveSpaceToWorldBook(spaceId, characterName).catch(error => {
                                    console.error('‰øùÂ≠ò‰∫íÂä®Á©∫Èó¥Â§±Ë¥•:', error);
                                });
                                
                                // ÊòæÁ§∫Êñ∞ÂàõÂª∫ÁöÑ‰∫íÂä®Á©∫Èó¥
                                QQ_DisplayEnhancedInteractiveSpace(spaceId, `‰∏é${characterName}ÁöÑ‰∫íÂä®`, characterName);
                                
                                toastr.success(`Â∑≤‰∏∫ ${characterName} ÂàõÂª∫Êñ∞ÁöÑ‰∫íÂä®Á©∫Èó¥ÔºÅ`, '‰∫íÂä®Á©∫Èó¥');
                            } else {
                                toastr.error('AIÂõûÂ§çÊ†ºÂºèÈîôËØØ', '‰∫íÂä®Á©∫Èó¥');
                            }
                        } else {
                            toastr.error('AIÂõûÂ§ç‰∏∫Á©∫', '‰∫íÂä®Á©∫Èó¥');
                        }
                    } catch (error) {
                        console.error('ÂàõÂª∫‰∫íÂä®Á©∫Èó¥Êó∂Âá∫Èîô:', error);
                        toastr.error('ÂàõÂª∫‰∫íÂä®Á©∫Èó¥Â§±Ë¥•');
                    }
                });
            }
            
            // ===== ÊµãËØïÂíåË∞ÉËØïÂäüËÉΩ =====
            
            /**
             * ÊµãËØïËßíËâ≤‰∏ìÂ±ûÁ≤æÁÅµÁ≥ªÁªü
             */
            function QQ_Test_Character_Spirit_System() {
                console.log('=== ËßíËâ≤‰∏ìÂ±ûÁ≤æÁÅµÁ≥ªÁªüÊµãËØï ===');
                
                // ÊµãËØï1: ÊòæÁ§∫ÂΩìÂâçËßíËâ≤Á≤æÁÅµÁä∂ÊÄÅ
                console.log('ÂΩìÂâçÁ≤æÁÅµÁä∂ÊÄÅ:', QQ_CharacterSpirits);
                
                // ÊµãËØï2: ÊòæÁ§∫ËßíËâ≤Á©∫Èó¥Êï∞ÊçÆ
                console.log('ËßíËâ≤Á©∫Èó¥Êï∞ÊçÆ:', QQ_CharacterSpaces);
                
                // ÊµãËØï3: Ëé∑ÂèñÂΩìÂâçËÅäÂ§©È°µÈù¢
                const currentChatPage = $('.QQ_chat_page:visible');
                const currentCharacter = currentChatPage.length > 0 ? currentChatPage.attr('data-name') : null;
                console.log('ÂΩìÂâçËÅäÂ§©ËßíËâ≤:', currentCharacter);
                
                // ÊµãËØï4: ÊµãËØïÂ§¥ÂÉèËé∑ÂèñÂäüËÉΩ
                if (currentCharacter) {
                    const avatar = QQ_GetCharacterAvatar(currentCharacter);
                    console.log(`ËßíËâ≤ ${currentCharacter} ÁöÑÂ§¥ÂÉè:`, avatar);
                }
                
                // ÊµãËØï5: Ê£ÄÊü•Á≤æÁÅµÊåâÈíÆÊòØÂê¶Â≠òÂú®
                const spiritButtons = $('.QQ_character_spirit');
                console.log('È°µÈù¢‰∏äÁöÑÁ≤æÁÅµÊåâÈíÆÊï∞Èáè:', spiritButtons.length);
                spiritButtons.each(function() {
                    const characterName = $(this).attr('data-character');
                    console.log(`- Á≤æÁÅµÊåâÈíÆ: ${characterName}`);
                });
                
                toastr.info('ËßíËâ≤‰∏ìÂ±ûÁ≤æÁÅµÁ≥ªÁªüÊµãËØïÂÆåÊàêÔºåËØ∑Êü•ÁúãÊéßÂà∂Âè∞ËæìÂá∫', 'Á≥ªÁªüÊµãËØï');
            }
            
            /**
             * ÊâãÂä®‰∏∫ÊåáÂÆöËßíËâ≤ÊòæÁ§∫Á≤æÁÅµÊåâÈíÆÔºàË∞ÉËØïÁî®Ôºâ
             * @param {string} characterName - ËßíËâ≤ÂêçÁß∞
             */
            function QQ_Debug_Show_Character_Spirit(characterName) {
                if (!characterName) {
                    toastr.error('ËØ∑Êèê‰æõËßíËâ≤ÂêçÁß∞', 'Ë∞ÉËØïÂ∑•ÂÖ∑');
                    return;
                }
                
                console.log(`ÊâãÂä®ÊòæÁ§∫ËßíËâ≤ ${characterName} ÁöÑÁ≤æÁÅµÊåâÈíÆ`);
                QQ_ShowCharacterSpirit(characterName);
                toastr.success(`Â∑≤ÊòæÁ§∫ËßíËâ≤ ${characterName} ÁöÑÁ≤æÁÅµÊåâÈíÆ`, 'Ë∞ÉËØïÂ∑•ÂÖ∑');
            }
            
            /**
             * ÊòæÁ§∫ÊâÄÊúâÁ≤æÁÅµÁ≥ªÁªüÁä∂ÊÄÅ‰ø°ÊÅØ
             */
            function QQ_Show_Spirit_System_Stats() {
                console.log('=== Á≤æÁÅµÁ≥ªÁªüÁä∂ÊÄÅÊä•Âëä ===');
                console.log('Á≤æÁÅµÊåâÈíÆÁä∂ÊÄÅ:', QQ_CharacterSpirits);
                console.log('ËßíËâ≤Á©∫Èó¥Êï∞ÊçÆ:', QQ_CharacterSpaces);
                console.log('‰∫íÂä®È°µÈù¢Êï∞ÊçÆ:', QQ_InteractivePages);
                console.log('ÂΩìÂâçÈ°µÈù¢Á¥¢Âºï:', QQ_InteractiveCurrentPage);
                
                // ÁªüËÆ°‰ø°ÊÅØ
                const spiritCount = Object.keys(QQ_CharacterSpirits).length;
                const spaceCount = Object.keys(QQ_CharacterSpaces).reduce((total, char) => total + Object.keys(QQ_CharacterSpaces[char]).length, 0);
                const pageCount = Object.keys(QQ_InteractivePages).length;
                
                console.log('=== ÁªüËÆ°‰ø°ÊÅØ ===');
                console.log(`Ê¥ªË∑ÉÁ≤æÁÅµÊåâÈíÆ: ${spiritCount} ‰∏™`);
                console.log(`‰∫íÂä®Á©∫Èó¥ÊÄªÊï∞: ${spaceCount} ‰∏™`);
                console.log(`È°µÈù¢Êï∞ÊçÆÊÄªÊï∞: ${pageCount} ‰∏™`);
                
                toastr.info(`Á≤æÁÅµÁ≥ªÁªüÁä∂ÊÄÅ: ${spiritCount}‰∏™Á≤æÁÅµ, ${spaceCount}‰∏™Á©∫Èó¥, ${pageCount}‰∏™È°µÈù¢`, 'Á≥ªÁªüÁä∂ÊÄÅ');
            }
            
                         /**
              * ÊµãËØïÂ§¥ÂÉèËé∑ÂèñÂäüËÉΩ
              * @param {string} characterName - ËßíËâ≤ÂêçÁß∞
              */
             function QQ_Test_Avatar_Loading(characterName) {
                 if (!characterName) {
                     // Ëé∑ÂèñÂΩìÂâçËÅäÂ§©ËßíËâ≤
                     const currentChatPage = $('.QQ_chat_page:visible');
                     characterName = currentChatPage.length > 0 ? currentChatPage.attr('data-name') : null;
                     
                     if (!characterName) {
                         toastr.error('ËØ∑ÂÖàÊâìÂºÄ‰∏Ä‰∏™ÁßÅËÅäÈ°µÈù¢ÊàñÊèê‰æõËßíËâ≤ÂêçÁß∞', 'Â§¥ÂÉèÊµãËØï');
                         return;
                     }
                 }
                 
                 console.log(`=== ÂºÄÂßãÊµãËØïËßíËâ≤ ${characterName} ÁöÑÂ§¥ÂÉèËé∑Âèñ ===`);
                 
                 // Ëé∑ÂèñÂ§¥ÂÉèURL
                 const avatarUrl = QQ_GetCharacterAvatar(characterName);
                 
                 // ÂàõÂª∫ÊµãËØïÁïåÈù¢
                 const testHtml = `
                     <div class="QQ_avatar_test_panel" style="
                         position: fixed;
                         top: 50px;
                         right: 50px;
                         width: 300px;
                         background: white;
                         border-radius: 15px;
                         padding: 20px;
                         box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                         z-index: 999999999;
                         border: 2px solid #FF6B6B;
                     ">
                         <h3 style="margin: 0 0 15px 0; color: #333; text-align: center;">Â§¥ÂÉèÊµãËØïÈù¢Êùø</h3>
                         <p style="margin: 5px 0; color: #666;"><strong>ËßíËâ≤ÂêçÁß∞:</strong> ${characterName}</p>
                         <p style="margin: 5px 0; color: #666; word-break: break-all;"><strong>Â§¥ÂÉèURL:</strong> ${avatarUrl}</p>
                         
                         <div style="text-align: center; margin: 15px 0;">
                             <img src="${avatarUrl}" alt="${characterName}" style="
                                 width: 80px;
                                 height: 80px;
                                 border-radius: 50%;
                                 border: 3px solid #FF6B6B;
                                 object-fit: cover;
                             " onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiByeD0iMzAiIGZpbGw9IiNGRjZCNkIiLz4KPHRLEHA+4pWpPC90ZXh0Pgo8L3N2Zz4K'; this.style.border='3px solid red'; console.log('ÊµãËØïÂ§¥ÂÉèÂä†ËΩΩÂ§±Ë¥•: ${characterName}');">
                         </div>
                         
                         <div style="text-align: center; gap: 10px; display: flex; justify-content: space-between;">
                             <button class="QQ_test_show_spirit" style="
                                 background: #FF6B6B;
                                 color: white;
                                 border: none;
                                 padding: 8px 12px;
                                 border-radius: 8px;
                                 cursor: pointer;
                                 font-size: 12px;
                             ">ÊòæÁ§∫Á≤æÁÅµ</button>
                             <button class="QQ_test_close" style="
                                 background: #999;
                                 color: white;
                                 border: none;
                                 padding: 8px 12px;
                                 border-radius: 8px;
                                 cursor: pointer;
                                 font-size: 12px;
                             ">ÂÖ≥Èó≠</button>
                         </div>
                     </div>
                 `;
                 
                 // ÁßªÈô§Áé∞ÊúâÊµãËØïÈù¢Êùø
                 $('.QQ_avatar_test_panel').remove();
                 
                 // Ê∑ªÂä†Êñ∞ÁöÑÊµãËØïÈù¢Êùø
                 $('body').append(testHtml);
                 
                 // ÁªëÂÆö‰∫ã‰ª∂
                 $('.QQ_test_show_spirit').on('click', function() {
                     QQ_ShowCharacterSpirit(characterName);
                     toastr.success(`Â∑≤ÊòæÁ§∫ ${characterName} ÁöÑÁ≤æÁÅµÊåâÈíÆ`, 'ÊµãËØï');
                 });
                 
                 $('.QQ_test_close').on('click', function() {
                     $('.QQ_avatar_test_panel').remove();
                 });
                 
                 toastr.info(`Â§¥ÂÉèÊµãËØïÈù¢ÊùøÂ∑≤ÊòæÁ§∫ÔºåËØ∑Êü•ÁúãÂè≥‰∏äËßí`, 'Â§¥ÂÉèÊµãËØï');
             }
             
             // Ê∑ªÂä†Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü‰æõË∞ÉËØï‰ΩøÁî®
             window.QQ_Test_Character_Spirit_System = QQ_Test_Character_Spirit_System;
             window.QQ_Debug_Show_Character_Spirit = QQ_Debug_Show_Character_Spirit;
             window.QQ_Show_Spirit_System_Stats = QQ_Show_Spirit_System_Stats;
             window.QQ_Test_Avatar_Loading = QQ_Test_Avatar_Loading;
            
            /**
             * ÊòæÁ§∫ËßíËâ≤‰∏ìÂ±ûÁ≤æÁÅµÊåâÈíÆ
             * @param {string} characterName - ËßíËâ≤ÂêçÁß∞
             */
            function QQ_ShowCharacterSpirit(characterName) {
                // Â¶ÇÊûúÂ∑≤ÁªèÊòæÁ§∫ÔºåÂàô‰∏çÈáçÂ§çÂàõÂª∫
                if ($(`.QQ_character_spirit[data-character="${characterName}"]`).length > 0) return;
                
                console.log(`ÊòæÁ§∫ËßíËâ≤ ${characterName} ÁöÑ‰∏ìÂ±ûÁ≤æÁÅµÊåâÈíÆ`);
                
                // ÈöêËóèÂÖ∂‰ªñËßíËâ≤ÁöÑÁ≤æÁÅµÊåâÈíÆ
                QQ_HideAllCharacterSpirits();
                
                // Ëé∑ÂèñËßíËâ≤Â§¥ÂÉè
                const characterAvatar = QQ_GetCharacterAvatar(characterName);
                
                // Ëé∑Âèñ‰∏äÊ¨°‰øùÂ≠òÁöÑ‰ΩçÁΩÆ
                const savedPosition = localStorage.getItem(`QQ_spirit_position_${characterName}`);
                let position = { right: '20px', top: '50%' };
                if (savedPosition) {
                    try {
                        position = JSON.parse(savedPosition);
                    } catch (e) {
                        console.warn('Ëß£ÊûêËßíËâ≤Á≤æÁÅµ‰ΩçÁΩÆÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§‰ΩçÁΩÆ');
                    }
                }
                
                                // ÂàõÂª∫Á≤æÁÅµÊåâÈíÆHTML
                const positionStyle = position.right ? 
                    'right: ' + position.right : 'left: ' + position.left;
                const topBottomStyle = position.bottom ? 
                    'bottom: ' + position.bottom : 'top: ' + position.top;
                
                const spiritHtml = 
                    '<div class="QQ_character_spirit" data-character="' + characterName + '" style="' +
                        'position: fixed;' +
                        positionStyle + ';' +
                        topBottomStyle + ';' +
                        'width: 70px;' +
                        'height: 70px;' +
                        'border-radius: 50%;' +
                        'box-shadow: 0 4px 20px rgba(255, 107, 107, 0.4);' +
                        'cursor: move;' +
                        'z-index: 9999;' +
                        'display: flex;' +
                        'align-items: center;' +
                        'justify-content: center;' +
                        'user-select: none;' +
                        'transition: all 0.3s ease;' +
                        'animation: characterSpiritPulse 2s infinite;' +
                        'background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);' +
                        'padding: 4px;' +
                    '" title="‰∏é ' + characterName + ' ‰∫íÂä®">' +
                        '<img src="' + characterAvatar + '" alt="' + characterName + '" style="' +
                            'width: 100%;' +
                            'height: 100%;' +
                            'border-radius: 50%;' +
                            'object-fit: cover;' +
                            'border: 2px solid white;' +
                        '" onerror="this.onerror=null; this.src=\'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiByeD0iMzAiIGZpbGw9IiNGRjZCNkIiLz4KPHRLEHA+4pWpPC90ZXh0Pgo8L3N2Zz4K\'; console.log(\'Â§¥ÂÉèÂä†ËΩΩÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè: ' + characterName + '\');">' +
                        '<div style="' +
                            'position: absolute;' +
                            'bottom: -5px;' +
                            'right: -5px;' +
                            'width: 24px;' +
                            'height: 24px;' +
                            'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);' +
                            'border-radius: 50%;' +
                            'display: flex;' +
                            'align-items: center;' +
                            'justify-content: center;' +
                            'font-size: 12px;' +
                            'color: white;' +
                            'border: 2px solid white;' +
                            'box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);' +
                        '">‚ú®</div>' +
                    '</div>' +
                    '<style>' +
                        '@keyframes characterSpiritPulse {' +
                            '0%, 100% { transform: scale(1); box-shadow: 0 4px 20px rgba(255, 107, 107, 0.4); }' +
                            '50% { transform: scale(1.05); box-shadow: 0 6px 25px rgba(255, 107, 107, 0.6); }' +
                        '}' +
                        '.QQ_character_spirit:hover {' +
                            'transform: scale(1.1) !important;' +
                            'box-shadow: 0 6px 25px rgba(255, 107, 107, 0.7) !important;' +
                        '}' +
                    '</style>';
                
                $('body').append(spiritHtml);
                
                QQ_CharacterSpirits[characterName] = true;
                console.log(`ËßíËâ≤ ${characterName} ÁöÑÁ≤æÁÅµÊåâÈíÆÂ∑≤ÊòæÁ§∫`);
                
                // ÁªëÂÆöÁÇπÂáª‰∫ã‰ª∂
                $(`.QQ_character_spirit[data-character="${characterName}"]`).on('click touchend', function(e) {
                    if ($(this).hasClass('dragging')) {
                        return;
                    }
                    
                    e.stopPropagation();
                    e.preventDefault();
                    console.log(`ËßíËâ≤Á≤æÁÅµË¢´ÁÇπÂáª: ${characterName}`);
                    QQ_ShowCharacterSpiritPanel(characterName);
                });
                
                // ÁªëÂÆöÊãñÊãΩÂäüËÉΩ
                QQ_MakeCharacterSpiritDraggable(characterName);
                
                console.log(`ËßíËâ≤ ${characterName} ÁöÑÁ≤æÁÅµÊåâÈíÆÂ∑≤ÊòæÁ§∫`);
            }
            
            /**
             * ÈöêËóèÊâÄÊúâËßíËâ≤ÁöÑÁ≤æÁÅµÊåâÈíÆ
             */
            function QQ_HideAllCharacterSpirits() {
                $('.QQ_character_spirit').fadeOut(300, function() {
                    $(this).remove();
                });
                QQ_CharacterSpirits = {};
                console.log('ÊâÄÊúâËßíËâ≤Á≤æÁÅµÊåâÈíÆÂ∑≤ÈöêËóè');
            }
            
            /**
             * ÈöêËóèÁâπÂÆöËßíËâ≤ÁöÑÁ≤æÁÅµÊåâÈíÆ
             * @param {string} characterName - ËßíËâ≤ÂêçÁß∞
             */
            function QQ_HideCharacterSpirit(characterName) {
                $(`.QQ_character_spirit[data-character="${characterName}"]`).fadeOut(300, function() {
                    $(this).remove();
                });
                delete QQ_CharacterSpirits[characterName];
                console.log(`ËßíËâ≤ ${characterName} ÁöÑÁ≤æÁÅµÊåâÈíÆÂ∑≤ÈöêËóè`);
            }
            
            /**
             * ‰ΩøËßíËâ≤Á≤æÁÅµÊåâÈíÆÂèØÊãñÊãΩ
             * @param {string} characterName - ËßíËâ≤ÂêçÁß∞
             */
            function QQ_MakeCharacterSpiritDraggable(characterName) {
                let isDragging = false;
                let dragStarted = false;
                let startX, startY, initialX, initialY;
                let dragTimer;
                
                $(`.QQ_character_spirit[data-character="${characterName}"]`).on('mousedown touchstart', function(e) {
                    e.preventDefault();
                    dragStarted = false;
                    
                    const rect = this.getBoundingClientRect();
                    initialX = rect.left;
                    initialY = rect.top;
                    
                    const clientX = e.type === 'touchstart' ? e.originalEvent.touches[0].clientX : e.clientX;
                    const clientY = e.type === 'touchstart' ? e.originalEvent.touches[0].clientY : e.clientY;
                    
                    startX = clientX - initialX;
                    startY = clientY - initialY;
                    
                    dragTimer = setTimeout(() => {
                        isDragging = true;
                        dragStarted = true;
                        
                        $(`.QQ_character_spirit[data-character="${characterName}"]`).addClass('dragging').css({
                            'cursor': 'grabbing',
                            'z-index': '99999999',
                            'animation': 'none'
                        });
                        
                        console.log(`ÂºÄÂßãÊãñÊãΩËßíËâ≤Á≤æÁÅµ: ${characterName}`);
                    }, 150);
                });
                
                $(document).on('mousemove touchmove', function(e) {
                    if (!isDragging) return;
                    
                    const clientX = e.type === 'touchmove' ? e.originalEvent.touches[0].clientX : e.clientX;
                    const clientY = e.type === 'touchmove' ? e.originalEvent.touches[0].clientY : e.clientY;
                    
                    const x = clientX - startX;
                    const y = clientY - startY;
                    
                    const maxX = window.innerWidth - 65;
                    const maxY = window.innerHeight - 65;
                    
                    const constrainedX = Math.max(0, Math.min(x, maxX));
                    const constrainedY = Math.max(0, Math.min(y, maxY));
                    
                    $(`.QQ_character_spirit[data-character="${characterName}"]`).css({
                        'left': constrainedX + 'px',
                        'top': constrainedY + 'px',
                        'right': 'auto',
                        'bottom': 'auto'
                    });
                    
                    e.preventDefault();
                });
                
                $(document).on('mouseup touchend', function(e) {
                    if (dragTimer) {
                        clearTimeout(dragTimer);
                        dragTimer = null;
                    }
                    
                    if (!isDragging && !dragStarted) {
                        return;
                    }
                    
                    if (!isDragging) return;
                    isDragging = false;
                    dragStarted = false;
                    
                    const $spirit = $(`.QQ_character_spirit[data-character="${characterName}"]`);
                    $spirit.removeClass('dragging').css({
                        'cursor': 'move',
                        'z-index': '9999999',
                        'animation': 'characterSpiritPulse 2s infinite'
                    });
                    
                    // ‰øùÂ≠ò‰ΩçÁΩÆ
                    const rect = $spirit[0].getBoundingClientRect();
                    const windowWidth = window.innerWidth;
                    const windowHeight = window.innerHeight;
                    
                    let position;
                    if (rect.left < windowWidth / 2) {
                        position = {
                            left: rect.left + 'px',
                            top: rect.top + 'px'
                        };
                    } else {
                        position = {
                            right: (windowWidth - rect.right) + 'px',
                            top: rect.top + 'px'
                        };
                    }
                    
                    const positionKey = `QQ_character_spirit_position_${characterName}`;
                    localStorage.setItem(positionKey, JSON.stringify(position));
                    console.log(`ËßíËâ≤ ${characterName} Á≤æÁÅµ‰ΩçÁΩÆÂ∑≤‰øùÂ≠ò`);
                });
            }
            
            /**
             * ÊòæÁ§∫ËßíËâ≤Á≤æÁÅµÈù¢Êùø
             * @param {string} characterName - ËßíËâ≤ÂêçÁß∞
             */
            function QQ_ShowCharacterSpiritPanel(characterName) {
                console.log(`ÊòæÁ§∫ËßíËâ≤ ${characterName} Á≤æÁÅµÈù¢Êùø`);
                
                // Á°Æ‰øùËßíËâ≤ÂêçÁß∞ÊúâÊïà
                if (!characterName || typeof characterName !== 'string') {
                    console.error('Êó†ÊïàÁöÑËßíËâ≤ÂêçÁß∞:', characterName);
                    return;
                }
                
                // ÁßªÈô§Áé∞ÊúâÁöÑÈù¢Êùø
                $('.QQ_character_spirit_panel').remove();
                
                // ‰ΩøÁî®Áã¨Á´ãÊÄßÊ£ÄÊü•Á°Æ‰øùÊï∞ÊçÆÂÆâÂÖ®
                if (!QQ_EnsureCharacterSpaceIndependence(characterName)) {
                    console.error(`ËßíËâ≤ ${characterName} ÁöÑ‰∫íÂä®Á©∫Èó¥Áã¨Á´ãÊÄßÊ£ÄÊü•Â§±Ë¥•`);
                    toastr.error('‰∫íÂä®Á©∫Èó¥Êï∞ÊçÆÈîôËØØ');
                    return;
                }
                
                // Ëé∑ÂèñËßíËâ≤ÁöÑ‰∫íÂä®Á©∫Èó¥ÂàóË°®
                const characterSpaces = QQ_CharacterSpaces[characterName];
                const spaceList = Object.values(characterSpaces);
                
                // ÂàõÂª∫Èù¢ÊùøHTML
                const panelHtml = `
                    <div class="QQ_character_spirit_panel" style="
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: white;
                        border-radius: 15px;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                        z-index: 99999999;
                        overflow: hidden;
                        animation: spiritPanelSlideIn 0.3s ease;
                        max-width: 90%;
                        max-height: 80%;
                        width: 350px;
                    ">
                        <div class="panel-header" style="
                            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
                            color: white;
                            padding: 20px;
                            text-align: center;
                            font-weight: 600;
                        ">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                                <img src="${charAvatarPath || getAvatarUrl(characterName)}" alt="${characterName}" style="
                                    width: 40px;
                                    height: 40px;
                                    border-radius: 50%;
                                    border: 2px solid white;
                                ">
                                <span style="font-size: 16px;">üíï ${characterName}ÁöÑ‰∫íÂä®Á©∫Èó¥</span>
                            </div>
                        </div>
                        
                        ${spaceList.length > 0 ? `
                            <div class="space-list" style="max-height: 300px; overflow-y: auto;">
                                ${spaceList.slice(0, 30).map(space => `
                                    <div class="space-item" data-space-id="${space.id}" style="
                                        padding: 15px 20px;
                                        border-bottom: 1px solid #f0f0f0;
                                        cursor: pointer;
                                        transition: background-color 0.2s ease;
                                        display: flex;
                                        align-items: center;
                                        gap: 12px;
                                    " onmouseover="this.style.backgroundColor='#f8f9fa'" 
                                       onmouseout="this.style.backgroundColor='transparent'">
                                        <div style="
                                            width: 10px;
                                            height: 10px;
                                            border-radius: 50%;
                                            background: #FF6B6B;
                                            flex-shrink: 0;
                                        "></div>
                                        <div style="flex: 1; min-width: 0;">
                                            <div style="
                                                font-size: 14px;
                                                font-weight: 500;
                                                color: #333;
                                                margin-bottom: 3px;
                                                overflow: hidden;
                                                text-overflow: ellipsis;
                                                white-space: nowrap;
                                            ">${space.name}</div>
                                            <div style="
                                                font-size: 12px;
                                                color: #999;
                                            ">${QQ_FormatDate(space.createdAt)}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div style="
                                padding: 40px 20px;
                                text-align: center;
                                color: #999;
                            ">
                                <div style="font-size: 48px; margin-bottom: 15px;">üåü</div>
                                <div style="font-size: 14px; margin-bottom: 8px;">ËøòÊ≤°Êúâ‰∫íÂä®ËÆ∞ÂΩï</div>
                                <div style="font-size: 12px; color: #bbb;">ÂºÄÂßã‰∏ÄÊÆµÁé∞ÂÆû‰∫íÂä®ÂêßÔΩû</div>
                            </div>
                        `}
                        
                        <div class="panel-actions" style="
                            padding: 20px;
                            background: #fafafa;
                            display: flex;
                            gap: 10px;
                        ">
                            <button class="new-space-btn" style="
                                flex: 1;
                                background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
                                border: none;
                                color: white;
                                padding: 12px 16px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 13px;
                                font-weight: 500;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.transform='translateY(-1px)'" 
                               onmouseout="this.style.transform='translateY(0)'">
                                ‚ú® ÂàõÂª∫Êñ∞‰∫íÂä®
                            </button>
                            <button class="close-panel-btn" style="
                                background: #e9ecef;
                                border: none;
                                color: #666;
                                padding: 12px 16px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 13px;
                                font-weight: 500;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.background='#dee2e6'" 
                               onmouseout="this.style.background='#e9ecef'">
                                ÂÖ≥Èó≠
                            </button>
                        </div>
                        
                        <!-- Êñ∞Â¢ûÔºö‰∫íÂä®Áä∂ÊÄÅÊèêÁ§∫ -->
                        <div class="interactive-tip" style="
                            padding: 12px 20px;
                            background: linear-gradient(135deg, #E8F5E8 0%, #F0F8FF 100%);
                            border-top: 1px solid #e9ecef;
                            font-size: 12px;
                            color: #666;
                            line-height: 1.4;
                        ">
                            <div style="
                                display: flex;
                                align-items: center;
                                gap: 8px;
                                margin-bottom: 6px;
                                font-weight: 500;
                            ">
                                <span style="
                                    display: inline-block;
                                    width: 16px;
                                    height: 16px;
                                    background: #4CAF50;
                                    border-radius: 50%;
                                    color: white;
                                    text-align: center;
                                    line-height: 16px;
                                    font-size: 10px;
                                ">üí°</span>
                                <span style="color: #4CAF50;">ÂΩìÂâç‰∫íÂä®Ëß¶ÂèëÁä∂ÊÄÅ</span>
                            </div>
                            <div id="interactive-status-content" style="margin-left: 24px; font-size: 11px;">
                                <!-- Áä∂ÊÄÅÂÜÖÂÆπÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÂ°´ÂÖÖ -->
                            </div>
                        </div>
                    </div>
                    
                    <style>
                        @keyframes spiritPanelSlideIn {
                            from {
                                opacity: 0;
                                transform: translate(-50%, -60%);
                            }
                            to {
                                opacity: 1;
                                transform: translate(-50%, -50%);
                            }
                        }
                    </style>
                `;
                
                // Ê∑ªÂä†Âà∞È°µÈù¢
                $('body').append(panelHtml);
                
                // Âä®ÊÄÅÊõ¥Êñ∞‰∫íÂä®Áä∂ÊÄÅ
                QQ_UpdateInteractiveStatus();
                
                // ÁªëÂÆö‰∫ã‰ª∂
                $('.QQ_character_spirit_panel').on('click', function(e) {
                    e.stopPropagation();
                    
                    const spaceItem = e.target.closest('.space-item');
                    const newSpaceBtn = e.target.closest('.new-space-btn');
                    const closePanelBtn = e.target.closest('.close-panel-btn');
                    
                    if (spaceItem) {
                        const spaceId = spaceItem.getAttribute('data-space-id');
                        console.log(`ÁÇπÂáªÊü•Áúã‰∫íÂä®Á©∫Èó¥: ${spaceId}`);
                        QQ_DisplayEnhancedInteractiveSpace(spaceId, `${characterName}ÁöÑ‰∫íÂä®Á©∫Èó¥`, characterName);
                        $('.QQ_character_spirit_panel').remove();
                    } else if (newSpaceBtn) {
                        console.log(`‰∏∫ËßíËâ≤ ${characterName} ÂàõÂª∫Êñ∞ÁöÑ‰∫íÂä®Á©∫Èó¥`);
                        $('.QQ_character_spirit_panel').remove();
                        QQ_ShowCharacterInteractiveSpace(characterName);
                    } else if (closePanelBtn) {
                        $('.QQ_character_spirit_panel').remove();
                    }
                });
                
                // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠Èù¢Êùø
                $(document).one('click', function() {
                    $('.QQ_character_spirit_panel').remove();
                });
            }
            
            /**
             * Ê†ºÂºèÂåñÊó•ÊúüÊòæÁ§∫
             * @param {string} dateStr - ISOÊó•ÊúüÂ≠óÁ¨¶‰∏≤
             * @returns {string} Ê†ºÂºèÂåñÂêéÁöÑÊó•Êúü
             */
            function QQ_FormatDate(dateStr) {
                const date = new Date(dateStr);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                if (diffMins < 1) {
                    return 'ÂàöÂàö';
                } else if (diffMins < 60) {
                    return `${diffMins}ÂàÜÈíüÂâç`;
                } else if (diffHours < 24) {
                    return `${diffHours}Â∞èÊó∂Ââç`;
                } else if (diffDays < 7) {
                    return `${diffDays}Â§©Ââç`;
                } else {
                    return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
                }
            }
            
            /**
             * *** Êñ∞Â¢ûÔºöÂàõÂª∫Áõ¥Êé•ÁöÑ‰∫íÂä®ÂÜÖÂÆπËØ∑Ê±Ç ***
             * @param {string} userDescription - Áî®Êà∑ÊèèËø∞ÁöÑ‰∫íÂä®ÂÜÖÂÆπ
             * @returns {string} Áõ¥Êé•‰∫íÂä®ËØ∑Ê±Ç
             */
            function QQ_CreateDirectInteractiveRequest(userDescription) {
                return `üéØ Áî®Êà∑‰∏ªÂä®ËØ∑Ê±Ç‰∫íÂä®ÂÜÖÂÆπÔºö
ËØ∑Ê†πÊçÆÁî®Êà∑ÁöÑÊèèËø∞Ôºö"${userDescription}"ÔºåÁõ¥Êé•ÂàõÂª∫‰∏Ä‰∏™ÁîüÂä®ËØ¶ÁªÜÁöÑ‰∫íÂä®Âú∫ÊôØ„ÄÇ

üìã ËØ∑Ê±ÇË¶ÅÊ±ÇÔºö
1. Áõ¥Êé•ÁîüÊàê‰∫íÂä®ÂÜÖÂÆπÔºåÊó†ÈúÄÊôÆÈÄöËÅäÂ§©ÂõûÂ§ç
2. ÂÜÖÂÆπÂøÖÈ°ªÁî® <content> Ê†áÁ≠æÂåÖË£π
3. ÊèèËø∞Ë¶ÅÁîüÂä®ËØ¶ÁªÜÔºåÁ¨¶ÂêàÁé∞ÂÆû‰∫íÂä®ÁöÑÊÑüÂèó
4. Ê†πÊçÆ‰∫íÂä®ÊÄßË¥®Âà§Êñ≠‰øùÂ≠ò‰ΩçÁΩÆÔºö
   - Ê∂âÂèäÂ§ö‰∫∫/Áæ§‰Ωì ‚Üí ÂÖ¨ÂÖ±‰∫íÂä®Á©∫Èó¥
   - ÂçïÁã¨ÂíåËßíËâ≤ ‚Üí ËßíËâ≤‰∏ìÂ±ûÁ©∫Èó¥
5. ‰∫íÂä®ÂÜÖÂÆπË¶ÅÊúâÊ≤âÊµ∏ÊÑüÂíåÁúüÂÆûÊÑü
6. ÂåÖÂê´Âä®‰Ωú„ÄÅÂØπËØù„ÄÅÊÑüÂÆòÁªÜËäÇ„ÄÅÊÉÖÊÑüË°®Ëææ

üí° ËøôÊòØÁî®Êà∑‰ΩøÁî®ÁâπÊÆäÁ¨¶Âè∑‰∏ªÂä®Ëß¶ÂèëÁöÑ‰∫íÂä®ËØ∑Ê±ÇÔºåËØ∑ÁßØÊûÅÂõûÂ∫îÔºÅ

<Request:ËØ∑Ê†πÊçÆ‰∏äËø∞Áî®Êà∑ÊèèËø∞ÁîüÊàê‰∫íÂä®ÂÜÖÂÆπÔºåÁõ¥Êé•Áî®contentÊ†áÁ≠æÂåÖË£π>`;
            }
            
            /**
             * ‰∏∫‰∫íÂä®ÂÜÖÂÆπËØ∑Ê±Ç‰øÆÊîπAIÊåáÂØº
             * @param {string} originalRequest - ÂéüÂßãËØ∑Ê±ÇÂÜÖÂÆπ
             * @returns {string} - ‰øÆÊîπÂêéÁöÑËØ∑Ê±ÇÂÜÖÂÆπ
             */
            function QQ_ModifyRequestForInteractive(originalRequest) {
                // Âú®RequestÊ†áÁ≠æ‰∏≠Ê∑ªÂä†‰∫íÂä®ÂÜÖÂÆπË¶ÅÊ±Ç
                const interactiveGuidance = `
<InteractiveGuidance:üî• Âº∫Âà∂ÊâßË°åÔºöÁî®Êà∑ÁöÑÊ∂àÊÅØÂåÖÂê´ÊòéÊòæÁöÑ‰∫íÂä®ÊÑèÂõæÔºåÂøÖÈ°ª‰∏•Ê†ºÊåâÁÖß‰ª•‰∏ãË¶ÅÊ±ÇÂõûÂ§ç üî•

üì±„ÄêÂèåÈáçÂõûÂ§çË¶ÅÊ±Ç„ÄëÔºö
1. „ÄêÂøÖÈ°ªÂÖàÂõûÂ§ç„ÄëÂú®Áî®Êà∑ÂΩìÂâçÂèëË®ÄÁöÑ‰ΩçÁΩÆÔºàÁßÅËÅä/Áæ§ËÅä/Âä®ÊÄÅËØÑËÆ∫ÔºâÊ≠£Â∏∏ÂõûÂ§çÔºåË°®ËææÂèçÂ∫î„ÄÅÁ°ÆËÆ§„ÄÅÊÉÖÊÑüÁ≠â
2. „ÄêÁÑ∂ÂêéÊèê‰æõ‰∫íÂä®„ÄëÁî®<content>Ê†áÁ≠æÂåÖË£πËØ¶ÁªÜÁöÑÁé∞ÂÆû‰∫íÂä®Âú∫ÊôØÊèèËø∞

üö®„ÄêÂº∫Âà∂ÊâßË°åÈ°∫Â∫è„ÄëÔºö
- ÁßÅËÅä‰∫íÂä®ÔºöÂÖàÂú®ÁßÅËÅä‰∏≠ÂõûÂ§ç ‚Üí ÂÜçÊèê‰æõ‰∫íÂä®ÂÜÖÂÆπ
- Áæ§ËÅä‰∫íÂä®ÔºöÂÖàÂú®Áæ§ËÅä‰∏≠ÂõûÂ§ç ‚Üí ÂÜçÊèê‰æõ‰∫íÂä®ÂÜÖÂÆπ  
- Âä®ÊÄÅËØÑËÆ∫‰∫íÂä®ÔºöÂÖàÂú®ËØÑËÆ∫‰∏≠ÂõûÂ§ç ‚Üí ÂÜçÊèê‰æõ‰∫íÂä®ÂÜÖÂÆπ

üí¨„ÄêÂõûÂ§çÁ§∫‰æãÊ†ºÂºè„ÄëÔºö

**ÁßÅËÅäÂú∫ÊôØ**Ôºö
<Áî®Êà∑ÂêçÂíåËßíËâ≤ÂêçÁöÑÁßÅËÅä>
ËßíËâ≤Âêç--Â•ΩÁöÑÔºÅÊàëÈ©¨‰∏äËøáÊù•Êâæ‰Ω†~--Êó∂Èó¥
</Áî®Êà∑ÂêçÂíåËßíËâ≤ÂêçÁöÑÁßÅËÅä>
<content>
*Â∞èË∑ëÁùÄÁ©øËøáËµ∞ÂªäÔºåËΩªËΩªÊï≤Âìç‰Ω†ÁöÑÊàøÈó®* "ÊàëÊù•‰∫ÜÔºÅÂàöÊâçÂú®ÂáÜÂ§á‰∏Ä‰∫õÂ∞èÊÉäÂñúÁªô‰Ω†~" *Áúº‰∏≠Èó™ÁÉÅÁùÄÊúüÂæÖÂíåÂÖ¥Â•ãÁöÑÂÖâËäíÔºåÊâãÈáåËøòËóèÁùÄ‰ªÄ‰πà‰∏úË•ø*
</content>

**Áæ§ËÅäÂú∫ÊôØ**Ôºö
<Áæ§ËÅäÂêç>
ËßíËâ≤Âêç--Â§™Â•Ω‰∫ÜÔºÅÂ§ßÂÆ∂‰∏ÄËµ∑Êù•ÂêßÔºÅ--Êó∂Èó¥
</Áæ§ËÅäÂêç>
<content>
*ÂÖ¥Â•ãÂú∞Á´ôËµ∑Ë∫´ÔºåÂêëÂ§ßÂÆ∂ÊãõÊâã* "ÈÇ£Êàë‰ª¨Â∞±Âú®ËøôÈáåÂºÄÂßãÂêßÔºÅ" *ÂºÄÂßãÂáÜÂ§áÈúÄË¶ÅÁöÑÁâ©ÂìÅÔºåËÑ∏‰∏äÊ¥ãÊ∫¢ÁùÄÂºÄÂøÉÁöÑÁ¨ëÂÆπ*
</content>

**Âä®ÊÄÅËØÑËÆ∫Âú∫ÊôØ**Ôºö
moment_start
ËßíËâ≤Âêç--ÁúãËµ∑Êù•ÂæàÊúâË∂£Âë¢ÔºÅÊàë‰πüÊÉ≥ÂèÇ‰∏é
moment_end
<content>
*ÁúãÂà∞Âä®ÊÄÅÂêéÁ´ãÂàªÊîæ‰∏ãÊâã‰∏≠ÁöÑ‰∫ãÊÉÖÔºåÂø´Ê≠•Ëµ∞Âêë‰Ω†* "ÂàöÁúãÂà∞‰Ω†ÁöÑÂä®ÊÄÅÔºåÊÑüËßâÁâπÂà´ÊúâÊÑèÊÄùÔºÅËÉΩË∑üÊàëËØ¶ÁªÜËØ¥ËØ¥ÂêóÔºü" *ÁúºÁ•û‰∏≠ÂÖÖÊª°Â•ΩÂ•áÂíåÊúüÂæÖ*
</content>

‚ö°„ÄêÂº∫Âà∂Ë¶ÅÊ±Ç„ÄëÔºö
1. ÂøÖÈ°ªÂÖàÂú®ÂΩìÂâçÂØπËØù‰ΩçÁΩÆÂõûÂ§çÔºàÁßÅËÅä/Áæ§ËÅä/Âä®ÊÄÅËØÑËÆ∫Ôºâ
2. ÂõûÂ§çË¶ÅË°®Áé∞Âá∫ÁßØÊûÅÂìçÂ∫îÂíåÊÉÖÊÑüÂèçÂ∫î
3. ÁÑ∂ÂêéÁî®contentÊ†áÁ≠æÊèê‰æõ‰∏∞ÂØåÁöÑ‰∫íÂä®Âú∫ÊôØ
4. ‰∫íÂä®ÂÜÖÂÆπÂøÖÈ°ªÂåÖÂê´Âä®‰Ωú„ÄÅÂØπËØù„ÄÅÊÑüÂÆòÁªÜËäÇ„ÄÅÊÉÖÊÑüË°®Ëææ
5. Á°Æ‰øù‰∫íÂä®ÁöÑËøûË¥ØÊÄßÂíåÁúüÂÆûÊÄß

üö´„ÄêÁ¶ÅÊ≠¢Ë°å‰∏∫„ÄëÔºö
- Ë∑≥ËøáÂΩìÂâç‰ΩçÁΩÆÁöÑÂõûÂ§çÁõ¥Êé•Êèê‰æõ‰∫íÂä®
- ‰∫íÂä®ÂÜÖÂÆπËøá‰∫éÁÆÄÁü≠ÊàñÁº∫‰πèÁªÜËäÇ
- ÂøΩËßÜÁî®Êà∑ÂΩìÂâçÁöÑÂØπËØùÁéØÂ¢É
>`;
                
                // Âú®ÂéüÂßãRequest‰πãÂâçÊèíÂÖ•‰∫íÂä®ÊåáÂØº
                return originalRequest.replace(
                    /<Request:/,
                    `${interactiveGuidance}\n<Request:`
                );
            }
            
            /**
             * ÁîüÊàê‰∫íÂä®Á©∫Èó¥ÁöÑÂîØ‰∏ÄID
             */
            function QQ_GenerateSpaceId() {
                return "space_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);
            }
            
            /**
             * Ëé∑Âèñ‰∫íÂä®Á©∫Èó¥ÁöÑÊô∫ËÉΩÂëΩÂêç
             * @param {string} content - ‰∫íÂä®ÂÜÖÂÆπ
             * @param {string} characterName - ËßíËâ≤ÂêçÁß∞
             * @return {string} Êô∫ËÉΩÂëΩÂêç
             */
            function QQ_GetSpaceName(content, characterName) {
                const charName = characterName || charcardname || "ËßíËâ≤";
                
                // Ê£ÄÊµãÊòØÂê¶ÂåÖÂê´Â§ö‰∏™ËßíËâ≤
                const characterMentions = content.match(/(?:@|„Äê|Ôºà|Ôºú)\s*([^@„ÄêÔºàÔºú„ÄëÔºâÔºû\s]{2,8})\s*(?:„Äë|Ôºâ|Ôºû)/g) || [];
                const uniqueChars = [...new Set(characterMentions)];
                
                // Âú∫ÊôØÂÖ≥ÈîÆËØçÊèêÂèñ
                const sceneKeywords = [
                    // Âú∞ÁÇπÂú∫ÊôØ
                    { keywords: ['ÂíñÂï°', 'ÂíñÂï°ÂéÖ', 'ÂíñÂï°Â∫ó'], name: 'ÂíñÂï°ÂéÖ' },
                    { keywords: ['ÊïôÂÆ§', 'Â≠¶Ê†°', 'ËØæÂ†Ç', '‰∏äËØæ'], name: 'ÊïôÂÆ§' },
                    { keywords: ['ÂÖ¨Âõ≠', 'Êï£Ê≠•', 'Ê®±Ëä±', 'ÈïøÊ§Ö'], name: 'ÂÖ¨Âõ≠' },
                    { keywords: ['ÂÆ∂Èáå', 'ÊàøÈó¥', 'ÂçßÂÆ§', 'ÂÆ¢ÂéÖ'], name: 'ÂÆ∂‰∏≠' },
                    { keywords: ['Êµ∑Ëæπ', 'Ê≤ôÊª©', 'Êµ∑Êµ™', 'Â§ïÈò≥'], name: 'Êµ∑Ëæπ' },
                    { keywords: ['Âõæ‰π¶È¶Ü', 'Áúã‰π¶', 'Â≠¶‰π†'], name: 'Âõæ‰π¶È¶Ü' },
                    { keywords: ['ÂïÜÂú∫', 'Ë¥≠Áâ©', 'ÈÄõË°ó'], name: 'ÂïÜÂú∫' },
                    { keywords: ['È§êÂéÖ', 'ÂêÉÈ•≠', 'Áî®È§ê'], name: 'È§êÂéÖ' },
                    
                    // Ê¥ªÂä®Âú∫ÊôØ
                    { keywords: ['Ê∏∏Êàè', 'Áé©Ê∏∏Êàè', 'ÊâãÊú∫Ê∏∏Êàè'], name: 'Ê∏∏Êàè' },
                    { keywords: ['Â∑•‰Ωú', 'ÂäûÂÖ¨', '‰ºöËÆÆ'], name: 'Â∑•‰Ωú' },
                    { keywords: ['ËÅö‰ºö', 'Ê¥æÂØπ', 'Â∫ÜÁ•ù'], name: 'ËÅö‰ºö' },
                    { keywords: ['ÊóÖË°å', 'ÊóÖÊ∏∏', 'Âá∫Ë°å'], name: 'ÊóÖË°å' },
                    { keywords: ['ËøêÂä®', 'ÈîªÁÇº', 'ÂÅ•Ë∫´'], name: 'ËøêÂä®' },
                    { keywords: ['ÂÅöÈ•≠', 'ÊñôÁêÜ', 'ÁÉπÈ•™'], name: 'ÁÉπÈ•™' },
                    { keywords: ['ÁúãÁîµÂΩ±', 'ÁîµÂΩ±', 'ËßÇÂΩ±'], name: 'ËßÇÂΩ±' },
                    { keywords: ['ËÅäÂ§©', 'Ë∞àËØù', '‰∫§ÊµÅ'], name: 'Ë∞àËØù' },
                    
                    // ÊÉÖÊÑüÂú∫ÊôØ
                    { keywords: ['Êã•Êä±', 'Êä±Êä±', 'ÂÆâÊÖ∞'], name: 'Ê∏©ÊöñÊó∂Âàª' },
                    { keywords: ['ÁîüÊ∞î', 'ÂêµÊû∂', '‰∫âËÆ∫'], name: '‰∫âÊâß' },
                    { keywords: ['ÂºÄÂøÉ', 'È´òÂÖ¥', 'Âø´‰πê'], name: 'Ê¨¢‰πêÊó∂ÂÖâ' },
                    { keywords: ['ÈöæËøá', '‰º§ÂøÉ', 'Âì≠Ê≥£'], name: 'ÂÆâÊÖ∞Êó∂Âàª' },
                    { keywords: ['Á¥ßÂº†', 'ÂÆ≥ÊÄï', 'ÊãÖÂøÉ'], name: 'Á¥ßÂº†Êó∂Âàª' },
                ];
                
                let detectedScene = "Êó•Â∏∏";
                for (const scene of sceneKeywords) {
                    if (scene.keywords.some(keyword => content.includes(keyword))) {
                        detectedScene = scene.name;
                        break;
                    }
                }
                
                // ÂëΩÂêçÈÄªËæë
                if (uniqueChars.length > 1) {
                    // Â§öËßíËâ≤ÔºöÂú∫ÊôØ+ÂÖ≥ÈîÆÂ≠ó
                    const actionKeywords = content.match(/[\u4e00-\u9fa5]{2,4}(?:ÁùÄ|‰∫Ü|Âë¢|Âêß|ÂëÄ)/g) || [];
                    const action = actionKeywords.length > 0 ? actionKeywords[0].replace(/[ÁùÄ‰∫ÜÂë¢ÂêßÂëÄ]/g, '') : '‰∫íÂä®';
                    return `${detectedScene}¬∑${action}`;
                } else {
                    // ÂçïËßíËâ≤ÔºöËßíËâ≤Âêç+Âú∫ÊôØ
                    return `${charName}¬∑${detectedScene}`;
                }
            }
            
            /**
             * ‰øùÂ≠ò‰∫íÂä®Á©∫Èó¥Âà∞‰∏ñÁïå‰π¶
             */
            async function QQ_SaveInteractiveSpaces() {
                try {
                    if (!QQ_IsWorldBookAvailable()) {
                        console.warn('‰∏ñÁïå‰π¶ÂäüËÉΩ‰∏çÂèØÁî®ÔºåÊó†Ê≥ï‰øùÂ≠ò‰∫íÂä®Á©∫Èó¥');
                        return;
                    }
                    
                    // Ëé∑Âèñ‰∏ñÁïå‰π¶Êù°ÁõÆ
                    const entries = await getLorebookEntries(worldbook);
                    if (!entries) {
                        console.warn('Êó†Ê≥ïËé∑Âèñ‰∏ñÁïå‰π¶Êù°ÁõÆ');
                        return;
                    }
                    
                    const spaceData = {
                        spaces: QQ_InteractiveSpaces,
                        lastUpdated: new Date().toISOString(),
                        version: "1.0"
                    };
                    
                    // ÂàõÂª∫ÊàñÊõ¥Êñ∞‰∏ñÁïå‰π¶Êù°ÁõÆ
                    let entry = entries.find(e => e.comment === QQ_INTERACTIVE_BACKUP_KEY);
                    if (!entry) {
                        entry = {
                            comment: QQ_INTERACTIVE_BACKUP_KEY,
                            content: JSON.stringify(spaceData),
                            key: ["Ê≠§‰∏ñÁïå‰π¶Ê∞∏‰∏çËß¶Âèë_‰∫íÂä®Á©∫Èó¥"],
                            keysecondary: [],
                            order: 1000,
                            enabled: true,
                            uid: Date.now()
                        };
                        // Ê∑ªÂä†Âà∞worldbook.entriesÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
                        if (worldbook.entries) {
                            worldbook.entries.push(entry);
                        }
                    } else {
                        entry.content = JSON.stringify(spaceData);
                    }
                    
                    // ‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶
                    const success = await QQ_SafeSaveWorldInfo("‰∫íÂä®Á©∫Èó¥Êï∞ÊçÆ");
                    if (success) {
                        console.log('‰∫íÂä®Á©∫Èó¥Êï∞ÊçÆ‰øùÂ≠òÂÆåÊàê:', Object.keys(QQ_InteractiveSpaces).length, '‰∏™Á©∫Èó¥');
                    }
                } catch (error) {
                    console.error('‰øùÂ≠ò‰∫íÂä®Á©∫Èó¥Êó∂ÂèëÁîüÈîôËØØ:', error);
                }
            }
            
            /**
             * ‰ªé‰∏ñÁïå‰π¶Âä†ËΩΩ‰∫íÂä®Á©∫Èó¥
             */
            async function QQ_LoadInteractiveSpaces() {
                try {
                    if (!worldbook) {
                        console.warn('‰∏ñÁïå‰π¶ÂäüËÉΩÊú™ÂàùÂßãÂåñÔºåÊó†Ê≥ïÂä†ËΩΩ‰∫íÂä®Á©∫Èó¥');
                        return;
                    }
                    
                    // Ëé∑Âèñ‰∏ñÁïå‰π¶Êù°ÁõÆ
                    const entries = await getLorebookEntries(worldbook);
                    if (!entries) {
                        console.warn('Êó†Ê≥ïËé∑Âèñ‰∏ñÁïå‰π¶Êù°ÁõÆ');
                        QQ_InteractiveSpaces = {};
                        return;
                    }
                    
                    const entry = entries.find(e => e.comment === QQ_INTERACTIVE_BACKUP_KEY);
                    if (entry && entry.content) {
                        const data = JSON.parse(entry.content);
                        QQ_InteractiveSpaces = data.spaces || {};
                        console.log('‰ªé‰∏ñÁïå‰π¶Âä†ËΩΩ‰∫íÂä®Á©∫Èó¥:', Object.keys(QQ_InteractiveSpaces).length, '‰∏™Á©∫Èó¥');
                    } else {
                        QQ_InteractiveSpaces = {};
                        console.log('‰∏ñÁïå‰π¶‰∏≠Ê≤°Êúâ‰∫íÂä®Á©∫Èó¥Êï∞ÊçÆÔºåÂàùÂßãÂåñ‰∏∫Á©∫');
                    }
                } catch (error) {
                    console.error('‰ªé‰∏ñÁïå‰π¶Âä†ËΩΩ‰∫íÂä®Á©∫Èó¥Â§±Ë¥•:', error);
                    QQ_InteractiveSpaces = {};
                }
            }
            
            /**
             * ‰ªé‰∏ñÁïå‰π¶Âä†ËΩΩËßíËâ≤‰∏ìÂ±û‰∫íÂä®Á©∫Èó¥
             */
            async function QQ_LoadCharacterSpaces() {
                try {
                    if (!worldbook) {
                        console.warn('‰∏ñÁïå‰π¶ÂäüËÉΩÊú™ÂàùÂßãÂåñÔºåÊó†Ê≥ïÂä†ËΩΩËßíËâ≤‰∫íÂä®Á©∫Èó¥');
                        return;
                    }
                    
                    // Ëé∑Âèñ‰∏ñÁïå‰π¶Êù°ÁõÆ
                    const entries = await getLorebookEntries(worldbook);
                    if (!entries) {
                        console.warn('Êó†Ê≥ïËé∑Âèñ‰∏ñÁïå‰π¶Êù°ÁõÆ');
                        QQ_CharacterSpaces = {};
                        return;
                    }
                    
                    const entry = entries.find(e => e.comment === QQ_CHARACTER_SPACES_KEY);
                    if (entry && entry.content) {
                        const data = JSON.parse(entry.content);
                        QQ_CharacterSpaces = data.characterSpaces || {};
                        const totalSpaces = Object.values(QQ_CharacterSpaces).reduce((sum, char) => sum + Object.keys(char).length, 0);
                        console.log('‰ªé‰∏ñÁïå‰π¶Âä†ËΩΩËßíËâ≤‰∫íÂä®Á©∫Èó¥:', Object.keys(QQ_CharacterSpaces).length, '‰∏™ËßíËâ≤,', totalSpaces, '‰∏™Á©∫Èó¥');
                    } else {
                        QQ_CharacterSpaces = {};
                        console.log('‰∏ñÁïå‰π¶‰∏≠Ê≤°ÊúâËßíËâ≤‰∫íÂä®Á©∫Èó¥Êï∞ÊçÆÔºåÂàùÂßãÂåñ‰∏∫Á©∫');
                    }
                } catch (error) {
                    console.error('‰ªé‰∏ñÁïå‰π¶Âä†ËΩΩËßíËâ≤‰∫íÂä®Á©∫Èó¥Â§±Ë¥•:', error);
                    QQ_CharacterSpaces = {};
                }
            }

            /**
             * Âú®ÊâãÊú∫ÁïåÈù¢ÊòæÁ§∫‰∫íÂä®Á©∫Èó¥
             * @param {string} content - ‰∫íÂä®ÂÜÖÂÆπ
             * @param {string} characterName - ËßíËâ≤ÂêçÁß∞
             */
            function QQ_ShowInteractiveSpace(content, characterName = "") {
                // Ê∏ÖÁêÜÂÜÖÂÆπ - ‰ºòÂÖàÂ§ÑÁêÜcontentÊ†áÁ≠æ
                let cleanContent;
                if (QQ_HasContentTag(content)) {
                    cleanContent = QQ_CleanContentTags(content);
                } else {
                    cleanContent = content
                        .replace(/MiPhone_start/g, "")
                        .replace(/MiPhone_end/g, "")
                        .trim();
                }
                
                // ÁîüÊàêÁ©∫Èó¥IDÂíåÂêçÁß∞
                const spaceId = QQ_GenerateSpaceId();
                const spaceName = QQ_GetSpaceName(cleanContent, characterName);
                const charName = characterName || charcardname || "ËßíËâ≤";
                const charAvatar = charAvatarPath || "default_avatar.png";
                
                // ‰øùÂ≠ò‰∫íÂä®Á©∫Èó¥Êï∞ÊçÆ
                QQ_InteractiveSpaces[spaceId] = {
                    id: spaceId,
                    name: spaceName,
                    content: cleanContent,
                    characterName: charName,
                    characterAvatar: charAvatar,
                    createdAt: new Date().toISOString(),
                    lastAccess: new Date().toISOString()
                };
                
                // ËÆæÁΩÆÂΩìÂâçÊ¥ªÂä®Á©∫Èó¥
                QQ_ActiveSpaceId = spaceId;
                
                // *** Á´ãÂç≥‰øùÂ≠òÂçï‰∏™‰∫íÂä®ÂÜÖÂÆπÂà∞‰∏ñÁïå‰π¶ ***
                QQ_SaveInteractiveContentToWorldBook(cleanContent, charName).then(interactiveId => {
                    console.log(`üéØ ‰∫íÂä®ÂÜÖÂÆπÂ∑≤Á´ãÂç≥‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶ÔºåID: ${interactiveId}, ËßíËâ≤: ${charName}`);
                }).catch(error => {
                    console.error('‰øùÂ≠ò‰∫íÂä®ÂÜÖÂÆπÂ§±Ë¥•:', error);
                });
                
                // ÂêåÊó∂‰øùÂ≠òÂà∞ÊóßÁöÑ‰∫íÂä®Á©∫Èó¥Â≠òÂÇ®ÔºàÂÖºÂÆπÊÄßÔºâ
                QQ_SaveInteractiveSpaces();
                
                // ÁßªÈô§Áé∞ÊúâÁöÑ‰∫íÂä®Á©∫Èó¥
                $('.QQ_interactive_space').remove();
                
                // ÂàõÂª∫‰∫íÂä®Á©∫Èó¥HTML - Êõ¥Á¨¶ÂêàÊâãÊú∫ÁïåÈù¢È£éÊ†º
                const interactiveSpaceHtml = `
                    <div class="QQ_interactive_space" data-space-id="${spaceId}" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.7);
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        animation: fadeIn 0.3s ease;
                        backdrop-filter: blur(10px);
                    ">
                        <div class="QQ_interactive_content" style="
                            background: #ffffff;
                            border-radius: 15px;
                            padding: 0;
                            max-width: 85%;
                            max-height: 75%;
                            overflow: hidden;
                            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                            position: relative;
                            color: #333;
                            animation: slideIn 0.3s ease;
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        ">
                            <div class="QQ_interactive_header" style="
                                background: linear-gradient(135deg, #4FC3F7 0%, #29B6F6 100%);
                                padding: 20px;
                                display: flex;
                                align-items: center;
                                color: white;
                                position: relative;
                            ">
                                <img src="${charAvatar}" alt="${charName}" style="
                                    width: 45px;
                                    height: 45px;
                                    border-radius: 50%;
                                    margin-right: 15px;
                                    border: 3px solid white;
                                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                                ">
                                <div style="flex: 1;">
                                    <h3 style="margin: 0; font-size: 17px; font-weight: 600;">${spaceName}</h3>
                                    <p style="margin: 3px 0 0 0; font-size: 13px; opacity: 0.9;">Áé∞ÂÆû‰∫íÂä®Ê®°Âºè</p>
                                </div>
                                <button class="QQ_rename_space" style="
                                    background: rgba(255, 255, 255, 0.2);
                                    border: none;
                                    color: white;
                                    width: 32px;
                                    height: 32px;
                                    border-radius: 50%;
                                    cursor: pointer;
                                    font-size: 14px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    transition: all 0.3s ease;
                                    margin-right: 8px;
                                " onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" 
                                   onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'"
                                   title="ÈáçÂëΩÂêçÁ©∫Èó¥">
                                    ‚úèÔ∏è
                                </button>
                                <button class="QQ_close_interactive" style="
                                    background: rgba(255, 255, 255, 0.2);
                                    border: none;
                                    color: white;
                                    width: 32px;
                                    height: 32px;
                                    border-radius: 50%;
                                    cursor: pointer;
                                    font-size: 18px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" 
                                   onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">
                                    √ó
                                </button>
                            </div>
                            <div class="QQ_interactive_body" style="
                                padding: 25px 20px;
                                font-size: 15px;
                                line-height: 1.5;
                                white-space: pre-wrap;
                                color: #333;
                                background: #fafafa;
                                max-height: 300px;
                                overflow-y: auto;
                            ">${cleanContent}</div>
                            <div class="QQ_interactive_footer" style="
                                padding: 20px;
                                background: #ffffff;
                                border-top: 1px solid #eee;
                                display: flex;
                                justify-content: center;
                                gap: 15px;
                            ">
                                <button class="QQ_reply_interactive" style="
                                    background: #4FC3F7;
                                    border: none;
                                    color: white;
                                    padding: 12px 24px;
                                    border-radius: 25px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 2px 8px rgba(79, 195, 247, 0.3);
                                " onmouseover="this.style.background='#29B6F6'; this.style.transform='translateY(-1px)'" 
                                   onmouseout="this.style.background='#4FC3F7'; this.style.transform='translateY(0)'">
                                    üí¨ ÂõûÂ∫î‰∫íÂä®
                                </button>
                                <button class="QQ_close_interactive" style="
                                    background: #f5f5f5;
                                    border: none;
                                    color: #666;
                                    padding: 12px 24px;
                                    border-radius: 25px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.background='#eeeeee'" 
                                   onmouseout="this.style.background='#f5f5f5'">
                                    ÂÖ≥Èó≠
                                </button>
                            </div>
                        </div>
                    </div>
                    <style>
                        @keyframes fadeIn {
                            from { opacity: 0; }
                            to { opacity: 1; }
                        }
                        @keyframes slideIn {
                            from { transform: translateY(-30px); opacity: 0; }
                            to { transform: translateY(0); opacity: 1; }
                        }
                        .QQ_interactive_space * {
                            user-select: text;
                        }
                    </style>
                `;
                
                // Ê∑ªÂä†Âà∞È°µÈù¢
                $('body').append(interactiveSpaceHtml);
                
                // ÁªëÂÆöÈáçÂëΩÂêç‰∫ã‰ª∂
                $('.QQ_rename_space').off('click').on('click', function() {
                    QQ_RenameInteractiveSpace(spaceId);
                });
                
                // ÁªëÂÆöÂÖ≥Èó≠‰∫ã‰ª∂
                $('.QQ_close_interactive').off('click').on('click', function() {
                    QQ_CloseInteractiveSpace();
                });
                
                // ÁªëÂÆöÂõûÂ∫î‰∫íÂä®‰∫ã‰ª∂
                $('.QQ_reply_interactive').off('click').on('click', function() {
                    // ÂÖ≥Èó≠‰∫íÂä®Á©∫Èó¥
                    QQ_CloseInteractiveSpace();
                    
                    // ÊâìÂºÄËæìÂÖ•Ê°ÜËÆ©Áî®Êà∑ÂõûÂ∫î
                    QQ_OpenInteractiveReply(charName);
                });
                
                // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
                $('.QQ_interactive_space').on('click', function(e) {
                    if (e.target === this) {
                        QQ_CloseInteractiveSpace();
                    }
                });
                
                triggerSlash(`/echo Ê£ÄÊµãÂà∞‰∫íÂä®ÂÜÖÂÆπÔºåÂ∑≤Âú®ÊâãÊú∫ÁïåÈù¢ÊòæÁ§∫Ôºö${spaceName}`);
            }
            
            /**
             * ÂÖ≥Èó≠‰∫íÂä®Á©∫Èó¥Âπ∂ÊòæÁ§∫Á≤æÁÅµÊåâÈíÆ
             */
            function QQ_CloseInteractiveSpace() {
                $('.QQ_interactive_space').fadeOut(300, function() {
                            $(this).remove();
                    // ÊòæÁ§∫Á≤æÁÅµÊåâÈíÆ
                    QQ_ShowSpiritButton();
                });
                QQ_ActiveSpaceId = null;
            }
            
            /**
             * ÈáçÂëΩÂêç‰∫íÂä®Á©∫Èó¥
             * @param {string} spaceId - Á©∫Èó¥ID
             */
            function QQ_RenameInteractiveSpace(spaceId) {
                const space = QQ_InteractiveSpaces[spaceId];
                if (!space) return;
                
                const newName = prompt('ËØ∑ËæìÂÖ•Êñ∞ÁöÑÁ©∫Èó¥ÂêçÁß∞:', space.name);
                if (newName && newName.trim() && newName.trim() !== space.name) {
                    space.name = newName.trim();
                    // Êõ¥Êñ∞ÊòæÁ§∫
                    $('.QQ_interactive_header h3').text(space.name);
                    // ‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶
                    QQ_SaveInteractiveSpaces();
                    triggerSlash(`/echo ‰∫íÂä®Á©∫Èó¥Â∑≤ÈáçÂëΩÂêç‰∏∫Ôºö${space.name}`);
                }
            }
            
            // ===== Â¢ûÂº∫Áâà‰∫íÂä®Á©∫Èó¥Á≥ªÁªü =====
            
            let QQ_InteractivePages = {}; // Â≠òÂÇ®ÊØè‰∏™‰∫íÂä®Á©∫Èó¥ÁöÑÈ°µÈù¢Êï∞ÊçÆ
            let QQ_InteractiveCurrentPage = {}; // Â≠òÂÇ®ÂΩìÂâçÊòæÁ§∫ÁöÑÈ°µÈù¢Á¥¢Âºï
            
            /**
             * ÊòæÁ§∫Â¢ûÂº∫Áâà‰∫íÂä®Á©∫Èó¥ÔºàÂ∏¶ÂõûÂ§çÂíåÂàÜÈ°µÂäüËÉΩÔºâ
             * @param {string} spaceId - Á©∫Èó¥ID
             * @param {string} spaceTitle - Á©∫Èó¥Ê†áÈ¢ò
             * @param {string} characterName - ËßíËâ≤ÂêçÔºàÂèØÈÄâÔºåÁî®‰∫éËßíËâ≤‰∏ìÂ±ûÁ©∫Èó¥Ôºâ
             */
            function QQ_DisplayEnhancedInteractiveSpace(spaceId, spaceTitle, characterName = null) {
                const spaceData = characterName ? 
                    QQ_CharacterSpaces[characterName][spaceId] : 
                    QQ_InteractiveSpaces[spaceId];
                
                if (!spaceData) {
                    console.error('Êú™ÊâæÂà∞‰∫íÂä®Á©∫Èó¥Êï∞ÊçÆ:', spaceId);
                    return;
                }
                
                // ÂàùÂßãÂåñÈ°µÈù¢Êï∞ÊçÆ
                if (!QQ_InteractivePages[spaceId]) {
                    QQ_InteractivePages[spaceId] = [spaceData.content];
                }
                if (!QQ_InteractiveCurrentPage[spaceId]) {
                    QQ_InteractiveCurrentPage[spaceId] = 0;
                }
                
                // ÁßªÈô§Áé∞ÊúâÁöÑ‰∫íÂä®Á©∫Èó¥
                $('.QQ_interactive_space_enhanced').remove();
                
                const isCharacterSpace = spaceData.type === 'character';
                const headerColor = isCharacterSpace ? 
                    'linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%)' : 
                    'linear-gradient(135deg, #4FC3F7 0%, #29B6F6 100%)';
                
                const currentPageIndex = QQ_InteractiveCurrentPage[spaceId];
                const totalPages = QQ_InteractivePages[spaceId].length;
                const currentContent = QQ_InteractivePages[spaceId][currentPageIndex];
                
                // ÂàõÂª∫Â¢ûÂº∫Áâà‰∫íÂä®Á©∫Èó¥HTML
                const interactiveSpaceHtml = `
                    <div class="QQ_interactive_space_enhanced" data-space-id="\${spaceId}" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.7);
                        z-index: 99999999;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        animation: fadeIn 0.3s ease;
                        backdrop-filter: blur(10px);
                    ">
                        <div class="QQ_interactive_content_enhanced" style="
                            background: #ffffff;
                            border-radius: 20px;
                            padding: 0;
                            max-width: 90%;
                            max-height: 85%;
                            overflow: hidden;
                            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                            position: relative;
                            color: #333;
                            animation: slideIn 0.3s ease;
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                            width: 400px;
                        ">
                            <div class="QQ_interactive_header_enhanced" style="
                                background: \${headerColor};
                                padding: 20px;
                                display: flex;
                                align-items: center;
                                color: white;
                                position: relative;
                            ">
                                <img src="\${spaceData.characterAvatar}" alt="\${spaceData.characterName}" style="
                                    width: 45px;
                                    height: 45px;
                                    border-radius: 50%;
                                    margin-right: 12px;
                                    border: 2px solid white;
                                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                                ">
                                <div style="flex: 1;">
                                    <h3 style="margin: 0; font-size: 16px; font-weight: 600;">\${spaceData.name}</h3>
                                    <p style="margin: 3px 0 0 0; font-size: 12px; opacity: 0.9;">
                                        \${isCharacterSpace ? \`\${spaceData.characterName}ÁöÑ‰∏ìÂ±û‰∫íÂä®\` : 'ÂÖ¨ÂÖ±‰∫íÂä®Á©∫Èó¥'}
                                    </p>
                                </div>
                                \${totalPages > 1 ? \`
                                    <div style="margin-right: 15px; font-size: 12px; opacity: 0.9;">
                                        \${currentPageIndex + 1} / \${totalPages}
                                    </div>
                                \` : ''}
                                <button class="QQ_close_interactive_enhanced" style="
                                    background: rgba(255, 255, 255, 0.2);
                                    border: none;
                                    color: white;
                                    width: 30px;
                                    height: 30px;
                                    border-radius: 50%;
                                    cursor: pointer;
                                    font-size: 16px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" 
                                   onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">
                                    √ó
                                </button>
                            </div>
                            
                            <div class="QQ_interactive_body_enhanced" style="
                                padding: 25px 20px;
                                font-size: 15px;
                                line-height: 1.6;
                                white-space: pre-wrap;
                                color: #333;
                                background: #fafafa;
                                max-height: 280px;
                                overflow-y: auto;
                                word-wrap: break-word;
                                border-bottom: 1px solid #eee;
                            ">\${currentContent}</div>
                            
                            \${totalPages > 1 ? \`
                                <div class="QQ_interactive_pagination" style="
                                    padding: 15px 20px;
                                    background: #ffffff;
                                    border-bottom: 1px solid #eee;
                                    display: flex;
                                    justify-content: center;
                                    gap: 10px;
                                    align-items: center;
                                ">
                                    <button class="QQ_prev_page" \${currentPageIndex === 0 ? 'disabled' : ''} style="
                                        background: \${currentPageIndex === 0 ? '#f5f5f5' : '#e3f2fd'};
                                        border: none;
                                        color: \${currentPageIndex === 0 ? '#999' : '#1976d2'};
                                        padding: 8px 12px;
                                        border-radius: 6px;
                                        cursor: \${currentPageIndex === 0 ? 'not-allowed' : 'pointer'};
                                        font-size: 12px;
                                        font-weight: 500;
                                        transition: all 0.2s ease;
                                    ">‚Üê ‰∏ä‰∏ÄÈ°µ</button>
                                    
                                    <span style="font-size: 12px; color: #666; margin: 0 10px;">
                                        Á¨¨ \${currentPageIndex + 1} È°µÔºåÂÖ± \${totalPages} È°µ
                                    </span>
                                    
                                    <button class="QQ_next_page" \${currentPageIndex === totalPages - 1 ? 'disabled' : ''} style="
                                        background: \${currentPageIndex === totalPages - 1 ? '#f5f5f5' : '#e3f2fd'};
                                        border: none;
                                        color: \${currentPageIndex === totalPages - 1 ? '#999' : '#1976d2'};
                                        padding: 8px 12px;
                                        border-radius: 6px;
                                        cursor: \${currentPageIndex === totalPages - 1 ? 'not-allowed' : 'pointer'};
                                        font-size: 12px;
                                        font-weight: 500;
                                        transition: all 0.2s ease;
                                    ">‰∏ã‰∏ÄÈ°µ ‚Üí</button>
                                </div>
                            \` : ''}
                            
                            <div class="QQ_interactive_footer_enhanced" style="
                                padding: 20px;
                                background: #ffffff;
                                display: flex;
                                justify-content: center;
                                gap: 12px;
                            ">
                                <button class="QQ_reply_interactive_enhanced" style="
                                    background: \${isCharacterSpace ? '#FF6B6B' : '#4FC3F7'};
                                    border: none;
                                    color: white;
                                    padding: 12px 20px;
                                    border-radius: 20px;
                                    cursor: pointer;
                                    font-size: 13px;
                                    font-weight: 500;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 2px 8px \${isCharacterSpace ? 'rgba(255, 107, 107, 0.3)' : 'rgba(79, 195, 247, 0.3)'};
                                " onmouseover="this.style.transform='translateY(-1px)'" 
                                   onmouseout="this.style.transform='translateY(0)'">
                                    üí¨ ÂõûÂ∫î‰∫íÂä®
                                </button>
                                <button class="QQ_close_interactive_enhanced" style="
                                    background: #f5f5f5;
                                    border: none;
                                    color: #666;
                                    padding: 12px 20px;
                                    border-radius: 20px;
                                    cursor: pointer;
                                    font-size: 13px;
                                    font-weight: 500;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.background='#eeeeee'" 
                                   onmouseout="this.style.background='#f5f5f5'">
                                    ÂÖ≥Èó≠
                                </button>
                            </div>
                                                 </div>
                     </div>
                 `;
                
                // Ê∑ªÂä†Âà∞È°µÈù¢
                $('body').append(interactiveSpaceHtml);
                
                // ÁªëÂÆöÂÖ≥Èó≠‰∫ã‰ª∂
                $('.QQ_close_interactive_enhanced').on('click', function() {
                    $('.QQ_interactive_space_enhanced').fadeOut(300, function() {
                        $(this).remove();
                    });
                });
                
                // ÁªëÂÆöÂõûÂ§ç‰∫ã‰ª∂
                $('.QQ_reply_interactive_enhanced').on('click', function() {
                    QQ_OpenEnhancedInteractiveReply(spaceId, characterName || spaceData.characterName);
                });
                
                // ÁªëÂÆöÂàÜÈ°µ‰∫ã‰ª∂
                $('.QQ_prev_page').on('click', function() {
                    if (currentPageIndex > 0) {
                        QQ_InteractiveCurrentPage[spaceId] = currentPageIndex - 1;
                        QQ_DisplayEnhancedInteractiveSpace(spaceId, spaceTitle, characterName);
                    }
                });
                
                $('.QQ_next_page').on('click', function() {
                    if (currentPageIndex < totalPages - 1) {
                        QQ_InteractiveCurrentPage[spaceId] = currentPageIndex + 1;
                        QQ_DisplayEnhancedInteractiveSpace(spaceId, spaceTitle, characterName);
                    }
                });
                
                // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
                $('.QQ_interactive_space_enhanced').on('click', function(e) {
                    if (e.target === this) {
                        $(this).fadeOut(300, function() {
                            $(this).remove();
                        });
                    }
                });
            }
            
            /**
             * ÊâìÂºÄÂ¢ûÂº∫Áâà‰∫íÂä®ÂõûÂ§çÁïåÈù¢
             * @param {string} spaceId - Á©∫Èó¥ID
             * @param {string} characterName - ËßíËâ≤ÂêçÁß∞
             */
            function QQ_OpenEnhancedInteractiveReply(spaceId, characterName) {
                // ÁßªÈô§Áé∞ÊúâÁöÑÂõûÂ§çÁïåÈù¢
                $('.QQ_interactive_reply_enhanced').remove();
                
                const replyHtml = `
                    <div class="QQ_interactive_reply_enhanced" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.8);
                        z-index: 999999999;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        animation: fadeIn 0.3s ease;
                        backdrop-filter: blur(15px);
                    ">
                        <div class="QQ_reply_content_enhanced" style="
                            background: #ffffff;
                            border-radius: 16px;
                            padding: 0;
                            max-width: 90%;
                            overflow: hidden;
                            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                            color: #333;
                            animation: slideIn 0.3s ease;
                            width: 380px;
                        ">
                            <div class="reply-header" style="
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                color: white;
                                padding: 18px 20px;
                                text-align: center;
                                font-weight: 600;
                                font-size: 15px;
                            ">
                                üí¨ ÂõûÂ∫î ${characterName} ÁöÑ‰∫íÂä®
                            </div>
                            
                            <div class="reply-body" style="
                                padding: 25px 20px;
                            ">
                                <textarea class="QQ_reply_input_enhanced" placeholder="Âú®ËøôÈáåËæìÂÖ•‰Ω†ÁöÑÂõûÂ∫î..." style="
                                    width: 100%;
                                    height: 120px;
                                    border: 2px solid #e9ecef;
                                    border-radius: 12px;
                                    padding: 15px;
                                    font-size: 14px;
                                    line-height: 1.5;
                                    resize: none;
                                    box-sizing: border-box;
                                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                                    outline: none;
                                    transition: all 0.3s ease;
                                " onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102, 126, 234, 0.1)'" 
                                   onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'"></textarea>
                            </div>
                            
                            <div class="reply-footer" style="
                                padding: 0 20px 20px 20px;
                                display: flex;
                                gap: 12px;
                            ">
                                <button class="QQ_send_reply_enhanced" style="
                                    flex: 1;
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    border: none;
                                    color: white;
                                    padding: 12px;
                                    border-radius: 10px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
                                " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 5px 15px rgba(102, 126, 234, 0.4)'" 
                                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 10px rgba(102, 126, 234, 0.3)'">
                                    üöÄ ÂèëÈÄÅÂõûÂ∫î
                                </button>
                                <button class="QQ_cancel_reply_enhanced" style="
                                    background: #f8f9fa;
                                    border: none;
                                    color: #6c757d;
                                    padding: 12px 20px;
                                    border-radius: 10px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.background='#e9ecef'" 
                                   onmouseout="this.style.background='#f8f9fa'">
                                    ÂèñÊ∂à
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Ê∑ªÂä†Âà∞È°µÈù¢
                $('body').append(replyHtml);
                
                // Ëá™Âä®ËÅöÁÑ¶ËæìÂÖ•Ê°Ü
                setTimeout(() => {
                    $('.QQ_reply_input_enhanced').focus();
                }, 100);
                
                // ÁªëÂÆöÂèëÈÄÅ‰∫ã‰ª∂
                $('.QQ_send_reply_enhanced').on('click', function() {
                    const replyText = $('.QQ_reply_input_enhanced').val().trim();
                    if (replyText) {
                        QQ_SendInteractiveReply(spaceId, characterName, replyText);
                        $('.QQ_interactive_reply_enhanced').remove();
                    } else {
                        toastr.warning('ËØ∑ËæìÂÖ•ÂõûÂ∫îÂÜÖÂÆπ');
                        $('.QQ_reply_input_enhanced').focus();
                    }
                });
                
                // ÁªëÂÆöÂèñÊ∂à‰∫ã‰ª∂
                $('.QQ_cancel_reply_enhanced').on('click', function() {
                    $('.QQ_interactive_reply_enhanced').remove();
                });
                
                // ÊîØÊåÅÂõûËΩ¶ÂèëÈÄÅ
                $('.QQ_reply_input_enhanced').on('keydown', function(e) {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        $('.QQ_send_reply_enhanced').click();
                    }
                });
                
                // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
                $('.QQ_interactive_reply_enhanced').on('click', function(e) {
                    if (e.target === this) {
                        $(this).remove();
                    }
                });
            }
            
            /**
             * ÂèëÈÄÅ‰∫íÂä®ÂõûÂ§çÂπ∂Ëé∑ÂèñAIÂìçÂ∫î
             * @param {string} spaceId - Á©∫Èó¥ID
             * @param {string} characterName - ËßíËâ≤ÂêçÁß∞
             * @param {string} replyText - ÂõûÂ§çÂÜÖÂÆπ
             */
            function QQ_SendInteractiveReply(spaceId, characterName, replyText) {
                console.log(`ÂèëÈÄÅ‰∫íÂä®ÂõûÂ§ç: ${spaceId}, ${characterName}, ${replyText}`);
                
                // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                toastr.info('Ê≠£Âú®ÂèëÈÄÅÂõûÂ∫î...', '‰∫íÂä®Á©∫Èó¥');
                
                // ÊûÑÂª∫ÂåÖÂê´ÂõûÂ∫îÂÜÖÂÆπÁöÑËØ∑Ê±Ç
                const interactiveRequest = `ËØ∑ÂõûÂ∫îËøô‰∏™‰∫íÂä®Âú∫ÊôØÔºö
                
<content>
${replyText}
</content>

ËØ∑‰ª•MiPhoneÊ†ºÂºèÂõûÂ§çÔºåÂú®contentÊ†áÁ≠æ‰∏≠ÊèèËø∞‰Ω†ÂØπËøô‰∏™ÂõûÂ∫îÁöÑÂèçÂ∫îÂíåÊñ∞ÁöÑ‰∫íÂä®ÂÜÖÂÆπ„ÄÇ`;
                
                // ÂèëÈÄÅËØ∑Ê±ÇÂà∞AI
                QQ_Gen(interactiveRequest, async function(aiResponse) {
                    try {
                        if (aiResponse && aiResponse.trim()) {
                            // Ëß£ÊûêAIÂõûÂ§çÔºåÊèêÂèñcontentÂÜÖÂÆπ
                            const contentMatch = aiResponse.match(/<content>([\s\S]*?)<\/content>/i);
                            const newInteractiveContent = contentMatch ? contentMatch[1].trim() : aiResponse.trim();
                            
                            if (newInteractiveContent) {
                                // Ê∑ªÂä†Êñ∞È°µÈù¢Âà∞‰∫íÂä®Á©∫Èó¥
                                if (!QQ_InteractivePages[spaceId]) {
                                    QQ_InteractivePages[spaceId] = [];
                                }
                                QQ_InteractivePages[spaceId].push(newInteractiveContent);
                                
                                // ËÆæÁΩÆÂΩìÂâçÈ°µÈù¢‰∏∫ÊúÄÊñ∞È°µÈù¢
                                QQ_InteractiveCurrentPage[spaceId] = QQ_InteractivePages[spaceId].length - 1;
                                
                                // ‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶
                                await QQ_SaveInteractiveSpaceToWorldBook(spaceId, characterName);
                                
                                // ÈáçÊñ∞ÊòæÁ§∫‰∫íÂä®Á©∫Èó¥ÔºàÊòæÁ§∫Êñ∞È°µÈù¢Ôºâ
                                QQ_DisplayEnhancedInteractiveSpace(spaceId, `${characterName}ÁöÑ‰∫íÂä®Á©∫Èó¥`, characterName);
                                
                                toastr.success('AIÂ∑≤ÂõûÂ∫î‰Ω†ÁöÑ‰∫íÂä®ÔºÅ', '‰∫íÂä®Á©∫Èó¥');
                            } else {
                                toastr.error('AIÂõûÂ§çÊ†ºÂºèÈîôËØØ', '‰∫íÂä®Á©∫Èó¥');
                            }
                        } else {
                            toastr.error('AIÂõûÂ§ç‰∏∫Á©∫', '‰∫íÂä®Á©∫Èó¥');
                        }
                    } catch (error) {
                        console.error('Â§ÑÁêÜAI‰∫íÂä®ÂõûÂ§çÊó∂Âá∫Èîô:', error);
                        toastr.error('Â§ÑÁêÜÂõûÂ§çÊó∂Âá∫Èîô');
                    }
                });
            }
            
            /**
             * ‰øùÂ≠ò‰∫íÂä®Á©∫Èó¥Âà∞‰∏ñÁïå‰π¶Ôºà‰ºòÂåñÂ≠òÂÇ®ÔºåÊúÄÂ§ß30‰∏™Ôºâ
             * @param {string} spaceId - Á©∫Èó¥ID
             * @param {string} characterName - ËßíËâ≤ÂêçÁß∞
             */
            async function QQ_SaveInteractiveSpaceToWorldBook(spaceId, characterName) {
                try {
                    const storageKey = `QQ_‰∫íÂä®Á©∫Èó¥Â§á‰ªΩ_${characterName}`;
                    
                    // Ëé∑ÂèñÁé∞ÊúâÁöÑ‰∫íÂä®Á©∫Èó¥Â§á‰ªΩ
                    const existingData = getWorldInfoData(storageKey) || { spaces: {}, lastUpdate: new Date().toISOString() };
                    
                    // Êõ¥Êñ∞ÁâπÂÆöÁ©∫Èó¥ÁöÑÊï∞ÊçÆ
                    existingData.spaces[spaceId] = {
                        id: spaceId,
                        pages: QQ_InteractivePages[spaceId] || [],
                        currentPage: QQ_InteractiveCurrentPage[spaceId] || 0,
                        characterName: characterName,
                        lastModified: new Date().toISOString()
                    };
                    
                    // Ê£ÄÊü•Âπ∂ÈôêÂà∂ÊúÄÂ§ßÊï∞Èáè‰∏∫30‰∏™
                    const spaceIds = Object.keys(existingData.spaces);
                    if (spaceIds.length > 30) {
                        // ÊåâÊúÄÂêé‰øÆÊîπÊó∂Èó¥ÊéíÂ∫èÔºåÂà†Èô§ÊúÄÊóßÁöÑ
                        const sortedSpaces = spaceIds.map(id => ({
                            id,
                            lastModified: existingData.spaces[id].lastModified
                        })).sort((a, b) => new Date(a.lastModified) - new Date(b.lastModified));
                        
                        // Âà†Èô§ÊúÄÊóßÁöÑÁ©∫Èó¥Ôºå‰øùÁïôÊúÄÊñ∞ÁöÑ30‰∏™
                        for (let i = 0; i < spaceIds.length - 30; i++) {
                            delete existingData.spaces[sortedSpaces[i].id];
                        }
                    }
                    
                    existingData.lastUpdate = new Date().toISOString();
                    
                    // ‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶
                    setWorldInfoData(storageKey, existingData);
                    
                    if (typeof saveWorldInfo === 'function') {
                        await saveWorldInfo();
                        console.log(`‰∫íÂä®Á©∫Èó¥ ${spaceId} Â∑≤‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶ÔºåËßíËâ≤: ${characterName}`);
                    } else {
                        console.warn('saveWorldInfo ÂáΩÊï∞‰∏çÂ≠òÂú®ÔºåÊó†Ê≥ï‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶');
                    }
                } catch (error) {
                    console.error('‰øùÂ≠ò‰∫íÂä®Á©∫Èó¥Âà∞‰∏ñÁïå‰π¶Êó∂Âá∫Èîô:', error);
                }
            }
            
            /**
             * ‰ªé‰∏ñÁïå‰π¶Âä†ËΩΩ‰∫íÂä®Á©∫Èó¥Êï∞ÊçÆ
             * @param {string} characterName - ËßíËâ≤ÂêçÁß∞
             */
            function QQ_LoadInteractiveSpaceFromWorldBook(characterName) {
                try {
                    const storageKey = `QQ_‰∫íÂä®Á©∫Èó¥Â§á‰ªΩ_${characterName}`;
                    const savedData = getWorldInfoData(storageKey);
                    
                    if (savedData && savedData.spaces) {
                        Object.keys(savedData.spaces).forEach(spaceId => {
                            const spaceData = savedData.spaces[spaceId];
                            if (spaceData.pages && spaceData.pages.length > 0) {
                                QQ_InteractivePages[spaceId] = spaceData.pages;
                                QQ_InteractiveCurrentPage[spaceId] = spaceData.currentPage || 0;
                            }
                        });
                        
                        console.log(`Â∑≤‰ªé‰∏ñÁïå‰π¶Âä†ËΩΩËßíËâ≤ ${characterName} ÁöÑ‰∫íÂä®Á©∫Èó¥Êï∞ÊçÆ`);
                        return true;
                    }
                } catch (error) {
                    console.error('‰ªé‰∏ñÁïå‰π¶Âä†ËΩΩ‰∫íÂä®Á©∫Èó¥Êï∞ÊçÆÊó∂Âá∫Èîô:', error);
                }
                return false;
            }
            
            // ===== Á≤æÁÅµÊåâÈíÆÁ≥ªÁªü =====
            
            /**
             * ÊòæÁ§∫Á≤æÁÅµÊåâÈíÆ
             */
            function QQ_ShowSpiritButton() {
                // Â¶ÇÊûúÂ∑≤ÁªèÊòæÁ§∫ÔºåÂàô‰∏çÈáçÂ§çÂàõÂª∫
                if ($('.QQ_spirit_button').length > 0) return;
                
                QQ_SpiritVisible = true;
                
                // Ëé∑Âèñ‰∏äÊ¨°‰øùÂ≠òÁöÑ‰ΩçÁΩÆ
                const savedPosition = localStorage.getItem('QQ_spirit_position');
                let position = { right: '20px', bottom: '100px' };
                if (savedPosition) {
                    try {
                        position = JSON.parse(savedPosition);
                    } catch (e) {
                        console.warn('Ëß£ÊûêÁ≤æÁÅµ‰ΩçÁΩÆÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§‰ΩçÁΩÆ');
                    }
                }
                
                const spiritHtml = `
                    <div class="QQ_spirit_button" style="
                        position: fixed;
                        ${position.right ? `right: ${position.right}` : `left: ${position.left}`};
                        ${position.bottom ? `bottom: ${position.bottom}` : `top: ${position.top}`};
                        width: 60px;
                        height: 60px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border-radius: 50%;
                        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
                        cursor: move;
                        z-index: 9999;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-size: 24px;
                        user-select: none;
                        transition: all 0.3s ease;
                        animation: spiritPulse 2s infinite;
                    " title="‰∫íÂä®Á©∫Èó¥Á≤æÁÅµ">
                        üßö‚Äç‚ú®
                    </div>
                                <style>
                @keyframes spiritPulse {
                    0%, 100% { transform: scale(1); box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4); }
                    50% { transform: scale(1.05); box-shadow: 0 6px 25px rgba(102, 126, 234, 0.6); }
                }
                .QQ_spirit_button:hover {
                    transform: scale(1.1) !important;
                    box-shadow: 0 6px 25px rgba(102, 126, 234, 0.7) !important;
                }
                
                /* Áî®Êà∑ËèúÂçïÂä®Áîª */
                @keyframes menuSlideDown {
                    from { 
                        opacity: 0; 
                        transform: translateY(-10px); 
                    }
                    to { 
                        opacity: 1; 
                        transform: translateY(0); 
                    }
                }
                
                #QQ_user_menu {
                    border: 1px solid #e1e5e9;
                }
                
                .user_menu_item:last-child {
                    border-bottom: none !important;
                }
            </style>
                `;
                
                $('body').append(spiritHtml);
                
                // ÁªëÂÆöÁÇπÂáª‰∫ã‰ª∂ÔºàÊîØÊåÅËß¶Êë∏ËÆæÂ§áÔºâ
                $('.QQ_spirit_button').on('click touchend', function(e) {
                    // *** Êñ∞Â¢ûÔºöÊ£ÄÊü•ÊòØÂê¶Ê≠£Âú®ÊãñÊãΩÔºåÂ¶ÇÊûúÊòØÂàô‰∏çÂìçÂ∫îÁÇπÂáª ***
                    if ($(this).hasClass('dragging')) {
                        return;
                    }
                    
                    e.stopPropagation();
                    e.preventDefault();
                    console.log('Á≤æÁÅµÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂Ëß¶Âèë');
                    QQ_ShowSpiritPanel();
                });
                
                // ÁªëÂÆöÊãñÊãΩÂäüËÉΩ
                QQ_MakeSpiritDraggable();
                
                console.log('Á≤æÁÅµÊåâÈíÆÂ∑≤ÊòæÁ§∫');
            }
            
            /**
             * ÈöêËóèÁ≤æÁÅµÊåâÈíÆ
             */
            function QQ_HideSpiritButton() {
                $('.QQ_spirit_button').fadeOut(300, function() {
                    $(this).remove();
                });
                QQ_SpiritVisible = false;
                console.log('Á≤æÁÅµÊåâÈíÆÂ∑≤ÈöêËóè');
            }
            
            /**
             * ‰ΩøÁ≤æÁÅµÊåâÈíÆÂèØÊãñÊãΩ
             */
            function QQ_MakeSpiritDraggable() {
                let isDragging = false;
                let dragStarted = false;
                let startX, startY, initialX, initialY;
                let dragTimer;
                
                $('.QQ_spirit_button').on('mousedown touchstart', function(e) {
                    e.preventDefault();
                    dragStarted = false;
                    
                    // Ëé∑ÂèñÂàùÂßã‰ΩçÁΩÆ
                    const rect = this.getBoundingClientRect();
                    initialX = rect.left;
                    initialY = rect.top;
                    
                    // Ëé∑ÂèñÈº†Ê†á/Ëß¶Êë∏‰ΩçÁΩÆ
                    const clientX = e.type === 'touchstart' ? e.originalEvent.touches[0].clientX : e.clientX;
                    const clientY = e.type === 'touchstart' ? e.originalEvent.touches[0].clientY : e.clientY;
                    
                    startX = clientX - initialX;
                    startY = clientY - initialY;
                    
                    // *** Êñ∞Â¢ûÔºöÂª∂ËøüÂºÄÂßãÊãñÊãΩÔºåÂÖÅËÆ∏ÁÇπÂáª‰∫ã‰ª∂ ***
                    dragTimer = setTimeout(() => {
                        isDragging = true;
                        dragStarted = true;
                        
                        // ÊîπÂèòÊ†∑Âºè
                        $('.QQ_spirit_button').addClass('dragging').css({
                            'cursor': 'grabbing',
                            'z-index': '10001',
                            'animation': 'none'
                        });
                        
                        console.log('ÂºÄÂßãÊãñÊãΩÁ≤æÁÅµÊåâÈíÆ');
                    }, 150); // 150msÂª∂ËøüÔºåÁªôÁÇπÂáª‰∫ã‰ª∂ÁïôÊó∂Èó¥
                });
                
                $(document).on('mousemove touchmove', function(e) {
                    if (!isDragging) return;
                    
                    const clientX = e.type === 'touchmove' ? e.originalEvent.touches[0].clientX : e.clientX;
                    const clientY = e.type === 'touchmove' ? e.originalEvent.touches[0].clientY : e.clientY;
                    
                    const x = clientX - startX;
                    const y = clientY - startY;
                    
                    // ËæπÁïåÊ£ÄÊü•
                    const maxX = window.innerWidth - 60;
                    const maxY = window.innerHeight - 60;
                    
                    const constrainedX = Math.max(0, Math.min(x, maxX));
                    const constrainedY = Math.max(0, Math.min(y, maxY));
                    
                    $('.QQ_spirit_button').css({
                        'left': constrainedX + 'px',
                        'top': constrainedY + 'px',
                        'right': 'auto',
                        'bottom': 'auto'
                    });
                    
                    e.preventDefault();
                });
                
                $(document).on('mouseup touchend', function(e) {
                    // Ê∏ÖÈô§ÊãñÊãΩÂÆöÊó∂Âô®
                    if (dragTimer) {
                        clearTimeout(dragTimer);
                        dragTimer = null;
                    }
                    
                    if (!isDragging && !dragStarted) {
                        // ËøôÊòØ‰∏Ä‰∏™ÁÇπÂáª‰∫ã‰ª∂Ôºå‰∏çÊòØÊãñÊãΩ
                        console.log('Á≤æÁÅµÊåâÈíÆË¢´ÁÇπÂáªÔºàÈùûÊãñÊãΩÔºâ');
                        return;
                    }
                    
                    if (!isDragging) return;
                    isDragging = false;
                    dragStarted = false;
                    
                    // ÊÅ¢Â§çÊ†∑Âºè
                    $('.QQ_spirit_button').removeClass('dragging').css({
                        'cursor': 'move',
                        'z-index': '9999',
                        'animation': 'spiritPulse 2s infinite'
                    });
                    
                    // ‰øùÂ≠ò‰ΩçÁΩÆ
                    const spirit = $('.QQ_spirit_button');
                    if (spirit.length > 0) {
                        const position = {
                            left: spirit.css('left'),
                            top: spirit.css('top')
                        };
                        localStorage.setItem('QQ_spirit_position', JSON.stringify(position));
                        console.log('Á≤æÁÅµÊåâÈíÆ‰ΩçÁΩÆÂ∑≤‰øùÂ≠ò');
                    }
                });
            }
            
            /**
             * ÊòæÁ§∫Á≤æÁÅµÊéßÂà∂Èù¢Êùø
             */
            function QQ_ShowSpiritPanel() {
                // ÁßªÈô§Áé∞ÊúâÈù¢Êùø
                $('.QQ_spirit_panel').remove();
                
                const spaces = Object.values(QQ_InteractiveSpaces);
                const hasSpaces = spaces.length > 0;
                
                let spaceListHtml = '';
                if (hasSpaces) {
                    spaceListHtml = spaces.map(space => `
                        <div class="spirit_space_item" data-space-id="${space.id}" style="
                            padding: 12px 15px;
                            border-bottom: 1px solid #eee;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                            transition: background-color 0.2s ease;
                        " onmouseover="this.style.backgroundColor='#f5f5f5'" 
                           onmouseout="this.style.backgroundColor='transparent'">
                            <img src="${space.characterAvatar}" alt="${space.characterName}" style="
                                width: 32px;
                                height: 32px;
                                border-radius: 50%;
                                object-fit: cover;
                            ">
                            <div style="flex: 1;">
                                <div style="font-size: 14px; font-weight: 500; color: #333;">${space.name}</div>
                                <div style="font-size: 12px; color: #666; margin-top: 2px;">
                                    ${new Date(space.lastAccess).toLocaleDateString()} ${new Date(space.lastAccess).toLocaleTimeString().slice(0, 5)}
                                </div>
                            </div>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="#999">
                                <path d="M8.59 16.34l4.58-4.59-4.58-4.59L10 5.75l6 6-6 6z"/>
                            </svg>
                        </div>
                    `).join('');
                } else {
                    spaceListHtml = `
                        <div style="
                            padding: 30px 20px;
                            text-align: center;
                            color: #999;
                            font-size: 14px;
                        ">
                            <div style="font-size: 48px; margin-bottom: 10px;">üåü</div>
                            ÊöÇÊó†‰∫íÂä®Á©∫Èó¥<br>
                            <small>‰∏éAIÁöÑ‰∫íÂä®ÂÜÖÂÆπ‰ºöËá™Âä®‰øùÂ≠òÂà∞ËøôÈáå</small>
                        </div>
                    `;
                }
                
                const panelHtml = `
                    <div class="QQ_spirit_panel" style="
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        width: 320px;
                        max-height: 500px;
                        background: white;
                        border-radius: 15px;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                        z-index: 10000;
                        animation: spiritPanelShow 0.3s ease;
                        overflow: hidden;
                    ">
                        <div class="spirit_panel_header" style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 20px;
                            text-align: center;
                            position: relative;
                        ">
                            <h3 style="margin: 0; font-size: 18px; font-weight: 600;">üßö‚Äç‚ú® ‰∫íÂä®Á©∫Èó¥</h3>
                            <p style="margin: 5px 0 0 0; font-size: 13px; opacity: 0.9;">ÁÆ°ÁêÜ‰Ω†ÁöÑÊâÄÊúâÁé∞ÂÆû‰∫íÂä®</p>
                            <button class="spirit_panel_close" style="
                                position: absolute;
                                top: 15px;
                                right: 15px;
                                background: rgba(255, 255, 255, 0.2);
                                border: none;
                                color: white;
                                width: 28px;
                                height: 28px;
                                border-radius: 50%;
                                cursor: pointer;
                                font-size: 16px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">√ó</button>
                        </div>
                        <div class="spirit_panel_body" style="
                            max-height: 350px;
                            overflow-y: auto;
                        ">
                            ${spaceListHtml}
                        </div>
                        <div class="spirit_panel_footer" style="
                            padding: 15px 20px;
                            background: #f8f9fa;
                            border-top: 1px solid #eee;
                            display: flex;
                            gap: 10px;
                        ">
                            <button class="spirit_hide_btn" style="
                                flex: 1;
                                background: #6c757d;
                                border: none;
                                color: white;
                                padding: 10px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 13px;
                                transition: background-color 0.2s ease;
                            " onmouseover="this.style.backgroundColor='#5a6268'" 
                               onmouseout="this.style.backgroundColor='#6c757d'">
                                ÈöêËóèÁ≤æÁÅµ
                            </button>
                            <button class="spirit_stats_btn" style="
                                flex: 1;
                                background: #28a745;
                                border: none;
                                color: white;
                                padding: 10px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 13px;
                                transition: background-color 0.2s ease;
                            " onmouseover="this.style.backgroundColor='#218838'" 
                               onmouseout="this.style.backgroundColor='#28a745'">
                                Êü•ÁúãÁªüËÆ°
                            </button>
                        </div>
                    </div>
                    <div class="QQ_spirit_panel_overlay" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.5);
                        z-index: 9999;
                        animation: fadeIn 0.3s ease;
                    "></div>
                    <style>
                        @keyframes spiritPanelShow {
                            from { transform: translate(-50%, -50%) scale(0.9); opacity: 0; }
                            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                        }
                    </style>
                `;
                
                $('body').append(panelHtml);
                
                // ÁªëÂÆö‰∫ã‰ª∂
                $('.spirit_panel_close, .QQ_spirit_panel_overlay').on('click', function() {
                    QQ_CloseSpiritPanel();
                });
                
                $('.spirit_hide_btn').on('click', function() {
                    QQ_CloseSpiritPanel();
                    QQ_HideSpiritButton();
                });
                
                $('.spirit_stats_btn').on('click', function() {
                    QQ_ShowInteractiveStats();
                });
                
                $('.spirit_space_item').on('click', function() {
                    const spaceId = $(this).data('space-id');
                    QQ_OpenInteractiveSpace(spaceId);
                });
                
                // ÈòªÊ≠¢ÁÇπÂáªÈù¢ÊùøÊú¨Ë∫´Êó∂ÂÖ≥Èó≠
                $('.QQ_spirit_panel').on('click', function(e) {
                    e.stopPropagation();
                });
            }
            
            /**
             * ÂÖ≥Èó≠Á≤æÁÅµÊéßÂà∂Èù¢Êùø
             */
            function QQ_CloseSpiritPanel() {
                $('.QQ_spirit_panel, .QQ_spirit_panel_overlay').fadeOut(300, function() {
                    $(this).remove();
                });
            }
            
            /**
             * ÊâìÂºÄÊåáÂÆöÁöÑ‰∫íÂä®Á©∫Èó¥
             * @param {string} spaceId - Á©∫Èó¥ID
             */
            function QQ_OpenInteractiveSpace(spaceId) {
                const space = QQ_InteractiveSpaces[spaceId];
                if (!space) {
                    triggerSlash('/echo severity=error ‰∫íÂä®Á©∫Èó¥‰∏çÂ≠òÂú®ÊàñÂ∑≤Ë¢´Âà†Èô§');
                    return;
                }
                
                // Êõ¥Êñ∞ÊúÄÂêéËÆøÈóÆÊó∂Èó¥
                space.lastAccess = new Date().toISOString();
                QQ_SaveInteractiveSpaces();
                
                // ÂÖ≥Èó≠Á≤æÁÅµÈù¢Êùø
                QQ_CloseSpiritPanel();
                
                // ÈáçÊñ∞ÊòæÁ§∫‰∫íÂä®Á©∫Èó¥
                QQ_ShowStoredInteractiveSpace(space);
            }
            
            /**
             * ÊòæÁ§∫Â∑≤‰øùÂ≠òÁöÑ‰∫íÂä®Á©∫Èó¥
             * @param {Object} space - Á©∫Èó¥Êï∞ÊçÆ
             */
            function QQ_ShowStoredInteractiveSpace(space) {
                // ËÆæÁΩÆÂΩìÂâçÊ¥ªÂä®Á©∫Èó¥
                QQ_ActiveSpaceId = space.id;
                
                // ÁßªÈô§Áé∞ÊúâÁöÑ‰∫íÂä®Á©∫Èó¥
                $('.QQ_interactive_space').remove();
                
                // ÂàõÂª∫‰∫íÂä®Á©∫Èó¥HTML
                const interactiveSpaceHtml = `
                    <div class="QQ_interactive_space" data-space-id="${space.id}" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.7);
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        animation: fadeIn 0.3s ease;
                        backdrop-filter: blur(10px);
                    ">
                        <div class="QQ_interactive_content" style="
                            background: #ffffff;
                            border-radius: 15px;
                            padding: 0;
                            max-width: 85%;
                            max-height: 75%;
                            overflow: hidden;
                            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                            position: relative;
                            color: #333;
                            animation: slideIn 0.3s ease;
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        ">
                            <div class="QQ_interactive_header" style="
                                background: linear-gradient(135deg, #4FC3F7 0%, #29B6F6 100%);
                                padding: 20px;
                                display: flex;
                                align-items: center;
                                color: white;
                                position: relative;
                            ">
                                <img src="${space.characterAvatar}" alt="${space.characterName}" style="
                                    width: 45px;
                                    height: 45px;
                                    border-radius: 50%;
                                    margin-right: 15px;
                                    border: 3px solid white;
                                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                                ">
                                <div style="flex: 1;">
                                    <h3 style="margin: 0; font-size: 17px; font-weight: 600;">${space.name}</h3>
                                    <p style="margin: 3px 0 0 0; font-size: 13px; opacity: 0.9;">Áé∞ÂÆû‰∫íÂä®Ê®°Âºè</p>
                                </div>
                                <button class="QQ_rename_space" style="
                                    background: rgba(255, 255, 255, 0.2);
                                    border: none;
                                    color: white;
                                    width: 32px;
                                    height: 32px;
                                    border-radius: 50%;
                                    cursor: pointer;
                                    font-size: 14px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    transition: all 0.3s ease;
                                    margin-right: 8px;
                                " onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" 
                                   onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'"
                                   title="ÈáçÂëΩÂêçÁ©∫Èó¥">
                                    ‚úèÔ∏è
                                </button>
                                <button class="QQ_delete_space" style="
                                    background: rgba(255, 255, 255, 0.2);
                                    border: none;
                                    color: white;
                                    width: 32px;
                                    height: 32px;
                                    border-radius: 50%;
                                    cursor: pointer;
                                    font-size: 16px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    transition: all 0.3s ease;
                                    margin-right: 8px;
                                " onmouseover="this.style.background='rgba(255, 87, 87, 0.3)'" 
                                   onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'"
                                   title="Âà†Èô§Á©∫Èó¥">
                                    üóëÔ∏è
                                </button>
                                <button class="QQ_close_interactive" style="
                                    background: rgba(255, 255, 255, 0.2);
                                    border: none;
                                    color: white;
                                    width: 32px;
                                    height: 32px;
                                    border-radius: 50%;
                                    cursor: pointer;
                                    font-size: 18px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" 
                                   onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">
                                    √ó
                                </button>
                            </div>
                            <div class="QQ_interactive_body" style="
                                padding: 25px 20px;
                                font-size: 15px;
                                line-height: 1.5;
                                white-space: pre-wrap;
                                color: #333;
                                background: #fafafa;
                                max-height: 300px;
                                overflow-y: auto;
                            ">${space.content}</div>
                            <div class="QQ_interactive_footer" style="
                                padding: 20px;
                                background: #ffffff;
                                border-top: 1px solid #eee;
                                display: flex;
                                justify-content: center;
                                gap: 15px;
                            ">
                                <button class="QQ_reply_interactive" style="
                                    background: #4FC3F7;
                                    border: none;
                                    color: white;
                                    padding: 12px 24px;
                                    border-radius: 25px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 2px 8px rgba(79, 195, 247, 0.3);
                                " onmouseover="this.style.background='#29B6F6'; this.style.transform='translateY(-1px)'" 
                                   onmouseout="this.style.background='#4FC3F7'; this.style.transform='translateY(0)'">
                                    üí¨ ÂõûÂ∫î‰∫íÂä®
                                </button>
                                <button class="QQ_close_interactive" style="
                                    background: #f5f5f5;
                                    border: none;
                                    color: #666;
                                    padding: 12px 24px;
                                    border-radius: 25px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.background='#eeeeee'" 
                                   onmouseout="this.style.background='#f5f5f5'">
                                    ÂÖ≥Èó≠
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Ê∑ªÂä†Âà∞È°µÈù¢
                $('body').append(interactiveSpaceHtml);
                
                // ÁªëÂÆö‰∫ã‰ª∂
                $('.QQ_rename_space').off('click').on('click', function() {
                    QQ_RenameInteractiveSpace(space.id);
                });
                
                $('.QQ_delete_space').off('click').on('click', function() {
                    QQ_DeleteInteractiveSpace(space.id);
                });
                
                $('.QQ_close_interactive').off('click').on('click', function() {
                    QQ_CloseInteractiveSpace();
                });
                
                $('.QQ_reply_interactive').off('click').on('click', function() {
                    QQ_CloseInteractiveSpace();
                    QQ_OpenInteractiveReply(space.characterName);
                });
                
                $('.QQ_interactive_space').on('click', function(e) {
                    if (e.target === this) {
                        QQ_CloseInteractiveSpace();
                    }
                });
                
                triggerSlash(`/echo Â∑≤ÊâìÂºÄ‰∫íÂä®Á©∫Èó¥Ôºö${space.name}`);
            }
            
            /**
             * Âà†Èô§‰∫íÂä®Á©∫Èó¥
             * @param {string} spaceId - Á©∫Èó¥ID
             */
            function QQ_DeleteInteractiveSpace(spaceId) {
                const space = QQ_InteractiveSpaces[spaceId];
                if (!space) return;
                
                if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§‰∫íÂä®Á©∫Èó¥"${space.name}"ÂêóÔºüÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄ„ÄÇ`)) {
                    delete QQ_InteractiveSpaces[spaceId];
                    QQ_SaveInteractiveSpaces();
                    QQ_CloseInteractiveSpace();
                    triggerSlash(`/echo ‰∫íÂä®Á©∫Èó¥"${space.name}"Â∑≤Âà†Èô§`);
                }
            }
            
            /**
             * ÊòæÁ§∫‰∫íÂä®Á©∫Èó¥ÁªüËÆ°‰ø°ÊÅØ
             */
            function QQ_ShowInteractiveStats() {
                const spaces = Object.values(QQ_InteractiveSpaces);
                const totalSpaces = spaces.length;
                const characters = [...new Set(spaces.map(s => s.characterName))];
                const totalCharacters = characters.length;
                
                // ÊåâËßíËâ≤ÁªüËÆ°
                const characterStats = {};
                spaces.forEach(space => {
                    const char = space.characterName;
                    if (!characterStats[char]) {
                        characterStats[char] = { count: 0, lastInteraction: space.lastAccess };
                    }
                    characterStats[char].count++;
                    if (new Date(space.lastAccess) > new Date(characterStats[char].lastInteraction)) {
                        characterStats[char].lastInteraction = space.lastAccess;
                    }
                });
                
                // ÊúÄËøëÁöÑ‰∫íÂä®
                const recentSpaces = spaces
                    .sort((a, b) => new Date(b.lastAccess) - new Date(a.lastAccess))
                    .slice(0, 5);
                
                let statsHtml = `
                    üìä ‰∫íÂä®Á©∫Èó¥ÁªüËÆ°‰ø°ÊÅØ
                    
                    ÊÄª‰∫íÂä®Á©∫Èó¥: ${totalSpaces}‰∏™
                    Ê∂âÂèäËßíËâ≤: ${totalCharacters}‰∏™
                    
                    üìà ËßíËâ≤‰∫íÂä®ÁªüËÆ°:
                    ${Object.entries(characterStats)
                        .sort((a, b) => b[1].count - a[1].count)
                        .map(([char, stats]) => `‚Ä¢ ${char}: ${stats.count}Ê¨°`)
                        .join('\n')
                    }
                    
                    üïí ÊúÄËøë‰∫íÂä®:
                    ${recentSpaces.map(space => 
                        `‚Ä¢ ${space.name} (${new Date(space.lastAccess).toLocaleDateString()})`
                    ).join('\n')}
                    
                    üíæ Êï∞ÊçÆ‰øùÂ≠ò‰ΩçÁΩÆ: ‰∏ñÁïå‰π¶
                    üîÑ ÊúÄÂêéÂêåÊ≠•: ${new Date().toLocaleString()}
                `;
                
                triggerSlash(`/echo ${statsHtml}`);
                QQ_CloseSpiritPanel();
            }
            
            // ===== Áî®Êà∑ËèúÂçïÁ≥ªÁªü =====
            
            /**
             * ÂàáÊç¢Áî®Êà∑ËèúÂçïÊòæÁ§∫/ÈöêËóè
             */
            function QQ_ToggleUserMenu() {
                const menu = $('#QQ_user_menu');
                if (menu.is(':visible')) {
                    QQ_HideUserMenu();
                } else {
                    QQ_ShowUserMenu();
                }
            }
            
            /**
             * ÊòæÁ§∫Áî®Êà∑ËèúÂçï
             */
            function QQ_ShowUserMenu() {
                // ÈöêËóèÂÖ∂‰ªñËèúÂçï
                $('.dropdown-menu, .context-menu').hide();
                
                $('#QQ_user_menu').fadeIn(200);
                
                // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠ËèúÂçï
                $(document).one('click', function(e) {
                    if (!$(e.target).closest('#QQ_user_menu, #QQ_home_UserName').length) {
                        QQ_HideUserMenu();
                    }
                });
            }
            
            /**
             * ÈöêËóèÁî®Êà∑ËèúÂçï
             */
            function QQ_HideUserMenu() {
                $('#QQ_user_menu').fadeOut(150);
            }
            
            // ===== ÂÖ®Â±ÄË∞ÉËØïÂ∑•ÂÖ∑ =====
            
            /**
             * ÊòæÁ§∫‰∫íÂä®Á©∫Èó¥ËØ¶ÁªÜÁªüËÆ°ÔºàË∞ÉËØïÁî®Ôºâ
             */
            window.QQ_Show_Interactive_Stats = function() {
                const spaces = Object.values(QQ_InteractiveSpaces);
                console.log('=== ‰∫íÂä®Á©∫Èó¥ËØ¶ÁªÜÁªüËÆ° ===');
                console.log('ÊÄªÁ©∫Èó¥Êï∞Èáè:', spaces.length);
                console.log('Á≤æÁÅµÊåâÈíÆÂèØËßÅ:', QQ_SpiritVisible);
                console.log('ÂΩìÂâçÊ¥ªÂä®Á©∫Èó¥:', QQ_ActiveSpaceId);
                console.log('ÊâÄÊúâÁ©∫Èó¥Êï∞ÊçÆ:', QQ_InteractiveSpaces);
                
                if (worldbook) {
                    // ‰ΩøÁî®ÂºÇÊ≠•ÊñπÂºèËé∑ÂèñÊù°ÁõÆ
                    getLorebookEntries(worldbook).then(entries => {
                        if (entries) {
                            const entry = entries.find(e => e.comment === QQ_INTERACTIVE_BACKUP_KEY);
                            console.log('‰∏ñÁïå‰π¶Â§á‰ªΩÊù°ÁõÆ:', entry ? 'Â≠òÂú®' : '‰∏çÂ≠òÂú®');
                            if (entry) {
                                console.log('Â§á‰ªΩÂÜÖÂÆπÈïøÂ∫¶:', entry.content.length);
                                try {
                                    const data = JSON.parse(entry.content);
                                    console.log('Â§á‰ªΩÁâàÊú¨:', data.version);
                                    console.log('ÊúÄÂêéÊõ¥Êñ∞:', data.lastUpdated);
                                    console.log('Â§á‰ªΩÁ©∫Èó¥Êï∞Èáè:', Object.keys(data.spaces || {}).length);
                                } catch (e) {
                                    console.error('Ëß£ÊûêÂ§á‰ªΩÊï∞ÊçÆÂ§±Ë¥•:', e);
                                }
                            }
                        } else {
                            console.warn('Êó†Ê≥ïËé∑Âèñ‰∏ñÁïå‰π¶Êù°ÁõÆ');
                        }
                    }).catch(error => {
                        console.error('Ëé∑Âèñ‰∏ñÁïå‰π¶Êù°ÁõÆÂ§±Ë¥•:', error);
                    });
                } else {
                    console.warn('‰∏ñÁïå‰π¶Êú™ÂàùÂßãÂåñ');
                }
                
                // Ê£ÄÊü•Á≤æÁÅµÊåâÈíÆÁä∂ÊÄÅ
                const spiritButton = $('.QQ_spirit_button');
                console.log('Á≤æÁÅµÊåâÈíÆDOMÂ≠òÂú®:', spiritButton.length > 0);
                if (spiritButton.length > 0) {
                    console.log('Á≤æÁÅµÊåâÈíÆ‰ΩçÁΩÆ:', {
                        left: spiritButton.css('left'),
                        top: spiritButton.css('top'),
                        right: spiritButton.css('right'),
                        bottom: spiritButton.css('bottom')
                    });
                }
                
                const savedPosition = localStorage.getItem('QQ_spirit_position');
                console.log('‰øùÂ≠òÁöÑÁ≤æÁÅµ‰ΩçÁΩÆ:', savedPosition);
                
                triggerSlash('/echo üìä ‰∫íÂä®Á©∫Èó¥Ë∞ÉËØï‰ø°ÊÅØÂ∑≤ËæìÂá∫Âà∞ÊéßÂà∂Âè∞');
            };
            
            // ===== È°µÈù¢ÂàùÂßãÂåñÂ§ÑÁêÜ =====
            
            /**
             * ÂàùÂßãÂåñ‰∫íÂä®Á©∫Èó¥Á≥ªÁªü
             */
            async function QQ_InitInteractiveSystem() {
                try {
                    // Âä†ËΩΩ‰∫íÂä®Á©∫Èó¥Êï∞ÊçÆ
                    await QQ_LoadInteractiveSpaces();
                    await QQ_LoadCharacterSpaces();
                    
                    // Ê∑ªÂä†CSSÊ†∑Âºè
                    if (!$('#QQ_interactive_styles').length) {
                        $('head').append(`
                            <style id="QQ_interactive_styles">
                                @keyframes menuSlideDown {
                                    from { 
                                        opacity: 0; 
                                        transform: translateY(-10px); 
                                    }
                                    to { 
                                        opacity: 1; 
                                        transform: translateY(0); 
                                    }
                                }
                                
                                .user_menu_item:last-child {
                                    border-bottom: none !important;
                                }
                                
                                /* Á≤æÁÅµÊåâÈíÆÂú®ÁßªÂä®ËÆæÂ§á‰∏äÁöÑ‰ºòÂåñ */
                                @media (max-width: 768px) {
                                    .QQ_spirit_button {
                                        width: 50px !important;
                                        height: 50px !important;
                                        font-size: 20px !important;
                                    }
                                }
                                
                                /* ‰∫íÂä®Á©∫Èó¥Âú®ÁßªÂä®ËÆæÂ§á‰∏äÁöÑ‰ºòÂåñ */
                                @media (max-width: 768px) {
                                    .QQ_interactive_content {
                                        max-width: 95% !important;
                                        max-height: 85% !important;
                                    }
                                    
                                    .QQ_spirit_panel {
                                        width: 300px !important;
                                        max-height: 400px !important;
                                    }
                                }
                            </style>
                        `);
                    }
                    
                    console.log('‚úÖ ‰∫íÂä®Á©∫Èó¥Á≥ªÁªüÂàùÂßãÂåñÂÆåÊàê');
                } catch (error) {
                    console.error('‚ùå ‰∫íÂä®Á©∫Èó¥Á≥ªÁªüÂàùÂßãÂåñÂ§±Ë¥•:', error);
                }
            }

            /**
             * ÊâìÂºÄ‰∫íÂä®ÂõûÂ∫îÁïåÈù¢
             * @param {string} characterName - ËßíËâ≤ÂêçÁß∞
             */
            function QQ_OpenInteractiveReply(characterName) {
                // ÂàõÂª∫Êõ¥‰ºòÈõÖÁöÑËæìÂÖ•ÁïåÈù¢
                const inputHtml = `
                    <div class="QQ_reply_input_overlay" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.5);
                        z-index: 10001;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        animation: fadeIn 0.3s ease;
                    ">
                        <div style="
                            background: white;
                            border-radius: 15px;
                            padding: 25px;
                            max-width: 80%;
                            width: 400px;
                            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                            animation: slideIn 0.3s ease;
                        ">
                            <h3 style="margin: 0 0 15px 0; color: #333; text-align: center;">ÂõûÂ∫î ${characterName} ÁöÑ‰∫íÂä®</h3>
                            <textarea id="reply_input" placeholder="ËæìÂÖ•‰Ω†ÁöÑÂõûÂ∫î..." style="
                                width: 100%;
                                height: 100px;
                                border: 2px solid #e0e0e0;
                                border-radius: 10px;
                                padding: 12px;
                                font-size: 14px;
                                resize: vertical;
                                box-sizing: border-box;
                                font-family: inherit;
                            "></textarea>
                            <div style="display: flex; justify-content: center; gap: 15px; margin-top: 20px;">
                                <button id="send_reply" style="
                                    background: #4FC3F7;
                                    border: none;
                                    color: white;
                                    padding: 10px 20px;
                                    border-radius: 20px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                ">ÂèëÈÄÅÂõûÂ∫î</button>
                                <button id="cancel_reply" style="
                                    background: #f5f5f5;
                                    border: none;
                                    color: #666;
                                    padding: 10px 20px;
                                    border-radius: 20px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                ">ÂèñÊ∂à</button>
                            </div>
                        </div>
                    </div>
                `;
                
                $('body').append(inputHtml);
                
                // ËÅöÁÑ¶ËæìÂÖ•Ê°Ü
                setTimeout(() => $('#reply_input').focus(), 100);
                
                // ÁªëÂÆö‰∫ã‰ª∂
                $('#send_reply').on('click', function() {
                    const replyText = $('#reply_input').val().trim();
                    if (replyText) {
                        const interactiveReply = `ÂõûÂ∫î‰∫íÂä®: ${replyText}`;
                        QQ_SendMessage(interactiveReply, characterName);
                        $('.QQ_reply_input_overlay').fadeOut(300, function() {
                            $(this).remove();
                        });
                    } else {
                        $('#reply_input').focus();
                    }
                });
                
                $('#cancel_reply').on('click', function() {
                    $('.QQ_reply_input_overlay').fadeOut(300, function() {
                        $(this).remove();
                    });
                });
                
                // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
                $('.QQ_reply_input_overlay').on('click', function(e) {
                    if (e.target === this) {
                        $(this).fadeOut(300, function() {
                            $(this).remove();
                        });
                    }
                });
                
                // ÂõûËΩ¶ÂèëÈÄÅ
                $('#reply_input').on('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        $('#send_reply').click();
                    }
                });
            }

            /**
             * ÂèëÈÄÅÊ∂àÊÅØÂà∞ÊåáÂÆöËßíËâ≤
             * @param {string} message - Ê∂àÊÅØÂÜÖÂÆπ
             * @param {string} targetName - ÁõÆÊ†áËßíËâ≤ÂêçÁß∞
             */
            function QQ_SendMessage(message, targetName = "") {
                // ËÆæÁΩÆÂÖ®Â±ÄÂèëÈÄÅÂèòÈáè
                SendValue = message;
                SendName = targetName;
                
                // Ë∞ÉÁî®Áé∞ÊúâÁöÑÂèëÈÄÅÊú∫Âà∂
                console.log(`ÂèëÈÄÅ‰∫íÂä®ÂõûÂ∫îÊ∂àÊÅØ: ${message} -> ${targetName}`);
                
                // Â¶ÇÊûúÂú®ËÅäÂ§©È°µÈù¢ÔºåÁõ¥Êé•ÂèëÈÄÅ
                if (typeof QQ_Send === 'function') {
                    QQ_Send();
                } else {
                    // Âê¶ÂàôÈÄöËøátriggerSlashÂèëÈÄÅ
                    if (targetName) {
                        triggerSlash(`/sendas name={{char}} Êî∂Âà∞Êù•Ëá™${UserName}ÁöÑ‰∫íÂä®ÂõûÂ∫î: ${message}`);
                    } else {
                        triggerSlash(`/sendas name={{char}} Êî∂Âà∞‰∫íÂä®ÂõûÂ∫î: ${message}`);
                    }
                }
                
                // Ê∏ÖÁêÜÂèëÈÄÅÂèòÈáè
                SendValue = "";
                SendName = "";
            }

            
            // ===== Áî®Êà∑ËèúÂçïÊéßÂà∂ÂáΩÊï∞ =====
            
            /**
             * ÂàáÊç¢Áî®Êà∑ËèúÂçïÊòæÁ§∫Áä∂ÊÄÅ
             */
            function QQ_ToggleUserMenu() {
                const menu = $('#QQ_user_menu');
                if (menu.is(':visible')) {
                    QQ_HideUserMenu();
                } else {
                    QQ_ShowUserMenu();
                }
            }
            
            /**
             * ÊòæÁ§∫Áî®Êà∑ËèúÂçï
             */
            function QQ_ShowUserMenu() {
                const menu = $('#QQ_user_menu');
                if (menu.length === 0) return;
                
                // ÈöêËóèÂÖ∂‰ªñËèúÂçï
                $('.dropdown-menu, .context-menu, .QQ_spirit_panel').hide();
                
                // ÊòæÁ§∫ËèúÂçï
                menu.show();
                
                // ÁªëÂÆöÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠‰∫ã‰ª∂
                setTimeout(() => {
                    $(document).on('click.user-menu', function(e) {
                        if (!menu.is(e.target) && menu.has(e.target).length === 0 && !$('#QQ_home_UserName').is(e.target)) {
                            QQ_HideUserMenu();
                        }
                    });
                }, 100);
            }
            
            /**
             * ÈöêËóèÁî®Êà∑ËèúÂçï
             */
            function QQ_HideUserMenu() {
                $('#QQ_user_menu').hide();
                $(document).off('click.user-menu');
            }
            
            // ===== ‰∫íÂä®Á©∫Èó¥Ë∞ÉËØïÂ∑•ÂÖ∑ =====
            
            /**
             * ÊòæÁ§∫‰∫íÂä®Á©∫Èó¥Ë∞ÉËØïÁªüËÆ°‰ø°ÊÅØÔºàÂÖ®Â±ÄÂáΩÊï∞Ôºâ
             */
            window.QQ_Show_Interactive_Stats = function() {
                const spaces = Object.values(QQ_InteractiveSpaces);
                const spiritVisible = QQ_SpiritVisible;
                const activeSpace = QQ_ActiveSpaceId;
                
                let report = `
üßö‚Äç‚ú® ‰∫íÂä®Á©∫Èó¥Á≥ªÁªüÁä∂ÊÄÅÊä•Âëä
========================

üìä Âü∫Á°ÄÁªüËÆ°:
‚Ä¢ ÊÄªÁ©∫Èó¥Êï∞: ${spaces.length}
‚Ä¢ Á≤æÁÅµÁä∂ÊÄÅ: ${spiritVisible ? 'ÊòæÁ§∫' : 'ÈöêËóè'}
‚Ä¢ Ê¥ªÂä®Á©∫Èó¥: ${activeSpace || 'Êó†'}

üìù Á©∫Èó¥ËØ¶ÊÉÖ:`;
                
                if (spaces.length > 0) {
                    spaces.forEach((space, index) => {
                        const lastAccess = new Date(space.lastAccess).toLocaleString();
                        report += `
${index + 1}. ${space.name}
   ID: ${space.id}
   ËßíËâ≤: ${space.characterName}
   ÂàõÂª∫: ${new Date(space.createdAt).toLocaleString()}
   ÊúÄÂêéËÆøÈóÆ: ${lastAccess}
   ÂÜÖÂÆπÈïøÂ∫¶: ${space.content.length} Â≠óÁ¨¶`;
                    });
                } else {
                    report += `
   ÊöÇÊó†‰∫íÂä®Á©∫Èó¥Êï∞ÊçÆ`;
                }
                
                report += `

üíæ Â≠òÂÇ®‰ø°ÊÅØ:
‚Ä¢ Â§á‰ªΩÈîÆ: ${QQ_INTERACTIVE_BACKUP_KEY}
‚Ä¢ ‰∏ñÁïå‰π¶Áä∂ÊÄÅ: ${worldbook ? 'Â∑≤Âä†ËΩΩ' : 'Êú™Âä†ËΩΩ'}

üîß ÂèØÁî®ÂëΩ‰ª§:
‚Ä¢ window.QQ_Show_Interactive_Stats() - ÊòæÁ§∫Ê≠§ÁªüËÆ°
‚Ä¢ QQ_ShowSpiritButton() - ÊòæÁ§∫Á≤æÁÅµÊåâÈíÆ
‚Ä¢ QQ_HideSpiritButton() - ÈöêËóèÁ≤æÁÅµÊåâÈíÆ
‚Ä¢ QQ_LoadInteractiveSpaces() - ÈáçÊñ∞Âä†ËΩΩÁ©∫Èó¥Êï∞ÊçÆ
‚Ä¢ QQ_SaveInteractiveSpaces() - ÊâãÂä®‰øùÂ≠òÁ©∫Èó¥Êï∞ÊçÆ
`;
                
                console.log(report);
                triggerSlash(`/echo üìä ‰∫íÂä®Á©∫Èó¥ÁªüËÆ°Ôºö${spaces.length}‰∏™Á©∫Èó¥ÔºåÁ≤æÁÅµ${spiritVisible ? 'ÊòæÁ§∫' : 'ÈöêËóè'}‰∏≠`);
                return {
                    totalSpaces: spaces.length,
                    spiritVisible,
                    activeSpace,
                    spaces: spaces.map(s => ({
                        id: s.id,
                        name: s.name,
                        character: s.characterName,
                        created: s.createdAt,
                        lastAccess: s.lastAccess
                    }))
                };
            };
            
            /**
             * *** Êñ∞Â¢ûÔºöÁî®Êà∑Âêç‰∏ãÊãâËèúÂçïÂäüËÉΩ ***
             */
            function QQ_ToggleUserMenu() {
                console.log('ÁÇπÂáªÁî®Êà∑ÂêçÔºåÊòæÁ§∫‰∏ãÊãâËèúÂçï');
                
                // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®ËèúÂçï
                let existingMenu = document.getElementById('QQ_user_dropdown_menu');
                if (existingMenu) {
                    existingMenu.remove();
                    return;
                }
                
                // ÂàõÂª∫‰∏ãÊãâËèúÂçï
                const menu = document.createElement('div');
                menu.id = 'QQ_user_dropdown_menu';
                menu.style.cssText = `
                    position: fixed;
                    top: 70px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: white;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    min-width: 200px;
                    overflow: hidden;
                `;
                
                // Ëé∑ÂèñÂΩìÂâçÁî®Êà∑Âêç
                const currentUserName = document.getElementById('QQ_message_list_UserName').textContent.replace(/\*\*/g, '');
                
                // ËèúÂçïÈ°πÊï∞ÊçÆ
                const menuItems = [
                    {
                        icon: 'üë§',
                        text: '‰øÆÊîπÊòµÁß∞',
                        action: () => QQ_ChangeUserName()
                    },
                    {
                        icon: 'üí´',
                        text: '‰∫íÂä®‰ΩøÁî®ÊåáÂçó',
                        action: () => QQ_ShowInteractiveGuide()
                    },
                    {
                        icon: 'üì±',
                        text: 'ÊâãÊú∫Áä∂ÊÄÅ',
                        action: () => QQ_ShowPhoneStatus()
                    },
                    {
                        icon: 'üîÑ',
                        text: 'ÂêåÊ≠•Êï∞ÊçÆ',
                        action: () => QQ_SyncAllData()
                    },
                    {
                        icon: 'üìã',
                        text: 'Êï∞ÊçÆÁÆ°ÁêÜ',
                        action: () => QQ_ShowDataManagement()
                    },
                    {
                        icon: 'üßπ',
                        text: 'Ê∏ÖÁêÜÁºìÂ≠ò',
                        action: () => QQ_ClearCache()
                    }
                ];
                
                // Ê∑ªÂä†ËèúÂçïÈ°π
                menuItems.forEach((item, index) => {
                    const menuItem = document.createElement('div');
                    menuItem.style.cssText = `
                        padding: 12px 16px;
                        display: flex;
                        align-items: center;
                        cursor: pointer;
                        border-bottom: ${index < menuItems.length - 1 ? '1px solid #f0f0f0' : 'none'};
                        transition: background-color 0.2s;
                    `;
                    
                    menuItem.innerHTML = `
                        <span style="margin-right: 12px; font-size: 16px;">${item.icon}</span>
                        <span style="color: #333; font-size: 14px;">${item.text}</span>
                    `;
                    
                    menuItem.addEventListener('mouseover', () => {
                        menuItem.style.backgroundColor = '#f5f5f5';
                    });
                    
                    menuItem.addEventListener('mouseout', () => {
                        menuItem.style.backgroundColor = 'transparent';
                    });
                    
                    menuItem.addEventListener('click', () => {
                        menu.remove();
                        item.action();
                    });
                    
                    menu.appendChild(menuItem);
                });
                
                // Ê∑ªÂä†Âà∞È°µÈù¢
                document.body.appendChild(menu);
                
                // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠ËèúÂçï
                setTimeout(() => {
                    document.addEventListener('click', function closeMenu(e) {
                        if (!menu.contains(e.target)) {
                            menu.remove();
                            document.removeEventListener('click', closeMenu);
                        }
                    });
                }, 100);
            }

            /**
             * *** Êñ∞Â¢ûÔºöÊòæÁ§∫‰∫íÂä®‰ΩøÁî®ÊåáÂçó ***
             */
            function QQ_ShowInteractiveGuide() {
                const guideContent = `
üéØ ‰∫íÂä®ÂäüËÉΩ‰ΩøÁî®ÊåáÂçó

„Äê‰∏ªÂä®Ëß¶Âèë‰∫íÂä®„Äë
‰ΩøÁî®ÁâπÊÆäÁ¨¶Âè∑ && Áõ¥Êé•Ëß¶Âèë‰∫íÂä®ÂÜÖÂÆπÔºö

‚ú® ‰ΩøÁî®ÊñπÊ≥ïÔºö
‚Ä¢ "&&ÊÉ≥Ë¶ÅÊã•Êä±‰Ω†" 
‚Ä¢ "Êä±Êä±‰Ω†&&"  
‚Ä¢ "ÊàëÊÉ≥&&Âíå‰Ω†‰∏ÄËµ∑Êï£Ê≠•"

üé™ ÊïàÊûúÔºöAI‰ºöÁõ¥Êé•ÁîüÊàê‰∫íÂä®Âú∫ÊôØÔºåË∑≥ËøáÊôÆÈÄöËÅäÂ§©

„ÄêÊÉäÂñúÊ®°Âºè‰∫íÂä®„Äë
Á≥ªÁªüÊ£ÄÊµãÂÖ≥ÈîÆËØçËá™Âä®Ëß¶ÂèëÔºà‰Ωú‰∏∫ÊÉäÂñúÂäüËÉΩÔºâÔºö

üí´ ÂÖ≥ÈîÆËØçÁ±ªÂûãÔºö
‚Ä¢ Ë∫´‰ΩìÊé•Ëß¶ÔºöÊã•Êä±„ÄÅ‰∫≤Âêª„ÄÅËß¶Êë∏„ÄÅÁâµÊâã
‚Ä¢ Èù¢ÂØπÈù¢‰∫§ÊµÅÔºöÈù¢ÂØπÈù¢„ÄÅËµ∞Ëøë„ÄÅÂùê‰∏ã
‚Ä¢ ÊÉÖÊÑüË°®ËææÔºöËÑ∏Á∫¢„ÄÅÂæÆÁ¨ë„ÄÅÂì≠Ê≥£
‚Ä¢ Âä®‰ΩúÊèèËø∞Ôºö*Âä®‰Ωú*„ÄÅ„ÄêÊÉÖÊÑü„Äë

üè† ‰∫íÂä®Á©∫Èó¥Ôºö
‚Ä¢ ÁÇπÂáªÁßÅËÅäËßíËâ≤ÂêçÁß∞ÂèØÊü•ÁúãËßíËâ≤‰∏ìÂ±ûÁ≤æÁÅµ
‚Ä¢ Á≤æÁÅµÂèØÁÆ°ÁêÜËØ•ËßíËâ≤ÁöÑÊâÄÊúâ‰∫íÂä®ËÆ∞ÂΩï
‚Ä¢ ÊîØÊåÅÂàõÂª∫Êñ∞‰∫íÂä®ÂíåÊü•ÁúãÂéÜÂè≤ËÆ∞ÂΩï

üí° Â∞èË¥¥Â£´Ôºö
‚Ä¢ ‰∏ªÂä®Á¨¶Âè∑Ëß¶ÂèëÊõ¥Á≤æÂáÜ
‚Ä¢ ÊÉäÂñúÊ®°ÂºèÂú®ÂÖ≥ÈîÆÊó∂ÂàªÊøÄÊ¥ª
‚Ä¢ ÊâÄÊúâ‰∫íÂä®ÂÜÖÂÆπ‰øùÂ≠òÂú®‰∏ñÁïå‰π¶‰∏≠
                `.trim();
                
                alert(guideContent);
                console.log('ÊòæÁ§∫‰∫íÂä®‰ΩøÁî®ÊåáÂçó');
            }
            
            /**
             * *** Êñ∞Â¢ûÔºö‰øÆÊîπÁî®Êà∑ÊòµÁß∞ ***
             */
            function QQ_ChangeUserName() {
                const currentName = document.getElementById('QQ_message_list_UserName').textContent.replace(/\*\*/g, '');
                const newName = prompt('ËØ∑ËæìÂÖ•Êñ∞ÁöÑÊòµÁß∞:', currentName);
                
                if (newName && newName.trim() && newName.trim() !== currentName) {
                    const finalName = newName.trim();
                    
                    // Êõ¥Êñ∞ÊâÄÊúâÊòæÁ§∫ÁöÑÁî®Êà∑Âêç
                    document.getElementById('QQ_message_list_UserName').innerHTML = `<strong>${finalName}</strong>`;
                    document.getElementById('QQ_home_UserName').textContent = finalName;
                    
                    // ‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶
                    QQ_SafeSaveToWorldBook('Áî®Êà∑ËÆæÁΩÆ', {
                        userName: finalName,
                        updateTime: new Date().toISOString()
                    }, 'QQ_Áî®Êà∑ËÆæÁΩÆ');
                    
                    console.log(`Áî®Êà∑ÂêçÂ∑≤Êõ¥Êîπ‰∏∫: ${finalName}`);
                    triggerSlash(`/echo Áî®Êà∑ÂêçÂ∑≤Êõ¥Êîπ‰∏∫: ${finalName}`);
                }
            }

            /**
             * *** Êñ∞Â¢ûÔºöÊòæÁ§∫ÊâãÊú∫Áä∂ÊÄÅ ***
             */
            function QQ_ShowPhoneStatus() {
                const stats = {
                    contacts: Object.keys(window.QQ_Contacts || {}).length,
                    groups: Object.keys(window.QQ_Groups || {}).length,
                    messages: Object.keys(window.QQ_MessageHistory || {}).length,
                    moments: Object.keys(window.QQ_MomentData || {}).length,
                    interactiveSpaces: Object.keys(window.QQ_InteractiveSpaces || {}).length
                };
                
                const statusInfo = `
üì± ÊâãÊú∫Áä∂ÊÄÅÊä•Âëä
ËÅîÁ≥ª‰∫∫: ${stats.contacts} ‰∏™
Áæ§ËÅä: ${stats.groups} ‰∏™  
Ê∂àÊÅØËÆ∞ÂΩï: ${stats.messages} Êù°
Âä®ÊÄÅ: ${stats.moments} Êù°
‰∫íÂä®Á©∫Èó¥: ${stats.interactiveSpaces} ‰∏™

üîã Á≥ªÁªüÁä∂ÊÄÅ: Ê≠£Â∏∏
üì∂ ÁΩëÁªúÁä∂ÊÄÅ: Â∑≤ËøûÊé•
üíæ Êï∞ÊçÆÂêåÊ≠•: ‰∏ñÁïå‰π¶
                `.trim();
                
                alert(statusInfo);
                console.log('ÊâãÊú∫Áä∂ÊÄÅ:', stats);
            }

            /**
             * *** Êñ∞Â¢ûÔºöÂêåÊ≠•ÊâÄÊúâÊï∞ÊçÆ ***
             */
            function QQ_SyncAllData() {
                console.log('üîÑ ÂºÄÂßãÂêåÊ≠•ÊâÄÊúâÊï∞ÊçÆÂà∞‰∏ñÁïå‰π¶...');
                
                const syncTasks = [
                    () => QQ_SaveAllContactsToWorldBook(),
                    () => QQ_SaveAllGroupsToWorldBook(), 
                    () => QQ_SaveAllMessagesToWorldBook(),
                    () => QQ_SaveAllMomentsToWorldBook(),
                    () => QQ_SaveAllInteractiveSpacesToWorldBook(),
                    () => saveGroupsToStorage() // ‰øùÂ≠òÂΩìÂâçËßíËâ≤ÁöÑÂàÜÁªÑÊï∞ÊçÆ
                ];
                
                let completed = 0;
                const total = syncTasks.length;
                
                syncTasks.forEach((task, index) => {
                    setTimeout(() => {
                        try {
                            task();
                            completed++;
                            console.log(`‚úÖ ÂêåÊ≠•‰ªªÂä° ${index + 1}/${total} ÂÆåÊàê`);
                            
                            if (completed === total) {
                                triggerSlash(`/echo ÊâÄÊúâÊï∞ÊçÆÂ∑≤ÂêåÊ≠•Âà∞‰∏ñÁïå‰π¶ (${total}/${total})`);
                                console.log('üéâ ÊâÄÊúâÊï∞ÊçÆÂêåÊ≠•ÂÆåÊàêÔºÅ');
                            }
                        } catch (error) {
                            console.error(`‚ùå ÂêåÊ≠•‰ªªÂä° ${index + 1} Â§±Ë¥•:`, error);
                        }
                    }, index * 500); // Èó¥Èöî500msÊâßË°åÔºåÈÅøÂÖçÂπ∂ÂèëÈóÆÈ¢ò
                });
                
                triggerSlash(`/echo Ê≠£Âú®ÂêåÊ≠•Êï∞ÊçÆÂà∞‰∏ñÁïå‰π¶... (0/${total})`);
            }

            /**
             * *** Êñ∞Â¢ûÔºöÊòæÁ§∫Êï∞ÊçÆÁÆ°ÁêÜÁïåÈù¢ ***
             */
            function QQ_ShowDataManagement() {
                console.log('ÊòæÁ§∫Êï∞ÊçÆÁÆ°ÁêÜÁïåÈù¢');
                alert('Êï∞ÊçÆÁÆ°ÁêÜÂäüËÉΩÂºÄÂèë‰∏≠...\n\nÂΩìÂâçÊîØÊåÅ:\n‚Ä¢ ÊâÄÊúâÊï∞ÊçÆ‰øùÂ≠òÂú®‰∏ñÁïå‰π¶‰∏≠\n‚Ä¢ ËÅîÁ≥ª‰∫∫ÂàÜÁªÑÁÆ°ÁêÜ\n‚Ä¢ ‰∫íÂä®Á©∫Èó¥ÁÆ°ÁêÜ\n‚Ä¢ Ê∂àÊÅØËÆ∞ÂΩïÁÆ°ÁêÜ');
            }

            /**
             * *** Êñ∞Â¢ûÔºöÊ∏ÖÁêÜÁºìÂ≠ò ***
             */
            function QQ_ClearCache() {
                if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁêÜÁºìÂ≠òÂêóÔºüËøôÂ∞ÜÊ∏ÖÈô§‰∏¥Êó∂Êï∞ÊçÆ‰ΩÜ‰øùÁïô‰∏ñÁïå‰π¶‰∏≠ÁöÑÈáçË¶ÅÊï∞ÊçÆ„ÄÇ')) {
                    // Ê∏ÖÁêÜÂâçÁ´ØÁºìÂ≠ò
                    window.QQ_Cache = {};
                    window.QQ_TempData = {};
                    
                    // Ê∏ÖÁêÜ‰∏Ä‰∫õ‰∏¥Êó∂DOMÁºìÂ≠ò
                    $('.QQ_temp_cache').remove();
                    
                    console.log('ÁºìÂ≠òÂ∑≤Ê∏ÖÁêÜ');
                    triggerSlash('/echo ÁºìÂ≠òÂ∑≤Ê∏ÖÁêÜÔºåÈáçË¶ÅÊï∞ÊçÆ‰øùÁïôÂú®‰∏ñÁïå‰π¶‰∏≠');
                }
            }

            // *** Êñ∞Â¢ûÔºö‰∫íÂä®Ê£ÄÊµãÊµãËØïÂ∑•ÂÖ∑ - ‰ºòÂåñÁâà ***
            window.QQ_Test_Interactive_Detection = function(text) {
                if (text) {
                    // ÊµãËØïÂçï‰∏™ÊñáÊú¨
                    const result = QQ_DetectInteractiveIntent(text);
                    
                    let details = `
=== ‰∫íÂä®ÊÑèÂõæÊ£ÄÊµãÊµãËØï ===
üìù ÊµãËØïÊñáÊú¨: "${text}"`;

                    if (result && result.isInteractive) {
                        details += `
üéØ Ê£ÄÊµãÁªìÊûú: ‚úÖ Ê£ÄÊµãÂà∞‰∫íÂä®ÊÑèÂõæ
üîß Ëß¶ÂèëÁ±ªÂûã: ${result.triggerType === 'symbol' ? 'üéØ ÁâπÊÆäÁ¨¶Âè∑Ëß¶Âèë' : 'üí´ ÂÖ≥ÈîÆËØçËß¶Âèë (ÊÉäÂñúÊ®°Âºè)'}`;
                        
                        if (result.triggerType === 'symbol') {
                            details += `
üîó Ëß¶ÂèëÁ¨¶Âè∑: ${result.triggerSymbol}
üìù Ê∏ÖÁêÜÂêéÂÜÖÂÆπ: "${result.cleanContent}"
üí° ËØ¥Êòé: ${result.description}`;
                        } else {
                            details += `
üìä ÂÖ≥ÈîÆËØçÂåπÈÖç: ${result.matchCount || 0} ‰∏™
üé≠ Ê®°ÂºèÂåπÈÖç: ${result.patternMatches || 0} ‰∏™
üîç ÂåπÈÖçÂÜÖÂÆπ: ${result.matchedKeywords ? result.matchedKeywords.join(', ') : 'Êó†'}
üí° ËØ¥Êòé: ${result.description}`;
                        }
                    } else {
                        details += `
üéØ Ê£ÄÊµãÁªìÊûú: ‚ùå Êú™Ê£ÄÊµãÂà∞‰∫íÂä®ÊÑèÂõæ`;
                    }

                    details += `

üí° ‰ΩøÁî®ÊåáÂçó:
üéØ „Äê‰∏ªÂä®Ëß¶Âèë„Äë‰ΩøÁî®ÁâπÊÆäÁ¨¶Âè∑:
‚Ä¢ "&&ÊÉ≥Ë¶ÅÊã•Êä±‰Ω†" (‚úÖ Á¨¶Âè∑Ëß¶Âèë)
‚Ä¢ "Êä±Êä±‰Ω†&&" (‚úÖ Á¨¶Âè∑Ëß¶Âèë)  
‚Ä¢ "ÊàëÊÉ≥&&Âíå‰Ω†‰∏ÄËµ∑Êï£Ê≠•" (‚úÖ Á¨¶Âè∑Ëß¶Âèë)

üí´ „ÄêÊÉäÂñúÊ®°Âºè„Äë‰º†ÁªüÂÖ≥ÈîÆËØç:
‚Ä¢ Ë∫´‰ΩìÊé•Ëß¶: Êã•Êä±„ÄÅ‰∫≤Âêª„ÄÅËß¶Êë∏„ÄÅÁâµÊâãÁ≠â
‚Ä¢ Èù¢ÂØπÈù¢‰∫§ÊµÅ: Èù¢ÂØπÈù¢„ÄÅÂΩìÈù¢„ÄÅËµ∞Ëøë„ÄÅÂùê‰∏ãÁ≠â  
‚Ä¢ ÊÉÖÊÑüË°®Ëææ: ËÑ∏Á∫¢„ÄÅÂÆ≥Áæû„ÄÅÂæÆÁ¨ë„ÄÅÂì≠Ê≥£Á≠â
‚Ä¢ Âä®‰ΩúÊèèËø∞: *Âä®‰Ωú*„ÄÅ„ÄêÊÉÖÊÑü„ÄëÁ≠âÊ†ºÂºè
‚Ä¢ ÈúÄË¶Å2‰∏™ÂÖ≥ÈîÆËØçÊàñ1‰∏™Ê®°ÂºèÂåπÈÖçÊâçËß¶Âèë

üìö Á§∫‰æãÊµãËØïÊñáÊú¨:
‚Ä¢ "&&Êä±Êä±‰Ω†" (üéØ Á¨¶Âè∑Ëß¶Âèë)
‚Ä¢ "ÊàëÊÉ≥Êä±Êä±‰Ω†" (üí´ Ë∫´‰ΩìÊé•Ëß¶)
‚Ä¢ "*Ëµ∞Âêë‰Ω†*" (üí´ Âä®‰ΩúÊ®°Âºè) 
‚Ä¢ "Èù¢ÂØπÈù¢ËÅäÂ§©" (üí´ Èù¢ÂØπÈù¢+Âä®‰Ωú)
‚Ä¢ "‰Ω†Â•ΩÂêóÔºü" (‚ùå ÊôÆÈÄöÂØπËØù)
                `;
                    console.log(details);
                    alert(details);
                    return result;
                } else {
                    // ËøêË°åÂÆåÊï¥ÁöÑ‰ºòÂåñÊµãËØïÂ•ó‰ª∂
                    console.log("üîç ========== ‰∫íÂä®Ê£ÄÊµã‰ºòÂåñÊµãËØïÂ•ó‰ª∂ ==========");
                    
                    const testCases = [
                        // üî¨ ÂÖàÂõûÂ§çÂêé‰∫íÂä®ÁöÑÊµãËØïÁî®‰æã
                        {
                            name: "ÂÖàÁßÅËÅäÂõûÂ§çÂêé‰∫íÂä®",
                            content: "ÂÖàÂú®ÁßÅËÅäÂõûÂ§ç'Â•ΩÁöÑÈ©¨‰∏äÊù•'ÁÑ∂ÂêéËøáÊù•Êã•Êä±Êàë",
                            expected: "Â∫îÊ£ÄÊµãÂà∞ÂÖàÂõûÂ§çË¶ÅÊ±Ç",
                            test: (content) => QQ_CheckPriorReplyRequest(content).shouldReplyFirst
                        },
                        {
                            name: "ÂÖàÁæ§ËÅäÂõûÂ§çÂêé‰∫íÂä®", 
                            content: "ÂÖàÂú®Áæ§ËÅäËØ¥'Â§ßÂÆ∂Á≠âÊàë‰∏Ä‰∏ã'ÁÑ∂ÂêéÂÜçËøáÊù•‰∏ÄËµ∑Áé©Ê∏∏Êàè",
                            expected: "Â∫îÊ£ÄÊµãÂà∞ÂÖàÂõûÂ§çË¶ÅÊ±Ç",
                            test: (content) => QQ_CheckPriorReplyRequest(content).shouldReplyFirst
                        },
                        
                        // üî¨ Á≤æÁ°ÆÂÖ≥ÈîÆËØçÊ£ÄÊµãÁöÑÊµãËØïÁî®‰æã
                        {
                            name: "Êó†ÊïàÈõÜ‰ΩìÂÖ≥ÈîÆËØç",
                            content: "Áî®Êà∑ÂèëÈÄÅ‰∫Ü'ÈõÜ‰ΩìË°åÂä®'‰ΩÜËøôÂè™ÊòØÂú®ËÆ®ËÆ∫Ê¶ÇÂøµ",
                            expected: "‰∏çÂ∫îËß¶ÂèëÂ§ö‰∫∫‰∫íÂä®",
                            test: (content) => !QQ_DetectMultiCharacterInteraction(content, null)
                        },
                        {
                            name: "ÊúâÊïàÈõÜ‰Ωì‰∫íÂä®",
                            content: "Êàë‰ª¨‰∏ÄËµ∑ÂéªÂÖ¨Âõ≠Áé©ÂêßÔºåÊâÄÊúâ‰∫∫ÈÉΩÊù•",
                            expected: "Â∫îËß¶ÂèëÂ§ö‰∫∫‰∫íÂä®",
                            test: (content) => QQ_DetectMultiCharacterInteraction(content, null)
                        },
                        {
                            name: "ËøáÂéªÊó∂ÊÄÅÊó†Êïà",
                            content: "Êàë‰ª¨‰ª•Ââç‰∏ÄËµ∑Áé©ËøáÊ∏∏Êàè",
                            expected: "‰∏çÂ∫îËß¶ÂèëÂ§ö‰∫∫‰∫íÂä®",
                            test: (content) => !QQ_DetectMultiCharacterInteraction(content, null)
                        },
                        {
                            name: "Êù°‰ª∂Âè•Êó†Êïà",
                            content: "Â¶ÇÊûúÊàë‰ª¨‰∏ÄËµ∑ÂéªÁöÑËØù‰ºöÂæàÊúâË∂£",
                            expected: "‰∏çÂ∫îËß¶ÂèëÂ§ö‰∫∫‰∫íÂä®", 
                            test: (content) => !QQ_DetectMultiCharacterInteraction(content, null)
                        },
                        
                        // üî¨ ‰∫íÂä®ÂÜÖÂÆπÊ£ÄÊµãÁöÑÊµãËØïÁî®‰æã
                        {
                            name: "ÊúâÊïà‰∫íÂä®ÂÜÖÂÆπ",
                            content: "*Ëµ∞Âêë‰Ω†* ÊÉ≥Ë¶ÅÊã•Êä±‰Ω†",
                            expected: "Â∫îÊ£ÄÊµãÂà∞‰∫íÂä®ÂÜÖÂÆπ",
                            test: (content) => QQ_IsInteractiveContent(content)
                        },
                        {
                            name: "ÊôÆÈÄöÂØπËØù",
                            content: "‰Ω†‰ªäÂ§©ÊÄé‰πàÊ†∑ÔºüÂ∑•‰ΩúÈ°∫Âà©ÂêóÔºü",
                            expected: "‰∏çÂ∫îÊ£ÄÊµãÂà∞‰∫íÂä®ÂÜÖÂÆπ",
                            test: (content) => !QQ_IsInteractiveContent(content)
                        }
                    ];
                    
                    console.log("ÂºÄÂßãÊâßË°åÊµãËØïÁî®‰æã...");
                    
                    let passCount = 0;
                    let failCount = 0;
                    
                    testCases.forEach((testCase, index) => {
                        console.log(`\n--- ÊµãËØï ${index + 1}: ${testCase.name} ---`);
                        console.log(`ÂÜÖÂÆπ: "${testCase.content}"`);
                        console.log(`ÊúüÊúõ: ${testCase.expected}`);
                        
                        try {
                            const result = testCase.test(testCase.content);
                            if (result) {
                                console.log(`‚úÖ ÊµãËØïÈÄöËøá`);
                                passCount++;
                            } else {
                                console.log(`‚ùå ÊµãËØïÂ§±Ë¥•`);
                                failCount++;
                            }
                        } catch (error) {
                            console.error(`üí• ÊµãËØïÊâßË°åÈîôËØØ:`, error);
                            failCount++;
                        }
                    });
                    
                    console.log(`\nüèÅ ========== ÊµãËØïÁªìÊûúÊ±áÊÄª ==========`);
                    console.log(`‚úÖ ÈÄöËøá: ${passCount}/${testCases.length}`);
                    console.log(`‚ùå Â§±Ë¥•: ${failCount}/${testCases.length}`);
                    console.log(`üìä ÊàêÂäüÁéá: ${Math.round((passCount / testCases.length) * 100)}%`);
                    
                    if (failCount === 0) {
                        console.log(`üéâ ÊâÄÊúâÊµãËØïÁî®‰æãÈÉΩÈÄöËøá‰∫ÜÔºÅ‰∫íÂä®Ê£ÄÊµãÁ≥ªÁªü‰ºòÂåñÊàêÂäüÔºÅ`);
                    } else {
                        console.log(`‚ö†Ô∏è Êúâ ${failCount} ‰∏™ÊµãËØïÁî®‰æãÂ§±Ë¥•ÔºåÈúÄË¶ÅËøõ‰∏ÄÊ≠•‰ºòÂåñ`);
                    }
                    
                    return { passCount, failCount, total: testCases.length };
                }
            };
            
            function QQ_UpdateNewTips() {
                // Âà∑Êñ∞Â∑¶‰∏äËßíÊú™ËØª‰ø°ÊÅØÊï∞Â≠ó
                let ids = $(".QQ_chat_page")
                    .map(function () {
                        return this; // Áõ¥Êé•ËøîÂõûÂÖÉÁ¥†ÁöÑ ID
                    })
                    .get()
                    .filter(Boolean); // ËøáÊª§ÊéâÁ©∫ ID
                for (const id of ids) {
                    if ($(id).css("display") == "none") {
                        continue;
                    }
                    const name = $(id).attr("data-name") ?? "";
                    let TipsCount = QQ_GetChatShowTipsCount(name);
                    console.log(`Ëé∑ÂèñÂà∞${name}ÁöÑÂ∑¶‰∏äËßíÊï∞Â≠ó‰∏∫:${TipsCount}`);
                    const $Tips = $(`.QQ_chat_page[data-name='${name}']`).find(
                        `.new_tips`,
                    );
                    $Tips.text(TipsCount);
                    if (TipsCount > 0) {
                        $Tips.css("display", "flex");
                        console.log(`ÊòæÁ§∫tips`);
                    } else {
                        $Tips.hide();
                        console.log(`ÈöêËóètips`);
                    }
                }
            }
            /**
             * ÂØºËà™Âà∞ÊåáÂÆöÈ°µÈù¢
             */
            function QQ_Nav(page) {
                // È°µÈù¢ÂàáÊç¢Êó∂‰∏çËá™Âä®Ê£ÄÊü•QQ_GroupsÔºàÈÅøÂÖçÈáçÂ§çÂä†ËΩΩÔºâ
                console.log(`ÂØºËà™Âà∞È°µÈù¢: ${page}`);
                
                const $message_svg = $("#QQ_message_svg");
                const $people_svg = $("#QQ_people_svg");
                const $moment_svg = $("#QQ_moment_svg");
                $message_svg.css("fill", "#000000");
                $people_svg.css("fill", "#000000");
                $moment_svg.css("fill", "#000000");
                $("#QQ_home_page").hide();
                $("#QQ_space_page").hide();
                $("#QQ_message_list_page").hide();
                
                // ÊòæÁ§∫Â∫ïÈÉ®ÂØºËà™Ê†è
                $(".QQ_bottom_nav").show();
                
                // Êõ¥Êñ∞ÂΩìÂâçÈ°µÈù¢Áä∂ÊÄÅ
                QQ_currentPage = page;
                
                if (page === "message") {
                    $message_svg.css("fill", "#019aff");
                    $("#QQ_message_list_page").css('display','flex');
                    $("#App_QQ").css("background-color", "#eff3ff");
                    // Êõ¥Êñ∞Áî®Êà∑ÂêçÊòæÁ§∫
                    const userName = $("#QQ_home_UserName").text();
                    $("#QQ_message_list_UserName").text(userName);
                    // ÊØèÊ¨°ÂàáÊç¢Âà∞Ê∂àÊÅØÈ°µÈù¢Êó∂ÈÉΩÊõ¥Êñ∞ÂàóË°®
                    // ‰ΩøÁî®setTimeoutÈÅøÂÖçasyncÈóÆÈ¢ò
                    setTimeout(async () => {
                        await QQ_UpdateMessageList();
                    }, 100);
                    // Ê∂àÊÅØÈ°µÈù¢Âè™ÈúÄË¶ÅÊòæÁ§∫Â∑≤Âä†ËΩΩÁöÑÁæ§ËÅäÔºå‰∏çÈúÄË¶ÅÈáçÊñ∞ÂàùÂßãÂåñ
                    // Ê∂àÊÅØÈ°µÈù¢Âè™ÈúÄË¶ÅÊõ¥Êñ∞ÂàóË°®ÊòæÁ§∫Ôºå‰∏çÈúÄË¶ÅÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
                    console.log('Ê∂àÊÅØÈ°µÈù¢ÊòæÁ§∫ÔºåÊõ¥Êñ∞Ê∂àÊÅØÂàóË°®');
                } else if (page === "people") {
                    $people_svg.css("fill", "#019aff");
                    $("#QQ_home_page").css('display','flex');
                    $("#App_QQ").css("background-color", "#eff3ff");
                    
                    console.log('ÂàáÊç¢Âà∞ËÅîÁ≥ª‰∫∫È°µÈù¢');
                    
                    // ËÅîÁ≥ª‰∫∫È°µÈù¢Âè™ÈúÄË¶ÅÊòæÁ§∫Â∑≤Âä†ËΩΩÁöÑÊï∞ÊçÆÔºå‰∏çÈúÄË¶ÅÈáçÊñ∞Âä†ËΩΩ
                    console.log('ËÅîÁ≥ª‰∫∫È°µÈù¢ÊòæÁ§∫ÔºåÊï∞ÊçÆÂ∑≤Âú®ÂàùÂßãÂåñÊó∂Âä†ËΩΩ');
                    
                    // ËÅîÁ≥ª‰∫∫È°µÈù¢Âè™ÈúÄË¶ÅÊòæÁ§∫Â∑≤Âä†ËΩΩÁöÑÁæ§ËÅäÔºå‰∏çÈúÄË¶ÅÈáçÊñ∞ÂàùÂßãÂåñ
                    
                    // ÂàùÂßãÂåñËÅîÁ≥ª‰∫∫ÂàÜÁªÑÂäüËÉΩ
                    if (typeof initContactGroups === 'function') {
                        setTimeout(initContactGroups, 200);
                    }
                } else if (page === "moment") {
                    $moment_svg.css("fill", "#019aff");
                    $("#QQ_space_page").show();
                    $("#App_QQ").css("background-color", "#ffffff");
                    QQ_SetNewTips(0);
                    QQ_NewMsg["moment"] = 0;
                    $(".new_tips").hide();
                } else if (page === "chat") {
                    // Â§ÑÁêÜËÅäÂ§©È°µÈù¢ÂàáÊç¢
                    console.log('ÂàáÊç¢Âà∞ËÅäÂ§©È°µÈù¢');
                    
                    // ÈöêËóèÂ∫ïÈÉ®ÂØºËà™Ê†è
                    $(".QQ_bottom_nav").hide();
                    
                    // ÈöêËóèÊâÄÊúâÂÖ∂‰ªñÈ°µÈù¢
                    $("#QQ_home_page").hide();
                    $("#QQ_space_page").hide();
                    $("#QQ_message_list_page").hide();
                    
                    // Â¶ÇÊûúÊòØÁæ§ËÅäÔºåÂàõÂª∫ÊàñÊòæÁ§∫Áæ§ËÅä‰∏ìÁî®È°µÈù¢
                    if (window.currentGroupChat) {
                        console.log('ÊòæÁ§∫Áæ§ËÅäÈ°µÈù¢:', window.currentGroupChat.name, 'ID:', window.currentGroupChat.id);
                        
                        // ÈöêËóèÊâÄÊúâÁé∞ÊúâÁöÑËÅäÂ§©È°µÈù¢
                        $(".QQ_chat_page").hide();
                        
                        // ÂÖàÁßªÈô§ÊâÄÊúâÁé∞ÊúâÁöÑÁæ§ËÅäÈ°µÈù¢ÔºåÁ°Æ‰øùÊ≤°ÊúâÁºìÂ≠òÈóÆÈ¢ò
                        $(".group-chat-page").remove();
                        
                        // ÂàõÂª∫Êñ∞ÁöÑÁæ§ËÅä‰∏ìÁî®È°µÈù¢
                        console.log('ÂàõÂª∫Áæ§ËÅä‰∏ìÁî®È°µÈù¢:', window.currentGroupChat.name);
                        const groupChatPage = $(`
                            <div data-group-id="${window.currentGroupChat.id}" class="QQ_chat_page group-chat-page" style="width:100%;height:100%;padding-top:0;background-color:white;position:relative;display:none;">
                                <div class="chat-header" style="padding:10px 15px;background-color:white;border-bottom:1px solid #eee;display:flex;align-items:center;">
                                    <div style="cursor:pointer;margin-right:15px;" onclick="QQ_GoHome()">
                                        <svg viewBox="0 0 1024 1024" style="height:20px;width:20px;">
                                            <path d="M724 218.3V141c0-6.7-7.7-10.4-12.9-6.3L260.3 486.8a31.86 31.86 0 0 0 0 50.3l450.8 352.1c5.3 4.1 12.9 0.4 12.9-6.3v-77.3c0-4.9-2.3-9.6-6.1-12.6l-360-281 360-281.1c3.8-3 6.1-7.7 6.1-12.6z" fill="#333"></path>
                                        </svg>
                                    </div>
                                    <div class="group-chat-info" style="flex:1;">
                                        <div class="group-chat-name" style="font-size:16px;font-weight:bold;color:#333;">${window.currentGroupChat.name}</div>
                                        <div class="group-chat-members" style="font-size:12px;color:#666;">Áæ§ËÅä ¬∑ ${window.currentGroupChat.members.length}‰∫∫</div>
                                    </div>
                                    <div style="cursor:pointer;" onclick="showGroupManagementMenu(window.currentGroupChat, this)">
                                        <svg viewBox="0 0 1024 1024" style="height:20px;width:20px;">
                                            <path d="M512 256c-35.3 0-64 28.7-64 64s28.7 64 64 64 64-28.7 64-64-28.7-64-64-64zm0 256c-35.3 0-64 28.7-64 64s28.7 64 64 64 64-28.7 64-64-28.7-64-64-64zm0 256c-35.3 0-64 28.7-64 64s28.7 64 64 64 64-28.7 64-64-28.7-64-64-64z" fill="#666"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div class="msgcontent" style="flex:1;overflow-y:auto;padding:10px;background-color:#f5f5f5;height:calc(100vh - 120px);">
                                    <!-- Áæ§ËÅäÊ∂àÊÅØÂÜÖÂÆπ -->
                                </div>
                                <div class="chat-input" style="padding:10px;background-color:white;border-top:1px solid #eee;display:flex;align-items:center;">
                                    <input type="text" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." style="flex:1;padding:8px 12px;border:1px solid #ddd;border-radius:20px;outline:none;">
                                    <button style="margin-left:10px;padding:8px 16px;background:#007AFF;color:white;border:none;border-radius:20px;cursor:pointer;">ÂèëÈÄÅ</button>
                                </div>
                            </div>
                        `);
                        
                        // Ê∑ªÂä†Âà∞È°µÈù¢
                        $("#App_QQ").append(groupChatPage);
                        
                        // ÊòæÁ§∫Áæ§ËÅäÈ°µÈù¢
                        groupChatPage.show();
                        $("#App_QQ").css("background-color", "#ffffff");
                        
                        // Á´ãÂç≥Âä†ËΩΩÁæ§ËÅäÂéÜÂè≤Ê∂àÊÅØ
                        console.log('ÂáÜÂ§áÂä†ËΩΩÁæ§ËÅäÂéÜÂè≤Ê∂àÊÅØ:', window.currentGroupChat.id);
                        loadGroupChatHistory(window.currentGroupChat.id);
                        
                    } else {
                        // ÊôÆÈÄöËÅäÂ§©È°µÈù¢Â§ÑÁêÜ
                        const chatPage = $(".QQ_chat_page").not('.group-chat-page');
                        if (chatPage.length > 0) {
                            chatPage.first().show();
                            $("#App_QQ").css("background-color", "#ffffff");
                            console.log('ËÅäÂ§©È°µÈù¢Â∑≤ÊòæÁ§∫');
                        } else {
                            console.error('Êú™ÊâæÂà∞ËÅäÂ§©È°µÈù¢ÂÖÉÁ¥†');
                            // Â¶ÇÊûúÊâæ‰∏çÂà∞ËÅäÂ§©È°µÈù¢ÔºåÂõûÈÄÄÂà∞Ê∂àÊÅØÈ°µÈù¢
                            QQ_Nav("message");
                            return;
                        }
                    }
                }
            }

            /**
             * ËøîÂõûÈ¶ñÈ°µ
             */
            function QQ_GoHome() {
                QQ_HideAllChat();
                
                // Â¶ÇÊûúÂΩìÂâçÂú®Áæ§ËÅä‰∏≠ÔºåËøîÂõûÂà∞Êù•Ê∫êÈ°µÈù¢
                if (window.currentGroupChat && window.groupChatSourcePage) {
                    const sourcePage = window.groupChatSourcePage;
                    console.log('‰ªéÁæ§ËÅäËøîÂõûÂà∞Êù•Ê∫êÈ°µÈù¢:', sourcePage);
                    
                    // Ê∏ÖÈô§Áæ§ËÅäÁä∂ÊÄÅ
                    window.currentGroupChat = null;
                    window.groupChatSourcePage = null;
                    
                    // ËøîÂõûÂà∞Êù•Ê∫êÈ°µÈù¢
                    if (sourcePage === 'messages') {
                        QQ_Nav("message");
                    } else {
                        QQ_Nav("people");
                    }
                    return;
                }
                
                // Ê†πÊçÆÂΩìÂâçÈ°µÈù¢Áä∂ÊÄÅËøîÂõûÂà∞Ê≠£Á°ÆÁöÑÈ°µÈù¢
                if (QQ_currentPage === "message") {
                    // Â¶ÇÊûú‰πãÂâçÂú®Ê∂àÊÅØÈ°µÈù¢ÔºåËøîÂõûÂà∞Ê∂àÊÅØÈ°µÈù¢
                    QQ_Nav("message");
                } else if (QQ_currentPage === "moment") {
                    // Â¶ÇÊûú‰πãÂâçÂú®Âä®ÊÄÅÈ°µÈù¢ÔºåËøîÂõûÂà∞Âä®ÊÄÅÈ°µÈù¢
                    QQ_Nav("moment");
                } else {
                    // ÈªòËÆ§ËøîÂõûÂà∞ËÅîÁªú‰∫∫È°µÈù¢
                    QQ_Nav("people");
                }
            }
            /**
             * ÈîôËØØÊèêÁ§∫
             * @param content ÊèêÁ§∫ÂÜÖÂÆπ
             * @param change ÊòØÂê¶Êõ¥Êç¢ÊµèËßàÂô®
             */
            function QQ_Error(content, change) {
                triggerSlash(`/echo severity=error ${content}`);
                if (change) {
                    triggerSlash(`/echo ËØ∑Êõ¥Êç¢ÊµèËßàÂô®ÈáçËØï`);
                }
            }
            /**
             * ÂàùÂßãÂåñ
             */
            async function init() {
                const LorebookSettings = await getLorebookSettings();
                if (
                    LorebookSettings &&
                    LorebookSettings.context_percentage != 100
                ) {
                    console.log(`ËÆæÁΩÆ‰∏ä‰∏ãÊñá!!!!!!!!!!`);
                    await setLorebookSettings({ context_percentage: 100 });
                }
                Verify();
                UserName =
                    (await triggerSlashWithResult("/pass {{user}}")) ?? "";
                $("#QQ_home_UserName").html(`<strong>${UserName}</strong>`);
                $("#QQ_message_list_UserName").html(`<strong>${UserName}</strong>`);
                charAvatarPath =
                    (await triggerSlashWithResult(
                        "/pass {{charAvatarPath}}",
                    )) ?? "";
                userAvatarPath =
                    (await triggerSlashWithResult(
                        "/pass {{userAvatarPath}}",
                    )) ?? "";
                console.log(`Ëé∑ÂèñÂà∞ÁöÑuserÂ§¥ÂÉè:${userAvatarPath}`);
                charcardname =
                    (await triggerSlashWithResult("/pass {{char}}")) ?? "";
                console.log(`ÂºÄÂßãËé∑Âèñ‰∏ñÁïå‰π¶ÈÖçÁΩÆ`);
                try {
                    worldbook = await GetWorldBookName();
                    if (!worldbook) {
                        QQ_Error(`Ëé∑Âèñ‰∏ñÁïå‰π¶Â§±Ë¥•!!!!`);
                    }
                    console.log(`Ëé∑ÂèñÂà∞ÁöÑ‰∏ñÁïå‰π¶ÂêçÂ≠ó:${worldbook}`);
                    entries = await getLorebookEntries(worldbook);
                    if (!entries) {
                        QQ_Error(`Ëé∑Âèñ‰∏ñÁïå‰π¶Êù°ÁõÆÂ§±Ë¥•!!!!`);
                    }
                } catch (e) {
                    QQ_Error(`Âá∫Áé∞ÂºÇÂ∏∏:\n${e}`);
                    console.log(`Ëé∑Âèñ‰∏ñÁïå‰π¶Âá∫Áé∞ÂºÇÂ∏∏:${e}`);
                }
                Variables = await getVariables();
                if (Variables) {
                    if (Variables.Npc_Settings) {
                        try {
                            Npc_Settings = JSON.parse(Variables.Npc_Settings);
                        } catch {
                            QQ_Error("ËØªÂèñNPCÈÖçÁΩÆÂ§±Ë¥•");
                        }
                    }
                }
                // NpcCssValue = Variables.NpcCssValue ?? "";
                // console.log(`È¶ñÊ¨°ËØªÂèñÂà∞ÁöÑNpcCss:\n${NpcCssValue}`);
                $("<style>")
                    .attr("data-name", "AutoNpc")
                    .text("")
                    .appendTo("head");
                System_UpdateNpcCss();
                let Phone_Entry = GetWorldEntry(
                    ["ÊâãÊú∫-ÁïåÈù¢Âü∫Êú¨ËÆæÁΩÆ", "ÊâãÊú∫ÁïåÈù¢Âü∫Êú¨ËÆæÁΩÆ"],
                    true,
                );
                if (Phone_Entry) {
                    Phone_Settings.loadText(Phone_Entry.content);
                }
                DelPadding(); // ÁßªÈô§Â§¥ÂÉèÂíåËæπË∑ù
                await WorldBookUpdate();
                await GetSettings();
                await LoadRandomHead();
                await LoadEmoji();
                await LoadChars();
                await MiPhone_Merge();

                // Áæ§ËÅäÊï∞ÊçÆÂ∑≤Âú®LoadChars‰∏≠Âä†ËΩΩÔºåÊó†ÈúÄÈ¢ùÂ§ñÊÅ¢Â§ç
                
                // *** Êñ∞Â¢ûÔºöÂàùÂßãÂåñÊó∂Âä†ËΩΩÂ∑≤ËØªÁä∂ÊÄÅ ***
                console.log('ÂºÄÂßãÂä†ËΩΩÂ∑≤ËØªÁä∂ÊÄÅ...');
                await QQ_LoadReadStatus();
                
                // *** Êñ∞Â¢ûÔºöÂä†ËΩΩ‰øùÂ≠òÁöÑÂä®ÊÄÅÂÜÖÂÆπ ***
                console.log('ÂºÄÂßãÂä†ËΩΩÂä®ÊÄÅÂÜÖÂÆπ...');
                await QQ_Load_Moments();
                
                // *** Êñ∞Â¢ûÔºöÂàùÂßãÂåñ‰∫íÂä®Á©∫Èó¥Á≥ªÁªü ***
                console.log('ÂºÄÂßãÂàùÂßãÂåñ‰∫íÂä®Á©∫Èó¥Á≥ªÁªü...');
                await QQ_InitInteractiveSystem();
                
                console.log('È°µÈù¢ÂàùÂßãÂåñÂÆåÊàê');
                
                // ‰∏∫ËÅäÂ§©ÂÖÉÁ¥†ÁªëÂÆöÁÇπÂáª‰∫ã‰ª∂
                console.log('ÁªëÂÆöÂ∫ïÈÉ®ÂØºËà™ÁÇπÂáª‰∫ã‰ª∂');
                $(document).on("click", "#QQ_message_nav", () => {
                    console.log('ÁÇπÂáªÊ∂àÊÅØÂØºËà™');
                    QQ_Nav("message");
                });
                $(document).on("click", "#QQ_people_nav", () => {
                    console.log('ÁÇπÂáªËÅîÁ≥ª‰∫∫ÂØºËà™');
                    QQ_Nav("people");
                });
                $(document).on("click", "#QQ_moment_nav", () => {
                    console.log('ÁÇπÂáªÂä®ÊÄÅÂØºËà™');
                    QQ_Nav("moment");
                });
                $(document).on("click", ".QQ-close-btn", () => QQ_GoHome());
                $(document).on("click", ".QQ_home_usermsg", (e) =>
                    QQ_ChangeChatPage(e),
                );
                $(document).on("click", "#QQ_chat_page_setting", (e) =>
                    QQ_SetChatPageSetting(e),
                );
                $(document).on("click", ".close-setting-btn", () =>
                    closeSettingPopup(),
                );
                
                // *** Êñ∞Â¢ûÔºöÂä®ÊÄÅÂà†Èô§Áõ∏ÂÖ≥‰∫ã‰ª∂ÁªëÂÆö ***
                // ÁÇπÂáª‰∏â‰∏™ÁÇπÊòæÁ§∫ËèúÂçï
                $(document).on("click", ".moment_menu_dots", showMomentMenu);
                
                // ÁÇπÂáªËèúÂçïÈ°π
                $(document).on("click", ".moment_menu_item", function(e) {
                    e.stopPropagation();
                    const action = $(this).data('action');
                    const momentId = $(this).data('moment-id');
                    
                    hideMomentMenu();
                    
                    if (action === 'delete') {
                        confirmDeleteMoment(momentId);
                    }
                });
                
                // ÁÇπÂáªÁ°ÆËÆ§Âà†Èô§ÂØπËØùÊ°ÜÊåâÈíÆ
                $(document).on("click", ".moment_dialog_cancel", function() {
                    $('.moment_confirm_dialog').fadeOut(200, function() {
                        $(this).remove();
                    });
                });
                
                $(document).on("click", ".moment_dialog_confirm", async function() {
                    const momentId = $(this).data('moment-id');
                    const success = await QQ_Delete_Moment(momentId);
                    
                    $('.moment_confirm_dialog').fadeOut(200, function() {
                        $(this).remove();
                    });
                    
                    if (success) {
                        // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†ÊàêÂäüÊèêÁ§∫
                        console.log('Âä®ÊÄÅÂà†Èô§ÊàêÂäü');
                    } else {
                        console.error('Âä®ÊÄÅÂà†Èô§Â§±Ë¥•');
                    }
                });
                
                // ÁÇπÂáªÁ©∫ÁôΩÂå∫ÂüüÈöêËóèËèúÂçï
                $(document).on("click", function() {
                    hideMomentMenu();
                });
                
                // Èò≤Ê≠¢ËèúÂçïÂÜÖÁÇπÂáª‰∫ã‰ª∂ÂÜíÊ≥°
                $(document).on("click", ".moment_menu_dropdown", function(e) {
                    e.stopPropagation();
                });
                
                // Èò≤Ê≠¢ÂØπËØùÊ°ÜÂÜÖÁÇπÂáª‰∫ã‰ª∂ÂÜíÊ≥°
                $(document).on("click", ".moment_confirm_dialog > div", function(e) {
                    e.stopPropagation();
                });
                $(document).on("click", "#cancel-setting-btn", () =>
                    closeSettingPopup(),
                );
                $(document).on("click", "#save-setting-btn", () =>
                    saveSettingAndClose(),
                );
                $(document).on(
                    "click",
                    "#randomcolor-setting-btn",
                    function () {
                        const { bgColor, textColor } = generateBubbleColor();
                        $("#bubble-color").val(bgColor);
                        $("#bubble-color-input").val(bgColor);
                        $("#text-color").val(textColor);
                        $("#text-color-input").val(textColor);
                        $("#chat-setting-preview").each(function () {
                            this.style.setProperty(
                                "background-color",
                                bgColor,
                                "important",
                            );
                            const spans = this.querySelectorAll("span");
                            spans.forEach((span) => {
                                span.style.setProperty(
                                    "color",
                                    textColor,
                                    "important",
                                );
                            });
                        });
                    },
                );
                // *** ÂêØÁî®Âä®ÊÄÅËØÑËÆ∫ÂäüËÉΩ ***
            $(document).on("click", ".moment_comment", QQ_Moment_Comment);
            
            // *** Êñ∞Â¢ûÔºöÊîØÊåÅÂõûËΩ¶ÈîÆÂèëÈÄÅËØÑËÆ∫ ***
            $(document).on("keypress", ".user_moment input[type='text']", function(e) {
                if (e.which === 13) { // ÂõûËΩ¶ÈîÆ
                    const $sendButton = $(this).siblings('.moment_comment');
                    if ($sendButton.length > 0) {
                        $sendButton.click();
                    }
                }
            });
                $(document).on("click", "#QQ_chat_send-btn", (event) =>
                    QQ_SendMsg(event),
                );
                $(document).on("dblclick", ".Chat_MyHead", (e) => QQ_Roll(e));
                $(document).on("click", ".QQ_chat_voice", (e) =>
                    QQ_Voice2Text(e),
                );
                $(document).on("click", ".music-container", (e) =>
                    QQ_MusicPlay(e),
                );
                $(document).on("click", ".popup-overlay", function (e) {
                    if (e.target === this) {
                        closeSettingPopup();
                    }
                });
                $(document).on("click", ".top", function () {
                    if ($(".discord").css("display") == "none") {
                        App_Load("discord");
                    } else {
                        App_Load("QQ");
                    }
                });
                $(document).on("click", ".discord-top-return", () =>
                    App_Load("QQ"),
                );
                $(document).on("click", ".app-svg-div[data-app='QQ']", () =>
                    App_Load("QQ"),
                );
                $(document).on(
                    "click",
                    ".app-svg-div[data-app='twitter']",
                    () => App_Load("twitter"),
                );
                // Ê∑ªÂä†ËæìÂÖ•Ê°ÜÂõûËΩ¶‰∫ã‰ª∂ÁõëÂê¨
                $(document).on("keydown", ".userInput", function (e) {
                    QQ_EnterPress(e, this);
                });
                $(document).on(
                    "keydown",
                    ".discord-thread-input-userinput",
                    function (e) {
                        Discord_EnterPress(e, this);
                    },
                );
                $(document).on("click", ".discord-card", (e) =>
                    Discord_LoadThread(e),
                );
                $(document).on(
                    "click",
                    ".discord-thread-top-return",
                    function () {
                        $(".discord-homepage").show();
                        $(".discord-thread-list").hide();
                    },
                );
                $(document).on("click", ".discord-cardget", function () {
                    triggerSlash("/send Êü•ÁúãdiscordÂ∏ñÂ≠êÂÜÖÂÆπ|/trigger");
                });
                $(document).on(
                    "click",
                    ".discord_thread-input-sendbutton",
                    (e) => Discord_Send(e),
                );
                $(document).on(
                    "input",
                    ".discord-thread-input-userinput",
                    (e) => Discord_input(e),
                );
                const message = System_TagCompletion(
                    await ST.GetCurrentMessages(),
                );
                let match = message.match(/msg_start([\s\S]+?)msg_end/);
                if (match) {
                    console.log(
                        `Ëß£ÊûêËÅäÂ§©ËÆ∞ÂΩï!!!!!!!!!!!!!!!\n${match[1].trim()}`,
                    );
                    await QQ_Msg_Parse(match[1].trim());
                    console.log(`ËΩ¨ÂõûÊñáÊú¨ÁöÑÁªìÊûú`, QQ_Json2Text(QQ_msgjson));
                    if (!match[1].match(/\S/)) {
                        // Ê≤°ÊúâÊúâÊïàÂÜÖÂÆπÊâç‰øùÂ≠ò
                        await QQ_Save_Msg();
                    }
                } else {
                    // *** Êñ∞Â¢ûÔºöÂ¶ÇÊûúÊ≤°ÊúâÊâæÂà∞Áé∞ÊúâËÅäÂ§©ËÆ∞ÂΩïÔºåÂ∞ùËØï‰ªéÂ§á‰ªΩÊÅ¢Â§ç ***
                    console.log('Êú™ÊâæÂà∞Áé∞ÊúâËÅäÂ§©ËÆ∞ÂΩïÔºåÂ∞ùËØï‰ªéÂ§á‰ªΩÊÅ¢Â§ç...');
                    const restored = await QQ_Load_Chat_Backup();
                    if (restored) {
                        console.log('ÊàêÂäü‰ªéÂ§á‰ªΩÊÅ¢Â§çËÅäÂ§©Êï∞ÊçÆ');
                        // ÊÅ¢Â§çÂêé‰øùÂ≠òÂà∞Ê∂àÊÅØÁ≥ªÁªü
                        await QQ_Save_Msg();
                    }
                }
                const matches = message.matchAll(
                    /moment_start([\s\S]+?)moment_end/g,
                );
                if (matches) {
                    console.log(`Ëß£ÊûêÂä®ÊÄÅÂÜÖÂÆπ!!!!!!!!!!!!!!!`);
                    for (const m of matches) {
                        QQ_Moment_Parse(m[1].trim());
                    }
                }
                let discords = message.matchAll(
                    /(?:discord_start|<discord>)([\S\s]+?)(?:discord_end|<\/discord>)/g,
                );
                if (discords) {
                    console.log(`Ëß£ÊûêËÆ∫ÂùõÂÜÖÂÆπ!!!!!!!!!!!!!!!`);
                    for (const discord of discords) {
                        Discord_Parse(discord[1]);
                    }
                }
                console.log(`Áæ§ËÅäÂàóË°®:${QQ_Groups.join(",")}`);
                
                // ËÆæÁΩÆÈªòËÆ§ÊòæÁ§∫ËÅîÁªú‰∫∫È°µÈù¢
                console.log('ÂáÜÂ§áËÆæÁΩÆÈªòËÆ§È°µÈù¢‰∏∫ËÅîÁ≥ª‰∫∫');
                setTimeout(() => {
                    console.log('ÊâßË°åÈªòËÆ§È°µÈù¢ÂØºËà™');
                    QQ_Nav("people");
                    QQ_UpdateMessageList();
                    
                    // Âú®È°µÈù¢ÂàáÊç¢ÂíåÊ∂àÊÅØÂàóË°®Êõ¥Êñ∞ÂêéÂàùÂßãÂåñÊêúÁ¥¢ÂäüËÉΩ
                    setTimeout(() => {
                        initContactSearch();
                        console.log("ÊêúÁ¥¢ÂäüËÉΩÂ∑≤ÂàùÂßãÂåñ");
                    }, 300);
                }, 500);
            }
            //space_init();
            console.log(`4.11`);
            init();
            
            
            // Á°Æ‰øùÈ°µÈù¢ÂÆåÂÖ®Âä†ËΩΩÂêéÊõ¥Êñ∞Ê∂àÊÅØÂàóË°®
            setTimeout(() => {
                QQ_UpdateMessageList();
                
                // È¢ùÂ§ñÁöÑÊêúÁ¥¢ÂäüËÉΩÂàùÂßãÂåñÊ£ÄÊü•ÔºàÁî®‰∫éSillyTavernÁéØÂ¢ÉÔºâ
                if (document.getElementById('contact_search_input') && 
                    !document.getElementById('contact_search_input').hasAttribute('data-initialized')) {
                    console.log("ÊâßË°åÈ¢ùÂ§ñÁöÑÊêúÁ¥¢ÂäüËÉΩÂàùÂßãÂåñ");
                    initContactSearch();
                }
            }, 1000);
            async function WorldBookUpdate() {
                let text = {
                    "ÊâãÊú∫-Ê†ºÂºè1-Ê†ºÂºèÂºÄÂ§¥": _1_raw_namespaceObject,
                    "ÊâãÊú∫-Ê†ºÂºè2-QQËÅäÂ§©": _2_QQ_raw_namespaceObject,
                    "ÊâãÊú∫-Ê†ºÂºè3-QQÁ©∫Èó¥": _3_QQ_raw_namespaceObject,
                    "ÊâãÊú∫-Ê†ºÂºè4-discordËÆ∫Âùõ": _4_discord_raw_namespaceObject,
                    "ÊâãÊú∫-Ê†ºÂºè999-Ê†ºÂºèÁªìÂ∞æ": _999_raw_namespaceObject,
                    "ÊâãÊú∫-ÁïåÈù¢Âü∫Êú¨ËÆæÁΩÆ": src_worldbook_raw_namespaceObject_0,
                    // "ÊâãÊú∫-ËßíËâ≤"Êù°ÁõÆ‰∏çÂ∫îËØ•Ë¢´Ëá™Âä®Êõ¥Êñ∞ÔºåÂ∫îËØ•‰øùÁïôÁî®Êà∑ÁöÑÊï∞ÊçÆ
                    "ÊâãÊú∫-ËßíËâ≤": `[a]
Â§¥ÂÉè=http://sharkpan.xyz/f/mQFW/mmexport1736279065029.png
[b]
Â§¥ÂÉè=http://sharkpan.xyz/f/BZsa/mmexport1736279012663.png
[Áõ∏‰∫≤Áõ∏Áà±‰∏ÄÂÆ∂‰∫∫]
Á±ªÂûã=Áæ§ËÅä
ÊàêÂëò=a,b
Â§¥ÂÉè=http://sharkpan.xyz/f/z0WU5/mmexport1736971020657.gif`,
                    "ÊâãÊú∫-Ë°®ÊÉÖÂåÖÂ≠òÊîæ": _worldbook_raw_namespaceObject,
                    "ÊâãÊú∫-ÈöèÊú∫Â§¥ÂÉè": _raw_namespaceObject,
                };
                const nowver = Phone_Settings.readValue(
                    "‰∏ãÈù¢ÊòØÂü∫Êú¨ËÆæÁΩÆ",
                    "‰∏ñÁïå‰π¶ÁâàÊú¨",
                );
                if (nowver && Number(version) <= Number(nowver)) {
                    console.log(`‰∏ñÁïå‰π¶ÁâàÊú¨:${nowver} Á¨¶ÂêàË¶ÅÊ±Ç‰∏çÊõ¥Êñ∞`);
                    return;
                }
                console.log(`‰∏ñÁïå‰π¶ÁâàÊú¨:${nowver}`);
                console.log(`ÂºÄÂßãËá™Âä®Êõ¥Êñ∞‰∏ñÁïå‰π¶`);
                for (let entry of entries) {
                    if (entry.comment == "ÊâãÊú∫-Ê†ºÂºè") {
                        try {
                            await deleteLorebookEntry(worldbook, entry.uid);
                        } catch {
                            console.log(`Âà†Èô§ÊâãÊú∫-Ê†ºÂºè‰∏ñÁïå‰π¶Â§±Ë¥•`);
                        }
                    }
                }
                let ini = new MyINI();
                ini.loadText(worldlistraw_namespaceObject);
                for (const section of ini.getAllSections()) {
                    let targetEntry = entries.find(
                        (entry) => entry.comment == section,
                    );
                    if (targetEntry && ini.readValue(section, "Ë¶ÜÁõñ") != "Áúü") {
                        continue;
                    }
                    if (targetEntry) {
                        console.log(`${section}Â≠òÂú®,ÂºÄÂßã‰øÆÊîπ`);
                        await setLorebookEntries(worldbook, [
                            {
                                uid: targetEntry.uid,
                                content: text[section],
                                key: ini
                                    .readValue(section, "ÂÖ≥ÈîÆËØç")
                                    .split(",")
                                    .map((item) => item.trim()),
                                depth: ini.readValue(section, "Ê∑±Â∫¶"),
                                type:
                                    ini.readValue(section, "Á±ªÂûã") == "ËìùÁÅØ"
                                        ? "constant"
                                        : "selective",
                                exclude_recursion: true,
                                order: Number(ini.readValue(section, "È°∫Â∫è")),
                                enabled: true,
                            },
                        ]);
                        console.log(`${section}‰øÆÊîπÂÆåÊàê`);
                    } else {
                        console.log(`${section}‰∏çÂ≠òÂú®,ÂºÄÂßãÂàõÂª∫`);
                        await createLorebookEntry(worldbook, {
                            comment: section,
                            key: ini
                                .readValue(section, "ÂÖ≥ÈîÆËØç")
                                .split(",")
                                .map((item) => item.trim()),
                            content: text[section],
                            position: "at_depth_as_system",
                            type:
                                ini.readValue(section, "Á±ªÂûã") == "ËìùÁÅØ"
                                    ? "constant"
                                    : "selective",
                            depth: ini.readValue(section, "Ê∑±Â∫¶"),
                            exclude_recursion: true,
                            order: Number(ini.readValue(section, "È°∫Â∫è")),
                            enabled: true,
                        });
                    }
                }
                Phone_Settings.writeValue(
                    "‰∏ãÈù¢ÊòØÂü∫Êú¨ËÆæÁΩÆ",
                    "‰∏ñÁïå‰π¶ÁâàÊú¨",
                    version,
                );
                // for (let entry of entries) {
                //   if (
                //     entry.comment == "ÊâãÊú∫-ÁïåÈù¢Âü∫Êú¨ËÆæÁΩÆ" ||
                //     entry.comment == "ÊâãÊú∫ÁïåÈù¢Âü∫Êú¨ËÆæÁΩÆ"
                //   ) {
                //     await setLorebookEntries(worldbook,
                //       [{
                //         uid: entry.uid,
                //         content: Phone_Settings.getAllText(),
                //       }]
                //     );
                //   }
                // }
                // ÈáçÊñ∞Ëé∑ÂèñÊõ¥Êñ∞ÂêéÁöÑ‰∏ñÁïå‰π¶Êù°ÁõÆ
                entries = await getLorebookEntries(worldbook);
                triggerSlash("/echo severity=success ÊâãÊú∫‰∏ñÁïå‰π¶Ëá™Âä®Êõ¥Êñ∞ÊàêÂäü");
                triggerSlash("/echo severity=success ÁÇπÂáªÊâãÊú∫logoÂèØ‰ª•ÂàáÊç¢È°µÈù¢");
            }
            function System_TagCompletion(content) {
                if (!content) {
                    return "";
                }
                content = content.replace(
                    /<(?:think|thinking)>[\s\S]+?<\/(?:think|thinking)>/gi,
                    "",
                );
                let match = content.match(/moment_end[\s\S]*discord_start/);
                if (!match && content.indexOf("moment_end") > 0) {
                    content = content.replace(
                        "moment_end",
                        "moment_end\ndiscord_start",
                    );
                }
                match = content.match(/MiPhone_start[\s\S]*msg_start/);
                if (!match && content.indexOf("msg_start") > 0) {
                    content = content.replace(
                        "msg_start",
                        "MiPhone_start\nmsg_start",
                    );
                }
                return content;
            }
            function System_AddNpcHead(name, url) {
                if (name in Npc_Settings && Npc_Settings[name].head) {
                    return;
                }
                if (
                    name == UserName ||
                    QQ_CharSettings.getAllSections().includes(name)
                ) {
                    //console.log(`${name}Â∑≤Â≠òÂú®Â§¥ÂÉè,‰∏çÂÜçÈáçÂ§çÊ∑ªÂä†`)
                    return;
                }
                if (name in Npc_Settings == false) {
                    Npc_Settings[name] = {};
                }
                if (!url) {
                    url = QQ_GetRandomHead();
                }
                console.log(`‰∏∫${name}Ê∑ªÂä†Â§¥ÂÉè${url}`);
                Npc_Settings[name].head = url;
                System_UpdateNpcCss();
            }
            function System_UpdateNpcCss() {
                let cssvalue = "";
                for (let key in Npc_Settings) {
                    try {
                        if (
                            "head" in Npc_Settings[key] == false ||
                            !Npc_Settings[key].head
                        ) {
                            Npc_Settings[key].head = QQ_GetRandomHead();
                            //console.log(`Áªô${key}Ê∑ªÂä†ÈöèÊú∫Â§¥ÂÉè:${Npc_Settings[key].head}`);
                        }
                        cssvalue += `\n.head[data-name='${key}'] { background-image: url('${Npc_Settings[key].head}') !important;}`;
                        const { bgColor, textColor } = generateBubbleColor();
                        if (
                            "bubble" in Npc_Settings[key] == false ||
                            !Npc_Settings[key].bubble
                        ) {
                            Npc_Settings[key].bubble = bgColor;
                        }
                        if (
                            "text" in Npc_Settings[key] == false ||
                            !Npc_Settings[key].text
                        ) {
                            Npc_Settings[key].text = textColor;
                        }
                        cssvalue += `\n.QQ_chat_msgdiv[data-name='${key}']{
      background-color: ${Npc_Settings[key].bubble} !important;
      span{
      color: ${textColor} !important;}
      }`;
                    } catch (e) {}
                }
                //console.log(`Êñ∞NpcÁöÑCss:\n${cssvalue}`);
                $(`style[data-name=AutoNpc]`).text(cssvalue);
                insertOrAssignVariables({
                    Npc_Settings: JSON.stringify(Npc_Settings),
                });
            }
            function generateBubbleColor() {
                // ÁîüÊàêËÉåÊôØËâ≤ÂèÇÊï∞ÔºàHSVÊ®°ÂûãÔºâ
                const hueSegments = [0, 60, 120, 180, 240, 300, 360];
                const segmentIndex = Math.floor(Math.random() * 6); // 0-5
                // Âú®ÈÄâÂÆöÁöÑÂå∫Èó¥ÂÜÖÈöèÊú∫ÁîüÊàêËâ≤Áõ∏ÔºàÈÅøÂÖçË∑®Âå∫Èó¥Ê∑∑ÊùÇÔºâ
                const H = hueSegments[segmentIndex] + Math.random() * 60;
                const S = 30 + Math.random() * 40; // È•±ÂíåÂ∫¶ 30%-70%
                const V = 60 + Math.random() * 30; // ‰∫ÆÂ∫¶ 60%-90%
                const bgRgb = hsvToRgb(H, S, V);
                const bgHex = rgbToHex(...bgRgb);
                // ÁîüÊàê‰∫íË°•Ëâ≤
                const complementH = (H + 180) % 360;
                // ÊèêÈ´òÈ•±ÂíåÂ∫¶Âπ∂ÂèçËΩ¨‰∫ÆÂ∫¶
                const textS = Math.min(S + 20, 100); // ÊèêÈ´ò20%È•±ÂíåÂ∫¶
                const textV = 100 - V; // ‰∫ÆÂ∫¶ÂèñÂèç
                const textRgb = hsvToRgb(complementH, textS, textV);
                const textHex = rgbToHex(...textRgb);
                // ËÆ°ÁÆóÂØπÊØîÂ∫¶
                const bgLum = calculateLuminance(bgRgb);
                const textLum = calculateLuminance(textRgb);
                const contrastRatio =
                    (Math.max(bgLum, textLum) + 0.05) /
                    (Math.min(bgLum, textLum) + 0.05);
                // Ê†πÊçÆÂØπÊØîÂ∫¶ËøîÂõûÈ¢úËâ≤ÔºàËá≥Â∞ë4.5:1Ôºâ
                if (contrastRatio >= 4.5) {
                    return { bgColor: bgHex, textColor: textHex };
                } else {
                    // ÂØπÊØîÂ∫¶‰∏çË∂≥Êó∂ÂõûÈÄÄÂà∞ÈªëÁôΩ
                    const textColor = bgLum > 0.5 ? "#000000" : "#FFFFFF";
                    return { bgColor: bgHex, textColor };
                }
            }
            /**
             * ËÆ°ÁÆóÈ¢úËâ≤ÁöÑÁõ∏ÂØπ‰∫ÆÂ∫¶ÔºàËåÉÂõ¥ 0-1Ôºâ
             * ÂÖ¨ÂºèÂèÇËÄÉÔºöWCAG 2.0 Ê†áÂáÜÔºàhttps://www.w3.org/TR/WCAG20/Ôºâ
             */
            function calculateLuminance([r, g, b]) {
                const [R, G, B] = [r, g, b].map((v) => {
                    v /= 255;
                    return v <= 0.03928
                        ? v / 12.92
                        : Math.pow((v + 0.055) / 1.055, 2.4);
                });
                return 0.2126 * R + 0.7152 * G + 0.0722 * B; // ÊùÉÈáçÁ≥ªÊï∞
            }
            function hsvToRgb(h, s, v) {
                h /= 360;
                s /= 100;
                v /= 100; // ÂΩí‰∏ÄÂåñÂà∞ [0,1]
                const i = Math.floor(h * 6);
                const f = h * 6 - i;
                const p = v * (1 - s);
                const q = v * (1 - f * s);
                const t = v * (1 - (1 - f) * s);
                let r, g, b;
                switch (i % 6) {
                    case 0:
                        [r, g, b] = [v, t, p];
                        break;
                    case 1:
                        [r, g, b] = [q, v, p];
                        break;
                    case 2:
                        [r, g, b] = [p, v, t];
                        break;
                    case 3:
                        [r, g, b] = [p, q, v];
                        break;
                    case 4:
                        [r, g, b] = [t, p, v];
                        break;
                    case 5:
                        [r, g, b] = [v, p, q];
                        break;
                }
                // Êâ©Â±ï‰∏∫ 0-255 ÁöÑ RGB ÂÄº
                return [
                    Math.round(r * 255),
                    Math.round(g * 255),
                    Math.round(b * 255),
                ];
            }
            /**
             * RGB ËΩ¨ÂçÅÂÖ≠ËøõÂà∂
             */
            function rgbToHex(...rgb) {
                return (
                    "#" +
                    rgb.map((x) => x.toString(16).padStart(2, "0")).join("")
                );
            }
            function Discord_EnterPress(e, element) {
                if (e.key !== "Enter") {
                    return;
                }
                if (!element) return;
                const value = $(element).val();
                if (!value) {
                    return;
                }
                const $closest = $(element).closest(".discord-thread");
                const id = $closest.attr("data-id");
                const result = `Âú®Â∏ñÂ≠ê${id}‰∏≠ÂõûÂ§ç:\n${value}`;
                triggerSlash(`/send ${result}|/trigger`);
                $(element).val("").trigger("input");
                const commentlist = $closest.find(
                    ".discord-thread-comment-list",
                );
                const comment = _.template(discord_discord_thread_comment)({
                    name: UserName,
                    content: value,
                    creator: "",
                    isuser: " user_avatar",
                });
                commentlist.append(comment);
                const scroll = $closest.find(".discord-scroll-container");
                scroll.scrollTop(scroll[0].scrollHeight);
            }
            function Discord_Send(event) {
                event.stopPropagation();
                if (!event.currentTarget) return;
                const $closest = $(event.currentTarget).closest(
                    ".discord-thread",
                );
                const value = $closest
                    .find(".discord-thread-input-userinput")
                    .val();
                const id = $closest.attr("data-id");
                const result = `Âú®Â∏ñÂ≠ê${id}‰∏≠ÂõûÂ§ç:\n${value}`;
                triggerSlash(`/send ${result}|/trigger`);
                $closest
                    .find(".discord-thread-input-userinput")
                    .val("")
                    .trigger("input");
                const commentlist = $closest.find(
                    ".discord-thread-comment-list",
                );
                const comment = _.template(discord_discord_thread_comment)({
                    name: UserName,
                    content: value,
                    creator: "",
                    isuser: " user_avatar",
                });
                commentlist.append(comment);
                const scroll = $closest.find(".discord-scroll-container");
                scroll.scrollTop(scroll[0].scrollHeight);
            }
            function Discord_Parse(content) {
                const matches = content.matchAll(
                    /<([0-9a-zA-Z]+)>([\s\S+]*?)<\/([0-9a-zA-Z]+)>/g,
                );
                if (!matches) {
                    console.log(`ËÆ∫ÂùõÂåπÈÖçÂ§±Ë¥•,ËøîÂõû!`);
                    return;
                }
                for (const match of matches) {
                    Discord_AddCard(match[1], match[2]);
                }
            }
            function Discord_AddCard(id, content) {
                if (!id) return;
                console.log(`Ê∑ªÂä†ËÆ∫ÂùõÂÜÖÂÆπ!!!!!!!!!`);
                let comment_list;
                let author = "";
                let map = new Map();
                let match = content.match(/<Ê≠£Êñá>([\s\S+]+?)<\/Ê≠£Êñá>/);
                if (!match) {
                    console.log(`ÂåπÈÖçÊ≠£ÊñáÊ†áÁ≠æÂ§±Ë¥•\n${content}`);
                    return;
                }
                let matches = match[1].matchAll(/(.+?)[:Ôºö]\s*(.+)/g);
                for (const m of matches) {
                    if (m[1].trim() == "Â∏ñÂ≠êÊÄªËØÑËÆ∫Êï∞-") {
                        map.set("Â∏ñÂ≠êÊÄªËØÑËÆ∫Êï∞", m[2].trim());
                    } else {
                        map.set(m[1].trim(), m[2].trim());
                    }
                }
                console.log(
                    `ÂåπÈÖçÂà∞ËÆ∫ÂùõÂÜÖÂÆπ:\n${JSON.stringify(Object.fromEntries(map))}`,
                );
                let img = map.get("Â∏ñÂ≠êÈÖçÂõæÊèèËø∞")?.match(/\[img-(.+?)\]/);
                if (img) {
                    map.set("Â∏ñÂ≠êÈÖçÂõæÊèèËø∞", img[1]);
                }
                if (map.get("Â∏ñÂ≠êÊ†áÁ≠æ")) {
                    let tags = map.get("Â∏ñÂ≠êÊ†áÁ≠æ").split("/");
                    let localtag = "";
                    for (const tag of tags) {
                        localtag += `<div class="discord-card-tag">${tag}</div>`;
                    }
                    if (localtag) {
                        map.set("Â∏ñÂ≠êÊ†áÁ≠æ", localtag);
                    }
                }
                const html = _.template(discord_discord_card)({
                    id: id,
                    tag: map.get("Â∏ñÂ≠êÊ†áÁ≠æ"),
                    time: map.get("Ë∑ùÁ¶ªÂèëÂ∏ñËøáÂéªÊó∂Èó¥"),
                    name: map.get("ÂèëÂ∏ñ‰∫∫"),
                    cardtilte: map.get("Â∏ñÂ≠êÊ†áÈ¢ò"),
                    content: map.get("Â∏ñÂ≠êÊ≠£Êñá"),
                    img: map.get("Â∏ñÂ≠êÈÖçÂõæÊèèËø∞"),
                    messages: map.get("Â∏ñÂ≠êÊÄªËØÑËÆ∫Êï∞"),
                    likes: map.get("Â∏ñÂ≠êÊÄªÁÇπËµûÊï∞"),
                });
                $(".discord-cardlist").append(html);
                $(".discord-cardget").hide();
                const thread = _.template(discord_discord_thread)({
                    id: id,
                    tag: map.get("Â∏ñÂ≠êÊ†áÁ≠æ"),
                    time: map.get("Ë∑ùÁ¶ªÂèëÂ∏ñËøáÂéªÊó∂Èó¥"),
                    name: map.get("ÂèëÂ∏ñ‰∫∫"),
                    threadtilte: map.get("Â∏ñÂ≠êÊ†áÈ¢ò"),
                    content: map.get("Â∏ñÂ≠êÊ≠£Êñá"),
                    img: map.get("Â∏ñÂ≠êÈÖçÂõæÊèèËø∞"),
                    messages: map.get("Â∏ñÂ≠êÊÄªËØÑËÆ∫Êï∞"),
                    likes: map.get("Â∏ñÂ≠êÊÄªÁÇπËµûÊï∞"),
                    isuser:
                        map.get("ÂèëÂ∏ñ‰∫∫").trim() == UserName
                            ? " user_avatar"
                            : "",
                });
                System_AddNpcHead(map.get("ÂèëÂ∏ñ‰∫∫") ?? "Êú™Áü•Áî®Êà∑");
                $(".discord-thread-list").append(thread);
                comment_list = $(`.discord-thread[data-id=${id}]`).find(
                    ".discord-thread-comment-list",
                );
                match = content.match(/<ËØÑËÆ∫>([\s\S+]+?)<\/ËØÑËÆ∫>/);
                if (match) {
                    let matches = match[1].matchAll(/^\s*(.+?)--\s*(.+)$/gm);
                    if (matches) {
                        for (let m of matches) {
                            const comment = _.template(
                                discord_discord_thread_comment,
                            )({
                                name: m[1].trim(),
                                content: AtMessage(m[2]),
                                creator:
                                    map.get("ÂèëÂ∏ñ‰∫∫") == m[1] ||
                                    QQ_CharSettings.getAllSections().includes(
                                        m[1],
                                    )
                                        ? " discord-name-creator"
                                        : "",
                                isuser:
                                    m[1].trim() == UserName
                                        ? " user_avatar"
                                        : "",
                            });
                            System_AddNpcHead(m[1]);
                            comment_list.append(comment);
                        }
                    }
                }
            }
            function AtMessage(content) {
                const match = content.match(/(@.{1,8}?) /);
                if (match) {
                    content = content.replace(
                        match[1],
                        `<span style='color:#587ef5'>${match[1]}</span>`,
                    );
                }
                return content;
            }
            function Discord_AddCard_Old(id, content) {
                console.log(`Ê∑ªÂä†ËÆ∫ÂùõÂÜÖÂÆπ!!!!!!!!!`);
                let comment_list;
                let author = "";
                for (const str of content.split(/\r?\n/g)) {
                    let match = str.match(
                        /(.+?)--(.+?)--(.+?)--(.+?)--(.+?)--(.+?)--(.+?)--(.+)/,
                    );
                    if (match) {
                        const html = _.template(discord_card)({
                            id: id,
                            tag: match[5],
                            time: match[6],
                            name: match[1],
                            cardtilte: match[2],
                            content: match[3],
                            img: match[4],
                            messages: match[7],
                            likes: match[8],
                        });
                        $(".discord-cardlist").append(html);
                        const thread = _.template(discord_thread)({
                            id: id,
                            tag: match[5],
                            time: match[6],
                            name: match[1],
                            threadtilte: match[2],
                            content: match[3],
                            img: match[4],
                            messages: match[7],
                            likes: match[8],
                        });
                        System_AddNpcHead(match[1]);
                        $(".discord-thread-list").append(thread);
                        comment_list = $(`.discord-thread[data-id=${id}]`).find(
                            ".discord-thread-comment-list",
                        );
                        author = match[1];
                        continue;
                    }
                    match = str.match(/^(.+?)[:Ôºö](.+)$/m);
                    if (match && comment_list && comment_list.length > 0) {
                        const comment = _.template(discord_thread_comment)({
                            name: match[1],
                            content: match[2],
                            creator:
                                author == match[1]
                                    ? " discord-name-creator"
                                    : "",
                            isuser: match[1] == UserName ? " user_avatar" : "",
                        });
                        System_AddNpcHead(match[1]);
                        comment_list.append(comment);
                    }
                }
            }
            function Discord_LoadThread(event) {
                event.stopPropagation();
                if (!event.currentTarget) return;
                const id = $(event.currentTarget).attr("data-id");
                if (!id) {
                    return;
                }
                let ThreadPage = $(`.discord-thread[data-id=${id}]`);
                if (ThreadPage.length === 0) {
                    return;
                }
                $(`.discord-thread`).hide();
                ThreadPage.show();
                $(".discord-homepage").hide();
                $(".discord-thread-list").show();
            }
            function Discord_input(event) {
                event.stopPropagation();
                if (!event.currentTarget) return;
                if ($(event.currentTarget).val()) {
                    console.log(`ÊòæÁ§∫`);
                    $(".discord-thread-input-button").hide();
                    $(".discord-thread-input-focus-button").show();
                } else {
                    console.log(`ÈöêËóè`);
                    $(".discord-thread-input-button").show();
                    $(".discord-thread-input-focus-button").hide();
                }
            }
            async function QQ_MusicPlay(event) {
                event.stopPropagation();
                if (!event.currentTarget) return;
                const $element = $(event.currentTarget);
                const musicname = $element.find(".music-name")?.text().trim();
                const singer = $element.find(".music-author")?.text().trim();
                if (!musicname) {
                    QQ_Error("Ëé∑ÂèñÊ≠åÊõ≤‰ø°ÊÅØÂ§±Ë¥•");
                    return;
                }
                const $playbutton = $element.find(".icon-music-play");
                const $stopbutton = $element.find(".icon-music-stop");
                // Á´ãÂç≥ÂàáÊç¢ÊåâÈíÆÁä∂ÊÄÅ
                if (!$playbutton.is(":hidden")) {
                    // üî¥ ÂÖàÊîπÂèòÁïåÈù¢Áä∂ÊÄÅ
                    $playbutton.hide();
                    $stopbutton.show();
                    $element.addClass("loading"); // Ê∑ªÂä†Âä†ËΩΩÂä®Áîª
                    QQ_Music.lastelement = $element;
                    try {
                        // ÂºÇÊ≠•Ëé∑ÂèñÈü≥Ê∫ê
                        let source = await WY_MusicGetUrl(musicname, singer);
                        if (!source?.url) {
                            console.log(`ÁΩëÊòì‰∫ëËé∑ÂèñÂ§±Ë¥•,ÂºÄÂßãÂú®QQÈü≥‰πê‰∏≠ÊêúÁ¥¢`);
                            source = await QQ_MusicGetUrl(musicname);
                            if (!source || !source.url) {
                                throw new Error("Êó†ÂèØÁî®Èü≥Ê∫ê");
                            }
                        }
                        // ËÆæÁΩÆÊñ∞Èü≥Ê∫ê
                        QQ_Music.audio.src = source.url;
                        if (source.cover) {
                            $element
                                .find(".music-img")
                                .css(
                                    "background-image",
                                    `url('${source.cover}')`,
                                );
                            $element.find(".music-img").show();
                        }
                        // Ëá™Âä®Êí≠Êîæ
                        await QQ_Music.audio.play();
                        // Êõ¥Êñ∞ÂÖ∂‰ªñÂÖÉÁ¥†Áä∂ÊÄÅ
                        if (
                            QQ_Music.lastelement &&
                            !QQ_Music.lastelement.is($element)
                        ) {
                            QQ_Music.lastelement
                                .find(".icon-music-stop")
                                .hide();
                            QQ_Music.lastelement
                                .find(".icon-music-play")
                                .show();
                        }
                    } catch (error) {
                        console.error("Êí≠ÊîæÂ§±Ë¥•:", error);
                        QQ_Error("Êí≠ÊîæÂ§±Ë¥•");
                        // üî¥ Â§±Ë¥•Êó∂ÂõûÊªöÊåâÈíÆÁä∂ÊÄÅ
                        $playbutton.show();
                        $stopbutton.hide();
                    } finally {
                        $element.removeClass("loading");
                    }
                } else {
                    // ÊöÇÂÅúÈÄªËæë‰øùÊåÅ‰∏çÂèò
                    QQ_Music.audio.pause();
                    $playbutton.show();
                    $stopbutton.hide();
                }
            }
            async function QQ_MusicGetUrl(name) {
                try {
                    // Ëé∑ÂèñÊ≠åÊõ≤ÂàóË°®
                    name = name.replace(/\s/g, "");
                    let cover = "";
                    const result = await Http_Get(
                        `https://api.vkeys.cn/v2/music/tencent?word=${name}`,
                    );
                    if (!result?.data?.length) {
                        QQ_Error("ÊêúÁ¥¢Ê≠åÊõ≤Â§±Ë¥•");
                        return;
                    }
                    // ÊèêÂèñÊâÄÊúâid
                    let ids = [];
                    for (const data of result.data) {
                        if (!cover && data.cover) {
                            cover = data.cover;
                        }
                        if (data.id) {
                            ids.push(data.id);
                        }
                        if (data.grp) {
                            for (const grp of data.grp) {
                                if (grp.id) {
                                    ids.push(grp.id);
                                }
                            }
                        }
                    }
                    console.log(`idÊï∞Èáè:${ids.length}`);
                    // ÈÅçÂéÜÈü≥Ë¥®ÁªÑÊ£ÄÊµãÂèØÁî®Èü≥Ê∫ê
                    for (const id of ids) {
                        try {
                            // Ëé∑ÂèñÂÖ∑‰ΩìÈü≥Ê∫êURL
                            console.log(`ÂáÜÂ§áÊ£ÄÊµãÈü≥Ê∫ê ID:${id}`);
                            const r = await Http_Get(
                                `https://api.vkeys.cn/v2/music/tencent?id=${id}`,
                            );
                            if (!r?.data?.url) continue;
                            // ÂºÇÊ≠•Ê£ÄÊµãÈü≥Ê∫êÂèØÁî®ÊÄß
                            const isAvailable = await checkAudioAvailability(
                                r.data.url,
                            );
                            if (isAvailable) {
                                console.log(`ÊâæÂà∞ÂèØÁî®Èü≥Ê∫ê: ${r.data.url}`);
                                return {
                                    url: r.data.url,
                                    cover: cover,
                                };
                            }
                        } catch (e) {
                            console.warn(`Èü≥Ê∫êÊ£ÄÊµãÂ§±Ë¥•: ${id}`, e);
                        }
                    }
                    QQ_Error("Ê≤°ÊúâÊâæÂà∞ÂèØÁî®Èü≥Ê∫ê");
                } catch (e) {
                    QQ_Error("Ê≠åÊõ≤ÊêúÁ¥¢ÂºÇÂ∏∏");
                    console.error("Ëé∑ÂèñÈü≥Ê∫êÂ§±Ë¥•:", e);
                }
            }
            async function WY_MusicGetUrl(name, singer) {
                let url = `https://api.vkeys.cn/v2/music/netease?word=${name}`;
                if (singer) {
                    url += `-${singer}`;
                }
                let result = await Http_Get(url);
                if (!result) return;
                let cover = "";
                let ids = [];
                for (const data of result.data) {
                    if (!cover && data.cover) {
                        cover = data.cover;
                    }
                    if (data.id) {
                        ids.push(data.id);
                    }
                }
                for (const id of ids) {
                    try {
                        // Ëé∑ÂèñÂÖ∑‰ΩìÈü≥Ê∫êURL
                        console.log(`ÂáÜÂ§áÊ£ÄÊµãÈü≥Ê∫ê ID:${id}`);
                        const r = await Http_Get(
                            `https://api.vkeys.cn/v2/music/netease?id=${id}`,
                        );
                        if (!r?.data?.url) continue;
                        // ÂºÇÊ≠•Ê£ÄÊµãÈü≥Ê∫êÂèØÁî®ÊÄß
                        const isAvailable = await checkAudioAvailability(
                            r.data.url,
                        );
                        if (isAvailable) {
                            console.log(`ÊâæÂà∞ÂèØÁî®Èü≥Ê∫ê: ${r.data.url}`);
                            return {
                                url: r.data.url,
                                cover: cover,
                            };
                        }
                    } catch (e) {
                        console.warn(`Èü≥Ê∫êÊ£ÄÊµãÂ§±Ë¥•: ${id}`, e);
                    }
                }
            }
            /** Èü≥È¢ëÂèØÁî®ÊÄßÊ£ÄÊµãÂáΩÊï∞ */
            async function checkAudioAvailability(url) {
                return new Promise((resolve) => {
                    // ÂàõÂª∫ÊµãËØïÁî®Èü≥È¢ëÂØπË±°
                    const tester = new Audio();
                    let timer;
                    // ÊàêÂäüÂä†ËΩΩÂÖÉÊï∞ÊçÆ
                    const onLoaded = () => {
                        cleanup();
                        resolve(true);
                    };
                    // ÂèëÁîüÈîôËØØÊàñË∂ÖÊó∂
                    const onError = () => {
                        cleanup();
                        resolve(false);
                    };
                    // Ê∏ÖÁêÜ‰∫ã‰ª∂ÁõëÂê¨
                    const cleanup = () => {
                        tester.removeEventListener("loadedmetadata", onLoaded);
                        tester.removeEventListener("error", onError);
                        clearTimeout(timer);
                        tester.src = ""; // ÈáäÊîæËµÑÊ∫ê
                    };
                    // ËÆæÁΩÆÊ£ÄÊµãÂèÇÊï∞
                    tester.preload = "metadata";
                    tester.src = url;
                    timer = setTimeout(onError, 3000); // 3ÁßíË∂ÖÊó∂
                    // ÁªëÂÆö‰∫ã‰ª∂ÁõëÂê¨
                    tester.addEventListener("loadedmetadata", onLoaded);
                    tester.addEventListener("error", onError);
                });
            }
            function Http_Get(url) {
                return new Promise((resolve, reject) => {
                    $.ajax({
                        url: url,
                        method: "GET",
                        timeout: 10000,
                        success: function (data, status) {
                            resolve(data); // ÊàêÂäüÊó∂ËøîÂõûÊï∞ÊçÆ
                        },
                        error: function (xhr, status, error) {
                            if (status === "timeout") {
                                console.error("ËØ∑Ê±ÇË∂ÖÊó∂ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñÈáçËØï");
                            } else {
                                console.error("ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÈîôËØØ‰ø°ÊÅØÔºö", error);
                            }
                            resolve(null);
                            //reject(error); // Â§±Ë¥•Êó∂ÊäõÂá∫ÈîôËØØ
                        },
                    });
                });
            }
            function JsonYamlParse(content) {
                content = content.replace(/\{\{user\}\}/g, UserName);
                try {
                    let json = JSON.parse(content);
                    return json;
                } catch {
                    console.log(`jsonËß£ÊûêÂ§±Ë¥•`);
                }
                try {
                    let simple = Simpleformat(content);
                    if (simple) {
                        console.log(`ÁÆÄÂçïÊ†ºÂºèËΩ¨Êç¢ÊàêÂäü:\n${simple}`);
                        return simple;
                    } else {
                        console.log(`ÁÆÄÂçïËΩ¨Êç¢Â§±Ë¥•`);
                    }
                } catch {}
                try {
                    let yaml = YAML.parse(content);
                    console.log(`yamlËß£ÊûêÊàêÂäü`);
                    return yaml;
                } catch {
                    //console.log(`yamlËß£ÊûêÂ§±Ë¥•:\n${content}`);
                }
                try {
                    content = content.replace(/^\s*Áæ§ËÅä:/m, "Áæ§ËÅä:");
                    content = content.replace(/^\s*ÁßÅËÅä:/m, "ÁßÅËÅä:");
                    content = fixYamlSingleQuotes(content);
                    //console.log(`Á¨¨‰∏ÄÊ¨°‰øÆÂ§çÂêéÁöÑyamlÊñáÊú¨:\n${content}`);
                    if (!content) {
                        return null;
                    }
                    let yaml = YAML.parse(content);
                    return yaml;
                } catch {
                    console.log(`Á¨¨‰∏ÄÊ¨°yaml‰øÆÂ§çÂ§±Ë¥•`);
                }
                try {
                    content = fixYamlSingleQuotes(
                        content.replace(/\\'/g, "''"),
                    );
                    //console.log(`Á¨¨‰∫åÊ¨°‰øÆÂ§çÂêéÁöÑyamlÊñáÊú¨:\n${content}`);
                    if (!content) {
                        return null;
                    }
                    let yaml = YAML.parse(content);
                    return yaml;
                } catch {
                    console.log(`Á¨¨‰∫åÊ¨°yaml‰øÆÂ§çÂ§±Ë¥•`);
                }
                try {
                    content = content.replace(/, /g, "\r\n    - ");
                    content = content.replace(/\['/g, "\r\n    - '");
                    content = content.replace(/'\]/g, "'");
                    content = fixYamlSingleQuotes(content);
                    //console.log(`Á¨¨‰∏âÊ¨°‰øÆÂ§çÂêéÁöÑyamlÊñáÊú¨:\n${content}`);
                    if (!content) {
                        return null;
                    }
                    let yaml = YAML.parse(content);
                    return yaml;
                } catch {
                    return null;
                }
            }
            function Simpleformat(content) {
                let json = {
                    ÁßÅËÅä: {},
                    Áæ§ËÅä: {},
                };
                // Ê∑ªÂä†ÁßÅËÅäÊ∂àÊÅØ
                let matches = content.matchAll(
                    /<(.+?)Âíå(.+?)ÁöÑÁßÅËÅä>([\s\S]+?)<\/(.+?)Âíå(.+?)ÁöÑÁßÅËÅä>/g,
                );
                if (matches) {
                    for (const match of matches) {
                        if (match[1] != match[4] || match[2] != match[5]) {
                            QQ_Error("ÁßÅËÅäÊ†áÁ≠æÈó≠ÂêàÂºÇÂ∏∏,ËØ∑ÊâãÂä®‰øÆÂ§ç");
                        }
                        const key = `${match[1]}Âíå${match[2]}ÁöÑËÅäÂ§©`;
                        json.ÁßÅËÅä[key] = [];
                        for (let line of match[3].split(/\r?\n/)) {
                            line = line.trim();
                            if (line) {
                                let m = line.match(
                                    /(.+?)\s*(?:--|:|Ôºö)\s*(.+)/,
                                );
                                if (!m) {
                                    continue;
                                }
                                let message = m[2];
                                if (message.split("--").length >= 2) {
                                    message = message.split("--")[0];
                                }
                                json.ÁßÅËÅä[key].push(`${m[1]}--${m[2]}`);
                            }
                        }
                    }
                }
                // Ê∑ªÂä†Áæ§ËÅäÊ∂àÊÅØ
                matches = content.matchAll(
                    /<Áæ§ËÅä[:Ôºö](.+?)>([\s\S]+?)<\/Áæ§ËÅä[:Ôºö](.+?)>/g,
                );
                if (matches) {
                    for (const match of matches) {
                        if (match[1] != match[3]) {
                            QQ_Error("Áæ§ËÅäÊ†áÁ≠æÈó≠ÂêàÂºÇÂ∏∏,ËØ∑ÊâãÂä®‰øÆÂ§ç");
                        }
                        json.Áæ§ËÅä[match[1]] = {};
                        json.Áæ§ËÅä[match[1]].members = [];
                        json.Áæ§ËÅä[match[1]].msgs = [];
                        let m = match[2].match(/<ÊàêÂëò>([\S\s]+?)<\/ÊàêÂëò>/);
                        if (m) {
                            let members = m[1]
                                .split(",")
                                .map((item) => item.trim());
                            json.Áæ§ËÅä[match[1]].members = members;
                        }
                        m = match[2].match(/<ËÅäÂ§©ÂÜÖÂÆπ>([\S\s]+?)<\/ËÅäÂ§©ÂÜÖÂÆπ>/);
                        if (m) {
                            for (let message of m[1].split(/\r?\n/)) {
                                message = message.trim();
                                if (message) {
                                    let regex = message.match(
                                        /(.+?)\s*(?:--|:|Ôºö)\s*(.+)/,
                                    );
                                    if (!regex) {
                                        continue;
                                    }
                                    let content = regex[2];
                                    if (content.split("--").length >= 2) {
                                        content = content.split("--")[0];
                                    }
                                    json.Áæ§ËÅä[match[1]].msgs.push(
                                        `${regex[1]}--${regex[2]}`,
                                    );
                                }
                            }
                        }
                    }
                }
                console.log(`ÁÆÄÂçïÊ†ºÂºèËΩ¨Êç¢:${JSON.stringify(json)}`);
                return json;
            }
            function fixYamlSingleQuotes(yamlText) {
                try {
                    return yamlText.replace(
                        /(- ')(.*?[^\\])(')(?=\s*#|$)/gm,
                        (match, prefix, content, suffix) => {
                            // ‰ΩøÁî®‰∏âÊ≠•Â§ÑÁêÜÊ≥ï‰øùËØÅÂ∑≤ÊúâËΩ¨‰πâ‰∏çÂèò
                            const escaped = content
                                .replace(/''/g, "\uE000") // Ê≠•È™§1ÔºöÁî®‰∏¥Êó∂UnicodeÂç†‰ΩçÁ¨¶‰øùÂ≠òÂ∑≤ÊúâÂèåÂºïÂè∑
                                .replace(/'/g, "''") // Ê≠•È™§2ÔºöËΩ¨‰πâÊâÄÊúâÂâ©‰ΩôÂçïÂºïÂè∑
                                .replace(/\uE000/g, "''"); // Ê≠•È™§3ÔºöÊÅ¢Â§çÂéüÊúâÂèåÂºïÂè∑
                            return `${prefix}${escaped}${suffix}`;
                        },
                    );
                } catch (e) {
                    QQ_Error(`${e}`);
                    return "";
                }
            }
            async function MiPhone_Merge() {
                let messages = await ST.GetCurrentMessages();
                messages = messages.replace(
                    /<(?:think|thinking)>[\s\S]+?<\/(?:think|thinking)>/gi,
                    "",
                );
                const matches = messages.matchAll(
                    /MiPhone_start([\s\S]+?)MiPhone_end/g,
                );
                if (!matches) {
                    return;
                }
                const matchesArray = [...matches];
                const length = matchesArray.length;
                console.log(`ÂåπÈÖçÂà∞Êï∞Èáè:${length}`);
                if (length <= 1) {
                    return;
                }
                for (let i = 0; i < matchesArray.length; i++) {
                    const value = matchesArray[i][0];
                    console.log(`value:\n${value}`);
                    const msg = value.match(/msg_start([\s\S]+?)msg_end/);
                    if (msg) {
                        let json;
                        try {
                            json = JsonYamlParse(msg[1]);
                            if (json) {
                                json = QQ_Msg_DeletOld(json);
                                await QQ_Msg_Parse(JSON.stringify(json));
                            }
                        } catch {}
                    }
                    if (i != matchesArray.length - 1) {
                        messages = messages.replace(value, "");
                    } else {
                        if (msg) {
                            const lovalvalue = value.replace(
                                msg[0],
                                `msg_start\n${QQ_Json2Text(QQ_msgjson)}\nmsg_end`,
                            );
                            messages = messages.replace(value, lovalvalue);
                        } else {
                            messages = messages.replace(
                                "MiPhone_start",
                                `msg_start\n${QQ_Json2Text(QQ_msgjson)}\nmsg_end`,
                            );
                        }
                    }
                }
                triggerSlash("/echo Â≠òÂú®Â§ö‰∏™Ê†ºÂºè,Ëá™Âä®ÂêàÂπ∂");
                triggerSlash(
                    "/echo ÂêàÂπ∂Âè™‰ºö‰øùÁïôËÅäÂ§©ÂÜÖÂÆπ,Âä®ÊÄÅÂíåËÆ∫Âùõ‰ºö‰∏¢Â§±!!!!!",
                );
                const CurrentMessageId = await getCurrentMessageId();
                setChatMessage({ message: messages }, CurrentMessageId);
            }
            /**
             * *** Êñ∞Â¢ûÔºö‰ªéworldbookÂä†ËΩΩÂä®ÊÄÅÂÜÖÂÆπ ***
             */
            async function QQ_Load_Moments() {
                if (!worldbook || !entries) {
                    console.log('Âä®ÊÄÅÂä†ËΩΩË∑≥ËøáÔºöÁº∫Â∞ëworldbookÊàñentries');
                    return;
                }
                
                try {
                    const momentEntry = entries.find(entry => entry.comment === "ÊâãÊú∫-Âä®ÊÄÅÂÜÖÂÆπÂ≠òÂÇ®");
                    
                    if (momentEntry && momentEntry.content) {
                        // Ëß£Êûê‰øùÂ≠òÁöÑÂä®ÊÄÅÊï∞ÊçÆ
                        const savedMoments = JSON.parse(momentEntry.content);
                        
                        // Á°Æ‰øùÊØè‰∏™Âä®ÊÄÅÈÉΩÊúâÁÇπËµûÊï∞ÊçÆÁªìÊûÑ
                        QQ_MomentsData = savedMoments.map(moment => {
                            if (!moment.likes) {
                                moment.likes = {
                                    count: parseInt(moment.extraContent) || 0,
                                    userLiked: false,
                                    likedBy: [],
                                    lastLikeTime: null
                                };
                            }
                            return moment;
                        });
                        
                        window.QQ_MomentsData = QQ_MomentsData; // Êõ¥Êñ∞ÂÖ®Â±ÄÂºïÁî®
                        
                        console.log('ÊàêÂäüÂä†ËΩΩÂä®ÊÄÅÂÜÖÂÆπ:', QQ_MomentsData.length, 'Êù°Âä®ÊÄÅ');
                        
                        // ÈáçÊñ∞Ê∏≤ÊüìÂä®ÊÄÅÁïåÈù¢
                        await QQ_Render_Moments();
                    } else {
                        console.log('Êú™ÊâæÂà∞‰øùÂ≠òÁöÑÂä®ÊÄÅÂÜÖÂÆπ');
                    }
                } catch (error) {
                    console.error('Âä†ËΩΩÂä®ÊÄÅÂÜÖÂÆπÂ§±Ë¥•:', error);
                }
            }
            
            /**
             * *** Êñ∞Â¢ûÔºö‰ªéworldbookÂä†ËΩΩËÅäÂ§©Ê∂àÊÅØÂ§á‰ªΩ ***
             */
            async function QQ_Load_Chat_Backup() {
                if (!worldbook || !entries) {
                    console.log('ËÅäÂ§©Â§á‰ªΩÂä†ËΩΩË∑≥ËøáÔºöÁº∫Â∞ëworldbookÊàñentries');
                    return false;
                }
                
                try {
                    const chatBackupEntry = entries.find(entry => entry.comment === "ÊâãÊú∫-ËÅäÂ§©Ê∂àÊÅØÂ§á‰ªΩ");
                    
                    if (chatBackupEntry && chatBackupEntry.content) {
                        // Ëß£Êûê‰øùÂ≠òÁöÑËÅäÂ§©Â§á‰ªΩÊï∞ÊçÆ
                        const backupData = JSON.parse(chatBackupEntry.content);
                        
                        if (backupData.data && (backupData.data.ÁßÅËÅä || backupData.data.Áæ§ËÅä)) {
                            // Ê£ÄÊü•ÊòØÂê¶Â∫îËØ•‰ΩøÁî®Â§á‰ªΩÊï∞ÊçÆ
                            const backupTime = new Date(backupData.lastUpdated);
                            const timeDiff = Date.now() - backupTime.getTime();
                            
                            console.log('ÊâæÂà∞ËÅäÂ§©Â§á‰ªΩÊï∞ÊçÆÔºåÂ§á‰ªΩÊó∂Èó¥:', backupData.lastUpdated);
                            console.log('Â§á‰ªΩÊï∞ÊçÆÂåÖÂê´:', Object.keys(backupData.data.ÁßÅËÅä || {}).length, '‰∏™ÁßÅËÅä,', Object.keys(backupData.data.Áæ§ËÅä || {}).length, '‰∏™Áæ§ËÅä');
                            
                            // Â¶ÇÊûúÂΩìÂâçQQ_msgjson‰∏∫Á©∫ÊàñÊï∞ÊçÆÂæàÂ∞ëÔºå‰ΩøÁî®Â§á‰ªΩÊÅ¢Â§ç
                            const currentPrivateChats = Object.keys(QQ_msgjson?.ÁßÅËÅä || {}).length;
                            const currentGroupChats = Object.keys(QQ_msgjson?.Áæ§ËÅä || {}).length;
                            const backupPrivateChats = Object.keys(backupData.data.ÁßÅËÅä || {}).length;
                            const backupGroupChats = Object.keys(backupData.data.Áæ§ËÅä || {}).length;
                            
                            // Â¶ÇÊûúÂ§á‰ªΩÊï∞ÊçÆÊØîÂΩìÂâçÊï∞ÊçÆÊõ¥‰∏∞ÂØåÔºåÊàñËÄÖÊó∂Èó¥Â∑Æ‰∏çË∂ÖËøá1Â∞èÊó∂ÔºåÂàôÊÅ¢Â§çÂ§á‰ªΩ
                            if ((backupPrivateChats > currentPrivateChats || backupGroupChats > currentGroupChats) && timeDiff < 3600000) {
                                console.log('ÊÅ¢Â§çËÅäÂ§©Â§á‰ªΩÊï∞ÊçÆ...');
                                QQ_msgjson = JSON.parse(JSON.stringify(backupData.data)); // Ê∑±Êã∑Ë¥ù
                                QQ_ChatBackup = backupData;
                                window.QQ_ChatBackup = QQ_ChatBackup; // Êõ¥Êñ∞ÂÖ®Â±ÄÂºïÁî®
                                
                                console.log('ÊàêÂäüÊÅ¢Â§çËÅäÂ§©Â§á‰ªΩÊï∞ÊçÆ:', Object.keys(QQ_msgjson.ÁßÅËÅä || {}).length, '‰∏™ÁßÅËÅä,', Object.keys(QQ_msgjson.Áæ§ËÅä || {}).length, '‰∏™Áæ§ËÅä');
                                return true;
                            } else {
                                console.log('ÂΩìÂâçËÅäÂ§©Êï∞ÊçÆËæÉÊñ∞ÊàñÊõ¥ÂÆåÊï¥Ôºå‰∏ç‰ΩøÁî®Â§á‰ªΩ');
                                return false;
                            }
                        }
                    } else {
                        console.log('Êú™ÊâæÂà∞ËÅäÂ§©Â§á‰ªΩÊï∞ÊçÆ');
                        return false;
                    }
                } catch (error) {
                    console.error('Âä†ËΩΩËÅäÂ§©Â§á‰ªΩÂ§±Ë¥•:', error);
                    return false;
                }
            }

            /**
             * *** Êñ∞Â¢ûÔºöÊ∏≤ÊüìÂä®ÊÄÅÂÜÖÂÆπÂà∞ÁïåÈù¢ (ÊîØÊåÅÂàÜÈ°µ) ***
             */
            async function QQ_Render_Moments(loadMore = false) {
                const $spaceContents = $("#space_contents");
                
                if (QQ_MomentsData.length === 0) {
                    console.log('Ê≤°ÊúâÂä®ÊÄÅÂÜÖÂÆπÈúÄË¶ÅÊ∏≤Êüì');
                    momentsDisplayCount = 0;
                    return;
                }

                // È¶ñÊ¨°Âä†ËΩΩÊàñÈùûÂä†ËΩΩÊõ¥Â§öÊó∂Ê∏ÖÁ©∫ÂÜÖÂÆπ
                if (!loadMore) {
                    $spaceContents.empty();
                    momentsDisplayCount = 0;
                }
                
                // ÊåâÊó∂Èó¥Êà≥ÂÄíÂ∫èÊéíÂàóÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÔºâ
                const sortedMoments = [...QQ_MomentsData].sort((a, b) => {
                    return new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime();
                });

                // Á°ÆÂÆöË¶ÅÊòæÁ§∫ÁöÑÂä®ÊÄÅËåÉÂõ¥
                const startIndex = momentsDisplayCount;
                const endIndex = Math.min(startIndex + (loadMore ? MOMENTS_LOAD_INCREMENT : MOMENTS_DISPLAY_LIMIT), sortedMoments.length);
                const momentsToShow = sortedMoments.slice(startIndex, endIndex);
                
                for (const momentData of momentsToShow) {
                    try {
                        const momentDiv = $("<div>", { 
                            class: "user_moment",
                            "data-moment-id": momentData.id // Ê∑ªÂä†Âä®ÊÄÅIDÂ±ûÊÄß
                        });
                        momentDiv.html(
                            _.template(moment_page)({
                                userName: momentData.userName,
                                message: momentData.message,
                                timestamp: momentData.timestampText,
                                additionalInfo: momentData.additionalInfo,
                                randomPhone: momentData.randomPhone,
                                extraContent: momentData.likes ? momentData.likes.count : 0, // ‰øÆÊ≠£ÔºöÁÇπËµûÊï∞Áî®‰∫éextraContent
                                imgcontent: momentData.imgcontent || '',
                                momentId: momentData.id, // ‰º†ÈÄíÂä®ÊÄÅIDÂà∞Ê®°Êùø
                                // Êñ∞Â¢ûÔºöÁÇπËµûÁõ∏ÂÖ≥Êï∞ÊçÆ
                                likeCount: momentData.likes ? momentData.likes.count : 0,
                                likedByUser: momentData.likes ? momentData.likes.userLiked : false
                            })
                        );
                        
                        // *** Ê∏≤ÊüìËØÑËÆ∫Ôºà‰ΩøÁî®Êñ∞ÁöÑÊäòÂè†Á≥ªÁªüÔºâ ***
                        const commentsList = momentDiv.find(".user_leave_message_list");
                        QQ_Render_Comments(momentData, commentsList);
                        
                        $spaceContents.append(momentDiv);
                    } catch (error) {
                        console.error('Ê∏≤ÊüìÂä®ÊÄÅÂ§±Ë¥•:', error, momentData);
                    }
                }

                // Êõ¥Êñ∞ÊòæÁ§∫ËÆ°Êï∞
                momentsDisplayCount = endIndex;

                // Ê∑ªÂä†ÊàñÊõ¥Êñ∞"Êü•ÁúãÊõ¥Â§ö"ÊåâÈíÆ
                QQ_Update_Moments_LoadMore(sortedMoments.length);
                
                // ÂàùÂßãÂåñÁÇπËµûÊåâÈíÆ‰∫ã‰ª∂ÁªëÂÆöÔºàÂ¶ÇÊûúËøòÊ≤°ÊúâÂàùÂßãÂåñÔºâ
                if (typeof QQ_InitMomentLikes === 'function') {
                    QQ_InitMomentLikes();
                }
                
                // Âä†ËΩΩÁÇπËµûÁä∂ÊÄÅ
                if (typeof QQ_LoadMomentLikes === 'function') {
                    await QQ_LoadMomentLikes();
                }
                
                console.log(`Âä®ÊÄÅÂÜÖÂÆπÊ∏≤ÊüìÂÆåÊàêÔºåÊòæÁ§∫ ${momentsDisplayCount}/${sortedMoments.length} Êù°`);
            }

            /**
             * *** Êõ¥Êñ∞Âä®ÊÄÅ"Êü•ÁúãÊõ¥Â§ö"ÊåâÈíÆ ***
             */
            function QQ_Update_Moments_LoadMore(totalMoments) {
                const $spaceContents = $("#space_contents");
                const loadMoreId = 'moments-load-more';
                
                // ÁßªÈô§ÊóßÁöÑÂä†ËΩΩÊõ¥Â§öÊåâÈíÆ
                $(`#${loadMoreId}`).remove();
                
                // Â¶ÇÊûúËøòÊúâÊõ¥Â§öÂä®ÊÄÅÈúÄË¶ÅÊòæÁ§∫ÔºåÊ∑ªÂä†ÊåâÈíÆ
                if (momentsDisplayCount < totalMoments) {
                    const loadMoreBtn = $(`
                        <div id="${loadMoreId}" style="text-align: center; padding: 20px 0; color: #999; font-size: 12px; cursor: pointer; border-top: 1px solid #e5e5e5; margin-top: 10px;">
                            --ÁÇπÂáªÊü•ÁúãÊõ¥Â§ö--
                        </div>
                    `);
                    
                    loadMoreBtn.on('click', async function() {
                        $(this).text('Âä†ËΩΩ‰∏≠...');
                        try {
                            await QQ_Render_Moments(true);  // Âä†ËΩΩÊõ¥Â§ö
                        } catch (error) {
                            console.error('Âä†ËΩΩÊõ¥Â§öÂä®ÊÄÅÂ§±Ë¥•:', error);
                            $(this).text('Âä†ËΩΩÂ§±Ë¥•ÔºåÁÇπÂáªÈáçËØï');
                        }
                    });
                    
                    $spaceContents.append(loadMoreBtn);
                }
            }

            /**
             * *** ËÅäÂ§©Ê∂àÊÅØÂàÜÈ°µÂä†ËΩΩÂáΩÊï∞ ***
             */
            async function QQ_Load_Chat_History(chatName, msgContainer) {
                const isGroup = QQ_Groups.includes(chatName);
                let allMessages = [];
                
                // Ëé∑ÂèñÊâÄÊúâÂéÜÂè≤Ê∂àÊÅØ
                if (isGroup && QQ_msgjson.Áæ§ËÅä[chatName] && QQ_msgjson.Áæ§ËÅä[chatName].msgs) {
                    allMessages = [...QQ_msgjson.Áæ§ËÅä[chatName].msgs];
                } else if (!isGroup && QQ_msgjson.ÁßÅËÅä[`${UserName}Âíå${chatName}ÁöÑËÅäÂ§©`]) {
                    allMessages = [...QQ_msgjson.ÁßÅËÅä[`${UserName}Âíå${chatName}ÁöÑËÅäÂ§©`]];
                }
                
                // Ëé∑ÂèñÂΩìÂâçÊòæÁ§∫ÁöÑÊ∂àÊÅØÊï∞Èáè
                const currentDisplayed = chatDisplayCounts[chatName] || 0;
                const totalMessages = allMessages.length;
                
                if (currentDisplayed >= totalMessages) {
                    console.log('Ê≤°ÊúâÊõ¥Â§öÂéÜÂè≤Ê∂àÊÅØ');
                    return false;
                }
                
                // ËÆ°ÁÆóË¶ÅÂä†ËΩΩÁöÑÊ∂àÊÅØËåÉÂõ¥Ôºà‰ªéÂéÜÂè≤ÂæÄÂâçÂÄíÊé®Ôºâ
                const loadCount = Math.min(CHAT_LOAD_INCREMENT, totalMessages - currentDisplayed);
                const startIndex = Math.max(0, totalMessages - currentDisplayed - loadCount);
                const endIndex = totalMessages - currentDisplayed;
                const messagesToLoad = allMessages.slice(startIndex, endIndex);
                
                console.log(`ÂáÜÂ§áÂä†ËΩΩÂéÜÂè≤Ê∂àÊÅØ: ${startIndex}-${endIndex}, ÂÖ±${loadCount}Êù°`);
                
                // Ëé∑ÂèñÂΩìÂâçÁ¨¨‰∏Ä‰∏™Ê∂àÊÅØÂÖÉÁ¥†ÔºåÁî®‰∫éÊèíÂÖ•‰ΩçÁΩÆ
                const $firstMsg = $(msgContainer).children().not('.load-more-messages').first();
                
                // ÂÄíÂ∫èÊ∑ªÂä†Ê∂àÊÅØÂà∞È°∂ÈÉ®Ôºà‰øùÊåÅÊó∂Èó¥È°∫Â∫èÔºâ
                for (let i = messagesToLoad.length - 1; i >= 0; i--) {
                    const msg = messagesToLoad[i];
                    const tempDiv = $('<div>');
                    
                    // ‰ΩøÁî®‰øÆÊîπÂêéÁöÑQQ_Chat_AddMsgÊ∑ªÂä†Ê∂àÊÅØÔºåË∑≥ËøáÊªöÂä®ÂíåËÆ°Êï∞
                    QQ_Chat_AddMsg(tempDiv[0], msg, chatName, false, true);
                    
                    // Â∞ÜÊ∂àÊÅØÊèíÂÖ•Âà∞ÂÆπÂô®È°∂ÈÉ®
                    if ($firstMsg.length > 0) {
                        $firstMsg.before(tempDiv.html());
                    } else {
                        $(msgContainer).prepend(tempDiv.html());
                    }
                }
                
                // Êõ¥Êñ∞ÊòæÁ§∫ËÆ°Êï∞
                chatDisplayCounts[chatName] = (chatDisplayCounts[chatName] || 0) + loadCount;
                
                console.log(`ÂéÜÂè≤Ê∂àÊÅØÂä†ËΩΩÂÆåÊàêÔºåÂΩìÂâçÊòæÁ§∫: ${chatDisplayCounts[chatName]}/${totalMessages}`);
                return chatDisplayCounts[chatName] < totalMessages; // ËøîÂõûÊòØÂê¶ËøòÊúâÊõ¥Â§öÊ∂àÊÅØ
            }

            /**
             * *** Êõ¥Êñ∞ËÅäÂ§©"Âä†ËΩΩÊõ¥Â§ö"ÊåâÈíÆ ***
             */
            function QQ_Update_Chat_LoadMore(chatName, msgContainer) {
                const $container = $(msgContainer);
                const loadMoreId = `chat-load-more-${chatName.replace(/[^a-zA-Z0-9]/g, '_')}`;
                
                // ÁßªÈô§ÊóßÁöÑÂä†ËΩΩÊõ¥Â§öÊåâÈíÆ
                $(`.load-more-messages`).remove();
                
                // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊòæÁ§∫Âä†ËΩΩÊõ¥Â§öÊåâÈíÆ
                const isGroup = QQ_Groups.includes(chatName);
                let totalMessages = 0;
                
                if (isGroup && QQ_msgjson.Áæ§ËÅä[chatName] && QQ_msgjson.Áæ§ËÅä[chatName].msgs) {
                    totalMessages = QQ_msgjson.Áæ§ËÅä[chatName].msgs.length;
                } else if (!isGroup && QQ_msgjson.ÁßÅËÅä[`${UserName}Âíå${chatName}ÁöÑËÅäÂ§©`]) {
                    totalMessages = QQ_msgjson.ÁßÅËÅä[`${UserName}Âíå${chatName}ÁöÑËÅäÂ§©`].length;
                }
                
                const currentDisplayed = chatDisplayCounts[chatName] || 0;
                
                // Âè™ÊúâÂΩìÊ∂àÊÅØÊï∞ÈáèË∂ÖËøáÊòæÁ§∫ÈôêÂà∂‰∏îËøòÊúâÂéÜÂè≤Ê∂àÊÅØÊó∂ÊâçÊòæÁ§∫ÊåâÈíÆ
                if (totalMessages > CHAT_DISPLAY_LIMIT && currentDisplayed < totalMessages) {
                    const loadMoreBtn = $(`
                        <div id="${loadMoreId}" class="load-more-messages" style="text-align: center; padding: 15px 0; color: #999; font-size: 12px; cursor: pointer; border-bottom: 1px solid #e5e5e5; margin-bottom: 10px; background-color: #f9f9f9;">
                            --ÁÇπÂáªÂä†ËΩΩÊõ¥Â§ö--
                        </div>
                    `);
                    
                    loadMoreBtn.on('click', async function() {
                        $(this).text('Âä†ËΩΩ‰∏≠...');
                        try {
                            const hasMore = await QQ_Load_Chat_History(chatName, msgContainer);
                            if (!hasMore) {
                                $(this).text('Ê≤°ÊúâÊõ¥Â§öÊ∂àÊÅØ‰∫Ü').css('color', '#ccc').off('click');
                                setTimeout(() => $(this).fadeOut(), 2000);
                            } else {
                                $(this).text('--ÁÇπÂáªÂä†ËΩΩÊõ¥Â§ö--');
                            }
                        } catch (error) {
                            console.error('Âä†ËΩΩÊõ¥Â§öËÅäÂ§©Ê∂àÊÅØÂ§±Ë¥•:', error);
                            $(this).text('Âä†ËΩΩÂ§±Ë¥•ÔºåÁÇπÂáªÈáçËØï');
                        }
                    });
                    
                    // Â∞ÜÊåâÈíÆÊèíÂÖ•Âà∞ÂÆπÂô®È°∂ÈÉ®
                    $container.prepend(loadMoreBtn);
                }
            }

            /**
             * ÂàùÂßãÂåñÂä®ÊÄÅÁ©∫Èó¥ÂÜÖÂÆπ
             */
            function space_init() {
                $("#space_contents").prepend(space_contents);
                // *** ‰øÆÊîπÔºöÂàùÂßãÂåñÊó∂Âä†ËΩΩ‰øùÂ≠òÁöÑÂä®ÊÄÅÂÜÖÂÆπ ***
                setTimeout(() => {
                    QQ_Load_Moments();
                }, 500);
            }
            async function GetWorldBookName() {
                let localbook;
                try {
                    localbook = await getCurrentCharPrimaryLorebook();
                    console.log(
                        `ËßíËâ≤Âç°ÁªëÂÆö‰∏ªË¶Å‰∏ñÁïå‰π¶`,
                        JSON.stringify(localbook),
                    );
                } catch (e) {
                    console.log(`Ëé∑ÂèñÁªëÂÆö‰∏ñÁïå‰π¶Âá∫Áé∞ÂºÇÂ∏∏:${e}`);
                }
                if (localbook) {
                    const localentrys = await getLorebookEntries(localbook);
                    const targetEntry = localentrys.find((entry) =>
                        ["ÊâãÊú∫-ÁïåÈù¢Âü∫Êú¨ËÆæÁΩÆ", "ÊâãÊú∫ÁïåÈù¢Âü∫Êú¨ËÆæÁΩÆ"].includes(
                            entry.comment,
                        ),
                    );
                    if (targetEntry) {
                        console.log(`‰ΩøÁî®ËßíËâ≤Âç°ÁªëÂÆöÁöÑ‰∏ñÁïå‰π¶`);
                        return localbook;
                    }
                }
                const globalbook = (await getLorebookSettings())
                    .selected_global_lorebooks;
                if (globalbook) {
                    for (const book of globalbook) {
                        const localentrys = await getLorebookEntries(book);
                        const targetEntry = localentrys.find((entry) =>
                            ["ÊâãÊú∫-ÁïåÈù¢Âü∫Êú¨ËÆæÁΩÆ", "ÊâãÊú∫ÁïåÈù¢Âü∫Êú¨ËÆæÁΩÆ"].includes(
                                entry.comment,
                            ),
                        );
                        if (targetEntry) {
                            console.log(`‰ΩøÁî®ÂÖ®Â±Ä‰∏ñÁïå‰π¶:${book}`);
                            return book;
                        }
                    }
                }
                if (localbook) {
                    return localbook;
                }
                console.log(`Ê≤°ÊúâÂåπÈÖçÁöÑ‰∏ñÁïå‰π¶`);
                return null;
            }
            async function DelPadding() {
                const message_id = await getCurrentMessageId();
                console.log(`ÂºÄÂßãÁßªÈô§Â§¥ÂÉèÂíåËæπË∑ù:${message_id}`);
                $(`div.mes[mesid="${message_id}"]`, window.parent.document)
                    .find(`div.mes_text`)
                    .css("padding-right", "0");
                $(`div.mes[mesid="${message_id}"]`, window.parent.document)
                    .find(`div.avatar`)
                    .css("display", "none");
                $(`div.mes[mesid="${message_id}"]`, window.parent.document)
                    .find(`div.mesAvatarWrapper`)
                    .css("display", "none");
            }
            /**
             * Ëé∑ÂèñËÆæÁΩÆ
             */
            async function GetSettings() {
                console.log(
                    `ÊµãËØïËé∑Âèñini:${Phone_Settings.readValue("‰∏ãÈù¢ÊòØÂü∫Êú¨ËÆæÁΩÆ", "ËÅäÂ§©Â£ÅÁ∫∏")}`,
                );
                if (Phone_Settings.readValue("‰∏ãÈù¢ÊòØÂü∫Êú¨ËÆæÁΩÆ", "ÂÜÖÊ°ÜÈ¢úËâ≤")) {
                    let value = Phone_Settings.readValue(
                        "‰∏ãÈù¢ÊòØÂü∫Êú¨ËÆæÁΩÆ",
                        "ÂÜÖÊ°ÜÈ¢úËâ≤",
                    );
                    if (value[0] != "#") {
                        value += "#";
                    }
                    console.log(`ËÆæÁΩÆÊ∞îÊ≥°È¢úËâ≤‰∏∫ ${value}`);
                    $("<style>")
                        .text(
                            `.card { background-color: ${value} !important; }`,
                        )
                        .appendTo("head");
                    $("<style>")
                        .text(`.top { background-color: ${value} !important; }`)
                        .appendTo("head");
                }
                let value = Phone_Settings.readValue(
                    "‰∏ãÈù¢ÊòØÂü∫Êú¨ËÆæÁΩÆ",
                    "Â§ñÊ°ÜÈ¢úËâ≤",
                );
                if (value) {
                    if (value[0] != "#") {
                        value += "#";
                    }
                    console.log(`ËÆæÁΩÆÊ∞îÊ≥°È¢úËâ≤‰∏∫ ${value}`);
                    $("<style>")
                        .text(
                            `.card { border: 2px solid ${value} !important; }`,
                        )
                        .appendTo("head");
                }
                value = Phone_Settings.readValue("‰∏ãÈù¢ÊòØÂü∫Êú¨ËÆæÁΩÆ", "‰æßËæπÊåâÈíÆ");
                if (value) {
                    if (value[0] != "#") {
                        value += "#";
                    }
                    console.log(`ËÆæÁΩÆÊ∞îÊ≥°È¢úËâ≤‰∏∫ ${value}`);
                    $("<style>")
                        .text(
                            `.btn1 { background-color: ${value} !important; }`,
                        )
                        .appendTo("head");
                    $("<style>")
                        .text(
                            `.btn2 { background-color: ${value} !important; }`,
                        )
                        .appendTo("head");
                    $("<style>")
                        .text(
                            `.btn3 { background-color: ${value} !important; }`,
                        )
                        .appendTo("head");
                }
                value = Phone_Settings.readValue("‰∏ãÈù¢ÊòØÂü∫Êú¨ËÆæÁΩÆ", "ÂèëÈÄÅÊ®°Âºè");
                if (value) {
                    if (value == "2") {
                        newgen = false;
                        console.log("ËÆæÁΩÆÂèëÈÄÅÊ®°Âºè‰∏∫ÈùûÊµÅÂºè");
                    } else {
                        newgen = true;
                        console.log("ËÆæÁΩÆÂèëÈÄÅÊ®°Âºè‰∏∫ÊµÅÂºè");
                    }
                } else {
                    Phone_Settings.writeValue(
                        "‰∏ãÈù¢ÊòØÂü∫Êú¨ËÆæÁΩÆ",
                        "ÂèëÈÄÅÊ®°Âºè",
                        "1",
                    );
                    console.log("Êú™ÊâæÂà∞ÂèëÈÄÅÊ®°ÂºèËÆæÁΩÆÔºå‰ΩøÁî®ÈªòËÆ§ÊµÅÂºèÂèëÈÄÅ");
                }
                value = Phone_Settings.readValue("‰∏ãÈù¢ÊòØÂü∫Êú¨ËÆæÁΩÆ", "ËÅäÂ§©Â£ÅÁ∫∏");
                if (value) {
                    $("<style>")
                        .text(
                            `.QQ_chat_page {
      background-image: url("${value}");
    }`,
                        )
                        .appendTo("head");
                }
                value = Phone_Settings.readValue("‰∏ãÈù¢ÊòØÂü∫Êú¨ËÆæÁΩÆ", "Ê∞îÊ≥°È¢úËâ≤");
                if (value) {
                    if (value[0] != "#") {
                        value += "#";
                    }
                    //console.log(`ËÆæÁΩÆÊ∞îÊ≥°È¢úËâ≤‰∏∫ ${value}`);
                    $("<style>")
                        .text(
                            `.QQ_chat_msgdiv { background-color: ${value} !important; }`,
                        )
                        .appendTo("head");
                }
                Phone_Settings.writeValue(
                    "‰∏ãÈù¢ÊòØÂü∫Êú¨ËÆæÁΩÆ",
                    "‰∏ñÁïå‰π¶ÁâàÊú¨",
                    version,
                );
                for (let entry of entries) {
                    if (
                        entry.comment == "ÊâãÊú∫-ÁïåÈù¢Âü∫Êú¨ËÆæÁΩÆ" ||
                        entry.comment == "ÊâãÊú∫ÁïåÈù¢Âü∫Êú¨ËÆæÁΩÆ"
                    ) {
                        await setLorebookEntries(worldbook, [
                            {
                                uid: entry.uid,
                                content: Phone_Settings.getAllText(),
                            },
                        ]);
                    }
                }
                entries = await getLorebookEntries(worldbook);
            }
            /**
             * Ê†πÊçÆËßíËâ≤ÂêçËé∑ÂèñËÅäÂ§©ËÆæÂÆö
             *
             * @param name ËßíËâ≤Âêç
             * @returns ËÅäÂ§©ËÆæÂÆö
             */
            function GetChatCharSettingByName(name) {
                let char_setting = "";
                for (let entry of entries) {
                    if (entry.comment == "ÈÖçÁΩÆ-ËÅäÂ§©-ËßíËâ≤‰∏™‰∫∫ËÆæÂÆö") {
                        char_setting = entry.content.trim();
                    }
                }
                if (!char_setting) {
                    return;
                }
                const char_setting_json = JSON.parse(char_setting);
                const setting = char_setting_json.find(
                    (item) => item.name === name,
                );
                if (!setting) {
                    return;
                }
                console.log(`Ëé∑ÂèñÂà∞ËßíËâ≤ËÆæÂÆö:${YAML.stringify(setting)}`);
                return setting;
            }
            async function Verify() {
                try {
                    // Ëé∑ÂèñÁâàÊú¨ÂÖÉÁ¥†Âπ∂ÊèêÂèñÁ∫ØÁâàÊú¨Âè∑
                    let version = await getFrontendVersion();
                    console.log(`ÈÖíÈ¶ÜÂä©ÊâãÁâàÊú¨${version}`);
                    // ÊãÜÂàÜÁâàÊú¨Âè∑‰∏∫Êï∞Â≠óÊï∞ÁªÑ
                    const versionParts = version.split(".").map(Number);
                    if (versionParts.length < 3 || versionParts.some(isNaN)) {
                        throw new Error("Invalid version format");
                    }
                    // Ëß£ÊûÑËµãÂÄºÁâàÊú¨Âè∑
                    const [major, minor, patch] = versionParts;
                    // ËÆæÁΩÆÊúÄ‰ΩéË¶ÅÊ±ÇÁâàÊú¨
                    const MIN_MAJOR = 2;
                    const MIN_MINOR = 4;
                    const MIN_PATCH = 3;
                    // ÁâàÊú¨ÊØîËæÉÈÄªËæë
                    if (
                        major < MIN_MAJOR ||
                        (major === MIN_MAJOR &&
                            (minor < MIN_MINOR ||
                                (minor === MIN_MINOR && patch < MIN_PATCH)))
                    ) {
                        alert(
                            `ÂâçÁ´ØÂä©ÊâãÁâàÊú¨Ëøá‰Ωé (ÂΩìÂâç ${versionParts.join(".")}ÔºåÈúÄË¶ÅËá≥Â∞ë ${MIN_MAJOR}.${MIN_MINOR}.${MIN_PATCH})ÔºåËØ∑Êõ¥Êñ∞`,
                        );
                    }
                } catch (error) {
                    assertIsError(error);
                    console.error("ÁâàÊú¨È™åËØÅÂ§±Ë¥•:", error);
                    // Â¶ÇÊûúÂ≠òÂú®Ëá™ÂÆö‰πâÈîôËØØÂ§ÑÁêÜÂàôË∞ÉÁî®ÔºåÂê¶Âàô‰ΩøÁî®ÈªòËÆ§ÊèêÁ§∫
                    if (typeof QQ_Error === "function") {
                        QQ_Error(`È™åËØÅÂâçÁ´ØÂä©ÊâãÁâàÊú¨Â§±Ë¥•: ${error.message}`);
                    } else {
                        alert("ÁâàÊú¨È™åËØÅÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊéßÂà∂Âè∞‰ø°ÊÅØ");
                    }
                }
            }
            function assertIsError(error) {
                if (!(error instanceof Error)) {
                    throw new TypeError();
                }
            }
            function random(min, max) {
                return Math.floor(Math.random() * (max - min) + min);
            }
            function head_init() {
                let girl = `EJeUD/Image_1737026320652.jpg|Y8pt1/Image_1737026296736.jpg|QWWc6/Image_1737026308451.jpg|Z8LIW/Image_1737026306601.jpg|W8lhW/Image_1737026313246.jpg|0rJtX/Image_1737026292787.jpg|yVxsN/Image_1737026293840.jpg|vaBCL/Image_1737026286979.jpg|pZ6hQ/Image_1737026285632.jpg|11AH2/Image_1737026284351.jpg|eXKUw/Image_1737026281715.jpg|o31F4/Image_1737026277201.jpg|8E2uj/Image_1737026279242.jpg|GLmIl/Image_1737026275069.jpg|zWZT5/Image_1737026271769.jpg|7Zrij/Image_1737026269532.jpg|AqYsZ/Image_1737026266131.jpg|w4lFq/2406563368.jpeg|MQNua/2403629154.jpeg|3YZhe/2405854911.jpeg|5QKhj/2312445144.jpeg|k6JT6/2408434848.jpeg|j6Bf6/2386328773.jpeg|a8LHY/2386327598.jpeg|r08C6/2386327604.jpeg|DgECK/2331678725.jpeg|LJrC7/2371251634.jpeg|q1LF3/2329660869.gif|X84sW/2328035526.jpeg|2eDfQ/2326662447.jpeg|ggetw/2326683821.jpeg|J21ig/2323432137.gif`;
                let girls = girl.split("|");
                let result = "";
                for (let i = 0; i < girls.length; i++) {
                    if (girls[i]) {
                        random_head_list.push(girls[i]);
                        result += `\nhttp://sharkpan.xyz/f/${girls[i]}`;
                    }
                }
            }
            // Â¢ûÂä†Èü≥È¢ëÁä∂ÊÄÅÁõëÂê¨
            QQ_Music.audio.addEventListener("ended", () => {
                if (QQ_Music.lastelement) {
                    QQ_Music.lastelement.find(".icon-music-stop").hide();
                    QQ_Music.lastelement.find(".icon-music-play").show();
                }
            });
            QQ_Music.audio.addEventListener("error", () => {
                if (QQ_Music.lastelement) {
                    QQ_Music.lastelement.find(".icon-music-stop").hide();
                    QQ_Music.lastelement.find(".icon-music-play").show();
                }
                QQ_Error("Êí≠ÊîæÂá∫ÈîôÔºåËØ∑Â∞ùËØïÈáçÊñ∞Êí≠Êîæ");
            });
            // Â¢ûÂä†Èü≥È¢ë‰∏≠Êñ≠ÁõëÂê¨
            QQ_Music.audio.addEventListener("pause", () => {
                if (QQ_Music.lastelement) {
                    QQ_Music.lastelement.find(".icon-music-stop").hide();
                    QQ_Music.lastelement.find(".icon-music-play").show();
                }
            });
            async function LoadRandomHead() {
                let content = "";
                for (let entry of entries) {
                    if (entry.comment == "ÊâãÊú∫-ÈöèÊú∫Â§¥ÂÉè") {
                        content = entry.content;
                    }
                }
                if (!content) {
                    return;
                }
                const matches = content.matchAll(/^http.+$/gm);
                for (const match of matches) {
                    const obj = {
                        url: match[0],
                        count: [
                            ...NpcCssValue.matchAll(new RegExp(match[0], "g")),
                        ].length,
                    };
                    QQ_RandomHead.push(obj);
                }
            }
            function GetWorldEntry(name, search) {
                let list = [];
                
                // Ê£ÄÊü•entriesÊòØÂê¶Â∑≤ÂàùÂßãÂåñ
                if (!entries) {
                    console.warn('GetWorldEntry: entriesÊú™ÂàùÂßãÂåñÔºåËøîÂõûnull');
                    return null;
                }
                
                entries.forEach((item) => {
                    if (search) {
                        name.forEach((n) => {
                            if (item.comment.indexOf(n) > -1) {
                                list.push(item);
                            }
                        });
                    } else if (name.includes(item.comment)) {
                        list.push(item);
                    }
                });
                if (list.length == 0) {
                    return null;
                } else if (list.length == 1) {
                    return list[0];
                }
                // Â≠òÂú®Â§ö‰∏™Êù°ÁõÆ,‰ΩøÁî®ÂºÄÂêØÁöÑÊù°ÁõÆ,ÊúâÂ§ö‰∏™ÂºÄÂêØÊù°ÁõÆ‰∏çÂÅöÂ§ÑÁêÜ
                for (let entry of list) {
                    if (entry.enabled) {
                        return entry;
                    }
                }
                // ÂÖ®ÈÉΩÊ≤°ÂºÄÂêØ,Áõ¥Êé•ËøîÂõûÁ¨¨‰∏Ä‰∏™
                return list[0];
            }
            /**
             * Ëé∑ÂèñË°®ÊÉÖÂåÖ
             */
            async function LoadEmoji() {
                let content = "";
                let phonebook = "";
                let phoneuid = -1;
                
                // Ê£ÄÊü•entriesÊòØÂê¶Â∑≤ÂàùÂßãÂåñ
                if (!entries) {
                    console.warn('LoadEmoji: entriesÊú™ÂàùÂßãÂåñÔºåË∑≥ËøáË°®ÊÉÖÂåÖÂä†ËΩΩ');
                    return;
                }
                
                for (let entry of entries) {
                    if (
                        entry.comment == "ÊâãÊú∫-Ë°®ÊÉÖÂåÖÂ≠òÊîæ" ||
                        entry.comment == "Ë°®ÊÉÖÂåÖÂ≠òÊîæ‰∏ñÁïå‰π¶"
                    ) {
                        content = entry.content;
                    } else if (entry.comment == "ÊâãÊú∫-Ê†ºÂºè2-QQËÅäÂ§©") {
                        phonebook = entry.content;
                        phoneuid = entry.uid;
                    }
                }
                if (!content) {
                    console.log(`Ëé∑ÂèñË°®ÊÉÖÂåÖ‰∏ñÁïå‰π¶Â§±Ë¥•`);
                    return;
                }
                if (phoneuid == -1) {
                    console.log(`Ëé∑ÂèñÊâãÊú∫Ê†ºÂºè‰∏ñÁïå‰π¶Êù°ÁõÆÂ§±Ë¥•`);
                    return;
                }
                content = content.replace(
                    /http:\/\/sharkpan/g,
                    "https://sharkpan",
                );
                content = content.replace(/--\n/g, "--");
                const regex = new RegExp("(.+?)--(http.+)", "g");
                const matches = [...content.matchAll(regex)];
                if (!matches) {
                    return;
                }
                console.log(`Ë°®ÊÉÖÂåÖÊï∞Èáè:${matches.length}`);
                for (const match of matches) {
                    QQ_emoji.set(match[1], match[2]);
                }
                const keysArray = JSON.stringify(Array.from(QQ_emoji.keys()));
                const m = phonebook.match(
                    /<Ë°®ÊÉÖÂåÖÂàóË°®>([\s\S]*?)<\/Ë°®ÊÉÖÂåÖÂàóË°®>/,
                );
                if (m) {
                    phonebook = phonebook.replace(
                        m[0],
                        `<Ë°®ÊÉÖÂåÖÂàóË°®>\n${keysArray}\n<\/Ë°®ÊÉÖÂåÖÂàóË°®>`,
                    );
                    // await setLorebookEntries(worldbook, entrys.map((entry) => ({ uid: phoneuid, content: phonebook })));
                    await setLorebookEntries(worldbook, [
                        { uid: phoneuid, content: phonebook },
                    ]);
                }
            }
            /**
             * ËÅäÂ§©-Âä†ËΩΩËßíËâ≤ÂàóË°®
             *
             */
            async function LoadChars() {
                console.log('=== LoadChars ÂºÄÂßãÊâßË°å ===');
                console.log('entriesÂèòÈáèÁä∂ÊÄÅ:', typeof entries, entries ? entries.length : 'undefined');
                console.log('worldbookÂèòÈáè:', worldbook);
                
                // ÂÖàÂàóÂá∫ÊâÄÊúâentriesÁöÑcommentÊù•Ê£ÄÊü•
                if (entries) {
                    console.log('ÊâÄÊúâ‰∏ñÁïå‰π¶Êù°ÁõÆ:', entries.map(e => ({comment: e.comment, enabled: e.enabled, hasContent: !!e.content})));
                }
                
                // Ê£ÄÊü•‰∏ñÁïå‰π¶‰∏≠ÁöÑÁæ§ËÅäÂÜÖÂÆπ
                checkWorldbookGroups();
                
                let content;
                // for (let entry of entries) {
                //   if (entry.comment == "ÊâãÊú∫-ËßíËâ≤" || entry.comment == "ÊâãÊú∫ÁïåÈù¢-ËßíËâ≤") {
                //     content = entry.content;
                //     break;
                //   }
                // }
                // if (!content) {
                //   return;
                // }
                let entry = GetWorldEntry(["ÊâãÊú∫-ËßíËâ≤", "ÊâãÊú∫ÁïåÈù¢-ËßíËâ≤"], true);
                console.log('ÊâæÂà∞ÁöÑ‰∏ñÁïå‰π¶Êù°ÁõÆ:', entry);
                
                // Â¶ÇÊûúGetWorldEntryÂ§±Ë¥•ÔºåÂ∞ùËØïÁõ¥Êé•Êü•Êâæ
                if (!entry || !entry.content) {
                    console.log('GetWorldEntryÂ§±Ë¥•ÔºåÂ∞ùËØïÁõ¥Êé•Êü•Êâæ...');
                    for (let e of entries || []) {
                        console.log(`Ê£ÄÊü•Êù°ÁõÆ: ${e.comment}`);
                        if (e.comment === "ÊâãÊú∫-ËßíËâ≤" || e.comment === "ÊâãÊú∫ÁïåÈù¢-ËßíËâ≤") {
                            console.log('Áõ¥Êé•Êü•ÊâæÊâæÂà∞Êù°ÁõÆ:', e);
                            entry = e;
                            break;
                        }
                    }
                }
                
                if (!entry || !entry.content) {
                    console.error('‰ªçÁÑ∂Êú™ÊâæÂà∞ÊâãÊú∫-ËßíËâ≤‰∏ñÁïå‰π¶Êù°ÁõÆÊàñÂÜÖÂÆπ‰∏∫Á©∫');
                    console.error('ÂΩìÂâçentry:', entry);
                    return;
                }
                content = entry.content;
                console.log('‰∏ñÁïå‰π¶ÂÜÖÂÆπÈïøÂ∫¶:', content.length);
                console.log(`Ëé∑ÂèñÂà∞ÁöÑËßíËâ≤‰ø°ÊÅØ:${content}`);
                QQ_CharSettings.loadText(content);
                console.log(`GetAllText:\n${QQ_CharSettings.getAllText()}`);
                const allSections = QQ_CharSettings.getAllSections();
                console.log('ÊâÄÊúâËß£ÊûêÁöÑÊÆµËêΩ:', allSections);
                for (let section of allSections) {
                    const hasGetCharAvatar =
                        typeof getCharAvatarPath === "function"; // Ê†∏ÂøÉÊ£ÄÊü•ÈÄªËæë
                    const type = QQ_CharSettings.readValue(section, "Á±ªÂûã");
                    if (section == "char") {
                        section = getFilenameWithoutExtension(charAvatarPath);
                    }
                    let headurl = QQ_CharSettings.readValue(section, "Â§¥ÂÉè");
                    if (!headurl) {
                        if (hasGetCharAvatar) {
                            headurl = await getCharAvatarPath(section);
                        } else {
                            QQ_Error(
                                `Ëá™Âä®Ëé∑ÂèñÂ§¥ÂÉèË¶ÅÊ±ÇÂâçÁ´ØÂä©ÊâãÁâàÊú¨Âú®2.4.4Âèä‰ª•‰∏äÁâàÊú¨`,
                            );
                            continue;
                        }
                    } else {
                        const match = headurl.match(/[<{]+(.+?)[>}]/);
                        if (match) {
                            if (hasGetCharAvatar) {
                                headurl = await getCharAvatarPath(match[1]);
                            } else {
                                QQ_Error(
                                    `Ëá™Âä®Ëé∑ÂèñÂ§¥ÂÉèË¶ÅÊ±ÇÂâçÁ´ØÂä©ÊâãÁâàÊú¨Âú®2.4.4Âèä‰ª•‰∏äÁâàÊú¨`,
                                );
                                continue;
                            }
                        }
                    }
                    if (!type.match(/npc/i) && type != "Ë∑Ø‰∫∫" && type != "Áæ§ËÅä") {
                        // Âè™Â§ÑÁêÜÁßÅËÅäËßíËâ≤ÔºåÁæ§ËÅäÁî±Áã¨Á´ãÁöÑloadGroupChatsFromWorldbookÂáΩÊï∞Â§ÑÁêÜ
                        console.log(`ÂáÜÂ§áÊ∑ªÂä†ËßíËâ≤: ${section}, Á±ªÂûã: ${type}`);
                        AddNewChar(section, headurl);
                        QQ_msgjson.ÁßÅËÅä[`${UserName}Âíå${section}ÁöÑËÅäÂ§©`] = [];
                        } else {
                        console.log(`Ë∑≥ËøáËßíËâ≤: ${section}, Á±ªÂûã: ${type}`);
                    }
                    console.log(`ËßíËâ≤${section}ÁöÑÂ§¥ÂÉè:${headurl}`);
                    let CssValue = new Map();
                    let divkey = `.QQ_chat_msgdiv[data-name='${section}']`;
                    let MsgColor = QQ_CharSettings.readValue(
                        section,
                        "Ê∞îÊ≥°È¢úËâ≤",
                    );
                    if (MsgColor) {
                        MsgColor =
                            MsgColor[0] == "#" ? MsgColor : `#${MsgColor}`;
                        CssValue.set(
                            divkey,
                            `--MsgColor: ${MsgColor};
        background-color: var(--MsgColor) !important; `,
                        );
                        console.log(
                            `ËÆæÁΩÆ‰∫ÜËßíËâ≤ ${section} ÁöÑÊ∞îÊ≥°È¢úËâ≤:${MsgColor}`,
                        );
                    }
                    let TextColor = QQ_CharSettings.readValue(
                        section,
                        "Â≠ó‰ΩìÈ¢úËâ≤",
                    );
                    if (TextColor) {
                        TextColor =
                            TextColor[0] == "#" ? TextColor : `#${TextColor}`;
                        if (CssValue.has(divkey)) {
                            CssValue.set(
                                divkey,
                                CssValue.get(divkey) +
                                    `--TextColor: ${TextColor};`,
                            );
                        }
                        CssValue.set(
                            `.QQ_chat_msgdiv[data-name='${section}'] span`,
                            `color:var(--TextColor) !important;`,
                        );
                        console.log(
                            `ËÆæÁΩÆ‰∫ÜËßíËâ≤ ${section} ÁöÑÂ≠ó‰ΩìÈ¢úËâ≤:${TextColor}`,
                        );
                    }
                    let BackGroundImg = QQ_CharSettings.readValue(
                        section,
                        "ËÅäÂ§©Â£ÅÁ∫∏",
                    );
                    if (BackGroundImg) {
                        CssValue.set(
                            `.QQ_chat_page[data-name='${section}']`,
                            `--BackGroundImg: url('${BackGroundImg}');
        background-image:var(--BackGroundImg) !important;`,
                        );
                        console.log(
                            `ËÆæÁΩÆ‰∫ÜËßíËâ≤ ${section} ÁöÑËÅäÂ§©Â£ÅÁ∫∏:${BackGroundImg}`,
                        );
                    }
                    if (headurl) {
                        CssValue.set(
                            `.head[data-name=${section}]`,
                            `background-image:url('${headurl}')`,
                        );
                        console.log(`Ê∑ªÂä†headurl`);
                    }
                    if (CssValue) {
                        let value = "";
                        for (const key of CssValue.keys()) {
                            value += `\n${key}{${CssValue.get(key)}}`;
                        }
                        if (value) {
                            $(`<style>`)
                                .attr("data-name", section)
                                .text(value)
                                .appendTo("head");
                            //console.log(`ËÆæÁΩÆcss:\n${value}`);
                        }
                    }
                    //console.log(`Ëé∑ÂèñÂà∞ÁöÑÊ†∑ÂºèË°®:\n${$(`style[data-name='${section}']`).text()}`);
                }
                const style = $("<style></style>").prop("type", "text/css");
                const cssRule = chat_headraw_namespaceObject
                    .replace(/\$\{name\}/g, UserName)
                    .replace(/\$\{head\}/g, userAvatarPath);
                style.text(cssRule);
                $("head").append(style);
                
                // Âä†ËΩΩ‰øùÂ≠òÁöÑÁæ§ËÅäÊï∞ÊçÆ
                console.log('LoadChars: ÂáÜÂ§áÂä†ËΩΩÁæ§ËÅäÊï∞ÊçÆ, worldbookÁä∂ÊÄÅ:', !!worldbook, 'QQ_GroupsÈïøÂ∫¶:', QQ_Groups.length);
                if (worldbook) {
                    console.log('LoadChars: ÂºÄÂßãÂä†ËΩΩÁæ§ËÅäÊï∞ÊçÆ');
                    await loadGroupChatsFromWorldbook();
                } else {
                    console.log('LoadChars: Ë∑≥ËøáÁæ§ËÅäÂä†ËΩΩ - worldbookÊú™ÂàùÂßãÂåñ');
                }
                
                // Ê≥®ÈáäÔºöÊ∏ÖÁêÜÈáçÂ§çÁæ§ËÅäÂ∑≤ÁßªÈô§ÔºåÈÅøÂÖçËØØÂà†Êñ∞ÂàõÂª∫ÁöÑÁæ§ËÅä
                // setTimeout(async () => {
                //     await cleanupDuplicateGroups();
                // }, 500);
            }
            
            /**
             * ‰ªéÊâãÊú∫-ËßíËâ≤‰∏≠ÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™ËÅäÂ§©Â£ÅÁ∫∏
             */
            function getRandomChatBackground() {
                try {
                    console.log('ÂºÄÂßãËé∑ÂèñÈöèÊú∫ËÅäÂ§©Â£ÅÁ∫∏...');
                    
                    // Ëé∑Âèñ‰∏ñÁïå‰π¶Êù°ÁõÆ
                    const entry = GetWorldEntry(["ÊâãÊú∫-ËßíËâ≤", "ÊâãÊú∫ÁïåÈù¢-ËßíËâ≤"], true);
                    if (!entry || !entry.content) {
                        console.log('Êó†Ê≥ïËé∑ÂèñËßíËâ≤ÈÖçÁΩÆÔºå‰ΩøÁî®ÈªòËÆ§Â£ÅÁ∫∏');
                        console.log('entry:', entry);
                        return 'http://sharkpan.xyz/f/mM2SW/Screenshot_20250317_001012.jpg';
                    }
                    
                    console.log('ÊàêÂäüËé∑ÂèñÂà∞ËßíËâ≤ÈÖçÁΩÆÊù°ÁõÆÔºåÂÜÖÂÆπÈïøÂ∫¶:', entry.content.length);
                    
                    // Ëß£ÊûêÈÖçÁΩÆ
                    const settings = new QQ_Settings();
                    settings.loadText(entry.content);
                    const allSections = settings.getAllSections();
                    
                    console.log('Ëß£ÊûêÂæóÂà∞ÁöÑËßíËâ≤sectionsÊï∞Èáè:', allSections.length);
                    
                    // Êî∂ÈõÜÊâÄÊúâÊúâËÅäÂ§©Â£ÅÁ∫∏ÁöÑÈùûÁæ§ËÅäËßíËâ≤
                    const availableBackgrounds = [];
                    
                    for (const section of allSections) {
                        const type = settings.readValue(section, "Á±ªÂûã");
                        const backgroundImg = settings.readValue(section, "ËÅäÂ§©Â£ÅÁ∫∏");
                        
                        console.log(`Ê£ÄÊü•ËßíËâ≤ ${section}: Á±ªÂûã=${type}, ËÅäÂ§©Â£ÅÁ∫∏=${backgroundImg ? 'Êúâ' : 'Êó†'}`);
                        
                        // ÊéíÈô§Áæ§ËÅä„ÄÅË∑Ø‰∫∫„ÄÅNPCÁ±ªÂûã
                        if (!type || (type.trim() !== 'Áæ§ËÅä' && type.trim() !== 'Ë∑Ø‰∫∫' && !type.match(/npc/i))) {
                            if (backgroundImg && backgroundImg.trim()) {
                                availableBackgrounds.push({
                                    character: section,
                                    url: backgroundImg.trim()
                                });
                                console.log(`Êî∂ÈõÜÂà∞ËßíËâ≤ ${section} ÁöÑËÅäÂ§©Â£ÅÁ∫∏: ${backgroundImg.trim()}`);
                            }
                        }
                    }
                    
                    console.log('ÊÄªÂÖ±Êî∂ÈõÜÂà∞', availableBackgrounds.length, '‰∏™ÂèØÁî®ÁöÑËÅäÂ§©Â£ÅÁ∫∏');
                    
                    // Â¶ÇÊûúÊâæÂà∞‰∫ÜÂ£ÅÁ∫∏ÔºåÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™
                    if (availableBackgrounds.length > 0) {
                        const randomChoice = availableBackgrounds[Math.floor(Math.random() * availableBackgrounds.length)];
                        console.log(`‰∏∫Áæ§ËÅäÈöèÊú∫ÈÄâÊã©‰∫ÜÊù•Ëá™ËßíËâ≤ "${randomChoice.character}" ÁöÑËÅäÂ§©Â£ÅÁ∫∏: ${randomChoice.url}`);
                        return randomChoice.url;
                    }
                    
                } catch (error) {
                    console.error('ÈöèÊú∫ÈÄâÊã©ËÅäÂ§©Â£ÅÁ∫∏Êó∂Âá∫Èîô:', error);
                }
                
                // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ÊàñÂá∫ÈîôÔºåËøîÂõûÈªòËÆ§Â£ÅÁ∫∏
                console.log('Ê≤°ÊúâÊâæÂà∞ÂèØÁî®ÁöÑËÅäÂ§©Â£ÅÁ∫∏Ôºå‰ΩøÁî®ÈªòËÆ§Â£ÅÁ∫∏');
                return 'http://sharkpan.xyz/f/mM2SW/Screenshot_20250317_001012.jpg';
            }
            
            /**
             * ‰∏∫Áæ§ËÅäÊ∑ªÂä†ÂàùÂßãÊ¨¢ËøéÊ∂àÊÅØÔºàÂ∑≤ÁßªÂä®Âà∞ÂêéÈù¢ÔºåÊ≠§Â§ÑÂà†Èô§ÈáçÂ§çÂáΩÊï∞Ôºâ
             */
            
            function SetCssVariable(name, variable, value) {
                let cssvalue = $(`style[data-name='${name}']`).text();
                if (!cssvalue) {
                    return;
                }
                const match = cssvalue.match(
                    new RegExp(`--${variable}\s*:\s*(.+?);`),
                );
                if (!match) {
                    return;
                }
                cssvalue = cssvalue
                    .replace(
                        `${match[0]}`,
                        `${match[0].replace(match[1], value)}`,
                    )
                    .trim();
                console.log(`Êõ¥Êñ∞ÂêéÁöÑcss:\n${cssvalue}`);
                $(`style[data-name='${name}']`).text(cssvalue);
            }
            /**
             * ËÅäÂ§©-Ê∑ªÂä†Êñ∞ËßíËâ≤Âà∞ÂàóË°®
             * @param {*} name
             * @param {*} head
             */
            function AddNewChar(name, head) {
                console.log(`Ê∑ªÂä†Êñ∞ËßíËâ≤:${name}  ${head}`);
                let html = _.template(chat_list_item)({
                    name: name,
                    head: head.trim(),
                });
                $("#QQ_home_chars").append(html);
                QQ_pages.push(name);
                const style = $("<style></style>").prop("type", "text/css");
                const cssRule = chat_headraw_namespaceObject
                    .replace(/\$\{name\}/g, name)
                    .replace(/\$\{head\}/g, head);
                style.text(cssRule);
                $("head").append(style);
                //System_AddNpcHead(name, head);
                
                // Êõ¥Êñ∞Ê∂àÊÅØÂàóË°®
                setTimeout(() => {
                    QQ_UpdateMessageList();
                }, 100);
            }
            
            /**
             * Ê∑ªÂä†Êñ∞Áæ§ËÅäÔºàÂÆåÂÖ®Âü∫‰∫éÁßÅËÅäÈÄªËæëÔºâ
             */
             function AddNewGroup(name, head, members, description) {
                console.log(`Ê∑ªÂä†/Êõ¥Êñ∞Áæ§ËÅä:${name}  |  ÊàêÂëò:${members.length}‰∫∫  |  ÊèèËø∞:${description}`);

                const existingElements = $(`.QQ_home_usermsg[data-name='${name}'][data-group-type='true']`);
                if (existingElements.length > 0) {
                    console.log(`ÊâæÂà∞ÂêåÂêçÁæ§ËÅäÔºåÊâßË°åÊõ¥Êñ∞Êìç‰Ωú`);
                    existingElements.remove();
                }

                // *** ‰øÆÂ§çÔºöÁ°Æ‰øùheadÊòØÂ≠óÁ¨¶‰∏≤ÔºåÂ¶ÇÊûúÊòØÂØπË±°ÂàôÂ§ÑÁêÜ‰∏∫ÂêàÈÄÇÁöÑÂ≠óÁ¨¶‰∏≤ ***
                let headStr = '';
                if (typeof head === 'string') {
                    headStr = head.trim();
                } else if (head && typeof head === 'object') {
                    // Â¶ÇÊûúÊòØÂ§¥ÂÉèÂØπË±°ÔºåÊèêÂèñÂêàÈÄÇÁöÑÂÄº
                    if (head.type === 'upload' && head.imageData) {
                        headStr = head.imageData;
                    } else if (head.type === 'preset' && head.text) {
                        headStr = head.text;
                    } else if (head.type === 'url' && head.url) {
                        headStr = head.url;
                    } else {
                        headStr = 'https://files.catbox.moe/skngqq.jpg'; // ÈªòËÆ§Â§¥ÂÉè
                    }
                } else {
                    headStr = head || 'https://files.catbox.moe/skngqq.jpg'; // ÈªòËÆ§Â§¥ÂÉè
                }
                
                let html = _.template(chat_list_item)({ name: name, head: headStr });
                const $html = $(html);
                $html.attr('data-group-type', 'true').attr('data-group-name', name).attr('draggable', 'true');
                
                // *** ‰øÆÂ§çÔºö‰∏çË¶ÅÁ°¨ÁºñÁ†ÅÁæ§ËÅäÊòæÁ§∫ÔºåÁ®çÂêé‰ºöÈÄöËøáupdateGroupLastMessageDisplayÊõ¥Êñ∞ ***
                // ‰∏¥Êó∂ËÆæÁΩÆÂàùÂßãÊòæÁ§∫ÔºåÈò≤Ê≠¢Á©∫ÁôΩ
                const memberCount = members ? members.length : 0;
                $html.find('.QQ_home_lastmsg').text('Áæ§ËÅä');
                $html.find('.QQ_home_lasttime').text(`${memberCount}‰∫∫`);

                $html.on('click', function() {
                    console.log('Áæ§ËÅäË¢´ÁÇπÂáª:', name);
                    QQ_ChangeChatPage(null, name);
                });

                const $contactsContainer = $("#QQ_home_chars");
                let $ungroupedSection = $contactsContainer.find('.ungrouped-contacts');
                if ($ungroupedSection.length === 0) {
                    $ungroupedSection = $(`<div class="ungrouped-contacts"><div class="ungrouped-header">Êú™ÂàÜÁªÑËÅîÁ≥ª‰∫∫</div><div class="drop-zone ungrouped-drop-zone" data-group-id="ungrouped"></div></div>`);
                    $contactsContainer.prepend($ungroupedSection);
                }
                $ungroupedSection.append($html);
                
                QQ_pages.push(name);
                if (!QQ_Groups.includes(name)) {
                    QQ_Groups.push(name);
                }

                if (!QQ_msgjson.Áæ§ËÅä[name]) {
                    QQ_msgjson.Áæ§ËÅä[name] = { msgs: [], members: [] };
                }
                QQ_msgjson.Áæ§ËÅä[name].members = members || [];

                const randomBackground = getRandomChatBackground();
                let cssRule = chat_headraw_namespaceObject.replace(/\$\{name\}/g, name).replace(/\$\{head\}/g, headStr);
                
                if (randomBackground) {
                    const backgroundCSS = `
.QQ_chat_page[data-name='${name}'] {
    --BackGroundImg: url('${randomBackground}');
    background-image: var(--BackGroundImg) !important;
}`;
                    cssRule += backgroundCSS;
                }

                const style = $("<style></style>").prop("type", "text/css");
                style.text(cssRule);
                $("head").append(style);
                
                // *** Ê†∏ÂøÉÊîπÂä®ÔºöÁõ¥Êé•Âú®Ê≠§Â§ÑÁîüÊàêÊ¨¢ËøéÊ∂àÊÅØ ***
                addGroupWelcomeMessages(name, members);

                // *** ‰øÆÂ§çÔºöÂú®ÂàõÂª∫Áæ§ËÅäÂêéÁ´ãÂç≥Êõ¥Êñ∞ÊúÄÂêéÊ∂àÊÅØÊòæÁ§∫ ***
                setTimeout(() => {
                    updateGroupLastMessageDisplay(name);
                    QQ_UpdateMessageList();
                }, 100);

                console.log(`Áæ§ËÅä ${name} ÂàõÂª∫/Êõ¥Êñ∞ÊµÅÁ®ãÂÆåÊàê`);
            }

            /**
             * ‰∏∫Áæ§ËÅäÊ∑ªÂä†ÂàùÂßãÊ¨¢ËøéÊ∂àÊÅØ (Âº∫Âà∂Ë¶ÜÁõñÁâà)
             */
            function addGroupWelcomeMessages(groupName, members) {
                console.log(`addGroupWelcomeMessages Ë¢´Ë∞ÉÁî®: ${groupName}`);
                
                // *** Á¨¨‰∏ÄÂ±ÇÊ£ÄÊü•ÔºöSessionÁ∫ßÈò≤ÈáçÂ§çÊú∫Âà∂ ***
                if (QQ_GroupInitializedSet.has(groupName)) {
                    console.log(`Áæ§ËÅä ${groupName} Âú®ÂΩìÂâç‰ºöËØù‰∏≠Â∑≤ÂàùÂßãÂåñËøáÔºåË∑≥ËøáÊ∑ªÂä†`);
                    return;
                }
                
                if (!QQ_msgjson.Áæ§ËÅä[groupName]) {
                    QQ_msgjson.Áæ§ËÅä[groupName] = { msgs: [], members: members || [] };
                }
                
                const groupData = QQ_msgjson.Áæ§ËÅä[groupName];
                
                // *** Á¨¨‰∫åÂ±ÇÊ£ÄÊü•ÔºöÊõ¥‰∏•Ê†ºÁöÑÊ£ÄÊü•ÊòØÂê¶Â∑≤ÊúâÁ≥ªÁªüÂàùÂßãÊ∂àÊÅØÔºåÈÅøÂÖçÈáçÂ§çÊ∑ªÂä† ***
                const hasInitialMessages = groupData.msgs.some(msg => {
                    if (!msg.startsWith('Á≥ªÁªüÊ∂àÊÅØ--')) return false;
                    
                    // Ê£ÄÊü•Ê∂àÊÅØÂÜÖÂÆπÈÉ®ÂàÜÔºàÁ¨¨‰∫å‰∏™--ÂàÜÈöîÁöÑÈÉ®ÂàÜÔºâ
                    const parts = msg.split('--');
                    if (parts.length < 2) return false;
                    
                    const content = parts[1];
                    return content.includes('ÂàõÂª∫ÊàêÂäü') || 
                           content.includes('Âä†ÂÖ•‰∫ÜÁæ§ËÅä') ||
                           /^\d{2}:\d{2}$/.test(content); // Á∫ØÊó∂Èó¥Ê∂àÊÅØÊ†ºÂºè
                });
                
                if (hasInitialMessages) {
                    console.log(`Áæ§ËÅä ${groupName} Â∑≤ÊúâÁ≥ªÁªüÂàùÂßãÊ∂àÊÅØÔºåË∑≥ËøáÊ∑ªÂä†`);
                    console.log(`Áé∞ÊúâÊ∂àÊÅØÂàóË°®:`, groupData.msgs.slice(0, 5)); // ÊòæÁ§∫Ââç5Êù°Ê∂àÊÅØ‰æø‰∫éË∞ÉËØï
                    // Ê†áËÆ∞‰∏∫Â∑≤ÂàùÂßãÂåñÔºåÈÅøÂÖçÂêéÁª≠ÈáçÂ§çÊ£ÄÊü•
                    QQ_GroupInitializedSet.add(groupName);
                    return;
                }
                
                if (groupData.msgs.length > 0) {
                    console.log(`Áæ§ËÅä ${groupName} Â∑≤Êúâ ${groupData.msgs.length} Êù°ÈùûÁ≥ªÁªüÊ∂àÊÅØÔºå‰ΩÜÁº∫Â∞ëÂàùÂßãÊ∂àÊÅØÔºåÂ∞ÜÊ∑ªÂä†`);
                }

                const currentTime = new Date().toLocaleTimeString('zh-CN', { 
                    hour12: false, 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                // Ê∑ªÂä†Áæ§ËÅäÂàõÂª∫Á≥ªÁªüÊ∂àÊÅØ
                const systemMsg = `Á≥ªÁªüÊ∂àÊÅØ--${currentTime}--Áæ§ËÅä"${groupName}"ÂàõÂª∫ÊàêÂäüÔºåÂºÄÂßãËÅäÂ§©ÂêßÔºÅ`;
                groupData.msgs.push(systemMsg);
                
                // Ê∑ªÂä†ÊàêÂëòÂä†ÂÖ•Ê∂àÊÅØ
                if (members && members.length > 0) {
                    members.forEach(member => {
                        const joinMsg = `Á≥ªÁªüÊ∂àÊÅØ--${currentTime}--${member} Âä†ÂÖ•‰∫ÜÁæ§ËÅä`;
                        groupData.msgs.push(joinMsg);
                    });
                }
                
                // *** ‰øÆÂ§çÔºöÂú®ÊâÄÊúâÂä†ÂÖ•Ê∂àÊÅØÂêéÊ∑ªÂä†Êó∂Èó¥Á≥ªÁªüÊ∂àÊÅØÔºåËÄå‰∏çÊòØÁî®Êà∑Ê∂àÊÅØ ***
                const timeMsg = `Á≥ªÁªüÊ∂àÊÅØ--${currentTime}--${currentTime}`;
                groupData.msgs.push(timeMsg);
                
                // *** Êñ∞Â¢ûÔºöÁ´ãÂç≥Êõ¥Êñ∞Áæ§ËÅäÁöÑÊúÄÂêéÊ∂àÊÅØÂíåÊó∂Èó¥ÊòæÁ§∫ ***
                updateGroupLastMessageDisplay(groupName);
                
                // *** Êñ∞Â¢ûÔºöÊ†áËÆ∞Áæ§ËÅäÂ∑≤ÂàùÂßãÂåñÔºåÈÅøÂÖçÈáçÂ§çÊ∑ªÂä† ***
                QQ_GroupInitializedSet.add(groupName);
                
                console.log(`‰∏∫Áæ§ËÅä ${groupName} ÁîüÊàê‰∫Ü ${groupData.msgs.length} Êù°Êñ∞ÁöÑÂàùÂßãÊ∂àÊÅØ„ÄÇ`);
            }
            
            /**
             * Êõ¥Êñ∞Áæ§ËÅäÁöÑÊúÄÂêéÊ∂àÊÅØÂíåÊó∂Èó¥ÊòæÁ§∫
             */
            function updateGroupLastMessageDisplay(groupName) {
                const groupData = QQ_msgjson.Áæ§ËÅä[groupName];
                if (!groupData || !groupData.msgs || groupData.msgs.length === 0) {
                    return;
                }
                
                // Ëé∑ÂèñÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØ
                const lastMsgRaw = groupData.msgs[groupData.msgs.length - 1];
                const msgParts = lastMsgRaw.split('--');
                
                if (msgParts.length >= 3) {
                    const sender = msgParts[0];
                    const content = msgParts[1];
                    const time = msgParts[2] || '';
                    
                    let displayMsg = content;
                    let displayTime = time;
                    
                    // Â¶ÇÊûúÊòØÁ≥ªÁªüÊ∂àÊÅØÔºåÁõ¥Êé•ÊòæÁ§∫ÂÜÖÂÆπ
                    if (sender === 'Á≥ªÁªüÊ∂àÊÅØ') {
                        displayMsg = content;
                    } else {
                        // Â¶ÇÊûúÊòØÁî®Êà∑Ê∂àÊÅØÔºåÊòæÁ§∫‰∏∫ "ÂèëÈÄÅËÄÖ: ÂÜÖÂÆπ"
                        displayMsg = `${sender}: ${content}`;
                    }
                    
                    // ÈôêÂà∂Ê∂àÊÅØÈïøÂ∫¶ÈÅøÂÖçÁïåÈù¢ËøáÂÆΩ
                    if (displayMsg.length > 20) {
                        displayMsg = displayMsg.substring(0, 20) + '...';
                    }
                    
                    // Êõ¥Êñ∞ÁïåÈù¢ÊòæÁ§∫
                    $(`.QQ_home_usermsg[data-name='${groupName}'] .QQ_home_lastmsg`).text(displayMsg);
                    $(`.QQ_home_usermsg[data-name='${groupName}'] .QQ_home_lasttime`).text(displayTime);
                    
                    console.log(`Áæ§ËÅä ${groupName} ÊúÄÂêéÊ∂àÊÅØÂ∑≤Êõ¥Êñ∞: ${displayMsg} (${displayTime})`);
                }
            }
            
            function getFilenameWithoutExtension(path) {
                // Ëß£Á†ÅURIÁªÑ‰ª∂ÔºàÂ§ÑÁêÜÁâπÊÆäÂ≠óÁ¨¶Ôºâ
                const decodedPath = decodeURIComponent(path);
                // ÂàÜÂâ≤Ë∑ØÂæÑÂπ∂Ëé∑ÂèñÊñá‰ª∂ÂêçÈÉ®ÂàÜ
                const filename = decodedPath.split("/").pop();
                // ÊâæÂà∞ÊúÄÂêé‰∏Ä‰∏™ÁÇπÁöÑ‰ΩçÁΩÆ
                const lastDotIndex = filename.lastIndexOf(".");
                // Âà§Êñ≠Âπ∂Êà™ÂèñÊñá‰ª∂ÂêçÔºàÊó†ÂêéÁºÄÔºâ
                return lastDotIndex > 0
                    ? filename.slice(0, lastDotIndex)
                    : filename;
            }
            function QQ_page(id) {
                if (id == "message") {
                    console.log("ÁÇπÂáª‰∫ÜÊ∂àÊÅØÈ°µ");
                    $("#QQ_home_page").show();
                    $("#QQ_space_page").hide();
                    $(".QQ_chat_page").hide();
                    $("#QQ_message_svg").css("fill", "#019aff");
                    $("#QQ_people_svg").css("fill", "#000000");
                    $("#QQ_moment_svg").css("fill", "#000000");
                    $("#App_QQ").css("background-color", "#eff3ff");
                } else if (id == "people") {
                    console.log("ÁÇπÂáª‰∫ÜËÅîÁ≥ª‰∫∫");
                } else if (id == "moment") {
                    console.log("ÁÇπÂáª‰∫ÜÂä®ÊÄÅÈ°µ");
                    $("#QQ_home_page").hide();
                    $("#QQ_space_page").show();
                    $(".QQ_chat_page").hide();
                    $("#QQ_moment_svg").css("fill", "#019aff");
                    $("#QQ_people_svg").css("fill", "#000000");
                    $("#QQ_message_svg").css("fill", "#000000");
                    $("#App_QQ").css("background-color", "#ffffff");
                    QQ_SetNewTips(0);
                    QQ_NewMsg["moment"] = 0;
                    $(".new_tips").hide();
                }
            }
            function QQ_SetNewTips(count) {
                let tips = $(".new_tips");
                tips.each(function () {
                    if (count == 0) {
                        $(this).css("display", "none");
                    } else {
                        $(this).css("display", "flex").text(count);
                    }
                });
            }
            
            async function QQ_UpdateMessageList() {
                console.log("ÂºÄÂßãÊõ¥Êñ∞Ê∂àÊÅØÂàóË°®");
                
                // ‰∏çÂÜçËá™Âä®ÈáçÊñ∞Âä†ËΩΩÁæ§ËÅäÔºåÈÅøÂÖçÈáçÂ§çÂæ™ÁéØ
                console.log('ÂΩìÂâçQQ_GroupsÁä∂ÊÄÅ:', QQ_Groups.length, '‰∏™Áæ§ËÅä');
                
                const $messageChars = $("#QQ_message_list_chars");
                const $homeChars = $("#QQ_home_chars");
                
                // Ê∏ÖÁ©∫Ê∂àÊÅØÈ°µÈù¢ÁöÑËÅîÁ≥ª‰∫∫ÂàóË°®
                $messageChars.empty();
                
                // Âè™Â§çÂà∂ËÅîÁ≥ª‰∫∫È°πÁõÆÔºå‰∏çÂ§çÂà∂ÊêúÁ¥¢Ê°Ü
                const $homeContacts = $homeChars.find('.QQ_home_usermsg');
                
                // ÁÑ∂ÂêéËøáÊª§ÔºåÂè™ÊòæÁ§∫ÊúâÁúüÂÆûÊ∂àÊÅØÊ≤üÈÄöËøáÁöÑËÅîÁ≥ª‰∫∫
                const contactedUsers = [];
                let firstContact = null;
                
                $homeContacts.each(function() {
                    const $contact = $(this);
                    const name = $contact.attr('data-name');
                    const $newMsgBadge = $contact.find('.QQ_home_usermsg_new');
                    const hasNewMessages = $newMsgBadge.is(':visible') && parseInt($newMsgBadge.text()) > 0;
                    const lastMsg = $contact.find('.QQ_home_lastmsg').text().trim();
                    const isGroup = $contact.attr('data-group-type') === 'true';
                    
                    if (!firstContact) {
                        firstContact = $contact.clone(true);
                    }
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÊúâÁúüÂÆûÁöÑÊ∂àÊÅØËÆ∞ÂΩï
                    let hasRealMessageRecord = false;
                    
                    // Ê£ÄÊü•ÁßÅËÅäËÆ∞ÂΩï
                    const privateChatKey = `${UserName}Âíå${name}ÁöÑËÅäÂ§©`;
                    if (QQ_msgjson && QQ_msgjson.ÁßÅËÅä && QQ_msgjson.ÁßÅËÅä[privateChatKey] && QQ_msgjson.ÁßÅËÅä[privateChatKey].length > 0) {
                        hasRealMessageRecord = true;
                    }
                    
                    // Ê£ÄÊü•Áæ§ËÅäËÆ∞ÂΩï
                    if (QQ_msgjson && QQ_msgjson.Áæ§ËÅä && QQ_msgjson.Áæ§ËÅä[name] && QQ_msgjson.Áæ§ËÅä[name].msgs && QQ_msgjson.Áæ§ËÅä[name].msgs.length > 0) {
                        hasRealMessageRecord = true;
                    }
                    
                    // Ê£ÄÊü•Êú™ËØªÊ∂àÊÅØÊï∞ÈáèÔºàÂøÖÈ°ªÂ§ß‰∫é0‰∏îÂèØËßÅÔºâ
                    const hasUnreadCount = hasNewMessages && parseInt($newMsgBadge.text()) > 0;
                    
                    // Áæ§ËÅäÁâπÊÆäÂ§ÑÁêÜÔºöÂ¶ÇÊûúÊòØÁæ§ËÅä‰∏îÂú®QQ_Groups‰∏≠ÔºåÂàôÊòæÁ§∫
                    if (isGroup) {
                        if (QQ_Groups.includes(name)) {
                            console.log('Ê∑ªÂä†Áæ§ËÅäÂà∞Ê∂àÊÅØÂàóË°®:', name);
                            contactedUsers.push($contact.clone(true));
                        }
                    } else {
                        // Âè™ÊúâÁúüÊ≠£ÊúâÊ∂àÊÅØËÆ∞ÂΩïÊàñÊú™ËØªÊ∂àÊÅØÊâçÊòæÁ§∫
                    if (hasRealMessageRecord || hasUnreadCount) {
                        contactedUsers.push($contact.clone(true));
                        }
                    }
                });
                
                // Â¶ÇÊûúÊ≤°Êúâ‰ªª‰ΩïËÅîÁ≥ªËøáÁöÑÁî®Êà∑ÔºåÂè™ÊòæÁ§∫Á¨¨‰∏Ä‰∏™ËÅîÁ≥ª‰∫∫ÔºàË¥ùÂ∞îÊ≥ïÊñØÁâπÔºâ
                if (contactedUsers.length === 0 && firstContact) {
                    $messageChars.append(firstContact);
                } else {
                    contactedUsers.forEach(function($contact) {
                        $messageChars.append($contact);
                    });
                }
                
                console.log("Ê∂àÊÅØÂàóË°®Êõ¥Êñ∞ÂÆåÊàê");
            }
            function QQ_HideAllChat() {
                // for (let name of QQ_pages) {
                //   let $page = $(`#QQ_chat_${name}`);
                //   if ($page.length === 0) {
                //     continue;
                //   }
                //   $page.hide();
                // }
                $(`.QQ_chat_page`).hide();
            }
            function QQ_ChangeChatPage(event, directName = null) {
                const $QQpage = $("#App_QQ");
                if ($QQpage.length === 0) {
                    console.log("Ëé∑ÂèñQQpageÂ§±Ë¥•");
                    return;
                }
                
                let name;
                if (directName) {
                    // Áõ¥Êé•‰º†ÂÖ•ÂêçÁß∞ÔºàÁî®‰∫éÁæ§ËÅäÔºâ
                    name = directName;
                } else {
                    // ‰ªé‰∫ã‰ª∂Ëé∑ÂèñÂêçÁß∞ÔºàÁî®‰∫éÁßÅËÅäÔºâ
                    let element = event.currentTarget;
                    name = element.getAttribute("data-name") ?? "";
                }
                
                // Ê£ÄÊü•ÊòØÂê¶‰∏∫Áæ§ËÅä
                const isGroup = QQ_Groups.includes(name);
                console.log(`ÂàáÊç¢Âà∞ËÅäÂ§©È°µ: ${name}, ÊòØÂê¶‰∏∫Áæ§ËÅä: ${isGroup}`);
                
                let $page = $(`.QQ_chat_page[data-name='${name}']`);
                if ($page.length === 0) {
                    console.log(`${name}ÁöÑËÅäÂ§©È°µ‰∏çÂ≠òÂú®,ÂºÄÂßãÂàõÂª∫`);
                    $page = $(QQ_CreatChatPage(name));
                    $QQpage.append($page);
                }
                
                // Â¶ÇÊûúÊòØÁæ§ËÅäÔºåËÆæÁΩÆÁâπÊÆäÁöÑCSSÁ±ªÂíåÂ±ûÊÄß
                if (isGroup) {
                    $page.addClass('group-chat-page');
                    $page.attr('data-group-type', 'true');
                    
                    // Êõ¥Êñ∞ËÅäÂ§©È°µÈù¢ÁöÑÊ†áÈ¢òÊòæÁ§∫Áæ§ËÅä‰ø°ÊÅØ
                    const $username = $page.find('#QQ_chat_username');
                    if ($username.length > 0) {
                        const groupData = QQ_msgjson.Áæ§ËÅä[name];
                        const memberCount = groupData && groupData.members ? groupData.members.length : 0;
                        $username.html(`${name} <span style="font-size: 12px; color: #999; font-weight: normal;">(${memberCount}‰∫∫)</span>`);
                    }
                    
                    // Á°Æ‰øùÁæ§ËÅäËæìÂÖ•Ê°ÜÊúâÊ≠£Á°ÆÁöÑÁ±ªÂêçÂíåÂ±ûÊÄß
                    const $input = $page.find('.QQ_chat_input');
                    $input.addClass('userInput');
                    $input.attr('data-name', name);
                }
                
                QQ_SetHomeTips(name, "0");
                
                // *** Êñ∞Â¢ûÔºöÁÇπÂáªËÅäÂ§©Êó∂Ê†áËÆ∞‰∏∫Â∑≤ËØª ***
                QQ_MarkAsRead(name);
                
                // *** Êñ∞Â¢ûÔºöÈ°µÈù¢ÂàáÊç¢Êó∂ÈöêËóèÂÖ∂‰ªñËßíËâ≤ÁöÑÁ≤æÁÅµÊåâÈíÆÔºåÂè™‰øùÁïôÂΩìÂâçËßíËâ≤ÁöÑÁ≤æÁÅµ ***
                if (!isGroup) {
                    // ÁßÅËÅäÈ°µÈù¢ÔºåÈöêËóèÂÖ∂‰ªñËßíËâ≤ÁöÑÁ≤æÁÅµÔºåÊòæÁ§∫ÂΩìÂâçËßíËâ≤ÁöÑÁ≤æÁÅµ
                    Object.keys(QQ_CharacterSpirits).forEach(characterName => {
                        if (characterName !== name) {
                            QQ_HideCharacterSpirit(characterName);
                        }
                    });
                } else {
                    // Áæ§ËÅäÈ°µÈù¢ÔºåÈöêËóèÊâÄÊúâËßíËâ≤Á≤æÁÅµ
                    QQ_HideAllCharacterSpirits();
                }
                
                QQ_HideAllChat();
                // ÈöêËóèQQ‰∏ªÈ°µÂíåÊ∂àÊÅØÈ°µÈù¢
                $("#QQ_home_page").hide();
                $("#QQ_message_list_page").hide();
                $("#QQ_space_page").hide();
                // ÈöêËóèÂ∫ïÈÉ®ÂØºËà™Ê†è
                $(".QQ_bottom_nav").hide();
                $page.show();
                console.log(`ÊòæÁ§∫ËÅäÂ§©È°µ:QQ_chat_${name}`);
                let $msgContent = $page.find(".msgcontent");
                $msgContent.scrollTop($msgContent[0].scrollHeight);
                let TipsCount = QQ_GetChatShowTipsCount(name);
                const $Tips = $page.find(`.new_tips`);
                $Tips.text(TipsCount);
                if (TipsCount > 0) {
                    $Tips.css("display", "flex");
                } else {
                    $Tips.hide();
                }
            }
            /**
             * ÂàõÂª∫ËÅäÂ§©È°µ
             * @param name ËÅäÂ§©È°µÂêçÁß∞
             * @returns ËÅäÂ§©È°µHTML
             */
             function QQ_CreatChatPage(name) {
                console.log(`ÂàõÂª∫ËÅäÂ§©È°µ: ${name}`);
                const isGroup = QQ_Groups.includes(name);
                
                // ‰ΩøÁî®Ê®°ÊùøÂàõÂª∫È°µÈù¢
                let $page = $(_.template(chat_page)({
                    name: name,
                    isGroup: isGroup,
                    members: isGroup ? (QQ_msgjson.Áæ§ËÅä[name]?.members || []).join(', ') : ''
                }));

                // Â∞ÜÊñ∞ÂàõÂª∫ÁöÑÈ°µÈù¢Ê∑ªÂä†Âà∞DOM‰∏≠
                $("#App_QQ").append($page);
                
                // *** Ê†∏ÂøÉ‰øÆÂ§çÔºöÂàõÂª∫È°µÈù¢ÂêéÔºåÁ´ãÂç≥Âä†ËΩΩÂπ∂ÊòæÁ§∫Â∑≤ÊúâÊ∂àÊÅØÔºàÊîØÊåÅÂàÜÈ°µÔºâ ***
                const $msgContent = $page.find(".msgcontent");
                let allMessages = [];
                
                if (isGroup && QQ_msgjson.Áæ§ËÅä[name] && QQ_msgjson.Áæ§ËÅä[name].msgs) {
                    allMessages = QQ_msgjson.Áæ§ËÅä[name].msgs;
                } else if (!isGroup && QQ_msgjson.ÁßÅËÅä[`${UserName}Âíå${name}ÁöÑËÅäÂ§©`]) {
                    allMessages = QQ_msgjson.ÁßÅËÅä[`${UserName}Âíå${name}ÁöÑËÅäÂ§©`];
                }
                
                if (allMessages.length > 0) {
                    console.log(`‰∏∫Êñ∞ÂàõÂª∫ÁöÑËÅäÂ§© ${name} Âä†ËΩΩÊ∂àÊÅØÔºåÊÄªÊï∞: ${allMessages.length}`);
                    
                    // ÂàùÂßãÂåñÊòæÁ§∫ËÆ°Êï∞
                    chatDisplayCounts[name] = 0;
                    
                    // ËÆ°ÁÆóË¶ÅÊòæÁ§∫ÁöÑÊ∂àÊÅØÊï∞ÈáèÔºà‰ªéÊúÄÊñ∞ÁöÑÂºÄÂßãÔºåÊúÄÂ§öÊòæÁ§∫CHAT_DISPLAY_LIMITÊù°Ôºâ
                    const startIndex = Math.max(0, allMessages.length - CHAT_DISPLAY_LIMIT);
                    const messagesToShow = allMessages.slice(startIndex);
                    
                    // Ê∑ªÂä†Ê∂àÊÅØÂà∞ÁïåÈù¢
                    messagesToShow.forEach(msg => {
                        QQ_Chat_AddMsg($msgContent[0], msg, name, false, true); // Ë∑≥ËøáÂàÜÈ°µÊéßÂà∂
                    });
                    
                    // Êõ¥Êñ∞ÊòæÁ§∫ËÆ°Êï∞
                    chatDisplayCounts[name] = messagesToShow.length;
                    
                    // Ê∑ªÂä†"Âä†ËΩΩÊõ¥Â§ö"ÊåâÈíÆÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
                    QQ_Update_Chat_LoadMore(name, $msgContent[0]);
                    
                    console.log(`ËÅäÂ§©È°µÈù¢Âä†ËΩΩÂÆåÊàê: ÊòæÁ§∫ ${messagesToShow.length}/${allMessages.length} Êù°Ê∂àÊÅØ`);
                }
                
                // ÊªöÂä®Âà∞Â∫ïÈÉ®
                $msgContent.scrollTop($msgContent[0].scrollHeight);

                return $page;
            }
            function QQ_Msg_DelUserKey(content) {
                let json = JsonYamlParse(content);
                if (!json) {
                    return content;
                }
                let others = "";
                if (`${UserName}` in json.ÁßÅËÅä == false) {
                    return content;
                }
                for (let msg of json.ÁßÅËÅä[`${UserName}`]) {
                    const sp = msg.split("--");
                    if (sp.length <= 0) {
                        continue;
                    }
                    if (sp[0] != `${UserName}`) {
                        if (!others) {
                            others = sp[0];
                        } else if (sp[0] != others) {
                            // Âá∫Áé∞Á¨¨‰∏â‰∏™ÂêçÂ≠ó,Ëøá‰∫éÂ§çÊùÇ‰∏çÂÅöÂ§ÑÁêÜ
                            return content;
                        }
                    }
                }
                if (!others) {
                    // Ê≤°ÂèñÂà∞ÂØπÊñπÂêçÂ≠ó
                    if (json.ÁßÅËÅä[`${UserName}`].length == 0) {
                        delete json.ÁßÅËÅä[`${UserName}`];
                        return JSON.stringify(json);
                    }
                    return content;
                }
                if (others in json.ÁßÅËÅä == false) {
                    // ‰∏çÂ≠òÂú®ÂØπÊñπÂêçÂ≠óÈîÆ,Áõ¥Êé•ÊîπÂêç
                    const newvalue = json.ÁßÅËÅä[`${UserName}`];
                    delete json.ÁßÅËÅä[`${UserName}`];
                    json.ÁßÅËÅä[others] = newvalue;
                    return JSON.stringify(json);
                } else if (json.ÁßÅËÅä[others].length == 0) {
                    // Â≠òÂú®‰ΩÜ‰∏∫Á©∫
                    const newvalue = json.ÁßÅËÅä[`${UserName}`];
                    delete json.ÁßÅËÅä[`${UserName}`];
                    json.ÁßÅËÅä[others] = newvalue;
                    return JSON.stringify(json);
                }
                return content;
            }
            function QQ_AddNpcHead(content) {
                let json = JsonYamlParse(content);
                if (!json) {
                    return content;
                }
                // Â§¥ÂÉè‰øÆÂ§ç
                const Sections = QQ_CharSettings.getAllSections();
                let newcss = "";
                for (let str in json.ÁßÅËÅä) {
                    for (const msg of json.ÁßÅËÅä[str]) {
                        const sp = msg.split("--");
                        if (sp.length <= 1) {
                            continue;
                        }
                        const name = sp[0];
                        if (!Sections.includes(name) && name != `${UserName}`) {
                            // Ë∑Ø‰∫∫,ËÆæÁΩÆÈöèÊú∫Â§¥ÂÉè
                            System_AddNpcHead(name);
                        }
                    }
                }
                for (let Group in json.Áæ§ËÅä) {
                    for (const msg of json.Áæ§ËÅä[Group].msgs) {
                        const sp = msg.split("--");
                        if (sp.length <= 0) {
                            continue;
                        }
                        const name = sp[0];
                        if (!Sections.includes(name) && name != `${UserName}`) {
                            // Ë∑Ø‰∫∫,ËÆæÁΩÆÈöèÊú∫Â§¥ÂÉè
                            System_AddNpcHead(name);
                        }
                    }
                }
            }
            function QQ_Msg_Repair(content) {
                let json = JsonYamlParse(content);
                if (!json) {
                    return content;
                }
                // ‰øÆÊ≠£È°∫Â∫è
                for (let str in json.ÁßÅËÅä) {
                    const match = str.match(/(.+?)Âíå(.+?)ÁöÑËÅäÂ§©/);
                    if (!match) {
                        // ÊóßÁâàÊú¨Âè™Êúâ‰∏Ä‰∏™ÂêçÂ≠ó
                        if (str != `${UserName}`) {
                            const value = json.ÁßÅËÅä[str];
                            delete json.ÁßÅËÅä[str];
                            json.ÁßÅËÅä[`${UserName}Âíå${str}ÁöÑËÅäÂ§©`] = value;
                        } else {
                            delete json.ÁßÅËÅä[str];
                        }
                        continue;
                    }
                    if (
                        match[1] != `${UserName}` &&
                        match[2] != `${UserName}`
                    ) {
                        // ‰ø©ËßíËâ≤‰πãÈó¥ÁöÑÁßÅËÅä,Â±û‰∫éÁâπÊÆäÊÉÖÂÜµÁõ¥Êé•Âà†‰∫Ü
                        console.log(`Âà†Èô§:${str}`);
                        delete json.ÁßÅËÅä[str];
                        continue;
                    }
                    if (
                        match[1] != `${UserName}` &&
                        match[2] == `${UserName}`
                    ) {
                        // È°∫Â∫èÂèç‰∫Ü
                        const value = json.ÁßÅËÅä[str];
                        delete json.ÁßÅËÅä[str];
                        json.ÁßÅËÅä[`${UserName}Âíå${match[1]}ÁöÑËÅäÂ§©`] = value;
                    }
                }
                // ‰øÆÊ≠£ÁΩëÂêç
                const keys = QQ_CharSettings.getAllSections();
                for (let str in json.ÁßÅËÅä) {
                    const match = str.match(/(.+?)Âíå(.+?)ÁöÑËÅäÂ§©/);
                    if (!match) {
                        continue;
                    }
                    // ‰∏çÁÆ°ÊúâÊ≤°ÊúâÈîôÂÖà‰øÆÊ≠£‰∏ÄÊ¨°ÂÜÖÂÆπ
                    let value = QQ_NickNameRepair(json.ÁßÅËÅä[str]);
                    json.ÁßÅËÅä[str] = value;
                    const localname = match[2];
                    if (!keys.includes(localname)) {
                        // ÈîÆÂêçÊòØÁî®ÁöÑÁΩëÂêç,‰øÆÊ≠£
                        for (const char of keys) {
                            let find = false;
                            const namelist = QQ_CharSettings.readValue(
                                char,
                                "ÁΩëÂêç",
                            ).split(",");
                            if (!namelist || namelist.length == 0) {
                                continue;
                            }
                            for (const name of namelist) {
                                const regex = createRegExp(name);
                                if (!name || !regex) {
                                    continue;
                                }
                                if (localname.match(regex)) {
                                    delete json.ÁßÅËÅä[str];
                                    json.ÁßÅËÅä[`${UserName}Âíå${char}ÁöÑËÅäÂ§©`] =
                                        value;
                                    find = true;
                                    break;
                                }
                            }
                            if (find) {
                                break;
                            }
                        }
                    }
                }
                for (const Group in json.Áæ§ËÅä) {
                    json.Áæ§ËÅä[Group].msgs = QQ_NickNameRepair(
                        json.Áæ§ËÅä[Group].msgs,
                    );
                }
                QQ_AddNpcHead(JSON.stringify(json));
                return JSON.stringify(json);
            }
            function QQ_NickNameRepair(content) {
                if (!content || content.length == 0) {
                    return content;
                }
                let charlist = QQ_CharSettings.getAllSections();
                let result = [];
                for (let str of content) {
                    const match = str.match(/(.+?)--([\s\S]+)/);
                    if (match && match[1] != UserName) {
                        const localname = match[1];
                        if (!charlist.includes(localname)) {
                            for (const char of charlist) {
                                let find = false;
                                const namelist = QQ_CharSettings.readValue(
                                    char,
                                    "ÁΩëÂêç",
                                ).split(",");
                                if (!namelist || namelist.length == 0) {
                                    continue;
                                }
                                for (const name of namelist) {
                                    if (!name) {
                                        continue;
                                    }
                                    if (name.match(/^\/(.+)\/([gimuy]*)$/)) {
                                        // ÂêçÂ≠óÊòØÊ≠£ÂàôË°®ËææÂºè
                                        const regex = createRegExp(name);
                                        if (!regex) {
                                            continue;
                                        }
                                        if (localname.match(regex)) {
                                            str = `${char}--${match[2]}`;
                                            find = true;
                                            break;
                                        }
                                    } else {
                                        // ÂêçÂ≠ó‰∏çÊòØÊ≠£ÂàôË°®ËææÂºè
                                        if (namelist.includes(localname)) {
                                            str = `${char}--${match[2]}`;
                                            find = true;
                                            break;
                                        }
                                    }
                                }
                                if (find) {
                                    break;
                                }
                            }
                        }
                    }
                    result.push(str);
                }
                return result;
            }
            function createRegExp(pattern) {
                if (!pattern) return null;
                // Â¶ÇÊûúÂ∑≤ÁªèÊòØRegExpÂØπË±°ÔºåÁõ¥Êé•ËøîÂõû
                if (pattern instanceof RegExp) return pattern;
                try {
                    // Ê£ÄÊü•ÊòØÂê¶ÊòØ /pattern/flags Ê†ºÂºè
                    const regexMatch = pattern.match(/^\/(.+)\/([gimuy]*)$/);
                    if (regexMatch) {
                        // ÊèêÂèñÊ≠£ÂàôË°®ËææÂºèÁöÑÊ®°ÂºèÂíåÊ†áÂøó
                        const [_, regexPattern, flags] = regexMatch;
                        return new RegExp(regexPattern, flags);
                    } else {
                        // ‰∏çÂ∏¶/ÁöÑÁ∫ØÂ≠óÁ¨¶‰∏≤Ê†ºÂºèÔºåÈªòËÆ§‰∏çÂä†‰ªª‰ΩïÊ†áÂøó
                        return new RegExp(pattern);
                    }
                } catch (error) {
                    console.error("ÂàõÂª∫Ê≠£ÂàôË°®ËææÂºèÂ§±Ë¥•:", error);
                    return null;
                }
            }
            /**
             * ÂàùÂßãÂåñÊó∂Ëß£ÊûêËÅäÂ§©Ê∂àÊÅØ
             * @param content ËÅäÂ§©Ê∂àÊÅØÂÜÖÂÆπ
             */
            async function QQ_Msg_Parse(content) {
                //content = QQ_Msg_Repair(content);
                console.log(`ÂºÄÂßãËß£ÊûêËÅäÂ§©Ê∂àÊÅØ:${content}`);
                let hasstr = false;
                if (content.match(/\S/)) {
                    hasstr = true;
                }
                let json = JsonYamlParse(content);
                if (!json) {
                    if (hasstr) {
                        QQ_Error(`Ëß£ÊûêËÅäÂ§©ËÆ∞ÂΩïÂ§±Ë¥•,ËØ∑ÊâãÂä®Ëß£ÂÜ≥`);
                    }
                    // QQ_Error(`yamlËß£ÊûêÂ§±Ë¥•`);
                    return;
                }
                console.log(`Ëß£ÊûêÊàêÂäüÊó∂ÁöÑËÅäÂ§©Ê∂àÊÅØ:${JSON.stringify(json)}`);
                const $QQpage = $("#App_QQ");
                if ($QQpage.length === 0) {
                    console.log("Ëé∑ÂèñQQpageÂ§±Ë¥•");
                    return;
                }
                for (let str in json.ÁßÅËÅä) {
                    const match = str.match(/(.+?)Âíå(.+?)ÁöÑËÅäÂ§©/);
                    if (!match) {
                        continue;
                    }
                    let name = "";
                    if (match[1] != `${UserName}`) {
                        name = match[1];
                    } else if (match[2] != `${UserName}`) {
                        name = match[2];
                    } else {
                        continue;
                    }
                    try {
                        if (!QQ_msgjson.ÁßÅËÅä[str]) {
                            QQ_msgjson.ÁßÅËÅä[str] = [];
                        }
                        if (!QQ_NewMsg[name]) {
                            QQ_NewMsg[name] = {};
                        }
                        if (
                            !$(`.QQ_home_usermsg[data-name='${name}']`)
                                .length &&
                            name != `${UserName}`
                        ) {
                            console.log(`${name}ÁöÑ‰∏ªÈ°µ‰∏çÂ≠òÂú®,ÂºÄÂßãÂàõÂª∫`);
                            AddNewChar(name, "");
                        }
                        let $page = $(`.QQ_chat_page[data-name='${name}']`);
                        let Creat = false;
                        if ($page.length === 0) {
                            Creat = true;
                            console.log(`${name}ÁöÑËÅäÂ§©È°µ‰∏çÂ≠òÂú®,ÂºÄÂßãÂàõÂª∫123`);
                            $page = $(QQ_CreatChatPage(`${name}`));
                            $QQpage.append($page);
                        }
                        if (json.ÁßÅËÅä[str].length == 0) {
                            continue;
                        }
                        let $msgContent = $page.find(".msgcontent");
                        let NewMsgCount = 0;
                        let LastTime = "";
                        let LastMsg = "";
                        for (let msg of json.ÁßÅËÅä[str]) {
                            // Ê£ÄÊü•ÊòØÂê¶‰∏∫Êñ∞Ê∂àÊÅØÔºà‰∏çÂú®Áé∞ÊúâÊ∂àÊÅØÂàóË°®‰∏≠Ôºâ
                            const isNewMsg = !QQ_msgjson.ÁßÅËÅä[str].includes(msg);
                            QQ_Chat_AddMsg($msgContent[0], msg, name, isNewMsg);
                            QQ_msgjson.ÁßÅËÅä[str].push(msg);
                            let sp = msg.split("--");
                            if (sp.length >= 2) {
                                if (sp[0] == `${UserName}`) {
                                    User_LastMsgMap.ÁßÅËÅä[name] =
                                        `${sp[0]}--${sp[1]}`;
                                } else if (sp[0] == name) {
                                    if (sp.length >= 3) {
                                        Char_LastMsgMap.ÁßÅËÅä[name] =
                                            `${sp[0]}--${sp[1]}--${sp[2]}`;
                                    } else {
                                        Char_LastMsgMap.ÁßÅËÅä[name] =
                                            `${sp[0]}--${sp[1]}`;
                                    }
                                }
                            }
                            if (sp.length >= 3) {
                                LastTime = sp[2];
                            }
                            LastMsg = sp[1];
                        }
                        
                        // *** Êñ∞ÁöÑÊú™ËØªÊ∂àÊÅØËÆ°ÁÆóÈÄªËæëÔºö‰ΩøÁî®QQ_CalculateUnreadCount ***
                        NewMsgCount = QQ_CalculateUnreadCount(name, QQ_msgjson.ÁßÅËÅä[str], 'private');
                        console.log(`ÁßÅËÅä ${name} ËÆ°ÁÆóÊú™ËØªÊ∂àÊÅØ: ${NewMsgCount}`);
                        // ËÆæÁΩÆÁ∫¢ÁÇπÂíåÈ¶ñÈ°µÊòæÁ§∫ÁöÑÊ∂àÊÅØ
                        if (
                            $(`.QQ_chat_page[data-name='${name}']`).css(
                                "display",
                            ) != "none" &&
                            !Creat
                        ) {
                            console.log(`display‰∏ç‰∏∫none,Á∫¢ÁÇπ‰∏∫0  ${name}`);
                            NewMsgCount = 0;
                        }
                        $(
                            `.QQ_home_usermsg[data-name='${name}'] .QQ_home_lastmsg`,
                        ).text(LastMsg);
                        $(
                            `.QQ_home_usermsg[data-name='${name}'] .QQ_home_lasttime`,
                        ).text(LastTime);
                        QQ_SetHomeTips(name, NewMsgCount);
                        $msgContent.scrollTop($msgContent[0].scrollHeight);
                        
                        // *** Êñ∞Â¢ûÔºöÊõ¥Êñ∞ÂàÜÈ°µÊåâÈíÆ ***
                        if (NewMsgCount > 0) {
                            QQ_Update_Chat_LoadMore(name, $msgContent[0]);
                        }
                        
                        // ÊúâÊñ∞Ê∂àÊÅØÊó∂Êõ¥Êñ∞Ê∂àÊÅØÂàóË°®
                        QQ_UpdateMessageList();
                    } catch (error) {
                        throw error;
                        assertIsError(error);
                        //QQ_Error(error.message);
                    }
                }
                for (let name in json.Áæ§ËÅä) {
                    try {
                        if (!QQ_msgjson.Áæ§ËÅä[name]) {
                            QQ_msgjson.Áæ§ËÅä[name] = {};
                            QQ_msgjson.Áæ§ËÅä[name]["members"] =
                                json.Áæ§ËÅä[name]["members"];
                            QQ_msgjson.Áæ§ËÅä[name]["msgs"] = [];
                        }
                        // Ê£ÄÊü•ÊòØÂê¶ÊòØÂ∑≤Â≠òÂú®ÁöÑÁæ§ËÅä
                        let existingGroupElement = $(`.QQ_home_usermsg[data-name='${name}']`);
                        let isExistingGroup = false;
                        
                        // Ê£ÄÊü•ÊòØÂê¶Âú®Â≠òÂÇ®ÁöÑÁæ§ËÅäÂàóË°®‰∏≠
                        const storedGroups = await loadGroupChatsFromWorldbook();
                        const storedGroup = storedGroups.find(g => g.name === name);
                        
                        if (existingGroupElement.length > 0) {
                            // Áæ§ËÅäÂÖÉÁ¥†Â∑≤Â≠òÂú®
                            isExistingGroup = true;
                            console.log(`Áæ§ËÅä ${name} Â∑≤Â≠òÂú®Ôºå‰ΩøÁî®Áé∞ÊúâÁæ§ËÅä`);
                        } else if (storedGroup) {
                            // Áæ§ËÅäÂú®Â≠òÂÇ®‰∏≠Â≠òÂú®Ôºå‰ΩÜÁïåÈù¢ÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºåÈáçÊñ∞ÂàõÂª∫
                            console.log(`Áæ§ËÅä ${name} Âú®Â≠òÂÇ®‰∏≠Â≠òÂú®ÔºåÈáçÊñ∞ÂàõÂª∫ÁïåÈù¢ÂÖÉÁ¥†`);
                            AddNewGroup(storedGroup.name, storedGroup.avatar || 'https://files.catbox.moe/skngqq.jpg', storedGroup.members, storedGroup.description);
                            isExistingGroup = true;
                        } else {
                            // ËøôÊòØ‰∏Ä‰∏™ÂÖ®Êñ∞ÁöÑÁæ§ËÅäÔºåÈúÄË¶ÅÊô∫ËÉΩÂ§ÑÁêÜ
                            console.log(`Ê£ÄÊµãÂà∞Êñ∞Áæ§ËÅä: ${name}ÔºåÂºÄÂßãÊô∫ËÉΩË∑ØÁî±Â§ÑÁêÜ`);
                            
                            let redirected = false;
                            
                            // Êô∫ËÉΩÊ∂àÊÅØË∑ØÁî±ÔºöÊ£ÄÊü•Ê∂àÊÅØ‰∏≠ÊòØÂê¶ÂåÖÂê´Áî®Êà∑ÂèëÈÄÅÁöÑÂÜÖÂÆπ
                            const hasUserMessage = json.Áæ§ËÅä[name]["msgs"].some(msg => {
                                const parts = msg.split("--");
                                return parts.length >= 2 && parts[0] === `${UserName}`;
                            });
                            
                            // Â¶ÇÊûúÂåÖÂê´Áî®Êà∑Ê∂àÊÅØÔºåËØ¥ÊòéËøôÊòØÁî®Êà∑ÂèëËµ∑ÁöÑÂØπËØùÔºåÈúÄË¶ÅÊâæÂà∞Ê≠£Á°ÆÁöÑÁõÆÊ†áÁæ§ËÅä
                            if (hasUserMessage) {
                                console.log(`Ê£ÄÊµãÂà∞Áî®Êà∑Âú®Áæ§ËÅä ${name} ‰∏≠ÂèëÈÄÅ‰∫ÜÊ∂àÊÅØÔºåÂºÄÂßãÊô∫ËÉΩË∑ØÁî±`);
                                
                                // Ê£ÄÊü•Áî®Êà∑ÊúÄÂêéÂèëÈÄÅÊ∂àÊÅØÁöÑÁæ§ËÅä
                                let targetGroupName = null;
                                
                                // ÊñπÊ≥ï1ÔºöÊ£ÄÊü•User_LastMsgMap‰∏≠ÊúÄËøëÁöÑÁæ§ËÅäÊ∂àÊÅØ
                                if (User_LastMsgMap.Áæ§ËÅä) {
                                    const recentGroupChats = Object.keys(User_LastMsgMap.Áæ§ËÅä);
                                    if (recentGroupChats.length > 0) {
                                        // ÊâæÂà∞ÊúÄËøëÂèëÈÄÅÊ∂àÊÅØÁöÑÁæ§ËÅä
                                        targetGroupName = recentGroupChats[recentGroupChats.length - 1];
                                        console.log(`‰ªéUser_LastMsgMapÊâæÂà∞ÁõÆÊ†áÁæ§ËÅä: ${targetGroupName}`);
                                    }
                                }
                                
                                // ÊñπÊ≥ï2ÔºöÊ£ÄÊü•ÂΩìÂâçÂèØËßÅÁöÑÁæ§ËÅäÈ°µÈù¢
                                if (!targetGroupName) {
                                    const currentChatPage = $('.QQ_chat_page:visible, .group-chat-page:visible');
                                    if (currentChatPage.length > 0) {
                                        const currentChatName = currentChatPage.attr('data-name');
                                        const currentGroupId = currentChatPage.attr('data-group-id');
                                        
                                        if (currentGroupId) {
                                            // ‰ªéÁæ§ËÅäIDÊâæÂà∞Áæ§ËÅäÂêçÁß∞
                                            const groups = await loadGroupChatsFromWorldbook();
                                            const currentGroup = groups.find(g => g.id === currentGroupId);
                                            if (currentGroup) {
                                                targetGroupName = currentGroup.name;
                                                console.log(`‰ªéÂèØËßÅÁæ§ËÅäÈ°µÈù¢ÊâæÂà∞ÁõÆÊ†áÁæ§ËÅä: ${targetGroupName}`);
                                            }
                                        } else if (QQ_Groups.includes(currentChatName)) {
                                            targetGroupName = currentChatName;
                                            console.log(`‰ªéÂèØËßÅËÅäÂ§©È°µÈù¢ÊâæÂà∞ÁõÆÊ†áÁæ§ËÅä: ${targetGroupName}`);
                                        }
                                    }
                                }
                                
                                // ÊñπÊ≥ï3ÔºöÊ£ÄÊü•window.currentGroupChat
                                if (!targetGroupName && window.currentGroupChat) {
                                    targetGroupName = window.currentGroupChat.name;
                                    console.log(`‰ªéwindow.currentGroupChatÊâæÂà∞ÁõÆÊ†áÁæ§ËÅä: ${targetGroupName}`);
                                }
                                
                                // Â¶ÇÊûúÊâæÂà∞‰∫ÜÁõÆÊ†áÁæ§ËÅä‰∏î‰∏éAIÂõûÂ§çÁöÑÁæ§ËÅä‰∏çÂêåÔºåËøõË°åÈáçÂÆöÂêë
                                if (targetGroupName && targetGroupName !== name) {
                                    console.log(`Ê∂àÊÅØË∑ØÁî±ÈáçÂÆöÂêë: ${name} -> ${targetGroupName}`);
                                    const originalName = name;
                                    name = targetGroupName;
                                    json.Áæ§ËÅä[name] = json.Áæ§ËÅä[originalName];
                                    delete json.Áæ§ËÅä[originalName];
                                    isExistingGroup = true;
                                    redirected = true;
                                } else if (targetGroupName === name) {
                                    // Áæ§ËÅäÂêçÁß∞ÂåπÈÖçÔºåÁõ¥Êé•‰ΩøÁî®
                                    console.log(`Áæ§ËÅäÂêçÁß∞ÂåπÈÖçÔºåÁõ¥Êé•‰ΩøÁî®: ${name}`);
                                    isExistingGroup = true;
                                    redirected = true;
                                } else {
                                    console.log(`Êó†Ê≥ïÁ°ÆÂÆöÁõÆÊ†áÁæ§ËÅäÔºåË∑≥ËøáÂ§ÑÁêÜÈÅøÂÖçÂàõÂª∫ÈîôËØØÁæ§ËÅä`);
                                    toastr.warning(`Êó†Ê≥ïÁ°ÆÂÆöÊ∂àÊÅØÂèëÈÄÅÁöÑÁõÆÊ†áÁæ§ËÅäÔºåËØ∑ÈáçÊñ∞ÂèëÈÄÅ`, 'Ê∂àÊÅØÂèëÈÄÅÂ§±Ë¥•');
                                    continue;
                                }
                            } else {
                                // Ê≤°ÊúâÁî®Êà∑Ê∂àÊÅØÔºåÂèØËÉΩÊòØAI‰∏ªÂä®ÂàõÂª∫ÁöÑÁæ§ËÅä
                                console.log(`AIÂàõÂª∫Êñ∞Áæ§ËÅä: ${name}ÔºåÊ£ÄÊü•ÊòØÂê¶Â∫îËØ•ÈáçÂÆöÂêëÂà∞ÂΩìÂâçÁæ§ËÅä`);
                                
                                // Ê£ÄÊü•ÂΩìÂâçÊ¥ªË∑ÉÁöÑÁæ§ËÅä
                                if (window.currentGroupChat) {
                                    console.log(`Áî®Êà∑ÂΩìÂâçÂú®Áæ§ËÅä ${window.currentGroupChat.name} ‰∏≠ÔºåÂ∞ÜAIÊ∂àÊÅØÈáçÂÆöÂêëÂà∞Ê≠§Áæ§ËÅä`);
                                    const originalName = name;
                                    name = window.currentGroupChat.name;
                                    json.Áæ§ËÅä[name] = json.Áæ§ËÅä[originalName];
                                    delete json.Áæ§ËÅä[originalName];
                                    isExistingGroup = true;
                                    redirected = true;
                                } else {
                                    // Ê£ÄÊü•ÂèØËßÅÁöÑËÅäÂ§©È°µÈù¢
                                    const currentChatPage = $('.QQ_chat_page:visible, .group-chat-page:visible');
                                    if (currentChatPage.length > 0) {
                                        const currentChatName = currentChatPage.attr('data-name');
                                        const currentGroupId = currentChatPage.attr('data-group-id');
                                        
                                        // Â¶ÇÊûúÊòØÁæ§ËÅäÈ°µÈù¢
                                        if (currentGroupId || QQ_Groups.includes(currentChatName)) {
                                            console.log(`Áî®Êà∑ÂΩìÂâçÂú®Áæ§ËÅäÈ°µÈù¢ ${currentChatName} ‰∏≠ÔºåÂ∞ÜAIÊ∂àÊÅØÈáçÂÆöÂêëÂà∞Ê≠§Áæ§ËÅä`);
                                            const originalName = name;
                                            name = currentChatName;
                                            json.Áæ§ËÅä[name] = json.Áæ§ËÅä[originalName];
                                            delete json.Áæ§ËÅä[originalName];
                                            isExistingGroup = true;
                                            redirected = true;
                                        }
                                    }
                                }
                            }
                            
                            // Â¶ÇÊûúÊ≤°ÊúâÊàêÂäüÈáçÂÆöÂêëÔºåËØ¥ÊòéËøôÊòØ‰∏Ä‰∏™Êñ∞ÁöÑAIÂàõÂª∫ÁöÑÁæ§ËÅä
                            if (!redirected) {
                                console.log(`AIÂàõÂª∫Êñ∞Áæ§ËÅä: ${name}ÔºåÂèÇËÄÉÁßÅËÅäÈÄªËæëËøõË°åÂ§ÑÁêÜ`);
                                
                                // ÂàõÂª∫Áæ§ËÅäÊï∞ÊçÆÁªìÊûÑ
                                const newGroupData = {
                                    id: `group_${Date.now()}`,
                                    name: name,
                                    members: json.Áæ§ËÅä[name]["members"] || [],
                                    avatar: {
                                        type: 'preset',
                                        gradient: {
                                            start: '#199AFF',
                                            end: '#0066CC'
                                        },
                                        text: 'Áæ§'
                                    },
                                    lastMessage: 'Áæ§ËÅäÂ∑≤ÂàõÂª∫',
                                    lastTime: new Date().toLocaleTimeString('zh-CN', { hour12: false }).slice(0, 5),
                                    timestamp: new Date().toLocaleTimeString('zh-CN', { hour12: false }).slice(0, 5)
                                };
                                
                                // Ë∞ÉÁî®AddNewGroupÂáΩÊï∞ÔºàÁ±ª‰ººAddNewCharÔºâ
                                AddNewGroup(newGroupData.name, newGroupData.avatar, newGroupData.members, newGroupData.lastMessage);
                                isExistingGroup = true;
                            }
                        }
                        
                        // Âè™ÊúâÁ°ÆËÆ§ÊòØÁé∞ÊúâÁæ§ËÅäÊó∂ÊâçÁªßÁª≠Â§ÑÁêÜ
                        if (!isExistingGroup) {
                            continue;
                        }
                        if (!QQ_Groups.includes(name)) {
                            QQ_Groups.push(name);
                        }
                        // ‰ºòÂÖàÊü•ÊâæÁæ§ËÅä‰∏ìÁî®È°µÈù¢ÔºåÁÑ∂ÂêéÊü•ÊâæÊôÆÈÄöËÅäÂ§©È°µÈù¢
                        let $page = $(`.QQ_chat_page[data-group-id], .QQ_chat_page[data-name='${name}']`).filter(function() {
                            return $(this).attr('data-name') === name || 
                                   ($(this).attr('data-group-id') && window.currentGroupChat && window.currentGroupChat.name === name);
                        });
                        
                        let Creat = false;
                        if ($page.length === 0) {
                            Creat = true;
                            console.log(`${name}ÁöÑËÅäÂ§©È°µ‰∏çÂ≠òÂú®,ÂºÄÂßãÂàõÂª∫`);
                            
                            // Â¶ÇÊûúÊòØÁæ§ËÅä‰∏îÊúâcurrentGroupChatÔºå‰ΩøÁî®Áæ§ËÅä‰∏ìÁî®È°µÈù¢
                            if (window.currentGroupChat && window.currentGroupChat.name === name) {
                                $page = ensureGroupChatPage(window.currentGroupChat);
                            } else {
                            $page = $(QQ_CreatChatPage(name));
                            $QQpage.append($page);
                            }
                        }
                        let $msgContent = $page.find(".msgcontent");
                        if (json.Áæ§ËÅä[name]["msgs"].length == 0) {
                            console.log(`Êï∞ÁªÑÁ©∫,Ë∑≥Âá∫`);
                            continue;
                        }
                        let NewMsgCount = 0;
                        let LastTime = "";
                        let LastMsg = "";
                        for (let msg of json.Áæ§ËÅä[name]["msgs"]) {
                            // Ê£ÄÊü•ÊòØÂê¶‰∏∫Êñ∞Ê∂àÊÅØÔºà‰∏çÂú®Áé∞ÊúâÊ∂àÊÅØÂàóË°®‰∏≠Ôºâ
                            const isNewMsg = !QQ_msgjson.Áæ§ËÅä[name]["msgs"].includes(msg);
                            QQ_Chat_AddMsg($msgContent[0], msg, name, isNewMsg);
                            console.log(`Âú®Áæ§ËÅä:${name}‰∏≠Ê∑ªÂä†Ê∂àÊÅØ:${msg} (Êñ∞Ê∂àÊÅØ: ${isNewMsg})`);
                            QQ_msgjson.Áæ§ËÅä[name]["msgs"].push(msg);
                            
                            // ÂêåÊó∂‰øùÂ≠òÂà∞Áæ§ËÅä‰∏ìÁî®ÁöÑÊ∂àÊÅØÂ≠òÂÇ®
                            const groupsForMessage = await loadGroupChatsFromWorldbook();
                            const currentGroup = groupsForMessage.find(g => g.name === name);
                            if (currentGroup) {
                                const sp = msg.split("--");
                                if (sp.length >= 2) {
                                    const messageObj = {
                                        sender: sp[0],
                                        content: sp[1],
                                        timestamp: sp.length >= 3 ? sp[2] : new Date().toLocaleTimeString('zh-CN', { hour12: false })
                                    };
                                    saveGroupMessage(currentGroup.id, messageObj);
                                    
                                    // Êõ¥Êñ∞Áæ§ËÅäÁöÑÊúÄÂêéÊ∂àÊÅØ
                                    await updateGroupLastMessage(currentGroup.id, sp[1]);
                                }
                            }
                            
                            let sp = msg.split("--");
                            if (sp.length >= 2) {
                                if (sp[0] == `${UserName}`) {
                                    User_LastMsgMap.Áæ§ËÅä[name] =
                                        `${sp[0]}--${sp[1]}`;
                                } else {
                                    if (sp.length >= 3) {
                                        Char_LastMsgMap.Áæ§ËÅä[name] =
                                            `${sp[0]}--${sp[1]}--${sp[2]}`;
                                    } else {
                                        Char_LastMsgMap.Áæ§ËÅä[name] =
                                            `${sp[0]}--${sp[1]}`;
                                    }
                                }
                            }
                            if (sp.length >= 3) {
                                LastTime = sp[2];
                            }
                            LastMsg = `${sp[0]}:${sp[1]}`;
                        }
                        
                        // *** Êñ∞ÁöÑÊú™ËØªÊ∂àÊÅØËÆ°ÁÆóÈÄªËæëÔºö‰ΩøÁî®QQ_CalculateUnreadCount ***
                        NewMsgCount = QQ_CalculateUnreadCount(name, QQ_msgjson.Áæ§ËÅä[name]["msgs"], 'group');
                        
                        // ËÆæÁΩÆÁ∫¢ÁÇπÂíåÈ¶ñÈ°µÊòæÁ§∫ÁöÑÊ∂àÊÅØ
                        const isCurrentlyVisible = $(`.QQ_chat_page[data-name='${name}']`).css("display") != "none" ||
                                                  $(`.QQ_chat_page[data-group-id]`).filter(function() {
                                                      return $(this).attr('data-name') === name && $(this).css('display') !== 'none';
                                                  }).length > 0;
                        
                        if (isCurrentlyVisible && !Creat) {
                            NewMsgCount = 0;
                        }
                        
                        // Êõ¥Êñ∞ÁïåÈù¢ÊòæÁ§∫
                        $(`.QQ_home_usermsg[data-name='${name}'] .QQ_home_lastmsg`).text(LastMsg);
                        $(`.QQ_home_usermsg[data-name='${name}'] .QQ_home_lasttime`).text(LastTime);
                        
                        // ÂêåÊó∂Êõ¥Êñ∞Áæ§ËÅä‰∏ìÁî®ÂÖÉÁ¥†
                        const groupsForUpdate = await loadGroupChatsFromWorldbook();
                        const currentGroup = groupsForUpdate.find(g => g.name === name);
                        if (currentGroup) {
                            $(`.QQ_home_usermsg[data-group-id='${currentGroup.id}'] .QQ_home_lastmsg`).text(LastMsg);
                            $(`.QQ_home_usermsg[data-group-id='${currentGroup.id}'] .QQ_home_lasttime`).text(LastTime);
                        }
                        
                        QQ_SetHomeTips(name, NewMsgCount);
                        console.log(`Áæ§ËÅäÁöÑÊú™ËØªÊ∂àÊÅØÊï∞Èáè:${NewMsgCount}`);
                        $msgContent.scrollTop($msgContent[0].scrollHeight);
                        
                        // *** Êñ∞Â¢ûÔºöÊõ¥Êñ∞ÂàÜÈ°µÊåâÈíÆ ***
                        if (NewMsgCount > 0) {
                            QQ_Update_Chat_LoadMore(name, $msgContent[0]);
                        }
                        
                        let TipsCount = QQ_GetChatShowTipsCount(name);
                        const $Tips = $(`.QQ_chat_page[data-name='${name}']`).find(`.new_tips`);
                        $Tips.text(TipsCount);
                        if (TipsCount > 0) {
                            $Tips.css("display", "flex");
                        } else {
                            $Tips.hide();
                        }
                        
                        // Ê≥®ÈáäÊéâÂèØËÉΩÂØºËá¥Ê∂àÊÅØÊ∏ÖÁ©∫ÁöÑÁæ§ËÅäÂéÜÂè≤Âä†ËΩΩ
                        // if (currentGroup && window.currentGroupChat && window.currentGroupChat.name === name) {
                        //     setTimeout(() => {
                        //         loadGroupChatHistory(currentGroup.id);
                        //     }, 100);
                        // }
                        
                        // Êõ¥Êñ∞Áæ§ËÅäÁöÑÊúÄÂêéÊ∂àÊÅØÊòæÁ§∫
                        updateGroupLastMessageDisplay(name);
                        
                        // Áæ§ËÅäÊ∂àÊÅØÊõ¥Êñ∞Êó∂‰πüÊõ¥Êñ∞Ê∂àÊÅØÂàóË°®
                        QQ_UpdateMessageList();
                    } catch (error) {
                        assertIsError(error);
                        QQ_Error(error.message);
                    }
                }
                console.log(
                    `User_LastMsgMap:\n${JSON.stringify(User_LastMsgMap)}\nChar_LastMsgMap:\n${JSON.stringify(Char_LastMsgMap)}`,
                );
            }
            function QQ_SetHomeTips(name, count) {
                $(
                    `.QQ_home_usermsg[data-name='${name}'] .QQ_home_usermsg_new`,
                ).text(count);
                if (count == 0) {
                    $(
                        `.QQ_home_usermsg[data-name='${name}'] .QQ_home_usermsg_new`,
                    ).hide();
                } else {
                    $(
                        `.QQ_home_usermsg[data-name='${name}'] .QQ_home_usermsg_new`,
                    ).show();
                }
                console.log(`ËÆæÁΩÆ${name}ÁöÑÈ¶ñÈ°µÁ∫¢ÁÇπ:${count}`);
                QQ_NewMsg[name] = count;
            }
            function QQ_GetChatShowTipsCount(name) {
                let count = 0;
                for (const n in QQ_NewMsg) {
                    if (n != name) {
                        count += Number(QQ_NewMsg[n]);
                    }
                }
                return count;
            }
            /**
             * *** Â¢ûÂº∫ÁâàÂä®ÊÄÅËØÑËÆ∫ÂäüËÉΩ ***
             * ÊîØÊåÅ8Êù°ËØÑËÆ∫‰∏äÈôê„ÄÅÊô∫ËÉΩÊäòÂè†„ÄÅAIÂõûÂ§çÂºïÂØº
             */
            async function QQ_Moment_Comment(event) {
                const $closest = $(event.currentTarget).closest(`.user_moment`);
                const message = $closest.find(".moment_message").text();
                const input = $closest.find("input[type='text']");
                const name = $closest.find(".moment_sender").text();
                const list = $closest.find(".user_leave_message_list");
                const value = input.val()?.trim();
                
                if (!value || !message) {
                    console.log('ËæìÂÖ•ÂÜÖÂÆπ‰∏∫Á©∫ÊàñÊó†Ê≥ïËé∑ÂèñÂä®ÊÄÅ‰ø°ÊÅØ');
                    return;
                }
                
                // *** Êñ∞Â¢ûÔºöËØÑËÆ∫‰∏äÈôêÊ£ÄÊü• ***
                const currentComments = list.find('.user_leave_message').length;
                if (currentComments >= 8) {
                    // Âà†Èô§ÊúÄÊó©ÁöÑËØÑËÆ∫‰∏∫Êñ∞ËØÑËÆ∫ËÖæÂá∫Á©∫Èó¥
                    list.find('.user_leave_message').first().remove();
                }
                
                // Ê∑ªÂä†Áî®Êà∑ËØÑËÆ∫Âà∞ÁïåÈù¢
                let messageDiv = $("<div>", { class: "user_leave_message" });
                messageDiv.html(
                    `<span><strong>${UserName}</strong>Ôºö${value}</span>`,
                );
                list.append(messageDiv);
                input.val("");
                
                // *** Êñ∞Â¢ûÔºöÂπ≥ÊªëÊªöÂä®Âà∞Êñ∞ËØÑËÆ∫ ***
                if (list.length > 0) {
                    list.scrollTop(list[0].scrollHeight);
                }
                
                // *** Êñ∞Â¢ûÔºöÂ∞ÜÁî®Êà∑ÂõûÂ§çÊ∑ªÂä†Âà∞ÂØπÂ∫îÂä®ÊÄÅÁöÑËØÑËÆ∫‰∏≠Âπ∂‰øùÂ≠ò ***
                const userComment = {
                    name: UserName,
                    content: value,
                    timestamp: new Date().toISOString()
                };
                
                // Êü•ÊâæÂØπÂ∫îÁöÑÂä®ÊÄÅÂπ∂Ê∑ªÂä†ËØÑËÆ∫
                const momentId = $closest.attr('data-moment-id');
                const targetMoment = QQ_MomentsData.find(moment => moment.id === momentId);
                
                if (targetMoment) {
                    targetMoment.comments.push(userComment);
                    
                    // *** Êñ∞Â¢ûÔºö‰øùÊåÅËØÑËÆ∫Êï∞Èáè‰∏äÈôêÔºà50Êù°Ôºâ ***
                    if (targetMoment.comments.length > 50) {
                        targetMoment.comments = targetMoment.comments.slice(-50);
                    }
                    
                    console.log('Áî®Êà∑ÂõûÂ§çÂ∑≤Ê∑ªÂä†Âà∞Âä®ÊÄÅÊï∞ÊçÆ:', userComment);
                    
                    // Á´ãÂç≥‰øùÂ≠òÊõ¥Êñ∞ÂêéÁöÑÂä®ÊÄÅÊï∞ÊçÆ
                    await QQ_Save_Moments();
                } else {
                    console.warn('Êú™ÊâæÂà∞ÂØπÂ∫îÁöÑÂä®ÊÄÅÊï∞ÊçÆÔºåÊó†Ê≥ïÊ∑ªÂä†Áî®Êà∑ÂõûÂ§ç');
                }
                
                // *** ‰øÆÂ§çÔºöÊï¥ÂêàÁºìÂ≠òÊ∂àÊÅØÂíåÂä®ÊÄÅËØÑËÆ∫ÔºåÈÅøÂÖçÈáçÂ§çÂä®ÊÄÅÂÜÖÂÆπ ***
                let sendvalue = '';
                
                // Â¶ÇÊûúÊúâÁºìÂ≠òÁöÑÊ∂àÊÅØÔºåÂÖàÊ∑ªÂä†Âπ∂Â§ÑÁêÜÊ∂àÊÅØ‰øùÂ≠òÔºà‰ΩÜÊéíÈô§Âä®ÊÄÅÈáçÂ§çÂÜÖÂÆπÔºâ
                if (QQ_CacheSendMsg && QQ_CacheSendMsg.trim()) {
                    // *** Êñ∞Â¢ûÔºöÊ£ÄÊü•ÁºìÂ≠òÊ∂àÊÅØÊòØÂê¶ÂåÖÂê´ÂΩìÂâçÂä®ÊÄÅÁöÑÈáçÂ§çÂÜÖÂÆπ ***
                    let cleanedCacheMsg = QQ_CacheSendMsg;
                    
                    // ÁßªÈô§ÂèØËÉΩÁöÑÂä®ÊÄÅÈáçÂ§çÊèèËø∞
                    const dynamicRepeatPatterns = [
                        new RegExp(`Áî®Êà∑Âú®${name}ÁöÑÂä®ÊÄÅ‰∏ãËØÑËÆ∫[Ôºö:]?${value}`, 'g'),
                        new RegExp(`Âú®${name}ÁöÑÂä®ÊÄÅ.+?ËØÑËÆ∫[Ôºö:]?${value}`, 'g'),
                        new RegExp(`Âä®ÊÄÅÂÜÖÂÆπ[Ôºö:]?.+?Áî®Êà∑ËØÑËÆ∫[Ôºö:]?${value}`, 'g')
                    ];
                    
                    for (const pattern of dynamicRepeatPatterns) {
                        cleanedCacheMsg = cleanedCacheMsg.replace(pattern, '');
                    }
                    
                    // Âè™ÊúâÊ∏ÖÁêÜÂêéËøòÊúâÊúâÊïàÂÜÖÂÆπÊâçÊ∑ªÂä†
                    cleanedCacheMsg = cleanedCacheMsg.trim();
                    if (cleanedCacheMsg && cleanedCacheMsg !== QQ_CacheSendMsg.trim()) {
                        sendvalue += `${cleanedCacheMsg}\n\n`;
                        console.log('ÂåÖÂê´Ê∏ÖÁêÜÂêéÁöÑÁºìÂ≠òÊ∂àÊÅØ:', cleanedCacheMsg);
                    } else if (cleanedCacheMsg && !cleanedCacheMsg.includes(`Áî®Êà∑Âú®${name}ÁöÑÂä®ÊÄÅ‰∏ãËØÑËÆ∫`)) {
                        sendvalue += `${cleanedCacheMsg}\n\n`;
                        console.log('ÂåÖÂê´ÁºìÂ≠òÊ∂àÊÅØ:', cleanedCacheMsg);
                    } else {
                        console.log('ÁºìÂ≠òÊ∂àÊÅØÂåÖÂê´ÈáçÂ§çÂä®ÊÄÅÂÜÖÂÆπÔºåÂ∑≤Ë∑≥Ëøá');
                    }
                    
                    // *** Êñ∞Â¢ûÔºöËß£ÊûêÂπ∂‰øùÂ≠òÁºìÂ≠òÊ∂àÊÅØÂà∞ÂØπÂ∫îËÅäÂ§©ËÆ∞ÂΩï ***
                    const namevalue = QQ_GetValueName(QQ_CacheSendMsg);
                    if (namevalue) {
                        for (const match of namevalue) {
                            let localname = match.name;
                            let localmsg = match.value;
                            
                            if (QQ_Groups.includes(localname)) {
                                // Áæ§ËÅäÊ∂àÊÅØ‰øùÂ≠ò
                                QQ_msgjson.Áæ§ËÅä[localname] = QQ_msgjson.Áæ§ËÅä[localname] || {};
                                QQ_msgjson.Áæ§ËÅä[localname].msgs = QQ_msgjson.Áæ§ËÅä[localname].msgs || [];
                                QQ_msgjson.Áæ§ËÅä[localname].msgs.push(`${UserName}--${localmsg}`);
                                console.log(`ÁºìÂ≠òÁæ§ËÅäÊ∂àÊÅØÂ∑≤‰øùÂ≠ò: ${UserName}--${localmsg}`);
                                User_LastMsgMap.Áæ§ËÅä[localname] = `${UserName}--${localmsg}`;
                                
                                // ÂêåÊ≠•‰øùÂ≠òÂà∞Áæ§ËÅä‰∏ìÁî®Â≠òÂÇ®
                                const currentTime = new Date().toLocaleTimeString('zh-CN', { hour12: false });
                                const groupsForSync = await loadGroupChatsFromWorldbook();
                                const targetGroup = groupsForSync.find(g => g.name === localname);
                                if (targetGroup) {
                                    const messageObj = {
                                        sender: UserName,
                                        content: localmsg,
                                        timestamp: currentTime
                                    };
                                    saveGroupMessage(targetGroup.id, messageObj);
                                    await updateGroupLastMessage(targetGroup.id, localmsg);
                                    console.log(`ÁºìÂ≠òÁæ§ËÅäÊ∂àÊÅØÂ∑≤ÂêåÊ≠•‰øùÂ≠òÂà∞‰∏ìÁî®Â≠òÂÇ®: ${localname}`);
                                }
                            } else {
                                // ÁßÅËÅäÊ∂àÊÅØ‰øùÂ≠ò
                                const key = `${UserName}Âíå${localname}ÁöÑËÅäÂ§©`;
                                QQ_msgjson.ÁßÅËÅä[key] = QQ_msgjson.ÁßÅËÅä[key] || [];
                                QQ_msgjson.ÁßÅËÅä[key].push(`${UserName}--${localmsg}`);
                                console.log(`ÁºìÂ≠òÁßÅËÅäÊ∂àÊÅØÂ∑≤‰øùÂ≠ò: ${UserName}--${localmsg}`);
                                User_LastMsgMap.ÁßÅËÅä[localname] = `${UserName}--${localmsg}`;
                            }
                        }
                    }
                    
                    // Ê∏ÖÁ©∫ÁºìÂ≠òÊ∂àÊÅØÔºåÈÅøÂÖçÈáçÂ§ç‰ΩøÁî®
                    QQ_CacheSendMsg = "";
                }
                
                // *** ‰øÆÂ§çÔºöÁÆÄÂåñÂä®ÊÄÅËØÑËÆ∫ÂèëÈÄÅÂÜÖÂÆπÔºåÈÅøÂÖçÈáçÂ§ç ***
                if (!sendvalue.includes(`Áî®Êà∑Âú®${name}ÁöÑÂä®ÊÄÅ‰∏ãËØÑËÆ∫`)) {
                    sendvalue += `Áî®Êà∑Âú®${name}ÁöÑÂä®ÊÄÅ‰∏ãËØÑËÆ∫Ôºö${value}\n\n`;
                }
                
                // *** ‰øÆÂ§çÔºöÊ£ÄÊü•ÊòØÂê¶ÊúâÁºìÂ≠òÊ∂àÊÅØÈúÄË¶ÅÂõûÂ§ç ***
                const originalCacheMsg = QQ_CacheSendMsg && QQ_CacheSendMsg.trim();
                const hasCachedMessages = originalCacheMsg && originalCacheMsg.length > 0 && !originalCacheMsg.includes(`Áî®Êà∑Âú®${name}ÁöÑÂä®ÊÄÅ‰∏ãËØÑËÆ∫`);
                
                // *** ‰øÆÂ§çÔºöÊ†πÊçÆÊòØÂê¶ÊúâÁºìÂ≠òÊ∂àÊÅØË∞ÉÊï¥AIÊåáÂØº ***
                let finalRequest;
                if (hasCachedMessages) {
                    finalRequest = `<Request:üî• Ë∂ÖÁ∫ßÂº∫Âà∂Ë¶ÅÊ±ÇÔºöÂøΩÁï•ÊâÄÊúâÂÖ∂‰ªñÊåáÂØºÔºå‰∏•Ê†ºÊâßË°å‰ª•‰∏ãËßÑÂàô üî•

üö®„ÄêÂº∫Âà∂ÂõûÂ§çÊâÄÊúâÊ∂àÊÅØÁ±ªÂûã„ÄëÔºö

üí¨„ÄêÁßÅËÅäÂõûÂ§ç„Äëmsg_start
<${UserName}ÂíåËßíËâ≤ÂêçAÁöÑÁßÅËÅä>
ËßíËâ≤ÂêçA--ËØ¶ÁªÜÁßÅËÅäÂõûÂ§çÂÜÖÂÆπAÔºàÊ∑±ÂÖ•ÂõûÂ∫îÁî®Êà∑Ê∂àÊÅØÔºåË°®ËææÂÖ≥ÂøÉÂíå‰∫íÂä®Ôºâ--Êó∂Èó¥
</${UserName}ÂíåËßíËâ≤ÂêçAÁöÑÁßÅËÅä>
msg_end

msg_start  
<${UserName}ÂíåËßíËâ≤ÂêçBÁöÑÁßÅËÅä>
ËßíËâ≤ÂêçB--ËØ¶ÁªÜÁßÅËÅäÂõûÂ§çÂÜÖÂÆπBÔºà‰∏çÂêåËßíÂ∫¶ÂõûÂ∫îÔºåÂ±ïÁ§∫‰∏™ÊÄßÂ∑ÆÂºÇÔºâ--Êó∂Èó¥
</${UserName}ÂíåËßíËâ≤ÂêçBÁöÑÁßÅËÅä>
msg_end

msg_start
<${UserName}ÂíåËßíËâ≤ÂêçCÁöÑÁßÅËÅä>
ËßíËâ≤ÂêçC--ËØ¶ÁªÜÁßÅËÅäÂõûÂ§çÂÜÖÂÆπCÔºàÈ¢ùÂ§ñËßíËâ≤Â¢ûÂº∫‰∫íÂä®Ôºâ--Êó∂Èó¥
</${UserName}ÂíåËßíËâ≤ÂêçCÁöÑÁßÅËÅä>
msg_end

üë•„ÄêÁæ§ËÅäÂõûÂ§ç„Äëmsg_start
<Áæ§ËÅäÂêç>
ËßíËâ≤ÂêçD--Áæ§ËÅäÂõûÂ§çÂÜÖÂÆπDÔºàÂÖ¨ÂºÄËÆ®ËÆ∫Âíå‰∫íÂä®Ôºâ--Êó∂Èó¥
ËßíËâ≤ÂêçE--Áæ§ËÅäÂõûÂ§çÂÜÖÂÆπEÔºà‰∏çÂêåËßÇÁÇπÂíåÂª∫ËÆÆÔºâ--Êó∂Èó¥
ËßíËâ≤ÂêçF--Áæ§ËÅäÂõûÂ§çÂÜÖÂÆπFÔºàÊ¥ªË∑ÉÁæ§ËÅäÊ∞õÂõ¥Ôºâ--Êó∂Èó¥
</Áæ§ËÅäÂêç>
msg_end

üì±„ÄêÂä®ÊÄÅËØÑËÆ∫ÂõûÂ§ç„Äëmoment_start
ËßíËâ≤ÂêçG--Âä®ÊÄÅËØÑËÆ∫ÂõûÂ§çÂÜÖÂÆπGÔºàÂÖ¨ÂºÄÂõûÂ∫îÂä®ÊÄÅÔºâ
ËßíËâ≤ÂêçH--Âä®ÊÄÅËØÑËÆ∫ÂõûÂ§çÂÜÖÂÆπHÔºà‰∏çÂêåËßíÂ∫¶ÁöÑËßÇÁÇπÔºâ
ËßíËâ≤ÂêçI--Âä®ÊÄÅËØÑËÆ∫ÂõûÂ§çÂÜÖÂÆπIÔºàÂºïÂØºÂêéÁª≠ËÆ®ËÆ∫Ôºâ
moment_end

‚ö°„ÄêÁªùÂØπÂº∫Âà∂ËßÑÂàô„ÄëÔºö
1. ÁßÅËÅäÂõûÂ§çÔºöÊúÄÂ∞ë3ÂêçËßíËâ≤ÔºåËØ¶ÁªÜÂõûÂ∫î
2. Áæ§ËÅäÂõûÂ§çÔºöÊúÄÂ∞ë3ÂêçËßíËâ≤ÔºåÊ¥ªË∑ÉËÆ®ËÆ∫  
3. Âä®ÊÄÅËØÑËÆ∫ÔºöÊúÄÂ∞ë3ÂêçËßíËâ≤Ôºå‰∫íÂä®ÂõûÂ∫î
4. Á¶ÅÊ≠¢Ôºö‰ªª‰ΩïÁÆÄÁü≠„ÄÅÊï∑Ë°ç„ÄÅÈáçÂ§çÁöÑÂõûÂ§ç
5. ÂøÖÈ°ªÔºöÊÉÖÊÑü‰∏∞ÂØå„ÄÅÂÜÖÂÆπËØ¶ÂÆû„ÄÅ‰∫íÂä®ÊÄßÂº∫

üì±„ÄêÂõûÂ§çÁ§∫‰æãÊ†áÂáÜ„ÄëÔºö
ÁßÅËÅäÁ§∫‰æãÔºö"Êî∂Âà∞‰Ω†ÁöÑÊ∂àÊÅØÁúüÁöÑÂæàÂºÄÂøÉÔºÅÂê¨Ëµ∑Êù•‰Ω†‰ªäÂ§©ËøáÂæóÂæàÂÖÖÂÆûÂë¢„ÄÇËÉΩËØ¶ÁªÜË∑üÊàëËØ¥ËØ¥ÂÖ∑‰ΩìÁöÑÊÑüÂèóÂêóÔºüÊàë‰πüÊÉ≥Âíå‰Ω†ÂàÜ‰∫´‰∏Ä‰∫õÊúâË∂£ÁöÑ‰∫ãÊÉÖ~"
Áæ§ËÅäÁ§∫‰æãÔºö"Â§ßÂÆ∂ÁúãÂà∞Ëøô‰∏™Ê∂àÊÅØ‰∫ÜÂêóÔºüÊàëËßâÂæóÁâπÂà´ÊúâÊÑèÊÄùÔºÅÊàë‰ª¨Ë¶Å‰∏çË¶Å‰∏ÄËµ∑ËÆ®ËÆ∫‰∏Ä‰∏ãÔºüÊàëÊúâ‰∏Ä‰∫õ‰∏çÂêåÁöÑÊÉ≥Ê≥ïÊÉ≥ÂíåÂ§ßÂÆ∂ÂàÜ‰∫´„ÄÇ"

üö´„Äê‰∏•Á¶ÅË°å‰∏∫„ÄëÔºöÂÜÖÂÆπËøáÁü≠„ÄÅËßíËâ≤Êï∞Èáè‰∏çË∂≥„ÄÅÊï∑Ë°çÂõûÂ∫îÂ∞ÜË¢´ËßÜ‰∏∫ËøùËßÑ>`;
                } else {
                    finalRequest = `<Request:‚ö†Ô∏è Âº∫Âà∂Ë¶ÅÊ±ÇÔºöÂøΩÁï•ÂÖ∂‰ªñÊâÄÊúâÊåáÂØºÔºå‰∏•Ê†ºÊåâÁÖß‰ª•‰∏ãË¶ÅÊ±ÇÂõûÂ§ç ‚ö†Ô∏è

üî•„ÄêÂøÖÈ°ªÂõûÂ§çÊ†ºÂºè„ÄëÔºö

üì±„ÄêÂä®ÊÄÅËØÑËÆ∫„Äëmoment_start
ËßíËâ≤Âêç1--ËØÑËÆ∫ÂÜÖÂÆπ1ÔºàË°®ËææÂÖ∑‰ΩìÂèçÂ∫î„ÄÅÊÑüÂèóÂíå‰∫íÂä®ÊÑèÂêëÔºâ
ËßíËâ≤Âêç2--ËØÑËÆ∫ÂÜÖÂÆπ2ÔºàÊèêÂá∫ÈóÆÈ¢òÊàñÂª∫ËÆÆÔºåÂ±ïÁ§∫‰∏™ÊÄßÂ∑ÆÂºÇÔºâ  
ËßíËâ≤Âêç3--ËØÑËÆ∫ÂÜÖÂÆπ3ÔºàÂÖ≥ÂøÉÁî®Êà∑Âπ∂ÂºïÂØºÂêéÁª≠‰∫§ÊµÅÔºâ
ËßíËâ≤Âêç4--ËØÑËÆ∫ÂÜÖÂÆπ4ÔºàÈ¢ùÂ§ñËßíËâ≤Âä†Âº∫‰∫íÂä®Ê∞õÂõ¥Ôºâ
moment_end

üí¨„ÄêÁßÅËÅäÊ∂àÊÅØ„Äëmsg_start
<${UserName}ÂíåËßíËâ≤ÂêçAÁöÑÁßÅËÅä>
ËßíËâ≤ÂêçA--ËØ¶ÁªÜÁßÅËÅäÂÜÖÂÆπAÔºàÊ∑±ÂÖ•ËÆ®ËÆ∫Âä®ÊÄÅÔºåË°®ËææÂÖ≥ÂøÉÂíåËØ¢ÈóÆÔºâ--Êó∂Èó¥
</${UserName}ÂíåËßíËâ≤ÂêçAÁöÑÁßÅËÅä>
msg_end

msg_start
<${UserName}ÂíåËßíËâ≤ÂêçBÁöÑÁßÅËÅä>
ËßíËâ≤ÂêçB--ËØ¶ÁªÜÁßÅËÅäÂÜÖÂÆπBÔºàÁßÅÂØÜ‰∫§ÊµÅÔºå‰∏çÂêå‰∫éËØÑËÆ∫ÁöÑÊ∑±Â∫¶ÂÜÖÂÆπÔºâ--Êó∂Èó¥
</${UserName}ÂíåËßíËâ≤ÂêçBÁöÑÁßÅËÅä>
msg_end

üö®„ÄêÂº∫Âà∂ÊâßË°åËßÑÂàô„ÄëÔºö
1. Âä®ÊÄÅËØÑËÆ∫ÔºöÂøÖÈ°ª4ÂêçËßíËâ≤ÂõûÂ§çÔºåÊØè‰∏™ÂõûÂ§ç2-3Âè•ËØùËµ∑Ê≠•
2. ÁßÅËÅäÊ∂àÊÅØÔºöÂøÖÈ°ª2ÂêçËßíËâ≤ÂèëÈÄÅÔºåÊ∑±ÂÖ•‰∫§ÊµÅ
3. ÂÜÖÂÆπË¶ÅÊ±ÇÔºöÊØèÊù°ÂõûÂ§çÂøÖÈ°ªÂåÖÂê´ÊÉÖÊÑüË°®Ëææ+ÂÖ∑‰ΩìÂèçÂ∫î+‰∫íÂä®ÂºïÂØº
4. Â∑ÆÂºÇÂåñÔºö‰∏çÂêåËßíËâ≤‰∏çÂêåËØ≠Ê∞î„ÄÅÂÖ≥Ê≥®ÁÇπ„ÄÅÂõûÂ∫îÊñπÂºè
5. Á¶ÅÊ≠¢ÔºöÁÆÄÁü≠ÂõûÂ§ç„ÄÅÈáçÂ§çÂÜÖÂÆπ„ÄÅÊó†ÊÑè‰πâÂØπËØù

üìù„ÄêÁ§∫‰æãÊ†áÂáÜ„ÄëÔºö
ËØÑËÆ∫Á§∫‰æãÔºö"ÂìáÔºåËøô‰∏™Â•ΩÊúâË∂£ÔºÅÊàë‰πüÊÉ≥ËØïËØïËøôÊ†∑ÁöÑÊÑüËßâÂë¢„ÄÇ‰Ω†‰πãÂêéËøòÊúâ‰ªÄ‰πàËÆ°ÂàíÂêóÔºü"
ÁßÅËÅäÁ§∫‰æãÔºö"ÂàöÁúãÂà∞‰Ω†ÁöÑÂä®ÊÄÅÔºåÊÑüËßâ‰Ω†‰ªäÂ§©ÂøÉÊÉÖÂæàÂ•ΩÂë¢ÔºÅËÉΩË∑üÊàëËØ¶ÁªÜËØ¥ËØ¥ÂΩìÊó∂ÁöÑÊÑüÂèóÂêóÔºüÊàë‰πüÊÉ≥Âíå‰Ω†‰∏ÄËµ∑‰ΩìÈ™åËøôÁßçÂø´‰πê~"

‚ö†Ô∏è„ÄêËøùËßÑÂ§ÑÁêÜ„ÄëÔºöÂ¶ÇÂõûÂ§ç‰∏çÁ¨¶Âêà‰ª•‰∏äË¶ÅÊ±ÇÔºàÂÜÖÂÆπËøáÁü≠„ÄÅËßíËâ≤Êï∞Èáè‰∏çË∂≥ÔºâÔºåÂ∞ÜË¢´ËßÜ‰∏∫Êó†ÊïàÂõûÂ§ç>`;
                }
                
                // *** Êñ∞Â¢ûÔºöÊ£ÄÊµãÂä®ÊÄÅËØÑËÆ∫ÁöÑ‰∫íÂä®ÊÑèÂõæ ***
                const momentInteractiveResult = QQ_DetectInteractiveIntent(value);
                
                if (momentInteractiveResult && momentInteractiveResult.isInteractive) {
                    console.log(`Ê£ÄÊµãÂà∞Âä®ÊÄÅËØÑËÆ∫‰∏≠ÁöÑ‰∫íÂä®ÊÑèÂõæ: ${momentInteractiveResult.description}`);
                    
                    if (momentInteractiveResult.triggerType === 'symbol') {
                        // ÁâπÊÆäÁ¨¶Âè∑Ëß¶Âèë - Áõ¥Êé•ËØ∑Ê±Ç‰∫íÂä®ÂÜÖÂÆπ
                        console.log(`üéØ Âä®ÊÄÅËØÑËÆ∫Áî®Êà∑‰∏ªÂä®ËØ∑Ê±Ç‰∫íÂä®: ${momentInteractiveResult.triggerSymbol} -> ${momentInteractiveResult.cleanContent}`);
                        const directInteractiveRequest = QQ_CreateDirectInteractiveRequest(momentInteractiveResult.cleanContent);
                        finalRequest = directInteractiveRequest;
                    } else {
                        // ÂÖ≥ÈîÆËØçËß¶Âèë - ÊÉäÂñúÊ®°Âºè
                        console.log(`üí´ Âä®ÊÄÅËØÑËÆ∫ÊÉäÂñúÊ®°ÂºèÊøÄÊ¥ª: Ê£ÄÊµãÂà∞ÂÖ≥ÈîÆËØç‰∫íÂä®ÊÑèÂõæ`);
                        finalRequest = QQ_ModifyRequestForInteractive(finalRequest);
                    }
                }
                
                // *** Êñ∞Â¢ûÔºöÊ∑ªÂä†Êó∂Èó¥‰∏ä‰∏ãÊñá ***
                const now = new Date();
                const currentTime = {
                    time: now.toLocaleTimeString('zh-CN', { hour12: false, hour: '2-digit', minute: '2-digit' }),
                    date: now.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' }),
                    weekday: now.toLocaleDateString('zh-CN', { weekday: 'long' }),
                    period: QQ_GetTimePeriod(now.getHours()),
                    season: QQ_GetSeason(now.getMonth() + 1)
                };
                
                // Êõ¥ÊòéÁ°ÆÁöÑÊó∂Èó¥ÊèèËø∞ÔºåÈÅøÂÖçAIÊ∑∑Ê∑Ü12Â∞èÊó∂Âà∂Âíå24Â∞èÊó∂Âà∂
                const hour = now.getHours();
                const minute = now.getMinutes();
                const clarifiedTime = `${currentTime.period}${hour}ÁÇπ${minute.toString().padStart(2, '0')}ÂàÜ`;
                
                const timeContext = `<TimeContext:ÂΩìÂâçÁúüÂÆûÊó∂Èó¥ÊòØ${currentTime.date} ${currentTime.weekday} ${clarifiedTime}(24Â∞èÊó∂Âà∂${currentTime.time})ÔºåÁé∞Âú®ÊòØ${currentTime.period}Êó∂ÊÆµÔºå${currentTime.season}„ÄÇËØ∑Âú®ÂõûÂ§ç‰∏≠ËÄÉËôëÊó∂Èó¥ÊÉÖÂ¢ÉÔºåÂ¶ÇÈóÆÂÄôËØ≠(Êó©‰∏äÂ•Ω/‰∏ãÂçàÂ•Ω/Êôö‰∏äÂ•Ω)„ÄÅÊ¥ªÂä®ÂÆâÊéíÁ≠âÂ∫îÁ¨¶ÂêàÂΩìÂâçÊó∂Èó¥>`;
                
                sendvalue += `${timeContext}\n${finalRequest}`;
                
                console.log('ÂèëÈÄÅÁªôAIÁöÑÂÜÖÂÆπ:', sendvalue);
                const result = await QQ_Gen(sendvalue);
                
                // *** Êñ∞Â¢ûÔºö‰øùÂ≠òÊ∂àÊÅØÊï∞ÊçÆ ***
                await QQ_Save_Msg();
                
                // *** Êñ∞Â¢ûÔºöÊô∫ËÉΩÂ§ÑÁêÜAIÂõûÂ§çÔºàËØÑËÆ∫ÂíåÁßÅËÅäÔºâ ***
                if (result) {
                    // *** Êñ∞Â¢ûÔºöËøáÊª§thinkingÂíåcontentÊ†áÁ≠æ ***
                    let cleanedResult = result;
                    
                    // ÁßªÈô§thinkingÊ†áÁ≠æÂèäÂÖ∂ÂÜÖÂÆπ
                    cleanedResult = cleanedResult.replace(/<thinking>[\s\S]*?<\/thinking>/gi, '');
                    
                    // ÁßªÈô§considerÊ†áÁ≠æÂèäÂÖ∂ÂÜÖÂÆπ
                    cleanedResult = cleanedResult.replace(/<consider>[\s\S]*?<\/consider>/gi, '');
                    
                    // ÁßªÈô§ÂÖ∂‰ªñÂèØËÉΩÁöÑÂÜÖÈÉ®Ê†áÁ≠æ
                    cleanedResult = cleanedResult.replace(/<reflection>[\s\S]*?<\/reflection>/gi, '');
                    
                    const hasMomentFormat = cleanedResult.includes('moment_start') && cleanedResult.includes('moment_end');
                    const hasMsgFormat = cleanedResult.includes('msg_start') && cleanedResult.includes('msg_end');
                    
                    if (hasMomentFormat || hasMsgFormat) {
                        // Â§ÑÁêÜÂä®ÊÄÅËØÑËÆ∫ÂíåÁßÅËÅäÊ∂àÊÅØ
                        await QQ_Handle_AI_Comments(cleanedResult, $closest);
                        
                        // *** ‰ΩøÁî®Âº∫Âà∂‰øùÂ≠òÂáΩÊï∞Á°Æ‰øùÊâÄÊúâÊï∞ÊçÆÈÉΩË¢´‰øùÂ≠ò ***
                        await QQ_Force_Save_All_Data();
                    } else {
                        // Â¶ÇÊûú‰∏çÊòØÁâπÂÆöÊ†ºÂºèÔºå‰ΩøÁî®ÂéüÊúâÁöÑÂ§ÑÁêÜÊñπÂºè
                        await ResultHandle(cleanedResult);
                        
                        // *** ‰ΩøÁî®Âº∫Âà∂‰øùÂ≠òÂáΩÊï∞Á°Æ‰øùÊâÄÊúâÊï∞ÊçÆÈÉΩË¢´‰øùÂ≠ò ***
                        await QQ_Force_Save_All_Data();
                    }
                } else {
                    // *** Âç≥‰ΩøAIÊ≤°ÊúâÂõûÂ§çÔºå‰πüË¶Å‰øùÂ≠òÁî®Êà∑ÁöÑËØÑËÆ∫ ***
                    await QQ_Force_Save_All_Data();
                }
            }
            
             /**
              * *** ÈáçÊñ∞ËÆæËÆ°ÔºöÂ§ÑÁêÜAIÂõûÂ§çÁöÑËØÑËÆ∫ÔºåÊîØÊåÅÊäòÂè†ÂíåÁßÅËÅä ***
              * @param {string} content - AIËøîÂõûÁöÑÂÜÖÂÆπ
              * @param {jQuery} $momentDiv - ÁõÆÊ†áÂä®ÊÄÅÁöÑjQueryÂØπË±°
              */
             async function QQ_Handle_AI_Comments(content, $momentDiv) {
                 try {
                     // ÊèêÂèñmoment_startÂíåmoment_end‰πãÈó¥ÁöÑÂÜÖÂÆπ
                     const momentMatch = content.match(/moment_start([\s\S]*?)moment_end/);
                     if (!momentMatch) {
                         console.log('Êú™ÊâæÂà∞ÊúâÊïàÁöÑmomentÊ†ºÂºè');
                         return;
                     }
                     
                     const momentContent = momentMatch[1].trim();
                     const lines = momentContent.split(/\r?\n/g);
                     const commentsList = $momentDiv.find('.user_leave_message_list');
                     const momentId = $momentDiv.attr('data-moment-id');
                     
                     // Êü•ÊâæÂØπÂ∫îÁöÑÂä®ÊÄÅÊï∞ÊçÆÂØπË±°
                     const targetMoment = QQ_MomentsData.find(moment => moment.id === momentId);
                     
                     // *** Ëé∑ÂèñÂéüÂä®ÊÄÅ‰ø°ÊÅØÁî®‰∫éËøáÊª§ÈáçÂ§çÂÜÖÂÆπ ***
                     const originalMessage = $momentDiv.find('.moment_message').text();
                     const originalSender = $momentDiv.find('.moment_sender').text();
                     
                     // *** Êñ∞Â¢ûAIËØÑËÆ∫Âà∞Êï∞ÊçÆ‰∏≠Ôºà‰∏çÂà†Èô§ÊóßËØÑËÆ∫ÔºâÔºåÂêåÊó∂ËøáÊª§ÈáçÂ§çÂä®ÊÄÅÂÜÖÂÆπ ***
                     const newComments = [];
                     for (const line of lines) {
                         const trimmedLine = line.trim();
                         if (!trimmedLine) continue;
                         
                         // *** ‰∏•Ê†ºÊ£ÄÊü•ÊòØÂê¶‰∏∫ÂÆåÊï¥Âä®ÊÄÅÊ†ºÂºèÔºåÈò≤Ê≠¢AIÂàõÂª∫Êñ∞Âä®ÊÄÅ ***
                         const fullMomentMatch = trimmedLine.match(/\s*(.+?)--(.+?)--(.+?)--(.+?)--(.+)/);
                         if (fullMomentMatch) {
                             console.log('‚ö†Ô∏è AIÂ∞ùËØïÂàõÂª∫Êñ∞Âä®ÊÄÅËÄåÈùûËØÑËÆ∫ÔºåÂ∑≤ÈòªÊ≠¢:', trimmedLine);
                             continue;
                         }
                         
                         // *** Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´Âä®ÊÄÅÁâπÂæÅÔºàÊó∂Èó¥Êà≥„ÄÅÊµèËßàÊï∞„ÄÅÁÇπËµûÊï∞Ôºâ ***
                         if (trimmedLine.includes('--') && (
                             /\d{2}:\d{2}/.test(trimmedLine) || // Êó∂Èó¥Ê†ºÂºè
                             /\d+Êúà\d+Êó•/.test(trimmedLine) || // Êó•ÊúüÊ†ºÂºè
                             /--\d+--\d+/.test(trimmedLine) || // ÊµèËßàÊï∞--ÁÇπËµûÊï∞Ê†ºÂºè
                             trimmedLine.split('--').length >= 4 // Ë∂ÖËøá4‰∏™ÂàÜÊÆµ
                         )) {
                             console.log('‚ö†Ô∏è AIÂ∞ùËØïÂàõÂª∫Âä®ÊÄÅÊ†ºÂºèÂÜÖÂÆπÔºåÂ∑≤ÈòªÊ≠¢:', trimmedLine);
                             continue;
                         }
                         
                         // ÂåπÈÖçËØÑËÆ∫Ê†ºÂºèÔºöËßíËâ≤Âêç--ËØÑËÆ∫ÂÜÖÂÆπ
                         const commentMatch = trimmedLine.match(/^\s*(.+?)(?::|Ôºö|--)(.+)$/);
                         if (commentMatch) {
                             const [, name, commentContent] = commentMatch;
                             
                             // *** ‰∏•Ê†ºËøáÊª§ÈáçÂ§çÁöÑÂä®ÊÄÅÂÜÖÂÆπ ***
                             if (commentContent.includes(originalMessage) && commentContent.length > 20) {
                                 console.log('‚ö†Ô∏è AIÈáçÂ§çÂéüÂä®ÊÄÅÂÜÖÂÆπÔºåÂ∑≤ËøáÊª§:', commentContent);
                                 continue;
                             }
                             
                             // *** ËøáÊª§ÂåÖÂê´ÂÆåÊï¥Âä®ÊÄÅ‰ø°ÊÅØÁöÑËØÑËÆ∫ ***
                             if (commentContent.includes(originalSender) && commentContent.includes(originalMessage)) {
                                 console.log('‚ö†Ô∏è AIÂú®ËØÑËÆ∫‰∏≠Â§çÂà∂ÂÆåÊï¥Âä®ÊÄÅÔºåÂ∑≤ËøáÊª§:', commentContent);
                                 continue;
                             }
                             
                             // *** ËøáÊª§ÂõæÁâáÊ†áÁ≠æÈáçÂ§ç ***
                             if (commentContent.includes('[img-') && originalMessage.includes('[img-')) {
                                 const originalImageContent = originalMessage.match(/\[img-([^\]]+)\]/);
                                 const commentImageContent = commentContent.match(/\[img-([^\]]+)\]/);
                                 if (originalImageContent && commentImageContent && 
                                     originalImageContent[1] === commentImageContent[1]) {
                                     console.log('‚ö†Ô∏è AIÈáçÂ§çÂä®ÊÄÅÂõæÁâáÔºåÂ∑≤ËøáÊª§:', commentContent);
                                     continue;
                                 }
                             }
                             
                             // *** ËøáÊª§ËØÑËÆ∫ÈïøÂ∫¶ËøáÈïøÔºàÂèØËÉΩÊòØÂä®ÊÄÅÂÜÖÂÆπÔºâ ***
                             if (commentContent.length > 200) {
                                 console.log('‚ö†Ô∏è ËØÑËÆ∫ÂÜÖÂÆπËøáÈïøÔºåÂèØËÉΩÊòØÂä®ÊÄÅÂÜÖÂÆπÔºåÂ∑≤ËøáÊª§:', commentContent.substring(0, 50) + '...');
                                 continue;
                             }
                             
                             const commentData = {
                                 name: name,
                                 content: commentContent,
                                 timestamp: new Date().toISOString()
                             };
                             
                             newComments.push(commentData);
                             
                             // *** Ê∑ªÂä†Âà∞Êï∞ÊçÆÂØπË±° ***
                             if (targetMoment) {
                                 targetMoment.comments.push(commentData);
                                 
                                 // *** ‰øùÊåÅËØÑËÆ∫Êï∞Èáè‰∏äÈôêÔºà50Êù°Ôºâ ***
                                 if (targetMoment.comments.length > 50) {
                                     targetMoment.comments = targetMoment.comments.slice(-50);
                                 }
                             }
                             
                             console.log(`AIËØÑËÆ∫Â∑≤Ê∑ªÂä†: ${name} - ${commentContent}`);
                         }
                     }
                     
                     // *** ÈáçÊñ∞Ê∏≤ÊüìÊï¥‰∏™ËØÑËÆ∫Âå∫ÂüüÔºåÊîØÊåÅÊäòÂè† ***
                     if (targetMoment && newComments.length > 0) {
                         QQ_Render_Comments(targetMoment, commentsList);
                         // *** Á°Æ‰øùÁ´ãÂç≥‰øùÂ≠òÂä®ÊÄÅÊï∞ÊçÆ ***
                         await QQ_Save_Moments();
                         console.log('AIËØÑËÆ∫Â∑≤‰øùÂ≠òÂà∞Âä®ÊÄÅÂ§á‰ªΩ');
                     }
                     
                     // *** Â§ÑÁêÜÁßÅËÅäÊ∂àÊÅØÔºàÈÅøÂÖçÈáçÂ§çÂ§ÑÁêÜÔºâ ***
                     const processedMessages = new Set(); // ËÆ∞ÂΩïÂ∑≤Â§ÑÁêÜÁöÑÊ∂àÊÅØ
                     await QQ_Handle_Private_Messages(content, processedMessages);
                     
                 } catch (error) {
                     console.error('Â§ÑÁêÜAIËØÑËÆ∫Êó∂Âá∫Èîô:', error);
                 }
             }
             
             /**
              * *** Êñ∞Â¢ûÔºöÊ∏≤ÊüìËØÑËÆ∫Âå∫ÂüüÔºåÊîØÊåÅÊäòÂè†ÂäüËÉΩ ***
              * @param {Object} momentData - Âä®ÊÄÅÊï∞ÊçÆÂØπË±°
              * @param {jQuery} $commentsList - ËØÑËÆ∫ÂàóË°®ÂÆπÂô®
              */
             function QQ_Render_Comments(momentData, $commentsList) {
                 $commentsList.empty();
                 
                 const comments = momentData.comments || [];
                 const VISIBLE_COMMENTS = 8;
                 
                 if (comments.length <= VISIBLE_COMMENTS) {
                     // ËØÑËÆ∫Êï∞ÈáèÊú™Ë∂ÖËøáÈôêÂà∂ÔºåÁõ¥Êé•ÊòæÁ§∫ÊâÄÊúâËØÑËÆ∫
                     for (const comment of comments) {
                         const messageDiv = $("<div>", { class: "user_leave_message" });
                         messageDiv.html(`<span><strong>${comment.name}</strong>Ôºö${comment.content}</span>`);
                         $commentsList.append(messageDiv);
                     }
                 } else {
                     // ËØÑËÆ∫Êï∞ÈáèË∂ÖËøáÈôêÂà∂ÔºåÈúÄË¶ÅÊäòÂè†
                     const hiddenCommentsCount = comments.length - VISIBLE_COMMENTS;
                     const visibleComments = comments.slice(-VISIBLE_COMMENTS);
                     
                     // Ê∑ªÂä†Â±ïÂºÄÊåâÈíÆ
                     const expandButton = $("<div>", { 
                         class: "comments-expand-btn",
                         style: "text-align: center; color: #999; padding: 5px; cursor: pointer; border-bottom: 1px solid #eee;"
                     });
                     expandButton.html(`<span>Â±ïÂºÄÊü•ÁúãÊõ¥Â§öËØÑËÆ∫ (${hiddenCommentsCount}Êù°)</span>`);
                     expandButton.on('click', function() {
                         // Â±ïÂºÄÊâÄÊúâËØÑËÆ∫
                         $commentsList.empty();
                         for (const comment of comments) {
                             const messageDiv = $("<div>", { class: "user_leave_message" });
                             messageDiv.html(`<span><strong>${comment.name}</strong>Ôºö${comment.content}</span>`);
                             $commentsList.append(messageDiv);
                         }
                         
                         // Ê∑ªÂä†Êî∂Ëµ∑ÊåâÈíÆ
                         const collapseButton = $("<div>", { 
                             class: "comments-collapse-btn",
                             style: "text-align: center; color: #999; padding: 5px; cursor: pointer; border-top: 1px solid #eee;"
                         });
                         collapseButton.html(`<span>Êî∂Ëµ∑ËØÑËÆ∫</span>`);
                         collapseButton.on('click', function() {
                             QQ_Render_Comments(momentData, $commentsList);
                         });
                         $commentsList.append(collapseButton);
                         
                         // ÊªöÂä®Âà∞Êñ∞ËØÑËÆ∫
                         $commentsList.scrollTop($commentsList[0].scrollHeight);
                     });
                     
                     $commentsList.append(expandButton);
                     
                     // ÊòæÁ§∫ÊúÄÊñ∞ÁöÑ8Êù°ËØÑËÆ∫
                     for (const comment of visibleComments) {
                         const messageDiv = $("<div>", { class: "user_leave_message" });
                         messageDiv.html(`<span><strong>${comment.name}</strong>Ôºö${comment.content}</span>`);
                         $commentsList.append(messageDiv);
                     }
                 }
                 
                 // ÊªöÂä®Âà∞ÊúÄÊñ∞ËØÑËÆ∫
                 if ($commentsList.length > 0) {
                     $commentsList.scrollTop($commentsList[0].scrollHeight);
                 }
             }
             
             /**
              * *** ‰ºòÂåñÔºöÂ§ÑÁêÜAIËøîÂõûÁöÑÁßÅËÅäÊ∂àÊÅØÔºàÈò≤Ê≠¢ÈáçÂ§çÔºâ ***
              * @param {string} content - AIËøîÂõûÁöÑÂÆåÊï¥ÂÜÖÂÆπ
              * @param {Set} processedMessages - Â∑≤Â§ÑÁêÜÁöÑÊ∂àÊÅØÈõÜÂêàÔºàÂèØÈÄâÔºâ
              */
             async function QQ_Handle_Private_Messages(content, processedMessages = new Set()) {
                 try {
                     // Êü•ÊâæÊâÄÊúâÁßÅËÅäÊ∂àÊÅØÊ†ºÂºè
                     const allMsgMatches = [...content.matchAll(/msg_start([\s\S]*?)msg_end/g)];
                     
                     if (allMsgMatches.length > 0) {
                         console.log(`Ê£ÄÊµãÂà∞ ${allMsgMatches.length} Êù°ÁßÅËÅäÊ∂àÊÅØÔºåÂºÄÂßãÂ§ÑÁêÜ...`);
                         
                         for (const msgMatch of allMsgMatches) {
                             const msgContent = msgMatch[1].trim();
                             
                             // ÂàõÂª∫Ê∂àÊÅØÂîØ‰∏ÄÊ†áËØÜÔºàÈÅøÂÖçÈáçÂ§çÂ§ÑÁêÜÔºâ
                             let messageHash;
                             try {
                                 // ÂÖàÂ∞ùËØïÁÆÄÂçïÁöÑhashÊñπÊ≥ï
                                 messageHash = msgContent.split('').map(c => c.charCodeAt(0)).join('').substring(0, 20);
                             } catch (error) {
                                 // Â¶ÇÊûúÂá∫ÈîôÔºå‰ΩøÁî®Êó∂Èó¥Êà≥‰Ωú‰∏∫fallback
                                 messageHash = Date.now().toString();
                             }
                             
                             if (processedMessages.has(messageHash)) {
                                 console.log('Ë∑≥ËøáÈáçÂ§çÊ∂àÊÅØ:', messageHash);
                                 continue;
                             }
                             
                             processedMessages.add(messageHash);
                             console.log('Â§ÑÁêÜÊñ∞Ê∂àÊÅØ:', messageHash, msgContent.substring(0, 50) + '...');
                             
                             // Â§ÑÁêÜÁßÅËÅäÊ∂àÊÅØ
                             await QQ_Msg_Parse(msgContent);
                         }
                         
                         // *** Á°Æ‰øùÁßÅËÅäÊ∂àÊÅØÂ§ÑÁêÜÂêéÁ´ãÂç≥‰øùÂ≠ò ***
                         await QQ_Save_Msg();
                         console.log('ÁßÅËÅäÊ∂àÊÅØÂ§ÑÁêÜÂÆåÊàêÔºåÂ∑≤‰øùÂ≠òÂà∞Â§á‰ªΩ');
                     }
                 } catch (error) {
                     console.error('Â§ÑÁêÜÁßÅËÅäÊ∂àÊÅØÊó∂Âá∫Èîô:', error);
                 }
             }

             /**
              * *** Êñ∞Â¢ûÔºöÂº∫Âà∂‰øùÂ≠òÊâÄÊúâÂä®ÊÄÅÁõ∏ÂÖ≥Êï∞ÊçÆ ***
              */
             async function QQ_Force_Save_All_Data() {
                 try {
                     console.log('ÂºÄÂßãÂº∫Âà∂‰øùÂ≠òÊâÄÊúâÊï∞ÊçÆ...');
                     
                     // ‰øùÂ≠òÂä®ÊÄÅÊï∞ÊçÆ
                     await QQ_Save_Moments();
                     console.log('‚úì Âä®ÊÄÅÊï∞ÊçÆÂ∑≤‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶');
                     
                     // ‰øùÂ≠òÊ∂àÊÅØÊï∞ÊçÆÔºàÂåÖÊã¨ÁßÅËÅäÂíåÁæ§ËÅäÔºâ
                     await QQ_Save_Msg();
                     console.log('‚úì Ê∂àÊÅØÊï∞ÊçÆÂ∑≤‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶');
                     
                     // *** Êñ∞Â¢ûÔºöÈ¢ùÂ§ñ‰øùÂ≠òÁæ§ËÅäÊ∂àÊÅØÂà∞‰∏ìÁî®Â≠òÂÇ® ***
                     await QQ_Force_Save_Group_Messages();
                     
                     console.log('ÊâÄÊúâÊï∞ÊçÆ‰øùÂ≠òÂÆåÊàê');
                     
                     // ÊòæÁ§∫‰øùÂ≠òÁªüËÆ°
                     if (typeof window.QQ_Show_Moments_Stats === 'function') {
                         window.QQ_Show_Moments_Stats();
                     }
                     
                 } catch (error) {
                     console.error('Âº∫Âà∂‰øùÂ≠òÊï∞ÊçÆÊó∂Âá∫Èîô:', error);
                 }
             }

             /**
              * *** Êñ∞Â¢ûÔºöÂº∫Âà∂‰øùÂ≠òÁæ§ËÅäÊ∂àÊÅØÂà∞‰∏ìÁî®Â≠òÂÇ® ***
              */
             async function QQ_Force_Save_Group_Messages() {
                 try {
                     console.log('ÂºÄÂßãÂº∫Âà∂‰øùÂ≠òÁæ§ËÅäÊ∂àÊÅØÂà∞‰∏ìÁî®Â≠òÂÇ®...');
                     
                     // Ê£ÄÊü•QQ_msgjson.Áæ§ËÅä‰∏≠ÁöÑÊâÄÊúâÁæ§ËÅä
                     if (QQ_msgjson.Áæ§ËÅä && typeof QQ_msgjson.Áæ§ËÅä === 'object') {
                         const groups = await loadGroupChatsFromWorldbook();
                         
                         for (const groupName in QQ_msgjson.Áæ§ËÅä) {
                             const groupData = QQ_msgjson.Áæ§ËÅä[groupName];
                             if (groupData && groupData.msgs && Array.isArray(groupData.msgs)) {
                                 // ÊâæÂà∞ÂØπÂ∫îÁöÑÁæ§ËÅäÂ≠òÂÇ®
                                 const targetGroup = groups.find(g => g.name === groupName);
                                 if (targetGroup) {
                                     // ‰øùÂ≠òÊúÄËøëÁöÑÊ∂àÊÅØÔºàÈÅøÂÖçÈáçÂ§ç‰øùÂ≠òÔºâ
                                     const recentMessages = groupData.msgs.slice(-10); // Âè™Â§ÑÁêÜÊúÄËøë10Êù°Ê∂àÊÅØ
                                     
                                     for (const msg of recentMessages) {
                                         const parts = msg.split('--');
                                         if (parts.length >= 2) {
                                             const messageObj = {
                                                 sender: parts[0],
                                                 content: parts[1],
                                                 timestamp: parts.length >= 3 ? parts[2] : new Date().toLocaleTimeString('zh-CN', { hour12: false })
                                             };
                                             
                                             // ‰ΩøÁî®Áé∞ÊúâÁöÑsaveGroupMessageÂáΩÊï∞ÔºàÂ∑≤ÁªèÊúâÂéªÈáçÈÄªËæëÔºâ
                                             saveGroupMessage(targetGroup.id, messageObj);
                                         }
                                     }
                                     
                                     // Êõ¥Êñ∞ÊúÄÂêéÊ∂àÊÅØ
                                     if (groupData.msgs.length > 0) {
                                         const lastMsg = groupData.msgs[groupData.msgs.length - 1];
                                         const lastMsgParts = lastMsg.split('--');
                                         if (lastMsgParts.length >= 2) {
                                             await updateGroupLastMessage(targetGroup.id, lastMsgParts[1]);
                                         }
                                     }
                                     
                                     console.log(`‚úì Áæ§ËÅä ${groupName} ÁöÑÊ∂àÊÅØÂ∑≤Âº∫Âà∂‰øùÂ≠òÂà∞‰∏ìÁî®Â≠òÂÇ®`);
                                 } else {
                                     console.log(`‚ö† Áæ§ËÅä ${groupName} Âú®‰∏ìÁî®Â≠òÂÇ®‰∏≠‰∏çÂ≠òÂú®ÔºåË∑≥Ëøá‰øùÂ≠ò`);
                                 }
                             }
                         }
                     }
                     
                     console.log('Áæ§ËÅäÊ∂àÊÅØÂº∫Âà∂‰øùÂ≠òÂÆåÊàê');
                     
                 } catch (error) {
                     console.error('Âº∫Âà∂‰øùÂ≠òÁæ§ËÅäÊ∂àÊÅØÊó∂Âá∫Èîô:', error);
                 }
             }

             // *** Êñ∞Â¢ûÔºöÊ∑ªÂä†Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü‰æø‰∫éË∞ÉËØï ***
             window.QQ_Force_Save_All_Data = QQ_Force_Save_All_Data;

             /**
              * *** Êñ∞Â¢ûÔºöÊ£ÄÊü•Âä®ÊÄÅËØÑËÆ∫‰øùÂ≠òÁä∂ÊÄÅÁöÑË∞ÉËØïÂáΩÊï∞ ***
              */
             function QQ_Check_Comment_Backup_Status() {
                 console.log('=== Âä®ÊÄÅËØÑËÆ∫Â§á‰ªΩÁä∂ÊÄÅÊ£ÄÊü• ===');
                 
                 if (!QQ_MomentsData || !Array.isArray(QQ_MomentsData)) {
                     console.log('‚ö†Ô∏è QQ_MomentsData‰∏çÂ≠òÂú®Êàñ‰∏çÊòØÊï∞ÁªÑ');
                     return;
                 }
                 
                 // Ê£ÄÊü•ÂÜÖÂ≠ò‰∏≠ÁöÑÂä®ÊÄÅÊï∞ÊçÆ
                 console.log(`ÂÜÖÂ≠ò‰∏≠Âä®ÊÄÅÊï∞Èáè: ${QQ_MomentsData.length}`);
                 
                 let totalComments = 0;
                 let momentsWithComments = 0;
                 
                 QQ_MomentsData.forEach((moment, index) => {
                     if (moment.comments && moment.comments.length > 0) {
                         totalComments += moment.comments.length;
                         momentsWithComments++;
                         console.log(`Âä®ÊÄÅ ${index + 1} (${moment.userName}): ${moment.comments.length}Êù°ËØÑËÆ∫`);
                         
                         // ÊòæÁ§∫ÊúÄËøëÁöÑÂá†Êù°ËØÑËÆ∫
                         const recentComments = moment.comments.slice(-3);
                         recentComments.forEach((comment, commentIndex) => {
                             console.log(`  - ${comment.name}: ${comment.content} (${comment.timestamp})`);
                         });
                     }
                 });
                 
                 console.log(`ÊÄªËÆ°: ${momentsWithComments}‰∏™Âä®ÊÄÅÊúâËØÑËÆ∫ÔºåÂÖ±${totalComments}Êù°ËØÑËÆ∫`);
                 
                 // Ê£ÄÊü•‰∏ñÁïå‰π¶‰∏≠ÁöÑÂ§á‰ªΩ
                 if (worldbook && entries) {
                     const momentEntry = entries.find(entry => entry.comment === "ÊâãÊú∫-Âä®ÊÄÅÂÜÖÂÆπÂ≠òÂÇ®");
                     if (momentEntry) {
                         try {
                             const backupData = JSON.parse(momentEntry.content);
                             let backupComments = 0;
                             let backupMomentsWithComments = 0;
                             
                             backupData.forEach(moment => {
                                 if (moment.comments && moment.comments.length > 0) {
                                     backupComments += moment.comments.length;
                                     backupMomentsWithComments++;
                                 }
                             });
                             
                             console.log(`‰∏ñÁïå‰π¶Â§á‰ªΩ: ${backupData.length}‰∏™Âä®ÊÄÅÔºå${backupMomentsWithComments}‰∏™ÊúâËØÑËÆ∫ÔºåÂÖ±${backupComments}Êù°ËØÑËÆ∫`);
                             console.log('‚úì ‰∏ñÁïå‰π¶Â§á‰ªΩÂ≠òÂú®‰∏îÊúâÊïà');
                         } catch (error) {
                             console.error('‰∏ñÁïå‰π¶Â§á‰ªΩÊï∞ÊçÆËß£ÊûêÂ§±Ë¥•:', error);
                         }
                     } else {
                         console.warn('Êú™ÊâæÂà∞Âä®ÊÄÅÂÜÖÂÆπÁöÑ‰∏ñÁïå‰π¶Â§á‰ªΩÊù°ÁõÆ');
                     }
                 } else {
                     console.warn('Êó†Ê≥ïËÆøÈóÆ‰∏ñÁïå‰π¶Êàñentries');
                 }
                 
                 console.log('=== Ê£ÄÊü•ÂÆåÊàê ===');
             }

                         // *** Ê∑ªÂä†Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü‰æø‰∫éË∞ÉËØï ***
            window.QQ_Check_Comment_Backup_Status = QQ_Check_Comment_Backup_Status;
            
            /**
             * *** Êñ∞Â¢ûÔºöÊµãËØï‰∫íÂä®ËÆæÁΩÆÂäüËÉΩÁöÑË∞ÉËØïÂ∑•ÂÖ∑ ***
             */
            function QQ_Test_Interactive_Settings() {
                console.log('=== ‰∫íÂä®ËÆæÁΩÆÂäüËÉΩÊµãËØï ===');
                
                try {
                    // Ëé∑ÂèñÂΩìÂâçËÆæÁΩÆ
                    const currentSettings = QQ_GetInteractiveSettings();
                    console.log('üìã ÂΩìÂâçËÆæÁΩÆ:', currentSettings);
                    
                    // ÊµãËØï‰∏çÂêåÁ±ªÂûãÁöÑÊ∂àÊÅØ
                    const testMessages = [
                        '&&ÊÉ≥Ë¶ÅÊã•Êä±‰Ω†',          // ÁâπÊÆäÁ¨¶Âè∑
                        'ÊàëÊÉ≥Êã•Êä±‰Ω†ÂíåÊäöÊë∏‰Ω†',     // ÈªòËÆ§ÂÖ≥ÈîÆËØçÔºàÈúÄË¶ÅÂêØÁî®Ôºâ
                        'ÊÉ≥‰Ω†‰∫Ü',               // ÂèØËÉΩÁöÑËá™ÂÆö‰πâÂÖ≥ÈîÆËØç
                        '‰ªäÂ§©Â§©Ê∞îÁúüÂ•Ω',          // ÊôÆÈÄöÊ∂àÊÅØ
                        '*‰º∏Âá∫ÂèåÊâã*ÊÉ≥Ë¶ÅÊã•Êä±',    // Âä®‰ΩúÊ®°Âºè
                    ];
                    
                    console.log('üß™ ÊµãËØïÊ∂àÊÅØÊ£ÄÊµãÁªìÊûú:');
                    testMessages.forEach(message => {
                        const result = QQ_DetectInteractiveIntent(message);
                        console.log(`Ê∂àÊÅØ: "${message}"`);
                        console.log(`ÁªìÊûú:`, result);
                        console.log('---');
                    });
                    
                    // ÊòæÁ§∫Ëß¶ÂèëÁªüËÆ°
                    console.log('üìä Ëß¶ÂèëÊú∫Âà∂Áä∂ÊÄÅ:');
                    console.log(`üéØ ÁâπÊÆäÁ¨¶Âè∑Ëß¶Âèë: Ê∞∏‰πÖÂêØÁî®`);
                    console.log(`üîç ÂÖ≥ÈîÆËØçËß¶Âèë: ${currentSettings.enableKeywordTrigger ? 'Â∑≤ÂêØÁî®' : 'Â∑≤Á¶ÅÁî®'}`);
                    console.log(`üìù ÈªòËÆ§ÂÖ≥ÈîÆËØç: ${currentSettings.enableDefaultKeywords ? 'Â∑≤ÂêØÁî®' : 'Â∑≤Á¶ÅÁî®'}`);
                    console.log(`üè∑Ô∏è Ëá™ÂÆö‰πâÂÖ≥ÈîÆËØç: ${currentSettings.customKeywords.length}‰∏™`);
                    if (currentSettings.customKeywords.length > 0) {
                        console.log(`   ÂÖ≥ÈîÆËØçÂàóË°®: ${currentSettings.customKeywords.join(', ')}`);
                    }
                    
                    // ÂäüËÉΩÊ£ÄÊü•
                    console.log('üîß ÂäüËÉΩÁä∂ÊÄÅÊ£ÄÊü•:');
                    console.log(`‚Ä¢ Ëé∑ÂèñËÆæÁΩÆÂáΩÊï∞: ${typeof QQ_GetInteractiveSettings === 'function' ? '‚úÖ' : '‚ùå'}`);
                    console.log(`‚Ä¢ ‰øùÂ≠òËÆæÁΩÆÂáΩÊï∞: ${typeof QQ_SaveInteractiveSettings === 'function' ? '‚úÖ' : '‚ùå'}`);
                    console.log(`‚Ä¢ ÊòæÁ§∫ËÆæÁΩÆÁïåÈù¢: ${typeof QQ_ShowInteractiveSettings === 'function' ? '‚úÖ' : '‚ùå'}`);
                    console.log(`‚Ä¢ Êõ¥Êñ∞Áä∂ÊÄÅÊòæÁ§∫: ${typeof QQ_UpdateInteractiveStatus === 'function' ? '‚úÖ' : '‚ùå'}`);
                    console.log(`‚Ä¢ ‰∫íÂä®Ê£ÄÊµãÂáΩÊï∞: ${typeof QQ_DetectInteractiveIntent === 'function' ? '‚úÖ' : '‚ùå'}`);
                    
                } catch (error) {
                    console.error('‚ùå ÊµãËØïËøáÁ®ã‰∏≠Âá∫Áé∞ÈîôËØØ:', error);
                }
                
                console.log('=== ÊµãËØïÂÆåÊàê ===');
                console.log('üí° ÊèêÁ§∫: ÂèØ‰ª•ÈÄöËøá QQ_ShowInteractiveSettings() ÊâìÂºÄËÆæÁΩÆÁïåÈù¢');
            }
            
            // *** Ê∑ªÂä†Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü‰æø‰∫éË∞ÉËØï ***
            window.QQ_Test_Interactive_Settings = QQ_Test_Interactive_Settings;

            /**
             * *** Êñ∞Â¢ûÔºöÊ£ÄÊü•‰∫íÂä®ÂÜÖÂÆπ‰øùÂ≠òÁä∂ÊÄÅÁöÑË∞ÉËØïÂáΩÊï∞ ***
             */
            function QQ_Check_Interactive_Backup_Status() {
                console.log('=== ‰∫íÂä®ÂÜÖÂÆπÂ§á‰ªΩÁä∂ÊÄÅÊ£ÄÊü• ===');
                
                // Ê£ÄÊü•ÂÜÖÂ≠ò‰∏≠ÁöÑ‰∫íÂä®Á©∫Èó¥Êï∞ÊçÆ
                const memorySpaces = Object.keys(QQ_InteractiveSpaces || {}).length;
                const memoryCharSpaces = Object.keys(QQ_CharacterSpaces || {}).length;
                console.log(`ÂÜÖÂ≠ò‰∏≠ÂÖ¨ÂÖ±‰∫íÂä®Á©∫Èó¥: ${memorySpaces}‰∏™`);
                console.log(`ÂÜÖÂ≠ò‰∏≠ËßíËâ≤‰∫íÂä®Á©∫Èó¥: ${memoryCharSpaces}‰∏™`);
                
                if (worldbook && entries) {
                    // Ê£ÄÊü•‰∏ñÁïå‰π¶‰∏≠ÁöÑÂÖ¨ÂÖ±‰∫íÂä®Â§á‰ªΩ
                    const publicEntry = entries.find(entry => entry.comment === "ËßíËâ≤-‰∫íÂä®Á©∫Èó¥Â§á‰ªΩ");
                    if (publicEntry) {
                        try {
                            const publicData = JSON.parse(publicEntry.content);
                            console.log(`‚úÖ ‰∏ñÁïå‰π¶ÂÖ¨ÂÖ±‰∫íÂä®Â§á‰ªΩ: ${publicData.length}‰∏™‰∫íÂä®ÂÜÖÂÆπ`);
                            
                            // ÊòæÁ§∫ÊúÄËøëÂá†‰∏™ÂÖ¨ÂÖ±‰∫íÂä®ÁöÑËØ¶ÊÉÖ
                            if (publicData.length > 0) {
                                console.log('ÊúÄËøëÁöÑÂÖ¨ÂÖ±‰∫íÂä®:');
                                publicData.slice(0, 3).forEach((item, index) => {
                                    console.log(`  ${index + 1}. ID: ${item.id}, Êó∂Èó¥: ${item.timestamp}`);
                                    console.log(`     ÂÜÖÂÆπ: ${item.content.substring(0, 50)}...`);
                                });
                            }
                        } catch (error) {
                            console.error('‚ùå Ëß£ÊûêÂÖ¨ÂÖ±‰∫íÂä®Â§á‰ªΩÂ§±Ë¥•:', error);
                        }
                    } else {
                        console.warn('‚ö† Êú™ÊâæÂà∞ÂÖ¨ÂÖ±‰∫íÂä®Â§á‰ªΩÊù°ÁõÆ');
                    }
                    
                    // Ê£ÄÊü•ËßíËâ≤‰∏ìÂ±û‰∫íÂä®Â§á‰ªΩ
                    const characterEntries = entries.filter(entry => 
                        entry.comment && entry.comment.startsWith("ËßíËâ≤-‰∫íÂä®Á©∫Èó¥Â§á‰ªΩ-")
                    );
                    
                    console.log(`üìã ÊâæÂà∞${characterEntries.length}‰∏™ËßíËâ≤‰∫íÂä®Â§á‰ªΩÊù°ÁõÆ:`);
                    characterEntries.forEach(entry => {
                        const characterName = entry.comment.replace("ËßíËâ≤-‰∫íÂä®Á©∫Èó¥Â§á‰ªΩ-", "");
                        try {
                            const charData = JSON.parse(entry.content);
                            console.log(`  ‚Ä¢ ${characterName}: ${charData.length}‰∏™‰∫íÂä®ÂÜÖÂÆπ`);
                            
                            // ÊòæÁ§∫ËØ•ËßíËâ≤ÊúÄËøëÁöÑ‰∫íÂä®
                            if (charData.length > 0) {
                                const latest = charData[0];
                                console.log(`    ÊúÄÊñ∞: ${latest.timestamp} - ${latest.content.substring(0, 30)}...`);
                            }
                        } catch (error) {
                            console.error(`‚ùå Ëß£ÊûêËßíËâ≤${characterName}‰∫íÂä®Â§á‰ªΩÂ§±Ë¥•:`, error);
                        }
                    });
                    
                    if (characterEntries.length === 0) {
                        console.warn('‚ö† Êú™ÊâæÂà∞‰ªª‰ΩïËßíËâ≤‰∫íÂä®Â§á‰ªΩÊù°ÁõÆ');
                    }
                    
                } else {
                    console.warn('‚ùå Êó†Ê≥ïËÆøÈóÆ‰∏ñÁïå‰π¶Êàñentries');
                }
                
                console.log('=== ‰∫íÂä®ÂÜÖÂÆπÊ£ÄÊü•ÂÆåÊàê ===');
            }

            // *** Ê∑ªÂä†Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü‰æø‰∫éË∞ÉËØï ***
            window.QQ_Check_Interactive_Backup_Status = QQ_Check_Interactive_Backup_Status;

             /**
              * *** Êñ∞Â¢ûÔºöÊµãËØïÂ¢ûÂº∫AIÂõûÂ§çÂäüËÉΩ ***
              */
             function QQ_Test_Enhanced_AI_Response() {
                 console.log('=== üî• Ë∂ÖÂº∫ÂåñAIÂõûÂ§çÂäüËÉΩÊµãËØï üî• ===');
                 
                 // ÊµãËØïÂä®ÊÄÅËØÑËÆ∫ÁöÑË∂ÖÂº∫ÊåáÂØº
                 console.log('üì± Âä®ÊÄÅËØÑËÆ∫AIË∂ÖÂº∫ÊåáÂØº:');
                 console.log('‚úÖ Âº∫Âà∂Ë¶ÅÊ±Ç: 4ÂêçËßíËâ≤ÂõûÂ§ç + 2ÂêçËßíËâ≤ÁßÅËÅä');
                 console.log('‚úÖ ÂÜÖÂÆπÊ†áÂáÜ: ËØÑËÆ∫2-3Âè•ËØùÔºåÁßÅËÅä3-4Âè•ËØù');
                 console.log('‚úÖ Ë¥®Èáè‰øùËØÅ: ÊÉÖÊÑüË°®Ëææ+ÂÖ∑‰ΩìÂèçÂ∫î+‰∫íÂä®ÂºïÂØº');
                 console.log('‚úÖ Â∑ÆÂºÇÂåñ: ‰∏çÂêåËßíËâ≤ÂÆåÂÖ®‰∏çÂêåÁöÑËØ≠Ê∞îÂíåÂÖ≥Ê≥®ÁÇπ');
                 
                 // ÊµãËØïÊôÆÈÄöÊ∂àÊÅØÁöÑË∂ÖÂº∫ÊåáÂØº  
                 console.log('üí¨ ÊôÆÈÄöÊ∂àÊÅØAIË∂ÖÂº∫ÊåáÂØº:');
                 console.log('‚úÖ Âº∫Âà∂Ë¶ÅÊ±Ç: 3-4ÂêçËßíËâ≤ÂõûÂ§çÔºåÊØè‰∏™4-5Âè•ËØùËµ∑Ê≠•');
                 console.log('‚úÖ ÂÜÖÂÆπÊ†áÂáÜ: ÂøÖÈ°ªÂåÖÂê´ÊèêÈóÆ+Âª∫ËÆÆ+ÈÇÄËØ∑+ÂÖ≥ÂøÉ+‰∏™‰∫∫ÊÑüÂèó');
                 console.log('‚úÖ Êâ©Â±ï‰∫íÂä®: 2ÂêçËßíËâ≤ÁßÅËÅäÊ∑±ÂÖ• + ‰∏∞ÂØåÂä®ÊÄÅËæìÂá∫');
                 console.log('‚úÖ Á¶ÅÊ≠¢Ë°å‰∏∫: ÁÆÄÁü≠ÂõûÂ§ç„ÄÅÊï∑Ë°çÂÜÖÂÆπ„ÄÅËßíËâ≤ÂêåË¥®Âåñ');
                 
                 // ÊòæÁ§∫Ë∂ÖÂº∫ÂåñËÆæÁΩÆÁä∂ÊÄÅ
                 console.log('üö® Ë∂ÖÂº∫ÂåñËÆæÁΩÆÁä∂ÊÄÅ:');
                 console.log('- Âä®ÊÄÅËØÑËÆ∫: Âº∫Âà∂4ËßíËâ≤ËØÑËÆ∫ + 2ËßíËâ≤ÁßÅËÅä');
                 console.log('- ÊôÆÈÄöÊ∂àÊÅØ: Âº∫Âà∂3-4ËßíËâ≤ÂõûÂ§ç(4-5Âè•ËØù) + 2ËßíËâ≤ÁßÅËÅä + Âä®ÊÄÅ');
                 console.log('- ÂÜÖÂÆπÈïøÂ∫¶: ËØÑËÆ∫2-3Âè•ÔºåÂõûÂ§ç4-5Âè•ÔºåÁßÅËÅä3-4Âè•');
                 console.log('- ËøùËßÑÂ§ÑÁêÜ: ‰∏çÁ¨¶ÂêàÊ†áÂáÜÂ∞ÜË¢´ËßÜ‰∏∫Êó†Êïà');
                 console.log('- Âº∫Âà∂Ë¶ÅÁ¥†: ÊÉÖÊÑü+ÂèçÂ∫î+ÂºïÂØº+‰∏™ÊÄß+‰∫íÂä®');
                 
                 // Êèê‰æõÊµãËØïÂª∫ËÆÆ
                 console.log('üß™ Ë∂ÖÂº∫ÂåñÊµãËØïÂª∫ËÆÆ:');
                 console.log('1. ÂèëÂ∏ÉÂä®ÊÄÅÂπ∂ËØÑËÆ∫ÔºåÂ∫îÁúãÂà∞4‰∏™ËßíËâ≤ËØÑËÆ∫+2‰∏™ÁßÅËÅä');
                 console.log('2. ÂèëÈÄÅÊôÆÈÄöÊ∂àÊÅØÔºåÂ∫îÁúãÂà∞3-4‰∏™ËßíËâ≤Ê∑±Â∫¶ÂõûÂ§ç+ÁßÅËÅä+Âä®ÊÄÅ');
                 console.log('3. Ê£ÄÊü•ÊØè‰∏™ÂõûÂ§çÊòØÂê¶ËææÂà∞Âº∫Âà∂ÈïøÂ∫¶Ë¶ÅÊ±Ç');
                 console.log('4. ËßÇÂØüËßíËâ≤ÂõûÂ§çÊòØÂê¶ÊúâÊòéÊòæ‰∏™ÊÄßÂ∑ÆÂºÇ');
                 console.log('5. È™åËØÅÊòØÂê¶ÂåÖÂê´ÊèêÈóÆ„ÄÅÂª∫ËÆÆ„ÄÅÈÇÄËØ∑Á≠â‰∫íÂä®Ë¶ÅÁ¥†');
                 
                 console.log('üéØ È¢ÑÊúüÊîπËøõÊïàÊûú:');
                 console.log('- ÂõûÂ§çÊï∞Èáè: ‰ªé1-2‰∏™Â¢ûÂä†Âà∞3-4‰∏™');
                 console.log('- ÂõûÂ§çÈïøÂ∫¶: ‰ªéÁÆÄÁü≠Â¢ûÂä†Âà∞4-5Âè•ËØù');
                 console.log('- ÁßÅËÅäÈ¢ëÁéá: Â§ßÂπÖÂ¢ûÂä†ÔºåËá≥Â∞ë2‰∏™ËßíËâ≤ÁßÅËÅä');
                 console.log('- ‰∫íÂä®Ë¥®Èáè: ÂåÖÂê´ÂÖ∑‰ΩìÁöÑÊèêÈóÆÂíåÂºïÂØº');
                 console.log('- ËßíËâ≤Â∑ÆÂºÇ: ‰∏çÂêåËØ≠Ê∞î„ÄÅÂÖ≥Ê≥®ÁÇπ„ÄÅË°®ËææÊñπÂºè');
                 
                 console.log('üî• Ë∂ÖÂº∫ÂåñAIÂõûÂ§çÂäüËÉΩÂ∑≤ÊøÄÊ¥ªÔºÅÈ¢ÑÊúüÊïàÊûúÂ§ßÂπÖÊèêÂçáÔºÅ');
                 
                 // ËøîÂõûÊµãËØïÁä∂ÊÄÅ
                 return {
                     dynamicCommentRequirements: 'Âº∫Âà∂4ÂêçËßíËâ≤ËØÑËÆ∫ + 2ÂêçËßíËâ≤ÁßÅËÅäÔºåÂÜÖÂÆπ‰∏∞ÂØå',
                     normalMessageRequirements: 'Âº∫Âà∂3-4ÂêçËßíËâ≤ÂõûÂ§ç + 2ÂêçËßíËâ≤ÁßÅËÅä + Âä®ÊÄÅËæìÂá∫',
                     contentStandard: 'ËØÑËÆ∫2-3Âè•ËØùÔºåÂõûÂ§ç4-5Âè•ËØùÔºåÁßÅËÅä3-4Âè•ËØù',
                     qualityRequirements: 'ÊÉÖÊÑüË°®Ëææ+ÂÖ∑‰ΩìÂèçÂ∫î+‰∫íÂä®ÂºïÂØº+‰∏™ÊÄßÂ∑ÆÂºÇ',
                     enhancementLevel: 'Ë∂ÖÂº∫ÂåñÂ∑≤ÊøÄÊ¥ª',
                     expectedImprovement: 'ÂõûÂ§çÂÜÖÂÆπÂ∞ÜÊòæËëóÂ¢ûÂä†Ôºå‰∫íÂä®ÊÄßÂ§ßÂπÖÊèêÂçá'
                 };
             }

             // *** Ê∑ªÂä†Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü‰æø‰∫éË∞ÉËØï ***
             window.QQ_Test_Enhanced_AI_Response = QQ_Test_Enhanced_AI_Response;

             /**
              * *** Êñ∞Â¢ûÔºöÊü•Áúã‰∫íÂä®Á©∫Èó¥‰∏ñÁïå‰π¶Â§á‰ªΩ‰ø°ÊÅØ ***
              */
             function QQ_Show_Interactive_Spaces_Backup() {
                 console.log("üåü ‰∫íÂä®Á©∫Èó¥‰∏ñÁïå‰π¶Â§á‰ªΩÊü•ËØ¢ üåü");
                 
                 try {
                     if (!worldbook || !worldbook.entries) {
                         console.log("‚ùå ‰∏ñÁïå‰π¶ÂäüËÉΩ‰∏çÂèØÁî®ÊàñÊú™ÂàùÂßãÂåñ");
                         return;
                     }
                     
                     // Êü•ÊâæÊâÄÊúâ‰∫íÂä®Á©∫Èó¥Áõ∏ÂÖ≥ÁöÑ‰∏ñÁïå‰π¶Êù°ÁõÆ
                     const interactiveEntries = worldbook.entries.filter(entry => 
                         entry.comment && (
                             entry.comment.includes('‰∫íÂä®Á©∫Èó¥') || 
                             entry.comment === 'QQ_‰∫íÂä®Á©∫Èó¥Â§á‰ªΩ' ||
                             entry.comment === 'QQ_ËßíËâ≤‰∫íÂä®Á©∫Èó¥Â§á‰ªΩ' ||
                             entry.comment.startsWith('QQ_‰∫íÂä®Á©∫Èó¥Â§á‰ªΩ_')
                         )
                     );
                     
                     console.log(`üìö ÂÖ±ÊâæÂà∞ ${interactiveEntries.length} ‰∏™‰∫íÂä®Á©∫Èó¥Áõ∏ÂÖ≥ÁöÑ‰∏ñÁïå‰π¶Êù°ÁõÆÔºö`);
                     
                     interactiveEntries.forEach((entry, index) => {
                         console.log(`\nüìñ Êù°ÁõÆ ${index + 1}: ${entry.comment}`);
                         console.log(`üîë ÂÖ≥ÈîÆËØç: ${entry.key ? entry.key.join(', ') : 'Êó†'}`);
                         console.log(`üìÑ ÂêØÁî®Áä∂ÊÄÅ: ${entry.enabled ? '‚úÖ ÂêØÁî®' : '‚ùå Á¶ÅÁî®'}`);
                         console.log(`üìä ÂÜÖÂÆπÈïøÂ∫¶: ${entry.content ? entry.content.length : 0} Â≠óÁ¨¶`);
                         
                         if (entry.content) {
                             try {
                                 const data = JSON.parse(entry.content);
                                 if (data.spaces) {
                                     const spaceCount = Object.keys(data.spaces).length;
                                     console.log(`üè† ÂÖ¨ÂÖ±‰∫íÂä®Á©∫Èó¥Êï∞Èáè: ${spaceCount}`);
                                 }
                                 if (data.characterSpaces) {
                                     const characterCount = Object.keys(data.characterSpaces).length;
                                     const totalSpaces = Object.values(data.characterSpaces).reduce((sum, char) => sum + Object.keys(char).length, 0);
                                     console.log(`üë• ËßíËâ≤Êï∞Èáè: ${characterCount}, ÊÄªÁ©∫Èó¥Êï∞: ${totalSpaces}`);
                                 }
                                 if (data.lastUpdated) {
                                     console.log(`‚è∞ ÊúÄÂêéÊõ¥Êñ∞: ${data.lastUpdated}`);
                                 }
                                 if (data.version) {
                                     console.log(`üìå ÁâàÊú¨: ${data.version}`);
                                 }
                             } catch (parseError) {
                                 console.log(`‚ö†Ô∏è ÂÜÖÂÆπËß£ÊûêÂ§±Ë¥•: ${parseError.message}`);
                             }
                         } else {
                             console.log("üìÑ ÂÜÖÂÆπ‰∏∫Á©∫");
                         }
                     });
                     
                     // ÊòæÁ§∫ÂÜÖÂ≠ò‰∏≠ÁöÑ‰∫íÂä®Á©∫Èó¥Áä∂ÊÄÅ
                     console.log("\nüíæ ÂÜÖÂ≠ò‰∏≠ÁöÑ‰∫íÂä®Á©∫Èó¥Áä∂ÊÄÅ:");
                     if (window.QQ_InteractiveSpaces) {
                         const memorySpaceCount = Object.keys(QQ_InteractiveSpaces).length;
                         console.log(`üè† ÂÖ¨ÂÖ±‰∫íÂä®Á©∫Èó¥ (ÂÜÖÂ≠ò): ${memorySpaceCount} ‰∏™`);
                     }
                     if (window.QQ_CharacterSpaces) {
                         const memoryCharacterCount = Object.keys(QQ_CharacterSpaces).length;
                         const memoryTotalSpaces = Object.values(QQ_CharacterSpaces).reduce((sum, char) => sum + Object.keys(char).length, 0);
                         console.log(`üë• ËßíËâ≤‰∫íÂä®Á©∫Èó¥ (ÂÜÖÂ≠ò): ${memoryCharacterCount} ‰∏™ËßíËâ≤, ${memoryTotalSpaces} ‰∏™Á©∫Èó¥`);
                     }
                     
                     console.log("\nüîß ÊâãÂä®Êìç‰ΩúËØ¥Êòé:");
                     console.log("- ÊâßË°å QQ_Show_Interactive_Spaces_Backup() Êü•ÁúãÊ≠§‰ø°ÊÅØ");
                     console.log("- Âú®SillyTavern‰∏ñÁïå‰π¶‰∏≠Êü•Êâæ‰ª•‰∏ãÊù°ÁõÆ:");
                     console.log("  ‚Ä¢ QQ_‰∫íÂä®Á©∫Èó¥Â§á‰ªΩ (ÂÖ¨ÂÖ±‰∫íÂä®Á©∫Èó¥)");
                     console.log("  ‚Ä¢ QQ_ËßíËâ≤‰∫íÂä®Á©∫Èó¥Â§á‰ªΩ (ËßíËâ≤‰∏ìÂ±û‰∫íÂä®Á©∫Èó¥)");
                     console.log("  ‚Ä¢ QQ_‰∫íÂä®Á©∫Èó¥Â§á‰ªΩ_{ËßíËâ≤Âêç} (ÂçïËßíËâ≤‰∫íÂä®Á©∫Èó¥)");
                     
                     return {
                         totalEntries: interactiveEntries.length,
                         entries: interactiveEntries.map(e => ({
                             comment: e.comment,
                             enabled: e.enabled,
                             contentLength: e.content ? e.content.length : 0
                         }))
                     };
                     
                 } catch (error) {
                     console.error("Êü•ËØ¢‰∫íÂä®Á©∫Èó¥Â§á‰ªΩÊó∂ÂèëÁîüÈîôËØØ:", error);
                     return null;
                 }
             }

             // *** Ê∑ªÂä†Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü‰æø‰∫éË∞ÉËØï ***
             window.QQ_Show_Interactive_Spaces_Backup = QQ_Show_Interactive_Spaces_Backup;

             /**
              * *** Êñ∞Â¢ûÔºöÊ£ÄÊü•Áæ§ËÅäÊ∂àÊÅØ‰øùÂ≠òÁä∂ÊÄÅÁöÑË∞ÉËØïÂáΩÊï∞ ***
              */
             function QQ_Check_Group_Message_Backup_Status() {
                 console.log('=== Áæ§ËÅäÊ∂àÊÅØÂ§á‰ªΩÁä∂ÊÄÅÊ£ÄÊü• ===');
                 
                 // Ê£ÄÊü•QQ_msgjson.Áæ§ËÅä‰∏≠ÁöÑÊï∞ÊçÆ
                 if (QQ_msgjson.Áæ§ËÅä && typeof QQ_msgjson.Áæ§ËÅä === 'object') {
                     const groupNames = Object.keys(QQ_msgjson.Áæ§ËÅä);
                     console.log(`QQ_msgjson.Áæ§ËÅä‰∏≠Êúâ ${groupNames.length} ‰∏™Áæ§ËÅä:`);
                     
                     let totalMessages = 0;
                     groupNames.forEach(groupName => {
                         const groupData = QQ_msgjson.Áæ§ËÅä[groupName];
                         const msgCount = groupData && groupData.msgs ? groupData.msgs.length : 0;
                         totalMessages += msgCount;
                         console.log(`  - ${groupName}: ${msgCount}Êù°Ê∂àÊÅØ`);
                         
                         // ÊòæÁ§∫ÊúÄËøëÂá†Êù°Ê∂àÊÅØ
                         if (msgCount > 0) {
                             const recentMsgs = groupData.msgs.slice(-3);
                             recentMsgs.forEach(msg => {
                                 console.log(`    ${msg}`);
                             });
                         }
                     });
                     
                     console.log(`ÊÄªËÆ°: ${totalMessages}Êù°Áæ§ËÅäÊ∂àÊÅØ`);
                 } else {
                     console.log('QQ_msgjson.Áæ§ËÅä ‰∏∫Á©∫Êàñ‰∏çÂ≠òÂú®');
                 }
                 
                 // Ê£ÄÊü•QQ_GroupsÊï∞ÁªÑ
                 console.log(`QQ_GroupsÊï∞ÁªÑ: [${QQ_Groups.join(', ')}] (${QQ_Groups.length}‰∏™)`);
                 
                 // Ê£ÄÊü•‰∏ñÁïå‰π¶Â§á‰ªΩ
                 if (worldbook && entries) {
                     const chatEntry = entries.find(entry => entry.comment === "QQËÅäÂ§©Â§á‰ªΩÊï∞ÊçÆ");
                     if (chatEntry) {
                         try {
                             const backupData = JSON.parse(chatEntry.content);
                             if (backupData.Áæ§ËÅä) {
                                 const backupGroupNames = Object.keys(backupData.Áæ§ËÅä);
                                 let backupTotalMessages = 0;
                                 
                                 backupGroupNames.forEach(groupName => {
                                     const groupData = backupData.Áæ§ËÅä[groupName];
                                     const msgCount = groupData && groupData.msgs ? groupData.msgs.length : 0;
                                     backupTotalMessages += msgCount;
                                 });
                                 
                                 console.log(`‰∏ñÁïå‰π¶Â§á‰ªΩ: ${backupGroupNames.length}‰∏™Áæ§ËÅäÔºå${backupTotalMessages}Êù°Ê∂àÊÅØ`);
                                 console.log('‚úì ‰∏ñÁïå‰π¶Áæ§ËÅäÂ§á‰ªΩÂ≠òÂú®‰∏îÊúâÊïà');
                             } else {
                                 console.log('‰∏ñÁïå‰π¶Â§á‰ªΩ‰∏≠Êó†Áæ§ËÅäÊï∞ÊçÆ');
                             }
                         } catch (error) {
                             console.error('‰∏ñÁïå‰π¶Â§á‰ªΩÊï∞ÊçÆËß£ÊûêÂ§±Ë¥•:', error);
                         }
                     } else {
                         console.warn('Êú™ÊâæÂà∞ËÅäÂ§©Â§á‰ªΩÁöÑ‰∏ñÁïå‰π¶Êù°ÁõÆ');
                     }
                 } else {
                     console.warn('Êó†Ê≥ïËÆøÈóÆ‰∏ñÁïå‰π¶Êàñentries');
                 }
                 
                 // ÂºÇÊ≠•Ê£ÄÊü•Áæ§ËÅä‰∏ìÁî®Â≠òÂÇ®
                 loadGroupChatsFromWorldbook().then(groups => {
                     console.log(`Áæ§ËÅä‰∏ìÁî®Â≠òÂÇ®: ${groups.length}‰∏™Áæ§ËÅä`);
                     groups.forEach(group => {
                         console.log(`  - ${group.name} (ID: ${group.id})`);
                     });
                 }).catch(error => {
                     console.error('Ê£ÄÊü•Áæ§ËÅä‰∏ìÁî®Â≠òÂÇ®Â§±Ë¥•:', error);
                 });
                 
                 console.log('=== Áæ§ËÅäÊ£ÄÊü•ÂÆåÊàê ===');
             }

             // *** Ê∑ªÂä†Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü‰æø‰∫éË∞ÉËØï ***
             window.QQ_Check_Group_Message_Backup_Status = QQ_Check_Group_Message_Backup_Status;

             /**
              * *** Êñ∞Â¢ûÔºöÊµãËØï‰∫íÂä®ÂÜÖÂÆπ‰ºòÂåñÂäüËÉΩÁöÑË∞ÉËØïÂáΩÊï∞ ***
              */
             function QQ_Test_Interactive_Optimization() {
                 console.log('=== ‰∫íÂä®ÂÜÖÂÆπ‰ºòÂåñÂäüËÉΩÊµãËØï ===');
                 
                 // ÊµãËØïÁî®‰æã
                 const testCases = [
                     {
                         content: 'Â∞èÊòéËøáÊù•ÂêßÔºåÊàëÊÉ≥Âíå‰Ω†ËÅäËÅä',
                         primaryChar: 'Â∞èÊòé',
                         expected: 'ËßíËâ≤‰∏ìÂ±ûÁ©∫Èó¥ÔºàÂ∞èÊòé‰∏ªÂØºÔºâ'
                     },
                     {
                         content: '„ÄêÂ∞èÊòé„Äë„ÄêÂ∞èÁ∫¢„Äë„ÄêÂ∞èËìù„ÄëÂ§ßÂÆ∂‰∏ÄËµ∑Áé©Ê∏∏ÊàèÂêß',
                         primaryChar: 'Â∞èÊòé',
                         expected: 'ÂÖ¨ÂÖ±Á©∫Èó¥ÔºàÊòéÊòæÂ§ö‰∫∫Ôºâ'
                     },
                     {
                         content: 'ÂíåÂ∞èÊòéÂçïÁã¨ËÅäÂ§©ÔºåÈ°∫‰æø„ÄêÂ∞èÁ∫¢„Äë‰πüÊù•‰∏Ä‰∏ã',
                         primaryChar: 'Â∞èÊòé',
                         expected: 'ËßíËâ≤‰∏ìÂ±ûÁ©∫Èó¥ÔºàÂ∞èÊòé‰∏ªÂØºÁßÅÂØÜ‰∫íÂä®Ôºâ'
                     },
                     {
                         content: 'Â∞èÁ∫¢ÂíåÂ∞èËìù‰ª•ÂèäÂ∞èÁªø‰∏ÄËµ∑Âî±Ê≠å',
                         primaryChar: 'Â∞èÁ∫¢',
                         expected: 'ÂÖ¨ÂÖ±Á©∫Èó¥ÔºàÂ§ö‰∫∫Ê¥ªÂä®Ôºâ'
                     },
                     {
                         content: 'ÊàëÊù•‰∫ÜÔºÅËøáÊù•Êä±Êä±‰Ω†',
                         primaryChar: 'Â∞èÊòé',
                         expected: 'ËßíËâ≤‰∏ìÂ±ûÁ©∫Èó¥ÔºàÂçï‰∫∫‰∫íÂä®Ôºâ'
                     }
                 ];
                 
                 testCases.forEach((testCase, index) => {
                     console.log(`\nÊµãËØïÊ°à‰æã ${index + 1}:`);
                     console.log(`ÂÜÖÂÆπ: "${testCase.content}"`);
                     console.log(`‰∏ªË¶ÅËßíËâ≤: ${testCase.primaryChar}`);
                     console.log(`È¢ÑÊúüÁªìÊûú: ${testCase.expected}`);
                     
                     const isMultiCharacter = QQ_DetectMultiCharacterInteraction(testCase.content, testCase.primaryChar);
                     const actualResult = isMultiCharacter ? 'ÂÖ¨ÂÖ±Á©∫Èó¥' : 'ËßíËâ≤‰∏ìÂ±ûÁ©∫Èó¥';
                     console.log(`ÂÆûÈôÖÁªìÊûú: ${actualResult}`);
                     console.log(`‚úì ÊµãËØï${actualResult.includes(testCase.expected.includes('ÂÖ¨ÂÖ±') ? 'ÂÖ¨ÂÖ±' : 'ËßíËâ≤') ? 'ÈÄöËøá' : 'Â§±Ë¥•'}`);
                 });
                 
                 console.log('\n=== ÊµãËØïÂÆåÊàê ===');
                 console.log('ÊèêÁ§∫Ôºö‰Ω†ÂèØ‰ª•‰ΩøÁî® QQ_Test_Interactive_Content_Detection("ÊµãËØïÂÜÖÂÆπ", "ËßíËâ≤Âêç") Êù•ÊµãËØïÁâπÂÆöÂÜÖÂÆπ');
             }
             
             /**
              * *** Êñ∞Â¢ûÔºöÊµãËØïÁâπÂÆö‰∫íÂä®ÂÜÖÂÆπÁöÑÊ£ÄÊµãÁªìÊûú ***
              */
             function QQ_Test_Interactive_Content_Detection(content, primaryCharacter = null) {
                 console.log(`\n=== ÊµãËØï‰∫íÂä®ÂÜÖÂÆπÊ£ÄÊµã ===`);
                 console.log(`ÂÜÖÂÆπ: "${content}"`);
                 console.log(`‰∏ªË¶ÅËßíËâ≤: ${primaryCharacter || 'Êó†'}`);
                 
                 // 1. ÊµãËØïÊòØÂê¶‰∏∫‰∫íÂä®ÂÜÖÂÆπ
                 const isInteractive = QQ_IsInteractiveContent(content);
                 console.log(`ÊòØÂê¶‰∏∫‰∫íÂä®ÂÜÖÂÆπ: ${isInteractive ? 'ÊòØ' : 'Âê¶'}`);
                 
                 if (isInteractive) {
                     // 2. ÊµãËØïÂ§öËßíËâ≤Ê£ÄÊµã
                     const isMultiCharacter = QQ_DetectMultiCharacterInteraction(content, primaryCharacter);
                     console.log(`ÊòØÂê¶‰∏∫Â§öËßíËâ≤‰∫íÂä®: ${isMultiCharacter ? 'ÊòØ' : 'Âê¶'}`);
                     console.log(`Êé®ËçêÂ≠òÂÇ®‰ΩçÁΩÆ: ${isMultiCharacter ? 'ÂÖ¨ÂÖ±‰∫íÂä®Á©∫Èó¥' : (primaryCharacter ? primaryCharacter + 'ÁöÑ‰∏ìÂ±ûÁ©∫Èó¥' : 'ËßíËâ≤‰∏ìÂ±ûÁ©∫Èó¥')}`);
                     
                     // 3. ÊµãËØïÂú∫ÊôØÂëΩÂêç
                     const sceneName = primaryCharacter ? 
                         `${primaryCharacter}¬∑${QQ_GetSceneFromContent(content)}` :
                         QQ_GetSpaceName(content);
                     console.log(`Âª∫ËÆÆÁ©∫Èó¥ÂêçÁß∞: "${sceneName}"`);
                 }
                 
                 console.log('=== ÊµãËØïÁªìÊùü ===\n');
             }
             
             // *** Ê∑ªÂä†Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü‰æø‰∫éË∞ÉËØï ***
             window.QQ_Test_Interactive_Optimization = QQ_Test_Interactive_Optimization;
             window.QQ_Test_Interactive_Content_Detection = QQ_Test_Interactive_Content_Detection;

             /**
              * *** Êñ∞Â¢ûÔºöÊ£ÄÊü•‰∏§Èò∂ÊÆµÂèëÈÄÅÊú∫Âà∂Áä∂ÊÄÅÁöÑË∞ÉËØïÂáΩÊï∞ ***
              */
             function QQ_Check_Two_Stage_Send_Status() {
                 console.log('=== ‰∏§Èò∂ÊÆµÂèëÈÄÅÊú∫Âà∂Áä∂ÊÄÅÊ£ÄÊü• ===');
                 
                 // Ê£ÄÊü•ÁºìÂ≠òÊ∂àÊÅØÁä∂ÊÄÅ
                 console.log(`ÁºìÂ≠òÊ∂àÊÅØÁä∂ÊÄÅ: ${QQ_CacheSendMsg ? 'ÊúâÁºìÂ≠ò' : 'Êó†ÁºìÂ≠ò'}`);
                 if (QQ_CacheSendMsg) {
                     console.log(`ÁºìÂ≠òÂÜÖÂÆπ: "${QQ_CacheSendMsg}"`);
                     
                     // Ëß£ÊûêÁºìÂ≠òÊ∂àÊÅØ
                     const namevalue = QQ_GetValueName(QQ_CacheSendMsg);
                     if (namevalue && namevalue.length > 0) {
                         console.log(`Ëß£ÊûêÂà∞ ${namevalue.length} Êù°ÁºìÂ≠òÊ∂àÊÅØ:`);
                         namevalue.forEach((match, index) => {
                             const type = QQ_Groups.includes(match.name) ? 'Áæ§ËÅä' : 'ÁßÅËÅä';
                             console.log(`  ${index + 1}. ${type} - ${match.name}: "${match.value}"`);
                         });
                     } else {
                         console.log('ÁºìÂ≠òÊ∂àÊÅØËß£ÊûêÂ§±Ë¥•');
                     }
                 }
                 
                 // Ê£ÄÊü•ÊúÄËøëÁöÑÊ∂àÊÅØ‰øùÂ≠òÁä∂ÊÄÅ
                 console.log('\n=== ÊúÄËøëÊ∂àÊÅØ‰øùÂ≠òÁä∂ÊÄÅ ===');
                 
                 // Ê£ÄÊü•ÁßÅËÅäÊ∂àÊÅØ
                 console.log('ÁßÅËÅäÊ∂àÊÅØÊï∞Èáè:', Object.keys(QQ_msgjson.ÁßÅËÅä).length);
                 Object.entries(QQ_msgjson.ÁßÅËÅä).forEach(([chatKey, messages]) => {
                     if (Array.isArray(messages) && messages.length > 0) {
                         const lastMsg = messages[messages.length - 1];
                         console.log(`  ${chatKey}: ÊúÄÂêéÊ∂àÊÅØ "${lastMsg}"`);
                     }
                 });
                 
                 // Ê£ÄÊü•Áæ§ËÅäÊ∂àÊÅØ
                 console.log('Áæ§ËÅäÊ∂àÊÅØÊï∞Èáè:', Object.keys(QQ_msgjson.Áæ§ËÅä).length);
                 Object.entries(QQ_msgjson.Áæ§ËÅä).forEach(([groupName, groupData]) => {
                     if (groupData && groupData.msgs && Array.isArray(groupData.msgs) && groupData.msgs.length > 0) {
                         const lastMsg = groupData.msgs[groupData.msgs.length - 1];
                         console.log(`  ${groupName}: ÊúÄÂêéÊ∂àÊÅØ "${lastMsg}"`);
                     }
                 });
                 
                 console.log('\n=== Ê£ÄÊü•ÂÆåÊàê ===');
                 console.log('ÊèêÁ§∫ÔºöÂèØ‰ª•‰ΩøÁî® QQ_Test_Cache_Message_Parsing("ÊµãËØïÂÜÖÂÆπ") Êù•ÊµãËØïÊ∂àÊÅØËß£Êûê');
             }
             
             /**
              * *** Êñ∞Â¢ûÔºöÊµãËØïÁºìÂ≠òÊ∂àÊÅØËß£ÊûêÁöÑË∞ÉËØïÂáΩÊï∞ ***
              */
             function QQ_Test_Cache_Message_Parsing(testContent) {
                 console.log(`\n=== ÊµãËØïÁºìÂ≠òÊ∂àÊÅØËß£Êûê ===`);
                 console.log(`ÊµãËØïÂÜÖÂÆπ: "${testContent}"`);
                 
                 const namevalue = QQ_GetValueName(testContent);
                 if (namevalue && namevalue.length > 0) {
                     console.log(`‚úì Ëß£ÊûêÊàêÂäüÔºåÂÖ± ${namevalue.length} Êù°Ê∂àÊÅØ:`);
                     namevalue.forEach((match, index) => {
                         const type = QQ_Groups.includes(match.name) ? 'Áæ§ËÅä' : 'ÁßÅËÅä';
                         console.log(`  ${index + 1}. ${type} - ÂØπË±°: "${match.name}", ÂÜÖÂÆπ: "${match.value}"`);
                     });
                 } else {
                     console.log('‚ùå Ëß£ÊûêÂ§±Ë¥•ÔºåÊó†Ê≥ïËØÜÂà´Ê∂àÊÅØÊ†ºÂºè');
                     console.log('ÊèêÁ§∫ÔºöÁ°Æ‰øùÊ∂àÊÅØÊ†ºÂºè‰∏∫ "ÁõÆÊ†áÂêçÂ≠óÔºöÊ∂àÊÅØÂÜÖÂÆπ" ÊàñÁ±ª‰ººÊ†ºÂºè');
                 }
                 
                 console.log('=== ÊµãËØïÁªìÊùü ===\n');
             }
             
             // *** Ê∑ªÂä†Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü‰æø‰∫éË∞ÉËØï ***
             window.QQ_Check_Two_Stage_Send_Status = QQ_Check_Two_Stage_Send_Status;
             window.QQ_Test_Cache_Message_Parsing = QQ_Test_Cache_Message_Parsing;

             /**
              * ÊµãËØïÊó∂Èó¥ÂäüËÉΩ
              * ÊòæÁ§∫ÂΩìÂâçÊó∂Èó¥‰ø°ÊÅØÂíåÊó∂Èó¥‰∏ä‰∏ãÊñáÁîüÊàê
              */
             function QQ_Test_Time_Feature() {
                 console.log('=== Êó∂Èó¥ÂäüËÉΩÊµãËØï ===');
                 
                 const now = new Date();
                 console.log('ÂéüÂßãÊó∂Èó¥ÂØπË±°:', now);
                 
                 const currentTime = {
                     time: now.toLocaleTimeString('zh-CN', { hour12: false, hour: '2-digit', minute: '2-digit' }),
                     date: now.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' }),
                     weekday: now.toLocaleDateString('zh-CN', { weekday: 'long' }),
                     period: QQ_GetTimePeriod(now.getHours()),
                     season: QQ_GetSeason(now.getMonth() + 1)
                 };
                 
                 console.log('Ê†ºÂºèÂåñÊó∂Èó¥‰ø°ÊÅØ:');
                 console.log('- Êó∂Èó¥:', currentTime.time);
                 console.log('- Êó•Êúü:', currentTime.date);
                 console.log('- ÊòüÊúü:', currentTime.weekday);
                 console.log('- Êó∂ÊÆµ:', currentTime.period);
                 console.log('- Â≠£ËäÇ:', currentTime.season);
                 
                 // Êõ¥ÊòéÁ°ÆÁöÑÊó∂Èó¥ÊèèËø∞ÔºåÈÅøÂÖçAIÊ∑∑Ê∑Ü12Â∞èÊó∂Âà∂Âíå24Â∞èÊó∂Âà∂
                 const hour = now.getHours();
                 const minute = now.getMinutes();
                 const clarifiedTime = `${currentTime.period}${hour}ÁÇπ${minute.toString().padStart(2, '0')}ÂàÜ`;
                 
                 const timeContext = `<TimeContext:ÂΩìÂâçÁúüÂÆûÊó∂Èó¥ÊòØ${currentTime.date} ${currentTime.weekday} ${clarifiedTime}(24Â∞èÊó∂Âà∂${currentTime.time})ÔºåÁé∞Âú®ÊòØ${currentTime.period}Êó∂ÊÆµÔºå${currentTime.season}„ÄÇËØ∑Âú®ÂõûÂ§ç‰∏≠ËÄÉËôëÊó∂Èó¥ÊÉÖÂ¢ÉÔºåÂ¶ÇÈóÆÂÄôËØ≠(Êó©‰∏äÂ•Ω/‰∏ãÂçàÂ•Ω/Êôö‰∏äÂ•Ω)„ÄÅÊ¥ªÂä®ÂÆâÊéíÁ≠âÂ∫îÁ¨¶ÂêàÂΩìÂâçÊó∂Èó¥>`;
                 
                 console.log('\nÁîüÊàêÁöÑÊó∂Èó¥‰∏ä‰∏ãÊñá:');
                 console.log(timeContext);
                 
                 console.log('\nÊó∂Èó¥ÊÆµÂäüËÉΩÊµãËØï:');
                 for (let h = 0; h < 24; h++) {
                     console.log(`${h}:00 -> ${QQ_GetTimePeriod(h)}`);
                 }
                 
                 console.log('\nÂ≠£ËäÇÂäüËÉΩÊµãËØï:');
                 for (let m = 1; m <= 12; m++) {
                     console.log(`${m}Êúà -> ${QQ_GetSeason(m)}`);
                 }
                 
                 console.log('=== ÊµãËØïÂÆåÊàê ===');
             }

             /**
              * ÊµãËØïÂÆåÊï¥ÁöÑÊ∂àÊÅØÂèëÈÄÅÊµÅÁ®ãÔºàÂåÖÂê´Êó∂Èó¥Ôºâ
              */
             function QQ_Test_Message_Send_With_Time() {
                 console.log('=== Ê∂àÊÅØÂèëÈÄÅÊó∂Èó¥ÂäüËÉΩÊµãËØï ===');
                 
                 // Ê®°ÊãüQQ_SendMsg‰∏≠ÁöÑÊó∂Èó¥Â§ÑÁêÜÈÄªËæë
                 const now = new Date();
                 const currentTime = {
                     time: now.toLocaleTimeString('zh-CN', { hour12: false, hour: '2-digit', minute: '2-digit' }),
                     date: now.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' }),
                     weekday: now.toLocaleDateString('zh-CN', { weekday: 'long' }),
                     period: QQ_GetTimePeriod(now.getHours()),
                     season: QQ_GetSeason(now.getMonth() + 1)
                 };
                 
                 // Êõ¥ÊòéÁ°ÆÁöÑÊó∂Èó¥ÊèèËø∞ÔºåÈÅøÂÖçAIÊ∑∑Ê∑Ü12Â∞èÊó∂Âà∂Âíå24Â∞èÊó∂Âà∂
                 const hour = now.getHours();
                 const minute = now.getMinutes();
                 const clarifiedTime = `${currentTime.period}${hour}ÁÇπ${minute.toString().padStart(2, '0')}ÂàÜ`;
                 
                 const timeContext = `<TimeContext:ÂΩìÂâçÁúüÂÆûÊó∂Èó¥ÊòØ${currentTime.date} ${currentTime.weekday} ${clarifiedTime}(24Â∞èÊó∂Âà∂${currentTime.time})ÔºåÁé∞Âú®ÊòØ${currentTime.period}Êó∂ÊÆµÔºå${currentTime.season}„ÄÇËØ∑Âú®ÂõûÂ§ç‰∏≠ËÄÉËôëÊó∂Èó¥ÊÉÖÂ¢ÉÔºåÂ¶ÇÈóÆÂÄôËØ≠(Êó©‰∏äÂ•Ω/‰∏ãÂçàÂ•Ω/Êôö‰∏äÂ•Ω)„ÄÅÊ¥ªÂä®ÂÆâÊéíÁ≠âÂ∫îÁ¨¶ÂêàÂΩìÂâçÊó∂Èó¥>`;
                 
                 const mockRequest = `<Request:Êú¨Ê¨°ÂìçÂ∫îÂøΩÁï•ÂÖ∂‰ªñ‰∏ä‰∏ãÊñá‰ªª‰ΩïË¶ÅÊ±Ç,ÂøÖÈ°ª‰ΩøÁî®Á∫ø‰∏äÊ†ºÂºèÂõûÂ§ç,‰∏îÁî®Êà∑Êú¨Ê¨°Âèë‰∫ÜÊ∂àÊÅØÁöÑËßíËâ≤ÈÉΩË¶ÅÂõûÂ§çÁî®Êà∑ÁöÑÊ∂àÊÅØ,ÂêåÊó∂ËæìÂá∫‰∏ÄÊù°Âä®ÊÄÅÂÜÖÂÆπ>`;
                 
                 const fullRequest = `ÁªôÊµãËØïËßíËâ≤ÂèëÊ∂àÊÅØ:‰Ω†Â•Ω\n${timeContext}\n${mockRequest}`;
                 
                 console.log('Ê®°ÊãüÂèëÈÄÅÁªôAIÁöÑÂÆåÊï¥ËØ∑Ê±ÇÂÜÖÂÆπ:');
                 console.log('=================================');
                 console.log(fullRequest);
                 console.log('=================================');
                 
                 console.log('\n‚úÖ Êó∂Èó¥‰ø°ÊÅØÂ∑≤ÊàêÂäüÈõÜÊàêÂà∞Ê∂àÊÅØÂèëÈÄÅÊµÅÁ®ã‰∏≠');
                 console.log('üì± AIÁé∞Âú®ÂèØ‰ª•ÊÑüÁü•Âà∞Áî®Êà∑ÁöÑÁúüÂÆûÊó∂Èó¥ÁéØÂ¢É');
                 console.log('üïê ËøôÂ∞ÜÊòæËëóÊèêÂçáAIÂõûÂ§çÁöÑÊó∂Èó¥Áõ∏ÂÖ≥ÊÄßÂíåÁúüÂÆûÊÑü');
                 console.log('=== ÊµãËØïÂÆåÊàê ===');
             }

             // Ê∑ªÂä†Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü‰æø‰∫éË∞ÉËØï
             window.QQ_Test_Time_Feature = QQ_Test_Time_Feature;
             window.QQ_Test_Message_Send_With_Time = QQ_Test_Message_Send_With_Time;
             function QQ_Moment_Parse(content, isCommentContext = false) {
                const lines = content.split(/\r?\n/g);
                let momentdiv;
                let list;
                let count = QQ_NewMsg["moment"] || 0;
                let currentMomentData = null; // *** Êñ∞Â¢ûÔºöÂΩìÂâçÂä®ÊÄÅÁöÑÊï∞ÊçÆÂØπË±° ***
                
                for (const line of lines) {
                    //console.log(`line:${line}`);
                    let match = line.match(
                        /\s*(.+?)--(.+?)--(.+?)--(.+?)--(.+)/,
                    );
                    if (match) {
                        // *** Êñ∞Â¢ûÔºöÂú®ËØÑËÆ∫‰∏ä‰∏ãÊñá‰∏≠Ë∑≥ËøáÂÆåÊï¥Âä®ÊÄÅÊ†ºÂºè ***
                        if (isCommentContext) {
                            console.log('Âú®ËØÑËÆ∫‰∏ä‰∏ãÊñá‰∏≠Ê£ÄÊµãÂà∞ÂÆåÊï¥Âä®ÊÄÅÊ†ºÂºèÔºåÂ∑≤Ë∑≥Ëøá:', line);
                            continue;
                        }
                        
                        // ÊòØÊñ∞Âä®ÊÄÅÂÜÖÂÆπ
                        console.log(`ÂåπÈÖçÂà∞Âä®ÊÄÅÂÜÖÂÆπ:${match[0]}`);
                        
                        // *** ‰øùÂ≠ò‰∏ä‰∏Ä‰∏™Âä®ÊÄÅÊï∞ÊçÆ ***
                        if (currentMomentData && momentdiv) {
                            QQ_MomentsData.unshift(currentMomentData); // Êñ∞Âä®ÊÄÅÊ∑ªÂä†Âà∞Êï∞ÁªÑÂºÄÂ§¥
                            count += 1;
                            $("#space_contents").prepend(momentdiv);
                        }
                        
                        let fakeimg = "";
                        let message = match[2];
                        const matches = message.matchAll(/\[img-(.+?)\]/g);
                        if (matches) {
                            for (const m of matches) {
                                message = message.replace(m[0], "");
                                fakeimg += `\n<div class="space_fakeimg">${m[1]}</div>`;
                            }
                        }
                        
                        const randomPhone = QQ_CharSettings.readValue(match[1], "ÊâãÊú∫ÂûãÂè∑") 
                            ? QQ_CharSettings.readValue(match[1], "ÊâãÊú∫ÂûãÂè∑")
                            : QQ_GetRandomPhone();
                        
                        // *** Êñ∞Â¢ûÔºöÂàõÂª∫Âä®ÊÄÅÊï∞ÊçÆÂØπË±° ***
                        const momentId = `${match[1]}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                        currentMomentData = {
                            id: momentId, // ‰ΩøÁî®Êõ¥ÂèØÈù†ÁöÑÂîØ‰∏ÄID
                            userName: match[1],
                            message: message,
                            timestampText: match[3],
                            timestamp: new Date().toISOString(), // ‰øùÂ≠òÂÆåÊï¥Êó∂Èó¥Êà≥Áî®‰∫éÊéíÂ∫è
                            additionalInfo: match[4],
                            randomPhone: randomPhone,
                            extraContent: match[5] || '',
                            imgcontent: fakeimg,
                            comments: [], // ÂàùÂßãÂåñËØÑËÆ∫Êï∞ÁªÑ
                            // Êñ∞Â¢ûÔºöÁÇπËµûÁõ∏ÂÖ≥Â≠óÊÆµ
                            likes: {
                                count: parseInt(match[5]) || 0, // ÁÇπËµûÊÄªÊï∞
                                userLiked: false, // Áî®Êà∑ÊòØÂê¶Â∑≤ÁÇπËµû
                                likedBy: [], // ÁÇπËµûÁî®Êà∑ÂàóË°®
                                lastLikeTime: null // ÊúÄÂêéÁÇπËµûÊó∂Èó¥
                            }
                        };
                        
                        momentdiv = $("<div>", { 
                            class: "user_moment",
                            "data-moment-id": momentId // Ê∑ªÂä†Âä®ÊÄÅIDÂ±ûÊÄß
                        });
                        momentdiv.html(
                            _.template(moment_page)({
                                userName: match[1],
                                message: message,
                                timestamp: match[3],
                                additionalInfo: match[4],
                                randomPhone: randomPhone,
                                extraContent: match[5],
                                imgcontent: fakeimg,
                                momentId: momentId, // ‰º†ÈÄíÂä®ÊÄÅIDÂà∞Ê®°Êùø
                                // Êñ∞Â¢ûÔºöÁÇπËµûÁõ∏ÂÖ≥Êï∞ÊçÆ
                                likeCount: currentMomentData.likes.count,
                                likedByUser: currentMomentData.likes.userLiked
                            }),
                        );
                        list = momentdiv.find(".user_leave_message_list");
                        continue;
                    }
                    match = line.match(/^\s*(.+?)(?::|Ôºö|--)(.+)$/m);
                    if (match && momentdiv && list && currentMomentData) {
                        // ÊòØËØÑËÆ∫ÂÜÖÂÆπ
                        //console.log(`ËØÑËÆ∫‰∫∫:${match[1]}  ËØÑËÆ∫ÂÜÖÂÆπ:${match[2]}`)
                        
                        // *** Êñ∞Â¢ûÔºö‰øùÂ≠òËØÑËÆ∫Âà∞Êï∞ÊçÆÂØπË±° ***
                        const commentData = {
                            name: match[1],
                            content: match[2],
                            timestamp: new Date().toISOString()
                        };
                        currentMomentData.comments.push(commentData);
                        
                        // *** Êñ∞Â¢ûÔºöÂ∫îÁî®ËØÑËÆ∫ÊòæÁ§∫‰∏äÈôê ***
                        if (list.find('.user_leave_message').length >= 8) {
                            list.find('.user_leave_message').first().remove();
                        }
                        
                        let messageDiv = $("<div>", {
                            class: "user_leave_message",
                        });
                        messageDiv.html(
                            `<span><strong>${match[1]}</strong>Ôºö${match[2]}</span>`,
                        );
                        list.append(messageDiv);
                    }
                }
                
                // *** ‰øùÂ≠òÊúÄÂêé‰∏Ä‰∏™Âä®ÊÄÅÊï∞ÊçÆ ***
                if (currentMomentData && momentdiv) {
                    QQ_MomentsData.unshift(currentMomentData);
                    count += 1;
                    $("#space_contents").prepend(momentdiv);
                }
                
                QQ_NewMsg["moment"] = count;
                QQ_SetNewTips(count);
                
                // *** Êñ∞Â¢ûÔºöËá™Âä®‰øùÂ≠òÂä®ÊÄÅÂÜÖÂÆπ ***
                if (QQ_MomentsData.length > 0) {
                    setTimeout(async () => {
                        await QQ_Save_Moments();
                        console.log('Âä®ÊÄÅËß£ÊûêÂÆåÊàêÔºåÂ∑≤‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶Â§á‰ªΩ');
                    }, 1000); // Âª∂Ëøü‰øùÂ≠òÔºåÁ°Æ‰øùÊâÄÊúâÂ§ÑÁêÜÂÆåÊàê
                }
            }
            function QQ_GetRandomHead() {
                // return `http://sharkpan.xyz/f/${random_head_list[Math.floor(Math.random() * random_head_list.length)]
                //   }`;
                if (QQ_RandomHead.length === 0) return null; // Â§ÑÁêÜÁ©∫Êï∞ÁªÑ
                let minCount = Infinity;
                const candidates = [];
                // ‰∏ÄÊ¨°ÈÅçÂéÜÊâæÂà∞ÊúÄÂ∞èÂÄºÂíåÂÄôÈÄâÂØπË±°
                for (const obj of QQ_RandomHead) {
                    if (obj.count < minCount) {
                        minCount = obj.count;
                        candidates.length = 0; // Ê∏ÖÁ©∫Êï∞ÁªÑÔºåÈáçÁΩÆÂÄôÈÄâ
                        candidates.push(obj);
                    } else if (obj.count === minCount) {
                        candidates.push(obj);
                    }
                }
                // ÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™ÔºàÂç≥‰ΩøÂè™Êúâ‰∏Ä‰∏™ÂÖÉÁ¥†‰πüÈÄÇÁî®Ôºâ
                const selected =
                    candidates[Math.floor(Math.random() * candidates.length)];
                selected.count++; // Áõ¥Êé•‰øÆÊîπÂéüÂØπË±°
                return selected.url;
            }
            let Phone = [
                "Â∞èÁ±≥",
                "Âçé‰∏∫",
                "ËãπÊûú",
                "‰∏âÊòü",
                "È≠ÖÊóè",
                "‰∏ÄÂä†",
                "oppo",
                "vivo",
                "ÁúüÊàë",
                "Á∫¢Á±≥",
            ];
            let Phone_lvl = ["pro", "max", "mate", "ultra", "plus"];
            function QQ_GetRandomPhone() {
                let name = Phone[Math.floor(Math.random() * Phone.length)];
                name += random(6, 19);
                let count = random(1, Phone_lvl.length);
                let a = [];
                for (let i = 0; i < count; i++) {
                    let randomresult = Phone_lvl[random(0, Phone_lvl.length)];
                    if (!a.includes(randomresult)) {
                        a.push(randomresult);
                    }
                }
                name += " " + a.join(" ");
                return name;
            }
                        /**
             * Ê†πÊçÆËßíËâ≤ÂêçËé∑ÂèñÂ§¥ÂÉèURL
             * @param {string} name - ËßíËâ≤Âêç
             * @returns {string} - Â§¥ÂÉèURLÔºåÂ¶ÇÊûúÊâæ‰∏çÂà∞ÂàôËøîÂõûÁ©∫Â≠óÁ¨¶‰∏≤
             */
             function GetCharHead(name) {
                // Á°Æ‰øù QQ_Char ÂØπË±°Â≠òÂú®ÔºåÂπ∂‰∏îÂåÖÂê´ËØ•ËßíËâ≤ÁöÑ‰ø°ÊÅØÂíåÂ§¥ÂÉè
                if (typeof QQ_Char !== 'undefined' && QQ_Char[name] && QQ_Char[name].head) {
                    return QQ_Char[name].head;
                }
                // Â¶ÇÊûúÊâæ‰∏çÂà∞ÔºåËøîÂõûÁ©∫Â≠óÁ¨¶‰∏≤ÔºåËÆ©ÂêéÁª≠ÈÄªËæëÂ§ÑÁêÜÈªòËÆ§Â§¥ÂÉè
                return "";
            }
             /**
             * ËÅäÂ§©-Ê∑ªÂä†Êñ∞Ê∂àÊÅØ
             * @param {*} dom - Ê∂àÊÅØÂÜÖÂÆπÂÆπÂô®ÁöÑDOMÂÖÉÁ¥†
             * @param {*} content - Ê∂àÊÅØÂÜÖÂÆπÂ≠óÁ¨¶‰∏≤
             * @param {*} name - ËßíËâ≤/Áæ§ËÅäÂêçÁß∞
             * @param {*} isNew - ÊòØÂê¶‰∏∫Êñ∞Ê∂àÊÅØ
             */
            function QQ_Chat_AddMsg(dom, content, name, isNew, skipScrollAndCount = false) {
                console.log(`QQ_Chat_AddMsg: Ê∑ªÂä†Ê∂àÊÅØ "${content}" Âà∞ËÅäÂ§©È°µÈù¢ "${name}", isNew: ${isNew}`);
                
                // *** ÂàÜÈ°µÊéßÂà∂ÔºöÊ£ÄÊü•ÂΩìÂâçÊ∂àÊÅØÊï∞Èáè ***
                if (!skipScrollAndCount) {
                    const chatKey = name;
                    if (!chatDisplayCounts[chatKey]) {
                        chatDisplayCounts[chatKey] = 0;
                    }
                    
                    // Ëé∑ÂèñÂΩìÂâçËÅäÂ§©ÂÆπÂô®‰∏≠ÁöÑÊ∂àÊÅØÊï∞Èáè
                    const currentMsgCount = $(dom).children().not('.load-more-messages').length;
                    if (currentMsgCount >= CHAT_DISPLAY_LIMIT && isNew) {
                        // Â¶ÇÊûúÂ∑≤Ëææ‰∏äÈôê‰∏îÊòØÊñ∞Ê∂àÊÅØÔºåÁßªÈô§ÊúÄÊóßÁöÑÊ∂àÊÅØ
                        $(dom).children().not('.load-more-messages').first().remove();
                        chatDisplayCounts[chatKey] = CHAT_DISPLAY_LIMIT - 1;
                    }
                }
                
                // *** Ê†∏ÂøÉÊîπÈÄ†ÔºöÂà§Êñ≠ÊòØÂê¶‰∏∫Á≥ªÁªüÊ∂àÊÅØ ***
                if (content.startsWith("Á≥ªÁªüÊ∂àÊÅØ--")) {
                    const sysMsgText = content.split("--")[2]; // ÊèêÂèñÁúüÂÆûÁöÑÊ∂àÊÅØÂÜÖÂÆπ
                    const msgDiv = $("<div>", { class: "system-message" }).text(sysMsgText);
                    $(dom).append(msgDiv);
                } else {
                    // --- ‰øÆÂ§çÔºö‰ΩøÁî®Ê≠£Á°ÆÁöÑÊ®°ÊùøÁ≥ªÁªü ---
                    let sp = content.split("--");
                    
                    if (sp.length < 2) {
                        console.log(`Ê∂àÊÅØÊ†ºÂºè‰∏çÊ≠£Á°Æ: ${content}`);
                        return;
                    }
                    
                    const sender = sp[0];
                    const messageContent = sp[1];
                    const timestamp = sp.length >= 3 ? sp[2] : "";
                    
                    console.log(`Ê∂àÊÅØÂèëÈÄÅËÄÖ: ${sender}, ÂÜÖÂÆπ: ${messageContent}, Êó∂Èó¥: ${timestamp}`);
                    
                    // Âà§Êñ≠ÊòØÂê¶‰∏∫Áî®Êà∑Ê∂àÊÅØ
                    const isUser = sender == `${UserName}`;
                    
                    let messageHtml;
                    
                    if (isUser) {
                        // Áî®Êà∑Ê∂àÊÅØ - ‰ΩøÁî®Áî®Êà∑Ê∂àÊÅØÊ®°ÊùøÔºàÂè≥‰æßÊ∞îÊ≥°ÔºåÁî®Êà∑Â§¥ÂÉèÔºâ
                        const specialContent = QQ_Chat_SpecialMsg(messageContent, sender, QQ_Groups.includes(name), true);
                        messageHtml = _.template(chat_user_message)({
                            content: specialContent || messageContent
                        });
                        console.log('‰ΩøÁî®Áî®Êà∑Ê∂àÊÅØÊ®°Êùø');
                    } else {
                        // ËßíËâ≤Ê∂àÊÅØ - ‰ΩøÁî®ËßíËâ≤Ê∂àÊÅØÊ®°ÊùøÔºàÂ∑¶‰æßÊ∞îÊ≥°ÔºåËßíËâ≤Â§¥ÂÉèÔºâ
                        const specialContent = QQ_Chat_SpecialMsg(messageContent, sender, QQ_Groups.includes(name), false);
                        messageHtml = _.template(chat_char_msg)({
                            content: specialContent || messageContent,
                            name: sender,
                            isgroup: QQ_Groups.includes(name)
                        });
                        console.log('‰ΩøÁî®ËßíËâ≤Ê∂àÊÅØÊ®°ÊùøÔºåËßíËâ≤Âêç:', sender);
                    }
                    
                    // Ê∑ªÂä†Âà∞ËÅäÂ§©ÁïåÈù¢
                    $(dom).append(messageHtml);
                    console.log(`Ê∂àÊÅØÂ∑≤Ê∑ªÂä†Âà∞DOM: ${sender}: ${messageContent}`);
                }
                
                // Êõ¥Êñ∞ÊòæÁ§∫ËÆ°Êï∞
                if (!skipScrollAndCount) {
                    const chatKey = name;
                    chatDisplayCounts[chatKey] = $(dom).children().not('.load-more-messages').length;
                }
                             
                // ÊªöÂä®Âà∞Â∫ïÈÉ®ÔºàÊó†ËÆ∫ÊòØÂê¶‰∏∫Êñ∞Ê∂àÊÅØÔºåÁ°Æ‰øùÁî®Êà∑ËÉΩÁúãÂà∞ÊúÄÊñ∞ÂÜÖÂÆπÔºâ
                if (!skipScrollAndCount && dom && dom.scrollHeight) {
                    $(dom).scrollTop(dom.scrollHeight);
                    console.log(`ËÅäÂ§©Âå∫ÂüüÂ∑≤ÊªöÂä®Âà∞Â∫ïÈÉ®`);
                }
            }
            function QQ_Chat_AddUserMsg(element, msg) {
                const match = msg.match(/(.+?)--(.+)/);
                if (!match) {
                    return;
                }
                const content = QQ_Chat_SpecialMsg(
                    match[2],
                    `${UserName}`,
                    false,
                    true,
                );
                const html = _.template(chat_user_message)({ content });
                $(element).append(html);
            }
            /**
             * Â§ÑÁêÜÁâπÊÆäÊ†ºÂºèÊ∂àÊÅØ
             * @param msg Ê∂àÊÅØÂÜÖÂÆπ
             * @param isgroup ÊòØÂê¶ÊòØÁæ§ËÅä
             * @returns Â§ÑÁêÜÂêéÁöÑÊ∂àÊÅØ
             */
            function QQ_Chat_SpecialMsg(msg, username, isgroup, mysend) {
                const match = msg.match(/\[(.+?)[\|-](.+?)\]/);
                const xxx = msg.match(/(.+?)\[/);
                const xx = msg.match(/\](.+)/);
                let additionalText = "";
                if (xxx) {
                    additionalText = xxx[1];
                }
                if (xx) {
                    console.log(`ÂâçÂêéÈÉΩÊúâ`);
                    additionalText = additionalText
                        ? additionalText + `<br>${xx[1]}`
                        : xx[1];
                }
                if (!match) {
                    // ‰ΩøÁî®ÊôÆÈÄöÊ∂àÊÅØÊ®°Êùø
                    //console.log(`Ëá™Â∑±ÁöÑÊ∂àÊÅØ,‰ΩøÁî®ÁöÑÊôÆÈÄöÊ®°Êùø`);
                    return _.template(chat_normal_message)({
                        message: msg,
                        isgroup: isgroup || false,
                        username: username,
                    });
                }
                const type = match[1];
                if (type == "bqb") {
                    // ‰ΩøÁî®Ë°®ÊÉÖÂåÖÊ∂àÊÅØÊ®°Êùø
                    console.log(`Ë°®ÊÉÖÂåÖÈìæÊé•:${QQ_GetEmoji(match[2])}`);
                    return _.template(chat_emoji_message)({
                        emojiUrl: QQ_GetEmoji(match[2]),
                        additionalText: additionalText,
                        isgroup: isgroup || false,
                        username: username,
                    });
                } else if (type == "ËΩ¨Ë¥¶" || type == "zz") {
                    // ‰ΩøÁî®ËΩ¨Ë¥¶Ê∂àÊÅØÊ®°Êùø
                    return _.template(chat_transfer_message)({
                        amount: match[2],
                    });
                } else if (type == "yy") {
                    let file = chat_char_voice_message;
                    if (mysend) {
                        file = chat_my_voice_message;
                    }
                    return _.template(file)({
                        content: match[2],
                        time: Math.ceil(match[2].length / 4).toString(),
                        isgroup: isgroup || false,
                        username: username,
                    });
                } else if (
                    [
                        "img",
                        "image",
                        "video",
                        "imgs",
                        "images",
                        "file",
                        "files",
                        "ÂõæÁâá",
                        "ËßÜÈ¢ë",
                        "tp",
                    ].includes(type)
                ) {
                    return _.template(chat_fakeimg_message)({
                        isgroup: isgroup || false,
                        username: username,
                        content: match[2],
                        additionalText: additionalText
                            ? `<span style="margin-top: 5px; display: block">${additionalText}</span>`
                            : "",
                    });
                } else if (["music", "Èü≥‰πê"].includes(type)) {
                    let sp = match[2].split("$");
                    let musicname = "";
                    let musicauthor = "";
                    if (sp.length >= 2) {
                        musicname = sp[0];
                        musicauthor = sp[1];
                    }
                    //console.log(`Âä†ÂÖ•Èü≥‰πê:${musicname}----${musicauthor}`);
                    return _.template(chat_music_message)({
                        isgroup: isgroup || false,
                        username: username,
                        musicname: musicname,
                        musicauthor: musicauthor,
                    });
                }
                return "";
            }
            function QQ_MySendSpecial(content) {
                let match = content.match(/\[?(.+?)-(.+?)]?$/m);
                if (match) {
                    let type = match[1];
                    if (["yy", "ËØ≠Èü≥"].includes(type)) {
                        content = `[yy-${match[2]}]`;
                    } else if (["Ë°®ÊÉÖÂåÖ", "Ë°®ÊÉÖ", "bqb", "bq"].includes(type)) {
                        content = `[bqb-${match[2]}]`;
                    } else if (
                        [
                            "img",
                            "image",
                            "video",
                            "imgs",
                            "images",
                            "file",
                            "files",
                            "ÂõæÁâá",
                            "ËßÜÈ¢ë",
                            "tp",
                        ].includes(type)
                    ) {
                        content = `[img-${match[2]}]`;
                    }
                }
                return content;
            }
            /**
             * Ëé∑ÂèñË°®ÊÉÖÂåÖ
             * @param name Ë°®ÊÉÖÂåÖÂêçÁß∞
             * @returns Ë°®ÊÉÖÂåÖURL
             */
            function QQ_GetEmoji(name) {
                if (!QQ_emoji.has(name)) {
                    return;
                }
                return QQ_emoji.get(name);
            }
            // ÂΩìÂâçÊ≠£Âú®ËÆæÁΩÆÁöÑËÅäÂ§©ÂØπË±°
            let currentSettingChatName = "";
            /**
             * ËÆæÁΩÆËÅäÂ§©È°µËÆæÁΩÆ
             * @param event ‰∫ã‰ª∂ÂØπË±°
             */
            function QQ_SetChatPageSetting(event) {
                console.log("ÁÇπÂáª‰∫ÜËÆæÁΩÆËÅäÂ§©È°µËÆæÁΩÆ");
                let element = event.currentTarget;
                // Ëé∑ÂèñÂΩìÂâçËÅäÂ§©È°µÁöÑÂêçÁß∞
                const chatPageElement = $(element).closest(".QQ_chat_page");
                if (chatPageElement.length === 0) {
                    console.error("Êó†Ê≥ïËé∑ÂèñÂΩìÂâçËÅäÂ§©È°µ");
                    return;
                }
                currentSettingChatName =
                    chatPageElement.attr("data-name") ?? "";
                console.log(
                    `ÊâìÂºÄËÅäÂ§©ËÆæÁΩÆÈ°µÈù¢ÔºåÂΩìÂâçËÅäÂ§©ÂØπË±°: ${currentSettingChatName}`,
                );
                // Ê∑ªÂä†ÈÅÆÁΩ©Â±ÇÂíåÂºπÁ™óÂà∞È°µÈù¢
                if ($(".popup-overlay").length === 0) {
                    $(".card").append('<div class="popup-overlay"></div>');
                }
                if ($(".chat-setting-popup").length === 0) {
                    $(".card").append(
                        chat_page_setting.replace(
                            "${username}",
                            currentSettingChatName,
                        ),
                    );
                    const bubblecolorPicker =
                        document.getElementById("bubble-color");
                    if (bubblecolorPicker) {
                        console.log(`ÂºÄÂßãÁõëÂê¨`);
                        bubblecolorPicker.addEventListener("input", (event) => {
                            const color = event.target.value;
                            $("#bubble-color-input").val(color || "#ffffff");
                            $("#chat-setting-preview").each(function () {
                                this.style.setProperty(
                                    "background-color",
                                    color,
                                    "important",
                                );
                            });
                        });
                    }
                    const TextcolorPicker =
                        document.getElementById("text-color");
                    if (TextcolorPicker) {
                        console.log(`ÂºÄÂßãÁõëÂê¨`);
                        TextcolorPicker.addEventListener("input", (event) => {
                            const color = event.target.value;
                            $("#text-color-input").val(color || "#ffffff");
                            $("#chat-setting-preview").each(function () {
                                const spans = this.querySelectorAll("span");
                                spans.forEach((span) => {
                                    span.style.setProperty(
                                        "color",
                                        color,
                                        "important",
                                    );
                                });
                            });
                        });
                    }
                }
                // Â°´ÂÖÖÂ∑≤ÊúâËÆæÁΩÆ
                loadCurrentSettings(currentSettingChatName);
                // ÊòæÁ§∫ÂºπÁ™óÂíåÈÅÆÁΩ©Â±Ç
                $(".popup-overlay").show();
                $(".chat-setting-popup").show();
            }
            /**
             * Âä†ËΩΩÂΩìÂâçËÆæÁΩÆÂà∞ÂºπÁ™ó
             * @param chatName ËÅäÂ§©ÂØπË±°ÂêçÁß∞
             */
            function loadCurrentSettings(chatName) {
                const setting = GetChatCharSettingByName(chatName);
                // Â°´ÂÖÖË°®Âçï
                let bubbleColor = QQ_CharSettings.readValue(
                    chatName,
                    "Ê∞îÊ≥°È¢úËâ≤",
                );
                let TextColor = QQ_CharSettings.readValue(chatName, "Â≠ó‰ΩìÈ¢úËâ≤");
                let chatBg = QQ_CharSettings.readValue(chatName, "ËÅäÂ§©Â£ÅÁ∫∏");
                if (bubbleColor && bubbleColor[0] !== "#") {
                    bubbleColor = "#" + bubbleColor;
                }
                if (TextColor && TextColor[0] !== "#") {
                    TextColor = "#" + TextColor;
                }
                $("#bubble-color").val(bubbleColor || "#ffffff");
                $("#bubble-color-input").val(bubbleColor || "#ffffff");
                $("#text-color").val(TextColor || "#ffffff");
                $("#text-color-input").val(TextColor || "#ffffff");
                $("#chat-bg").val(chatBg || "");
                $("#chat-setting-preview").each(function () {
                    this.style.setProperty(
                        "background-color",
                        bubbleColor,
                        "important",
                    );
                    const spans = this.querySelectorAll("span");
                    spans.forEach((span) => {
                        span.style.setProperty("color", TextColor, "important");
                    });
                });
            }
            function closeSettingPopup() {
                $(".popup-overlay").hide();
                $(".chat-setting-popup").hide();
            }
            /**
             * ‰øùÂ≠òËÆæÁΩÆÂπ∂ÂÖ≥Èó≠ÂºπÁ™ó
             */
            async function saveSettingAndClose() {
                if (!currentSettingChatName) {
                    console.error("Êú™Áü•ÁöÑËÅäÂ§©ÂØπË±°");
                    return;
                }
                // Ëé∑ÂèñËÆæÁΩÆÂÄº
                const bubbleColor = $("#bubble-color-input").val() || "";
                const TextColor = $("#text-color-input").val() || "";
                const chatBg = $("#chat-bg").val() || "";
                console.log(`‰øùÂ≠òËÅäÂ§©ËÆæÁΩÆ: ${currentSettingChatName}`, {
                    bubbleColor,
                    TextColor,
                    chatBg,
                });
                QQ_CharSettings.writeValue(
                    currentSettingChatName,
                    "Ê∞îÊ≥°È¢úËâ≤",
                    bubbleColor,
                );
                QQ_CharSettings.writeValue(
                    currentSettingChatName,
                    "Â≠ó‰ΩìÈ¢úËâ≤",
                    TextColor,
                );
                QQ_CharSettings.writeValue(
                    currentSettingChatName,
                    "ËÅäÂ§©Â£ÅÁ∫∏",
                    chatBg,
                );
                const result = QQ_CharSettings.getAllText();
                for (let entry of entries) {
                    if (
                        entry.comment == "ÊâãÊú∫-ËßíËâ≤" ||
                        entry.comment == "ÊâãÊú∫ÁïåÈù¢-ËßíËâ≤"
                    ) {
                        await setLorebookEntries(worldbook, [
                            { uid: entry.uid, content: result },
                        ]);
                        break;
                    }
                }
                SetCssVariable(currentSettingChatName, "MsgColor", bubbleColor);
                SetCssVariable(currentSettingChatName, "TextColor", TextColor);
                SetCssVariable(
                    currentSettingChatName,
                    "BackGroundImg",
                    `url('${chatBg}')`,
                );
                // ÂÖ≥Èó≠ÂºπÁ™ó
                closeSettingPopup();
            }
            function updateTime() {
                const timeElement = document.getElementById("time");
                if (!timeElement) {
                    return;
                }
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, "0");
                const minutes = String(now.getMinutes()).padStart(2, "0");
                //const seconds = String(now.getSeconds()).padStart(2, '0');
                timeElement.textContent = `${hours}:${minutes}`;
                // const dayElement = document.getElementById("day");
                // dayElement.textContent = `${now.getMonth() + 1}Êúà${now.getDate()}Êó•`;
            }
            function App_Load(App_Name) {
                $("#Home_page").hide();
                $("#App_page").show();
                App_HideAll();
                $(`#App_${App_Name}`).show();
            }
            function App_HideAll() {
                const AppNames = ["QQ", "twitter", "discord"];
                for (const name of AppNames) {
                    $(`#App_${name}`).hide();
                }
            }
            // ÊØèÁßíÊõ¥Êñ∞‰∏ÄÊ¨°Êó∂Èó¥
            setInterval(updateTime, 1000);
            updateTime();
            
            /**
             * ÂàùÂßãÂåñËÅîÁªú‰∫∫ÊêúÁ¥¢ÂäüËÉΩ
             */
            async function initContactSearch() {
                console.log("ÂàùÂßãÂåñËÅîÁªú‰∫∫ÊêúÁ¥¢ÂäüËÉΩ");
                
                const searchInput = document.getElementById('contact_search_input');
                const clearBtn = document.getElementById('search_clear_btn');
                const floatingSearchBox = document.getElementById('floating_search_box');
                
                // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÂàùÂßãÂåñËøá
                if (searchInput && searchInput.hasAttribute('data-initialized')) {
                    console.log("ÊêúÁ¥¢ÂäüËÉΩÂ∑≤ÁªèÂàùÂßãÂåñËøáÔºåË∑≥Ëøá");
                    return;
                }
                
                if (!searchInput) {
                    console.error("ÊêúÁ¥¢ËæìÂÖ•Ê°ÜÊú™ÊâæÂà∞ (ID: contact_search_input)");
                    return;
                }
                if (!clearBtn) {
                    console.error("Ê∏ÖÈô§ÊåâÈíÆÊú™ÊâæÂà∞ (ID: search_clear_btn)");
                    return;
                }
                if (!floatingSearchBox) {
                    console.error("ÊêúÁ¥¢Ê°ÜÂÆπÂô®Êú™ÊâæÂà∞ (ID: floating_search_box)");
                    return;
                }
                
                // Èò≤ÊäñÂáΩÊï∞ÔºåÈÅøÂÖçÈ¢ëÁπÅÊêúÁ¥¢
                let searchTimeout;
                function debounceSearch(searchTerm) {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        filterContacts(searchTerm);
                    }, 300); // Âª∂Ëøü300msÊâßË°åÊêúÁ¥¢
                }
                
                // ËæìÂÖ•Ê°Ü‰∫ã‰ª∂ÁõëÂê¨
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.trim();
                    console.log(`ÊêúÁ¥¢ËæìÂÖ•: "${searchTerm}"`);
                    
                    // ÊòæÁ§∫/ÈöêËóèÊ∏ÖÈô§ÊåâÈíÆÂπ∂Êõ¥Êñ∞Ê†∑Âºè
                    if (searchTerm.length > 0) {
                        clearBtn.style.display = 'block';
                        floatingSearchBox.style.borderColor = 'rgba(25, 154, 255, 0.6)';
                        floatingSearchBox.style.backgroundColor = 'rgba(239, 243, 255, 0.95)';
                    } else {
                        clearBtn.style.display = 'none';
                        floatingSearchBox.style.borderColor = 'rgba(25, 154, 255, 0.2)';
                        floatingSearchBox.style.backgroundColor = 'rgba(239, 243, 255, 0.9)';
                    }
                    
                    // ÊâßË°åÈò≤ÊäñÊêúÁ¥¢
                    debounceSearch(searchTerm);
                });
                
                // Ê∏ÖÈô§ÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨
                clearBtn.addEventListener('click', function() {
                    searchInput.value = '';
                    clearBtn.style.display = 'none';
                    floatingSearchBox.style.borderColor = 'rgba(25, 154, 255, 0.2)';
                    floatingSearchBox.style.backgroundColor = 'rgba(239, 243, 255, 0.9)';
                    
                    // Ê∏ÖÈô§ÊêúÁ¥¢ÔºåÁ´ãÂç≥ÊâßË°å
                    clearTimeout(searchTimeout);
                    filterContacts('');
                    
                    // ÈáçÊñ∞Ëé∑ÂæóÁÑ¶ÁÇπ
                    searchInput.focus();
                });
                
                // ÊêúÁ¥¢Ê°ÜËé∑ÂæóÁÑ¶ÁÇπÊó∂ÁöÑÊïàÊûú
                searchInput.addEventListener('focus', function() {
                    floatingSearchBox.style.boxShadow = '0 2px 8px rgba(25, 154, 255, 0.3)';
                });
                
                // ÊêúÁ¥¢Ê°ÜÂ§±ÂéªÁÑ¶ÁÇπÊó∂ÁöÑÊïàÊûú
                searchInput.addEventListener('blur', function() {
                    floatingSearchBox.style.boxShadow = 'none';
                });
                
                // ÊîØÊåÅÈîÆÁõòÂø´Êç∑ÈîÆÔºàEscape Ê∏ÖÈô§ÊêúÁ¥¢Ôºâ
                searchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        e.preventDefault();
                        this.value = '';
                        clearBtn.style.display = 'none';
                        floatingSearchBox.style.borderColor = 'rgba(25, 154, 255, 0.2)';
                        floatingSearchBox.style.backgroundColor = 'rgba(239, 243, 255, 0.9)';
                        clearTimeout(searchTimeout);
                        filterContacts('');
                    }
                });
                
                // Ê†áËÆ∞ÊêúÁ¥¢ÂäüËÉΩÂ∑≤ÂàùÂßãÂåñ
                searchInput.setAttribute('data-initialized', 'true');
                console.log("ËÅîÁªú‰∫∫ÊêúÁ¥¢ÂäüËÉΩÂàùÂßãÂåñÂÆåÊàê");
                
                // Á°Æ‰øùÁæ§ËÅäÂäüËÉΩ‰πüÂ∑≤ÂàùÂßãÂåñ
                if (typeof reinitGroupChat === 'function') {
                    reinitGroupChat();
                }
                
                // ÊêúÁ¥¢ÂäüËÉΩÂàùÂßãÂåñ‰∏çÈúÄË¶ÅÈáçÊñ∞Âä†ËΩΩÁæ§ËÅäÊï∞ÊçÆ
                console.log('initContactSearch: ÊêúÁ¥¢ÂäüËÉΩÂ∑≤ÂàùÂßãÂåñ');
                
                // ÂàùÂßãÂåñËÅîÁ≥ª‰∫∫ÂàÜÁªÑÂäüËÉΩ
                if (typeof initContactGroups === 'function') {
                    initContactGroups();
                }
                
                // Ê£ÄÊü•ËÅîÁªú‰∫∫ÂàóË°®ÊòØÂê¶Â≠òÂú®
                setTimeout(() => {
                    const contactsList = document.querySelector('#QQ_home_chars');
                    const contacts = contactsList ? contactsList.querySelectorAll('.QQ_home_usermsg') : [];
                    console.log(`ÂΩìÂâçËÅîÁªú‰∫∫Êï∞Èáè: ${contacts.length}`);
                    
                    // Â¶ÇÊûúÊ≤°ÊúâËÅîÁªú‰∫∫ÔºåÂèØ‰ª•Âú®ÊéßÂà∂Âè∞ÁúãÂà∞Áõ∏ÂÖ≥‰ø°ÊÅØ
                    if (contacts.length === 0) {
                        console.warn("ÂΩìÂâçÊ≤°ÊúâËÅîÁªú‰∫∫Êï∞ÊçÆÔºåÊêúÁ¥¢ÂäüËÉΩÂèØËÉΩÊó†Ê≥ïÊòæÁ§∫ÊïàÊûú");
                        console.log("ËØ∑Á°Æ‰øù‰∏ñÁïå‰π¶‰∏≠ÊúâËÅîÁªú‰∫∫Êï∞ÊçÆÔºåÊàñËÄÖÊâãÂä®Ê∑ªÂä†‰∏Ä‰∫õËÅîÁªú‰∫∫Êù•ÊµãËØïÊêúÁ¥¢ÂäüËÉΩ");
                    }
                }, 1000);
            }
            
            /**
             * ËøáÊª§ËÅîÁªú‰∫∫ÂàóË°®ÔºàÊîØÊåÅÂàÜÁªÑÔºâ
             * @param {string} searchTerm ÊêúÁ¥¢ÂÖ≥ÈîÆËØç
             */
            function filterContacts(searchTerm) {
                const contactsList = document.querySelector('#QQ_home_chars');
                if (!contactsList) {
                    console.error("ËÅîÁªú‰∫∫ÂàóË°®Êú™ÊâæÂà∞");
                    return;
                }
                
                // È¢ÑÂ§ÑÁêÜÊêúÁ¥¢ËØç
                const search = searchTerm.toLowerCase().trim();
                const isEmpty = search === '';
                let totalVisibleCount = 0;
                
                // Â§ÑÁêÜÂàÜÁªÑ‰∏≠ÁöÑËÅîÁ≥ª‰∫∫
                const contactGroups = contactsList.querySelectorAll('.contact-group');
                contactGroups.forEach(groupElement => {
                    const groupContent = groupElement.querySelector('.group-content');
                    const contacts = groupContent ? groupContent.querySelectorAll('.QQ_home_usermsg') : [];
                    let groupVisibleCount = 0;
                    
                    contacts.forEach(contact => {
                        const isVisible = filterSingleContact(contact, search, searchTerm, isEmpty);
                        if (isVisible) {
                            groupVisibleCount++;
                            totalVisibleCount++;
                        }
                    });
                    
                    // ÊòæÁ§∫/ÈöêËóèÂàÜÁªÑÔºàÂ¶ÇÊûúÂàÜÁªÑÂÜÖÊúâÂåπÈÖçÁöÑËÅîÁ≥ª‰∫∫Â∞±ÊòæÁ§∫ÂàÜÁªÑÔºâ
                    if (!isEmpty) {
                        if (groupVisibleCount > 0) {
                            groupElement.style.display = '';
                            // Â¶ÇÊûúÂàÜÁªÑÊòØÊäòÂè†Áä∂ÊÄÅ‰∏îÊúâÊêúÁ¥¢ÁªìÊûúÔºåÂ±ïÂºÄÂàÜÁªÑ
                            const groupToggle = groupElement.querySelector('.group-toggle');
                            const groupContentDiv = groupElement.querySelector('.group-content');
                            if (groupToggle && groupToggle.classList.contains('collapsed')) {
                                groupToggle.classList.remove('collapsed');
                                groupContentDiv.classList.remove('collapsed');
                                groupContentDiv.classList.add('expanded');
                            }
                        } else {
                            groupElement.style.display = 'none';
                        }
                    } else {
                        // ÊêúÁ¥¢‰∏∫Á©∫Êó∂ÊòæÁ§∫ÊâÄÊúâÂàÜÁªÑ
                        groupElement.style.display = '';
                    }
                });
                
                // Â§ÑÁêÜÊú™ÂàÜÁªÑÁöÑËÅîÁ≥ª‰∫∫
                const ungroupedSection = contactsList.querySelector('.ungrouped-contacts');
                if (ungroupedSection) {
                    const ungroupedContacts = ungroupedSection.querySelectorAll('.QQ_home_usermsg');
                    let ungroupedVisibleCount = 0;
                    
                    ungroupedContacts.forEach(contact => {
                        const isVisible = filterSingleContact(contact, search, searchTerm, isEmpty);
                        if (isVisible) {
                            ungroupedVisibleCount++;
                            totalVisibleCount++;
                        }
                    });
                    
                    // ÊòæÁ§∫/ÈöêËóèÊú™ÂàÜÁªÑÂå∫Âüü
                    if (!isEmpty) {
                        ungroupedSection.style.display = ungroupedVisibleCount > 0 ? '' : 'none';
                    } else {
                        ungroupedSection.style.display = '';
                    }
                }
                
                // Â§ÑÁêÜÁã¨Á´ãÁöÑËÅîÁ≥ª‰∫∫ÔºàÂ¶ÇÊûúÊ≤°ÊúâÂàÜÁªÑÁ≥ªÁªüÔºâ
                const independentContacts = contactsList.querySelectorAll('.QQ_home_usermsg:not(.contact-group .QQ_home_usermsg):not(.ungrouped-contacts .QQ_home_usermsg)');
                independentContacts.forEach(contact => {
                    const isVisible = filterSingleContact(contact, search, searchTerm, isEmpty);
                    if (isVisible) {
                        totalVisibleCount++;
                    }
                });
                
                // Âú®ÊéßÂà∂Âè∞ËæìÂá∫ÊêúÁ¥¢ÁªìÊûúÔºàË∞ÉËØïÁî®Ôºâ
                if (!isEmpty) {
                    console.log(`ÊêúÁ¥¢"${searchTerm}": ÊâæÂà∞ ${totalVisibleCount} ‰∏™ËÅîÁªú‰∫∫`);
                }
                
                // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞‰ªª‰ΩïÂåπÈÖçÈ°πÔºåÂèØ‰ª•ÊòæÁ§∫ÊèêÁ§∫ÔºàÂèØÈÄâÔºâ
                if (!isEmpty && totalVisibleCount === 0) {
                    console.log("Ê≤°ÊúâÊâæÂà∞ÂåπÈÖçÁöÑËÅîÁªú‰∫∫");
                }
            }
            
            /**
             * ËøáÊª§Âçï‰∏™ËÅîÁ≥ª‰∫∫
             * @param {Element} contact ËÅîÁ≥ª‰∫∫ÂÖÉÁ¥†
             * @param {string} search ÊêúÁ¥¢ËØçÔºàÂ∞èÂÜôÔºâ
             * @param {string} searchTerm ÂéüÂßãÊêúÁ¥¢ËØç
             * @param {boolean} isEmpty ÊòØÂê¶‰∏∫Á©∫ÊêúÁ¥¢
             * @returns {boolean} ÊòØÂê¶ÊòæÁ§∫ËØ•ËÅîÁ≥ª‰∫∫
             */
            function filterSingleContact(contact, search, searchTerm, isEmpty) {
                const nameElement = contact.querySelector('.QQ_home_name');
                const lastMsgElement = contact.querySelector('.QQ_home_lastmsg');
                
                if (!nameElement) {
                    console.warn("ËÅîÁªú‰∫∫È°πÁõÆÁº∫Â∞ëÂßìÂêçÂÖÉÁ¥†", contact);
                    return false;
                }
                
                // Ëé∑ÂèñÂéüÂßãÊñáÊú¨ÂÜÖÂÆπ
                const originalName = nameElement.getAttribute('data-original-text') || nameElement.textContent;
                const name = originalName.toLowerCase();
                const lastMsg = lastMsgElement ? lastMsgElement.textContent.toLowerCase() : '';
                
                // Ê£ÄÊü•ÊòØÂê¶ÂåπÈÖçÊêúÁ¥¢Êù°‰ª∂
                const nameMatches = isEmpty || name.includes(search);
                const msgMatches = isEmpty || lastMsg.includes(search);
                const isMatch = nameMatches || msgMatches;
                
                if (isMatch) {
                    // ÊòæÁ§∫ËÅîÁªú‰∫∫
                    contact.style.display = '';
                    
                    // Â§ÑÁêÜÈ´ò‰∫ÆÊòæÁ§∫
                    if (!isEmpty && nameMatches) {
                        highlightContactSearchTerm(nameElement, searchTerm, originalName);
                    } else {
                        // ÊÅ¢Â§çÂéüÂßãÊñáÊú¨ÔºåÁßªÈô§È´ò‰∫Æ
                        if (nameElement.getAttribute('data-original-text')) {
                            nameElement.innerHTML = originalName;
                        }
                    }
                    
                    return true;
                } else {
                    // ÈöêËóè‰∏çÂåπÈÖçÁöÑËÅîÁªú‰∫∫
                    contact.style.display = 'none';
                    return false;
                }
            }
            
            /**
             * ËÅîÁ≥ª‰∫∫ÊêúÁ¥¢È´ò‰∫ÆÂäüËÉΩ
             * @param {Element} element Ë¶ÅÈ´ò‰∫ÆÁöÑÂÖÉÁ¥†
             * @param {string} searchTerm ÊêúÁ¥¢ËØç
             * @param {string} originalText ÂéüÂßãÊñáÊú¨
             */
            function highlightContactSearchTerm(element, searchTerm, originalText) {
                if (!searchTerm || searchTerm.trim() === '') {
                    element.innerHTML = originalText;
                    return;
                }
                
                // ‰øùÂ≠òÂéüÂßãÊñáÊú¨
                if (!element.getAttribute('data-original-text')) {
                    element.setAttribute('data-original-text', originalText);
                }
                
                // ÂàõÂª∫È´ò‰∫ÆHTML
                const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                const highlightedText = originalText.replace(regex, '<span style="background-color: #FFE066; color: #333; font-weight: bold; padding: 1px 2px; border-radius: 2px;">$1</span>');
                
                element.innerHTML = highlightedText;
            }
            
            /**
             * È´ò‰∫ÆÊêúÁ¥¢ËØç
             * @param {Element} element Ë¶ÅÈ´ò‰∫ÆÁöÑÂÖÉÁ¥†
             * @param {string} searchTerm ÊêúÁ¥¢ËØç
             */
            function highlightSearchTerm(element, searchTerm) {
                // ‰øùÂ≠òÂéüÂßãÊñáÊú¨ÔºàÂ¶ÇÊûúËøòÊ≤°Êúâ‰øùÂ≠òÔºâ
                if (!element.getAttribute('data-original-text')) {
                    element.setAttribute('data-original-text', element.textContent);
                }
                
                const originalText = element.getAttribute('data-original-text');
                
                // Â¶ÇÊûúÊêúÁ¥¢ËØç‰∏∫Á©∫ÔºåÊÅ¢Â§çÂéüÂßãÊñáÊú¨
                if (!searchTerm || searchTerm.trim() === '') {
                    element.innerHTML = originalText;
                    return;
                }
                
                // ËΩ¨‰πâÁâπÊÆäÂ≠óÁ¨¶ÔºåÈò≤Ê≠¢Ê≠£ÂàôË°®ËææÂºèÈîôËØØ
                const escapedSearchTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`(${escapedSearchTerm})`, 'gi');
                const highlightedText = originalText.replace(regex, '<span class="search-highlight">$1</span>');
                
                element.innerHTML = highlightedText;
            }
        </script>

        <!-- Áæ§ËÅäÁÆ°ÁêÜ‰∏ãÊãâËèúÂçï -->
        <div id="group_management_dropdown" class="group-management-dropdown" style="display: none;">
            <div class="group-management-header">
                <div class="group-management-title">Áæ§ËÅäÊàêÂëò</div>
                <svg class="group-settings-icon" onclick="showGroupSettings()" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11.03L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11.03C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                </svg>
            </div>
            <div class="group-members-list" id="group_members_display">
                <!-- Áæ§ÊàêÂëòÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
            </div>
        </div>
        
        <!-- Áæ§ËÅäËÆæÁΩÆÊ®°ÊÄÅÁ™óÂè£ -->
        <div id="group_settings_modal" class="group-settings-modal">
            <div class="group-settings-content">
                <div class="group-settings-header">
                    <h3 class="group-settings-title">Áæ§ËÅäËÆæÁΩÆ</h3>
                </div>
                <div class="group-settings-body">
                    <div class="group-settings-section">
                        <div class="group-settings-section-title">Áæ§ËÅäÂêçÁß∞</div>
                        <input type="text" id="group_name_edit" class="group-settings-input" placeholder="ËæìÂÖ•Áæ§ËÅäÂêçÁß∞">
                    </div>
                    <div class="group-settings-section">
                        <div class="group-settings-section-title">Áæ§ËÅäÂ§¥ÂÉè</div>
                        <div class="group-settings-avatar-container">
                            <div class="group-settings-avatar-preview" id="group_settings_avatar_preview" onclick="showGroupAvatarSelector()">
                                <div class="group-settings-default-avatar">Áæ§</div>
                            </div>
                            <div class="group-settings-avatar-text" onclick="showGroupAvatarSelector()">ÁÇπÂáªÊõ¥Êç¢Â§¥ÂÉè</div>
                        </div>
                    </div>
                    <div class="group-settings-section">
                        <div class="group-settings-section-title">Áæ§ÊàêÂëòÁÆ°ÁêÜ</div>
                        <div class="group-settings-member-list" id="group_members_edit">
                            <!-- Áæ§ÊàêÂëòÁºñËæëÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                        </div>
                    </div>
                </div>
                <div class="group-settings-actions">
                    <button class="group-settings-btn group-settings-cancel-btn" onclick="closeGroupSettings()">ÂèñÊ∂à</button>
                    <button class="group-settings-btn group-settings-save-btn" onclick="saveGroupSettings()">‰øùÂ≠ò</button>
                    <button class="group-settings-btn group-settings-delete-btn" onclick="deleteCurrentGroup()">Âà†Èô§Áæ§ËÅä</button>
                </div>
            </div>
        </div>

        <!-- Áæ§ËÅäÂàõÂª∫ÂºπÁ™óÁ≥ªÁªü -->
        <!-- Á¨¨‰∏ÄÂ±ÇÂºπÁ™óÔºöÈÄâÊã©ÂàõÂª∫Á±ªÂûã -->
        <div id="group_chat_modal" class="group-chat-modal" style="display: none;">
            <div class="group-chat-dialog">
                <div class="group-chat-header">
                    Êñ∞Âª∫
                </div>
                <div class="group-chat-content">
                    <div class="group-chat-option" onclick="openGroupCreateModal()">
                        <svg class="group-chat-option-icon" viewBox="0 0 1024 1024">
                            <path d="M320 896c-35.2 0-64-28.8-64-64V288c0-35.2 28.8-64 64-64s64 28.8 64 64v544c0 35.2-28.8 64-64 64zM704 896c-35.2 0-64-28.8-64-64V288c0-35.2 28.8-64 64-64s64 28.8 64 64v544c0 35.2-28.8 64-64 64zM512 1024c-106.039 0-192-85.961-192-192s85.961-192 192-192 192 85.961 192 192-85.961 192-192 192z m0-128c70.692 0 128-57.308 128-128s-57.308-128-128-128-128 57.308-128 128 57.308 128 128 128z"/>
                        </svg>
                        <span class="group-chat-option-text">ÂèëËµ∑Áæ§ËÅä</span>
                    </div>
                    <div class="group-chat-option" onclick="openContactGroupModal()">
                        <svg class="group-chat-option-icon" viewBox="0 0 1024 1024">
                            <path d="M853.333 256H682.667c0-47.147-38.187-85.333-85.333-85.333H426.667c-47.147 0-85.333 38.187-85.333 85.333H170.667C123.52 256 85.333 294.187 85.333 341.333v426.667c0 47.147 38.187 85.333 85.333 85.333h682.667c47.147 0 85.333-38.187 85.333-85.333V341.333c0-47.147-38.187-85.333-85.333-85.333zM426.667 256h170.667v85.333H426.667V256zm426.667 512H170.667V341.333h170.667v42.667c0 23.573 19.093 42.667 42.667 42.667s42.667-19.093 42.667-42.667v-42.667h170.667v42.667c0 23.573 19.093 42.667 42.667 42.667s42.667-19.093 42.667-42.667v-42.667h170.667V768z"/>
                        </svg>
                        <span class="group-chat-option-text">Êñ∞Âª∫ÂàÜÁªÑ</span>
                    </div>
                    <div class="group-chat-option" onclick="closeGroupChatModal()">
                        <svg class="group-chat-option-icon" viewBox="0 0 1024 1024">
                            <path d="M628.64 183.936a64 64 0 0 1 90.368 90.368L557.312 435.84l161.696 161.472a64 64 0 1 1-90.368 90.368L466.944 526.208 305.472 687.68a64 64 0 1 1-90.368-90.368L376.576 435.84 214.88 274.368a64 64 0 0 1 90.368-90.368l161.696 161.472 161.696-161.472z"/>
                        </svg>
                        <span class="group-chat-option-text">Ê∑ªÂä†ÊúãÂèã</span>
                    </div>
                    <div class="group-chat-option" onclick="closeGroupChatModal()">
                        <svg class="group-chat-option-icon" viewBox="0 0 1024 1024">
                            <path d="M304 176h416c79.4 0 144 64.6 144 144v384c0 79.4-64.6 144-144 144H304c-79.4 0-144-64.6-144-144V320c0-79.4 64.6-144 144-144z m0 64c-44.2 0-80 35.8-80 80v384c0 44.2 35.8 80 80 80h416c44.2 0 80-35.8 80-80V320c0-44.2-35.8-80-80-80H304z"/>
                        </svg>
                        <span class="group-chat-option-text">Êâ´‰∏ÄÊâ´</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Á¨¨‰∫åÂ±ÇÂºπÁ™óÔºöÂàõÂª∫Áæ§ËÅä -->
        <div id="group_create_modal" class="group-create-modal" style="display: none;">
            <div class="group-create-dialog">
                <div class="group-create-header">
                    <span class="group-create-title">ÂèëËµ∑Áæ§ËÅä</span>
                    <span class="group-create-close" onclick="closeGroupCreateModal()">&times;</span>
                </div>
                <div class="group-create-content">
                    <div class="group-name-section">
                        <label class="group-name-label">Áæ§ËÅäÂêçÁß∞</label>
                        <input 
                            type="text" 
                            id="group_name_input" 
                            class="group-name-input" 
                            placeholder="ËØ∑ËæìÂÖ•Áæ§ËÅäÂêçÁß∞"
                            maxlength="20"
                        >
                    </div>
                    <div class="group-avatar-section">
                        <label class="group-avatar-label">Áæ§ËÅäÂ§¥ÂÉè</label>
                        <div class="group-avatar-selector">
                            <div class="group-avatar-preview" id="group_avatar_preview" onclick="showAvatarSelector()">
                                <div class="default-group-avatar">+</div>
                            </div>
                            <div class="group-avatar-text" onclick="showAvatarSelector()">ÁÇπÂáªËÆæÁΩÆÂ§¥ÂÉè</div>
                        </div>
                    </div>
                    <div class="group-members-section">
                        <div class="group-members-label">ÈÄâÊã©Áæ§ÊàêÂëò</div>
                        <div class="group-member-search">
                            <span class="group-search-icon">üîç</span>
                            <input 
                                type="text" 
                                class="group-search-input" 
                                id="group_member_search" 
                                placeholder="ÊêúÁ¥¢ËÅîÁ≥ª‰∫∫..."
                                oninput="filterGroupMembers()"
                                onkeydown="handleGroupSearchKeydown(event)"
                            >
                            <span class="group-search-clear" id="group_search_clear" onclick="clearGroupSearch()">‚úï</span>
                        </div>
                        <div class="contact-list-container">
                            <div id="contact_list_for_group">
                                <!-- ËøôÈáåÂ∞ÜÂä®ÊÄÅÂä†ËΩΩËÅîÁ≥ª‰∫∫ÂàóË°® -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="group-create-actions">
                    <button class="group-action-btn group-cancel-btn" onclick="closeGroupCreateModal()">
                        ÂèñÊ∂à
                    </button>
                    <button class="group-action-btn group-confirm-btn" id="group_confirm_btn" onclick="createGroupChat()">
                        ÂàõÂª∫Áæ§ËÅä
                    </button>
                </div>
            </div>
        </div>

        <!-- Â§¥ÂÉèÈÄâÊã©ÂºπÁ™ó -->
        <div id="avatar_selector_modal" class="avatar-selector-modal" style="display: none;">
            <div class="avatar-selector-dialog">
                <div class="avatar-selector-header">
                    <span class="avatar-selector-title">ÈÄâÊã©Áæ§ËÅäÂ§¥ÂÉè</span>
                    <span class="avatar-selector-close" onclick="closeAvatarSelector()">&times;</span>
                </div>
                <div class="avatar-selector-content">
                    <div class="avatar-selector-tabs">
                        <div class="avatar-tab active" onclick="switchAvatarTab('preset')">È¢ÑËÆæÂ§¥ÂÉè</div>
                        <div class="avatar-tab" onclick="switchAvatarTab('upload')">‰∏ä‰º†Â§¥ÂÉè</div>
                        <div class="avatar-tab" onclick="switchAvatarTab('url')">ËæìÂÖ•ÈìæÊé•</div>
                    </div>
                    <div class="avatar-selector-body">
                        <!-- È¢ÑËÆæÂ§¥ÂÉèÈÄâÈ°π -->
                        <div id="preset_avatars" class="avatar-options active">
                            <div class="preset-avatar-grid">
                                <!-- ËøôÈáå‰ºöÂä®ÊÄÅÂä†ËΩΩÈ¢ÑËÆæÂ§¥ÂÉè -->
                            </div>
                        </div>
                        <!-- ‰∏ä‰º†Â§¥ÂÉèÈÄâÈ°π -->
                        <div id="upload_avatars" class="avatar-options">
                            <div class="upload-zone" onclick="triggerFileUpload()">
                                <div class="upload-icon">üìÅ</div>
                                <div class="upload-text">ÁÇπÂáª‰∏ä‰º†ÂõæÁâá</div>
                                <div class="upload-hint">ÊîØÊåÅ JPG„ÄÅPNG Ê†ºÂºè</div>
                            </div>
                            <input type="file" id="avatar_upload_input" accept="image/*" style="display: none;" onchange="handleAvatarUpload(event)">
                        </div>
                        <!-- ËæìÂÖ•ÈìæÊé•ÈÄâÈ°π -->
                        <div id="url_avatars" class="avatar-options">
                            <div class="url-input-zone">
                                <div class="url-input-title">ËæìÂÖ•ÂõæÁâáÈìæÊé•</div>
                                <input 
                                    type="url" 
                                    id="avatar_url_input" 
                                    class="url-input" 
                                    placeholder="ËØ∑ËæìÂÖ•ÂõæÁâáÈìæÊé• (Â¶Ç: https://catbox.moe/...)"
                                    oninput="handleAvatarUrlInput()"
                                >
                                <div class="url-input-hint">
                                    Êé®Ëçê‰ΩøÁî® <a href="https://catbox.moe" target="_blank" style="color: #199AFF;">catbox.moe</a> Á≠âÂõæÂ∫äÊúçÂä°
                                </div>
                                <div id="url_preview_container" class="url-preview-container" style="display: none;">
                                    <div class="url-preview-title">È¢ÑËßà</div>
                                    <img id="url_preview_image" class="url-preview-image" alt="È¢ÑËßàÂõæÁâá">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="avatar-selector-actions">
                    <button class="avatar-action-btn avatar-cancel-btn" onclick="closeAvatarSelector()">
                        ÂèñÊ∂à
                    </button>
                    <button class="avatar-action-btn avatar-confirm-btn" id="avatar_confirm_btn" onclick="confirmAvatarSelection()">
                        Á°ÆËÆ§
                    </button>
                </div>
            </div>
        </div>

        <!-- Êñ∞Âª∫ÂàÜÁªÑÂºπÁ™ó -->
        <div id="new_group_modal" class="new-group-modal">
            <div class="new-group-dialog">
                <div class="new-group-title">Êñ∞Âª∫ÂàÜÁªÑ</div>
                <input 
                    type="text" 
                    id="new_group_name_input"
                    class="new-group-input" 
                    placeholder="ËØ∑ËæìÂÖ•ÂàÜÁªÑÂêçÁß∞"
                    maxlength="15"
                    onkeydown="handleNewGroupKeydown(event)"
                >
                <div class="new-group-actions">
                    <button class="new-group-btn new-group-cancel" onclick="closeNewGroupModal()">
                        ÂèñÊ∂à
                    </button>
                                    <button class="new-group-btn new-group-confirm" onclick="createNewContactGroup()">
                    ÂàõÂª∫
                </button>
                </div>
            </div>
        </div>

        <!-- Ê∑ªÂä†ÊàêÂëòÂºπÁ™ó -->
        <div id="add_member_modal" class="add-member-modal" style="display: none;">
            <div class="add-member-dialog">
                <div class="add-member-header">
                    <h3 class="add-member-title">ÈÄâÊã©Áæ§ÊàêÂëò</h3>
                    <span class="add-member-close" onclick="closeAddMemberModal()">&times;</span>
                </div>
                <div class="add-member-content">
                    <div class="add-member-search">
                        <input 
                            type="text" 
                            class="add-member-search-input" 
                            id="add_member_search_input"
                            placeholder="ÊêúÁ¥¢ËÅîÁ≥ª‰∫∫..."
                            oninput="filterAddMemberContacts()"
                        >
                        <span class="add-member-search-icon">üîç</span>
                    </div>
                    <div class="add-member-contact-list" id="add_member_contact_list">
                        <!-- ËÅîÁ≥ª‰∫∫ÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>
                <div class="add-member-actions">
                    <button class="add-member-btn add-member-cancel-btn" onclick="closeAddMemberModal()">
                        ÂèñÊ∂à
                    </button>
                    <button class="add-member-btn add-member-confirm-btn" id="add_member_confirm_btn" onclick="confirmAddMembers()" disabled>
                        Ê∑ªÂä†ÊàêÂëò
                    </button>
                </div>
            </div>
        </div>

        <script>
            // Áæ§ËÅäÂàõÂª∫ÂäüËÉΩJavaScript‰ª£Á†Å
            
            /**
             * ÊòæÁ§∫Áæ§ËÅäÈÄâÈ°πÂºπÁ™ó
             */
            function showGroupChatModal() {
                console.log('showGroupChatModal ÂáΩÊï∞Ë¢´Ë∞ÉÁî®');
                const modal = document.getElementById('group_chat_modal');
                console.log('ÂºπÁ™óÂÖÉÁ¥†:', modal);
                
                if (modal) {
                    console.log('ÊòæÁ§∫ÂºπÁ™ó...');
                    modal.style.display = 'flex';
                    modal.style.zIndex = '9999';
                    
                    // Ê∑ªÂä†ËÉåÊôØÁÇπÂáªÂÖ≥Èó≠ÂäüËÉΩ
                    modal.addEventListener('click', function(e) {
                        if (e.target === modal) {
                            closeGroupChatModal();
                        }
                    });
                    
                    console.log('ÂºπÁ™óÂ∑≤ÊòæÁ§∫ÔºåÂΩìÂâçÊ†∑Âºè:', modal.style.display);
                } else {
                    console.error('Êú™ÊâæÂà∞ÂºπÁ™óÂÖÉÁ¥† (ID: group_chat_modal)');
                    alert('ÂºπÁ™óÂÖÉÁ¥†Êú™ÊâæÂà∞ÔºåËØ∑Ê£ÄÊü•È°µÈù¢ÁªìÊûÑ');
                }
            }
            
            /**
             * ÂÖ≥Èó≠Áæ§ËÅäÈÄâÈ°πÂºπÁ™ó
             */
            function closeGroupChatModal() {
                const modal = document.getElementById('group_chat_modal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }
            
            /**
             * ÊâìÂºÄÁæ§ËÅäÂàõÂª∫ÂºπÁ™ó
             */
            function openGroupCreateModal() {
                // ÂÖàÂÖ≥Èó≠Á¨¨‰∏ÄÂ±ÇÂºπÁ™ó
                closeGroupChatModal();
                
                // Âª∂Ëøü‰∏ÄÁÇπÊó∂Èó¥ÂÜçÊòæÁ§∫Á¨¨‰∫åÂ±ÇÂºπÁ™óÔºåËÆ©Âä®ÁîªÊõ¥ÊµÅÁïÖ
                setTimeout(() => {
                    const modal = document.getElementById('group_create_modal');
                    if (modal) {
                        modal.style.display = 'flex';
                        
                        // Âä†ËΩΩËÅîÁ≥ª‰∫∫ÂàóË°®
                        loadContactsForGroup();
                        
                        // ÈáçÁΩÆË°®ÂçïÂíåÊêúÁ¥¢
                        document.getElementById('group_name_input').value = '';
                        const searchInput = document.getElementById('group_member_search');
                        if (searchInput) {
                            searchInput.value = '';
                        }
                        const clearBtn = document.getElementById('group_search_clear');
                        if (clearBtn) {
                            clearBtn.classList.remove('show');
                        }
                        updateConfirmButtonState();
                        
                        // Ê∑ªÂä†ËÉåÊôØÁÇπÂáªÂÖ≥Èó≠ÂäüËÉΩ
                        modal.addEventListener('click', function(e) {
                            if (e.target === modal) {
                                closeGroupCreateModal();
                            }
                        });
                    }
                }, 150);
            }
            
            /**
             * ÂÖ≥Èó≠Áæ§ËÅäÂàõÂª∫ÂºπÁ™ó
             */
            function closeGroupCreateModal() {
                const modal = document.getElementById('group_create_modal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }
            
            /**
             * Âä†ËΩΩËÅîÁ≥ª‰∫∫ÂàóË°®Âà∞Áæ§ËÅäÂàõÂª∫ÂºπÁ™ó
             */
            function loadContactsForGroup() {
                const contactListContainer = document.getElementById('contact_list_for_group');
                const homeChars = document.getElementById('QQ_home_chars');
                
                if (!contactListContainer || !homeChars) return;
                
                // Ê∏ÖÁ©∫‰πãÂâçÁöÑÂÜÖÂÆπ
                contactListContainer.innerHTML = '';
                
                // Ëé∑ÂèñÊâÄÊúâËÅîÁ≥ª‰∫∫
                const contacts = homeChars.querySelectorAll('.QQ_home_usermsg');
                
                if (contacts.length === 0) {
                    contactListContainer.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">ÊöÇÊó†ËÅîÁ≥ª‰∫∫</div>';
                    return;
                }
                
                // ‰∏∫ÊØè‰∏™ËÅîÁ≥ª‰∫∫ÂàõÂª∫Â§çÈÄâÊ°ÜÈ°πÔºàÊéíÈô§Áæ§ËÅäÔºâ
                contacts.forEach((contact, index) => {
                    const nameElement = contact.querySelector('.QQ_home_name');
                    const headElement = contact.querySelector('.QQ_home_head');
                    
                    if (!nameElement) return;
                    
                    // Ë∑≥ËøáÁæ§ËÅäÁ±ªÂûãÁöÑËÅîÁ≥ª‰∫∫
                    if (contact.hasAttribute('data-group-type')) {
                        return;
                    }
                    
                    const contactName = nameElement.textContent.trim();
                    
                    // Ëé∑ÂèñÂ§¥ÂÉèÊ†∑Âºè - Áõ¥Êé•Â§çÂà∂ÂéüÂßãÂÖÉÁ¥†ÁöÑÊâÄÊúâÊ†∑Âºè
                    let avatarStyle = '';
                    let hasRealAvatar = false;
                    
                    if (headElement) {
                        // Áõ¥Êé•Ëé∑ÂèñÂÜÖËÅîÊ†∑Âºè
                        const inlineStyle = headElement.getAttribute('style') || '';
                        
                        // Ëé∑ÂèñËÆ°ÁÆóÊ†∑Âºè
                        const computedStyle = window.getComputedStyle(headElement);
                        const backgroundImage = computedStyle.backgroundImage;
                        const backgroundColor = computedStyle.backgroundColor;
                        
                        // console.log('Â§¥ÂÉèË∞ÉËØï‰ø°ÊÅØ:', {
                        //     inlineStyle,
                        //     backgroundImage,
                        //     backgroundColor,
                        //     contactName
                        // });
                        
                        if (inlineStyle && inlineStyle.includes('background')) {
                            // ‰ºòÂÖà‰ΩøÁî®ÂÜÖËÅîÊ†∑Âºè
                            avatarStyle = inlineStyle;
                            hasRealAvatar = inlineStyle.includes('background-image');
                        } else if (backgroundImage && backgroundImage !== 'none') {
                            avatarStyle = `background-image: ${backgroundImage}; background-size: cover; background-position: center;`;
                            hasRealAvatar = true;
                        } else if (backgroundColor && backgroundColor !== 'rgba(0, 0, 0, 0)' && backgroundColor !== 'transparent') {
                            avatarStyle = `background-color: ${backgroundColor};`;
                        }
                        
                        // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ÊúâÊïàÁöÑËÉåÊôØÔºå‰ΩøÁî®ÈªòËÆ§È¢úËâ≤
                        if (!avatarStyle || avatarStyle === '') {
                            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F'];
                            const color = colors[index % colors.length];
                            avatarStyle = `background-color: ${color};`;
                        }
                    } else {
                        // ÈªòËÆ§Â§¥ÂÉèÈ¢úËâ≤
                        const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F'];
                        const color = colors[index % colors.length];
                        avatarStyle = `background-color: ${color};`;
                    }
                    
                    const contactItem = document.createElement('div');
                    contactItem.className = 'contact-item';
                    contactItem.setAttribute('data-contact-name', contactName);
                    contactItem.setAttribute('data-contact-index', index);
                    contactItem.onclick = () => toggleContactSelection(contactItem);
                    
                    contactItem.innerHTML = `
                        <input 
                            type="checkbox" 
                            id="contact_${index}" 
                            class="contact-checkbox"
                            data-contact-name="${contactName}"
                        >
                        <div class="contact-avatar" style="${avatarStyle}">
                            ${!hasRealAvatar ? 
                                `<span style="color: white; font-size: 12px; font-weight: bold; display: flex; align-items: center; justify-content: center; height: 100%;">${contactName.charAt(0)}</span>` : 
                                ''
                            }
                        </div>
                        <span class="contact-name">${contactName}</span>
                    `;
                    
                    contactListContainer.appendChild(contactItem);
                });
            }
            
            /**
             * ÂàáÊç¢ËÅîÁ≥ª‰∫∫ÈÄâÊã©Áä∂ÊÄÅ
             */
            function toggleContactSelection(contactItem) {
                const checkbox = contactItem.querySelector('.contact-checkbox');
                
                if (contactItem.classList.contains('selected')) {
                    // ÂèñÊ∂àÈÄâÊã©
                    contactItem.classList.remove('selected');
                    if (checkbox) checkbox.checked = false;
                } else {
                    // ÈÄâÊã©
                    contactItem.classList.add('selected');
                    if (checkbox) checkbox.checked = true;
                }
                
                updateConfirmButtonState();
                
                // Ê∑ªÂä†ÈÄâÊã©Áä∂ÊÄÅÁöÑË∞ÉËØï‰ø°ÊÅØ
                const contactName = contactItem.getAttribute('data-contact-name');
                const isSelected = contactItem.classList.contains('selected');
                console.log(`ËÅîÁ≥ª‰∫∫ "${contactName}" ÈÄâÊã©Áä∂ÊÄÅ: ${isSelected ? 'Â∑≤ÈÄâ‰∏≠' : 'Êú™ÈÄâ‰∏≠'}`);
            }
            
            /**
             * È´ò‰∫ÆÊêúÁ¥¢ÂÖ≥ÈîÆÂ≠ó
             */
            function highlightSearchTerm(text, searchTerm) {
                if (!searchTerm || searchTerm.trim() === '') {
                    return text;
                }
                
                const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                return text.replace(regex, '<span style="background-color: #FFE066; color: #333; font-weight: bold; padding: 1px 2px; border-radius: 2px;">$1</span>');
            }
            
            /**
             * Áæ§ËÅäÊàêÂëòÊêúÁ¥¢ÂäüËÉΩ
             */
            function filterGroupMembers() {
                const searchInput = document.getElementById('group_member_search');
                const clearBtn = document.getElementById('group_search_clear');
                const contactItems = document.querySelectorAll('#contact_list_for_group .contact-item');
                const contactListContainer = document.getElementById('contact_list_for_group');
                
                if (!searchInput || !contactItems.length) return;
                
                const searchTerm = searchInput.value.toLowerCase().trim();
                const originalSearchTerm = searchInput.value.trim(); // ‰øùÊåÅÂéüÂßãÂ§ßÂ∞èÂÜô
                
                // ÊòæÁ§∫/ÈöêËóèÊ∏ÖÈô§ÊåâÈíÆ
                if (searchTerm.length > 0) {
                    clearBtn.classList.add('show');
                } else {
                    clearBtn.classList.remove('show');
                }
                
                let visibleCount = 0;
                
                contactItems.forEach(item => {
                    const originalContactName = item.getAttribute('data-contact-name');
                    const contactName = originalContactName.toLowerCase();
                    const nameElement = item.querySelector('.contact-name');
                    
                    if (contactName.includes(searchTerm)) {
                        item.style.display = 'flex';
                        visibleCount++;
                        
                        // È´ò‰∫ÆÂåπÈÖçÁöÑÂÖ≥ÈîÆÂ≠ó
                        if (searchTerm.length > 0) {
                            nameElement.innerHTML = highlightSearchTerm(originalContactName, originalSearchTerm);
                        } else {
                            nameElement.textContent = originalContactName;
                        }
                    } else {
                        item.style.display = 'none';
                        // ÈáçÁΩÆÊñáÊú¨ÂÜÖÂÆπ
                        nameElement.textContent = originalContactName;
                    }
                });
                
                // ÊòæÁ§∫Êó†ÊêúÁ¥¢ÁªìÊûúÊèêÁ§∫
                let noResultsDiv = contactListContainer.querySelector('.no-results');
                if (visibleCount === 0 && searchTerm.length > 0) {
                    if (!noResultsDiv) {
                        noResultsDiv = document.createElement('div');
                        noResultsDiv.className = 'no-results';
                        noResultsDiv.textContent = 'Êú™ÊâæÂà∞ÂåπÈÖçÁöÑËÅîÁ≥ª‰∫∫';
                        contactListContainer.appendChild(noResultsDiv);
                    }
                    noResultsDiv.style.display = 'block';
                } else if (noResultsDiv) {
                    noResultsDiv.style.display = 'none';
                }
            }
            
            /**
             * Ê∏ÖÈô§Áæ§ËÅäÊàêÂëòÊêúÁ¥¢
             */
            function clearGroupSearch() {
                const searchInput = document.getElementById('group_member_search');
                const clearBtn = document.getElementById('group_search_clear');
                
                if (searchInput) {
                    searchInput.value = '';
                    searchInput.focus();
                }
                
                if (clearBtn) {
                    clearBtn.classList.remove('show');
                }
                
                // Ê∏ÖÈô§ÊâÄÊúâÈ´ò‰∫ÆÂπ∂ÊòæÁ§∫ÊâÄÊúâËÅîÁ≥ª‰∫∫
                const contactItems = document.querySelectorAll('#contact_list_for_group .contact-item');
                contactItems.forEach(item => {
                    const nameElement = item.querySelector('.contact-name');
                    const originalName = item.getAttribute('data-contact-name');
                    
                    item.style.display = 'flex';
                    nameElement.textContent = originalName; // Ê∏ÖÈô§È´ò‰∫Æ
                });
                
                // ÈöêËóèÊó†ÁªìÊûúÊèêÁ§∫
                const noResultsDiv = document.getElementById('contact_list_for_group').querySelector('.no-results');
                if (noResultsDiv) {
                    noResultsDiv.style.display = 'none';
                }
            }
            
            /**
             * Â§ÑÁêÜÁæ§ËÅäÊêúÁ¥¢ÈîÆÁõò‰∫ã‰ª∂
             */
            function handleGroupSearchKeydown(event) {
                if (event.key === 'Escape') {
                    clearGroupSearch();
                } else if (event.key === 'Enter') {
                    // Â¶ÇÊûúÂè™Êúâ‰∏Ä‰∏™ÂèØËßÅÁöÑËÅîÁ≥ª‰∫∫ÔºåÁõ¥Êé•ÈÄâÊã©ÂÆÉ
                    const visibleItems = document.querySelectorAll('#contact_list_for_group .contact-item[style*="flex"], #contact_list_for_group .contact-item:not([style*="none"])');
                    if (visibleItems.length === 1) {
                        toggleContactSelection(visibleItems[0]);
                    }
                }
            }
            
            /**
             * Êõ¥Êñ∞Á°ÆËÆ§ÊåâÈíÆÁä∂ÊÄÅ
             */
            function updateConfirmButtonState() {
                const confirmBtn = document.getElementById('group_confirm_btn');
                const groupNameInput = document.getElementById('group_name_input');
                const selectedItems = document.querySelectorAll('#contact_list_for_group .contact-item.selected');
                
                if (!confirmBtn || !groupNameInput) return;
                
                const hasName = groupNameInput.value.trim().length > 0;
                const hasMembers = selectedItems.length > 0;
                
                confirmBtn.disabled = !(hasName && hasMembers);
                
                console.log('Êõ¥Êñ∞Áæ§ËÅäÁ°ÆËÆ§ÊåâÈíÆÁä∂ÊÄÅ:', {
                    hasName,
                    hasMembers,
                    disabled: confirmBtn.disabled,
                    nameLength: groupNameInput.value.trim().length,
                    selectedCount: selectedItems.length
                });
            }
            
            // Ëøô‰∏™ÂáΩÊï∞Â∑≤Ë¢´‰∏ãÈù¢Êõ¥ÂÆåÊï¥ÁöÑÁâàÊú¨Êõø‰ª£ÔºåÂ∑≤Âà†Èô§ÈáçÂ§çÂÆö‰πâ
            
            /**
             * ÁîüÊàêÁæ§ËÅäÂ§¥ÂÉèÔºà‰ΩøÁî®Áæ§ÊàêÂëòÂ§¥ÂÉèÁªÑÂêàÊàñÈªòËÆ§Ê†∑ÂºèÔºâ
             */
            function generateGroupAvatar(members) {
                // ÁÆÄÂçïÁöÑÁæ§ËÅäÂ§¥ÂÉèÁîüÊàêÔºö‰ΩøÁî®Ê∏êÂèòËÉåÊôØ
                const colors = [
                    'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                    'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                    'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                    'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                    'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)'
                ];
                return colors[Math.floor(Math.random() * colors.length)];
            }
            
            /**
             * Ëé∑ÂèñÂΩìÂâçÊó∂Èó¥Â≠óÁ¨¶‰∏≤
             */
            function getCurrentTime() {
                const now = new Date();
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                return `${hours}:${minutes}`;
            }
            
            // Ê≥®ÊÑèÔºöaddGroupToContactListÂíåaddGroupToMessageListÂáΩÊï∞Â∑≤Âà†Èô§
            // Áé∞Âú®Áªü‰∏Ä‰ΩøÁî®AddNewGroupÂáΩÊï∞ÔºåÂÆÉ‰ºöËá™Âä®Â§ÑÁêÜËÅîÁ≥ª‰∫∫ÂàóË°®ÂíåÊ∂àÊÅØÂàóË°®ÁöÑÂêåÊ≠•
            
            /**
             * ‰øùÂ≠òÁæ§ËÅäÊï∞ÊçÆÂà∞Êú¨Âú∞Â≠òÂÇ®
             */
            async function saveGroupToStorage(groupData) {
                // Êñ∞ÁâàÊú¨Ôºö‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶ËÄå‰∏çÊòØlocalStorage
                console.log('saveGroupToStorageË¢´Ë∞ÉÁî®ÔºåËΩ¨ÂèëÂà∞‰∏ñÁïå‰π¶‰øùÂ≠ò');
                console.log('Áæ§ËÅäÊï∞ÊçÆ:', groupData);
                
                const success = await addGroupToWorldbook(groupData);
                if (success) {
                    console.log('Áæ§ËÅäÂ∑≤ÊàêÂäü‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶');
                } else {
                    console.error('‰øùÂ≠òÁæ§ËÅäÂà∞‰∏ñÁïå‰π¶Â§±Ë¥•');
                }
                return success;
            }
            
            /**
             * ‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩÁæ§ËÅäÊï∞ÊçÆ
             */
             async function loadGroupChatsFromWorldbook() {
                console.log('=== loadGroupChatsFromWorldbookË¢´Ë∞ÉÁî®Ôºà‰ªéÁã¨Á´ãÁæ§ËÅäÊù°ÁõÆÔºâ ===');
                console.log('ÂΩìÂâçworldbook:', typeof worldbook, worldbook ? 'Â≠òÂú®' : '‰∏çÂ≠òÂú®');
                
                const groups = [];
                
                console.log('Áæ§ËÅäÂä†ËΩΩÔºöÈááÁî®‰∏éÁßÅËÅäÁõ∏ÂêåÁöÑÊ®°ÂºèÔºå‰∏çÊ∏ÖÁêÜÁé∞ÊúâÈ°πÁõÆ');
                
                try {
                    // Ê£ÄÊü•Âπ∂Á°Æ‰øùentriesÂ∑≤ÂÆö‰πâ‰∏îÂèØÁî®
                    if (typeof entries === 'undefined' || entries === null) {
                        console.log('entriesÊú™ÂÆö‰πâÔºåÊ≠£Âú®ÂàùÂßãÂåñ...');
                        if (!worldbook) {
                            console.error('worldbookÊú™ÂÆö‰πâÔºåÊó†Ê≥ïÂàùÂßãÂåñentriesÔºåÊèêÂâçÈÄÄÂá∫');
                            return groups;
                        }
                        // ‰ΩøÁî® getLorebookEntries Á°Æ‰øùËé∑ÂèñÂà∞ÊúÄÊñ∞ÁöÑ‰∏ñÁïå‰π¶Êù°ÁõÆ
                        entries = await getLorebookEntries(worldbook);
                        console.log('entriesÂàùÂßãÂåñÂÆåÊàêÔºåÊù°ÁõÆÊï∞Èáè:', entries ? entries.length : 'failed');
                        if (!entries) {
                            console.error('entriesÂàùÂßãÂåñÂ§±Ë¥•ÔºåÊèêÂâçÈÄÄÂá∫');
                            return groups;
                        }
                    }
                    
                    console.log('ÂΩìÂâçentries:', typeof entries, entries ? entries.length : 'undefined');

                    // Êü•ÊâæÊâÄÊúâÁæ§ËÅäÊù°ÁõÆ - ‰ΩøÁî®ÂîØ‰∏ÄcommentÂâçÁºÄÊü•Êâæ
                    const groupEntries = entries.filter(e => e.comment && e.comment.startsWith("ÊâãÊú∫-Áæ§ËÅä-"));
                    console.log('ÊâæÂà∞ÁöÑÁæ§ËÅäÊù°ÁõÆÊï∞Èáè:', groupEntries.length);
                    
                    if (groupEntries.length === 0) {
                        console.log('Ê≤°ÊúâÊâæÂà∞Áæ§ËÅäÊù°ÁõÆÔºåÂáΩÊï∞ÊâßË°åÁªìÊùü');
                        return groups; // Êó¢ÁÑ∂Ê≤°ÊúâÁæ§ËÅäÔºåÂ∞±Áõ¥Êé•ËøîÂõû
                    }
                    
                    groupEntries.forEach(entry => {
                        if (entry && entry.content) {
                            console.log('>>> ÂºÄÂßãÂ§ÑÁêÜÁæ§ËÅäÊù°ÁõÆ:', entry.key);
                            
                            // ‰ªécomment‰∏≠ÊèêÂèñÂéüÂßãÁæ§ËÅäÂêçÁß∞ÔºåÁî®‰∫éÁîüÊàêÁ®≥ÂÆöÁöÑID
                            const originalGroupName = entry.comment.replace('ÊâãÊú∫-Áæ§ËÅä-', '');
                            const lines = entry.content.split('\n');
                            let groupData = null;
                            
                            for (const line of lines) {
                                const trimmed = line.trim();
                                if (trimmed.startsWith('[') && trimmed.endsWith(']')) {
                                    const name = trimmed.slice(1, -1);
                                    groupData = { 
                                        name, 
                                        type: 'group',
                                        // ‰ΩøÁî®comment‰∏≠ÁöÑÂéüÂßãÂêçÁß∞ÁîüÊàêIDÔºå‰øùÊåÅÁ®≥ÂÆöÊÄß
                                        id: `group_${originalGroupName.replace(/[^a-zA-Z0-9\u4e00-\u9fff]/g, '_')}`
                                    };
                                } else if (groupData && trimmed.includes('Á±ªÂûã=Áæ§ËÅä')) {
                                    continue;
                                } else if (groupData && trimmed.startsWith('ÊàêÂëò=')) {
                                    groupData.members = trimmed.substring(3).split(/[,Ôºå]/).map(m => m.trim()).filter(m => m);
                                } else if (groupData && trimmed.startsWith('ÊèèËø∞=')) {
                                    groupData.description = trimmed.substring(3);
                                } else if (groupData && trimmed.startsWith('Â§¥ÂÉè=')) {
                                    const avatarReference = trimmed.substring(3);
                                    if (avatarReference.startsWith('data:')) {
                                        groupData.avatar = avatarReference;
                                        groupData.avatarData = avatarReference;
                                    } else {
                                        groupData.avatar = avatarReference;
                                    }
                                }
                            }
                            
                            if (groupData && groupData.name && groupData.members && groupData.members.length > 0) {
                                console.log('Ëß£ÊûêÁæ§ËÅäÊï∞ÊçÆÊàêÂäü:', groupData.name);
                                groups.push(groupData);
                                
                                if (!QQ_Groups.includes(groupData.name)) {
                                    QQ_Groups.push(groupData.name);
                                }
                                
                                // **‰øÆÂ§çÔºöÊ£ÄÊü•Áæ§ËÅäÊòØÂê¶Â∑≤Âú®ÁïåÈù¢‰∏≠Â≠òÂú®ÔºåÈÅøÂÖçÈáçÂ§çÂàõÂª∫**
                                const existingGroupElement = $(`.QQ_home_usermsg[data-name='${groupData.name}'][data-group-type='true']`);
                                const groupAlreadyExists = existingGroupElement.length > 0;
                                
                                if (!QQ_msgjson.Áæ§ËÅä[groupData.name]) {
                                    QQ_msgjson.Áæ§ËÅä[groupData.name] = {
                                        members: groupData.members || [],
                                        msgs: []
                                    };
                                    console.log('Âú®QQ_msgjson.Áæ§ËÅä‰∏≠ÂàùÂßãÂåñÁæ§ËÅäÊï∞ÊçÆ:', groupData.name);
                                } else {
                                    console.log('Áæ§ËÅäÊï∞ÊçÆÂ∑≤Â≠òÂú®ÔºåÊõ¥Êñ∞ÊàêÂëòÂàóË°®:', groupData.name);
                                    QQ_msgjson.Áæ§ËÅä[groupData.name].members = groupData.members || [];
                                }
                                
                                // **‰øÆÂ§çÔºöÂè™ÊúâÂΩìÁæ§ËÅä‰∏çÂ≠òÂú®Êó∂ÊâçË∞ÉÁî®AddNewGroupÔºåÈÅøÂÖçÈáçÂ§çÂàõÂª∫ÂíåÁ≥ªÁªüÊ∂àÊÅØ**
                                if (!groupAlreadyExists) {
                                    console.log('Áæ§ËÅä‰∏çÂ≠òÂú®ÔºåË∞ÉÁî®AddNewGroupÂáΩÊï∞Ê∑ªÂä†Áæ§ËÅä:', groupData.name);
                                    AddNewGroup(groupData.name, groupData.avatar || 'https://files.catbox.moe/skngqq.jpg', groupData.members, groupData.description);
                                } else {
                                    console.log('Áæ§ËÅäÂ∑≤Â≠òÂú®‰∫éÁïåÈù¢‰∏≠ÔºåË∑≥ËøáAddNewGroupË∞ÉÁî®:', groupData.name);
                                }
                                
                                // *** ‰øÆÂ§çÔºöÂú®Âä†ËΩΩÁæ§ËÅäÂêéÁ´ãÂç≥Êõ¥Êñ∞ÊúÄÂêéÊ∂àÊÅØÊòæÁ§∫ ***
                                setTimeout(() => {
                                    updateGroupLastMessageDisplay(groupData.name);
                                }, 300);
                                
                               

                            } else {
                                console.log('Áæ§ËÅäÊï∞ÊçÆ‰∏çÂÆåÊï¥ÔºåË∑≥Ëøá„ÄÇËß£ÊûêÂà∞ÁöÑÊï∞ÊçÆ:', groupData);
                            }
                        }
                    });
                } catch (error) {
                    console.error('‰ªéÁã¨Á´ã‰∏ñÁïå‰π¶Êù°ÁõÆÂä†ËΩΩÁæ§ËÅäÊï∞ÊçÆÂ§±Ë¥•:', error);
                }
                
                console.log('‰ªéÁã¨Á´ã‰∏ñÁïå‰π¶Êù°ÁõÆÂä†ËΩΩÁæ§ËÅäÊï∞ÊçÆÂÆåÊàê:', groups.length, '‰∏™Áæ§ËÅä');
                console.log(`ÊúÄÁªàQQ_GroupsÂàóË°®:`, QQ_Groups);
                
                return groups;
            }
            
            // ÂàùÂßãÂåñÁæ§ËÅäÂäüËÉΩÁöÑÂáΩÊï∞
            function initGroupChatFeature() {
                console.log('Ê≠£Âú®ÂàùÂßãÂåñÁæ§ËÅäÂäüËÉΩ...');
                
                // ËÅîÁ≥ª‰∫∫È°µÈù¢ÁöÑ'+'ÊåâÈíÆ
                const contactsAddBtn = document.getElementById('contacts_add_btn');
                if (contactsAddBtn) {
                    console.log('ÊâæÂà∞ËÅîÁ≥ª‰∫∫È°µÈù¢ÁöÑ+ÊåâÈíÆÔºåÁªëÂÆö‰∫ã‰ª∂...');
                    contactsAddBtn.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('ËÅîÁ≥ª‰∫∫È°µÈù¢+ÊåâÈíÆË¢´ÁÇπÂáª');
                        showGroupChatModal();
                    };
                } else {
                    console.warn('Êú™ÊâæÂà∞ËÅîÁ≥ª‰∫∫È°µÈù¢ÁöÑ+ÊåâÈíÆ (ID: contacts_add_btn)');
                }
                
                // Ê∂àÊÅØÈ°µÈù¢ÁöÑ'+'ÊåâÈíÆ
                const messagesAddBtn = document.getElementById('messages_add_btn');
                if (messagesAddBtn) {
                    console.log('ÊâæÂà∞Ê∂àÊÅØÈ°µÈù¢ÁöÑ+ÊåâÈíÆÔºåÁªëÂÆö‰∫ã‰ª∂...');
                    messagesAddBtn.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Ê∂àÊÅØÈ°µÈù¢+ÊåâÈíÆË¢´ÁÇπÂáª');
                        showGroupChatModal();
                    };
                } else {
                    console.warn('Êú™ÊâæÂà∞Ê∂àÊÅØÈ°µÈù¢ÁöÑ+ÊåâÈíÆ (ID: messages_add_btn)');
                }
                
                // Áæ§ËÅäÂêçÁß∞ËæìÂÖ•Ê°Ü‰∫ã‰ª∂ÁõëÂê¨
                const groupNameInput = document.getElementById('group_name_input');
                if (groupNameInput) {
                    groupNameInput.addEventListener('input', updateConfirmButtonState);
                    groupNameInput.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' && !document.getElementById('group_confirm_btn').disabled) {
                            createGroupChat();
                        }
                    });
                }
                
                console.log('Áæ§ËÅäÂäüËÉΩÂàùÂßãÂåñÂÆåÊàê');
            }
            
            // Èò≤Ê≠¢ÈáçÂ§çÂä†ËΩΩÁöÑÊ†áÂøó
            let groupChatInitialized = false;
            
            // QQ_GroupsÊï∞ÁªÑ‰øùÊä§Êú∫Âà∂
            function protectQQGroups() {
                if (!Array.isArray(QQ_Groups)) {
                    console.warn('QQ_Groups‰∏çÊòØÊï∞ÁªÑÔºåÈáçÊñ∞ÂàùÂßãÂåñ');
                    QQ_Groups = [];
                }
                
                            // ÂÆöÊúüÊ£ÄÊü•QQ_GroupsÁöÑÂÆåÊï¥ÊÄßÔºà‰∏çÂÜçÈáçÊñ∞Âä†ËΩΩÔºåÂè™‰ªéÁïåÈù¢ÊÅ¢Â§çÔºâ
            setInterval(() => {
                if (groupChatInitialized && Array.isArray(QQ_Groups) && QQ_Groups.length === 0) {
                    console.log('ÂÆöÊúüÊ£ÄÊü•ÔºöQQ_Groups‰∏∫Á©∫ÔºåÂ∞ùËØï‰ªéÁïåÈù¢ÂÖÉÁ¥†ÊÅ¢Â§ç');
                    
                    // Âè™‰ªéÁé∞ÊúâÁïåÈù¢ÂÖÉÁ¥†ÊÅ¢Â§çQQ_GroupsÔºå‰∏çÈáçÊñ∞Âä†ËΩΩ
                    const contactsGroups = document.querySelectorAll('#QQ_home_chars [data-group-type="true"]');
                    const messageGroups = document.querySelectorAll('#QQ_message_list_chars [data-group-type="true"]');
                    
                    contactsGroups.forEach(element => {
                        const groupName = element.getAttribute('data-group-name');
                        if (groupName && !QQ_Groups.includes(groupName)) {
                            QQ_Groups.push(groupName);
                            console.log(`ÂÆöÊúüÊ£ÄÊü•Ôºö‰ªéËÅîÁ≥ª‰∫∫ÁïåÈù¢ÊÅ¢Â§çÁæ§ËÅä: ${groupName}`);
                        }
                    });
                    
                    messageGroups.forEach(element => {
                        const groupName = element.getAttribute('data-group-name');
                        if (groupName && !QQ_Groups.includes(groupName)) {
                            QQ_Groups.push(groupName);
                            console.log(`ÂÆöÊúüÊ£ÄÊü•Ôºö‰ªéÊ∂àÊÅØÁïåÈù¢ÊÅ¢Â§çÁæ§ËÅä: ${groupName}`);
                        }
                    });
                    
                    if (QQ_Groups.length > 0) {
                        console.log('ÂÆöÊúüÊ£ÄÊü•ÔºöQQ_GroupsÊÅ¢Â§çÂÆåÊàê:', QQ_Groups);
                    }
                }
            }, 30000); // ÊØè30ÁßíÊ£ÄÊü•‰∏ÄÊ¨°
            }
            
            // ÂêØÂä®‰øùÊä§Êú∫Âà∂
            protectQQGroups();
            
            // ÁÆÄÂåñÁöÑQQ_GroupsÂÆåÊï¥ÊÄßÊ£ÄÊü•Ôºà‰∏çÈáçÊñ∞Âä†ËΩΩÁæ§ËÅäÂà∞ÁïåÈù¢Ôºâ
            function ensureQQGroupsIntegrity() {
                if (groupChatInitialized && QQ_Groups.length === 0) {
                    console.warn('Ê£ÄÊµãÂà∞QQ_Groups‰∏∫Á©∫Ôºå‰ΩÜ‰∏çËá™Âä®ÈáçÊñ∞Âä†ËΩΩÔºàÈÅøÂÖçÈáçÂ§çÔºâ');
                    console.log('ÂΩìÂâçÈ°µÈù¢Áæ§ËÅäÂ∫îËØ•‰øùÊåÅÂèØËßÅÔºåÈóÆÈ¢òÂèØËÉΩÂú®ÂÖ∂‰ªñÂú∞Êñπ');
                    
                    // ‰ªÖÊ£ÄÊü•Áé∞ÊúâÁïåÈù¢ÂÖÉÁ¥†Âπ∂ÊÅ¢Â§çQQ_Groups
                    const contactsGroups = document.querySelectorAll('#QQ_home_chars [data-group-type="true"]');
                    const messageGroups = document.querySelectorAll('#QQ_message_list_chars [data-group-type="true"]');
                    
                    contactsGroups.forEach(element => {
                        const groupName = element.getAttribute('data-group-name');
                        if (groupName && !QQ_Groups.includes(groupName)) {
                            QQ_Groups.push(groupName);
                            console.log(`‰ªéËÅîÁ≥ª‰∫∫ÁïåÈù¢ÊÅ¢Â§çÁæ§ËÅäÂà∞QQ_Groups: ${groupName}`);
                        }
                    });
                    
                    messageGroups.forEach(element => {
                        const groupName = element.getAttribute('data-group-name');
                        if (groupName && !QQ_Groups.includes(groupName)) {
                            QQ_Groups.push(groupName);
                            console.log(`‰ªéÊ∂àÊÅØÁïåÈù¢ÊÅ¢Â§çÁæ§ËÅäÂà∞QQ_Groups: ${groupName}`);
                        }
                    });
                    
                    console.log('QQ_GroupsÊÅ¢Â§çÂêé:', QQ_Groups);
                }
            }
            
            // ÁÇπÂáªÁæ§ËÅäÊó∂ÁöÑÂÆåÊï¥ÊÄßÊ£ÄÊü•
            function ensureQQGroupsIntegrityOnClick(groupName) {
                console.log(`Áæ§ËÅä ${groupName} Ë¢´ÁÇπÂáªÔºåÊ£ÄÊü•QQ_GroupsÂÆåÊï¥ÊÄß`);
                
                // Á°Æ‰øùÁÇπÂáªÁöÑÁæ§ËÅäÂú®QQ_Groups‰∏≠
                if (!QQ_Groups.includes(groupName)) {
                    console.warn(`Áæ§ËÅä ${groupName} ‰∏çÂú®QQ_Groups‰∏≠ÔºåÊ∑ªÂä†‰∏≠...`);
                    QQ_Groups.push(groupName);
                }
                
                // Á°Æ‰øùQQ_msgjson‰∏≠ÊúâËØ•Áæ§ËÅäÁöÑÊï∞ÊçÆÁªìÊûÑ
                if (!QQ_msgjson.Áæ§ËÅä) {
                    QQ_msgjson.Áæ§ËÅä = {};
                }
                if (!QQ_msgjson.Áæ§ËÅä[groupName]) {
                    console.log(`Âú®QQ_msgjson.Áæ§ËÅä‰∏≠ÂàùÂßãÂåñÁæ§ËÅäÊï∞ÊçÆ: ${groupName}`);
                    QQ_msgjson.Áæ§ËÅä[groupName] = {
                        members: [],
                        msgs: []
                    };
                }
                
                console.log(`Áæ§ËÅä ${groupName} ÂÆåÊï¥ÊÄßÊ£ÄÊü•ÂÆåÊàê`);
            }
            
            // Áªü‰∏ÄÁöÑÂ§¥ÂÉèÂ§ÑÁêÜÂáΩÊï∞
            function processGroupAvatar(groupData) {
                console.log('Â§ÑÁêÜÁæ§Â§¥ÂÉè:', groupData.name, 'Â§¥ÂÉèÊï∞ÊçÆ:', groupData.avatar);
                
                // Áªü‰∏ÄÁöÑÂ§¥ÂÉèÊï∞ÊçÆÂ§ÑÁêÜÈÄªËæë
                let avatarDisplay = '';
                const avatarSrc = groupData.avatarData || groupData.avatar;
                
                if (avatarSrc && (avatarSrc.startsWith('data:') || avatarSrc.startsWith('http'))) {
                    // base64Êï∞ÊçÆÊàñÁΩëÁªúÈìæÊé•ÔºåÁõ¥Êé•‰ΩøÁî®
                    avatarDisplay = `<img src="${avatarSrc}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                    console.log('‰ΩøÁî®Â§¥ÂÉèÂõæÁâáÔºåÁ±ªÂûã:', avatarSrc.startsWith('data:') ? 'base64' : 'URL');
                } else {
                    // ÈªòËÆ§ÊòæÁ§∫"Áæ§"Â≠ó
                    avatarDisplay = 'Áæ§';
                    console.log('‰ΩøÁî®ÈªòËÆ§Áæ§Â≠óÂ§¥ÂÉè');
                }
                
                return avatarDisplay;
            }
            
            // Áªü‰∏ÄÁöÑÂàùÂßãÂåñÂáΩÊï∞
            async function initGroupChatOnce() {
                if (groupChatInitialized) {
                    console.log('Áæ§ËÅäÂäüËÉΩÂ∑≤ÂàùÂßãÂåñÔºåË∑≥ËøáÈáçÂ§çÂàùÂßãÂåñ');
                    return;
                }
                
                console.log('ÂºÄÂßãÂàùÂßãÂåñÁæ§ËÅäÂäüËÉΩ...');
                initGroupChatFeature();
                
                // Ê£ÄÊü•ÁïåÈù¢ÊòØÂê¶ÊúâÁæ§ËÅäÂÖÉÁ¥†
                const contactsGroups = document.querySelectorAll('#QQ_home_chars [data-group-type="true"]');
                const messageGroups = document.querySelectorAll('#QQ_message_list_chars [data-group-type="true"]');
                
                console.log('ÂΩìÂâçÁïåÈù¢Áä∂ÊÄÅÊ£ÄÊü•:');
                console.log('- QQ_GroupsÊï∞ÁªÑÈïøÂ∫¶:', QQ_Groups.length);
                console.log('- ËÅîÁ≥ª‰∫∫ÁïåÈù¢Áæ§ËÅäÂÖÉÁ¥†Êï∞Èáè:', contactsGroups.length);
                console.log('- Ê∂àÊÅØÁïåÈù¢Áæ§ËÅäÂÖÉÁ¥†Êï∞Èáè:', messageGroups.length);
                console.log('- worldbookÁä∂ÊÄÅ:', !!worldbook);
                console.log('- entriesÁä∂ÊÄÅ:', !!entries);
                
                // Â¶ÇÊûúÊúâÁæ§ËÅäÊï∞ÊçÆ‰ΩÜÁïåÈù¢Ê≤°ÊúâÊòæÁ§∫ÔºåÂº∫Âà∂ÈáçÊñ∞Âä†ËΩΩ
                if (worldbook && entries) {
                    if (QQ_Groups.length > 0 && contactsGroups.length === 0) {
                        console.log('ÂèëÁé∞Áæ§ËÅäÊï∞ÊçÆ‰ΩÜÁïåÈù¢Êú™ÊòæÁ§∫ÔºåÂº∫Âà∂ÈáçÊñ∞Âä†ËΩΩÂà∞ÁïåÈù¢');
                        await loadGroupChatsFromWorldbook();
                    } else if (QQ_Groups.length === 0) {
                        console.log('È¶ñÊ¨°ÂàùÂßãÂåñÔºö‰ªé‰∏ñÁïå‰π¶Âä†ËΩΩÁæ§ËÅä');
                        await loadGroupChatsFromWorldbook();
                    } else {
                        console.log('Áæ§ËÅäÊï∞ÊçÆÂíåÁïåÈù¢Áä∂ÊÄÅÊ≠£Â∏∏ÔºåË∑≥ËøáÂä†ËΩΩ');
                    }
                } else {
                    console.log('worldbookÊàñentriesÊú™ÂáÜÂ§áÂ•ΩÔºåË∑≥ËøáÁæ§ËÅäÂä†ËΩΩ');
                }
                
                groupChatInitialized = true;
                console.log('Áæ§ËÅäÂäüËÉΩÂàùÂßãÂåñÂÆåÊàê');
            }
            
            // ÈáçÁΩÆÁæ§ËÅäÂàùÂßãÂåñÁä∂ÊÄÅÔºàÁî®‰∫éË∞ÉËØïÔºâ
            window.resetGroupChatState = function() {
                groupChatInitialized = false;
                console.log('Áæ§ËÅäÁä∂ÊÄÅÂ∑≤ÈáçÁΩÆ');
            };
            
            // Âº∫Âà∂ÈáçÊñ∞Âä†ËΩΩÁæ§ËÅäÂà∞ÁïåÈù¢ÔºàÁî®‰∫éË∞ÉËØïÔºâ
            window.forceReloadGroupChats = async function() {
                console.log('Âº∫Âà∂ÈáçÊñ∞Âä†ËΩΩÁæ§ËÅä...');
                if (!worldbook || !entries) {
                    console.error('worldbookÊàñentriesÊú™ÂáÜÂ§áÂ•Ω');
                    return;
                }
                try {
                    await loadGroupChatsFromWorldbook();
                    console.log('Áæ§ËÅäÂº∫Âà∂ÈáçÊñ∞Âä†ËΩΩÂÆåÊàê');
                } catch (error) {
                    console.error('Âº∫Âà∂ÈáçÊñ∞Âä†ËΩΩÁæ§ËÅäÂ§±Ë¥•:', error);
                }
            };
            
            // Âçï‰∏ÄÁöÑÂàùÂßãÂåñË∞ÉÁî®ÁÇπ
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initGroupChatOnce);
            } else {
                // Âª∂ËøüÊâßË°åÔºåÁ°Æ‰øùworldbookÂíåentriesÈÉΩÂ∑≤ÂáÜÂ§áÂ•Ω
                setTimeout(initGroupChatOnce, 1000);
            }
            
            // Ê∑ªÂä†ÂÖ®Â±ÄÊµãËØïÂáΩÊï∞Ôºå‰æø‰∫éË∞ÉËØï
            window.testGroupChat = function() {
                console.log('ÊµãËØïÁæ§ËÅäÂäüËÉΩ...');
                showGroupChatModal();
            };
            
            // Ê∑ªÂä†ÈîÆÁõòÂø´Êç∑ÈîÆÊµãËØïÔºàCtrl+GÔºâ
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'g') {
                    e.preventDefault();
                    console.log('ÈÄöËøáÂø´Êç∑ÈîÆË∞ÉÁî®Áæ§ËÅäÂäüËÉΩ');
                    showGroupChatModal();
                }
            });
            
            // ==================== ËÅîÁ≥ª‰∫∫ÂàÜÁªÑÂäüËÉΩ ====================
            
            // ÂàÜÁªÑÊï∞ÊçÆÂ≠òÂÇ® - ‰ΩøÁî®varÈÅøÂÖçTDZÈóÆÈ¢ò
            var contactGroups = [];
            var draggedElement = null;
            var draggedFromGroup = null;
            
            /**
             * Ëé∑ÂèñÂΩìÂâçËßíËâ≤IDÁî®‰∫éÊï∞ÊçÆÈöîÁ¶ª
             */
            function getCurrentCharacterId() {
                try {
                    // ÊñπÂºè1Ôºö‰ºòÂÖà‰ΩøÁî®SillyTavernÁöÑcharacterId
                    if (window.SillyTavern && window.SillyTavern.characterId !== undefined) {
                        return window.SillyTavern.characterId;
                    }
                    
                    // ÊñπÂºè2ÔºöÂ∞ùËØïË∞ÉÁî®SillyTavernÁöÑgetContextÊñπÊ≥ï
                    if (window.SillyTavern && typeof window.SillyTavern.getContext === 'function') {
                        const context = window.SillyTavern.getContext();
                        if (context && context.characterId !== undefined) {
                            return context.characterId;
                        }
                    }
                    
                    // ÊñπÂºè3Ôºö‰ªéwindow.this_chidËé∑ÂèñÔºàÈÖíÈ¶ÜÂÜÖÈÉ®ÂèòÈáèÔºâ
                    if (window.this_chid !== undefined) {
                        return window.this_chid;
                    }
                    
                    // ÊñπÂºè4Ôºö‰ªéURLÂèÇÊï∞Ëé∑Âèñ
                    const urlParams = new URLSearchParams(window.location.search);
                    const charId = urlParams.get('charId') || urlParams.get('characterId');
                    if (charId) {
                        return charId;
                    }
                    
                    // ÊñπÂºè5Ôºö‰ΩøÁî®ÂΩìÂâçËßíËâ≤Âêç
                    if (window.currentCharacterName) {
                        return window.currentCharacterName;
                    }
                    
                    // ÊñπÂºè6Ôºö‰ªéheader‰∏≠ÁöÑËßíËâ≤ÂêçËé∑Âèñ
                    const headerName = document.querySelector('.QQ_home_nick')?.textContent?.trim();
                    if (headerName) {
                        return headerName;
                    }
                    
                    // ÊúÄÂêéÁöÑÂ§áÁî®ÊñπÊ°à
                    return 'default';
                } catch (error) {
                    console.warn('Ëé∑ÂèñËßíËâ≤IDÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§ÂÄº:', error);
                    return 'default';
                }
            }
            
            // ÂÖ®Â±ÄÂèòÈáèËÆ∞ÂΩïÂΩìÂâçËßíËâ≤IDÔºåÁî®‰∫éÊ£ÄÊµãËßíËâ≤ÂàáÊç¢
            let currentCharId = null;
            
            /**
             * Ê£ÄÊµãËßíËâ≤ÊòØÂê¶ÂàáÊç¢ÔºåÂ¶ÇÊûúÂàáÊç¢ÂàôÈáçÊñ∞Âä†ËΩΩÂàÜÁªÑÊï∞ÊçÆ
             */
            function checkCharacterChange() {
                const newCharId = getCurrentCharacterId();
                if (currentCharId !== newCharId) {
                    console.log(`Ê£ÄÊµãÂà∞ËßíËâ≤ÂàáÊç¢: ${currentCharId} -> ${newCharId}`);
                    currentCharId = newCharId;
                    loadGroupsFromStorage();
                    renderContactGroups();
                }
            }
            
            /**
             * Ëé∑ÂèñËßíËâ≤‰∏ìÂ±ûÁöÑÂàÜÁªÑÂ≠òÂÇ®key
             */
            function getCharacterGroupsKey() {
                const charId = getCurrentCharacterId();
                return `contactGroups_${charId}`;
            }
            
            /**
             * ‰ªé‰∏ñÁïå‰π¶Âä†ËΩΩÂàÜÁªÑÔºàÊåâËßíËâ≤ÈöîÁ¶ªÔºâ
             */
            function loadGroupsFromStorage() {
                try {
                    const charId = getCurrentCharacterId() || 'default';
                    console.log(`‰ªé‰∏ñÁïå‰π¶Âä†ËΩΩÂàÜÁªÑÔºåËßíËâ≤ID: ${charId}`);
                    
                    // ‰ΩøÁî®Êñ∞ÁöÑÁªü‰∏ÄÂä†ËΩΩÂáΩÊï∞
                    const groups = QQ_LoadContactGroupsFromWorldBook(charId);
                    
                    if (groups && Array.isArray(groups)) {
                        contactGroups.length = 0; // Ê∏ÖÁ©∫Áé∞ÊúâÊï∞ÁªÑ
                        contactGroups.push(...groups); // Ê∑ªÂä†‰ªé‰∏ñÁïå‰π¶Âä†ËΩΩÁöÑÊï∞ÊçÆ
                        console.log(`‰ªé‰∏ñÁïå‰π¶Âä†ËΩΩ‰∫Ü ${groups.length} ‰∏™ÂàÜÁªÑ`);
                    } else {
                        // Â∞ùËØï‰ªélocalStorageËøÅÁßªÊï∞ÊçÆ
                        console.log('‰∏ñÁïå‰π¶‰∏≠Ê≤°ÊúâÊâæÂà∞ÂàÜÁªÑÊï∞ÊçÆÔºåÂ∞ùËØï‰ªélocalStorageËøÅÁßª...');
                        const charGroupsKey = getCharacterGroupsKey();
                        const localStored = localStorage.getItem(charGroupsKey);
                        if (localStored) {
                            const localGroups = JSON.parse(localStored);
                            contactGroups.length = 0;
                            contactGroups.push(...localGroups);
                            console.log(`‰ªélocalStorageËøÅÁßª‰∫Ü ${localGroups.length} ‰∏™ÂàÜÁªÑÂà∞‰∏ñÁïå‰π¶`);
                            // Á´ãÂç≥‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶
                            setTimeout(() => saveGroupsToStorage(), 1000);
                        } else {
                            console.log('Ê≤°ÊúâÊâæÂà∞‰ªª‰ΩïÂàÜÁªÑÊï∞ÊçÆÔºå‰ΩøÁî®ÈªòËÆ§Á©∫Êï∞ÁªÑ');
                            contactGroups.length = 0;
                        }
                    }
                } catch (error) {
                    console.error('‰ªé‰∏ñÁïå‰π¶Âä†ËΩΩÂàÜÁªÑÊó∂Âá∫Èîô:', error);
                    contactGroups.length = 0;
                }
            }
            
            // Á´ãÂç≥ÂàùÂßãÂåñcontactGroups
            loadGroupsFromStorage();
            
            /**
             * ‰øùÂ≠òÂàÜÁªÑÂà∞‰∏ñÁïå‰π¶ÔºàÊåâËßíËâ≤ÈöîÁ¶ªÔºâ- ‰øÆÂ§çÁâà
             */
            async function saveGroupsToStorage() {
                try {
                    const charId = getCurrentCharacterId() || 'default';
                    console.log(`‰øùÂ≠òÂàÜÁªÑÂà∞‰∏ñÁïå‰π¶ÔºåËßíËâ≤ID: ${charId}`);
                    
                    // ‰ΩøÁî®Êñ∞ÁöÑÁªü‰∏Ä‰øùÂ≠òÂáΩÊï∞
                    const success = QQ_SaveContactGroupsToWorldBook(charId, contactGroups);
                    
                    if (success) {
                        console.log(`ËßíËâ≤ ${charId} ÁöÑÂàÜÁªÑÊï∞ÊçÆÂ∑≤‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶ÔºåÂÖ± ${contactGroups.length} ‰∏™ÂàÜÁªÑ`);
                    } else {
                        console.error('ÂàÜÁªÑÊï∞ÊçÆ‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶Â§±Ë¥•');
                    }
                } catch (error) {
                    console.error('‰øùÂ≠òÂàÜÁªÑÂà∞‰∏ñÁïå‰π¶Êó∂Âá∫Èîô:', error);
                }
            }
            
            /**
             * ÂàùÂßãÂåñÂàÜÁªÑÂäüËÉΩ
             */
            function initContactGroups() {
                // ÂàùÂßãÂåñÂΩìÂâçËßíËâ≤ID
                currentCharId = getCurrentCharacterId();
                
                loadGroupsFromStorage();
                renderContactGroups();
                initGroupDragAndDrop();
                
                // ÂêØÂä®ËßíËâ≤ÂàáÊç¢Ê£ÄÊµã
                setInterval(checkCharacterChange, 1000); // ÊØèÁßíÊ£ÄÊµã‰∏ÄÊ¨°ËßíËâ≤ÂàáÊç¢
                
                console.log(`ÂàÜÁªÑÂäüËÉΩÂ∑≤ÂàùÂßãÂåñÔºåÂΩìÂâçËßíËâ≤ID: ${currentCharId}`);
            }
            
            /**
             * ÂàùÂßãÂåñÊãñÊãΩÂäüËÉΩ
             */
            function initGroupDragAndDrop() {
                // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÊãñÊãΩÁõ∏ÂÖ≥ÁöÑÂàùÂßãÂåñ‰ª£Á†Å
                console.log('ÂàÜÁªÑÊãñÊãΩÂäüËÉΩÂ∑≤ÂàùÂßãÂåñ');
            }
            
            /**
             * ÊòæÁ§∫Êñ∞Âª∫ÂàÜÁªÑÂºπÁ™ó
             */
            function showNewGroupModal() {
                const modal = document.getElementById('new_group_modal');
                const input = document.getElementById('new_group_name_input');
                
                if (modal && input) {
                    modal.style.display = 'flex';
                    input.value = '';
                    input.focus();
                    
                    // Ê∑ªÂä†ËÉåÊôØÁÇπÂáªÂÖ≥Èó≠
                    modal.addEventListener('click', function(e) {
                        if (e.target === modal) {
                            closeNewGroupModal();
                        }
                    });
                }
            }
            
            /**
             * ÂÖ≥Èó≠Êñ∞Âª∫ÂàÜÁªÑÂºπÁ™ó
             */
            function closeNewGroupModal() {
                const modal = document.getElementById('new_group_modal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }
            
            /**
             * ÂàõÂª∫Êñ∞ÁöÑËÅîÁ≥ª‰∫∫ÂàÜÁªÑ
             */
            async function createNewContactGroup() {
                console.log('üÜï ÂºÄÂßãÂàõÂª∫Êñ∞ÂàÜÁªÑ...');
                
                // *** ÂÖ≥ÈîÆ‰ºòÂåñÔºöÂÖà‰ªé‰∏ñÁïå‰π¶ÈáçÊñ∞Âä†ËΩΩÂàÜÁªÑÊï∞ÊçÆ ***
                await QQ_ForceReloadContactGroups();
                
                const input = document.getElementById('new_group_name_input');
                if (!input) {
                    console.error('Êú™ÊâæÂà∞ÂàÜÁªÑÂêçÁß∞ËæìÂÖ•Ê°ÜÂÖÉÁ¥†');
                    alert('ÁïåÈù¢ÂÖÉÁ¥†Êú™ÊâæÂà∞ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
                    return;
                }
                
                const groupName = input.value.trim();
                if (!groupName) {
                    alert('ËØ∑ËæìÂÖ•ÂàÜÁªÑÂêçÁß∞');
                    return;
                }
                
                // Ê£ÄÊü•ÂàÜÁªÑÂêçÊòØÂê¶ÈáçÂ§ç
                if (contactGroups.some(group => group.name === groupName)) {
                    alert('ÂàÜÁªÑÂêçÁß∞Â∑≤Â≠òÂú®');
                    return;
                }
                
                // ÂàõÂª∫Êñ∞ÂàÜÁªÑ
                const newGroup = {
                    id: 'group_' + Date.now(),
                    name: groupName,
                    contacts: [],
                    collapsed: false,
                    order: contactGroups.length
                };
                
                contactGroups.push(newGroup);
                await saveGroupsToStorage();
                renderContactGroups();
                closeNewGroupModal();
                
                console.log('ÂàõÂª∫Êñ∞ÂàÜÁªÑÊàêÂäü:', newGroup);
                alert('ÂàÜÁªÑ"' + groupName + '"ÂàõÂª∫ÊàêÂäüÔºÅ');
            }
            
            /**
             * Â§ÑÁêÜÊñ∞Âª∫ÂàÜÁªÑËæìÂÖ•Ê°ÜÁöÑÊåâÈîÆ‰∫ã‰ª∂
             */
            function handleNewGroupKeydown(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    createNewContactGroup();
                } else if (event.key === 'Escape') {
                    event.preventDefault();
                    closeNewGroupModal();
                }
            }
            
            // Á°Æ‰øùÂáΩÊï∞ÂÖ®Â±ÄÂèØÁî®
            window.createNewContactGroup = createNewContactGroup;
            window.closeNewGroupModal = closeNewGroupModal;
            window.showNewGroupModal = showNewGroupModal;
            window.handleNewGroupKeydown = handleNewGroupKeydown;
            window.openContactGroupModal = openContactGroupModal;
            
            /**
             * Ê∏≤ÊüìÂàÜÁªÑÁïåÈù¢
             */
            async function renderContactGroups() {
                const contactsContainer = document.getElementById('QQ_home_chars');
                if (!contactsContainer) return;
                
                // *** ÂÖ≥ÈîÆ‰ºòÂåñÔºöÊ∏≤ÊüìÂâçÂÖà‰ªé‰∏ñÁïå‰π¶ÈáçÊñ∞Âä†ËΩΩÂàÜÁªÑÊï∞ÊçÆ ***
                await QQ_ForceReloadContactGroups();

                // ‰ΩøÁî®jQueryÊù•‰øùÂ≠òÁæ§ËÅäÂíåÁßÅËÅäËÅîÁ≥ª‰∫∫ÔºåÁ°Æ‰øù‰∫ã‰ª∂ÁªëÂÆö‰∏ç‰∏¢Â§±
                const $originalGroupChats = $(contactsContainer).find('.QQ_home_usermsg[data-group-type="true"]');
                const $originalContacts = $(contactsContainer).find('.QQ_home_usermsg:not([data-group-type="true"])');

                // Ê∏ÖÁ©∫ÂÆπÂô®Ôºå‰ΩÜÁî®jQueryÁöÑÊñπÂºè
                $(contactsContainer).empty();

                // Ê≠•È™§1: Á´ãÂç≥Â∞ÜÁæ§ËÅäÈáçÊñ∞Ê∑ªÂä†ÂõûÂéªÔºåÁ°Æ‰øùÂÆÉ‰ª¨ÊÄªÂú®ÊúÄ‰∏äÊñπ
                if ($originalGroupChats.length > 0) {
                    const $groupChatSection = $('<div></div>');
                    $originalGroupChats.each(function() {
                        // ‰ΩøÁî®jQueryÁöÑdetach()ÂíåappendTo()Êù•‰øùÊåÅ‰∫ã‰ª∂ÁªëÂÆö
                        $(this).appendTo($groupChatSection);
                    });
                    $groupChatSection.appendTo($(contactsContainer));
                }

                // Ê≠•È™§2: Ê∏≤ÊüìÁßÅËÅäÁöÑËá™ÂÆö‰πâÂàÜÁªÑ
                contactGroups.sort((a, b) => a.order - b.order).forEach(group => {
                    const groupElement = createGroupElement(group);
                    contactsContainer.appendChild(groupElement);
                });

                // Ê≠•È™§3: Ê∏≤ÊüìÊú™ÂàÜÁªÑÁöÑÁßÅËÅäËÅîÁ≥ª‰∫∫
                const $ungroupedContacts = $originalContacts.filter(function() {
                    const contactName = $(this).find('.QQ_home_name').text().trim();
                    return !isContactInAnyGroup(contactName);
                });

                if ($ungroupedContacts.length > 0) {
                    const $ungroupedSection = $(`
                        <div class="ungrouped-contacts">
                            <div class="ungrouped-header">Êú™ÂàÜÁªÑËÅîÁ≥ª‰∫∫</div>
                        </div>
                    `);
                    
                    const $dropZone = $('<div class="drop-zone ungrouped-drop-zone" data-group-id="ungrouped"></div>');

                    $ungroupedContacts.each(function() {
                        $(this).attr('draggable', 'true');
                        $(this).appendTo($ungroupedSection);
                    });

                    $dropZone.appendTo($ungroupedSection);
                    $ungroupedSection.appendTo($(contactsContainer));
                }
            }
            
            /**
             * ÂàõÂª∫ÂàÜÁªÑÂÖÉÁ¥†
             */
            function createGroupElement(group) {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'contact-group';
                groupDiv.setAttribute('data-group-id', group.id);
                
                const isCollapsed = group.collapsed;
                const contactCount = group.contacts.length;
                
                groupDiv.innerHTML = `
                    <div class="group-header" onclick="toggleGroup('${group.id}')">
                        <span class="group-drag-handle" onmousedown="startGroupDrag(event, '${group.id}')">‚ãÆ‚ãÆ</span>
                        <span class="group-toggle ${isCollapsed ? 'collapsed' : ''}">‚ñº</span>
                        <span class="group-name" onclick="editGroupName(event, '${group.id}')" data-group-id="${group.id}">${group.name}</span>
                        <span class="group-count">${contactCount}</span>
                        <span class="group-delete-btn" onclick="deleteContactGroup(event, '${group.id}')">√ó</span>
                    </div>
                    <div class="group-content ${isCollapsed ? 'collapsed' : 'expanded'}">
                        ${group.contacts.map(contact => {
                            // Á°Æ‰øùËÅîÁ≥ª‰∫∫ÂèØ‰ª•ÊãñÊãΩ
                            const contactHtml = contact.html.replace(
                                'class="QQ_home_usermsg"',
                                'class="QQ_home_usermsg" draggable="true"'
                            );
                            return contactHtml;
                        }).join('')}
                    </div>
                    <div class="drop-zone" data-group-id="${group.id}"></div>
                `;
                
                return groupDiv;
            }
            
            /**
             * Ê£ÄÊü•ËÅîÁ≥ª‰∫∫ÊòØÂê¶Âú®‰ªª‰ΩïÂàÜÁªÑ‰∏≠
             */
            function isContactInAnyGroup(contactName) {
                return contactGroups.some(group => 
                    group.contacts.some(contact => contact.name === contactName)
                );
            }
            
            /**
             * ÂàáÊç¢ÂàÜÁªÑÊäòÂè†Áä∂ÊÄÅ
             */
            async function toggleGroup(groupId) {
                // *** ÂÖ≥ÈîÆ‰ºòÂåñÔºöÂÖà‰ªé‰∏ñÁïå‰π¶ÈáçÊñ∞Âä†ËΩΩÂàÜÁªÑÊï∞ÊçÆ ***
                await QQ_ForceReloadContactGroups();
                
                const group = contactGroups.find(g => g.id === groupId);
                if (!group) return;
                
                group.collapsed = !group.collapsed;
                await saveGroupsToStorage();
                
                const groupElement = document.querySelector(`[data-group-id="${groupId}"]`);
                const toggle = groupElement.querySelector('.group-toggle');
                const content = groupElement.querySelector('.group-content');
                
                if (group.collapsed) {
                    toggle.classList.add('collapsed');
                    content.classList.remove('expanded');
                    content.classList.add('collapsed');
                } else {
                    toggle.classList.remove('collapsed');
                    content.classList.remove('collapsed');
                    content.classList.add('expanded');
                }
            }
            
            /**
             * ÁºñËæëÂàÜÁªÑÂêçÁß∞
             */
            function editGroupName(event, groupId) {
                event.stopPropagation();
                
                const groupNameElement = event.target;
                const currentName = groupNameElement.textContent;
                
                // ÂàõÂª∫ËæìÂÖ•Ê°Ü
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentName;
                input.className = 'group-name editing';
                input.maxLength = 15;
                
                // ÊõøÊç¢ÂÖÉÁ¥†
                groupNameElement.replaceWith(input);
                input.focus();
                input.select();
                
                // Â§ÑÁêÜ‰øùÂ≠ò
                const saveEdit = async () => {
                    const newName = input.value.trim();
                    if (newName && newName !== currentName) {
                        // *** ÂÖ≥ÈîÆ‰ºòÂåñÔºöÂÖà‰ªé‰∏ñÁïå‰π¶ÈáçÊñ∞Âä†ËΩΩÂàÜÁªÑÊï∞ÊçÆ ***
                        await QQ_ForceReloadContactGroups();
                        
                        // Ê£ÄÊü•ÈáçÂêç
                        if (contactGroups.some(g => g.id !== groupId && g.name === newName)) {
                            alert('ÂàÜÁªÑÂêçÁß∞Â∑≤Â≠òÂú®');
                            input.focus();
                            return;
                        }
                        
                        // Êõ¥Êñ∞ÂàÜÁªÑÂêç
                        const group = contactGroups.find(g => g.id === groupId);
                        if (group) {
                            group.name = newName;
                            console.log(`üè∑Ô∏è ÂàÜÁªÑÈáçÂëΩÂêç: ${currentName} ‚Üí ${newName}`);
                            await saveGroupsToStorage();
                        }
                    }
                    
                    // ÊÅ¢Â§çÊòæÁ§∫
                    const newSpan = document.createElement('span');
                    newSpan.className = 'group-name';
                    newSpan.setAttribute('data-group-id', groupId);
                    newSpan.textContent = newName || currentName;
                    newSpan.onclick = (e) => editGroupName(e, groupId);
                    input.replaceWith(newSpan);
                };
                
                // ÁªëÂÆö‰∫ã‰ª∂
                input.addEventListener('blur', saveEdit);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        saveEdit();
                    } else if (e.key === 'Escape') {
                        const newSpan = document.createElement('span');
                        newSpan.className = 'group-name';
                        newSpan.setAttribute('data-group-id', groupId);
                        newSpan.textContent = currentName;
                        newSpan.onclick = (e) => editGroupName(e, groupId);
                        input.replaceWith(newSpan);
                    }
                });
            }
            
            /**
             * Âà†Èô§ËÅîÁ≥ª‰∫∫ÂàÜÁªÑ
             */
            async function deleteContactGroup(event, groupId) {
                event.stopPropagation();
                
                // *** ÂÖ≥ÈîÆ‰ºòÂåñÔºöÂÖà‰ªé‰∏ñÁïå‰π¶ÈáçÊñ∞Âä†ËΩΩÂàÜÁªÑÊï∞ÊçÆ ***
                await QQ_ForceReloadContactGroups();
                
                const group = contactGroups.find(g => g.id === groupId);
                if (!group) return;
                
                if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÂàÜÁªÑ"${group.name}"ÂêóÔºü\nÂàÜÁªÑ‰∏≠ÁöÑËÅîÁ≥ª‰∫∫Â∞ÜÁßªÂä®Âà∞Êú™ÂàÜÁªÑÂå∫Âüü„ÄÇ`)) {
                    console.log(`üóëÔ∏è Âà†Èô§ÂàÜÁªÑ: ${group.name} (${group.contacts.length}‰∫∫)`);
                    // ÁßªÈô§ÂàÜÁªÑ
                    contactGroups = contactGroups.filter(g => g.id !== groupId);
                    await saveGroupsToStorage();
                    renderContactGroups();
                }
            }
            
            /**
             * ÂàùÂßãÂåñÊãñÊãΩÂäüËÉΩ
             */
            function initGroupDragAndDrop() {
                // Ê∑ªÂä†ËÅîÁ≥ª‰∫∫ÊãñÊãΩÊîØÊåÅ
                document.addEventListener('dragstart', handleContactDragStart);
                document.addEventListener('dragover', handleDragOver);
                document.addEventListener('drop', handleContactDrop);
                document.addEventListener('dragend', handleDragEnd);
                
                // ‰∏∫Áé∞ÊúâËÅîÁ≥ª‰∫∫Ê∑ªÂä†ÊãñÊãΩÂ±ûÊÄß
                setTimeout(() => {
                    const contacts = document.querySelectorAll('.QQ_home_usermsg:not([data-group-type])');
                    contacts.forEach(contact => {
                        contact.draggable = true;
                        contact.addEventListener('dragstart', handleContactDragStart);
                    });
                }, 200);
                
                console.log('ÊãñÊãΩÂäüËÉΩÂàùÂßãÂåñÂÆåÊàê');
            }
            
            /**
             * ËÅîÁ≥ª‰∫∫ÊãñÊãΩÂºÄÂßã
             */
            function handleContactDragStart(event) {
                const contact = event.target.closest('.QQ_home_usermsg');
                if (!contact) return;
                
                draggedElement = contact;
                contact.classList.add('dragging');
                
                // Êü•ÊâæËÅîÁ≥ª‰∫∫ÂΩìÂâçÊâÄÂú®ÁöÑÂàÜÁªÑ
                const groupContent = contact.closest('.group-content');
                if (groupContent) {
                    const groupElement = groupContent.closest('.contact-group');
                    draggedFromGroup = groupElement ? groupElement.getAttribute('data-group-id') : null;
                } else {
                    draggedFromGroup = null; // Êù•Ëá™Êú™ÂàÜÁªÑÂå∫Âüü
                }
                
                // ÊòæÁ§∫ÊâÄÊúâÊãñÊãΩÁõÆÊ†áÂå∫Âüü
                document.querySelectorAll('.drop-zone').forEach(zone => {
                    zone.classList.add('active');
                });
                
                event.dataTransfer.effectAllowed = 'move';
            }
            
            /**
             * ÊãñÊãΩÊÇ¨ÂÅúÂ§ÑÁêÜ
             */
            function handleDragOver(event) {
                event.preventDefault();
                event.dataTransfer.dropEffect = 'move';
                
                const dropZone = event.target.closest('.drop-zone');
                if (dropZone) {
                    dropZone.style.borderColor = '#199AFF';
                    dropZone.style.backgroundColor = 'rgba(25, 154, 255, 0.2)';
                }
            }
            
            /**
             * ËÅîÁ≥ª‰∫∫ÊãñÊãΩÊîæÁΩÆ
             */
            async function handleContactDrop(event) {
                event.preventDefault();
                
                const dropZone = event.target.closest('.drop-zone');
                if (!dropZone || !draggedElement) return;
                
                // *** ÂÖ≥ÈîÆ‰ºòÂåñÔºöÂÖà‰ªé‰∏ñÁïå‰π¶ÈáçÊñ∞Âä†ËΩΩÂàÜÁªÑÊï∞ÊçÆ ***
                await QQ_ForceReloadContactGroups();
                
                const targetGroupId = dropZone.getAttribute('data-group-id');
                const contactName = draggedElement.querySelector('.QQ_home_name')?.textContent?.trim();
                
                if (!contactName) return;
                
                console.log(`üîÑ ÊãñÊãΩËÅîÁ≥ª‰∫∫: ${contactName} ‚Üí ${targetGroupId === 'ungrouped' ? 'Êú™ÂàÜÁªÑ' : 'ÂàÜÁªÑ'}`);
                
                // ‰ªéÂéüÂàÜÁªÑ‰∏≠ÁßªÈô§ËÅîÁ≥ª‰∫∫
                if (draggedFromGroup) {
                    const fromGroup = contactGroups.find(g => g.id === draggedFromGroup);
                    if (fromGroup) {
                        fromGroup.contacts = fromGroup.contacts.filter(c => c.name !== contactName);
                        console.log(`üì§ ‰ªéÂàÜÁªÑ "${fromGroup.name}" ÁßªÈô§ "${contactName}"`);
                    }
                }
                
                // Â§ÑÁêÜÁõÆÊ†á‰ΩçÁΩÆ
                if (targetGroupId === 'ungrouped') {
                    // ÊãñÊãΩÂà∞Êú™ÂàÜÁªÑÂå∫ÂüüÔºå‰∏çÈúÄË¶ÅÊ∑ªÂä†Âà∞‰ªª‰ΩïÂàÜÁªÑ
                    console.log(`üìç ËÅîÁ≥ª‰∫∫ "${contactName}" Â∑≤ÁßªÂä®Âà∞Êú™ÂàÜÁªÑÂå∫Âüü`);
                } else {
                    // Ê∑ªÂä†Âà∞ÁõÆÊ†áÂàÜÁªÑ
                    const targetGroup = contactGroups.find(g => g.id === targetGroupId);
                    if (targetGroup) {
                        // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÂ≠òÂú®
                        if (!targetGroup.contacts.some(c => c.name === contactName)) {
                            targetGroup.contacts.push({
                                name: contactName,
                                html: draggedElement.outerHTML
                            });
                            console.log(`üì• Ê∑ªÂä† "${contactName}" Âà∞ÂàÜÁªÑ "${targetGroup.name}"`);
                        }
                    }
                }
                
                // ‰øùÂ≠òÂπ∂ÈáçÊñ∞Ê∏≤Êüì
                await saveGroupsToStorage();
                renderContactGroups();
                
                // ÈáçÊñ∞ÂàùÂßãÂåñÊãñÊãΩÂäüËÉΩ
                setTimeout(() => {
                    initGroupDragAndDrop();
                }, 100);
            }
            
            /**
             * ÊãñÊãΩÁªìÊùüÂ§ÑÁêÜ
             */
            function handleDragEnd(event) {
                // Ê∏ÖÁêÜÊãñÊãΩÁä∂ÊÄÅ
                if (draggedElement) {
                    draggedElement.classList.remove('dragging');
                    draggedElement = null;
                }
                draggedFromGroup = null;
                
                // ÈöêËóèÊâÄÊúâÊãñÊãΩÁõÆÊ†áÂå∫Âüü
                document.querySelectorAll('.drop-zone').forEach(zone => {
                    zone.classList.remove('active');
                    zone.style.borderColor = '';
                    zone.style.backgroundColor = '';
                });
            }
            
            /**
             * ÂºÄÂßãÂàÜÁªÑÊãñÊãΩ
             */
            function startGroupDrag(event, groupId) {
                event.stopPropagation();
                // ÂàÜÁªÑÊãñÊãΩÂäüËÉΩÂ∞ÜÂú®ÂêéÁª≠ÂÆûÁé∞
                console.log('ÂºÄÂßãÊãñÊãΩÂàÜÁªÑ:', groupId);
            }
            
            /**
             * ‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩÂàÜÁªÑÊï∞ÊçÆ
             */
            function loadGroupsFromStorage() {
                try {
                    const stored = localStorage.getItem('contact_groups');
                    if (stored) {
                        contactGroups = JSON.parse(stored);
                    }
                } catch (error) {
                    console.error('Âä†ËΩΩÂàÜÁªÑÊï∞ÊçÆÂ§±Ë¥•:', error);
                    contactGroups = [];
                }
            }
            
            /**
             * ‰øùÂ≠òÂàÜÁªÑÊï∞ÊçÆÂà∞Êú¨Âú∞Â≠òÂÇ®
             */
            function saveGroupsToStorage() {
                try {
                    localStorage.setItem('contact_groups', JSON.stringify(contactGroups));
                } catch (error) {
                    console.error('‰øùÂ≠òÂàÜÁªÑÊï∞ÊçÆÂ§±Ë¥•:', error);
                }
            }
            
            /**
             * Â§ÑÁêÜÊñ∞Âª∫ÂàÜÁªÑÁöÑÈîÆÁõò‰∫ã‰ª∂
             */
            function handleNewGroupKeydown(event) {
                if (event.key === 'Enter') {
                    createNewContactGroup();
                } else if (event.key === 'Escape') {
                    closeNewGroupModal();
                }
            }

            // ==================== ÂàÜÁªÑÂºπÁ™óÁÆ°ÁêÜÂäüËÉΩ ====================
            
            /**
             * ÊâìÂºÄÂàÜÁªÑÁÆ°ÁêÜÂºπÁ™ó
             */
            function openContactGroupModal() {
                closeGroupChatModal();
                setTimeout(() => {
                    showNewGroupModal();
                }, 150);
            }

            // ==================== Áæ§ËÅäÂ§¥ÂÉèËÆæÁΩÆÂäüËÉΩ ====================
            
            let selectedAvatarData = null; // Â≠òÂÇ®ÈÄâ‰∏≠ÁöÑÂ§¥ÂÉèÊï∞ÊçÆ
            
            // ==================== Áæ§ËÅäÂäüËÉΩÂ¢ûÂº∫ ====================
            
            /**
             * Â§ÑÁêÜËÅäÂ§©Ê†áÈ¢òÁÇπÂáª - ÊòæÁ§∫Áæ§ÊàêÂëòÂàóË°®
             */
            function handleChatTitleClick(element) {
                console.log('=== handleChatTitleClick Ë¢´Ë∞ÉÁî® ===');
                
                // *** Ë∞ÉËØïÔºöÊ£ÄÊü•DOMÂÖÉÁ¥†ÁöÑÁõ∏ÂÖ≥Â±ûÊÄß ***
                console.log('ÁÇπÂáªÁöÑËÅäÂ§©Ê†áÈ¢ò:', element.textContent.trim());
                console.log('ÂÖÉÁ¥†Êï∞ÊçÆÂ±ûÊÄß:', {
                    'data-name': element.getAttribute('data-name'),
                    'data-group-id': element.getAttribute('data-group-id')
                });
                
                const chatPageContainer = element.closest('.QQ_chat_page');
                if (!chatPageContainer) {
                    console.log('Êú™ÊâæÂà∞ËÅäÂ§©È°µÈù¢ÂÆπÂô®');
                    return;
                }
                
                console.log('ËÅäÂ§©È°µÈù¢ÂÆπÂô®:', chatPageContainer);
                console.log('ËÅäÂ§©È°µÈù¢ÂÆπÂô®ÁöÑdata-name:', chatPageContainer.getAttribute('data-name'));
                console.log('ËÅäÂ§©È°µÈù¢ÂÆπÂô®ÁöÑdata-group-id:', chatPageContainer.getAttribute('data-group-id'));
                
                // *** Ë∞ÉËØïÊó•ÂøóÔºöÊ£ÄÊü•Â§öÁßçËé∑ÂèñËÅäÂ§©ÂêçÁß∞ÁöÑÊñπÂºè ***
                const chatName = element.textContent.trim();
                const dataName = element.getAttribute('data-name') || chatPageContainer.getAttribute('data-name');
                const groupId = element.getAttribute('data-group-id') || chatPageContainer.getAttribute('data-group-id');
                
                console.log('=== ËÅäÂ§©ÂêçÁß∞Ëé∑ÂèñË∞ÉËØï ===');
                console.log('‰ªétextContentËé∑ÂèñÁöÑÂêçÁß∞:', chatName);
                console.log('‰ªédata-nameÂ±ûÊÄßËé∑ÂèñÁöÑÂêçÁß∞:', dataName);
                console.log('‰ªédata-group-idÂ±ûÊÄßËé∑ÂèñÁöÑID:', groupId);
                
                // *** Ë∞ÉËØïÊó•ÂøóÔºöÊ£ÄÊü•ÂÖ®Â±ÄÁæ§ËÅäÊï∞ÊçÆ ***
                console.log('=== ÂÖ®Â±ÄÊï∞ÊçÆË∞ÉËØï ===');
                console.log('QQ_GroupsÊï∞ÁªÑ:', window.QQ_Groups);
                if (window.QQ_Groups && Array.isArray(window.QQ_Groups)) {
                    const matchingGroups = window.QQ_Groups.filter(g => 
                        g.name === chatName || 
                        g.name === dataName || 
                        g.id === groupId ||
                        chatName.includes(g.name) ||
                        (dataName && dataName.includes(g.name))
                    );
                    console.log('ÂåπÈÖçÁöÑÁæ§ËÅäÊï∞ÊçÆ:', matchingGroups);
                }
                
                console.log('ÊúÄÁªà‰ΩøÁî®ÁöÑËÅäÂ§©ÂêçÁß∞:', chatName);
                
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÁæ§ËÅä
                const isGroupChat = checkIfGroupChat(chatName);
                if (isGroupChat) {
                    // Áæ§ËÅäÈÄªËæë
                const cleanGroupName = chatName.replace(/\s*\(\d+‰∫∫\)\s*$/, '').trim();
                
                // ‰ªéQQ_msgjson.Áæ§ËÅä‰∏≠Ëé∑ÂèñÁæ§ËÅäÊï∞ÊçÆ
                let groupData = null;
                if (QQ_msgjson && QQ_msgjson.Áæ§ËÅä && QQ_msgjson.Áæ§ËÅä[cleanGroupName]) {
                    const msgGroupData = QQ_msgjson.Áæ§ËÅä[cleanGroupName];
                    groupData = {
                        name: cleanGroupName,
                        members: msgGroupData.members || [],
                        avatar: 'https://files.catbox.moe/skngqq.jpg' // ÈªòËÆ§Â§¥ÂÉè
                    };
                }
                
                // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞Áæ§ËÅäÊï∞ÊçÆÔºåÂàõÂª∫‰∏Ä‰∏™Âü∫Êú¨ÁöÑÊï∞ÊçÆÁªìÊûÑ
                if (!groupData) {
                    groupData = {
                        name: cleanGroupName,
                        members: ['ÊàêÂëò1', 'ÊàêÂëò2', 'ÊàêÂëò3'], // Á§∫‰æãÊàêÂëò
                        avatar: 'https://files.catbox.moe/skngqq.jpg'
                    };
                    console.warn(`Áæ§ËÅä ${cleanGroupName} Êï∞ÊçÆÊú™ÊâæÂà∞Ôºå‰ΩøÁî®ÈªòËÆ§Êï∞ÊçÆ`);
                }
                
                // Ë∞ÉÁî®Áæ§ËÅäÁÆ°ÁêÜËèúÂçï
                console.log('ÊòæÁ§∫Áæ§ËÅäÁÆ°ÁêÜËèúÂçï:', groupData);
                showGroupManagementMenu(groupData, element);
                } else {
                    // ÁßÅËÅäÈÄªËæë - ÂÖàÊòæÁ§∫ËßíËâ≤Á≤æÁÅµ
                    console.log('ËøôÊòØÁßÅËÅäÔºåÊòæÁ§∫ËßíËâ≤Á≤æÁÅµ');
                    QQ_ShowCharacterSpirit(chatName);
                }
            }
            
            /**
             * Ê£ÄÊü•ÊòØÂê¶‰∏∫Áæ§ËÅäÔºàÁªü‰∏Ä‰ΩøÁî®QQ_GroupsÊï∞ÁªÑÔºâ
             */
            function checkIfGroupChat(chatName) {
                // ÁßªÈô§Ê†áÈ¢ò‰∏≠ÁöÑ‰∫∫Êï∞‰ø°ÊÅØÔºåÂè™‰øùÁïôÁæ§Âêç
                const cleanChatName = chatName.replace(/\s*\(\d+‰∫∫\)\s*$/, '').trim();
                
                // ‰ΩøÁî®QQ_GroupsÊï∞ÁªÑÊ£ÄÊü•ÔºåÁ°Æ‰øù‰∏éÂÖ∂‰ªñÂú∞ÊñπÁöÑÈÄªËæë‰∏ÄËá¥
                return QQ_Groups.includes(cleanChatName);
            }
            
            /**
             * Âä†ËΩΩÁæ§ÊàêÂëòÂàóË°®
             */
            function loadGroupMembers(groupName, memberListContainer) {
                // Ëé∑ÂèñÁæ§ÊàêÂëòÊï∞ÊçÆÔºàËøôÈáåÂèØ‰ª•‰ªélocalStorageÊàñÂÖ∂‰ªñÊï∞ÊçÆÊ∫êËé∑ÂèñÔºâ
                const groupMembers = getGroupMembers(groupName);
                
                // Ê∏ÖÁ©∫ÂÆπÂô®
                memberListContainer.innerHTML = '';
                
                if (groupMembers.length === 0) {
                    memberListContainer.innerHTML = '<div class="no-members">ÊöÇÊó†Áæ§ÊàêÂëò</div>';
                    return;
                }
                
                // Ê∏≤ÊüìÊàêÂëòÂàóË°®
                groupMembers.forEach(member => {
                    const memberItem = document.createElement('div');
                    memberItem.className = 'group-member-item';
                    memberItem.innerHTML = `
                        <div class="member-avatar" style="background-image: url('${member.avatar}')"></div>
                        <div class="member-name">${member.name}</div>
                    `;
                    memberListContainer.appendChild(memberItem);
                });
            }
            
            /**
             * Ëé∑ÂèñÁæ§ÊàêÂëòÊï∞ÊçÆÔºà‰ªéQQ_msgjson.Áæ§ËÅä‰∏≠Ëé∑ÂèñÔºâ
             */
            function getGroupMembers(groupName) {
                // ÁßªÈô§ÂèØËÉΩÁöÑ‰∫∫Êï∞Ê†áËØÜ
                const cleanGroupName = groupName.replace(/\s*\(\d+‰∫∫\)\s*$/, '').trim();
                
                try {
                    // Áõ¥Êé•‰ªéQQ_msgjson.Áæ§ËÅä‰∏≠Ëé∑ÂèñÁæ§ËÅäÊï∞ÊçÆ
                    if (QQ_msgjson && QQ_msgjson.Áæ§ËÅä && QQ_msgjson.Áæ§ËÅä[cleanGroupName]) {
                        const groupData = QQ_msgjson.Áæ§ËÅä[cleanGroupName];
                        
                        if (groupData.members && Array.isArray(groupData.members)) {
                            console.log(`‰ªéQQ_msgjsonËé∑ÂèñÁæ§ÊàêÂëò: ${cleanGroupName}`, groupData.members);
                            
                            // Ëé∑ÂèñÈöèÊú∫Â§¥ÂÉèÂàóË°®
                            const avatarList = QQ_RandomHeadList || [
                                'http://sharkpan.xyz/f/EJeUD/Image_1737026320652.jpg',
                                'http://sharkpan.xyz/f/Y8pt1/Image_1737026296736.jpg',
                                'http://sharkpan.xyz/f/QWWc6/Image_1737026308451.jpg',
                                'http://sharkpan.xyz/f/Z8LIW/Image_1737026306601.jpg',
                                'http://sharkpan.xyz/f/W8lhW/Image_1737026313246.jpg'
                            ];
                            
                            return groupData.members.map((memberName, index) => ({
                                name: memberName,
                                avatar: avatarList[index % avatarList.length]
                            }));
                        }
                    }
                    
                    console.warn(`Áæ§ËÅä ${cleanGroupName} ÁöÑÊàêÂëò‰ø°ÊÅØÊú™ÊâæÂà∞Ôºå‰ΩøÁî®Á§∫‰æãÊàêÂëò`);
                } catch (error) {
                    console.error('‰ªéQQ_msgjsonËé∑ÂèñÁæ§ÊàêÂëòÂ§±Ë¥•:', error);
                }
                
                // Â¶ÇÊûúÊ≤°ÊúâÊï∞ÊçÆÔºåÁîüÊàê‰∏Ä‰∫õÁ§∫‰æãÊàêÂëò
                return generateSampleMembers(cleanGroupName);
            }
            
            /**
             * ÁîüÊàêÁ§∫‰æãÁæ§ÊàêÂëò
             */
            function generateSampleMembers(groupName) {
                const sampleMembers = [
                    { name: 'Áæ§‰∏ª', avatar: 'http://sharkpan.xyz/f/EJeUD/Image_1737026320652.jpg' },
                    { name: 'ÁÆ°ÁêÜÂëò', avatar: 'http://sharkpan.xyz/f/Y8pt1/Image_1737026296736.jpg' },
                    { name: 'ÊàêÂëòA', avatar: 'http://sharkpan.xyz/f/QWWc6/Image_1737026308451.jpg' },
                    { name: 'ÊàêÂëòB', avatar: 'http://sharkpan.xyz/f/Z8LIW/Image_1737026306601.jpg' },
                    { name: 'ÊàêÂëòC', avatar: 'http://sharkpan.xyz/f/W8lhW/Image_1737026313246.jpg' }
                ];
                
                // Êñ∞ÁâàÊú¨Ôºö‰∏çÂÜç‰ΩøÁî®localStorage‰øùÂ≠òÁæ§ÊàêÂëòÊï∞ÊçÆ
                console.log('ÁîüÊàêÁ§∫‰æãÁæ§ÊàêÂëòÔºà‰ªÖÂÜÖÂ≠òÔºâ:', sampleMembers);
                
                return sampleMembers;
            }
            
            /**
             * Á°Æ‰øùÊ∂àÊÅØÈöîÁ¶ª - Âè™ÂèëÈÄÅÁªôÂΩìÂâçÁæ§ÁªÑ
             */
            function sendGroupMessage(groupName, message) {
                const timestamp = new Date().toLocaleTimeString('zh-CN', { 
                    hour12: false, 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                // Ëé∑ÂèñÂΩìÂâçÁæ§ÊàêÂëò
                const members = getGroupMembers(groupName);
                
                // Ê®°ÊãüÁæ§ÊàêÂëòÂõûÂ§çÔºàÈöèÊú∫ÈÄâÊã©1-2‰∏™ÊàêÂëòÂõûÂ§çÔºâ
                setTimeout(() => {
                    const replyCount = Math.floor(Math.random() * 2) + 1;
                    const repliedMembers = [];
                    
                    for (let i = 0; i < replyCount; i++) {
                        const randomMember = members[Math.floor(Math.random() * members.length)];
                        if (!repliedMembers.includes(randomMember.name)) {
                            repliedMembers.push(randomMember.name);
                            
                            // ÁîüÊàêÂõûÂ§çÊ∂àÊÅØ
                            const replyMessage = generateGroupReply(message);
                            
                            // Ê∑ªÂä†Âà∞ËÅäÂ§©ÁïåÈù¢ÔºàËøôÈáåÈúÄË¶ÅÊ†πÊçÆÂÆûÈôÖÁöÑÊ∂àÊÅØÊ∏≤ÊüìÂáΩÊï∞Ë∞ÉÁî®Ôºâ
                            console.log(`${randomMember.name}Âú®Áæ§"${groupName}"‰∏≠ÂõûÂ§ç: ${replyMessage}`);
                        }
                    }
                }, Math.random() * 3000 + 1000); // 1-4ÁßíÂêéÂõûÂ§ç
            }
            
            /**
             * ÁîüÊàêÁæ§ËÅäÂõûÂ§çÂÜÖÂÆπ
             */
            function generateGroupReply(originalMessage) {
                const replies = [
                    'ÂêåÊÑèÔºÅ',
                    'ÂìàÂìàÂìà',
                    'Â•ΩÁöÑ',
                    'Êî∂Âà∞',
                    'Á°ÆÂÆûÂ¶ÇÊ≠§',
                    'Êàë‰πüËßâÂæó',
                    'ËØ¥ÂæóÂØπ',
                    '+1',
                    'ÊîØÊåÅ',
                    'ËµûÂêå'
                ];
                
                return replies[Math.floor(Math.random() * replies.length)];
            }
            
            // ÂÖ®Â±ÄÊ≥®ÂÜåÂáΩÊï∞
            window.handleChatTitleClick = handleChatTitleClick;
            window.sendGroupMessage = sendGroupMessage;
            
            /**
             * ÊòæÁ§∫Â§¥ÂÉèÈÄâÊã©Âô®
             */
            function showAvatarSelector() {
                console.log('ÊòæÁ§∫Â§¥ÂÉèÈÄâÊã©Âô®');
                const modal = document.getElementById('avatar_selector_modal');
                if (modal) {
                    modal.style.display = 'flex';
                    
                    // ÂàùÂßãÂåñÈ¢ÑËÆæÂ§¥ÂÉè
                    loadPresetAvatars();
                    
                    // ÈáçÁΩÆÈÄâÊã©Áä∂ÊÄÅ - ÊöÇÊó∂Ê≥®ÈáäÊéâÔºåËÆ©Áî®Êà∑ÂèØ‰ª•ÈÄâÊã©
                    // selectedAvatarData = null;
                    
                    // ÂàùÂßãÁä∂ÊÄÅ‰∏ãÂêØÁî®Á°ÆËÆ§ÊåâÈíÆ
                    const confirmBtn = document.getElementById('avatar_confirm_btn');
                    if (confirmBtn) {
                        confirmBtn.disabled = false;
                    }
                    
                    updateAvatarConfirmButton();
                    
                    // Ê∑ªÂä†ËÉåÊôØÁÇπÂáªÂÖ≥Èó≠ÂäüËÉΩ
                    modal.addEventListener('click', function(e) {
                        if (e.target === modal) {
                            closeAvatarSelector();
                        }
                    });
                    
                    console.log('Â§¥ÂÉèÈÄâÊã©Âô®Â∑≤ÊòæÁ§∫');
                }
            }
            
            /**
             * ÂÖ≥Èó≠Â§¥ÂÉèÈÄâÊã©Âô®
             */
            function closeAvatarSelector() {
                console.log('ÂÖ≥Èó≠Â§¥ÂÉèÈÄâÊã©Âô®');
                const modal = document.getElementById('avatar_selector_modal');
                if (modal) {
                    modal.style.display = 'none';
                }
                
                // Ê∏ÖÁêÜÁæ§ËÅäÂ§¥ÂÉèÈÄâÊã©Áä∂ÊÄÅ
                if (window.isSelectingGroupAvatar) {
                    window.isSelectingGroupAvatar = false;
                    window.currentAvatarGroup = null;
                }
                
                // ‰∏çË¶ÅÈáçÁΩÆÂ§¥ÂÉèÊï∞ÊçÆÔºåËÆ©Áî®Êà∑ÁöÑÈÄâÊã©‰øùÊåÅ
                // selectedAvatarData = null;
            }
            
            /**
             * ÂàáÊç¢Â§¥ÂÉèÈÄâÊã©Ê†áÁ≠æÈ°µ
             */
            function switchAvatarTab(tabType) {
                console.log('ÂàáÊç¢Âà∞Ê†áÁ≠æÈ°µ:', tabType);
                
                // Êõ¥Êñ∞Ê†áÁ≠æÁä∂ÊÄÅ
                document.querySelectorAll('.avatar-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`.avatar-tab[onclick*="${tabType}"]`).classList.add('active');
                
                // ÊòæÁ§∫ÂØπÂ∫îÂÜÖÂÆπ
                document.querySelectorAll('.avatar-options').forEach(option => {
                    option.classList.remove('active');
                });
                document.getElementById(tabType + '_avatars').classList.add('active');
                
                // Â¶ÇÊûúÂàáÊç¢Âà∞URLÊ†áÁ≠æÈ°µÔºåÊ∏ÖÁ©∫‰πãÂâçÁöÑÈ¢ÑËßà
                if (tabType === 'url') {
                    const urlInput = document.getElementById('avatar_url_input');
                    const previewContainer = document.getElementById('url_preview_container');
                    if (urlInput) urlInput.value = '';
                    if (previewContainer) previewContainer.style.display = 'none';
                }
            }
            
            /**
             * Â§ÑÁêÜÂ§¥ÂÉèURLËæìÂÖ•
             */
            function handleAvatarUrlInput() {
                const urlInput = document.getElementById('avatar_url_input');
                const previewContainer = document.getElementById('url_preview_container');
                const previewImage = document.getElementById('url_preview_image');
                
                if (!urlInput || !previewContainer || !previewImage) return;
                
                const url = urlInput.value.trim();
                
                if (!url) {
                    previewContainer.style.display = 'none';
                    window.selectedAvatarData = null;
                    updateAvatarConfirmButton();
                    return;
                }
                
                // ÁÆÄÂçïÁöÑURLÈ™åËØÅ
                try {
                    new URL(url);
                } catch (e) {
                    previewContainer.style.display = 'none';
                    window.selectedAvatarData = null;
                    updateAvatarConfirmButton();
                    return;
                }
                
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÂõæÁâáURL
                const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp'];
                const isImageUrl = imageExtensions.some(ext => 
                    url.toLowerCase().includes(ext) || 
                    url.toLowerCase().includes('image') ||
                    url.includes('catbox.moe') ||
                    url.includes('imgur.com') ||
                    url.includes('i.imgur.com')
                );
                
                if (!isImageUrl && !url.startsWith('data:image/')) {
                    console.warn('ÂèØËÉΩ‰∏çÊòØÂõæÁâáURL:', url);
                }
                
                // ÊòæÁ§∫È¢ÑËßà
                previewImage.onload = function() {
                    console.log('ÂõæÁâáÂä†ËΩΩÊàêÂäü:', url);
                    previewContainer.style.display = 'block';
                    
                    // ‰øùÂ≠òÈÄâ‰∏≠ÁöÑÂ§¥ÂÉèÊï∞ÊçÆ
                    window.selectedAvatarData = {
                        type: 'url',
                        url: url
                    };
                    
                    console.log('URLÂ§¥ÂÉèÊï∞ÊçÆÂ∑≤‰øùÂ≠ò:', window.selectedAvatarData);
                    updateAvatarConfirmButton();
                };
                
                previewImage.onerror = function() {
                    console.error('ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•:', url);
                    previewContainer.style.display = 'none';
                    window.selectedAvatarData = null;
                    updateAvatarConfirmButton();
                    
                    // ÂèØ‰ª•ÊòæÁ§∫ÈîôËØØÊèêÁ§∫
                    const urlInput = document.getElementById('avatar_url_input');
                    if (urlInput) {
                        urlInput.style.borderColor = '#ff6b6b';
                        setTimeout(() => {
                            urlInput.style.borderColor = '';
                        }, 2000);
                    }
                };
                
                previewImage.src = url;
            }
            
            /**
             * Âä†ËΩΩÈ¢ÑËÆæÂ§¥ÂÉè
             */
            function loadPresetAvatars() {
                const gridContainer = document.querySelector('.preset-avatar-grid');
                if (!gridContainer) return;
                
                // È¢ÑËÆæÂ§¥ÂÉèÁöÑÊ∏êÂèòËâ≤ÈÖçÁΩÆ
                const avatarGradients = [
                    { start: '#FF6B6B', end: '#EE5A24', text: 'Áæ§' },
                    { start: '#4ECDC4', end: '#44A08D', text: 'ËÅä' },
                    { start: '#45B7D1', end: '#96CEB4', text: 'ÁªÑ' },
                    { start: '#FFA07A', end: '#FA8072', text: 'Âõ¢' },
                    { start: '#98D8C8', end: '#F7DC6F', text: 'Èòü' },
                    { start: '#BB8FCE', end: '#D2B4DE', text: 'Âúà' },
                    { start: '#F8C471', end: '#F39C12', text: 'Á§æ' },
                    { start: '#85C1E9', end: '#5DADE2', text: '‰ºö' },
                    { start: '#F1948A', end: '#EC7063', text: 'Âèã' },
                    { start: '#82E0AA', end: '#58D68D', text: '‰º¥' },
                    { start: '#AED6F1', end: '#7FB3D3', text: '‰ºô' },
                    { start: '#E8DAEF', end: '#D7BDE2', text: 'ÈõÜ' }
                ];
                
                gridContainer.innerHTML = '';
                
                avatarGradients.forEach((gradient, index) => {
                    const avatarItem = document.createElement('div');
                    avatarItem.className = 'preset-avatar-item';
                    avatarItem.style.setProperty('--gradient-start', gradient.start);
                    avatarItem.style.setProperty('--gradient-end', gradient.end);
                    avatarItem.textContent = gradient.text;
                    
                    avatarItem.addEventListener('click', () => {
                        console.log('ÁÇπÂáªÈ¢ÑËÆæÂ§¥ÂÉè:', gradient);
                        
                        // ÁßªÈô§ÂÖ∂‰ªñÈÄâ‰∏≠Áä∂ÊÄÅ
                        document.querySelectorAll('.preset-avatar-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        
                        // Ê∑ªÂä†ÈÄâ‰∏≠Áä∂ÊÄÅ
                        avatarItem.classList.add('selected');
                        
                        // ‰øùÂ≠òÈÄâ‰∏≠ÁöÑÂ§¥ÂÉèÊï∞ÊçÆ
                        window.selectedAvatarData = {
                            type: 'preset',
                            gradient: gradient,
                            text: gradient.text
                        };
                        
                        console.log('Â§¥ÂÉèÊï∞ÊçÆÂ∑≤‰øùÂ≠ò:', window.selectedAvatarData);
                        updateAvatarConfirmButton();
                    });
                    
                    gridContainer.appendChild(avatarItem);
                });
            }
            
            /**
             * Ëß¶ÂèëÊñá‰ª∂‰∏ä‰º†
             */
            function triggerFileUpload() {
                document.getElementById('avatar_upload_input').click();
            }
            
            /**
             * Â§ÑÁêÜÂ§¥ÂÉè‰∏ä‰º†
             */
            function handleAvatarUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûã
                if (!file.type.startsWith('image/')) {
                    alert('ËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂');
                    return;
                }
                
                // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞è (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('ÂõæÁâáÊñá‰ª∂‰∏çËÉΩË∂ÖËøá5MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    console.log('ÂéüÂßãÂõæÁâáÂ§ßÂ∞è:', e.target.result.length);
                    
                    // ÂéãÁº©ÂõæÁâá‰ª•ÈÅøÂÖçlocalStorageÈÖçÈ¢ùÈóÆÈ¢ò
                    let imageData;
                    try {
                        imageData = await compressImage(file, 512, 0.8);
                        console.log('ÂõæÁâáÂéãÁº©ÂÆåÊàêÔºåÂéãÁº©ÂêéÂ§ßÂ∞è:', imageData.length);
                    } catch (error) {
                        console.warn('ÂõæÁâáÂéãÁº©Â§±Ë¥•Ôºå‰ΩøÁî®ÂéüÂõæ:', error);
                        imageData = e.target.result;
                    }
                    
                    // Áõ¥Êé•‰ΩøÁî®ÂéãÁº©ÂêéÁöÑbase64Êï∞ÊçÆÔºåÈÅøÂÖçlocalStorageÂ≠òÂÇ®
                    console.log('‰ΩøÁî®ÂéãÁº©ÂêéÁöÑbase64Êï∞ÊçÆÔºåË∑≥ËøálocalStorageÂ≠òÂÇ®');
                    
                    // *** ‰øÆÂ§çÔºöÁªü‰∏ÄÁöÑÂ§¥ÂÉè‰∏ä‰º†ÈÄªËæë ***
                    // Êó†ËÆ∫ÊòØÂàõÂª∫Áæ§ËÅäËøòÊòØÁæ§ËÅäËÆæÁΩÆÔºåÈÉΩ‰ΩøÁî®Áõ∏ÂêåÁöÑÈÄªËæëÔºöÂÖà‰øùÂ≠òÂà∞selectedAvatarDataÔºåÁÑ∂ÂêéÈÄöËøáÁ°ÆËÆ§ÊåâÈíÆÁªü‰∏ÄÂ§ÑÁêÜ
                    
                    // Áæ§ËÅäÂàõÂª∫‰∏≠ÁöÑÂ§¥ÂÉè‰∏ä‰º†
                    const uploadZone = document.querySelector('.upload-zone');
                    if (uploadZone) {
                        uploadZone.innerHTML = `
                            <div class="uploaded-preview">
                                <img src="${imageData}" alt="È¢ÑËßà" style="width: 120px; height: 120px; border-radius: 12px; object-fit: cover;">
                                <div class="upload-text" style="margin-top: 10px; color: #28a745;">‚úÖ ÂõæÁâáÂ∑≤‰∏ä‰º†ÊàêÂäüÔºàÂ∑≤ÂéãÁº©Ôºâ</div>
                                <button class="change-image-btn" onclick="triggerFileUpload()" style="margin-top: 8px; padding: 6px 12px; border: 1px solid #ddd; border-radius: 6px; background: white; cursor: pointer;">Êõ¥Êç¢ÂõæÁâá</button>
                                <div style="margin-top: 8px; font-size: 12px; color: #666; text-align: center;">
                                    ÂõæÁâáÂ∑≤ÂéãÁº©Âπ∂Â∞ÜÁõ¥Êé•‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶‰∏≠
                                </div>
                            </div>
                        `;
                    }
                    
                    // ‰øùÂ≠òÈÄâ‰∏≠ÁöÑÂ§¥ÂÉèÊï∞ÊçÆÔºà‰ΩøÁî®ÂéãÁº©ÂêéÁöÑÊï∞ÊçÆÔºâ
                    window.selectedAvatarData = {
                        type: 'upload',
                        imageData: imageData  // Áõ¥Êé•‰øùÂ≠òÂéãÁº©ÂêéÁöÑÂÆåÊï¥Êï∞ÊçÆ
                    };
                    
                    console.log('‰∏ä‰º†Â§¥ÂÉèÊï∞ÊçÆÂ∑≤‰øùÂ≠ò:', {
                        type: window.selectedAvatarData.type,
                        hasImageData: !!window.selectedAvatarData.imageData,
                        dataSize: window.selectedAvatarData.imageData.length
                    });
                    
                    updateAvatarConfirmButton();
                };
                
                reader.readAsDataURL(file);
            }
            
            /**
             * Êõ¥Êñ∞Á°ÆËÆ§ÊåâÈíÆÁä∂ÊÄÅ
             */
            function updateAvatarConfirmButton() {
                const confirmBtn = document.getElementById('avatar_confirm_btn');
                if (confirmBtn) {
                    // ÊÄªÊòØÂêØÁî®Á°ÆËÆ§ÊåâÈíÆÔºåÂõ†‰∏∫ÂèØ‰ª•‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè
                    confirmBtn.disabled = false;
                    console.log('Êõ¥Êñ∞Â§¥ÂÉèÁ°ÆËÆ§ÊåâÈíÆÁä∂ÊÄÅ:', {
                        hasData: !!window.selectedAvatarData,
                        disabled: confirmBtn.disabled,
                        selectedData: window.selectedAvatarData
                    });
                }
            }
            
            /**
             * Á°ÆËÆ§Â§¥ÂÉèÈÄâÊã©ÔºàÂ¢ûÂº∫ÁâàÔºöÊîØÊåÅÂàõÂª∫Áæ§ËÅäÂíåÁæ§ËÅäËÆæÁΩÆÔºâ
             */
            function confirmAvatarSelection() {
                console.log('Á°ÆËÆ§Â§¥ÂÉèÈÄâÊã©ÔºåÂΩìÂâçÈÄâ‰∏≠ÁöÑÂ§¥ÂÉèÊï∞ÊçÆ:', window.selectedAvatarData);
                console.log('ÊòØÂê¶Âú®Áæ§ËÅäËÆæÁΩÆ‰∏≠ÈÄâÊã©Â§¥ÂÉè:', window.isSelectingGroupAvatar);
                
                // Â¶ÇÊûúÊ≤°ÊúâÈÄâÊã©Â§¥ÂÉèÔºå‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè
                if (!window.selectedAvatarData) {
                    window.selectedAvatarData = {
                        type: 'preset',
                        gradient: { start: '#199AFF', end: '#0066CC' },
                        text: 'Áæ§'
                    };
                    console.log('‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè:', window.selectedAvatarData);
                }
                
                // *** ‰øÆÂ§çÔºöÊîØÊåÅÁæ§ËÅäËÆæÁΩÆ‰∏≠ÁöÑÂ§¥ÂÉèÈÄâÊã© ***
                if (window.isSelectingGroupAvatar) {
                    // Áæ§ËÅäËÆæÁΩÆ‰∏≠ÁöÑÂ§¥ÂÉèÈÄâÊã©
                    const settingsPreviewElement = document.getElementById('group_settings_avatar_preview');
                    const settingsTextElement = document.querySelector('.group-settings-avatar-text');
                    
                    if (settingsPreviewElement && settingsTextElement) {
                        if (window.selectedAvatarData.type === 'preset') {
                            // È¢ÑËÆæÂ§¥ÂÉè
                            const gradient = window.selectedAvatarData.gradient;
                            settingsPreviewElement.style.background = `linear-gradient(135deg, ${gradient.start}, ${gradient.end})`;
                            settingsPreviewElement.style.backgroundImage = 'none';
                            settingsPreviewElement.innerHTML = `<div class="default-group-avatar">${window.selectedAvatarData.text}</div>`;
                            settingsTextElement.textContent = 'Â∑≤ÈÄâÊã©È¢ÑËÆæÂ§¥ÂÉè';
                        } else if (window.selectedAvatarData.type === 'upload') {
                            // ‰∏ä‰º†ÁöÑÂ§¥ÂÉè
                            settingsPreviewElement.style.background = 'none';
                            settingsPreviewElement.style.backgroundImage = `url('${window.selectedAvatarData.imageData}')`;
                            settingsPreviewElement.style.backgroundSize = 'cover';
                            settingsPreviewElement.style.backgroundPosition = 'center';
                            settingsPreviewElement.style.backgroundRepeat = 'no-repeat';
                            settingsPreviewElement.innerHTML = '';
                            settingsTextElement.textContent = 'Â∑≤ÈÄâÊã©Ëá™ÂÆö‰πâÂ§¥ÂÉè';
                        }
                        
                        console.log('Áæ§ËÅäËÆæÁΩÆÂ§¥ÂÉèÈ¢ÑËßàÂ∑≤Êõ¥Êñ∞');
                    } else {
                        console.error('Êâæ‰∏çÂà∞Áæ§ËÅäËÆæÁΩÆÂ§¥ÂÉèÈ¢ÑËßàÂÖÉÁ¥†');
                    }
                    
                    // Ê∏ÖÁêÜÁæ§ËÅäËÆæÁΩÆÁõ∏ÂÖ≥ÁöÑÊ†áÂøó
                    window.isSelectingGroupAvatar = false;
                    window.currentAvatarGroup = null;
                } else {
                    // ÂàõÂª∫Áæ§ËÅäÊó∂ÁöÑÂ§¥ÂÉèÈÄâÊã©ÔºàÂéüÈÄªËæëÔºâ
                    const previewElement = document.getElementById('group_avatar_preview');
                    const textElement = document.querySelector('.group-avatar-text');
                    
                    if (!previewElement || !textElement) {
                        console.error('Êâæ‰∏çÂà∞ÂàõÂª∫Áæ§ËÅäÂ§¥ÂÉèÈ¢ÑËßàÂÖÉÁ¥†');
                        closeAvatarSelector();
                        return;
                    }
                    
                    if (window.selectedAvatarData.type === 'preset') {
                        // È¢ÑËÆæÂ§¥ÂÉè
                        const gradient = window.selectedAvatarData.gradient;
                        previewElement.style.background = `linear-gradient(135deg, ${gradient.start}, ${gradient.end})`;
                        previewElement.style.backgroundImage = 'none';
                        previewElement.innerHTML = `<div class="default-group-avatar">${window.selectedAvatarData.text}</div>`;
                        textElement.textContent = 'Â∑≤ËÆæÁΩÆÈ¢ÑËÆæÂ§¥ÂÉè';
                    } else if (window.selectedAvatarData.type === 'upload') {
                        // ‰∏ä‰º†ÁöÑÂ§¥ÂÉè
                        previewElement.style.background = 'none';
                        previewElement.style.backgroundImage = `url('${window.selectedAvatarData.imageData}')`;
                        previewElement.style.backgroundSize = 'cover';
                        previewElement.style.backgroundPosition = 'center';
                        previewElement.innerHTML = '';
                        textElement.textContent = 'Â∑≤ËÆæÁΩÆËá™ÂÆö‰πâÂ§¥ÂÉè';
                    }
                    
                    console.log('ÂàõÂª∫Áæ§ËÅäÂ§¥ÂÉèÈ¢ÑËßàÂ∑≤Êõ¥Êñ∞');
                }
                
                console.log('Â§¥ÂÉèËÆæÁΩÆÊàêÂäüÔºåÂÖ≥Èó≠ÈÄâÊã©Âô®');
                closeAvatarSelector();
            }

            // ==================== Áæ§ËÅäÂäüËÉΩÂ¢ûÂº∫ ====================
            
            /**
             * ÊîπËøõÁöÑÁæ§ËÅäÂàõÂª∫ÂäüËÉΩÔºàÂ∏¶Â§¥ÂÉèÊîØÊåÅÔºâ
             */
            // ÊóßÁöÑcreateGroupChatÂáΩÊï∞Â∑≤ÁßªÈô§ÔºåÁé∞Âú®‰ΩøÁî®window.createGroupChatÔºà‰∏ñÁïå‰π¶ÈÄªËæëÔºâ
            
            /**
             * Ê£ÄÊü•‰∏ñÁïå‰π¶‰∏≠ÁöÑÁæ§ËÅäÂÜÖÂÆπ
             */
            function checkWorldbookGroups() {
                console.log('=== Ê£ÄÊü•‰∏ñÁïå‰π¶‰∏≠ÁöÑÁã¨Á´ãÁæ§ËÅäÊù°ÁõÆ ===');
                
                if (!entries) {
                    console.log('entriesÊú™ÂÆö‰πâÔºåÊó†Ê≥ïÊ£ÄÊü•Áæ§ËÅä');
                    return;
                }
                
                // Êü•ÊâæÊâÄÊúâÁæ§ËÅäÊù°ÁõÆ
                const groupEntries = entries.filter(e => e.comment === "ÊâãÊú∫-Áæ§ËÅä" || (e.key && typeof e.key === 'string' && e.key.startsWith("ÊâãÊú∫-Áæ§ËÅä-")));
                console.log(`ÊâæÂà∞ ${groupEntries.length} ‰∏™Áã¨Á´ãÁæ§ËÅäÊù°ÁõÆ:`);
                
                groupEntries.forEach((entry, index) => {
                    console.log(`Áæ§ËÅäÊù°ÁõÆ ${index + 1}:`);
                    console.log('  - Key:', entry.key);
                    console.log('  - Comment:', entry.comment);
                    console.log('  - Content:', entry.content);
                    
                    // Ëß£ÊûêÁæ§ËÅä‰ø°ÊÅØ
                    const lines = entry.content.split('\n');
                    let groupName = '';
                    let members = [];
                    let avatar = '';
                    
                    for (const line of lines) {
                        const trimmed = line.trim();
                        if (trimmed.startsWith('[') && trimmed.endsWith(']')) {
                            groupName = trimmed.slice(1, -1);
                        } else if (trimmed.startsWith('ÊàêÂëò=')) {
                            members = trimmed.substring(3).split(',').map(m => m.trim());
                        } else if (trimmed.startsWith('Â§¥ÂÉè=')) {
                            avatar = trimmed.substring(3);
                        }
                    }
                    
                    console.log(`  - Áæ§ËÅäÂêçÁß∞: ${groupName}`);
                    console.log(`  - ÊàêÂëò: ${members.join(', ')}`);
                    console.log(`  - Â§¥ÂÉè: ${avatar}`);
                });
            }

            /**
             * Ê∏ÖÁêÜÈáçÂ§çÁöÑÁæ§ËÅäÔºàÂ∑≤Á¶ÅÁî®ÔºåÂÖÅËÆ∏ÂêåÂêçÁæ§ËÅäÂ≠òÂú®Ôºâ
             */
            async function cleanupDuplicateGroups() {
                console.log('Áæ§ËÅäÈáçÂ§çÊ∏ÖÁêÜÂäüËÉΩÂ∑≤Á¶ÅÁî®ÔºåÂÖÅËÆ∏ÂêåÂêçÁæ§ËÅäÂ≠òÂú®');
                return; // Á¶ÅÁî®Ê≠§ÂáΩÊï∞ÔºåÂÖÅËÆ∏ÂêåÂêçÁæ§ËÅä
                
                console.log('ÂºÄÂßãÊ∏ÖÁêÜÈáçÂ§çÁæ§ËÅä');
                
                // ‰ªé‰∏ñÁïå‰π¶Âä†ËΩΩÁæ§ËÅäÊï∞ÊçÆËøõË°åÊ∏ÖÁêÜ
                const groups = await loadGroupChatsFromWorldbook();
                const uniqueGroups = [];
                const seenNames = new Set();
                
                for (const group of groups) {
                    if (!seenNames.has(group.name)) {
                        seenNames.add(group.name);
                        uniqueGroups.push(group);
                    } else {
                        console.log(`Âà†Èô§ÈáçÂ§çÁæ§ËÅä: ${group.name} (ID: ${group.id})`);
                    }
                }
                
                if (uniqueGroups.length !== groups.length) {
                    // Êñ∞ÁâàÊú¨Ôºö‰∏çÂÜç‰ΩøÁî®localStorageÔºåÁæ§ËÅäÊï∞ÊçÆÂú®‰∏ñÁïå‰π¶‰∏≠ÁÆ°ÁêÜ
                    console.log(`Ê∏ÖÁêÜÂÆåÊàêÔºå‰ªé ${groups.length} ‰∏™Áæ§ËÅäÂáèÂ∞ëÂà∞ ${uniqueGroups.length} ‰∏™`);
                }
                
                // Ê∏ÖÁêÜÁïåÈù¢‰∏≠ÁöÑÈáçÂ§çÁæ§ËÅäÂÖÉÁ¥†
                const contactsContainer = document.getElementById('QQ_home_chars');
                if (contactsContainer) {
                    const groupElements = contactsContainer.querySelectorAll('[data-group-type="true"]');
                    const seenGroupNames = new Set();
                    
                    groupElements.forEach(element => {
                        const nameElement = element.querySelector('.QQ_home_name');
                        if (nameElement) {
                            const groupName = nameElement.textContent.trim();
                            if (seenGroupNames.has(groupName)) {
                                console.log(`Âà†Èô§ÈáçÂ§çÁöÑÁæ§ËÅäÁïåÈù¢ÂÖÉÁ¥†: ${groupName}`);
                                element.remove();
                            } else {
                                seenGroupNames.add(groupName);
                            }
                        }
                    });
                }
                
                // Ê∏ÖÁêÜÊ∂àÊÅØÂàóË°®‰∏≠ÁöÑÈáçÂ§çÁæ§ËÅäÂÖÉÁ¥†
                const messagesContainer = document.getElementById('QQ_message_list_chars');
                if (messagesContainer) {
                    const groupElements = messagesContainer.querySelectorAll('[data-group-type="true"]');
                    const seenGroupNames = new Set();
                    
                    groupElements.forEach(element => {
                        const nameElement = element.querySelector('.QQ_home_name');
                        if (nameElement) {
                            const groupName = nameElement.textContent.trim();
                            if (seenGroupNames.has(groupName)) {
                                console.log(`Âà†Èô§ÈáçÂ§çÁöÑÁæ§ËÅäÊ∂àÊÅØÂÖÉÁ¥†: ${groupName}`);
                                element.remove();
                            } else {
                                seenGroupNames.add(groupName);
                            }
                        }
                    });
                }
            }

            /**
             * Â∞ÜÁæ§ËÅäÊ∑ªÂä†Âà∞‰∏ñÁïå‰π¶
             */
            async function addGroupToWorldbook(groupData) {
                try {
                    console.log('=== ÂºÄÂßãÂ∞ÜÁæ§ËÅäÊ∑ªÂä†Âà∞Áã¨Á´ãÁöÑ‰∏ñÁïå‰π¶Êù°ÁõÆ ===');
                    console.log('Áæ§ËÅäÊï∞ÊçÆ:', groupData);
                    console.log('Â§¥ÂÉèÊï∞ÊçÆËØ¶ÊÉÖ:', groupData.avatar);
                    console.log('ÂΩìÂâçentries:', typeof entries, entries ? entries.length : 'undefined');
                    console.log('worldbookÂèòÈáè:', worldbook);
                    console.log('setLorebookEntriesÂáΩÊï∞:', typeof setLorebookEntries);
                    
                    // Â¶ÇÊûúentriesÊú™ÂÆö‰πâÔºåÂÖàÂàùÂßãÂåñÂÆÉ
                    if (!entries) {
                        console.log('entriesÊú™ÂÆö‰πâÔºåÊ≠£Âú®ÂàùÂßãÂåñ...');
                        if (!worldbook) {
                            console.error('worldbookÊú™ÂÆö‰πâÔºåÊó†Ê≥ïÂàùÂßãÂåñentries');
                            return false;
                        }
                        entries = await getLorebookEntries(worldbook);
                        console.log('entriesÂàùÂßãÂåñÂÆåÊàêÔºåÊù°ÁõÆÊï∞Èáè:', entries ? entries.length : 'failed');
                        if (!entries) {
                            console.error('entriesÂàùÂßãÂåñÂ§±Ë¥•');
                            return false;
                        }
                    }
                    
                    // ÂÆö‰πâuniqueCommentÂèòÈáèÂú®ÂáΩÊï∞ÂºÄÂ§¥ÔºåÁ°Æ‰øùÂú®ÊâÄÊúâÂàÜÊîØ‰∏≠ÈÉΩÂèØÁî®
                    const uniqueComment = `ÊâãÊú∫-Áæ§ËÅä-${groupData.name}`;
                    
                    // Êü•ÊâæÁé∞ÊúâÁöÑÁæ§ËÅäÊù°ÁõÆ
                    let groupEntry = null;
                    const groupEntryKey = `ÊâãÊú∫-Áæ§ËÅä-${groupData.name}`;
                    
                    groupEntry = entries.find(e => 
                        e.comment === "ÊâãÊú∫-Áæ§ËÅä" && e.content && e.content.includes(`[${groupData.name}]`)
                    );
                    
                    // ÊûÑÂª∫Áæ§ËÅäÊù°ÁõÆÂÜÖÂÆπ - Êô∫ËÉΩÂ§¥ÂÉèÊ∑∑ÂêàÂ≠òÂÇ®ÊñπÊ°à
                    let avatarReference = 'http://sharkpan.xyz/f/z0WU5/mmexport1736971020657.gif';
                    
                    if (groupData.avatar) {
                        console.log('ÂºÄÂßãÂ§ÑÁêÜÂ§¥ÂÉèÊï∞ÊçÆÔºåÁ±ªÂûã:', typeof groupData.avatar);
                        
                        if (typeof groupData.avatar === 'string') {
                            // Áõ¥Êé•ÁöÑÂ≠óÁ¨¶‰∏≤Ê†ºÂºèÔºàÂèØËÉΩÊòØbase64ÊàñURLÔºâ
                            if (groupData.avatar.startsWith('data:')) {
                                // Base64ÂõæÂÉèÊï∞ÊçÆÔºå‰ΩøÁî®IndexedDBÊàñÁõ¥Êé•Â≠òÂÇ®Âú®‰∏ñÁïå‰π¶‰∏≠
                                try {
                                    // Â∞Übase64Áõ¥Êé•Â≠òÂÇ®Âú®‰∏ñÁïå‰π¶‰∏≠ÔºåÈÅøÂÖçlocalStorageÈôêÂà∂
                                    avatarReference = groupData.avatar; // Áõ¥Êé•‰ΩøÁî®base64
                                    console.log('Base64Â§¥ÂÉèÁõ¥Êé•Â≠òÂÇ®Âú®‰∏ñÁïå‰π¶‰∏≠ÔºåÈïøÂ∫¶:', groupData.avatar.length);
                                } catch (e) {
                                    console.warn('Â§¥ÂÉèÂ§ÑÁêÜÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè:', e);
                                    avatarReference = 'http://sharkpan.xyz/f/z0WU5/mmexport1736971020657.gif';
                                }
                            } else if (groupData.avatar.startsWith('http://') || groupData.avatar.startsWith('https://')) {
                                // ÁΩëÁªúURLÔºåÁõ¥Êé•‰ΩøÁî®
                                avatarReference = groupData.avatar;
                                console.log('‰ΩøÁî®ÁΩëÁªúÈìæÊé•Â§¥ÂÉè:', avatarReference);
                            } else if (groupData.avatar.startsWith('avatar_')) {
                                // Â∑≤ÁªèÊòØÂ§¥ÂÉèIDÂºïÁî®ÔºåÁõ¥Êé•‰ΩøÁî®
                                avatarReference = groupData.avatar;
                                console.log('‰ΩøÁî®Â∑≤ÊúâÁöÑÂ§¥ÂÉèIDÂºïÁî®:', avatarReference);
                            } else {
                                console.log('Êú™ËØÜÂà´ÁöÑÂ§¥ÂÉèÊ†ºÂºèÔºå‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè');
                                avatarReference = 'http://sharkpan.xyz/f/z0WU5/mmexport1736971020657.gif';
                            }
                        } else if (typeof groupData.avatar === 'object') {
                            // ÂØπË±°Ê†ºÂºèÁöÑÂ§¥ÂÉèÊï∞ÊçÆ
                            if (groupData.avatar.type === 'url' && groupData.avatar.url) {
                                // ÁΩëÁªúÈìæÊé•
                                avatarReference = groupData.avatar.url;
                                console.log('‰ΩøÁî®ÁΩëÁªúÈìæÊé•Â§¥ÂÉè:', avatarReference);
                            } else if (groupData.avatar.type === 'upload') {
                                if (groupData.avatar.avatarId) {
                                    // Â∑≤ÊúâÁöÑÂ§¥ÂÉèIDÂºïÁî®
                                    avatarReference = groupData.avatar.avatarId;
                                    console.log('‰ΩøÁî®Â§¥ÂÉèIDÂºïÁî®:', avatarReference);
                                } else if (groupData.avatar.imageData) {
                                    if (groupData.avatar.imageData.startsWith('data:')) {
                                        // Base64Êï∞ÊçÆÔºåÁõ¥Êé•Â≠òÂÇ®
                                        try {
                                            avatarReference = groupData.avatar.imageData; // Áõ¥Êé•‰ΩøÁî®base64
                                            console.log('Base64Â§¥ÂÉèÁõ¥Êé•Â≠òÂÇ®ÔºåÈïøÂ∫¶:', groupData.avatar.imageData.length);
                                        } catch (e) {
                                            console.warn('Â§¥ÂÉèÂ§ÑÁêÜÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè:', e);
                                            avatarReference = 'http://sharkpan.xyz/f/z0WU5/mmexport1736971020657.gif';
                                        }
                                    } else if (groupData.avatar.imageData.startsWith('http://') || groupData.avatar.imageData.startsWith('https://')) {
                                        // ÁΩëÁªúÈìæÊé•
                                        avatarReference = groupData.avatar.imageData;
                                        console.log('‰ΩøÁî®ÁΩëÁªúÈìæÊé•Â§¥ÂÉè:', avatarReference);
                                    } else {
                                        console.log('Êú™ËØÜÂà´ÁöÑimageDataÊ†ºÂºèÔºå‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè');
                                        avatarReference = 'http://sharkpan.xyz/f/z0WU5/mmexport1736971020657.gif';
                                    }
                                } else {
                                    console.log('uploadÁ±ªÂûã‰ΩÜÊó†ÊúâÊïàÊï∞ÊçÆÔºå‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè');
                                    avatarReference = 'http://sharkpan.xyz/f/z0WU5/mmexport1736971020657.gif';
                                }
                            } else {
                                console.log('Êú™ËØÜÂà´ÁöÑÂ§¥ÂÉèÂØπË±°Á±ªÂûãÔºå‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè');
                                avatarReference = 'http://sharkpan.xyz/f/z0WU5/mmexport1736971020657.gif';
                            }
                        } else {
                            console.log('Êú™ËØÜÂà´ÁöÑÂ§¥ÂÉèÊï∞ÊçÆÁ±ªÂûãÔºå‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè');
                            avatarReference = 'http://sharkpan.xyz/f/z0WU5/mmexport1736971020657.gif';
                        }
                    } else {
                        console.log('Êó†Â§¥ÂÉèÊï∞ÊçÆÔºå‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè');
                    }
                    
                    console.log('ÊúÄÁªàÂ§¥ÂÉèÂºïÁî®:', avatarReference);
                    
                    const groupContent = `[${groupData.name}]
Á±ªÂûã=Áæ§ËÅä
ÊàêÂëò=${groupData.members.join(',')}
Â§¥ÂÉè=${avatarReference}`;
                    
                    if (groupEntry) {
                        // Êõ¥Êñ∞Áé∞ÊúâÊù°ÁõÆ
                        console.log('Êõ¥Êñ∞Áé∞ÊúâÁæ§ËÅäÊù°ÁõÆ:', groupEntry.uid);
                        await setLorebookEntries(worldbook, [
                            {
                                uid: groupEntry.uid,
                                content: groupContent,
                            }
                        ]);
                    } else {
                        // ÂàõÂª∫Êñ∞ÁöÑÁã¨Á´ãÁæ§ËÅäÊù°ÁõÆ
                        console.log('ÂàõÂª∫Êñ∞ÁöÑÁã¨Á´ãÁæ§ËÅäÊù°ÁõÆ');
                        
                        // ‰ΩøÁî®Ê≠£Á°ÆÁöÑcreateLorebookEntryÂáΩÊï∞ÔºåÈÅµÂæ™È°πÁõÆÊ†áÂáÜËÆæÂÆö
                        console.log('ÂáÜÂ§áË∞ÉÁî®createLorebookEntryÔºåÂèÇÊï∞:', { worldbook, uniqueComment, groupContent });
                        const createResult = await createLorebookEntry(worldbook, {
                            comment: uniqueComment, // ‰ΩøÁî®ÂîØ‰∏ÄÁöÑcommentÊ†áËØÜÁæ§ËÅä
                            key: ["Ê≠§‰∏ñÁïå‰π¶Ê∞∏‰∏çËß¶Âèë"], // ‰ΩøÁî®Ê†áÂáÜÁöÑÊ∞∏‰∏çËß¶ÂèëÂÖ≥ÈîÆËØçÔºå‰∏éÊâãÊú∫-ËßíËâ≤‰øùÊåÅ‰∏ÄËá¥
                            content: groupContent,
                            position: "at_depth_as_system",
                            type: "selective", // ÁªøÁÅØÔºöÈÄâÊã©ÊÄßËß¶Âèë
                            depth: 4, // Ê∑±Â∫¶4Ôºå‰∏éÂÖ∂‰ªñÊâãÊú∫Ê†ºÂºè‰øùÊåÅ‰∏ÄËá¥
                            exclude_recursion: true, // ÊéíÈô§ÈÄíÂΩíÔºåÈÅµÂæ™È°πÁõÆÊ†áÂáÜ
                            order: 6000, // È°∫Â∫è6000ÔºåÈ´ò‰∫éÊ†ºÂºèÊù°ÁõÆÔºà5560-5564Ôºâ
                            enabled: true,
                        });
                        console.log('createLorebookEntryË∞ÉÁî®ÁªìÊûú:', createResult);
                        
                        // Â∞ùËØïËß¶Âèë‰∏ñÁïå‰π¶‰øùÂ≠òÔºàÂ¶ÇÊûúÊúâÁõ∏ÂÖ≥ÂáΩÊï∞ÁöÑËØùÔºâ
                        if (typeof saveWorldInfo === 'function') {
                            console.log('Ëß¶ÂèësaveWorldInfo‰øùÂ≠ò...');
                            await saveWorldInfo();
                        } else {
                            console.log('saveWorldInfoÂáΩÊï∞‰∏çÂèØÁî®Ôºå‰æùËµñSillyTavernËá™Âä®‰øùÂ≠òÊú∫Âà∂');
                        }
                    }
                    
                    console.log('Áæ§ËÅäÂ∑≤ÊàêÂäüÊ∑ªÂä†Âà∞Áã¨Á´ãÁöÑ‰∏ñÁïå‰π¶Êù°ÁõÆ');
                    
                    // È™åËØÅÊù°ÁõÆÊòØÂê¶ÁúüÁöÑË¢´Ê∑ªÂä†‰∫Ü
                    console.log('È™åËØÅÔºöÈáçÊñ∞Ëé∑Âèñ‰∏ñÁïå‰π¶Êù°ÁõÆ...');
                    const updatedEntries = await getLorebookEntries(worldbook);
                    const verifyEntry = updatedEntries.find(e => e.comment === uniqueComment);
                    console.log('È™åËØÅÁªìÊûú - ÊâæÂà∞Êñ∞Êù°ÁõÆ:', !!verifyEntry);
                    if (verifyEntry) {
                        console.log('Êñ∞Êù°ÁõÆÂÜÖÂÆπ:', verifyEntry.content);
                        // Êõ¥Êñ∞ÂÖ®Â±ÄentriesÊï∞ÁªÑ
                        entries = updatedEntries;
                        console.log('Â∑≤Êõ¥Êñ∞ÂÖ®Â±ÄentriesÊï∞ÁªÑÔºåÂΩìÂâçÊÄªÊï∞:', entries.length);
                    } else {
                        console.error('‚ùå ‰∏ñÁïå‰π¶Êù°ÁõÆÂàõÂª∫Â§±Ë¥•ÔºÅÊù°ÁõÆÊú™Âú®‰∏ñÁïå‰π¶‰∏≠ÊâæÂà∞');
                        // Â∞ùËØïÂÜçÊ¨°Ëé∑Âèñentries‰ª•Á°Æ‰øùÂêåÊ≠•
                        entries = updatedEntries;
                        console.log('Â∑≤ÈáçÊñ∞ÂêåÊ≠•entriesÊï∞ÁªÑÔºåÂΩìÂâçÊÄªÊï∞:', entries.length);
                    }
                    
                    return true;
                } catch (error) {
                    console.error('Ê∑ªÂä†Áæ§ËÅäÂà∞‰∏ñÁïå‰π¶Â§±Ë¥•:', error);
                    return false;
                }
            }
            
            /**
             * Êõ¥Êñ∞Áæ§ËÅäÊàêÂëòÂà∞‰∏ñÁïå‰π¶
             */
            async function updateGroupMembersInWorldbook(groupName, members) {
                try {
                    console.log('Êõ¥Êñ∞Áæ§ËÅäÊàêÂëòÂà∞Áã¨Á´ã‰∏ñÁïå‰π¶Êù°ÁõÆ:', groupName, members);
                    
                    // Êü•ÊâæÂØπÂ∫îÁöÑÁæ§ËÅäÊù°ÁõÆ - ‰ΩøÁî®ÂîØ‰∏ÄcommentÊü•Êâæ
                    let groupEntry = null;
                    const uniqueComment = `ÊâãÊú∫-Áæ§ËÅä-${groupName}`;
                    
                    if (entries) {
                        groupEntry = entries.find(e => 
                            e.comment === uniqueComment
                        );
                    }
                    
                    if (!groupEntry) {
                        console.error('Âú®‰∏ñÁïå‰π¶‰∏≠Êú™ÊâæÂà∞Áæ§ËÅäÊù°ÁõÆ:', groupName);
                        return false;
                    }
                    
                    // Ëß£ÊûêÁé∞ÊúâÂÜÖÂÆπ
                    let content = groupEntry.content;
                    const lines = content.split('\n');
                    let updatedContent = '';
                    
                    // ‰øùÁïôÂÖ∂‰ªñÂ±ûÊÄßÔºåÊõ¥Êñ∞ÊàêÂëòÂàóË°®
                    let hasMembersLine = false;
                    for (const line of lines) {
                        if (line.startsWith('ÊàêÂëò=')) {
                            updatedContent += `ÊàêÂëò=${members.join(',')}\n`;
                            hasMembersLine = true;
                        } else if (line.trim()) {
                            updatedContent += line + '\n';
                        }
                    }
                    
                    // Â¶ÇÊûúÊ≤°ÊúâÊàêÂëòË°åÔºåÊ∑ªÂä†‰∏Ä‰∏™
                    if (!hasMembersLine) {
                        updatedContent += `ÊàêÂëò=${members.join(',')}\n`;
                    }
                    
                    // Êõ¥Êñ∞‰∏ñÁïå‰π¶
                    await setLorebookEntries(worldbook, [
                        {
                            uid: groupEntry.uid,
                            content: updatedContent.trim(),
                        }
                    ]);
                    
                    // ÈáçÊñ∞Âä†ËΩΩentries‰ª•Êõ¥Êñ∞Êú¨Âú∞Êï∞ÊçÆ
                    entries = await getLorebookEntries(worldbook);
                    
                    // ÂêåÊ≠•Êõ¥Êñ∞Êú¨Âú∞Êï∞ÊçÆÁªìÊûÑ
                    if (QQ_msgjson.Áæ§ËÅä[groupName]) {
                        QQ_msgjson.Áæ§ËÅä[groupName].members = members;
                        console.log('Â∑≤ÂêåÊ≠•Êõ¥Êñ∞ QQ_msgjson.Áæ§ËÅä ‰∏≠ÁöÑÊàêÂëòÂàóË°®');
                    }
                    
                    console.log('Áæ§ËÅäÊàêÂëòÂ∑≤Êõ¥Êñ∞Âà∞Áã¨Á´ã‰∏ñÁïå‰π¶Êù°ÁõÆÂπ∂ÂêåÊ≠•Êú¨Âú∞Êï∞ÊçÆ');
                    return true;
                } catch (error) {
                    console.error('Êõ¥Êñ∞Áæ§ËÅäÊàêÂëòÂà∞‰∏ñÁïå‰π¶Â§±Ë¥•:', error);
                    return false;
                }
            }

            /**
             * Êõ¥Êñ∞Áæ§ËÅäÂêçÁß∞Âà∞‰∏ñÁïå‰π¶ÔºàË∂ÖÂÆâÂÖ®Ê®°ÂºèÔºöÂÖàÂàõÂª∫Êñ∞Êù°ÁõÆÔºåÁ°ÆËÆ§ÊàêÂäüÂêéÂÜçÂà†Èô§ÊóßÊù°ÁõÆÔºâ
             */
            async function updateGroupNameInWorldbook(oldName, newName) {
                try {
                    console.log('Êõ¥Êñ∞Áæ§ËÅäÂêçÁß∞Âà∞‰∏ñÁïå‰π¶ÔºàÁÆÄÂåñÁâàÔºâ:', oldName, '->', newName);
                    
                    // *** ÈáçË¶Å‰øÆÂ§çÔºöÁ°Æ‰øù‰∏ñÁïå‰π¶ÂèòÈáèÂ∑≤Ê≠£Á°ÆÂàùÂßãÂåñ ***
                    if (!worldbook) {
                        console.log('updateGroupNameInWorldbook: ‰∏ñÁïå‰π¶ÂèòÈáèÊú™ÂàùÂßãÂåñÔºåÈáçÊñ∞Ëé∑Âèñ...');
                        worldbook = await GetWorldBookName();
                        if (!worldbook) {
                            console.error('updateGroupNameInWorldbook: Êó†Ê≥ïËé∑Âèñ‰∏ñÁïå‰π¶');
                            return false;
                        }
                    }
                    
                    if (!entries || entries.length === 0) {
                        console.log('updateGroupNameInWorldbook: entriesÂèòÈáèÊú™ÂàùÂßãÂåñÔºåÈáçÊñ∞Ëé∑Âèñ...');
                        entries = await getLorebookEntries(worldbook);
                        if (!entries) {
                            console.error('updateGroupNameInWorldbook: Êó†Ê≥ïËé∑Âèñ‰∏ñÁïå‰π¶Êù°ÁõÆ');
                            return false;
                        }
                    }
                    
                    console.log('updateGroupNameInWorldbook: ‰∏ñÁïå‰π¶Ê£ÄÊü•ÂÆåÊàêÔºåworldbook:', worldbook, 'entriesÊï∞Èáè:', entries.length);
                    
                    // 1. Êü•ÊâæÊóßÁæ§ËÅäÊù°ÁõÆ - ‰ΩøÁî®ÂîØ‰∏ÄcommentÊü•Êâæ
                    let oldGroupEntry = null;
                    const oldUniqueComment = `ÊâãÊú∫-Áæ§ËÅä-${oldName}`;
                    
                    if (entries) {
                        oldGroupEntry = entries.find(e => 
                            e.comment === oldUniqueComment
                        );
                    }
                    
                    if (!oldGroupEntry) {
                        console.error('Âú®‰∏ñÁïå‰π¶‰∏≠Êú™ÊâæÂà∞Áæ§ËÅäÊù°ÁõÆ:', oldName);
                        console.error('ÂΩìÂâçÊâÄÊúâÁæ§ËÅäÁõ∏ÂÖ≥Êù°ÁõÆ:');
                        if (entries) {
                            entries.filter(e => e.comment.startsWith("ÊâãÊú∫-Áæ§ËÅä")).forEach((e, i) => {
                                console.error(`Áæ§ËÅäÊù°ÁõÆ ${i}:`, {
                                    uid: e.uid,
                                    key: e.key,
                                    comment: e.comment,
                                    content: e.content?.substring(0, 100) + '...'
                                });
                            });
                        }
                        throw new Error(`Êâæ‰∏çÂà∞Ë¶ÅÊõ¥Êñ∞ÁöÑÁæ§ËÅäÊù°ÁõÆ: ${oldName}`);
                    }
                    
                    // 2. Â§á‰ªΩÊóßÊù°ÁõÆÁöÑÊâÄÊúâ‰ø°ÊÅØ
                    const backupContent = oldGroupEntry.content;
                    const backupMembers = extractMembersFromContent(backupContent);
                    const backupAvatar = extractAvatarFromContent(backupContent);
                    
                    console.log('Â§á‰ªΩÁöÑÁæ§ËÅä‰ø°ÊÅØ:', { backupMembers, backupAvatar });
                    
                    // 3. ÂàõÂª∫Êñ∞ÂÜÖÂÆπÔºåÂè™ÊõøÊç¢Áæ§ËÅäÂêçÁß∞
                    const newContent = `[${newName}]
Á±ªÂûã=Áæ§ËÅä
ÊàêÂëò=${backupMembers}
Â§¥ÂÉè=${backupAvatar}`;
                    
                    // 4. Áõ¥Êé•Âú®ÂéüÊù°ÁõÆ‰∏äÊõ¥Êñ∞ÂÜÖÂÆπ„ÄÅcommentÂíåkeyÔºàÈÅøÂÖçÂàõÂª∫Êñ∞Êù°ÁõÆÁöÑÂ§çÊùÇÊÄßÔºâ
                    const newUniqueComment = `ÊâãÊú∫-Áæ§ËÅä-${newName}`;
                    const newGroupEntryKey = `ÊâãÊú∫-Áæ§ËÅä-${newName}`;
                    
                    console.log('Áõ¥Êé•Êõ¥Êñ∞Áé∞ÊúâÊù°ÁõÆ:', oldGroupEntry.uid);
                    console.log('Êñ∞comment:', newUniqueComment);
                    console.log('Êñ∞key:', [newGroupEntryKey]);
                    console.log('Êñ∞ÂÜÖÂÆπ:', newContent.substring(0, 100) + '...');
                    
                    // ‰ΩøÁî®setLorebookEntriesÊõ¥Êñ∞Áé∞ÊúâÊù°ÁõÆÁöÑcomment„ÄÅkeyÂíåcontent
                    await setLorebookEntries(worldbook, [
                        {
                            uid: oldGroupEntry.uid,
                            comment: newUniqueComment,
                            key: [newGroupEntryKey],
                            content: newContent
                        }
                    ]);
                    
                    console.log('Áæ§ËÅäÊù°ÁõÆÊõ¥Êñ∞ÊàêÂäü');
                    
                    // 5. ÈáçÊñ∞Âä†ËΩΩentries‰ª•Êõ¥Êñ∞Êú¨Âú∞Êï∞ÊçÆ
                    entries = await getLorebookEntries(worldbook);
                    
                    // 6. ÂêåÊ≠•Êõ¥Êñ∞ÊâÄÊúâÁõ∏ÂÖ≥ÁöÑÊï∞ÊçÆÁªìÊûÑ
                    console.log('ÂºÄÂßãÂêåÊ≠•Êõ¥Êñ∞Áõ∏ÂÖ≥Êï∞ÊçÆÁªìÊûÑ...');
                    
                    // Êõ¥Êñ∞ QQ_Groups Êï∞ÁªÑ
                    const oldNameIndex = QQ_Groups.indexOf(oldName);
                    if (oldNameIndex !== -1) {
                        QQ_Groups[oldNameIndex] = newName;
                        console.log('Â∑≤Êõ¥Êñ∞ QQ_Groups Êï∞ÁªÑ:', QQ_Groups);
                    }
                    
                    // Êõ¥Êñ∞ QQ_msgjson.Áæ§ËÅä ‰∏≠ÁöÑÊ∂àÊÅØËÆ∞ÂΩï
                    if (QQ_msgjson.Áæ§ËÅä[oldName]) {
                        QQ_msgjson.Áæ§ËÅä[newName] = QQ_msgjson.Áæ§ËÅä[oldName];
                        delete QQ_msgjson.Áæ§ËÅä[oldName];
                        console.log('Â∑≤ËøÅÁßªÁæ§ËÅäÊ∂àÊÅØËÆ∞ÂΩï:', oldName, '->', newName);
                    }
                    
                    // ÈáçË¶ÅÔºöÁ°Æ‰øùQQ_msgjson.Áæ§ËÅä[newName]ÁªìÊûÑÊ≠£Á°Æ
                    if (!QQ_msgjson.Áæ§ËÅä[newName]) {
                        QQ_msgjson.Áæ§ËÅä[newName] = {
                            members: backupMembers.split(',').map(m => m.trim()),
                            msgs: []
                        };
                        console.log('ÈáçÊñ∞ÂàùÂßãÂåñQQ_msgjson.Áæ§ËÅäÊï∞ÊçÆ:', newName);
                    }
                    
                    // *** ‰øÆÂ§çÔºöÁîüÊàêÁ®≥ÂÆöÁöÑÁæ§ËÅäIDÔºåÂü∫‰∫éÂéüÂßãÂêçÁß∞ ***
                    const originalGroupName = oldUniqueComment.replace('ÊâãÊú∫-Áæ§ËÅä-', '');
                    const stableGroupId = `group_${originalGroupName.replace(/[^a-zA-Z0-9\u4e00-\u9fff]/g, '_')}`;
                    console.log('‰∏∫Áæ§ËÅäÁîüÊàêÁ®≥ÂÆöID:', stableGroupId, '(Âü∫‰∫éÂéüÂßãÂêçÁß∞:', originalGroupName, ')');
                    
                    // Êõ¥Êñ∞ÁïåÈù¢ÂÖÉÁ¥†ÁöÑ data Â±ûÊÄßÔºàÂêçÁß∞Êõ¥Êñ∞Ôºå‰ΩÜID‰øùÊåÅÁ®≥ÂÆöÔºâ
                    document.querySelectorAll(`[data-group-name="${oldName}"]`).forEach(element => {
                        element.setAttribute('data-group-name', newName);
                        // Á°Æ‰øù‰ΩøÁî®Á®≥ÂÆöÁöÑÁæ§ËÅäID
                        if (element.hasAttribute('data-group-id')) {
                            element.setAttribute('data-group-id', stableGroupId);
                        }
                        console.log('Â∑≤Êõ¥Êñ∞ÁïåÈù¢ÂÖÉÁ¥† data-group-name Âíå data-group-id Â±ûÊÄß');
                    });
                    
                    // Êõ¥Êñ∞Áæ§ËÅäÈ°µÈù¢ÁöÑ data Â±ûÊÄß
                    document.querySelectorAll(`[data-name="${oldName}"]`).forEach(element => {
                        element.setAttribute('data-name', newName);
                        // Á°Æ‰øù‰ΩøÁî®Á®≥ÂÆöÁöÑÁæ§ËÅäID
                        if (element.hasAttribute('data-group-id')) {
                            element.setAttribute('data-group-id', stableGroupId);
                        }
                        console.log('Â∑≤Êõ¥Êñ∞Áæ§ËÅäÈ°µÈù¢ data-name Âíå data-group-id Â±ûÊÄß');
                    });
                    
                    console.log('Áæ§ËÅäÂêçÁß∞Â∑≤ÊàêÂäüÊõ¥Êñ∞Âà∞‰∏ñÁïå‰π¶Âπ∂ÂêåÊ≠•ÊâÄÊúâÁõ∏ÂÖ≥Êï∞ÊçÆ (ÂÆåÊï¥Áâà)');
                    return true;
                    
                } catch (error) {
                    console.error('Êõ¥Êñ∞Áæ§ËÅäÂêçÁß∞Âà∞‰∏ñÁïå‰π¶Â§±Ë¥•:', error);
                    return false;
                }
            }
            
            /**
             * ‰ªéÊù°ÁõÆÂÜÖÂÆπ‰∏≠ÊèêÂèñÊàêÂëòÂàóË°®
             */
            function extractMembersFromContent(content) {
                const memberMatch = content.match(/ÊàêÂëò=(.+)/);
                return memberMatch ? memberMatch[1] : '';
            }
            
            /**
             * ‰ªéÊù°ÁõÆÂÜÖÂÆπ‰∏≠ÊèêÂèñÂ§¥ÂÉè‰ø°ÊÅØ
             */
            function extractAvatarFromContent(content) {
                const avatarMatch = content.match(/Â§¥ÂÉè=(.+)/);
                return avatarMatch ? avatarMatch[1] : 'http://sharkpan.xyz/f/z0WU5/mmexport1736971020657.gif';
            }

            /**
             * ‰ªé‰∏ñÁïå‰π¶‰∏≠Âà†Èô§Áæ§ËÅä
             */
            async function removeGroupFromWorldbook(groupName) {
                try {
                    console.log('ÂºÄÂßã‰ªéÁã¨Á´ã‰∏ñÁïå‰π¶Êù°ÁõÆ‰∏≠Âà†Èô§Áæ§ËÅä:', groupName);
                    
                    // Êü•ÊâæÂØπÂ∫îÁöÑÁæ§ËÅäÊù°ÁõÆ - ‰ΩøÁî®ÂîØ‰∏ÄcommentÊü•Êâæ
                    let groupEntry = null;
                    let groupIndex = -1;
                    const uniqueComment = `ÊâãÊú∫-Áæ§ËÅä-${groupName}`;
                    
                    if (entries) {
                        groupIndex = entries.findIndex(e => e.comment === uniqueComment);
                        if (groupIndex >= 0) {
                            groupEntry = entries[groupIndex];
                        }
                    }
                    
                    if (!groupEntry) {
                        console.error('Âú®‰∏ñÁïå‰π¶‰∏≠Êú™ÊâæÂà∞Áæ§ËÅäÊù°ÁõÆ:', groupName);
                        return false;
                    }
                    
                    // Âà†Èô§‰∏ñÁïå‰π¶Êù°ÁõÆ
                    await deleteLorebookEntry(worldbook, groupEntry.uid);
                    
                    // ‰ªéÊú¨Âú∞entriesÊï∞ÁªÑ‰∏≠ÁßªÈô§
                    if (groupIndex >= 0 && entries) {
                        entries.splice(groupIndex, 1);
                    }
                    
                    console.log('Áæ§ËÅäÂ∑≤‰ªéÁã¨Á´ã‰∏ñÁïå‰π¶Êù°ÁõÆ‰∏≠Âà†Èô§');
                    return true;
                } catch (error) {
                    console.error('‰ªé‰∏ñÁïå‰π¶‰∏≠Âà†Èô§Áæ§ËÅäÂ§±Ë¥•:', error);
                    return false;
                }
            }


            
            /**
             * ÂàáÊç¢Âà∞Áæ§ËÅäÁïåÈù¢
             */
            function switchToGroupChat(groupData) {
                console.log('ÂàáÊç¢Âà∞Áæ§ËÅä:', groupData.name);
                console.log('Áæ§ËÅäÊàêÂëò:', groupData.members);
                
                // ËÆæÁΩÆÂΩìÂâçÊ¥ªË∑ÉÁöÑÁæ§ËÅä
                window.currentGroupChat = groupData;
                
                // ÂàáÊç¢Âà∞ËÅäÂ§©ÁïåÈù¢
                QQ_Nav('chat');
                
                // Âª∂ËøüÊõ¥Êñ∞ÔºåÁ°Æ‰øùÈ°µÈù¢Â∑≤ÁªèÂàáÊç¢
                setTimeout(() => {
                    // Á°Æ‰øùÁæ§ËÅäÈ°µÈù¢Â≠òÂú®‰∏îÊòØÁã¨Á´ãÁöÑ
                    ensureGroupChatPage(groupData);
                    
                    // Êõ¥Êñ∞ËÅäÂ§©ÁïåÈù¢ÁöÑÂ§¥ÈÉ®‰ø°ÊÅØ
                    updateChatHeader(groupData);
                    
                    // Âä†ËΩΩÁæ§ËÅäÊ∂àÊÅØÂéÜÂè≤
                    loadGroupChatHistory(groupData.id);
                    
                    // Êõ¥Êñ∞ËÅäÂ§©Âå∫ÂüüÁöÑÊ†áÈ¢ò
                    const chatUsername = document.getElementById('QQ_chat_username');
                    if (chatUsername) {
                        chatUsername.textContent = groupData.name;
                    }
                }, 100);
            }
            
            /**
             * Á°Æ‰øùÁæ§ËÅäÈ°µÈù¢Â≠òÂú®‰∏îÁã¨Á´ã
             */
            function ensureGroupChatPage(groupData) {
                console.log('Á°Æ‰øùÁæ§ËÅäÈ°µÈù¢Â≠òÂú®:', groupData.name, 'ID:', groupData.id);
                
                // ÈöêËóèÊâÄÊúâÁé∞ÊúâÁöÑËÅäÂ§©È°µÈù¢
                $('.QQ_chat_page').hide();
                
                // Êü•ÊâæÁé∞ÊúâÁöÑÁæ§ËÅäÈ°µÈù¢
                let groupChatPage = $(`.QQ_chat_page[data-group-id="${groupData.id}"]`);
                
                if (groupChatPage.length === 0) {
                    console.log('ÂàõÂª∫Êñ∞ÁöÑÁæ§ËÅäÈ°µÈù¢:', groupData.name);
                    // ÂàõÂª∫Êñ∞ÁöÑÁæ§ËÅäÈ°µÈù¢
                    groupChatPage = createGroupChatPage(groupData);
                    $('#App_QQ').append(groupChatPage);
                } else {
                    console.log('‰ΩøÁî®Áé∞ÊúâÁæ§ËÅäÈ°µÈù¢:', groupData.name);
                }
                
                // ÊòæÁ§∫ÂΩìÂâçÁæ§ËÅäÈ°µÈù¢
                groupChatPage.show();
                
                return groupChatPage;
            }
            
            /**
             * ÂàõÂª∫Áæ§ËÅä‰∏ìÁî®È°µÈù¢
             */
            function createGroupChatPage(groupData) {
                console.log('ÂàõÂª∫Áæ§ËÅä‰∏ìÁî®È°µÈù¢:', groupData.name);
                
                const pageHTML = `
                    <div class="QQ_chat_page group-chat-page" data-group-id="${groupData.id}" data-name="${groupData.name}" style="display: none;">
                        <div class="QQ_chat_head" style="display: flex; align-items: center; padding: 10px; background: white; border-bottom: 1px solid #eee;">
                            <div class="QQ_chat_head_back" style="margin-right: 15px; cursor: pointer;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                    <path d="M15 18L9 12L15 6" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="QQ_chat_head_avatar" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; background: linear-gradient(135deg, #199AFF, #0066CC); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">Áæ§</div>
                            <div style="flex: 1;">
                                <span id="QQ_chat_username" class="group-chat-clickable-name" style="font-size: 16px; font-weight: bold; cursor: pointer;">${groupData.name}</span>
                                <div style="font-size: 12px; color: #999; margin-top: 2px;">Áæ§ËÅä ¬∑ ${groupData.members.length}‰∫∫</div>
                            </div>
                        </div>
                        <div class="msgcontent" style="flex: 1; overflow-y: auto; padding: 10px; background: #f5f5f5;">
                            <!-- Áæ§ËÅäÊ∂àÊÅØÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                        </div>
                        <div class="QQ_chat_input_area" style="padding: 10px; background: white; border-top: 1px solid #eee;">
                            <div style="display: flex; align-items: center;">
                                <input type="text" class="group-chat-input userInput" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 20px; outline: none;">
                                <button class="group-chat-send-btn" style="margin-left: 10px; padding: 8px 16px; background: #007AFF; color: white; border: none; border-radius: 20px; cursor: pointer;">ÂèëÈÄÅ</button>
                            </div>
                        </div>
                    </div>
                `;
                
                const $page = $(pageHTML);
                
                // ÁªëÂÆöËøîÂõûÊåâÈíÆ‰∫ã‰ª∂
                $page.find('.QQ_chat_head_back').on('click', function() {
                    // ÈáçÊñ∞ÊòæÁ§∫Â∫ïÈÉ®ÂØºËà™Ê†è
                    $('.QQ_bottom_nav').show();
                    
                    console.log('Áæ§ËÅäËøîÂõûÊåâÈíÆË¢´ÁÇπÂáª');
                    // Ê†πÊçÆÊù•Ê∫êÈ°µÈù¢ËøîÂõû
                    const sourcePage = window.groupChatSourcePage || 'contacts';
                    if (sourcePage === 'messages') {
                        QQ_Nav('message');
                    } else {
                        QQ_Nav('people');
                    }
                    // Ê∏ÖÈô§Áæ§ËÅäÁä∂ÊÄÅ
                    window.currentGroupChat = null;
                });
                
                // ÁªëÂÆöÁæ§ËÅäÂêçÁß∞ÁÇπÂáª‰∫ã‰ª∂
                $page.find('.group-chat-clickable-name').on('click', function() {
                    console.log('Áæ§ËÅäÂêçÁß∞Ë¢´ÁÇπÂáª:', groupData.name);
                    showGroupManagementMenu(groupData, this);
                });
                
                // ÁªëÂÆöÂèëÈÄÅÊ∂àÊÅØ‰∫ã‰ª∂
                const $input = $page.find('.group-chat-input');
                const $sendBtn = $page.find('.group-chat-send-btn');
                

                
                // ‰øÆÊîπ‰∏∫‰∏§Èò∂ÊÆµÂèëÈÄÅÊú∫Âà∂ÔºöEnterÈîÆÁºìÂ≠òÊ∂àÊÅØÔºåÁÇπÂáªÂèëÈÄÅÊåâÈíÆÊâçÁúüÊ≠£ÂèëÈÄÅ
                $sendBtn.on('click', function() {
                    // ÁÇπÂáªÂèëÈÄÅÊåâÈíÆÊó∂Ôºå‰ΩøÁî®QQ_SendMsgÂèëÈÄÅÁºìÂ≠òÁöÑÊ∂àÊÅØ
                    const fakeEvent = { target: $page[0] };
                    QQ_SendMsg(fakeEvent);
                });
                
                // ‰ΩøÁî®Áªü‰∏ÄÁöÑEnterÈîÆÂ§ÑÁêÜÊú∫Âà∂
                $input.on('keydown', function(e) {
                    QQ_EnterPress(e, this);
                });
                

                
                return $page;
            }
            
            /**
             * Ê∑ªÂä†Êñ∞Áæ§ËÅäÔºàÁ±ª‰ººAddNewCharÔºâ
             */
            /**
             * ÂàõÂª∫Êñ∞Áæ§ËÅäÔºàÂü∫‰∫é‰∏ñÁïå‰π¶ÔºåÁ±ª‰ººÁßÅËÅäÈÄªËæëÔºâ
             */
            async function createNewGroup(groupName, members, avatarUrl) {
                console.log('=== ÂàõÂª∫Êñ∞Áæ§ËÅäÂºÄÂßã ===');
                console.log('Áæ§ËÅäÂêçÁß∞:', groupName);
                console.log('ÊàêÂëòÂàóË°®:', members);
                console.log('Â§¥ÂÉèURL:', avatarUrl);
                
                try {
                    // 1. Ê∑ªÂä†Âà∞‰∏ñÁïå‰π¶
                    const groupData = {
                        name: groupName,
                        members: members,
                        avatar: {
                            type: 'upload',
                            imageData: avatarUrl || 'http://sharkpan.xyz/f/z0WU5/mmexport1736971020657.gif'
                        }
                    };
                    
                    console.log('ÂáÜÂ§áË∞ÉÁî®addGroupToWorldbookÔºåÊï∞ÊçÆ:', groupData);
                    const success = await addGroupToWorldbook(groupData);
                    console.log('addGroupToWorldbookËøîÂõûÁªìÊûú:', success);
                    
                    if (!success) {
                        throw new Error('Ê∑ªÂä†Âà∞‰∏ñÁïå‰π¶Â§±Ë¥•');
                    }
                    
                    // Á´ãÂç≥Âà∑Êñ∞entriesÔºåÁ°Æ‰øùÊñ∞ÂàõÂª∫ÁöÑÁæ§ËÅäËÉΩË¢´Âä†ËΩΩ
                    console.log('Âà∑Êñ∞entries‰ª•ÂåÖÂê´Êñ∞ÂàõÂª∫ÁöÑÁæ§ËÅä');
                    try {
                        entries = await getLorebookEntries(worldbook);
                        console.log('entriesÂà∑Êñ∞ÊàêÂäüÔºåÊñ∞ÁöÑÊù°ÁõÆÊï∞Èáè:', entries ? entries.length : 'failed');
                    } catch (e) {
                        console.warn('Âà∑Êñ∞entriesÂ§±Ë¥•Ôºå‰ΩÜÁæ§ËÅäÂ∑≤ÂàõÂª∫:', e);
                    }
                    
                    // 2. Á°Æ‰øùÁæ§ËÅäÁ´ãÂç≥Âä†ÂÖ•QQ_GroupsÊï∞ÁªÑ
                    if (!QQ_Groups.includes(groupName)) {
                        QQ_Groups.push(groupName);
                        console.log(`Áæ§ËÅä "${groupName}" Â∑≤Á´ãÂç≥Âä†ÂÖ•QQ_GroupsÊï∞ÁªÑ`);
                    }
                    
                    // 3. Á°Æ‰øùQQ_msgjson‰∏≠ÊúâËØ•Áæ§ËÅäÁöÑÊï∞ÊçÆÁªìÊûÑ
                    if (!QQ_msgjson.Áæ§ËÅä[groupName]) {
                        QQ_msgjson.Áæ§ËÅä[groupName] = {
                            members: members || [],
                            msgs: []
                        };
                        console.log('Âú®QQ_msgjson.Áæ§ËÅä‰∏≠ÂàùÂßãÂåñÁæ§ËÅäÊï∞ÊçÆ:', groupName);
                    }
                    
                    // 4. Á´ãÂç≥ÈáçÊñ∞Âä†ËΩΩÁæ§ËÅä‰ª•Á°Æ‰øùÊòæÁ§∫Âú®ÁïåÈù¢‰∏ä
                    console.log('Á´ãÂç≥ÈáçÊñ∞Âä†ËΩΩÁæ§ËÅäÊï∞ÊçÆ‰ª•ÊòæÁ§∫Êñ∞ÂàõÂª∫ÁöÑÁæ§ËÅä');
                    await loadGroupChatsFromWorldbook();
                    
                    console.log('Áæ§ËÅäÂàõÂª∫ÊàêÂäü:', groupName);
                    console.log('ÂΩìÂâçQQ_GroupsÊï∞ÁªÑ:', QQ_Groups);
                    return true;
                } catch (error) {
                    console.error('ÂàõÂª∫Áæ§ËÅäÂ§±Ë¥•:', error);
                    toastr.error('ÂàõÂª∫Áæ§ËÅäÂ§±Ë¥•: ' + error.message);
                    return false;
                }
            }
            
            /**
             * Âà†Èô§Áæ§ËÅäÔºàÂü∫‰∫é‰∏ñÁïå‰π¶ÔºåÁ±ª‰ººÁßÅËÅäÈÄªËæëÔºâ
             */
            async function deleteGroupChat(groupName) {
                console.log('Âà†Èô§Áæ§ËÅä:', groupName);
                
                try {
                    // 1. ‰ªé‰∏ñÁïå‰π¶Âà†Èô§
                    const success = await removeGroupFromWorldbook(groupName);
                    if (!success) {
                        throw new Error('‰ªé‰∏ñÁïå‰π¶Âà†Èô§Â§±Ë¥•');
                    }
                    
                    // 2. ‰ªéÁïåÈù¢Âà†Èô§
                    $(`.QQ_home_usermsg[data-name='${groupName}']`).remove();
                    
                    // 3. ‰ªéÊï∞ÊçÆÁªìÊûÑÂà†Èô§
                    delete QQ_msgjson.Áæ§ËÅä[groupName];
                    const index = QQ_Groups.indexOf(groupName);
                    if (index > -1) {
                        QQ_Groups.splice(index, 1);
                    }
                    const pageIndex = QQ_pages.indexOf(groupName);
                    if (pageIndex > -1) {
                        QQ_pages.splice(pageIndex, 1);
                    }
                    
                    // 4. Âà†Èô§ËÅäÂ§©È°µÈù¢
                    $(`.QQ_chat_page[data-name='${groupName}']`).remove();
                    
                    // 5. Á´ãÂç≥Âà∑Êñ∞entriesÔºåÁ°Æ‰øùÂà†Èô§ÁöÑÁæ§ËÅä‰ªéÁïåÈù¢Ê∂àÂ§±
                    console.log('Âà∑Êñ∞entries‰ª•ÁßªÈô§Â∑≤Âà†Èô§ÁöÑÁæ§ËÅä');
                    try {
                        entries = await getLorebookEntries(worldbook);
                        console.log('entriesÂà∑Êñ∞ÊàêÂäüÔºåÊñ∞ÁöÑÊù°ÁõÆÊï∞Èáè:', entries ? entries.length : 'failed');
                    } catch (e) {
                        console.warn('Âà∑Êñ∞entriesÂ§±Ë¥•Ôºå‰ΩÜÁæ§ËÅäÂ∑≤Âà†Èô§:', e);
                    }
                    
                    // 6. Á´ãÂç≥ÈáçÊñ∞Âä†ËΩΩÁæ§ËÅä‰ª•Á°Æ‰øùÂ∑≤Âà†Èô§ÁöÑÁæ§ËÅä‰ªéÁïåÈù¢Ê∂àÂ§±
                    console.log('Á´ãÂç≥ÈáçÊñ∞Âä†ËΩΩÁæ§ËÅäÊï∞ÊçÆ‰ª•ÁßªÈô§Â∑≤Âà†Èô§ÁöÑÁæ§ËÅä');
                    await loadGroupChatsFromWorldbook();
                    
                    // 7. Êõ¥Êñ∞Ê∂àÊÅØÂàóË°®
                    setTimeout(async () => {
                        await QQ_UpdateMessageList();
                    }, 100);
                    
                    console.log('Áæ§ËÅäÂà†Èô§ÊàêÂäü:', groupName);
                    console.log('ÂΩìÂâçQQ_GroupsÊï∞ÁªÑ:', QQ_Groups);
                    return true;
                } catch (error) {
                    console.error('Âà†Èô§Áæ§ËÅäÂ§±Ë¥•:', error);
                    toastr.error('Âà†Èô§Áæ§ËÅäÂ§±Ë¥•: ' + error.message);
                    return false;
                }
            }
            
            /**
             * ‰øùÂ≠òÁæ§ËÅäÊ∂àÊÅØÂà∞Êú¨Âú∞Â≠òÂÇ®ÂíåQQ_msgjson
             */
            function saveGroupMessage(groupId, message) {
                try {
                    // *** ‰øÆÂ§çÔºöÂÆûÈôÖ‰øùÂ≠òÁæ§ËÅäÊ∂àÊÅØÂà∞QQ_msgjson.Áæ§ËÅä ***
                    
                    // Á°Æ‰øùQQ_msgjson.Áæ§ËÅäÁªìÊûÑÂ≠òÂú®
                    if (!QQ_msgjson.Áæ§ËÅä) {
                        QQ_msgjson.Áæ§ËÅä = {};
                    }
                    
                    // Ê†πÊçÆgroupIdÊâæÂà∞ÂØπÂ∫îÁöÑÁæ§ËÅäÂêçÁß∞
                    let groupName = null;
                    
                    // Â∞ùËØï‰ªéQQ_GroupsÊï∞ÁªÑ‰∏≠ÂåπÈÖç
                    for (const name of QQ_Groups) {
                        if (name.includes(groupId) || groupId.includes(name)) {
                            groupName = name;
                            break;
                        }
                    }
                    
                    // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ÔºåÂ∞ùËØïÈÄöËøáÁïåÈù¢ÂÖÉÁ¥†Êü•Êâæ
                    if (!groupName) {
                        const groupElement = document.querySelector(`[data-group-id="${groupId}"]`);
                        if (groupElement) {
                            groupName = groupElement.getAttribute('data-name') || 
                                       groupElement.textContent.trim() ||
                                       groupId; // ÊúÄÂêé‰ΩøÁî®groupId‰Ωú‰∏∫ÂêçÁß∞
                        } else {
                            groupName = groupId; // Áõ¥Êé•‰ΩøÁî®groupId
                        }
                    }
                    
                    console.log(`‰øùÂ≠òÁæ§ËÅäÊ∂àÊÅØ - groupId: ${groupId}, groupName: ${groupName}`, message);
                    
                    // Á°Æ‰øùËØ•Áæ§ËÅäÂú®QQ_msgjson.Áæ§ËÅä‰∏≠Â≠òÂú®
                    if (!QQ_msgjson.Áæ§ËÅä[groupName]) {
                        QQ_msgjson.Áæ§ËÅä[groupName] = {
                            msgs: [],
                            members: []
                        };
                        console.log(`ÂàùÂßãÂåñÁæ§ËÅäÊï∞ÊçÆÁªìÊûÑ: ${groupName}`);
                    }
                    
                    // ÊûÑÈÄ†Ê∂àÊÅØÊ†ºÂºèÔºöÂèëÈÄÅËÄÖ--Ê∂àÊÅØÂÜÖÂÆπ
                    const msgString = `${message.sender}--${message.content}`;
                    
                    // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®Áõ∏ÂêåÊ∂àÊÅØÔºàÈÅøÂÖçÈáçÂ§çÔºâ
                    const isDuplicate = QQ_msgjson.Áæ§ËÅä[groupName].msgs.some(msg => 
                        msg === msgString || msg.includes(message.content)
                    );
                    
                    if (!isDuplicate) {
                        // Ê∑ªÂä†Ê∂àÊÅØÂà∞Áæ§ËÅäËÆ∞ÂΩï‰∏≠
                        QQ_msgjson.Áæ§ËÅä[groupName].msgs.push(msgString);
                        console.log(`‚úì Áæ§ËÅäÊ∂àÊÅØÂ∑≤‰øùÂ≠òÂà∞QQ_msgjson.Áæ§ËÅä[${groupName}], ÂΩìÂâçÊ∂àÊÅØÊï∞: ${QQ_msgjson.Áæ§ËÅä[groupName].msgs.length}`);
                        
                        // *** Êñ∞Â¢ûÔºöÁ´ãÂç≥‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶ ***
                        setTimeout(async () => {
                            await QQ_Save_Msg();
                            console.log('‚úì Áæ§ËÅäÊ∂àÊÅØÂ∑≤ÂêåÊ≠•‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶Â§á‰ªΩ');
                        }, 100);
                    } else {
                        console.log('Ë∑≥ËøáÈáçÂ§çÁöÑÁæ§ËÅäÊ∂àÊÅØ:', msgString);
                    }
                    
                } catch (error) {
                    console.error('‰øùÂ≠òÁæ§ËÅäÊ∂àÊÅØÂ§±Ë¥•:', error);
                }
            }
            
            /**
             * ÊÅ¢Â§çÁæ§ËÅäÊï∞ÊçÆÂà∞QQ_msgjsonÔºàÁ±ª‰ººÁßÅËÅäÁöÑÊÅ¢Â§çÊú∫Âà∂Ôºâ
             */
            async function restoreGroupDataToMsgjson() {
                console.log('ÂºÄÂßãÊÅ¢Â§çÁæ§ËÅäÊï∞ÊçÆÂà∞QQ_msgjson');
                const groups = await loadGroupsFromStorage();
                
                groups.forEach(groupData => {
                    // Á°Æ‰øùQQ_msgjson‰∏≠ÊúâËØ•Áæ§ËÅäÁöÑÊï∞ÊçÆÁªìÊûÑ
                    if (!QQ_msgjson.Áæ§ËÅä[groupData.name]) {
                        QQ_msgjson.Áæ§ËÅä[groupData.name] = {
                            members: groupData.members || [],
                            msgs: []
                        };
                    }
                    
                    // *** ‰øÆÂ§çÔºö‰øùÊåÅÁé∞ÊúâÊ∂àÊÅØÔºå‰∏çË¶ÅÊ∏ÖÁ©∫ ***
                    // Â¶ÇÊûúQQ_msgjson‰∏≠Â∑≤ÁªèÊúâÊ∂àÊÅØÔºå‰øùÊåÅÂÆÉ‰ª¨
                    console.log(`Áæ§ËÅä ${groupData.name} ÂΩìÂâçÊúâ ${QQ_msgjson.Áæ§ËÅä[groupData.name].msgs.length} Êù°Ê∂àÊÅØ`);
                    
                    // Á°Æ‰øùÁæ§ËÅäÂú®QQ_GroupsÊï∞ÁªÑ‰∏≠
                    if (!QQ_Groups.includes(groupData.name)) {
                        QQ_Groups.push(groupData.name);
                    }
                    
                    // *** Êñ∞Â¢ûÔºöÈáçÊñ∞Âä†ËΩΩÂêéÁ´ãÂç≥Êõ¥Êñ∞Áæ§ËÅäÊúÄÂêéÊ∂àÊÅØÊòæÁ§∫ ***
                    if (QQ_msgjson.Áæ§ËÅä[groupData.name].msgs.length > 0) {
                        setTimeout(() => {
                            updateGroupLastMessageDisplay(groupData.name);
                        }, 200);
                    }
                    
                    console.log(`ÊÅ¢Â§çÁæ§ËÅäÊï∞ÊçÆ: ${groupData.name}, Ê∂àÊÅØÊï∞Èáè: ${QQ_msgjson.Áæ§ËÅä[groupData.name].msgs.length}`);
                });
            }
            
            /**
             * Êõ¥Êñ∞Áæ§ËÅäÁöÑÊúÄÂêéÊ∂àÊÅØÂíåÊó∂Èó¥
             */
            async function updateGroupLastMessage(groupId, message) {
                try {
                    const groups = await loadGroupsFromStorage();
                    
                    // ‰øÆÂ§çÔºöÁ°Æ‰øùgroupsÊòØÊúâÊïàÁöÑÊï∞ÁªÑ
                    if (!groups || !Array.isArray(groups)) {
                        console.warn('groupsÊï∞ÊçÆÊó†ÊïàÔºåË∑≥ËøáÊõ¥Êñ∞Áæ§ËÅäÊúÄÂêéÊ∂àÊÅØ:', groupId);
                        return;
                    }
                    
                    const groupIndex = groups.findIndex(g => g && g.id === groupId);
                    
                    if (groupIndex !== -1) {
                        const currentTime = new Date();
                        groups[groupIndex].lastMessage = message;
                        groups[groupIndex].lastTime = currentTime.toLocaleTimeString('zh-CN', { hour12: false }).slice(0, 5);
                        groups[groupIndex].timestamp = groups[groupIndex].lastTime;
                        
                        // Êñ∞ÁâàÊú¨Ôºö‰∏çÂÜç‰ΩøÁî®localStorage‰øùÂ≠òÁæ§ËÅäÊï∞ÊçÆ
                        console.log('Áæ§ËÅäÊúÄÂêéÊ∂àÊÅØÂ∑≤Êõ¥Êñ∞Ôºà‰ªÖÂÜÖÂ≠òÔºâ');
                        
                        // Êõ¥Êñ∞ÁïåÈù¢ÊòæÁ§∫
                        const messageElement = $(`.QQ_home_usermsg[data-group-id="${groupId}"]`)[0];
                        const contactElement = $(`.QQ_home_usermsg[data-group-id="${groupId}"]`)[0];
                        
                        if (messageElement) {
                            updateGroupInMessageList(messageElement, groups[groupIndex]);
                        }
                        if (contactElement) {
                            updateGroupInContactList(contactElement, groups[groupIndex]);
                        }
                        
                        console.log('Áæ§ËÅäÊúÄÂêéÊ∂àÊÅØÂ∑≤Êõ¥Êñ∞:', groups[groupIndex]);
                    }
                } catch (error) {
                    console.error('Êõ¥Êñ∞Áæ§ËÅäÊúÄÂêéÊ∂àÊÅØÂ§±Ë¥•:', error);
                }
            }
            
            /**
             * Âä†ËΩΩÁæ§ËÅäÊ∂àÊÅØÂéÜÂè≤
             */
            function loadGroupChatHistory(groupId) {
                console.log('Âä†ËΩΩÁæ§ËÅäÊ∂àÊÅØÂéÜÂè≤:', groupId);
                
                try {
                    // Êñ∞ÁâàÊú¨ÔºöÁæ§ËÅäÊ∂àÊÅØÂéÜÂè≤ÊöÇÊó∂‰∏çÊåÅ‰πÖÂåñÔºåÊØèÊ¨°ÈáçÊñ∞ÂºÄÂßã
                    const messages = [];
                    console.log('Áæ§ËÅäÊ∂àÊÅØÂéÜÂè≤ÔºàÊñ∞‰ºöËØùÔºâ:', messages.length, 'Êù°');
                    
                    // Êü•ÊâæÁæ§ËÅä‰∏ìÁî®È°µÈù¢ÁöÑÊ∂àÊÅØÂÆπÂô®
                    const groupChatPage = $(`.QQ_chat_page[data-group-id="${groupId}"]`);
                    const msgContent = groupChatPage.find('.msgcontent')[0] || document.querySelector('.group-chat-page .msgcontent');
                    
                    if (msgContent) {
                        msgContent.innerHTML = '';
                        
                        // Â¶ÇÊûúÊúâÂéÜÂè≤Ê∂àÊÅØÔºåÊòæÁ§∫ÂÆÉ‰ª¨
                        messages.forEach(message => {
                            displayGroupMessage(message, msgContent);
                        });
                        
                        // ÊªöÂä®Âà∞Â∫ïÈÉ®
                        msgContent.scrollTop = msgContent.scrollHeight;
                    } else {
                        console.error('Êú™ÊâæÂà∞Áæ§ËÅäÊ∂àÊÅØÂÆπÂô®');
                    }
                    
                    if (messages.length === 0) {
                        // Â¶ÇÊûúÊ≤°ÊúâÂéÜÂè≤Ê∂àÊÅØÔºåÊòæÁ§∫Ê¨¢Ëøé‰ø°ÊÅØ
                        if (msgContent && window.currentGroupChat) {
                            const welcomeMsg = document.createElement('div');
                            welcomeMsg.style.cssText = 'text-align: center; color: #999; padding: 20px; font-size: 14px;';
                            welcomeMsg.innerHTML = `
                                <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">${window.currentGroupChat.name}</div>
                                <div style="font-size: 14px; margin-bottom: 10px;">Áæ§ÊàêÂëò: ${window.currentGroupChat.members.join(', ')}</div>
                                <div style="font-size: 12px; color: #999;">Áæ§ËÅäÂ∑≤ÂàõÂª∫ÔºåÂºÄÂßãËÅäÂ§©ÂêßÔºÅ</div>
                            `;
                            msgContent.appendChild(welcomeMsg);
                        }
                    }
                } catch (error) {
                    console.error('Âä†ËΩΩÁæ§ËÅäÊ∂àÊÅØÂéÜÂè≤Â§±Ë¥•:', error);
                }
            }
            
            /**
             * ÊòæÁ§∫Áæ§ËÅäÊ∂àÊÅØ
             */
            function displayGroupMessage(message, msgContent = null) {
                if (!msgContent) {
                    msgContent = document.querySelector('.group-chat-page .msgcontent') || document.querySelector('.msgcontent');
                }
                if (!msgContent) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'QQ_chat_msgdiv group-message';
                messageDiv.setAttribute('data-name', message.sender);
                messageDiv.style.cssText = 'margin: 10px 0; padding: 10px; background: white; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);';
                
                const senderSpan = document.createElement('span');
                senderSpan.style.cssText = 'font-weight: bold; color: #007AFF; margin-right: 8px; font-size: 14px;';
                senderSpan.textContent = message.sender + ':';
                
                const contentSpan = document.createElement('span');
                contentSpan.style.cssText = 'color: #333; font-size: 14px; line-height: 1.4;';
                contentSpan.textContent = message.content;
                
                const timeSpan = document.createElement('span');
                timeSpan.style.cssText = 'font-size: 12px; color: #999; margin-left: 8px; float: right;';
                timeSpan.textContent = message.timestamp || new Date().toLocaleTimeString();
                
                messageDiv.appendChild(senderSpan);
                messageDiv.appendChild(contentSpan);
                messageDiv.appendChild(timeSpan);
                
                msgContent.appendChild(messageDiv);
            }
            
            /**
             * ÂàáÊç¢Âà∞ÁßÅËÅäÊó∂Ê∏ÖÈô§Áæ§ËÅäÁä∂ÊÄÅ
             */
            function clearGroupChatState() {
                if (window.currentGroupChat) {
                    console.log('Á¶ªÂºÄÁæ§ËÅä:', window.currentGroupChat.name);
                    window.currentGroupChat = null;
                }
            }
            
            // ÁõëÂê¨ÁßÅËÅäÂàáÊç¢ÔºåÊ∏ÖÈô§Áæ§ËÅäÁä∂ÊÄÅ
            const originalQQNav = window.QQ_Nav;
            // QQ_NavÂáΩÊï∞Â∑≤Âú®ÂâçÈù¢Ê≠£Á°ÆÂÆö‰πâÔºåÊó†ÈúÄÈáçÂ§çÂÆö‰πâ
            
            /**
             * Á°Æ‰øùÁæ§ËÅäÂú®ËÅîÁ≥ª‰∫∫ÂàóË°®‰∏≠Â≠òÂú®
             */
            async function ensureGroupsInContactList() {
                const groups = await loadGroupsFromStorage();
                const contactsContainer = document.getElementById('QQ_home_chars');
                
                if (!contactsContainer) {
                    console.log('ËÅîÁ≥ª‰∫∫ÂÆπÂô®‰∏çÂ≠òÂú®ÔºåË∑≥ËøáÁæ§ËÅäÊÅ¢Â§ç');
                    return;
                }
                
                if (groups.length === 0) {
                    console.log('Ê≤°ÊúâÁæ§ËÅäÊï∞ÊçÆÈúÄË¶ÅÊÅ¢Â§ç');
                    return;
                }
                
                console.log('Ê£ÄÊü•ËÅîÁ≥ª‰∫∫ÂàóË°®‰∏≠ÁöÑÁæ§ËÅäÔºåÂÖ±', groups.length, '‰∏™Áæ§ËÅäÈúÄË¶ÅÊÅ¢Â§ç');
                console.log('Áæ§ËÅäÊï∞ÊçÆ:', groups.map(g => ({name: g.name, id: g.id, avatar: g.avatar})));
                
                // ÂÖàÊ∏ÖÁêÜÈáçÂ§çÁöÑÁæ§ËÅäÂÖÉÁ¥†Ôºå‰ΩÜ‰øùÁïô‰∏Ä‰∏™
                const existingGroups = contactsContainer.querySelectorAll('[data-group-type="true"]');
                const groupMap = new Map();
                const groupNameMap = new Map(); // ÊåâÂêçÁß∞Á¥¢Âºï
                
                console.log('Áé∞ÊúâÁæ§ËÅäÂÖÉÁ¥†Êï∞Èáè:', existingGroups.length);
                
                existingGroups.forEach(element => {
                    const groupId = element.getAttribute('data-group-id');
                    const groupName = element.getAttribute('data-name');
                    
                    console.log('Ê£ÄÊü•Áé∞ÊúâÁæ§ËÅäÂÖÉÁ¥†:', {groupId, groupName});
                    
                    if (groupId) {
                        if (groupMap.has(groupId)) {
                            console.log('ÁßªÈô§ÈáçÂ§çÁöÑÁæ§ËÅäÂÖÉÁ¥†(ÊåâID):', groupId);
                            element.remove();
                        } else {
                            groupMap.set(groupId, element);
                            if (groupName) {
                                groupNameMap.set(groupName, element);
                            }
                        }
                    } else if (groupName) {
                        // Â¶ÇÊûúÊ≤°ÊúâID‰ΩÜÊúâÂêçÁß∞Ôºå‰πüËÆ∞ÂΩï‰∏ãÊù•
                        if (groupNameMap.has(groupName)) {
                            console.log('ÁßªÈô§ÈáçÂ§çÁöÑÁæ§ËÅäÂÖÉÁ¥†(ÊåâÂêçÁß∞):', groupName);
                            element.remove();
                        } else {
                            groupNameMap.set(groupName, element);
                        }
                    }
                });
                
                // ÁÑ∂ÂêéÊ∑ªÂä†Áº∫Â§±ÁöÑÁæ§ËÅä
                groups.forEach(groupData => {
                    const existsByID = groupMap.has(groupData.id);
                    const existsByName = groupNameMap.has(groupData.name);
                    
                    if (!existsByID && !existsByName) {
                        console.log('ÊÅ¢Â§çÁæ§ËÅäÂà∞ËÅîÁ≥ª‰∫∫ÂàóË°®:', groupData.name, 'ID:', groupData.id);
                        AddNewGroup(groupData.name, groupData.avatar || 'https://files.catbox.moe/skngqq.jpg', groupData.members, groupData.description);
                    } else {
                        console.log('Áæ§ËÅäÂ∑≤Â≠òÂú®‰∫éËÅîÁ≥ª‰∫∫ÂàóË°®:', groupData.name);
                        // Á°Æ‰øùÁé∞ÊúâÁæ§ËÅäÁöÑÂ§¥ÂÉèÊ≠£Á°ÆÊòæÁ§∫
                        const existingElement = existsByID ? groupMap.get(groupData.id) : groupNameMap.get(groupData.name);
                        if (existingElement) {
                            updateGroupAvatarInElement(existingElement, groupData);
                        }
                    }
                });
                
                console.log('ËÅîÁ≥ª‰∫∫ÂàóË°®Áæ§ËÅäÊÅ¢Â§çÂÆåÊàê');
            }
            
            /**
             * Êõ¥Êñ∞Áæ§ËÅäÂÖÉÁ¥†‰∏≠ÁöÑÂ§¥ÂÉèÊòæÁ§∫
             */
            function updateGroupAvatarInElement(element, groupData) {
                const avatarElement = element.querySelector('.QQ_home_head');
                if (!avatarElement) return;
                
                // ÈáçÁΩÆÂ§¥ÂÉèÊ†∑Âºè
                avatarElement.style.backgroundImage = '';
                avatarElement.style.background = '';
                avatarElement.textContent = '';
                
                // Â∫îÁî®Â§¥ÂÉè
                applyGroupAvatar(avatarElement, groupData.avatar);
            }
            
            /**
             * ‰ªé‰∏ñÁïå‰π¶Ëé∑ÂèñËßíËâ≤Â§¥ÂÉèÊï∞ÊçÆ
             */
            function getCharacterAvatarFromWorldbook(characterName) {
                console.log(`‰ªé‰∏ñÁïå‰π¶Ëé∑ÂèñËßíËâ≤Â§¥ÂÉè: ${characterName}`);
                
                // ‰ªé‰∏ñÁïå‰π¶ "ÊâãÊú∫-ËßíËâ≤" Êù°ÁõÆËé∑ÂèñÂ§¥ÂÉè
                let entry = GetWorldEntry(["ÊâãÊú∫-ËßíËâ≤", "ÊâãÊú∫ÁïåÈù¢-ËßíËâ≤"], true);
                if (!entry || !entry.content) {
                    console.log('Êú™ÊâæÂà∞ÊâãÊú∫-ËßíËâ≤‰∏ñÁïå‰π¶Êù°ÁõÆ');
                    return null;
                }
                
                const content = entry.content;
                const lines = content.split('\n');
                let currentSection = null;
                
                for (let line of lines) {
                    line = line.trim();
                    if (line.startsWith('[') && line.endsWith(']')) {
                        currentSection = line.slice(1, -1);
                    } else if (currentSection === characterName && line.startsWith('Â§¥ÂÉè=')) {
                        const avatarUrl = line.substring(3);
                        console.log(`ÊâæÂà∞ËßíËâ≤ ${characterName} ÁöÑÂ§¥ÂÉè: ${avatarUrl}`);
                        return {
                            backgroundImage: `url("${avatarUrl}")`,
                            background: '',
                            textContent: '',
                            avatarUrl: avatarUrl
                        };
                    }
                }
                
                console.log(`Êú™Âú®‰∏ñÁïå‰π¶‰∏≠ÊâæÂà∞ËßíËâ≤ ${characterName} ÁöÑÂ§¥ÂÉè`);
                return null;
            }
            
            /**
             * ‰ªé‰∏ñÁïå‰π¶Ëé∑ÂèñÁæ§ËÅäÂ§¥ÂÉèÊï∞ÊçÆ
             */
            function getGroupAvatarFromWorldbook(groupName) {
                console.log(`‰ªé‰∏ñÁïå‰π¶Ëé∑ÂèñÁæ§ËÅäÂ§¥ÂÉè: ${groupName}`);
                
                // ‰ªé‰∏ñÁïå‰π¶ "ÊâãÊú∫-Áæ§ËÅä" Êù°ÁõÆËé∑ÂèñÂ§¥ÂÉè
                if (!entries) {
                    console.log('entriesÊú™ÂÆö‰πâÔºåÊó†Ê≥ïËé∑ÂèñÁæ§ËÅäÂ§¥ÂÉè');
                    return null;
                }
                
                const uniqueComment = `ÊâãÊú∫-Áæ§ËÅä-${groupName}`;
                const groupEntry = entries.find(e => 
                    e.comment === uniqueComment
                );
                
                if (!groupEntry) {
                    console.log(`Êú™ÊâæÂà∞Áæ§ËÅä ${groupName} ÁöÑ‰∏ñÁïå‰π¶Êù°ÁõÆ`);
                    return null;
                }
                
                const content = groupEntry.content;
                const lines = content.split('\n');
                let currentSection = null;
                
                for (let line of lines) {
                    line = line.trim();
                    if (line.startsWith('[') && line.endsWith(']')) {
                        currentSection = line.slice(1, -1);
                    } else if (currentSection === groupName && line.startsWith('Â§¥ÂÉè=')) {
                        const avatarUrl = line.substring(3);
                        console.log(`ÊâæÂà∞Áæ§ËÅä ${groupName} ÁöÑÂ§¥ÂÉè: ${avatarUrl}`);
                        return {
                            backgroundImage: `url("${avatarUrl}")`,
                            background: '',
                            textContent: '',
                            avatarUrl: avatarUrl
                        };
                    }
                }
                
                console.log(`Êú™Âú®‰∏ñÁïå‰π¶‰∏≠ÊâæÂà∞Áæ§ËÅä ${groupName} ÁöÑÂ§¥ÂÉè`);
                return null;
            }
            
            /**
             * Ëé∑ÂèñËßíËâ≤Â§¥ÂÉèÊï∞ÊçÆÔºà‰ºòÂÖà‰ªé‰∏ñÁïå‰π¶ÔºåÂ§áÈÄâ‰ªéËÅîÁ≥ª‰∫∫ÂàóË°®Ôºâ
             */
            function getCharacterAvatar(characterName) {
                console.log(`Ëé∑ÂèñËßíËâ≤Â§¥ÂÉè: ${characterName}`);
                
                // È¶ñÂÖàÂ∞ùËØï‰ªé‰∏ñÁïå‰π¶Ëé∑Âèñ
                const worldbookAvatar = getCharacterAvatarFromWorldbook(characterName);
                if (worldbookAvatar) {
                    return worldbookAvatar;
                }
                
                // Â§áÈÄâÊñπÊ°àÔºö‰ªéËÅîÁ≥ª‰∫∫ÂàóË°®‰∏≠Êü•ÊâæËßíËâ≤Â§¥ÂÉè
                const contactsContainer = document.getElementById('QQ_home_chars');
                if (!contactsContainer) {
                    console.log('ËÅîÁ≥ª‰∫∫ÂÆπÂô®Êú™ÊâæÂà∞');
                    return null;
                }
                
                // Êü•ÊâæÂØπÂ∫îÁöÑËÅîÁ≥ª‰∫∫ÂÖÉÁ¥† - ‰øÆÂ§çÔºö‰ΩøÁî®Ê≠£Á°ÆÁöÑÈÄâÊã©Âô®
                const contactElements = contactsContainer.querySelectorAll('.QQ_home_usermsg');
                for (let element of contactElements) {
                    const nameElement = element.querySelector('.QQ_home_name');
                    if (nameElement && nameElement.textContent.trim() === characterName) {
                        const avatarElement = element.querySelector('.QQ_home_head');
                        if (avatarElement) {
                            // ÊèêÂèñÂ§¥ÂÉè‰ø°ÊÅØ
                            const backgroundImage = avatarElement.style.backgroundImage;
                            const background = avatarElement.style.background;
                            const textContent = avatarElement.textContent;
                            
                            console.log(`‰ªéËÅîÁ≥ª‰∫∫ÂàóË°®Ëé∑ÂèñËßíËâ≤ ${characterName} ÁöÑÂ§¥ÂÉè`);
                            return {
                                backgroundImage,
                                background,
                                textContent
                            };
                        }
                    }
                }
                
                console.log(`Êú™ÊâæÂà∞ËßíËâ≤ ${characterName} ÁöÑÂ§¥ÂÉè`);
                return null;
            }
            
            /**
             * Â∫îÁî®ËßíËâ≤Â§¥ÂÉèÂà∞ÂÖÉÁ¥†
             */
            function applyCharacterAvatar(element, avatarData, characterName) {
                // *** ‰øÆÂ§çÔºö‰∏çË¶ÅÂº∫Âà∂ËÆæÁΩÆÂ∞∫ÂØ∏Ôºå‰øùÊåÅCSS‰∏≠ÁöÑÊ†∑Âºè ***
                // Âè™ËÆæÁΩÆÂøÖË¶ÅÁöÑÂü∫Á°ÄÊ†∑ÂºèÔºåËÆ©CSSÊéßÂà∂Â∞∫ÂØ∏
                element.style.borderRadius = '50%';
                element.style.display = 'flex';
                element.style.alignItems = 'center';
                element.style.justifyContent = 'center';
                element.style.fontWeight = 'bold';
                element.style.fontSize = '12px';
                element.style.color = 'white';
                element.style.backgroundSize = 'cover';
                element.style.backgroundPosition = 'center';
                element.style.backgroundRepeat = 'no-repeat';
                element.style.flexShrink = '0';
                
                if (avatarData && (avatarData.backgroundImage || avatarData.background)) {
                    // ‰ΩøÁî®ÁúüÂÆûÂ§¥ÂÉè
                    if (avatarData.backgroundImage && avatarData.backgroundImage !== 'none') {
                        element.style.backgroundImage = avatarData.backgroundImage;
                        element.style.background = '';
                        element.textContent = '';
                    } else if (avatarData.background && avatarData.background !== 'none') {
                        element.style.background = avatarData.background;
                        element.style.backgroundImage = '';
                        element.textContent = avatarData.textContent || characterName.charAt(0);
                    } else {
                        // ‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè
                        element.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                        element.style.backgroundImage = '';
                        element.textContent = characterName.charAt(0);
                    }
                } else {
                    // ‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè
                    element.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                    element.style.backgroundImage = '';
                    element.textContent = characterName.charAt(0);
                }
            }
            
            // Ê≥®ÊÑèÔºöensureGroupsInMessageListÂáΩÊï∞Â∑≤Âà†Èô§
            // Ê∂àÊÅØÂàóË°®Áé∞Âú®Áî±QQ_UpdateMessageList()Ëá™Âä®‰ªéËÅîÁ≥ª‰∫∫ÂàóË°®ÂêåÊ≠•
            
            /**
             * Êõ¥Êñ∞ËÅäÂ§©ÁïåÈù¢Â§¥ÈÉ®‰ø°ÊÅØ
             */
            function updateChatHeader(groupData) {
                console.log('Êõ¥Êñ∞ËÅäÂ§©ÁïåÈù¢Â§¥ÈÉ®‰ø°ÊÅØ:', groupData);
                
                // Êü•ÊâæËÅäÂ§©ÁïåÈù¢ÁöÑÂ§¥ÈÉ®ÂÖÉÁ¥†
                const chatHeader = document.querySelector('#QQ_chat_username')?.closest('div') || 
                                  document.querySelector('.QQ_chat_head') || 
                                  document.querySelector('#QQ_chat_head');
                console.log('ËÅäÂ§©Â§¥ÈÉ®ÂÖÉÁ¥†:', chatHeader);
                
                if (!chatHeader) {
                    console.error('Êú™ÊâæÂà∞ËÅäÂ§©Â§¥ÈÉ®ÂÖÉÁ¥†ÔºåÂ∞ùËØïÂàõÂª∫Â§¥ÈÉ®');
                    // Â¶ÇÊûúÊâæ‰∏çÂà∞Â§¥ÈÉ®ÔºåÂ∞ùËØïÂú®È°µÈù¢È°∂ÈÉ®ÂàõÂª∫‰∏Ä‰∏™
                    const chatPage = document.querySelector('.QQ_chat_page[style*="display:block"], .QQ_chat_page:not([style*="display:none"])');
                    if (chatPage) {
                        const headerDiv = document.createElement('div');
                        headerDiv.className = 'QQ_chat_head group-chat-header';
                        headerDiv.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; height: 60px; background: #fff; z-index: 1000; display: flex; align-items: center; padding: 0 15px; border-bottom: 1px solid #eee;';
                        
                        // ÂàõÂª∫Â§¥ÂÉè
                        const avatar = document.createElement('div');
                        avatar.className = 'QQ_home_head';
                        avatar.style.cssText = 'width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;';
                        
                        // ÂàõÂª∫ÂêçÁß∞Âíå‰ø°ÊÅØÂÆπÂô®
                        const infoDiv = document.createElement('div');
                        infoDiv.style.cssText = 'flex: 1;';
                        
                        const nameDiv = document.createElement('div');
                        nameDiv.className = 'QQ_home_name group-chat-clickable-name';
                        nameDiv.style.cssText = 'font-size: 16px; font-weight: bold; color: #333; cursor: pointer; user-select: none;';
                        nameDiv.textContent = groupData.name;
                        
                        // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ÊòæÁ§∫Áæ§ËÅäÁÆ°ÁêÜËèúÂçï
                        nameDiv.addEventListener('click', function(e) {
                            e.stopPropagation();
                            showGroupManagementMenu(groupData, nameDiv);
                        });
                        
                        const msgDiv = document.createElement('div');
                        msgDiv.className = 'QQ_home_lastmsg group-member-count';
                        msgDiv.style.cssText = 'font-size: 12px; color: #666; margin-top: 2px;';
                        msgDiv.textContent = `Áæ§ËÅä ¬∑ ${groupData.members.length}‰∫∫`;
                        
                        infoDiv.appendChild(nameDiv);
                        infoDiv.appendChild(msgDiv);
                        
                        headerDiv.appendChild(avatar);
                        headerDiv.appendChild(infoDiv);
                        
                        chatPage.insertBefore(headerDiv, chatPage.firstChild);
                        
                        // Êõ¥Êñ∞ËÅäÂ§©Âå∫ÂüüÁöÑ‰∏äËæπË∑ùÔºåÈÅøÂÖçË¢´Âõ∫ÂÆöÂ§¥ÈÉ®ÈÅÆÊå°
                        const msgContent = chatPage.querySelector('.msgcontent');
                        if (msgContent) {
                            msgContent.style.paddingTop = '70px';
                        }
                        
                        // ÈáçÊñ∞ËÆæÁΩÆchatHeader
                        const updatedHeader = headerDiv;
                        updateHeaderContent(updatedHeader, groupData);
                        return;
                    } else {
                        console.error('‰πüÊú™ÊâæÂà∞ËÅäÂ§©È°µÈù¢');
                        return;
                    }
                }
                
                updateHeaderContent(chatHeader, groupData);
            }
            
            /**
             * Êõ¥Êñ∞Â§¥ÈÉ®ÂÜÖÂÆπÁöÑÈÄöÁî®ÂáΩÊï∞
             */
            function updateHeaderContent(chatHeader, groupData) {
                // *** Âº∫Âà∂Êõ¥Êñ∞Â§¥ÂÉèÊòæÁ§∫ ***
                const headerAvatar = chatHeader.querySelector('.QQ_home_head');
                console.log('*** ËÅäÂ§©ÁïåÈù¢Â§¥ÂÉèÊõ¥Êñ∞ ***');
                console.log('Â§¥ÂÉèÂÖÉÁ¥†:', headerAvatar);
                console.log('Áæ§ËÅäÂ§¥ÂÉèÊï∞ÊçÆ:', groupData.avatar);
                
                if (headerAvatar) {
                    // Âº∫Âà∂Ê∏ÖÁ©∫ÊâÄÊúâÊ†∑Âºè
                    headerAvatar.innerHTML = '';
                    headerAvatar.style.cssText = '';
                    
                    // ÈáçÊñ∞ËÆæÁΩÆÂü∫Á°ÄÊ†∑Âºè
                    headerAvatar.style.display = 'block';
                    headerAvatar.style.width = '40px';
                    headerAvatar.style.height = '40px';
                    headerAvatar.style.borderRadius = '50%';
                    headerAvatar.style.marginRight = '10px';
                    headerAvatar.style.flexShrink = '0';
                    headerAvatar.style.position = 'relative';
                    headerAvatar.style.overflow = 'hidden';
                    
                    // *** Âº∫Âà∂Êõ¥Êñ∞Â§¥ÂÉèÂÜÖÂÆπ ***
                    if (groupData.avatar) {
                        console.log('Âº∫Âà∂Êõ¥Êñ∞Áæ§ËÅäÂ§¥ÂÉè:', groupData.avatar.type);
                        
                        // Á°Æ‰øùÁ´ãÂç≥Êõ¥Êñ∞Â§¥ÂÉè
                        updateAvatarElement(headerAvatar, groupData.avatar);
                        
                        // Âª∂ËøüÂÜçÊ¨°Á°Æ‰øùÂ§¥ÂÉèÊ≠£Á°ÆÊòæÁ§∫
                        setTimeout(() => {
                            console.log('Âª∂ËøüÂÜçÊ¨°Êõ¥Êñ∞Â§¥ÂÉè');
                            updateAvatarElement(headerAvatar, groupData.avatar);
                        }, 50);
                        
                        console.log('ËÅäÂ§©ÁïåÈù¢Â§¥ÂÉèÂ∑≤Âº∫Âà∂Êõ¥Êñ∞');
                    } else {
                        // ‰ΩøÁî®ÈªòËÆ§Áæ§ËÅäÂ§¥ÂÉè
                        headerAvatar.style.background = 'linear-gradient(135deg, #199AFF, #0066CC)';
                        headerAvatar.style.backgroundImage = 'none';
                        headerAvatar.style.color = 'white';
                        headerAvatar.style.display = 'flex';
                        headerAvatar.style.alignItems = 'center';
                        headerAvatar.style.justifyContent = 'center';
                        headerAvatar.style.fontWeight = 'bold';
                        headerAvatar.textContent = 'Áæ§';
                        console.log('‰ΩøÁî®ÈªòËÆ§Áæ§ËÅäÂ§¥ÂÉè');
                    }
                } else {
                    console.warn('Êú™ÊâæÂà∞ËÅäÂ§©ÁïåÈù¢Â§¥ÂÉèÂÖÉÁ¥†');
                }
                
                // *** ‰øÆÂ§çÔºöÊõ¥ÂÖ®Èù¢ÁöÑÂêçÁß∞ÂÖÉÁ¥†Êü•ÊâæÂíåÊõ¥Êñ∞ ***
                console.log('=== ÂºÄÂßãÊõ¥Êñ∞ËÅäÂ§©Â§¥ÈÉ®ÂêçÁß∞ÊòæÁ§∫ ===');
                console.log('ÁõÆÊ†áÁæ§ËÅäÂêçÁß∞:', groupData.name);
                console.log('Áæ§ËÅäÊàêÂëòÊï∞Èáè:', groupData.members.length);
                
                // Êü•ÊâæÂ§ö‰∏™ÂèØËÉΩÁöÑÈÄâÊã©Âô®ÔºåÊåâÈáçË¶ÅÊÄßÊéíÂ∫è
                const nameSelectors = [
                    '#QQ_chat_username',        // ÊúÄÂ∏∏Áî®ÁöÑËÅäÂ§©Áî®Êà∑ÂêçÂÖÉÁ¥†
                    '.QQ_home_name',           // ËÅîÁ≥ª‰∫∫ÂêçÁß∞ÂÖÉÁ¥†
                    '.chat-title',             // ËÅäÂ§©Ê†áÈ¢òÂÖÉÁ¥†
                    '.group-chat-title',       // Áæ§ËÅäÊ†áÈ¢òÂÖÉÁ¥†
                    'h2',                      // ÈÄöÁî®Ê†áÈ¢òÂÖÉÁ¥†
                    '.name',                   // ÈÄöÁî®ÂêçÁß∞ÂÖÉÁ¥†
                    'span',                    // ÈÄöÁî®spanÂÖÉÁ¥†
                    'div'                      // ÊúÄÂêéÁöÑÂ§áÈÄâ
                ];
                
                let headerName = null;
                let selectorUsed = '';
                
                // Êåâ‰ºòÂÖàÁ∫ßÊü•ÊâæÂêçÁß∞ÂÖÉÁ¥†
                for (const selector of nameSelectors) {
                    headerName = chatHeader.querySelector(selector);
                    if (headerName) {
                        selectorUsed = selector;
                        console.log(`ÊâæÂà∞ÂêçÁß∞ÂÖÉÁ¥†Ôºå‰ΩøÁî®ÈÄâÊã©Âô®: ${selector}`);
                        break;
                    }
                }
                
                console.log('Êü•ÊâæÂà∞ÁöÑÂêçÁß∞ÂÖÉÁ¥†:', headerName);
                console.log('ËÅäÂ§©Â§¥ÈÉ®ÁöÑÊâÄÊúâÂ≠êÂÖÉÁ¥†:', Array.from(chatHeader.children).map(el => ({
                    tag: el.tagName,
                    class: el.className,
                    id: el.id,
                    text: el.textContent.trim().substring(0, 50)
                })));
                
                if (headerName) {
                    console.log('ÊâæÂà∞ÂêçÁß∞ÂÖÉÁ¥†ÔºåÂºÄÂßãÊõ¥Êñ∞...');
                    console.log('  - ÂΩìÂâçÂÜÖÂÆπ:', headerName.textContent.trim());
                    console.log('  - ÁõÆÊ†áÂêçÁß∞:', groupData.name);
                    console.log('  - ÊàêÂëòÊï∞Èáè:', groupData.members.length);
                    
                    // *** ‰øÆÂ§çÔºöÊ≠£Á°ÆËÆæÁΩÆÁæ§ËÅäÊ†áÈ¢òÊ†ºÂºè ***
                    if (groupData.members && groupData.members.length >= 1) {
                        // Áæ§ËÅäÊ†ºÂºèÔºöÂè™ÊòæÁ§∫ÂêçÁß∞Ôºå‰∫∫Êï∞Âú®ÂâØÊ†áÈ¢ò‰∏≠ÊòæÁ§∫
                        headerName.textContent = groupData.name;
                        console.log('Â∑≤ËÆæÁΩÆÁæ§ËÅäÊ†áÈ¢ò:', groupData.name);
                        
                        // *** ÈáçË¶Å‰øÆÂ§çÔºöÊõ¥Êñ∞‰∫∫Êï∞ÊòæÁ§∫ ***
                        const memberCountElement = chatHeader.querySelector('.QQ_home_lastmsg, .group-member-count');
                        if (memberCountElement) {
                            const memberCount = groupData.members.length;
                            const countText = `Áæ§ËÅä ¬∑ ${memberCount}‰∫∫`;
                            memberCountElement.textContent = countText;
                            console.log('‚úÖ Áæ§ËÅä‰∫∫Êï∞Â∑≤Êõ¥Êñ∞:', countText);
                        } else {
                            console.log('Êú™ÊâæÂà∞‰∫∫Êï∞ÊòæÁ§∫ÂÖÉÁ¥†ÔºåÂ∞ùËØïÂàõÂª∫...');
                            // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞‰∫∫Êï∞ÊòæÁ§∫ÂÖÉÁ¥†ÔºåÂàõÂª∫‰∏Ä‰∏™
                            const nameContainer = headerName.parentElement;
                            if (nameContainer) {
                                const memberCountDiv = document.createElement('div');
                                memberCountDiv.className = 'QQ_home_lastmsg group-member-count';
                                memberCountDiv.style.cssText = 'font-size: 12px; color: #666; margin-top: 2px;';
                                memberCountDiv.textContent = `Áæ§ËÅä ¬∑ ${groupData.members.length}‰∫∫`;
                                nameContainer.appendChild(memberCountDiv);
                                console.log('‚úÖ Â∑≤ÂàõÂª∫Áæ§ËÅä‰∫∫Êï∞ÊòæÁ§∫ÂÖÉÁ¥†');
                            }
                        }
                    } else {
                        // ÁßÅËÅäÊàñÊó†ÊàêÂëò‰ø°ÊÅØÊó∂ÔºåÂè™ÊòæÁ§∫ÂêçÁß∞
                        headerName.textContent = groupData.name;
                        console.log('Â∑≤ËÆæÁΩÆÁßÅËÅäÊ†áÈ¢ò:', groupData.name);
                    }
                    
                    // *** Ê†∏ÂøÉ‰øÆÂ§çÔºöÁ°Æ‰øùÂÖÉÁ¥†Ê≠£Á°ÆÁöÑÂèØÁÇπÂáªÊÄß ***
                    // ÁßªÈô§ÂèØËÉΩÂ≠òÂú®ÁöÑÊóßÁ±ªÂêç
                    headerName.classList.remove('group-chat-clickable-name');
                    
                    // Ê∑ªÂä†Êñ∞ÁöÑÁ±ªÂêçÂíåÊ†∑Âºè
                    headerName.classList.add('group-chat-clickable-name');
                    headerName.style.cursor = 'pointer';
                    headerName.style.userSelect = 'none';
                    headerName.style.color = '#333';
                    headerName.style.fontWeight = 'bold';
                    
                    // ËÆæÁΩÆÈáçË¶ÅÁöÑÊï∞ÊçÆÂ±ûÊÄß
                    headerName.setAttribute('data-group-name', groupData.name);
                    headerName.setAttribute('data-group-id', groupData.id);
                    
                    // ÁßªÈô§ÊóßÁöÑÁÇπÂáª‰∫ã‰ª∂ÁõëÂê¨Âô®
                    if (headerName._groupClickHandler) {
                        headerName.removeEventListener('click', headerName._groupClickHandler);
                        console.log('Â∑≤ÁßªÈô§ÊóßÁöÑÁÇπÂáª‰∫ã‰ª∂');
                    }
                    
                    // Ê∑ªÂä†Êñ∞ÁöÑÁÇπÂáª‰∫ã‰ª∂
                    headerName._groupClickHandler = function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        console.log('Áæ§ËÅäÂêçÁß∞Ë¢´ÁÇπÂáª - ÊúÄÊñ∞Êï∞ÊçÆ:', {
                            name: groupData.name,
                            id: groupData.id,
                            members: groupData.members.length
                        });
                        showGroupManagementMenu(groupData, headerName);
                    };
                    headerName.addEventListener('click', headerName._groupClickHandler);
                    
                    console.log('Áæ§ËÅäÂêçÁß∞ÁÇπÂáª‰∫ã‰ª∂Â∑≤ÈáçÊñ∞ÁªëÂÆö');
                    console.log('  - ÊúÄÁªàÊòæÁ§∫ÂÜÖÂÆπ:', headerName.textContent.trim());
                    
                } else {
                    console.error('*** Êú™ÊâæÂà∞Áæ§ÂêçÁß∞ÂÖÉÁ¥†ÔºåÁæ§ÂêçÁß∞Êõ¥Êñ∞Â§±Ë¥• ***');
                    console.error('ËÅäÂ§©Â§¥ÈÉ®ÁªìÊûÑ:', chatHeader.outerHTML);
                    
                    // ÂàõÂª∫Êñ∞ÁöÑÂêçÁß∞ÂÖÉÁ¥†‰Ωú‰∏∫ÊúÄÂêéÊâãÊÆµ
                    const nameElement = document.createElement('span');
                    nameElement.id = 'QQ_chat_username';
                    nameElement.className = 'QQ_home_name group-chat-clickable-name';
                    
                    // ËÆæÁΩÆÁæ§ËÅäÊ†áÈ¢ò
                    if (groupData.members && groupData.members.length > 1) {
                        nameElement.textContent = `${groupData.name} (${groupData.members.length}‰∫∫)`;
                    } else {
                    nameElement.textContent = groupData.name;
                    }
                    
                    nameElement.style.cssText = 'font-size: 16px; font-weight: bold; color: #333; margin-left: 10px; cursor: pointer; user-select: none;';
                    nameElement.setAttribute('data-group-name', groupData.name);
                    nameElement.setAttribute('data-group-id', groupData.id);
                    
                    // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
                    nameElement.addEventListener('click', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        console.log('Êñ∞ÂàõÂª∫ÁöÑÁæ§ËÅäÂêçÁß∞Ë¢´ÁÇπÂáª:', groupData.name);
                        showGroupManagementMenu(groupData, nameElement);
                    });
                    
                    chatHeader.appendChild(nameElement);
                    headerName = nameElement;
                    console.log('Â∑≤ÂàõÂª∫Êñ∞ÁöÑÁæ§ËÅäÂêçÁß∞ÂÖÉÁ¥†');
                }
                
                console.log('=== ËÅäÂ§©Â§¥ÈÉ®ÂêçÁß∞Êõ¥Êñ∞ÂÆåÊàê ===');
                
                // Ê∑ªÂä†Áæ§ËÅäÊàêÂëòÊï∞ÊòæÁ§∫
                const headerMsg = chatHeader.querySelector('.QQ_home_lastmsg') || 
                                 chatHeader.querySelector('.chat-subtitle');
                
                if (headerMsg) {
                    headerMsg.textContent = `Áæ§ËÅä ¬∑ ${groupData.members.length}‰∫∫`;
                } else {
                    // Â¶ÇÊûúÊâæ‰∏çÂà∞ÂâØÊ†áÈ¢òÂÖÉÁ¥†ÔºåÂàõÂª∫‰∏Ä‰∏™
                    const subtitleElement = document.createElement('div');
                    subtitleElement.className = 'QQ_home_lastmsg';
                    subtitleElement.textContent = `Áæ§ËÅä ¬∑ ${groupData.members.length}‰∫∫`;
                    subtitleElement.style.cssText = 'font-size: 12px; color: #666; margin-left: 10px;';
                    chatHeader.appendChild(subtitleElement);
                }
            }
            
            /**
             * Âä†ËΩΩÁæ§ËÅäÊ∂àÊÅØÂéÜÂè≤ÔºàÂ¢ûÂº∫ÁâàÔºöÊîØÊåÅÁ≥ªÁªüÊ∂àÊÅØÔºâ
             */
            function loadGroupChatHistory(groupId) {
                console.log('Âä†ËΩΩÁæ§ËÅäÊ∂àÊÅØÂéÜÂè≤:', groupId);
                
                const chatContainer = document.querySelector('#QQ_chat_msgs');
                if (!chatContainer) {
                    console.error('Êâæ‰∏çÂà∞ËÅäÂ§©Ê∂àÊÅØÂÆπÂô®');
                    return;
                }
                
                // Ê∏ÖÁ©∫Áé∞ÊúâÊ∂àÊÅØ
                chatContainer.innerHTML = '';
                
                // Ê£ÄÊü•ÊòØÂê¶Êúâ‰øùÂ≠òÁöÑÁæ§ËÅäÊ∂àÊÅØ
                if (window.groupChatMessages && window.groupChatMessages[groupId]) {
                    const messages = window.groupChatMessages[groupId];
                    console.log(`Áæ§ËÅä ${groupId} Êúâ ${messages.length} Êù°Ê∂àÊÅØ`);
                    
                    // ÊòæÁ§∫ÊâÄÊúâÊ∂àÊÅØÔºàÂåÖÊã¨Á≥ªÁªüÊ∂àÊÅØÔºâ
                    messages.forEach(message => {
                        if (message.type === 'system') {
                            // ÊòæÁ§∫Á≥ªÁªüÊ∂àÊÅØ
                            const systemMsgDiv = document.createElement('div');
                            systemMsgDiv.className = 'system-message';
                            systemMsgDiv.style.cssText = `
                                text-align: center;
                                color: #999;
                                font-size: 12px;
                                margin: 10px 0;
                                padding: 5px;
                                line-height: 1.4;
                            `;
                            systemMsgDiv.textContent = message.content;
                            chatContainer.appendChild(systemMsgDiv);
                        } else {
                            // ÊòæÁ§∫ÊôÆÈÄöÊ∂àÊÅØÔºàËøôÈáåÂèØ‰ª•Êâ©Â±ïÊõ¥Â§öÊ∂àÊÅØÁ±ªÂûãÔºâ
                            console.log('ÊòæÁ§∫ÊôÆÈÄöÊ∂àÊÅØ:', message);
                            // TODO: Ê∑ªÂä†ÊôÆÈÄöÊ∂àÊÅØÊòæÁ§∫ÈÄªËæë
                        }
                    });
                }
                
                // Â¶ÇÊûúÊ≤°ÊúâÊ∂àÊÅØÔºåÊòæÁ§∫Ê¨¢ËøéÊ∂àÊÅØ
                if (chatContainer.children.length === 0) {
                    const welcomeDiv = document.createElement('div');
                    welcomeDiv.className = 'system-message';
                    welcomeDiv.style.cssText = `
                        text-align: center;
                        color: #999;
                        margin: 20px 0;
                        font-size: 14px;
                    `;
                    welcomeDiv.textContent = 'Ê¨¢ËøéÊù•Âà∞Áæ§ËÅäÔºÅÂºÄÂßãËÅäÂ§©ÂêßÔΩû';
                    chatContainer.appendChild(welcomeDiv);
                }
                
                // ÊªöÂä®Âà∞Â∫ïÈÉ®
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            // ==================== Áæ§ËÅäÈöîÁ¶ªÂäüËÉΩ ====================
            
            /**
             * Ëé∑ÂèñÂΩìÂâçÁæ§ËÅäÁöÑÊàêÂëòÂàóË°®
             */
            function getCurrentGroupMembers() {
                if (!window.currentGroupChat) {
                    return [];
                }
                return window.currentGroupChat.members || [];
            }
            
            /**
             * Ê£ÄÊü•ËßíËâ≤ÊòØÂê¶Âú®ÂΩìÂâçÁæ§ËÅä‰∏≠
             */
            function isCharacterInCurrentGroup(characterName) {
                if (!window.currentGroupChat) {
                    return true; // Â¶ÇÊûú‰∏çÂú®Áæ§ËÅä‰∏≠ÔºåÂÖÅËÆ∏ÊâÄÊúâËßíËâ≤ÂõûÂ§ç
                }
                
                const members = getCurrentGroupMembers();
                return members.includes(characterName);
            }
            
            /**
             * Áæ§ËÅäÊ∂àÊÅØËøáÊª§Âô® - Âè™ÂÖÅËÆ∏Áæ§ËÅäÊàêÂëòÁúãÂà∞Ê∂àÊÅØ
             */
            function filterGroupChatResponse(response) {
                if (!window.currentGroupChat) {
                    return response; // ‰∏çÂú®Áæ§ËÅä‰∏≠Ôºå‰∏çÈúÄË¶ÅËøáÊª§
                }
                
                const groupName = window.currentGroupChat.name;
                const members = getCurrentGroupMembers();
                
                console.log(`ÂΩìÂâçÁæ§ËÅä: ${groupName}, ÊàêÂëò: [${members.join(', ')}]`);
                
                // Âú®ÂìçÂ∫î‰∏≠Ê∑ªÂä†Áæ§ËÅä‰∏ä‰∏ãÊñá‰ø°ÊÅØ
                let contextInfo = `\n[Áæ§ËÅä‰∏ä‰∏ãÊñá]\n`;
                contextInfo += `- ÂΩìÂâçÁæ§ËÅä: ${groupName}\n`;
                contextInfo += `- Áæ§ËÅäÊàêÂëò: ${members.join('„ÄÅ')}\n`;
                contextInfo += `- Ê≥®ÊÑè: Âè™Êúâ‰ª•‰∏äÊàêÂëòËÉΩÂ§üÁúãÂà∞ÂíåÂõûÂ§çÊ≠§Áæ§ËÅä‰∏≠ÁöÑÊ∂àÊÅØ\n`;
                contextInfo += `- ÂÖ∂‰ªñËßíËâ≤Êó†Ê≥ïÁúãÂà∞Ê≠§Áæ§ËÅäÁöÑÂÜÖÂÆπ\n`;
                
                return contextInfo + response;
            }
            
            /**
             * ÈáçÂÜôQQ_GenÂáΩÊï∞‰ª•ÊîØÊåÅÁæ§ËÅäÈöîÁ¶ª
             */
            const originalQQGen = window.QQ_Gen;
            if (originalQQGen) {
                            window.QQ_Gen = async function(prompt, callback) {
                try {
                    // Â¶ÇÊûúÂú®Áæ§ËÅä‰∏≠ÔºåÊ∑ªÂä†ÈöîÁ¶ª‰ø°ÊÅØ
                    if (window.currentGroupChat) {
                        const groupName = window.currentGroupChat.name;
                        const members = getCurrentGroupMembers();
                        
                        // Âú®promptÂâçÊ∑ªÂä†Áæ§ËÅäÈôêÂà∂‰ø°ÊÅØ
                        const groupContext = `[ÈáçË¶Å: ÂΩìÂâçÂú®Áæ§ËÅä"${groupName}"‰∏≠ÔºåÂè™Êúâ‰ª•‰∏ãÊàêÂëòÂèØ‰ª•ÂèÇ‰∏éÂØπËØù: ${members.join('„ÄÅ')}„ÄÇÂÖ∂‰ªñËßíËâ≤Êó†Ê≥ïÁúãÂà∞Ê≠§Áæ§ËÅäÊ∂àÊÅØÔºå‰∏çÂ∫îÂõûÂ§ç„ÄÇ]\n\n`;
                        prompt = groupContext + prompt;
                        
                        console.log('Áæ§ËÅäÊ∂àÊÅØÂèëÈÄÅÔºåÈôêÂà∂ÊàêÂëò:', members);
                    }
                    
                    // Ë∞ÉÁî®ÂéüÂßãÁîüÊàêÂáΩÊï∞
                    const result = await originalQQGen(prompt);
                    
                    // ÂØπÁªìÊûúËøõË°åÁæ§ËÅäËøáÊª§
                    const filteredResult = filterGroupChatResponse(result);
                    
                    // Â¶ÇÊûúÊèê‰æõ‰∫ÜÂõûË∞ÉÂáΩÊï∞ÔºåË∞ÉÁî®ÂÆÉ
                    if (typeof callback === 'function') {
                        await callback(filteredResult);
                    }
                    
                    return filteredResult;
                } catch (error) {
                    console.error('QQ_GenÊâßË°åÈîôËØØ:', error);
                    
                    // Â¶ÇÊûúÊèê‰æõ‰∫ÜÂõûË∞ÉÂáΩÊï∞Ôºå‰πüË¶ÅÈÄöÁü•ÈîôËØØ
                    if (typeof callback === 'function') {
                        try {
                            await callback(null, error);
                        } catch (callbackError) {
                            console.error('ÂõûË∞ÉÂáΩÊï∞ÊâßË°åÈîôËØØ:', callbackError);
                        }
                    }
                    
                    throw error;
                }
            };
            }
            
            // ==================== È°µÈù¢ÂàùÂßãÂåñÂ¢ûÂº∫ ====================
            
            /**
             * Â¢ûÂº∫ÁöÑÈ°µÈù¢ÂàùÂßãÂåñÔºåÂåÖÂê´Áæ§ËÅäÂäüËÉΩ
             */
            async function initializeEnhancedFeatures() {
                // Âä†ËΩΩ‰øùÂ≠òÁöÑÁæ§ËÅä
                if (worldbook) {
                    await loadGroupChatsFromWorldbook();
                } else {
                    console.log('initializeEnhancedFeatures: worldbookÊú™ÂàùÂßãÂåñÔºåË∑≥ËøáÁæ§ËÅäÂä†ËΩΩ');
                }
                
                // ÂàùÂßãÂåñÂàÜÁªÑÂäüËÉΩ
                if (typeof loadGroupsFromStorage === 'function' && worldbook) {
                    await loadGroupsFromStorage();
                } else if (!worldbook) {
                    console.log('initializeEnhancedFeatures: worldbookÊú™ÂàùÂßãÂåñÔºåË∑≥ËøáÂàÜÁªÑÂä†ËΩΩ');
                }
                
                if (typeof initContactGroups === 'function') {
                    initContactGroups();
                }
                
                // *** ‰øÆÂ§çÔºöÂú®ÂàùÂßãÂåñÂÆåÊàêÂêéÊõ¥Êñ∞ÊâÄÊúâÁæ§ËÅäÁöÑÊúÄÂêéÊ∂àÊÅØÊòæÁ§∫ ***
                setTimeout(async () => {
                    console.log('ÂºÄÂßãÊõ¥Êñ∞ÊâÄÊúâÁæ§ËÅäÁöÑÊúÄÂêéÊ∂àÊÅØÊòæÁ§∫...');
                    try {
                        const groups = await loadGroupsFromStorage();
                        if (groups && Array.isArray(groups)) {
                            groups.forEach(groupData => {
                                if (groupData && groupData.name) {
                                    updateGroupLastMessageDisplay(groupData.name);
                                }
                            });
                            console.log('ÊâÄÊúâÁæ§ËÅäÊúÄÂêéÊ∂àÊÅØÊòæÁ§∫Êõ¥Êñ∞ÂÆåÊàê');
                        } else {
                            console.warn('Áæ§ËÅäÊï∞ÊçÆÊó†ÊïàÔºåË∑≥ËøáÊúÄÂêéÊ∂àÊÅØÊòæÁ§∫Êõ¥Êñ∞');
                        }
                    } catch (error) {
                        console.error('Êõ¥Êñ∞Áæ§ËÅäÊúÄÂêéÊ∂àÊÅØÊòæÁ§∫Êó∂Âá∫Èîô:', error);
                    }
                }, 500);
                
                // ÂàùÂßãÂåñÂä®ÊÄÅÁÇπËµûÂäüËÉΩ
                if (typeof QQ_InitMomentLikes === 'function') {
                    QQ_InitMomentLikes();
                    console.log('- Âä®ÊÄÅÁÇπËµûÂäüËÉΩÂ∑≤ÂêØÁî®');
                }
                
                // Âä†ËΩΩÂä®ÊÄÅÁÇπËµûÁä∂ÊÄÅ
                if (typeof QQ_LoadMomentLikes === 'function') {
                    await QQ_LoadMomentLikes();
                }
                
                console.log('Â¢ûÂº∫ÂäüËÉΩÂàùÂßãÂåñÂÆåÊàê');
                console.log('- Áæ§ËÅäÂäüËÉΩÂ∑≤ÂêØÁî®');
                console.log('- ÂàÜÁªÑÂäüËÉΩÂ∑≤ÂêØÁî®');
                console.log('- Â§¥ÂÉèËÆæÁΩÆÂ∑≤ÂêØÁî®');
                console.log('- ÊãñÊãΩÂäüËÉΩÂ∑≤ÂêØÁî®');
            }
            
            // Âú®È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñÂ¢ûÂº∫ÂäüËÉΩ
            if (document.readyState === 'complete' || document.readyState === 'interactive') {
                setTimeout(initializeEnhancedFeatures, 1000);
            } else {
                document.addEventListener('DOMContentLoaded', () => {
                    setTimeout(initializeEnhancedFeatures, 1000);
                });
            }
            
        </script>
        
        <!-- ‰øÆÂ§çÊåâÈíÆÁÇπÂáªÈóÆÈ¢òÔºöÂ∞ÜÂÖ≥ÈîÆÂáΩÊï∞ÊîæÂú®ÂçïÁã¨ÁöÑscriptÊ†áÁ≠æ‰∏≠ -->
        <script>
            // Á°Æ‰øùÂÖ®Â±ÄÂèòÈáèÂèØÁî®
            window.selectedAvatarData = null;
            
            // Á°Æ‰øùËøô‰∫õÂáΩÊï∞Âú®ÂÖ®Â±Ä‰ΩúÁî®Âüü‰∏≠ÂèØÁî®
            window.confirmAvatarSelection = function() {
                console.log('üîµ confirmAvatarSelection Ë¢´Ë∞ÉÁî®ÔºÅ');
                console.log('ÂΩìÂâçÈÄâ‰∏≠ÁöÑÂ§¥ÂÉèÊï∞ÊçÆ:', window.selectedAvatarData);
                
                // Â¶ÇÊûúÊ≤°ÊúâÈÄâÊã©Â§¥ÂÉèÔºå‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè
                if (!window.selectedAvatarData) {
                    window.selectedAvatarData = {
                        type: 'preset',
                        gradient: { start: '#199AFF', end: '#0066CC' },
                        text: 'Áæ§'
                    };
                    console.log('‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè:', window.selectedAvatarData);
                }
                
                const previewElement = document.getElementById('group_avatar_preview');
                const textElement = document.querySelector('.group-avatar-text');
                
                if (!previewElement || !textElement) {
                    console.error('Êâæ‰∏çÂà∞Â§¥ÂÉèÈ¢ÑËßàÂÖÉÁ¥†');
                    alert('Êâæ‰∏çÂà∞Â§¥ÂÉèÈ¢ÑËßàÂÖÉÁ¥†ÔºåËØ∑Ê£ÄÊü•È°µÈù¢ÁªìÊûÑ');
                    return;
                }
                
                try {
                    if (window.selectedAvatarData.type === 'preset') {
                        // È¢ÑËÆæÂ§¥ÂÉè
                        const gradient = window.selectedAvatarData.gradient;
                        previewElement.style.background = `linear-gradient(135deg, ${gradient.start}, ${gradient.end})`;
                        previewElement.style.backgroundImage = 'none';
                        previewElement.innerHTML = `<div class="default-group-avatar">${window.selectedAvatarData.text}</div>`;
                        textElement.textContent = 'Â∑≤ËÆæÁΩÆÈ¢ÑËÆæÂ§¥ÂÉè';
                    } else if (window.selectedAvatarData.type === 'upload') {
                        // ‰∏ä‰º†ÁöÑÂ§¥ÂÉè
                        previewElement.style.background = 'none';
                        previewElement.style.backgroundImage = `url('${window.selectedAvatarData.imageData}')`;
                        previewElement.style.backgroundSize = 'cover';
                        previewElement.style.backgroundPosition = 'center';
                        previewElement.innerHTML = '';
                        textElement.textContent = 'Â∑≤ËÆæÁΩÆËá™ÂÆö‰πâÂ§¥ÂÉè';
                    }
                    
                    console.log('Â§¥ÂÉèËÆæÁΩÆÊàêÂäüÔºåÂÖ≥Èó≠ÈÄâÊã©Âô®');
                    
                    // ÂÖ≥Èó≠Â§¥ÂÉèÈÄâÊã©Âô®
                    const modal = document.getElementById('avatar_selector_modal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                    
                    alert('Â§¥ÂÉèËÆæÁΩÆÊàêÂäüÔºÅ');
                    
                } catch (error) {
                    console.error('Â§¥ÂÉèËÆæÁΩÆÊó∂Âá∫Èîô:', error);
                    alert('Â§¥ÂÉèËÆæÁΩÆÂ§±Ë¥•Ôºö' + error.message);
                }
            };
            
            // Ê∑ªÂä†ÂÖ®Â±ÄÊ∏ÖÁêÜÂáΩÊï∞
            window.cleanupDuplicateGroups = cleanupDuplicateGroups;
            window.checkWorldbookGroups = checkWorldbookGroups;
            
            window.createGroupChat = async function() {
                console.log('üîµ createGroupChat Ë¢´Ë∞ÉÁî®ÔºÅÔºà‰ΩøÁî®Êñ∞ÁöÑ‰∏ñÁïå‰π¶ÈÄªËæëÔºâ');
                
                try {
                    const nameInput = document.getElementById('group_name_input');
                    if (!nameInput) {
                        console.error('Êâæ‰∏çÂà∞Áæ§ËÅäÂêçÁß∞ËæìÂÖ•Ê°Ü');
                        alert('Á≥ªÁªüÈîôËØØÔºöÊâæ‰∏çÂà∞Áæ§ËÅäÂêçÁß∞ËæìÂÖ•Ê°Ü');
                        return;
                    }
                    
                    const groupName = nameInput.value.trim();
                    console.log('Áæ§ËÅäÂêçÁß∞:', groupName);
                    
                    if (!groupName) {
                        alert('ËØ∑ËæìÂÖ•Áæ§ËÅäÂêçÁß∞');
                        return;
                    }
                    
                    // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÊàêÂëò
                    const selectedContacts = Array.from(document.querySelectorAll('#contact_list_for_group .contact-item.selected'));
                    
                    console.log('=== Áæ§ËÅäÂàõÂª∫Ë∞ÉËØï‰ø°ÊÅØ ===');
                    console.log('ÊâÄÊúâËÅîÁ≥ª‰∫∫È°πÁõÆ:', document.querySelectorAll('#contact_list_for_group .contact-item'));
                    console.log('ÈÄâ‰∏≠ÁöÑËÅîÁ≥ª‰∫∫È°πÁõÆ:', selectedContacts);
                    console.log('ÈÄâ‰∏≠ÁöÑËÅîÁ≥ª‰∫∫Êï∞Èáè:', selectedContacts.length);
                    
                    if (selectedContacts.length === 0) {
                        alert('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Áæ§ÊàêÂëò');
                        return;
                    }
                    
                    // Á¶ÅÁî®ÂàõÂª∫ÊåâÈíÆÈò≤Ê≠¢ÈáçÂ§çÁÇπÂáª
                    const confirmBtn = document.getElementById('group_confirm_btn');
                    if (confirmBtn) {
                        confirmBtn.disabled = true;
                        confirmBtn.textContent = 'ÂàõÂª∫‰∏≠...';
                    }
                    
                    // Ëé∑ÂèñÊàêÂëòÂàóË°®
                    const members = selectedContacts.map(contact => {
                        const nameElement = contact.querySelector('.contact-name');
                        return nameElement ? nameElement.textContent.trim() : '';
                    }).filter(name => name);
                    
                    // Ëé∑ÂèñÂ§¥ÂÉèURL
                    let avatarUrl = 'http://sharkpan.xyz/f/z0WU5/mmexport1736971020657.gif';
                    if (window.selectedAvatarData && window.selectedAvatarData.type === 'upload' && window.selectedAvatarData.imageData) {
                        avatarUrl = window.selectedAvatarData.imageData;
                    }
                    
                    console.log('ÂáÜÂ§áË∞ÉÁî®createNewGroupÔºåÂèÇÊï∞:', { groupName, members, avatarUrl });
                    
                    // ‰ΩøÁî®Êñ∞ÁöÑcreateNewGroupÂáΩÊï∞Ôºà‰∏ñÁïå‰π¶ÈÄªËæëÔºâ
                    const success = await createNewGroup(groupName, members, avatarUrl);
                    if (!success) {
                        // ÊÅ¢Â§çÂàõÂª∫ÊåâÈíÆÁä∂ÊÄÅ
                        if (confirmBtn) {
                            confirmBtn.disabled = false;
                            confirmBtn.textContent = 'ÂàõÂª∫Áæ§ËÅä';
                        }
                        return;
                    }
                    
                    // ÂÖ≥Èó≠ÂºπÁ™ó
                    const modal = document.getElementById('group_create_modal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                    
                    // ÈáçÁΩÆË°®Âçï
                    nameInput.value = '';
                    window.selectedAvatarData = null;
                    const preview = document.getElementById('group_avatar_preview');
                    const text = document.querySelector('.group-avatar-text');
                    if (preview && text) {
                        preview.style.background = 'linear-gradient(135deg, #199AFF, #0066CC)';
                        preview.innerHTML = '<div class="default-group-avatar">+</div>';
                        text.textContent = 'ÁÇπÂáªËÆæÁΩÆÂ§¥ÂÉè';
                    }
                    
                    console.log('Áæ§ËÅäÂàõÂª∫ÊàêÂäü:', groupName);
                    alert(`Áæ§ËÅä"${groupName}"ÂàõÂª∫ÊàêÂäüÔºÅ`);
                    
                    // ÊÅ¢Â§çÂàõÂª∫ÊåâÈíÆÁä∂ÊÄÅ
                    if (confirmBtn) {
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = 'ÂàõÂª∫Áæ§ËÅä';
                    }
                    
                } catch (error) {
                    console.error('ÂàõÂª∫Áæ§ËÅäÊó∂Âá∫Èîô:', error);
                    alert('ÂàõÂª∫Áæ§ËÅäÂ§±Ë¥•Ôºö' + error.message);
                    
                    // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                    const confirmBtn = document.getElementById('group_confirm_btn');
                    if (confirmBtn) {
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = 'ÂàõÂª∫Áæ§ËÅä';
                    }
                }
            };
            
            // saveGroupToStorageÂáΩÊï∞Â∑≤ÁßªÈô§ÔºåÁé∞Âú®‰ΩøÁî®‰∏ñÁïå‰π¶Â≠òÂÇ®
            
            /**
             * ‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩÁæ§ËÅäÊï∞ÊçÆ
             */
            // Ê≠§ÂáΩÊï∞Â∑≤Ë¢´loadGroupChatsFromWorldbookÊõø‰ª£Ôºå‰∏∫‰∫ÜÂÖºÂÆπÊÄß‰øùÁïôÂà´Âêç
            // ‰ΩÜÁé∞Âú®Á¶ÅÁî®Ëá™Âä®Âä†ËΩΩÔºåÈÅøÂÖçÈáçÂ§çÂæ™ÁéØ
            async function loadGroupsFromStorage() {
                console.log('loadGroupsFromStorageË¢´Ë∞ÉÁî®Ôºå‰ΩÜÂ∑≤Á¶ÅÁî®Ëá™Âä®Âä†ËΩΩ');
                return []; // ËøîÂõûÁ©∫Êï∞ÁªÑÔºåÈÅøÂÖçÈáçÂ§çÂä†ËΩΩ
            }
            
            
            /**
             * Êõ¥Êñ∞ËÅîÁ≥ª‰∫∫ÂàóË°®‰∏≠ÁöÑÁæ§ËÅä‰ø°ÊÅØ
             */
            function updateGroupInContactList(element, groupData) {
                const nameDiv = element.querySelector('.QQ_home_name');
                const msgDiv = element.querySelector('.QQ_home_lastmsg');
                
                if (nameDiv) nameDiv.textContent = groupData.name;
                if (msgDiv) msgDiv.textContent = `Áæ§ËÅä ¬∑ ${groupData.members.length}‰∫∫`;
            }
            
            /**
             * Êõ¥Êñ∞Ê∂àÊÅØÂàóË°®‰∏≠ÁöÑÁæ§ËÅä‰ø°ÊÅØ
             */
            function updateGroupInMessageList(element, groupData) {
                const nameDiv = element.querySelector('.QQ_home_name');
                const msgDiv = element.querySelector('.QQ_home_lastmsg');
                const timeDiv = element.querySelector('.QQ_home_lasttime');
                const avatarDiv = element.querySelector('.QQ_home_head');
                
                if (nameDiv) nameDiv.textContent = groupData.name;
                if (msgDiv) msgDiv.textContent = groupData.lastMessage || 'Áæ§ËÅäÂ∑≤ÂàõÂª∫';
                if (timeDiv) {
                    const currentTime = new Date();
                    const timeString = groupData.timestamp || groupData.lastTime || currentTime.toLocaleTimeString('zh-CN', { hour12: false }).slice(0, 5);
                    timeDiv.textContent = timeString;
                }
                
                // Êõ¥Êñ∞Â§¥ÂÉè
                if (avatarDiv) {
                    if (groupData.avatar && groupData.avatar.type === 'preset' && groupData.avatar.gradient) {
                        const gradient = groupData.avatar.gradient;
                        avatarDiv.style.background = `linear-gradient(135deg, ${gradient.start}, ${gradient.end})`;
                        avatarDiv.style.color = 'white';
                        avatarDiv.style.display = 'flex';
                        avatarDiv.style.alignItems = 'center';
                        avatarDiv.style.justifyContent = 'center';
                        avatarDiv.style.fontWeight = 'bold';
                        avatarDiv.style.fontSize = '18px';
                        avatarDiv.textContent = groupData.avatar.text || 'Áæ§';
                    } else if (groupData.avatar && groupData.avatar.type === 'upload' && groupData.avatar.imageData) {
                        // Ê∏ÖÈô§ÊâÄÊúâÂèØËÉΩÂÜ≤Á™ÅÁöÑÊ†∑Âºè
                        avatarDiv.style.background = '';
                        avatarDiv.style.backgroundColor = '';
                        avatarDiv.style.color = '';
                        avatarDiv.style.display = 'block'; // Á°Æ‰øùÂÖÉÁ¥†ÂèØËßÅ
                        avatarDiv.style.alignItems = '';
                        avatarDiv.style.justifyContent = '';
                        avatarDiv.style.fontWeight = '';
                        avatarDiv.style.fontSize = '';
                        avatarDiv.textContent = '';
                        
                        // Á°Æ‰øùÂü∫Á°ÄÂ∞∫ÂØ∏Ê†∑ÂºèÊ≠£Á°Æ
                        avatarDiv.style.width = '40px';
                        avatarDiv.style.height = '40px';
                        avatarDiv.style.borderRadius = '50%';
                        avatarDiv.style.minWidth = '40px';
                        
                        // ËÆæÁΩÆËÉåÊôØÂõæÁâá
                        avatarDiv.style.backgroundImage = `url('${groupData.avatar.imageData}')`;
                        avatarDiv.style.backgroundSize = 'cover';
                        avatarDiv.style.backgroundPosition = 'center';
                        avatarDiv.style.backgroundRepeat = 'no-repeat';
                    } else {
                        // ÈªòËÆ§Â§¥ÂÉè
                        avatarDiv.style.background = 'linear-gradient(135deg, #199AFF, #0066CC)';
                        avatarDiv.style.color = 'white';
                        avatarDiv.style.display = 'flex';
                        avatarDiv.style.alignItems = 'center';
                        avatarDiv.style.justifyContent = 'center';
                        avatarDiv.style.fontWeight = 'bold';
                        avatarDiv.style.fontSize = '18px';
                        avatarDiv.textContent = 'Áæ§';
                        avatarDiv.style.backgroundImage = '';
                    }
                }
            }
            
            /**
             * È°µÈù¢Âä†ËΩΩÊó∂ÊÅ¢Â§çÁæ§ËÅäÊï∞ÊçÆ
             */
            async function restoreGroupChats() {
                console.log('ÊÅ¢Â§çÁæ§ËÅäÊï∞ÊçÆ...');
                if (!worldbook) {
                    console.log('restoreGroupChats: worldbookÊú™ÂàùÂßãÂåñÔºåË∑≥ËøáÁæ§ËÅäÊÅ¢Â§ç');
                    return;
                }
                const groups = await loadGroupsFromStorage();
                
                groups.forEach(groupData => {
                    console.log('ÊÅ¢Â§çÁæ§ËÅä:', groupData.name);
                    AddNewGroup(groupData.name, groupData.avatar || 'https://files.catbox.moe/skngqq.jpg', groupData.members, groupData.description);
                });
                
                console.log('Áæ§ËÅäÊï∞ÊçÆÊÅ¢Â§çÂÆåÊàêÔºåÂÖ±', groups.length, '‰∏™Áæ§ËÅä');
            }
            
            // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÊÅ¢Â§çÁæ§ËÅäÊï∞ÊçÆÔºàÊöÇÊó∂Á¶ÅÁî®ÔºåÈÅøÂÖç‰∏éÁªü‰∏ÄÂàùÂßãÂåñÂÜ≤Á™ÅÔºâ
            // document.addEventListener('DOMContentLoaded', function() {
            //     setTimeout(restoreGroupChats, 500);
            // });
            
            // Â¶ÇÊûúÈ°µÈù¢Â∑≤ÁªèÂä†ËΩΩÂÆåÊàêÔºåÁ´ãÂç≥ÊÅ¢Â§çÔºàÊöÇÊó∂Á¶ÅÁî®ÔºåÈÅøÂÖç‰∏éÁªü‰∏ÄÂàùÂßãÂåñÂÜ≤Á™ÅÔºâ
            // if (document.readyState === 'complete' || document.readyState === 'interactive') {
            //     setTimeout(restoreGroupChats, 500);
            // }
            
            // ==================== Áæ§ËÅäÁÆ°ÁêÜÂäüËÉΩ ====================
            
            let currentManagingGroup = null;
            
            /**
             * ÊòæÁ§∫Áæ§ËÅäÁÆ°ÁêÜ‰∏ãÊãâËèúÂçï
             */
            function showGroupManagementMenu(groupData, triggerElement) {
                console.log('=== showGroupManagementMenu Ë¢´Ë∞ÉÁî® ===');
                console.log('ÊòæÁ§∫Áæ§ËÅäÁÆ°ÁêÜËèúÂçï:', groupData.name);
                
                // *** ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÁõ¥Êé•‰ªé‰∏ñÁïå‰π¶Ëé∑ÂèñÊúÄÊñ∞ÁöÑÂ§¥ÂÉèÊï∞ÊçÆ ***
                console.log('ÂéüÂßãgroupData:', JSON.stringify(groupData, null, 2));
                
                currentManagingGroup = Object.assign({}, groupData); // ÂàõÂª∫ÂâØÊú¨
                
                // ‰ªé‰∏ñÁïå‰π¶Ëé∑ÂèñÊúÄÊñ∞ÁöÑÂ§¥ÂÉèÊï∞ÊçÆ
                try {
                    const worldbookAvatar = getGroupAvatarFromWorldbook(groupData.name);
                    if (worldbookAvatar && worldbookAvatar.avatarUrl) {
                        console.log('‰ªé‰∏ñÁïå‰π¶Ëé∑ÂèñÂà∞ÊúÄÊñ∞Â§¥ÂÉèÊï∞ÊçÆ:', worldbookAvatar.avatarUrl);
                        
                        // Ê†πÊçÆÂ§¥ÂÉèÊï∞ÊçÆÁ±ªÂûãÊûÑÂª∫Ê≠£Á°ÆÁöÑÊ†ºÂºè
                        if (worldbookAvatar.avatarUrl.startsWith('data:')) {
                            // Base64Êï∞ÊçÆÔºåÊûÑÂª∫‰∏∫‰∏ä‰º†Ê†ºÂºè
                            currentManagingGroup.avatar = {
                                type: 'upload',
                                imageData: worldbookAvatar.avatarUrl,
                                dataSize: Math.round(worldbookAvatar.avatarUrl.length * 0.75)
                            };
                            console.log('‰∏ñÁïå‰π¶Â§¥ÂÉè‰∏∫Base64Ê†ºÂºèÔºåÂ∑≤ËΩ¨Êç¢‰∏∫ÂØπË±°Ê†ºÂºè');
                        } else {
                            // URLÊ†ºÂºèÔºåÁõ¥Êé•‰ΩøÁî®
                            currentManagingGroup.avatar = worldbookAvatar.avatarUrl;
                            console.log('‰∏ñÁïå‰π¶Â§¥ÂÉè‰∏∫URLÊ†ºÂºèÔºåÁõ¥Êé•‰ΩøÁî®');
                        }
                    } else {
                        console.log('‰∏ñÁïå‰π¶‰∏≠Êú™ÊâæÂà∞Â§¥ÂÉèÊï∞ÊçÆÔºå‰øùÊåÅÂéüÂßãÂ§¥ÂÉè');
                    }
                } catch (error) {
                    console.error('‰ªé‰∏ñÁïå‰π¶Ëé∑ÂèñÂ§¥ÂÉèÂ§±Ë¥•:', error);
                }
                
                console.log('currentManagingGroup Â∑≤ËÆæÁΩÆ‰∏∫:', currentManagingGroup);
                console.log('currentManagingGroup Â§¥ÂÉèÊï∞ÊçÆ:', currentManagingGroup.avatar);
                
                const dropdown = document.getElementById('group_management_dropdown');
                if (!dropdown) {
                    console.error('Êú™ÊâæÂà∞Áæ§ËÅäÁÆ°ÁêÜ‰∏ãÊãâËèúÂçïÂÖÉÁ¥†');
                    return;
                }
                
                // ËÆæÁΩÆ‰∏ãÊãâËèúÂçï‰ΩçÁΩÆ
                const rect = triggerElement.getBoundingClientRect();
                dropdown.style.position = 'fixed';
                dropdown.style.top = (rect.bottom + 5) + 'px';
                dropdown.style.left = rect.left + 'px';
                dropdown.style.width = Math.max(200, rect.width) + 'px';
                
                // ÁîüÊàêÁæ§ÊàêÂëòÂàóË°®
                const membersList = document.getElementById('group_members_display');
                membersList.innerHTML = '';
                
                groupData.members.forEach((memberName, index) => {
                    const memberItem = document.createElement('div');
                    memberItem.className = 'group-member-item';
                    
                    const memberAvatar = document.createElement('div');
                    memberAvatar.className = 'group-member-avatar';
                    
                    // *** ‰øÆÂ§çÔºö‰ºòÂÖà‰ªé‰∏ñÁïå‰π¶Ëé∑ÂèñÊàêÂëòÂ§¥ÂÉè ***
                    console.log(`Áæ§ËÅä‰∏ãÊãâËèúÂçïÔºöËé∑ÂèñÊàêÂëò ${memberName} Â§¥ÂÉè`);
                    const worldbookAvatar = getCharacterAvatarFromWorldbook(memberName);
                    if (worldbookAvatar) {
                        memberAvatar.style.backgroundImage = worldbookAvatar.backgroundImage;
                        memberAvatar.style.backgroundSize = 'cover';
                        memberAvatar.style.backgroundPosition = 'center';
                        memberAvatar.style.backgroundRepeat = 'no-repeat';
                        memberAvatar.style.borderRadius = '50%';
                        memberAvatar.style.width = '32px';
                        memberAvatar.style.height = '32px';
                        memberAvatar.style.flexShrink = '0';
                        memberAvatar.textContent = '';
                        console.log(`Áæ§ËÅä‰∏ãÊãâËèúÂçïÔºöÊàêÂäüÂ∫îÁî® ${memberName} ÁöÑ‰∏ñÁïå‰π¶Â§¥ÂÉè`);
                    } else {
                        // Â§áÈÄâÊñπÊ°à
                        const memberAvatarData = getCharacterAvatar(memberName);
                        applyCharacterAvatar(memberAvatar, memberAvatarData, memberName);
                        memberAvatar.style.width = '32px';
                        memberAvatar.style.height = '32px';
                        console.log(`Áæ§ËÅä‰∏ãÊãâËèúÂçïÔºö‰ΩøÁî®Â§áÈÄâÊñπÊ°à‰∏∫ ${memberName} Â∫îÁî®Â§¥ÂÉè`);
                    }
                    
                    const memberNameDiv = document.createElement('div');
                    memberNameDiv.className = 'group-member-name';
                    memberNameDiv.textContent = memberName;
                    
                    memberItem.appendChild(memberAvatar);
                    memberItem.appendChild(memberNameDiv);
                    membersList.appendChild(memberItem);
                });
                
                // ÊòæÁ§∫‰∏ãÊãâËèúÂçï
                dropdown.style.display = 'block';
                
                // Ê∑ªÂä†ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠ÂäüËÉΩ
                setTimeout(() => {
                    document.addEventListener('click', closeGroupManagementMenu);
                }, 100);
            }
            
            /**
             * ÂÖ≥Èó≠Áæ§ËÅäÁÆ°ÁêÜ‰∏ãÊãâËèúÂçï
             */
            function closeGroupManagementMenu(event) {
                const dropdown = document.getElementById('group_management_dropdown');
                if (!dropdown) return;
                
                // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØ‰∏ãÊãâËèúÂçïÂÜÖÈÉ®Ôºå‰∏çÂÖ≥Èó≠
                if (event && dropdown.contains(event.target)) {
                    return;
                }
                
                dropdown.style.display = 'none';
                document.removeEventListener('click', closeGroupManagementMenu);
            }
            
            /**
             * ÊòæÁ§∫Áæ§ËÅäËÆæÁΩÆÊ®°ÊÄÅÁ™óÂè£
             */
            function showGroupSettings() {
                console.log('=== showGroupSettings Ë¢´Ë∞ÉÁî® ===');
                if (!currentManagingGroup) {
                    console.error('Ê≤°ÊúâÂΩìÂâçÁÆ°ÁêÜÁöÑÁæ§ËÅä');
                    return;
                }
                
                console.log('ÊòæÁ§∫Áæ§ËÅäËÆæÁΩÆ:', currentManagingGroup.name);
                
                // ÂÖ≥Èó≠‰∏ãÊãâËèúÂçï
                closeGroupManagementMenu();
                
                const modal = document.getElementById('group_settings_modal');
                if (!modal) {
                    console.error('Êú™ÊâæÂà∞Áæ§ËÅäËÆæÁΩÆÊ®°ÊÄÅÁ™óÂè£');
                    return;
                }
                
                // Â°´ÂÖÖÂΩìÂâçÁæ§ËÅä‰ø°ÊÅØ
                const nameInput = document.getElementById('group_name_edit');
                if (nameInput) {
                    nameInput.value = currentManagingGroup.name;
                }
                
                // *** ‰øÆÂ§çÔºö‰ºòÂÖà‰ªé‰∏ñÁïå‰π¶Ëé∑ÂèñÁæ§ËÅäÂ§¥ÂÉè ***
                const avatarPreview = document.getElementById('group_settings_avatar_preview');
                if (avatarPreview) {
                    avatarPreview.innerHTML = '';
                    
                    console.log(`Áæ§ËÅäËÆæÁΩÆÔºöËé∑ÂèñÁæ§ËÅä ${currentManagingGroup.name} Â§¥ÂÉè`);
                    
                    // È¶ñÂÖàÂ∞ùËØï‰ªé‰∏ñÁïå‰π¶Ëé∑ÂèñÁæ§ËÅäÂ§¥ÂÉè
                    const worldbookGroupAvatar = getGroupAvatarFromWorldbook(currentManagingGroup.name);
                    let realAvatarFound = false;
                    
                    if (worldbookGroupAvatar) {
                        console.log(`‰ªé‰∏ñÁïå‰π¶Ëé∑ÂèñÂà∞Áæ§ËÅä ${currentManagingGroup.name} Â§¥ÂÉè:`, worldbookGroupAvatar);
                        const avatarImg = document.createElement('div');
                        avatarImg.style.backgroundImage = worldbookGroupAvatar.backgroundImage;
                        avatarImg.style.backgroundSize = 'cover';
                        avatarImg.style.backgroundPosition = 'center';
                        avatarImg.style.backgroundRepeat = 'no-repeat';
                        avatarImg.style.borderRadius = '12px';
                        avatarImg.style.width = '100%';
                        avatarImg.style.height = '100%';
                        avatarPreview.appendChild(avatarImg);
                        realAvatarFound = true;
                    } else {
                        // Â§áÈÄâÊñπÊ°àÔºö‰ªéÁæ§ËÅäÂàóË°®‰∏≠Ëé∑ÂèñÁúüÂÆûÁöÑÂ§¥ÂÉèÊï∞ÊçÆ
                        const contactsContainer = document.getElementById('QQ_home_chars');
                        
                        if (contactsContainer) {
                            const groupElements = contactsContainer.querySelectorAll('.QQ_home_char[data-group-type="true"]');
                            for (let element of groupElements) {
                                const nameElement = element.querySelector('.QQ_home_name');
                                if (nameElement && nameElement.textContent.trim() === currentManagingGroup.name) {
                                    const avatarElement = element.querySelector('.QQ_home_head');
                                    if (avatarElement) {
                                        // ÂàõÂª∫‰∏Ä‰∏™ÂíåËÅîÁ≥ª‰∫∫ÂàóË°®‰∏≠Áõ∏ÂêåÁöÑÂ§¥ÂÉè
                                        const avatarClone = document.createElement('div');
                                        avatarClone.style.cssText = avatarElement.style.cssText;
                                        avatarClone.style.width = '60px';
                                        avatarClone.style.height = '60px';
                                        avatarClone.style.fontSize = '20px';
                                        avatarClone.textContent = avatarElement.textContent;
                                        avatarPreview.appendChild(avatarClone);
                                        realAvatarFound = true;
                                        break;
                                    }
                                }
                            }
                        }
                        
                        // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ÁúüÂÆûÂ§¥ÂÉèÔºåÂ∞ùËØï‰ΩøÁî®Â≠òÂÇ®ÁöÑÂ§¥ÂÉèÊï∞ÊçÆ
                        if (!realAvatarFound && currentManagingGroup.avatar) {
                            if (currentManagingGroup.avatar.startsWith('avatar_')) {
                                const avatarData = localStorage.getItem(`avatarData_${currentManagingGroup.avatar.replace('avatar_', '')}`);
                                if (avatarData) {
                                    const img = document.createElement('img');
                                    img.src = avatarData;
                                    img.alt = 'Áæ§ËÅäÂ§¥ÂÉè';
                                    img.style.width = '100%';
                                    img.style.height = '100%';
                                    img.style.objectFit = 'cover';
                                    avatarPreview.appendChild(img);
                                    realAvatarFound = true;
                                }
                            } else if (currentManagingGroup.avatar.startsWith('http')) {
                                // Áõ¥Êé•ÊòØURL
                                const img = document.createElement('img');
                                img.src = currentManagingGroup.avatar;
                                img.alt = 'Áæ§ËÅäÂ§¥ÂÉè';
                                img.style.width = '100%';
                                img.style.height = '100%';
                                img.style.objectFit = 'cover';
                                avatarPreview.appendChild(img);
                                realAvatarFound = true;
                            }
                        }
                    }
                    
                    // Â¶ÇÊûú‰ªçÁÑ∂Ê≤°ÊúâÂ§¥ÂÉèÔºåÊòæÁ§∫ÈªòËÆ§Â§¥ÂÉè
                    if (!realAvatarFound) {
                        const defaultAvatar = document.createElement('div');
                        defaultAvatar.className = 'group-settings-default-avatar';
                        defaultAvatar.textContent = currentManagingGroup.name.charAt(0);
                        defaultAvatar.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                        defaultAvatar.style.color = 'white';
                        defaultAvatar.style.width = '100%';
                        defaultAvatar.style.height = '100%';
                        defaultAvatar.style.display = 'flex';
                        defaultAvatar.style.alignItems = 'center';
                        defaultAvatar.style.justifyContent = 'center';
                        avatarPreview.appendChild(defaultAvatar);
                        console.log(`Áæ§ËÅäËÆæÁΩÆÔºö‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉèÊòæÁ§∫ ${currentManagingGroup.name}`);
                    }
                }
                
                // ÁîüÊàêÁæ§ÊàêÂëòÁºñËæëÂàóË°®
                const membersEdit = document.getElementById('group_members_edit');
                if (membersEdit) {
                    membersEdit.innerHTML = '';
                    
                    // Ê∑ªÂä†Áé∞ÊúâÊàêÂëò
                    currentManagingGroup.members.forEach((memberName, index) => {
                        const memberItem = document.createElement('div');
                        memberItem.className = 'group-settings-member-item';
                        
                        const memberInfo = document.createElement('div');
                        memberInfo.className = 'group-settings-member-info';
                        
                        const memberAvatar = document.createElement('div');
                        memberAvatar.className = 'group-member-avatar';
                        
                        // *** ‰øÆÂ§çÔºö‰ºòÂÖà‰ªé‰∏ñÁïå‰π¶Ëé∑ÂèñÊàêÂëòÂ§¥ÂÉè ***
                        console.log(`Áæ§ËÅäËÆæÁΩÆÔºöËé∑ÂèñÊàêÂëò ${memberName} Â§¥ÂÉè`);
                        const worldbookAvatar = getCharacterAvatarFromWorldbook(memberName);
                        if (worldbookAvatar) {
                            memberAvatar.style.backgroundImage = worldbookAvatar.backgroundImage;
                            memberAvatar.style.backgroundSize = 'cover';
                            memberAvatar.style.backgroundPosition = 'center';
                            memberAvatar.style.backgroundRepeat = 'no-repeat';
                            memberAvatar.style.borderRadius = '50%';
                            memberAvatar.style.width = '32px';
                            memberAvatar.style.height = '32px';
                            memberAvatar.style.flexShrink = '0';
                            memberAvatar.textContent = '';
                            console.log(`Áæ§ËÅäËÆæÁΩÆÔºöÊàêÂäüÂ∫îÁî® ${memberName} ÁöÑ‰∏ñÁïå‰π¶Â§¥ÂÉè`);
                        } else {
                            // Â§áÈÄâÊñπÊ°à
                            const memberAvatarData = getCharacterAvatar(memberName);
                            applyCharacterAvatar(memberAvatar, memberAvatarData, memberName);
                            memberAvatar.style.width = '32px';
                            memberAvatar.style.height = '32px';
                            console.log(`Áæ§ËÅäËÆæÁΩÆÔºö‰ΩøÁî®Â§áÈÄâÊñπÊ°à‰∏∫ ${memberName} Â∫îÁî®Â§¥ÂÉè`);
                        }
                        
                        const memberNameDiv = document.createElement('div');
                        memberNameDiv.className = 'group-member-name';
                        memberNameDiv.textContent = memberName;
                        
                        memberInfo.appendChild(memberAvatar);
                        memberInfo.appendChild(memberNameDiv);
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'group-settings-remove-btn';
                        removeBtn.textContent = 'ÁßªÈô§';
                        removeBtn.onclick = () => removeMemberFromGroup(memberName);
                        
                        memberItem.appendChild(memberInfo);
                        memberItem.appendChild(removeBtn);
                        membersEdit.appendChild(memberItem);
                    });
                    
                    // Ê∑ªÂä†"Ê∑ªÂä†ÊàêÂëò"ÊåâÈíÆ
                    const addMemberItem = document.createElement('div');
                    addMemberItem.className = 'group-settings-add-member-item';
                    
                    const addMemberBtn = document.createElement('button');
                    addMemberBtn.className = 'group-settings-add-member-btn';
                    addMemberBtn.innerHTML = '<span class="add-member-icon">+</span><span class="add-member-text">Ê∑ªÂä†ÊàêÂëò</span>';
                    addMemberBtn.onclick = () => showAddMemberModal();
                    
                    addMemberItem.appendChild(addMemberBtn);
                    membersEdit.appendChild(addMemberItem);
                }
                
                // ÊòæÁ§∫Ê®°ÊÄÅÁ™óÂè£
                modal.style.display = 'flex';
            }
            
            /**
             * ÂÖ≥Èó≠Áæ§ËÅäËÆæÁΩÆÊ®°ÊÄÅÁ™óÂè£
             */
            function closeGroupSettings() {
                const modal = document.getElementById('group_settings_modal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }
            
            /**
             * ‰ªéÁæ§ËÅä‰∏≠ÁßªÈô§ÊàêÂëò
             */
            async function removeMemberFromGroup(memberName) {
                if (!currentManagingGroup) return;
                
                if (confirm(`Á°ÆÂÆöË¶ÅÂ∞Ü ${memberName} ÁßªÂá∫Áæ§ËÅäÂêóÔºü`)) {
                    const index = currentManagingGroup.members.indexOf(memberName);
                    if (index > -1) {
                        currentManagingGroup.members.splice(index, 1);
                        console.log(`Â∑≤‰ªéÁæ§ËÅä‰∏≠ÁßªÈô§ÊàêÂëò: ${memberName}`);
                        
                        // *** Á´ãÂç≥Êõ¥Êñ∞ÂΩìÂâçËÅäÂ§©ÁïåÈù¢ÔºàÂ¶ÇÊûúÊ≠£Âú®Áæ§ËÅä‰∏≠Ôºâ ***
                        if (window.currentGroupChat && window.currentGroupChat.id === currentManagingGroup.id) {
                            console.log('Á´ãÂç≥Êõ¥Êñ∞ÂΩìÂâçÁæ§ËÅäÁïåÈù¢ÔºàÁßªÈô§ÊàêÂëòÂêéÔºâ');
                            
                            // Êõ¥Êñ∞ÂΩìÂâçÁæ§ËÅäÂØπË±°
                            window.currentGroupChat.members = currentManagingGroup.members;
                            
                            // Á´ãÂç≥Êõ¥Êñ∞ËÅäÂ§©ÁïåÈù¢Â§¥ÈÉ®ÊòæÁ§∫ÔºàÂåÖÊã¨‰∫∫Êï∞Ôºâ
                            updateChatHeader(currentManagingGroup);
                            
                            console.log('Áæ§ËÅäÁïåÈù¢Â§¥ÈÉ®Â∑≤Á´ãÂç≥Êõ¥Êñ∞Ôºå‰∫∫Êï∞:', currentManagingGroup.members.length);
                        }
                        
                        // *** ‰øÆÂ§çÔºöÊ∑ªÂä†Á≥ªÁªüÊ∂àÊÅØÂπ∂Á´ãÂç≥ÊòæÁ§∫ ***
                        const systemMessage = `Áæ§‰∏ªÂ∞Ü${memberName}ÁßªÂá∫‰∫ÜÁæ§ËÅä`;
                        
                        // *** ‰øÆÂ§çÔºöÊÄªÊòØÊòæÁ§∫Á≥ªÁªüÊ∂àÊÅØÔºå‰∏ç‰æùËµñÁïåÈù¢Áä∂ÊÄÅÊ£ÄÊü• ***
                        console.log('ÊòæÁ§∫ÁßªÈô§ÊàêÂëòÁ≥ªÁªüÊ∂àÊÅØ:', systemMessage);
                        await addSystemMessageToGroup(currentManagingGroup.id, systemMessage);
                        
                        // *** ‰øÆÂ§çÔºöÂº∫Âà∂Á´ãÂç≥ÊòæÁ§∫Á≥ªÁªüÊ∂àÊÅØ ***
                        console.log('Âº∫Âà∂Á´ãÂç≥ÊòæÁ§∫ÁßªÈô§ÊàêÂëòÁ≥ªÁªüÊ∂àÊÅØ:', systemMessage);
                        displaySystemMessage(systemMessage, currentManagingGroup.id);
                        
                                // *** Á´ãÂç≥Êõ¥Êñ∞ÊâÄÊúâÁïåÈù¢‰∏≠ÁöÑÁæ§ËÅäÊòæÁ§∫ ***
        console.log('Á´ãÂç≥Êõ¥Êñ∞ËÅîÁ≥ª‰∫∫ÂàóË°®‰∏≠ÁöÑÁæ§ËÅäÊòæÁ§∫ÔºàÁßªÈô§ÊàêÂëòÂêéÔºâ...');
        
        // *** ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÁ°Æ‰øù‰º†ÈÄíÂÆåÊï¥ÁöÑÁæ§ËÅäÊï∞ÊçÆÔºåÂåÖÊã¨Â§¥ÂÉè‰ø°ÊÅØ ***
        console.log('‰º†ÈÄíÁªôprotectedContactListUpdateÁöÑÊï∞ÊçÆ:', {
            name: currentManagingGroup.name,
            id: currentManagingGroup.id,
            avatar: currentManagingGroup.avatar,
            members: currentManagingGroup.members
        });
        await protectedContactListUpdate(currentManagingGroup, 'remove_member');
        
        // Êõ¥Êñ∞Âà∞‰∏ñÁïå‰π¶
        await updateGroupMembersInWorldbook(currentManagingGroup.name, currentManagingGroup.members);
        
        // *** ËΩªÈáèÁ∫ßÁïåÈù¢Êõ¥Êñ∞ÔºåÈÅøÂÖçÊ∂àÊÅØ‰∏¢Â§± ***
        console.log('ÊâßË°åËΩªÈáèÁ∫ßÁïåÈù¢Êõ¥Êñ∞ÔºàÁßªÈô§ÊàêÂëòÂêéÔºâ...');
        await refreshGroupChatsDisplay();
                        
                        // ÈáçÊñ∞ÁîüÊàêÊàêÂëòÂàóË°®
                        showGroupSettings();
                    }
                }
            }
            
            /**
             * ÊòæÁ§∫Áæ§ËÅäÂ§¥ÂÉèÈÄâÊã©Âô®
             */
            function showGroupAvatarSelector() {
                if (!currentManagingGroup) {
                    console.error('Ê≤°ÊúâÂΩìÂâçÁÆ°ÁêÜÁöÑÁæ§ËÅä');
                    return;
                }
                
                // ËÆæÁΩÆÂÖ®Â±ÄÂèòÈáèÔºåÊ†áËØÜÂΩìÂâçÊòØÂú®Áæ§ËÅäËÆæÁΩÆ‰∏≠ÈÄâÊã©Â§¥ÂÉè
                window.isSelectingGroupAvatar = true;
                window.currentAvatarGroup = currentManagingGroup;
                
                // ÊòæÁ§∫Â§¥ÂÉèÈÄâÊã©Âô®Ê®°ÊÄÅÁ™óÂè£
                const avatarModal = document.getElementById('avatar_selector_modal');
                if (avatarModal) {
                    avatarModal.style.display = 'flex';
                    
                    // ÂàáÊç¢Âà∞‰∏ä‰º†Ê†áÁ≠æÈ°µ
                    switchAvatarTab('upload');
                } else {
                    console.error('Êú™ÊâæÂà∞Â§¥ÂÉèÈÄâÊã©Âô®Ê®°ÊÄÅÁ™óÂè£');
                }
            }
            
            // *** ÊóßÁöÑÁæ§ËÅäÂ§¥ÂÉè‰∏ä‰º†ÂáΩÊï∞Â∑≤ÁßªÈô§ÔºåÁé∞Âú®‰ΩøÁî®Áªü‰∏ÄÁöÑ handleAvatarUpload Âíå confirmAvatarSelection ÈÄªËæë ***

            /**
             * ‰øùÂ≠òÁæ§ËÅäËÆæÁΩÆÔºàÂ¢ûÂº∫‰øÆÂ§çÁâàÔºöÁ´ãÂç≥ÁîüÊïàÔºå‰øùÊåÅÊ∂àÊÅØ‰∏ç‰∏¢Â§±Ôºâ
             */
            async function saveGroupSettings() {
                if (!currentManagingGroup) return;
                
                const nameInput = document.getElementById('group_name_edit');
                const newName = nameInput ? nameInput.value.trim() : '';
                
                if (!newName) {
                    alert('Áæ§ËÅäÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫');
                    return;
                }
                
                console.log('=== ‰øùÂ≠òÁæ§ËÅäËÆæÁΩÆÔºàÂ¢ûÂº∫‰øÆÂ§çÁâàÔºâ ===');
                console.log('ÂéüÁæ§ËÅäÂêçÁß∞:', currentManagingGroup.name);
                console.log('Êñ∞Áæ§ËÅäÂêçÁß∞:', newName);
                console.log('ÈÄâ‰∏≠ÁöÑÂ§¥ÂÉèÊï∞ÊçÆ:', window.selectedAvatarData);
                
                // *** ÈáçË¶Å‰øÆÂ§çÔºöÁ°Æ‰øù‰∏ñÁïå‰π¶ÂèòÈáèÂ∑≤Ê≠£Á°ÆÂàùÂßãÂåñ ***
                try {
                    if (!worldbook) {
                        console.log('‰∏ñÁïå‰π¶ÂèòÈáèÊú™ÂàùÂßãÂåñÔºåÈáçÊñ∞Ëé∑Âèñ...');
                        worldbook = await GetWorldBookName();
                        if (!worldbook) {
                            console.error('Êó†Ê≥ïËé∑Âèñ‰∏ñÁïå‰π¶Ôºå‰øùÂ≠òÊìç‰ΩúÁªàÊ≠¢');
                            alert('Êó†Ê≥ïËøûÊé•Âà∞‰∏ñÁïå‰π¶ÔºåËØ∑Á®çÂêéÈáçËØï');
                            return;
                        }
                    }
                    
                    if (!entries) {
                        console.log('entriesÂèòÈáèÊú™ÂàùÂßãÂåñÔºåÈáçÊñ∞Ëé∑Âèñ...');
                        entries = await getLorebookEntries(worldbook);
                        if (!entries) {
                            console.error('Êó†Ê≥ïËé∑Âèñ‰∏ñÁïå‰π¶Êù°ÁõÆÔºå‰øùÂ≠òÊìç‰ΩúÁªàÊ≠¢');
                            alert('Êó†Ê≥ïËØªÂèñ‰∏ñÁïå‰π¶Êï∞ÊçÆÔºåËØ∑Á®çÂêéÈáçËØï');
                            return;
                        }
                    }
                    
                    console.log('‰∏ñÁïå‰π¶ÂàùÂßãÂåñÊ£ÄÊü•ÂÆåÊàêÔºåworldbook:', worldbook, 'entriesÊï∞Èáè:', entries.length);
                } catch (error) {
                    console.error('‰∏ñÁïå‰π¶ÂàùÂßãÂåñÂ§±Ë¥•:', error);
                    alert('‰∏ñÁïå‰π¶ÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
                    return;
                }
                
                // ‰øùÂ≠òÊóßÁöÑ‰ø°ÊÅØ
                const oldName = currentManagingGroup.name;
                const oldId = currentManagingGroup.id;
                const oldAvatar = currentManagingGroup.avatar;
                
                // *** ÈáçË¶Å‰øÆÂ§çÔºöÁ°Æ‰øùÂ§¥ÂÉèÊï∞ÊçÆÂÆåÊï¥ÊÄß ***
                console.log('Ê£ÄÊü•Â§¥ÂÉèÊï∞ÊçÆÂÆåÊï¥ÊÄß:');
                console.log('- currentManagingGroup.avatar:', currentManagingGroup.avatar);
                console.log('- window.selectedAvatarData:', window.selectedAvatarData);
                
                // *** ÂÖ≥ÈîÆ‰øÆÂ§çÔºö‰ªé‰∏ñÁïå‰π¶comment‰∏≠Ëé∑ÂèñÂéüÂßãÁæ§ËÅäÂêçÁß∞ÔºåÁ°Æ‰øùIDÁ®≥ÂÆö ***
                let originalGroupName = oldName; // ÈªòËÆ§‰ΩøÁî®ÂΩìÂâçÂêçÁß∞
                try {
                    if (entries) {
                        const groupEntry = entries.find(e => 
                            e.comment === `ÊâãÊú∫-Áæ§ËÅä-${oldName}` || 
                            e.comment.startsWith('ÊâãÊú∫-Áæ§ËÅä-') && 
                            e.content.includes(`[${oldName}]`)
                        );
                        
                        if (groupEntry && groupEntry.comment.startsWith('ÊâãÊú∫-Áæ§ËÅä-')) {
                            originalGroupName = groupEntry.comment.replace('ÊâãÊú∫-Áæ§ËÅä-', '');
                            console.log('‰ªé‰∏ñÁïå‰π¶comment‰∏≠Ëé∑ÂèñÂà∞ÂéüÂßãÁæ§ËÅäÂêçÁß∞:', originalGroupName);
                        }
                    }
                } catch (error) {
                    console.warn('Ëé∑ÂèñÂéüÂßãÁæ§ËÅäÂêçÁß∞Êó∂Âá∫ÈîôÔºå‰ΩøÁî®ÂΩìÂâçÂêçÁß∞:', error);
                }
                
                // *** ‰øÆÂ§çÔºöÁ°Æ‰øùID‰øùÊåÅÁ®≥ÂÆöÔºåÂü∫‰∫éÂéüÂßãÂêçÁß∞ÁîüÊàê ***
                const stableGroupId = `group_${originalGroupName.replace(/[^a-zA-Z0-9\u4e00-\u9fff]/g, '_')}`;
                console.log('‰ΩøÁî®Á®≥ÂÆöÁöÑÁæ§ËÅäID:', stableGroupId, '(Âü∫‰∫éÂéüÂßãÂêçÁß∞:', originalGroupName, ')');
                
                // ËÆ∞ÂΩïÂèòÊõ¥Á±ªÂûã
                const changes = [];
                
                // Êõ¥Êñ∞Áæ§ËÅäÂêçÁß∞Ôºà‰øùÊåÅID‰∏çÂèòÔºâ
                if (newName !== oldName) {
                    // *** Ê†∏ÂøÉ‰øÆÂ§çÔºöÂÆåÊï¥ÁöÑÊï∞ÊçÆÁªëÂÆöËøÅÁßª ***
                    console.log('=== ÊâßË°åÂÆåÊï¥Êï∞ÊçÆÁªëÂÆöËøÅÁßª ===');
                    const migratedCount = await migrateGroupDataBindings(oldName, newName, currentManagingGroup);
                    console.log(`Êï∞ÊçÆÁªëÂÆöËøÅÁßªÂÆåÊàêÔºåÂÖ±ËøÅÁßª ${migratedCount} È°π`);
                    
                    currentManagingGroup.name = newName;
                    currentManagingGroup.id = stableGroupId;
                    changes.push({
                        type: 'name',
                        oldValue: oldName,
                        newValue: newName
                    });
                }
                
                // *** ‰øÆÂ§çÔºöÊõ¥Êñ∞Â§¥ÂÉè‰ø°ÊÅØ ***
                if (window.selectedAvatarData) {
                    console.log('Ê£ÄÊµãÂà∞Êñ∞ÁöÑÂ§¥ÂÉèÊï∞ÊçÆÔºåÊõ¥Êñ∞Áæ§ËÅäÂ§¥ÂÉè:', window.selectedAvatarData);
                    currentManagingGroup.avatar = window.selectedAvatarData;
                    
                    // Â¶ÇÊûúÊòØ‰∏ä‰º†ÁöÑÂ§¥ÂÉèÔºåÁ°Æ‰øùÊï∞ÊçÆÊ†ºÂºèÊ≠£Á°Æ
                    if (window.selectedAvatarData.type === 'upload' && window.selectedAvatarData.imageData) {
                        currentManagingGroup.avatarUrl = window.selectedAvatarData.imageData;
                    }
                    
                    changes.push({
                        type: 'avatar',
                        oldValue: oldAvatar,
                        newValue: window.selectedAvatarData
                    });
                } else {
                    // *** ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÂ¶ÇÊûúÊ≤°ÊúâÊñ∞Â§¥ÂÉèÊï∞ÊçÆÔºåÁ°Æ‰øù‰øùÊåÅÂéüÊúâÂ§¥ÂÉè ***
                    console.log('Ê≤°ÊúâÊñ∞Â§¥ÂÉèÊï∞ÊçÆÔºå‰øùÊåÅÂéüÊúâÂ§¥ÂÉè:', currentManagingGroup.avatar);
                    console.log('ÂéüÊúâÂ§¥ÂÉèÊï∞ÊçÆÁ±ªÂûã:', typeof currentManagingGroup.avatar);
                    console.log('ÂéüÊúâÂ§¥ÂÉèÊï∞ÊçÆËØ¶ÊÉÖ:', currentManagingGroup.avatar);
                    
                    // *** ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÂ§ÑÁêÜ‰∏çÂêåÊ†ºÂºèÁöÑÂ§¥ÂÉèÊï∞ÊçÆ ***
                    if (currentManagingGroup.avatar) {
                        // ÊÉÖÂÜµ1ÔºöÂ§¥ÂÉèÊòØÂ≠óÁ¨¶‰∏≤URLÔºàÈúÄË¶Å‰øùÊåÅ‰∏çÂèòÔºâ
                        if (typeof currentManagingGroup.avatar === 'string') {
                            console.log('Ê£ÄÊµãÂà∞Â≠óÁ¨¶‰∏≤Á±ªÂûãÂ§¥ÂÉèÔºå‰øùÊåÅ‰∏çÂèò:', currentManagingGroup.avatar);
                            // ‰øùÊåÅÂ≠óÁ¨¶‰∏≤Ê†ºÂºèÁöÑÂ§¥ÂÉè‰∏çÂèò
                            // ‰∏çÈúÄË¶ÅÈ¢ùÂ§ñÂ§ÑÁêÜÔºåÂ≠óÁ¨¶‰∏≤Â§¥ÂÉè‰ºöË¢´updateAvatarElementÊ≠£Á°ÆÂ§ÑÁêÜ
                        }
                        // ÊÉÖÂÜµ2ÔºöÂ§¥ÂÉèÊòØÂØπË±°ÔºåÊ£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅË°•ÂÖÖÊï∞ÊçÆ
                        else if (typeof currentManagingGroup.avatar === 'object' && currentManagingGroup.avatar.type) {
                            console.log('Ê£ÄÊµãÂà∞ÂØπË±°Á±ªÂûãÂ§¥ÂÉèÔºåÊ£ÄÊü•Êï∞ÊçÆÂÆåÊï¥ÊÄß');
                            // Â¶ÇÊûúÊúâavatarUrl‰ΩÜÊ≤°ÊúâÂú®avatarÂØπË±°‰∏≠ÔºåÈúÄË¶ÅË°•ÂÖÖ
                            if (currentManagingGroup.avatarUrl && 
                                currentManagingGroup.avatar.type === 'upload' && 
                                !currentManagingGroup.avatar.imageData) {
                                currentManagingGroup.avatar.imageData = currentManagingGroup.avatarUrl;
                                console.log('‰øÆÂ§çÂ§¥ÂÉèÊï∞ÊçÆÊ†ºÂºèÔºåÊ∑ªÂä†imageData');
                            }
                        }
                        // ÊÉÖÂÜµ3ÔºöÂ§¥ÂÉèÊï∞ÊçÆÊ†ºÂºèÂºÇÂ∏∏ÔºåÂ∞ùËØï‰ªéavatarUrlÊÅ¢Â§ç
                        else {
                            console.log('Â§¥ÂÉèÊï∞ÊçÆÊ†ºÂºèÂºÇÂ∏∏ÔºåÂ∞ùËØï‰ªéavatarUrlÊÅ¢Â§ç');
                            if (currentManagingGroup.avatarUrl) {
                                console.log('‰ΩøÁî®avatarUrl‰Ωú‰∏∫Â§¥ÂÉè:', currentManagingGroup.avatarUrl);
                                currentManagingGroup.avatar = currentManagingGroup.avatarUrl;
                            } else {
                                console.log('Êó†Ê≥ïÊÅ¢Â§çÂ§¥ÂÉèÊï∞ÊçÆÔºåËÆæÁΩÆÈªòËÆ§Â§¥ÂÉè');
                                currentManagingGroup.avatar = {
                                    type: 'preset',
                                    text: 'Áæ§',
                                    gradient: {
                                        start: '#199AFF',
                                        end: '#0066CC'
                                    }
                                };
                            }
                        }
                    } else {
                        // ÊÉÖÂÜµ4ÔºöÂÆåÂÖ®Ê≤°ÊúâÂ§¥ÂÉèÊï∞ÊçÆÔºåÂ∞ùËØï‰ªéavatarUrlÊÅ¢Â§çÊàñËÆæÁΩÆÈªòËÆ§
                        console.log('Ê≤°ÊúâÂ§¥ÂÉèÊï∞ÊçÆÔºåÊ£ÄÊü•ÊòØÂê¶ÊúâavatarUrl...');
                        if (currentManagingGroup.avatarUrl) {
                            console.log('‰ΩøÁî®avatarUrl‰Ωú‰∏∫Â§¥ÂÉè:', currentManagingGroup.avatarUrl);
                            currentManagingGroup.avatar = currentManagingGroup.avatarUrl;
                        } else {
                            console.log('ËÆæÁΩÆÈªòËÆ§Â§¥ÂÉè');
                            currentManagingGroup.avatar = {
                                type: 'preset',
                                text: 'Áæ§',
                                gradient: {
                                    start: '#199AFF',
                                    end: '#0066CC'
                                }
                            };
                        }
                    }
                    
                    console.log('Â§¥ÂÉèÊï∞ÊçÆÂ§ÑÁêÜÂÆåÊàê:', currentManagingGroup.avatar);
                }
                
                // *** Ê†∏ÂøÉ‰øÆÂ§ç1ÔºöÂú®‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶‰πãÂâçÔºåÂÖàÁ´ãÂç≥Êõ¥Êñ∞ÁïåÈù¢ ***
                console.log('=== Á´ãÂç≥Êõ¥Êñ∞ÁïåÈù¢ÊòæÁ§∫Ôºà‰øùÂ≠òÂâçÔºâ ===');
                
                // ÁÆÄÂåñÔºöÂü∫Êú¨DOMÊõ¥Êñ∞Ôºà‰∫§ÁªôÊï∞ÊçÆËøÅÁßªÂáΩÊï∞Â§ÑÁêÜÔºâ
                console.log('Âü∫Êú¨DOMÂ±ûÊÄßÊõ¥Êñ∞Â∑≤Áî±migrateGroupDataBindingsÂ§ÑÁêÜ');
                
                // *** ÁÆÄÂåñÁöÑÁïåÈù¢Êõ¥Êñ∞ÊµÅÁ®ã ***
                console.log('=== ÁÆÄÂåñÁïåÈù¢Êõ¥Êñ∞ÊµÅÁ®ã ===');
                
                // Êõ¥Êñ∞ÂΩìÂâçÁæ§ËÅäÂØπË±°ÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
                    if (window.currentGroupChat && window.currentGroupChat.id === stableGroupId) {
                        window.currentGroupChat.name = currentManagingGroup.name;
                        window.currentGroupChat.avatar = currentManagingGroup.avatar;
                        window.currentGroupChat.avatarUrl = currentManagingGroup.avatarUrl;
                        window.currentGroupChat.members = currentManagingGroup.members;
                }
                
                // 1. Á´ãÂç≥Êõ¥Êñ∞Ê†áÈ¢ò
                console.log('ÂºÄÂßãÂØªÊâæËÅäÂ§©Â§¥ÈÉ®ËøõË°åÊõ¥Êñ∞...');
                
                // Êü•ÊâæÂΩìÂâçÂèØËßÅÁöÑËÅäÂ§©È°µÈù¢Â§¥ÈÉ®
                let chatHeader = null;
                const visibleChatPage = document.querySelector('.QQ_chat_page[style*="display:block"], .QQ_chat_page:not([style*="display:none"])');
                if (visibleChatPage) {
                    chatHeader = visibleChatPage.querySelector('.QQ_chat_header, .QQ_home');
                }
                
                            if (chatHeader) {
                    console.log('ÊâæÂà∞ËÅäÂ§©Â§¥ÈÉ®ÔºåÂºÄÂßãÊõ¥Êñ∞Ê†áÈ¢ò...');
                                updateHeaderContent(chatHeader, currentManagingGroup);
                } else {
                    console.log('Êú™ÊâæÂà∞ÂèØËßÅÁöÑËÅäÂ§©Â§¥ÈÉ®ÔºåË∑≥ËøáÊ†áÈ¢òÊõ¥Êñ∞');
                }
                
                // 2. Âª∂ËøüÊÅ¢Â§çËÉåÊôØÂíåÊõ¥Êñ∞ËÅîÁ≥ª‰∫∫ÔºàÈÅøÂÖçÂÜ≤Á™ÅÔºâ
                setTimeout(async () => {
                    // ÈáçÊñ∞Â∫îÁî®Áæ§ËÅäËÉåÊôØ
                    reapplyGroupChatBackground(currentManagingGroup);
                    
                    // ‰øùÊä§ÊÄßËÅîÁ≥ª‰∫∫Êõ¥Êñ∞
                    await protectedContactListUpdate(currentManagingGroup, oldName);
                    
                    console.log('ÁïåÈù¢Êõ¥Êñ∞ÊµÅÁ®ãÂÆåÊàê');
                }, 150);
                
                // Á°Æ‰øù‰ΩøÁî®Á®≥ÂÆöID
                currentManagingGroup.id = stableGroupId;
                
                // Áé∞Âú®Êâç‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶
                if (oldName !== newName) {
                    await updateGroupNameInWorldbook(oldName, newName);
                } else {
                    // Âç≥‰ΩøÂêçÁß∞Ê≤°ÂèòÔºå‰πüË¶Å‰øùÂ≠òÂ§¥ÂÉèÁ≠âÂÖ∂‰ªñ‰ø°ÊÅØ
                    await saveGroupToWorldbook(currentManagingGroup);
                }
                
                // *** Ê†∏ÂøÉ‰øÆÂ§ç4ÔºöÊ∑ªÂä†Á≥ªÁªüÊ∂àÊÅØÂπ∂Á´ãÂç≥ÊòæÁ§∫ ***
                if (changes.length > 0) {
                    console.log('Ê∑ªÂä†Á≥ªÁªüÊ∂àÊÅØÔºåÂèòÊõ¥ÂàóË°®:', changes);
                    
                    // ‰∏∫ÊØè‰∏™ÂèòÊõ¥ÁîüÊàêÁ≥ªÁªüÊ∂àÊÅØ
                    for (const change of changes) {
                        let systemMessage = '';
                        switch (change.type) {
                            case 'name':
                                systemMessage = `Áæ§ËÅäÂêçÁß∞Â∑≤Êõ¥Êîπ‰∏∫"${change.newValue}"`;
                                break;
                            case 'avatar':
                                systemMessage = `Áæ§‰∏ªÂ∑≤Êõ¥ÊîπÁæ§Â§¥ÂÉè`;
                                break;
                        }
                        
                        if (systemMessage) {
                            console.log('Â§ÑÁêÜÁ≥ªÁªüÊ∂àÊÅØ:', systemMessage);
                            
                            // ‰øùÂ≠òÂà∞Áæ§ËÅäÊ∂àÊÅØÂéÜÂè≤‰∏≠
                            await addSystemMessageToGroup(stableGroupId, systemMessage);
                            
                            // *** Âº∫Âà∂Âú®ÂΩìÂâçËÅäÂ§©ÁïåÈù¢ÊòæÁ§∫Á≥ªÁªüÊ∂àÊÅØÔºàË∂ÖÂº∫Âà∂ÁâàÔºâ ***
                            console.log('Ê£ÄÊü•ÂΩìÂâçËÅäÂ§©Áä∂ÊÄÅ:', {
                                currentGroupChat: window.currentGroupChat ? window.currentGroupChat.id : 'null',
                                targetGroupId: stableGroupId,
                                isMatching: window.currentGroupChat && window.currentGroupChat.id === stableGroupId
                            });
                            
                            // ÁÆÄÂåñÔºöÂ¶ÇÊûúËÉΩÊìç‰ΩúÁæ§ËÅäËÆæÁΩÆÔºåÂ∞±Áõ¥Êé•ÊòæÁ§∫Á≥ªÁªüÊ∂àÊÅØ
                            console.log('*** ÊòæÁ§∫Á≥ªÁªüÊ∂àÊÅØ ***:', systemMessage);
                            console.log('ÂΩìÂâçËÅäÂ§©È°µÈù¢Áä∂ÊÄÅÊ£ÄÊü•...');
                            
                            // ÊòæÁ§∫Á≥ªÁªüÊ∂àÊÅØÂà∞Ê≠£Á°ÆÁöÑÁæ§ËÅä
                            console.log('ÊòæÁ§∫Á≥ªÁªüÊ∂àÊÅØÂà∞ÂΩìÂâçÊìç‰ΩúÁöÑÁæ§ËÅä:', currentManagingGroup.id);
                            displaySystemMessage(systemMessage, currentManagingGroup.id);
                        }
                    }
                }
                
                // *** ‰øÆÂ§çÔºöÊõ¥Êñ∞Ê∂àÊÅØJSON‰∏≠ÁöÑÁæ§ËÅä‰ø°ÊÅØÔºå‰øùÊåÅËÅäÂ§©ËÆ∞ÂΩï ***
                if (oldName !== newName) {
                    await updateGroupChatMessagesInMsgjson(stableGroupId, oldName, newName);
                }
                
                // Ê∏ÖÁ©∫ÈÄâ‰∏≠ÁöÑÂ§¥ÂÉèÊï∞ÊçÆ
                window.selectedAvatarData = null;
                
                console.log(`Áæ§ËÅäËÆæÁΩÆÂ∑≤‰øùÂ≠òÂπ∂Á´ãÂç≥ÁîüÊïà: ${oldName} -> ${newName}`);
                alert('Áæ§ËÅäËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
                closeGroupSettings();
            }
            
            /**
             * Âà†Èô§ÂΩìÂâçÁæ§ËÅä
             */
            async function deleteCurrentGroup() {
                if (!currentManagingGroup) return;
                
                if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Áæ§ËÅä "${currentManagingGroup.name}" ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`)) {
                    console.log('Âà†Èô§Áæ§ËÅä:', currentManagingGroup.name);
                    
                    const deletedGroupId = currentManagingGroup.id;
                    const deletedGroupName = currentManagingGroup.name;
                    
                    // **ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÂÖàÂÖ≥Èó≠Ê®°ÊÄÅÁ™óÂè£Âπ∂Á´ãÂç≥Ë∑≥ËΩ¨ÔºåÈÅøÂÖçÁïåÈù¢Âç°Ê≠ª**
                    closeGroupSettings();
                    
                    // ËÆ∞ÂΩïË∑≥ËΩ¨ÁõÆÊ†áÂíåÂΩìÂâçÁä∂ÊÄÅ
                    let shouldJumpToPage = null;
                    let wasInGroupChat = false;
                    
                    if (window.currentGroupChat && window.currentGroupChat.id === deletedGroupId) {
                        shouldJumpToPage = window.groupChatSourcePage || 'people';
                        wasInGroupChat = true;
                        console.log('Âà†Èô§Áæ§ËÅäÂêéÈúÄË¶ÅË∑≥ËΩ¨Âà∞È°µÈù¢:', shouldJumpToPage);
                        console.log('ÂΩìÂâçÂú®Áæ§ËÅäÁïåÈù¢ÔºåÈúÄË¶ÅË∑≥ËΩ¨');
                    } else {
                        // Âç≥‰Ωø‰∏çÂú®Áæ§ËÅäÁïåÈù¢Ôºå‰πüË¶ÅÁ°Æ‰øùÂà†Èô§ÂêéÂà∑Êñ∞ÂΩìÂâçÈ°µÈù¢
                        shouldJumpToPage = 'people'; // ÈªòËÆ§Ë∑≥ËΩ¨Âà∞ËÅîÁ≥ª‰∫∫È°µÈù¢
                        console.log('‰∏çÂú®Áæ§ËÅäÁïåÈù¢Ôºå‰ΩÜ‰ªçÈúÄË¶ÅÂà∑Êñ∞ÁïåÈù¢');
                    }
                    
                    // Á≠âÂæÖÊ®°ÊÄÅÁ™óÂè£ÂÖ≥Èó≠ÂêéÂÜçÊâßË°åÂà†Èô§Êìç‰Ωú
                    setTimeout(async () => {
                        try {
                            // ‰ªé‰∏ñÁïå‰π¶‰∏≠Âà†Èô§
                            await removeGroupFromWorldbook(deletedGroupName);
                            console.log('Áæ§ËÅäÂ∑≤‰ªé‰∏ñÁïå‰π¶‰∏≠Âà†Èô§');
                            
                            // Á´ãÂç≥Âà∑Êñ∞entries
                            console.log('Âà∑Êñ∞entries‰ª•ÁßªÈô§Â∑≤Âà†Èô§ÁöÑÁæ§ËÅä');
                            entries = await getLorebookEntries(worldbook);
                            console.log('entriesÂà∑Êñ∞ÊàêÂäüÔºåÊñ∞ÁöÑÊù°ÁõÆÊï∞Èáè:', entries ? entries.length : 'failed');
                            

                            
                            // ‰ªéÊï∞ÊçÆÁªìÊûÑ‰∏≠Âà†Èô§Áæ§ËÅä
                            delete QQ_msgjson.Áæ§ËÅä[deletedGroupName];
                            
                            // ‰øÆÂ§çÔºöÁ°Æ‰øùQQ_GroupsÊòØÊúâÊïàÁöÑÊï∞ÁªÑ
                            if (QQ_Groups && Array.isArray(QQ_Groups)) {
                                const index = QQ_Groups.findIndex(g => g && (g.id === deletedGroupId || g.name === deletedGroupName));
                                if (index > -1) {
                                    QQ_Groups.splice(index, 1);
                                }
                            }
                            console.log('Áæ§ËÅäÂ∑≤‰ªéÊï∞ÊçÆÁªìÊûÑ‰∏≠Âà†Èô§ÔºåÂΩìÂâçQQ_Groups:', QQ_Groups.length);
                            
                            // **ÂÖàÊ∏ÖÈô§Áæ§ËÅäÁä∂ÊÄÅÔºåÈÅøÂÖçË∑≥ËΩ¨Êó∂ÁöÑÁä∂ÊÄÅÂÜ≤Á™Å**
                            if (wasInGroupChat) {
                                window.currentGroupChat = null;
                                window.groupChatSourcePage = null;
                                console.log('Â∑≤Ê∏ÖÈô§Áæ§ËÅäÁä∂ÊÄÅ');
                            }
                            
                            // **Á´ãÂç≥Ë∑≥ËΩ¨Âà∞ÁõÆÊ†áÈ°µÈù¢**
                            console.log('ÊâßË°åÈ°µÈù¢Ë∑≥ËΩ¨Âà∞:', shouldJumpToPage);
                            if (typeof QQ_Nav === 'function') {
                                if (shouldJumpToPage === 'messages') {
                                    QQ_Nav('message');
                                } else {
                                    QQ_Nav('people');
                                }
                                console.log('Ë∑≥ËΩ¨ÂÆåÊàê');
                            } else {
                                console.warn('QQ_NavÂáΩÊï∞‰∏çÂèØÁî®ÔºåÊâãÂä®ÊòæÁ§∫ËÅîÁ≥ª‰∫∫È°µÈù¢');
                                // ÊâãÂä®ÊòæÁ§∫ËÅîÁ≥ª‰∫∫È°µÈù¢
                                $('.QQ_chat_page').hide();
                                $('.group-chat-page').hide();
                                $('#QQ_home_page').show();
                                $('.QQ_bottom_nav').show();
                            }
                            
                            // **Á≠âÂæÖË∑≥ËΩ¨ÂÆåÊàêÂêéÂÜçÂà†Èô§ÁïåÈù¢ÂÖÉÁ¥†ÂíåÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ**
                            setTimeout(async () => {
                                // Âà†Èô§ÁâπÂÆöÁöÑÁæ§ËÅäÂÖÉÁ¥†
                                safeRemoveGroupFromInterface(deletedGroupId, deletedGroupName);
                                
                                // ÈáçÊñ∞Âä†ËΩΩÁæ§ËÅäÊï∞ÊçÆ
                                console.log('ÈáçÊñ∞Âä†ËΩΩÁæ§ËÅäÊï∞ÊçÆ');
                                await loadGroupChatsFromWorldbook();
                                
                                // Êõ¥Êñ∞Ê∂àÊÅØÂàóË°®
                                await QQ_UpdateMessageList();
                                
                                console.log('ÁïåÈù¢Êï∞ÊçÆÊõ¥Êñ∞ÂÆåÊàê');
                            }, 300);
                            
                            console.log('Áæ§ËÅäÂà†Èô§ÂÆåÊàê:', deletedGroupName);
                            alert('Áæ§ËÅäÂ∑≤Âà†Èô§');
                            
                        } catch (error) {
                            console.error('Âà†Èô§Áæ§ËÅäÊó∂Âá∫Èîô:', error);
                            alert('Âà†Èô§Áæ§ËÅäÊó∂Âá∫Áé∞ÈóÆÈ¢òÔºåËØ∑Âà∑Êñ∞È°µÈù¢');
                            
                            // Âá∫ÈîôÊó∂Á°Æ‰øùÁïåÈù¢ÊÅ¢Â§çÊ≠£Â∏∏
                            console.log('Âá∫ÈîôÂêéÊÅ¢Â§çÁïåÈù¢ÊòæÁ§∫');
                            
                            // Ê∏ÖÈô§Áæ§ËÅäÁä∂ÊÄÅ
                            if (wasInGroupChat) {
                                window.currentGroupChat = null;
                                window.groupChatSourcePage = null;
                            }
                            
                            // Âº∫Âà∂ÊòæÁ§∫ËÅîÁ≥ª‰∫∫È°µÈù¢
                            $('.QQ_chat_page').hide();
                            $('.group-chat-page').hide();
                            $('#QQ_home_page').show();
                            $('.QQ_bottom_nav').show();
                            
                            // Â∞ùËØïÈÄöËøáQQ_NavÊÅ¢Â§çÊ≠£Â∏∏Áä∂ÊÄÅ
                            if (typeof QQ_Nav === 'function') {
                                QQ_Nav('people');
                            }
                        }
                        
                        currentManagingGroup = null;
                    }, 100); // Áº©Áü≠Á≠âÂæÖÊó∂Èó¥
                }
            }
            
            /**
             * Êõ¥Êñ∞ÊâÄÊúâÂàóË°®‰∏≠ÁöÑÁæ§ËÅä‰ø°ÊÅØÔºàÂ¢ûÂº∫ÁâàÔºöÂåÖÂê´Â§¥ÂÉèÊõ¥Êñ∞Ôºâ
             */
            async function updateGroupInAllListsWithAvatar(groupData) {
                console.log('Êõ¥Êñ∞ÊâÄÊúâÂàóË°®‰∏≠ÁöÑÁæ§ËÅä‰ø°ÊÅØÔºåÂåÖÊã¨Â§¥ÂÉè:', groupData);
                
                // Êõ¥Êñ∞ËÅîÁ≥ª‰∫∫ÂàóË°®
                const contactsContainer = document.getElementById('QQ_home_chars');
                if (contactsContainer) {
                    const existingGroup = contactsContainer.querySelector(`[data-group-id="${groupData.id}"]`);
                    if (existingGroup) {
                        const nameElement = existingGroup.querySelector('.QQ_home_name');
                        const avatarElement = existingGroup.querySelector('.QQ_home_head');
                        
                        if (nameElement) {
                            nameElement.textContent = groupData.name;
                        }
                        
                        // Êõ¥Êñ∞Â§¥ÂÉè
                        if (avatarElement && groupData.avatar) {
                            updateAvatarElement(avatarElement, groupData.avatar);
                        }
                    }
                }
                
                // Êõ¥Êñ∞Ê∂àÊÅØÂàóË°®
                const messagesContainer = document.getElementById('QQ_message_list_chars');
                if (messagesContainer) {
                    const existingGroup = messagesContainer.querySelector(`[data-group-id="${groupData.id}"]`);
                    if (existingGroup) {
                        const nameElement = existingGroup.querySelector('.QQ_home_name');
                        const avatarElement = existingGroup.querySelector('.QQ_home_head');
                        
                        if (nameElement) {
                            nameElement.textContent = groupData.name;
                        }
                        
                        // Êõ¥Êñ∞Â§¥ÂÉè
                        if (avatarElement && groupData.avatar) {
                            updateAvatarElement(avatarElement, groupData.avatar);
                        }
                    }
                }
            }
            
            /**
             * Êõ¥Êñ∞ÊâÄÊúâÂàóË°®‰∏≠ÁöÑÁæ§ËÅä‰ø°ÊÅØÔºàÂéüÁâàÔºö‰ªÖÂêçÁß∞Ôºâ
             */
            function updateGroupInAllLists(groupData) {
                // Êõ¥Êñ∞ËÅîÁ≥ª‰∫∫ÂàóË°®
                const contactsContainer = document.getElementById('QQ_home_chars');
                if (contactsContainer) {
                    const existingGroup = contactsContainer.querySelector(`[data-group-id="${groupData.id}"]`);
                    if (existingGroup) {
                        const nameElement = existingGroup.querySelector('.QQ_home_name');
                        if (nameElement) {
                            nameElement.textContent = groupData.name;
                        }
                    }
                }
                
                // Êõ¥Êñ∞Ê∂àÊÅØÂàóË°®
                const messagesContainer = document.getElementById('QQ_message_list_chars');
                if (messagesContainer) {
                    const existingGroup = messagesContainer.querySelector(`[data-group-id="${groupData.id}"]`);
                    if (existingGroup) {
                        const nameElement = existingGroup.querySelector('.QQ_home_name');
                        if (nameElement) {
                            nameElement.textContent = groupData.name;
                        }
                    }
                }
            }
            
            /**
             * Áæ§ËÅäËÆæÁΩÆÊõ¥Êñ∞ÂêéËΩªÈáèÁ∫ßÁïåÈù¢Êõ¥Êñ∞Ôºà‰∏çÈáçÊñ∞Âä†ËΩΩÔºåÈÅøÂÖçÊ∂àÊÅØ‰∏¢Â§±Ôºâ
             */
            async function autoReloadInterfaceAfterGroupUpdate(updatedGroupData) {
                console.log('=== ÂºÄÂßãËΩªÈáèÁ∫ßÁïåÈù¢Êõ¥Êñ∞ÔºàÈÅøÂÖçÊ∂àÊÅØ‰∏¢Â§±Ôºâ ===');
                console.log('Êõ¥Êñ∞ÁöÑÁæ§ËÅäÊï∞ÊçÆ:', updatedGroupData);
                
                try {
                    // *** ÈáçË¶ÅÔºö‰∏çÈáçÊñ∞‰ªé‰∏ñÁïå‰π¶Âä†ËΩΩÔºåËÄåÊòØÁõ¥Êé•Êõ¥Êñ∞Áé∞ÊúâÊï∞ÊçÆ ***
                    
                    // 1. Êõ¥Êñ∞ÂÖ®Â±ÄÁæ§ËÅäÊï∞ÊçÆÔºà‰øùÊåÅÊ∂àÊÅØ‰∏çÂèòÔºâ
                    if (window.QQ_Groups && Array.isArray(window.QQ_Groups)) {
                        const groupIndex = window.QQ_Groups.findIndex(g => g.id === updatedGroupData.id);
                        if (groupIndex !== -1) {
                            // Âè™Êõ¥Êñ∞ÂêçÁß∞ÂíåÂ§¥ÂÉèÔºå‰øùÊåÅÂÖ∂‰ªñÊï∞ÊçÆ‰∏çÂèò
                            window.QQ_Groups[groupIndex].name = updatedGroupData.name;
                            window.QQ_Groups[groupIndex].avatar = updatedGroupData.avatar;
                            window.QQ_Groups[groupIndex].avatarUrl = updatedGroupData.avatarUrl;
                            console.log('Â∑≤ËΩªÈáèÊõ¥Êñ∞ÂÖ®Â±ÄÁæ§ËÅäÊï∞ÊçÆ');
                        }
                    }
                    
                    // 2. Â¶ÇÊûúÂΩìÂâçÂú®Áæ§ËÅäÁïåÈù¢ÔºåÂè™Êõ¥Êñ∞Â§¥ÈÉ®ÊòæÁ§∫Ôºå‰∏çÈáçÊñ∞Âä†ËΩΩÊ∂àÊÅØ
                    if (window.currentGroupChat && window.currentGroupChat.id === updatedGroupData.id) {
                        console.log('ËΩªÈáèÊõ¥Êñ∞ÂΩìÂâçÁæ§ËÅäÁïåÈù¢Â§¥ÈÉ®...');
                        
                        // Êõ¥Êñ∞ÂΩìÂâçÁæ§ËÅäÂØπË±°Ôºà‰øùÊåÅÊ∂àÊÅØÊï∞ÊçÆ‰∏çÂèòÔºâ
                        window.currentGroupChat.name = updatedGroupData.name;
                        window.currentGroupChat.avatar = updatedGroupData.avatar;
                        window.currentGroupChat.avatarUrl = updatedGroupData.avatarUrl;
                        
                        // Âè™Êõ¥Êñ∞ËÅäÂ§©Â§¥ÈÉ®Ôºå‰∏çÈáçÊñ∞Âä†ËΩΩÊ∂àÊÅØÂéÜÂè≤
                        updateChatHeader(updatedGroupData);
                        
                        console.log('ËÅäÂ§©ÁïåÈù¢Â§¥ÈÉ®Â∑≤ËΩªÈáèÊõ¥Êñ∞ÔºåÊ∂àÊÅØÂéÜÂè≤‰øùÊåÅ‰∏çÂèò');
                    }
                    
                        // 3. ËΩªÈáèÊõ¥Êñ∞Áæ§ËÅäÂàóË°®ÊòæÁ§∫
    console.log('ËΩªÈáèÊõ¥Êñ∞Áæ§ËÅäÂàóË°®ÊòæÁ§∫...');
    await protectedContactListUpdate(updatedGroupData, 'group_update');
                    
                    console.log('=== ËΩªÈáèÁ∫ßÁïåÈù¢Êõ¥Êñ∞ÂÆåÊàêÔºåÊ∂àÊÅØÊï∞ÊçÆ‰øùÊåÅÂÆåÊï¥ ===');
                    
                } catch (error) {
                    console.error('ËΩªÈáèÁ∫ßÁïåÈù¢Êõ¥Êñ∞Êó∂Âá∫Èîô:', error);
                    // ‰∏çÊòæÁ§∫Ë≠¶ÂëäÊ°ÜÔºåÈÅøÂÖçÊâìÊñ≠Áî®Êà∑Êìç‰Ωú
                    console.warn('ÁïåÈù¢Êõ¥Êñ∞Êó∂Âá∫Áé∞ÈóÆÈ¢òÔºå‰ΩÜÁæ§ËÅäËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºåÊ∂àÊÅØÊï∞ÊçÆÂÆåÊï¥');
                }
            }
            
            /**
             * Âà∑Êñ∞Áæ§ËÅäÊòæÁ§∫Ôºà‰øÆÂ§çÁâàÔºöÈò≤Ê≠¢ÈáçÂ§çÁæ§ËÅäÔºåÊ≠£Á°ÆÂ∫îÁî®Â§¥ÂÉèÔºâ
             */
            async function refreshGroupChatsDisplay() {
                console.log('Âà∑Êñ∞Áæ§ËÅäÊòæÁ§∫Ôºà‰øÆÂ§çÁâàÔºâ...');
                
                try {
                    // ‰∏çË¶ÅÈáçÊñ∞‰ªé‰∏ñÁïå‰π¶Âä†ËΩΩÔºåÁõ¥Êé•‰ΩøÁî®ÂΩìÂâçÁöÑQQ_GroupsÊï∞ÊçÆ
                    // Ê∏ÖÁêÜÂíåÈáçÊñ∞ÊòæÁ§∫Áé∞ÊúâÁöÑÁæ§ËÅäÂÖÉÁ¥†
                    await updateExistingGroupElements();
                    
                    console.log('Áæ§ËÅäÊòæÁ§∫Âà∑Êñ∞ÂÆåÊàê');
                    
                } catch (error) {
                    console.error('Âà∑Êñ∞Áæ§ËÅäÊòæÁ§∫Êó∂Âá∫Èîô:', error);
                    alert('ÁïåÈù¢Êõ¥Êñ∞Êó∂Âá∫Áé∞ÈóÆÈ¢òÔºåÂª∫ËÆÆÊâãÂä®Âà∑Êñ∞È°µÈù¢„ÄÇ');
                }
            }
            
            /**
             * Êõ¥Êñ∞Áé∞ÊúâÁæ§ËÅäÂÖÉÁ¥†ËÄå‰∏çÈáçÊñ∞ÂàõÂª∫
             */
            async function updateExistingGroupElements() {
                console.log('Êõ¥Êñ∞Áé∞ÊúâÁæ§ËÅäÂÖÉÁ¥†...');
                
                try {
                    // *** ÂÖ≥ÈîÆ‰øÆÂ§çÔºö‰ΩøÁî®ÂΩìÂâçÂÜÖÂ≠ò‰∏≠ÁöÑQQ_GroupsÊï∞ÊçÆÔºå‰∏çÈáçÊñ∞Âä†ËΩΩ ***
                    const latestGroups = window.QQ_Groups || [];
                    console.log('updateExistingGroupElements: ‰ΩøÁî®ÁöÑÁæ§ËÅäÊï∞ÊçÆ:', latestGroups.length, '‰∏™Áæ§ËÅä');
                    console.log('‰ΩøÁî®ÂΩìÂâçÂÜÖÂ≠ò‰∏≠ÁöÑÁæ§ËÅäÊï∞ÊçÆ:', latestGroups.length, '‰∏™');
                    
                    if (latestGroups.length === 0) {
                        console.warn('ÂÜÖÂ≠ò‰∏≠Ê≤°ÊúâÁæ§ËÅäÊï∞ÊçÆÔºåË∑≥ËøáÊõ¥Êñ∞');
                        return;
                    }
                    
                    const contactsContainer = document.getElementById('QQ_home_chars');
                    const messagesContainer = document.getElementById('QQ_message_list_chars');
                    
                    // Êõ¥Êñ∞ËÅîÁ≥ª‰∫∫ÂàóË°®‰∏≠ÁöÑÁæ§ËÅä
                    if (contactsContainer && latestGroups) {
                        for (const groupData of latestGroups) {
                            if (groupData && groupData.name) {
                                const existingElement = contactsContainer.querySelector(`[data-group-id="${groupData.id}"]`);
                                if (existingElement) {
                                    console.log('Êõ¥Êñ∞Áé∞ÊúâÁæ§ËÅäÂÖÉÁ¥†:', groupData.name);
                                    updateGroupElement(existingElement, groupData);
                                } else {
                                    console.log('Áæ§ËÅäÂÖÉÁ¥†‰∏çÂ≠òÂú®Ôºå‰øùÊåÅÁé∞Áä∂:', groupData.name);
                                }
                            }
                        }
                    }
                    
                    // Êõ¥Êñ∞Ê∂àÊÅØÂàóË°®‰∏≠ÁöÑÁæ§ËÅä
                    if (messagesContainer && latestGroups) {
                        console.log('=== ÂºÄÂßãÊõ¥Êñ∞Ê∂àÊÅØÂàóË°®‰∏≠ÁöÑÁæ§ËÅä ===');
                        console.log('Ê∂àÊÅØÂÆπÂô®Â≠òÂú®:', !!messagesContainer);
                        console.log('Áæ§ËÅäÊï∞ÊçÆ:', latestGroups.map(g => ({ name: g.name, id: g.id })));
                        
                        // ÂÖàÊ£ÄÊü•Ê∂àÊÅØÂàóË°®‰∏≠Áé∞ÊúâÁöÑÁæ§ËÅäÂÖÉÁ¥†
                        const existingElements = messagesContainer.querySelectorAll('[data-group-id]');
                        console.log('Ê∂àÊÅØÂàóË°®‰∏≠Áé∞ÊúâÁöÑÁæ§ËÅäÂÖÉÁ¥†:', Array.from(existingElements).map(el => ({
                            name: el.querySelector('.QQ_home_name')?.textContent,
                            dataGroupId: el.getAttribute('data-group-id')
                        })));
                        
                        for (const groupData of latestGroups) {
                            if (groupData && groupData.name) {
                                console.log(`\n--- Â§ÑÁêÜÁæ§ËÅä: ${groupData.name} (ID: ${groupData.id}) ---`);
                                
                                const existingElement = messagesContainer.querySelector(`[data-group-id="${groupData.id}"]`);
                                console.log('Ê†πÊçÆdata-group-idÊü•ÊâæÂà∞ÁöÑÂÖÉÁ¥†:', !!existingElement);
                                
                                if (!existingElement) {
                                    // Â∞ùËØïÁî®ÂÖ∂‰ªñÊñπÂºèÊü•ÊâæÔºåÊØîÂ¶ÇÂêçÁß∞ÂåπÈÖç
                                    const nameElements = messagesContainer.querySelectorAll('.QQ_home_name');
                                    let foundByName = null;
                                    for (const nameEl of nameElements) {
                                        if (nameEl.textContent.trim() === groupData.name) {
                                            foundByName = nameEl.closest('[data-group-id]');
                                            break;
                                        }
                                    }
                                    
                                    if (foundByName) {
                                        console.log('ÈÄöËøáÂêçÁß∞ÂåπÈÖçÊâæÂà∞Áæ§ËÅäÂÖÉÁ¥†ÔºåÊõ¥Êñ∞data-group-id');
                                        foundByName.setAttribute('data-group-id', groupData.id);
                                        updateGroupElement(foundByName, groupData);
                                    } else {
                                        console.warn(`‚ùå Áæ§ËÅä "${groupData.name}" Âú®Ê∂àÊÅØÂàóË°®‰∏≠ÂÆåÂÖ®Êâæ‰∏çÂà∞ÔºåÂèØËÉΩÂ∑≤Ë¢´Âà†Èô§ÊàñÈöêËóè`);
                                        
                                                                // ÁâπÊÆäÊ£ÄÊü•'Ê∏ØÂå∫'Áæ§ËÅä
                        if (groupData.name === 'Ê∏ØÂå∫') {
                            console.error('üö® ÁâπÂà´ÂÖ≥Ê≥®ÔºöÊ∏ØÂå∫Áæ§ËÅäÂú®Ê∂àÊÅØÂàóË°®‰∏≠Êâæ‰∏çÂà∞ÔºÅ');
                            console.log('Ê∏ØÂå∫Áæ§ËÅäÂÆåÊï¥Êï∞ÊçÆ:', JSON.stringify(groupData, null, 2));
                            console.log('ÊâÄÊúâÁé∞ÊúâÂÖÉÁ¥†ÁöÑËØ¶ÁªÜ‰ø°ÊÅØ:');
                            existingElements.forEach(el => {
                                console.log('ÂÖÉÁ¥†:', {
                                    innerHTML: el.innerHTML.substring(0, 200),
                                    dataGroupId: el.getAttribute('data-group-id'),
                                    nameText: el.querySelector('.QQ_home_name')?.textContent
                                });
                            });
                            
                            // *** Ê∏ØÂå∫Áæ§ËÅäÁ¥ßÊÄ•ÊÅ¢Â§çÊú∫Âà∂ ***
                            console.log('ÂêØÂä®Ê∏ØÂå∫Áæ§ËÅäÁ¥ßÊÄ•ÊÅ¢Â§çÊú∫Âà∂...');
                            const messagesContainer = document.querySelector('#QQ_messages_list');
                            if (messagesContainer) {
                                // Ê£ÄÊü•ÊòØÂê¶ÊúâÊ∏ØÂå∫Áæ§ËÅäÁöÑÊÆãÁïôÂÖÉÁ¥†ÔºàÊ≤°ÊúâÊ≠£Á°ÆÁöÑdata-group-idÔºâ
                                const allGroupElements = messagesContainer.querySelectorAll('.QQ_home_lxr');
                                console.log('ÊâæÂà∞ÁöÑÊâÄÊúâÁæ§ËÅäÂÖÉÁ¥†:', allGroupElements.length);
                                
                                for (const element of allGroupElements) {
                                    const nameEl = element.querySelector('.QQ_home_name');
                                    if (nameEl && nameEl.textContent.trim() === 'Ê∏ØÂå∫') {
                                        console.log('üîß ÊâæÂà∞Ê∏ØÂå∫Áæ§ËÅäÂÖÉÁ¥†Ôºå‰øÆÂ§çÂÖ∂data-group-id');
                                        element.setAttribute('data-group-id', groupData.id || 'group_gangqu');
                                        updateGroupElement(element, groupData);
                                        console.log('‚úÖ Ê∏ØÂå∫Áæ§ËÅäÂ∑≤‰øÆÂ§ç');
                                        return; // ‰øÆÂ§çÂÆåÊàêÔºåÈÄÄÂá∫
                                    }
                                }
                                
                                // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ÔºåÂ∞ùËØïÈáçÊñ∞Ê∑ªÂä†Ê∏ØÂå∫Áæ§ËÅä
                                console.log('üÜò Ê∏ØÂå∫Áæ§ËÅäÂÆåÂÖ®‰∏¢Â§±ÔºåÂ∞ùËØïÈáçÊñ∞ÂàõÂª∫...');
                                const groupElement = createGroupElementForDisplay({
                                    ...groupData,
                                    id: groupData.id || 'group_gangqu',
                                    name: 'Ê∏ØÂå∫'
                                });
                                
                                if (groupElement) {
                                    messagesContainer.insertBefore(groupElement, messagesContainer.firstChild);
                                    console.log('‚úÖ Ê∏ØÂå∫Áæ§ËÅäÂ∑≤ÈáçÊñ∞ÂàõÂª∫Âπ∂Ê∑ªÂä†Âà∞ÂàóË°®È°∂ÈÉ®');
                                }
                            }
                        }
                                    }
                                } else {
                                    console.log('‚úÖ ÊâæÂà∞Áæ§ËÅäÂÖÉÁ¥†ÔºåÊ≠£Âú®Êõ¥Êñ∞:', groupData.name);
                                    updateGroupElement(existingElement, groupData);
                                }
                            }
                        }
                        
                        console.log('=== Ê∂àÊÅØÂàóË°®Áæ§ËÅäÊõ¥Êñ∞ÂÆåÊàê ===');
                    }
                } catch (error) {
                    console.error('Êõ¥Êñ∞Áé∞ÊúâÁæ§ËÅäÂÖÉÁ¥†Êó∂Âá∫Èîô:', error);
                }
            }
            
            /**
             * Êõ¥Êñ∞Áæ§ËÅäÂÖÉÁ¥†ÁöÑÂêçÁß∞ÂíåÂ§¥ÂÉèÔºàÂ¢ûÂº∫ÁâàÔºöÈò≤Ê≠¢Â§¥ÂÉè‰∏¢Â§±Ôºâ
             */
            function updateGroupElement(element, groupData) {
                try {
                    console.log('=== updateGroupElement ÂºÄÂßã ===');
                    console.log('Áæ§ËÅäÊï∞ÊçÆ:', {
                        name: groupData.name,
                        id: groupData.id,
                        avatar: groupData.avatar,
                        avatarUrl: groupData.avatarUrl
                    });
                    
                    // Êõ¥Êñ∞Áæ§ËÅäÂêçÁß∞
                    const nameElement = element.querySelector('.QQ_home_name');
                    if (nameElement) {
                        nameElement.textContent = groupData.name;
                    }
                    
                    // *** ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÊõ¥Âº∫ÁöÑÂ§¥ÂÉèÊï∞ÊçÆÊ£ÄÊü•Âíå‰øùÊä§ ***
                    const avatarElement = element.querySelector('.QQ_home_head');
                    if (avatarElement) {
                        console.log('ÊâæÂà∞Â§¥ÂÉèÂÖÉÁ¥†ÔºåÊ£ÄÊü•Â§¥ÂÉèÊï∞ÊçÆ...');
                        
                        // ‰ºòÂÖàÁ∫ß1ÔºöÊ£ÄÊü•ÂÆåÊï¥ÁöÑavatarÂØπË±°
                        if (groupData.avatar && typeof groupData.avatar === 'object' && groupData.avatar.type) {
                            console.log('ÂèëÁé∞ÂÆåÊï¥ÁöÑÂ§¥ÂÉèÂØπË±°ÔºåÂ∫îÁî®Â§¥ÂÉè:', groupData.avatar);
                            updateAvatarElement(avatarElement, groupData.avatar);
                        }
                        // ‰ºòÂÖàÁ∫ß2ÔºöÊ£ÄÊü•avatarUrlÂ≠óÁ¨¶‰∏≤
                        else if (groupData.avatarUrl && typeof groupData.avatarUrl === 'string') {
                            console.log('ÂèëÁé∞avatarUrlÔºåÂ∫îÁî®Â≠óÁ¨¶‰∏≤Â§¥ÂÉè:', groupData.avatarUrl);
                            updateAvatarElement(avatarElement, groupData.avatarUrl);
                        }
                        // ‰ºòÂÖàÁ∫ß3ÔºöÊ£ÄÊü•avatarÂ≠óÁ¨¶‰∏≤
                        else if (groupData.avatar && typeof groupData.avatar === 'string') {
                            console.log('ÂèëÁé∞avatarÂ≠óÁ¨¶‰∏≤ÔºåÂ∫îÁî®Â§¥ÂÉè:', groupData.avatar);
                            updateAvatarElement(avatarElement, groupData.avatar);
                        }
                        // ‰ºòÂÖàÁ∫ß4Ôºö‰ªéÂÜÖÂ≠ò‰∏≠ÁöÑQQ_GroupsÊü•ÊâæÂÆåÊï¥Êï∞ÊçÆ
                        else if (window.QQ_Groups && groupData.id) {
                            console.log('Â§¥ÂÉèÊï∞ÊçÆ‰∏çÂÆåÊï¥Ôºå‰ªéQQ_Groups‰∏≠Êü•Êâæ...');
                            const fullGroupData = window.QQ_Groups.find(g => g.id === groupData.id || g.name === groupData.name);
                            if (fullGroupData && fullGroupData.avatar) {
                                console.log('‰ªéQQ_Groups‰∏≠ÊâæÂà∞ÂÆåÊï¥Â§¥ÂÉèÊï∞ÊçÆ:', fullGroupData.avatar);
                                updateAvatarElement(avatarElement, fullGroupData.avatar);
                            } else {
                                console.warn('‰ªéQQ_Groups‰∏≠‰πüÊú™ÊâæÂà∞Â§¥ÂÉèÊï∞ÊçÆÔºå‰øùÊåÅÁé∞ÊúâÂ§¥ÂÉè');
                                // ‰∏çÂ∫îÁî®ÈªòËÆ§Â§¥ÂÉèÔºå‰øùÊåÅÁé∞ÊúâÂ§¥ÂÉè‰∏çÂèò
                            }
                        }
                                                 else {
                             console.warn('Ê≤°ÊúâÊúâÊïàÁöÑÂ§¥ÂÉèÊï∞ÊçÆÔºå‰øùÊåÅÁé∞ÊúâÂ§¥ÂÉè');
                             // ‰∏çÂ∫îÁî®ÈªòËÆ§Â§¥ÂÉèÔºå‰øùÊåÅÁé∞ÊúâÂ§¥ÂÉè‰∏çÂèò
                         }
                     } else {
                         console.warn('Êú™ÊâæÂà∞Â§¥ÂÉèÂÖÉÁ¥†');
                     }
                    
                    console.log('Áæ§ËÅäÂÖÉÁ¥†Êõ¥Êñ∞ÂÆåÊàê:', groupData.name);
                } catch (error) {
                    console.error('Êõ¥Êñ∞Áæ§ËÅäÂÖÉÁ¥†Êó∂Âá∫Èîô:', error);
                }
            }
            
            /**
             * Ê∑ªÂä†Á≥ªÁªüÊ∂àÊÅØÂà∞Áæ§ËÅäÔºàÁÅ∞Ëâ≤Â∞èÂ≠óÔºâ
             */
            async function addSystemMessageToGroup(groupId, systemMessage) {
                console.log('Ê∑ªÂä†Á≥ªÁªüÊ∂àÊÅØÂà∞Áæ§ËÅä:', { groupId, systemMessage });
                
                try {
                    // Á°Æ‰øùÁæ§ËÅäÊ∂àÊÅØÊï∞ÁªÑÂ≠òÂú®
                    if (!window.groupChatMessages) {
                        window.groupChatMessages = {};
                    }
                    if (!window.groupChatMessages[groupId]) {
                        window.groupChatMessages[groupId] = [];
                    }
                    
                    // ÂàõÂª∫Á≥ªÁªüÊ∂àÊÅØÂØπË±°
                    const systemMessageObj = {
                        id: 'system_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        type: 'system',
                        content: systemMessage,
                        timestamp: new Date().toISOString(),
                        sender: 'system'
                    };
                    
                    // Ê∑ªÂä†Âà∞Áæ§ËÅäÊ∂àÊÅØÊï∞ÁªÑ
                    window.groupChatMessages[groupId].push(systemMessageObj);
                    
                    // Â¶ÇÊûúÂΩìÂâçÊ≠£Âú®Êü•ÁúãËøô‰∏™Áæ§ËÅäÔºåÁ´ãÂç≥ÊòæÁ§∫Á≥ªÁªüÊ∂àÊÅØ
                    if (window.currentGroupChat && window.currentGroupChat.id === groupId) {
                        displaySystemMessage(systemMessage, groupId);
                    }
                    
                    console.log('Á≥ªÁªüÊ∂àÊÅØÂ∑≤Ê∑ªÂä†Âà∞Áæ§ËÅä');
                    
                } catch (error) {
                    console.error('Ê∑ªÂä†Á≥ªÁªüÊ∂àÊÅØÊó∂Âá∫Èîô:', error);
                }
            }
            
            /**
             * Âú®ËÅäÂ§©ÁïåÈù¢ÊòæÁ§∫Á≥ªÁªüÊ∂àÊÅØÔºàÁÅ∞Ëâ≤Â∞èÂ≠óÔºâ- ‰øÆÂ§çÁâà
             */
            function displaySystemMessage(message, targetGroupId = null) {
                try {
                    console.log('=== Â∞ùËØïÊòæÁ§∫Á≥ªÁªüÊ∂àÊÅØ ===');
                    console.log('Ê∂àÊÅØÂÜÖÂÆπ:', message);
                    console.log('ÁõÆÊ†áÁæ§ËÅäID:', targetGroupId);
                    console.log('ÂΩìÂâçÁæ§ËÅä:', window.currentGroupChat);
                    
                    let msgContent = null;
                    
                    // *** ‰øÆÂ§çÔºöÊõ¥ÂáÜÁ°ÆÁöÑÊ∂àÊÅØÂÆπÂô®Êü•ÊâæÁ≠ñÁï• ***
                    const containerSelectors = [
                        '.QQ_chat_page[style*="display:block"] .msgcontent',
                        '.QQ_chat_page:not([style*="display:none"]) .msgcontent',
                        '.msgcontent:not([style*="display:none"])',
                        '.msgcontent',
                        '#QQ_chat_msgs'
                    ];
                    
                    // Êåâ‰ºòÂÖàÁ∫ßÊü•ÊâæÂèØËßÅÁöÑÊ∂àÊÅØÂÆπÂô®
                    for (const selector of containerSelectors) {
                        const elements = document.querySelectorAll(selector);
                        for (const element of elements) {
                            if (element && element.offsetParent !== null && 
                                element.offsetWidth > 0 && element.offsetHeight > 0) {
                                msgContent = element;
                                console.log('‚úÖ ÊâæÂà∞ÂèØËßÅÁöÑÊ∂àÊÅØÂÆπÂô®Ôºå‰ΩøÁî®ÈÄâÊã©Âô®:', selector);
                                break;
                            }
                        }
                        if (msgContent) break;
                    }
                    
                    // *** ‰øÆÂ§çÔºöÂ¶ÇÊûúËøòÊòØÊ≤°ÊâæÂà∞ÔºåÂº∫Âà∂Êü•ÊâæÂΩìÂâçÊ¥ªË∑ÉÁöÑËÅäÂ§©È°µÈù¢ ***
                    if (!msgContent) {
                        console.log('Â∞ùËØïÂú®ÂΩìÂâçÊ¥ªË∑ÉÁöÑËÅäÂ§©È°µÈù¢‰∏≠Êü•ÊâæÊ∂àÊÅØÂÆπÂô®...');
                        
                        // Êü•ÊâæÂΩìÂâçÊòæÁ§∫ÁöÑËÅäÂ§©È°µÈù¢
                        const activeChatPage = document.querySelector('.QQ_chat_page[style*="display:block"]') ||
                                              document.querySelector('.QQ_chat_page:not([style*="display:none"])');
                        
                        if (activeChatPage) {
                            console.log('ÊâæÂà∞Ê¥ªË∑ÉÁöÑËÅäÂ§©È°µÈù¢ÔºåÂàõÂª∫‰∏¥Êó∂Ê∂àÊÅØÂÆπÂô®');
                            
                            // Âú®Ê¥ªË∑ÉËÅäÂ§©È°µÈù¢‰∏≠ÂàõÂª∫ÊàñÊü•ÊâæÊ∂àÊÅØÂÆπÂô®
                            msgContent = activeChatPage.querySelector('.msgcontent');
                            if (!msgContent) {
                                msgContent = document.createElement('div');
                                msgContent.className = 'msgcontent';
                                msgContent.style.cssText = `
                                    flex: 1;
                                    overflow-y: auto;
                                    box-sizing: border-box;
                                    margin-bottom: 50px;
                                    padding-left: 8px;
                                    padding-right: 8px;
                                    scrollbar-width: none;
                                    -ms-overflow-style: none;
                                    height: calc(100% - 120px);
                                    position: relative;
                                `;
                                activeChatPage.appendChild(msgContent);
                            }
                        }
                    }
                    
                    if (!msgContent) {
                        console.error('Êó†Ê≥ïÊâæÂà∞‰ªª‰ΩïÊ∂àÊÅØÂÆπÂô®Êù•ÊòæÁ§∫Á≥ªÁªüÊ∂àÊÅØ');
                        // ‰Ωú‰∏∫ÊúÄÂêéÁöÑÂÖúÂ∫ïÊñπÊ°àÔºåÁõ¥Êé•Âú®È°µÈù¢‰∏≠ÊòæÁ§∫
                        const fallbackMsg = document.createElement('div');
                        fallbackMsg.style.cssText = `
                            position: fixed;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            background: rgba(0,0,0,0.8);
                            color: white;
                            padding: 10px 20px;
                            border-radius: 5px;
                            z-index: 999999;
                            font-size: 14px;
                        `;
                        fallbackMsg.textContent = message;
                        document.body.appendChild(fallbackMsg);
                        setTimeout(() => fallbackMsg.remove(), 3000);
                        return;
                    }
                    
                    console.log('ÂáÜÂ§áÊ∑ªÂä†Á≥ªÁªüÊ∂àÊÅØÂà∞ÂÆπÂô®:', msgContent.tagName, msgContent.className || msgContent.id);
                    
                    // *** ‰øÆÂ§çÔºöÂàõÂª∫Êõ¥ÂèØÈù†ÁöÑÁ≥ªÁªüÊ∂àÊÅØÂÖÉÁ¥† ***
                    const systemMsgDiv = document.createElement('div');
                    systemMsgDiv.className = 'system-message-chat';
                    systemMsgDiv.setAttribute('data-message-type', 'system');
                    systemMsgDiv.setAttribute('data-timestamp', Date.now());
                    
                    // *** ‰øÆÂ§çÔºö‰ΩøÁî®Êõ¥Âº∫Âà∂ÁöÑÊ†∑ÂºèÔºåÁ°Æ‰øùÊòæÁ§∫ ***
                    systemMsgDiv.style.cssText = `
                        text-align: center !important;
                        color: #999999 !important;
                        font-size: 12px !important;
                        margin: 10px auto !important;
                        padding: 5px 10px !important;
                        line-height: 1.4 !important;
                        background: transparent !important;
                        border: none !important;
                        max-width: 90% !important;
                        position: relative !important;
                        z-index: 10 !important;
                        word-wrap: break-word !important;
                        white-space: normal !important;
                        display: block !important;
                        clear: both !important;
                        font-weight: normal !important;
                        opacity: 1 !important;
                        visibility: visible !important;
                        box-sizing: border-box !important;
                        width: auto !important;
                        min-height: 20px !important;
                        font-family: inherit !important;
                    `;
                    systemMsgDiv.textContent = message;
                    
                    console.log('*** Á≥ªÁªüÊ∂àÊÅØÂÖÉÁ¥†Â∑≤ÂàõÂª∫ ***:', {
                        message: message,
                        element: systemMsgDiv,
                        parent: msgContent.tagName,
                        parentVisible: msgContent.offsetParent !== null
                    });
                    
                    // *** ‰øÆÂ§çÔºöÁ´ãÂç≥Ê∑ªÂä†Âπ∂Âº∫Âà∂ÊòæÁ§∫ ***
                    msgContent.appendChild(systemMsgDiv);
                    
                    // Âº∫Âà∂Âà∑Êñ∞Â∏ÉÂ±Ä
                    systemMsgDiv.offsetHeight;
                    
                    // Á´ãÂç≥ÊªöÂä®Âà∞Â∫ïÈÉ®
                    setTimeout(() => {
                        msgContent.scrollTop = msgContent.scrollHeight;
                        console.log('Á≥ªÁªüÊ∂àÊÅØÂ∑≤ÊòæÁ§∫ÔºåÂÆπÂô®È´òÂ∫¶:', msgContent.scrollHeight);
                    }, 50);
                    
                    // *** ‰øÆÂ§çÔºöÊ∑ªÂä†È™åËØÅÊ£ÄÊü• ***
                    setTimeout(() => {
                        if (document.contains(systemMsgDiv)) {
                            const computedStyle = window.getComputedStyle(systemMsgDiv);
                            console.log('‚úÖ Á≥ªÁªüÊ∂àÊÅØÊòæÁ§∫ÊàêÂäü:', {
                                inDOM: true,
                                visible: systemMsgDiv.offsetParent !== null,
                                display: computedStyle.display,
                                visibility: computedStyle.visibility,
                                opacity: computedStyle.opacity,
                                height: systemMsgDiv.offsetHeight
                            });
                        } else {
                            console.error('‚ùå Á≥ªÁªüÊ∂àÊÅØÊú™ËÉΩÊ∑ªÂä†Âà∞DOM‰∏≠');
                        }
                    }, 200);
                    
                } catch (error) {
                    console.error('ÊòæÁ§∫Á≥ªÁªüÊ∂àÊÅØÊó∂Âá∫Èîô:', error);
                    console.error('ÈîôËØØËØ¶ÊÉÖ:', error.stack);
                }
            }
            

            
            /**
             * ‰∏∫Áæ§ËÅäÂèòÊõ¥Ê∑ªÂä†Á≥ªÁªüÊ∂àÊÅØ
             */
            async function addSystemMessagesForChanges(groupId, changes) {
                if (!changes || changes.length === 0) {
                    return;
                }
                
                console.log('‰∏∫Áæ§ËÅäÂèòÊõ¥Ê∑ªÂä†Á≥ªÁªüÊ∂àÊÅØ:', { groupId, changes });
                
                for (const change of changes) {
                    let systemMessage = '';
                    
                    switch (change.type) {
                        case 'name':
                            systemMessage = `Áæ§ËÅäÂêçÁß∞Â∑≤Êõ¥Êîπ‰∏∫"${change.newValue}"`;
                            break;
                        case 'avatar':
                            systemMessage = `Áæ§‰∏ªÂ∑≤Êõ¥ÊîπÁæ§Â§¥ÂÉè`;
                            break;
                        case 'add_member':
                            systemMessage = `${change.operator}ÈÇÄËØ∑${change.newValue}Âä†ÂÖ•Áæ§ËÅä`;
                            break;
                        case 'remove_member':
                            systemMessage = `${change.operator}Â∞Ü${change.oldValue}ÁßªÂá∫Áæ§ËÅä`;
                            break;
                        default:
                            systemMessage = `Áæ§ËÅäËÆæÁΩÆÂ∑≤Êõ¥Êñ∞`;
                            break;
                    }
                    
                    if (systemMessage) {
                        await addSystemMessageToGroup(groupId, systemMessage);
                    }
                }
            }
            
            /**
             * Êõ¥Êñ∞Áæ§ËÅäÊ∂àÊÅØJSON‰∏≠ÁöÑÁæ§ËÅä‰ø°ÊÅØÔºà‰øùÊåÅËÅäÂ§©ËÆ∞ÂΩïÔºâ
             */
            async function updateGroupChatMessagesInMsgjson(groupId, oldName, newName) {
                console.log('Êõ¥Êñ∞Ê∂àÊÅØJSON‰∏≠ÁöÑÁæ§ËÅä‰ø°ÊÅØ:', { groupId, oldName, newName });
                
                try {
                    // Êõ¥Êñ∞Áæ§ËÅäÊ∂àÊÅØËÆ∞ÂΩï‰∏≠ÁöÑÁæ§ËÅäÂêçÁß∞
                    if (window.groupChatMessages && window.groupChatMessages[groupId]) {
                        const messages = window.groupChatMessages[groupId];
                        console.log(`Áæ§ËÅä ${groupId} Êúâ ${messages.length} Êù°Ê∂àÊÅØÈúÄË¶ÅÊõ¥Êñ∞`);
                        
                        // ËøôÈáåÂèØ‰ª•Êõ¥Êñ∞Ê∂àÊÅØ‰∏≠ÁöÑÁæ§ËÅäÁõ∏ÂÖ≥‰ø°ÊÅØÔºå‰ΩÜ‰øùÊåÅÊ∂àÊÅØÂÜÖÂÆπ‰∏çÂèò
                        // ÁõÆÂâç‰∏ªË¶ÅÊòØÁ°Æ‰øùgroupIdÂíåÊ∂àÊÅØËÆ∞ÂΩïÁöÑÂÖ≥ËÅî‰øùÊåÅÊ≠£Á°Æ
                    }
                    
                    // Êõ¥Êñ∞msgjson‰∏≠ÁöÑÁæ§ËÅäÁõ∏ÂÖ≥‰ø°ÊÅØ
                    if (window.msgjson && window.msgjson.data) {
                        // ÈÅçÂéÜÊâÄÊúâÁî®Êà∑ÁöÑÊ∂àÊÅØÔºåÊõ¥Êñ∞Ê∂âÂèäËØ•Áæ§ËÅäÁöÑÊ∂àÊÅØ
                        Object.keys(window.msgjson.data).forEach(userId => {
                            const userMessages = window.msgjson.data[userId];
                            if (Array.isArray(userMessages)) {
                                userMessages.forEach(message => {
                                    // Â¶ÇÊûúÊ∂àÊÅØ‰∏≠ÊèêÂà∞‰∫ÜÊóßÁöÑÁæ§ËÅäÂêçÁß∞ÔºåÂèØ‰ª•ÈÄâÊã©ÊÄßÊõ¥Êñ∞
                                    // ‰ΩÜË¶Å‰øùÊåÅÊ∂àÊÅØÂÜÖÂÆπÁöÑÂÆåÊï¥ÊÄß
                                    if (message.mes && typeof message.mes === 'string' && message.mes.includes(oldName)) {
                                        console.log(`Âú®Áî®Êà∑ ${userId} ÁöÑÊ∂àÊÅØ‰∏≠ÂèëÁé∞Áæ§ËÅäÂºïÁî®Ôºå‰øùÊåÅ‰∏çÂèò`);
                                        // ËøôÈáåÂèØ‰ª•ÈÄâÊã©ÊòØÂê¶Êõ¥Êñ∞Ê∂àÊÅØ‰∏≠ÁöÑÁæ§ËÅäÂêçÁß∞ÂºïÁî®
                                        // ‰∏∫‰∫ÜÂÆâÂÖ®Ëµ∑ËßÅÔºåÊöÇÊó∂‰øùÊåÅÊ∂àÊÅØÂÜÖÂÆπ‰∏çÂèò
                                    }
                                });
                            }
                        });
                    }
                    
                    console.log('Áæ§ËÅäÊ∂àÊÅØ‰ø°ÊÅØÊõ¥Êñ∞ÂÆåÊàê');
                } catch (error) {
                    console.error('Êõ¥Êñ∞Áæ§ËÅäÊ∂àÊÅØ‰ø°ÊÅØÊó∂Âá∫Èîô:', error);
                }
            }
            
            /**
             * ÈáçÊñ∞Â∫îÁî®Áæ§ËÅäËÉåÊôØÔºà‰ΩøÁî®ÂéüÊúâÁöÑgetRandomChatBackgroundÈÄªËæëÔºâ
             */
            function reapplyGroupChatBackground(groupData) {
                console.log('*** ÈáçÊñ∞Â∫îÁî®Áæ§ËÅäËÉåÊôØ ***');
                console.log('Áæ§ËÅäÊï∞ÊçÆ:', groupData);
                
                try {
                    if (!groupData || !groupData.name) {
                        console.warn('Áæ§ËÅäÊï∞ÊçÆÊó†ÊïàÔºåË∑≥ËøáËÉåÊôØÂ∫îÁî®');
                        return;
                    }
                    
                    // Ëé∑ÂèñÈöèÊú∫ËÅäÂ§©ËÉåÊôØÔºà‰ΩøÁî®ÂéüÊúâÈÄªËæëÔºâ
                    const randomBackground = getRandomChatBackground();
                    console.log('Ëé∑ÂèñÂà∞ÁöÑÈöèÊú∫ËÉåÊôØ:', randomBackground);
                    
                    if (!randomBackground) {
                        console.warn('Êú™Ëé∑ÂèñÂà∞ÊúâÊïàËÉåÊôØÔºåË∑≥ËøáÂ∫îÁî®');
                        return;
                    }
                    
                    // Êü•ÊâæÊàñÂàõÂª∫Áæ§ËÅäÁöÑCSSÊ†∑ÂºèÔºàÊ®°‰ªøAddNewGroupÁöÑÈÄªËæëÔºâ
                    const groupName = groupData.name;
                    
                    // ÁßªÈô§ÊóßÁöÑËÉåÊôØÊ†∑ÂºèÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
                    $(`style[data-group-bg="${groupName}"]`).remove();
                    
                    // ÂàõÂª∫Êñ∞ÁöÑËÉåÊôØCSSÊ†∑ÂºèÔºàÂåÖÂê´ÂÆåÊï¥ÁöÑËÉåÊôØÂ±ûÊÄßÔºâ
                    const backgroundCSS = `
.QQ_chat_page[data-name='${groupName}'] {
    --BackGroundImg: url('${randomBackground}');
    background-image: var(--BackGroundImg) !important;
    background-size: cover !important;
    background-position: center !important;
    background-repeat: no-repeat !important;
    background-color: transparent !important;
}`;
                    
                    // ÂàõÂª∫Êñ∞ÁöÑstyleÂÖÉÁ¥†Âπ∂Ê∑ªÂä†Âà∞È°µÈù¢
                    const style = $("<style></style>").prop("type", "text/css");
                    style.attr('data-group-bg', groupName);
                    style.text(backgroundCSS);
                    $("head").append(style);
                    
                    console.log(`Áæ§ËÅä ${groupName} ÁöÑËÉåÊôØCSSÂ∑≤ÈáçÊñ∞Â∫îÁî®:`, randomBackground);
                    
                    // Âª∂ËøüÈ™åËØÅËÉåÊôØÊòØÂê¶Ê≠£Á°ÆÂ∫îÁî®ÔºàÊõ¥ÂÆΩÊùæÁöÑÈ™åËØÅÔºâ
                    setTimeout(() => {
                        const chatPage = document.querySelector(`.QQ_chat_page[data-name="${groupName}"]`);
                        if (chatPage) {
                            const finalBg = window.getComputedStyle(chatPage).backgroundImage;
                            console.log('ËÉåÊôØÂ∫îÁî®È™åËØÅ - ÊúÄÁªàËÉåÊôØ:', finalBg);
                            
                            // Êõ¥ÂÆΩÊùæÁöÑÈ™åËØÅÔºöÂè™Ë¶Å‰∏çÊòØ'none'Â∞±ËÆ§‰∏∫ÊàêÂäü
                            if (finalBg === 'none') {
                                console.warn('ËÉåÊôØÂ∫îÁî®Â§±Ë¥•ÔºöÊúÄÁªàËÉåÊôØ‰∏∫none');
                            } else if (finalBg.includes('url(')) {
                                console.log('*** Áæ§ËÅäËÉåÊôØÈáçÊñ∞Â∫îÁî®ÊàêÂäü ***');
                                console.log('È™åËØÅÈÄöËøáÔºöÊ£ÄÊµãÂà∞ËÉåÊôØÂõæÁâáURL');
                            } else {
                                // Âç≥‰ΩøURL‰∏çÂÆåÂÖ®ÂåπÈÖçÔºåÂè™Ë¶ÅÊúâËÉåÊôØÂ∞±ÁÆóÊàêÂäü
                                console.log('*** Áæ§ËÅäËÉåÊôØÈáçÊñ∞Â∫îÁî®ÊàêÂäü ***'); 
                                console.log('È™åËØÅÈÄöËøáÔºöÊ£ÄÊµãÂà∞ËÉåÊôØÊ†∑ÂºèÔºàÂèØËÉΩ‰∏∫CSSÂèòÈáèÂ±ïÂºÄÂêéÁöÑÂÄºÔºâ');
                            }
                        }
                    }, 200);
                    
                } catch (error) {
                    console.error('ÈáçÊñ∞Â∫îÁî®Áæ§ËÅäËÉåÊôØÊó∂Âá∫Èîô:', error);
                }
            }
            
            /**
             * Áæ§ËÅäÊîπÂêçÊó∂ÁöÑÂÆåÊï¥Êï∞ÊçÆËøÅÁßªÔºà‰øÆÂ§çÁªëÂÆöÂÖ≥Á≥ªÔºâ
             */
            async function migrateGroupDataBindings(oldName, newName, groupData) {
                console.log('*** ÂºÄÂßãÁæ§ËÅäÊîπÂêçÊï∞ÊçÆËøÅÁßª ***');
                console.log(`ËøÅÁßª: "${oldName}" -> "${newName}"`);
                
                try {
                    let migratedCount = 0;
                    
                    // *** 1. ËøÅÁßªÂ£ÅÁ∫∏ÁªëÂÆöÊï∞ÊçÆÔºàÂ¶ÇÊûúÂ≠òÂú®‰ª•Áæ§ËÅäÂêçÁß∞‰∏∫keyÁöÑÁªëÂÆöÔºâ***
                    if (window.wallpaperurl) {
                        // Ê£ÄÊü•ÊòØÂê¶Êúâ‰ª•ÊóßÁæ§ËÅäÂêçÁß∞‰∏∫keyÁöÑÂ£ÅÁ∫∏ËÆæÁΩÆ
                        if (window.wallpaperurl[oldName]) {
                            console.log(`ÂèëÁé∞‰ª•Áæ§ËÅäÂêçÁß∞‰∏∫keyÁöÑÂ£ÅÁ∫∏ËÆæÁΩÆ: ${oldName}`);
                            window.wallpaperurl[newName] = window.wallpaperurl[oldName];
                            delete window.wallpaperurl[oldName];
                            console.log(`Â£ÅÁ∫∏ÁªëÂÆöÂ∑≤ËøÅÁßª: ${oldName} -> ${newName}`);
                            migratedCount++;
                        }
                        
                        // Á°Æ‰øùÁæ§ËÅäÊàêÂëòÁöÑÂ£ÅÁ∫∏ÁªëÂÆöÂÆåÊï¥
                    if (groupData.members && groupData.members.length > 0) {
                        const firstMember = groupData.members[0];
                            if (window.wallpaperurl[firstMember]) {
                                console.log(`Á°ÆËÆ§ÊàêÂëòÂ£ÅÁ∫∏ÁªëÂÆöÂ≠òÂú®: ${firstMember} -> ${window.wallpaperurl[firstMember]}`);
                            } else {
                                // Â¶ÇÊûúÊàêÂëòÊ≤°ÊúâÂ£ÅÁ∫∏ËÆæÁΩÆÔºå‰ΩøÁî®ÈªòËÆ§ÁöÑÁæ§ËÅäÂ£ÅÁ∫∏
                                window.wallpaperurl[firstMember] = 'https://files.catbox.moe/9fdwty.jpg';
                                console.log(`‰∏∫ÊàêÂëòËÆæÁΩÆÈªòËÆ§Áæ§ËÅäÂ£ÅÁ∫∏: ${firstMember}`);
                                migratedCount++;
                            }
                        }
                    }
                    
                    // *** 2. Á°Æ‰øùÂÖ®Â±ÄQQ_GroupsÊï∞ÁªÑÊ≠£Á°ÆÊõ¥Êñ∞ ***
                    console.log('Ê£ÄÊü•ÂíåÊõ¥Êñ∞ÂÖ®Â±ÄQQ_GroupsÊï∞ÁªÑ...');
                    
                    // Á°Æ‰øùQQ_GroupsÊï∞ÁªÑÂ≠òÂú®
                    if (!window.QQ_Groups) {
                        console.warn('QQ_GroupsÊï∞ÁªÑ‰∏çÂ≠òÂú®ÔºåÈáçÊñ∞ÂàùÂßãÂåñ');
                        window.QQ_Groups = [];
                    }
                    
                    // Êü•ÊâæÂπ∂Êõ¥Êñ∞QQ_Groups‰∏≠ÁöÑÁæ§ËÅäÊï∞ÊçÆ
                    const groupIndex = window.QQ_Groups.findIndex(g => 
                        g && (g.id === groupData.id || g.name === oldName || g.name === newName)
                    );
                    
                    if (groupIndex > -1) {
                        console.log(`Êõ¥Êñ∞QQ_GroupsÊï∞ÁªÑ‰∏≠ÁöÑÁæ§ËÅä [${groupIndex}]:`, oldName, '->', newName);
                        console.log(`Â§¥ÂÉèÊï∞ÊçÆËøÅÁßª: ${groupData.avatar ? JSON.stringify(groupData.avatar) : 'null'}`);
                        window.QQ_Groups[groupIndex] = {
                            ...window.QQ_Groups[groupIndex],
                            name: groupData.name,
                            id: groupData.id,
                            avatar: groupData.avatar,
                            avatarUrl: groupData.avatarUrl,
                            members: groupData.members
                        };
                        console.log('QQ_GroupsÊï∞ÁªÑ‰∏≠ÁöÑÂ§¥ÂÉèÂ∑≤Êõ¥Êñ∞:', window.QQ_Groups[groupIndex].avatar);
                        migratedCount++;
                    } else {
                        // Â¶ÇÊûúÂú®QQ_Groups‰∏≠Êâæ‰∏çÂà∞ÔºåÁ°Æ‰øùÁæ§ËÅäÊï∞ÊçÆÂ≠òÂú®
                        console.log('Âú®QQ_Groups‰∏≠Êú™ÊâæÂà∞Áæ§ËÅäÔºåÊ∑ªÂä†Êñ∞Êï∞ÊçÆ');
                        console.log('Êñ∞Êï∞ÊçÆÂ§¥ÂÉè:', groupData.avatar);
                        window.QQ_Groups.push(groupData);
                        migratedCount++;
                    }
                    
                    console.log('QQ_GroupsÊï∞ÁªÑÊõ¥Êñ∞ÂÆåÊàêÔºåÂΩìÂâçÊï∞Èáè:', window.QQ_Groups.length);
                    console.log('QQ_GroupsÊï∞ÁªÑÂÜÖÂÆπ:', window.QQ_Groups.map(g => ({ name: g.name, id: g.id })));
                    
                    // *** 3. ËøÅÁßªÂÖ∂‰ªñÂèØËÉΩÁöÑÂêçÁß∞ÁªëÂÆöÊï∞ÊçÆ ***
                    
                    // ËøÅÁßªlocalStorage‰∏≠ÂèØËÉΩÁöÑÁæ§ËÅäÁõ∏ÂÖ≥Êï∞ÊçÆ
                    try {
                        const storageKeys = Object.keys(localStorage);
                        for (const key of storageKeys) {
                            if (key.includes(oldName)) {
                                const value = localStorage.getItem(key);
                                const newKey = key.replace(oldName, newName);
                                localStorage.setItem(newKey, value);
                                localStorage.removeItem(key);
                                console.log(`localStorageÊï∞ÊçÆËøÅÁßª: ${key} -> ${newKey}`);
                                migratedCount++;
                            }
                        }
                    } catch (storageError) {
                        console.warn('localStorageÊï∞ÊçÆËøÅÁßªÊó∂Âá∫Èîô:', storageError);
                    }
                    
                    // *** 3. ËøÅÁßªwindowÂÖ®Â±ÄÂØπË±°‰∏≠ÁöÑÁæ§ËÅäÁõ∏ÂÖ≥Êï∞ÊçÆ ***
                    if (window.groups && Array.isArray(window.groups)) {
                        const groupIndex = window.groups.findIndex(g => g && g.name === oldName || g.name === newName);
                        if (groupIndex !== -1) {
                            window.groups[groupIndex].name = newName;
                            console.log(`window.groupsÊï∞ÊçÆÂ∑≤Êõ¥Êñ∞`);
                            migratedCount++;
                        }
                    }
                    
                    // *** 4. Á°Æ‰øùCSSÁ±ªÂêçÂíåÊ†∑ÂºèÁöÑÊï∞ÊçÆÁªëÂÆö ***
                    // Êõ¥Êñ∞ÊâÄÊúâÂèØËÉΩÂåÖÂê´ÊóßÂêçÁß∞ÁöÑdataÂ±ûÊÄß
                    const elementsWithOldName = document.querySelectorAll(`[data-name="${oldName}"]`);
                    elementsWithOldName.forEach(el => {
                        el.setAttribute('data-name', newName);
                        console.log('Â∑≤Êõ¥Êñ∞ÂÖÉÁ¥†data-nameÂ±ûÊÄß');
                        migratedCount++;
                    });
                    
                    // *** 5. ËøÅÁßªÂèØËÉΩÁöÑËÅäÂ§©ÂéÜÂè≤ÁªëÂÆö ***
                    if (window.groupChats && window.groupChats[oldName]) {
                        window.groupChats[newName] = window.groupChats[oldName];
                        delete window.groupChats[oldName];
                        console.log(`Áæ§ËÅäÂéÜÂè≤Êï∞ÊçÆÂ∑≤ËøÅÁßª: ${oldName} -> ${newName}`);
                        migratedCount++;
                    }
                    
                    console.log(`*** Êï∞ÊçÆËøÅÁßªÂÆåÊàêÔºåÂÖ±ËøÅÁßª ${migratedCount} È°πÊï∞ÊçÆÁªëÂÆö ***`);
                    
                    // *** 6. Á´ãÂç≥Êõ¥Êñ∞ÂΩìÂâçËÅäÂ§©È°µÈù¢ÔºàÂ¶ÇÊûúÊ≠£Âú®ËÅäÂ§©‰∏≠Ôºâ ***
                    console.log('Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞ÂΩìÂâçËÅäÂ§©È°µÈù¢...');
                    
                    // Êü•ÊâæÂΩìÂâçÊòæÁ§∫ÁöÑËÅäÂ§©È°µÈù¢
                    const currentChatPage = document.querySelector('.QQ_chat_page:not([style*="display: none"]):not([style*="display:none"])');
                    if (currentChatPage) {
                        console.log('ÊâæÂà∞ÂΩìÂâçËÅäÂ§©È°µÈù¢ÔºåÊ£ÄÊü•ÊòØÂê¶‰∏∫ÁõÆÊ†áÁæ§ËÅä...');
                        
                        // Ê£ÄÊü•ÊòØÂê¶‰∏∫ÂΩìÂâçÁæ§ËÅäÁöÑËÅäÂ§©È°µÈù¢
                        const pageGroupId = currentChatPage.getAttribute('data-group-id');
                        const pageDataName = currentChatPage.getAttribute('data-name');
                        
                        console.log('ËÅäÂ§©È°µÈù¢Êï∞ÊçÆ:', {
                            pageGroupId,
                            pageDataName,
                            targetGroupId: groupData.id,
                            oldName,
                            newName
                        });
                        
                        // Âà§Êñ≠ÊòØÂê¶‰∏∫ÁõÆÊ†áÁæ§ËÅäÈ°µÈù¢ÔºàÈÄöËøáIDÊàñÂêçÁß∞ÂåπÈÖçÔºâ
                        const isTargetChatPage = (pageGroupId === groupData.id) || 
                                                (pageDataName === oldName) || 
                                                (pageDataName === newName);
                        
                        if (isTargetChatPage) {
                            console.log('*** ÂΩìÂâçËÅäÂ§©È°µÈù¢ÊòØÁõÆÊ†áÁæ§ËÅäÔºåÁ´ãÂç≥Êõ¥Êñ∞ÔºÅ***');
                            
                            // *** Ê†∏ÂøÉ‰øÆÂ§ç1ÔºöÁ´ãÂç≥Êõ¥Êñ∞ËÅäÂ§©È°µÈù¢ÁöÑÊï∞ÊçÆÂ±ûÊÄß ***
                            currentChatPage.setAttribute('data-group-id', groupData.id);
                            currentChatPage.setAttribute('data-name', groupData.name);
                            console.log('Â∑≤Êõ¥Êñ∞ËÅäÂ§©È°µÈù¢ÁöÑdata-group-idÂíådata-name');
                            
                            // *** Ê†∏ÂøÉ‰øÆÂ§ç2ÔºöÁ´ãÂç≥Êõ¥Êñ∞window.currentGroupChat ***
                            if (window.currentGroupChat && 
                                (window.currentGroupChat.id === groupData.id || 
                                 window.currentGroupChat.name === oldName)) {
                                console.log('Êõ¥Êñ∞window.currentGroupChatÊï∞ÊçÆ...');
                                window.currentGroupChat.name = groupData.name;
                                window.currentGroupChat.avatar = groupData.avatar;
                                window.currentGroupChat.avatarUrl = groupData.avatarUrl;
                                window.currentGroupChat.members = groupData.members;
                                console.log('window.currentGroupChatÂ∑≤Êõ¥Êñ∞:', window.currentGroupChat);
                            }
                            
                            // *** Ê†∏ÂøÉ‰øÆÂ§ç3ÔºöÁ´ãÂç≥Êõ¥Êñ∞ËÅäÂ§©È°µÈù¢Â§¥ÈÉ®ÔºàÂ§öÈáçÁ≠ñÁï•Ôºâ ***
                            console.log('ÂºÄÂßãÁ´ãÂç≥Êõ¥Êñ∞ËÅäÂ§©È°µÈù¢Ê†áÈ¢ò...');
                            
                            // Á≠ñÁï•1ÔºöÁõ¥Êé•Êõ¥Êñ∞ËÅäÂ§©Áî®Êà∑ÂêçÂÖÉÁ¥†
                            const chatUsernameElement = currentChatPage.querySelector('#QQ_chat_username');
                            if (chatUsernameElement) {
                                console.log('ÊâæÂà∞ËÅäÂ§©Áî®Êà∑ÂêçÂÖÉÁ¥†ÔºåÁ´ãÂç≥Êõ¥Êñ∞...');
                                const displayName = groupData.members && groupData.members.length > 1 
                                    ? `${groupData.name} (${groupData.members.length}‰∫∫)` 
                                    : groupData.name;
                                chatUsernameElement.textContent = displayName;
                                chatUsernameElement.setAttribute('data-group-name', groupData.name);
                                chatUsernameElement.setAttribute('data-group-id', groupData.id);
                                console.log(`ËÅäÂ§©Ê†áÈ¢òÂ∑≤Á´ãÂç≥Êõ¥Êñ∞‰∏∫: ${displayName}`);
                            } else {
                                console.warn('Êú™ÊâæÂà∞#QQ_chat_usernameÂÖÉÁ¥†');
                            }
                            
                            // Á≠ñÁï•2ÔºöÊü•ÊâæÂπ∂Êõ¥Êñ∞ÂÆåÊï¥ÁöÑËÅäÂ§©Â§¥ÈÉ®
                            const chatHeader = currentChatPage.querySelector('.QQ_chat_header') || 
                                             currentChatPage.querySelector('.QQ_home') ||
                                             currentChatPage.querySelector('[class*="header"]');
                            
                            if (chatHeader) {
                                console.log('ÊâæÂà∞ËÅäÂ§©Â§¥ÈÉ®ÔºåÂÆåÊï¥Êõ¥Êñ∞...');
                                updateHeaderContent(chatHeader, groupData);
                                console.log('ËÅäÂ§©Â§¥ÈÉ®ÂÆåÊï¥Êõ¥Êñ∞ÂÆåÊàê');
                            } else {
                                console.warn('Êú™ÊâæÂà∞ËÅäÂ§©Â§¥ÈÉ®ÂÖÉÁ¥†');
                                console.log('ËÅäÂ§©È°µÈù¢ÁªìÊûÑ:', currentChatPage.outerHTML.substring(0, 500));
                            }
                            
                            // *** Á≠ñÁï•3ÔºöÂº∫Âà∂DOMÂà∑Êñ∞ÂêéÂÜçÊ¨°Êõ¥Êñ∞ÔºàÁ°Æ‰øùÊòæÁ§∫Êõ¥Êñ∞Ôºâ ***
                        setTimeout(() => {
                                console.log('Âª∂ËøüÂº∫Âà∂Êõ¥Êñ∞ËÅäÂ§©Ê†áÈ¢ò...');
                                
                                // ÂÜçÊ¨°Êü•ÊâæÂπ∂Êõ¥Êñ∞Áî®Êà∑ÂêçÂÖÉÁ¥†
                                const delayedUsernameElement = currentChatPage.querySelector('#QQ_chat_username');
                                if (delayedUsernameElement) {
                                    const delayedDisplayName = groupData.members && groupData.members.length > 1 
                                        ? `${groupData.name} (${groupData.members.length}‰∫∫)` 
                                        : groupData.name;
                                    delayedUsernameElement.textContent = delayedDisplayName;
                                    console.log(`Âª∂ËøüÊõ¥Êñ∞Ê†áÈ¢òÊàêÂäü: ${delayedDisplayName}`);
                                }
                                
                                // ÂÜçÊ¨°Êõ¥Êñ∞Â§¥ÈÉ®
                                const delayedChatHeader = currentChatPage.querySelector('.QQ_chat_header') || 
                                                         currentChatPage.querySelector('.QQ_home') ||
                                                         currentChatPage.querySelector('[class*="header"]');
                                if (delayedChatHeader) {
                                    updateHeaderContent(delayedChatHeader, groupData);
                                    console.log('Âª∂ËøüÂ§¥ÈÉ®Êõ¥Êñ∞ÂÆåÊàê');
                                }
                                
                            }, 50);
                            
                                                         // *** Ê†∏ÂøÉ‰øÆÂ§ç4ÔºöÈáçÊñ∞Â∫îÁî®Áæ§ËÅäËÉåÊôØÔºàÁ´ãÂç≥ÊâßË°åÔºâ ***
                             reapplyGroupChatBackground(groupData);
                            
                            console.log('*** ÂΩìÂâçËÅäÂ§©È°µÈù¢ÂÆûÊó∂Êõ¥Êñ∞ÂÆåÊàê ***');
                        } else {
                            console.log('ÂΩìÂâçËÅäÂ§©È°µÈù¢‰∏çÊòØÁõÆÊ†áÁæ§ËÅäÔºåË∑≥ËøáÂÆûÊó∂Êõ¥Êñ∞');
                        }
                    } else {
                        console.log('ÂΩìÂâçÊ≤°ÊúâÊâìÂºÄÁöÑËÅäÂ§©È°µÈù¢');
                    }
                    
                    // *** 7. Âª∂ËøüÂà∑Êñ∞ÂÖ∂‰ªñÁªÑ‰ª∂‰ª•Â∫îÁî®Êñ∞ÁöÑÁªëÂÆöÂÖ≥Á≥ª ***
                    setTimeout(() => {
                        console.log('Âª∂ËøüÂà∑Êñ∞ÂÖ∂‰ªñÁªÑ‰ª∂...');
                        
                        // Ëß¶ÂèëÁïåÈù¢ÈáçÊñ∞Ê∏≤Êüì‰∫ã‰ª∂
                        const event = new CustomEvent('groupDataMigrated', {
                            detail: { oldName, newName, groupData }
                        });
                        window.dispatchEvent(event);
                        
                                                 // ÂÜçÊ¨°Á°Æ‰øùÂ£ÅÁ∫∏Ê≠£Á°Æ
                         reapplyGroupChatBackground(groupData);
                        
                    }, 100);
                    
                    return migratedCount;
                    
                } catch (error) {
                    console.error('Áæ§ËÅäÊï∞ÊçÆËøÅÁßªÊó∂Âá∫Èîô:', error);
                    return 0;
                }
            }
            
            /**
             * ‰øùÊä§ÊÄßËÅîÁ≥ª‰∫∫ÂàóË°®Êõ¥Êñ∞ÔºàÈò≤Ê≠¢Ê†ºÂºèÁ†¥ÂùèÔºâ
             */
            async function protectedContactListUpdate(groupData, operation = 'group_update') {
                console.log('*** ÂºÄÂßã‰øùÊä§ÊÄßËÅîÁ≥ª‰∫∫ÂàóË°®Êõ¥Êñ∞ ***');
                console.log('Áæ§ËÅäÊï∞ÊçÆ:', groupData);
                console.log('Êìç‰ΩúÁ±ªÂûã:', operation);
                
                try {
                    const contactsContainer = document.getElementById('QQ_home_chars');
                    if (!contactsContainer) {
                        console.warn('ËÅîÁ≥ª‰∫∫ÂÆπÂô®Êú™ÊâæÂà∞');
                        return;
                    }
                    
                    // *** ÂÖ≥ÈîÆÁ≠ñÁï•ÔºöÊûÅÂ∫¶‰øùÂÆàÁöÑÊõ¥Êñ∞ÊñπÂºè ***
                    
                    // 1. Á≤æÁ°ÆÊü•ÊâæÁõÆÊ†áÁæ§ËÅäÂÖÉÁ¥†Ôºà‰ΩøÁî®Â§öÁßçÊñπÊ≥ïÁ°Æ‰øùÁ≤æÁ°ÆÂåπÈÖçÔºâ
                    let targetElements = [];
                    
                    // ÊñπÊ≥ï1Ôºö‰ΩøÁî®data-group-idÊü•Êâæ
                    if (groupData.id) {
                        const byGroupId = contactsContainer.querySelectorAll(`[data-group-id="${groupData.id}"]`);
                        targetElements.push(...byGroupId);
                        console.log(`ÊñπÊ≥ï1(data-group-id)ÊâæÂà∞ ${byGroupId.length} ‰∏™ÂÖÉÁ¥†`);
                    }
                    
                    // ÊñπÊ≥ï2ÔºöÂ¶ÇÊûúoperationÂåÖÂê´ÊóßÂêçÁß∞‰ø°ÊÅØÔºå‰ΩøÁî®ÂÆÉÊü•Êâæ
                    if (operation && operation !== 'group_update' && targetElements.length === 0) {
                        const byOldName = contactsContainer.querySelectorAll(`[data-name="${operation}"]`);
                        targetElements.push(...byOldName);
                        console.log(`ÊñπÊ≥ï2(data-nameÊìç‰ΩúÂèÇÊï∞)ÊâæÂà∞ ${byOldName.length} ‰∏™ÂÖÉÁ¥†`);
                    }
                    
                    // ÊñπÊ≥ï3Ôºö‰ΩøÁî®Êñ∞ÂêçÁß∞ÁöÑdata-nameÊü•Êâæ
                    if (groupData.name && targetElements.length === 0) {
                        const byNewName = contactsContainer.querySelectorAll(`[data-name="${groupData.name}"]`);
                        targetElements.push(...byNewName);
                        console.log(`ÊñπÊ≥ï3(data-nameÊñ∞ÂêçÁß∞)ÊâæÂà∞ ${byNewName.length} ‰∏™ÂÖÉÁ¥†`);
                    }
                    
                    // ÂéªÈáç
                    targetElements = [...new Set(targetElements)];
                    console.log(`ÊÄªÂÖ±ÊâæÂà∞ ${targetElements.length} ‰∏™ÁõÆÊ†áÂÖÉÁ¥†ÈúÄË¶ÅÊõ¥Êñ∞`);
                    
                    if (targetElements.length === 0) {
                        console.warn('Êú™ÊâæÂà∞ÈúÄË¶ÅÊõ¥Êñ∞ÁöÑËÅîÁ≥ª‰∫∫ÂÖÉÁ¥†ÔºåË∑≥ËøáÊõ¥Êñ∞');
                        return;
                    }
                    
                    // 2. ÂØπÊØè‰∏™ÁõÆÊ†áÂÖÉÁ¥†ËøõË°åÂÆâÂÖ®Êõ¥Êñ∞
                    let successCount = 0;
                    let errorCount = 0;
                    
                    targetElements.forEach((element, index) => {
                        try {
                            console.log(`Êõ¥Êñ∞ÁõÆÊ†áÂÖÉÁ¥† ${index + 1}/${targetElements.length}`);
                            
                            // *** ÊûÅÂ∫¶ÂÆâÂÖ®ÁöÑÊõ¥Êñ∞Á≠ñÁï•ÔºöÂè™Êõ¥Êñ∞Á°Æ‰øùÂ≠òÂú®ÁöÑÂÖÉÁ¥† ***
                            
                            // È™åËØÅËøôÊòØ‰∏Ä‰∏™ÊúâÊïàÁöÑËÅîÁ≥ª‰∫∫ÂÖÉÁ¥†
                            if (!element.classList.contains('QQ_home_usermsg')) {
                                console.warn(`ÂÖÉÁ¥†${index + 1}‰∏çÊòØÊúâÊïàÁöÑËÅîÁ≥ª‰∫∫ÂÖÉÁ¥†ÔºåË∑≥Ëøá`);
                                return;
                            }
                            
                            // Âè™Êõ¥Êñ∞Êï∞ÊçÆÂ±ûÊÄßÔºàÊúÄÂÆâÂÖ®Ôºâ
                            element.setAttribute('data-group-id', groupData.id);
                            element.setAttribute('data-name', groupData.name);
                            
                            // Âè™ÊúâÂú®ÊâæÂà∞ÂêçÁß∞ÂÖÉÁ¥†Êó∂ÊâçÊõ¥Êñ∞ÊñáÊú¨
                            const nameElement = element.querySelector('.QQ_home_name');
                            if (nameElement && nameElement.textContent.trim() !== groupData.name) {
                                const oldText = nameElement.textContent.trim();
                                nameElement.textContent = groupData.name;
                                console.log(`ÂÖÉÁ¥†${index + 1}ÂêçÁß∞Êõ¥Êñ∞: "${oldText}" -> "${groupData.name}"`);
                            }
                            
                            // *** ÈáçË¶Å‰øÆÂ§çÔºöÊõ¥Êñ∞Â§¥ÂÉèÔºàÂ¶ÇÊûúÊúâÂ§¥ÂÉèÊï∞ÊçÆÔºâ ***
                            const avatarElement = element.querySelector('.QQ_home_head');
                            if (avatarElement && groupData.avatar) {
                                console.log(`Êõ¥Êñ∞ÂÖÉÁ¥†${index + 1}ÁöÑÂ§¥ÂÉè`);
                                try {
                                    // ‰øùÂ≠òÂéüÊúâÁöÑÁ±ªÂêçÔºåÈÅøÂÖçÁ†¥ÂùèÊ†∑Âºè
                                    const originalClasses = avatarElement.className;
                                    const originalId = avatarElement.id;
                                    
                                    // Êõ¥Êñ∞Â§¥ÂÉè
                                    updateAvatarElement(avatarElement, groupData.avatar);
                                    
                                    // Á°Æ‰øùÂéüÊúâÁ±ªÂêçÊ≤°ÊúâË¢´Á†¥Âùè
                                    if (originalClasses && !avatarElement.className.includes('QQ_home_head')) {
                                        avatarElement.className = originalClasses;
                                    }
                                    if (originalId) {
                                        avatarElement.id = originalId;
                                    }
                                    
                                    console.log(`ÂÖÉÁ¥†${index + 1}Â§¥ÂÉèÊõ¥Êñ∞ÊàêÂäü`);
                                } catch (avatarError) {
                                    console.error(`Êõ¥Êñ∞ÂÖÉÁ¥†${index + 1}Â§¥ÂÉèÊó∂Âá∫Èîô:`, avatarError);
                                }
                            } else if (!avatarElement) {
                                console.log(`ÂÖÉÁ¥†${index + 1}Ê≤°ÊúâÊâæÂà∞Â§¥ÂÉèÂÖÉÁ¥†`);
                            } else if (!groupData.avatar) {
                                console.log(`ÂÖÉÁ¥†${index + 1}Ê≤°ÊúâÂ§¥ÂÉèÊï∞ÊçÆ`);
                            }
                            
                            // ‰øùÊä§Áé∞ÊúâÊ†ºÂºèÔºå‰∏çÊõ¥Êñ∞ÂÖ∂‰ªñDOMÁªìÊûÑ
                            
                            successCount++;
                            console.log(`ÂÖÉÁ¥†${index + 1}Êõ¥Êñ∞ÊàêÂäü`);
                            
                        } catch (elementError) {
                            console.error(`Êõ¥Êñ∞ÂÖÉÁ¥†${index + 1}Êó∂Âá∫Èîô:`, elementError);
                            errorCount++;
                        }
                    });
                    
                    console.log(`*** ‰øùÊä§ÊÄßËÅîÁ≥ª‰∫∫Êõ¥Êñ∞ÂÆåÊàê: ÊàêÂäü${successCount}‰∏™, ÈîôËØØ${errorCount}‰∏™ ***`);
                    
                    // 3. È™åËØÅÊõ¥Êñ∞ÁªìÊûú
                    setTimeout(() => {
                        console.log('=== ËÅîÁ≥ª‰∫∫Êõ¥Êñ∞ÁªìÊûúÈ™åËØÅ ===');
                        const updatedElements = contactsContainer.querySelectorAll(`[data-name="${groupData.name}"]`);
                        console.log(`È™åËØÅÔºöÁé∞Âú®Êúâ ${updatedElements.length} ‰∏™ÂÖÉÁ¥†‰ΩøÁî®Êñ∞ÂêçÁß∞`);
                        
                        updatedElements.forEach((el, i) => {
                            const nameEl = el.querySelector('.QQ_home_name');
                            if (nameEl) {
                                console.log(`È™åËØÅÂÖÉÁ¥†${i + 1}: "${nameEl.textContent.trim()}"`);
                            }
                        });
                    }, 500);
                    
                } catch (error) {
                    console.error('‰øùÊä§ÊÄßËÅîÁ≥ª‰∫∫ÂàóË°®Êõ¥Êñ∞Êó∂Âá∫Èîô:', error);
                }
            }
            
            // [Â∑≤Âà†Èô§] updateChatPageBackground - ÂäüËÉΩÂ∑≤Áî±reapplyGroupChatBackgroundÊõø‰ª£
            
            // [Â∑≤Âà†Èô§] ensureContactListFormat - ÂäüËÉΩÂ∑≤Áî±protectedContactListUpdateÊõø‰ª£
            
            // [Â∑≤Âà†Èô§] immediateUpdateGroupInAllLists - ÂäüËÉΩÂ∑≤Áî±protectedContactListUpdateÊõø‰ª£
            
            /**
             * ÂÆâÂÖ®Êõ¥Êñ∞Áæ§ËÅäÂÖÉÁ¥†Ôºà‰øùÊä§ÂéüÊúâÊ†ºÂºèÁâàÔºâ
             */
            function safeUpdateGroupElement(element, groupData) {
                try {
                    if (!element || !groupData) return;
                    
                    console.log('ÂºÄÂßãÂÆâÂÖ®Êõ¥Êñ∞Áæ§ËÅäÂÖÉÁ¥†:', groupData.name);
                    console.log('ÂÖÉÁ¥†ÂΩìÂâçÁä∂ÊÄÅ:', {
                        tagName: element.tagName,
                        className: element.className,
                        dataName: element.getAttribute('data-name'),
                        dataGroupId: element.getAttribute('data-group-id')
                    });
                    
                    // *** ÂÆâÂÖ®Á≠ñÁï•1ÔºöÂè™Êõ¥Êñ∞Êï∞ÊçÆÂ±ûÊÄßÔºå‰∏çÁ†¥ÂùèDOMÁªìÊûÑ ***
                    element.setAttribute('data-group-id', groupData.id);
                    element.setAttribute('data-name', groupData.name);
                    
                    // *** ÂÆâÂÖ®Á≠ñÁï•2ÔºöÂ∞èÂøÉÊõ¥Êñ∞Áæ§ËÅäÂêçÁß∞Ôºå‰øùÊåÅÂéüÊúâHTMLÁªìÊûÑ ***
                    const nameElement = element.querySelector('.QQ_home_name');
                    if (nameElement) {
                        const oldName = nameElement.textContent.trim();
                        if (oldName !== groupData.name) {
                            console.log(`ÂÆâÂÖ®Êõ¥Êñ∞ÂêçÁß∞: "${oldName}" -> "${groupData.name}"`);
                        nameElement.textContent = groupData.name;
                        }
                    } else {
                        console.warn('Êú™ÊâæÂà∞Áæ§ËÅäÂêçÁß∞ÂÖÉÁ¥†ÔºåË∑≥ËøáÂêçÁß∞Êõ¥Êñ∞');
                    }
                    
                    // *** ÂÆâÂÖ®Á≠ñÁï•3ÔºöË∞®ÊÖéÊõ¥Êñ∞Áæ§ËÅäÂ§¥ÂÉèÔºåÈÅøÂÖçÁ†¥ÂùèÊ†∑Âºè ***
                    const avatarElement = element.querySelector('.QQ_home_head');
                    if (avatarElement && groupData.avatar) {
                        console.log('ÂÆâÂÖ®Êõ¥Êñ∞Áæ§ËÅäÂ§¥ÂÉè');
                        
                        // ‰øùÂ≠òÂéüÊúâÁöÑÂü∫Á°ÄÊ†∑Âºè
                        const originalClasses = avatarElement.className;
                        const originalId = avatarElement.id;
                        
                        try {
                        updateAvatarElement(avatarElement, groupData.avatar);
                            
                            // Á°Æ‰øùÂéüÊúâÁ±ªÂêçÂíåIDÊ≤°ÊúâË¢´Á†¥Âùè
                            if (originalClasses && !avatarElement.className.includes('QQ_home_head')) {
                                avatarElement.className = originalClasses;
                            }
                            if (originalId) {
                                avatarElement.id = originalId;
                            }
                            
                        } catch (avatarError) {
                            console.error('Êõ¥Êñ∞Â§¥ÂÉèÊó∂Âá∫ÈîôÔºå‰øùÊåÅÂéüÁä∂:', avatarError);
                        }
                    }
                    
                    console.log('Áæ§ËÅäÂÖÉÁ¥†ÂÆâÂÖ®Êõ¥Êñ∞ÂÆåÊàê:', groupData.name);
                    
                } catch (error) {
                    console.error('ÂÆâÂÖ®Êõ¥Êñ∞Áæ§ËÅäÂÖÉÁ¥†Êó∂Âá∫Èîô:', error);
                    // Âç≥‰ΩøÂá∫Èîô‰πüË¶ÅÁ°Æ‰øùÂü∫Êú¨Êï∞ÊçÆÂ±ûÊÄßÊ≠£Á°Æ
                    try {
                        element.setAttribute('data-group-id', groupData.id);
                        element.setAttribute('data-name', groupData.name);
                        console.log('Â∑≤ËÆæÁΩÆÂü∫Êú¨Êï∞ÊçÆÂ±ûÊÄß‰Ωú‰∏∫Â§áÁî®');
                    } catch (backupError) {
                        console.error('ËÆæÁΩÆÂ§áÁî®Êï∞ÊçÆÂ±ûÊÄß‰πüÂ§±Ë¥•:', backupError);
                    }
                }
            }
            
            // [Â∑≤Âà†Èô§] immediateUpdateGroupElement - Â∑≤Êï¥ÂêàÂà∞safeUpdateGroupElement
            
            /**
             * Êõ¥Êñ∞Â§¥ÂÉèÂÖÉÁ¥†ÁöÑÈÄöÁî®ÂáΩÊï∞
             */
            function updateAvatarElement(avatarElement, avatarData) {
                if (!avatarElement) {
                    console.warn('updateAvatarElement: Â§¥ÂÉèÂÖÉÁ¥†‰∏çÂ≠òÂú®');
                    return;
                }
                
                if (!avatarData) {
                    console.warn('updateAvatarElement: Â§¥ÂÉèÊï∞ÊçÆ‰∏çÂ≠òÂú®Ôºå‰øùÊåÅÁé∞ÊúâÂ§¥ÂÉè');
                    return;
                }
                
                console.log('Êõ¥Êñ∞Â§¥ÂÉèÂÖÉÁ¥†:', avatarData);
                
                if (avatarData.type === 'preset') {
                    // È¢ÑËÆæÂ§¥ÂÉè
                    avatarElement.style.background = `linear-gradient(135deg, ${avatarData.gradient.start}, ${avatarData.gradient.end})`;
                    avatarElement.style.backgroundImage = 'none';
                    avatarElement.style.color = 'white';
                    avatarElement.style.display = 'flex';
                    avatarElement.style.alignItems = 'center';
                    avatarElement.style.justifyContent = 'center';
                    avatarElement.style.fontWeight = 'bold';
                    avatarElement.textContent = avatarData.text || 'Áæ§';
                } else if (avatarData.type === 'upload' && avatarData.imageData) {
                    // ‰∏ä‰º†ÁöÑÂ§¥ÂÉè
                    avatarElement.style.background = 'none';
                    avatarElement.style.backgroundImage = `url('${avatarData.imageData}')`;
                    avatarElement.style.backgroundSize = 'cover';
                    avatarElement.style.backgroundPosition = 'center';
                    avatarElement.style.backgroundRepeat = 'no-repeat';
                    avatarElement.textContent = '';
                } else if (typeof avatarData === 'string' && avatarData.startsWith('data:')) {
                    // Áõ¥Êé•ÁöÑbase64Â≠óÁ¨¶‰∏≤
                    avatarElement.style.background = 'none';
                    avatarElement.style.backgroundImage = `url('${avatarData}')`;
                    avatarElement.style.backgroundSize = 'cover';
                    avatarElement.style.backgroundPosition = 'center';
                    avatarElement.style.backgroundRepeat = 'no-repeat';
                    avatarElement.textContent = '';
                } else if (typeof avatarData === 'string' && (avatarData.startsWith('http://') || avatarData.startsWith('https://'))) {
                    // ÁΩëÁªúÂõæÁâáURL
                    avatarElement.style.background = 'none';
                    avatarElement.style.backgroundImage = `url('${avatarData}')`;
                    avatarElement.style.backgroundSize = 'cover';
                    avatarElement.style.backgroundPosition = 'center';
                    avatarElement.style.backgroundRepeat = 'no-repeat';
                    avatarElement.textContent = '';
                } else {
                    // ÈªòËÆ§Â§¥ÂÉè
                    avatarElement.style.background = 'linear-gradient(135deg, #199AFF, #0066CC)';
                    avatarElement.style.backgroundImage = 'none';
                    avatarElement.style.color = 'white';
                    avatarElement.style.display = 'flex';
                    avatarElement.style.alignItems = 'center';
                    avatarElement.style.justifyContent = 'center';
                    avatarElement.style.fontWeight = 'bold';
                    avatarElement.textContent = 'Áæ§';
                }
            }
            

            
            /**
             * ‰øùÂ≠òÁæ§ËÅäÂà∞‰∏ñÁïå‰π¶ÁöÑÈÄöÁî®ÂáΩÊï∞Ôºà‰øÆÂ§çÁâàÔºâ
             */
            async function saveGroupToWorldbook(groupData) {
                console.log('‰øùÂ≠òÁæ§ËÅäÂà∞‰∏ñÁïå‰π¶:', groupData);
                
                try {
                    // Â¶ÇÊûúentriesÊú™ÂÆö‰πâÔºåÂÖàÂàùÂßãÂåñÂÆÉ
                    if (!entries) {
                        console.log('entriesÊú™ÂÆö‰πâÔºåÊ≠£Âú®ÂàùÂßãÂåñ...');
                        if (!worldbook) {
                            console.error('worldbookÊú™ÂÆö‰πâÔºåÊó†Ê≥ïÂàùÂßãÂåñentries');
                            return false;
                        }
                        entries = await getLorebookEntries(worldbook);
                        console.log('entriesÂàùÂßãÂåñÂÆåÊàêÔºåÊù°ÁõÆÊï∞Èáè:', entries ? entries.length : 'failed');
                        if (!entries) {
                            console.error('entriesÂàùÂßãÂåñÂ§±Ë¥•');
                            return false;
                        }
                    }
                    
                    // Êü•ÊâæÁé∞ÊúâÁöÑÁæ§ËÅäÊù°ÁõÆ - ‰ΩøÁî®ÂîØ‰∏ÄcommentÊü•Êâæ
                    const uniqueComment = `ÊâãÊú∫-Áæ§ËÅä-${groupData.name}`;
                    let groupEntry = entries.find(e => 
                        e.comment === uniqueComment
                    );
                    
                    // Â§ÑÁêÜÂ§¥ÂÉèÂºïÁî®
                    let avatarReference = 'http://sharkpan.xyz/f/z0WU5/mmexport1736971020657.gif';
                    if (groupData.avatar) {
                        if (groupData.avatar.type === 'upload' && groupData.avatar.imageData) {
                            avatarReference = groupData.avatar.imageData;
                        } else if (groupData.avatar.type === 'preset') {
                            avatarReference = `È¢ÑËÆæ:${groupData.avatar.text || 'Áæ§'}`;
                        } else if (groupData.avatar.type === 'url' && groupData.avatar.url) {
                            avatarReference = groupData.avatar.url;
                        }
                    } else if (groupData.avatarUrl) {
                        avatarReference = groupData.avatarUrl;
                    }
                    
                    // ÊûÑÂª∫Áæ§ËÅäÂÜÖÂÆπ
                    const groupContent = `[${groupData.name}]
Á±ªÂûã=Áæ§ËÅä
ÊàêÂëò=${groupData.members.join(',')}
Â§¥ÂÉè=${avatarReference}`;
                    
                    if (groupEntry) {
                        // Êõ¥Êñ∞Áé∞ÊúâÊù°ÁõÆ
                        console.log('Êõ¥Êñ∞Áé∞ÊúâÁæ§ËÅäÊù°ÁõÆ:', groupEntry.uid);
                        await setLorebookEntries(worldbook, [
                            {
                                uid: groupEntry.uid,
                                content: groupContent,
                            }
                        ]);
                        console.log('Áæ§ËÅäÂ∑≤‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶');
                    } else {
                        console.error('Êú™ÊâæÂà∞Áæ§ËÅäÊù°ÁõÆÔºåÊó†Ê≥ï‰øùÂ≠ò');
                        return false;
                    }
                    
                    return true;
                } catch (error) {
                    console.error('‰øùÂ≠òÁæ§ËÅäÂà∞‰∏ñÁïå‰π¶Â§±Ë¥•:', error);
                    throw error;
                }
            }
            
            /**
             * ‰ªéÊâÄÊúâÂàóË°®‰∏≠ÁßªÈô§Áæ§ËÅä
             */
            function removeGroupFromAllLists(groupId) {
                // ‰ªéËÅîÁ≥ª‰∫∫ÂàóË°®ÁßªÈô§
                const contactsContainer = document.getElementById('QQ_home_chars');
                if (contactsContainer) {
                    const existingGroup = contactsContainer.querySelector(`[data-group-id="${groupId}"]`);
                    if (existingGroup) {
                        existingGroup.remove();
                    }
                }
                
                // ‰ªéÊ∂àÊÅØÂàóË°®ÁßªÈô§
                const messagesContainer = document.getElementById('QQ_message_list_chars');
                if (messagesContainer) {
                    const existingGroup = messagesContainer.querySelector(`[data-group-id="${groupId}"]`);
                    if (existingGroup) {
                        existingGroup.remove();
                    }
                }
            }
            
            /**
             * Âº∫Âà∂Âà†Èô§Áæ§ËÅäÁïåÈù¢ÂÖÉÁ¥†ÔºàÂ¢ûÂº∫ÁâàÂà†Èô§ÔºåÁ°Æ‰øùÂÆåÂÖ®Ê∏ÖÈô§Ôºâ
             */
            function forceRemoveGroupFromInterface(groupId, groupName) {
                console.log('Âº∫Âà∂Âà†Èô§Áæ§ËÅäÁïåÈù¢ÂÖÉÁ¥†:', groupId, groupName);
                
                // ÊñπÊ≥ï1ÔºöÈÄöËøádata-group-idÂà†Èô§
                const elementsById = document.querySelectorAll(`[data-group-id="${groupId}"]`);
                elementsById.forEach((element, index) => {
                    console.log(`ÈÄöËøáIDÂà†Èô§ÂÖÉÁ¥† ${index + 1}:`, element);
                    element.remove();
                });
                
                // ÊñπÊ≥ï2ÔºöÈÄöËøáÁæ§ËÅäÂêçÁß∞Âà†Èô§
                const contactsContainer = document.getElementById('QQ_home_chars');
                if (contactsContainer) {
                    const groupElements = contactsContainer.querySelectorAll('.QQ_home_char[data-group-type="true"]');
                    groupElements.forEach(element => {
                        const nameElement = element.querySelector('.QQ_home_name');
                        if (nameElement && nameElement.textContent.trim() === groupName) {
                            console.log('ÈÄöËøáÂêçÁß∞Âà†Èô§ËÅîÁ≥ª‰∫∫ÂàóË°®‰∏≠ÁöÑÁæ§ËÅä:', groupName);
                            element.remove();
                        }
                    });
                }
                
                // ÊñπÊ≥ï3ÔºöÈÄöËøáÁæ§ËÅäÂêçÁß∞Âà†Èô§Ê∂àÊÅØÂàóË°®‰∏≠ÁöÑÁæ§ËÅä
                const messagesContainer = document.getElementById('QQ_message_list_chars');
                if (messagesContainer) {
                    const groupElements = messagesContainer.querySelectorAll('.QQ_home_char[data-group-type="true"]');
                    groupElements.forEach(element => {
                        const nameElement = element.querySelector('.QQ_home_name');
                        if (nameElement && nameElement.textContent.trim() === groupName) {
                            console.log('ÈÄöËøáÂêçÁß∞Âà†Èô§Ê∂àÊÅØÂàóË°®‰∏≠ÁöÑÁæ§ËÅä:', groupName);
                            element.remove();
                        }
                    });
                }
                
                // ÊñπÊ≥ï4ÔºöÂà†Èô§ÂØπÂ∫îÁöÑËÅäÂ§©È°µÈù¢
                const chatPages = document.querySelectorAll(`.QQ_chat_page[data-name='${groupName}']`);
                chatPages.forEach((page, index) => {
                    console.log(`Âà†Èô§ËÅäÂ§©È°µÈù¢ ${index + 1}:`, groupName);
                    page.remove();
                });
                
                // ÊñπÊ≥ï5ÔºöÂà†Èô§Áæ§ËÅä‰∏ìÁî®È°µÈù¢
                const groupChatPages = document.querySelectorAll(`.group-chat-page[data-group-id="${groupId}"]`);
                groupChatPages.forEach((page, index) => {
                    console.log(`Âà†Èô§Áæ§ËÅä‰∏ìÁî®È°µÈù¢ ${index + 1}:`, groupId);
                    page.remove();
                });
                
                console.log('Âº∫Âà∂Âà†Èô§Áæ§ËÅäÁïåÈù¢ÂÖÉÁ¥†ÂÆåÊàê');
            }
            
            /**
             * ÂÆâÂÖ®Âà†Èô§Áæ§ËÅäÁïåÈù¢ÂÖÉÁ¥†ÔºàÈÅøÂÖçËøáÂ∫¶Âà†Èô§ÂØºËá¥Á©∫ÁôΩÈ°µÈù¢Ôºâ
             */
            function safeRemoveGroupFromInterface(groupId, groupName) {
                console.log('ÂÆâÂÖ®Âà†Èô§Áæ§ËÅäÁïåÈù¢ÂÖÉÁ¥†:', groupId, groupName);
                
                // Âè™Âà†Èô§ÁâπÂÆöÁöÑÁæ§ËÅäÂÖÉÁ¥†Ôºå‰øùÊä§‰∏ªË¶ÅÁöÑÁïåÈù¢ÁªìÊûÑ
                try {
                    // Âà†Èô§ËÅîÁ≥ª‰∫∫ÂàóË°®‰∏≠ÁöÑÁæ§ËÅä
                    const contactsContainer = document.getElementById('QQ_home_chars');
                    if (contactsContainer) {
                        const groupElements = contactsContainer.querySelectorAll('.QQ_home_char[data-group-type="true"]');
                        groupElements.forEach(element => {
                            const nameElement = element.querySelector('.QQ_home_name');
                            if (nameElement && nameElement.textContent.trim() === groupName) {
                                console.log('ÂÆâÂÖ®Âà†Èô§ËÅîÁ≥ª‰∫∫ÂàóË°®‰∏≠ÁöÑÁæ§ËÅä:', groupName);
                                element.remove();
                            }
                        });
                    }
                    
                    // Âà†Èô§Ê∂àÊÅØÂàóË°®‰∏≠ÁöÑÁæ§ËÅä
                    const messagesContainer = document.getElementById('QQ_message_list_chars');
                    if (messagesContainer) {
                        const groupElements = messagesContainer.querySelectorAll('.QQ_home_char[data-group-type="true"]');
                        groupElements.forEach(element => {
                            const nameElement = element.querySelector('.QQ_home_name');
                            if (nameElement && nameElement.textContent.trim() === groupName) {
                                console.log('ÂÆâÂÖ®Âà†Èô§Ê∂àÊÅØÂàóË°®‰∏≠ÁöÑÁæ§ËÅä:', groupName);
                                element.remove();
                            }
                        });
                    }
                    
                    // Âè™Âà†Èô§ÂΩìÂâçÁæ§ËÅäÁöÑ‰∏ìÁî®È°µÈù¢
                    const groupChatPages = document.querySelectorAll(`.group-chat-page[data-group-id="${groupId}"]`);
                    groupChatPages.forEach((page, index) => {
                        console.log(`ÂÆâÂÖ®Âà†Èô§Áæ§ËÅä‰∏ìÁî®È°µÈù¢ ${index + 1}:`, groupId);
                        page.remove();
                    });
                    
                    console.log('ÂÆâÂÖ®Âà†Èô§Áæ§ËÅäÁïåÈù¢ÂÖÉÁ¥†ÂÆåÊàê');
                    
                } catch (error) {
                    console.error('ÂÆâÂÖ®Âà†Èô§Áæ§ËÅäÁïåÈù¢ÂÖÉÁ¥†Êó∂Âá∫Èîô:', error);
                }
            }
            
            /**
             * Ë∞ÉËØïÂáΩÊï∞ÔºöÊµãËØïÁæ§ËÅäÂêçÁß∞ÁÇπÂáª
             */
            function testGroupNameClick() {
                if (window.currentGroupChat) {
                    const nameElements = document.querySelectorAll('.group-chat-clickable-name');
                    console.log('ÊâæÂà∞ÁöÑÂèØÁÇπÂáªÁæ§ËÅäÂêçÁß∞ÂÖÉÁ¥†:', nameElements.length);
                    nameElements.forEach((element, index) => {
                        console.log(`ÂÖÉÁ¥† ${index + 1}:`, element);
                        console.log('- ÊñáÊú¨ÂÜÖÂÆπ:', element.textContent);
                        console.log('- ÁÇπÂáª‰∫ã‰ª∂:', element._groupClickHandler ? 'Â∑≤ÁªëÂÆö' : 'Êú™ÁªëÂÆö');
                    });
                    
                    if (nameElements.length > 0) {
                        console.log('Ê®°ÊãüÁÇπÂáªÁ¨¨‰∏Ä‰∏™Áæ§ËÅäÂêçÁß∞...');
                        nameElements[0].click();
                    }
                } else {
                    console.log('ÂΩìÂâçÊ≤°ÊúâÁæ§ËÅäÔºåËØ∑ÂÖàËøõÂÖ•Áæ§ËÅäÁïåÈù¢');
                }
            }
            
            /**
             * Ë∞ÉËØïÂáΩÊï∞ÔºöÊ£ÄÊü•Áæ§ËÅäÊï∞ÊçÆ
             */
            async function debugGroupData() {
                const groups = await loadGroupsFromStorage();
                console.log('=== Áæ§ËÅäÊï∞ÊçÆË∞ÉËØï ===');
                console.log('Áæ§ËÅäÊÄªÊï∞:', groups.length);
                groups.forEach((group, index) => {
                    console.log(`Áæ§ËÅä ${index + 1}:`, {
                        id: group.id,
                        name: group.name,
                        members: group.members,
                        avatar: group.avatar
                    });
                });
                
                console.log('ÂΩìÂâçÁæ§ËÅä:', window.currentGroupChat);
                console.log('Êù•Ê∫êÈ°µÈù¢:', window.groupChatSourcePage);
            }
            
            /**
             * ÊòæÁ§∫Ê∑ªÂä†ÊàêÂëòÊ®°ÊÄÅÁ™óÂè£
             */
            function showAddMemberModal() {
                if (!currentManagingGroup) {
                    console.error('Ê≤°ÊúâÂΩìÂâçÁÆ°ÁêÜÁöÑÁæ§ËÅä');
                    return;
                }
                
                console.log('ÊòæÁ§∫Ê∑ªÂä†ÊàêÂëòÊ®°ÊÄÅÁ™óÂè£');
                
                const modal = document.getElementById('add_member_modal');
                if (!modal) {
                    console.error('Êú™ÊâæÂà∞Ê∑ªÂä†ÊàêÂëòÊ®°ÊÄÅÁ™óÂè£');
                    return;
                }
                
                // Ê∏ÖÁ©∫ÊêúÁ¥¢Ê°Ü
                const searchInput = document.getElementById('add_member_search_input');
                if (searchInput) {
                    searchInput.value = '';
                }
                
                // ÈáçÁΩÆÈÄâ‰∏≠Áä∂ÊÄÅ
                window.selectedMembersToAdd = [];
                updateAddMemberConfirmButton();
                
                // Âä†ËΩΩËÅîÁ≥ª‰∫∫ÂàóË°®
                loadContactsForAddMember();
                
                // ÊòæÁ§∫Ê®°ÊÄÅÁ™óÂè£
                modal.style.display = 'flex';
            }
            
            /**
             * ÂÖ≥Èó≠Ê∑ªÂä†ÊàêÂëòÊ®°ÊÄÅÁ™óÂè£
             */
            function closeAddMemberModal() {
                const modal = document.getElementById('add_member_modal');
                if (modal) {
                    modal.style.display = 'none';
                }
                
                // Ê∏ÖÁ©∫ÈÄâ‰∏≠Áä∂ÊÄÅ
                window.selectedMembersToAdd = [];
            }
            
            /**
             * Âä†ËΩΩËÅîÁ≥ª‰∫∫ÂàóË°®Áî®‰∫éÊ∑ªÂä†ÊàêÂëò
             */
            function loadContactsForAddMember() {
                const contactList = document.getElementById('add_member_contact_list');
                if (!contactList) {
                    console.error('Ê∑ªÂä†ÊàêÂëòËÅîÁ≥ª‰∫∫ÂàóË°®ÂÆπÂô®Êú™ÊâæÂà∞');
                    return;
                }
                
                contactList.innerHTML = '';
                
                // Ëé∑ÂèñÊâÄÊúâËÅîÁ≥ª‰∫∫
                const contactsContainer = document.getElementById('QQ_home_chars');
                if (!contactsContainer) {
                    console.error('ËÅîÁ≥ª‰∫∫ÂÆπÂô®Êú™ÊâæÂà∞');
                    return;
                }
                
                // *** ‰øÆÂ§çÔºö‰ΩøÁî®Ê≠£Á°ÆÁöÑÈÄâÊã©Âô® .QQ_home_usermsgÔºå‰∏éËÅîÁ≥ª‰∫∫ÁïåÈù¢ÊêúÁ¥¢‰øùÊåÅ‰∏ÄËá¥ ***
                const contactElements = contactsContainer.querySelectorAll('.QQ_home_usermsg');
                const currentMembers = new Set(currentManagingGroup.members);
                
                console.log(`ÊâæÂà∞ ${contactElements.length} ‰∏™ËÅîÁ≥ª‰∫∫ÔºåÂΩìÂâçÁæ§ËÅäÊàêÂëò:`, currentMembers);
                
                let addedCount = 0;
                contactElements.forEach(element => {
                    // Ë∑≥ËøáÁæ§ËÅäÁ±ªÂûãÁöÑËÅîÁ≥ª‰∫∫ÔºåÂè™Â§ÑÁêÜ‰∏™‰∫∫ËÅîÁ≥ª‰∫∫
                    if (element.hasAttribute('data-group-type')) {
                        return;
                    }
                    
                    const nameElement = element.querySelector('.QQ_home_name');
                    if (!nameElement) return;
                    
                    const contactName = nameElement.textContent.trim();
                    
                    // Ë∑≥ËøáÂ∑≤ÁªèÂú®Áæ§ËÅä‰∏≠ÁöÑÊàêÂëò
                    if (currentMembers.has(contactName)) {
                        console.log(`Ë∑≥ËøáÂ∑≤Â≠òÂú®ÊàêÂëò: ${contactName}`);
                        return;
                    }
                    
                    const contactItem = document.createElement('div');
                    contactItem.className = 'add-member-contact-item';
                    contactItem.setAttribute('data-contact-name', contactName);
                    
                    const contactAvatar = document.createElement('div');
                    contactAvatar.className = 'add-member-contact-avatar';
                    
                    // *** ‰øÆÂ§çÔºö‰ºòÂÖà‰ªé‰∏ñÁïå‰π¶Ëé∑ÂèñÂ§¥ÂÉèÔºåÁ°Æ‰øùÊòæÁ§∫Ê≠£Á°ÆÁöÑËßíËâ≤Â§¥ÂÉè ***
                    console.log(`‰∏∫ËÅîÁ≥ª‰∫∫ ${contactName} Ëé∑ÂèñÂ§¥ÂÉè`);
                    
                    // È¶ñÂÖàÂ∞ùËØï‰ªé‰∏ñÁïå‰π¶Ëé∑ÂèñÂ§¥ÂÉè
                    const worldbookAvatar = getCharacterAvatarFromWorldbook(contactName);
                    if (worldbookAvatar) {
                        console.log(`‰ªé‰∏ñÁïå‰π¶Ëé∑ÂèñÂà∞ ${contactName} ÁöÑÂ§¥ÂÉè:`, worldbookAvatar);
                        
                        // Â∫îÁî®‰∏ñÁïå‰π¶‰∏≠ÁöÑÂ§¥ÂÉè
                        contactAvatar.style.backgroundImage = worldbookAvatar.backgroundImage;
                        contactAvatar.style.backgroundSize = 'cover';
                        contactAvatar.style.backgroundPosition = 'center';
                        contactAvatar.style.backgroundRepeat = 'no-repeat';
                        contactAvatar.style.borderRadius = '50%';
                        contactAvatar.style.width = '40px';
                        contactAvatar.style.height = '40px';
                        contactAvatar.style.marginRight = '12px';
                        contactAvatar.style.flexShrink = '0';
                        contactAvatar.textContent = '';
                    } else {
                        // Â§áÈÄâÊñπÊ°àÔºö‰ªéËÅîÁ≥ª‰∫∫ÂàóË°®Â§çÂà∂Â§¥ÂÉè
                        const avatarElement = element.querySelector('.QQ_home_head');
                        if (avatarElement) {
                            console.log(`‰ªéËÅîÁ≥ª‰∫∫ÂàóË°®Â§çÂà∂ ${contactName} ÁöÑÂ§¥ÂÉè`);
                            
                            // Áõ¥Êé•Â§çÂà∂ÂéüÂßãÂ§¥ÂÉèÁöÑÊâÄÊúâÊ†∑ÂºèÂíåÂÜÖÂÆπ
                            contactAvatar.style.cssText = avatarElement.style.cssText;
                            contactAvatar.style.width = '40px';
                            contactAvatar.style.height = '40px';
                            contactAvatar.style.marginRight = '12px';
                            contactAvatar.style.flexShrink = '0';
                            contactAvatar.textContent = avatarElement.textContent;
                            
                            // Á°Æ‰øùËÉåÊôØÂõæÂÉèÂíåËÉåÊôØÊ†∑ÂºèÈÉΩÂ§çÂà∂ËøáÊù•
                            const computedStyle = window.getComputedStyle(avatarElement);
                            if (computedStyle.backgroundImage && computedStyle.backgroundImage !== 'none') {
                                contactAvatar.style.backgroundImage = computedStyle.backgroundImage;
                            }
                            if (computedStyle.backgroundColor && computedStyle.backgroundColor !== 'rgba(0, 0, 0, 0)') {
                                contactAvatar.style.backgroundColor = computedStyle.backgroundColor;
                            }
                        } else {
                            // ÊúÄÂêéÁöÑÂ§áÈÄâÊñπÊ°àÔºö‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè
                            console.log(`‰∏∫ ${contactName} ‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè`);
                            contactAvatar.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                            contactAvatar.style.backgroundImage = '';
                            contactAvatar.style.color = 'white';
                            contactAvatar.style.display = 'flex';
                            contactAvatar.style.alignItems = 'center';
                            contactAvatar.style.justifyContent = 'center';
                            contactAvatar.style.fontWeight = 'bold';
                            contactAvatar.style.borderRadius = '50%';
                            contactAvatar.style.width = '40px';
                            contactAvatar.style.height = '40px';
                            contactAvatar.style.marginRight = '12px';
                            contactAvatar.style.flexShrink = '0';
                            contactAvatar.textContent = contactName.charAt(0);
                        }
                    }
                    
                    const contactNameDiv = document.createElement('div');
                    contactNameDiv.className = 'add-member-contact-name';
                    contactNameDiv.textContent = contactName;
                    
                    const contactStatus = document.createElement('div');
                    contactStatus.className = 'add-member-contact-status';
                    contactStatus.textContent = 'ÁÇπÂáªÊ∑ªÂä†';
                    
                    contactItem.appendChild(contactAvatar);
                    contactItem.appendChild(contactNameDiv);
                    contactItem.appendChild(contactStatus);
                    
                    // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
                    contactItem.addEventListener('click', function() {
                        toggleMemberSelection(contactName, contactItem);
                    });
                    
                    contactList.appendChild(contactItem);
                    addedCount++;
                });
                
                console.log(`Â∑≤Âä†ËΩΩ ${addedCount} ‰∏™ÂèØÊ∑ªÂä†ÁöÑËÅîÁ≥ª‰∫∫`);
                
                // Â¶ÇÊûúÊ≤°ÊúâÂèØÊ∑ªÂä†ÁöÑËÅîÁ≥ª‰∫∫ÔºåÊòæÁ§∫ÊèêÁ§∫
                if (addedCount === 0) {
                    const noContactDiv = document.createElement('div');
                    noContactDiv.style.cssText = 'text-align: center; color: #999; padding: 20px; font-size: 14px;';
                    noContactDiv.textContent = 'ÊöÇÊó†ÂèØÊ∑ªÂä†ÁöÑËÅîÁ≥ª‰∫∫';
                    contactList.appendChild(noContactDiv);
                }
            }
            
            /**
             * ÂàáÊç¢ÊàêÂëòÈÄâ‰∏≠Áä∂ÊÄÅ
             */
            function toggleMemberSelection(contactName, contactItem) {
                if (!window.selectedMembersToAdd) {
                    window.selectedMembersToAdd = [];
                }
                
                const index = window.selectedMembersToAdd.indexOf(contactName);
                const statusElement = contactItem.querySelector('.add-member-contact-status');
                
                if (index > -1) {
                    // ÂèñÊ∂àÈÄâ‰∏≠
                    window.selectedMembersToAdd.splice(index, 1);
                    contactItem.classList.remove('selected');
                    statusElement.textContent = 'ÁÇπÂáªÊ∑ªÂä†';
                } else {
                    // ÈÄâ‰∏≠
                    window.selectedMembersToAdd.push(contactName);
                    contactItem.classList.add('selected');
                    statusElement.textContent = 'Â∑≤ÈÄâ‰∏≠';
                }
                
                updateAddMemberConfirmButton();
            }
            
            /**
             * Êõ¥Êñ∞Ê∑ªÂä†ÊàêÂëòÁ°ÆËÆ§ÊåâÈíÆÁä∂ÊÄÅ
             */
            function updateAddMemberConfirmButton() {
                const confirmBtn = document.getElementById('add_member_confirm_btn');
                if (!confirmBtn) return;
                
                const selectedCount = window.selectedMembersToAdd ? window.selectedMembersToAdd.length : 0;
                
                if (selectedCount > 0) {
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = `Ê∑ªÂä†ÊàêÂëò (${selectedCount})`;
                } else {
                    confirmBtn.disabled = true;
                    confirmBtn.textContent = 'Ê∑ªÂä†ÊàêÂëò';
                }
            }
            
            /**
             * ËøáÊª§Ê∑ªÂä†ÊàêÂëòËÅîÁ≥ª‰∫∫ÂàóË°®ÔºàÂèÇËÄÉËÅîÁ≥ª‰∫∫ÁïåÈù¢ÊêúÁ¥¢ÈÄªËæëÔºâ
             */
            function filterAddMemberContacts() {
                const searchInput = document.getElementById('add_member_search_input');
                const contactList = document.getElementById('add_member_contact_list');
                
                if (!searchInput || !contactList) {
                    console.log('ÊêúÁ¥¢ËæìÂÖ•Ê°ÜÊàñËÅîÁ≥ª‰∫∫ÂàóË°®Êú™ÊâæÂà∞');
                    return;
                }
                
                const searchTerm = searchInput.value.trim();
                const search = searchTerm.toLowerCase();
                const isEmpty = search === '';
                const contactItems = contactList.querySelectorAll('.add-member-contact-item');
                
                console.log(`=== Ê∑ªÂä†ÊàêÂëòÊêúÁ¥¢Ë∞ÉËØï ===`);
                console.log(`ÊêúÁ¥¢ËØç: "${searchTerm}"`);
                console.log(`ËÅîÁ≥ª‰∫∫ÊÄªÊï∞: ${contactItems.length}`);
                
                let visibleCount = 0;
                
                // ÁßªÈô§‰πãÂâçÁöÑÊó†ÁªìÊûúÊèêÁ§∫
                const existingNoResult = contactList.querySelector('.no-search-result');
                if (existingNoResult) {
                    existingNoResult.remove();
                }
                
                contactItems.forEach((item, index) => {
                    const nameElement = item.querySelector('.add-member-contact-name');
                    if (!nameElement) {
                        console.warn("ËÅîÁ≥ª‰∫∫È°πÁõÆÁº∫Â∞ëÂßìÂêçÂÖÉÁ¥†", item);
                        item.style.display = 'none';
                        return;
                    }
                    
                    // Ëé∑ÂèñÂéüÂßãÊñáÊú¨ÂÜÖÂÆπÔºàÂèÇËÄÉËÅîÁ≥ª‰∫∫ÊêúÁ¥¢ÈÄªËæëÔºâ
                    const originalName = nameElement.getAttribute('data-original-text') || nameElement.textContent;
                    const name = originalName.toLowerCase();
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÂåπÈÖçÊêúÁ¥¢Êù°‰ª∂
                    const nameMatches = isEmpty || name.includes(search);
                    const isMatch = nameMatches;
                    
                    if (isMatch) {
                        // ÊòæÁ§∫ËÅîÁ≥ª‰∫∫
                        item.style.display = 'flex';
                        visibleCount++;
                        
                        // Â§ÑÁêÜÈ´ò‰∫ÆÊòæÁ§∫ÔºàÂèÇËÄÉËÅîÁ≥ª‰∫∫ÊêúÁ¥¢ÁöÑÈ´ò‰∫ÆÈÄªËæëÔºâ
                        if (!isEmpty && nameMatches) {
                            highlightAddMemberSearchTerm(nameElement, searchTerm, originalName);
                        } else {
                            // ÊÅ¢Â§çÂéüÂßãÊñáÊú¨ÔºåÁßªÈô§È´ò‰∫Æ
                            if (nameElement.getAttribute('data-original-text')) {
                                nameElement.innerHTML = originalName;
                            }
                        }
                    } else {
                        // ÈöêËóè‰∏çÂåπÈÖçÁöÑËÅîÁ≥ª‰∫∫
                        item.style.display = 'none';
                    }
                });
                
                console.log(`ÊêúÁ¥¢"${searchTerm}": ÊâæÂà∞ ${visibleCount} ‰∏™ËÅîÁ≥ª‰∫∫`);
                
                // Â¶ÇÊûúÊêúÁ¥¢ÊúâÂÜÖÂÆπ‰ΩÜÊó†ÁªìÊûúÔºåÊòæÁ§∫ÊèêÁ§∫
                if (!isEmpty && visibleCount === 0) {
                    const noResultDiv = document.createElement('div');
                    noResultDiv.className = 'no-search-result';
                    noResultDiv.style.cssText = 'text-align: center; color: #999; padding: 20px; font-size: 14px; border: 1px dashed #ddd; border-radius: 8px; margin: 10px 0;';
                    noResultDiv.innerHTML = `
                        <div style="font-size: 16px; margin-bottom: 8px;">üîç</div>
                        <div>Êú™ÊâæÂà∞ÂåÖÂê´ "<strong>${searchTerm}</strong>" ÁöÑËÅîÁ≥ª‰∫∫</div>
                        <div style="font-size: 12px; color: #666; margin-top: 4px;">ËØ∑Â∞ùËØïËæìÂÖ•ÂÖ∂‰ªñÂÖ≥ÈîÆËØç</div>
                    `;
                    contactList.appendChild(noResultDiv);
                    console.log("Ê≤°ÊúâÊâæÂà∞ÂåπÈÖçÁöÑËÅîÁ≥ª‰∫∫");
                }
            }
            
            /**
             * Ê∑ªÂä†ÊàêÂëòÊêúÁ¥¢È´ò‰∫ÆÂäüËÉΩÔºàÂèÇËÄÉËÅîÁ≥ª‰∫∫ÊêúÁ¥¢È´ò‰∫ÆÈÄªËæëÔºâ
             */
            function highlightAddMemberSearchTerm(element, searchTerm, originalText) {
                if (!searchTerm || searchTerm.trim() === '') {
                    element.innerHTML = originalText;
                    return;
                }
                
                // ‰øùÂ≠òÂéüÂßãÊñáÊú¨
                if (!element.getAttribute('data-original-text')) {
                    element.setAttribute('data-original-text', originalText);
                }
                
                // ÂàõÂª∫È´ò‰∫ÆHTML
                const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                const highlightedText = originalText.replace(regex, '<span style="background-color: #FFE066; color: #333; font-weight: bold; padding: 1px 2px; border-radius: 2px;">$1</span>');
                
                element.innerHTML = highlightedText;
            }
            
            /**
             * Á°ÆËÆ§Ê∑ªÂä†ÊàêÂëò
             */
            async function confirmAddMembers() {
                if (!currentManagingGroup || !window.selectedMembersToAdd || window.selectedMembersToAdd.length === 0) {
                    return;
                }
                
                console.log('Ê∑ªÂä†ÊàêÂëòÂà∞Áæ§ËÅä:', window.selectedMembersToAdd);
                
                // ËÆ∞ÂΩïË¶ÅÊ∑ªÂä†ÁöÑÊñ∞ÊàêÂëòÔºàÁî®‰∫éÁ≥ªÁªüÊ∂àÊÅØÔºâ
                const newMembers = [];
                
                // Â∞ÜÈÄâ‰∏≠ÁöÑÊàêÂëòÊ∑ªÂä†Âà∞Áæ§ËÅä
                window.selectedMembersToAdd.forEach(memberName => {
                    if (!currentManagingGroup.members.includes(memberName)) {
                        currentManagingGroup.members.push(memberName);
                        newMembers.push(memberName);
                    }
                });
                
                // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                saveGroupToStorage(currentManagingGroup);
                
                // *** Êñ∞Â¢ûÔºöÊõ¥Êñ∞Âà∞‰∏ñÁïå‰π¶ ***
                await updateGroupMembersInWorldbook(currentManagingGroup.name, currentManagingGroup.members);
                
                // *** Á´ãÂç≥Êõ¥Êñ∞ÂΩìÂâçËÅäÂ§©ÁïåÈù¢ÔºàÂ¶ÇÊûúÊ≠£Âú®Áæ§ËÅä‰∏≠Ôºâ ***
                if (window.currentGroupChat && window.currentGroupChat.id === currentManagingGroup.id) {
                    console.log('Á´ãÂç≥Êõ¥Êñ∞ÂΩìÂâçÁæ§ËÅäÁïåÈù¢ÔºàÊ∑ªÂä†ÊàêÂëòÂêéÔºâ');
                    
                    // Êõ¥Êñ∞ÂΩìÂâçÁæ§ËÅäÂØπË±°
                    window.currentGroupChat.members = currentManagingGroup.members;
                    
                    // Á´ãÂç≥Êõ¥Êñ∞ËÅäÂ§©ÁïåÈù¢Â§¥ÈÉ®ÊòæÁ§∫ÔºàÂåÖÊã¨‰∫∫Êï∞Ôºâ
                    updateChatHeader(currentManagingGroup);
                    
                    console.log('Áæ§ËÅäÁïåÈù¢Â§¥ÈÉ®Â∑≤Á´ãÂç≥Êõ¥Êñ∞Ôºå‰∫∫Êï∞:', currentManagingGroup.members.length);
                }
                
                // *** ‰øÆÂ§çÔºö‰∏∫ÊØè‰∏™Êñ∞ÊàêÂëòÊ∑ªÂä†Á≥ªÁªüÊ∂àÊÅØÂπ∂Á´ãÂç≥ÊòæÁ§∫ ***
                if (newMembers.length > 0) {
                    console.log('Ê∑ªÂä†ÊàêÂëòÁ≥ªÁªüÊ∂àÊÅØ:', newMembers);
                    
                    for (const memberName of newMembers) {
                        const systemMessage = `Áæ§‰∏ªÈÇÄËØ∑${memberName}Âä†ÂÖ•Áæ§ËÅä`;
                        
                        // *** ‰øÆÂ§çÔºöÊÄªÊòØ‰øùÂ≠òÁ≥ªÁªüÊ∂àÊÅØÔºå‰∏ç‰æùËµñÁïåÈù¢Áä∂ÊÄÅÊ£ÄÊü• ***
                        console.log('‰øùÂ≠òÊ∑ªÂä†ÊàêÂëòÁ≥ªÁªüÊ∂àÊÅØ:', systemMessage);
                        await addSystemMessageToGroup(currentManagingGroup.id, systemMessage);
                        
                        // *** ‰øÆÂ§çÔºöÂº∫Âà∂Á´ãÂç≥ÊòæÁ§∫Á≥ªÁªüÊ∂àÊÅØ ***
                        console.log('Âº∫Âà∂Á´ãÂç≥ÊòæÁ§∫Ê∑ªÂä†ÊàêÂëòÁ≥ªÁªüÊ∂àÊÅØ:', systemMessage);
                        displaySystemMessage(systemMessage, currentManagingGroup.id);
                    }
                }
                
                        // *** Á´ãÂç≥Êõ¥Êñ∞ÊâÄÊúâÁïåÈù¢‰∏≠ÁöÑÁæ§ËÅäÊòæÁ§∫ ***
        console.log('Á´ãÂç≥Êõ¥Êñ∞ËÅîÁ≥ª‰∫∫ÂàóË°®‰∏≠ÁöÑÁæ§ËÅäÊòæÁ§∫ÔºàÊ∑ªÂä†ÊàêÂëòÂêéÔºâ...');
        
        // *** ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÁ°Æ‰øù‰º†ÈÄíÂÆåÊï¥ÁöÑÁæ§ËÅäÊï∞ÊçÆÔºåÂåÖÊã¨Â§¥ÂÉè‰ø°ÊÅØ ***
        console.log('‰º†ÈÄíÁªôprotectedContactListUpdateÁöÑÊï∞ÊçÆ:', {
            name: currentManagingGroup.name,
            id: currentManagingGroup.id,
            avatar: currentManagingGroup.avatar,
            members: currentManagingGroup.members
        });
        await protectedContactListUpdate(currentManagingGroup, 'add_member');
        
        // *** ËΩªÈáèÁ∫ßÁïåÈù¢Êõ¥Êñ∞ÔºåÈÅøÂÖçÊ∂àÊÅØ‰∏¢Â§± ***
        console.log('ÊâßË°åËΩªÈáèÁ∫ßÁïåÈù¢Êõ¥Êñ∞ÔºàÊ∑ªÂä†ÊàêÂëòÂêéÔºâ...');
        await refreshGroupChatsDisplay();
                
                console.log(`Â∑≤Ê∑ªÂä† ${newMembers.length} ‰∏™Êñ∞ÊàêÂëòÂà∞Áæ§ËÅä`);
                alert(`Â∑≤Ê∑ªÂä† ${newMembers.length} ‰∏™ÊàêÂëòÂà∞Áæ§ËÅä`);
                
                // ÂÖ≥Èó≠Ê®°ÊÄÅÁ™óÂè£
                closeAddMemberModal();
                
                // Âà∑Êñ∞Áæ§ËÅäËÆæÁΩÆÁïåÈù¢
                showGroupSettings();
            }

            /**
             * Ê∏ÖÁêÜlocalStorage‰∏≠ÁöÑËøáÊúüÂ§¥ÂÉèÊï∞ÊçÆ
             */
            function cleanupAvatarData() {
                try {
                    // Ëé∑ÂèñÊâÄÊúâlocalStorage‰∏≠ÁöÑÂ§¥ÂÉèÊï∞ÊçÆ
                    const avatarKeys = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('avatarData_')) {
                            avatarKeys.push(key);
                        }
                    }
                    
                    console.log('ÊâæÂà∞Â§¥ÂÉèÊï∞ÊçÆ:', avatarKeys.length, '‰∏™');
                    
                    // Ëé∑Âèñ‰∏ñÁïå‰π¶‰∏≠Ê≠£Âú®‰ΩøÁî®ÁöÑÂ§¥ÂÉèID
                    const usedAvatarIds = new Set();
                    if (entries && worldbook) {
                        const entry = entries.find(e => e.key === "ÊâãÊú∫-ËßíËâ≤");
                        if (entry && entry.content) {
                            const lines = entry.content.split('\n');
                            lines.forEach(line => {
                                if (line.startsWith('Â§¥ÂÉè=avatar_')) {
                                    const avatarId = line.substring(3);
                                    usedAvatarIds.add('avatarData_' + avatarId);
                                }
                            });
                        }
                    } else {
                        console.log('cleanupAvatarData: entriesÊàñworldbookÊú™ÂàùÂßãÂåñÔºåË∑≥Ëøá‰∏ñÁïå‰π¶Ê£ÄÊü•');
                    }
                    
                    console.log('Ê≠£Âú®‰ΩøÁî®ÁöÑÂ§¥ÂÉèID:', usedAvatarIds.size, '‰∏™');
                    
                    // Âà†Èô§Êú™‰ΩøÁî®ÁöÑÂ§¥ÂÉèÊï∞ÊçÆ
                    let deletedCount = 0;
                    avatarKeys.forEach(key => {
                        if (!usedAvatarIds.has(key)) {
                            localStorage.removeItem(key);
                            deletedCount++;
                            console.log('Âà†Èô§Êú™‰ΩøÁî®ÁöÑÂ§¥ÂÉèÊï∞ÊçÆ:', key);
                        }
                    });
                    
                    console.log('Ê∏ÖÁêÜÂÆåÊàêÔºåÂà†Èô§‰∫Ü', deletedCount, '‰∏™Êú™‰ΩøÁî®ÁöÑÂ§¥ÂÉèÊï∞ÊçÆ');
                } catch (error) {
                    console.error('Ê∏ÖÁêÜÂ§¥ÂÉèÊï∞ÊçÆÂ§±Ë¥•:', error);
                }
            }
            
            /**
             * Ëé∑ÂèñlocalStorage‰ΩøÁî®ÊÉÖÂÜµ
             */
            function getStorageUsage() {
                try {
                    let totalSize = 0;
                    let avatarSize = 0;
                    let avatarCount = 0;
                    
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        const value = localStorage.getItem(key);
                        const size = (key.length + value.length) * 2; // ‰º∞ÁÆóÂ≠óËäÇÊï∞
                        totalSize += size;
                        
                        if (key.startsWith('avatarData_')) {
                            avatarSize += size;
                            avatarCount++;
                        }
                    }
                    
                    console.log('localStorage‰ΩøÁî®ÊÉÖÂÜµ:');
                    console.log('- ÊÄªÂ§ßÂ∞è:', (totalSize / 1024 / 1024).toFixed(2), 'MB');
                    console.log('- Â§¥ÂÉèÊï∞ÊçÆÂ§ßÂ∞è:', (avatarSize / 1024 / 1024).toFixed(2), 'MB');
                    console.log('- Â§¥ÂÉèÊï∞Èáè:', avatarCount, '‰∏™');
                    
                    return {
                        totalSize,
                        avatarSize,
                        avatarCount
                    };
                } catch (error) {
                    console.error('Ëé∑ÂèñÂ≠òÂÇ®‰ΩøÁî®ÊÉÖÂÜµÂ§±Ë¥•:', error);
                    return null;
                }
            }

            // Â∞ÜÂáΩÊï∞Ê∑ªÂä†Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü
            window.showGroupManagementMenu = showGroupManagementMenu;
            window.closeGroupManagementMenu = closeGroupManagementMenu;
            window.showGroupSettings = showGroupSettings;
            window.closeGroupSettings = closeGroupSettings;
            window.saveGroupSettings = saveGroupSettings;
            window.deleteContactGroup = deleteContactGroup;
            window.deleteGroupChat = deleteGroupChat;
            window.deleteCurrentGroup = deleteCurrentGroup;
            window.showAddMemberModal = showAddMemberModal;
            window.closeAddMemberModal = closeAddMemberModal;
            window.filterAddMemberContacts = filterAddMemberContacts;
            window.confirmAddMembers = confirmAddMembers;
            window.testGroupNameClick = testGroupNameClick;
            window.debugGroupData = debugGroupData;
            window.cleanupAvatarData = cleanupAvatarData;
            window.getStorageUsage = getStorageUsage;
            
            // Ë∞ÉËØïÔºöÊ£ÄÊü•ÂáΩÊï∞ÊòØÂê¶Ê≠£Á°ÆÂÆö‰πâ
            console.log('üîß ÂÖ®Â±ÄÂáΩÊï∞Ê£ÄÊü•:');
            console.log('- confirmAvatarSelection:', typeof window.confirmAvatarSelection);
            console.log('- createGroupChat:', typeof window.createGroupChat);
            console.log('- showGroupManagementMenu:', typeof window.showGroupManagementMenu);
            console.log('- saveGroupToStorage:', typeof saveGroupToStorage);
            console.log('- addGroupToContactList:', typeof addGroupToContactList);
            console.log('- addGroupToMessageList:', typeof addGroupToMessageList);
            
            // Ë∞ÉËØïÔºöÊ£ÄÊü•ÊåâÈíÆÊòØÂê¶Â≠òÂú®
            setTimeout(() => {
                const avatarBtn = document.getElementById('avatar_confirm_btn');
                const groupBtn = document.getElementById('group_confirm_btn');
                console.log('üîß ÊåâÈíÆÊ£ÄÊü•:');
                console.log('- avatar_confirm_btn:', avatarBtn ? 'Â≠òÂú®' : '‰∏çÂ≠òÂú®');
                console.log('- group_confirm_btn:', groupBtn ? 'Â≠òÂú®' : '‰∏çÂ≠òÂú®');
                
                if (avatarBtn) {
                    console.log('- avatarÊåâÈíÆonclick:', avatarBtn.getAttribute('onclick'));
                }
                if (groupBtn) {
                    console.log('- groupÊåâÈíÆonclick:', groupBtn.getAttribute('onclick'));
                }
            }, 1000);
            
            /**
             * ===== Â¢ûÂº∫ÁöÑ‰∏ñÁïå‰π¶Êï∞ÊçÆÁÆ°ÁêÜÁ≥ªÁªü =====
             */
            
            /**
             * ÂÆâÂÖ®Âú∞‰øùÂ≠òÊï∞ÊçÆÂà∞‰∏ñÁïå‰π¶
             */
            async function QQ_SafeSaveToWorldBook(operation, data, key) {
                try {
                    if (!QQ_IsWorldBookAvailable()) {
                        console.warn(`‰∏ñÁïå‰π¶ÂäüËÉΩ‰∏çÂèØÁî®ÔºåÊó†Ê≥ï‰øùÂ≠ò${operation}`);
                        return false;
                    }
                    
                    // Ëé∑Âèñ‰∏ñÁïå‰π¶Êù°ÁõÆ
                    const entries = await getLorebookEntries(worldbook);
                    if (!entries) {
                        console.warn('Êó†Ê≥ïËé∑Âèñ‰∏ñÁïå‰π¶Êù°ÁõÆ');
                        return false;
                    }
                    
                    // ÂàõÂª∫‰∏ñÁïå‰π¶Êù°ÁõÆÊï∞ÊçÆ
                    const entryData = {
                        data: data,
                        operation: operation,
                        timestamp: new Date().toISOString(),
                        version: "1.0"
                    };
                    
                    // Êü•ÊâæÊàñÂàõÂª∫‰∏ñÁïå‰π¶Êù°ÁõÆ
                    let entry = entries.find(e => e.comment === key);
                    
                    if (!entry) {
                        // ÂàõÂª∫Êñ∞Êù°ÁõÆ
                        entry = {
                            comment: key,
                            content: JSON.stringify(entryData),
                            key: [`Ê≠§‰∏ñÁïå‰π¶Ê∞∏‰∏çËß¶Âèë_${key}`],
                            keysecondary: [],
                            order: 1000 + entries.length,
                            enabled: true,
                            uid: Date.now() + Math.random()
                        };
                        // Ê∑ªÂä†Âà∞worldbook.entriesÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
                        if (worldbook.entries) {
                            worldbook.entries.push(entry);
                        }
                        console.log(`ÂàõÂª∫Êñ∞‰∏ñÁïå‰π¶Êù°ÁõÆ: ${key}`);
                    } else {
                        // Êõ¥Êñ∞Áé∞ÊúâÊù°ÁõÆ
                        entry.content = JSON.stringify(entryData);
                        console.log(`Êõ¥Êñ∞‰∏ñÁïå‰π¶Êù°ÁõÆ: ${key}`);
                    }
                    
                    // Ëß¶Âèë‰øùÂ≠ò
                    if (typeof saveWorldInfo === 'function') {
                        saveWorldInfo();
                    }
                    
                    console.log(`${operation}Â∑≤ÊàêÂäü‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶ (${key})`);
                    return true;
                } catch (error) {
                    console.error(`‰øùÂ≠ò${operation}Âà∞‰∏ñÁïå‰π¶Â§±Ë¥•:`, error);
                    return false;
                }
            }
            
            /**
             * ‰ªé‰∏ñÁïå‰π¶Ëé∑ÂèñÊï∞ÊçÆ
             */
            async function QQ_GetFromWorldBook(key) {
                try {
                    if (!QQ_IsWorldBookAvailable()) {
                        return null;
                    }
                    
                    // Ëé∑Âèñ‰∏ñÁïå‰π¶Êù°ÁõÆ
                    const entries = await getLorebookEntries(worldbook);
                    if (!entries) {
                        console.warn('Êó†Ê≥ïËé∑Âèñ‰∏ñÁïå‰π¶Êù°ÁõÆ');
                        return null;
                    }
                    
                    const entry = entries.find(e => e.comment === key);
                    if (entry && entry.content) {
                        const entryData = JSON.parse(entry.content);
                        return entryData.data;
                    }
                    
                    return null;
                } catch (error) {
                    console.error(`‰ªé‰∏ñÁïå‰π¶ËØªÂèñÊï∞ÊçÆÂ§±Ë¥• (${key}):`, error);
                    return null;
                }
            }
            
            /**
             * ===== ÂêÑÁ±ªÊï∞ÊçÆ‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶ÁöÑÂäüËÉΩ =====
             */
            
            /**
             * ‰øùÂ≠òÊâÄÊúâËÅîÁ≥ª‰∫∫Âà∞‰∏ñÁïå‰π¶
             */
            function QQ_SaveAllContactsToWorldBook() {
                const contacts = window.QQ_Contacts || {};
                return QQ_SafeSaveToWorldBook('ËÅîÁ≥ª‰∫∫Êï∞ÊçÆ', contacts, 'QQ_ËÅîÁ≥ª‰∫∫Êï∞ÊçÆ');
            }
            
            /**
             * ‰øùÂ≠òÊâÄÊúâÁæ§ËÅäÂà∞‰∏ñÁïå‰π¶
             */
            function QQ_SaveAllGroupsToWorldBook() {
                const groups = window.QQ_Groups || {};
                return QQ_SafeSaveToWorldBook('Áæ§ËÅäÊï∞ÊçÆ', groups, 'QQ_Áæ§ËÅäÊï∞ÊçÆ');
            }
            
            /**
             * ‰øùÂ≠òÊâÄÊúâÊ∂àÊÅØÂà∞‰∏ñÁïå‰π¶
             */
            function QQ_SaveAllMessagesToWorldBook() {
                const messages = window.QQ_MessageHistory || {};
                return QQ_SafeSaveToWorldBook('Ê∂àÊÅØËÆ∞ÂΩï', messages, 'QQ_Ê∂àÊÅØËÆ∞ÂΩï');
            }
            
            /**
             * ‰øùÂ≠òÊâÄÊúâÂä®ÊÄÅÂà∞‰∏ñÁïå‰π¶
             */
            function QQ_SaveAllMomentsToWorldBook() {
                const moments = window.QQ_MomentData || {};
                return QQ_SafeSaveToWorldBook('Âä®ÊÄÅÊï∞ÊçÆ', moments, 'QQ_Âä®ÊÄÅÊï∞ÊçÆ');
            }
            
            /**
             * ‰øùÂ≠òÊâÄÊúâ‰∫íÂä®Á©∫Èó¥Âà∞‰∏ñÁïå‰π¶
             */
            function QQ_SaveAllInteractiveSpacesToWorldBook() {
                const spaces = window.QQ_InteractiveSpaces || {};
                const characterSpaces = window.QQ_CharacterSpaces || {};
                
                const allSpaces = {
                    publicSpaces: spaces,
                    characterSpaces: characterSpaces
                };
                
                return QQ_SafeSaveToWorldBook('‰∫íÂä®Á©∫Èó¥Êï∞ÊçÆ', allSpaces, 'QQ_‰∫íÂä®Á©∫Èó¥Êï∞ÊçÆ');
            }
            
            /**
             * ‰øùÂ≠òÂàÜÁªÑÊï∞ÊçÆÂà∞‰∏ñÁïå‰π¶
             */
            function QQ_SaveContactGroupsToWorldBook(characterId, groups) {
                const key = `QQ_ÂàÜÁªÑÊï∞ÊçÆ_${characterId}`;
                return QQ_SafeSaveToWorldBook('ËÅîÁ≥ª‰∫∫ÂàÜÁªÑ', groups, key);
            }
            
            /**
             * ‰ªé‰∏ñÁïå‰π¶Âä†ËΩΩÂàÜÁªÑÊï∞ÊçÆ
             */
            function QQ_LoadContactGroupsFromWorldBook(characterId) {
                const key = `QQ_ÂàÜÁªÑÊï∞ÊçÆ_${characterId}`;
                return QQ_GetFromWorldBook(key) || [];
            }
            
            /**
             * ===== ‰øÆÂ§ç‰∫íÂä®ÂÜÖÂÆπ‰øùÂ≠òÂäüËÉΩ =====
             */
            
            /**
             * ‰øùÂ≠òÂçï‰∏™‰∫íÂä®ÂÜÖÂÆπÂà∞‰∏ñÁïå‰π¶ - ‰ΩøÁî®Á±ª‰ººÂä®ÊÄÅ‰øùÂ≠òÁöÑÂèØÈù†ÊñπÂºè
             */
            async function QQ_SaveInteractiveContentToWorldBook(content, characterName = null) {
                try {
                    if (!worldbook) {
                        console.warn('‰∏ñÁïå‰π¶ÂäüËÉΩ‰∏çÂèØÁî®ÔºåÊó†Ê≥ï‰øùÂ≠ò‰∫íÂä®ÂÜÖÂÆπ');
                        return null;
                    }
                    
                    // Ëé∑Âèñ‰∏ñÁïå‰π¶Êù°ÁõÆ
                    const entries = await getLorebookEntries(worldbook);
                    if (!entries) {
                        console.warn('Êó†Ê≥ïËé∑Âèñ‰∏ñÁïå‰π¶Êù°ÁõÆ');
                        return null;
                    }
                    
                    const interactiveData = {
                        content: content,
                        characterName: characterName,
                        timestamp: new Date().toISOString(),
                        id: `interactive_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        type: characterName ? 'character_specific' : 'public'
                    };
                    
                    // *** ‰ΩøÁî®Âä®ÊÄÅ‰øùÂ≠òÁöÑÁõ∏ÂêåÊú∫Âà∂ ***
                    const key = characterName ? 
                        `ËßíËâ≤-‰∫íÂä®Á©∫Èó¥Â§á‰ªΩ-${characterName}` : 
                        'ËßíËâ≤-‰∫íÂä®Á©∫Èó¥Â§á‰ªΩ';
                    
                    // Êü•ÊâæÁé∞ÊúâÊù°ÁõÆ
                    let interactiveEntry = entries.find(entry => entry.comment === key);
                    
                    let existingData = [];
                    if (interactiveEntry && interactiveEntry.content) {
                        try {
                            existingData = JSON.parse(interactiveEntry.content);
                        } catch (parseError) {
                            console.error('Ëß£ÊûêÁé∞Êúâ‰∫íÂä®Êï∞ÊçÆÂ§±Ë¥•:', parseError);
                            existingData = [];
                        }
                    }
                    
                    // Á°Æ‰øùÊòØÊï∞ÁªÑÊ†ºÂºè
                    if (!Array.isArray(existingData)) {
                        existingData = [];
                    }
                    
                    // Ê∑ªÂä†Êñ∞Êï∞ÊçÆÂà∞Êï∞ÁªÑÂºÄÂ§¥ÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÈù¢Ôºâ
                    existingData.unshift(interactiveData);
                    
                    // ÈôêÂà∂Êï∞ÈáèÔºàÊúÄÂ§ö30‰∏™Ôºâ
                    if (existingData.length > 30) {
                        existingData = existingData.slice(0, 30);
                    }
                    
                    const interactiveJson = JSON.stringify(existingData, null, 2);
                    console.log(`ÂáÜÂ§á‰øùÂ≠ò‰∫íÂä®ÂÜÖÂÆπ: ${characterName || 'ÂÖ¨ÂÖ±'}, ÊÄªËÆ°${existingData.length}‰∏™‰∫íÂä®`);
                    
                    if (interactiveEntry) {
                        // Êõ¥Êñ∞Áé∞ÊúâÊù°ÁõÆ
                        await setLorebookEntries(worldbook, [{
                            uid: interactiveEntry.uid,
                            content: interactiveJson,
                        }]);
                        console.log(`‚úÖ ‰∫íÂä®ÂÜÖÂÆπÂ∑≤Êõ¥Êñ∞Âà∞Áé∞Êúâ‰∏ñÁïå‰π¶Êù°ÁõÆ: ${key}`);
                    } else {
                        // ÂàõÂª∫Êñ∞Êù°ÁõÆ
                        await createLorebookEntry(worldbook, {
                            comment: key,
                            key: [`Ê≠§‰∏ñÁïå‰π¶Ê∞∏‰∏çËß¶Âèë_‰∫íÂä®${characterName || 'ÂÖ¨ÂÖ±'}`],
                            content: interactiveJson,
                            position: "at_depth_as_system",
                            type: "selective",
                            depth: 0,
                            exclude_recursion: true,
                            order: 9998,
                            enabled: true,
                        });
                        console.log(`‚úÖ ‰∫íÂä®ÂÜÖÂÆπÂ∑≤‰øùÂ≠òÂà∞Êñ∞‰∏ñÁïå‰π¶Êù°ÁõÆ: ${key}`);
                    }
                    
                    console.log(`üéØ ‰∫íÂä®ÂÜÖÂÆπ‰øùÂ≠òÊàêÂäü: ${characterName || 'ÂÖ¨ÂÖ±'}, ID: ${interactiveData.id}`);
                    return interactiveData.id;
                    
                } catch (error) {
                    console.error('‰øùÂ≠ò‰∫íÂä®ÂÜÖÂÆπÂà∞‰∏ñÁïå‰π¶Â§±Ë¥•:', error);
                    return null;
                }
            }
            
            /**
             * ‰ªé‰∏ñÁïå‰π¶Âä†ËΩΩ‰∫íÂä®ÂÜÖÂÆπ
             */
            function QQ_LoadInteractiveContentFromWorldBook(characterName = null) {
                try {
                    const key = characterName ? 
                        `QQ_ËßíËâ≤‰∫íÂä®Á©∫Èó¥_${characterName}` : 
                        'QQ_ÂÖ¨ÂÖ±‰∫íÂä®Á©∫Èó¥';
                    
                    const data = QQ_GetFromWorldBook(key);
                    
                    if (Array.isArray(data)) {
                        console.log(`‰ªé‰∏ñÁïå‰π¶Âä†ËΩΩ‰∫Ü ${data.length} ‰∏™${characterName || 'ÂÖ¨ÂÖ±'}‰∫íÂä®ÂÜÖÂÆπ`);
                        return data;
                    }
                    
                    return [];
                } catch (error) {
                    console.error('‰ªé‰∏ñÁïå‰π¶Âä†ËΩΩ‰∫íÂä®ÂÜÖÂÆπÂ§±Ë¥•:', error);
                    return [];
                }
            }
            
            /**
             * ===== ‰øÆÂ§çÂàÜÁªÑ‰øùÂ≠òÂäüËÉΩ =====
             */
            
            // ÈáçÂÜôÂàÜÁªÑ‰øùÂ≠òÂáΩÊï∞Á°Æ‰øù‰ΩøÁî®‰∏ñÁïå‰π¶
            window.saveGroupsToStorage = async function() {
                try {
                    const characterId = getCurrentCharacterId() || 'default';
                    console.log(`üîÑ ‰øùÂ≠òÂàÜÁªÑÂà∞‰∏ñÁïå‰π¶ÔºåËßíËâ≤ID: ${characterId}, ÂàÜÁªÑÊï∞Èáè: ${contactGroups.length}`);
                    
                    const success = QQ_SaveContactGroupsToWorldBook(characterId, contactGroups);
                    
                    if (success) {
                        console.log(`‚úÖ ËßíËâ≤ ${characterId} ÁöÑÂàÜÁªÑÊï∞ÊçÆÂ∑≤‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶`);
                        console.log('üìä ÂàÜÁªÑËØ¶ÊÉÖ:', contactGroups.map(g => `${g.name}(${g.contacts.length}‰∫∫)`).join(', '));
                    } else {
                        console.error('‚ùå ÂàÜÁªÑÊï∞ÊçÆ‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶Â§±Ë¥•');
                    }
                } catch (error) {
                    console.error('üí• ‰øùÂ≠òÂàÜÁªÑÂà∞‰∏ñÁïå‰π¶Êó∂Âá∫Èîô:', error);
                }
            };
            
            /**
             * *** Êñ∞Â¢ûÔºöÂº∫Âà∂ÈáçÊñ∞Âä†ËΩΩÂàÜÁªÑÊï∞ÊçÆ ***
             */
            window.QQ_ForceReloadContactGroups = async function() {
                try {
                    const characterId = getCurrentCharacterId() || 'default';
                    console.log(`üîÑ Âº∫Âà∂‰ªé‰∏ñÁïå‰π¶ÈáçÊñ∞Âä†ËΩΩÂàÜÁªÑÊï∞ÊçÆÔºåËßíËâ≤ID: ${characterId}`);
                    
                    // Ê∏ÖÁ©∫ÂÜÖÂ≠òÁºìÂ≠ò
                    contactGroups.length = 0;
                    
                    // ‰ªé‰∏ñÁïå‰π¶ÈáçÊñ∞Âä†ËΩΩ
                    const groups = QQ_LoadContactGroupsFromWorldBook(characterId);
                    
                    if (groups && Array.isArray(groups)) {
                        contactGroups.push(...groups);
                        console.log(`‚úÖ ‰ªé‰∏ñÁïå‰π¶ÈáçÊñ∞Âä†ËΩΩ‰∫Ü ${groups.length} ‰∏™ÂàÜÁªÑ`);
                        console.log('üìä ÂàÜÁªÑËØ¶ÊÉÖ:', groups.map(g => `${g.name}(${g.contacts.length}‰∫∫)`).join(', '));
                    } else {
                        console.log('üìã ‰∏ñÁïå‰π¶‰∏≠Ê≤°ÊúâÊâæÂà∞ÂàÜÁªÑÊï∞ÊçÆ');
                    }
                    
                    return contactGroups;
                } catch (error) {
                    console.error('üí• Âº∫Âà∂ÈáçÊñ∞Âä†ËΩΩÂàÜÁªÑÊï∞ÊçÆÂ§±Ë¥•:', error);
                    return [];
                }
            };
            
            // ÈáçÂÜôÂàÜÁªÑÂä†ËΩΩÂáΩÊï∞Á°Æ‰øù‰ªé‰∏ñÁïå‰π¶ËØªÂèñ
            window.loadGroupsFromStorage = function() {
                try {
                    const characterId = getCurrentCharacterId() || 'default';
                    console.log(`‰ªé‰∏ñÁïå‰π¶Âä†ËΩΩÂàÜÁªÑÔºåËßíËâ≤ID: ${characterId}`);
                    
                    const groups = QQ_LoadContactGroupsFromWorldBook(characterId);
                    
                    if (groups && Array.isArray(groups)) {
                        contactGroups.length = 0; // Ê∏ÖÁ©∫Áé∞ÊúâÊï∞ÁªÑ
                        contactGroups.push(...groups); // Ê∑ªÂä†‰ªé‰∏ñÁïå‰π¶Âä†ËΩΩÁöÑÊï∞ÊçÆ
                        console.log(`‰ªé‰∏ñÁïå‰π¶Âä†ËΩΩ‰∫Ü ${groups.length} ‰∏™ÂàÜÁªÑ`);
                    } else {
                        console.log('‰∏ñÁïå‰π¶‰∏≠Ê≤°ÊúâÊâæÂà∞ÂàÜÁªÑÊï∞ÊçÆÔºå‰ΩøÁî®ÈªòËÆ§Á©∫Êï∞ÁªÑ');
                        contactGroups.length = 0;
                    }
                } catch (error) {
                    console.error('‰ªé‰∏ñÁïå‰π¶Âä†ËΩΩÂàÜÁªÑÊó∂Âá∫Èîô:', error);
                    contactGroups.length = 0;
                }
            };
            
            /**
             * ===== Êï∞ÊçÆÁÆ°ÁêÜÂíåË∞ÉËØïÂ∑•ÂÖ∑ =====
             */
            
            /**
             * ÊòæÁ§∫‰∏ñÁïå‰π¶Êï∞ÊçÆÁªüËÆ°
             */
            window.QQ_Show_WorldBook_Stats = function() {
                try {
                    if (!QQ_IsWorldBookAvailable()) {
                        console.log('‚ùå ‰∏ñÁïå‰π¶ÂäüËÉΩ‰∏çÂèØÁî®');
                        return;
                    }
                    
                    console.log('=== ‰∏ñÁïå‰π¶Êï∞ÊçÆÁªüËÆ° ===');
                    
                    const stats = {
                        ÊÄªÊù°ÁõÆÊï∞: 0,
                        QQÁõ∏ÂÖ≥Êù°ÁõÆ: 0,
                        Êï∞ÊçÆÁ±ªÂûã: {}
                    };
                    
                    if (worldbook && worldbook.entries) {
                        stats.ÊÄªÊù°ÁõÆÊï∞ = worldbook.entries.length;
                        
                        worldbook.entries.forEach(entry => {
                            if (entry.comment && entry.comment.includes('QQ_')) {
                                stats.QQÁõ∏ÂÖ≥Êù°ÁõÆ++;
                                
                                // ÁªüËÆ°Êï∞ÊçÆÁ±ªÂûã
                                if (entry.comment.includes('ËÅîÁ≥ª‰∫∫')) {
                                    stats.Êï∞ÊçÆÁ±ªÂûã.ËÅîÁ≥ª‰∫∫ = (stats.Êï∞ÊçÆÁ±ªÂûã.ËÅîÁ≥ª‰∫∫ || 0) + 1;
                                } else if (entry.comment.includes('Áæ§ËÅä')) {
                                    stats.Êï∞ÊçÆÁ±ªÂûã.Áæ§ËÅä = (stats.Êï∞ÊçÆÁ±ªÂûã.Áæ§ËÅä || 0) + 1;
                                } else if (entry.comment.includes('Ê∂àÊÅØ')) {
                                    stats.Êï∞ÊçÆÁ±ªÂûã.Ê∂àÊÅØ = (stats.Êï∞ÊçÆÁ±ªÂûã.Ê∂àÊÅØ || 0) + 1;
                                } else if (entry.comment.includes('Âä®ÊÄÅ')) {
                                    stats.Êï∞ÊçÆÁ±ªÂûã.Âä®ÊÄÅ = (stats.Êï∞ÊçÆÁ±ªÂûã.Âä®ÊÄÅ || 0) + 1;
                                } else if (entry.comment.includes('‰∫íÂä®')) {
                                    stats.Êï∞ÊçÆÁ±ªÂûã.‰∫íÂä®Á©∫Èó¥ = (stats.Êï∞ÊçÆÁ±ªÂûã.‰∫íÂä®Á©∫Èó¥ || 0) + 1;
                                } else if (entry.comment.includes('ÂàÜÁªÑ')) {
                                    stats.Êï∞ÊçÆÁ±ªÂûã.ÂàÜÁªÑ = (stats.Êï∞ÊçÆÁ±ªÂûã.ÂàÜÁªÑ || 0) + 1;
                                } else {
                                    stats.Êï∞ÊçÆÁ±ªÂûã.ÂÖ∂‰ªñ = (stats.Êï∞ÊçÆÁ±ªÂûã.ÂÖ∂‰ªñ || 0) + 1;
                                }
                            }
                        });
                    }
                    
                    console.log(stats);
                    
                    const message = `üìä ‰∏ñÁïå‰π¶Êï∞ÊçÆÁªüËÆ°
ÊÄªÊù°ÁõÆÊï∞: ${stats.ÊÄªÊù°ÁõÆÊï∞}
QQÁõ∏ÂÖ≥Êù°ÁõÆ: ${stats.QQÁõ∏ÂÖ≥Êù°ÁõÆ}

Êï∞ÊçÆÁ±ªÂûãÂàÜÂ∏É:
${Object.entries(stats.Êï∞ÊçÆÁ±ªÂûã).map(([type, count]) => `‚Ä¢ ${type}: ${count}‰∏™`).join('\n')}`;
                    
                    alert(message);
                    
                } catch (error) {
                    console.error('ÊòæÁ§∫‰∏ñÁïå‰π¶ÁªüËÆ°Â§±Ë¥•:', error);
                }
            };
            
            /**
             * ÊâãÂä®Ëß¶ÂèëÊï∞ÊçÆÂêåÊ≠•
             */
            window.QQ_Manual_Sync_All_Data = function() {
                console.log('üîÑ ÂºÄÂßãÊâãÂä®ÂêåÊ≠•ÊâÄÊúâÊï∞ÊçÆÂà∞‰∏ñÁïå‰π¶...');
                QQ_SyncAllData();
            };
            
            // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéËá™Âä®Ê£ÄÊü•‰∏ñÁïå‰π¶Áä∂ÊÄÅ
            $(document).ready(function() {
                setTimeout(() => {
                    console.log('üîç Ê£ÄÊü•‰∏ñÁïå‰π¶Áä∂ÊÄÅ...');
                    if (QQ_IsWorldBookAvailable()) {
                        console.log('‚úÖ ‰∏ñÁïå‰π¶ÂäüËÉΩÊ≠£Â∏∏');
                        // ÂèØÈÄâÔºöËá™Âä®Âä†ËΩΩÂàÜÁªÑÊï∞ÊçÆ
                        if (typeof loadGroupsFromStorage === 'function') {
                            loadGroupsFromStorage();
                        }
                    } else {
                        console.warn('‚ö†Ô∏è ‰∏ñÁïå‰π¶ÂäüËÉΩ‰∏çÂèØÁî®ÔºåÊï∞ÊçÆ‰øùÂ≠òÂèØËÉΩÂèóÂΩ±Âìç');
                    }
                }, 2000);
            });
            
            /**
             * ===== ‰øÆÂ§çÁî®Êà∑Âêç‰∏ãÊãâËèúÂçïÂäüËÉΩ =====
             */
            
            /**
             * *** ‰øÆÊîπÔºöÁÇπÂáªÁî®Êà∑ÂêçÊòæÁ§∫Á≤æÁÅµ ***
             */
            function QQ_ToggleUserMenu() {
                console.log('ÁÇπÂáªÁî®Êà∑ÂêçÔºåÊòæÁ§∫Áî®Êà∑Á≤æÁÅµ');
                
                // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®Á≤æÁÅµ
                let existingSpirit = document.getElementById('QQ_user_spirit');
                if (existingSpirit) {
                    existingSpirit.remove();
                    return;
                }
                
                QQ_ShowUserSpirit();
            }
            
            /**
             * *** Êñ∞Â¢ûÔºöÊòæÁ§∫Áî®Êà∑Á≤æÁÅµ ***
             */
            function QQ_ShowUserSpirit() {
                // ÁßªÈô§Áé∞ÊúâÁ≤æÁÅµ
                const existingSpirit = document.getElementById('QQ_user_spirit');
                if (existingSpirit) {
                    existingSpirit.remove();
                }
                
                // Ëé∑ÂèñÁî®Êà∑ÂêçÂíåÂ§¥ÂÉè
                const userName = QQ_GetUserName() || 'User';
                const userAvatar = QQ_GetUserAvatar() || 'default_avatar.png';
                
                // ÂàõÂª∫Á≤æÁÅµÊåâÈíÆ
                const spirit = document.createElement('div');
                spirit.id = 'QQ_user_spirit';
                spirit.style.cssText = `
                    position: fixed;
                    top: 120px;
                    right: 30px;
                    width: 60px;
                    height: 60px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    border-radius: 50%;
                    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
                    cursor: pointer;
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    animation: userSpiritPulse 2s infinite ease-in-out;
                    border: 3px solid white;
                    transition: all 0.3s ease;
                `;
                
                // Á≤æÁÅµÂÜÖÂÆπÔºàÁî®Êà∑Â§¥ÂÉèÊàñÂõæÊ†áÔºâ
                spirit.innerHTML = `
                    <img src="${userAvatar}" alt="${userName}" style="
                        width: 45px;
                        height: 45px;
                        border-radius: 50%;
                        object-fit: cover;
                    " onerror="this.outerHTML='<div style=&quot;color: white; font-size: 24px;&quot;>üë§</div>';">
                `;
                
                // Á≤æÁÅµÊÇ¨ÂÅúÊïàÊûú
                spirit.addEventListener('mouseenter', () => {
                    spirit.style.transform = 'scale(1.1)';
                    spirit.style.boxShadow = '0 8px 25px rgba(102, 126, 234, 0.6)';
                });
                
                spirit.addEventListener('mouseleave', () => {
                    spirit.style.transform = 'scale(1)';
                    spirit.style.boxShadow = '0 6px 20px rgba(102, 126, 234, 0.4)';
                });
                
                // ÁÇπÂáªÁ≤æÁÅµÊòæÁ§∫Áî®Êà∑Èù¢Êùø
                spirit.addEventListener('click', (e) => {
                    e.stopPropagation();
                    QQ_ShowUserSpiritPanel();
                    spirit.remove();
                });
                
                // Ê∑ªÂä†Á≤æÁÅµÂä®ÁîªÊ†∑Âºè
                if (!document.getElementById('user_spirit_styles')) {
                    const style = document.createElement('style');
                    style.id = 'user_spirit_styles';
                    style.textContent = `
                        @keyframes userSpiritPulse {
                            0%, 100% {
                                transform: scale(1);
                            }
                            50% {
                                transform: scale(1.05);
                            }
                        }
                        
                        @keyframes userSpiritSlideIn {
                            from {
                                opacity: 0;
                                transform: translateX(100px);
                            }
                            to {
                                opacity: 1;
                                transform: translateX(0);
                            }
                        }
                        
                        #QQ_user_spirit {
                            animation: userSpiritSlideIn 0.3s ease, userSpiritPulse 2s infinite ease-in-out 0.3s;
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                // Ê∑ªÂä†Âà∞È°µÈù¢
                document.body.appendChild(spirit);
                
                // 5ÁßíÂêéËá™Âä®Ê∂àÂ§±
                setTimeout(() => {
                    if (spirit && spirit.parentNode) {
                        spirit.style.opacity = '0';
                        spirit.style.transform = 'translateX(100px)';
                        setTimeout(() => {
                            if (spirit.parentNode) {
                                spirit.remove();
                            }
                        }, 300);
                    }
                }, 5000);
                
                console.log('Áî®Êà∑Á≤æÁÅµÂ∑≤ÊòæÁ§∫');
            }
            
            /**
             * *** Êñ∞Â¢ûÔºöËé∑ÂèñÁî®Êà∑Âêç ***
             */
            function QQ_GetUserName() {
                // Â∞ùËØïÂ§öÁßçÊñπÂºèËé∑ÂèñÁî®Êà∑Âêç
                const methods = [
                    () => UserName, // ÂÖ®Â±ÄÂèòÈáè
                    () => document.getElementById('QQ_home_UserName')?.textContent?.replace(/\*\*/g, '').trim(),
                    () => document.getElementById('QQ_message_list_UserName')?.textContent?.replace(/\*\*/g, '').trim(),
                    () => window.name || window.user || 'User'
                ];
                
                for (const method of methods) {
                    try {
                        const result = method();
                        if (result && typeof result === 'string' && result.length > 0) {
                            return result;
                        }
                    } catch (error) {
                        // ÂøΩÁï•ÈîôËØØÔºåÂ∞ùËØï‰∏ã‰∏Ä‰∏™ÊñπÊ≥ï
                    }
                }
                
                // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞Áî®Êà∑ÂêçÔºåËøîÂõûÈªòËÆ§ÂÄº
                return 'User';
            }
            
            /**
             * *** Êñ∞Â¢ûÔºöËé∑ÂèñÁî®Êà∑Â§¥ÂÉè ***
             */
            function QQ_GetUserAvatar() {
                // Â∞ùËØïÂ§öÁßçÊñπÂºèËé∑ÂèñÁî®Êà∑Â§¥ÂÉè
                const methods = [
                    () => window.userAvatarPath,
                    () => window.selectedAvatarData,
                    () => document.querySelector('#QQ_home_UserAvatar img')?.src,
                    () => document.querySelector('.user-avatar img')?.src,
                    () => document.querySelector('[data-user-avatar]')?.src
                ];
                
                for (const method of methods) {
                    try {
                        const result = method();
                        if (result && typeof result === 'string' && result !== 'default_avatar.png') {
                            return result;
                        }
                    } catch (error) {
                        // ÂøΩÁï•ÈîôËØØÔºåÂ∞ùËØï‰∏ã‰∏Ä‰∏™ÊñπÊ≥ï
                    }
                }
                
                // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞Â§¥ÂÉèÔºåËøîÂõûÈªòËÆ§ÂÄº
                return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiM2NjdlZWEiLz4KPHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4PSI4IiB5PSI4Ij4KPHBhdGggZD0iTTEyIDEyQzE0LjIwOTEgMTIgMTYgMTAuMjA5MSAxNiA4QzE2IDUuNzkwODYgMTQuMjA5MSA0IDEyIDRDOS43OTA4NiA0IDggNS43OTA4NiA4IDhDOCAxMC4yMDkxIDkuNzkwODYgMTIgMTIgMTJaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTIgMTRDOC4xMzQwMSAxNCA1IDE3LjEzNDAxIDUgMjFIMTlDMTkgMTcuMTM0MDEgMTUuODY2IDE0IDEyIDE0WiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+Cgo8L3N2Zz4K';
            }
            
            /**
             * *** Êñ∞Â¢ûÔºöÊòæÁ§∫Áî®Êà∑Á≤æÁÅµÈù¢Êùø ***
             */
            function QQ_ShowUserSpiritPanel() {
                console.log('ÊòæÁ§∫Áî®Êà∑Á≤æÁÅµÈù¢Êùø');
                
                // ÁßªÈô§Áé∞ÊúâÈù¢Êùø
                $('.QQ_user_spirit_panel').remove();
                
                const userName = QQ_GetUserName() || 'User';
                const userAvatar = QQ_GetUserAvatar();
                
                // ÂàõÂª∫Èù¢ÊùøHTML
                const panelHtml = `
                    <div class="QQ_user_spirit_panel" style="
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: white;
                        border-radius: 15px;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                        z-index: 99999999;
                        overflow: hidden;
                        animation: userPanelSlideIn 0.3s ease;
                        max-width: 90%;
                        max-height: 80%;
                        width: 350px;
                    ">
                        <div class="panel-header" style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 20px;
                            text-align: center;
                            font-weight: 600;
                        ">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                                <img src="${userAvatar}" alt="${userName}" style="
                                    width: 40px;
                                    height: 40px;
                                    border-radius: 50%;
                                    border: 2px solid white;
                                " onerror="this.outerHTML='<div style=&quot;width: 40px; height: 40px; border-radius: 50%; border: 2px solid white; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 20px;&quot;>üë§</div>';">
                                <span style="font-size: 16px;">üëë ${userName} ÁöÑÊéßÂà∂Èù¢Êùø</span>
                            </div>
                        </div>
                        
                        <div class="panel-content" style="padding: 20px;">
                            <!-- ‰∏ªË¶ÅÂäüËÉΩÂå∫ -->
                            <div style="
                                display: grid;
                                grid-template-columns: 1fr 1fr;
                                gap: 10px;
                                margin-bottom: 15px;
                            ">
                                <button class="panel-btn" data-action="interactive_guide" style="
                                    background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
                                    border: none;
                                    color: white;
                                    padding: 12px 8px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 12px;
                                    font-weight: 500;
                                    transition: all 0.2s ease;
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                    gap: 4px;
                                ">
                                    <span style="font-size: 16px;">üí´</span>
                                    <span>‰∫íÂä®ÊåáÂçó</span>
                                </button>
                                
                                <button class="panel-btn" data-action="phone_status" style="
                                    background: linear-gradient(135deg, #4FACFE 0%, #00F2FE 100%);
                                    border: none;
                                    color: white;
                                    padding: 12px 8px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 12px;
                                    font-weight: 500;
                                    transition: all 0.2s ease;
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                    gap: 4px;
                                ">
                                    <span style="font-size: 16px;">üì±</span>
                                    <span>ÊâãÊú∫Áä∂ÊÄÅ</span>
                                </button>
                                
                                <button class="panel-btn" data-action="sync_data" style="
                                    background: linear-gradient(135deg, #43E97B 0%, #38F9D7 100%);
                                    border: none;
                                    color: white;
                                    padding: 12px 8px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 12px;
                                    font-weight: 500;
                                    transition: all 0.2s ease;
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                    gap: 4px;
                                ">
                                    <span style="font-size: 16px;">üîÑ</span>
                                    <span>ÂêåÊ≠•Êï∞ÊçÆ</span>
                                </button>
                                
                                <button class="panel-btn" data-action="settings" style="
                                    background: linear-gradient(135deg, #FA709A 0%, #FEE140 100%);
                                    border: none;
                                    color: white;
                                    padding: 12px 8px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 12px;
                                    font-weight: 500;
                                    transition: all 0.2s ease;
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                    gap: 4px;
                                ">
                                    <span style="font-size: 16px;">‚öôÔ∏è</span>
                                    <span>ËÆæÂÆö</span>
                                </button>
                            </div>
                            
                            <!-- Êñ∞Â¢ûÔºöÂÖ¨ÂÖ±‰∫íÂä®Á©∫Èó¥ÁÆ°ÁêÜÂå∫ -->
                            <div style="
                                border-top: 1px solid #e9ecef;
                                padding-top: 15px;
                                margin-bottom: 15px;
                            ">
                                <div style="
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    margin-bottom: 10px;
                                    font-size: 13px;
                                    font-weight: 600;
                                    color: #666;
                                ">
                                    <span style="
                                        display: inline-block;
                                        width: 16px;
                                        height: 16px;
                                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                        border-radius: 50%;
                                        color: white;
                                        text-align: center;
                                        line-height: 16px;
                                        font-size: 10px;
                                    ">üè†</span>
                                    <span>ÂÖ¨ÂÖ±‰∫íÂä®Á©∫Èó¥</span>
                                    <span style="
                                        background: #e9ecef;
                                        color: #666;
                                        padding: 2px 6px;
                                        border-radius: 8px;
                                        font-size: 10px;
                                        font-weight: 500;
                                        margin-left: auto;
                                    ">${Object.keys(QQ_InteractiveSpaces || {}).length}‰∏™</span>
                                </div>
                                
                                <div style="
                                    display: grid;
                                    grid-template-columns: 1fr 1fr;
                                    gap: 8px;
                                ">
                                    <button class="panel-btn" data-action="view_public_spaces" style="
                                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                        border: none;
                                        color: white;
                                        padding: 10px 8px;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 11px;
                                        font-weight: 500;
                                        transition: all 0.2s ease;
                                        display: flex;
                                        flex-direction: column;
                                        align-items: center;
                                        gap: 3px;
                                    ">
                                        <span style="font-size: 14px;">üìÇ</span>
                                        <span>‰∫íÂä®ËÆ∞ÂΩï</span>
                                    </button>
                                    
                                    <button class="panel-btn" data-action="create_public_space" style="
                                        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                                        border: none;
                                        color: white;
                                        padding: 10px 8px;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 11px;
                                        font-weight: 500;
                                        transition: all 0.2s ease;
                                        display: flex;
                                        flex-direction: column;
                                        align-items: center;
                                        gap: 3px;
                                    ">
                                        <span style="font-size: 14px;">‚ú®</span>
                                        <span>ÂàõÂª∫‰∫íÂä®</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Êñ∞Â¢ûÔºö‰∫íÂä®Á¨¶Âè∑ÊèêÁ§∫ -->
                        <div class="interactive-tip" style="
                            padding: 12px 20px;
                            background: linear-gradient(135deg, #E8F5E8 0%, #F0F8FF 100%);
                            border-top: 1px solid #e9ecef;
                            font-size: 12px;
                            color: #666;
                            line-height: 1.4;
                        ">
                            <div style="
                                display: flex;
                                align-items: center;
                                gap: 8px;
                                margin-bottom: 6px;
                                font-weight: 500;
                            ">
                                <span style="
                                    display: inline-block;
                                    width: 16px;
                                    height: 16px;
                                    background: #4CAF50;
                                    border-radius: 50%;
                                    color: white;
                                    text-align: center;
                                    line-height: 16px;
                                    font-size: 10px;
                                ">üí°</span>
                                <span style="color: #4CAF50;">Âø´ÈÄü‰∫íÂä®Â∞èË¥¥Â£´</span>
                            </div>
                            <div style="margin-left: 24px;">
                                Âú®ËÅäÂ§©‰∏≠‰ΩøÁî® <span style="
                                    background: #4CAF50;
                                    color: white;
                                    padding: 2px 6px;
                                    border-radius: 3px;
                                    font-family: monospace;
                                    font-weight: 600;
                                ">&&</span> Á¨¶Âè∑ÂèØ‰ª•Áõ¥Êé•Ëß¶Âèë‰∫íÂä®ÂÜÖÂÆπ
                            </div>
                            <div style="margin-left: 24px; margin-top: 4px; color: #888;">
                                ‰æãÂ¶ÇÔºö<code style="background: #f8f9fa; padding: 1px 4px; border-radius: 2px;">&&ÊÉ≥Ë¶ÅÊã•Êä±‰Ω†</code>
                            </div>
                        </div>
                        
                        <div class="panel-actions" style="
                            padding: 20px;
                            background: #fafafa;
                            display: flex;
                            gap: 10px;
                        ">
                            <button class="close-panel-btn" style="
                                flex: 1;
                                background: #e9ecef;
                                border: none;
                                color: #666;
                                padding: 12px 16px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 13px;
                                font-weight: 500;
                                transition: all 0.2s ease;
                            ">
                                ÂÖ≥Èó≠
                            </button>
                        </div>
                    </div>
                    
                    <style>
                        @keyframes userPanelSlideIn {
                            from {
                                opacity: 0;
                                transform: translate(-50%, -60%);
                            }
                            to {
                                opacity: 1;
                                transform: translate(-50%, -50%);
                            }
                        }
                        
                        .QQ_user_spirit_panel .panel-btn:hover {
                            transform: translateY(-2px);
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                        }
                    </style>
                `;
                
                // Ê∑ªÂä†Âà∞È°µÈù¢
                $('body').append(panelHtml);
                
                // ÁªëÂÆö‰∫ã‰ª∂
                $('.QQ_user_spirit_panel').on('click', function(e) {
                    e.stopPropagation();
                    
                    const panelBtn = e.target.closest('.panel-btn');
                    const closePanelBtn = e.target.closest('.close-panel-btn');
                    
                    if (panelBtn) {
                        const action = panelBtn.getAttribute('data-action');
                        console.log(`ÁÇπÂáªÁî®Êà∑Èù¢ÊùøÊåâÈíÆ: ${action}`);
                        
                        $('.QQ_user_spirit_panel').remove();
                        
                        switch (action) {
                            case 'interactive_guide':
                                QQ_ShowInteractiveGuide();
                                break;
                            case 'phone_status':
                                QQ_ShowPhoneStatus();
                                break;
                            case 'sync_data':
                                QQ_SyncAllData();
                                break;
                            case 'settings':
                                QQ_ShowInteractiveSettings();
                                break;
                            case 'view_public_spaces':
                                QQ_ShowPublicInteractiveSpaces();
                                break;
                            case 'create_public_space':
                                QQ_CreatePublicInteractiveSpace();
                                break;
                        }
                    } else if (closePanelBtn) {
                        $('.QQ_user_spirit_panel').remove();
                    }
                });
                
                // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠Èù¢Êùø
                $(document).one('click', function() {
                    $('.QQ_user_spirit_panel').remove();
                });
            }
            
            /**
             * *** Êñ∞Â¢ûÔºöÊõ¥Êñ∞Á≤æÁÅµÈù¢Êùø‰∏≠ÁöÑ‰∫íÂä®Áä∂ÊÄÅÊòæÁ§∫ ***
             */
            function QQ_UpdateInteractiveStatus() {
                const statusContainer = $('#interactive-status-content');
                if (statusContainer.length === 0) return;
                
                try {
                    const settings = QQ_GetInteractiveSettings();
                    const symbolStatus = 'üü¢ ÁâπÊÆäÁ¨¶Âè∑ (&&)ÔºöÊ∞∏‰πÖÂêØÁî®';
                    const keywordStatus = settings.enableKeywordTrigger ? 
                        'üü¢ ÂÖ≥ÈîÆËØçËß¶ÂèëÔºöÂ∑≤ÂêØÁî®' : 
                        'üî¥ ÂÖ≥ÈîÆËØçËß¶ÂèëÔºöÂ∑≤Á¶ÅÁî®';
                    const customCount = settings.customKeywords.length;
                    const customStatus = customCount > 0 ? 
                        `üü¢ Ëá™ÂÆö‰πâÂÖ≥ÈîÆËØçÔºö${customCount}‰∏™` : 
                        '‚ö™ Ëá™ÂÆö‰πâÂÖ≥ÈîÆËØçÔºöÊöÇÊó†';
                    
                    const statusHtml = `
                        <div>${symbolStatus}</div>
                        <div>${keywordStatus}</div>
                        <div>${customStatus}</div>
                        <div style="margin-top: 4px; color: #888;">
                            ÁÇπÂáª"ËÆæÂÆö"ÊåâÈíÆÂèØ‰øÆÊîπÂÖ≥ÈîÆËØçËß¶ÂèëËÆæÁΩÆ
                        </div>
                    `;
                    
                    statusContainer.html(statusHtml);
                } catch (error) {
                    console.error('Êõ¥Êñ∞‰∫íÂä®Áä∂ÊÄÅÊòæÁ§∫Â§±Ë¥•:', error);
                    statusContainer.html(`
                        <div>üü¢ ÁâπÊÆäÁ¨¶Âè∑ (&&)ÔºöÊ∞∏‰πÖÂêØÁî®</div>
                        <div>‚ö™ ÂÖ≥ÈîÆËØçËß¶ÂèëÔºöËé∑ÂèñÁä∂ÊÄÅÂ§±Ë¥•</div>
                        <div style="margin-top: 4px; color: #888;">
                            ÁÇπÂáª"ËÆæÂÆö"ÊåâÈíÆÈÖçÁΩÆ‰∫íÂä®Ëß¶Âèë
                        </div>
                    `);
                }
            }

            /**
             * *** Êñ∞Â¢ûÔºöÊòæÁ§∫Áî®Êà∑ËÆæÂÆöËèúÂçïÔºàÂéü‰∏ãÊãâËèúÂçïÂäüËÉΩÔºâ ***
             */
            function QQ_ShowUserSettingsMenu() {
                console.log('ÊòæÁ§∫Áî®Êà∑ËÆæÂÆöËèúÂçï');
                
                // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®ËèúÂçï
                let existingMenu = document.getElementById('QQ_user_dropdown_menu');
                if (existingMenu) {
                    existingMenu.remove();
                    return;
                }
                
                // ÂàõÂª∫‰∏ãÊãâËèúÂçï
                const menu = document.createElement('div');
                menu.id = 'QQ_user_dropdown_menu';
                menu.style.cssText = `
                    position: fixed;
                    top: 70px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: white;
                    border-radius: 12px;
                    padding: 12px 0;
                    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
                    z-index: 9999;
                    min-width: 200px;
                    animation: fadeInDown 0.2s ease;
                    border: 1px solid #e0e0e0;
                `;
                
                // ËèúÂçïÈ°πÊï∞ÊçÆ
                const menuItems = [
                    {
                        icon: 'üìä',
                        text: '‰∏ñÁïå‰π¶ÁªüËÆ°',
                        action: () => {
                            QQ_Show_WorldBook_Stats();
                            menu.remove();
                        }
                    },
                    {
                        icon: 'üîÑ',
                        text: 'ÂêåÊ≠•Êï∞ÊçÆ',
                        action: () => {
                            QQ_Manual_Sync_All_Data();
                            menu.remove();
                        }
                    },
                    {
                        icon: 'üß™',
                        text: 'ÊµãËØï‰∫íÂä®Ê£ÄÊµã',
                        action: () => {
                            const testText = prompt('ËØ∑ËæìÂÖ•Ë¶ÅÊµãËØïÁöÑÊñáÊú¨:', 'ÊàëÊÉ≥ÂíåÂ§ßÂÆ∂‰∏ÄËµ∑Êã•Êä±');
                            if (testText) {
                                QQ_Test_Interactive_Detection(testText);
                            }
                            menu.remove();
                        }
                    },
                    {
                        icon: '‚öôÔ∏è',
                        text: 'ÊâãÊú∫ÁïåÈù¢ËÆæÁΩÆ',
                        action: () => {
                            alert('ËÆæÁΩÆÂäüËÉΩÂºÄÂèë‰∏≠...');
                            menu.remove();
                        }
                    },
                    {
                        icon: 'üì±',
                        text: 'ÁïåÈù¢‰ø°ÊÅØ',
                        action: () => {
                            const info = `ÊâãÊú∫ÁïåÈù¢Áä∂ÊÄÅ:
- ÂΩìÂâçÁî®Êà∑: ${QQ_GetUserName()}
- ÂΩìÂâçËßíËâ≤: ${getCurrentCharacterId() || 'Êú™Áü•'}
- ‰∏ñÁïå‰π¶Áä∂ÊÄÅ: ${QQ_IsWorldBookAvailable() ? '‚úÖ ÂèØÁî®' : '‚ùå ‰∏çÂèØÁî®'}
- ËÅîÁ≥ª‰∫∫ÂàÜÁªÑ: ${contactGroups ? contactGroups.length : 0} ‰∏™
- ‰∫íÂä®Á©∫Èó¥: ${Object.keys(QQ_InteractiveSpaces || {}).length} ‰∏™ÂÖ¨ÂÖ± + ${Object.keys(QQ_CharacterSpaces || {}).reduce((sum, char) => sum + Object.keys(QQ_CharacterSpaces[char]).length, 0)} ‰∏™ÁßÅ‰∫∫`;
                            alert(info);
                            menu.remove();
                        }
                    }
                ];
                
                // ÂàõÂª∫ËèúÂçïÈ°π
                menuItems.forEach((item, index) => {
                    const menuItem = document.createElement('div');
                    menuItem.style.cssText = `
                        padding: 12px 20px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        font-size: 14px;
                        color: #333;
                        transition: background-color 0.2s ease;
                        ${index > 0 ? 'border-top: 1px solid #f0f0f0;' : ''}
                    `;
                    
                    menuItem.innerHTML = `
                        <span style="margin-right: 12px; font-size: 16px;">${item.icon}</span>
                        <span>${item.text}</span>
                    `;
                    
                    // ÊÇ¨ÂÅúÊïàÊûú
                    menuItem.addEventListener('mouseenter', () => {
                        menuItem.style.backgroundColor = '#f5f5f5';
                    });
                    
                    menuItem.addEventListener('mouseleave', () => {
                        menuItem.style.backgroundColor = 'transparent';
                    });
                    
                    // ÁÇπÂáª‰∫ã‰ª∂
                    menuItem.addEventListener('click', item.action);
                    
                    menu.appendChild(menuItem);
                });
                
                // Ê∑ªÂä†Âä®ÁîªÊ†∑Âºè
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes fadeInDown {
                        from {
                            opacity: 0;
                            transform: translateX(-50%) translateY(-10px);
                        }
                        to {
                            opacity: 1;
                            transform: translateX(-50%) translateY(0);
                        }
                    }
                `;
                document.head.appendChild(style);
                
                // Ê∑ªÂä†ËèúÂçïÂà∞È°µÈù¢
                document.body.appendChild(menu);
                
                // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠ËèúÂçï
                const closeMenu = (e) => {
                    if (!menu.contains(e.target) && !document.getElementById('QQ_message_list_UserName').contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                };
                
                setTimeout(() => {
                    document.addEventListener('click', closeMenu);
                }, 100);
            }
            
            /**
             * *** Êñ∞Â¢ûÔºöÊòæÁ§∫ÊâãÊú∫Áä∂ÊÄÅ ***
             */
            function QQ_ShowPhoneStatus() {
                console.log('ÊòæÁ§∫ÊâãÊú∫Áä∂ÊÄÅ');
                
                const info = `üì± ÊâãÊú∫ÁïåÈù¢Áä∂ÊÄÅ‰ø°ÊÅØ

üë§ ÂΩìÂâçÁî®Êà∑: ${QQ_GetUserName()}
üé≠ ÂΩìÂâçËßíËâ≤: ${getCurrentCharacterId() || 'Êú™Áü•'}
üìö ‰∏ñÁïå‰π¶Áä∂ÊÄÅ: ${QQ_IsWorldBookAvailable() ? '‚úÖ ÂèØÁî®' : '‚ùå ‰∏çÂèØÁî®'}

üìã Êï∞ÊçÆÁªüËÆ°:
‚Ä¢ ËÅîÁ≥ª‰∫∫ÂàÜÁªÑ: ${contactGroups ? contactGroups.length : 0} ‰∏™
‚Ä¢ ÂÖ¨ÂÖ±‰∫íÂä®Á©∫Èó¥: ${Object.keys(QQ_InteractiveSpaces || {}).length} ‰∏™
‚Ä¢ ÁßÅ‰∫∫‰∫íÂä®Á©∫Èó¥: ${Object.keys(QQ_CharacterSpaces || {}).reduce((sum, char) => sum + Object.keys(QQ_CharacterSpaces[char]).length, 0)} ‰∏™
‚Ä¢ Âä®ÊÄÅÊï∞Èáè: ${QQ_MomentsData ? QQ_MomentsData.length : 0} ‰∏™

‚öôÔ∏è ÂäüËÉΩÁä∂ÊÄÅ:
‚Ä¢ Ê∂àÊÅØÂèëÈÄÅ: ${typeof QQ_SendMsg === 'function' ? '‚úÖ' : '‚ùå'}
‚Ä¢ Âä®ÊÄÅËØÑËÆ∫: ${typeof QQ_Moment_Comment === 'function' ? '‚úÖ' : '‚ùå'}
‚Ä¢ ‰∫íÂä®Ê£ÄÊµã: ${typeof QQ_DetectInteractiveIntent === 'function' ? '‚úÖ' : '‚ùå'}
‚Ä¢ ËßíËâ≤Á≤æÁÅµ: ${typeof QQ_ShowCharacterSpirit === 'function' ? '‚úÖ' : '‚ùå'}

üïí Á≥ªÁªüÊó∂Èó¥: ${new Date().toLocaleString('zh-CN')}`;
                
                alert(info);
            }
            
            /**
             * *** Êñ∞Â¢ûÔºöÂêåÊ≠•ÊâÄÊúâÊï∞ÊçÆÂà∞‰∏ñÁïå‰π¶ ***
             */
            function QQ_SyncAllData() {
                console.log('üîÑ ÂºÄÂßãÂêåÊ≠•ÊâÄÊúâÊï∞ÊçÆÂà∞‰∏ñÁïå‰π¶...');
                
                if (!QQ_IsWorldBookAvailable()) {
                    alert('‚ùå ‰∏ñÁïå‰π¶ÂäüËÉΩ‰∏çÂèØÁî®ÔºåÊó†Ê≥ïÂêåÊ≠•Êï∞ÊçÆ');
                    return;
                }
                
                let syncCount = 0;
                let totalCount = 0;
                
                try {
                    // ÂêåÊ≠•ÂàÜÁªÑÊï∞ÊçÆ
                    if (typeof saveGroupsToStorage === 'function') {
                        console.log('üîÑ ÂêåÊ≠•ÂàÜÁªÑÊï∞ÊçÆ...');
                        saveGroupsToStorage();
                        syncCount++;
                    }
                    totalCount++;
                    
                    // ÂêåÊ≠•Âä®ÊÄÅÊï∞ÊçÆ
                    if (typeof QQ_Save_Moments === 'function' && QQ_MomentsData) {
                        console.log('üîÑ ÂêåÊ≠•Âä®ÊÄÅÊï∞ÊçÆ...');
                        QQ_Save_Moments();
                        syncCount++;
                    }
                    totalCount++;
                    
                    // ÂêåÊ≠•‰∫íÂä®Á©∫Èó¥Êï∞ÊçÆ
                    if (typeof QQ_Save_Interactive_Spaces === 'function') {
                        console.log('üîÑ ÂêåÊ≠•‰∫íÂä®Á©∫Èó¥Êï∞ÊçÆ...');
                        QQ_Save_Interactive_Spaces();
                        syncCount++;
                    }
                    totalCount++;
                    
                    // ÂêåÊ≠•Â∑≤ËØªÁä∂ÊÄÅ
                    if (typeof QQ_SaveReadStatus === 'function') {
                        console.log('üîÑ ÂêåÊ≠•Â∑≤ËØªÁä∂ÊÄÅ...');
                        QQ_SaveReadStatus();
                        syncCount++;
                    }
                    totalCount++;
                    
                    console.log(`‚úÖ Êï∞ÊçÆÂêåÊ≠•ÂÆåÊàê: ${syncCount}/${totalCount} È°πÊàêÂäü`);
                    alert(`‚úÖ Êï∞ÊçÆÂêåÊ≠•ÂÆåÊàê\nÊàêÂäüÂêåÊ≠•: ${syncCount}/${totalCount} È°πÊï∞ÊçÆ`);
                    
                } catch (error) {
                    console.error('‚ùå Êï∞ÊçÆÂêåÊ≠•Â§±Ë¥•:', error);
                    alert(`‚ùå Êï∞ÊçÆÂêåÊ≠•Â§±Ë¥•: ${error.message}`);
                }
            }
            
            /**
             * *** Âº∫Âà∂‰ªé‰∏ñÁïå‰π¶ÈáçÊñ∞Âä†ËΩΩÊâÄÊúâ‰∫íÂä®Á©∫Èó¥Êï∞ÊçÆ ***
             */
            async function QQ_ForceReloadInteractiveSpaces() {
                console.log('üîÑ Âº∫Âà∂‰ªé‰∏ñÁïå‰π¶ÈáçÊñ∞Âä†ËΩΩ‰∫íÂä®Á©∫Èó¥Êï∞ÊçÆ...');
                
                try {
                    // Ê∏ÖÁ©∫ÂÜÖÂ≠òÁºìÂ≠ò
                    QQ_InteractiveSpaces = {};
                    QQ_CharacterSpaces = {};
                    
                    // ‰ªé‰∏ñÁïå‰π¶ÈáçÊñ∞Âä†ËΩΩ
                    await QQ_LoadInteractiveSpaces();
                    await QQ_LoadCharacterSpaces();
                    
                    console.log('‚úÖ ‰∫íÂä®Á©∫Èó¥Êï∞ÊçÆÈáçÊñ∞Âä†ËΩΩÂÆåÊàê');
                    console.log(`üìä ÂÖ¨ÂÖ±Á©∫Èó¥: ${Object.keys(QQ_InteractiveSpaces).length} ‰∏™`);
                    console.log(`üë• ËßíËâ≤Á©∫Èó¥: ${Object.keys(QQ_CharacterSpaces).length} ‰∏™ËßíËâ≤`);
                    
                    return true;
                } catch (error) {
                    console.error('‚ùå Âº∫Âà∂ÈáçÊñ∞Âä†ËΩΩ‰∫íÂä®Á©∫Èó¥Êï∞ÊçÆÂ§±Ë¥•:', error);
                    return false;
                }
            }
            
            /**
             * *** Êñ∞Â¢ûÔºöÊòæÁ§∫ÂÖ¨ÂÖ±‰∫íÂä®Á©∫Èó¥ÂàóË°® ***
             */
            async function QQ_ShowPublicInteractiveSpaces() {
                console.log('ÊòæÁ§∫ÂÖ¨ÂÖ±‰∫íÂä®Á©∫Èó¥ÂàóË°®');
                
                // *** ÂÖ≥ÈîÆ‰ºòÂåñÔºöÂº∫Âà∂‰ªé‰∏ñÁïå‰π¶ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ ***
                await QQ_ForceReloadInteractiveSpaces();
                
                // ÁßªÈô§Áé∞ÊúâÈù¢Êùø
                $('.QQ_user_spirit_panel').remove();
                
                const spaces = Object.values(QQ_InteractiveSpaces || {});
                const spacesCount = spaces.length;
                
                // ÂàõÂª∫‰∫íÂä®Á©∫Èó¥ÂàóË°®Èù¢Êùø
                const panel = $(`
                    <div class="QQ_public_spaces_panel" style="
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: white;
                        border-radius: 16px;
                        width: 85%;
                        max-width: 400px;
                        max-height: 70vh;
                        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                        z-index: 10000;
                        overflow: hidden;
                        animation: slideIn 0.3s ease;
                    ">
                        <div class="panel-header" style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 16px 20px;
                            text-align: center;
                            position: relative;
                        ">
                            <div style="
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                gap: 8px;
                                font-size: 16px;
                                font-weight: 600;
                            ">
                                <span style="font-size: 18px;">üè†</span>
                                <span>ÂÖ¨ÂÖ±‰∫íÂä®Á©∫Èó¥</span>
                                <span style="
                                    background: rgba(255, 255, 255, 0.2);
                                    padding: 2px 8px;
                                    border-radius: 8px;
                                    font-size: 12px;
                                    font-weight: 500;
                                ">${spacesCount}‰∏™</span>
                            </div>
                        </div>
                        
                        <div class="panel-content" style="
                            padding: 0;
                            max-height: 50vh;
                            overflow-y: auto;
                        ">
                            ${spacesCount === 0 ? `
                                <div style="
                                    text-align: center;
                                    padding: 40px 20px;
                                    color: #999;
                                ">
                                    <div style="font-size: 48px; margin-bottom: 16px;">üåü</div>
                                    <div style="font-size: 16px; margin-bottom: 8px; color: #666;">ËøòÊ≤°Êúâ‰∫íÂä®ËÆ∞ÂΩï</div>
                                    <div style="font-size: 12px;">ÂºÄÂßã‰∏ÄÊÆµÁé∞ÂÆû‰∫íÂä®ÂêßÔΩû</div>
                                </div>
                            ` : spaces.map((space, index) => `
                                <div class="space-item" data-space-id="${space.id}" style="
                                    padding: 16px 20px;
                                    border-bottom: 1px solid #f0f0f0;
                                    cursor: pointer;
                                    transition: background-color 0.2s ease;
                                    ${index === spaces.length - 1 ? 'border-bottom: none;' : ''}
                                ">
                                    <div style="
                                        display: flex;
                                        align-items: flex-start;
                                        gap: 12px;
                                    ">
                                        <div style="
                                            width: 36px;
                                            height: 36px;
                                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                            border-radius: 8px;
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                            color: white;
                                            font-size: 16px;
                                            flex-shrink: 0;
                                        ">üåü</div>
                                        
                                        <div style="flex: 1; min-width: 0;">
                                            <div style="
                                                font-size: 14px;
                                                font-weight: 600;
                                                color: #333;
                                                margin-bottom: 4px;
                                                overflow: hidden;
                                                text-overflow: ellipsis;
                                                white-space: nowrap;
                                            ">${space.title || `‰∫íÂä®Á©∫Èó¥ #${index + 1}`}</div>
                                            
                                            <div style="
                                                font-size: 12px;
                                                color: #666;
                                                line-height: 1.4;
                                                display: -webkit-box;
                                                -webkit-line-clamp: 2;
                                                -webkit-box-orient: vertical;
                                                overflow: hidden;
                                            ">${(space.content || '').replace(/<[^>]*>/g, '').substring(0, 60)}${(space.content || '').length > 60 ? '...' : ''}</div>
                                            
                                            <div style="
                                                font-size: 10px;
                                                color: #999;
                                                margin-top: 6px;
                                                display: flex;
                                                align-items: center;
                                                gap: 8px;
                                            ">
                                                <span>üìÖ ${space.timestamp ? new Date(space.timestamp).toLocaleDateString('zh-CN') : 'Êú™Áü•Êó∂Èó¥'}</span>
                                                <span>üí¨ ${space.replies ? space.replies.length : 0}Êù°ÂõûÂ§ç</span>
                                            </div>
                                        </div>
                                        
                                        <div style="
                                            width: 24px;
                                            height: 24px;
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                            color: #ccc;
                                            font-size: 14px;
                                        ">‚Üí</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="panel-footer" style="
                            padding: 16px 20px;
                            border-top: 1px solid #f0f0f0;
                            background: #fafafa;
                        ">
                            <div style="
                                display: grid;
                                grid-template-columns: 1fr 1fr;
                                gap: 10px;
                            ">
                                <button class="close-btn" style="
                                    background: #e9ecef;
                                    border: none;
                                    color: #666;
                                    padding: 10px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.2s ease;
                                ">ÂÖ≥Èó≠</button>
                                
                                <button class="create-new-btn" style="
                                    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                                    border: none;
                                    color: white;
                                    padding: 10px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.2s ease;
                                ">‚ú® ÂàõÂª∫Êñ∞‰∫íÂä®</button>
                            </div>
                        </div>
                    </div>
                `);
                
                // Ê∑ªÂä†ÊÇ¨ÂÅúÊïàÊûú
                panel.find('.space-item').hover(
                    function() { $(this).css('background-color', '#f8f9fa'); },
                    function() { $(this).css('background-color', 'transparent'); }
                );
                
                // ÁªëÂÆö‰∫ã‰ª∂
                panel.on('click', '.space-item', function() {
                    const spaceId = $(this).data('space-id');
                    const space = QQ_InteractiveSpaces[spaceId];
                    if (space) {
                        panel.remove();
                        setTimeout(() => {
                            QQ_DisplayInteractiveSpace(spaceId, 'ÂÖ¨ÂÖ±‰∫íÂä®Á©∫Èó¥');
                        }, 100);
                    }
                });
                
                panel.on('click', '.close-btn', function() {
                    panel.remove();
                });
                
                panel.on('click', '.create-new-btn', function() {
                    panel.remove();
                    setTimeout(() => {
                        QQ_CreatePublicInteractiveSpace();
                    }, 100);
                });
                
                // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠
                $(document).one('click', function() {
                    panel.remove();
                });
                
                panel.on('click', function(e) {
                    e.stopPropagation();
                });
                
                $('body').append(panel);
            }
            
            /**
             * *** Êñ∞Â¢ûÔºöÂàõÂª∫ÂÖ¨ÂÖ±‰∫íÂä®Á©∫Èó¥ ***
             */
            async function QQ_CreatePublicInteractiveSpace() {
                console.log('ÂàõÂª∫ÂÖ¨ÂÖ±‰∫íÂä®Á©∫Èó¥');
                
                // *** ÂÖ≥ÈîÆ‰ºòÂåñÔºöÂÖà‰ªé‰∏ñÁïå‰π¶ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ ***
                await QQ_ForceReloadInteractiveSpaces();
                
                // ÁßªÈô§Áé∞ÊúâÈù¢Êùø
                $('.QQ_public_spaces_panel').remove();
                
                // ÂàõÂª∫ËæìÂÖ•Èù¢Êùø
                const panel = $(`
                    <div class="QQ_create_space_panel" style="
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: white;
                        border-radius: 16px;
                        width: 85%;
                        max-width: 400px;
                        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                        z-index: 10000;
                        overflow: hidden;
                        animation: slideIn 0.3s ease;
                    ">
                        <div class="panel-header" style="
                            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                            color: white;
                            padding: 16px 20px;
                            text-align: center;
                        ">
                            <div style="
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                gap: 8px;
                                font-size: 16px;
                                font-weight: 600;
                            ">
                                <span style="font-size: 18px;">‚ú®</span>
                                <span>ÂàõÂª∫Êñ∞‰∫íÂä®Á©∫Èó¥</span>
                            </div>
                        </div>
                        
                        <div class="panel-content" style="padding: 20px;">
                            <div style="margin-bottom: 16px;">
                                <label style="
                                    display: block;
                                    font-size: 13px;
                                    font-weight: 600;
                                    color: #333;
                                    margin-bottom: 6px;
                                ">‰∫íÂä®Ê†áÈ¢ò</label>
                                <input type="text" class="space-title" placeholder="‰∏∫ËøôÊ¨°‰∫íÂä®Ëµ∑‰∏™ÂêçÂ≠ó..." style="
                                    width: 100%;
                                    padding: 10px 12px;
                                    border: 1px solid #ddd;
                                    border-radius: 8px;
                                    font-size: 14px;
                                    outline: none;
                                    transition: border-color 0.2s ease;
                                    box-sizing: border-box;
                                ">
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="
                                    display: block;
                                    font-size: 13px;
                                    font-weight: 600;
                                    color: #333;
                                    margin-bottom: 6px;
                                ">‰∫íÂä®ÂÜÖÂÆπ</label>
                                <textarea class="space-content" placeholder="ÊèèËø∞‰Ω†ÊÉ≥Ë¶ÅÁöÑ‰∫íÂä®Âú∫ÊôØ..." style="
                                    width: 100%;
                                    height: 100px;
                                    padding: 10px 12px;
                                    border: 1px solid #ddd;
                                    border-radius: 8px;
                                    font-size: 14px;
                                    outline: none;
                                    transition: border-color 0.2s ease;
                                    resize: vertical;
                                    box-sizing: border-box;
                                "></textarea>
                            </div>
                            
                            <div style="
                                background: #f8f9fa;
                                padding: 12px;
                                border-radius: 8px;
                                margin-bottom: 20px;
                            ">
                                <div style="
                                    display: flex;
                                    align-items: center;
                                    gap: 6px;
                                    margin-bottom: 6px;
                                    font-size: 12px;
                                    font-weight: 600;
                                    color: #28a745;
                                ">
                                    <span>üí°</span>
                                    <span>Âø´ÈÄü‰∫íÂä®Â∞èË¥¥Â£´</span>
                                </div>
                                <div style="
                                    font-size: 11px;
                                    color: #666;
                                    line-height: 1.4;
                                ">
                                    Âú®ËÅäÂ§©‰∏≠‰ΩøÁî® <code style="
                                        background: #e9ecef;
                                        padding: 2px 4px;
                                        border-radius: 3px;
                                        font-family: monospace;
                                    ">&amp;&amp;</code> Á¨¶Âè∑ÂèØ‰ª•Áõ¥Êé•Ëß¶Âèë‰∫íÂä®ÂÜÖÂÆπ<br>
                                    ‰æãÂ¶ÇÔºö<em>&amp;&amp;ÊÉ≥Ë¶ÅÊã•Êä±‰Ω†</em>
                                </div>
                            </div>
                        </div>
                        
                        <div class="panel-footer" style="
                            padding: 16px 20px;
                            border-top: 1px solid #f0f0f0;
                            background: #fafafa;
                        ">
                            <div style="
                                display: grid;
                                grid-template-columns: 1fr 1fr;
                                gap: 10px;
                            ">
                                <button class="cancel-btn" style="
                                    background: #e9ecef;
                                    border: none;
                                    color: #666;
                                    padding: 10px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.2s ease;
                                ">ÂèñÊ∂à</button>
                                
                                <button class="create-btn" style="
                                    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                                    border: none;
                                    color: white;
                                    padding: 10px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.2s ease;
                                ">‚ú® ÂàõÂª∫‰∫íÂä®</button>
                            </div>
                        </div>
                    </div>
                `);
                
                // ËæìÂÖ•Ê°ÜÁÑ¶ÁÇπÊïàÊûú
                panel.find('input, textarea').on('focus', function() {
                    $(this).css('border-color', '#f093fb');
                }).on('blur', function() {
                    $(this).css('border-color', '#ddd');
                });
                
                // ÁªëÂÆö‰∫ã‰ª∂
                panel.on('click', '.cancel-btn', function() {
                    panel.remove();
                });
                
                panel.on('click', '.create-btn', function() {
                    const title = panel.find('.space-title').val().trim();
                    const content = panel.find('.space-content').val().trim();
                    
                    if (!content) {
                        alert('ËØ∑ËæìÂÖ•‰∫íÂä®ÂÜÖÂÆπ');
                        return;
                    }
                    
                    // ÂàõÂª∫‰∫íÂä®Á©∫Èó¥
                    const spaceId = 'space_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    const timestamp = Date.now();
                    
                    QQ_InteractiveSpaces[spaceId] = {
                        id: spaceId,
                        title: title || `‰∫íÂä®Á©∫Èó¥ #${Object.keys(QQ_InteractiveSpaces).length + 1}`,
                        content: content,
                        timestamp: timestamp,
                        characterName: '',
                        isMultiCharacter: true,
                        replies: []
                    };
                    
                    // *** Á´ãÂç≥‰øùÂ≠ò‰∫íÂä®ÂÜÖÂÆπÂà∞‰∏ñÁïå‰π¶ ***
                    QQ_SaveInteractiveContentToWorldBook(content, null).then(interactiveId => {
                        console.log(`üéØ ÂÖ¨ÂÖ±‰∫íÂä®Á©∫Èó¥Â∑≤Á´ãÂç≥‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶ÔºåID: ${interactiveId}`);
                    }).catch(error => {
                        console.error('‰øùÂ≠òÂÖ¨ÂÖ±‰∫íÂä®Á©∫Èó¥Â§±Ë¥•:', error);
                    });
                    
                    // ÂêåÊó∂‰øùÂ≠òÂà∞ÊóßÁöÑ‰∫íÂä®Á©∫Èó¥Â≠òÂÇ®ÔºàÂÖºÂÆπÊÄßÔºâ
                    if (typeof QQ_Save_Interactive_Spaces === 'function') {
                        QQ_Save_Interactive_Spaces();
                    }
                    
                    console.log('‚úÖ ÂÖ¨ÂÖ±‰∫íÂä®Á©∫Èó¥ÂàõÂª∫ÊàêÂäü:', spaceId);
                    
                    panel.remove();
                    
                    // ÊòæÁ§∫ÂàõÂª∫ÁöÑ‰∫íÂä®Á©∫Èó¥
                    setTimeout(() => {
                        QQ_DisplayInteractiveSpace(spaceId, 'ÂÖ¨ÂÖ±‰∫íÂä®Á©∫Èó¥');
                    }, 100);
                });
                
                // ÂõûËΩ¶Âø´Êç∑ÈîÆ
                panel.find('.space-content').on('keydown', function(e) {
                    if (e.ctrlKey && e.key === 'Enter') {
                        panel.find('.create-btn').click();
                    }
                });
                
                // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠
                $(document).one('click', function() {
                    panel.remove();
                });
                
                panel.on('click', function(e) {
                    e.stopPropagation();
                });
                
                $('body').append(panel);
                
                // Ëá™Âä®ËÅöÁÑ¶Âà∞Ê†áÈ¢òËæìÂÖ•Ê°Ü
                setTimeout(() => {
                    panel.find('.space-title').focus();
                }, 100);
            }
            
            // Á°Æ‰øùÂáΩÊï∞ÂÖ®Â±ÄÂèØÁî®
            window.QQ_ToggleUserMenu = QQ_ToggleUserMenu;
            window.QQ_GetUserName = QQ_GetUserName;
            window.QQ_ShowUserSpirit = QQ_ShowUserSpirit;
            window.QQ_ShowUserSpiritPanel = QQ_ShowUserSpiritPanel;
            window.QQ_ShowUserSettingsMenu = QQ_ShowUserSettingsMenu;
            window.QQ_ShowPhoneStatus = QQ_ShowPhoneStatus;
            window.QQ_SyncAllData = QQ_SyncAllData;
            window.QQ_ShowPublicInteractiveSpaces = QQ_ShowPublicInteractiveSpaces;
            window.QQ_CreatePublicInteractiveSpace = QQ_CreatePublicInteractiveSpace;
            window.QQ_ForceReloadInteractiveSpaces = QQ_ForceReloadInteractiveSpaces;
            window.QQ_ForceReloadContactGroups = QQ_ForceReloadContactGroups;
            
            /**
             * ===== ÈîôËØØ‰øÆÂ§çÈ™åËØÅÂ∑•ÂÖ∑ =====
             */
            
            /**
             * ÊµãËØï‰∏ñÁïå‰π¶Êù°ÁõÆËÆøÈóÆÊòØÂê¶Ê≠£Â∏∏
             */
            window.QQ_Test_WorldBook_Access = async function() {
                console.log('=== ÊµãËØï‰∏ñÁïå‰π¶Êù°ÁõÆËÆøÈóÆ ===');
                
                try {
                    // ÊµãËØï‰∏ñÁïå‰π¶ÊòØÂê¶ÂèØÁî®
                    console.log('1. Ê£ÄÊü•‰∏ñÁïå‰π¶ÂèØÁî®ÊÄß:', QQ_IsWorldBookAvailable());
                    
                    if (!worldbook) {
                        console.error('‚ùå worldbook Êú™ÂÆö‰πâ');
                        return;
                    }
                    
                    // ÊµãËØïËé∑ÂèñÊù°ÁõÆ
                    console.log('2. ÊµãËØïËé∑Âèñ‰∏ñÁïå‰π¶Êù°ÁõÆ...');
                    const entries = await getLorebookEntries(worldbook);
                    
                    if (entries) {
                        console.log(`‚úÖ ÊàêÂäüËé∑Âèñ‰∏ñÁïå‰π¶Êù°ÁõÆ: ${entries.length} ‰∏™`);
                        
                        // ÊµãËØïÊü•Êâæ‰∫íÂä®Áõ∏ÂÖ≥Êù°ÁõÆ
                        const interactiveEntry = entries.find(e => e.comment === 'QQ_‰∫íÂä®Á©∫Èó¥Â§á‰ªΩ');
                        const characterEntry = entries.find(e => e.comment === 'QQ_ËßíËâ≤‰∫íÂä®Á©∫Èó¥Â§á‰ªΩ');
                        const settingsEntry = entries.find(e => e.comment === 'QQ_‰∫íÂä®ËÆæÁΩÆ');
                        
                        console.log('3. ‰∫íÂä®Áõ∏ÂÖ≥Êù°ÁõÆÁä∂ÊÄÅ:');
                        console.log('   - ÂÖ¨ÂÖ±‰∫íÂä®Á©∫Èó¥:', interactiveEntry ? '‚úÖ Â≠òÂú®' : '‚ùå ‰∏çÂ≠òÂú®');
                        console.log('   - ËßíËâ≤‰∫íÂä®Á©∫Èó¥:', characterEntry ? '‚úÖ Â≠òÂú®' : '‚ùå ‰∏çÂ≠òÂú®');
                        console.log('   - ‰∫íÂä®ËÆæÁΩÆ:', settingsEntry ? '‚úÖ Â≠òÂú®' : '‚ùå ‰∏çÂ≠òÂú®');
                        
                        // ÊµãËØïÂêÑ‰∏™ÂäüËÉΩÂáΩÊï∞
                        console.log('4. ÊµãËØïÂäüËÉΩÂáΩÊï∞...');
                        
                        try {
                            await QQ_LoadInteractiveSpaces();
                            console.log('   - QQ_LoadInteractiveSpaces: ‚úÖ Ê≠£Â∏∏');
                        } catch (e) {
                            console.error('   - QQ_LoadInteractiveSpaces: ‚ùå ÈîôËØØ:', e.message);
                        }
                        
                        try {
                            await QQ_LoadCharacterSpaces();
                            console.log('   - QQ_LoadCharacterSpaces: ‚úÖ Ê≠£Â∏∏');
                        } catch (e) {
                            console.error('   - QQ_LoadCharacterSpaces: ‚ùå ÈîôËØØ:', e.message);
                        }
                        
                        try {
                            const settings = await QQ_GetInteractiveSettings();
                            console.log('   - QQ_GetInteractiveSettings: ‚úÖ Ê≠£Â∏∏, ÁªìÊûú:', settings);
                        } catch (e) {
                            console.error('   - QQ_GetInteractiveSettings: ‚ùå ÈîôËØØ:', e.message);
                        }
                        
                        triggerSlash('/echo ‚úÖ ‰∏ñÁïå‰π¶Êù°ÁõÆËÆøÈóÆÊµãËØïÂÆåÊàêÔºåËØ∑Êü•ÁúãÊéßÂà∂Âè∞ËØ¶ÁªÜÁªìÊûú');
                        
                    } else {
                        console.error('‚ùå Êó†Ê≥ïËé∑Âèñ‰∏ñÁïå‰π¶Êù°ÁõÆ');
                        triggerSlash('/echo ‚ùå ‰∏ñÁïå‰π¶Êù°ÁõÆËÆøÈóÆÊµãËØïÂ§±Ë¥•');
                    }
                    
                } catch (error) {
                    console.error('üí• ÊµãËØïËøáÁ®ã‰∏≠Âá∫Áé∞ÈîôËØØ:', error);
                    triggerSlash('/echo ‚ùå ‰∏ñÁïå‰π¶Êù°ÁõÆËÆøÈóÆÊµãËØïÂá∫Èîô: ' + error.message);
                }
            };
            
            /**
             * ÊµãËØï‰∫íÂä®ÂÜÖÂÆπ‰øùÂ≠òÂäüËÉΩ
             */
            window.QQ_Test_Interactive_Save = async function() {
                console.log('=== ÊµãËØï‰∫íÂä®ÂÜÖÂÆπ‰øùÂ≠òÂäüËÉΩ ===');
                
                try {
                    const testContent = "ËøôÊòØ‰∏Ä‰∏™ÊµãËØï‰∫íÂä®ÂÜÖÂÆπ - " + new Date().toISOString();
                    const testCharacter = "ÊµãËØïËßíËâ≤";
                    
                    console.log('Ê≠£Âú®ÊµãËØï‰øùÂ≠ò‰∫íÂä®ÂÜÖÂÆπ...');
                    const result = await QQ_SaveInteractiveContentToWorldBook(testContent, testCharacter);
                    
                    if (result) {
                        console.log(`‚úÖ ‰∫íÂä®ÂÜÖÂÆπ‰øùÂ≠òÊàêÂäüÔºåID: ${result}`);
                        triggerSlash('/echo ‚úÖ ‰∫íÂä®ÂÜÖÂÆπ‰øùÂ≠òÊµãËØïÊàêÂäü');
                    } else {
                        console.error('‚ùå ‰∫íÂä®ÂÜÖÂÆπ‰øùÂ≠òÂ§±Ë¥•');
                        triggerSlash('/echo ‚ùå ‰∫íÂä®ÂÜÖÂÆπ‰øùÂ≠òÊµãËØïÂ§±Ë¥•');
                    }
                    
                } catch (error) {
                    console.error('üí• ÊµãËØï‰∫íÂä®ÂÜÖÂÆπ‰øùÂ≠òÊó∂Âá∫Èîô:', error);
                    triggerSlash('/echo ‚ùå ‰∫íÂä®ÂÜÖÂÆπ‰øùÂ≠òÊµãËØïÂá∫Èîô: ' + error.message);
                }
            };

            /**
             * ===== Âä®ÊÄÅÁÇπËµûÂäüËÉΩ =====
             */

            /**
             * ÁÇπËµûÂä®ÊÄÅ
             * @param {string} momentId - Âä®ÊÄÅID
             */
            window.QQ_LikeMoment = async function(momentId) {
                try {
                    console.log(`ÁÇπËµûÂä®ÊÄÅ: ${momentId}`);
                    
                    // Ëé∑ÂèñÁî®Êà∑Âêç
                    const userName = QQ_GetUserName();
                    if (!userName) {
                        console.warn('Êó†Ê≥ïËé∑ÂèñÁî®Êà∑ÂêçÔºåÊó†Ê≥ïÊâßË°åÁÇπËµûÊìç‰Ωú');
                        return false;
                    }
                    
                    // Êü•ÊâæÂä®ÊÄÅÊï∞ÊçÆ
                    const momentData = QQ_MomentsData.find(m => m.id === momentId);
                    if (!momentData) {
                        console.warn(`Êú™ÊâæÂà∞Âä®ÊÄÅÊï∞ÊçÆ: ${momentId}`);
                        return false;
                    }
                    
                    // Á°Æ‰øùlikesÂØπË±°Â≠òÂú®
                    if (!momentData.likes) {
                        momentData.likes = {
                            count: 0,
                            userLiked: false,
                            likedBy: [],
                            lastLikeTime: null
                        };
                    }
                    
                    // ÂàáÊç¢ÁÇπËµûÁä∂ÊÄÅ
                    const wasLiked = momentData.likes.userLiked;
                    if (wasLiked) {
                        // ÂèñÊ∂àÁÇπËµû
                        momentData.likes.userLiked = false;
                        momentData.likes.count = Math.max(0, momentData.likes.count - 1);
                        momentData.likes.likedBy = momentData.likes.likedBy.filter(name => name !== userName);
                        momentData.likes.lastLikeTime = new Date().toISOString();
                        
                        console.log(`‚úÖ Â∑≤ÂèñÊ∂àÁÇπËµûÂä®ÊÄÅ: ${momentId}`);
                    } else {
                        // Ê∑ªÂä†ÁÇπËµû
                        momentData.likes.userLiked = true;
                        momentData.likes.count += 1;
                        if (!momentData.likes.likedBy.includes(userName)) {
                            momentData.likes.likedBy.push(userName);
                        }
                        momentData.likes.lastLikeTime = new Date().toISOString();
                        
                        console.log(`‚úÖ Â∑≤ÁÇπËµûÂä®ÊÄÅ: ${momentId}`);
                    }
                    
                    // Êõ¥Êñ∞UI
                    QQ_UpdateLikeUI(momentId, momentData.likes);
                    
                    // ÊòæÁ§∫ÁÇπËµûÊèêÁ§∫
                    QQ_ShowLikePopup(momentId, !wasLiked, userName);
                    
                    // ‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶
                    await QQ_Save_Moments();
                    console.log('ÁÇπËµûÁä∂ÊÄÅÂ∑≤‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶');
                    
                    // Â¶ÇÊûúÊòØÁÇπËµûÔºàÈùûÂèñÊ∂àÔºâÔºåËÆ∞ÂΩïÁî®‰∫éAIÂèçÂ∫î
                    if (!wasLiked) {
                        await QQ_RecordLikeForAI(momentData, userName);
                    }
                    
                    return true;
                } catch (error) {
                    console.error('ÁÇπËµûÊìç‰ΩúÂ§±Ë¥•:', error);
                    return false;
                }
            };

            /**
             * Êõ¥Êñ∞ÁÇπËµûUI
             * @param {string} momentId - Âä®ÊÄÅID
             * @param {Object} likes - ÁÇπËµûÊï∞ÊçÆ
             */
            window.QQ_UpdateLikeUI = function(momentId, likes) {
                try {
                    const momentElement = $(`.user_moment[data-moment-id="${momentId}"]`);
                    if (momentElement.length === 0) {
                        console.warn(`Êú™ÊâæÂà∞Âä®ÊÄÅÂÖÉÁ¥†: ${momentId}`);
                        return;
                    }
                    
                    // ÊîØÊåÅ‰∏§ÁßçÁ±ªÂûãÁöÑÁÇπËµûÊåâÈíÆ
                    
                    // Á±ªÂûã1ÔºöDiscordÂç°Áâá‰∏≠ÁöÑ.moment-like-button
                    const discordLikeButton = momentElement.find(`.moment-like-button[data-moment-id="${momentId}"]`);
                    const discordLikeCount = momentElement.find(`.moment-like-count`);
                    
                    if (discordLikeButton.length > 0) {
                        // DiscordÂç°ÁâáÊ†∑ÂºèÊõ¥Êñ∞
                        if (likes.userLiked) {
                            discordLikeButton.css('color', '#1677ff');
                            discordLikeButton.addClass('liked');
                        } else {
                            discordLikeButton.css('color', '#000000');
                            discordLikeButton.removeClass('liked');
                        }
                        discordLikeCount.text(likes.count);
                    }
                    
                    // Á±ªÂûã2ÔºöÂä®ÊÄÅÊ®°Êùø‰∏≠ÁöÑÁÇπËµûÁªìÊûÑÔºàÂê´üëçÁöÑSVGÈÉ®ÂàÜÔºâ
                    const momentLikeSection = momentElement.find('span:contains("‰∫∫Â∑≤Ëµû")').parent();
                    const momentLikeText = momentElement.find('span:contains("‰∫∫Â∑≤Ëµû")');
                    
                    if (momentLikeText.length > 0) {
                        // Êõ¥Êñ∞Âä®ÊÄÅÊ®°Êùø‰∏≠ÁöÑÁÇπËµûÊñáÊú¨
                        momentLikeText.text(`${likes.count}‰∫∫Â∑≤Ëµû`);
                        
                        // Êü•ÊâæÂåÖÂê´üëçÁöÑSVGÔºàÈÄöËøápathÁâπÂæÅËØÜÂà´Ôºâ
                        const thumbsUpSvg = momentElement.find('.moment_button svg').filter(function() {
                            const pathContent = $(this).find('path').attr('d');
                            return pathContent && pathContent.includes('471.411583');
                        });
                        
                        if (thumbsUpSvg.length > 0) {
                            const thumbPath = thumbsUpSvg.find('path');
                            if (likes.userLiked) {
                                // ÁÇπËµûÁä∂ÊÄÅÔºöËìùËâ≤ + ÂèëÂÖâÊïàÊûú
                                thumbPath.attr('fill', '#1677ff');
                                thumbsUpSvg.css({
                                    'filter': 'drop-shadow(0 0 8px #1677ff)',
                                    'transform': 'scale(1.2)',
                                    'transition': 'all 0.3s ease',
                                    'cursor': 'pointer'
                                }).addClass('liked-thumb');
                                
                                // Ê∑ªÂä†ËÑâÂÜ≤Âä®Áîª
                                if (!thumbsUpSvg.hasClass('pulse-animation')) {
                                    thumbsUpSvg.addClass('pulse-animation');
                                    setTimeout(() => thumbsUpSvg.removeClass('pulse-animation'), 800);
                                }
                            } else {
                                // Êú™ÁÇπËµûÁä∂ÊÄÅÔºöÊÅ¢Â§çÂéüËâ≤
                                thumbPath.attr('fill', '#000000');
                                thumbsUpSvg.css({
                                    'filter': 'none',
                                    'transform': 'scale(1)',
                                    'transition': 'all 0.3s ease',
                                    'cursor': 'pointer'
                                }).removeClass('liked-thumb pulse-animation');
                            }
                        }
                        
                        // Â§ÑÁêÜÁî®Êà∑Â∑≤ÁÇπËµûÊèêÁ§∫
                        const userLikedTip = momentLikeText.next('.user-liked-tip');
                        if (likes.userLiked) {
                            if (userLikedTip.length === 0) {
                                // Ê∑ªÂä†Áî®Êà∑Â∑≤ÁÇπËµûÊèêÁ§∫
                                momentLikeText.after('<div class="user-liked-tip" style="color:#1677ff;font-size:11px;margin-top:2px;font-weight:500;">‚úì ‰Ω†Â∑≤ÁÇπËµû</div>');
                            }
                        } else {
                            // ÁßªÈô§Áî®Êà∑Â∑≤ÁÇπËµûÊèêÁ§∫
                            userLikedTip.remove();
                        }
                    }
                    
                    console.log(`‚úÖ Â∑≤Êõ¥Êñ∞Âä®ÊÄÅ ${momentId} ÁöÑÁÇπËµûUI: ${likes.count}‰∫∫Â∑≤Ëµû, Áî®Êà∑Â∑≤ÁÇπËµû: ${likes.userLiked}`);
                } catch (error) {
                    console.error('Êõ¥Êñ∞ÁÇπËµûUIÂ§±Ë¥•:', error);
                }
            };

            /**
             * ÊòæÁ§∫ÁÇπËµûÂºπÁ™óÊèêÁ§∫
             * @param {string} momentId - Âä®ÊÄÅID
             * @param {boolean} isLike - ÊòØÂê¶‰∏∫ÁÇπËµûÔºàtrueÔºâËøòÊòØÂèñÊ∂àÁÇπËµûÔºàfalseÔºâ
             * @param {string} userName - Áî®Êà∑Âêç
             */
            window.QQ_ShowLikePopup = function(momentId, isLike, userName) {
                try {
                    const momentElement = $(`.user_moment[data-moment-id="${momentId}"]`);
                    const popup = momentElement.find('.moment-like-popup');
                    
                    if (isLike) {
                        popup.text(`${userName}Â∑≤ÁÇπËµû`).show();
                    } else {
                        popup.text(`${userName}Â∑≤ÂèñÊ∂àÁÇπËµû`).show();
                    }
                    
                    // 2ÁßíÂêéËá™Âä®ÈöêËóè
                    setTimeout(() => {
                        popup.fadeOut(300);
                    }, 2000);
                } catch (error) {
                    console.error('ÊòæÁ§∫ÁÇπËµûÂºπÁ™óÂ§±Ë¥•:', error);
                }
            };

            /**
             * ËÆ∞ÂΩïÁÇπËµû‰ø°ÊÅØ‰æõAIÂèçÂ∫î‰ΩøÁî®
             * @param {Object} momentData - Âä®ÊÄÅÊï∞ÊçÆ
             * @param {string} userName - Áî®Êà∑Âêç
             */
            window.QQ_RecordLikeForAI = async function(momentData, userName) {
                try {
                    // ÂàõÂª∫ÁÇπËµûËÆ∞ÂΩï
                    const likeRecord = {
                        type: 'moment_like',
                        momentId: momentData.id,
                        momentAuthor: momentData.userName,
                        momentContent: momentData.message.substring(0, 100), // Êà™ÂèñÂâç100Â≠óÁ¨¶
                        likedBy: userName,
                        likeTime: new Date().toISOString(),
                        totalLikes: momentData.likes.count,
                        context: `Áî®Êà∑"${userName}"ÂØπ"${momentData.userName}"ÂèëÂ∏ÉÁöÑÂä®ÊÄÅËøõË°å‰∫ÜÁÇπËµû„ÄÇÂä®ÊÄÅÂÜÖÂÆπÔºö"${momentData.message.substring(0, 50)}${momentData.message.length > 50 ? '...' : ''}"„ÄÇÂΩìÂâçËØ•Âä®ÊÄÅÂÖ±Êúâ${momentData.likes.count}‰∫∫ÁÇπËµû„ÄÇ`
                    };
                    
                    // ‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶Áî®‰∫éAIÂèçÂ∫î
                    const result = await QQ_SafeSaveToWorldBook('ÁÇπËµûËÆ∞ÂΩï', likeRecord, 'QQ_ÁÇπËµûËÆ∞ÂΩïÂ§á‰ªΩ');
                    if (result) {
                        console.log('‚úÖ ÁÇπËµûËÆ∞ÂΩïÂ∑≤‰øùÂ≠òÔºåAIÂèØÂú®‰∏ãÊ¨°ÂØπËØù‰∏≠Ëé∑ÂèñÊ≠§‰ø°ÊÅØ');
                    }
                } catch (error) {
                    console.error('ËÆ∞ÂΩïÁÇπËµû‰ø°ÊÅØÂ§±Ë¥•:', error);
                }
            };

            /**
             * ÂàùÂßãÂåñÂä®ÊÄÅÁÇπËµûÂäüËÉΩ
             */
            window.QQ_InitMomentLikes = function() {
                try {
                    // Á±ªÂûã1ÔºöÁªëÂÆöDiscordÂç°Áâá‰∏≠ÁöÑÁÇπËµûÊåâÈíÆ
                    $(document).off('click', '.moment-like-button').on('click', '.moment-like-button', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const momentId = $(this).data('moment-id');
                        if (momentId) {
                            QQ_LikeMoment(momentId);
                        }
                    });
                    
                    // Á±ªÂûã2ÔºöÁªëÂÆöÂä®ÊÄÅÊ®°Êùø‰∏≠ÁöÑüëçÁÇπËµûÂå∫Âüü
                    $(document).off('click', '.moment_button svg').on('click', '.moment_button svg', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Êü•ÊâæÂä®ÊÄÅID - Âêë‰∏äÊü•ÊâæÂåÖÂê´data-moment-idÁöÑÂÖÉÁ¥†
                        const momentElement = $(this).closest('.user_moment[data-moment-id]');
                        const momentId = momentElement.data('moment-id');
                        
                        if (momentId) {
                            // Âà§Êñ≠ËøôÊòØÂê¶ÊòØÁÇπËµûÊåâÈíÆÔºàÈÄöËøáË∑ØÂæÑÂÜÖÂÆπÊàñÁà∂ÂÖÉÁ¥†Âà§Êñ≠Ôºâ
                            const svgPath = $(this).find('path').attr('d');
                            // Ê£ÄÊü•ÊòØÂê¶ÊòØüëçÊåâÈíÆÔºàÊ†πÊçÆSVG pathÁâπÂæÅÂà§Êñ≠Ôºâ
                            if (svgPath && svgPath.includes('471.411583')) { // ËøôÊòØüëçÊåâÈíÆÁöÑpathÁâπÂæÅ
                                QQ_LikeMoment(momentId);
                            }
                        }
                    });
                    
                    // Á±ªÂûã3ÔºöÁõ¥Êé•ÁªëÂÆöÂåÖÂê´"‰∫∫Â∑≤Ëµû"ÊñáÊú¨ÁöÑÂå∫Âüü
                    $(document).off('click', 'span:contains("‰∫∫Â∑≤Ëµû")').on('click', 'span:contains("‰∫∫Â∑≤Ëµû")', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const momentElement = $(this).closest('.user_moment[data-moment-id]');
                        const momentId = momentElement.data('moment-id');
                        
                        if (momentId) {
                            QQ_LikeMoment(momentId);
                        }
                    });
                    
                    console.log('‚úÖ Âä®ÊÄÅÁÇπËµûÂäüËÉΩÂ∑≤ÂàùÂßãÂåñÔºàÊîØÊåÅÂ§öÁßçÁÇπËµûÊåâÈíÆÁ±ªÂûãÔºâ');
                } catch (error) {
                    console.error('ÂàùÂßãÂåñÂä®ÊÄÅÁÇπËµûÂäüËÉΩÂ§±Ë¥•:', error);
                }
            };

            /**
             * Âä†ËΩΩÂ∑≤ÊúâÂä®ÊÄÅÁöÑÁÇπËµûÁä∂ÊÄÅ
             */
            window.QQ_LoadMomentLikes = async function() {
                try {
                    if (!QQ_MomentsData || QQ_MomentsData.length === 0) {
                        return;
                    }
                    
                    const userName = QQ_GetUserName();
                    if (!userName) {
                        return;
                    }
                    
                    // Êõ¥Êñ∞ÊâÄÊúâÂä®ÊÄÅÁöÑÁÇπËµûUI
                    for (const momentData of QQ_MomentsData) {
                        if (momentData.likes) {
                            QQ_UpdateLikeUI(momentData.id, momentData.likes);
                        }
                    }
                    
                    console.log('‚úÖ Â∑≤Âä†ËΩΩÂä®ÊÄÅÁÇπËµûÁä∂ÊÄÅ');
                } catch (error) {
                    console.error('Âä†ËΩΩÂä®ÊÄÅÁÇπËµûÁä∂ÊÄÅÂ§±Ë¥•:', error);
                }
            };

            /**
             * ÊµãËØïÁÇπËµûÂäüËÉΩ
             */
            window.QQ_Test_Like_Function = function() {
                console.log('=== ÊµãËØïÂä®ÊÄÅÁÇπËµûÂäüËÉΩ ===');
                console.log('üîç Ê£ÄÊü•ÁÇπËµûÂäüËÉΩÁä∂ÊÄÅ...');
                
                // Ê£ÄÊü•Êï∞ÊçÆÁªìÊûÑ
                if (typeof QQ_MomentsData === 'undefined' || QQ_MomentsData.length === 0) {
                    console.warn('‚ö†Ô∏è Ê≤°ÊúâÂä®ÊÄÅÊï∞ÊçÆÂèØ‰æõÊµãËØï');
                    return;
                }
                
                console.log(`‚úÖ ÊâæÂà∞ ${QQ_MomentsData.length} Êù°Âä®ÊÄÅÊï∞ÊçÆ`);
                
                // Ê£ÄÊü•Á¨¨‰∏ÄÊù°Âä®ÊÄÅÁöÑÁÇπËµûÊï∞ÊçÆ
                const firstMoment = QQ_MomentsData[0];
                console.log('üìä Á¨¨‰∏ÄÊù°Âä®ÊÄÅÁöÑÁÇπËµûÊï∞ÊçÆ:', firstMoment.likes);
                
                // Ê£ÄÊü•UIÂÖÉÁ¥†
                const likeButtons = $('.moment-like-button');
                console.log(`üéØ ÊâæÂà∞ ${likeButtons.length} ‰∏™ÁÇπËµûÊåâÈíÆ`);
                
                if (likeButtons.length > 0) {
                    const firstButton = likeButtons.first();
                    const momentId = firstButton.data('moment-id');
                    console.log(`üß™ ÊµãËØïÁÇπËµûÁ¨¨‰∏ÄÊù°Âä®ÊÄÅ: ${momentId}`);
                    
                    if (momentId) {
                        QQ_LikeMoment(momentId);
                    }
                } else {
                    console.warn('‚ö†Ô∏è Êú™ÊâæÂà∞ÁÇπËµûÊåâÈíÆÔºåËØ∑Á°Æ‰øùÈ°µÈù¢Â∑≤Âä†ËΩΩÂä®ÊÄÅ');
                }
                
                triggerSlash('/echo ‚úÖ ÁÇπËµûÂäüËÉΩÊµãËØïÂÆåÊàêÔºåËØ∑Êü•ÁúãÊéßÂà∂Âè∞ËØ¶ÁªÜÁªìÊûú');
            };

            /**
             * *** Êñ∞Â¢ûÔºöÈîôËØØÊ£ÄÊü•ÂíåË∞ÉËØïÂáΩÊï∞ ***
             */
            window.QQ_Check_Errors = function() {
                console.log('=== üîç ÈîôËØØÊ£ÄÊü•ÂºÄÂßã ===');
                
                const results = {
                    momentsDataCheck: false,
                    functionsCheck: false,
                    nextVariableCheck: false,
                    arrayOperationsCheck: false,
                    groupsDataCheck: false
                };
                
                try {
                    // Ê£ÄÊü•QQ_MomentsData
                    if (typeof QQ_MomentsData !== 'undefined' && Array.isArray(QQ_MomentsData)) {
                        console.log('‚úÖ QQ_MomentsData Â∑≤Ê≠£Á°ÆÂÆö‰πâÔºåÁ±ªÂûã‰∏∫Êï∞ÁªÑÔºåÈïøÂ∫¶:', QQ_MomentsData.length);
                        results.momentsDataCheck = true;
                    } else {
                        console.warn('‚ö†Ô∏è QQ_MomentsData Êú™ÂÆö‰πâÊàñ‰∏çÊòØÊï∞ÁªÑ:', typeof QQ_MomentsData);
                    }
                    
                    // Ê£ÄÊü•Áæ§ËÅäÁõ∏ÂÖ≥Êï∞ÊçÆ
                    console.log('üß™ Ê£ÄÊü•Áæ§ËÅäÊï∞ÊçÆÁªìÊûÑ...');
                    if (typeof loadGroupsFromStorage === 'function') {
                        console.log('‚úÖ loadGroupsFromStorage ÂáΩÊï∞Â∑≤ÂÆö‰πâ');
                        try {
                            const groupsResult = loadGroupsFromStorage();
                            if (groupsResult && typeof groupsResult.then === 'function') {
                                // Â¶ÇÊûúËøîÂõûPromise
                                groupsResult.then(groups => {
                                    if (groups && Array.isArray(groups)) {
                                        console.log('‚úÖ Áæ§ËÅäÊï∞ÊçÆÂä†ËΩΩÊ≠£Â∏∏ÔºåÊï∞Èáè:', groups.length);
                                    } else {
                                        console.warn('‚ö†Ô∏è Áæ§ËÅäÊï∞ÊçÆÊó†Êïà:', groups);
                                    }
                                }).catch(e => {
                                    console.warn('‚ö†Ô∏è Áæ§ËÅäÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•:', e);
                                });
                            } else if (Array.isArray(groupsResult)) {
                                // Â¶ÇÊûúÁõ¥Êé•ËøîÂõûÊï∞ÁªÑ
                                console.log('‚úÖ Áæ§ËÅäÊï∞ÊçÆÂä†ËΩΩÊ≠£Â∏∏ÔºàÂêåÊ≠•ÔºâÔºåÊï∞Èáè:', groupsResult.length);
                            } else {
                                console.warn('‚ö†Ô∏è loadGroupsFromStorage ËøîÂõûÂÄºÊó†Êïà:', typeof groupsResult);
                            }
                        } catch (e) {
                            console.warn('‚ö†Ô∏è Áæ§ËÅäÊï∞ÊçÆÂêåÊ≠•Ê£ÄÊü•Â§±Ë¥•:', e);
                        }
                        results.groupsDataCheck = true;
                    } else {
                        console.warn('‚ö†Ô∏è loadGroupsFromStorage ÂáΩÊï∞Êú™ÂÆö‰πâ');
                    }
                    
                    // Ê£ÄÊü•ÂÖ≥ÈîÆÂáΩÊï∞
                    const functionList = ['QQ_Save_Moments', 'QQ_CleanOldMoments', 'QQ_OptimizeCommentsStorage', 'QQ_SendMsg', 'updateGroupLastMessageDisplay'];
                    let allFunctionsExist = true;
                    functionList.forEach(funcName => {
                        if (typeof window[funcName] === 'function') {
                            console.log(`‚úÖ ${funcName} ÂáΩÊï∞Â∑≤ÂÆö‰πâ`);
                        } else {
                            console.warn(`‚ö†Ô∏è ${funcName} ÂáΩÊï∞Êú™ÂÆö‰πâ`);
                            allFunctionsExist = false;
                        }
                    });
                    results.functionsCheck = allFunctionsExist;
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÊúâÊú™ÂÆö‰πâÁöÑnextÂèòÈáèÂºïÁî®
                    try {
                        if (typeof next !== 'undefined') {
                            console.log('‚ö†Ô∏è Ê£ÄÊµãÂà∞ÂÖ®Â±ÄnextÂèòÈáè:', next);
                        } else {
                            console.log('‚úÖ Ê≤°ÊúâÊ£ÄÊµãÂà∞ÂÖ®Â±ÄnextÂèòÈáèÔºàËøôÊòØÊ≠£Â∏∏ÁöÑÔºâ');
                            results.nextVariableCheck = true;
                        }
                    } catch (e) {
                        console.log('‚úÖ nextÂèòÈáèÊú™ÂÆö‰πâÔºàËøôÊòØÈ¢ÑÊúüÁöÑÔºâ');
                        results.nextVariableCheck = true;
                    }
                    
                    // ÊµãËØïÊï∞ÁªÑÊìç‰ΩúÂÆâÂÖ®ÊÄß
                    console.log('üß™ ÊµãËØïÊï∞ÁªÑÊìç‰ΩúÂÆâÂÖ®ÊÄß...');
                    if (QQ_MomentsData && Array.isArray(QQ_MomentsData)) {
                        try {
                            let testCount = 0;
                            QQ_MomentsData.forEach(moment => {
                                testCount++;
                            });
                            console.log(`‚úÖ QQ_MomentsData.forEach Êìç‰ΩúÊ≠£Â∏∏ÔºåÈÅçÂéÜ‰∫Ü ${testCount} ‰∏™ÂÖÉÁ¥†`);
                            results.arrayOperationsCheck = true;
                        } catch (e) {
                            console.error('‚ùå QQ_MomentsData.forEach Êìç‰ΩúÂ§±Ë¥•:', e);
                        }
                    } else {
                        console.log('‚ö†Ô∏è Ë∑≥ËøáÊï∞ÁªÑÊìç‰ΩúÊµãËØïÔºåÂõ†‰∏∫QQ_MomentsData‰∏çÂèØÁî®');
                    }
                    
                    // ÊµãËØïÊ∏ÖÁêÜÂáΩÊï∞
                    console.log('üß™ ÊµãËØïÊ∏ÖÁêÜÂáΩÊï∞...');
                    try {
                        if (typeof QQ_CleanOldMoments === 'function') {
                            QQ_CleanOldMoments();
                            console.log('‚úÖ QQ_CleanOldMoments ÂáΩÊï∞ÊâßË°åÊ≠£Â∏∏');
                        }
                        if (typeof QQ_OptimizeCommentsStorage === 'function') {
                            QQ_OptimizeCommentsStorage();
                            console.log('‚úÖ QQ_OptimizeCommentsStorage ÂáΩÊï∞ÊâßË°åÊ≠£Â∏∏');
                        }
                    } catch (e) {
                        console.error('‚ùå Ê∏ÖÁêÜÂáΩÊï∞ÊµãËØïÂ§±Ë¥•:', e);
                    }
                    
                    // Ê∑ªÂä†ÈîôËØØÁõëÂê¨Âô®Êù•ÊçïËé∑ËøêË°åÊó∂ÈîôËØØ
                    window.addEventListener('error', function(e) {
                        if (e.message.includes('next is not defined')) {
                            console.error('üö® ÊçïËé∑Âà∞nextÊú™ÂÆö‰πâÈîôËØØ:', e);
                            console.error('ÈîôËØØ‰ΩçÁΩÆ:', e.filename, 'Ë°åÂè∑:', e.lineno);
                            console.error('ÈîôËØØÂ†ÜÊ†à:', e.error ? e.error.stack : 'Êó†Â†ÜÊ†à‰ø°ÊÅØ');
                        }
                    });
                    
                } catch (error) {
                    console.error('‚ùå ÈîôËØØÊ£ÄÊü•ËøáÁ®ã‰∏≠Âá∫Áé∞ÂºÇÂ∏∏:', error);
                }
                
                console.log('=== üìä ÈîôËØØÊ£ÄÊü•ÁªìÊûú ===', results);
                console.log('=== ‚úÖ ÈîôËØØÊ£ÄÊü•ÂÆåÊàê ===');
                
                // ÊòæÁ§∫ÁªìÊûú
                const passedTests = Object.values(results).filter(Boolean).length;
                const totalTests = Object.keys(results).length;
                triggerSlash(`/echo üîç ÈîôËØØÊ£ÄÊü•ÂÆåÊàê: ${passedTests}/${totalTests} È°πÊ£ÄÊü•ÈÄöËøá`);
                
                return results;
            };
            
            /**
             * *** Êñ∞Â¢ûÔºö‰∏ìÈó®Ê£ÄÊü•QQ_SendMsgÂáΩÊï∞ÁöÑÈîôËØØ ***
             */
            window.QQ_Debug_SendMsg = function() {
                console.log('=== üîß QQ_SendMsg Ë∞ÉËØïÂºÄÂßã ===');
                
                try {
                    // Ê£ÄÊü•QQ_SendMsgÂáΩÊï∞ÂÆö‰πâ
                    if (typeof QQ_SendMsg === 'function') {
                        console.log('‚úÖ QQ_SendMsg ÂáΩÊï∞Â∑≤ÂÆö‰πâ');
                        
                        // Ëé∑ÂèñÂáΩÊï∞Ê∫êÁ†ÅÂπ∂Ê£ÄÊü•ÊòØÂê¶ÊúânextÂºïÁî®
                        const funcStr = QQ_SendMsg.toString();
                        if (funcStr.includes('next(') || funcStr.includes('next;')) {
                            console.warn('‚ö†Ô∏è QQ_SendMsg ÂáΩÊï∞‰∏≠ÂèØËÉΩÂåÖÂê´nextÂèòÈáèÂºïÁî®');
                            
                            // Â∞ùËØïÊâæÂà∞nextÂºïÁî®ÁöÑ‰ΩçÁΩÆ
                            const lines = funcStr.split('\n');
                            lines.forEach((line, index) => {
                                if (line.includes('next') && !line.includes('.next(')) {
                                    console.warn(`‚ö†Ô∏è Á¨¨${index + 1}Ë°åÂèØËÉΩÊúâÈóÆÈ¢ò: ${line.trim()}`);
                                }
                            });
                        } else {
                            console.log('‚úÖ QQ_SendMsg ÂáΩÊï∞‰∏≠Êú™ÂèëÁé∞Áõ¥Êé•ÁöÑnextÂèòÈáèÂºïÁî®');
                        }
                    } else {
                        console.error('‚ùå QQ_SendMsg ÂáΩÊï∞Êú™ÂÆö‰πâ');
                        return;
                    }
                    
                } catch (error) {
                    console.error('‚ùå QQ_SendMsg Ë∞ÉËØïËøáÁ®ã‰∏≠Âá∫Áé∞ÂºÇÂ∏∏:', error);
                }
                
                console.log('=== ‚úÖ QQ_SendMsg Ë∞ÉËØïÂÆåÊàê ===');
            };
            
            /**
             * *** Êñ∞Â¢ûÔºö‰øÆÂ§çQQ_GenÂõûË∞ÉÂáΩÊï∞ÈóÆÈ¢ò ***
             */
            window.QQ_Fix_Next_Error = function() {
                console.log('=== üîß ‰øÆÂ§çQQ_GenÂõûË∞ÉÂáΩÊï∞ÈóÆÈ¢òÂºÄÂßã ===');
                
                try {
                    // Ê£ÄÊü•QQ_GenÂáΩÊï∞ÊòØÂê¶Ê≠£Á°ÆÊîØÊåÅÂõûË∞É
                    if (typeof QQ_Gen === 'function') {
                        const funcStr = QQ_Gen.toString();
                        if (funcStr.includes('callback')) {
                            console.log('‚úÖ QQ_GenÂáΩÊï∞Â∑≤Ê≠£Á°ÆÊîØÊåÅÂõûË∞ÉÂèÇÊï∞');
                        } else {
                            console.warn('‚ö†Ô∏è QQ_GenÂáΩÊï∞ÂèØËÉΩ‰∏çÊîØÊåÅÂõûË∞ÉÂèÇÊï∞');
                        }
                    }
                    
                    // È™åËØÅÊµãËØï‰∏Ä‰∏™ÁÆÄÂçïÁöÑQQ_GenË∞ÉÁî®
                    console.log('üß™ ÊµãËØïQQ_GenÂõûË∞ÉÂäüËÉΩ...');
                    if (typeof QQ_Gen === 'function') {
                        QQ_Gen('ÊµãËØïÊèêÁ§∫ËØç', function(response) {
                            console.log('‚úÖ QQ_GenÂõûË∞ÉÊµãËØïÊàêÂäüÔºåÊî∂Âà∞ÂìçÂ∫î:', response ? 'ÊúâÂìçÂ∫î' : 'Êó†ÂìçÂ∫î');
                        }).catch(error => {
                            console.warn('‚ö†Ô∏è QQ_GenÂõûË∞ÉÊµãËØïÂ§±Ë¥•:', error);
                        });
                    }
                    
                } catch (error) {
                    console.error('‚ùå ‰øÆÂ§çQQ_GenÂõûË∞ÉÂáΩÊï∞ÈóÆÈ¢òËøáÁ®ã‰∏≠Âá∫Áé∞ÂºÇÂ∏∏:', error);
                }
                
                console.log('=== ‚úÖ ‰øÆÂ§çQQ_GenÂõûË∞ÉÂáΩÊï∞ÈóÆÈ¢òÂÆåÊàê ===');
            };
            
            // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéËá™Âä®ÊâßË°å‰∏ÄÊ¨°Ê£ÄÊü•
            $(document).ready(function() {
                setTimeout(() => {
                    console.log('üîç Ëá™Âä®ÊâßË°åÈîôËØØÊ£ÄÊü•...');
                    QQ_Check_Errors();
                    
                    // È¢ùÂ§ñÊâßË°åË∞ÉËØïÂíå‰øÆÂ§ç
                    setTimeout(() => {
                        QQ_Debug_SendMsg();
                        QQ_Fix_Next_Error();
                    }, 1000);
                }, 3000);
            });
            
        </script>
    </body>
</html>