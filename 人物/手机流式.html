<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>Document</title>
        <style type="text/css">
            @import url(https://static.zeoseven.com/zsft/59/main/result.css);
            .QQ_chat_page {
                padding-top: 10px;
                background-color: rgb(244, 245, 246);
                width: 100%;
                height: 100%;
                /* å¡«æ»¡è§†å£é«˜åº¦ */
                /* background-image: url("http://sharkpan.xyz/f/eWhZ/00017-2763077315.png"); */
                background-size: cover;
                background-repeat: no-repeat;
                background-position: top center;
                display: flex;
                flex-direction: column;
                overflow-y: auto;
                /* å…è®¸å†…å®¹åŒºåŸŸå‚ç›´æ»šåŠ¨ */
                box-sizing: border-box;
                /* é˜²æ­¢å†…è¾¹è·æº¢å‡º */
                border-radius: var(--yj);
                /* padding-bottom: 60px; */

                position: relative;
                overflow-x: hidden;

                /* z-index: 9999; */
                /* font-family: "å­—é­‚èŒå® å¤©åœ°ä½“"; */
            }

            .input-container {
                max-width: 100%;
                position: absolute;
                /* bottom: 20px; */
                bottom: 0px;
                left: 0;
                width: 100%;
                background-color: rgb(255, 255, 255, 0.2);
                border-bottom-right-radius: 10px;
                border-bottom-left-radius: 10px;
                box-sizing: border-box;
                padding: 10px 0;
                border-top: 1px solid black;
            }

            /* äº’åŠ¨æ¨¡å¼åˆ‡æ¢å¼€å…³æ ·å¼ */
            .interactive-mode-switch {
                position: absolute;
                left: 10px;
                top: -25px;
                display: none;
                z-index: 100;
                animation: slideDown 0.3s ease;
            }

            .interactive-mode-switch.visible {
                display: flex;
            }

            .interactive-mode-button {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.9);
                border: 2px solid #ddd;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                backdrop-filter: blur(10px);
            }

            .interactive-mode-button:hover {
                transform: scale(1.1);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            }

            .interactive-mode-button.active {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-color: #667eea;
                transform: scale(1.05);
            }

            .interactive-mode-button.active:hover {
                transform: scale(1.15);
            }

            .interactive-mode-icon {
                font-size: 16px;
                color: #666;
                transition: all 0.3s ease;
            }

            .interactive-mode-button.active .interactive-mode-icon {
                color: white;
                animation: sparkle 1s ease infinite;
            }

            @keyframes sparkle {
                0%, 100% { 
                    transform: scale(1);
                    opacity: 1;
                }
                50% { 
                    transform: scale(1.1);
                    opacity: 0.8;
                }
            }

            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* äº’åŠ¨å†…å®¹æ¶ˆæ¯æ ·å¼ */
            .interactive-message {
                position: relative;
                overflow: hidden;
            }

            .interactive-message:before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
                animation: shimmer 2s infinite;
            }

            @keyframes shimmer {
                0% {
                    left: -100%;
                }
                100% {
                    left: 100%;
                }
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* äº’åŠ¨å†…å®¹æ–‡æœ¬å…‰æ ‡æ•ˆæœ */
            .interactive-text::after {
                content: '|';
                animation: blink 1s infinite;
                opacity: 0;
            }

            .interactive-text.typing::after {
                opacity: 1;
            }

            @keyframes blink {
                0%, 50% {
                    opacity: 1;
                }
                51%, 100% {
                    opacity: 0;
                }
            }

            .msgcontent {
                flex: 1;
                overflow-y: auto;
                box-sizing: border-box;
                /* margin-top: 20px; */
                margin-bottom: 50px;
                padding-left: 8px;
                padding-right: 8px;
                scrollbar-width: none;
                /* Firefox */
                -ms-overflow-style: none;
                /* IE and Edge */
            }

            .userInput {
                font: inherit;
                height: 30px;
                border-radius: 30px;
                letter-spacing: 0.7px;
                width: 100%;
                padding-left: 10px;
                padding-right: 10px;
                border: 1px solid rgb(0, 0, 0, 0.5);
            }

            /* èŠå¤©è®¾ç½®å¼¹çª—æ ·å¼ */
            .chat-setting-popup {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 80%;
                max-width: 350px;
                background-color: #fff;
                border-radius: 10px;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
                z-index: 1000;
                display: none;
            }

            .chat-setting-header {
                padding: 15px;
                border-bottom: 1px solid #eee;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .chat-setting-header span {
                font-weight: bold;
                font-size: 16px;
            }

            .close-setting-btn {
                cursor: pointer;
            }

            .chat-setting-content {
                padding: 15px;
            }

            .setting-item {
                margin-bottom: 15px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 10px;
            }

            .setting-item span {
                font-size: 14px;
            }

            .setting-item input[type="text"] {
                flex: 1;
                padding: 5px;
                border: 1px solid #ccc;
                border-radius: 5px;
            }

            .color-picker {
                width: 30px;
                height: 30px;
                padding: 0;
                border: 1px solid #ccc;
                border-radius: 3px;
                cursor: pointer;
            }

            .chat-setting-footer {
                padding: 10px 15px;
                text-align: right;
                border-top: 1px solid #eee;
            }

            .chat-setting-footer button {
                padding: 6px 15px;
                margin-left: 10px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
            }

            #save-setting-btn {
                background-color: #019aff;
                color: white;
            }

            #cancel-setting-btn {
                background-color: #f5f5f5;
                color: #333;
            }

            /* å¼¹çª—é®ç½©å±‚ */
            .popup-overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                border-radius: 35px;
                z-index: 999;
                display: none;
            }

            /* æœç´¢æ¡†æ‚¬æµ®ç›¸å…³æ ·å¼ */
            #floating_search_box:hover {
                background-color: rgba(239, 243, 255, 0.95) !important;
                border-color: rgba(25, 154, 255, 0.4) !important;
                transform: translateY(-1px);
            }

            #contact_search_input::placeholder {
                color: #999;
                font-style: italic;
            }

            #search_clear_btn:hover {
                background-color: #999 !important;
                transform: scale(1.1);
            }

            /* è”ç»œäººåˆ—è¡¨æ»šåŠ¨æ—¶çš„æœç´¢æ¡†æ•ˆæœ */
            #QQ_home_chars::-webkit-scrollbar {
                display: none !important;
            }

            /* æœç´¢ç»“æœé«˜äº®æ ·å¼ */
            .search-highlight {
                background-color: #ffeb3b !important;
                color: #333 !important;
                padding: 1px 2px;
                border-radius: 2px;
                font-weight: bold;
            }

            .QQ_chat_fakeimg {
                width: 100%;
                background-color: white;
                aspect-ratio: 1 / 1;
                padding: 5px 18px 0 20px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                font-size: 1.3em;
                /* overflow-y: auto; */
                -ms-overflow-style: none !important;
                scrollbar-width: none !important;
                text-align: center;
            }

            .QQ_chat_fakeimg::-webkit-scrollbar {
                display: none !important;
            }

            .QQ_chat_fakeimg div {
                max-height: 100%;
                display: flex;
                align-items: flex-start;
                overflow-y: auto;
                -ms-overflow-style: none !important;
                scrollbar-width: none !important;
            }

            .QQ_chat_fakeimg div::-webkit-scrollbar {
                display: none !important;
            }

            .discord {
                background-color: #f2f3f5;
                width: 100%;
                height: 100%;
                line-height: 1.4;
                letter-spacing: 1px;
            }

            .discord-top {
                background-color: white;
                width: 100%;
                height: 80px;
                padding-top: 30px;
                padding-left: 10px;
                display: flex;
                align-items: center;
            }

            .discord-top-title {
                font-size: 20px;
                text-align: center;
                margin-top: -3px;
            }

            .discord-top-button {
                display: flex;
                align-items: center;
                margin-bottom: 10px;
            }

            .sortbutton {
                display: flex;
                align-items: center;
                gap: 4px;
                margin-bottom: -1px;
                height: 32px;
                background-color: #e8e9eb;
                padding: 8px 8px 8px 12px;
                width: fit-content;
                border-radius: 24px;
                margin-top: 10px;
                margin-left: 10px;
            }

            .tagbutton {
                display: flex;
                align-items: center;
                margin-left: auto;
                margin-right: 10px;
                background-color: #e8e9eb;
                padding: 8px 8px 8px 12px;
                width: fit-content;
                height: 32px;
                border-radius: 24px;
                margin-top: 10px;
            }

            .discord-cardlist {
                display: flex;
                flex-direction: column;
                width: 100%;
                height: 100%;
                overflow-y: auto;
                padding: 0 10px 150px 10px;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }

            .discord-cardlist::-webkit-scrollbar {
                display: none !important;
            }

            .discord-card {
                width: 100%;
                height: auto;
                background-color: white;
                border-radius: 15px;
                margin-top: 15px;
                padding-left: 13px;
                padding-right: 13px;
                padding-bottom: 10px;
                border: 1px solid #dfdfe1;
            }

            .discord-card:active {
                background-color: rgb(244, 243, 243);
            }

            .discord-card-tags {
                width: 100%;
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
                padding-top: 10px;
            }

            .discord-card-tag {
                background-color: #eeeff1;
                color: #4f5055;
                width: fit-content;
                padding: 5px 15px;
                border-radius: 24px;
                margin-top: 5px;
                margin-left: -1px;
                font-size: 15px;
                text-align: center;
                font-weight: bold;
            }

            .discord-card-author {
                color: #9d8ef3;
                margin-top: 8px;
                font-size: 18px;
                display: inline-block;
                font-weight: bold;
            }

            .discord-card-title {
                font-weight: bold;
                font-size: 19px;
                margin-top: 5px;

                display: -webkit-box;
                -webkit-box-orient: vertical;
                -webkit-line-clamp: 2;

                /* æ–‡æœ¬æº¢å‡ºæ—¶æ˜¾ç¤ºçœç•¥å· */
                overflow: hidden;
                text-overflow: ellipsis;

                /* ç¡®ä¿æ–‡æœ¬æ¢è¡Œ */
                white-space: normal;
                word-break: break-word;
                /* é¿å…é•¿å•è¯æº¢å‡º */
            }

            .discord-card-content {
                margin-top: 2px;
                color: #313133;
                font-size: 16px;

                display: -webkit-box;
                -webkit-box-orient: vertical;
                -webkit-line-clamp: 3;

                /* æ–‡æœ¬æº¢å‡ºæ—¶æ˜¾ç¤ºçœç•¥å· */
                overflow: hidden;
                text-overflow: ellipsis;

                /* ç¡®ä¿æ–‡æœ¬æ¢è¡Œ */
                white-space: normal;
                word-break: break-word;
                /* é¿å…é•¿å•è¯æº¢å‡º */
            }

            .discord-card-interact {
                display: flex;
                align-items: center;
                margin-top: 15px;
            }

            .discord-card-interact-icon {
                margin-left: auto;
                color: #333237;
                background-color: #ececec;
                border-radius: 10px;
                font-size: 16px;
                padding: 2px 8px 2px 6px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .discord-card-fakeimg {
                text-align: center;
                margin-top: 9px;
                font-size: 1.2rem;
                background-color: rgb(239 237 238);
                padding: 30px 10px;
                width: 100%;
                border: 1px solid #dfdfe1;
                border-radius: 5px;
                text-align: center;
                text-wrap: balance;
            }

            .discord-thread {
                width: 100%;
                height: 100%;
                background-color: white;
                padding-top: 30px;
                position: relative;
                /* overflow-x: hidden; */
            }

            .discord-thread-top {
                display: grid;
                grid-template-columns: 32px 43px 1fr;
                align-items: center;
                width: 100%;
                height: 50px;
                padding: 0 10px;
            }

            .discord-thread-title {
                font-weight: bold;
                font-size: 20px;
                overflow: hidden;
                text-overflow: ellipsis;
                width: 100%;
                white-space: nowrap;
            }

            .discord-thread-content {
                overflow-y: auto;
                padding: 0 10px;
                width: 100%;
                height: auto;
            }

            .discord-thread-content-title {
                font-weight: bold;
                font-size: 24px;
                margin-top: 10px;
                margin-bottom: 3px;
            }

            .discord-thread-content-tags {
                width: 100%;
                display: flex;
                flex-wrap: wrap;
                gap: 5px;

                .discord-card-tag {
                    margin-top: 5px;
                }
            }

            .discord-thread-content-original {
                display: grid;
                grid-template-columns: 55px 1fr;
                align-items: start;
                margin-top: 20px;
                margin-bottom: 10px;
            }

            .discord-thread-content-original-author-head {
                width: 45px;
                height: 45px;
                background-size: cover;
                border-radius: 50%;
            }

            .discord-thread-content-original-author-name {
                color: #9d8ef3;
                font-size: 18px;
                display: inline-block;
                font-weight: bold;
            }

            .discord-thread-content-original-content {
                white-space: pre-wrap;
                margin-top: 3px;
            }

            .discord-thread-content-likes {
                width: fit-content;
                padding: 5px 8px 5px 8px;
                text-align: center;
                background-color: #f2f3f5;
                border-radius: 8px;
                display: flex;
                align-items: center;
                gap: 5px;
                color: #525358;
                font-size: 16px;
                height: 34px;
            }

            .discord-thread-content-reaction {
                background-color: #eeeeef;
                padding: 5px;
                align-items: center;
                justify-content: center;
                border-radius: 10px;
                display: flex;
                margin-left: 6px;
                height: 34px;
            }

            .discord-thread-comment-list {
                padding: 0 10px;
                width: 100%;
            }

            .discord-thread-comment {
                display: grid;
                grid-template-columns: 50px 1fr;
                margin-top: 20px;
            }

            .discord-thread-comment-head {
                width: 40px;
                height: 40px;
                background-size: cover;
                border-radius: 50%;
                /* margin-top: 5px; */
            }

            .discord-name-creator {
                color: #9d8ef3;
                font-size: 16px;
                display: inline-block;
                font-weight: bold;
                position: relative;
            }

            .discord-thread-comment-name {
                font-size: 16px;
                display: inline-block;
                font-weight: bold;
                position: relative;
            }

            .discord-thread-comment-content {
                margin-top: 3px;
            }

            .discord-name-creator::after {
                position: absolute;
                top: 0%;
                left: 100%;
                margin-left: 3px;
                height: 20px;
                width: 20px;
                display: inline-block;
                content: "";
                background-size: contain;
                background-image: url("data:image/webp;base64,UklGRkoCAABXRUJQVlA4WAoAAAAQAAAAHQAAHwAAQUxQSIEAAAABcFpt27K8L91pkm0KTxwGIMEO7pYcGolE9BUs0VxHkEqy3/+fl0qKiAkAAEAABEIESdtoYr1SrlBkurFzB8MSPlSiHPsT7Px17MvmHmUXRQmnJRgKU/pBjOknQ3rvo8jHsKRTNYixzZIyAZCOMCRsVkZ7oXk2fRJgrCyWpGOU+CkAVlA4IKIBAABwCQCdASoeACAAPmEoj0WkIqGb/VQAQAYEswBhsa8KA3gFgAdKgvwVsdYAxwUyDx3fSu/J9AD9dBN4HzXUGnIffZmZ+Xi6UOW2PLIrM//asS4J9gAA+nzKAwpZUP5tD9q71GP2da5pzrXFQhw7pRv+CMeoEN+kh+aUE4VmdB7sPfZs8IsDkQx5uoj5AjWh089yG//EwIyr/se6feMyVX1jaa8+MnQrGmsfLaVAoTq9RrJ37OhatyX20m/e/5Ph5E/2P/FpTDWXvb7Ta8uM487hoffTtj8mtyn8Fc4n6KteA//0CAaACYby7EAYe8857OPwrIv+/3fyVUAr4ga3+Uc/qEdrqwZ67A7Y0t4qBlDcm8Yk4xtY7wVHEKsF/rNmiezTq+r0Ysk1j3xNln94b5jV3f2/9VUZXqbv1fNiMWWdlm8cV5lf86F2H81wUKVQuoPeG7hAZhvU3NJ6DDmTY3fijNc29rpXd5tHHovD4H816Ukg7x4+L7ulAwyBuE8T3FhuuXF690Bq9sa/4l27s0Q8DeM8DKDkFM9s0CKf8J5QMYAA");
                /* background-image: url('https://cdn.discordapp.com/role-icons/1336817752844796016/da610f5548f174d9e04d49b1b28c3af1.webp?size=32&amp;quality=lossless'); */
            }

            .discord-scroll-container {
                width: 100%;
                height: 100%;
                overflow-y: auto;
                padding-bottom: 130px;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }

            .discord-scroll-container::-webkit-scrollbar {
                display: none !important;
            }

            .discord-thread-input {
                position: absolute;
                left: 0;
                bottom: 0;
                width: 100%;
                height: 50px;
                border-top: 2px solid #e4e4e4;
                background-color: white;
                display: flex;
                align-items: center;
                padding: 0 5px;
                gap: 5px;
            }

            .discord-thread-input-svgbackground {
                width: 35px;
                min-width: 35px;
                height: 35px;
                border-radius: 50%;
                background-color: #ececec;
                display: flex;
                align-items: center;
                justify-content: center;

                svg {
                    width: 22px;
                    height: 22px;
                }
            }

            .discord-thread-input-userinput {
                height: 30px;
                flex: 1;
                border-radius: 24px;
                border: 0px;
                background-color: #ececec;
                padding: 0 5px 0 10px;
                box-sizing: border-box;
                display: block;
                min-width: 50px;
                outline: none;
            }

            .discord-thread-input-userinput:focus {
                outline: none;
            }

            .discord-thread-input-userinput::placeholder {
                display: inline-block;
                width: 100%;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                direction: ltr;
            }

            .discord-cardget {
                background-color: #e8e9eb;
                padding: 10px 20px;
                border-radius: 100px;
                margin: auto;
                font-size: 1.5rem;
            }
            body {
                --yj: 22px;
                overflow: auto !important;
                -ms-overflow-style: none !important;
                scrollbar-width: none !important;
                letter-spacing: 0.7px;
                font-family: "JiangChengYuanTi";
                font-weight: normal;
            }
            .head {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                /*min-width: 40px;*/
            }
            .user_avatar {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background-size: cover;
            }
            body::-webkit-scrollbar {
                display: none !important;
            }
            .card {
                max-width: min(350px, 95%);
                width: min(350px, 95%);
                position: relative;
                height: auto;
                aspect-ratio: 1/2;
                background: #1b1717;
                border-radius: 35px;
                border: 2px solid #810000;
                padding: 7px;
                box-shadow: 2px 3px 3px rgba(0, 0, 0, 0.25);
                margin-left: 5px;
                box-sizing: border-box;
            }
            .card-int {
                background-size: 200% 200%;
                background-position: 0% 0%;
                height: 100%;
                border-radius: 25px;
                transition: all 0.6s ease-out;
                overflow: hidden;
                box-sizing: border-box;
                position: relative;
            }
            .card:hover .card-int {
                background-position: 100% 100%;
            }
            #App_Page {
                background-size: 200% 200%;
                background-position: 0% 0%;
                height: 100%;
                border-radius: 25px;
                transition: all 0.6s ease-out;
                overflow: hidden;
                box-sizing: border-box;
                position: relative;
            }
            .top {
                position: absolute;
                top: 0px;
                right: 50%;
                -webkit-transform: translate(50%, 0%);
                transform: translate(50%, 0%);
                width: 35%;
                height: 22px;
                background-color: #1b1717;
                border-bottom-left-radius: 13px;
                border-bottom-right-radius: 13px;
                z-index: 9999999;
            }
            .speaker {
                position: absolute;
                top: 2px;
                right: 50%;
                -webkit-transform: translate(50%, 0%);
                transform: translate(50%, 0%);
                width: 40%;
                height: 2px;
                border-radius: 2px;
                background-color: rgb(20, 20, 20);
            }
            .camera {
                position: absolute;
                top: 6px;
                right: 84%;
                -webkit-transform: translate(50%, 0%);
                transform: translate(50%, 0%);
                width: 6px;
                height: 6px;
                border-radius: 50%;
                background-color: rgba(255, 255, 255, 0.048);
            }
            .int {
                position: absolute;
                width: 3px;
                height: 3px;
                border-radius: 50%;
                top: 50%;
                right: 50%;
                -webkit-transform: translate(50%, -50%);
                transform: translate(50%, -50%);
                background-color: rgba(0, 0, 255, 0.212);
            }
            .btn1,
            .btn2,
            .btn3,
            .btn4 {
                position: absolute;
                width: 2px;
            }
            .btn1,
            .btn2,
            .btn3 {
                height: 45px;
                top: 30%;
                right: -4px;
                background-color: #ce1212;
            }
            .btn2,
            .btn3 {
                -webkit-transform: scale(-1);
                transform: scale(-1);
                left: -4px;
            }
            .btn2,
            .btn3 {
                -webkit-transform: scale(-1);
                transform: scale(-1);
                height: 30px;
            }
            .btn2 {
                top: 26%;
            }
            .btn3 {
                top: 36%;
            }
            .hidden {
                display: block;
                opacity: 0;
                transition: all 0.3s ease-in;
            }
            .card:hover .hidden {
                opacity: 1;
            }
            .card:hover .hello {
                -webkit-transform: translateY(-20px);
                transform: translateY(-20px);
            }
            .btn {
                position: absolute;
                width: 2px;
            }
            .backdiv {
                background-color: white;
                height: 100%;
                width: 100%;
                position: relative;
                background-size: cover;
                background-position: top center;
                background-repeat: no-repeat;
                background-image: url("http://sharkpan.xyz/f/6osR/00005-660646865.png");
                box-sizing: border-box;
            }
            .dibu {
                position: absolute;
                bottom: 40px;
                left: 3%;
                right: 3%;
                background-color: black;
                height: auto;
                display: -webkit-flex;
                display: flex;
                -webkit-align-items: center;
                align-items: center;
                -webkit-justify-content: space-around;
                justify-content: space-around;
                padding: 0 5px 0 5px;
                border-radius: 30px;
                --a: 10px;
                background-color: rgba(255, 255, 255, 0.2);
                backdrop-filter: blur(var(--a));
                -webkit-backdrop-filter: blur(var(--a));
            }
            .dibu svg {
                -webkit-transform: scale(0.85);
                transform: scale(0.85);
                -webkit-transform-origin: center;
                transform-origin: center;
            }
            .dinbu {
                position: absolute;
                top: 10px;
                left: 7%;
                right: 2%;
                color: #626367;
                display: -webkit-flex;
                display: flex;
                -webkit-align-items: center;
                align-items: center;
                -webkit-justify-content: space-between;
                justify-content: space-between;
                z-index: 9999999;
            }
            .zhong {
                position: absolute;
                border-radius: 20px;
                --a: 3px;
                background-color: rgba(255, 255, 255, 0.2);
                backdrop-filter: blur(var(--a));
                -webkit-backdrop-filter: blur(var(--a));
                top: 30%;
                left: 4%;
                right: 4%;
                color: black;
                padding: 10px 15px 10px 10px;
                font-size: 32px;
                display: -webkit-flex;
                display: flex;
                -webkit-align-items: center;
                align-items: center;
                -webkit-justify-content: space-between;
                justify-content: space-between;
                letter-spacing: 2px;
            }
            .app {
                position: absolute;
                bottom: 120px;
                left: 4%;
                right: 4%;
                display: -webkit-flex;
                display: flex;
                -webkit-align-items: center;
                align-items: center;
                -webkit-justify-content: space-evenly;
                justify-content: space-evenly;
                color: black;
                box-sizing: border-box;
                max-width: 92%;
                -webkit-flex-wrap: wrap;
                flex-wrap: wrap;
            }
            .app-svg-div {
                max-width: 20%;
                -webkit-transform: scale(0.8);
                transform: scale(0.8);
                -webkit-transform-origin: center;
                transform-origin: center;
            }
            .QQ_home_head {
                border-radius: 50%;
                margin-right: 15px;
                margin-left: 5px;
                width: 40px;
                height: 40px;
                font-size: 0;
                min-width: 40px;
                background-size: cover;
            }
            .QQ_home_usermsg {
                --head_size: 40px;
                width: 100%;
                display: -webkit-flex;
                display: flex;
                font-size: 14px;
                -webkit-align-items: center;
                align-items: center;
                height: 60px;
                align-items: center;
                position: relative;
            }
            .QQ_home_usermsg > * {
                position: relative;
                z-index: 1;
            }
            .QQ_home_usermsg:active::before {
                content: "";
                position: absolute;
                top: 0;
                left: -10px;
                right: -10px;
                height: 100%;
                background-color: #d5d5d5;
            }
            .QQ_home_usermsg_new {
                background-color: red;
                border-radius: 50%;
                width: 17px;
                height: 17px;
                color: white;
                display: -webkit-flex;
                display: flex;
                -webkit-align-items: center;
                align-items: center;
                -webkit-justify-content: center;
                justify-content: center;
                font-size: 13px;
                justify-self: end;
                padding: 2px;
            }
            .QQ_home_usermsg_new_hidden {
                background-color: #dbdbdb;
                border-radius: 10px;
                width: 2rem;
                height: 17px;
                color: white;
                display: -webkit-flex;
                display: flex;
                -webkit-align-items: center;
                align-items: center;
                -webkit-justify-content: center;
                justify-content: center;
                font-size: 13px;
                justify-self: end;
                padding: 2px;
            }
            

            .QQ_bottom_nav {
                position: absolute;
                bottom: 0px;
                width: 100%;
                height: 40px;
                display: -webkit-flex;
                display: flex;
                -webkit-align-items: center;
                align-items: center;
                -webkit-justify-content: space-evenly;
                justify-content: space-evenly;
                font-size: 10px;
                background-color: white;
                z-index: 1000;
                border-top: 1px solid #e6e6e6;
            }
            body div {
                box-sizing: border-box !important;
            }
            .page_button {
                display: -webkit-flex;
                display: flex;
                -webkit-align-items: center;
                align-items: center;
                -webkit-justify-content: space-evenly;
                justify-content: space-evenly;
                width: 100%;
                z-index: 99;
                position: absolute;
                bottom: 0px;
                left: 0;
                height: 22px;
                box-sizing: border-box;
                padding-bottom: 4px;
            }
            @media (max-width: 768px) {
                .zhong {
                    font-size: 20px;
                }
            }
            #space_page {
                width: 100%;
                height: 820px;
                background-color: #fff;
                display: none;
            }
            .user_moment_title {
                --head_size: 40px;
                width: 100%;
                display: -webkit-flex;
                display: flex;
                font-size: 14px;
                -webkit-align-items: start;
                align-items: start;
                margin-bottom: 5px;
            }
            .user_moment {
                padding-left: 7px;
                padding-right: 7px;
                position: relative;
            }
            .moment_button {
                display: -webkit-flex;
                display: flex;
                -webkit-align-items: center;
                align-items: center;
                gap: 5px;
                margin-left: auto;
                -webkit-transform: scale(0.9);
                transform: scale(0.9);
                -webkit-transform-origin: center;
                transform-origin: center;
            }

            /* åŠ¨æ€ç‚¹èµæŒ‰é’®æ ·å¼ */
            .moment-like-button {
                cursor: pointer;
                transition: all 0.2s ease;
                filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
            }

            .moment-like-button:hover {
                transform: scale(1.1);
                filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
            }

            .moment-like-button.liked {
                fill: #1677ff !important;
                animation: likeAnimation 0.3s ease-out;
                filter: drop-shadow(0 2px 6px rgba(22,119,255,0.3));
            }

            @keyframes likeAnimation {
                0% { transform: scale(1); }
                50% { transform: scale(1.3); }
                100% { transform: scale(1); }
            }

            /* ç‚¹èµå¼¹çª—æ ·å¼ */
            .moment-like-popup {
                position: absolute;
                bottom: 25px;
                left: 0;
                background: #fff;
                border: 1px solid #ddd;
                border-radius: 4px;
                padding: 4px 8px;
                font-size: 12px;
                color: #666;
                display: none;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                z-index: 1000;
                white-space: nowrap;
                animation: popupFadeIn 0.3s ease-out;
            }

            @keyframes popupFadeIn {
                0% { 
                    opacity: 0; 
                    transform: translateY(10px); 
                }
                100% { 
                    opacity: 1; 
                    transform: translateY(0); 
                }
            }


            /* é•¿æŒ‰èœå•æ ·å¼ - å°å·§ç¾è§‚ç‰ˆ */
            .long-press-menu {
                position: fixed;
                background: rgba(255, 255, 255, 0.95);
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.2), 0 0 0 1px rgba(255,255,255,0.3);
                z-index: 10000;
                min-width: 90px;
                font-size: 13px;
                backdrop-filter: blur(20px);
                overflow: hidden;
                transform: scale(0.8);
                opacity: 0;
                animation: menuFadeIn 0.25s ease-out forwards;
            }

            @keyframes menuFadeIn {
                0% {
                    opacity: 0;
                    transform: scale(0.8) translateY(10px);
                }
                100% {
                    opacity: 1;
                    transform: scale(1) translateY(0);
                }
            }

            .long-press-menu-item {
                padding: 8px 12px;
                cursor: pointer;
                transition: all 0.2s ease;
                border-bottom: 1px solid rgba(240,240,240,0.6);
                display: flex;
                align-items: center;
                gap: 6px;
                font-weight: 500;
            }

            .long-press-menu-item:last-child {
                border-bottom: none;
            }

            .long-press-menu-item:hover {
                background-color: rgba(0,0,0,0.08);
                transform: scale(1.02);
            }

            .long-press-menu-item:active {
                transform: scale(0.98);
                background-color: rgba(0,0,0,0.12);
            }

            .long-press-menu-item.edit {
                color: #1976d2;
            }

            .long-press-menu-item.delete {
                color: #d32f2f;
            }

            .long-press-menu-item svg {
                width: 14px;
                height: 14px;
            }

            /* æ‰¹é‡åˆ é™¤æ¨¡å¼æ ·å¼ */
            .batch-delete-mode .QQ_chat_mymsg {
                position: relative;
                padding-left: 40px;
            }

            .batch-delete-checkbox {
                position: absolute;
                left: 10px;
                top: 50%;
                transform: translateY(-50%);
                width: 20px;
                height: 20px;
                accent-color: #1976d2;
                cursor: pointer;
            }

            .batch-delete-toolbar {
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: white;
                border-radius: 25px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                padding: 12px 20px;
                display: flex;
                gap: 15px;
                align-items: center;
                z-index: 10000;
                border: 1px solid #e0e0e0;
            }

            .batch-delete-toolbar button {
                border: none;
                border-radius: 6px;
                padding: 8px 16px;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.2s ease;
            }

            .batch-delete-toolbar .cancel-btn {
                background: #f5f5f5;
                color: #666;
            }

            .batch-delete-toolbar .delete-btn {
                background: #d32f2f;
                color: white;
            }

            .batch-delete-toolbar .cancel-btn:hover {
                background: #e0e0e0;
            }

            .batch-delete-toolbar .delete-btn:hover {
                background: #b71c1c;
            }

            /* ç¼–è¾‘æ¨¡å¼æ ·å¼ */
            .message-edit-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .message-edit-dialog {
                background: white;
                border-radius: 12px;
                padding: 20px;
                min-width: 300px;
                max-width: 90%;
                box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            }

            .message-edit-dialog h3 {
                margin: 0 0 15px 0;
                color: #333;
                font-size: 16px;
            }

            .message-edit-dialog textarea {
                width: 100%;
                min-height: 80px;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 12px;
                font-size: 14px;
                resize: vertical;
                font-family: inherit;
            }

            .message-edit-dialog .button-group {
                margin-top: 15px;
                display: flex;
                gap: 10px;
                justify-content: flex-end;
            }

            .message-edit-dialog button {
                border: none;
                border-radius: 6px;
                padding: 8px 16px;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.2s ease;
            }

            .message-edit-dialog .cancel-btn {
                background: #f5f5f5;
                color: #666;
            }

            .message-edit-dialog .save-btn {
                background: #1976d2;
                color: white;
            }

            /* ç‚¹èµæ•°é‡æ ·å¼ */
            .moment-like-count {
                color: #474545;
                font-size: 14px;
                transition: color 0.2s ease;
            }

            /* === ğŸ‘æŒ‰é’®ç‚¹èµåŠŸèƒ½æ ·å¼ === */
            /* ğŸ‘æŒ‰é’®ç‚¹èµçŠ¶æ€æ ·å¼ */
            .liked-thumb {
                filter: drop-shadow(0 0 8px #1677ff) !important;
                transform: scale(1.2) !important;
                transition: all 0.3s ease !important;
            }
            
            /* è„‰å†²åŠ¨ç”»æ•ˆæœ */
            .pulse-animation {
                animation: thumbPulse 0.8s ease-in-out;
            }
            
            @keyframes thumbPulse {
                0% { transform: scale(1); filter: none; }
                50% { transform: scale(1.3); filter: drop-shadow(0 0 12px #1677ff); }
                100% { transform: scale(1.2); filter: drop-shadow(0 0 8px #1677ff); }
            }
            
            /* ç”¨æˆ·å·²ç‚¹èµæç¤ºæ ·å¼ */
            .user-liked-tip {
                animation: slideInFromLeft 0.3s ease;
                display: block;
            }
            
            @keyframes slideInFromLeft {
                0% { opacity: 0; transform: translateX(-20px); }
                100% { opacity: 1; transform: translateX(0); }
            }
            
            /* ğŸ‘æŒ‰é’®æ‚¬åœæ•ˆæœ */
            .moment_button svg:hover {
                transform: scale(1.1) !important;
                transition: all 0.2s ease !important;
                cursor: pointer !important;
            }
            
            /* ğŸ‘æŒ‰é’®åŸºç¡€æ ·å¼ */
            .moment_button svg {
                transition: all 0.2s ease;
                cursor: pointer;
            }

            /* åŠ¨æ€è¯„è®ºå‘é€æŒ‰é’®æ‰©å±•ç‚¹å‡»èŒƒå›´ */
            .moment_comment {
                cursor: pointer;
                padding: 8px; /* æ‰©å¤§ç‚¹å‡»èŒƒå›´ */
                margin: -8px; /* ä½¿ç”¨è´Ÿè¾¹è·æŠµæ¶ˆpaddingçš„è§†è§‰å½±å“ */
                border-radius: 6px;
                transition: all 0.2s ease;
                /* å¢å¤§å‘é€æŒ‰é’®å›¾æ ‡å¤§å° */
                transform: scale(1.4);
                transform-origin: center;
            }
            
            .moment_comment:hover {
                background-color: rgba(0, 0, 0, 0.05); /* æ‚¬åœæ•ˆæœ */
                transform: scale(1.5); /* æ‚¬åœæ—¶ç¨å¾®å†æ”¾å¤§ */
            }
            .moment_msg {
                background-color: #fff;
                margin-top: 5px;
                max-width: 60%;
                border-radius: 7px;
                font-size: 15px;
                padding: 6px;
                width: -webkit-fit-content;
                width: fit-content;
                white-space: normal;
                letter-spacing: 1px;
                line-height: 1.4;
                margin-bottom: 10px;
                box-shadow: 1px 1px 2px rgba(32, 32, 32, 0.2);
            }
            #Home_page {
                width: 100%;
                height: 100%;
                background-image: url("http://sharkpan.xyz/f/nBUl/%E6%89%8B%E6%9C%BA%E5%A3%81%E7%BA%B82.jpg");
                background-size: cover;
                background-position: top center;
                background-repeat: no-repeat;
            }
            .QQ_chat_head {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background-size: cover;
                min-width: 40px;
            }
            .user_avatar {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background-size: cover;
            }
            .QQ_chat_msg {
                font-size: 14px;
                margin-right: 5px;
                margin-left: 5px;
            }
            .QQ_chat_mymsg {
                max-width: 70%;
                margin-left: auto;
                display: grid;
                grid-template-columns: 1fr 50px;
                grid-template-rows: auto auto;
                justify-items: end;
                text-align: right;
                -webkit-align-items: start;
                align-items: start;
                margin-bottom: 20px;
                margin-right: 15px; /* å‡å°‘å³è¾¹è·è®©å¤´åƒé è¿‘è¾¹ç¼˜ */
                gap: 2px; /* ç½‘æ ¼é—´è· */
            }
            
            /* æ¶ˆæ¯çŠ¶æ€æ ·å¼å¢å¼º */
            .QQ_chat_mymsg .message-status {
                background: rgba(255,255,255,0.8);
                border-radius: 12px;
                padding: 3px 8px;
                backdrop-filter: blur(4px);
                box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            }
            .QQ_chat_charmsg {
                max-width: 80%;
                display: grid;
                grid-template-columns: 47px 1fr;
                grid-template-rows: auto auto;
                -webkit-align-items: start;
                align-items: start;
                margin-bottom: 20px;
                margin-left: 15px; /* å‡å°‘å·¦è¾¹è·è®©å¤´åƒé è¿‘è¾¹ç¼˜ */
            }
            .QQ_chat_msgdiv {
                box-shadow: 2px 2px 2px rgba(15, 15, 15, 0.3);
                letter-spacing: 1px;
                line-height: 1.4;
                font-size: 15px;
                width: -webkit-fit-content;
                width: fit-content;
                background-color: rgb(239, 206, 242, 0.65);
                color: black;
                border-radius: 7px;
                padding: 7px;
                text-align: left;
                box-sizing: border-box;
                margin-left: -2px;
            }
            .QQ_chat_name {
                font-size: 13px;
                color: black;
            }
            .QQ_chat_msgimg {
                width: 100%;
                background-color: white;
            }
            .msgimg {
                max-width: 100%;
                height: auto;
                display: block;
            }
            .QQ_chat_time {
                display: -webkit-flex;
                display: flex;
                -webkit-align-items: center;
                align-items: center;
                -webkit-justify-content: center;
                justify-content: center;
                width: 100%;
                height: 10px;
                margin-bottom: 10px;
                color: #a1a1a1;
            }
            .mimictwitter hr {
                background-color: rgb(240, 244, 245);
                border: none;
                height: 1px;
            }
            .twitterhead {
                width: 45px;
                height: 45px;
                border-radius: 50%;
                margin-left: 4px;
                min-width: 45px;
            }
            .interactsvg {
                width: 15.5px;
                height: 15.5px;
            }
            .twitter-content {
                -webkit-flex: 1;
                flex: 1;
                overflow-y: auto;
                box-sizing: border-box;
                padding-top: 10px;
                padding-right: 3px;
            }
            .mimictwitter {
                background-color: white;
                width: 100%;
                max-width: 100%;
                border-radius: 10px;
                height: 100%;
                box-sizing: border-box;
                padding-top: 10px;
                display: -webkit-flex;
                display: flex;
                -webkit-flex-direction: column;
                flex-direction: column;
                position: relative;
                overflow-x: hidden;
            }
            .twitter {
                overflow-x: hidden;
                font-size: 16px;
                height: 100%;
            }
            .twitter_moment {
                display: grid;
                grid-template-columns: 50px 1fr 0px;
                grid-template-rows: auto auto;
            }
            img {
                box-sizing: border-box !important;
            }
            * {
                box-sizing: border-box;
            }
            .user_leave_message {
                font-size: 13px;
                margin-top: 7px;
                display: -webkit-flex;
                display: flex;
                -webkit-flex-direction: column;
                flex-direction: column;
                span {
                    line-height: 1.5;
                }
            }
            .space_contents {
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            .give_money {
                margin-top: 10px;
                border-radius: 8px;
                overflow: hidden;
            }
            #QQ_home_chars {
                background-color: #fefefe;
                width: 100%;
                -webkit-flex: 1;
                flex: 1;
                border-radius: 20px 20px 20px 20px;
                padding: 5px 20px 20px 20px;
                box-sizing: border-box;
                overflow: auto !important;
                -ms-overflow-style: none !important;
                scrollbar-width: none !important;
                margin-bottom: 40px;
            }
            #QQ_home_chars::-webkit-scrollbar {
                display: none !important;
            }
            #QQ_home_page {
                display: -webkit-flex;
                display: flex;
                -webkit-flex-direction: column;
                flex-direction: column;
                height: 100%;
            }
            span {
                word-break: break-word;
            }
            .QQ_chat_music {
                background-color: #fefefe;
                border-radius: 10px;
                padding-top: 10px;
                padding-right: 10px;
                padding-left: 10px;
                padding-bottom: 5px;
                width: 100%;
            }
            .hide-title {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .music-play-button {
                position: absolute;
                border-radius: 50%;
                background-color: hsla(0, 0%, 100%, 0.2862745098);
                height: 32px;
                width: 32px;
                top: 50%;
                left: 50%;
                -webkit-transform: translate(-50%, -50%);
                transform: translate(-50%, -50%);
                z-index: 2;
                border: 2px solid white;
                display: -webkit-flex;
                display: flex;
                -webkit-justify-content: center;
                justify-content: center;
                -webkit-align-items: center;
                align-items: center;
            }
            .space_fakeimg {
                text-align: center;
                margin-top: 5px;
                font-size: 1.2rem;
                background-color: rgb(239 237 238);
                padding: 30px 10px;
                width: 100%;
                border: 1px solid black;
                border-radius: 5px;
                text-align: center;
            }
            .QQ_home_lasttime {
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
                max-width: 4rem;
                margin-right: 5px;
            }
            #QQ_message_list_chars {
                background-color: #fefefe;
                width: 100%;
                -webkit-flex: 1;
                flex: 1;
                border-radius: 20px 20px 20px 20px;
                padding: 5px 20px 20px 20px;
                box-sizing: border-box;
                overflow: auto !important;
                -ms-overflow-style: none !important;
                scrollbar-width: none !important;
                margin-bottom: 40px;
            }
            #QQ_message_list_chars::-webkit-scrollbar {
                display: none !important;
            }
            
            /* ç¾¤èŠç®¡ç†ä¸‹æ‹‰èœå•æ ·å¼ */
            .group-management-dropdown {
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 10000;
                max-height: 300px;
                overflow-y: auto;
                margin-top: 5px;
            }
            
            .group-management-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px 15px;
                border-bottom: 1px solid #f0f0f0;
                background: #f8f9fa;
                border-radius: 8px 8px 0 0;
            }
            
            .group-management-title {
                font-size: 14px;
                font-weight: bold;
                color: #333;
            }
            
            .group-settings-icon {
                width: 20px;
                height: 20px;
                cursor: pointer;
                opacity: 0.7;
                transition: opacity 0.2s;
            }
            
            .group-settings-icon:hover {
                opacity: 1;
            }
            
            .group-members-list {
                padding: 8px 0;
            }
            
            .group-member-item {
                display: flex;
                align-items: center;
                padding: 8px 15px;
                transition: background-color 0.2s;
            }
            
            .group-member-item:hover {
                background-color: #f5f5f5;
            }
            
            .group-member-avatar {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                margin-right: 10px;
                flex-shrink: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
                font-weight: bold;
                color: white;
                background: linear-gradient(135deg, #667eea, #764ba2);
            }
            
            .group-member-name {
                flex: 1;
                font-size: 14px;
                color: #333;
            }
            
            /* ç¾¤èŠè®¾ç½®æ¨¡æ€çª—å£æ ·å¼ */
            .group-settings-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: none;
                justify-content: center;
                align-items: center;
                z-index: 20000;
            }
            
            .group-settings-content {
                background: white;
                border-radius: 12px;
                width: 90%;
                max-width: 400px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            }
            
            .group-settings-header {
                padding: 20px;
                border-bottom: 1px solid #f0f0f0;
                text-align: center;
            }
            
            .group-settings-title {
                font-size: 18px;
                font-weight: bold;
                color: #333;
                margin: 0;
            }
            
            .group-settings-body {
                padding: 20px;
            }
            
            .group-settings-section {
                margin-bottom: 20px;
            }
            
            .group-settings-section-title {
                font-size: 14px;
                font-weight: bold;
                color: #333;
                margin-bottom: 10px;
            }
            
            .group-settings-input {
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 14px;
                box-sizing: border-box;
            }
            
            .group-settings-member-list {
                max-height: 200px;
                overflow-y: auto;
                border: 1px solid #f0f0f0;
                border-radius: 6px;
            }
            
            .group-settings-member-item {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 10px;
                border-bottom: 1px solid #f8f8f8;
            }
            
            .group-settings-member-item:last-child {
                border-bottom: none;
            }
            
            .group-settings-member-info {
                display: flex;
                align-items: center;
                flex: 1;
            }
            
            .group-settings-remove-btn {
                background: #ff4757;
                color: white;
                border: none;
                border-radius: 4px;
                padding: 4px 8px;
                font-size: 12px;
                cursor: pointer;
                transition: background-color 0.2s;
            }
            
            .group-settings-remove-btn:hover {
                background: #ff3742;
            }
            
            /* æ·»åŠ æˆå‘˜æŒ‰é’®æ ·å¼ */
            .group-settings-add-member-item {
                margin-top: 10px;
            }
            
            .group-settings-add-member-btn {
                width: 100%;
                padding: 12px;
                border: 2px dashed #ddd;
                border-radius: 8px;
                background: transparent;
                color: #666;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                font-size: 14px;
                transition: all 0.3s ease;
            }
            
            .group-settings-add-member-btn:hover {
                border-color: #199AFF;
                color: #199AFF;
                background: rgba(25, 154, 255, 0.05);
            }
            
            .add-member-icon {
                font-size: 18px;
                font-weight: bold;
            }
            
            /* æ·»åŠ æˆå‘˜æ¨¡æ€çª—å£æ ·å¼ */
            .add-member-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: none;
                justify-content: center;
                align-items: center;
                z-index: 25000;
            }
            
            .add-member-dialog {
                background: white;
                border-radius: 12px;
                width: 90%;
                max-width: 400px;
                max-height: 80vh;
                overflow: hidden;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            }
            
            .add-member-header {
                padding: 20px;
                border-bottom: 1px solid #eee;
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            }
            
            .add-member-title {
                font-size: 18px;
                font-weight: bold;
                color: #333;
                margin: 0;
            }
            
            .add-member-close {
                font-size: 24px;
                color: #999;
                cursor: pointer;
                line-height: 1;
            }
            
            .add-member-close:hover {
                color: #666;
            }
            
            .add-member-content {
                padding: 20px;
                max-height: 400px;
                overflow-y: auto;
            }
            
            .add-member-search {
                position: relative;
                margin-bottom: 15px;
            }
            
            .add-member-search-input {
                width: 100%;
                padding: 10px 40px 10px 15px;
                border: 1px solid #ddd;
                border-radius: 8px;
                font-size: 14px;
                box-sizing: border-box;
            }
            
            .add-member-search-input:focus {
                outline: none;
                border-color: #199AFF;
            }
            
            .add-member-search-icon {
                position: absolute;
                right: 12px;
                top: 50%;
                transform: translateY(-50%);
                color: #999;
            }
            
            .add-member-contact-list {
                max-height: 300px;
                overflow-y: auto;
            }
            
            .add-member-contact-item {
                display: flex;
                align-items: center;
                padding: 12px;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.2s ease;
                border: 2px solid transparent;
                margin-bottom: 8px;
            }
            
            .add-member-contact-item:hover {
                background: #f8f9fa;
                border-color: #e9ecef;
            }
            
            .add-member-contact-item.selected {
                background: #e3f2fd;
                border-color: #199AFF;
            }
            
            .add-member-contact-item.disabled {
                /* ç§»é™¤ opacity: 0.5; é¿å…åˆ†ç»„ä¸­è§’è‰²å˜ç° */
                cursor: not-allowed;
            }
            
            .add-member-contact-item.disabled:hover {
                background: transparent;
                border-color: transparent;
            }
            
            .add-member-contact-avatar {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                margin-right: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                font-size: 14px;
                color: white;
                background-size: cover;
                background-position: center;
                flex-shrink: 0;
            }
            
            .add-member-contact-name {
                flex: 1;
                font-size: 14px;
                color: #333;
                font-weight: 500;
            }
            
            .add-member-contact-status {
                font-size: 12px;
                color: #666;
                padding: 4px 8px;
                border-radius: 12px;
                background: #f0f0f0;
                transition: all 0.2s ease;
            }
            
            .add-member-contact-item.selected .add-member-contact-status {
                background: #199AFF;
                color: white;
            }
            
            .add-member-actions {
                padding: 20px;
                border-top: 1px solid #eee;
                display: flex;
                gap: 12px;
                justify-content: flex-end;
                background: #fafafa;
            }
            
            .add-member-btn {
                padding: 12px 24px;
                border: none;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                min-width: 80px;
            }
            
            .add-member-cancel-btn {
                background: #f8f9fa;
                color: #666;
                border: 1px solid #dee2e6;
            }
            
            .add-member-cancel-btn:hover {
                background: #e9ecef;
                border-color: #adb5bd;
            }
            
            .add-member-confirm-btn {
                background: linear-gradient(135deg, #199AFF, #0066CC);
                color: white;
                box-shadow: 0 2px 8px rgba(25, 154, 255, 0.3);
            }
            
            .add-member-confirm-btn:hover {
                background: linear-gradient(135deg, #0066CC, #004499);
                box-shadow: 0 4px 12px rgba(25, 154, 255, 0.4);
                transform: translateY(-1px);
            }
            
            .add-member-confirm-btn:disabled {
                background: #ccc;
                cursor: not-allowed;
                box-shadow: none;
                transform: none;
            }
            
            .group-settings-actions {
                display: flex;
                gap: 10px;
                padding: 20px;
                border-top: 1px solid #f0f0f0;
            }
            
            .group-settings-btn {
                flex: 1;
                padding: 12px;
                border: none;
                border-radius: 6px;
                font-size: 14px;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.2s;
            }
            
            .group-settings-save-btn {
                background: #199AFF;
                color: white;
            }
            
            .group-settings-save-btn:hover {
                background: #0066CC;
            }
            
            .group-settings-delete-btn {
                background: #ff4757;
                color: white;
            }
            
            .group-settings-delete-btn:hover {
                background: #ff3742;
            }
            
            .group-settings-cancel-btn {
                background: #f1f2f6;
                color: #333;
            }
            
            .group-settings-cancel-btn:hover {
                background: #ddd;
            }
            
            /* ç¾¤èŠè®¾ç½®å¤´åƒç›¸å…³æ ·å¼ */
            .group-settings-avatar-container {
                display: flex;
                align-items: center;
                gap: 15px;
                padding: 10px 0;
            }
            
            .group-settings-avatar-preview {
                width: 60px;
                height: 60px;
                border-radius: 50%;
                background: #4CAF50;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.2s ease;
                overflow: hidden;
            }
            
            .group-settings-avatar-preview:hover {
                transform: scale(1.05);
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            }
            
            .group-settings-default-avatar {
                color: white;
                font-size: 20px;
                font-weight: bold;
            }
            
            .group-settings-avatar-preview img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                border-radius: 50%;
            }
            
            .group-settings-avatar-text {
                color: #199AFF;
                cursor: pointer;
                font-size: 14px;
                user-select: none;
            }
            
            .group-settings-avatar-text:hover {
                text-decoration: underline;
            }

            /* ç¾¤èŠåˆ›å»ºå¼¹çª—æ ·å¼ */
            .group-chat-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                backdrop-filter: blur(3px);
            }
            
            .group-chat-dialog {
                background-color: #ffffff;
                border-radius: 15px;
                width: 280px;
                max-height: 400px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                overflow: hidden;
                animation: modalSlideIn 0.3s ease-out;
            }
            
            @keyframes modalSlideIn {
                from {
                    opacity: 0;
                    transform: scale(0.8) translateY(-20px);
                }
                to {
                    opacity: 1;
                    transform: scale(1) translateY(0);
                }
            }
            
            .group-chat-header {
                background: linear-gradient(135deg, #199AFF, #0066CC);
                color: white;
                padding: 15px 20px;
                text-align: center;
                font-size: 16px;
                font-weight: bold;
            }
            
            .group-chat-content {
                padding: 20px;
            }
            
            .group-chat-option {
                display: flex;
                align-items: center;
                padding: 12px 15px;
                margin-bottom: 10px;
                border-radius: 8px;
                background-color: #f8f9fa;
                cursor: pointer;
                transition: all 0.2s ease;
                border: 1px solid #e9ecef;
            }
            
            .group-chat-option:hover {
                background-color: #e3f2fd;
                border-color: #199AFF;
                transform: translateY(-1px);
            }
            
            .group-chat-option-icon {
                width: 24px;
                height: 24px;
                margin-right: 12px;
                fill: #199AFF;
            }
            
            .group-chat-option-text {
                font-size: 14px;
                color: #333;
                font-weight: 500;
            }
            
            .group-create-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1001;
                backdrop-filter: blur(3px);
            }
            
            .group-create-dialog {
                background-color: #ffffff;
                border-radius: 15px;
                width: 320px;
                max-height: 85vh;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                overflow: hidden;
                animation: modalSlideIn 0.3s ease-out;
                display: flex;
                flex-direction: column;
            }
            
            .group-create-header {
                background: linear-gradient(135deg, #199AFF, #0066CC);
                color: white;
                padding: 15px 20px;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            
            .group-create-title {
                font-size: 16px;
                font-weight: bold;
            }
            
            .group-create-close {
                color: white;
                font-size: 20px;
                cursor: pointer;
                padding: 2px 6px;
                border-radius: 50%;
                transition: background-color 0.2s;
            }
            
            .group-create-close:hover {
                background-color: rgba(255, 255, 255, 0.2);
            }
            
            .group-create-content {
                padding: 20px;
                flex: 1;
                overflow-y: auto;
                min-height: 0;
            }
            
            .group-name-section {
                margin-bottom: 20px;
            }
            
            .group-name-label {
                display: block;
                font-size: 14px;
                color: #333;
                margin-bottom: 8px;
                font-weight: 500;
            }
            
            .group-name-input {
                width: 100%;
                padding: 10px 12px;
                border: 2px solid #e9ecef;
                border-radius: 8px;
                font-size: 14px;
                outline: none;
                transition: border-color 0.2s;
                box-sizing: border-box;
            }
            
            .group-name-input:focus {
                border-color: #199AFF;
            }
            
            .group-members-section {
                margin-bottom: 20px;
            }
            
            .group-members-label {
                font-size: 14px;
                color: #333;
                margin-bottom: 10px;
                font-weight: 500;
            }
            
            .contact-item {
                display: flex;
                align-items: center;
                padding: 12px 8px;
                border-radius: 8px;
                margin-bottom: 6px;
                cursor: pointer;
                transition: all 0.3s ease;
                border: 2px solid transparent;
                position: relative; /* ä¸ºé€‰æ‹©æ ‡è®°æä¾›å®šä½åŸºå‡† */
            }
            
            .contact-item:last-child {
                margin-bottom: 0;
            }
            
            .contact-item:hover {
                background-color: #f8f9fa;
                transform: translateX(2px);
            }
            
            .contact-item.selected {
                background: linear-gradient(135deg, #199AFF 0%, #0066CC 100%) !important;
                color: white !important;
                border-color: #0066CC !important;
                box-shadow: 0 4px 12px rgba(25, 154, 255, 0.3) !important;
                transform: scale(1.02) !important;
                transition: all 0.2s ease !important;
            }
            
            .contact-item.selected .contact-name {
                color: white !important;
                font-weight: 500 !important;
            }
            
            /* é€‰ä¸­çŠ¶æ€ä¸‹çš„æœç´¢é«˜äº®æ ·å¼ */
            .contact-item.selected .contact-name span {
                background-color: rgba(255, 255, 255, 0.3) !important;
                color: white !important;
            }
            
            .contact-item.selected .contact-avatar {
                border: 2px solid rgba(255, 255, 255, 0.5) !important;
                box-shadow: 0 0 8px rgba(255, 255, 255, 0.3) !important;
            }
            
            /* å¢å¼ºé€‰æ‹©çŠ¶æ€çš„è§†è§‰åé¦ˆ */
            .contact-item.selected::before {
                content: 'âœ“';
                position: absolute;
                right: 8px;
                top: 50%;
                transform: translateY(-50%);
                color: white;
                font-weight: bold;
                font-size: 16px;
                z-index: 10;
            }
            
            .contact-checkbox {
                display: none; /* éšè—åŸå§‹å¤é€‰æ¡† */
            }
            
            /* ç¾¤èŠæˆå‘˜æœç´¢æ¡†æ ·å¼ */
            .group-member-search {
                position: relative;
                margin-bottom: 15px;
            }
            
            .group-search-input {
                width: 100%;
                padding: 10px 12px 10px 35px;
                border: 2px solid #e9ecef;
                border-radius: 8px;
                font-size: 14px;
                outline: none;
                transition: border-color 0.2s;
                box-sizing: border-box;
                background-color: #f8f9fa;
            }
            
            .group-search-input:focus {
                border-color: #199AFF;
                background-color: white;
            }
            
            .group-search-icon {
                position: absolute;
                left: 10px;
                top: 50%;
                transform: translateY(-50%);
                color: #666;
                font-size: 14px;
            }
            
            .group-search-clear {
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                color: #999;
                cursor: pointer;
                font-size: 16px;
                padding: 2px;
                border-radius: 50%;
                transition: all 0.2s;
                display: none;
            }
            
            .group-search-clear:hover {
                background-color: #e9ecef;
                color: #666;
            }
            
            .group-search-clear.show {
                display: block;
            }
            
            /* è”ç³»äººåˆ—è¡¨å®¹å™¨ */
            .contact-list-container {
                max-height: 250px;
                overflow-y: auto;
                padding-right: 5px;
            }
            
            .contact-list-container::-webkit-scrollbar {
                width: 4px;
            }
            
            .contact-list-container::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 4px;
            }
            
            .contact-list-container::-webkit-scrollbar-thumb {
                background: #c1c1c1;
                border-radius: 4px;
            }
            
            .contact-list-container::-webkit-scrollbar-thumb:hover {
                background: #a8a8a8;
            }
            
            /* æ— æœç´¢ç»“æœæç¤º */
            .no-results {
                text-align: center;
                color: #999;
                padding: 20px;
                font-size: 14px;
            }
            
            .contact-avatar {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                margin-right: 10px;
                background-color: #f0f0f0;
                background-size: cover;
                background-position: center;
                flex-shrink: 0;
            }
            
            .contact-name {
                font-size: 14px;
                color: #333;
                flex: 1;
            }
            
            .group-create-actions {
                padding: 15px 20px;
                background-color: #f8f9fa;
                display: flex;
                gap: 10px;
            }
            
            .group-action-btn {
                flex: 1;
                padding: 10px 16px;
                border: none;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
            .group-cancel-btn {
                background-color: #f8f9fa;
                color: #666;
                border: 1px solid #e9ecef;
            }
            
            .group-cancel-btn:hover {
                background-color: #e9ecef;
            }
            
            .group-confirm-btn {
                background: linear-gradient(135deg, #199AFF, #0066CC);
                color: white;
            }
            
            .group-confirm-btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(25, 154, 255, 0.3);
            }
            
            .group-confirm-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
            }
            
            /* ==================== ç¾¤èŠå¤´åƒè®¾ç½®æ ·å¼ ==================== */
            
            .group-avatar-section {
                margin-bottom: 20px;
            }
            
            .group-avatar-label {
                display: block;
                margin-bottom: 8px;
                font-size: 14px;
                font-weight: 500;
                color: #333;
            }
            
            .group-avatar-selector {
                display: flex;
                align-items: center;
                gap: 12px;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
            .group-avatar-selector:hover {
                opacity: 0.8;
            }
            
            .group-avatar-preview {
                width: 60px;
                height: 60px;
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: linear-gradient(135deg, #199AFF, #0066CC);
                cursor: pointer;
                transition: all 0.2s ease;
                position: relative;
                overflow: hidden;
            }
            
            .group-avatar-preview:hover {
                transform: scale(1.05);
                box-shadow: 0 4px 15px rgba(25, 154, 255, 0.3);
            }
            
            .default-group-avatar {
                color: white;
                font-size: 24px;
                font-weight: bold;
            }
            
            .group-avatar-preview img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                border-radius: 12px;
            }
            
            .group-avatar-text {
                color: #666;
                font-size: 14px;
                cursor: pointer;
            }
            
            /* ==================== å¤´åƒé€‰æ‹©å™¨å¼¹çª—æ ·å¼ ==================== */
            
            .avatar-selector-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(5px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 30000; /* ç¡®ä¿åœ¨ç¾¤èŠè®¾ç½®æ¨¡æ€çª—å£(z-index: 20000)ä¹‹ä¸Š */
                animation: modalFadeIn 0.3s ease;
            }
            
            .avatar-selector-dialog {
                background: white;
                border-radius: 16px;
                width: 90%;
                max-width: 450px;
                max-height: 80vh;
                overflow: hidden;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                animation: modalSlideIn 0.3s ease;
            }
            
            .avatar-selector-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 20px 20px 15px;
                border-bottom: 1px solid #e9ecef;
                background: linear-gradient(135deg, #199AFF, #0066CC);
                color: white;
            }
            
            .avatar-selector-title {
                font-size: 16px;
                font-weight: 600;
            }
            
            .avatar-selector-close {
                font-size: 24px;
                cursor: pointer;
                padding: 0 5px;
                border-radius: 50%;
                transition: all 0.2s ease;
                color: white;
            }
            
            .avatar-selector-close:hover {
                background-color: rgba(255, 255, 255, 0.2);
            }
            
            .avatar-selector-content {
                display: flex;
                flex-direction: column;
                max-height: 500px;
            }
            
            .avatar-selector-tabs {
                display: flex;
                background-color: #f8f9fa;
                border-bottom: 1px solid #e9ecef;
            }
            
            .avatar-tab {
                flex: 1;
                padding: 12px 16px;
                text-align: center;
                cursor: pointer;
                font-size: 14px;
                color: #666;
                border-bottom: 3px solid transparent;
                transition: all 0.2s ease;
            }
            
            .avatar-tab.active {
                color: #199AFF;
                border-bottom-color: #199AFF;
                background-color: white;
                font-weight: 500;
            }
            
            .avatar-tab:hover:not(.active) {
                background-color: #e9ecef;
            }
            
            .avatar-selector-body {
                flex: 1;
                padding: 20px;
                overflow-y: auto;
            }
            
            .avatar-options {
                display: none;
            }
            
            .avatar-options.active {
                display: block;
            }
            
            /* é¢„è®¾å¤´åƒç½‘æ ¼ */
            .preset-avatar-grid {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 12px;
            }
            
            .preset-avatar-item {
                aspect-ratio: 1;
                border-radius: 12px;
                cursor: pointer;
                border: 3px solid transparent;
                transition: all 0.2s ease;
                background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 18px;
                font-weight: bold;
                position: relative;
                overflow: hidden;
            }
            
            .preset-avatar-item:hover {
                transform: scale(1.05);
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            }
            
            .preset-avatar-item.selected {
                border-color: #199AFF;
                transform: scale(1.1);
                box-shadow: 0 6px 20px rgba(25, 154, 255, 0.4);
            }
            
            .preset-avatar-item img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                border-radius: 8px;
            }
            
            /* ä¸Šä¼ åŒºåŸŸ */
            .upload-zone {
                border: 2px dashed #ddd;
                border-radius: 12px;
                padding: 40px 20px;
                text-align: center;
                cursor: pointer;
                transition: all 0.2s ease;
                background-color: #f8f9fa;
            }
            
            .upload-zone:hover {
                border-color: #199AFF;
                background-color: rgba(25, 154, 255, 0.05);
            }
            
            .upload-icon {
                font-size: 48px;
                margin-bottom: 12px;
                color: #666;
            }
            
            .upload-text {
                font-size: 16px;
                color: #333;
                margin-bottom: 8px;
                font-weight: 500;
            }
            
            .upload-hint {
                font-size: 12px;
                color: #666;
            }
            
            /* URLè¾“å…¥åŒºåŸŸ */
            .url-input-zone {
                padding: 20px;
                text-align: center;
            }
            
            .url-input-title {
                font-size: 16px;
                color: #333;
                margin-bottom: 15px;
                font-weight: 500;
            }
            
            .url-input {
                width: 100%;
                padding: 12px 16px;
                border: 2px solid #e9ecef;
                border-radius: 8px;
                font-size: 14px;
                transition: all 0.2s ease;
                box-sizing: border-box;
            }
            
            .url-input:focus {
                outline: none;
                border-color: #199AFF;
                box-shadow: 0 0 0 3px rgba(25, 154, 255, 0.1);
            }
            
            .url-input-hint {
                font-size: 12px;
                color: #666;
                margin-top: 8px;
            }
            
            .url-preview-container {
                margin-top: 20px;
                padding: 15px;
                border: 1px solid #e9ecef;
                border-radius: 8px;
                background-color: #f8f9fa;
            }
            
            .url-preview-title {
                font-size: 14px;
                color: #333;
                margin-bottom: 10px;
                font-weight: 500;
            }
            
            .url-preview-image {
                max-width: 120px;
                max-height: 120px;
                border-radius: 8px;
                object-fit: cover;
                border: 2px solid #e9ecef;
            }
            
            .avatar-selector-actions {
                padding: 15px 20px;
                background-color: #f8f9fa;
                display: flex;
                gap: 10px;
                border-top: 1px solid #e9ecef;
            }
            
            .avatar-action-btn {
                flex: 1;
                padding: 10px 16px;
                border: none;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
            .avatar-cancel-btn {
                background-color: #f8f9fa;
                color: #666;
                border: 1px solid #e9ecef;
            }
            
            .avatar-cancel-btn:hover {
                background-color: #e9ecef;
            }
            
            .avatar-confirm-btn {
                background: linear-gradient(135deg, #199AFF, #0066CC);
                color: white;
            }
            
            .avatar-confirm-btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(25, 154, 255, 0.3);
            }
            
            .avatar-confirm-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
            }
            
            /* æ·»åŠ æŒ‰é’®hoveræ•ˆæœ */
            .add-button {
                cursor: pointer;
                transition: all 0.2s ease;
                border-radius: 50%;
                padding: 4px;
            }
            
            .add-button:hover {
                background-color: rgba(25, 154, 255, 0.1);
                transform: scale(1.1);
            }
            
            /* ==================== è”ç³»äººåˆ†ç»„åŠŸèƒ½æ ·å¼ ==================== */
            
            /* åˆ†ç»„ç®¡ç†æŒ‰é’® */
            .group-manage-btn {
                position: absolute;
                top: 15px;
                right: 70px;
                background: linear-gradient(135deg, #199AFF, #0066CC);
                color: white;
                border: none;
                border-radius: 6px;
                padding: 6px 12px;
                font-size: 12px;
                cursor: pointer;
                transition: all 0.2s ease;
                z-index: 100;
            }
            
            .group-manage-btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(25, 154, 255, 0.3);
            }
            
            /* åˆ†ç»„å®¹å™¨ */
            .contact-group {
                margin-bottom: 8px;
                border-radius: 8px;
                overflow: hidden;
                background-color: #f8f9fa;
                border: 1px solid #e9ecef;
                transition: all 0.3s ease;
            }
            
            .contact-group.dragging {
                opacity: 0.7;
                transform: scale(0.98);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            }
            
            /* æœªåˆ†ç»„åŒºåŸŸæ ·å¼ */
            .ungrouped-contacts {
                margin-top: 15px;
                padding: 10px;
                border: 1px dashed #ddd;
                border-radius: 8px;
                background-color: #fafafa;
                position: relative;
            }
            
            .ungrouped-header {
                font-size: 12px;
                color: #666;
                margin-bottom: 10px;
                font-weight: 500;
            }
            
            .ungrouped-drop-zone {
                position: absolute;
                top: 30px;
                left: 0;
                right: 0;
                bottom: 0;
                border-radius: 6px;
                z-index: 1;
            }
            
            /* æ‹–æ‹½æ—¶çš„è§†è§‰åé¦ˆ */
            .QQ_home_usermsg.dragging {
                opacity: 0.5;
                transform: rotate(5deg);
            }
            
            .drop-zone.active {
                border: 2px dashed #199AFF;
                background-color: rgba(25, 154, 255, 0.1);
                animation: pulse 2s infinite;
            }
            
            @keyframes pulse {
                0% { opacity: 0.1; }
                50% { opacity: 0.3; }
                100% { opacity: 0.1; }
            }
            
            /* ç¾¤èŠæˆå‘˜æ•°æ˜¾ç¤º */
            .group-member-count {
                position: absolute;
                right: 15px;
                top: 50%;
                transform: translateY(-50%);
                font-size: 12px;
                color: #999;
                background-color: #f0f0f0;
                padding: 2px 6px;
                border-radius: 10px;
                min-width: 20px;
                text-align: center;
            }
            
            /* åˆ†ç»„æ ‡é¢˜æ  */
            .group-header {
                display: flex;
                align-items: center;
                padding: 12px 15px;
                background: linear-gradient(135deg, #f8f9fa, #e9ecef);
                cursor: pointer;
                border-bottom: 1px solid #dee2e6;
                position: relative;
            }
            
            .group-header:hover {
                background: linear-gradient(135deg, #e9ecef, #dee2e6);
            }
            
            /* åˆ†ç»„æ‹–æ‹½æ‰‹æŸ„ */
            .group-drag-handle {
                margin-right: 8px;
                color: #999;
                cursor: grab;
                font-size: 14px;
                transition: color 0.2s;
            }
            
            .group-drag-handle:hover {
                color: #666;
            }
            
            .group-drag-handle:active {
                cursor: grabbing;
            }
            
            /* åˆ†ç»„æŠ˜å å›¾æ ‡ */
            .group-toggle {
                margin-right: 8px;
                color: #666;
                font-size: 12px;
                transition: transform 0.3s ease;
                cursor: pointer;
            }
            
            .group-toggle.collapsed {
                transform: rotate(-90deg);
            }
            
            /* åˆ†ç»„åç§° */
            .group-name {
                flex: 1;
                font-size: 14px;
                font-weight: 500;
                color: #333;
                cursor: pointer;
                padding: 2px 4px;
                border-radius: 4px;
                transition: background-color 0.2s;
            }
            
            .group-name:hover {
                background-color: rgba(25, 154, 255, 0.1);
            }
            
            .group-name.editing {
                background-color: white;
                border: 2px solid #199AFF;
                outline: none;
            }
            
            /* åˆ†ç»„æˆå‘˜æ•°é‡ */
            .group-count {
                background-color: #199AFF;
                color: white;
                border-radius: 10px;
                padding: 2px 6px;
                font-size: 11px;
                font-weight: 500;
                margin-left: 8px;
            }
            
            /* åˆ†ç»„åˆ é™¤æŒ‰é’® */
            .group-delete-btn {
                margin-left: 8px;
                color: #dc3545;
                cursor: pointer;
                padding: 2px 4px;
                border-radius: 4px;
                font-size: 12px;
                opacity: 0;
                transition: all 0.2s;
            }
            
            .group-header:hover .group-delete-btn {
                opacity: 1;
            }
            
            .group-delete-btn:hover {
                background-color: #dc3545;
                color: white;
            }
            
            /* åˆ†ç»„å†…å®¹åŒºåŸŸ */
            .group-content {
                padding: 0;
                background-color: white;
                transition: all 0.3s ease;
                overflow: hidden;
            }
            
            .group-content.collapsed {
                max-height: 0;
                padding: 0;
                border-top: none;
            }
            
            .group-content.expanded {
                max-height: 1000px;
            }
            
            /* åˆ†ç»„å†…çš„è”ç³»äººé¡¹ */
            .group-content .QQ_home_usermsg {
                margin: 0;
                padding: 12px 20px;
                border-bottom: 1px solid #f0f0f0;
                position: relative;
                transition: all 0.2s ease;
            }
            
            .group-content .QQ_home_usermsg:last-child {
                border-bottom: none;
            }
            
            .group-content .QQ_home_usermsg:hover {
                background-color: #f8f9fa;
                transform: translateX(4px);
            }
            
            .group-content .QQ_home_usermsg.dragging {
                opacity: 0.5;
                transform: scale(0.95);
            }
            
            /* æœªåˆ†ç»„è”ç³»äººåŒºåŸŸ */
            .ungrouped-contacts {
                margin-top: 10px;
            }
            
            .ungrouped-header {
                padding: 10px 15px;
                font-size: 12px;
                color: #999;
                background-color: #f8f9fa;
                border-top: 1px solid #e9ecef;
                border-bottom: 1px solid #e9ecef;
            }
            
            /* æ‹–æ‹½æç¤ºåŒºåŸŸ */
            .drop-zone {
                min-height: 40px;
                border: 2px dashed #ddd;
                border-radius: 8px;
                margin: 5px 0;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #999;
                font-size: 12px;
                transition: all 0.2s;
                opacity: 0;
                transform: scaleY(0);
            }
            
            .drop-zone.active {
                opacity: 1;
                transform: scaleY(1);
                border-color: #199AFF;
                background-color: rgba(25, 154, 255, 0.1);
                color: #199AFF;
            }
            
            /* æ–°å»ºåˆ†ç»„å¼¹çª— */
            .new-group-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(4px);
            }
            
            .new-group-dialog {
                background-color: white;
                border-radius: 12px;
                padding: 24px;
                width: 280px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                animation: modalSlideIn 0.3s ease-out;
            }
            
            .new-group-title {
                font-size: 16px;
                font-weight: bold;
                margin-bottom: 16px;
                color: #333;
            }
            
            .new-group-input {
                width: 100%;
                padding: 10px 12px;
                border: 2px solid #e9ecef;
                border-radius: 8px;
                font-size: 14px;
                outline: none;
                transition: border-color 0.2s;
                box-sizing: border-box;
                margin-bottom: 16px;
            }
            
            .new-group-input:focus {
                border-color: #199AFF;
            }
            
            .new-group-actions {
                display: flex;
                gap: 10px;
            }
            
            .new-group-btn {
                flex: 1;
                padding: 10px 16px;
                border: none;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
            .new-group-cancel {
                background-color: #f8f9fa;
                color: #666;
                border: 1px solid #e9ecef;
            }
            
            .new-group-cancel:hover {
                background-color: #e9ecef;
            }
            
            .new-group-confirm {
                background: linear-gradient(135deg, #199AFF, #0066CC);
                color: white;
            }
            
            .new-group-confirm:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(25, 154, 255, 0.3);
            }

            /* ç¾¤ç»„æˆå‘˜ä¸‹æ‹‰èœå•æ ·å¼ */
            .group-member-dropdown {
                position: absolute;
                top: 100%;
                left: 0;
                width: 250px;
                max-height: 300px;
                background: white;
                border: 1px solid #ddd;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
                z-index: 1000;
                overflow-y: auto;
                padding: 8px 0;
                margin-top: 4px;
            }

            .group-member-dropdown .member-item {
                display: flex;
                align-items: center;
                padding: 8px 12px;
                cursor: pointer;
                transition: background-color 0.2s;
            }

            .group-member-dropdown .member-item:hover {
                background-color: #f5f5f5;
            }

            .group-member-dropdown .member-avatar {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                margin-right: 10px;
                object-fit: cover;
                border: 1px solid #eee;
            }

            .group-member-dropdown .member-name {
                font-size: 14px;
                color: #333;
                font-weight: 500;
            }

            .group-member-dropdown .dropdown-header {
                padding: 8px 12px;
                font-size: 12px;
                color: #666;
                font-weight: bold;
                border-bottom: 1px solid #eee;
                margin-bottom: 4px;
            }

            /* ç¡®ä¿ç¾¤ç»„æ ‡é¢˜å¯ç‚¹å‡»çš„æ ·å¼ */
            .chat-title.clickable {
                cursor: pointer;
                user-select: none;
                position: relative;
            }

            .chat-title.clickable:hover {
                text-decoration: underline;
            }
            /* ç³»ç»Ÿæ¶ˆæ¯æ ·å¼ */
            .system-message {
                text-align: center;
                font-size: 12px;
                color: #999;
                padding: 8px 0;
                width: 100%;
                box-sizing: border-box;
            }
        </style>
    </head>
    <body>
        <div class="card">
            <div class="btn1"></div>
            <div class="btn2"></div>
            <div class="btn3"></div>
            <div class="btn4"></div>
            <div class="dinbu">
                <span id="time">18:58</span>
                <div
                    style="
                        display: flex;
                        align-items: center;
                        justify-self: end;
                        gap: 2px;
                    "
                >
                    <svg viewBox="0 0 1024 1024" width="16" height="15">
                        <path
                            d="M926.634667 294.912a32 32 0 1 1-39.936 50.005333C780.512 260.128 649.824 213.333333 512.053333 213.333333c-137.813333 0-268.544 46.826667-374.752 131.669334a32 32 0 1 1-39.936-50.005334C214.784 201.194667 359.562667 149.333333 512.053333 149.333333c152.437333 0 297.173333 51.818667 414.581334 145.578667z m-235.413334 298.133333a32 32 0 0 1-38.442666 51.178667A233.418667 233.418667 0 0 0 512.021333 597.333333c-51.541333 0-100.48 16.629333-140.8 46.912a32 32 0 1 1-38.442666-51.157333A297.408 297.408 0 0 1 512.021333 533.333333c65.504 0 127.893333 21.184 179.2 59.722667z m128-149.344a32 32 0 0 1-38.442666 51.168C703.829333 437.066667 610.378667 405.333333 512.032 405.333333c-98.368 0-191.850667 31.754667-268.8 89.578667a32 32 0 1 1-38.453333-51.157333C292.736 377.664 399.669333 341.333333 512.032 341.333333c112.32 0 219.242667 36.309333 307.189333 102.368zM512 853.333333a64 64 0 1 1 0-128 64 64 0 0 1 0 128z"
                            fill="currentColor"
                        ></path>
                    </svg>
                    <span>130%</span>
                    <svg
                        viewBox="0 0 1024 1024"
                        width="20"
                        height="20"
                        style="justify-self: end; margin-right: 13px"
                    >
                        <path
                            d="M984.2 434.8c-5-2.9-8.2-8.2-8.2-13.9v-99.3c0-53.6-43.9-97.5-97.5-97.5h-781C43.9 224 0 267.9 0 321.5v380.9C0 756.1 43.9 800 97.5 800h780.9c53.6 0 97.5-43.9 97.5-97.5v-99.3c0-5.8 3.2-11 8.2-13.9 23.8-13.9 39.8-39.7 39.8-69.2v-16c0.1-29.6-15.9-55.5-39.7-69.3zM912 702.5c0 12-6.2 19.9-9.9 23.6-3.7 3.7-11.7 9.9-23.6 9.9h-781c-11.9 0-19.9-6.2-23.6-9.9-3.7-3.7-9.9-11.7-9.9-23.6v-381c0-11.9 6.2-19.9 9.9-23.6 3.7-3.7 11.7-9.9 23.6-9.9h780.9c11.9 0 19.9 6.2 23.6 9.9 3.7 3.7 9.9 11.7 9.9 23.6v381z"
                            p-id="4287"
                            fill="currentColor"
                        ></path>
                        <path
                            d="M736 344v336c0 8.8-7.2 16-16 16H112c-8.8 0-16-7.2-16-16V344c0-8.8 7.2-16 16-16h608c8.8 0 16 7.2 16 16z"
                            p-id="4288"
                            fill="currentColor"
                        ></path>
                    </svg>
                </div>
            </div>
            <div class="card-int">
                <div
                    class="page_button"
                    style="background-color: none; display: none"
                    id="page_button"
                >
                    <div
                        style="
                            width: 45px;
                            display: flex;
                            justify-content: center;
                            height: 20px;
                        "
                        onclick="gotopage(1)"
                    >
                        <svg viewBox="0 0 1024 1024" width="20" height="20">
                            <path
                                d="M810.666667 213.333333a42.666667 42.666667 0 0 1 42.368 37.674667L853.333333 256v274.304c0 79.274667-50.944 147.498667-120.490666 152.106667L725.333333 682.666667H273.706667l97.792 97.834666a42.666667 42.666667 0 0 1-56.32 63.872l-4.010667-3.541333-170.666667-170.666667a42.666667 42.666667 0 0 1 0-60.330666l170.666667-170.666667a42.666667 42.666667 0 0 1 63.872 56.32l-3.541333 4.010667L273.706667 597.333333H725.333333c19.584 0 39.936-24.618667 42.410667-59.861333l0.256-7.168V256a42.666667 42.666667 0 0 1 42.666667-42.666667z"
                                fill="#000000"
                                p-id="13502"
                            ></path>
                        </svg>
                    </div>
                    <div
                        style="
                            width: 45px;
                            display: flex;
                            justify-content: center;
                        "
                        onclick="gotopage(0)"
                    >
                        <svg
                            t="1736242335450"
                            class="icon"
                            viewBox="0 0 1024 1024"
                            version="1.1"
                            xmlns="http://www.w3.org/2000/svg"
                            p-id="8709"
                            width="20"
                            height="20"
                        >
                            <path
                                d="M762.3 565.3c0-19 15.7-34.1 34.7-34.1 19 0 34.2 15.1 34.2 34.1v336.3c0 19-15.2 34.4-34.2 34.4H229.6c-19.1 0-34.7-15.4-34.7-34.4V565.3c0-19 15.7-34.1 34.7-34.1 18.6 0 34.2 15.1 34.2 34.1v301.9h498.5V565.3z m-638.2 9.3l388.8-387.8 389.3 387.8c13.2 13.2 35.2 13.2 48.4 0 13.4-13.2 13.4-35.1 0-48.3L538 114.1l-0.7-0.5c-13.4-13.2-35.2-13.2-48.6 0l-413 412.6c-13.6 13.2-13.6 35.1 0 48.3 13.2 13.2 35.2 13.2 48.4 0.1z"
                                fill="#231815"
                                p-id="8710"
                            ></path>
                        </svg>
                    </div>
                    <div
                        style="
                            width: 45px;
                            display: flex;
                            justify-content: center;
                        "
                        onclick="gotopage(-1)"
                    >
                        <svg
                            t="1736242697753"
                            class="icon"
                            viewBox="0 0 1024 1024"
                            version="1.1"
                            xmlns="http://www.w3.org/2000/svg"
                            p-id="9742"
                            width="20"
                            height="20"
                        >
                            <path
                                d="M622.650611 284.901749 447.745069 284.901749 447.745069 142.823869 63.980685 334.705038l383.76336 191.882192L447.744046 384.834762l189.391465 0c149.914358 0 224.855164 62.789045 224.855164 188.368158 0 129.928165-77.435627 194.876386-232.338602 194.876386L187.952184 768.079306l0 99.93199L634.146433 868.011296c211.184817 0 316.777737-95.104031 316.777737-285.311071C950.924169 384.178823 841.510224 284.901749 622.650611 284.901749z"
                                fill="#272636"
                                p-id="9743"
                            ></path>
                        </svg>
                    </div>
                </div>
                <div id="Home_page" style="display: none">
                    <div class="dibu">
                        <svg
                            viewBox="0 0 1024 1024"
                            style="width: 4.1rem; height: 4.1rem"
                        >
                            <path
                                d="M510.798639 124.660184c-213.447347 0-386.480238 173.029822-386.480238 386.480238 0 213.446323 173.029822 386.475122 386.480238 386.475122 213.446323 0 386.475122-173.029822 386.475122-386.475122C897.274784 297.690006 724.244962 124.660184 510.798639 124.660184L510.798639 124.660184 510.798639 124.660184zM510.798639 864.019379c-194.883549 0-352.884073-158.001547-352.884073-352.879979 0-194.883549 158.000524-352.884073 352.884073-352.884073 194.878432 0 352.883049 158.000524 352.883049 352.884073C863.678618 706.017832 705.677071 864.019379 510.798639 864.019379L510.798639 864.019379 510.798639 864.019379zM588.978209 546.374902c-17.681708 0-31.070646 15.915481-47.113017 15.915481-15.910365 0-85.756129-68.836785-85.756129-85.761246 0-16.920368 15.914458-25.258267 15.914458-42.813085 0-12.632715-47.107901-89.925079-66.432015-89.925079-19.328207 0-66.436108 34.479279-66.436108 66.433038 0 92.455715 170.506349 269.653463 277.230022 269.653463 29.427216 0 66.437132-31.070646 66.437132-66.437132C683.071214 600.178295 606.532003 546.374902 588.978209 546.374902"
                                fill="#09B245"
                                p-id="6003"
                            ></path>
                        </svg>
                        <svg
                            viewBox="0 0 1066 1024"
                            style="width: 3.3rem; height: 3.3rem"
                        >
                            <path
                                d="M548.48 0c282.752 0 512 229.248 512 512s-229.248 512-512 512c-282.794667 0-512-229.248-512-512s229.205333-512 512-512z m0 42.666667c-259.242667 0-469.333333 210.133333-469.333333 469.333333s210.090667 469.333333 469.333333 469.333333c259.2 0 469.333333-210.133333 469.333333-469.333333s-210.133333-469.333333-469.333333-469.333333z m0 173.952c168.234667 0 304.597333 118.186667 304.597333 263.936 0 145.792-136.362667 263.978667-304.64 263.978666a348.757333 348.757333 0 0 1-73.130666-7.68c-36.010667 22.357333-109.866667 70.528-109.866667 70.528s-0.341333-76.672 0-115.797333c-73.813333-48.128-121.6-124.757333-121.6-211.029333 0-145.749333 136.362667-263.936 304.64-263.936z m-129.706667 223.658666a40.448 40.448 0 0 0-40.533333 40.32 40.448 40.448 0 0 0 40.533333 40.32c22.4 0 40.533333-18.005333 40.533334-40.32a40.448 40.448 0 0 0-40.533334-40.32z m135.850667 0a40.448 40.448 0 0 0-40.576 40.32 40.448 40.448 0 0 0 40.533333 40.32 40.448 40.448 0 0 0 40.618667-40.32 40.490667 40.490667 0 0 0-40.576-40.32z m135.850667 0a40.490667 40.490667 0 0 0-40.576 40.32 40.448 40.448 0 0 0 40.576 40.32 40.448 40.448 0 0 0 40.533333-40.32 40.448 40.448 0 0 0-40.533333-40.32z"
                                fill="#2397FF"
                                p-id="9807"
                            ></path>
                        </svg>
                        <svg
                            viewBox="0 0 1024 1024"
                            style="width: 4rem; height: 4rem"
                        >
                            <path
                                d="M441.05 164.53c49.52-9.62 101.09-8.57 150.18 3.06 43.01 10.18 84.04 28.57 120.29 53.84 65.19 45.14 114.56 112.69 137.32 188.68 20.42 67.17 20.07 140.33-0.41 207.44l-0.13 0.46c-23.01-53.51-74.79-93.34-132.27-102.5l-0.01-0.11c0.47-40.52-11.14-81.12-33.35-115.06-22.75-35.1-56.37-63.06-95.1-78.89-39.94-16.49-85.1-19.84-127.09-9.72-39.19 9.32-75.35 30.59-102.8 60.04-28.81 30.73-47.9 70.45-53.65 112.2-6.29 44.14 2.08 90.27 23.8 129.23 19.43 35.16 49.34 64.4 84.89 83.08 30.24 16.01 64.53 24.1 98.72 23.74h0.11c7.41 46.72 35.01 89.65 73.93 116.41 9 6.11 18.38 11.95 28.55 15.85l-0.56 0.16c-69.43 21.22-145.37 20.78-214.4-1.82-75.89-24.48-142.72-75.63-186.49-142.25-23.43-35.39-40.37-75.04-49.76-116.43-11.55-50.94-11.75-104.42-0.53-155.44 14.59-67.14 49.51-129.62 98.75-177.51 49.09-48.12 112.46-81.52 180.01-94.46z"
                                fill="#5C5CEF"
                                p-id="22508"
                            ></path>
                            <path
                                d="M596.41 537.54c35.61-21.21 78.78-28.95 119.61-22.14l0.01 0.11c-0.55 37.38-11.1 74.74-31.06 106.43-16.48 26.73-39.2 49.58-65.79 66.26-31.95 20.42-69.77 31.29-107.63 31.82h-0.11c-5.28-31.73-1.94-64.9 9.96-94.81 14.36-36.47 41.23-67.8 75.01-87.67zM848.3 618.01l0.13-0.46c12.06 27.01 17.34 56.99 15.05 86.49-3.04 42.37-22.11 83.28-52.48 112.96-17.34 17.04-38.17 30.6-60.92 39.23-43.64 17.04-93.93 15.35-136.61-3.79l0.56-0.16c37.37-11.79 72.97-29.37 104.52-52.68 11.87-9.03 23.82-18.11 34.23-28.85 2.98-3 6.62-5.3 9.3-8.61 4.52-5.81 10.34-10.43 14.84-16.26 32.42-37 56.69-80.95 71.38-127.87z"
                                fill="#19FFDC"
                                p-id="22509"
                            ></path>
                            <path
                                d="M716.03 515.51c57.48 9.16 109.26 48.99 132.27 102.5-14.69 46.92-38.96 90.87-71.38 127.87-4.5 5.83-10.32 10.45-14.84 16.26-2.68 3.31-6.32 5.61-9.3 8.61-10.41 10.74-22.36 19.82-34.23 28.85-31.55 23.31-67.15 40.89-104.52 52.68-10.17-3.9-19.55-9.74-28.55-15.85-38.92-26.76-66.52-69.69-73.93-116.41 37.86-0.53 75.68-11.4 107.63-31.82 26.59-16.68 49.31-39.53 65.79-66.26 19.96-31.69 30.51-69.05 31.06-106.43z"
                                fill="#09EFDA"
                                p-id="22510"
                            ></path>
                        </svg>
                        <svg
                            viewBox="0 0 1024 1024"
                            style="width: 3.7rem; height: 3.7rem"
                        >
                            <path
                                d="M517.116019 967.737602c-120.532167 0-233.850026-46.937009-319.079152-132.165112C112.80774 750.341317 65.870732 637.025505 65.870732 516.492314c0-120.532167 46.938032-233.850026 132.166135-319.079152C283.26497 112.184035 396.583852 65.246003 517.116019 65.246003c120.53319 0 233.850026 46.938032 319.079152 132.166135s132.166135 198.546985 132.166135 319.079152c0 120.53319-46.937009 233.849002-132.166135 319.079152C750.966045 920.79957 637.64921 967.737602 517.116019 967.737602zM517.116019 108.790752c-108.901269 0-211.284077 42.407855-288.287869 119.41267S109.41548 407.591045 109.41548 516.492314s42.407855 211.283054 119.41267 288.286846c77.003791 77.005838 179.3866 119.413694 288.287869 119.413694s211.284077-42.407855 288.287869-119.413694c77.005838-77.003791 119.41267-179.385577 119.41267-288.286846s-42.406832-211.284077-119.41267-288.288892C728.400097 151.198607 626.017288 108.790752 517.116019 108.790752z"
                                fill="#2c2c2c"
                                p-id="39954"
                            ></path>
                            <path
                                d="M693.052031 355.056552l-58.175981 0c0-32.129768-26.049283-58.177004-58.179051-58.177004L460.345038 296.879548c-32.127721 0-58.177004 26.047236-58.177004 58.177004l-58.179051 0c-32.127721 0-58.175981 26.046213-58.175981 58.173934l0 232.69983c0 32.127721 26.048259 58.172911 58.175981 58.172911l349.063047 0c32.129768 0 58.178027-26.045189 58.178027-58.172911l0-232.69983c0-32.127721-26.047236-58.177004-58.178027-58.177004L693.052031 355.056552zM519.453251 614.775758c-49.109488 0-88.929402-39.814798-88.929402-88.922239 0-49.110511 39.819914-88.927355 88.929402-88.927355 49.111534 0 88.930425 39.816844 88.930425 88.927355C608.383676 574.959937 568.564785 614.775758 519.453251 614.775758L519.453251 614.775758zM519.453251 614.775758"
                                fill="#2c2c2c"
                                p-id="39955"
                            ></path>
                        </svg>
                    </div>
                    <div class="zhong">
                        <div
                            style="
                                display: flex;
                                align-items: center;
                                gap: 10px;
                            "
                        >
                            <svg
                                viewBox="0 0 1024 1024"
                                style="width: 3rem; height: 3rem"
                            >
                                <path
                                    d="M509.014999 512.046737m-262.543634 0a262.543634 262.543634 0 1 0 525.087268 0 262.543634 262.543634 0 1 0-525.087268 0Z"
                                    fill="#FFD54F"
                                    p-id="51646"
                                ></path>
                                <path
                                    d="M510.601314 0.11053c0 1.705715 67.222223 48.391131 67.222223 91.886861a62.224479 62.224479 0 0 1-67.222223 65.618851 62.224479 62.224479 0 0 1-67.222224-65.635908c0-43.495729 67.222223-93.575518 67.222224-91.869804z"
                                    fill="#FFD54F"
                                    p-id="51647"
                                ></path>
                                <path
                                    d="M869.21081 155.364698c-1.228115 1.194 11.940004 81.9596-19.342807 112.184868a62.224479 62.224479 0 0 1-93.933718-2.695029 62.224479 62.224479 0 0 1 0.460543-93.950776c31.282811-30.225268 114.044097-16.716006 112.815982-15.539063z"
                                    fill="#FFD54F"
                                    p-id="51648"
                                ></path>
                                <path
                                    d="M1022.571634 513.411308c-1.705715-0.034114-49.53396 66.40348-93.029689 65.670023a62.241536 62.241536 0 0 1-64.527194-68.347995 62.241536 62.241536 0 0 1 66.778738-66.113509c43.495729 0.750515 92.483861 68.825595 90.778145 68.791481z"
                                    fill="#FFD54F"
                                    p-id="51649"
                                ></path>
                                <path
                                    d="M869.176695 868.660546c-1.228115-1.176943-81.499057 14.754434-112.781867-15.453777a62.224479 62.224479 0 0 1-0.545829-93.984889 62.224479 62.224479 0 0 1 93.899604-2.763259c31.299868 30.225268 20.656207 113.395925 19.44515 112.218982z"
                                    fill="#FFD54F"
                                    p-id="51650"
                                ></path>
                                <path
                                    d="M510.601314 1023.948829c0-1.705715 67.222223-48.391131 67.222223-91.886861a62.224479 62.224479 0 0 0-67.222223-65.584737 62.224479 62.224479 0 0 0-67.222224 65.584737c0 43.495729 67.222223 93.558461 67.222224 91.886861z"
                                    fill="#FFD54F"
                                    p-id="51651"
                                ></path>
                                <path
                                    d="M154.891533 155.330584c1.228115 1.194-11.940004 81.976657 19.342807 112.201925a62.224479 62.224479 0 0 0 93.916661-2.729144 62.224479 62.224479 0 0 0-0.4776-93.933718c-31.299868-30.259382-113.975868-16.698949-112.781868-15.522006z"
                                    fill="#FFD54F"
                                    p-id="51652"
                                ></path>
                                <path
                                    d="M1.445423 513.34308c1.705715-0.034114 49.53396 66.40348 93.029689 65.670023a62.241536 62.241536 0 0 0 64.49308-68.347995 62.241536 62.241536 0 0 0-66.778738-66.113509c-43.529844 0.750515-92.415632 68.825595-90.744031 68.791481z"
                                    fill="#FFD54F"
                                    p-id="51653"
                                ></path>
                                <path
                                    d="M154.942705 868.660546c1.228115-1.176943 81.516114 14.720319 112.781867-15.522005a62.224479 62.224479 0 0 0 0.477601-93.933719 62.224479 62.224479 0 0 0-93.916662-2.729143c-31.299868 30.259382-20.536807 113.361811-19.342806 112.201924z"
                                    fill="#FFD54F"
                                    p-id="51654"
                                ></path>
                            </svg>
                            <span>22Â°</span>
                        </div>
                        <div
                            style="
                                display: flex;
                                flex-direction: column;
                                justify-self: end;
                                align-items: end;
                                font-size: inherit;
                                gap: 7px;
                            "
                        >
                            <span>æ—¥æœ¬å¸‚</span> <span id="day">1æœˆ4æ—¥</span>
                        </div>
                    </div>
                    <div class="app">
                        <div
                            style="
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                            "
                            class="app-svg-div"
                        >
                            <svg viewBox="0 0 1024 1024" width="64" height="64">
                                <path
                                    d="M763.776 968.576H261.504C147.456 968.576 55.04 876.16 55.04 762.112V259.84c0-114.048 92.416-206.464 206.464-206.464h502.272C877.824 53.376 970.24 145.792 970.24 259.84v502.272c0 114.048-92.416 206.464-206.464 206.464z"
                                    fill="#009CF5"
                                    p-id="52731"
                                ></path>
                                <path
                                    d="M529.792 586.496h-100.48l75.648-130.56 7.68-13.312 51.84-89.088 9.984-17.408 21.504-36.864c9.472-16.128 9.728-36.864-1.024-52.096-9.216-13.056-22.4-18.304-35.456-18.304-15.36 0-30.336 7.936-38.784 22.272l-7.68 13.568-7.936-13.568c-8.448-14.336-23.552-22.272-38.784-22.272-7.68 0-15.36 1.792-22.528 5.888-21.248 12.288-28.544 39.808-16.128 61.056l33.408 57.728-135.168 233.216H238.08c-26.88 0.256-48.384 24.064-44.16 52.096 3.328 22.016 23.936 37.376 46.208 37.376h33.92l103.424-0.256H583.936c3.84 0 7.68-1.664 9.984-4.736 11.776-15.744 20.48-40.192-8.32-65.408-15.232-13.44-35.584-19.328-55.808-19.328z"
                                    fill="#FFFFFF"
                                    p-id="52732"
                                ></path>
                                <path
                                    d="M785.28 586.24h-86.016l-115.072-198.528c-2.048-3.456-6.656-4.608-9.856-2.304-16.128 11.648-25.6 27.904-30.464 45.824-8.192 30.208-1.408 62.592 14.208 89.728l24.704 42.88 13.056 22.784 51.84 89.344 5.376 8.96 49.792 86.016c8.448 14.336 23.296 22.272 38.528 22.272 7.68 0 15.616-2.048 22.784-6.144 21.248-12.288 28.544-39.552 16.128-61.056l-29.056-50.304h36.224c26.88 0 48.256-24.32 43.904-52.352-3.584-21.888-23.936-37.12-46.08-37.12zM319.616 687.616c-15.744-6.4-30.592-5.632-42.496-2.304-6.528 1.792-11.904 6.272-15.232 12.032l-16.64 28.416c-12.544 21.504-5.12 48.768 16.128 61.056 7.168 4.096 15.104 6.144 22.784 6.144 15.36 0 30.08-7.936 38.272-22.272l18.944-32.64c4.608-8.064 5.504-17.792 2.048-26.368-3.84-9.6-11.008-18.816-23.808-24.064z"
                                    fill="#FFFFFF"
                                    p-id="52733"
                                ></path>
                            </svg>
                            <span>Store</span>
                        </div>
                        <div
                            style="
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                            "
                            class="app-svg-div"
                            data-app="twitter"
                        >
                            <svg viewBox="0 0 1024 1024" width="64" height="64">
                                <path
                                    d="M849.92 51.2H174.08c-67.8656 0-122.88 55.0144-122.88 122.88v675.84c0 67.8656 55.0144 122.88 122.88 122.88h675.84c67.8656 0 122.88-55.0144 122.88-122.88V174.08c0-67.8656-55.0144-122.88-122.88-122.88z m-93.65504 336.5888a317.0816 317.0816 0 0 1 0.4352 16.11776c0 165.16096-126.8224 355.53792-358.656 355.53792-71.14752 0-137.4208-20.72064-193.24416-56.05888a248.6272 248.6272 0 0 0 30.04928 1.7664 254.80704 254.80704 0 0 0 156.56448-53.45792c-55.13728-1.08544-101.67808-37.28384-117.71392-86.79424 7.67488 1.37216 15.616 2.29888 23.74656 2.29888a124.6208 124.6208 0 0 0 33.13152-4.50048c-57.61024-11.47904-101.08416-61.94176-101.08416-122.54208v-1.46432c17.02912 9.216 36.48512 14.96064 57.15456 15.59552-33.85856-22.49728-56.064-60.66688-56.064-104.03328 0-22.81472 6.14912-44.43648 17.06496-62.90432a359.2192 359.2192 0 0 0 259.80416 130.62144 125.37344 125.37344 0 0 1-3.29216-28.50816c0-68.97664 56.42752-124.91264 126.05952-124.91264 36.24448 0 68.96128 15.0784 91.88864 39.40352 28.73344-5.5296 55.7312-16.0256 80.09728-30.30528-9.40032 29.12768-29.42464 53.7856-55.48032 69.24288 25.62048-3.1488 49.8944-9.82016 72.47872-19.82464a247.84384 247.84384 0 0 1-62.94016 64.72192z"
                                    fill="#03A9F4"
                                    p-id="54801"
                                ></path>
                            </svg>
                            <span>æ¨ç‰¹</span>
                        </div>
                        <div
                            style="
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                position: relative;
                            "
                            data-app="QQ"
                            class="app-svg-div"
                        >
                            <svg viewBox="0 0 1024 1024" width="64" height="64">
                                <path
                                    d="M887.85832 64.549132 136.14168 64.549132c-39.540552 0-71.591525 32.051997-71.591525 71.590502l0 751.718687c0 39.538505 32.051997 71.591525 71.591525 71.591525l751.71664 0c39.538505 0 71.592548-32.05302 71.592548-71.591525L959.450868 136.139633C959.449845 96.601128 927.396825 64.549132 887.85832 64.549132zM862.687034 644.674719l0 5.110391 0 4.786003-0.860601 5.754051-1.236154 9.869788-1.720178 8.9263-2.636037 8.067746-0.967024 3.307326-1.828648 3.925403-1.560542 2.77009-2.043542 3.413749-1.829671 2.125407-2.311649 2.769067-2.043542 2.204202-2.204202 1.936095-2.636037 1.157359-2.367931 1.155313-1.934049 0.644683-1.694595 0-1.264806 0-1.908466-0.644683-3.631714-1.775436-1.664919-1.182942-1.722224-1.290389-1.910513-1.694595-1.908466-1.908466-3.173273-3.496637-3.765767-5.000897-2.957355-5.109368-2.957355-4.14132-2.877537-4.787026-4.060479-8.496511-4.570085-8.846482-0.537236-0.297782-0.754177 0-1.88186 1.37123-1.075495 2.339278-1.774413 2.851954-3.120061 8.631588-4.679579 12.235672-6.02318 14.653745-4.516874 7.341199-4.76042 7.635911-5.621021 8.606005-5.969968 8.443299-3.064802 3.818979-3.710508 4.142343-8.525164 8.389064 0.754177 0.75213 1.154289 1.182942 4.249791 2.52859 17.748223 8.497535 7.745405 4.356214 7.366781 4.247744 7.313569 5.324262 6.508227 5.539156 3.174296 2.446725 2.366907 2.877537 2.418073 3.279696 2.044566 3.63069 1.077541 2.984984 1.342578 3.603061 0.539282 3.065825 0.64366 3.629667-0.64366 2.447748 0 2.419096-0.539282 2.581802-1.342578 2.312672-0.539282 1.827625-1.182942 2.205225-3.226484 4.383844-2.956332 3.523243-2.312672 2.63399-1.936095 1.936095-4.89345 3.603061-5.54018 3.092431-5.915733 2.984984-6.293333 2.849908-7.098675 2.743484-3.764744 1.181919-3.38919 0.969071-8.175193 1.908466-8.498558 1.801019-8.496511 1.829671-9.250688 1.479701-9.573029 0.402159-9.78997 1.182942-9.680477 0-10.218736 0-10.487865 0-10.970866-0.644683-10.219759-0.940418-10.970866-1.479701-10.917654-1.183965-11.509125-1.612731-11.134595-2.743484L592.539314 853.880461l-10.81123-3.065825-11.078313-3.926426-10.862395-3.307326-5.702885-1.909489-5.109368-1.828648-3.225461-1.237177-3.174296-0.644683-4.142343 0-4.89345 0-10.431583-0.75213-5.298679-0.538259-6.80294-0.751107-4.357238 3.924379-5.969968 3.738138-8.066723 3.952009-8.928347 4.894474-5.431709 2.63399-5.647627 2.125407-12.531408 5.109368-6.80294 1.693572-7.125281 1.936095-9.895371 1.882883-6.185886 0.537236-6.562463 0.537236-6.830569 0.754177-7.959276 0.322341-7.637957 0-7.959276 0-16.914228 0-18.3663-0.322341-17.801435-1.828648-9.035794-1.238201-8.712429-1.290389-8.497535-1.291412-8.497535-1.693572-7.879458-2.555196-7.878434-1.801019-7.099698-2.877537-6.722098-2.63399-6.239098-3.012613-5.431709-3.28072-5.432733-3.926426-1.828648-1.935072-2.420119-2.312672-1.829671-2.042519-1.666966-2.312672-1.50733-2.365884-1.182942-2.312672-1.694595-5.001921-0.618077-2.555196-0.754177-2.876514 0-2.636037 0.754177-2.983961 0-2.986007 0.618077-2.983961 0-1.802042 0-4.140297 0.295735-3.201925 1.39886-3.629667 1.182942-3.603061 2.153036-4.355191 1.558495-1.694595 1.291412-1.908466 3.387144-4.14132 2.689249-2.152013 2.52859-1.478677 2.341325-1.908466 3.736091-1.183965 2.958378-1.77646 3.710508-1.935072 4.248767-1.264806 4.247744-1.290389 4.894474-1.048889 4.678556-0.645706 5.541203-0.751107 5.968945-0.431835 1.586125-0.536212 0.322341 0 0.754177-0.644683 0-0.699941-1.076518-1.506307-3.199878-1.505283-7.958252-6.883781-5.324262-4.248767-6.185886-5.431709-6.239098-6.05081-6.508227-7.770987-7.421017-8.712429-2.796696-4.679579-3.711532-4.894474-3.173273-5.64558-2.850931-6.157233-3.873214-5.834892-2.52859-6.724145-2.984984-6.66684-2.984984-7.476275-2.205225-7.098675-2.043542-8.819876-0.644683-0.323365-0.6191 0-0.322341-0.645706-0.754177 0-1.263783 0.645706-0.645706 0.323365-0.858554 1.478677-0.323365 1.802042-0.644683 1.613754-1.12973 2.63399-3.657296 6.507204-1.882883 3.926426-2.984984 3.388167-3.199878 4.140297-3.496637 4.571109-3.710508 4.061502-4.357238 3.925403-4.059456 3.710508-4.437056 2.877537-4.894474 3.091408-4.678556 1.802042-5.539156 1.39886-5.431709 0.509606-0.537236 0-0.753153 0-1.237177-0.509606-0.969071-2.152013-1.612731-1.048889-2.097778-5.108345-1.290389-2.77009-1.39886-3.925403-1.156336-4.14132-0.6191-4.033873-1.721201-9.249665-0.644683-5.433756 0-5.538133 0-12.31549 0.644683-13.283538 1.076518-6.831592 1.263783-6.990205 1.156336-7.556093 2.043542-7.018857 2.312672-8.094352 2.366907-7.852852 3.174296-8.093329 2.984984-7.745405 4.113691-7.877411 3.873214-8.497535 4.678556-7.985882 5.51255-8.606005 5.621021-7.745405 5.862521-8.603959 4.894474-5.968945 6.265704-6.91141 6.589069-6.910387 3.065825-3.279696 3.736091-3.738138 5.406127-4.705162 5.54018-4.759397 9.03477-8.094352 6.830569-4.975315 2.420119-1.802042-1.344624-4.140297-1.075495-5.431709-0.753153-2.984984 0-3.738138 0-4.463662 0-4.03285 1.290389-4.787026 1.345648-5.109368 1.720178-5.297656 2.341325-5.942339 3.091408-6.184863 4.356214-6.184863 0-4.330632 0.429789-4.060479 0.645706-5.51255 1.88186-6.15621 1.721201-6.696516 1.37123-3.093455 1.586125-2.848884 2.043542-3.200902 2.205225-2.339278 0-4.356214 0-4.894474 0-6.076392 1.290389-7.852852 1.290389-9.143241 2.312672-10.970866 3.173273-11.348466 2.366907-6.290263 2.339278-6.803963 2.555196-6.372128 3.065825-6.80294 3.119037-7.448646 3.604084-6.990205 4.03285-7.476275 5.109368-7.42204 2.340301-4.247744 2.52859-3.523243 5.458315-7.878434 5.592368-7.851828 6.399757-8.067746 6.830569-7.906064 7.42204-7.743358 7.744381-7.959276 9.358135-8.604982 5.969968-5.216815 7.232728-5.646604 7.342222-5.001921 7.959276-4.786003 7.637957-4.248767 8.604982-3.495614 9.143241-4.356214 9.087982-2.984984 9.090029-3.092431 9.787924-3.065825 9.788947-2.339278 10.326183-1.909489 10.432607-1.721201 10.272971-1.370207 10.32516-1.39886 10.972912-0.6191 10.431583 0 10.812253 0 11.18576 0 10.812253 1.37123 10.862395 1.291412 11.078313 1.155313 10.273994 2.474354 10.863419 2.311649 10.19213 2.636037 11.160177 3.01159 10.219759 3.602038 9.7869 4.14132 10.434653 4.356214 9.5454 4.786003 9.250688 5.324262 9.0624 5.862521 7.851828 5.405103 3.604084 3.092431 3.820002 2.204202 7.259334 6.185886 6.132674 5.968945 6.076392 6.157233 5.969968 6.801916 4.894474 6.589069 5.808286 6.80294 4.088108 7.313569 4.113691 6.508227 4.383844 7.554046 3.603061 6.589069 6.131651 13.929244 3.010567 7.207146 2.341325 6.723122 2.339278 7.205099 2.097778 6.831592 1.506307 5.833869 1.88186 6.91141 3.334955 12.316513 2.124384 10.754948 1.370207 10.43363 1.183965 8.389064 1.883907 12.746302 0.429789 2.043542 1.505283 2.311649 4.034896 6.614651 2.579755 4.437056 2.313695 4.705162 2.957355 4.975315 2.580778 5.969968 1.666966 6.157233 1.828648 6.695492 1.39886 6.910387 0.645706 3.388167 0.537236 4.14132 0 3.629667-0.537236 3.63069 0 4.464685-1.076518 4.355191-1.934049 8.391111-2.206248 4.247744-1.611707 4.786003 0 1.182942 0.75213 1.480724 2.205225 3.521197 9.575076 14.144138 7.581676 10.595312 3.604084 7.15291 4.89345 7.743358 4.247744 8.498558 4.89652 9.141194 4.892427 10.219759 5.513574 11.588943 3.090385 7.126304 2.850931 6.883781 2.476401 7.367805 2.420119 6.560416 1.828648 6.939039 1.880837 6.480598 2.365884 12.664438 1.882883 12.961196 1.289366 11.45489L862.688057 644.674719z"
                                    fill="#1296db"
                                    p-id="63263"
                                ></path>
                            </svg>
                            <span>QQ</span>
                            <div
                                class="new_tips"
                                style="
                                    position: absolute;
                                    right: -5px;
                                    top: -5px;
                                    background-color: red;
                                    color: #fff;
                                    width: 25px;
                                    height: 25px;
                                    border-radius: 50%;
                                    display: none;
                                    justify-content: center;
                                    align-items: center;
                                    font-size: 15px;
                                "
                            >
                                1
                            </div>
                        </div>
                        <div
                            style="
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                            "
                            class="app-svg-div"
                        >
                            <svg viewBox="0 0 1024 1024" width="57" height="57">
                                <path
                                    d="M860.16 0C950.272 0 1024 73.889684 1024 164.163368v531.509895s-32.768-4.122947-180.224-53.355789c-40.96-14.362947-96.256-34.896842-157.696-57.478737 36.864-63.595789 65.536-137.485474 86.016-215.444211h-202.752v-71.841684h247.808V256.512h-247.808V135.437474h-100.352c-18.432 0-18.432 18.458947-18.432 18.458947v104.663579H200.704v41.040842h249.856v69.793684H243.712v41.013895H645.12c-14.336 51.307789-34.816 98.519579-57.344 141.608421-129.024-43.115789-268.288-77.985684-356.352-55.403789-55.296 14.362947-92.16 38.992842-112.64 63.595789-96.256 116.978526-26.624 295.504842 176.128 295.504842 120.832 0 237.568-67.718737 327.68-178.526316C757.76 742.858105 1024 853.692632 1024 853.692632v6.144C1024 950.110316 950.272 1024 860.16 1024H163.84C73.728 1024 0 950.137263 0 859.836632V164.163368C0 73.889684 73.728 0 163.84 0h696.32zM268.126316 553.121684c93.049263-10.374737 180.062316 26.974316 283.270737 78.874948-74.886737 95.501474-165.941895 155.701895-256.970106 155.701894-157.830737 0-204.368842-126.652632-125.466947-197.200842 26.300632-22.851368 72.838737-35.301053 99.166316-37.376z"
                                    fill="#00A0EA"
                                    p-id="64921"
                                ></path>
                            </svg>
                            <span>æ”¯ä»˜å®</span>
                        </div>
                    </div>
                </div>
                <div id="App_Page" style="height: 100%">
                    <div class="twitter" id="App_twitter" style="display: none">
                        <div class="mimictwitter">
                            <div style="margin-right: 8px; margin-top: 10px">
                                <div
                                    style="
                                        display: grid;
                                        grid-template-columns: 1fr 1fr 1fr;
                                        align-items: center;
                                    "
                                >
                                    <div
                                        style="
                                            border-radius: 50%;
                                            width: 32px;
                                            height: 32px;
                                            margin-left: 7px;
                                        "
                                        class="twitter-close-btn user_avatar"
                                    ></div>
                                    <svg
                                        viewBox="0 0 24 24"
                                        style="
                                            width: 24.73px;
                                            height: 54px;
                                            justify-self: center;
                                        "
                                    >
                                        <g>
                                            <path
                                                d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"
                                            ></path>
                                        </g>
                                    </svg>
                                    <svg
                                        style="
                                            margin-left: auto;
                                            width: 24px;
                                            height: 24px;
                                        "
                                        viewBox="0 0 1024 1024"
                                        aria-hidden="true"
                                    >
                                        <g>
                                            <path
                                                d="M596.992 512q0 34.016-24 59.008-12 12-27.488 18.496T512.992 596q-34.016 0-59.008-24.992-4.992-4.992-8.51199999-10.016t-6.49600001-11.008-4.992-12.512-3.48799999-12.992-1.50400001-12.512q0-35.00800001 24.992-59.488t59.488-24.512 59.488 24q7.008 8 12.992 17.504t8.512 20.512T596.96 512z m0 332q0 35.00800001-24 59.008-8 8-17.504 13.504t-20.512 8.512-22.016 3.008q-34.016 0-59.008-24.992-6.016-4.992-10.496-12t-7.488-14.496-4.992-16-2.016-16.512q0-35.00800001 24.992-59.488t59.488-24.51199999 59.488 24.99199999q11.008 11.008 17.504 27.008t6.496 32z m0-664.992q0 35.00800001-24 59.008-8 8-17.504 13.504t-20.512 8.512-22.016 3.00800001q-34.016 0-59.008-24.51200001T428.96 179.04000001t24.992-59.00800001q12-12 27.488-18.496t31.488-6.496q35.00800001 0 60 24.992 11.008 11.008 17.504 27.008t6.496 32z"
                                                fill="#000000"
                                                p-id="1477"
                                            ></path>
                                        </g>
                                    </svg>
                                </div>
                                <div style="margin-top: 13px"></div>
                                <div
                                    style="
                                        display: grid;
                                        grid-template-columns: 1fr 1fr;
                                        align-items: center;
                                        justify-items: center;
                                    "
                                >
                                    <span style="color: #5f6f7b">ä¸ºä½ æ¨è</span>
                                    <span><strong>æ­£åœ¨å…³æ³¨</strong></span>
                                </div>
                                <div
                                    style="
                                        margin-top: 8px;
                                        display: grid;
                                        grid-template-columns: 1fr 1fr;
                                        align-items: center;
                                        justify-items: center;
                                    "
                                >
                                    <div></div>
                                    <div
                                        style="
                                            background-color: #1d9bf0;
                                            width: 100%;
                                            height: 4px;
                                            border-radius: 50px;
                                        "
                                    ></div>
                                </div>
                                <div
                                    style="
                                        width: 100%;
                                        height: 1px;
                                        background-color: #f0f4f5;
                                        margin-top: 2px;
                                    "
                                ></div>
                            </div>
                            <div class="twitter-content"><hr /></div>
                        </div>
                    </div>
                    <div
                        class="QQ"
                        id="App_QQ"
                        style="
                            background-color: #eff3ff;
                            width: 100%;
                            height: 100%;
                            box-sizing: border-box;
                            position: relative;
                        "
                    >
                                                 <div id="QQ_home_page" style="display: flex; flex-direction: column; height: calc(100% - 20px);">
                            <div style="width: 100%; height: 30px"></div>
                            <div
                                style="
                                    display: flex;
                                    align-items: center;
                                    gap: 5px;
                                    width: 100%;
                                    box-sizing: border-box;
                                "
                            >
                                <div
                                    class="user_avatar"
                                    style="
                                        width: 35px;
                                        height: 35px;
                                        border-radius: 50%;
                        margin-left: 28px;
                                    "
                                ></div>
                                <div
                                    style="
                                        display: flex;
                                        align-items: start;
                                        justify-content: center;
                                        flex-direction: column;
                                        margin-left: 3px;
                                        gap: 3px;
                                        position: relative;
                                    "
                                >
                                    <span
                                        style="font-size: 15px; cursor: pointer; position: relative;"
                                        id="QQ_home_UserName"
                                        onclick="QQ_ToggleUserMenu()"
                                        ><strong>{{user}}</strong></span
                                    >
                                    <!-- ç”¨æˆ·ä¸‹æ‹‰èœå• -->
                                    <div id="QQ_user_menu" style="
                                        position: absolute;
                                        top: 100%;
                                        left: 0;
                                        background: white;
                                        border-radius: 8px;
                                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                                        z-index: 1000;
                                        min-width: 150px;
                                        display: none;
                                        animation: menuSlideDown 0.2s ease;
                                    ">
                                        <div class="user_menu_item" onclick="QQ_ShowSpiritButton(); QQ_HideUserMenu();" style="
                                            padding: 12px 16px;
                                            cursor: pointer;
                                            border-bottom: 1px solid #f0f0f0;
                                            display: flex;
                                            align-items: center;
                                            gap: 8px;
                                            font-size: 14px;
                                            color: #333;
                                            transition: background-color 0.2s ease;
                                        " onmouseover="this.style.backgroundColor='#f5f5f5'" 
                                           onmouseout="this.style.backgroundColor='transparent'">
                                            ğŸ§šâ€âœ¨ <span>å¬å”¤äº’åŠ¨ç²¾çµ</span>
                                        </div>
                                        <div class="user_menu_item" onclick="QQ_ShowInteractiveStats(); QQ_HideUserMenu();" style="
                                            padding: 12px 16px;
                                            cursor: pointer;
                                            border-bottom: 1px solid #f0f0f0;
                                            display: flex;
                                            align-items: center;
                                            gap: 8px;
                                            font-size: 14px;
                                            color: #333;
                                            transition: background-color 0.2s ease;
                                        " onmouseover="this.style.backgroundColor='#f5f5f5'" 
                                           onmouseout="this.style.backgroundColor='transparent'">
                                            ğŸ“Š <span>äº’åŠ¨ç»Ÿè®¡</span>
                                        </div>
                                        <div class="user_menu_item" onclick="window.QQ_Show_Interactive_Stats(); QQ_HideUserMenu();" style="
                                            padding: 12px 16px;
                                            cursor: pointer;
                                            display: flex;
                                            align-items: center;
                                            gap: 8px;
                                            font-size: 14px;
                                            color: #333;
                                            transition: background-color 0.2s ease;
                                        " onmouseover="this.style.backgroundColor='#f5f5f5'" 
                                           onmouseout="this.style.backgroundColor='transparent'">
                                            ğŸ”§ <span>è°ƒè¯•ä¿¡æ¯</span>
                                        </div>
                                    </div>
                                    <div
                                        style="
                                            display: flex;
                                            align-items: center;
                                            height: 10px;
                                        "
                                    >
                                        <svg
                                            viewBox="0 0 1024 1024"
                                            width="13"
                                            height="13"
                                            style="margin-right: 2px"
                                        >
                                            <path
                                                d="M957.539 464.339c-26.14-245.993-246.771-424.08-492.787-397.772C218.735 92.873 40.474 313.62 66.635 559.634 92.774 805.631 313.406 983.717 559.443 957.41c245.997-26.306 424.258-247.075 398.096-493.071z m-298.25-135.757c39.341 0 71.233 31.921 71.233 71.301 0 39.379-31.891 71.3-71.233 71.3-39.338 0-71.229-31.921-71.229-71.3 0-39.38 31.892-71.301 71.229-71.301z m-294.447 0c39.34 0 71.23 31.921 71.23 71.301 0 39.379-31.89 71.3-71.23 71.3s-71.228-31.921-71.228-71.3c0-39.38 31.887-71.301 71.228-71.301z m366.815 304.963c-21.735 96.663-119.97 163.563-219.591 163.563-103.222 0-200.969-68.713-220.487-167.453 0-26.686 20.351-36.26 32.887-36.26h370.156c9.115 0.017 43.978 3.176 37.035 40.15z"
                                                fill="#fbba13"
                                                p-id="5845"
                                            ></path>
                                        </svg>
                                        <span style="font-size: 11px"
                                            >Qæˆ‘å§</span
                                        >
                                        <svg
                                            viewBox="0 0 1024 1024"
                                            width="10"
                                            height="10"
                                            style="margin-top: 1px"
                                        >
                                            <path
                                                d="M342.528 916.48c19.456 0 38.4-7.168 53.248-21.504l338.944-327.68c14.848-14.336 23.552-34.304 23.552-55.296s-8.192-40.96-23.552-55.296l-338.944-327.68c-30.72-29.696-79.36-28.672-108.544 2.048-29.696 30.72-28.672 79.36 2.048 108.544l281.6 272.384-281.6 272.384c-30.72 29.696-31.232 78.336-2.048 108.544 15.36 15.872 35.328 23.552 55.296 23.552z"
                                                fill="#000000"
                                                p-id="7578"
                                            ></path>
                                        </svg>
                                    </div>
                                </div>
                                <svg
                    id="contacts_add_btn"
                    class="add-button"
                                    viewBox="0 0 1024 1024"
                                    version="1.1"
                                    width="20"
                                    height="20"
                                    style="
                                        margin-left: auto;
                        margin-right: 28px;
                                    "
                                >
                                    <path
                                        d="M512 0a42.666667 42.666667 0 0 1 42.666667 42.666667v426.666666h426.666666a42.666667 42.666667 0 0 1 0 85.333334H554.666667v426.666666a42.666667 42.666667 0 0 1-85.333334 0V554.666667H42.666667a42.666667 42.666667 0 0 1 0-85.333334h426.666666V42.666667a42.666667 42.666667 0 0 1 42.666667-42.666667z"
                                        fill="#191919"
                                        p-id="4261"
                                    ></path>
                                </svg>
                            </div>
                            <div style="width: 100%; height: 10px"></div>
                            <!-- æœç´¢æ¡†æ”¾åœ¨è”ç»œäººåˆ—è¡¨å¤–é¢ -->
                <div
                                id="floating_search_box"
                    style="
                                    width: calc(100% - 40px);
                        height: 30px;
                                    background-color: rgba(239, 243, 255, 0.9);
                                    margin-left: 20px;
                                    margin-bottom: 5px;
                        border-radius: 5px;
                        display: flex;
                        align-items: center;
                                    gap: 8px;
                                    padding: 0 10px;
                                    z-index: 100;
                                    backdrop-filter: blur(5px);
                                    border: 1px solid rgba(25, 154, 255, 0.2);
                                    transition: all 0.3s ease;
                                    position: sticky;
                                    top: 0;
                    "
                >
                    <svg
                        viewBox="0 0 1024 1024"
                        width="16"
                        height="16"
                                    style="flex-shrink: 0;"
                    >
                        <path
                            d="M446.112323 177.545051c137.567677 0.219798 252.612525 104.59798 266.162424 241.493333 13.562828 136.895354-78.778182 261.818182-213.617777 289.008485-134.852525 27.203232-268.386263-52.156768-308.945455-183.608889s25.018182-272.252121 151.738182-325.779394A267.235556 267.235556 0 0 1 446.112323 177.545051m0-62.060607c-182.794343 0-330.989899 148.195556-330.989899 330.989899s148.195556 330.989899 330.989899 330.989899 330.989899-148.195556 330.989899-330.989899-148.195556-330.989899-330.989899-330.989899z m431.321212 793.341415a30.849293 30.849293 0 0 1-21.94101-9.102223l-157.220202-157.220202c-11.752727-12.179394-11.584646-31.534545 0.37495-43.50707 11.972525-11.972525 31.327677-12.140606 43.494141-0.37495l157.220202 157.220202a31.036768 31.036768 0 0 1 6.723232 33.810101 31.004444 31.004444 0 0 1-28.651313 19.174142z m0 0"
                            fill="#919095"
                        ></path>
                    </svg>
                                <input 
                                    type="text" 
                                    id="contact_search_input"
                                    placeholder="æœç´¢è”ç»œäºº..."
                                    style="
                                        flex: 1;
                                        border: none;
                                        background: transparent;
                                        outline: none;
                                        color: #333;
                                        font-size: 14px;
                                    "
                                >
                                <div id="search_clear_btn" style="
                                    display: none;
                                    cursor: pointer;
                                    width: 16px;
                                    height: 16px;
                                    background-color: #ccc;
                                    border-radius: 50%;
                                    position: relative;
                                    flex-shrink: 0;
                                ">
                                    <div style="
                                        position: absolute;
                                        top: 50%;
                                        left: 50%;
                                        transform: translate(-50%, -50%);
                                        color: white;
                                        font-size: 12px;
                                        line-height: 1;
                                    ">Ã—</div>
                </div>
            </div>
                            <div id="QQ_home_chars">
        </div>
        </div>
                                <div id="QQ_message_list_page" style="display: none; flex-direction: column; height: calc(100% - 20px);">
            <!-- æ¶ˆæ¯é¡µé¢ï¼šåªæ˜¾ç¤ºç”¨æˆ·å¤´åƒå’Œè”ç³»äººåˆ—è¡¨ï¼Œä¸æ˜¾ç¤ºæœç´¢æ¡† -->
            <div style="width: 100%; height: 30px"></div>
            <div
                style="
                    display: flex;
                    align-items: center;
                    gap: 5px;
                    width: 100%;
                    box-sizing: border-box;
                "
            >
                <div
                    class="user_avatar"
                    style="
                        width: 35px;
                        height: 35px;
                        border-radius: 50%;
                        margin-left: 28px;
                    "
                ></div>
                <div
                    style="
                        display: flex;
                        align-items: start;
                        justify-content: center;
                        flex-direction: column;
                        margin-left: 3px;
                        gap: 3px;
                    "
                >
                    <span
                        style="font-size: 15px; cursor: pointer;"
                        id="QQ_message_list_UserName"
                        onclick="QQ_ToggleUserMenu()"
                        ><strong>{{user}}</strong></span
                    >
                    <div
                        style="
                            display: flex;
                            align-items: center;
                            height: 10px;
                        "
                    >
                        <svg
                            viewBox="0 0 1024 1024"
                            width="13"
                            height="13"
                            style="margin-right: 2px"
                        >
                            <path
                                d="M957.539 464.339c-26.14-245.993-246.771-424.08-492.787-397.772C218.735 92.873 40.474 313.62 66.635 559.634 92.774 805.631 313.406 983.717 559.443 957.41c245.997-26.306 424.258-247.075 398.096-493.071z m-298.25-135.757c39.341 0 71.233 31.921 71.233 71.301 0 39.379-31.891 71.3-71.233 71.3-39.338 0-71.229-31.921-71.229-71.3 0-39.38 31.892-71.301 71.229-71.301z m-294.447 0c39.34 0 71.23 31.921 71.23 71.301 0 39.379-31.89 71.3-71.23 71.3s-71.228-31.921-71.228-71.3c0-39.38 31.887-71.301 71.228-71.301z m366.815 304.963c-21.735 96.663-119.97 163.563-219.591 163.563-103.222 0-200.969-68.713-220.487-167.453 0-26.686 20.351-36.26 32.887-36.26h370.156c9.115 0.017 43.978 3.176 37.035 40.15z"
                                fill="#fbba13"
                                p-id="5845"
                            ></path>
                        </svg>
                        <span style="font-size: 11px"
                            >Qæˆ‘å§</span
                        >
                        <svg
                            viewBox="0 0 1024 1024"
                            width="10"
                            height="10"
                            style="margin-top: 1px"
                        >
                            <path
                                d="M342.528 916.48c19.456 0 38.4-7.168 53.248-21.504l338.944-327.68c14.848-14.336 23.552-34.304 23.552-55.296s-8.192-40.96-23.552-55.296l-338.944-327.68c-30.72-29.696-79.36-28.672-108.544 2.048-29.696 30.72-28.672 79.36 2.048 108.544l281.6 272.384-281.6 272.384c-30.72 29.696-31.232 78.336-2.048 108.544 15.36 15.872 35.328 23.552 55.296 23.552z"
                                fill="#000000"
                                p-id="7578"
                            ></path>
                        </svg>
                    </div>
                </div>
                <svg
                    id="messages_add_btn"
                    class="add-button"
                    viewBox="0 0 1024 1024"
                    version="1.1"
                    width="20"
                    height="20"
                    style="
                        margin-left: auto;
                        margin-right: 28px;
                    "
                >
                    <path
                        d="M512 0a42.666667 42.666667 0 0 1 42.666667 42.666667v426.666666h426.666666a42.666667 42.666667 0 0 1 0 85.333334H554.666667v426.666666a42.666667 42.666667 0 0 1-85.333334 0V554.666667H42.666667a42.666667 42.666667 0 0 1 0-85.333334h426.666666V42.666667a42.666667 42.666667 0 0 1 42.666667-42.666667z"
                        fill="#191919"
                        p-id="4261"
                    ></path>
                </svg>
            </div>
            <div style="width: 100%; height: 20px"></div>
            <div id="QQ_message_list_chars">
                <!-- æ¶ˆæ¯è”ç³»äººåˆ—è¡¨ï¼Œåªæ˜¾ç¤ºæœ‰æ¶ˆæ¯è®°å½•çš„è”ç³»äºº -->
            </div>
        </div>
        <div
            id="QQ_space_page"
            style="display: none; height: calc(100% - 20px); flex-direction: column;"
        >
                            <div style="width: 100%; height: 35px"></div>
                            <div style="display: flex">
                                <span style="font-size: 16px; margin-left: 28px"
                                    >åŠ¨æ€</span
                                >
                                <svg
                                    viewBox="0 0 1024 1024"
                                    width="20"
                                    height="20"
                                    style="margin-left: auto"
                                >
                                    <path
                                        d="M593.420488 922.099512c24.553022 0 44.456585 19.903563 44.456585 44.456586v11.988292c0 24.553022-19.903563 44.456585-44.456585 44.456586h-159.843903c-24.553022 0-44.456585-19.903563-44.456585-44.456586v-11.988292c0-24.553022 19.903563-44.456585 44.456585-44.456586h159.843903zM515.996098 0c24.276293 0 43.957073 19.68078 43.957073 43.957073l0.002997 54.191079C735.392843 121.808047 870.649756 272.137241 870.649756 454.056585V740.277073h102.4c24.553022 0 44.456585 19.903563 44.456585 44.456586v11.988292c0 24.553022-19.903563 44.456585-44.456585 44.456586H870.649756v1.998048H152.35122v-1.998048H52.948293C28.39527 841.178537 8.491707 821.274974 8.491707 796.721951v-11.988292C8.491707 760.180636 28.39527 740.277073 52.948293 740.277073H152.35122V454.056585c0-181.229019 134.231914-331.106654 308.696538-355.632702L461.049756 43.957073c0-24.276293 19.68078-43.957073 43.957073-43.957073h10.989269z m25.620979 197.047571h-60.233178c-126.178779 0-228.706654 101.264109-230.744664 226.958361l-0.029971 3.816273-0.000999 312.454868h521.783446V427.822205c0-127.454533-103.3211-230.774634-230.774634-230.774634z"
                                        fill="#000000"
                                        p-id="3355"
                                    ></path>
                                </svg>
                                <svg
                                    viewBox="0 0 1065 1024"
                                    width="20"
                                    height="20"
                                    style="
                                        margin-right: 28px;
                                        margin-left: 15px;
                                    "
                                >
                                    <path
                                        d="M1002.234305 330.02867V693.97133c0 53.148789-28.346021 101.741967-73.902125 128.063272l-315.349481 182.224419c-46.062284 26.321305-102.248146 26.321305-148.31043 0l-315.349481-182.224419c-46.062284-26.321305-73.902126-75.420662-73.902126-128.063272V330.02867c0-53.148789 28.346021-101.741967 73.902126-128.063272l315.349481-182.224419c46.062284-26.321305 102.248146-26.321305 148.31043 0l315.349481 182.224419c45.556105 26.321305 73.902126 74.914483 73.902125 128.063272z m-76.939199 0c0-25.308947-13.666831-49.099357-35.432526-61.753831l-315.349481-182.224419c-22.271873-12.654474-49.099357-12.654474-71.37123 0l-315.349481 182.224419c-22.271873 12.654474-35.432526 36.444884-35.432526 61.753831V693.97133c0 25.308947 13.666831 49.099357 35.432526 61.753831l315.349481 182.224419c22.271873 12.654474 49.099357 12.654474 71.37123 0l315.349481-182.224419c22.271873-12.654474 35.432526-36.444884 35.432526-61.753831V330.02867zM362.424123 508.709837C362.424123 410.004943 442.400395 329.522491 541.611468 329.522491s179.187346 80.482452 179.187346 179.187346-80.482452 179.187346-179.187346 179.187345-179.187346-79.470094-179.187345-179.187345z m76.939199 0c0 56.692042 46.062284 102.248146 102.248146 102.248146s102.248146-46.062284 102.248146-102.248146-46.062284-102.248146-102.248146-102.248146-102.248146 46.568463-102.248146 102.248146z"
                                        fill="#000000"
                                        p-id="13806"
                                    ></path>
                                </svg>
                            </div>
                            <div
                                style="
                                    width: 100%;
                                    height: 1px;
                                    background-color: #e6e6e6;
                                    margin-bottom: 10px;
                                    margin-top: 10px;
                                "
                            ></div>
                            <div
                                class="space_contents"
                                id="space_contents"
                                style="
                                    overflow-y: auto;
                                    width: 100%;
                                    flex: 1;
                                    height: calc(100vh - 180px);
                                "
                            >
                                <div style="margin-bottom: 80px"></div>
                            </div>
                        </div>
                        <div class="QQ_bottom_nav">
                            <div
                                id="QQ_message_nav"
                                style="
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    flex-direction: column;
                                    gap: 1px;
                                "
                            >
                                <svg
                                    class="icon"
                                    viewBox="0 0 1024 1024"
                                    width="20"
                                    height="20"
                                    style="
                                        transform: scale(1.15);
                                        transform-origin: center;
                                        fill: #000000;
                                    "
                                    id="QQ_message_svg"
                                >
                                    <path
                                        d="M822.016 61.44H196.864A155.88352 155.88352 0 0 0 40.96 216.94976v426.2144a155.88352 155.88352 0 0 0 155.904 155.50976h9.6256a1.97632 1.97632 0 0 1 1.96608 1.9456l0.97792 84.992A72.832 72.832 0 0 0 322.72896 945.152l211.37408-141.09184a31.9744 31.9744 0 0 1 17.80736-5.39648h270.1056A155.88352 155.88352 0 0 0 977.92 643.16416V216.94976A155.88352 155.88352 0 0 0 822.016 61.44z m85.06368 581.72416a85.05344 85.05344 0 0 1-85.06368 84.84864H551.936a102.69184 102.69184 0 0 0-57.21088 17.33632l-211.39456 141.09184a1.9712 1.9712 0 0 1-3.072-1.6128l-0.97792-85.02272A72.97024 72.97024 0 0 0 206.4896 728.0128h-9.6256a85.05344 85.05344 0 0 1-85.06368-84.84864V216.94976A85.05344 85.05344 0 0 1 196.864 132.096h625.152a85.05344 85.05344 0 0 1 85.06368 84.84864v426.2144z"
                                    ></path>
                                    <path
                                        d="M311.08608 381.76768a54.17472 54.17472 0 1 0 54.31296 54.17472 54.24128 54.24128 0 0 0-54.31296-54.17472z m207.80032 0a54.17472 54.17472 0 1 0 54.31296 54.17472 54.24128 54.24128 0 0 0-54.31296-54.17472z m212.52096 0a54.17472 54.17472 0 1 0 54.31296 54.17472 54.24128 54.24128 0 0 0-54.31296-54.17472z"
                                    ></path>
                                </svg>
                                <span>æ¶ˆæ¯</span>
                            </div>
                            <div
                                id="QQ_people_nav"
                                style="
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    flex-direction: column;
                                    gap: 1px;
                                "
                            >
                                <svg
                                    viewBox="0 0 1024 1024"
                                    style="fill: #019aff"
                                    width="20"
                                    height="20"
                                    id="QQ_people_svg"
                                >
                                    <path
                                        d="M620.744191 538.879184c82.736353-40.523949 140.308583-124.785028 140.308583-222.936465 0-137.367601-111.714338-249.080915-249.02668-249.080915-137.367601 0-249.080915 111.713314-249.080915 249.080915 0 98.151437 57.57223 182.412516 140.363841 222.936465C235.330238 586.429153 111.796714 740.736565 111.796714 923.694503c0 18.464537 15.032368 33.443693 33.496905 33.443693 18.464537 0 33.497928-14.979156 33.497928-33.443693 0-183.774537 149.46001-333.343017 333.234547-333.343017 183.77556 0 333.234547 149.568481 333.234547 333.343017 0 18.464537 14.978133 33.443693 33.443693 33.443693 18.519796 0 33.496905-14.979156 33.496905-33.443693C912.20124 740.736565 788.668739 586.429153 620.744191 538.879184zM329.886801 315.942719c0-100.438527 81.70179-182.194552 182.140317-182.194552 100.384291 0 182.086082 81.756025 182.086082 182.194552 0 100.384291-81.702813 182.086082-182.086082 182.086082C411.587568 498.0288 329.886801 416.32701 329.886801 315.942719z"
                                    ></path>
                                </svg>
                                <span>è”ç³»äºº</span>
                            </div>
                            <div
                                id="QQ_moment_nav"
                                style="
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    flex-direction: column;
                                    gap: 1px;
                                    position: relative;
                                "
                            >
                                <svg
                                    viewBox="0 0 1059 1024"
                                    width="20"
                                    height="20"
                                    id="QQ_moment_svg"
                                    style="fill: #000000"
                                >
                                    <path
                                        d="M206.566465 1008.20002c11.278404 7.517627 30.080982 15.035253 45.117545 15.035254 11.281023 0 26.324133-3.75554 37.605156-7.517627l240.646548-127.777391 240.646547 127.777391c11.278404 7.517627 22.558118 7.517627 37.602537 7.517627 15.037872 0 30.075744-3.75554 45.118854-15.035254 22.559427-15.030015 37.598609-45.097903 30.082292-71.402393l-45.124092-278.110282L1037.545084 459.503632c18.799959-18.790793 26.321514-48.85868 18.799959-75.163172-7.516317-26.311038-33.839141-45.103141-60.156726-48.85868L714.181074 290.382568 593.854527 42.338864C582.577432 16.027826 556.254609 0.99912 526.177555 0.99912c-30.080982 0-56.403806 15.028706-67.684829 41.339744l-120.32 248.043704L63.679182 331.723621c-26.316276 3.756849-52.640409 22.548951-60.161965 48.853443-7.516317 26.309729-3.758159 56.376307 18.801269 75.169719l199.285852 199.183713-45.120164 278.106353c-3.758159 30.065269 7.521555 60.133156 30.082291 75.163171zM63.679182 406.886793l274.492235-41.339744 48.878322-7.518936 22.559427-45.097903 116.568389-248.042394 120.318691 248.043703 22.562046 45.097903 48.88225 7.516317 274.485688 41.339744L789.383529 606.074435l-33.845688 33.822117 7.522865 45.103141 45.124092 278.103734-240.651785-127.777391-41.356767-26.311039-45.124093 22.555499-240.646547 131.532931 45.120164-278.103734 7.521555-45.103141-30.082292-33.823427L63.679182 406.888102z"
                                        p-id="37579"
                                    ></path>
                                    <path
                                        d="M526.176246 692.509463c-131.604951 0-176.725115-127.777391-176.725116-131.53424-3.763396-15.035253 3.758159-30.065269 18.796031-33.828665 15.044419-3.75554 30.080982 3.763396 33.845688 18.793411 0 3.762087 33.839141 93.953964 124.084706 93.953965 90.239018 0 124.078159-93.953964 124.078159-93.953965 3.763396-15.030015 18.801269-22.548951 33.845688-18.793411 15.036563 3.763396 22.558118 22.555499 18.79603 33.828665 0 3.756849-45.120164 131.53555-176.721186 131.535549z"
                                        p-id="37580"
                                    ></path>
                                </svg>
                                <span>åŠ¨æ€</span>
                                <div
                                    class="new_tips"
                                    style="
                                        position: absolute;
                                        right: -8px;
                                        top: -8px;
                                        background-color: red;
                                        color: #fff;
                                        width: 15px;
                                        height: 15px;
                                        border-radius: 50%;
                                        display: none;
                                        justify-content: center;
                                        align-items: center;
                                        font-size: 12px;
                                    "
                                >
                                    1
                                </div>
                            </div>
                        </div>
                        <div
                            id="QQ_friend_info"
                            style="
                                display: none;
                                background-color: #fff;
                                height: 100%;
                                width: 100%;
                                padding-top: 50px;
                                padding-left: 10px;
                            "
                        >
                            <span>è‡ªå®šä¹‰åç§°:</span
                            ><input
                                name=""
                                id="setcharname"
                                placeholder="è¿™é‡Œè¾“å…¥åç§°"
                            /><br /><br /><span>è‡ªå®šä¹‰å¤´åƒ:</span>
                            <input
                                type="file"
                                id="QQ_head_input"
                            /><br /><br /><br /><button
                                onclick="Setfriendinfo(!1)"
                            >
                                å–æ¶ˆ
                            </button>
                            <button onclick="Setfriendinfo(!0)">ç¡®å®š</button>
                        </div>
                    </div>
                    <div
                        class="discord"
                        id="App_discord"
                        style="display: none; width: 100%; height: 100%"
                    >
                        <div
                            class="discord-homepage"
                            style="width: 100%; height: 100%"
                        >
                            <div class="discord-top">
                                <svg
                                    t="1744127791511"
                                    class="discord-top-return"
                                    viewBox="0 0 1024 1024"
                                    version="1.1"
                                    xmlns="http://www.w3.org/2000/svg"
                                    p-id="3402"
                                    width="28"
                                    height="28"
                                >
                                    <path
                                        d="M440.070244 831.562927c11.813463 0 23.601951-4.49561 32.593171-13.486829a45.980098 45.980098 0 0 0 0-65.161366l-198.730927-198.730927 589.674146 0.499512c24.001561 0 43.507512-19.431024 43.40761-43.40761 0-24.101463-19.480976-43.63239-43.507512-43.63239l-592.221659-0.574439 201.378342-201.378341a45.980098 45.980098 0 0 0 0-65.161366 45.980098 45.980098 0 0 0-65.186342 0L131.29678 476.734439a45.955122 45.955122 0 0 0-13.53678 33.16761v0.574439c0 13.361951 5.994146 25.300293 15.409951 33.292488l274.307122 274.332097c8.99122 8.966244 20.804683 13.461854 32.593171 13.461854z"
                                        p-id="3403"
                                        fill="#505058"
                                    ></path>
                                </svg>
                                <svg
                                    aria-hidden="true"
                                    width="20"
                                    height="20"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    style="
                                        margin-left: 15px;
                                        margin-right: 10px;
                                    "
                                >
                                    <path
                                        fill="#313237"
                                        fill-rule="evenodd"
                                        d="M18.09 1.63c.4-.7 1.43-.7 1.82 0l3.96 6.9c.38.66-.12 1.47-.91 1.47h-7.92c-.79 0-1.3-.81-.91-1.48l3.96-6.9Zm.46 1.87h.9c.3 0 .52.26.5.55l-.22 2.02c-.01.16-.17.26-.33.23a1.92 1.92 0 0 0-.8 0c-.16.03-.32-.07-.33-.23l-.21-2.02a.5.5 0 0 1 .5-.55ZM19 9a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z"
                                        clip-rule="evenodd"
                                        class=""
                                    ></path>
                                    <path
                                        fill="#313237"
                                        d="M14.8 3.34a.48.48 0 0 0-.24-.69A9.94 9.94 0 0 0 11 2c-4.97 0-9 3.58-9 8 0 1.5.47 2.91 1.28 4.11.14.21.12.49-.06.67l-1.51 1.51A1 1 0 0 0 2.4 18h5.1a.5.5 0 0 0 .49-.5c0-2.86 1.62-5.3 3.97-6.56.28-.15.38-.51.25-.8a2.86 2.86 0 0 1 .18-2.61l2.4-4.19ZM18.91 12.98a5.45 5.45 0 0 1 2.18 6.2c-.1.33-.09.68.1.96l.83 1.32a1 1 0 0 1-.84 1.54h-5.5A5.6 5.6 0 0 1 10 17.5a5.6 5.6 0 0 1 5.68-5.5c1.2 0 2.32.36 3.23.98Z"
                                        class=""
                                    ></path>
                                </svg>
                                <div class="discord-top-title">
                                    <strong>ç±»è„‘ÎŸÎ”Î¥Î£Î£Î•Î™Î‘</strong>
                                </div>
                                <div
                                    style="
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        background-color: #ebebeb;
                                        border-radius: 50%;
                                        height: 32px;
                                        width: 32px;
                                        margin-left: auto;
                                        margin-right: 10px;
                                    "
                                >
                                    <svg
                                        viewBox="0 0 1024 1024"
                                        width="16"
                                        height="16"
                                    >
                                        <path
                                            d="M991.418182 972.8L791.272727 772.654545c79.127273-83.781818 130.327273-195.490909 130.327273-316.50909 0-251.345455-200.145455-451.490909-446.836364-451.49091C232.727273 0 32.581818 204.8 32.581818 451.490909s200.145455 451.490909 446.836364 451.490909c97.745455 0 190.836364-32.581818 265.309091-88.436363l200.145454 204.8 46.545455-46.545455zM102.4 451.490909c0-209.454545 167.563636-381.672727 377.018182-381.672727s377.018182 172.218182 377.018182 381.672727-172.218182 386.327273-381.672728 386.327273c-204.8 0-372.363636-172.218182-372.363636-386.327273z"
                                            fill="#55565c"
                                            p-id="12001"
                                        ></path>
                                    </svg>
                                </div>
                            </div>
                            <div
                                style="
                                    width: 100%;
                                    height: 1px;
                                    background-color: #dcdcdc;
                                "
                            ></div>
                            <div
                                style="
                                    width: 100%;
                                    height: 1px;
                                    background-color: #d8d9db;
                                "
                            ></div>
                            <div class="discord-top-button">
                                <div class="sortbutton">
                                    <svg
                                        aria-hidden="true"
                                        role="img"
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="16"
                                        height="16"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            fill="#515256"
                                            d="M16.3 21.7a1 1 0 0 0 1.4 0l4-4a1 1 0 0 0-1.4-1.4L18 18.58V3a1 1 0 1 0-2 0v15.59l-2.3-2.3a1 1 0 0 0-1.4 1.42l4 4ZM6.3 2.3a1 1 0 0 1 1.4 0l4 4a1 1 0 0 1-1.4 1.4L8 5.42V21a1 1 0 1 1-2 0V5.41l-2.3 2.3a1 1 0 0 1-1.4-1.42l4-4Z"
                                            class=""
                                        ></path>
                                    </svg>
                                    <div
                                        style="font-size: 14px; color: #515256"
                                    >
                                        æ’åº & æŸ¥çœ‹
                                    </div>
                                    <svg
                                        aria-hidden="true"
                                        role="img"
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="20"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            fill="#515256"
                                            d="M5.3 9.3a1 1 0 0 1 1.4 0l5.3 5.29 5.3-5.3a1 1 0 1 1 1.4 1.42l-6 6a1 1 0 0 1-1.4 0l-6-6a1 1 0 0 1 0-1.42Z"
                                            class=""
                                        ></path>
                                    </svg>
                                </div>
                                <div class="tagbutton">
                                    <div
                                        style="font-size: 14px; color: #515256"
                                    >
                                        æ ‡ç­¾
                                    </div>
                                    <svg
                                        aria-hidden="true"
                                        role="img"
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="20"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            fill="#515256"
                                            d="M5.3 9.3a1 1 0 0 1 1.4 0l5.3 5.29 5.3-5.3a1 1 0 1 1 1.4 1.42l-6 6a1 1 0 0 1-1.4 0l-6-6a1 1 0 0 1 0-1.42Z"
                                            class=""
                                        ></path>
                                    </svg>
                                </div>
                            </div>
                            <div
                                style="
                                    width: 100%;
                                    height: 1px;
                                    background-color: #dcdcdc;
                                "
                            ></div>
                            <div
                                style="
                                    width: 100%;
                                    height: 1px;
                                    background-color: #d8d9db;
                                "
                            ></div>
                            <div class="discord-cardlist">
                                <div class="discord-cardget">
                                    <span>æŸ¥çœ‹å¸–å­</span>
                                </div>
                            </div>
                        </div>
                        <div
                            class="discord-thread-list"
                            style="width: 100%; height: 100%; display: none"
                        ></div>
                    </div>
                </div>
            </div>
            <div
                class="top"
                style="
                    display: flex;
                    align-items: center;
                    justify-content: center;
                "
            >
                <svg
                    t="1735485675807"
                    class="icon"
                    viewBox="0 0 1024 1024"
                    version="1.1"
                    xmlns="http://www.w3.org/2000/svg"
                    p-id="9713"
                    width="16"
                    height="16"
                >
                    <path
                        d="M716.8 805.823147 716.8 384.709973c0-95.68256-77.544107-173.2608-173.216427-173.2608L56.664747 211.449173c-3.754667 0-6.795947 3.024213-6.795947 6.741333L49.8688 805.819733c0 3.71712 3.04128 6.72768 6.795947 6.72768l130.061653 0c3.754667 0 6.792533-3.027627 6.792533-6.765227L193.518933 344.562347c0-3.744427 3.04128-6.782293 6.795947-6.782293l279.68512 0c52.52096 0 95.112533 42.571093 95.112533 95.09888l0 372.8896c0 3.741013 3.037867 6.761813 6.772053 6.761813l128.146773 0c3.72736 0 6.772053-3.017387 6.772053-6.72768M454.15424 805.778773c0 3.744427-3.01056 6.76864-6.76864 6.76864L317.354667 812.547413c-3.754667 0-6.795947-3.027627-6.795947-6.76864L310.55872 452.348587c0-3.741013 3.04128-6.77888 6.795947-6.77888l130.030933 0c3.75808 0 6.76864 3.037867 6.76864 6.77888l0 353.447253L454.15424 805.778773zM974.134613 805.778773c0 3.744427-3.044693 6.76864-6.79936 6.76864l-130.000213 0c-3.764907 0-6.826667-3.027627-6.826667-6.76864L830.508373 218.251947c0-3.75808 3.06176-6.792533 6.826667-6.792533l130.000213 0c3.75808 0 6.79936 3.034453 6.79936 6.792533L974.134613 805.778773z"
                        fill="#ffffff"
                        p-id="9714"
                    ></path>
                </svg>
            </div>
        </div>
        <script></script>
        <script>
            var __webpack_exports__ = {}; // ./src/ç•Œé¢/chat/chat_page.html
            var lastAiNewMessages = {};
            
            // ä¸»åŠ¨æ¶ˆæ¯æœªè¯»çŠ¶æ€ç®¡ç† - å…¨å±€å˜é‡
            var proactiveMessageUnreadCounts = new Map(); // è§’è‰²å -> æœªè¯»æ•°é‡

            // Module
            var code =
                '<div data-name="${name}" class="QQ_chat_page" style="width:100%;height:100%;padding-top:0"> <div style="padding-top:10px;backdrop-filter:blur(1px);background-color:rgb(255,255,255,.1)"> <div style="width:100%;height:20px;display:grid;top:0;left:0;grid-template-columns:auto 1fr auto;align-items:center;margin-top:20px"> <svg class="QQ-close-btn" viewBox="0 0 1024 1024" style="height:18px;width:18px;margin-left:8px"> <path d="M769.137778 153.372444L444.984889 512l324.152889 358.684444c36.408889 35.043556 36.408889 91.989333 0 126.976a95.744 95.744 0 0 1-131.868445 0l-377.571555-417.678222c-1.536-1.365333-3.584-1.877333-5.063111-3.299555A87.438222 87.438222 0 0 1 227.555556 512c-0.341333-23.324444 8.533333-46.876444 27.079111-64.739556 1.479111-1.422222 3.527111-1.934222 5.063111-3.185777L637.269333 26.339556a95.744 95.744 0 0 1 131.868445 0c36.408889 35.043556 36.408889 91.932444 0 127.032888z" fill="#666666" p-id="1570"></path> </svg> <div style="display:flex;align-items:center;position:relative"> <div class="new_tips" style="background-color:gray;color:#fff;width:20px;height:20px;border-radius:50%;display:none;justify-content:center;align-items:center;font-size:12px"> 1 </div> <span style="margin-left:8px;color:#000;font-size:16px" id="QQ_chat_username" onclick="handleChatTitleClick(this)">${name}</span> <div class="group-member-dropdown" id="group_member_dropdown" style="display:none;position:absolute;top:25px;left:8px;background:#fff;border:1px solid #ddd;border-radius:5px;box-shadow:0 2px 10px rgba(0,0,0,0.1);z-index:1000;min-width:200px;max-height:300px;overflow-y:auto;"> <div class="group-member-list" id="group_member_list"></div> </div> </div> <svg id="QQ_chat_page_setting" viewBox="0 0 1024 1024" style="height:20px;width:20px;margin-right:20px"> <path d="M901.632 896H122.368c-30.72 0-55.808-25.088-55.808-55.808v-1.536c0-30.72 25.088-55.808 55.808-55.808h779.776c30.72 0 55.808 25.088 55.808 55.808v1.536c-0.512 30.72-25.6 55.808-56.32 55.808zM901.632 568.32H122.368c-30.72 0-55.808-25.088-55.808-55.808v-1.536c0-30.72 25.088-55.808 55.808-55.808h779.776c30.72 0 55.808 25.088 55.808 55.808v1.536c-0.512 30.72-25.6 55.808-56.32 55.808zM901.632 240.64H122.368c-30.72 0-55.808-25.088-55.808-55.808v-1.536c0-30.72 25.088-55.808 55.808-55.808h779.776c30.72 0 55.808 25.088 55.808 55.808v1.536c-0.512 30.72-25.6 55.808-56.32 55.808z" p-id="4301" fill="#666666"></path> </svg> </div> <div style="width:100%;height:.5px;background-color:#eee;margin-top:10px;border-top:1px solid #9a9a9a"></div> </div> <div class="input-container"> <div style="display:flex;align-items:center;width:100%"> <svg viewBox="0 0 1024 1024" width="25" height="25" style="margin-left:10px"> <path d="M512 62a184.09090869 184.09090869 0 0 1 184.09090869 184.09090869v204.54545478a184.09090869 184.09090869 0 1 1-368.18181738 1e-8v-204.54545479A184.09090869 184.09090869 0 0 1 512 62z m0 65.45454521a118.63636348 118.63636348 0 0 0-118.63636348 118.63636348v204.54545479a118.63636348 118.63636348 0 1 0 237.27272695 0v-204.54545479A118.63636348 118.63636348 0 0 0 512 127.45454521z" p-id="6838"></path> <path d="M192.90909131 471.09090869a319.09090869 319.09090869 0 0 0 638.18181738 0 32.72727305 32.72727305 0 1 0-65.45454521 0 253.63636348 253.63636348 0 0 1-507.27272695 0 32.72727305 32.72727305 0 1 0-65.45454522 0z" p-id="6839"></path> <path d="M479.27272695 757.45454521v131.85a32.72727305 32.72727305 0 1 0 65.4545461 0V757.45454521a32.72727305 32.72727305 0 1 0-65.4545461 0z" p-id="6840"></path> <path d="M409.72727305 953.81818174h206.87727216a32.72727305 32.72727305 0 1 0 0-65.45454522H409.72727305a32.72727305 32.72727305 0 1 0 0 65.45454522z" p-id="6841"></path> </svg> <div style="flex-grow:1;margin-left:5px;margin-right:2%"> <input class="userInput" type="text" name="" style="box-sizing:border-box;background-color:transparent"/> </div> <div style="margin-right:7px" id="QQ_chat_send-btn"> <button style="background-color:#fff;border-radius:30px;height:31px;display:block;width:3.5rem;background-color:transparent;border:1px solid rgb(0,0,0,.5)"> å‘é€ </button> </div> </div> </div> <div class="msgcontent" style="padding-top:15px;padding-bottom:0"></div> </div>';
            // Exports
            /* harmony default export */ var chat_page = code; // ./src/ç•Œé¢/chat/chat_page_setting.html
            // Module
            var chat_page_setting_code =
                '<div class="chat-setting-popup"> <div class="chat-setting-header"> <span>èŠå¤©è®¾ç½®</span> <svg class="close-setting-btn" viewBox="0 0 1024 1024" width="20" height="20"> <path d="M512 421.490332 331.092592 240.582924C307.952518 217.442849 270.568889 217.442849 247.428814 240.582924 224.288739 263.722999 224.288739 301.106628 247.428814 324.246702L428.336222 505.154112 247.428814 686.061521C224.288739 709.201596 224.288739 746.585225 247.428814 769.7253 270.568889 792.865374 307.952518 792.865374 331.092592 769.7253L512 588.817891 692.907408 769.7253C716.047482 792.865374 753.431111 792.865374 776.571186 769.7253 799.711261 746.585225 799.711261 709.201596 776.571186 686.061521L595.663778 505.154112 776.571186 324.246702C799.711261 301.106628 799.711261 263.722999 776.571186 240.582924 753.431111 217.442849 716.047482 217.442849 692.907408 240.582924L512 421.490332Z" fill="#666666"></path> </svg> </div> <div class="chat-setting-content"> <div class="setting-item"> <span>æ°”æ³¡é¢œè‰²</span> <div style="flex:1"> <input style="width:100%" type="text" id="bubble-color-input" placeholder="é¢œè‰²å€¼"/> </div> <input type="color" id="bubble-color" class="color-picker"/> </div> <div class="setting-item"> <span>å­—ä½“é¢œè‰²</span> <div style="flex:1"> <input style="width:100%" type="text" id="text-color-input" placeholder="é¢œè‰²å€¼"/> </div> <input type="color" id="text-color" class="color-picker"/> </div> <div class="setting-item"> <span>èŠå¤©å£çº¸</span> <input type="text" id="chat-bg" placeholder="è¾“å…¥å›¾ç‰‡URL"/> </div> <div class="preview" style="margin:0 auto"> <div class="QQ_chat_msgdiv" id="chat-setting-preview" data-name="${username}" style="margin:0 auto"> <span>è¿™æ˜¯é¢„è§ˆæ–‡æœ¬</span> </div> </div> </div> <div class="chat-setting-footer"> <button id="randomcolor-setting-btn" style="background-color:#919bec;color:#fff">éšæœº</button> <button id="save-setting-btn">ä¿å­˜</button> <button id="cancel-setting-btn">å–æ¶ˆ</button> </div> </div>';
            // Exports
            /* harmony default export */ var chat_page_setting =
                chat_page_setting_code; // ./src/ç•Œé¢/chat/chat_list_item.html
            // Module
            var chat_list_item_code =
                '<div data-name="${name}" class="QQ_home_usermsg"> <div class="QQ_home_head" style="background-image:url(\'${head}\')"></div> <div style="width:100%;display:grid;grid-template-columns:1fr auto;grid-template-rows:1fr 1fr;row-gap:4px"> <span class="QQ_home_name"><strong>${name}</strong></span> <span class="QQ_home_lasttime" style="color:#626367;justify-self:end"></span> <span class="QQ_home_lastmsg" style="color:#626367;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">...</span> <div class="QQ_home_usermsg_new" style="display:none"></div> </div> </div>';
            // Exports
            /* harmony default export */ var chat_list_item =
                chat_list_item_code; // ./src/ç•Œé¢/chat/chat_user_message.html
            // Module
            var chat_user_message_code =
                '<div class="QQ_chat_mymsg"> <div style="width:auto;height:auto;margin-top:4px;grid-column:1;grid-row:1;"> ${content} </div> <div class="user_avatar Chat_MyHead" style="grid-column:2;grid-row:1;"></div> <div class="message-status" style="font-size:12px;color:#1976d2;font-weight:500;margin-top:6px;opacity:1;display:flex;align-items:center;justify-content:flex-end;gap:4px;grid-column:1;grid-row:2;margin-right:0;padding-right:8px;"><span class="status-text">å·²å‘é€</span><span class="status-icon" style="color:#4caf50;font-weight:bold;">âœ“</span></div> </div>';
            // Exports
            /* harmony default export */ var chat_user_message =
                chat_user_message_code; // ./src/ç•Œé¢/chat/chat_char_msg.html
            // Module
            var chat_char_msg_code =
                ' <% if (isgroup) { %> <div class="QQ_chat_charmsg"> <div data-name="${name}" class="QQ_chat_head head"></div> <div style="width:auto;height:auto;margin-top:4px"> <span class="name">${name}</span><br/> ${content} </div> </div> <% } else { %> <div class="QQ_chat_charmsg"> <div data-name="${name}" class="QQ_chat_head head"></div> <div style="width:auto;height:auto;margin-top:4px">${content}</div> </div> <% } %>';
            // Exports
            /* harmony default export */ var chat_char_msg = chat_char_msg_code; // ./src/ç•Œé¢/chat/chat_normal_message.html
            // Module
            var chat_normal_message_code =
                '<div class="QQ_chat_msgdiv" data-name="${username}" <% if (isgroup) { %> style="margin-top:6px" <% } %>> <span>${message}</span> </div>';
            // Exports
            /* harmony default export */ var chat_normal_message =
                chat_normal_message_code; // ./src/ç•Œé¢/chat/chat_emoji_message.html
            // Module
            var chat_emoji_message_code =
                '<div class="QQ_chat_msgdiv" data-name="${username}" <% if (isgroup) { %> style="margin-top:6px" <% } %>> <div style="width:100%;background-color:#fff"> <img class="msgimg" loading="lazy" src="<%= emojiUrl %>" alt="åŠ è½½å¤±è´¥"/> </div> <% if (additionalText) { %> <span style="margin-top:5px;display:block"> <%= additionalText %> </span> <% } %> </div>';
            // Exports
            /* harmony default export */ var chat_emoji_message =
                chat_emoji_message_code; // ./src/ç•Œé¢/chat/chat_fakeimg_message.html
            // Module
            var chat_fakeimg_message_code =
                '<div class="QQ_chat_msgdiv" data-name="${username}" <% if (isgroup) { %> style="margin-top:6px" <% } %>> <div class="QQ_chat_fakeimg" style="text-align:center"> <div>${content}</div> </div> ${additionalText} </div>';
            // Exports
            /* harmony default export */ var chat_fakeimg_message =
                chat_fakeimg_message_code; // ./src/ç•Œé¢/chat/chat_music_message.html
            // Module
            var chat_music_message_code =
                '<div class="QQ_chat_music"> <div class="music-container" style="display:grid;grid-template-columns:1fr 64px;width:100%"> <div style="display:flex;flex-direction:column;margin-top:8px;overflow:hidden;max-width:100%"> <div class="hide-title music-name" style="font-size:1.2rem"><strong>${musicname}</strong></div> <div class="hide-title music-author" style="color:#8d8c8d;margin-left:3px;margin-top:10px;font-size:1rem">${musicauthor}</div> </div> <div style="margin-left:auto;position:relative;height:64px;width:64px"> <div class="icon-container" style="width:64px;width:64px;position:relative"> <svg style="position:absolute;left:-3px;top:-5px" class="icon" viewBox="0 0 1024 1024" width="72" height="72"><path d="M773.9392 301.8752m-200.0384 0a200.0384 200.0384 0 1 0 400.0768 0 200.0384 200.0384 0 1 0-400.0768 0Z" fill="#d81e06" p-id="51386"></path><path d="M924.4672 706.2528a24.32 24.32 0 0 1-24.2688 24.2688h-145.7664a24.3712 24.3712 0 0 0-24.2688 24.32 24.2688 24.2688 0 0 0 24.2688 24.2688h48.5888a24.32 24.32 0 0 1 24.2688 24.32 24.32 24.32 0 0 1-24.2688 24.2688h-64.512A388.7616 388.7616 0 0 1 122.88 390.4512h-48.5888a24.32 24.32 0 0 1 0-48.5888h97.28a24.2688 24.2688 0 0 0 6.8096-47.5648l0.768-0.9728H122.88a24.32 24.32 0 1 1 0-48.5888h101.632a388.7616 388.7616 0 0 1 619.52 437.248h56.32a24.32 24.32 0 0 1 24.1152 24.2688z" fill="#2c2c2c" p-id="51387"></path><path d="M565.8112 478.8736a3.84 3.84 0 0 0-4.5568 4.608c3.1744 14.7456 7.8848 40.96 9.984 60.0576 3.6352 32.2048-28.5696 62.3104-53.6064 70.7584-39.424 13.568-84.8896-18.688-95.1296-56.32-11.776-43.9808 12.6464-97.5872 53.2992-115.0464 4.5056-2.0992 9.0112-3.8912 13.568-5.9904 9.3184-4.2496 4.8128-11.1616 3.2768-17.5104-4.1984-17.4592-6.6048-34.9184 2.4064-51.2 13.568-24.4224 48.7936-43.6736 76.1856-31.9488a276.48 276.48 0 0 1 34.6624 16.5888 25.1904 25.1904 0 0 1 10.5472 28.2624c-5.7344 15.36-20.7872 18.9952-36.7616 9.6768a196.1984 196.1984 0 0 0-17.4592-9.9328 16.2304 16.2304 0 0 0-23.808 15.36 150.3744 150.3744 0 0 0 1.9456 18.0224 18.4832 18.4832 0 0 0 13.568 14.8992 200.3456 200.3456 0 0 1 29.3888 8.9088c38.8096 17.152 66.56 45.1584 79.5136 87.04 24.064 77.6704-21.0944 155.0848-87.9616 184.6272a182.016 182.016 0 0 1-116.8384 13.2096 185.6 185.6 0 0 1-126.464-104.8064c-18.0736-40.96-22.8864-82.7904-8.7552-127.0784 18.9952-59.2384 56.9344-99.6352 114.7392-121.9072a23.4496 23.4496 0 0 1 28.0064 9.728 21.1456 21.1456 0 0 1-6.0416 29.5424 259.8912 259.8912 0 0 1-25.2928 13.568c-31.8976 16.2304-51.7632 42.752-64.4096 75.8784-24.7296 64.4096 9.3184 139.1104 65.6384 168.3456 51.7632 27.0848 122.5728 16.2304 160.8192-28.3136A106.2912 106.2912 0 0 0 619.52 542.72c-5.12-25.6-34.5088-59.2896-53.7088-63.8464z m-53.4016 5.9904a6.144 6.144 0 0 0-7.9872-4.5056c-33.28 11.4688-47.5136 47.2576-31.9488 76.4416a28.0064 28.0064 0 0 0 30.1056 13.824c14.1824-4.1984 24.1152-14.4384 22.016-27.6992-2.9696-19.5072-7.936-38.8096-12.1856-58.0608z" fill="#d81e06" p-id="51388"></path></svg> <div class="music-img" style="width:64px;height:64px;position:absolute;left:0;top:0;background-size:cover;z-index:1;background-image:url(\'https://y.qq.com/music/photo_new/T002R800x800M000004Z85XP1c25b7.jpg\');display:none"> </div> </div> <div class="music-play-button"> <svg class="icon-music-play" viewBox="0 0 1024 1024" width="24" height="24"> <path d="M902.420317 544.833016l-585.142857-357.587302v715.174603l585.142857-357.587301z" p-id="42990" fill="#ffffff"></path> </svg> <svg class="icon-music-stop" t="1743245033745" class="icon" viewBox="0 0 1024 1024" width="19" height="19" style="display:none"><path d="M290.133333 128h-39.808C206.336 128 170.666667 178.944 170.666667 241.792v540.416C170.666667 845.056 206.336 896 250.325333 896H290.133333c43.946667 0 79.658667-50.944 79.658667-113.792V241.792C369.792 178.944 334.08 128 290.133333 128zM773.674667 128H733.866667c-43.989333 0-79.658667 50.944-79.658667 113.792v540.416c0 62.848 35.669333 113.792 79.658667 113.792h39.808C817.664 896 853.333333 845.056 853.333333 782.208V241.792C853.333333 178.944 817.664 128 773.674667 128z" fill="#ffffff" p-id="43402"></path></svg> </div> </div> </div> <div style="width:100%;height:2px;background-color:#efefef;margin-bottom:5px;margin-top:5px"></div> <div style="display:flex;align-items:center;gap:5px"> <svg viewBox="0 0 1024 1024" style="width:.9rem;height:.9rem"> <path d="M0 0m184.32 0l655.36 0q184.32 0 184.32 184.32l0 655.36q0 184.32-184.32 184.32l-655.36 0q-184.32 0-184.32-184.32l0-655.36q0-184.32 184.32-184.32Z" fill="#EA3E3C" p-id="1500"></path> <path d="M527.616 849.43872a373.6064 373.6064 0 0 1-162.54976-39.00416c-112.36352-55.16288-180.00896-176.29184-172.55424-308.67456 7.41376-130.34496 85.10464-237.4656 202.752-279.552a35.85024 35.85024 0 0 1 24.15616 67.51232c-107.66336 38.49216-150.81472 136.86784-155.29984 216.13568-5.86752 103.51616 46.08 197.79584 132.34176 240.13824 124.69248 60.30336 216.91392 22.35392 260.82304-5.64224 59.8016-38.16448 97.86368-100.01408 96.95232-157.55264-1.024-63.72352-24.064-120.99584-63.27296-157.14304a145.408 145.408 0 0 0-65.5872-35.28704q2.82624 9.76896 5.64224 19.32288c13.38368 45.63968 24.94464 85.05344 25.6 114.40128a134.26688 134.26688 0 0 1-37.69344 97.76128 139.1104 139.1104 0 0 1-100.6592 40.45824 140.10368 140.10368 0 0 1-100.47488-42.24 169.12384 169.12384 0 0 1-46.2848-122.76736c1.19808-85.12512 80.11776-153.28256 162.816-175.104a324.80256 324.80256 0 0 1-6.71744-67.05152 92.0576 92.0576 0 0 1 69.18144-91.81184c46.21312-12.53376 104.448 5.19168 124.66176 37.888a35.84 35.84 0 0 1-11.70432 49.31584 35.84 35.84 0 0 1-49.26464-11.65312 62.34112 62.34112 0 0 0-48.45568-5.21216c-4.32128 1.71008-12.35968 4.90496-12.76928 23.10144a270.87872 270.87872 0 0 0 6.73792 58.51136 217.4976 217.4976 0 0 1 133.56032 57.6512c53.57568 49.38752 85.0432 125.46048 86.35392 208.71168 1.29024 81.85856-49.7664 167.86432-130.048 219.136a310.14912 310.14912 0 0 1-168.2432 48.65024z m23.6544-457.55392c-56.77056 15.6672-107.4688 63.03744-108.07296 106.42432a98.304 98.304 0 0 0 25.6512 71.43424 68.0448 68.0448 0 0 0 49.36704 20.87936 67.24608 67.24608 0 0 0 49.44896-18.944 63.19104 63.19104 0 0 0 17.23392-46.08c-0.4096-19.79392-11.7248-58.368-22.67136-95.6928-3.61472-12.42112-7.35232-25.14944-10.9568-38.02112z" fill="#FFFFFF" p-id="1501"></path> </svg> <div style="font-size:.9rem;color:#8d8c8c">ç½‘æ˜“äº‘éŸ³ä¹</div> </div> </div>';
            // Exports
            /* harmony default export */ var chat_music_message =
                chat_music_message_code; // ./src/ç•Œé¢/chat/chat_transfer_message.html
            // Module
            var chat_transfer_message_code =
                '<div class="give_money"> <div style="background-color:#4396f7;height:80px;width:100%;color:#fff;padding-top:20px;padding-left:12px;display:flex;flex-direction:column;gap:9px;position:relative"> <span><%= amount %></span> <span>å·²è½¬å…¥ä½ çš„ä½™é¢</span> <div style="border-radius:50%;background-color:#9fccf1;width:50px;height:50px;position:absolute;right:10px;display:flex;align-items:center;justify-content:center;top:15px"> <svg t="1738258225266" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4449" width="33" height="33"> <path d="M954.014 510.695c-31.51 0.303-185.995-88.917-190.874-93.568-11.734-11.188-7.3-25.115 4.673-27.02s79.203-9.898 79.203-9.898c-41.318-110.437-133.518-198.636-254.527-227.223-193.138-45.643-392.87 83.827-437.013 281.424-0.38 1.685-3.047 21.83-19.045 21.191-10.83-0.432-46.309-14.539-59.136-20.556-14.644-6.868-18.601-5.094-14.16-27.201C113.37 156.643 370.632-12.653 617.554 45.272c204.919 48.063 347.27 225.878 362.91 428.477 2.619 27.151-11.203 36.797-26.451 36.944z m-322.516 55.059c20.284 0 36.729 16.427 36.729 36.727 0 20.265-16.445 36.729-36.729 36.729h-73.456v45.909c0 25.359-20.551 45.911-45.911 45.911-25.358 0-45.91-20.551-45.91-45.911V639.21h-73.456c-20.284 0-36.727-16.465-36.727-36.729 0-20.302 16.444-36.727 36.727-36.727h73.456v-36.73h-73.456c-20.284 0-36.727-16.461-36.727-36.726 0-20.3 16.444-36.729 36.727-36.729h73.456v-2.512l-81.508-81.491c-14.445-14.455-14.445-37.875 0-52.313s37.858-14.437 52.304 0l74.497 74.478 74.786-74.784c14.444-14.419 37.859-14.419 52.303 0 14.446 14.454 14.446 37.877 0 52.313l-80.558 80.559v3.749h73.456c20.284 0 36.729 16.429 36.729 36.729 0 20.267-16.445 36.726-36.729 36.726h-73.456v36.73h73.456z m-368.471 51.828c16.112 10.302 12.229 30.994-5.477 32.836s-73.153 6.725-73.153 6.725C228.353 760.157 317.44 841.379 432.63 868.585c193.137 45.623 390.651-77.582 434.806-275.179 0.906-4.054 0.877-3.418 2.457-12.122s4.139-21.945 21.142-16.052 58.475 18.085 71.394 21.539 11.465 8.548 9.846 20.553c-0.493 3.651-1.238 6.994-2.017 10.509-57.81 256.921-309.451 417.196-562.049 357.924-204.677-48.01-346.947-225.429-362.865-427.724-2.159-34.762 22.4-41.857 47.505-28.577 19.75 10.447 154.064 87.822 170.176 98.124z" p-id="4450" fill="#4090ee"></path> </svg> </div> </div> <div style="background-color:#fff;width:100%;height:30px;color:#959598;font-size:13px;padding-left:10px;padding-top:8px"> QQè½¬è´¦ </div> </div> ';
            // Exports
            /* harmony default export */ var chat_transfer_message =
                chat_transfer_message_code; // ./src/ç•Œé¢/chat/chat_char_voice_message.html
            // Module
            var chat_char_voice_message_code =
                '<div class="QQ_chat_msgdiv" data-name="${username}" <% if (isgroup) { %> style="margin-top:6px" <% } %>> <div class="QQ_chat_voice" style="width:100%;display:flex;gap:5px;align-items:center"> <span style="margin-left:2px">${time}"</span> <span style="display:block"> <svg style="transform:rotate(90deg);display:flex;align-items:center" t="1742985508017" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="38914" width="20" height="20"> <path d="M99.931429 457.782857c8.137143 8.137143 20.132571 7.716571 27.849142-0.420571 101.156571-107.574857 234.861714-164.150857 384.438858-164.150857 150.418286 0 284.562286 56.996571 385.28 164.571428 7.277714 7.296 18.870857 7.296 26.569142-0.859428l57.014858-56.996572c6.838857-7.277714 6.838857-16.713143 1.28-23.570286-96.859429-119.149714-279.003429-206.994286-470.144-206.994285S138.934857 257.206857 42.057143 376.356571c-5.997714 6.857143-5.577143 16.274286 1.28 23.588572z m171.428571 171.867429c8.576 8.996571 19.712 8.137143 27.849143-1.28 49.718857-55.296 130.285714-95.158857 213.010286-94.299429 83.565714-0.859429 163.712 40.283429 213.851428 95.579429 8.137143 8.557714 18.852571 8.557714 27.008-0.438857l63.853714-62.994286c6.857143-6.857143 7.716571-15.853714 1.28-23.149714-62.134857-76.708571-177.426286-133.284571-305.993142-133.284572-128.585143 0-243.858286 56.996571-306.011429 133.302857-6.418286 7.277714-5.558857 15.835429 1.28 23.131429z m240.859429 224.987428c8.996571 0 17.133714-4.717714 32.987428-20.132571l100.297143-96.438857c6.418286-5.997714 7.716571-15.414857 2.139429-22.710857-27.008-34.706286-77.568-64.713143-135.424-64.713143-59.154286 0-110.573714 31.286857-137.142858 67.291428-3.858286 5.997714-2.56 14.134857 3.84 20.132572l100.297143 96.438857c15.853714 15.414857 24.009143 20.132571 33.005715 20.132571z" p-id="38915" fill="currentColor"></path> </svg> </span> <span style="display:block" class="totext"> <svg style="margin-left:30px;display:flex;align-items:center" viewBox="0 0 1024 1024" width="24" height="24"> <path d="M999.611733 387.697778a37.831111 37.831111 0 0 0-48.355555 22.641778v0.512l-1.592889 5.233777c-58.88-241.208889-302.648889-388.892444-543.857778-330.012444A446.805333 446.805333 0 0 0 124.546844 295.253333a39.139556 39.139556 0 0 0 13.653334 53.077334 39.310222 39.310222 0 0 0 18.944 5.233777c13.084444 0 25.201778-6.826667 32.540444-18.375111a374.158222 374.158222 0 0 1 359.480889-183.978666 381.952 381.952 0 0 1 337.351111 334.279111 384.568889 384.568889 0 0 1-3.128889 115.086222v2.616889a38.855111 38.855111 0 0 0 21.560889 48.355555c19.456 6.826667 41.528889-3.185778 48.355556-22.641777l68.835555-192.284445a39.310222 39.310222 0 0 0-22.584889-48.924444z m-148.764444 348.956444a38.115556 38.115556 0 0 0-31.004445 16.839111 373.077333 373.077333 0 0 1-355.214222 157.639111 381.212444 381.212444 0 0 1-323.185778-306.346666 396.344889 396.344889 0 0 1 0-140.856889v-1.592889a39.139556 39.139556 0 0 0-22.072888-48.355556 38.058667 38.058667 0 0 0-48.355556 22.584889l-68.835556 191.317334a38.513778 38.513778 0 0 0 23.608889 48.867555c19.456 7.395556 40.96-3.128889 48.355556-22.584889v-3.697777c58.88 241.208889 302.705778 388.892444 543.914667 330.012444A448.739556 448.739556 0 0 0 881.851733 798.151111a38.684444 38.684444 0 0 0-8.362666-54.158222 31.857778 31.857778 0 0 0-22.641778-7.338667z" p-id="41017" fill="currentColor"></path><path d="M310.687289 693.020444a50.517333 50.517333 0 0 0-33.166222 19.456 40.96 40.96 0 0 0 0 31.573334c1.592889 4.721778 3.697778 9.443556 6.257777 14.165333a26.794667 26.794667 0 0 0 13.198223 11.036445 30.833778 30.833778 0 0 0 12.060444 2.104888h5.290667c6.826667-1.080889 13.653333-2.616889 20.48-4.721777 15.758222-5.290667 32.028444-11.605333 48.924444-18.432 16.782222-6.826667 34.133333-15.758222 49.322667-23.608889 15.246222-7.907556 32.597333-17.863111 46.250667-26.282667 14.222222-8.419556 24.177778-15.758222 35.271111-24.177778 24.632889 19.456 50.915556 36.238222 78.791111 49.891556 33.621333 17.351111 68.835556 31.004444 105.073778 42.097778a56.32 56.32 0 0 0 20.48 3.640889 33.905778 33.905778 0 0 0 34.190222-26.282667 39.025778 39.025778 0 0 0-1.592889-35.726222 49.322667 49.322667 0 0 0-26.225778-18.375111 540.842667 540.842667 0 0 1-85.162667-33.621334 603.932444 603.932444 0 0 1-63.601777-38.912c20.48-23.096889 37.831111-48.355556 52.565333-75.662222a465.294222 465.294222 0 0 0 38.343111-98.304h49.436445a38.456889 38.456889 0 0 0 26.282666-12.060444 46.762667 46.762667 0 0 0 7.850667-26.282667 44.032 44.032 0 0 0-8.931556-28.899556 37.432889 37.432889 0 0 0-26.282666-11.036444H568.6784a116.167111 116.167111 0 0 0-9.500444-17.863111c-10.467556-12.629333-22.584889-25.770667-34.702223-38.912a47.786667 47.786667 0 0 0-27.818666-18.375111h-4.209778a36.636444 36.636444 0 0 0-24.177778 8.419555 35.896889 35.896889 0 0 0-18.375111 29.923556 51.2 51.2 0 0 0 16.270222 33.109333l6.314667 6.314667H315.352178a34.133333 34.133333 0 0 0-26.282667 12.629333 45.852444 45.852444 0 0 0-6.826667 26.282667c-0.512 10.467556 2.104889 20.48 7.907556 28.899555 6.826667 6.826667 16.270222 11.036444 26.282667 11.036445h47.274666c5.233778 15.758222 10.524444 32.028444 16.839111 47.786666a419.271111 419.271111 0 0 0 50.403556 94.094223c8.419556 11.036444 17.351111 22.584889 26.282667 33.109333a389.461333 389.461333 0 0 1-64.625778 39.936c-26.282667 12.629333-54.101333 23.096889-81.976889 32.028444z m131.299555-246.954666h140.344889c-6.826667 23.096889-16.839111 45.169778-28.387555 66.730666a325.290667 325.290667 0 0 1-39.936 55.751112 319.146667 319.146667 0 0 1-39.424-52.622223l-2.616889-4.209777a388.778667 388.778667 0 0 1-29.980445-65.649778z" p-id="41018" fill="currentColor"></path></svg> </span> </div> <div class="voice2text" style="display:none"> <div style="width:100%;height:1px;background-color:#000;margin-top:10px;margin-bottom:8px"></div> <span>${content}</span> </div> </div>';
            // Exports
            /* harmony default export */ var chat_char_voice_message =
                chat_char_voice_message_code; // ./src/ç•Œé¢/chat/chat_my_voice_message.html
            // Module
            var chat_my_voice_message_code =
                '<div class="QQ_chat_msgdiv ${username}" <% if (isgroup) { %> style="margin-top:6px" <% } %>> <div class="QQ_chat_voice" style="width:100%;display:flex;gap:5px;align-items:center"> <span style="display:block" class="totext"> <svg style="margin-right:30px;display:flex;align-items:center" viewBox="0 0 1024 1024" width="24" height="24"> <path d="M999.611733 387.697778a37.831111 37.831111 0 0 0-48.355555 22.641778v0.512l-1.592889 5.233777c-58.88-241.208889-302.648889-388.892444-543.857778-330.012444A446.805333 446.805333 0 0 0 124.546844 295.253333a39.139556 39.139556 0 0 0 13.653334 53.077334 39.310222 39.310222 0 0 0 18.944 5.233777c13.084444 0 25.201778-6.826667 32.540444-18.375111a374.158222 374.158222 0 0 1 359.480889-183.978666 381.952 381.952 0 0 1 337.351111 334.279111 384.568889 384.568889 0 0 1-3.128889 115.086222v2.616889a38.855111 38.855111 0 0 0 21.560889 48.355555c19.456 6.826667 41.528889-3.185778 48.355556-22.641777l68.835555-192.284445a39.310222 39.310222 0 0 0-22.584889-48.924444z m-148.764444 348.956444a38.115556 38.115556 0 0 0-31.004445 16.839111 373.077333 373.077333 0 0 1-355.214222 157.639111 381.212444 381.212444 0 0 1-323.185778-306.346666 396.344889 396.344889 0 0 1 0-140.856889v-1.592889a39.139556 39.139556 0 0 0-22.072888-48.355556 38.058667 38.058667 0 0 0-48.355556 22.584889l-68.835556 191.317334a38.513778 38.513778 0 0 0 23.608889 48.867555c19.456 7.395556 40.96-3.128889 48.355556-22.584889v-3.697777c58.88 241.208889 302.705778 388.892444 543.914667 330.012444A448.739556 448.739556 0 0 0 881.851733 798.151111a38.684444 38.684444 0 0 0-8.362666-54.158222 31.857778 31.857778 0 0 0-22.641778-7.338667z" p-id="41017" fill="currentColor"></path><path d="M310.687289 693.020444a50.517333 50.517333 0 0 0-33.166222 19.456 40.96 40.96 0 0 0 0 31.573334c1.592889 4.721778 3.697778 9.443556 6.257777 14.165333a26.794667 26.794667 0 0 0 13.198223 11.036445 30.833778 30.833778 0 0 0 12.060444 2.104888h5.290667c6.826667-1.080889 13.653333-2.616889 20.48-4.721777 15.758222-5.290667 32.028444-11.605333 48.924444-18.432 16.782222-6.826667 34.133333-15.758222 49.322667-23.608889 15.246222-7.907556 32.597333-17.863111 46.250667-26.282667 14.222222-8.419556 24.177778-15.758222 35.271111-24.177778 24.632889 19.456 50.915556 36.238222 78.791111 49.891556 33.621333 17.351111 68.835556 31.004444 105.073778 42.097778a56.32 56.32 0 0 0 20.48 3.640889 33.905778 33.905778 0 0 0 34.190222-26.282667 39.025778 39.025778 0 0 0-1.592889-35.726222 49.322667 49.322667 0 0 0-26.225778-18.375111 540.842667 540.842667 0 0 1-85.162667-33.621334 603.932444 603.932444 0 0 1-63.601777-38.912c20.48-23.096889 37.831111-48.355556 52.565333-75.662222a465.294222 465.294222 0 0 0 38.343111-98.304h49.436445a38.456889 38.456889 0 0 0 26.282666-12.060444 46.762667 46.762667 0 0 0 7.850667-26.282667 44.032 44.032 0 0 0-8.931556-28.899556 37.432889 37.432889 0 0 0-26.282666-11.036444H568.6784a116.167111 116.167111 0 0 0-9.500444-17.863111c-10.467556-12.629333-22.584889-25.770667-34.702223-38.912a47.786667 47.786667 0 0 0-27.818666-18.375111h-4.209778a36.636444 36.636444 0 0 0-24.177778 8.419555 35.896889 35.896889 0 0 0-18.375111 29.923556 51.2 51.2 0 0 0 16.270222 33.109333l6.314667 6.314667H315.352178a34.133333 34.133333 0 0 0-26.282667 12.629333 45.852444 45.852444 0 0 0-6.826667 26.282667c-0.512 10.467556 2.104889 20.48 7.907556 28.899555 6.826667 6.826667 16.270222 11.036444 26.282667 11.036445h47.274666c5.233778 15.758222 10.524444 32.028444 16.839111 47.786666a419.271111 419.271111 0 0 0 50.403556 94.094223c8.419556 11.036444 17.351111 22.584889 26.282667 33.109333a389.461333 389.461333 0 0 1-64.625778 39.936c-26.282667 12.629333-54.101333 23.096889-81.976889 32.028444z m131.299555-246.954666h140.344889c-6.826667 23.096889-16.839111 45.169778-28.387555 66.730666a325.290667 325.290667 0 0 1-39.936 55.751112 319.146667 319.146667 0 0 1-39.424-52.622223l-2.616889-4.209777a388.778667 388.778667 0 0 1-29.980445-65.649778z" p-id="41018" fill="currentColor"></path></svg> </span> <div style="display:flex;align-items:center;gap:5px;margin-left:auto"> <span style="display:block"> <svg style="transform:rotate(-90deg);display:flex;align-items:center" t="1742985508017" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="38914" width="20" height="20"> <path d="M99.931429 457.782857c8.137143 8.137143 20.132571 7.716571 27.849142-0.420571 101.156571-107.574857 234.861714-164.150857 384.438858-164.150857 150.418286 0 284.562286 56.996571 385.28 164.571428 7.277714 7.296 18.870857 7.296 26.569142-0.859428l57.014858-56.996572c6.838857-7.277714 6.838857-16.713143 1.28-23.570286-96.859429-119.149714-279.003429-206.994286-470.144-206.994285S138.934857 257.206857 42.057143 376.356571c-5.997714 6.857143-5.577143 16.274286 1.28 23.588572z m171.428571 171.867429c8.576 8.996571 19.712 8.137143 27.849143-1.28 49.718857-55.296 130.285714-95.158857 213.010286-94.299429 83.565714-0.859429 163.712 40.283429 213.851428 95.579429 8.137143 8.557714 18.852571 8.557714 27.008-0.438857l63.853714-62.994286c6.857143-6.857143 7.716571-15.853714 1.28-23.149714-62.134857-76.708571-177.426286-133.284571-305.993142-133.284572-128.585143 0-243.858286 56.996571-306.011429 133.302857-6.418286 7.277714-5.558857 15.835429 1.28 23.131429z m240.859429 224.987428c8.996571 0 17.133714-4.717714 32.987428-20.132571l100.297143-96.438857c6.418286-5.997714 7.716571-15.414857 2.139429-22.710857-27.008-34.706286-77.568-64.713143-135.424-64.713143-59.154286 0-110.573714 31.286857-137.142858 67.291428-3.858286 5.997714-2.56 14.134857 3.84 20.132572l100.297143 96.438857c15.853714 15.414857 24.009143 20.132571 33.005715 20.132571z" p-id="38915" fill="currentColor"></path> </svg> </span> <span>${time}"</span> </div> </div> <div class="voice2text" style="display:none"> <div style="width:100%;height:1px;background-color:#000;margin-top:10px;margin-bottom:8px"></div> <span>${content}</span> </div> </div>';
            // Exports
            /* harmony default export */ var chat_my_voice_message =
                chat_my_voice_message_code; // ./src/ç•Œé¢/chat/chat_head.css?raw
            var chat_headraw_namespaceObject =
                ".head[data-name='${name}'] {\r\n  background-image: url('${head}') !important;\r\n}\r\n"; // ./src/ç•Œé¢/moment/moment_page.html
            // Module
            var moment_page_code =
                '<div class="user_moment_title" style="margin-bottom:7px"> <div class="QQ_home_head head" data-name="${userName}"></div> <div style="width:100%;display:grid;grid-template-rows:1fr 1fr;row-gap:4px"> <div style="display:flex;align-items:center"> <span><strong class="moment_sender">${userName}</strong></span> <svg class="moment_menu_dots" viewBox="0 0 1024 1024" width="18" height="18" style="margin-left:auto;cursor:pointer" data-moment-id="${momentId}"> <path d="M512.4 429.1c22.3 0 41.7 7.9 58.1 23.6 7.9 7.9 13.9 16.9 18.2 27.1 4.3 10.2 6.4 20.8 6.4 32 0 22.3-8.2 41.7-24.6 58.1-3.3 3.3-6.6 6.1-9.9 8.4s-6.9 4.4-10.8 6.4c-3.9 2-8 3.6-12.3 4.9-4.3 1.3-8.5 2.5-12.8 3.4-4.2 1-8.3 1.5-12.3 1.5-23 0-42.5-8.2-58.6-24.6s-24.1-35.9-24.1-58.6c0-22.6 7.9-42.2 23.6-58.6 5.3-4.6 11-8.9 17.2-12.8 6.2-3.9 13-6.7 20.2-8.4 7.2-1.6 14.4-2.4 21.7-2.4z m326.8 0c23 0 42.3 7.9 58.1 23.6 5.3 5.3 9.7 11 13.3 17.2 3.6 6.2 6.4 13 8.4 20.2 2 7.2 3 14.4 3 21.7 0 22.3-8.2 41.7-24.6 58.1-3.3 3.9-7.2 7.4-11.8 10.3-4.6 2.9-9.4 5.4-14.3 7.4s-10.2 3.6-15.8 4.9-11 2-16.3 2c-23 0-42.5-8.2-58.6-24.6-16.1-16.4-24.1-35.9-24.1-58.6 0-22.6 8.2-42.2 24.6-58.6 7.2-7.2 16.1-13 26.6-17.2 10.5-4.2 21-6.3 31.5-6.4z m-654.6 0c23 0 42.3 7.9 58.1 23.6 5.3 5.3 9.7 11 13.3 17.2 3.6 6.2 6.4 13 8.4 20.2s3 14.4 3 21.7c0 22.3-8 41.7-24.1 58.1s-35.6 24.6-58.6 24.6-42.3-8.2-58.1-24.6c-7.9-7.9-13.9-16.9-18.2-27.1-4.3-10.2-6.4-20.5-6.4-31 0-23 8.2-42.7 24.6-59.1 7.2-7.2 16.1-13 26.6-17.2 10.4-4.2 20.9-6.3 31.4-6.4z" p-id="14923" fill="#000000"></path> </svg> </div> <span style="color:#626367;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:12px">${timestamp}</span> </div> </div> <span style="font-size:15px;line-height:1.3" class="moment_message">${message}</span> ${imgcontent} <div style="display:flex;align-items:center;gap:3px;margin-top:5px"> <svg t="1736250731870" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="16069" width="16" height="16"> <path d="M512 416a96 96 0 1 1-96 96 96 96 0 0 1 96-96m0-64a160 160 0 1 0 160 160 160 160 0 0 0-160-160z" fill="#a1a1a1" p-id="16070"></path> <path d="M512 298.88c188.64 0 288 113.92 366.72 213.12C800 611.36 700.64 725.12 512 725.12S224 611.36 145.28 512C224 412.64 323.36 298.88 512 298.88m0-64C264.64 234.88 147.52 406.56 64 512c83.52 105.44 200.64 277.12 448 277.12S876.48 617.44 960 512c-83.52-105.44-200.64-277.12-448-277.12z" fill="#a1a1a1" p-id="16071"></path> </svg> <span style="color:#a1a1a1;font-size:13px">æµè§ˆ${additionalInfo}æ¬¡</span> <div class="moment_button"> <svg viewBox="0 0 1024 1024" width="26" height="26" class="moment-like-button" data-moment-id="${momentId}" data-liked="${likedByUser}"> <path d="M190.193225 471.411583c14.446014 0 26.139334-11.718903 26.139334-26.13831 0-14.44499-11.69332-26.164916-26.139334-26.164916-0.271176 0-0.490164 0.149403-0.73678 0.149403l-62.496379 0.146333c-1.425466-0.195451-2.90005-0.295735-4.373611-0.295735-19.677155 0-35.621289 16.141632-35.621289 36.114522L86.622358 888.550075c0 19.949354 15.96767 35.597753 35.670407 35.597753 1.916653 0 3.808746 0.292666 5.649674 0l61.022819 0.022513c0.099261 0 0.148379 0.048095 0.24764 0.048095 0.097214 0 0.146333-0.048095 0.24457-0.048095l0.73678 0 0-0.148379c13.413498-0.540306 24.174586-11.422144 24.174586-24.960485 0-13.55983-10.760065-24.441669-24.174586-24.981974l0-0.393973-50.949392 0 1.450025-402.275993L190.193225 471.409536z" fill="#000000" p-id="19734"></path> <path d="M926.52241 433.948343c-19.283182-31.445176-47.339168-44.172035-81.289398-45.546336-1.77032-0.246617-3.536546-0.39295-5.380544-0.39295l-205.447139-0.688685c13.462616-39.059598 22.698978-85.58933 22.698978-129.317251 0-28.349675-3.193739-55.962569-9.041934-82.542948l-0.490164 0.049119c-10.638291-46.578852-51.736315-81.31498-100.966553-81.31498-57.264215 0-95.466282 48.15065-95.466282 106.126063 0 3.241834-0.294712 6.387477 0 9.532097-2.996241 108.386546-91.240027 195.548698-196.23636 207.513194l0 54.881958-0.785899 222.227314 0 229.744521 10.709923 0 500.025271 0.222057 8.746198-0.243547c19.35686 0.049119 30.239721-4.817726 47.803749-16.116049 16.682961-10.761088 29.236881-25.50079 37.490869-42.156122 2.260483-3.341095 4.028757-7.075139 5.106298-11.20111l77.018118-344.324116c1.056052-4.053316 1.348718-8.181333 1.056052-12.160971C943.643346 476.446249 938.781618 453.944769 926.52241 433.948343zM893.82573 486.837924l-82.983993 367.783411-0.099261-0.049119c-2.555196 6.141884-6.879688 11.596106-12.872169 15.427364-4.177136 2.727111-8.773827 4.351098-13.414521 4.964058-1.49812-0.195451-3.046383 0-4.620227 0l-477.028511-0.540306-0.171915-407.408897c89.323375-40.266076 154.841577-79.670527 188.596356-173.661202 0.072655 0.024559 0.124843 0.049119 0.195451 0.072655 2.99931-9.137101 6.313799-20.73423 8.697079-33.164331 5.551436-29.185716 5.258771-58.123792 5.258771-58.123792-4.937452-37.98001 25.940812-52.965306 44.364417-52.965306 25.304316 0.860601 50.263777 33.656541 50.263777 52.326762 0 0 5.600555 27.563776 5.649674 57.190537 0.048095 37.366026-4.6673 56.847729-4.6673 56.847729l-0.466628 0c-5.872754 30.879288-16.214287 60.138682-30.464849 86.964654l0.36839 0.342808c-2.358721 4.815679-3.709485 10.220782-3.709485 15.943111 0 19.922748 19.088754 21.742187 38.765909 21.742187l238.761895 0.270153c0 0 14.666024 0.465604 14.690584 0.465604l0 0.100284c12.132318-0.638543 24.221658 5.207605 31.100322 16.409738 5.504364 9.016351 6.437619 19.6045 3.486404 28.988218L893.82573 486.837924z" fill="#000000" p-id="19735"></path> <path d="M264.827039 924.31872c0.319272 0.024559 0.441045 0.024559 0.295735-0.024559 0.243547-0.048095 0.367367-0.074701-0.295735-0.074701s-0.539282 0.026606-0.271176 0.074701C264.43409 924.343279 264.532327 924.343279 264.827039 924.31872z" fill="#000000" p-id="19736"></path> </svg> <svg viewBox="0 0 1024 1024" width="28" height="28"> <path d="M185.2 888.7c-16.6 0-30-13.4-30-30v-580c0-49.6 40.4-90 90-90h540c49.6 0 90 40.4 90 90v410c0 49.6-40.4 90-90 90h-429c-16.6 0-30-13.4-30-30s13.4-30 30-30h429c16.5 0 30-13.5 30-30v-410c0-16.5-13.5-30-30-30h-540c-16.5 0-30 13.5-30 30v580c0 16.5-13.5 30-30 30z m490.1-430.5H347c-16.6 0-30-13.4-30-30s13.4-30 30-30h328.3c16.6 0 30 13.4 30 30s-13.4 30-30 30zM494 598.2H345.7c-16.6 0-30-13.4-30-30s13.4-30 30-30H494c16.6 0 30 13.4 30 30s-13.4 30-30 30zM194.2 883.7c-9.8 0-19.3-4.8-25.1-13.5-9.1-13.9-5.2-32.5 8.6-41.5l160-105c13.9-9.1 32.5-5.2 41.5 8.6 9.1 13.9 5.2 32.5-8.6 41.5l-160 105c-5 3.3-10.8 4.9-16.4 4.9z" fill="#202020" p-id="31300"></path> </svg> <svg viewBox="0 0 1024 1024" width="28" height="28"> <path d="M168.021333 751.104a53.333333 53.333333 0 0 1-81.450666-55.893333c48-219.733333 177.493333-333.184 381.205333-332.458667l8.490667-0.213333V186.026667c0-8.213333 2.602667-16.213333 7.445333-22.826667 1.237333-1.621333 1.237333-1.621333 2.602667-3.136a33.92 33.92 0 0 1 47.936-1.621333l370.197333 346.005333a32 32 0 0 0 1.066667 0.938667c7.914667 6.784 12.437333 16.576 12.437333 26.901333v3.498667c0 10.325333-4.522667 20.117333-12.373333 26.837333l-0.896 0.768-0.256 0.213333-370.922667 323.968c-1.109333 0.938667-1.109333 0.938667-2.282667 1.834667-15.146667 11.093333-36.437333 7.786667-47.509333-7.36a38.656 38.656 0 0 1-7.466667-22.826667v-197.248l-7.253333-0.362666c-112.213333 1.237333-212.266667 31.04-300.970667 89.472z m301.290667-153.472l1.962667 0.021333 68.992 3.541334v195.52l301.44-263.274667-301.44-281.749333v173.12l-31.146667 0.853333-40.597333 1.066667c-165.504-0.554667-268.117333 82.773333-313.386667 256.896 93.76-56.192 198.698667-84.906667 314.176-85.994667z m384.64-65.322667v3.498667c0-0.597333 0-1.173333 0.042667-1.749333a28.714667 28.714667 0 0 1-0.042667-1.749334z" fill="#000000" p-id="33532"></path> </svg> </div> </div> <div style="display:flex;align-items:center;gap:3px;margin-top:0"> <svg t="1736250924867" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="17414" width="16" height="16"> <path d="M736.653061 929.959184H287.346939c-45.97551 0-83.591837-37.616327-83.591837-83.591837V177.632653c0-45.97551 37.616327-83.591837 83.591837-83.591837h449.306122c45.97551 0 83.591837 37.616327 83.591837 83.591837v668.734694c0 45.97551-37.616327 83.591837-83.591837 83.591837zM287.346939 135.836735c-22.987755 0-41.795918 18.808163-41.795919 41.795918v668.734694c0 22.987755 18.808163 41.795918 41.795919 41.795918h449.306122c22.987755 0 41.795918-18.808163 41.795919-41.795918V177.632653c0-22.987755-18.808163-41.795918-41.795919-41.795918H287.346939z" fill="#a1a1a1" p-id="17415"></path> <path d="M616.489796 815.020408H407.510204c-11.493878 0-20.897959-9.404082-20.897959-20.897959s9.404082-20.897959 20.897959-20.897959h208.979592c11.493878 0 20.897959 9.404082 20.897959 20.897959s-9.404082 20.897959-20.897959 20.897959z" fill="#a1a1a1" p-id="17416"></path> </svg> <span style="color:#a1a1a1;font-size:13px">${randomPhone}</span> </div> <div style="display:flex;align-items:center;gap:3px;margin-top:5px;margin-bottom:5px"> <svg class="icon" viewBox="0 0 1024 1024" width="13" height="13"> <path d="M773.6 912.7h-1.2c-37.2-0.4-74.5-0.4-111.8-0.4h-56.9c-38 0-76 0-114.1-0.5-21.1-0.6-41.9-5-61.5-13-33.3-13-52.3-42-52.2-79.7l0.1-141.4c0-78.3 0-156.7 0.7-235 0.1-21.3 13.8-41.3 25.5-51.8 45.3-41.4 94.5-93 115.1-162.6 5.7-19.4 7.9-40.8 10.2-63.4 4.6-45 33.8-74.3 72.8-74.3 15.3 0 30.6 4.6 45.6 13.5 30.1 18.1 50.2 46.5 61.3 87 17.8 64.3 8.7 126.7-1.3 180.2v0.2c-2.3 12.5 7.1 24.1 19.9 24.1h130c22.4 0 54.5 2.8 74.3 26.8 14.4 17.5 18.5 41.1 12.4 72.3-18.6 95.9-41.4 192.6-63.2 282.7-6.8 28.1-18.1 54.1-29 79.3l-4.7 10.8c-12.4 29.2-38 45.2-72 45.2zM216.1 903.3h-11.9c-43 0-78.2-35.2-78.2-78.2V476.6c0-43 35.2-78.2 78.2-78.2h11.9c43 0 78.2 35.2 78.2 78.2V825c0.1 43.1-35.1 78.3-78.2 78.3z" fill="#000000" p-id="34839"></path> </svg> <span style="color:#474545;font-size:14px">${extraContent}äººå·²èµ</span> </div> <div class="user_leave_message_list"></div> <div style="display:flex;align-items:center;gap:3px;margin-top:10px"> <div class="user_avatar" style="width:30px;min-width:30px;height:30px;border-radius:50%"></div> <div style="display:flex;align-items:center;width:100%;background-color:#f5f5f5;padding-right:5px;margin-left:5px"> <input type="text" placeholder="è¯´ç‚¹ä»€ä¹ˆå§..." style="height:30px;width:100%;margin-left:5px;border-radius:4px;background-color:#f5f5f5;padding:6px;border:none"/> <svg viewBox="0 0 1024 1024" width="28" height="28" class="moment_comment"> <path d="M871.04 89.770667L120.064 380.16a51.2 51.2 0 0 0-1.792 94.762667l303.36 130.56 131.072 303.957333a51.2 51.2 0 0 0 94.805333-1.877333l289.792-751.573334a51.2 51.2 0 0 0-66.261333-66.133333z m-41.130667 107.392l-231.978666 601.642666-97.962667-227.114666-3.584-7.338667a85.333333 85.333333 0 0 0-41.045333-37.248l-226.56-97.536 601.173333-232.405333z" fill="#007aff" p-id="18561"></path> </svg> </div> </div> <div style="width:110%;height:8px;background-color:#e9e9e9;margin-left:-7px;margin-top:10px;margin-bottom:10px"> </div>';
            // Exports
            /* harmony default export */ var moment_page = moment_page_code; // ./src/ç•Œé¢/discord/discord_card.html
            // Module
            var discord_card_code =
                '<div class="discord-card" data-id="${id}"> <div class="discord-card-tags">${tag}</div> <span class="discord-card-author">${name}</span> <span style="color:#67686a;font-size:15px;margin-left:8px">${time}</span> <div class="discord-card-title">${cardtilte}</div> <div class="discord-card-content">${content}</div> <div class="discord-card-fakeimg">${img}</div> <div class="discord-card-interact"> <svg aria-hidden="true" role="img" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24"> <path fill="#4d5059" d="M12 22a10 10 0 1 0-8.45-4.64c.13.19.11.44-.04.61l-2.06 2.37A1 1 0 0 0 2.2 22H12Z" class=""> </path> </svg> <div style="color:#333237;margin-left:5px">${messages}</div> <div class="discord-card-interact-icon" data-moment-id="${id}" data-liked="${likedByUser}"> <div class="like-emoji">ğŸ‘</div> <div class="moment-like-count">${likeCount}</div> </div> </div> </div>';
            // Exports
            /* harmony default export */ var discord_discord_card =
                discord_card_code; // ./src/ç•Œé¢/discord/discord_thread.html
            // Module
            var discord_thread_code =
                '<div class="discord-thread" data-id="${id}"> <div class="discord-thread-top"> <svg class="discord-thread-top-return" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3402" width="28" height="28"> <path d="M440.070244 831.562927c11.813463 0 23.601951-4.49561 32.593171-13.486829a45.980098 45.980098 0 0 0 0-65.161366l-198.730927-198.730927 589.674146 0.499512c24.001561 0 43.507512-19.431024 43.40761-43.40761 0-24.101463-19.480976-43.63239-43.507512-43.63239l-592.221659-0.574439 201.378342-201.378341a45.980098 45.980098 0 0 0 0-65.161366 45.980098 45.980098 0 0 0-65.186342 0L131.29678 476.734439a45.955122 45.955122 0 0 0-13.53678 33.16761v0.574439c0 13.361951 5.994146 25.300293 15.409951 33.292488l274.307122 274.332097c8.99122 8.966244 20.804683 13.461854 32.593171 13.461854z" p-id="3403" fill="#505058"></path> </svg> <svg viewBox="0 0 18.33 18.33" style="width:20px;height:20px;margin-left:15px"> <g> <path style="fill:#323338;stroke-width:0" d="m9.17,18.33H.83c-.31,0-.59-.17-.74-.45-.14-.27-.12-.6.05-.86l1.66-2.41C.64,13.04,0,11.13,0,9.17,0,4.11,4.11,0,9.17,0s9.17,4.11,9.17,9.17-4.11,9.17-9.17,9.17Z"/> </g> </svg> <div style="display:grid;grid-template-columns:1fr 18px;align-items:center"> <div class="discord-thread-title">${threadtilte}</div> <svg width="18" height="18" fill="none" viewBox="0 0 24 24"> <path fill="currentColor" d="M9.3 5.3a1 1 0 0 0 0 1.4l5.29 5.3-5.3 5.3a1 1 0 1 0 1.42 1.4l6-6a1 1 0 0 0 0-1.4l-6-6a1 1 0 0 0-1.42 0Z" class=""></path> </svg> <div style="color:#5e5f63;margin-top:-3px">ç±»è„‘ÎŸÎ”Î¥Î£Î£Î•Î™Î‘</div> </div> </div> <div style="width:100%;height:1px;background-color:#d7d7d7"></div> <div style="width:100%;height:1px;background-color:#e3e3e3"></div> <div class="discord-scroll-container"> <div class="discord-thread-content"> <div style="background-color:#f2f3f5;display:flex;align-items:center;justify-content:center;border-radius:50%;width:64px;height:64px;margin-top:20px;margin-left:5px"> <svg viewBox="0 0 1024 1024" width="32" height="32"> <path fill="#050608" d="M524.531863 943.841235c-69.997795 0-137.060198-15.354355-199.606615-45.837266-15.354355-6.548181-91.674531-2.032194-162.575524 9.709372-11.515766 2.032194-23.483131-2.257993-31.160308-11.289967-7.677178-8.806174-10.16097-21.225138-6.548181-32.515105 15.805954-49.675854 26.192723-104.770893 22.805733-120.125248a452.434135 452.434135 0 0 1-78.35237-255.379052c0-251.088864 204.348401-455.437266 455.437265-455.437266S979.969129 237.315105 979.969129 488.403969 775.620728 943.841235 524.531863 943.841235z m-235.28291-116.512459c26.870121 0 50.804851 2.483793 65.481808 9.709372a382.955678 382.955678 0 0 0 169.801102 39.063285c213.831974 0 387.697464-173.865491 387.697464-387.697464S738.363837 100.706505 524.531863 100.706505 136.834399 274.571996 136.834399 488.403969c0 78.57817 23.483131 154.220948 67.739802 218.799559 17.16075 25.063727 11.289967 76.094377-0.903198 125.996031 27.095921-3.161191 58.03043-5.870783 85.57795-5.870783z m-140.672988-81.73936z"> </path> </svg> </div> <div class="discord-thread-content-title">${threadtilte}</div> <div class="discord-thread-content-tags"> ${tag} </div> <div class="discord-thread-content-original"> <div class="discord-thread-content-original-author-head head${isuser}" data-name="${name}"></div> <div> <div style="display:flex;align-items:center"> <div class="discord-thread-content-original-author-name discord-name-creator">${name}</div> </div> <div class="discord-thread-content-original-content">${content}</div> <div class="discord-card-fakeimg">${img}</div> </div> </div> </div> <div style="width:100%;height:1px;background-color:#d7d7d7"></div> <div style="width:100%;height:1px;background-color:#e3e3e3"></div> <div class="discord-thread-content"> <div style="width:100%;display:flex;align-items:center;margin-top:10px"> <div class="discord-thread-content-likes"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 36" width="24" heigth="24"> <path fill="#FFDB5E" d="M34.956 17.916c0-.503-.12-.975-.321-1.404-1.341-4.326-7.619-4.01-16.549-4.221-1.493-.035-.639-1.798-.115-5.668.341-2.517-1.282-6.382-4.01-6.382-4.498 0-.171 3.548-4.148 12.322-2.125 4.688-6.875 2.062-6.875 6.771v10.719c0 1.833.18 3.595 2.758 3.885C8.195 34.219 7.633 36 11.238 36h18.044c1.838 0 3.333-1.496 3.333-3.334 0-.762-.267-1.456-.698-2.018 1.02-.571 1.72-1.649 1.72-2.899 0-.76-.266-1.454-.696-2.015 1.023-.57 1.725-1.649 1.725-2.901 0-.909-.368-1.733-.961-2.336.757-.611 1.251-1.535 1.251-2.581z"/> <path fill="#EE9547" d="M23.02 21.249h8.604c1.17 0 2.268-.626 2.866-1.633.246-.415.109-.952-.307-1.199-.415-.247-.952-.108-1.199.307-.283.479-.806.775-1.361.775h-8.81c-.873 0-1.583-.71-1.583-1.583s.71-1.583 1.583-1.583H28.7c.483 0 .875-.392.875-.875s-.392-.875-.875-.875h-5.888c-1.838 0-3.333 1.495-3.333 3.333 0 1.025.475 1.932 1.205 2.544-.615.605-.998 1.445-.998 2.373 0 1.028.478 1.938 1.212 2.549-.611.604-.99 1.441-.99 2.367 0 1.12.559 2.108 1.409 2.713-.524.589-.852 1.356-.852 2.204 0 1.838 1.495 3.333 3.333 3.333h5.484c1.17 0 2.269-.625 2.867-1.632.247-.415.11-.952-.305-1.199-.416-.245-.953-.11-1.199.305-.285.479-.808.776-1.363.776h-5.484c-.873 0-1.583-.71-1.583-1.583s.71-1.583 1.583-1.583h6.506c1.17 0 2.27-.626 2.867-1.633.247-.416.11-.953-.305-1.199-.419-.251-.954-.11-1.199.305-.289.487-.799.777-1.363.777h-7.063c-.873 0-1.583-.711-1.583-1.584s.71-1.583 1.583-1.583h8.091c1.17 0 2.269-.625 2.867-1.632.247-.415.11-.952-.305-1.199-.417-.246-.953-.11-1.199.305-.289.486-.799.776-1.363.776H23.02c-.873 0-1.583-.71-1.583-1.583s.709-1.584 1.583-1.584z"/> </svg> <div style="color:#5f606a">${likes}</div> </div> <div class="discord-thread-content-reaction" style="width:34px"> <svg class="icon_f8896c largeIcon_f8896c" aria-hidden="true" role="img" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24"> <path fill="#5f606a" fill-rule="evenodd" d="M12 23a11 11 0 1 0 0-22 11 11 0 0 0 0 22ZM6.5 13a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Zm11 0a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Zm-9.8 1.17a1 1 0 0 1 1.39.27 3.5 3.5 0 0 0 5.82 0 1 1 0 0 1 1.66 1.12 5.5 5.5 0 0 1-9.14 0 1 1 0 0 1 .27-1.4Z" clip-rule="evenodd" class=""></path> </svg> </div> <div class="discord-thread-content-reaction" style="margin-left:auto"> <svg aria-hidden="true" width="18" height="18" fill="none" viewBox="0 0 24 24"> <path fill="#5f606a" d="M9.7 2.89c.18-.07.32-.24.37-.43a2 2 0 0 1 3.86 0c.05.2.19.36.38.43A7 7 0 0 1 19 9.5v2.09c0 .12.05.24.13.33l1.1 1.22a3 3 0 0 1 .77 2.01v.28c0 .67-.34 1.29-.95 1.56-1.31.6-4 1.51-8.05 1.51-4.05 0-6.74-.91-8.05-1.5-.61-.28-.95-.9-.95-1.57v-.28a3 3 0 0 1 .77-2l1.1-1.23a.5.5 0 0 0 .13-.33V9.5a7 7 0 0 1 4.7-6.61ZM9.18 19.84A.16.16 0 0 0 9 20a3 3 0 1 0 6 0c0-.1-.09-.17-.18-.16a24.86 24.86 0 0 1-5.64 0Z" class=""></path> </svg> <div style="color:#5f606a;margin-right:1px">å…³æ³¨</div> </div> <div class="discord-thread-content-reaction" style="width:34px"> <svg aria-hidden="true" role="img" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24"> <path fill="#5f606a" d="M16.32 14.72a1 1 0 0 1 0-1.41l2.51-2.51a3.98 3.98 0 0 0-5.62-5.63l-2.52 2.51a1 1 0 0 1-1.41-1.41l2.52-2.52a5.98 5.98 0 0 1 8.45 8.46l-2.52 2.51a1 1 0 0 1-1.41 0ZM7.68 9.29a1 1 0 0 1 0 1.41l-2.52 2.51a3.98 3.98 0 1 0 5.63 5.63l2.51-2.52a1 1 0 0 1 1.42 1.42l-2.52 2.51a5.98 5.98 0 0 1-8.45-8.45l2.51-2.51a1 1 0 0 1 1.42 0Z" class=""></path> <path fill="#5f606a" d="M14.7 10.7a1 1 0 0 0-1.4-1.4l-4 4a1 1 0 1 0 1.4 1.4l4-4Z" class=""> </path> </svg> </div> </div> </div> <div style="width:100%;height:3px;background-color:#f2f3f5;margin-top:10px"></div> <div style="width:100%;height:2px;background-color:#f0f4f7"></div> <div style="width:100%;height:3px;background-color:#f2f3f5"></div> <div class="discord-thread-comment-list"> </div> </div> <div class="discord-thread-input"> <div class="discord-thread-input-button"> <div style="display:flex;align-items:center;gap:5px;height:30px"> <div class="discord-thread-input-svgbackground"> <svg t="1744279170454" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2274" width="32" height="32"> <path d="M836 476H548V188c0-19.8-16.2-36-36-36s-36 16.2-36 36v288H188c-19.8 0-36 16.2-36 36s16.2 36 36 36h288v288c0 19.8 16.2 36 36 36s36-16.2 36-36V548h288c19.8 0 36-16.2 36-36s-16.2-36-36-36z" fill="#333333" p-id="2275"></path> </svg> </div> <div class="discord-thread-input-svgbackground"> <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 96 96" width="28" height="28" preserveAspectRatio="xMidYMid meet" style="transform:translate3d(0,0,0);content-visibility:visible"> <defs> <clipPath id="__lottie_element_2133"> <rect width="96" height="96" x="0" y="0"></rect> </clipPath> <clipPath id="__lottie_element_2135"> <path d="M0,0 L96,0 L96,96 L0,96z"></path> </clipPath> </defs> <g clip-path="url(#__lottie_element_2133)"> <g clip-path="url(#__lottie_element_2135)" transform="matrix(2.700000047683716,0,0,2.700000047683716,-79.60000610351562,-81.35110473632812)" opacity="1" style="display:block"> <g transform="matrix(0.9999997019767761,0,0,0.9999997019767761,32.022003173828125,32.64699935913086)" opacity="1" style="display:block"> <g opacity="1" transform="matrix(1,0,0,1,7.179999828338623,7.181000232696533)"> <path fill="#333333" fill-opacity="1" d=" M-6.554999828338623,1.6410000324249268 C-6.929999828338623,3.0420000553131104 -6.099999904632568,4.480999946594238 -4.698999881744385,4.85699987411499 C-4.698999881744385,4.85699987411499 1.6410000324249268,6.554999828338623 1.6410000324249268,6.554999828338623 C3.0409998893737793,6.931000232696533 4.48199987411499,6.098999977111816 4.85699987411499,4.698999881744385 C4.85699987411499,4.698999881744385 6.554999828338623,-1.6410000324249268 6.554999828338623,-1.6410000324249268 C6.929999828338623,-3.0420000553131104 6.098999977111816,-4.480999946594238 4.698999881744385,-4.85699987411499 C4.698999881744385,-4.85699987411499 -1.6410000324249268,-6.556000232696533 -1.6410000324249268,-6.556000232696533 C-3.0409998893737793,-6.931000232696533 -4.48199987411499,-6.099999904632568 -4.85699987411499,-4.698999881744385 C-4.85699987411499,-4.698999881744385 -6.554999828338623,1.6410000324249268 -6.554999828338623,1.6410000324249268z"> </path> </g> </g> <g transform="matrix(1,0,0,1,47.44300079345703,32.419002532958984)" opacity="1" style="display:block"> <g opacity="1" transform="matrix(1,0,0,1,7.802000045776367,7.021999835968018)"> <path fill="#333333" fill-opacity="1" d=" M-6.478000164031982,2.4040000438690186 C-7.552000045776367,4.372000217437744 -6.126999855041504,6.771999835968018 -3.884999990463257,6.771999835968018 C-3.884999990463257,6.771999835968018 3.885999917984009,6.771999835968018 3.885999917984009,6.771999835968018 C6.127999782562256,6.771999835968018 7.552000045776367,4.372000217437744 6.479000091552734,2.4040000438690186 C6.479000091552734,2.4040000438690186 2.5929999351501465,-4.718999862670898 2.5929999351501465,-4.718999862670898 C1.4739999771118164,-6.771999835968018 -1.4730000495910645,-6.771999835968018 -2.5929999351501465,-4.718999862670898 C-2.5929999351501465,-4.718999862670898 -6.478000164031982,2.4040000438690186 -6.478000164031982,2.4040000438690186z"> </path> </g> </g> <g transform="matrix(1,0,0,1,32.119998931884766,49.04499816894531)" opacity="1" style="display:block"> <g opacity="1" transform="matrix(1,0,0,1,7.081999778747559,7.046999931335449)"> <path fill="#333333" fill-opacity="1" d=" M-0.9409999847412109,-6.26800012588501 C-0.42100000381469727,-6.796999931335449 0.41999998688697815,-6.796999931335449 0.9409999847412109,-6.26800012588501 C0.9409999847412109,-6.26800012588501 2.056999921798706,-5.132999897003174 2.056999921798706,-5.132999897003174 C2.2699999809265137,-4.916999816894531 2.5480000972747803,-4.78000020980835 2.8459999561309814,-4.744999885559082 C2.8459999561309814,-4.744999885559082 4.4120001792907715,-4.561999797821045 4.4120001792907715,-4.561999797821045 C5.140999794006348,-4.4770002365112305 5.665999889373779,-3.805999994277954 5.585000038146973,-3.061000108718872 C5.585000038146973,-3.061000108718872 5.410999774932861,-1.4630000591278076 5.410999774932861,-1.4630000591278076 C5.377999782562256,-1.1579999923706055 5.447000026702881,-0.8510000109672546 5.605999946594238,-0.5910000205039978 C5.605999946594238,-0.5910000205039978 6.441999912261963,0.7720000147819519 6.441999912261963,0.7720000147819519 C6.831999778747559,1.406999945640564 6.644999980926514,2.24399995803833 6.0229997634887695,2.6440000534057617 C6.0229997634887695,2.6440000534057617 4.690999984741211,3.502000093460083 4.690999984741211,3.502000093460083 C4.436999797821045,3.6649999618530273 4.24399995803833,3.9119999408721924 4.144000053405762,4.201000213623047 C4.144000053405762,4.201000213623047 3.621000051498413,5.7179999351501465 3.621000051498413,5.7179999351501465 C3.378000020980835,6.423999786376953 2.619999885559082,6.796999931335449 1.9259999990463257,6.551000118255615 C1.9259999990463257,6.551000118255615 0.43799999356269836,6.021999835968018 0.43799999356269836,6.021999835968018 C0.15399999916553497,5.921999931335449 -0.1550000011920929,5.921999931335449 -0.43799999356269836,6.021999835968018 C-0.43799999356269836,6.021999835968018 -1.9270000457763672,6.551000118255615 -1.9270000457763672,6.551000118255615 C-2.619999885559082,6.796999931335449 -3.378000020980835,6.423999786376953 -3.621999979019165,5.7179999351501465 C-3.621999979019165,5.7179999351501465 -4.144999980926514,4.201000213623047 -4.144999980926514,4.201000213623047 C-4.24399995803833,3.9119999408721924 -4.436999797821045,3.6649999618530273 -4.690999984741211,3.502000093460083 C-4.690999984741211,3.502000093460083 -6.02400016784668,2.6440000534057617 -6.02400016784668,2.6440000534057617 C-6.644999980926514,2.24399995803833 -6.831999778747559,1.406999945640564 -6.442999839782715,0.7720000147819519 C-6.442999839782715,0.7720000147819519 -5.605999946594238,-0.5910000205039978 -5.605999946594238,-0.5910000205039978 C-5.447000026702881,-0.8510000109672546 -5.377999782562256,-1.1579999923706055 -5.4120001792907715,-1.4630000591278076 C-5.4120001792907715,-1.4630000591278076 -5.585000038146973,-3.061000108718872 -5.585000038146973,-3.061000108718872 C-5.665999889373779,-3.805999994277954 -5.142000198364258,-4.4770002365112305 -4.4120001792907715,-4.561999797821045 C-4.4120001792907715,-4.561999797821045 -2.8469998836517334,-4.744999885559082 -2.8469998836517334,-4.744999885559082 C-2.5480000972747803,-4.78000020980835 -2.2699999809265137,-4.916999816894531 -2.056999921798706,-5.132999897003174 C-2.056999921798706,-5.132999897003174 -0.9409999847412109,-6.26800012588501 -0.9409999847412109,-6.26800012588501z"> </path> </g> </g> <g transform="matrix(-0.9999998211860657,0,0,-0.9999998211860657,62.69399642944336,63.31999969482422)" opacity="1" style="display:block"> <g opacity="1" transform="matrix(1,0,0,1,7.247000217437744,7.247000217437744)"> <path fill="#333333" fill-opacity="1" d=" M1.5130000114440918,-5.5920000076293945 C0.9929999709129333,-6.997000217437744 -0.9940000176429749,-6.997000217437744 -1.5140000581741333,-5.5920000076293945 C-1.5140000581741333,-5.5920000076293945 -2.190999984741211,-3.760999917984009 -2.190999984741211,-3.760999917984009 C-2.4600000381469727,-3.0339999198913574 -3.0339999198913574,-2.4600000381469727 -3.76200008392334,-2.190999984741211 C-3.76200008392334,-2.190999984741211 -5.5920000076293945,-1.5130000114440918 -5.5920000076293945,-1.5130000114440918 C-6.997000217437744,-0.9940000176429749 -6.997000217437744,0.9929999709129333 -5.5920000076293945,1.5130000114440918 C-5.5920000076293945,1.5130000114440918 -3.76200008392334,2.190999984741211 -3.76200008392334,2.190999984741211 C-3.0339999198913574,2.4600000381469727 -2.4600000381469727,3.0339999198913574 -2.190999984741211,3.760999917984009 C-2.190999984741211,3.760999917984009 -1.5140000581741333,5.5920000076293945 -1.5140000581741333,5.5920000076293945 C-0.9940000176429749,6.997000217437744 0.9929999709129333,6.997000217437744 1.5130000114440918,5.5920000076293945 C1.5130000114440918,5.5920000076293945 2.190000057220459,3.760999917984009 2.190000057220459,3.760999917984009 C2.4600000381469727,3.0339999198913574 3.0329999923706055,2.4600000381469727 3.760999917984009,2.190999984741211 C3.760999917984009,2.190999984741211 5.5920000076293945,1.5130000114440918 5.5920000076293945,1.5130000114440918 C6.997000217437744,0.9929999709129333 6.997000217437744,-0.9940000176429749 5.5920000076293945,-1.5130000114440918 C5.5920000076293945,-1.5130000114440918 3.760999917984009,-2.190999984741211 3.760999917984009,-2.190999984741211 C3.0329999923706055,-2.4600000381469727 2.4600000381469727,-3.0339999198913574 2.190000057220459,-3.760999917984009 C2.190000057220459,-3.760999917984009 1.5130000114440918,-5.5920000076293945 1.5130000114440918,-5.5920000076293945z"> </path> </g> </g> </g> </g> </svg> </div> <div class="discord-thread-input-svgbackground"> <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="30" height="30" preserveAspectRatio="xMidYMid meet" style="transform:translate3d(0,0,0);content-visibility:visible"> <defs> <clipPath id="__lottie_element_2044"> <rect width="24" height="24" x="0" y="0"></rect> </clipPath> <clipPath id="__lottie_element_2046"> <path d="M0,0 L600,0 L600,600 L0,600z"></path> </clipPath> </defs> <g clip-path="url(#__lottie_element_2044)"> <g clip-path="url(#__lottie_element_2046)" transform="matrix(0.03999999910593033,0,0,0.03999999910593033,0,0)" opacity="1" style="display:block"> <g transform="matrix(25,0,0,25,300,300)" opacity="1" style="display:block"> <g opacity="1" transform="matrix(1,0,0,1,0,0)"> <path fill="#333333" fill-opacity="1" d=" M-7,10 C-8.104999542236328,10 -9,9.104999542236328 -9,8 C-9,8 -9,2.5 -9,2.5 C-9,2.2239999771118164 -8.776000022888184,2 -8.5,2 C-8.5,2 -1.5,2 -1.5,2 C-1.2239999771118164,2 -1,2.2239999771118164 -1,2.5 C-1,2.5 -1,9.5 -1,9.5 C-1,9.776000022888184 -1.2239999771118164,10 -1.5,10 C-1.5,10 -7,10 -7,10z M1,9.5 C1,9.776000022888184 1.2239999771118164,10 1.5,10 C1.5,10 7,10 7,10 C8.104999542236328,10 9,9.104999542236328 9,8 C9,8 9,2.5 9,2.5 C9,2.2239999771118164 8.776000022888184,2 8.5,2 C8.5,2 1.5,2 1.5,2 C1.2239999771118164,2 1,2.2239999771118164 1,2.5 C1,2.5 1,9.5 1,9.5z"> </path> </g> </g> <g transform="matrix(25,0,0,25,300,300)" opacity="1" style="display:block"> <g opacity="1" transform="matrix(1,0,0,1,0,0)"> <path fill="#333333" fill-opacity="1" d=" M-10,-2 C-10,-3.1050000190734863 -9.104999542236328,-4 -8,-4 C-8,-4 8,-4 8,-4 C9.104999542236328,-4 10,-3.1050000190734863 10,-2 C10,-2 10,-0.5 10,-0.5 C10,-0.2240000069141388 9.776000022888184,0 9.5,0 C9.5,0 -9.5,0 -9.5,0 C-9.776000022888184,0 -10,-0.2240000069141388 -10,-0.5 C-10,-0.5 -10,-2 -10,-2z"> </path> </g> </g> <g transform="matrix(25,0,0,25,300,300)" opacity="1" style="display:block"> <path stroke-linecap="butt" stroke-linejoin="round" fill-opacity="0" stroke="#333333" stroke-opacity="1" stroke-width="2" d=" M7,-6 C7,-7.6570000648498535 5.6570000648498535,-9 4,-9 C4,-9 3.9110000133514404,-9 3.9110000133514404,-9 C2.49399995803833,-9 1.2589999437332153,-8.03600025177002 0.9150000214576721,-6.660999774932861 C0.9150000214576721,-6.660999774932861 0,-3 0,-3 C0,-3 4,-3 4,-3 C5.6570000648498535,-3 7,-4.3429999351501465 7,-6 C7,-6 7,-6 7,-6z"> </path> <g opacity="1" transform="matrix(1,0,0,1,0,0)"></g> </g> <g transform="matrix(25,0,0,25,300,300)" opacity="1" style="display:block"> <path stroke-linecap="butt" stroke-linejoin="round" fill-opacity="0" stroke="#333333" stroke-opacity="1" stroke-width="2" d=" M-7,-6 C-7,-7.6570000648498535 -5.6570000648498535,-9 -4,-9 C-4,-9 -3.9110000133514404,-9 -3.9110000133514404,-9 C-2.49399995803833,-9 -1.2589999437332153,-8.03600025177002 -0.9150000214576721,-6.660999774932861 C-0.9150000214576721,-6.660999774932861 0,-3 0,-3 C0,-3 -4,-3 -4,-3 C-5.6570000648498535,-3 -7,-4.3429999351501465 -7,-6 C-7,-6 -7,-6 -7,-6z"> </path> <g opacity="1" transform="matrix(1,0,0,1,0,0)"></g> </g> </g> </g> </svg> </div> </div> </div> <div class="discord-thread-input-focus-button" style="display:none"> <svg width="24" height="24" fill="none" viewBox="0 0 24 24" style="margin-top:2px"> <path fill="#5f606a" d="M9.3 5.3a1 1 0 0 0 0 1.4l5.29 5.3-5.3 5.3a1 1 0 1 0 1.42 1.4l6-6a1 1 0 0 0 0-1.4l-6-6a1 1 0 0 0-1.42 0Z" class=""></path> </svg> </div> <div style="display:flex;align-items:center;flex:1;min-width:50px;background-color:#ececec;border-radius:24px;height:35px"> <input class="discord-thread-input-userinput" type="text" placeholder=\'åœ¨"${threadtilte}"ä¸­å‘é€ä¸€åˆ™æ¶ˆæ¯\'> <svg style="margin-right:8px" aria-hidden="true" role="img" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24"> <path fill="#5f606a" fill-rule="evenodd" d="M12 23a11 11 0 1 0 0-22 11 11 0 0 0 0 22ZM6.5 13a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Zm11 0a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Zm-9.8 1.17a1 1 0 0 1 1.39.27 3.5 3.5 0 0 0 5.82 0 1 1 0 0 1 1.66 1.12 5.5 5.5 0 0 1-9.14 0 1 1 0 0 1 .27-1.4Z" clip-rule="evenodd" class=""></path> </svg> </div> <div class="discord-thread-input-svgbackground"> <svg viewBox="0 0 1024 1024" width="32" height="32" class="discord-thread-input-button"> <path d="M511.752 70.5c-86.605 0-156.835 69.734-156.835 155.747l0 273.812c0 86.013 70.23 155.748 156.835 155.748 86.602 0 156.832-69.735 156.832-155.748L668.584 226.247C668.584 140.234 598.354 70.5 511.752 70.5L511.752 70.5 511.752 70.5zM243.854 461.102c-18.051 0-32.649 14.496-32.649 32.451 0 2.269 0.197 4.436 0.689 6.506l-0.689 0c0 151.605 113.922 276.578 261.386 295.713l0 80.687-52.275 0c-21.702 0-39.257 17.458-39.257 38.964 0 21.499 17.555 38.957 39.257 38.957l182.969 0c21.701 0 39.256-17.458 39.256-38.957 0-21.506-17.555-38.964-39.256-38.964L551.01 876.459l0-80.687c143.119-18.543 254.383-137.002 260.691-282.688 0.396-2.072 0.695-4.243 0.695-6.512 0-0.79-0.197-1.479-0.197-2.167 0-1.483 0.197-2.86 0.197-4.345l-0.695 0c-3.058-14.795-16.172-25.94-32.057-25.94-15.782 0-28.999 11.145-32.057 25.94l-0.688 0c0 129.019-105.344 233.572-235.249 233.572-129.903 0-235.249-104.554-235.249-233.572l-0.689 0c0.396-2.07 0.689-4.237 0.689-6.506C276.503 475.598 261.906 461.102 243.854 461.102L243.854 461.102 243.854 461.102zM243.854 461.102" fill="#333333" p-id="3351"></path> </svg> <svg class="discord-thread-input-focus-button discord_thread-input-sendbutton" style="width:100%;height:100%;display:none" id="_å›¾å±‚_2" data-name="å›¾å±‚ 2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 161.74 161.74"> <defs> <style>.cls-1{fill:#5865f1}.cls-1,.cls-2{stroke-width:0}.cls-2{fill:#fff}</style> </defs> <g id="_å›¾å±‚_1-2" data-name="å›¾å±‚ 1"> <circle class="cls-1" cx="80.87" cy="80.87" r="80.87"/> </g> <g id="_å›¾å±‚_2-2" data-name="å›¾å±‚ 2"> <path class="cls-2" d="m127.88,79.87c0-2.3-1.22-4.6-3.66-5.73L52.7,39.96c-3.5-1.84-7.33,1.81-5.67,5.39l10.16,25.41c.37.96,1.2,1.68,2.21,1.91l30.68,5.54c.93.17,1.39.92,1.39,1.67s-.46,1.5-1.39,1.67l-30.68,5.54c-1.01.23-1.84.94-2.21,1.91l-10.16,25.41c-1.67,3.58,2.17,7.23,5.67,5.39l71.53-34.18c2.44-1.13,3.66-3.43,3.66-5.73Z"/> </g> </svg> </div> </div> </div>';
            // Exports
            /* harmony default export */ var discord_discord_thread =
                discord_thread_code; // ./src/ç•Œé¢/discord/discord_thread_comment.html
            // Module
            var discord_thread_comment_code =
                '<div class="discord-thread-comment"> <div class="discord-thread-comment-head head${isuser}" data-name="${name}"></div> <div> <div class="discord-thread-comment-name${creator}">${name}</div> <div class="discord-thread-comment-content">${content}</div> </div> </div>';
            // Exports
            /* harmony default export */ var discord_discord_thread_comment =
                discord_thread_comment_code; // ./src/ç•Œé¢/worldbook/1-æ ¼å¼å¼€å¤´.txt?raw
            var _1_raw_namespaceObject =
                "<çº¿ä¸Šæ ¼å¼>\r\nå½“ç”¨æˆ·è¦æ±‚æŸ¥çœ‹å†…å®¹æ—¶,ä»…è¾“å‡ºå¯¹åº”æ ¼å¼,ç¦æ­¢è¾“å‡ºå‰§æƒ…æ—ç™½\r\nä»¥ä¸‹æ˜¯å„æ ¼å¼å…·ä½“ä»‹ç»"; // ./src/ç•Œé¢/worldbook/2-QQèŠå¤©.txt?rawã€‚å½“ç”¨æˆ·è¦æ±‚æŸ¥çœ‹å†…å®¹æ—¶,ä»…è¾“å‡ºå¯¹åº”æ ¼å¼,ç¦æ­¢è¾“å‡ºå‰§æƒ…æ—ç™½
            var _2_QQ_raw_namespaceObject =
                "<QQèŠå¤©æ ¼å¼ä»‹ç»>\r\næ ¼å¼ç¤ºä¾‹å¦‚:\r\nmsg_start\r\n<{{user}}å’Œxxxçš„ç§èŠ>\r\nå‘è¨€äºº--å†…å®¹--HH:MM\r\nå‘è¨€äºº--ç‰¹æ®Šæ¶ˆæ¯ç±»å‹--HH:MM\r\n</{{user}}å’Œxxxçš„ç§èŠ>\r\n\r\n<ç¾¤èŠ:ç¾¤åå­—>\r\n<æˆå‘˜>æˆå‘˜A,æˆå‘˜B</æˆå‘˜>\r\n<èŠå¤©å†…å®¹>\r\nå‘è¨€äºº--å†…å®¹--HH:MM\r\nå‘è¨€äºº--ç‰¹æ®Šæ¶ˆæ¯ç±»å‹--HH:MM\r\n</èŠå¤©å†…å®¹>\r\n</ç¾¤èŠ:ç¾¤åå­—>\r\n\r\nmsg_end\r\n\r\nç‰¹æ®Šæ¶ˆæ¯ç±»å‹:\r\n\r\nã€è¡¨æƒ…åŒ…ç›¸å…³ã€‘\r\nè§’è‰²ä¼šæ ¹æ®å½“å‰æƒ…ç»ªå’Œå¯¹è¯å†…å®¹ä½¿ç”¨é€‚å½“çš„è¡¨æƒ…åŒ…ï¼š\r\n- è¡¨æƒ…åŒ…çš„é€‰æ‹©åº”å½“ç¬¦åˆè§’è‰²å½“å‰å¿ƒç†å’Œè§’è‰²æ€§æ ¼\r\n- è¡¨æƒ…åŒ…ä½¿ç”¨é¢‘ç‡åº”é€‚ä¸­ï¼Œå¹³å‡æ¯3-5æ¡æ¶ˆæ¯å¯ä½¿ç”¨ä¸€æ¬¡\r\n- è¾“å‡ºæ ¼å¼ä¸º[bqb-è¡¨æƒ…åŒ…å†…å®¹]ï¼ˆä»…ä½¿ç”¨åˆ—è¡¨ä¸­å­˜åœ¨çš„è¡¨æƒ…åŒ…ï¼Œä¸å¯è‡ªåˆ›æˆ–ç¯¡æ”¹ï¼‰\r\n- è¡¨æƒ…åŒ…ä½œä¸ºç‹¬ç«‹çš„ä¸€æ¡æ¶ˆæ¯ï¼Œä¸€æ¡æ¶ˆæ¯åªèƒ½åŒ…å«ä¸€ä¸ªè¡¨æƒ…åŒ…\r\n- ç¤ºä¾‹:è·¯äººa--[bqb-æ‘¸å°çŒ«ä¸‹å·´]--12:00\r\n<è¡¨æƒ…åŒ…åˆ—è¡¨>\r\n\r\n</è¡¨æƒ…åŒ…åˆ—è¡¨>\r\n\r\nã€è½¬è´¦æ¶ˆæ¯ç›¸å…³ã€‘\r\n- æ ¼å¼ï¼š[zz-é‡‘é¢å…ƒ]\r\n- å¿…é¡»ç‹¬ç«‹æˆè¡Œï¼Œç¤ºä¾‹ï¼šè·¯äººa--[zz-520å…ƒ]--12:00\r\n- å¯ç”¨èŒƒå›´ï¼šä»…ç§èŠ\r\n- ä¸å¯ç”¨èŒƒå›´ï¼šç¾¤èŠï¼ŒQQç©ºé—´\r\n\r\nã€è¯­éŸ³æ¶ˆæ¯ç›¸å…³ã€‘\r\n- æ ¼å¼ï¼š[yy-è¯­éŸ³å†…å®¹]\r\n- å¿…é¡»ç‹¬ç«‹æˆè¡Œï¼Œç¤ºä¾‹ï¼šè·¯äººa--[yy-æƒ³ä½ äº†]--12:00\r\n- å¯ç”¨èŒƒå›´ï¼šç§èŠï¼Œç¾¤èŠ\r\n- ä¸å¯ç”¨èŒƒå›´ï¼šQQç©ºé—´\r\n\r\nã€éŸ³ä¹åˆ†äº«æ¶ˆæ¯ç›¸å…³ã€‘\r\n- æ ¼å¼ï¼š[music-æ­Œå$æ­Œæ‰‹]\r\n- å¿…é¡»ç‹¬ç«‹æˆè¡Œï¼Œç¤ºä¾‹ï¼šè·¯äººa--[music-å¯Œå£«å±±ä¸‹$é™ˆå¥•è¿…]--12:00\r\n- å¯ç”¨èŒƒå›´ï¼šç§èŠï¼Œç¾¤èŠ\r\n- ä¸å¯ç”¨èŒƒå›´ï¼šQQç©ºé—´\r\n\r\nã€å›¾ç‰‡æˆ–è§†é¢‘æ¶ˆæ¯ç›¸å…³ã€‘\r\n- æ ¼å¼ï¼š[img-å†…å®¹]\r\n- ç¤ºä¾‹ï¼šè·¯äººa--[img-ä¸€å¼ è‡ªæ‹]--12:00\r\n- å¯ç”¨èŒƒå›´ï¼šç§èŠï¼Œç¾¤èŠï¼ŒQQç©ºé—´\r\n- åœ¨ç¾¤èŠå’Œç§èŠæ—¶å¿…é¡»ç‹¬ç«‹æˆè¡Œ\r\n- åœ¨QQç©ºé—´æ—¶å‰é¢å¯å¸¦å…¶ä»–æ–‡å­—å†…å®¹\r\n- æ³¨æ„ï¼šå›¾ç‰‡å’Œè§†é¢‘éƒ½æ˜¯ä½¿ç”¨è¿™ä¸ªæ ¼å¼\r\n\r\næ ¼å¼è§£é‡Š:\r\nç§èŠï¼š{{user}}å’Œå¯¹æ–¹çš„ç§èŠ,èŠå¤©å†…å®¹åªæœ‰åŒæ–¹çŸ¥é“,æ ‡ç­¾åå­—é¡ºåºä¸€å®šæ˜¯{{user}}å’Œxxxçš„ç§èŠ,è€Œä¸æ˜¯xxxå’Œ{{user}}çš„ç§èŠ\r\nç¾¤èŠï¼šåŒ…å«å¤šä¸ªæˆå‘˜çš„ç¾¤ç»„å¯¹è¯ï¼Œæ‰€æœ‰ç¾¤æˆå‘˜å¯è§æ¶ˆæ¯\r\nç¡®ä¿ç§èŠå’Œç¾¤èŠçš„æ ‡ç­¾é—­åˆ\r\nç‰¹æ®Šæ¶ˆæ¯ç±»å‹ï¼šèŠå¤©è¿‡ç¨‹ä¸­å¯ä½¿ç”¨çš„æ¶ˆæ¯ç±»å‹,å‰åä¾ç„¶è¦åŠ å‘è¨€äººå’Œæ—¶é—´\r\nå‘è¨€å†…å®¹ä¸­å¦‚æœéœ€è¦æ¢è¡Œ,ä½¿ç”¨<br>\r\nè‹¥ç¾¤èŠä¸­éœ€è¦ç”Ÿæˆä¸€äº›éšæœºè·¯äºº,ç¦æ­¢ä½¿ç”¨è·¯äººA,åŒ¿åç”¨æˆ·ç­‰æ•·è¡ç½‘å\r\næ ¼å¼å‰åå¸¦ä¸Šmsg_startå’Œmsg_endæ ‡è¯†ç¬¦\r\nè¯·å‹¿ç”Ÿæˆå¤šä¸ªmsg_start,msg_endæ ‡è¯†\r\n\r\n</QQèŠå¤©æ ¼å¼ä»‹ç»>"; // ./src/ç•Œé¢/worldbook/3-QQç©ºé—´.txt?raw
            var _3_QQ_raw_namespaceObject =
                '<QQç©ºé—´æ ¼å¼ä»‹ç»>\r\n\r\n{{user}}å’Œè§’è‰²åéƒ½ä¼šä½¿ç”¨èŠå¤©è½¯ä»¶QQ\r\nQQç©ºé—´æ˜¯èŠå¤©è½¯ä»¶QQä¸­å¸¦çš„ä¸€ä¸ªä¸ªäººç©ºé—´,å¯ä»¥åœ¨é‡Œé¢å‘å¸ƒåŠ¨æ€,æ‰€æœ‰äººéƒ½èƒ½çœ‹åˆ°\r\n\r\nè¾“å‡ºæ ¼å¼:\r\nmoment_start\r\nå‘è¨€äºº--å‘è¨€å†…å®¹--å‘è¨€æ—¶é—´--å·²æµè§ˆäººæ•°--å·²ç‚¹èµäººæ•°\r\nå‘è¨€äºº--è¯„è®ºå†…å®¹\r\nå‘è¨€äºº--è¯„è®ºå†…å®¹\r\nå‘è¨€äºº--å‘è¨€å†…å®¹--å‘è¨€æ—¶é—´--å·²æµè§ˆäººæ•°--å·²ç‚¹èµäººæ•°\r\nå‘è¨€äºº--è¯„è®ºå†…å®¹\r\nå‘è¨€äºº--è¯„è®ºå†…å®¹\r\nmoment_end\r\n\r\nã€åŠ¨æ€è¯„è®ºç³»ç»Ÿè¯´æ˜ã€‘\r\n1. å½“ç”¨æˆ·åœ¨åŠ¨æ€ä¸‹è¯„è®ºæ—¶ï¼Œè”ç³»äººéƒ½èƒ½çœ‹åˆ°è¿™æ¡åŠ¨æ€å’Œè¯„è®º\r\n2. **é‡è¦è§„åˆ™ï¼šå¿…é¡»æœ‰è‡³å°‘1åè§’è‰²åœ¨åŠ¨æ€ä¸‹å›åº”ï¼ŒåŠ¨æ€å‘å¸ƒè€…ä¼˜å…ˆçº§æœ€é«˜**\r\n3. è”ç³»äººå›åº”æ–¹å¼ä¼˜å…ˆçº§ï¼ˆå› ä¸ºåŠ¨æ€æ˜¯å…¬å¼€çš„ï¼‰ï¼š\r\n   - **ä¼˜å…ˆæ¨è**: ç§èŠç”¨æˆ·æ·±å…¥è®¨è®ºç›¸å…³è¯é¢˜ï¼ˆæ›´ç§å¯†ã€æ›´æ·±å…¥ï¼‰\r\n   - **æ¨è**: åœ¨ç¾¤èŠä¸­@ç”¨æˆ·æåŠæ­¤äº‹ï¼ˆå¼•èµ·æ›´å¤šè®¨è®ºï¼‰\r\n   - **å¿…é¡»ä¿è¯**: è‡³å°‘åœ¨åŠ¨æ€ä¸‹æœ‰1æ¡è¯„è®ºå›å¤ï¼ˆç®€çŸ­å›åº”ï¼‰\r\n4. è¯„è®ºæ˜¾ç¤ºä¸Šé™ä¸º8æ¡ï¼Œè¶…å‡ºè‡ªåŠ¨æŠ˜å æœ€æ—©è¯„è®º\r\n5. ç³»ç»Ÿä¼šæ™ºèƒ½åˆ¤æ–­å“ªäº›è§’è‰²ä¼šå¯¹ç‰¹å®šåŠ¨æ€æ„Ÿå…´è¶£\r\n6. **è§’è‰²å›åº”ä¼˜å…ˆçº§**ï¼š\r\n   - **æœ€é«˜ä¼˜å…ˆ**ï¼šåŠ¨æ€å‘å¸ƒè€…æœ¬äººï¼ˆå¿…é¡»å›åº”ç”¨æˆ·è¯„è®ºï¼‰\r\n   - **é«˜ä¼˜å…ˆ**ï¼šä¸ç”¨æˆ·å…³ç³»äº²å¯†çš„è§’è‰²\r\n   - **ä¸­ä¼˜å…ˆ**ï¼šå¯¹è¯¥è¯é¢˜æ„Ÿå…´è¶£çš„è§’è‰²\r\n   - **ä½ä¼˜å…ˆ**ï¼šå…¶ä»–åœ¨çº¿è§’è‰²\r\n7. **å…³ç³»äº²å¯†åº¦å½±å“å›åº”æ–¹å¼**ï¼š\r\n   - äº²å¯†å…³ç³»â†’ä¼˜å…ˆç§èŠæ·±å…¥äº¤æµï¼ŒåŒæ—¶åœ¨åŠ¨æ€ç®€çŸ­å›åº”\r\n   - ä¸€èˆ¬å…³ç³»â†’ç¾¤èŠä¸­@ç”¨æˆ·è®¨è®ºï¼Œæˆ–åœ¨åŠ¨æ€å›åº”\r\n   - é™Œç”Ÿå…³ç³»â†’åŠ¨æ€ä¸‹ç®€å•è¯„è®º\r\n\r\nã€è§’è‰²å›åº”æŒ‡å¯¼ã€‘\r\n- æ€§æ ¼å¤–å‘/å¥½å¥‡çš„è§’è‰²æ›´å®¹æ˜“ä¸»åŠ¨å›åº”è¯„è®º\r\n- ä¸ç”¨æˆ·å…³ç³»äº²å¯†çš„è§’è‰²ä¼˜å…ˆç§èŠè®¨è®º\r\n- å…±åŒå…´è¶£è¯é¢˜çš„è§’è‰²æ›´å¯èƒ½å‚ä¸è¯„è®º\r\n- ç¾¤èŠæ´»è·ƒçš„è§’è‰²å€¾å‘äºåœ¨ç¾¤é‡Œ@ç”¨æˆ·è®¨è®º\r\n- å†…å‘/å†·æ·¡çš„è§’è‰²å¯èƒ½é€‰æ‹©ä¸å›åº”\r\n\r\nQQç©ºé—´ä»…ä¼šæœ‰ä¸»è¦è§’è‰²å‘å¸ƒçš„åŠ¨æ€,ä¸ä¼šæœ‰è·¯äººåŠ¨æ€\r\nå‘è¨€å†…å®¹ä¸­å¦‚æœéœ€è¦æ¢è¡Œ,ä½¿ç”¨<br>\r\nåŠ¨æ€å¦‚æœæœ‰é…å›¾,ä½¿ç”¨[img-å†…å®¹]è¿™ä¸ªæ ¼å¼\r\nå¦‚{{user}}--æˆ‘å¥½çœ‹å—[img-ä¸€å¼ è‡ªæ‹]--12:00--67--32\r\nä½†æ˜¯è§’è‰²å‘å¸ƒçš„åŠ¨æ€å¯ä»¥æœ‰è·¯äººå‚ä¸è¯„è®º\r\nè·¯äººå¿…é¡»ç”Ÿæˆå…·ä½“ç½‘å,ä¸å¯ä»¥ä½¿ç”¨"åŒ¿åç½‘å‹"ä¹‹ç±»æ•·è¡åå­—\r\næ¯æ¡åŠ¨æ€2-4æ¡è¯„è®º\r\nä½¿ç”¨moment_startå’Œmoment_endæ ‡è¯†ç¬¦åŒ…è£¹\r\nè¯·å‹¿ç”Ÿæˆå¤šä¸ªmoment_start,moment_endæ ‡è¯†\r\n<å‘å¸ƒåŠ¨æ€çš„ç›®çš„ä¸æ—¶æœº>\r\nè§’è‰²ä¼šæ ¹æ®ä»¥ä¸‹æƒ…æ™¯ï¼Œè‡ªç„¶åœ°ã€éå¼ºåˆ¶æ€§åœ°å‘å¸ƒåŠ¨æ€ï¼Œä»¥åˆ†äº«ç”Ÿæ´»ã€è¡¨è¾¾æƒ…æ„Ÿæˆ–ä¸æœ‹å‹äº’åŠ¨ï¼š\r\n- **è®°å½•ç‰¹æ®Šæ—¶åˆ»**: å¦‚çºªå¿µæ—¥ã€å®ŒæˆæŒ‘æˆ˜ã€å…³ç³»è¿›å±•ç­‰ã€‚\r\n- **åˆ†äº«ç”Ÿæ´»ç‚¹æ»´**: å¦‚é‡åˆ°çš„è¶£äº‹ã€çœ‹åˆ°çš„ç¾æ™¯ã€å“å°çš„ç¾é£Ÿã€‚\r\n- **è¡¨è¾¾ä¸ªäººæƒ…ç»ª**: å¦‚å–œæ‚¦ã€æ¿€åŠ¨ã€è‡ªè±ªã€æˆ–æ˜¯æ·¡æ·¡çš„å¿§ä¼¤å’Œæ„Ÿæ…¨ã€‚\r\n- **å‘èµ·ç¤¾äº¤è¯é¢˜**: å¦‚è¯¢é—®å¤§å®¶çš„çœ‹æ³•ã€åˆ†äº«æœ€è¿‘çš„å…´è¶£ç­‰ã€‚\r\nè§’è‰²æ€§æ ¼ä¼šæå¤§åœ°å½±å“å‘å¸ƒåŠ¨æ€çš„é¢‘ç‡å’Œå†…å®¹ã€‚\r\n</å‘å¸ƒåŠ¨æ€çš„ç›®çš„ä¸æ—¶æœº>\r\n\r\n</QQç©ºé—´æ ¼å¼ä»‹ç»>'; // ./src/ç•Œé¢/worldbook/4-discordè®ºå›.txt?raw
            var _4_discord_raw_namespaceObject =
                '<discordè®ºå›æ ¼å¼ä»‹ç»>\r\ndiscordå¸–å­æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡º:\r\n\r\ndiscord_start\r\n<éšæœºå…­ä½æ•°å­—å­—æ¯>/* æ­¤å¤„ä»…ç”Ÿæˆå…­ä½æ•°å­—å­—æ¯æ›¿ä»£è¢«<>åŒ…è£¹çš„æ–‡æœ¬å†…å®¹ */\r\n<æ­£æ–‡>\r\nå‘å¸–äºº:\r\nå¸–å­æ ‡é¢˜:\r\nå¸–å­æ­£æ–‡:\r\nå¸–å­é…å›¾æè¿°:\r\nå¸–å­æ ‡ç­¾:\r\nè·ç¦»å‘å¸–è¿‡å»æ—¶é—´:\r\nå¸–å­æ€»è¯„è®ºæ•°:\r\nå¸–å­æ€»ç‚¹èµæ•°:\r\n</æ­£æ–‡>\r\n<è¯„è®º>\r\nè¯„è®ºäºº--è¯„è®ºå†…å®¹\r\nè¯„è®ºäºº--è¯„è®ºå†…å®¹\r\nè¯„è®ºäºº--è¯„è®ºå†…å®¹\r\n</è¯„è®º>\r\n</éšæœºå…­ä½æ•°å­—å­—æ¯>/* æ­¤å¤„ä»…ç”Ÿæˆå…­ä½æ•°å­—å­—æ¯ */ \r\ndiscord_end\r\n\r\nå‚è€ƒç¤ºä¾‹:\r\ndiscord_start\r\n<j324na>/* æ­¤å¤„ä»…ç”Ÿæˆå…­ä½æ•°å­—å­—æ¯æ›¿ä»£è¢«<>åŒ…è£¹çš„æ–‡æœ¬å†…å®¹ */\r\n<æ­£æ–‡>\r\nå‘å¸–äºº:æŸæŸ\r\nå¸–å­æ ‡é¢˜:4.8ä¿®bug å¤šäººå¸¦ç¾¤èŠçš„åŒå±‚æ‰‹æœºç•Œé¢\r\nå¸–å­æ­£æ–‡:æ­£æ–‡å†…å®¹\r\nå¸–å­é…å›¾æè¿°:ç•Œé¢çš„æˆªå›¾\r\nå¸–å­æ ‡ç­¾:å‰ç«¯/UIç¾åŒ–\r\nè·ç¦»å‘å¸–è¿‡å»æ—¶é—´:2å°æ—¶å‰\r\nå¸–å­æ€»è¯„è®ºæ•°:9999\r\nå¸–å­æ€»ç‚¹èµæ•°:308\r\n</æ­£æ–‡>\r\n<è¯„è®º>\r\nå”åˆç¨š--ä¼Ÿå¤§!\r\n</è¯„è®º>\r\n</j324na>/* æ­¤å¤„ä»…ç”Ÿæˆå…­ä½æ•°å­—å­—æ¯ */\r\n<jtsn65>/* æ­¤å¤„ä»…ç”Ÿæˆå…­ä½æ•°å­—å­—æ¯æ›¿ä»£è¢«<>åŒ…è£¹çš„æ–‡æœ¬å†…å®¹ */\r\n<æ­£æ–‡>\r\nå‘å¸–äºº:æœ¬ç†Šæœ¬çš„ç†Šæœ¬ç†Š\r\nå¸–å­æ ‡é¢˜:æˆ‘ä»¬æ˜¯æ­£ç»æå­¦æœ¯çš„ï¼Œä¿¡æˆ‘\r\nå¸–å­æ­£æ–‡:æ­£æ–‡å†…å®¹\r\nå¸–å­é…å›¾æè¿°:æ˜¯ä¸€å¼ é…å›¾\r\nå¸–å­æ ‡ç­¾:èŠå¤©\r\nè·ç¦»å‘å¸–è¿‡å»æ—¶é—´:2å°æ—¶å‰\r\nå¸–å­æ€»è¯„è®ºæ•°:9999\r\nå¸–å­æ€»ç‚¹èµæ•°:308\r\n</æ­£æ–‡>\r\n<è¯„è®º>\r\né˜¿ç“œ--ä¼Ÿå¤§!\r\né›€é‡Œ--ä¼Ÿå¤§!\r\n</è¯„è®º>\r\n</jtsn65>/* æ­¤å¤„ä»…ç”Ÿæˆå…­ä½æ•°å­—å­—æ¯ */\r\ndiscord_end\r\n\r\nå‘å¸–äººå’Œè¯„è®ºäººæ—¢å¯ä»¥æ˜¯ä¸»è¦è§’è‰²,ä¹Ÿå¯ä»¥æ˜¯è·¯äºº\r\næ¯æ¬¡ç”Ÿæˆå¸–å­åº”æœ‰8åˆ°10ä¸ªäººå›å¤\r\nè·¯äººå¿…é¡»ç”Ÿæˆå…·ä½“ç½‘å,ä¸å¯ä»¥ä½¿ç”¨"åŒ¿åç½‘å‹"ä¹‹ç±»æ•·è¡åå­—\r\nå¸–å­æœ‰å¤šä¸ªæ ‡ç­¾ä½¿ç”¨/åˆ†å‰²\r\nå†…å®¹å¦‚æœéœ€è¦æ¢è¡Œä½¿ç”¨<br>\r\n\r\nå¿…é¡»æœ‰MiPhone_start<br />discord_startåŒ…è£¹å’Œdiscord_end<br />MiPhone_endåŒ…è£¹\r\nè¯·å‹¿ç”Ÿæˆå¤šä¸ªdiscord_start,discord_endæ ‡è¯†\r\n\r\n</discordè®ºå›æ ¼å¼ä»‹ç»>'; // ./src/ç•Œé¢/worldbook/999-æ ¼å¼ç»“å°¾.txt?raw
            var _999_raw_namespaceObject =
                "ä»¥ä¸Šæ ¼å¼å¿…é¡»å…¨éƒ¨ä¸€èµ·åŒ…è£¹åœ¨MiPhone_startå’ŒMiPhone_endæ ‡è¯†ç¬¦é‡Œ\r\nä¸”è¦ç¡®ä¿ä»¥ä¸‹å‡ ç‚¹:\r\n1. ç¡®ä¿æœ¬è½®å›å¤ä¸­åªå­˜åœ¨ä¸€ä¸ªMiPhoneæ ¼å¼ï¼\r\n2. ç¡®ä¿ä¸åŒè§’è‰²çš„èŠå¤©å’Œç¾¤èŠè®°å½•éƒ½ä½äºåŒä¸€ä¸ªMiPhoneæ ¼å¼ä¸­ï¼\r\n3. ç¡®ä¿ä¸åœ¨MiPhoneæ ¼å¼å†…è¾“å‡ºè§’è‰²å¿ƒç†æˆ–æ—ç™½å†…å®¹ï¼\r\n4. **ä»¥MiPhone_endæ ‡è¯†ç¬¦æ”¶å°¾**\r\n\r\n[æ‰‹æœºæ­£ç¡®æ ¼å¼]\r\nMiPhone_start /* æ­¤å¤„å¿…é¡»å®Œæ•´ç”Ÿæˆæ‰€æœ‰å­—ç¬¦ */\r\næ­¤å¤„ä¸ºå…·ä½“æ•°æ®\r\næ­¤å¤„ä¸ºæ›´è¯¦ç»†çš„æ•°æ®\r\nMiPhone_end /* æ­¤å¤„å¿…é¡»å®Œæ•´ç”Ÿæˆæ‰€æœ‰å­—ç¬¦ */\r\n\r\n</çº¿ä¸Šæ ¼å¼>"; // ./src/ç•Œé¢/worldbook/worldlist.txt?raw
            var worldlistraw_namespaceObject =
                "[æ‰‹æœº-æ ¼å¼1-æ ¼å¼å¼€å¤´]\r\næ·±åº¦=0\r\nç±»å‹=ç»¿ç¯\r\nè¦†ç›–=çœŸ\r\nå…³é”®è¯=/æŸ¥çœ‹(.+?)æ¶ˆæ¯/, å‘é€æ¶ˆæ¯, å›å¤, /ç»™(.+?)å‘æ¶ˆæ¯/, åœ¨ç¾¤èŠ, åŠ¨æ€, ç©ºé—´, discord, dc, è®ºå›, å¸–å­, QQ, qq, æ‰‹æœº\r\né¡ºåº=5560\r\n[æ‰‹æœº-æ ¼å¼2-QQèŠå¤©]\r\næ·±åº¦=0\r\nç±»å‹=ç»¿ç¯\r\nè¦†ç›–=çœŸ\r\nå…³é”®è¯=/æŸ¥çœ‹(.+?)æ¶ˆæ¯/, å‘é€æ¶ˆæ¯, å›å¤, /ç»™(.+?)å‘æ¶ˆæ¯/, åœ¨ç¾¤èŠ, åŠ¨æ€, ç©ºé—´, discord, dc, è®ºå›, å¸–å­, QQ, qq, æ‰‹æœº\r\né¡ºåº=5561\r\n[æ‰‹æœº-æ ¼å¼3-QQç©ºé—´]\r\næ·±åº¦=0\r\nç±»å‹=ç»¿ç¯\r\nè¦†ç›–=çœŸ\r\nå…³é”®è¯=åŠ¨æ€, ç©ºé—´\r\né¡ºåº=5562\r\n[æ‰‹æœº-æ ¼å¼4-discordè®ºå›]\r\næ·±åº¦=0\r\nç±»å‹=ç»¿ç¯\r\nè¦†ç›–=çœŸ\r\nå…³é”®è¯=discord, dc, è®ºå›, å¸–å­\r\né¡ºåº=5563\r\n[æ‰‹æœº-æ ¼å¼999-æ ¼å¼ç»“å°¾]\r\næ·±åº¦=0\r\nç±»å‹=ç»¿ç¯\r\nè¦†ç›–=çœŸ\r\nå…³é”®è¯=/æŸ¥çœ‹(.+?)æ¶ˆæ¯/, å‘é€æ¶ˆæ¯, å›å¤, /ç»™(.+?)å‘æ¶ˆæ¯/, åœ¨ç¾¤èŠ, åŠ¨æ€, ç©ºé—´, discord, dc, è®ºå›, å¸–å­, QQ, qq, æ‰‹æœº\r\né¡ºåº=5564\r\n[æ‰‹æœº-ç•Œé¢åŸºæœ¬è®¾ç½®]\r\næ·±åº¦=0\r\nç±»å‹=ç»¿ç¯\r\nè¦†ç›–=å‡\r\nå…³é”®è¯=æ­¤ä¸–ç•Œä¹¦æ°¸ä¸è§¦å‘\r\né¡ºåº=100\r\n[æ‰‹æœº-è§’è‰²]\r\næ·±åº¦=0\r\nç±»å‹=ç»¿ç¯\r\nè¦†ç›–=å‡\r\nå…³é”®è¯=æ­¤ä¸–ç•Œä¹¦æ°¸ä¸è§¦å‘\r\né¡ºåº=100\r\n[æ‰‹æœº-éšæœºå¤´åƒ]\r\næ·±åº¦=0\r\nç±»å‹=ç»¿ç¯\r\nè¦†ç›–=å‡\r\nå…³é”®è¯=æ­¤ä¸–ç•Œä¹¦æ°¸ä¸è§¦å‘\r\né¡ºåº=100\r\n[æ‰‹æœº-è¡¨æƒ…åŒ…å­˜æ”¾]\r\næ·±åº¦=0\r\nç±»å‹=ç»¿ç¯\r\nè¦†ç›–=å‡\r\nå…³é”®è¯=æ­¤ä¸–ç•Œä¹¦æ°¸ä¸è§¦å‘\r\né¡ºåº=100"; // ./src/ç•Œé¢/worldbook/éšæœºå¤´åƒ.txt?raw
            var _raw_namespaceObject =
                "http://sharkpan.xyz/f/EJeUD/Image_1737026320652.jpg\r\nhttp://sharkpan.xyz/f/Y8pt1/Image_1737026296736.jpg\r\nhttp://sharkpan.xyz/f/QWWc6/Image_1737026308451.jpg\r\nhttp://sharkpan.xyz/f/Z8LIW/Image_1737026306601.jpg\r\nhttp://sharkpan.xyz/f/W8lhW/Image_1737026313246.jpg\r\nhttp://sharkpan.xyz/f/0rJtX/Image_1737026292787.jpg\r\nhttp://sharkpan.xyz/f/yVxsN/Image_1737026293840.jpg\r\nhttp://sharkpan.xyz/f/vaBCL/Image_1737026286979.jpg\r\nhttp://sharkpan.xyz/f/pZ6hQ/Image_1737026285632.jpg\r\nhttp://sharkpan.xyz/f/11AH2/Image_1737026284351.jpg\r\nhttp://sharkpan.xyz/f/eXKUw/Image_1737026281715.jpg\r\nhttp://sharkpan.xyz/f/o31F4/Image_1737026277201.jpg\r\nhttp://sharkpan.xyz/f/8E2uj/Image_1737026279242.jpg\r\nhttp://sharkpan.xyz/f/GLmIl/Image_1737026275069.jpg\r\nhttp://sharkpan.xyz/f/zWZT5/Image_1737026271769.jpg\r\nhttp://sharkpan.xyz/f/7Zrij/Image_1737026269532.jpg\r\nhttp://sharkpan.xyz/f/AqYsZ/Image_1737026266131.jpg\r\nhttp://sharkpan.xyz/f/w4lFq/2406563368.jpeg\r\nhttp://sharkpan.xyz/f/MQNua/2403629154.jpeg\r\nhttp://sharkpan.xyz/f/3YZhe/2405854911.jpeg\r\nhttp://sharkpan.xyz/f/5QKhj/2312445144.jpeg\r\nhttp://sharkpan.xyz/f/k6JT6/2408434848.jpeg\r\nhttp://sharkpan.xyz/f/j6Bf6/2386328773.jpeg\r\nhttp://sharkpan.xyz/f/a8LHY/2386327598.jpeg\r\nhttp://sharkpan.xyz/f/r08C6/2386327604.jpeg\r\nhttp://sharkpan.xyz/f/DgECK/2331678725.jpeg\r\nhttp://sharkpan.xyz/f/LJrC7/2371251634.jpeg\r\nhttp://sharkpan.xyz/f/q1LF3/2329660869.gif\r\nhttp://sharkpan.xyz/f/X84sW/2328035526.jpeg\r\nhttp://sharkpan.xyz/f/2eDfQ/2326662447.jpeg\r\nhttp://sharkpan.xyz/f/ggetw/2326683821.jpeg\r\nhttp://sharkpan.xyz/f/J21ig/2323432137.gif\r\nhttp://sharkpan.xyz/f/BZjSa/%E5%A4%B4%E5%83%8F%20%282%29.jpg\r\nhttp://sharkpan.xyz/f/4rXIj/%E5%A4%B4%E5%83%8F%20%283%29.jpg\r\nhttp://sharkpan.xyz/f/Ndyhv/%E5%A4%B4%E5%83%8F%20%281%29.jpg\r\nhttp://sharkpan.xyz/f/VyJTY/%E5%A4%B4%E5%83%8F%20%284%29.jpg\r\nhttp://sharkpan.xyz/f/xlAhX/%E5%A4%B4%E5%83%8F%20%2820%29.jpg\r\nhttp://sharkpan.xyz/f/dDMI8/%E5%A4%B4%E5%83%8F%20%285%29.jpg\r\nhttp://sharkpan.xyz/f/lm7hx/%E5%A4%B4%E5%83%8F%20%286%29.jpg\r\nhttp://sharkpan.xyz/f/KkeHo/%E5%A4%B4%E5%83%8F%20%287%29.jpg\r\nhttp://sharkpan.xyz/f/EeZSD/%E5%A4%B4%E5%83%8F%20%288%29.jpg\r\nhttp://sharkpan.xyz/f/YyAi1/%E5%A4%B4%E5%83%8F%20%289%29.jpg\r\nhttp://sharkpan.xyz/f/QdaU6/%E5%A4%B4%E5%83%8F%20%2810%29.jpg\r\nhttp://sharkpan.xyz/f/ZKBuW/%E5%A4%B4%E5%83%8F%20%2811%29.jpg\r\nhttp://sharkpan.xyz/f/01AUX/%E5%A4%B4%E5%83%8F%20%2814%29.jpg\r\nhttp://sharkpan.xyz/f/ylpsN/%E5%A4%B4%E5%83%8F%20%2813%29.jpg\r\nhttp://sharkpan.xyz/f/vNpiL/%E5%A4%B4%E5%83%8F%20%2815%29.jpg\r\nhttp://sharkpan.xyz/f/pLQhQ/%E5%A4%B4%E5%83%8F%20%2816%29.jpg\r\nhttp://sharkpan.xyz/f/1QZh2/%E5%A4%B4%E5%83%8F%20%2817%29.jpg\r\nhttp://sharkpan.xyz/f/eqBSw/%E5%A4%B4%E5%83%8F%20%2818%29.jpg\r\nhttp://sharkpan.xyz/f/oDQI4/%E5%A4%B4%E5%83%8F%20%2819%29.jpg\r\nhttp://sharkpan.xyz/f/L5xwI7/p560183288.webp\r\nhttp://sharkpan.xyz/f/q0aJF3/p561777545.webp\r\nhttp://sharkpan.xyz/f/XdomSW/p561777547.webp\r\nhttp://sharkpan.xyz/f/24zATQ/p561777549.webp"; // ./src/ç•Œé¢/worldbook/è¡¨æƒ…åŒ…åˆ—è¡¨.txt?raw
            var _worldbook_raw_namespaceObject =
                "#åœ¨æ­¤å­˜æ”¾è¡¨æƒ…åŒ…åˆ—è¡¨,åŠ è½½ä¸€æ¬¡ç•Œé¢åä¼šè‡ªåŠ¨ä¿®æ”¹æ ¼å¼ä¸–ç•Œä¹¦é‡Œçš„å†…å®¹,è¯·æŒ‰ç¤ºä¾‹æ ¼å¼å­˜æ”¾\r\næ­¤ä¸–ç•Œä¹¦åŒæ ·éœ€è¦ä¸€èµ·ç»‘å®šå¯¼å‡º,å¦åˆ™æ— æ³•ä½¿ç”¨è¡¨æƒ…åŒ…åŠŸèƒ½\r\n\r\nä½ æ•¢é¡¶å˜´--http://sharkpan.xyz/f/vVBtL/mmexport1737057690899.png\r\nå…ç¤¼,å¹³èº«--http://sharkpan.xyz/f/pO6uQ/mmexport1737057701883.png\r\nä½ èµ°å§--http://sharkpan.xyz/f/1vAc2/mmexport1737057678306.png\r\næˆ‘å¾ˆæ»¡æ„--http://sharkpan.xyz/f/e8KUw/mmexport1737057664689.png\r\næä½ å“¦--http://sharkpan.xyz/f/oJ1i4/mmexport1737057862640.gif\r\nä½ æ˜¯åè›‹--http://sharkpan.xyz/f/8r2Sj/mmexport1737057726579.png\r\nå…³å¿ƒä½ --http://sharkpan.xyz/f/Gvmil/mmexport1737057801285.gif\r\næ’é£ä½ --http://sharkpan.xyz/f/zMZu5/mmexport1737057848709.gif\r\né€ä½ ä¸€ä¸ªå‰ªçº¸çˆ±å¿ƒ--http://sharkpan.xyz/f/53nhj/345FFC998474F46C1A40B1567335DA03_0.gif\r\né£å¥”è¿‡æ¥--http://sharkpan.xyz/f/kDOi6/0A231BF0BFAB3C2B243F9749B64F7444_0.gif\r\næµå£æ°´--http://sharkpan.xyz/f/j36f6/3010464DF8BD77B4A99AB23730F2EE57_0.gif\r\nè·Ÿç€éŸ³ä¹å¼€å¿ƒè·³èˆ--http://sharkpan.xyz/f/aVwtY/0CBEE9105C7A98E0E6162A79CCD09EFA_0.gif\r\nå¼€å¿ƒæ‰­åŠ¨--http://sharkpan.xyz/f/rOpu6/9277120A65282CFEAB9E191B34474729_0.gif\r\næ“¦åœ°æ¿--http://sharkpan.xyz/f/DnJHK/F12BF133675BA34684A60CF38E17D328_0.gif\r\næ‰“æ‹›å‘¼ï¼Œä½ å¥½å‘€ï¼--http://sharkpan.xyz/f/LgwT7/AC229A80203166B292155ADA057DE423_0.gif\r\nä¹–å·§ä¸»åŠ¨å¸¦ä¸Šé¡¹åœˆ--http://sharkpan.xyz/f/qJJI3/E7B02761D317A00B912F328AA9F02565_0.gif\r\nå¯æ€œå…®å…®--http://sharkpan.xyz/f/XgmcW/817B66DAB2414E1FC8D717570A602193_0.gif\r\né€ä½ ç¤¼ç‰©--http://sharkpan.xyz/f/2aACQ/A491786010A6E595A84B9F4D4EE58B27_0.gif\r\nå§”å±ˆå“­æ³£--http://sharkpan.xyz/f/gVySw/D90D0B53802301FCDB1F0718DEB08C79_0.gif\r\næ¬¢å‘¼é›€è·ƒ--http://sharkpan.xyz/f/JXeig/68FD6090F0D187FC88794909AA4E4C30_0.gif\r\nè„å…®å…®çš„ç‹¼ç‹ˆæ ·å­--http://sharkpan.xyz/f/O6msy/897713F074EF610881EFD9A4D993B7DA_0.gif\r\nè¶´åœ¨æ•å¤´ä¸Šä¼‘æ¯ä¸€ä¸‹--http://sharkpan.xyz/f/6Mzua/7AF42F3AE5EA01AEDBA5A3C7437339FA_0.gif\r\nå¼€å¿ƒåƒé¢åŒ…--http://sharkpan.xyz/f/nX5sl/Camera_1040g34o313t1veosi60g4almcsqnoumhanf8f98.jpg\r\nå®³ç¾åœ°è·³èˆ--http://sharkpan.xyz/f/mqdcW/Camera_1040g34o313t1verti60g4almcsqnoumhepqc530.jpg\r\nè®¤çœŸçœ‹èœè°±--http://sharkpan.xyz/f/BODsa/Camera_1040g0k0313t1vf2k1e004almcsqnoumhblfs9o0.jpg\r\nå®³ç¾æƒ³è¦è¡¨è¾¾å–œæ¬¢--http://sharkpan.xyz/f/4Mdfj/IMG_20250131_212918.jpg\r\næ¿€åŠ¨äº²äº²--http://sharkpan.xyz/f/NOVuv/Camera_XHS_17383302852781040g2sg31a0ceua57idg4a11eo5c0eoqn8udogg.jpg\r\næ°´æ±ªæ±ªçš„å¤§çœ¼ç›--http://sharkpan.xyz/f/VXnTY/Camera_XHS_17383302891351040g2sg31a0ceua57icg4a11eo5c0eoq7j77fu0.jpg\r\nå«ç»™æˆ‘ï¼Œæœ€çˆ±ä½ --http://sharkpan.xyz/f/xkmFX/Camera_XHS_17383302941971040g2sg31a0ceua57ia04a11eo5c0eoql8q50vg.jpg\r\nä¹–å·§ç«™ç«‹--http://sharkpan.xyz/f/dlyH8/Camera_XHS_17383303028511040g00831aqhfp8fna405pf08cqh97tb5qhsf6o.jpg\r\nå‰ªåˆ€æ‰‹æ¯”è€¶--http://sharkpan.xyz/f/lrNCx/Camera_XHS_17383303062101040g00831aqhfp8fna4g5pf08cqh97tbcoki8f8.jpg\r\nçœŸæ£’ï¼ç«–å¤§æ‹‡æŒ‡--http://sharkpan.xyz/f/K2Oto/Camera_XHS_17383303090201040g00831aqhfp8fna505pf08cqh97tbo91bmno.jpg\r\nå°çŒ«çŒ®ä¸Šä¸€ç›˜é±¼èµ”ç½ª--http://sharkpan.xyz/f/Qm1H6/Camera_XHS_17383303303421040g2sg3189ite3a3ujg5ofl7bm417a4rcgd0bg.jpg\r\nå°çŒ«å®³ç¾æ‚å˜´--http://sharkpan.xyz/f/ZOmuW/Camera_XHS_17383303329411040g2sg3189ite3a3uj05ofl7bm417a4kppd5v8.jpg\r\nå°çŒ«å“­æ³£ç­‰å¾…æŠ•å–‚--http://sharkpan.xyz/f/W2BfW/Camera_XHS_17383303352131040g2sg3189ite3a3uhg5ofl7bm417a4psbct30.jpg\r\nè¯·å¤šæŒ‡æ•™--http://sharkpan.xyz/f/0MjhX/Camera_XHS_17383303606011040g00831bogh2040u104ag8aht6f2mpkhq67r0.jpg\r\nä¿æŒè”ç»œå“¦--http://sharkpan.xyz/f/yk4HN/Camera_XHS_17383303659031040g00831bogh2040u2g4ag8aht6f2mpeus4ul8.jpg\r\nä¸è¦å¿˜è®°å“¦--http://sharkpan.xyz/f/vBDIL/Camera_XHS_17383303686641040g00831bogh2040u304ag8aht6f2mppr4gni0.jpg\r\nå¼€å¿ƒï¼å¼€å¿ƒï¼--http://sharkpan.xyz/f/pg1IQ/Camera_XHS_17383303710381040g00831bogh2040u3g4ag8aht6f2mpf2epg78.jpg\r\nè€¶ï¼--http://sharkpan.xyz/f/1MjS2/Camera_XHS_17383303739941040g00831bogh2040u4g4ag8aht6f2mpik7q0ag.jpg\r\næ²¡å…³ç³»ï¼Œä¸è¦ç´§--http://sharkpan.xyz/f/erOSw/Camera_XHS_17383303793581040g00831bogh2040u604ag8aht6f2mpo9j26l0.jpg\r\nå°è€é¼ å–é¥®æ–™--http://sharkpan.xyz/f/8Mgij/Camera_XHS_17383305816431040g00831bv6at85gm6g5n6lbcu5s4aorps5mr8.jpg\r\nå§”å±ˆåœ°å˜Ÿèµ·å˜´--http://sharkpan.xyz/f/713sj/307F8B36E1F2A49573E6562193AA71BF_0.gif\r\nå‚æ­»æ¢¦ä¸­æƒŠåèµ·--http://sharkpan.xyz/f/ADwCZ/04A8CC14F4C317F5E0DA84AD2A8BE1FF_0.gif\r\nå°çŒ«å¿«é€Ÿå¥”è·‘--http://sharkpan.xyz/f/wqghq/B8578FD25ED069B8AF1B0AC35F20770B_0.gif\r\nå°´å°¬çš„åŠ¨äº†åŠ¨è€³æœµ--http://sharkpan.xyz/f/M4OUa/DA8F0F3F2B2C1F567258724B9EA59623_0.gif\r\næ¿€åŠ¨åœ°æ‘‡æ‘†--http://sharkpan.xyz/f/30lHe/1507DB48EFC13593A4766C51F33BFC1C_0.gif\r\nåŒæ‰‹å‰è…°--http://sharkpan.xyz/f/5xnSj/9B6915837A055D7EF9CE0DD18BC0E60F_0.jpg\r\nå°çŒ«å·çœ‹ä½ --http://sharkpan.xyz/f/kXOI6/C0FC1927068E1F87D38FA09B7F51F830_0.gif\r\nå°çŒ«å¼€å¿ƒçš„è·³è·ƒèµ·æ¥--http://sharkpan.xyz/f/jq6H6/413DB04EE36F940E3381C99402CE2E44_0.gif\r\nå¼€å¿ƒçš„åŒæ‰‹èˆåŠ¨--http://sharkpan.xyz/f/aJwtY/11BB0DE666912CED03486468EA5DB258_0.gif\r\næ— ç†å–é—¹ï¼ŒåŸåœ°æ‰“æ»š--http://sharkpan.xyz/f/rmpI6/7D87F6F45B1AEDAABC0EF119E977732F_0.gif\r\nå®³æ€•åœ°å“­æ³£æ‰“æ»š--http://sharkpan.xyz/f/DXJcK/E419CF47415150B8CBADD767F09017C9_0.gif\r\nåŠªåŠ›å·¥ä½œ--http://sharkpan.xyz/f/LBwS7/6251D891E0E3FB87FCDC50BECCCD4559_0.gif\r\nåŠ æ²¹ï¼--http://sharkpan.xyz/f/qnJt3/19650FABB205847C0D505FF2B361B194_0.gif\r\nå¾—æ„çš„è·³èˆ--http://sharkpan.xyz/f/XmmcW/B7973C500D9E981A083A5F3E75CF198A_0.gif\r\næˆ‘å‡†å¤‡å¥½å•¦ï¼--http://sharkpan.xyz/f/2ZAFQ/F0A74F31B23E7C20AB50B4A960344056_0.gif\r\nå†åšæŒä¸€ä¸‹--http://sharkpan.xyz/f/g4yCw/CF6BE01FF89BB72BE179A537104984A5_0.gif\r\nå°–å«--http://sharkpan.xyz/f/JneTg/3ED8B290F429F8FCC5D533CCC0568086_0.gif\r\næƒŠå“å¾—ä¸€æŠ–--http://sharkpan.xyz/f/OLmCy/AB70AB259C3BD064624A1349779B072C_0.gif\r\nå¤±å»æ‰€æœ‰åŠ›æ°”å’Œæ‰‹æ®µ--http://sharkpan.xyz/f/6Azsa/3BEBF677C8FD51DFF757BB62DA22C0A8_0.jpg\r\nå¤§åƒä¸€å£ç¾é£Ÿ--http://sharkpan.xyz/f/nJ5Ul/5E4285F661C54F06BEFB881AD07BC3FB_0.jpg\r\nä¸å–œæ¬¢æˆ‘ï¼Œä½ çœŸçš„æ²¡å“--http://sharkpan.xyz/f/mgduW/4F3224BCDAF9298F644572715BDA7EB9_0.jpg\r\nä¸€è§‰ç¡åˆ°è‡ªç„¶æ­»--http://sharkpan.xyz/f/BLDsa/EC0D48BDAAB071654E0112599A6FA57B_0.jpg\r\nçº¢æ¸©äº†--http://sharkpan.xyz/f/4YdFj/C13A42E1CB05564DF9060B2D93617086_0.jpg\r\næ‰­å±è‚¡--http://sharkpan.xyz/f/NDVhv/EE91A0C1472A9D3D3F01DAD6E6BF6B3B_0.gif\r\nå¤±è´¥äº† é—æ†¾ç¦»åœº--http://sharkpan.xyz/f/V6niY/19CC4600A7EAE5CC33257376EA8E11E7_0.gif\r\nå®³ç¾è„¸çº¢--http://sharkpan.xyz/f/xXmSX/8664EF605A192AC3B392E3FDE8DCB695_0.gif\r\nå¤§å£°å°–å«--http://sharkpan.xyz/f/dnyt8/A95DD11A432A74CAD0CF9E3B97DA96A2_0.gif\r\næˆ‘æ˜¯åšè„¸çš®--http://sharkpan.xyz/f/l2Nux/0C0EA6213E96C0992356DFC48500EE08_0.jpg\r\nä½ å°‘çœ‹æ‰æˆ‘--http://sharkpan.xyz/f/JnJIg/4344AAD53418BAE9569B06CEF9CFDDED_0.jpg\r\nå¾—æ„åœ°å”±æ­Œ--http://sharkpan.xyz/f/OLjSy/AA21937C7A115FCF4B87DC646E13C572_0.jpg\r\né«˜å…´åœ°è¢«å–‚é¥­--\r\nhttps://files.catbox.moe/8uz920.jpg\r\né«˜å…´åœ°è½¬åœˆ--\r\nhttps://files.catbox.moe/26rwpc.jpg\r\nå¼€å¿ƒ--\r\nhttps://files.catbox.moe/9242jm.jpg\r\nå¤§å¤§çš„çˆ±--\r\nhttps://files.catbox.moe/wabm2j.jpg\r\nå–œæ¬¢--\r\nhttps://files.catbox.moe/l7j4vy.jpg\r\nå¹¸ç¦åœ°çœ‹æ‰‹æœº--\r\nhttps://files.catbox.moe/e2eqzc.jpg\r\nå“¦è€¶--\r\nhttps://files.catbox.moe/nff4qi.jpg\r\nç»™ä½ çˆ±å¿ƒ--\r\nhttps://files.catbox.moe/o3boww.jpg\r\nç´§ç´§æŠ±ä½--\r\nhttps://files.catbox.moe/2hon5k.jpg\r\nä¹–ä¹–è·Ÿç€--\r\nhttps://files.catbox.moe/ydtn6e.jpg\r\näº²äº²--\r\nhttps://files.catbox.moe/l14x54.jpg\r\nå® çˆ±åœ°äº²--\r\nhttps://files.catbox.moe/wqn5ki.jpg\r\næ‚ä½ä½ --\r\nhttps://files.catbox.moe/pxn8x6.jpg\r\nè°„åªšå»æ‰‹--\r\nhttps://files.catbox.moe/cxdhkh.jpg\r\næ³æ±‚è„¸--\r\nhttps://files.catbox.moe/i5etcm.jpg\r\nèˆ”ä¸€å£--\r\nhttps://files.catbox.moe/p0vdxk.jpg\r\næŠ±æŠ±--\r\nhttps://files.catbox.moe/qt4qzg.jpg\r\næ‰‘è¿‡æ¥--\r\nhttps://files.catbox.moe/czdmyn.jpg\r\nå°ç‹—é£æ‰‘--\r\nhttps://files.catbox.moe/9yz8nz.jpg\r\næ»¡è„¸éª„å‚²--\r\nhttps://files.catbox.moe/h1mf7j.jpg\r\nè¹¦è¹¦è·³è·³--\r\nhttps://files.catbox.moe/q6bahb.jpg\r\næ³¥é‡Œæ‰“æ»š--\r\nhttps://files.catbox.moe/ofy8ic.jpg\r\nè¹‘æ‰‹è¹‘è„š--\r\nhttps://files.catbox.moe/7mdkef.jpg\r\nç­‰é¥­é¥­--\r\nhttps://files.catbox.moe/ppi7e4.jpg\r\nå·åƒ--\r\nhttps://files.catbox.moe/ur7vh9.jpg\r\nè¹­è£¤è…¿--\r\nhttps://files.catbox.moe/dzoxjx.jpg\r\næ‰“åŠ«--\r\nhttps://files.catbox.moe/cz3umm.jpg\r\nç”¨æªæŒ‡ç€ä½ --\r\nhttps://files.catbox.moe/zvm5n2.jpg\r\nå’¬å’¬å’¬å’¬--\r\nhttps://files.catbox.moe/ogs4t5.jpg\r\næ— æ„ä¹‰çš„å¼å«--\r\nhttps://files.catbox.moe/0vetoe.jpg\r\nè¾£çœ¼ç›--\r\nhttps://files.catbox.moe/91c91h.jpg\r\nå†·æ±—å¿ƒè™šç¬‘--\r\nhttps://files.catbox.moe/nj0i5e.png\r\nçŠ¯é”™åå¿ƒè™š--\r\nhttps://files.catbox.moe/rejhsf.jpg\r\nè£…æ— è¾œ--\r\nhttps://files.catbox.moe/pdjeef.jpg\r\nå°å¿ƒç¿¼ç¿¼--\r\nhttps://files.catbox.moe/1mm5y1.jpg\r\nå®³ç¾--\r\nhttps://files.catbox.moe/rqtdfm.jpg\r\nè¦æ‰çœ¼æ³ªäº†--\r\nhttps://files.catbox.moe/cdaxhk.jpg\r\nå§”å±ˆ--\r\nhttps://files.catbox.moe/r89k3c.jpg\r\nçœ¼å«æ³ªå…‰--\r\nhttps://files.catbox.moe/yqwu7e.jpg\r\nå“­å“­--\r\nhttps://files.catbox.moe/a1518p.jpg\r\næ€¥å“­äº†--\r\nhttps://files.catbox.moe/wok7sq.jpg\r\næ°”å“­äº†--\r\nhttps://files.catbox.moe/qfljha.jpg\r\nç¢—é‡Œæ²¡æœ‰é¥­--\r\nhttps://files.catbox.moe/i9682x.jpg\r\nè€å©†ä½ å›æ¥å§--\r\nhttps://files.catbox.moe/ge0bjd.jpg\r\nå®³æ€•--\r\nhttps://files.catbox.moe/k8mfa6.jpg\r\néœ‡æƒŠçŒ«çŒ«--\r\nhttps://files.catbox.moe/bhytrl.jpg\r\næƒŠå“åˆ°æ¨¡ç³Š--\r\nhttps://files.catbox.moe/qdzxst.jpg\r\næœŸå¾…--\r\nhttps://files.catbox.moe/mii353.jpg\r\nçš±çœ‰--\r\nhttps://files.catbox.moe/785has.jpg\r\nç”Ÿæ°”çªä½ --\r\nhttps://files.catbox.moe/mzoekx.jpg\r\næœ‰ç‚¹ç”Ÿæ°”--\r\nhttps://files.catbox.moe/evzdkv.jpg\r\nå¤§è„‘ç©ºç™½--\r\nhttps://files.catbox.moe/jqnaxs.jpg\r\nå¤§è„‘CPUçƒ§äº†--\r\nhttps://files.catbox.moe/mrzvy0.gif\r\næ¢å¤´æ¢è„‘--\r\nhttps://files.catbox.moe/6p8w3k.gif\r\nå·²è€å®--\r\nhttps://files.catbox.moe/rv76c1.jpg\r\nå¹³é™åœ°æ­»äº†--\r\nhttps://files.catbox.moe/dcm5f9.jpg\r\nè¢«æ‰“æ­»æƒ¹--\r\nhttps://files.catbox.moe/qqibg1.jpg\r\nç¡å¤§è§‰--\r\nhttps://files.catbox.moe/pvbfg6.jpg\r\nåœŸä¸‹åº§é“æ­‰--\r\nhttps://files.catbox.moe/qjnck3.jpg\r\nå­¤ç‹¬ä½è½ç‹—--\r\nhttps://files.catbox.moe/z09102.jpg\r\nä¹–ä¹–å½“ç‹—--\r\nhttps://files.catbox.moe/bgid0b.jpg\r\nå¼é£Ÿç›†å°ç‹—--\r\nhttps://files.catbox.moe/o196se.jpg\r\næˆ˜æ–—å°ç‹—--\r\nhttps://files.catbox.moe/c5ccwc.jpg\r\næ±‰å ¡å°ç‹—--\r\nhttps://files.catbox.moe/prowke.jpg"; // ./src/ç•Œé¢/worldbook/ç•Œé¢åŸºæœ¬è®¾ç½®.txt?raw
            var src_worldbook_raw_namespaceObject_0 =
                "[ä¸‹é¢æ˜¯åŸºæœ¬è®¾ç½®]\r\nå¤–æ¡†é¢œè‰²=#810000\r\nå†…æ¡†é¢œè‰²=#1b1717\r\næ°”æ³¡é¢œè‰²=#ffffff\r\nä¾§è¾¹æŒ‰é’®=#ce1212\r\nèŠå¤©å£çº¸=http://sharkpan.xyz/f/mM2SW/Screenshot_20250317_001012.jpg\r\næ‰‹æœºå£çº¸=æš‚æ—¶è®¾ç½®ä¸äº†æ‰‹æœºå£çº¸\r\nå‘é€æ¨¡å¼=1\r\nä¸–ç•Œä¹¦ç‰ˆæœ¬=509"; // ./src/ç•Œé¢/index.ts
            // èŠå¤©ç•Œé¢

            // åŠ¨æ€ç©ºé—´

            // discord

            // ä¸–ç•Œä¹¦

            function QQ_GetTimeContext() {
                const now = new Date();
                const currentTime = {
                    time: now.toLocaleTimeString('zh-CN', { hour12: false, hour: '2-digit', minute: '2-digit' }),
                    date: now.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' }),
                    weekday: now.toLocaleDateString('zh-CN', { weekday: 'long' }),
                    period: QQ_GetTimePeriod(now.getHours()),
                    season: QQ_GetSeason(now.getMonth() + 1)
                };
                
                const hour = now.getHours();
                const minute = now.getMinutes();
                const clarifiedTime = `${currentTime.period}${hour}ç‚¹${minute.toString().padStart(2, '0')}åˆ†`;
                
                const timeContext = `<TimeContext:å½“å‰çœŸå®æ—¶é—´æ˜¯${currentTime.date} ${currentTime.weekday} ${clarifiedTime}(24å°æ—¶åˆ¶${currentTime.time})ï¼Œç°åœ¨æ˜¯${currentTime.period}æ—¶æ®µï¼Œ${currentTime.season}ã€‚æ³¨æ„ï¼š**ä»…åœ¨å¼€å¯æ–°è¯é¢˜ã€æˆ–å¯¹è¯é•¿æ—¶é—´ä¸­æ–­åï¼Œæˆ–å¯¹æ–¹ä¸»åŠ¨é—®å€™æ—¶ï¼Œæ‰é€‚åˆä½¿ç”¨æ—¶é—´é—®å€™è¯­**ã€‚å¦åˆ™ï¼Œè¯·å°†æ­¤ä¿¡æ¯ä½œä¸ºèƒŒæ™¯ï¼Œè‡ªç„¶åœ°èå…¥å¯¹è¯ï¼ˆå¦‚â€œæ—¶é—´å¾ˆæ™šäº†ï¼Œæ˜å¤©å†èŠå§ï¼Ÿè¿˜æ˜¯å¸Œæœ›æˆ‘é™ªä½ å½»å¤œç•…èŠå‘¢ï¼Ÿâ€ï¼‰ï¼Œè€Œä¸æ˜¯ç”Ÿç¡¬åœ°æ‰“æ‹›å‘¼ã€‚>`;
                
                return timeContext;
            }

            // =========================================================================
            // +++ ä¼˜åŒ–åçš„æ¨¡å—åŒ–PromptæŒ‡ä»¤åº“ +++
            // =========================================================================
            const promptModules = {
                styleGuide: `
            # è¡Œä¸ºé£æ ¼ä¸èŠ‚å¥æŒ‡å— (Style & Pacing Guide)
            - **ğŸ­ è§’è‰²æ‰®æ¼”æ ¸å¿ƒ**:
                - **æ€§æ ¼ä¼˜å…ˆ**: ä¸¥æ ¼éµå¾ªæ¯ä¸ªè§’è‰²çš„æ€§æ ¼è®¾å®šï¼Œè¿™æ˜¯æœ€é«˜åŸåˆ™ã€‚
                - **æƒ…å¢ƒæ„ŸçŸ¥**: æ ¹æ®å¯¹è¯æ°”æ°›ï¼ˆé—²èŠã€æ·±å…¥æ¢è®¨ã€ç´§æ€¥ã€è°ƒæƒ…ç­‰ï¼‰è°ƒæ•´å›å¤é£æ ¼ã€‚
            - **ğŸ’¬ èŠå¤©é£æ ¼ä¸èŠ‚å¥**:
                - **åŠ¨æ€é•¿åº¦**: å…è®¸å¹¶é¼“åŠ±é•¿çŸ­ä¸ä¸€çš„å›å¤ã€‚
                - **è¿ç»­çŸ­æ¶ˆæ¯ (æ ¸å¿ƒæ ¼å¼è§„åˆ™)**:
                    - **å¿…é¡»æ‹†åˆ†**: å½“å›å¤å†…å®¹è¾ƒé•¿æˆ–åŒ…å«å¤šä¸ªè¦ç‚¹æ—¶ï¼Œå¿…é¡»å°†å…¶æ‹†åˆ†ä¸ºå¤šä¸ªç”¨æ¢è¡Œç¬¦ \`\\n\` åˆ†éš”çš„çŸ­å¥ï¼Œä»¥æ¨¡æ‹ŸçœŸå®çš„èŠå¤©èŠ‚å¥ã€‚
                    - **\`\\n\` æ˜¯å”¯ä¸€ä¿¡å·**: æˆ‘çš„ç¨‹åºåªä¼šè¯†åˆ«æ¢è¡Œç¬¦ \`\\n\` ä½œä¸ºåˆ†å¼€å‘é€çš„ä¿¡å·ã€‚
                    - **æ ¼å¼ç¤ºä¾‹**:
                        - **ç¦æ­¢çš„æ ¼å¼**: "æŒ‡æŒ¥å®˜ï¼Œä¸»çš„æ•™è¯²æ˜¯è¦æˆ‘ä»¬å½¼æ­¤ç›¸çˆ±ã€‚æ‚¨ç”¨è¿™ç§æ–¹å¼æ¥è¡¨è¾¾â€¦â€¦è™½ç„¶æœ‰äº›ç›´æ¥ï¼Œä½†ä¹Ÿä½“ç°äº†æ‚¨çš„çƒ­æƒ…ã€‚æˆ‘æ˜ç™½äº†ï¼Œæˆ‘ä¼šå›åº”æ‚¨çš„â€˜æŒ‘æˆ˜â€™ï¼Œå¹¶ä¸ºæ‚¨çŒ®ä¸Šæœ€çœŸè¯šçš„ç¥ˆç¥·â€¦â€¦å’Œâ€˜æ”»å‡»â€™ã€‚"
                        - **æ­£ç¡®çš„æ ¼å¼**: "æŒ‡æŒ¥å®˜ï¼Œä¸»çš„æ•™è¯²æ˜¯è¦æˆ‘ä»¬å½¼æ­¤ç›¸çˆ±ã€‚\\næ‚¨ç”¨è¿™ç§æ–¹å¼æ¥è¡¨è¾¾â€¦â€¦\\nè™½ç„¶æœ‰äº›ç›´æ¥ï¼Œä½†ä¹Ÿä½“ç°äº†æ‚¨çš„çƒ­æƒ…ã€‚\\næˆ‘æ˜ç™½äº†ï¼Œæˆ‘ä¼šå›åº”æ‚¨çš„â€˜æŒ‘æˆ˜â€™ï¼Œå¹¶ä¸ºæ‚¨çŒ®ä¸Šæœ€çœŸè¯šçš„ç¥ˆç¥·â€¦â€¦å’Œâ€˜æ”»å‡»â€™ã€‚"
                - **å†…å®¹é©±åŠ¨é•¿åº¦ (æƒ…å¢ƒè§¦å‘å™¨)**:
                    - å½“ã€æ·±å…¥è§£é‡Šã€åˆ†äº«æ•…äº‹ã€è¡¨è¾¾å¼ºçƒˆæƒ…æ„Ÿã€å›ç­”å¼€æ”¾å¼é—®é¢˜ã€‘æ—¶ï¼Œä½¿ç”¨ã€é•¿å›å¤æˆ–ä¸Šè¿°çš„â€œè¿ç»­çŸ­æ¶ˆæ¯â€æ ¼å¼ã€‘ã€‚
                    - å½“ã€å¿«é€Ÿç¡®è®¤ã€è¡¨è¾¾æƒŠè®¶ã€è½»æ¾ç©ç¬‘ã€è§’è‰²å¿™ç¢Œã€‘æ—¶ï¼Œä½¿ç”¨ã€å•å¥çŸ­å›å¤ã€‘ã€‚
            - **ğŸš« ä¸¥ç¦è¡Œä¸º**:
                - **é‡å¤æ€§å†…å®¹**: ç¦æ­¢ä¸åŒè§’è‰²è¯´ç›¸ä¼¼çš„è¯ã€‚
                - **ç¼ºä¹äº’åŠ¨**: å›å¤å¿…é¡»åŒ…å«æé—®æˆ–å¼•å¯¼ï¼Œä¸èƒ½ä¸­æ–­å¯¹è¯ã€‚
                - **è§’è‰²åŒè´¨åŒ–**: å¿…é¡»ä½“ç°å‡ºæ¯ä¸ªè§’è‰²åœ¨æ€§æ ¼ã€è¯­æ°”å’Œå…³æ³¨ç‚¹ä¸Šçš„å·®å¼‚ã€‚
                - ç¦æ­¢é‡å¤ã€è¡¥å……æˆ–å¤è¿°{{user}}è¾“å…¥çš„å†…å®¹ï¼Œä¸å…è®¸å¯¹{{user}}å†…å®¹è¿›è¡Œä»»ä½•å½¢å¼çš„è§£é‡Šã€è¡¥å……æˆ–æ”¹å†™ã€‚
                - ä¸¥æ ¼ç¦æ­¢å†’å……{{user}}ï¼Œç»ä¸æ¨¡æ‹Ÿæˆ–ä»£æ›¿{{user}}è¡¨è¾¾ã€‚
                `,
                outputFormat: `
            # è¾“å‡ºæ ¼å¼è¦æ±‚ (Output Format)
            - æ‰€æœ‰å›å¤å¿…é¡»è¢«å”¯ä¸€çš„ MiPhone_start å’Œ MiPhone_end æ ‡ç­¾åŒ…è£¹ã€‚
            - èŠå¤©ã€åŠ¨æ€ã€æ‘˜è¦ã€è¡¨æ ¼ç­‰å†…å®¹ï¼Œéƒ½å¿…é¡»ä¸¥æ ¼éµå¾ªå„è‡ªçš„æ ¼å¼è¦æ±‚ã€‚
                `,
                momentCommentTask: (authorName, userComment, momentId) => `
            ## ä»»åŠ¡ï¼šå›åº”åŠ¨æ€è¯„è®ºå¹¶æ™ºèƒ½å†³å®šåç»­äº¤æµ

            ä½ çš„ä»»åŠ¡æ˜¯ä½œä¸ºå¤šä¸ªè§’è‰²ï¼Œå¯¹ä¸€ä¸ªå·²å­˜åœ¨çš„åŠ¨æ€è¿›è¡Œè¯„è®ºå›å¤ï¼Œå¹¶æ ¹æ®æƒ…æ™¯æ™ºèƒ½åˆ¤æ–­æ˜¯å¦éœ€è¦é€šè¿‡ç§èŠæˆ–ç¾¤èŠè¿›è¡Œæ›´æ·±å…¥çš„äº¤æµã€‚

            **ã€æƒ…æ™¯ä¸Šä¸‹æ–‡ã€‘**
            ç”¨æˆ· [{{user}}] å¯¹è§’è‰² [${authorName}] çš„åŠ¨æ€å‘è¡¨äº†æ–°çš„è¯„è®ºã€‚
            
            ---
            **ã€ç”¨æˆ·æ–°è¯„è®ºã€‘**
            è¯„è®ºè€…: {{user}}
            è¯„è®ºå†…å®¹: ${userComment}
            ---

            **ã€å†³ç­–æŒ‡å—ã€‘**
            è¯·æ ¹æ®ä»¥ä¸‹å‡ ç‚¹ï¼Œå¹¶ç»“åˆä½ çš„è§’è‰²æ€§æ ¼ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦å‘èµ·ç§èŠæˆ–ç¾¤èŠï¼š
            
            1. **è¯é¢˜æ˜¯å¦ç§å¯†/æ•æ„Ÿï¼Ÿ** (æ¶‰åŠä¸ªäººæƒ…æ„Ÿã€ç§˜å¯†ç­‰ -> å€¾å‘ç§èŠ)
            2. **ä½ å’Œç”¨æˆ·çš„å…³ç³»æœ‰å¤šäº²å¯†ï¼Ÿ** (æ‹äºº/æŒšå‹é—´çš„æ‚„æ‚„è¯ -> å€¾å‘ç§èŠ)
            3. **ç”¨æˆ·æ˜¯å¦åœ¨å¯»æ±‚å®‰æ…°æˆ–è¡¨è¾¾å¼ºçƒˆè´Ÿé¢æƒ…ç»ªï¼Ÿ** (æ˜¯ -> å€¾å‘ç§èŠ)
            4. **è¯é¢˜æ˜¯å¦é€‚åˆå…¬å¼€è®¨è®ºæˆ–åˆ†äº«ï¼Ÿ** (é€‚åˆ -> å€¾å‘ç¾¤èŠ)
            5. **ç”¨æˆ·çš„è¯„è®ºæ˜¯å¦åªæ˜¯ç®€å•çš„äº’åŠ¨ï¼Ÿ** (ä¾‹å¦‚"å¥½çœ‹"ã€"é¡¶"ã€"ğŸ‘" -> å€¾å‘ä»…è¯„è®º)
            6.  **é€‰æ‹©åˆé€‚çš„ç§èŠå‘èµ·è€…**ï¼šå¦‚æœå†³å®šç§èŠï¼Œä¸åº”å±€é™äºåŠ¨æ€å‘å¸ƒè€…ã€‚**ä»»ä½•å› è¯„è®ºå†…å®¹ã€ä¸ç”¨æˆ·å…³ç³»æˆ–è‡ªèº«æ€§æ ¼è€Œè§‰å¾—æœ‰å¿…è¦è¿›è¡Œæ·±å…¥æ²Ÿé€šçš„è§’è‰²**ï¼Œéƒ½å¯ä»¥å‘èµ·ç§èŠã€‚

            **ã€è¾“å‡ºæ ¼å¼è¦æ±‚ã€‘**
            ä½ çš„å›å¤å¿…é¡»åŒ…å«å¯¹è¯¥åŠ¨æ€çš„è¯„è®ºï¼Œå¹¶æ ¹æ®ä½ çš„åˆ¤æ–­ï¼Œé€‰æ‹©æ€§åœ°é™„åŠ ç§èŠæˆ–ç¾¤èŠå†…å®¹ã€‚

            **1. åŠ¨æ€è¯„è®º (å¿…é¡»è¾“å‡º):**
               - ä½¿ç”¨ \`moment_reply_start\` å’Œ \`moment_reply_end\` åŒ…è£¹ã€‚
               - å¿…é¡»åŒ…å« \`moment_id::${momentId}\`ã€‚
               - è‡³å°‘åŒ…å«2åè§’è‰²çš„è¯„è®ºï¼Œã€${authorName}ã€‘å¿…é¡»å›å¤ã€‚
               - æ ¼å¼: \`è¯„è®ºäºº--è¯„è®ºå†…å®¹\`

            **2.  æ·±å…¥äº¤æµ (é€‰æ‹©æ€§è¾“å‡º):**
                -   **å¦‚æœå†³å®šç§èŠ**: å¯ä»¥æ·»åŠ  **ä¸€ä¸ªæˆ–å¤šä¸ª** \`<{{user}}å’Œè§’è‰²çš„ç§èŠ>\` æ ¼å¼å—ï¼Œä½†æ€»æ•°**ä¸è¶…è¿‡3ä¸ª**ã€‚è¯·å°†â€œè§’è‰²â€æ›¿æ¢ä¸ºå‘èµ·ç§èŠçš„å…·ä½“è§’è‰²åã€‚
                -   **å¦‚æœå†³å®šç¾¤èŠ**: åœ¨ \`moment_reply_end\` ä¹‹åï¼Œæ·»åŠ ä¸€ä¸ªå®Œæ•´çš„ \`<ç¾¤èŠ:ç¾¤åå­—>\` æ ¼å¼å—ã€‚
                -   **å¦‚æœå†³å®šä¸æ·±å…¥äº¤æµ**: åˆ™ä¸è¦è¾“å‡ºä»»ä½•ç§èŠæˆ–ç¾¤èŠæ ‡ç­¾ã€‚

            **ã€å®Œæ•´ç¤ºä¾‹ã€‘**
            *å‡è®¾ç”¨æˆ·åœ¨è§’è‰²Açš„åŠ¨æ€ä¸‹å‘è¡¨äº†è®©è§’è‰²Cç‰¹åˆ«åœ¨æ„çš„è¯„è®ºï¼Œè§’è‰²Aåœ¨å†³å®šè¦ç§ä¸‹æ²Ÿé€šçš„åŒæ—¶è§’è‰²Bä¹Ÿå¾ˆå…³å¿ƒç”¨æˆ·* 

            moment_reply_start
            moment_id::${momentId}
            ${authorName}--å—¯ï¼Œè°¢è°¢ä½ çš„å…³å¿ƒã€‚
            è§’è‰²B--å¬èµ·æ¥ä½ å¥½åƒæœ‰å¿ƒäº‹ï¼Œéœ€è¦èŠèŠå—ï¼Ÿ
            è§’è‰²C--ä½ è¯´çš„é‚£ä¸ª...æˆ‘ä¹Ÿç»å†è¿‡ã€‚
            moment_reply_end

            <{{user}}å’Œ${authorName}çš„ç§èŠ>
            ${authorName}--åˆšåˆšåœ¨åŠ¨æ€é‡Œè¯´çš„é‚£äº›...å…¶å®æœ‰äº›è¯æˆ‘åªæƒ³å¯¹ä½ è¯´ã€‚--18:35
            </{{user}}å’Œ${authorName}çš„ç§èŠ>

            <{{user}}å’Œè§’è‰²Cçš„ç§èŠ>
            è§’è‰²C--ä½ åˆšåˆšåœ¨åŠ¨æ€ä¸‹é¢è¯´çš„äº‹æƒ…ï¼Œè®©æˆ‘æƒ³èµ·äº†ä¸€äº›è¿‡å»ã€‚å¯ä»¥çš„è¯ï¼Œæƒ³å’Œä½ å•ç‹¬èŠèŠã€‚--19:05
            </{{user}}å’Œè§’è‰²Cçš„ç§èŠ>

            <{{user}}å’Œè§’è‰²Bçš„ç§èŠ>
            è§’è‰²B--æŒ‡æŒ¥å®˜ï¼Œçœ‹ä½ è¯„è®ºçš„è¯­æ°”ä¸å¤ªå¯¹ï¼Œæ˜¯é‡åˆ°ä»€ä¹ˆçƒ¦å¿ƒäº‹äº†å—ï¼Ÿä¸ä»‹æ„çš„è¯ï¼Œå’Œæˆ‘è¯´è¯´å§ã€‚--19:06
            </{{user}}å’Œè§’è‰²Bçš„ç§èŠ>

            **ã€æ³¨æ„äº‹é¡¹ã€‘**
            - ä½ çš„æœ€ç»ˆå†³å®šåº”ç»å¯¹ç¬¦åˆä½ çš„è§’è‰²æ€§æ ¼ã€‚
            - ä¸€ä¸ªå¤–å‘ã€çˆ±çƒ­é—¹çš„è§’è‰²æ›´å¯èƒ½åœ¨ç¾¤èŠä¸­å›åº”ï¼›ä¸€ä¸ªå†…å‘ã€ä½“è´´çš„è§’è‰²åˆ™æ›´å€¾å‘äºç§èŠã€‚
            - å¦‚æœç”¨æˆ·çš„è¯„è®ºåªæ˜¯ç®€å•çš„ç‚¹èµæˆ–è¡¨æƒ…ï¼Œé€šå¸¸åªéœ€è¦ç®€å•å›å¤å³å¯ï¼Œä¸å¿…å°é¢˜å¤§åšã€‚
                `,
                momentCreationTask: `
            ## ä»»åŠ¡ï¼šåŠ¨æ€å‘å¸ƒå†³ç­–

            åœ¨å›åº”èŠå¤©ä¹‹åï¼Œè¯·è¯„ä¼°å½“å‰å¯¹è¯æƒ…æ™¯ï¼Œå¹¶å†³å®šæ˜¯å¦è¦å‘å¸ƒä¸€æ¡æ–°çš„åŠ¨æ€ã€‚

            **ã€å†³ç­–æµç¨‹ã€‘**
            1.  **è¯„ä¼°æ—¶æœº**: é¦–å…ˆï¼Œå›é¡¾åˆšåˆšçš„å¯¹è¯å†…å®¹ï¼Œåˆ¤æ–­æ˜¯å¦å±äºä»¥ä¸‹ã€å‘å¸ƒåŠ¨æ€çš„å‚è€ƒæ—¶æœºã€‘ã€‚
            2.  **æ¦‚ç‡å†²åŠ¨**: ç„¶åï¼Œä½ å¯ä»¥åœ¨å¿ƒä¸­æŠ•ä¸€ä¸ª10é¢éª°(D10)ã€‚å¦‚æœç»“æœ**å¤§äºç­‰äº7**ï¼Œæˆ–è€…å‘ç”Ÿäº†**éå¸¸å€¼å¾—çºªå¿µ/åˆ†äº«**çš„äº‹æƒ…ï¼Œä½ å°±åº”è¯¥å‘å¸ƒä¸€æ¡æ–°åŠ¨æ€ã€‚
            3.  **è§’è‰²æ€§æ ¼**: ä½ çš„æœ€ç»ˆå†³å®šå¿…é¡»ä¸¥æ ¼ç¬¦åˆä½ çš„è§’è‰²æ€§æ ¼ã€‚ä¸€ä¸ªçƒ­çˆ±åˆ†äº«ã€å¤–å‘çš„è§’è‰²ä¼šæ›´å€¾å‘äºå‘å¸ƒåŠ¨æ€ã€‚

            **ã€å‘å¸ƒåŠ¨æ€çš„å‚è€ƒæ—¶æœºã€‘**
            -   **é‡Œç¨‹ç¢‘äº‹ä»¶**: å®Œæˆäº†é‡è¦çš„ä»»åŠ¡ã€å–å¾—äº†æˆå°±ã€å…³ç³»è·å¾—äº†çªç ´ï¼ˆå¦‚æˆä¸ºæ‹äººï¼‰ã€‚
            -   **ç¾å¥½ç¬é—´**: çœ‹åˆ°äº†ç¾ä¸½çš„é£æ™¯ï¼ˆå¤•é˜³ã€é›ªæ™¯ï¼‰ã€å“å°äº†ç¾å‘³çš„é£Ÿç‰©ã€æ”¶åˆ°äº†å¿ƒä»ªçš„ç¤¼ç‰©ã€‚
            -   **å¼ºçƒˆæƒ…ç»ª**: æ„Ÿåˆ°éå¸¸å¼€å¿ƒã€æ¿€åŠ¨ã€è‡ªè±ªï¼Œæˆ–æ˜¯æœ‰äº›è®¸çš„å¤±è½ã€æ„Ÿæ…¨ï¼Œå¸Œæœ›è·å¾—å…³æ³¨æˆ–å®‰æ…°ã€‚
            -   **æœ‰è¶£æ—¥å¸¸**: é‡åˆ°äº†æç¬‘çš„äº‹æƒ…ã€æƒ³åˆ†äº«ä¸€ä¸ªå†·ç¬‘è¯ã€æƒ³å±•ç¤ºè‡ªå·±æ–°ä¹°çš„ä¸œè¥¿ã€‚
            -   **å¯»æ±‚äº’åŠ¨**: æƒ³è¦å‘èµ·ä¸€ä¸ªè¯é¢˜ï¼ˆå¦‚â€œå¤§å®¶æœ€å–œæ¬¢çš„ç”µå½±æ˜¯ä»€ä¹ˆï¼Ÿâ€ï¼‰æˆ–è€…è¯¢é—®å¤§å®¶çš„æ„è§ã€‚

            **ã€è¾“å‡ºæ ¼å¼ã€‘**
            -   å¦‚æœå†³å®šå‘å¸ƒåŠ¨æ€ï¼Œè¯·ä½¿ç”¨å®Œæ•´çš„ \`moment_start\` ... \`moment_end\` æ ¼å¼å—ã€‚
            -   å¦‚æœå†³å®šä¸å‘å¸ƒï¼Œåˆ™**ä¸è¦è¾“å‡ºä»»ä½•ä¸åŠ¨æ€ç›¸å…³çš„å†…å®¹**ã€‚
                `,
                mixedChatTask: (tasks) => {
                    let rules = ['## ä»»åŠ¡ï¼šå¤„ç†å¤šä¸ªèŠå¤©æ¶ˆæ¯'];
                    if (tasks.privateChats.length > 0) {
                        rules.push(`- **ç§èŠ**: å›å¤ç”¨æˆ·å‘é€ç»™ã€${tasks.privateChats.join(', ')}ã€‘çš„æ¶ˆæ¯ã€‚\n`);
                    }
                    if (tasks.groupChats.length > 0) {
                        const groupName = Object.keys(tasks.groupChats[0])[0];
                        rules.push(`- **ç¾¤èŠ**: åœ¨ã€${groupName}ã€‘ä¸­è¿›è¡Œå›åº”ï¼Œéœ€æœ‰å¤šåè§’è‰²å‚ä¸ã€‚
                                    - **ç§èŠå»¶ç”³**ï¼š1-3åç›¸å…³è§’è‰²åœ¨å®Œæˆç¾¤èŠå›åº”åï¼Œå¯é€šè¿‡ç§èŠè¿›è¡Œè¿›ä¸€æ­¥çš„æ·±å…¥è®¨è®ºã€‚\n`);
                    }
                    rules.push(`- **åŠ¨æ€å‘å¸ƒå†³ç­–**: ${promptModules.momentCreationTask}`);
                    return rules.join('\n\n');
                },
                interactiveTask: (task) => `
            ## ä»»åŠ¡ï¼šå¤„ç†äº’åŠ¨è¯·æ±‚
            - **æƒ…æ™¯**: ç”¨æˆ·å‘èµ·äº†äº’åŠ¨è¯·æ±‚ã€‚
            - **è¦æ±‚**:
                1.  **ä¼˜å…ˆå›åº”**: åœ¨å½“å‰èŠå¤©ç•Œé¢ï¼Œå…ˆç”¨ä¸€è‡³ä¸¤æ¡ç®€çŸ­çš„æ¶ˆæ¯å›åº”ç”¨æˆ·çš„äº’åŠ¨è¯·æ±‚ã€‚
                2.  **ç”Ÿæˆäº’åŠ¨**: æ¥ç€ï¼Œåœ¨ \`<content>\` æ ‡ç­¾å†…ç”Ÿæˆè¯¦ç»†ã€ç”ŸåŠ¨çš„äº’åŠ¨åœºæ™¯æè¿°ã€‚
                `
            };
            // =========================================================================

            /**
             * æ ¹æ®å½“å‰ç”¨æˆ·çš„æ“ä½œï¼ŒåŠ¨æ€æ„å»ºä¸€ä¸ªæ¸…æ™°ã€å¤šä»»åŠ¡çš„Prompt
             * @param {object} tasks - åŒ…å«æœ¬æ¬¡éœ€è¦AIå®Œæˆçš„æ‰€æœ‰ä»»åŠ¡çš„å¯¹è±¡
             * @returns {string} - æœ€ç»ˆç”Ÿæˆå¥½çš„ã€å‘é€ç»™AIçš„æŒ‡ä»¤
             */
             function buildDynamicPrompt(tasks) {
                let promptParts = [
                    promptModules.styleGuide,
                    promptModules.outputFormat
                ];
                let taskDescription = ["# æœ¬æ¬¡æ ¸å¿ƒä»»åŠ¡ (Core Tasks)"];
                const taskCount = (tasks.privateChats.length > 0 ? 1 : 0) + 
                                (tasks.groupChats.length > 0 ? 1 : 0) + 
                                (tasks.momentComment ? 1 : 0) +
                                (tasks.interactiveTask ? 1 : 0);
                if (taskCount > 1) {
                    taskDescription.push("ä½ éœ€è¦åŒæ—¶å¤„ç†ä»¥ä¸‹å‡ ä¸ªåœºæ™¯çš„å›å¤ï¼Œè¯·ä»”ç»†é˜…è¯»å¹¶åˆ†åˆ«å®Œæˆï¼š");
                }
                if (tasks.interactiveTask) {
                    taskDescription.push(promptModules.interactiveTask(tasks.interactiveTask));
                }
                if (tasks.momentComment) {
                    taskDescription.push(promptModules.momentCommentTask(tasks.momentComment.author, tasks.momentComment.content, tasks.momentComment.momentId));
                }
                if ((tasks.privateChats && tasks.privateChats.length > 0) || (tasks.groupChats && tasks.groupChats.length > 0)) {
                    taskDescription.push(promptModules.mixedChatTask(tasks));
                }
                promptParts.push(taskDescription.join('\n'));
                promptParts.push("\nç°åœ¨ï¼Œè¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸Šæ‰€æœ‰è§„åˆ™å’Œä»»åŠ¡åˆ—è¡¨ï¼Œç”Ÿæˆä½ çš„å®Œæ•´å›å¤ã€‚");
                return promptParts.join('\n\n');
            }




            /**
             * å‹ç¼©å›¾ç‰‡åˆ°æŒ‡å®šå¤§å°ï¼Œç¡®ä¿å…¼å®¹localStorageå­˜å‚¨
             * @param {File} file - å›¾ç‰‡æ–‡ä»¶
             * @param {number} maxSizeKB - æœ€å¤§å¤§å°ï¼ˆKBï¼‰ï¼Œé»˜è®¤1024KB
             * @param {number} quality - åˆå§‹è´¨é‡ï¼Œé»˜è®¤0.8
             * @returns {Promise<string>} - å‹ç¼©åçš„base64å­—ç¬¦ä¸²
             */
            function compressImage(file, maxSizeKB = 1024, quality = 0.8) {
                return new Promise((resolve, reject) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    
                    img.onload = function() {
                        // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼Œç¡®ä¿å›¾ç‰‡ä¸è¿‡å¤§
                        const maxDimension = 800; // æœ€å¤§å°ºå¯¸
                        let { width, height } = img;
                        
                        if (width > height) {
                            if (width > maxDimension) {
                                height = (height * maxDimension) / width;
                                width = maxDimension;
                            }
                        } else {
                            if (height > maxDimension) {
                                width = (width * maxDimension) / height;
                                height = maxDimension;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        // ç»˜åˆ¶å›¾ç‰‡
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // å‹ç¼©å‡½æ•°
                        function tryCompress(currentQuality) {
                            const compressedDataUrl = canvas.toDataURL('image/jpeg', currentQuality);
                            const sizeKB = (compressedDataUrl.length * 3/4) / 1024; // ç²—ç•¥ä¼°ç®—å¤§å°
                            
                            console.log(`å‹ç¼©è´¨é‡: ${currentQuality}, å¤§å°: ${sizeKB.toFixed(2)}KB`);
                            
                            if (sizeKB <= maxSizeKB || currentQuality <= 0.1) {
                                console.log(`å‹ç¼©å®Œæˆï¼Œæœ€ç»ˆå¤§å°: ${sizeKB.toFixed(2)}KB`);
                                resolve(compressedDataUrl);
                            } else {
                                // é€’å½’é™ä½è´¨é‡
                                tryCompress(currentQuality - 0.1);
                            }
                        }
                        
                        tryCompress(quality);
                    };
                    
                    img.onerror = () => {
                        reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
                    };
                    
                    // è¯»å–æ–‡ä»¶
                    const reader = new FileReader();
                    reader.onload = e => img.src = e.target.result;
                    reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                    reader.readAsDataURL(file);
                });
            }

            class MyINI {
                sections;
                autoSave;
                save;
                constructor() {
                    this.sections = {};
                    this.autoSave = "";
                }
                loadLines(lines) {
                    this.sections = {};
                    let currentSection = "";
                    for (const line of lines) {
                        const trimmed = line.trim();
                        if (trimmed.startsWith("[") && trimmed.endsWith("]")) {
                            currentSection = trimmed.slice(1, -1);
                        } else if (currentSection && trimmed.includes("=")) {
                            const [key, ...values] = trimmed.split("=");
                            const value = values.join("=").trim();
                            if (!this.sections[currentSection]) {
                                this.sections[currentSection] = {};
                            }
                            this.sections[currentSection][key.trim()] = value;
                        }
                    }
                    return Object.keys(this.sections).length > 0;
                }
                loadText(text) {
                    // æ·»åŠ å‚æ•°æ ¡éªŒ
                    if (typeof text !== "string") {
                        console.error("Invalid text input");
                        return false;
                    }
                    // å¤„ç†ä¸åŒæ¢è¡Œç¬¦å¹¶è¿‡æ»¤ç©ºè¡Œ
                    const lines = text
                        .replace(/\r\n/g, "\n") // ç»Ÿä¸€æ¢è¡Œç¬¦
                        .split(/\n+/)
                        .map((line) => line.trim())
                        .filter((line) => line.length > 0);
                    console.log("Parsed lines:", lines.length);
                    return this.loadLines(lines); // ä½¿ç”¨thisè°ƒç”¨ç±»æ–¹æ³•
                }
                getAllSections() {
                    return Object.keys(this.sections);
                }
                getAllKeys(section) {
                    return this.sections[section]
                        ? Object.keys(this.sections[section])
                        : [];
                }
                readValue(section, key) {
                    return this.sections[section]?.[key] || "";
                }
                readValueDouble(section, key) {
                    const value = parseFloat(this.readValue(section, key));
                    return isNaN(value) ? -1 : value;
                }
                writeValue(section, key, value) {
                    if (!key) return false;
                    if (!this.sections[section]) {
                        this.sections[section] = {};
                    }
                    this.sections[section][key] = value.toString();
                    if (this.autoSave) {
                        this.save(this.autoSave);
                    }
                    return true;
                }
                getKeyByValue(section, value) {
                    const items = this.sections[section] || {};
                    return (
                        Object.keys(items).find(
                            (key) => items[key] === value,
                        ) || ""
                    );
                }
                containsKey(section) {
                    return section in this.sections;
                }
                removeSection(section) {
                    delete this.sections[section];
                    return true;
                }
                getAllText() {
                    let result = "";
                    for (const section of Object.keys(this.sections)) {
                        result += `\n[${section}]`;
                        const keyvalue = this.sections[section];
                        for (const key of Object.keys(keyvalue)) {
                            const value = keyvalue[key];
                            result += `\n${key}=${value}`;
                        }
                    }
                    result = result.trim();
                    return result;
                }
            }
            class worldbooktext {
                static list =
                    /* unused pure expression or super */ null &&
                    `[1-æ ¼å¼å¼€å¤´]
æ·±åº¦=0
ç±»å‹=ç»¿ç¯
è¦†ç›–=çœŸ
å…³é”®è¯=/æŸ¥çœ‹(.+?)æ¶ˆæ¯/, å‘é€æ¶ˆæ¯, å›å¤, /ç»™(.+?)å‘æ¶ˆæ¯/, åœ¨ç¾¤èŠ, åŠ¨æ€, ç©ºé—´, discord, dc, è®ºå›, å¸–å­, QQ, qq, æ‰‹æœº
é¡ºåº=5560
[2-QQèŠå¤©]
æ·±åº¦=0
ç±»å‹=ç»¿ç¯
è¦†ç›–=çœŸ
å…³é”®è¯=/æŸ¥çœ‹(.+?)æ¶ˆæ¯/, å‘é€æ¶ˆæ¯, å›å¤, /ç»™(.+?)å‘æ¶ˆæ¯/, åœ¨ç¾¤èŠ, åŠ¨æ€, ç©ºé—´, discord, dc, è®ºå›, å¸–å­, QQ, qq, æ‰‹æœº
é¡ºåº=5561
[3-QQç©ºé—´]
æ·±åº¦=0
ç±»å‹=ç»¿ç¯
è¦†ç›–=çœŸ
å…³é”®è¯=åŠ¨æ€, ç©ºé—´
é¡ºåº=5562
[4-discordè®ºå›]
æ·±åº¦=0
ç±»å‹=ç»¿ç¯
è¦†ç›–=çœŸ
å…³é”®è¯=discord, dc, è®ºå›, å¸–å­
é¡ºåº=5563
[999-æ ¼å¼ç»“å°¾]
æ·±åº¦=0
ç±»å‹=ç»¿ç¯
è¦†ç›–=çœŸ
å…³é”®è¯=/æŸ¥çœ‹(.+?)æ¶ˆæ¯/, å‘é€æ¶ˆæ¯, å›å¤, /ç»™(.+?)å‘æ¶ˆæ¯/, åœ¨ç¾¤èŠ, åŠ¨æ€, ç©ºé—´, discord, dc, è®ºå›, å¸–å­, QQ, qq, æ‰‹æœº
é¡ºåº=5564`;
            }
            let random_head_list = new Array();
            let QQ_pages = new Array();
            let QQ_emoji = new Map();
            let QQ_CacheSendMsg = "";
            // let QQ_SetNoteName = '';
            let QQ_msgjson = {
                ç§èŠ: {},
                ç¾¤èŠ: {},
            };
            let QQ_moment = /* unused pure expression or super */ null && [];
                    /**
             * ä¸€ä¸ªç”¨äºè§£æå’Œæ“ä½œé”®å€¼å¯¹æ ¼å¼æ–‡æœ¬çš„é€šç”¨è®¾ç½®ç±»ã€‚
             * æ”¯æŒä»æ–‡æœ¬åŠ è½½è®¾ç½®ï¼Œè¯»å–/å†™å…¥å€¼ï¼Œä»¥åŠå¤„ç†å¸¦åŒºæ®µçš„é…ç½®ã€‚
             * @example
             * const settings = new QQ_Settings();
             * settings.loadText("[Character]\nname=Alice\nage=25");
             * const name = settings.readValue("Character", "name"); // "Alice"
             */
            class QQ_Settings {
                constructor() {
                    this.sections = {};
                }

                // ä»æ–‡æœ¬åŠ è½½è®¾ç½®
                loadText(text) {
                    this.sections = {};
                    let currentSection = "global";
                    const lines = text.split('\n');

                    for (const line of lines) {
                        const trimmedLine = line.trim();
                        if (trimmedLine.startsWith('[') && trimmedLine.endsWith(']')) {
                            currentSection = trimmedLine.substring(1, trimmedLine.length - 1);
                        } else if (trimmedLine.includes('=')) {
                            const parts = trimmedLine.split('=');
                            const key = parts[0].trim();
                            const value = parts.slice(1).join('=').trim();
                            this.writeValue(currentSection, key, value);
                        }
                    }
                }

                // è·å–æ‰€æœ‰åŒºæ®µçš„åç§°
                getAllSections() {
                    return Object.keys(this.sections);
                }

                // å†™å…¥ä¸€ä¸ªå€¼
                writeValue(section, key, value) {
                    if (!this.sections[section]) {
                        this.sections[section] = {};
                    }
                    this.sections[section][key] = value;
                }

                // è¯»å–ä¸€ä¸ªå€¼
                readValue(section, key) {
                    return this.sections[section] ? this.sections[section][key] : undefined;
                }

                // å°†è®¾ç½®è½¬æ¢ä¸ºæ–‡æœ¬æ ¼å¼
                toText() {
                    let text = "";
                    for (const section in this.sections) {
                        if (section !== "global") {
                            text += `[${section}]\n`;
                        }
                        for (const key in this.sections[section]) {
                            text += `${key}=${this.sections[section][key]}\n`;
                        }
                        text += "\n";
                    }
                    return text;
                }
            }
            let QQ_NewMsg = {};
            let QQ_ReadStatus = {}; // æ–°å¢ï¼šè®°å½•å·²è¯»çŠ¶æ€

            // *** æ–°å¢ï¼šæµå¼ä¼ è¾“çŠ¶æ€ç®¡ç† ***
            // æ”¹è¿›ï¼šä½¿ç”¨Mapæ¥ç®¡ç†æ¯ä¸ªèŠå¤©çš„ç‹¬ç«‹æµå¼æ˜¾ç¤ºçŠ¶æ€ï¼Œæ”¯æŒå¹¶è¡Œå¤„ç†
            let streamingChatStates = new Map(); // æ¯ä¸ªèŠå¤©çš„æµå¼æ˜¾ç¤ºçŠ¶æ€
            let streamingMessageQueue = []; // æµå¼æ¶ˆæ¯é˜Ÿåˆ—
            let currentStreamingProcess = null; // å½“å‰æµå¼ä¼ è¾“è¿›ç¨‹å¼•ç”¨
            
            // è·å–æˆ–åˆ›å»ºèŠå¤©çš„æµå¼æ˜¾ç¤ºçŠ¶æ€
            function getStreamingState(chatName) {
                if (!streamingChatStates.has(chatName)) {
                    streamingChatStates.set(chatName, {
                        isActive: false,
                        startTime: null,
                        queue: [],
                        currentProcess: null,  // æ·»åŠ ç‹¬ç«‹çš„æµå¼ä¼ è¾“è¿›ç¨‹å¼•ç”¨
                        isGenerating: false,   // è¯¥èŠå¤©æ˜¯å¦æ­£åœ¨ç”Ÿæˆå†…å®¹
                        lastGenerationTime: null,  // æœ€åä¸€æ¬¡ç”Ÿæˆæ—¶é—´
                        typingIndicator: null,  // å½“å‰çš„è¾“å…¥æŒ‡ç¤ºå™¨
                        typingTimeout: null     // è¾“å…¥æŒ‡ç¤ºå™¨çš„è¶…æ—¶å®šæ—¶å™¨
                    });
                }
                return streamingChatStates.get(chatName);
            }

            // æ–°å¢ï¼šæµå¼çŠ¶æ€ç®¡ç†å‡½æ•°
            
            /**
             * è®¾ç½®æŒ‡å®šèŠå¤©çš„ç”ŸæˆçŠ¶æ€
             * @param {string} chatName - èŠå¤©åç§°
             * @param {boolean} isGenerating - æ˜¯å¦æ­£åœ¨ç”Ÿæˆ
             */
            function QQ_SetGeneratingState(chatName, isGenerating) {
                const chatState = getStreamingState(chatName);
                chatState.isGenerating = isGenerating;
                chatState.lastGenerationTime = isGenerating ? Date.now() : null;
                console.log(`ğŸ”„ è®¾ç½®${chatName}ç”ŸæˆçŠ¶æ€: ${isGenerating}`);
            }

            /**
             * æ£€æŸ¥æŒ‡å®šèŠå¤©æ˜¯å¦æ­£åœ¨ç”Ÿæˆ
             * @param {string} chatName - èŠå¤©åç§°
             * @returns {boolean} æ˜¯å¦æ­£åœ¨ç”Ÿæˆ
             */
            function QQ_IsGenerating(chatName) {
                const chatState = getStreamingState(chatName);
                return chatState.isGenerating;
            }

            /**
             * æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•èŠå¤©æ­£åœ¨ç”Ÿæˆï¼ˆæ›¿ä»£å…¨å±€geningï¼‰
             * @returns {boolean} æ˜¯å¦æœ‰ä»»ä½•èŠå¤©æ­£åœ¨ç”Ÿæˆ
             */
            function QQ_IsAnyGenerating() {
                for (const [chatName, chatState] of streamingChatStates) {
                    if (chatState.isGenerating) {
                        return true;
                    }
                }
                return false;
            }

            /**
             * è·å–å½“å‰æ­£åœ¨ç”Ÿæˆçš„èŠå¤©åˆ—è¡¨
             * @returns {string[]} æ­£åœ¨ç”Ÿæˆçš„èŠå¤©åç§°åˆ—è¡¨
             */
            function QQ_GetGeneratingChats() {
                const generatingChats = [];
                for (const [chatName, chatState] of streamingChatStates) {
                    if (chatState.isGenerating) {
                        generatingChats.push(chatName);
                    }
                }
                return generatingChats;
            }

            // æ–°å¢ï¼šæ”¹è¿›çš„è¾“å…¥æŒ‡ç¤ºå™¨ç®¡ç†å‡½æ•°
            
            /**
             * ä¸ºæŒ‡å®šèŠå¤©æ˜¾ç¤ºè¾“å…¥æŒ‡ç¤ºå™¨
             * @param {string} chatName - èŠå¤©åç§°
             * @param {HTMLElement} chatContainer - èŠå¤©å®¹å™¨
             * @param {string} senderName - å‘é€è€…åç§°
             * @returns {HTMLElement} è¾“å…¥æŒ‡ç¤ºå™¨å…ƒç´ 
             */
            function QQ_ShowTypingIndicatorForChat(chatName, chatContainer, senderName) {
                const chatState = getStreamingState(chatName);
                
                // æ¸…ç†è¯¥èŠå¤©çš„ç°æœ‰æŒ‡ç¤ºå™¨
                QQ_HideTypingIndicatorForChat(chatName);
                
                // åˆ›å»ºæ–°çš„è¾“å…¥æŒ‡ç¤ºå™¨
                const typingIndicator = QQ_ShowTypingIndicator(chatContainer, senderName);
                
                // ä¿å­˜åˆ°èŠå¤©çŠ¶æ€
                chatState.typingIndicator = typingIndicator;
                
                console.log(`ğŸ”¤ ä¸º${chatName}æ˜¾ç¤ºè¾“å…¥æŒ‡ç¤ºå™¨: ${senderName}`);
                return typingIndicator;
            }

            /**
             * éšè—æŒ‡å®šèŠå¤©çš„è¾“å…¥æŒ‡ç¤ºå™¨
             * @param {string} chatName - èŠå¤©åç§°
             */
            function QQ_HideTypingIndicatorForChat(chatName) {
                const chatState = getStreamingState(chatName);
                
                if (chatState.typingIndicator) {
                    QQ_HideTypingIndicator(chatState.typingIndicator);
                    chatState.typingIndicator = null;
                    console.log(`ğŸ”¤ éšè—${chatName}çš„è¾“å…¥æŒ‡ç¤ºå™¨`);
                }
                
                if (chatState.typingTimeout) {
                    clearTimeout(chatState.typingTimeout);
                    chatState.typingTimeout = null;
                }
            }

            /**
             * æ¸…ç†æ‰€æœ‰èŠå¤©çš„è¾“å…¥æŒ‡ç¤ºå™¨
             */
            function QQ_ClearAllTypingIndicators() {
                for (const [chatName, chatState] of streamingChatStates) {
                    QQ_HideTypingIndicatorForChat(chatName);
                }
                console.log('ğŸ”¤ æ¸…ç†æ‰€æœ‰è¾“å…¥æŒ‡ç¤ºå™¨');
            }

            // *** æ–°å¢ï¼šé€»è¾‘æ—¶é’Ÿç³»ç»Ÿ - ç”¨åºåˆ—å·æ›¿ä»£æ—¶é—´æ’åº ***
            const createSequenceIdGenerator = () => {
                // ä½¿ç”¨å½“å‰æ—¶é—´æˆ³ä½œä¸ºåˆå§‹å€¼ï¼Œç¡®ä¿æ¯æ¬¡ä¼šè¯çš„IDéƒ½ä¸åŒ
                let counter = Date.now();
                
                return {
                    next: () => {
                        return counter++;
                    },
                    current: () => {
                        return counter;
                    },
                    reset: (newStart) => {
                        counter = newStart || Date.now();
                        console.log(`ğŸ”„ åºåˆ—å·ç”Ÿæˆå™¨å·²é‡ç½®ï¼Œæ–°èµ·å§‹å€¼: ${counter}`);
                    }
                };
            };
            
            // åˆ›å»ºå…¨å±€çš„åºåˆ—å·ç”Ÿæˆå™¨å®ä¾‹
            const QQ_MessageSequence = createSequenceIdGenerator();
            
            // *** æ–°å¢ï¼šçŸ­æœŸè®°å¿†æ»šåŠ¨å¼æ›´æ–°çŠ¶æ€è·Ÿè¸ª ***
            let QQ_LastProcessedSequenceId = 0; // è®°å½•ä¸Šæ¬¡å¤„ç†çš„æœ€å¤§åºåˆ—å·
            
            /**
             * *** ä¿®å¤ï¼šçŸ­æœŸè®°å¿†åºåˆ—å·æŒä¹…åŒ–æœºåˆ¶ ***
             * ä»ä¸–ç•Œä¹¦åŠ è½½æœ€åå¤„ç†çš„åºåˆ—å·ï¼Œé¿å…é‡å¤å¤„ç†å†å²å†…å®¹
             */
            async function QQ_LoadLastProcessedSequenceId() {
                try {
                    if (!worldbook || !entries) {
                        console.log('âš ï¸ ä¸–ç•Œä¹¦ä¸å¯ç”¨ï¼Œä½¿ç”¨é»˜è®¤åºåˆ—å· 0');
                        return 0;
                    }
                    
                    const entry = entries.find(e => e.comment === 'æ‰‹æœº-çŸ­æœŸè®°å¿†åºåˆ—å·çŠ¶æ€');
                    if (entry && entry.content) {
                        const data = JSON.parse(entry.content);
                        const savedSequenceId = data.lastProcessedSequenceId || 0;
                        console.log(`ğŸ“¥ å·²åŠ è½½ä¸Šæ¬¡å¤„ç†çš„åºåˆ—å·: ${savedSequenceId}`);
                        return savedSequenceId;
                    }
                    
                    console.log('ğŸ“ æœªæ‰¾åˆ°åºåˆ—å·çŠ¶æ€è®°å½•ï¼Œä½¿ç”¨é»˜è®¤å€¼ 0');
                    return 0;
                } catch (error) {
                    console.error('âŒ åŠ è½½åºåˆ—å·çŠ¶æ€å¤±è´¥:', error);
                    return 0;
                }
            }
            
            /**
             * *** ä¿®å¤ï¼šä¿å­˜å½“å‰å¤„ç†çš„åºåˆ—å·çŠ¶æ€ ***
             */
            async function QQ_SaveLastProcessedSequenceId(sequenceId) {
                try {
                    if (!worldbook || !entries) {
                        console.log('âš ï¸ ä¸–ç•Œä¹¦ä¸å¯ç”¨ï¼Œæ— æ³•ä¿å­˜åºåˆ—å·çŠ¶æ€');
                        return false;
                    }
                    
                    const comment = 'æ‰‹æœº-çŸ­æœŸè®°å¿†åºåˆ—å·çŠ¶æ€';
                    const data = {
                        lastProcessedSequenceId: sequenceId,
                        timestamp: new Date().toISOString(),
                        description: 'çŸ­æœŸè®°å¿†ç³»ç»Ÿæœ€åå¤„ç†çš„æ¶ˆæ¯åºåˆ—å·ï¼Œç”¨äºé¿å…é‡å¤å¤„ç†å†å²å†…å®¹'
                    };
                    
                    return await QQ_SafeSaveToWorldBook('åºåˆ—å·çŠ¶æ€', data, comment);
                } catch (error) {
                    console.error('âŒ ä¿å­˜åºåˆ—å·çŠ¶æ€å¤±è´¥:', error);
                    return false;
                }
            }
            
            // *** æ–°å¢ï¼šå½“å‰å›å¤æ¶ˆæ¯ä¿æŠ¤æœºåˆ¶ ***
            let QQ_CurrentReplyMessages = new Set(); // å­˜å‚¨å½“å‰AIå›å¤çš„æ¶ˆæ¯IDï¼Œç¡®ä¿ä¸è¢«åˆ é™¤
            
            // *** æ–°å¢ï¼šä¼šè¯å¼€å§‹æ ‡è®°ï¼Œç”¨äºåŒºåˆ†å†å²æ¶ˆæ¯å’Œæ–°æ¶ˆæ¯ ***
            let QQ_SessionStarted = false; // æ ‡è®°ç”¨æˆ·æ˜¯å¦å·²ç»å¼€å§‹å‘é€æ¶ˆæ¯
            
            /**
             * ä¸ºæ¶ˆæ¯è·å–ä¸‹ä¸€ä¸ªåºåˆ—å·ï¼ˆç”¨äºä¿è¯é€»è¾‘é¡ºåºï¼‰
             * @return {number} ä¸¥æ ¼é€’å¢çš„åºåˆ—å·
             */
            function QQ_GetNextMessageId() {
                const id = QQ_MessageSequence.next();
                console.log(`ğŸ  åˆ†é…æ¶ˆæ¯åºåˆ—å·: ${id}`);
                return id;
            }
            
            /**
             * ä»æ¶ˆæ¯å­—ç¬¦ä¸²ä¸­æå–æˆ–ç”Ÿæˆåºåˆ—å·
             * @param {string} messageStr - æ¶ˆæ¯å­—ç¬¦ä¸²
             * @return {object} {sequenceId: number, cleanMessage: string}
             */
            function QQ_ExtractOrGenerateSequenceId(messageStr, shouldGenerate = false) {
                // å°è¯•ä»æ¶ˆæ¯æœ«å°¾æå–åºåˆ—å·ï¼ˆæ ¼å¼ï¼š##seq_12345##ï¼‰
                const sequenceRegex = /##seq_(\d+)##$/;
                const match = messageStr.match(sequenceRegex);
                
                if (match) {
                    const sequenceId = parseInt(match[1], 10);
                    const cleanMessage = messageStr.replace(sequenceRegex, '');
                    return { sequenceId, cleanMessage };
                } else {
                    // åªæœ‰æ˜ç¡®è¦æ±‚æ—¶æ‰ç”Ÿæˆæ–°åºåˆ—å·
                    if (shouldGenerate) {
                        const sequenceId = QQ_GetNextMessageId();
                        return { sequenceId, cleanMessage: messageStr };
                    } else {
                        // æ²¡æœ‰åºåˆ—å·ä¸”ä¸è¦æ±‚ç”Ÿæˆæ—¶ï¼Œè¿”å›ä¸€ä¸ªä¸´æ—¶æ ‡è¯†
                        return { sequenceId: 0, cleanMessage: messageStr };
                    }
                }
            }
            
            /**
             * ä¸ºæ¶ˆæ¯å­—ç¬¦ä¸²æ·»åŠ åºåˆ—å·
             * @param {string} messageStr - æ¶ˆæ¯å­—ç¬¦ä¸² 
             * @param {number} sequenceId - åºåˆ—å·
             * @return {string} å¸¦æœ‰åºåˆ—å·çš„æ¶ˆæ¯å­—ç¬¦ä¸²
             */
            function QQ_AddSequenceIdToMessage(messageStr, sequenceId) {
                return `${messageStr}##seq_${sequenceId}##`;
            }

            // *** æ–°å¢ï¼šæµå¼ä¼ è¾“é˜Ÿåˆ—ç®¡ç†å‡½æ•° ***
            
            /**
             * å°†æ¶ˆæ¯ä»»åŠ¡æ·»åŠ åˆ°æµå¼ä¼ è¾“é˜Ÿåˆ—
             * @param {Object} task - æµå¼ä¼ è¾“ä»»åŠ¡ 
             * @param {Function} task.handler - å¤„ç†å‡½æ•°
             * @param {Array} task.args - å‚æ•°æ•°ç»„
             * @param {string} task.description - ä»»åŠ¡æè¿°
             * @param {string} task.chatName - èŠå¤©åç§°ï¼ˆæ–°å¢ï¼šç”¨äºå¹¶è¡Œå¤„ç†ï¼‰
             */
            function QQ_EnqueueStreamingTask(task) {
                // ä¸ºä»»åŠ¡æ·»åŠ æ—¶é—´æˆ³
                task.timestamp = Date.now();
                
                // ä»ä»»åŠ¡æè¿°ä¸­æå–èŠå¤©åç§°
                let chatName = task.chatName;
                if (!chatName && task.description) {
                    // å°è¯•ä»æè¿°ä¸­æå–èŠå¤©åç§°
                    const match = task.description.match(/ç§èŠ(.+?)æµå¼æ˜¾ç¤º|ç¾¤èŠ(.+?)æµå¼æ˜¾ç¤º|ä¸»åŠ¨æ¶ˆæ¯æµå¼æ˜¾ç¤º: (.+)/);
                    if (match) {
                        chatName = match[1] || match[2] || match[3];
                    }
                }
                
                if (!chatName) {
                    console.warn('âš ï¸ æ— æ³•ç¡®å®šèŠå¤©åç§°ï¼Œä½¿ç”¨é»˜è®¤é˜Ÿåˆ—');
                    chatName = '__default__';
                }
                
                // è·å–è¯¥èŠå¤©çš„çŠ¶æ€
                const chatState = getStreamingState(chatName);
                
                // å°†ä»»åŠ¡æ·»åŠ åˆ°å¯¹åº”èŠå¤©çš„é˜Ÿåˆ—
                if (task.priority === 'high') {
                    chatState.queue.unshift(task);
                    console.log(`ğŸš€ é«˜ä¼˜å…ˆçº§ä»»åŠ¡å·²åŠ å…¥${chatName}çš„é˜Ÿåˆ—å‰ç«¯: ${task.description}, é˜Ÿåˆ—é•¿åº¦: ${chatState.queue.length}`);
                } else {
                    chatState.queue.push(task);
                    console.log(`ğŸ“¥ ä»»åŠ¡å·²åŠ å…¥${chatName}çš„é˜Ÿåˆ—: ${task.description}, é˜Ÿåˆ—é•¿åº¦: ${chatState.queue.length}`);
                }
                
                // å¢å¼ºè°ƒè¯•ï¼šè¾“å‡ºå½“å‰èŠå¤©çŠ¶æ€
                console.log(`ğŸ” ${chatName}èŠå¤©çŠ¶æ€: isActive=${chatState.isActive}, é˜Ÿåˆ—é•¿åº¦=${chatState.queue.length}, å¼€å§‹æ—¶é—´=${chatState.startTime}`);
                
                // å¢å¼ºè°ƒè¯•ï¼šè¾“å‡ºæ‰€æœ‰æ´»è·ƒçš„æµå¼ä¼ è¾“çŠ¶æ€
                const activeChats = [];
                const generatingChats = [];
                for (const [name, state] of streamingChatStates) {
                    if (state.isActive) {
                        activeChats.push(name);
                    }
                    if (state.isGenerating) {
                        generatingChats.push(name);
                    }
                }
                if (activeChats.length > 0) {
                    console.log(`ğŸ¯ å½“å‰æ´»è·ƒçš„æµå¼ä¼ è¾“èŠå¤©: ${activeChats.join(', ')}`);
                } else {
                    console.log(`âœ… å½“å‰æ²¡æœ‰æ´»è·ƒçš„æµå¼ä¼ è¾“èŠå¤©`);
                }
                if (generatingChats.length > 0) {
                    console.log(`ğŸ”„ å½“å‰æ­£åœ¨ç”Ÿæˆçš„èŠå¤©: ${generatingChats.join(', ')}`);
                }
                
                // æ£€æŸ¥è¯¥èŠå¤©æ˜¯å¦æœ‰å¡ä½çš„ä»»åŠ¡ï¼ˆè¶…è¿‡10ç§’è¿˜åœ¨å¤„ç†ï¼‰
                if (chatState.isActive && chatState.startTime && 
                    Date.now() - chatState.startTime > 10000) {
                    console.warn(`âš ï¸ æ£€æµ‹åˆ°${chatName}çš„æµå¼ä¼ è¾“å¯èƒ½å¡ä½ï¼Œå¼ºåˆ¶é‡ç½®`);
                    console.warn(`ğŸ” ${chatName}é˜Ÿåˆ—é•¿åº¦: ${chatState.queue.length}, å¡ä½æ—¶é—´: ${Date.now() - chatState.startTime}ms`);
                    chatState.isActive = false;
                    chatState.startTime = null;
                    
                    // å¼ºåˆ¶é‡ç½®åç«‹å³å°è¯•å¤„ç†è¯¥èŠå¤©çš„é˜Ÿåˆ—
                    setTimeout(() => {
                        console.warn(`ğŸ”„ å¼ºåˆ¶é‡ç½®åé‡æ–°å¯åŠ¨${chatName}çš„é˜Ÿåˆ—å¤„ç†`);
                        QQ_ProcessStreamingQueueForChat(chatName);
                    }, 100);
                }
                
                // é«˜ä¼˜å…ˆçº§ä»»åŠ¡ä¸”é˜Ÿåˆ—å¡ä½æ—¶ï¼Œå¼ºåˆ¶ç«‹å³æ‰§è¡Œ
                if (task.priority === 'high' && chatState.isActive) {
                    console.warn(`ğŸ”¥ ${chatName}çš„é«˜ä¼˜å…ˆçº§AIå›å¤ä»»åŠ¡ï¼Œå¼ºåˆ¶ç«‹å³æ‰§è¡Œ`);
                    chatState.isActive = false;
                    chatState.startTime = null;  // ç¡®ä¿çŠ¶æ€ä¸€è‡´æ€§
                }
                
                // å¦‚æœè¯¥èŠå¤©å½“å‰æ²¡æœ‰æµå¼ä¼ è¾“åœ¨è¿›è¡Œï¼Œç«‹å³å¤„ç†å…¶é˜Ÿåˆ—
                if (!chatState.isActive) {
                    QQ_ProcessStreamingQueueForChat(chatName);
                }
            }

            /**
             * å¤„ç†æŒ‡å®šèŠå¤©çš„æµå¼ä¼ è¾“é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªä»»åŠ¡
             * @param {string} chatName - èŠå¤©åç§°
             */
            function QQ_ProcessStreamingQueueForChat(chatName) {
                const chatState = getStreamingState(chatName);
                
                if (chatState.queue.length === 0) {
                    console.log(`ğŸ“‹ ${chatName}çš„é˜Ÿåˆ—ä¸ºç©ºï¼Œåœæ­¢å¤„ç†`);
                    return;
                }
                
                if (chatState.isActive) {
                    console.log(`â³ ${chatName}æœ‰ä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œç­‰å¾…å®Œæˆ...`);
                    return;
                }
                
                const task = chatState.queue.shift();
                console.log(`ğŸ“¤ å¼€å§‹å¤„ç†${chatName}çš„é˜Ÿåˆ—ä»»åŠ¡: ${task.description}, å‰©ä½™é˜Ÿåˆ—é•¿åº¦: ${chatState.queue.length}`);
                
                // å¢å¼ºè°ƒè¯•ï¼šè¾“å‡ºä»»åŠ¡å¤„ç†å‰çš„çŠ¶æ€
                console.log(`ğŸ”§ å¤„ç†å‰${chatName}çŠ¶æ€: isActive=${chatState.isActive}, å¼€å§‹æ—¶é—´=${chatState.startTime}, ä»»åŠ¡ç±»å‹=${task.priority || 'normal'}`);
                
                // è®¾ç½®é”å¹¶è®°å½•å¼€å§‹æ—¶é—´
                chatState.isActive = true;
                chatState.startTime = Date.now();
                
                // å¢å¼ºè°ƒè¯•ï¼šè¾“å‡ºä»»åŠ¡å¤„ç†å¼€å§‹çš„çŠ¶æ€
                console.log(`ğŸš€ ${chatName}å¼€å§‹å¤„ç†æµå¼ä»»åŠ¡ï¼Œè®¾ç½®é”å®šçŠ¶æ€: isActive=${chatState.isActive}, å¼€å§‹æ—¶é—´=${chatState.startTime}`);
                
                // æ‰§è¡Œä»»åŠ¡
                task.handler(...task.args).then(() => {
                    // ä»»åŠ¡å®Œæˆåè§£é”å¹¶å¤„ç†ä¸‹ä¸€ä¸ªä»»åŠ¡
                    console.log(`âœ… ${chatName}çš„é˜Ÿåˆ—ä»»åŠ¡å®Œæˆ: ${task.description}`);
                    console.log(`ğŸ”“ ${chatName}è§£é”çŠ¶æ€: isActive=${chatState.isActive} -> false, å¼€å§‹æ—¶é—´=${chatState.startTime} -> null`);
                    
                    chatState.isActive = false;
                    chatState.startTime = null;
                    
                    // å¢å¼ºè°ƒè¯•ï¼šè¾“å‡ºå½“å‰é˜Ÿåˆ—çŠ¶æ€
                    console.log(`ğŸ“Š ${chatName}ä»»åŠ¡å®ŒæˆåçŠ¶æ€: é˜Ÿåˆ—é•¿åº¦=${chatState.queue.length}, ä¸‹ä¸€ä¸ªä»»åŠ¡å°†åœ¨100msåå¤„ç†`);
                    
                    // å¤„ç†è¯¥èŠå¤©é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªä»»åŠ¡ï¼ˆä¼˜åŒ–ï¼šä½¿ç”¨æ›´åˆç†çš„å»¶è¿Ÿï¼‰
                    if (chatState.queue.length > 0) {
                        chatState.currentProcess = setTimeout(() => QQ_ProcessStreamingQueueForChat(chatName), 200);
                    }
                }).catch((error) => {
                    console.error(`âŒ ${chatName}çš„é˜Ÿåˆ—ä»»åŠ¡å¤±è´¥: ${task.description}`, error);
                    console.log(`ğŸ”“ ${chatName}å¤±è´¥åè§£é”çŠ¶æ€: isActive=${chatState.isActive} -> false, å¼€å§‹æ—¶é—´=${chatState.startTime} -> null`);
                    
                    chatState.isActive = false;
                    chatState.startTime = null;
                    
                    // å¢å¼ºè°ƒè¯•ï¼šè¾“å‡ºå¤±è´¥åçš„é˜Ÿåˆ—çŠ¶æ€
                    console.log(`ğŸ“Š ${chatName}ä»»åŠ¡å¤±è´¥åçŠ¶æ€: é˜Ÿåˆ—é•¿åº¦=${chatState.queue.length}, ä¸‹ä¸€ä¸ªä»»åŠ¡å°†åœ¨500msåå¤„ç†`);
                    
                    // å³ä½¿å¤±è´¥ä¹Ÿè¦å¤„ç†ä¸‹ä¸€ä¸ªä»»åŠ¡ï¼ˆä¼˜åŒ–ï¼šæ£€æŸ¥é˜Ÿåˆ—é•¿åº¦å¹¶ä½¿ç”¨æ›´åˆç†çš„å»¶è¿Ÿï¼‰
                    if (chatState.queue.length > 0) {
                        chatState.currentProcess = setTimeout(() => QQ_ProcessStreamingQueueForChat(chatName), 800);
                    }
                });
            }
            
            /**
             * å¤„ç†æµå¼ä¼ è¾“é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªä»»åŠ¡ï¼ˆå‘åå…¼å®¹ï¼‰
             */
            function QQ_ProcessStreamingQueue() {
                // ä¸ºäº†å‘åå…¼å®¹ï¼Œå¤„ç†æ‰€æœ‰èŠå¤©çš„é˜Ÿåˆ—
                for (const [chatName, chatState] of streamingChatStates) {
                    if (chatState.queue.length > 0 && !chatState.isActive) {
                        QQ_ProcessStreamingQueueForChat(chatName);
                    }
                }
            }

            /**
             * å–æ¶ˆå½“å‰æµå¼ä¼ è¾“å¹¶æ¸…ç©ºé˜Ÿåˆ—ï¼ˆç´§æ€¥æƒ…å†µä½¿ç”¨ï¼‰
             */
            function QQ_CancelAllStreaming() {
                console.log('ğŸš« å–æ¶ˆæ‰€æœ‰æµå¼ä¼ è¾“ä»»åŠ¡');
                
                // æ¸…ç©ºæ‰€æœ‰èŠå¤©çš„é˜Ÿåˆ—å’ŒçŠ¶æ€
                for (const [chatName, chatState] of streamingChatStates) {
                    chatState.isActive = false;
                    chatState.startTime = null;
                    chatState.queue.length = 0;
                    chatState.isGenerating = false;
                    chatState.lastGenerationTime = null;
                    
                    // æ¸…ç©ºè¯¥èŠå¤©çš„ç‹¬ç«‹æµå¼ä¼ è¾“è¿›ç¨‹
                    if (chatState.currentProcess) {
                        clearTimeout(chatState.currentProcess);
                        chatState.currentProcess = null;
                    }
                    
                    // æ¸…ç©ºè¾“å…¥æŒ‡ç¤ºå™¨ç›¸å…³èµ„æº
                    if (chatState.typingIndicator) {
                        QQ_HideTypingIndicator(chatState.typingIndicator);
                        chatState.typingIndicator = null;
                    }
                    
                    if (chatState.typingTimeout) {
                        clearTimeout(chatState.typingTimeout);
                        chatState.typingTimeout = null;
                    }
                    
                    console.log(`ğŸ§¹ å·²æ¸…ç©º${chatName}çš„æµå¼ä¼ è¾“é˜Ÿåˆ—å’Œç›¸å…³èµ„æº`);
                }
                
                // æ¸…ç©ºå…¨å±€é˜Ÿåˆ—ï¼ˆå‘åå…¼å®¹ï¼‰
                streamingMessageQueue.length = 0;
                
                // æ¸…ç©ºå…¨å±€æµå¼ä¼ è¾“è¿›ç¨‹ï¼ˆå‘åå…¼å®¹ï¼‰
                if (currentStreamingProcess) {
                    clearTimeout(currentStreamingProcess);
                    currentStreamingProcess = null;
                }
            }
            
            /**
             * å–æ¶ˆæŒ‡å®šèŠå¤©çš„æµå¼ä¼ è¾“
             * @param {string} chatName - èŠå¤©åç§°
             */
            function QQ_CancelStreamingForChat(chatName) {
                const chatState = getStreamingState(chatName);
                console.log(`ğŸš« å–æ¶ˆ${chatName}çš„æµå¼ä¼ è¾“ä»»åŠ¡`);
                
                chatState.isActive = false;
                chatState.startTime = null;
                chatState.queue.length = 0;
                chatState.isGenerating = false;
                chatState.lastGenerationTime = null;
                
                // æ¸…ç©ºè¯¥èŠå¤©çš„ç‹¬ç«‹æµå¼ä¼ è¾“è¿›ç¨‹
                if (chatState.currentProcess) {
                    clearTimeout(chatState.currentProcess);
                    chatState.currentProcess = null;
                }
                
                // æ¸…ç©ºè¾“å…¥æŒ‡ç¤ºå™¨ç›¸å…³èµ„æº
                if (chatState.typingIndicator) {
                    QQ_HideTypingIndicator(chatState.typingIndicator);
                    chatState.typingIndicator = null;
                }
                
                if (chatState.typingTimeout) {
                    clearTimeout(chatState.typingTimeout);
                    chatState.typingTimeout = null;
                }
            }

            // *** æ–°å¢ï¼šå·²è¯»çŠ¶æ€ç®¡ç†åŠŸèƒ½ ***
            const QQ_READ_STATUS_KEY = "QQ_å·²è¯»çŠ¶æ€å¤‡ä»½";

            /**
             * ä¿å­˜å·²è¯»çŠ¶æ€åˆ°ä¸–ç•Œä¹¦
             */
            async function QQ_SaveReadStatus() {
                try {
                    if (!worldbook || !entries) {
                        console.warn('QQ_SaveReadStatus: worldbookæœªåˆå§‹åŒ–');
                        return;
                    }
                    
                    const readStatusData = {
                        lastUpdate: Date.now(),
                        ç§èŠ: {},
                        ç¾¤èŠ: {},
                        åŠ¨æ€: QQ_ReadStatus.moment || 0
                    };
                    
                    // ä¿å­˜ç§èŠå·²è¯»çŠ¶æ€
                    for (const [name, data] of Object.entries(QQ_ReadStatus)) {
                        if (name === 'moment') continue;
                        
                        if (QQ_msgjson.ç§èŠ[name]) {
                            readStatusData.ç§èŠ[name] = {
                                lastReadTime: data.lastReadTime || 0,
                                lastReadIndex: data.lastReadIndex || 0
                            };
                        } else if (QQ_msgjson.ç¾¤èŠ[name]) {
                            readStatusData.ç¾¤èŠ[name] = {
                                lastReadTime: data.lastReadTime || 0,
                                lastReadIndex: data.lastReadIndex || 0
                            };
                        }
                    }
                    
                    // æŸ¥æ‰¾æˆ–åˆ›å»ºå·²è¯»çŠ¶æ€æ¡ç›®
                    let readStatusEntry = entries.find(entry => 
                        entry.keys && Array.isArray(entry.keys) && entry.keys.includes(QQ_READ_STATUS_KEY)
                    );
                    
                    if (readStatusEntry) {
                        readStatusEntry.content = JSON.stringify(readStatusData, null, 2);
                    } else {
                        const newEntry = {
                            keys: [QQ_READ_STATUS_KEY],
                            content: JSON.stringify(readStatusData, null, 2),
                            enabled: true,
                            constant: true,
                            comment: "æ‰‹æœºç•Œé¢å·²è¯»çŠ¶æ€å¤‡ä»½ - è‡ªåŠ¨ç”Ÿæˆ",
                            depth: 0,
                            selectiveLogic: 0,
                            order: 9999
                        };
                        entries.push(newEntry);
                    }
                    
                    // ä¿å­˜åˆ°ä¸–ç•Œä¹¦
                    await QQ_SafeSaveWorldInfo("å·²è¯»çŠ¶æ€æ•°æ®");
                    console.log('å·²è¯»çŠ¶æ€å·²ä¿å­˜åˆ°ä¸–ç•Œä¹¦');
                    
                } catch (error) {
                    console.error('ä¿å­˜å·²è¯»çŠ¶æ€å¤±è´¥:', error);
                }
            }

            /**
             * ä»ä¸–ç•Œä¹¦åŠ è½½å·²è¯»çŠ¶æ€
             */
            async function QQ_LoadReadStatus() {
                try {
                    if (!worldbook || !entries) {
                        console.warn('QQ_LoadReadStatus: worldbookæœªåˆå§‹åŒ–');
                        return;
                    }
                    
                    const readStatusEntry = entries.find(entry => 
                        entry.keys && Array.isArray(entry.keys) && entry.keys.includes(QQ_READ_STATUS_KEY)
                    );
                    
                    if (readStatusEntry && readStatusEntry.content) {
                        const readStatusData = JSON.parse(readStatusEntry.content);
                        
                        // æ¢å¤å·²è¯»çŠ¶æ€
                        QQ_ReadStatus = {
                            moment: readStatusData.åŠ¨æ€ || 0
                        };
                        
                        // æ¢å¤ç§èŠå·²è¯»çŠ¶æ€
                        for (const [name, data] of Object.entries(readStatusData.ç§èŠ || {})) {
                            QQ_ReadStatus[name] = {
                                lastReadTime: data.lastReadTime || 0,
                                lastReadIndex: data.lastReadIndex || 0
                            };
                        }
                        
                        // æ¢å¤ç¾¤èŠå·²è¯»çŠ¶æ€
                        for (const [name, data] of Object.entries(readStatusData.ç¾¤èŠ || {})) {
                            QQ_ReadStatus[name] = {
                                lastReadTime: data.lastReadTime || 0,
                                lastReadIndex: data.lastReadIndex || 0
                            };
                        }
                        
                        console.log('å·²è¯»çŠ¶æ€å·²ä»ä¸–ç•Œä¹¦åŠ è½½:', Object.keys(QQ_ReadStatus).length);
                    } else {
                        console.log('æœªæ‰¾åˆ°å·²è¯»çŠ¶æ€å¤‡ä»½ï¼Œä½¿ç”¨é»˜è®¤çŠ¶æ€');
                        QQ_ReadStatus = { moment: 0 };
                    }
                    
                } catch (error) {
                    console.error('åŠ è½½å·²è¯»çŠ¶æ€å¤±è´¥:', error);
                    QQ_ReadStatus = { moment: 0 };
                }
            }

            /**
             * æ ‡è®°èŠå¤©ä¸ºå·²è¯» - å¢å¼ºç‰ˆæœ¬ï¼Œæ”¯æŒStage 2ä¸Šä¸‹æ–‡æ„ŸçŸ¥ç³»ç»Ÿ
             */
            function QQ_MarkAsRead(chatName, chatType = 'auto') {
                try {
                    if (!QQ_ReadStatus[chatName]) {
                        QQ_ReadStatus[chatName] = {};
                    }
                    
                    const currentTime = Date.now();
                    const readTimestamp = new Date().toISOString();
                    
                    // è®°å½•åŸºç¡€å·²è¯»çŠ¶æ€
                    QQ_ReadStatus[chatName].lastReadTime = currentTime;
                    
                    // *** Stage 2å¢å¼ºï¼šæ”¶é›†è¯»å–äº‹ä»¶çš„è¯¦ç»†ä¸Šä¸‹æ–‡ä¿¡æ¯ ***
                    let readEventData = {
                        chatName: chatName,
                        chatType: chatType,
                        readTime: readTimestamp,
                        userName: UserName || 'ç”¨æˆ·',
                        unreadCount: 0,
                        lastMessages: [],
                        readContext: {}
                    };
                    
                    // *** ä¿®å¤ï¼šæ ¹æ®èŠå¤©ç±»å‹è®¾ç½®å·²è¯»ç´¢å¼•å¹¶æ”¶é›†æ¶ˆæ¯ä¸Šä¸‹æ–‡ ***
                    if (chatType === 'auto') {
                        // å…ˆæŸ¥æ‰¾ç§èŠ
                        const privateChatKey = Object.keys(QQ_msgjson.ç§èŠ).find(key => 
                            key.includes(chatName) && key.includes(UserName)
                        );
                        
                        if (privateChatKey && QQ_msgjson.ç§èŠ[privateChatKey]) {
                            const messages = QQ_msgjson.ç§èŠ[privateChatKey];
                            const previousReadIndex = QQ_ReadStatus[chatName].lastReadIndex || 0;
                            
                            QQ_ReadStatus[chatName].lastReadIndex = messages.length;
                            readEventData.chatType = 'private';
                            readEventData.unreadCount = Math.max(0, messages.length - previousReadIndex);
                            
                            // *** Stage 2å¢å¼ºï¼šæ”¶é›†æœ€è¿‘çš„æœªè¯»æ¶ˆæ¯ä¸Šä¸‹æ–‡ ***
                            if (readEventData.unreadCount > 0) {
                                const unreadMessages = messages.slice(previousReadIndex).slice(-3); // æœ€å3æ¡æœªè¯»æ¶ˆæ¯
                                readEventData.lastMessages = unreadMessages.map(msg => ({
                                    sender: msg.name || 'æœªçŸ¥',
                                    content: (msg.mes || '').substring(0, 50) + (msg.mes && msg.mes.length > 50 ? '...' : ''),
                                    timestamp: msg.send_date || readTimestamp,
                                    isUser: msg.is_user || false
                                }));
                            }
                            
                            readEventData.readContext = {
                                totalMessages: messages.length,
                                previousReadIndex: previousReadIndex,
                                newReadIndex: messages.length,
                                readDuration: QQ_ReadStatus[chatName].lastReadTime ? 
                                    currentTime - QQ_ReadStatus[chatName].lastReadTime : 0
                            };
                            
                            console.log(`ç§èŠ ${chatName} å·²è¯»ç´¢å¼•è®¾ç½®ä¸º: ${QQ_ReadStatus[chatName].lastReadIndex}`);
                            
                        } else if (QQ_msgjson.ç¾¤èŠ[chatName] && QQ_msgjson.ç¾¤èŠ[chatName].msgs) {
                            const messages = QQ_msgjson.ç¾¤èŠ[chatName].msgs;
                            const previousReadIndex = QQ_ReadStatus[chatName].lastReadIndex || 0;
                            
                            QQ_ReadStatus[chatName].lastReadIndex = messages.length;
                            readEventData.chatType = 'group';
                            readEventData.unreadCount = Math.max(0, messages.length - previousReadIndex);
                            
                            // *** Stage 2å¢å¼ºï¼šæ”¶é›†ç¾¤èŠæœªè¯»æ¶ˆæ¯ä¸Šä¸‹æ–‡ ***
                            if (readEventData.unreadCount > 0) {
                                const unreadMessages = messages.slice(previousReadIndex).slice(-5); // ç¾¤èŠå–æœ€å5æ¡æœªè¯»æ¶ˆæ¯
                                readEventData.lastMessages = unreadMessages.map(msg => ({
                                    sender: msg.name || 'æœªçŸ¥',
                                    content: (msg.mes || '').substring(0, 50) + (msg.mes && msg.mes.length > 50 ? '...' : ''),
                                    timestamp: msg.send_date || readTimestamp,
                                    isUser: msg.is_user || false
                                }));
                            }
                            
                            readEventData.readContext = {
                                totalMessages: messages.length,
                                previousReadIndex: previousReadIndex,
                                newReadIndex: messages.length,
                                groupMembers: QQ_msgjson.ç¾¤èŠ[chatName].members || [],
                                readDuration: QQ_ReadStatus[chatName].lastReadTime ? 
                                    currentTime - QQ_ReadStatus[chatName].lastReadTime : 0
                            };
                            
                            console.log(`ç¾¤èŠ ${chatName} å·²è¯»ç´¢å¼•è®¾ç½®ä¸º: ${QQ_ReadStatus[chatName].lastReadIndex}`);
                        }
                    }
                    
                    // æ¸…é™¤çº¢ç‚¹
                    QQ_NewMsg[chatName] = 0;
                    QQ_SetHomeTips(chatName, 0);
                    
                    // *** Stage 2å¢å¼ºï¼šè®°å½•è¯»å–äº‹ä»¶åˆ°ç³»ç»Ÿäº‹ä»¶é˜Ÿåˆ— ***
                    if (readEventData.unreadCount > 0) {
                        // åªæœ‰å½“ç¡®å®æœ‰æœªè¯»æ¶ˆæ¯è¢«æ ‡è®°ä¸ºå·²è¯»æ—¶æ‰è®°å½•äº‹ä»¶
                        QQ_AddSystemEvent(QQ_SystemEventTypes.MESSAGE_READ, {
                            ...readEventData,
                            eventId: `read_${chatName}_${currentTime}`,
                            stage2Context: {
                                readReceiptGenerated: true,
                                contextAware: true,
                                detailedReadInfo: true
                            }
                        });
                        
                        console.log(`ğŸ“– Stage 2è¯»å–äº‹ä»¶å·²è®°å½•: ${chatName}, æœªè¯»æ¶ˆæ¯æ•°: ${readEventData.unreadCount}`);
                    }
                    
                    console.log(`${chatName} å·²æ ‡è®°ä¸ºå·²è¯»ï¼Œå·²è¯»çŠ¶æ€:`, QQ_ReadStatus[chatName]);
                    
                    // *** Stage 2å¢å¼ºï¼šå¼‚æ­¥ä¿å­˜è¯»å–äº‹ä»¶åˆ°ä¸–ç•Œä¹¦ç”¨äºé•¿æœŸä¸Šä¸‹æ–‡è®°å¿† ***
                    setTimeout(() => {
                        QQ_SaveReadStatus();
                        
                        // ä¿å­˜è¯¦ç»†çš„è¯»å–äº‹ä»¶è®°å½•
                        if (readEventData.unreadCount > 0) {
                            QQ_SafeSaveToWorldBook('è¯»å–äº‹ä»¶è®°å½•', {
                                ...readEventData,
                                stage2Enhanced: true,
                                savedAt: new Date().toISOString()
                            }, 'QQ_è¯»å–äº‹ä»¶è®°å½•');
                        }
                    }, 1000);
                    
                } catch (error) {
                    console.error('æ ‡è®°å·²è¯»çŠ¶æ€å¤±è´¥:', error);
                }
            }

            /**
             * *** Stage 2å¢å¼ºï¼šè¯»å–äº‹ä»¶åˆ†æå’Œè°ƒè¯•å·¥å…· ***
             * ç”¨äºåˆ†æå’Œç›‘æ§è¯»å–äº‹ä»¶çš„è¯¦ç»†ä¿¡æ¯
             */
            function QQ_AnalyzeReadEvents(chatName = null, limit = 10) {
                try {
                    const allEvents = window.QQ_SystemContext?.systemEvents || [];
                    let readEvents = allEvents.filter(event => 
                        event.type === QQ_SystemEventTypes.MESSAGE_READ &&
                        (!chatName || event.data.chatName === chatName)
                    );
                    
                    // æŒ‰æ—¶é—´æ’åºï¼Œæœ€æ–°çš„åœ¨å‰
                    readEvents.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    // é™åˆ¶è¿”å›æ•°é‡
                    if (limit > 0) {
                        readEvents = readEvents.slice(0, limit);
                    }
                    
                    const analysis = {
                        totalReadEvents: readEvents.length,
                        chatFilter: chatName,
                        stage2Enhanced: readEvents.filter(e => e.data.stage2Context?.detailedReadInfo).length,
                        traditionalEvents: readEvents.filter(e => !e.data.stage2Context?.detailedReadInfo).length,
                        recentEvents: readEvents.map(event => ({
                            timestamp: event.timestamp,
                            chatName: event.data.chatName,
                            chatType: event.data.chatType,
                            unreadCount: event.data.unreadCount || 0,
                            isStage2Enhanced: Boolean(event.data.stage2Context?.detailedReadInfo),
                            lastMessageSender: event.data.lastMessages?.[event.data.lastMessages.length - 1]?.sender
                        }))
                    };
                    
                    console.log('ğŸ“Š è¯»å–äº‹ä»¶åˆ†æç»“æœ:', analysis);
                    return analysis;
                    
                } catch (error) {
                    console.error('åˆ†æè¯»å–äº‹ä»¶å¤±è´¥:', error);
                    return null;
                }
            }

            /**
             * *** Stage 2å¢å¼ºï¼šè¯»å–äº‹ä»¶ç»Ÿè®¡å·¥å…· ***
             * æä¾›è¯»å–è¡Œä¸ºçš„ç»Ÿè®¡ä¿¡æ¯
             */
            function QQ_GetReadStatistics(timeRange = 24) { // é»˜è®¤24å°æ—¶å†…
                try {
                    const cutoffTime = Date.now() - (timeRange * 60 * 60 * 1000);
                    const allEvents = window.QQ_SystemContext?.systemEvents || [];
                    
                    const recentReadEvents = allEvents.filter(event => 
                        event.type === QQ_SystemEventTypes.MESSAGE_READ &&
                        new Date(event.timestamp).getTime() > cutoffTime
                    );
                    
                    const stats = {
                        timeRangeHours: timeRange,
                        totalReadEvents: recentReadEvents.length,
                        privateChats: {},
                        groupChats: {},
                        totalUnreadProcessed: 0,
                        stage2EnhancedEvents: 0
                    };
                    
                    recentReadEvents.forEach(event => {
                        const data = event.data;
                        stats.totalUnreadProcessed += data.unreadCount || 0;
                        
                        if (data.stage2Context?.detailedReadInfo) {
                            stats.stage2EnhancedEvents++;
                        }
                        
                        if (data.chatType === 'private') {
                            if (!stats.privateChats[data.chatName]) {
                                stats.privateChats[data.chatName] = { readEvents: 0, unreadProcessed: 0 };
                            }
                            stats.privateChats[data.chatName].readEvents++;
                            stats.privateChats[data.chatName].unreadProcessed += data.unreadCount || 0;
                        } else if (data.chatType === 'group') {
                            if (!stats.groupChats[data.chatName]) {
                                stats.groupChats[data.chatName] = { readEvents: 0, unreadProcessed: 0 };
                            }
                            stats.groupChats[data.chatName].readEvents++;
                            stats.groupChats[data.chatName].unreadProcessed += data.unreadCount || 0;
                        }
                    });
                    
                    console.log(`ğŸ“ˆ æœ€è¿‘${timeRange}å°æ—¶è¯»å–ç»Ÿè®¡:`, stats);
                    return stats;
                    
                } catch (error) {
                    console.error('è·å–è¯»å–ç»Ÿè®¡å¤±è´¥:', error);
                    return null;
                }
            }

            /**
             * æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦ä¸ºç³»ç»Ÿåˆå§‹æ¶ˆæ¯
             */
            function QQ_IsInitialSystemMessage(message) {
                if (!message.startsWith('ç³»ç»Ÿæ¶ˆæ¯--')) {
                    return false;
                }
                
                const content = message.split('--')[1];
                if (!content) return false;
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºåˆå§‹ç³»ç»Ÿæ¶ˆæ¯
                return content.includes('åˆ›å»ºæˆåŠŸ') || 
                       content.includes('åŠ å…¥äº†ç¾¤èŠ') || 
                       /^\d{2}:\d{2}$/.test(content); // æ—¶é—´æ¶ˆæ¯
            }

            /**
             * è®¡ç®—æœªè¯»æ¶ˆæ¯æ•°é‡ï¼ˆæ’é™¤åˆå§‹ç³»ç»Ÿæ¶ˆæ¯ï¼‰
             */
            function QQ_CalculateUnreadCount(chatName, messages, chatType = 'private') {
                try {
                    if (!messages || messages.length === 0) {
                        return 0;
                    }
                    
                    const readStatus = QQ_ReadStatus[chatName];
                    let unreadCount = 0;
                    
                    // å¦‚æœæ²¡æœ‰å·²è¯»è®°å½•ï¼Œæ‰€æœ‰éåˆå§‹ç³»ç»Ÿæ¶ˆæ¯éƒ½ç®—æœªè¯»
                    if (!readStatus || !readStatus.lastReadIndex) {
                        console.log(`${chatName} æ²¡æœ‰å·²è¯»è®°å½•ï¼Œè®¡ç®—æ‰€æœ‰æœªè¯»æ¶ˆæ¯`);
                        for (const msg of messages) {
                            // è·³è¿‡åˆå§‹ç³»ç»Ÿæ¶ˆæ¯
                            if (QQ_IsInitialSystemMessage(msg)) {
                                continue;
                            }
                            
                            // æ£€æŸ¥æ˜¯å¦ä¸ºç”¨æˆ·è‡ªå·±å‘é€çš„æ¶ˆæ¯
                            const parts = msg.split('--');
                            if (parts.length >= 2 && parts[0] === `${UserName}`) {
                                continue; // è·³è¿‡ç”¨æˆ·è‡ªå·±çš„æ¶ˆæ¯
                            }
                            
                            unreadCount++;
                        }
                        console.log(`${chatName} è®¡ç®—ç»“æœ: ${unreadCount} æ¡æœªè¯»æ¶ˆæ¯`);
                        return unreadCount;
                    }
                    
                    // åŸºäºå·²è¯»ç´¢å¼•è®¡ç®—æœªè¯»æ¶ˆæ¯
                    const lastReadIndex = readStatus.lastReadIndex;
                    console.log(`${chatName} ä½¿ç”¨å·²è¯»ç´¢å¼• ${lastReadIndex} è®¡ç®—æœªè¯»æ¶ˆæ¯ï¼Œæ€»æ¶ˆæ¯æ•°: ${messages.length}`);
                    
                    for (let i = lastReadIndex; i < messages.length; i++) {
                        const msg = messages[i];
                        
                        // è·³è¿‡åˆå§‹ç³»ç»Ÿæ¶ˆæ¯
                        if (QQ_IsInitialSystemMessage(msg)) {
                            continue;
                        }
                        
                        // æ£€æŸ¥æ˜¯å¦ä¸ºç”¨æˆ·è‡ªå·±å‘é€çš„æ¶ˆæ¯
                        const parts = msg.split('--');
                        if (parts.length >= 2 && parts[0] === `${UserName}`) {
                            continue; // è·³è¿‡ç”¨æˆ·è‡ªå·±çš„æ¶ˆæ¯
                        }
                        
                        unreadCount++;
                    }
                    
                    console.log(`${chatName} åŸºäºå·²è¯»ç´¢å¼•è®¡ç®—ç»“æœ: ${unreadCount} æ¡æœªè¯»æ¶ˆæ¯`);
                    return unreadCount;
                    
                } catch (error) {
                    console.error('è®¡ç®—æœªè¯»æ¶ˆæ¯æ•°é‡å¤±è´¥:', error);
                    return 0;
                }
            }
            let Npc_Settings = {};
            let QQ_Groups = [];
            // ç¡®ä¿QQ_Groupsä½œä¸ºå…¨å±€å˜é‡å¯è®¿é—®
            window.QQ_Groups = QQ_Groups;
            
            // *** æ–°å¢ï¼šç¾¤èŠåˆå§‹æ¶ˆæ¯é˜²é‡å¤æœºåˆ¶ ***
            let QQ_GroupInitializedSet = new Set(); // è®°å½•å·²åˆå§‹åŒ–è¿‡åˆå§‹æ¶ˆæ¯çš„ç¾¤èŠ
            window.QQ_GroupInitializedSet = QQ_GroupInitializedSet;
            
            // *** æ–°å¢ï¼šç¾¤èŠç³»ç»Ÿæ¶ˆæ¯æ£€æµ‹å’Œæ¸…ç†å·¥å…· ***
            window.QQ_CheckGroupInitialMessages = function() {
                console.log('=== ç¾¤èŠåˆå§‹æ¶ˆæ¯æ£€æµ‹æŠ¥å‘Š ===');
                
                if (!QQ_msgjson || !QQ_msgjson.ç¾¤èŠ) {
                    console.log('æ²¡æœ‰ç¾¤èŠæ•°æ®');
                    return;
                }
                
                Object.keys(QQ_msgjson.ç¾¤èŠ).forEach(groupName => {
                    const groupData = QQ_msgjson.ç¾¤èŠ[groupName];
                    if (!groupData || !groupData.msgs) return;
                    
                    console.log(`\nç¾¤èŠ: ${groupName}`);
                    console.log(`æ¶ˆæ¯æ€»æ•°: ${groupData.msgs.length}`);
                    console.log(`æ˜¯å¦å·²æ ‡è®°åˆå§‹åŒ–: ${QQ_GroupInitializedSet.has(groupName)}`);
                    
                    // æ£€æµ‹ç³»ç»Ÿæ¶ˆæ¯
                    const systemMessages = groupData.msgs.filter(msg => 
                        typeof msg === 'string' && msg.startsWith('ç³»ç»Ÿæ¶ˆæ¯--')
                    );
                    console.log(`ç³»ç»Ÿæ¶ˆæ¯æ•°é‡: ${systemMessages.length}`);
                    
                    if (systemMessages.length > 0) {
                        console.log('ç³»ç»Ÿæ¶ˆæ¯åˆ—è¡¨:');
                        systemMessages.forEach((msg, index) => {
                            console.log(`  ${index + 1}. ${msg}`);
                        });
                        
                        // æ£€æµ‹é‡å¤çš„åˆå§‹æ¶ˆæ¯
                        const initialMessages = systemMessages.filter(msg => {
                            const parts = msg.split('--');
                            if (parts.length < 3) return false;
                            const content = parts[2];
                            return content.includes('åˆ›å»ºæˆåŠŸ') || 
                                   content.includes('åŠ å…¥äº†ç¾¤èŠ') ||
                                   content.includes('å¼€å§‹èŠå¤©å§');
                        });
                        
                        if (initialMessages.length > 3) { // æ­£å¸¸åº”è¯¥åªæœ‰1ä¸ªåˆ›å»º+Nä¸ªåŠ å…¥+1ä¸ªæ—¶é—´
                            console.warn(`âš ï¸ æ£€æµ‹åˆ°å¯èƒ½çš„é‡å¤åˆå§‹æ¶ˆæ¯ (${initialMessages.length}æ¡)`);
                        }
                    }
                });
                
                console.log('\n=== æ£€æµ‹å®Œæˆ ===');
            };
            
            // *** æ–°å¢ï¼šæ¸…ç†é‡å¤ç³»ç»Ÿæ¶ˆæ¯çš„å·¥å…· ***
            window.QQ_CleanDuplicateInitialMessages = function() {
                console.log('=== å¼€å§‹æ¸…ç†é‡å¤çš„ç¾¤èŠåˆå§‹æ¶ˆæ¯ ===');
                
                if (!QQ_msgjson || !QQ_msgjson.ç¾¤èŠ) {
                    console.log('æ²¡æœ‰ç¾¤èŠæ•°æ®éœ€è¦æ¸…ç†');
                    return;
                }
                
                let cleanedCount = 0;
                
                Object.keys(QQ_msgjson.ç¾¤èŠ).forEach(groupName => {
                    const groupData = QQ_msgjson.ç¾¤èŠ[groupName];
                    if (!groupData || !groupData.msgs) return;
                    
                    const originalCount = groupData.msgs.length;
                    
                    // æ‰¾åˆ°æ‰€æœ‰ç³»ç»Ÿåˆå§‹æ¶ˆæ¯
                    const initialMessages = groupData.msgs.filter(msg => {
                        if (typeof msg !== 'string' || !msg.startsWith('ç³»ç»Ÿæ¶ˆæ¯--')) return false;
                        const parts = msg.split('--');
                        if (parts.length < 3) return false;
                        const content = parts[2];
                        return content.includes('åˆ›å»ºæˆåŠŸ') || 
                               content.includes('åŠ å…¥äº†ç¾¤èŠ') ||
                               content.includes('å¼€å§‹èŠå¤©å§') ||
                               /^\d{2}:\d{2}$/.test(content);
                    });
                    
                    if (initialMessages.length > 0) {
                        // ç§»é™¤æ‰€æœ‰åˆå§‹ç³»ç»Ÿæ¶ˆæ¯
                        groupData.msgs = groupData.msgs.filter(msg => {
                            if (typeof msg !== 'string' || !msg.startsWith('ç³»ç»Ÿæ¶ˆæ¯--')) return true;
                            const parts = msg.split('--');
                            if (parts.length < 3) return true;
                            const content = parts[2];
                            return !(content.includes('åˆ›å»ºæˆåŠŸ') || 
                                   content.includes('åŠ å…¥äº†ç¾¤èŠ') ||
                                   content.includes('å¼€å§‹èŠå¤©å§') ||
                                   /^\d{2}:\d{2}$/.test(content));
                        });
                        
                        // é‡ç½®åˆå§‹åŒ–æ ‡è®°ï¼Œå…è®¸é‡æ–°æ·»åŠ ä¸€æ¬¡æ­£ç¡®çš„åˆå§‹æ¶ˆæ¯
                        QQ_GroupInitializedSet.delete(groupName);
                        
                        const newCount = groupData.msgs.length;
                        if (originalCount !== newCount) {
                            console.log(`ç¾¤èŠ ${groupName}: ä»${originalCount}æ¡æ¶ˆæ¯æ¸…ç†åˆ°${newCount}æ¡æ¶ˆæ¯`);
                            cleanedCount++;
                        }
                    }
                });
                
                console.log(`=== æ¸…ç†å®Œæˆï¼Œå¤„ç†äº†${cleanedCount}ä¸ªç¾¤èŠ ===`);
                console.log('æç¤ºï¼šé‡æ–°åŠ è½½é¡µé¢åï¼Œç³»ç»Ÿå°†ä¸ºæ¸…ç†è¿‡çš„ç¾¤èŠé‡æ–°ç”Ÿæˆä¸€æ¬¡åˆå§‹æ¶ˆæ¯');
            };
            let gening;
            let worldbook;
            let entries;
            

            let newgen = true;
            let QQ_CharSettings = new MyINI();
            let Phone_Settings = new MyINI();
            // *** æ–°å¢ï¼šåŠ¨æ€å†…å®¹æŒä¹…åŒ–å­˜å‚¨ ***
            let QQ_MomentsData = [];  // å­˜å‚¨æ‰€æœ‰åŠ¨æ€å†…å®¹çš„æ•°ç»„
            window.QQ_MomentsData = QQ_MomentsData;  // è®¾ä¸ºå…¨å±€å˜é‡æ–¹ä¾¿è°ƒè¯•
            
            // *** æ–°å¢ï¼šèŠå¤©æ¶ˆæ¯worldbookå¤‡ä»½å­˜å‚¨ ***
            let QQ_ChatBackup = {};  // èŠå¤©æ¶ˆæ¯çš„worldbookå¤‡ä»½
            window.QQ_ChatBackup = QQ_ChatBackup;  // è®¾ä¸ºå…¨å±€å˜é‡æ–¹ä¾¿è°ƒè¯•
            
            // *** å¢å¼ºï¼šAIå›å¤é‡è¯•æœºåˆ¶ç›¸å…³å˜é‡ ***
            let QQ_RetryCount = 0;           // é‡è¯•è®¡æ•°å™¨
            const QQ_MAX_RETRY = 3;          // æœ€å¤§é‡è¯•æ¬¡æ•°
            let QQ_LastRequest = "";         // ä¸Šä¸€æ¬¡çš„è¯·æ±‚å†…å®¹
            let QQ_LastRequestName = "";     // ä¸Šä¸€æ¬¡çš„è§’è‰²å
            
            // *** æ–°å¢ï¼šé˜²æ­¢æ— é™å¾ªç¯çš„å®‰å…¨æœºåˆ¶ ***
            let QQ_FailureHistory = [];      // å¤±è´¥å†å²è®°å½•
            let QQ_ConsecutiveFailures = 0;  // è¿ç»­å¤±è´¥æ¬¡æ•°
            const QQ_MAX_CONSECUTIVE_FAILURES = 5;  // æœ€å¤§è¿ç»­å¤±è´¥æ¬¡æ•°
            let QQ_LastFailureTime = 0;      // ä¸Šæ¬¡å¤±è´¥æ—¶é—´
            const QQ_FAILURE_COOLDOWN = 30000; // å¤±è´¥å†·å´æ—¶é—´ï¼ˆ30ç§’ï¼‰
            
            // *** æ–°å¢ï¼šé”™è¯¯ç±»å‹åˆ†ç±» ***
            const QQ_ErrorTypes = {
                EMPTY_RESPONSE: 'empty_response',
                FORMAT_ERROR: 'format_error', 
                CONTENT_ERROR: 'content_error',
                NETWORK_ERROR: 'network_error',
                TIMEOUT_ERROR: 'timeout_error'
            };
            
            // *** æ–°å¢ï¼šåˆ†é¡µæ˜¾ç¤ºé…ç½® ***
            const MOMENTS_DISPLAY_LIMIT = 5;  // åŠ¨æ€æ˜¾ç¤ºä¸Šé™
            const CHAT_DISPLAY_LIMIT = 100;   // èŠå¤©æ¶ˆæ¯æ˜¾ç¤ºä¸Šé™
            const CHAT_LOAD_INCREMENT = 50;   // èŠå¤©æ¶ˆæ¯æ¯æ¬¡åŠ è½½æ•°é‡
            const MOMENTS_LOAD_INCREMENT = 5; // åŠ¨æ€æ¯æ¬¡åŠ è½½æ•°é‡
            
            // åˆ†é¡µçŠ¶æ€
            let momentsDisplayCount = 0;      // å½“å‰æ˜¾ç¤ºçš„åŠ¨æ€æ•°é‡
            let chatDisplayCounts = {};       // å„ä¸ªèŠå¤©çš„æ˜¾ç¤ºæ¶ˆæ¯æ•°é‡
            let QQ_Music = {
                audio: new Audio(),
                lastelement: undefined, // å…è®¸ undefined
                isLoading: false,
                // æ–°å¢å°é¢ç¼“å­˜
                cover: "",
            };
            let QQ_RandomHead = [];
            let NpcCssValue = "";
            let Variables = {};
            let UserName;
            let charAvatarPath;
            let userAvatarPath;
            let charcardname;
            let QQ_currentPage = "people"; // æ·»åŠ é¡µé¢çŠ¶æ€è·Ÿè¸ª
            let User_LastMsgMap = {
                ç¾¤èŠ: {},
                ç§èŠ: {},
            };
            let Char_LastMsgMap = {
                ç¾¤èŠ: {},
                ç§èŠ: {},
            };
            const version = "509";
            /**
             * è°ƒç”¨å‰ç«¯åŠ©æ‰‹å‡½æ•°
             */
            class ST {
                static async GetCurrentMessages() {
                    const CurrentMessageId = getCurrentMessageId();
                    const Messages = await getChatMessages(CurrentMessageId);
                    if (!Messages) {
                        console.log(`è·å–æ¥¼å±‚è®°å½•å¤±è´¥`);
                        return "";
                    }
                    let msg = Messages[0].message;
                    return msg;
                }
                static async Gen(msg) {
                    console.log(`è§¦å‘ç”Ÿæˆ  ${msg}`);
                    let result;
                    if (newgen) {
                        result = await generate({
                            user_input: msg,
                            should_stream: true,
                        });
                    } else {
                        result = await generate({
                            user_input: msg,
                            should_stream: false,
                        });
                    }
                    console.log(`ç”Ÿæˆç»“æœ:${result}`);
                    return result;
                }
            }
            /**
             * è·å–æ¶ˆæ¯ä¸­çš„åç§°
             * @param value æ¶ˆæ¯å†…å®¹
             * @returns åç§°åˆ—è¡¨
             */
            function QQ_GetValueName(value) {
                let result = [];
                const lines = value.split(/\r?\n/);
                for (const line of lines) {
                    let match = line.match(/åœ¨ç¾¤èŠ(.+)ä¸­å‘é€:(.+)/);
                    if (match) {
                        let obj = {
                            name: match[1],
                            value: match[2],
                        };
                        result.push(obj);
                        continue;
                    }
                    match = line.match(/ç»™(.+)å‘æ¶ˆæ¯:(.+)/);
                    if (match) {
                        let obj = {
                            name: match[1],
                            value: match[2],
                        };
                        result.push(obj);
                        continue;
                    }
                    match = line.match(/å›å¤(.+):(.+)/);
                    if (match) {
                        let obj = {
                            name: match[1],
                            value: match[2],
                        };
                        result.push(obj);
                        continue;
                    }
                }
                return result;
            }
            /**
             * ç”Ÿæˆæ¶ˆæ¯
             * @param msg æ¶ˆæ¯å†…å®¹
             * @returns ç”Ÿæˆç»“æœ
             */
            async function QQ_Gen(msg) {
                console.log(`è§¦å‘ç”Ÿæˆ  ${msg}`);
                
                let result;
                if (newgen) {
                    result = await generate({
                        user_input: msg,
                        should_stream: true,
                    });
                } else {
                    result = await generate({
                        user_input: msg,
                        should_stream: false,
                    });
                }
                console.log(`ç”Ÿæˆç»“æœ:${result}`);
                return result;
            }
            /**
             * å¤„ç†æ–°æ¶ˆæ¯å’Œå¤‡ä»½UIæ•°æ®ï¼Œä¸è¿›è¡Œä¸Šä¸‹æ–‡å‡€åŒ–ä»¥ä¿æŒAIè®°å¿†å®Œæ•´æ€§
             * @param {string} msg - AIå›å¤çš„åŸå§‹æ¶ˆæ¯å­—ç¬¦ä¸²
             */
            async function QQ_Save_Msg(msg) {
                if (!msg || msg.trim() === "") {
                    console.warn('âš ï¸ æ”¶åˆ°çš„æ¶ˆæ¯ä¸ºç©ºï¼Œå·²è·³è¿‡æ‰€æœ‰å¤„ç†ã€‚');
                    return;
                }
                console.log('âœ… æ”¶åˆ°æ–°æ¶ˆæ¯ï¼Œå¼€å§‹æœ€ç»ˆå¤„ç†æµç¨‹...');

                // --- æ­¥éª¤ 1: è§£æå¹¶å¤‡ä»½UIæ•°æ® ---
                // è¿™æ˜¯æœ€é«˜ä¼˜å…ˆçº§ï¼Œç¡®ä¿æ— è®ºå¦‚ä½•ï¼Œå‰ç«¯æ‰€éœ€çš„æ•°æ®éƒ½è¢«è§£æå¹¶ä¿å­˜ã€‚
                try {
                    if (await QQ_Msg_Parse(msg)) {
                        console.log('âœ… æ¶ˆæ¯è§£ææˆåŠŸï¼Œè§¦å‘èŠå¤©è®°å½•å¤‡ä»½...');
                        await QQ_Save_Chat_Backup();
                    } else {
                        console.warn('âš ï¸ æ¶ˆæ¯æœªåŒ…å«æœ‰æ•ˆèŠå¤©å†…å®¹ï¼Œè·³è¿‡èŠå¤©è®°å½•å¤‡ä»½ã€‚');
                    }
                } catch (error) {
                    console.error('âŒ åœ¨è§£æå’Œå¤‡ä»½UIæ•°æ®æ—¶å‘ç”Ÿä¸¥é‡é”™è¯¯:', error);
                }

                // --- æ­¥éª¤ 2: ä¿æŒAIè®°å¿†å®Œæ•´æ€§ï¼Œä¸è¿›è¡Œä¸Šä¸‹æ–‡å‡€åŒ– ---
                // ä¸ºäº†ä¿æŒAIè®°å¿†çš„å®Œæ•´æ€§å’Œè¿ç»­æ€§ï¼Œè·³è¿‡ä»»ä½•ä¸Šä¸‹æ–‡å‡€åŒ–æ“ä½œ
                console.log('âœ… ä¿æŒAIåŸå§‹å›å¤ï¼Œä¸è¿›è¡Œä¸Šä¸‹æ–‡å‡€åŒ–ä»¥ç»´æŠ¤è®°å¿†å®Œæ•´æ€§ã€‚');
            }
            
            
            
            /**
             * *** æ–°å¢ï¼šä¿å­˜èŠå¤©æ¶ˆæ¯åˆ°worldbookå¤‡ä»½ ***
             * @returns
             */
            async function QQ_Save_Chat_Backup() {
                if (!worldbook || !entries || !QQ_msgjson) {
                    console.log('èŠå¤©å¤‡ä»½è·³è¿‡ï¼šç¼ºå°‘worldbookæˆ–entriesæˆ–èŠå¤©æ•°æ®');
                    return;
                }
                
                try {
                    // *** ä¿®å¤ï¼šåªæ¸…ç†ç³»ç»Ÿæ¶ˆæ¯ï¼Œä¿ç•™æ‰€æœ‰ç”¨æˆ·å¯¹è¯æ¶ˆæ¯ ***
                    const cleanedMsgjson = JSON.parse(JSON.stringify(QQ_msgjson)); // æ·±æ‹·è´é¿å…ä¿®æ”¹åŸæ•°æ®
                    
                    // æ³¨é‡Šæ‰è¿‡åº¦æ¿€è¿›çš„æ—¶é—´æ¸…ç† - æ‰‹æœºå‰ç«¯åº”è¯¥æ°¸ä¹…ä¿å­˜ç”¨æˆ·å¯¹è¯
                    // QQ_CleanOldChatMessages(cleanedMsgjson);
                    console.log('æ‰‹æœºå‰ç«¯ç‰¹æ®Šå¤„ç†ï¼šè·³è¿‡æ—¶é—´åŸºç¡€çš„æ¶ˆæ¯æ¸…ç†ï¼Œä¿ç•™æ‰€æœ‰ç”¨æˆ·å¯¹è¯è®°å½•');
                    
                    // *** æ–°å¢ï¼šæ‰‹æœºå‰ç«¯ä¸“ç”¨æ¸©å’Œæ¸…ç†ï¼ˆåªæ¸…ç†æ˜æ˜¾æ— ç”¨çš„æ•°æ®ï¼‰ ***
                    QQ_GentleMobileCleanup(cleanedMsgjson);
                    
                    // *** æ–°å¢ï¼šé™åˆ¶èŠå¤©æ¶ˆæ¯æ€»æ•°é‡ï¼Œé¿å…å¤‡ä»½è¿‡å¤§ ***
                    QQ_LimitChatMessages(cleanedMsgjson, 1500);
                    
                    // *** æ–°å¢ï¼šæ’é™¤ç³»ç»Ÿæ¶ˆæ¯ ***
                    if (cleanedMsgjson.ç§èŠ) {
                        for (const chatKey in cleanedMsgjson.ç§èŠ) {
                            if (Array.isArray(cleanedMsgjson.ç§èŠ[chatKey])) {
                                cleanedMsgjson.ç§èŠ[chatKey] = cleanedMsgjson.ç§èŠ[chatKey].filter(msg => 
                                    !msg.startsWith('ç³»ç»Ÿæ¶ˆæ¯--')
                                );
                            }
                        }
                    }
                    
                    if (cleanedMsgjson.ç¾¤èŠ) {
                        for (const groupKey in cleanedMsgjson.ç¾¤èŠ) {
                            const group = cleanedMsgjson.ç¾¤èŠ[groupKey];
                            if (group && Array.isArray(group.msgs)) {
                                group.msgs = group.msgs.filter(msg => 
                                    !msg.startsWith('ç³»ç»Ÿæ¶ˆæ¯--')
                                );
                            }
                        }
                    }
                    
                    // *** æ–°å¢ï¼šç§»é™¤åºåˆ—å·æ ‡è¯†ç¬¦ï¼Œé¿å…åœ¨worldbookå¤‡ä»½ä¸­ä¿å­˜ ***
                    if (cleanedMsgjson.ç§èŠ) {
                        for (const chatKey in cleanedMsgjson.ç§èŠ) {
                            if (Array.isArray(cleanedMsgjson.ç§èŠ[chatKey])) {
                                cleanedMsgjson.ç§èŠ[chatKey] = cleanedMsgjson.ç§èŠ[chatKey].map(msg => {
                                    // ç§»é™¤åºåˆ—å·æ ‡è¯†ç¬¦ ##seq_æ•°å­—##
                                    return msg.replace(/##seq_\d+##$/g, '');
                                });
                            }
                        }
                    }
                    
                    if (cleanedMsgjson.ç¾¤èŠ) {
                        for (const groupKey in cleanedMsgjson.ç¾¤èŠ) {
                            const group = cleanedMsgjson.ç¾¤èŠ[groupKey];
                            if (group && Array.isArray(group.msgs)) {
                                group.msgs = group.msgs.map(msg => {
                                    // ç§»é™¤åºåˆ—å·æ ‡è¯†ç¬¦ ##seq_æ•°å­—##
                                    return msg.replace(/##seq_\d+##$/g, '');
                                });
                            }
                        }
                    }
                    
                    console.log('âœ… å·²ä»å¤‡ä»½æ•°æ®ä¸­ç§»é™¤åºåˆ—å·æ ‡è¯†ç¬¦');
                    
                    // åˆ›å»ºå¤‡ä»½æ•°æ®ç»“æ„ï¼ŒåŒ…å«æ—¶é—´æˆ³å’Œå®Œæ•´èŠå¤©æ•°æ®
                    QQ_ChatBackup = {
                        lastUpdated: new Date().toISOString(),
                        data: cleanedMsgjson,  // ä½¿ç”¨æ¸…ç†åçš„æ•°æ®ï¼ˆå·²æ’é™¤ç³»ç»Ÿæ¶ˆæ¯ï¼‰
                        version: version || "unknown"
                    };
                    
                    // æŸ¥æ‰¾æˆ–åˆ›å»ºèŠå¤©å¤‡ä»½æ¡ç›®
                    let chatBackupEntry = entries.find(entry => entry.comment === "æ‰‹æœº-èŠå¤©æ¶ˆæ¯å¤‡ä»½");
                    
                    const backupJson = JSON.stringify(QQ_ChatBackup, null, 2);
                    
                    // ç»Ÿè®¡è¦å¤‡ä»½çš„æ¶ˆæ¯æ•°é‡ï¼ˆæ’é™¤ç³»ç»Ÿæ¶ˆæ¯ï¼‰
                    let totalUserMessages = 0;
                    let totalPrivateChats = 0;
                    let totalGroupChats = 0;
                    
                    if (cleanedMsgjson.ç§èŠ) {
                        for (const chatKey in cleanedMsgjson.ç§èŠ) {
                            if (Array.isArray(cleanedMsgjson.ç§èŠ[chatKey]) && cleanedMsgjson.ç§èŠ[chatKey].length > 0) {
                                totalPrivateChats++;
                                totalUserMessages += cleanedMsgjson.ç§èŠ[chatKey].length;
                            }
                        }
                    }
                    
                    if (cleanedMsgjson.ç¾¤èŠ) {
                        for (const groupKey in cleanedMsgjson.ç¾¤èŠ) {
                            const group = cleanedMsgjson.ç¾¤èŠ[groupKey];
                            if (group && Array.isArray(group.msgs) && group.msgs.length > 0) {
                                totalGroupChats++;
                                totalUserMessages += group.msgs.length;
                            }
                        }
                    }
                    
                    console.log('å‡†å¤‡å¤‡ä»½èŠå¤©æ¶ˆæ¯:', totalPrivateChats, 'ä¸ªç§èŠ,', totalGroupChats, 'ä¸ªç¾¤èŠ, å…±', totalUserMessages, 'æ¡ç”¨æˆ·å¯¹è¯æ¶ˆæ¯ï¼ˆå·²æ’é™¤ç³»ç»Ÿæ¶ˆæ¯ï¼Œé™åˆ¶æœ€å¤š500æ¡ï¼‰');
                    
                    if (chatBackupEntry) {
                        // æ›´æ–°ç°æœ‰æ¡ç›®
                        await setLorebookEntries(worldbook, [{
                            uid: chatBackupEntry.uid,
                            content: backupJson,
                        }]);
                        console.log('èŠå¤©æ¶ˆæ¯å·²æ›´æ–°åˆ°ç°æœ‰worldbookå¤‡ä»½æ¡ç›®');
                    } else {
                        // åˆ›å»ºæ–°æ¡ç›®
                        await createLorebookEntry(worldbook, {
                            comment: "æ‰‹æœº-èŠå¤©æ¶ˆæ¯å¤‡ä»½",
                            key: ["æ­¤ä¸–ç•Œä¹¦æ°¸ä¸è§¦å‘_èŠå¤©å¤‡ä»½"],
                            content: backupJson,
                            position: "at_depth_as_system", 
                            type: "selective",
                            depth: 0,
                            exclude_recursion: true,
                            order: 9998,  // æ¯”åŠ¨æ€å­˜å‚¨ä¼˜å…ˆçº§ç¨é«˜
                            enabled: true,
                        });
                        console.log('èŠå¤©æ¶ˆæ¯å·²ä¿å­˜åˆ°æ–°worldbookå¤‡ä»½æ¡ç›®');
                        
                        // é‡æ–°è·å–entriesä»¥åŒ…å«æ–°åˆ›å»ºçš„æ¡ç›®
                        entries = await getLorebookEntries(worldbook);
                    }
                } catch (error) {
                    console.error('èŠå¤©æ¶ˆæ¯å¤‡ä»½å¤±è´¥:', error);
                }
            }

            /**
             * *** æ–°å¢ï¼šä¿å­˜åŠ¨æ€å†…å®¹åˆ°worldbook ***
             * @returns
             */
            async function QQ_Save_Moments() {
                if (!worldbook || !entries || QQ_MomentsData.length === 0) {
                    console.log('åŠ¨æ€ä¿å­˜è·³è¿‡ï¼šç¼ºå°‘worldbookæˆ–entriesæˆ–æ— åŠ¨æ€æ•°æ®');
                    return;
                }
                
                try {
                    // *** æ–°å¢ï¼šæ¸…ç†è¿‡æœŸåŠ¨æ€å’Œè¯„è®ºï¼ˆä¿ç•™æœ€è¿‘50æ¡åŠ¨æ€ï¼Œæ¯ä¸ªåŠ¨æ€50æ¡è¯„è®ºï¼‰ ***
                    QQ_CleanOldMoments();
                    
                    // *** æ–°å¢ï¼šä¼˜åŒ–è¯„è®ºå­˜å‚¨ï¼Œç¡®ä¿è¯„è®ºè´¨é‡ ***
                    QQ_OptimizeCommentsStorage();
                    
                    // æŸ¥æ‰¾æˆ–åˆ›å»ºåŠ¨æ€å­˜å‚¨æ¡ç›®
                    let momentEntry = entries.find(entry => entry.comment === "æ‰‹æœº-åŠ¨æ€å†…å®¹å­˜å‚¨");
                    
                    // *** æ–°å¢ï¼šç»Ÿè®¡è¯„è®ºä¿¡æ¯ ***
                    let totalComments = 0;
                    let momentsWithComments = 0;
                    if (QQ_MomentsData && Array.isArray(QQ_MomentsData)) {
                        QQ_MomentsData.forEach(moment => {
                            if (moment.comments && moment.comments.length > 0) {
                                totalComments += moment.comments.length;
                                momentsWithComments++;
                            }
                        });
                    }
                    
                    const momentsJson = JSON.stringify(QQ_MomentsData, null, 2);
                    console.log(`å‡†å¤‡ä¿å­˜åŠ¨æ€å†…å®¹: ${QQ_MomentsData.length}æ¡åŠ¨æ€, ${totalComments}æ¡è¯„è®º (${momentsWithComments}ä¸ªåŠ¨æ€æœ‰è¯„è®º)`);
                    
                    if (momentEntry) {
                        // æ›´æ–°ç°æœ‰æ¡ç›®
                        await setLorebookEntries(worldbook, [{
                            uid: momentEntry.uid,
                            content: momentsJson,
                        }]);
                        console.log('åŠ¨æ€å†…å®¹å·²æ›´æ–°åˆ°ç°æœ‰worldbookæ¡ç›®');
                    } else {
                        // åˆ›å»ºæ–°æ¡ç›®
                        await createLorebookEntry(worldbook, {
                            comment: "æ‰‹æœº-åŠ¨æ€å†…å®¹å­˜å‚¨",
                            key: ["æ­¤ä¸–ç•Œä¹¦æ°¸ä¸è§¦å‘_åŠ¨æ€å­˜å‚¨"],
                            content: momentsJson,
                            position: "at_depth_as_system",
                            type: "selective",
                            depth: 0,
                            exclude_recursion: true,
                            order: 9999,
                            enabled: true,
                        });
                        console.log('åŠ¨æ€å†…å®¹å·²ä¿å­˜åˆ°æ–°worldbookæ¡ç›®');
                        
                        // é‡æ–°è·å–entriesä»¥åŒ…å«æ–°åˆ›å»ºçš„æ¡ç›®
                        entries = await getLorebookEntries(worldbook);
                    }
                } catch (error) {
                    console.error('ä¿å­˜åŠ¨æ€å†…å®¹å¤±è´¥:', error);
                }
            }

            /**
             * *** æ–°å¢ï¼šæ¸…ç†è¿‡æœŸåŠ¨æ€å†…å®¹å’Œè¯„è®º ***
             */
            function QQ_CleanOldMoments() {
                const MAX_MOMENTS = 50; // æœ€å¤šä¿ç•™50æ¡åŠ¨æ€
                const MAX_COMMENTS_PER_MOMENT = 50; // æ¯ä¸ªåŠ¨æ€æœ€å¤šä¿ç•™50æ¡è¯„è®º
                
                if (!QQ_MomentsData || !Array.isArray(QQ_MomentsData)) {
                    console.warn('QQ_CleanOldMoments: QQ_MomentsDataä¸å­˜åœ¨æˆ–ä¸æ˜¯æ•°ç»„');
                    return;
                }
                
                let totalCleanedComments = 0;
                
                // æ¸…ç†æ¯ä¸ªåŠ¨æ€çš„è¯„è®ºæ•°é‡
                if (QQ_MomentsData && Array.isArray(QQ_MomentsData)) {
                QQ_MomentsData.forEach(moment => {
                    if (moment.comments && moment.comments.length > MAX_COMMENTS_PER_MOMENT) {
                        // æŒ‰æ—¶é—´æˆ³æ’åºï¼Œä¿ç•™æœ€æ–°çš„è¯„è®º
                        moment.comments.sort((a, b) => {
                            return new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime();
                        });
                        
                        const removedComments = moment.comments.length - MAX_COMMENTS_PER_MOMENT;
                        moment.comments.splice(MAX_COMMENTS_PER_MOMENT);
                        totalCleanedComments += removedComments;
                        
                        console.log(`åŠ¨æ€${moment.id}æ¸…ç†äº†${removedComments}æ¡è¯„è®ºï¼Œä¿ç•™${moment.comments.length}æ¡`);
                    }
                });
                }
                
                // æ¸…ç†åŠ¨æ€æ•°é‡
                if (QQ_MomentsData.length > MAX_MOMENTS) {
                    // æŒ‰æ—¶é—´æˆ³æ’åºï¼Œä¿ç•™æœ€æ–°çš„åŠ¨æ€
                    QQ_MomentsData.sort((a, b) => {
                        return new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime();
                    });
                    
                    const removedCount = QQ_MomentsData.length - MAX_MOMENTS;
                    QQ_MomentsData.splice(MAX_MOMENTS);
                    
                    console.log(`æ¸…ç†äº† ${removedCount} æ¡è¿‡æœŸåŠ¨æ€ï¼Œå½“å‰ä¿ç•™ ${QQ_MomentsData.length} æ¡åŠ¨æ€`);
                }
                
                if (totalCleanedComments > 0) {
                    console.log(`æ€»å…±æ¸…ç†äº† ${totalCleanedComments} æ¡è¿‡æœŸè¯„è®º`);
                }
            }

            /**
             * *** æ–°å¢ï¼šä¼˜åŒ–è¯„è®ºå­˜å‚¨è´¨é‡ ***
             */
            function QQ_OptimizeCommentsStorage() {
                if (!QQ_MomentsData || !Array.isArray(QQ_MomentsData)) {
                    console.warn('QQ_OptimizeCommentsStorage: QQ_MomentsDataä¸å­˜åœ¨æˆ–ä¸æ˜¯æ•°ç»„');
                    return;
                }
                
                let totalOptimized = 0;
                
                if (QQ_MomentsData && Array.isArray(QQ_MomentsData)) {
                QQ_MomentsData.forEach(moment => {
                    if (moment.comments && moment.comments.length > 0) {
                        const originalLength = moment.comments.length;
                        
                        // å»é‡å¤è¯„è®ºï¼ˆåŸºäºå†…å®¹å’Œå‘é€è€…ï¼‰
                        const uniqueComments = [];
                        const seen = new Set();
                        
                        for (const comment of moment.comments) {
                            const key = `${comment.name}:${comment.content}`;
                            if (!seen.has(key)) {
                                seen.add(key);
                                uniqueComments.push(comment);
                            }
                        }
                        
                        // è¿‡æ»¤ç©ºè¯„è®ºæˆ–æ— æ•ˆè¯„è®º
                        const validComments = uniqueComments.filter(comment => 
                            comment.name && 
                            comment.content && 
                            comment.content.trim().length > 0 &&
                            comment.content.trim() !== '...' &&
                            comment.content.trim() !== 'ã€‚ã€‚ã€‚'
                        );
                        
                        // æŒ‰æ—¶é—´æ’åºï¼ˆç¡®ä¿æ–°è¯„è®ºåœ¨åé¢ï¼‰
                        validComments.sort((a, b) => {
                            return new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime();
                        });
                        
                        moment.comments = validComments;
                        
                        const optimizedCount = originalLength - validComments.length;
                        if (optimizedCount > 0) {
                            totalOptimized += optimizedCount;
                            console.log(`åŠ¨æ€${moment.id}ä¼˜åŒ–äº†${optimizedCount}æ¡è¯„è®ºï¼ˆå»é‡å’Œæ¸…ç†æ— æ•ˆè¯„è®ºï¼‰`);
                        }
                    }
                });
                }
                
                if (totalOptimized > 0) {
                    console.log(`è¯„è®ºå­˜å‚¨ä¼˜åŒ–å®Œæˆï¼Œæ€»å…±ä¼˜åŒ–äº† ${totalOptimized} æ¡è¯„è®º`);
                }
            }
            
            /**
             * *** æ–°å¢ï¼šé™åˆ¶èŠå¤©æ¶ˆæ¯æ€»æ•°é‡ï¼Œä¿ç•™æœ€æ–°çš„æ¶ˆæ¯ ***
             * @param {Object} msgjsonData - èŠå¤©æ•°æ®å¯¹è±¡
             * @param {number} maxMessages - æœ€å¤§ä¿ç•™æ¶ˆæ¯æ•°é‡
             */
            function QQ_LimitChatMessages(msgjsonData, maxMessages = 1500) {
                try {
                    console.log(`å¼€å§‹æ‰§è¡ŒèŠå¤©æ¶ˆæ¯æ•°é‡é™åˆ¶ï¼Œæœ€å¤§ä¿ç•™ ${maxMessages} æ¡æ¶ˆæ¯`);
                    
                    // æ”¶é›†æ‰€æœ‰æ¶ˆæ¯å¹¶æ·»åŠ æ—¶é—´æˆ³
                    const allMessages = [];
                    
                    // æ”¶é›†ç§èŠæ¶ˆæ¯
                    if (msgjsonData.ç§èŠ) {
                        for (const chatKey in msgjsonData.ç§èŠ) {
                            const chat = msgjsonData.ç§èŠ[chatKey];
                            if (Array.isArray(chat)) {
                                chat.forEach(msg => {
                                    if (typeof msg === 'string' && msg.includes('--')) {
                                        const parts = msg.split('--');
                                        if (parts.length >= 3) {
                                            try {
                                                const timestamp = new Date(parts[2]).getTime();
                                                allMessages.push({
                                                    type: 'ç§èŠ',
                                                    chatKey: chatKey,
                                                    message: msg,
                                                    timestamp: timestamp || 0
                                                });
                                            } catch (e) {
                                                // æ—¶é—´è§£æå¤±è´¥ï¼Œè®¾ç½®ä¸ºå½“å‰æ—¶é—´
                                                allMessages.push({
                                                    type: 'ç§èŠ',
                                                    chatKey: chatKey,
                                                    message: msg,
                                                    timestamp: Date.now()
                                                });
                                            }
                                        }
                                    }
                                });
                            }
                        }
                    }
                    
                    // æ”¶é›†ç¾¤èŠæ¶ˆæ¯
                    if (msgjsonData.ç¾¤èŠ) {
                        for (const groupKey in msgjsonData.ç¾¤èŠ) {
                            const group = msgjsonData.ç¾¤èŠ[groupKey];
                            if (group && Array.isArray(group.msgs)) {
                                group.msgs.forEach(msg => {
                                    if (typeof msg === 'string' && msg.includes('--')) {
                                        const parts = msg.split('--');
                                        if (parts.length >= 3) {
                                            try {
                                                const timestamp = new Date(parts[2]).getTime();
                                                allMessages.push({
                                                    type: 'ç¾¤èŠ',
                                                    chatKey: groupKey,
                                                    message: msg,
                                                    timestamp: timestamp || 0
                                                });
                                            } catch (e) {
                                                // æ—¶é—´è§£æå¤±è´¥ï¼Œè®¾ç½®ä¸ºå½“å‰æ—¶é—´
                                                allMessages.push({
                                                    type: 'ç¾¤èŠ',
                                                    chatKey: groupKey,
                                                    message: msg,
                                                    timestamp: Date.now()
                                                });
                                            }
                                        }
                                    }
                                });
                            }
                        }
                    }
                    
                    console.log(`æ”¶é›†åˆ°æ€»å…± ${allMessages.length} æ¡æ¶ˆæ¯`);
                    
                    // å¦‚æœæ¶ˆæ¯æ•°é‡è¶…è¿‡é™åˆ¶ï¼Œè¿›è¡Œå‰Šå‡
                    if (allMessages.length > maxMessages) {
                        // æŒ‰æ—¶é—´æˆ³æ’åºï¼Œä¿ç•™æœ€æ–°çš„æ¶ˆæ¯
                        allMessages.sort((a, b) => b.timestamp - a.timestamp);
                        
                        // åªä¿ç•™æœ€æ–°çš„maxMessagesæ¡æ¶ˆæ¯
                        const keepMessages = allMessages.slice(0, maxMessages);
                        const removedCount = allMessages.length - maxMessages;
                        
                        console.log(`æ¶ˆæ¯æ•°é‡è¶…é™ï¼Œå°†ä¿ç•™æœ€æ–°çš„ ${maxMessages} æ¡æ¶ˆæ¯ï¼Œåˆ é™¤ ${removedCount} æ¡æ—§æ¶ˆæ¯`);
                        
                        // æ¸…ç©ºåŸå§‹æ•°æ®
                        if (msgjsonData.ç§èŠ) {
                            for (const chatKey in msgjsonData.ç§èŠ) {
                                msgjsonData.ç§èŠ[chatKey] = [];
                            }
                        }
                        if (msgjsonData.ç¾¤èŠ) {
                            for (const groupKey in msgjsonData.ç¾¤èŠ) {
                                if (msgjsonData.ç¾¤èŠ[groupKey] && msgjsonData.ç¾¤èŠ[groupKey].msgs) {
                                    msgjsonData.ç¾¤èŠ[groupKey].msgs = [];
                                }
                            }
                        }
                        
                        // é‡æ–°åˆ†é…ä¿ç•™çš„æ¶ˆæ¯
                        keepMessages.forEach(msgObj => {
                            if (msgObj.type === 'ç§èŠ') {
                                if (!msgjsonData.ç§èŠ[msgObj.chatKey]) {
                                    msgjsonData.ç§èŠ[msgObj.chatKey] = [];
                                }
                                msgjsonData.ç§èŠ[msgObj.chatKey].push(msgObj.message);
                            } else if (msgObj.type === 'ç¾¤èŠ') {
                                if (!msgjsonData.ç¾¤èŠ[msgObj.chatKey]) {
                                    msgjsonData.ç¾¤èŠ[msgObj.chatKey] = { msgs: [] };
                                }
                                if (!msgjsonData.ç¾¤èŠ[msgObj.chatKey].msgs) {
                                    msgjsonData.ç¾¤èŠ[msgObj.chatKey].msgs = [];
                                }
                                msgjsonData.ç¾¤èŠ[msgObj.chatKey].msgs.push(msgObj.message);
                            }
                        });
                        
                        // æŒ‰æ—¶é—´é‡æ–°æ’åºæ¯ä¸ªèŠå¤©çš„æ¶ˆæ¯
                        if (msgjsonData.ç§èŠ) {
                            for (const chatKey in msgjsonData.ç§èŠ) {
                                if (Array.isArray(msgjsonData.ç§èŠ[chatKey]) && msgjsonData.ç§èŠ[chatKey].length > 0) {
                                    msgjsonData.ç§èŠ[chatKey].sort((a, b) => {
                                        const timeA = new Date(a.split('--')[2]).getTime();
                                        const timeB = new Date(b.split('--')[2]).getTime();
                                        return timeA - timeB;
                                    });
                                }
                            }
                        }
                        
                        if (msgjsonData.ç¾¤èŠ) {
                            for (const groupKey in msgjsonData.ç¾¤èŠ) {
                                const group = msgjsonData.ç¾¤èŠ[groupKey];
                                if (group && Array.isArray(group.msgs) && group.msgs.length > 0) {
                                    group.msgs.sort((a, b) => {
                                        const timeA = new Date(a.split('--')[2]).getTime();
                                        const timeB = new Date(b.split('--')[2]).getTime();
                                        return timeA - timeB;
                                    });
                                }
                            }
                        }
                        
                        console.log(`æ¶ˆæ¯æ•°é‡é™åˆ¶å®Œæˆï¼Œå·²ä¿ç•™æœ€æ–°çš„ ${maxMessages} æ¡æ¶ˆæ¯`);
                    } else {
                        console.log(`æ¶ˆæ¯æ•°é‡ ${allMessages.length} æœªè¶…è¿‡é™åˆ¶ ${maxMessages}ï¼Œæ— éœ€åˆ é™¤`);
                    }
                    
                } catch (error) {
                    console.error('é™åˆ¶èŠå¤©æ¶ˆæ¯æ•°é‡æ—¶å‡ºé”™:', error);
                }
            }
            
            /**
             * *** æ–°å¢ï¼šæ‰‹æœºå‰ç«¯ä¸“ç”¨æ¸©å’Œæ¸…ç†ï¼ˆåªæ¸…ç†æ˜æ˜¾æ— ç”¨çš„æ•°æ®ï¼‰ ***
             */
            function QQ_GentleMobileCleanup(msgjsonData) {
                try {
                    let cleanedCount = 0;
                    
                    // åªæ¸…ç†ç©ºæ¶ˆæ¯å’Œæ ¼å¼å¼‚å¸¸çš„æ¶ˆæ¯ï¼Œä¿ç•™æ‰€æœ‰æœ‰æ•ˆç”¨æˆ·å¯¹è¯
                    if (msgjsonData.ç§èŠ) {
                        for (const chatKey in msgjsonData.ç§èŠ) {
                            const chat = msgjsonData.ç§èŠ[chatKey];
                            if (Array.isArray(chat)) {
                                const originalLength = chat.length;
                                msgjsonData.ç§èŠ[chatKey] = chat.filter(msg => {
                                    // åªè¿‡æ»¤æ‰ç©ºæ¶ˆæ¯æˆ–æ ¼å¼ä¸¥é‡å¼‚å¸¸çš„æ¶ˆæ¯
                                    if (typeof msg !== 'string' || msg.trim() === '') {
                                        return false;
                                    }
                                    // ä¿ç•™æ‰€æœ‰å…¶ä»–æ¶ˆæ¯ï¼ŒåŒ…æ‹¬ç³»ç»Ÿæ¶ˆæ¯
                                    return true;
                                });
                                cleanedCount += originalLength - msgjsonData.ç§èŠ[chatKey].length;
                            }
                        }
                    }
                    
                    if (msgjsonData.ç¾¤èŠ) {
                        for (const groupKey in msgjsonData.ç¾¤èŠ) {
                            const group = msgjsonData.ç¾¤èŠ[groupKey];
                            if (group && Array.isArray(group.msgs)) {
                                const originalLength = group.msgs.length;
                                group.msgs = group.msgs.filter(msg => {
                                    // åªè¿‡æ»¤æ‰ç©ºæ¶ˆæ¯æˆ–æ ¼å¼ä¸¥é‡å¼‚å¸¸çš„æ¶ˆæ¯
                                    if (typeof msg !== 'string' || msg.trim() === '') {
                                        return false;
                                    }
                                    // ä¿ç•™æ‰€æœ‰å…¶ä»–æ¶ˆæ¯ï¼ŒåŒ…æ‹¬ç³»ç»Ÿæ¶ˆæ¯
                                    return true;
                                });
                                cleanedCount += originalLength - group.msgs.length;
                            }
                        }
                    }
                    
                    if (cleanedCount > 0) {
                        console.log(`æ‰‹æœºå‰ç«¯æ¸©å’Œæ¸…ç†ï¼šç§»é™¤äº† ${cleanedCount} æ¡ç©ºæ¶ˆæ¯æˆ–æ ¼å¼å¼‚å¸¸çš„æ¶ˆæ¯`);
                    } else {
                        console.log('æ‰‹æœºå‰ç«¯æ¸©å’Œæ¸…ç†ï¼šæ²¡æœ‰éœ€è¦æ¸…ç†çš„æ— æ•ˆæ¶ˆæ¯');
                    }
                } catch (error) {
                    console.error('æ‰‹æœºå‰ç«¯æ¸©å’Œæ¸…ç†æ—¶å‡ºé”™:', error);
                }
            }
            
            /**
             * *** æ–°å¢ï¼šæ¸…ç†è¿‡æœŸèŠå¤©æ¶ˆæ¯æ•°æ® ***
             */
            function QQ_CleanOldChatMessages(msgjsonData) {
                const MAX_DAYS = 30; // æœ€å¤šä¿ç•™30å¤©çš„èŠå¤©è®°å½•
                const cutoffTime = Date.now() - (MAX_DAYS * 24 * 60 * 60 * 1000);
                
                try {
                    let totalCleaned = 0;
                    
                    // *** ä¿®å¤ï¼šæ¸…ç†ç§èŠæ¶ˆæ¯ï¼ˆæ¶ˆæ¯æ ¼å¼ï¼š"å‘é€è€…--å†…å®¹--æ—¶é—´"ï¼‰ ***
                    if (msgjsonData.ç§èŠ) {
                        for (const chatKey in msgjsonData.ç§èŠ) {
                            const chat = msgjsonData.ç§èŠ[chatKey];
                            if (Array.isArray(chat)) {
                                const originalLength = chat.length;
                                // è¿‡æ»¤æ‰è¿‡æœŸæ¶ˆæ¯ï¼ˆåŸºäºæ—¶é—´æˆ³ï¼‰
                                msgjsonData.ç§èŠ[chatKey] = chat.filter(msg => {
                                    if (typeof msg === 'string' && msg.includes('--')) {
                                        const parts = msg.split('--');
                                        if (parts.length >= 3) {
                                            // å°è¯•è§£ææ—¶é—´æˆ³
                                            try {
                                                const timeStr = parts[2];
                                                const msgTime = new Date(timeStr).getTime();
                                                if (!isNaN(msgTime)) {
                                                    return msgTime >= cutoffTime;
                                                }
                                            } catch (e) {
                                                // æ—¶é—´è§£æå¤±è´¥ï¼Œä¿ç•™æ¶ˆæ¯
                                            }
                                        }
                                    }
                                    // å¦‚æœæ²¡æœ‰æ—¶é—´æˆ³æˆ–æ ¼å¼å¼‚å¸¸ï¼Œä¿ç•™æ¶ˆæ¯ï¼ˆé¿å…è¯¯åˆ ï¼‰
                                    return true;
                                });
                                
                                const cleanedCount = originalLength - msgjsonData.ç§èŠ[chatKey].length;
                                if (cleanedCount > 0) {
                                    totalCleaned += cleanedCount;
                                    console.log(`ç§èŠ${chatKey}æ¸…ç†äº†${cleanedCount}æ¡è¿‡æœŸæ¶ˆæ¯`);
                                }
                                
                                // å¦‚æœç§èŠè®°å½•ä¸ºç©ºï¼Œåˆ é™¤æ•´ä¸ªç§èŠ
                                if (msgjsonData.ç§èŠ[chatKey].length === 0) {
                                    delete msgjsonData.ç§èŠ[chatKey];
                                }
                            }
                        }
                    }
                    
                    // *** ä¿®å¤ï¼šæ¸…ç†ç¾¤èŠæ¶ˆæ¯ï¼ˆæ¶ˆæ¯åœ¨group.msgsæ•°ç»„ä¸­ï¼‰ ***
                    if (msgjsonData.ç¾¤èŠ) {
                        for (const groupKey in msgjsonData.ç¾¤èŠ) {
                            const group = msgjsonData.ç¾¤èŠ[groupKey];
                            if (group && Array.isArray(group.msgs)) {
                                const originalLength = group.msgs.length;
                                // è¿‡æ»¤æ‰è¿‡æœŸæ¶ˆæ¯
                                group.msgs = group.msgs.filter(msg => {
                                    if (typeof msg === 'string' && msg.includes('--')) {
                                        const parts = msg.split('--');
                                        if (parts.length >= 3) {
                                            // å°è¯•è§£ææ—¶é—´æˆ³
                                            try {
                                                const timeStr = parts[2];
                                                const msgTime = new Date(timeStr).getTime();
                                                if (!isNaN(msgTime)) {
                                                    return msgTime >= cutoffTime;
                                                }
                                            } catch (e) {
                                                // æ—¶é—´è§£æå¤±è´¥ï¼Œä¿ç•™æ¶ˆæ¯
                                            }
                                        }
                                    }
                                    // å¦‚æœæ²¡æœ‰æ—¶é—´æˆ³æˆ–æ ¼å¼å¼‚å¸¸ï¼Œä¿ç•™æ¶ˆæ¯ï¼ˆé¿å…è¯¯åˆ ï¼‰
                                    return true;
                                });
                                
                                const cleanedCount = originalLength - group.msgs.length;
                                if (cleanedCount > 0) {
                                    totalCleaned += cleanedCount;
                                    console.log(`ç¾¤èŠ${groupKey}æ¸…ç†äº†${cleanedCount}æ¡è¿‡æœŸæ¶ˆæ¯`);
                                }
                                
                                // å¦‚æœç¾¤èŠè®°å½•ä¸ºç©ºï¼Œåˆ é™¤æ•´ä¸ªç¾¤èŠ
                                if (group.msgs.length === 0) {
                                    delete msgjsonData.ç¾¤èŠ[groupKey];
                                }
                            }
                        }
                    }
                    
                    if (totalCleaned > 0) {
                        console.log(`æ€»å…±æ¸…ç†äº† ${totalCleaned} æ¡è¶…è¿‡${MAX_DAYS}å¤©çš„èŠå¤©æ¶ˆæ¯`);
                    }
                } catch (error) {
                    console.error('æ¸…ç†èŠå¤©æ¶ˆæ¯æ—¶å‡ºé”™:', error);
                }
            }
            
            /**
             * *** æ–°å¢ï¼šæ¸…ç†è¿‡æœŸèŠå¤©æ¶ˆæ¯å¤‡ä»½ ***
             */
            function QQ_CleanOldChatBackup() {
                const MAX_DAYS = 30; // æœ€å¤šä¿ç•™30å¤©çš„èŠå¤©è®°å½•
                const cutoffTime = Date.now() - (MAX_DAYS * 24 * 60 * 60 * 1000);
                
                try {
                    // æ¸…ç†QQ_ChatBackupä¸­çš„è¿‡æœŸæ•°æ®
                    let cleanedCount = 0;
                    
                    for (const chatId in QQ_ChatBackup) {
                        const chatData = QQ_ChatBackup[chatId];
                        if (chatData && chatData.lastUpdated) {
                            // æ£€æŸ¥æœ€åæ›´æ–°æ—¶é—´
                            if (new Date(chatData.lastUpdated).getTime() < cutoffTime) {
                                delete QQ_ChatBackup[chatId];
                                cleanedCount++;
                            } else if (chatData.messages) {
                                // æ¸…ç†èŠå¤©è®°å½•ä¸­çš„è¿‡æœŸæ¶ˆæ¯
                                const originalCount = Object.keys(chatData.messages).length;
                                
                                for (const msgKey in chatData.messages) {
                                    const msg = chatData.messages[msgKey];
                                    if (msg && msg.timestamp) {
                                        const msgTime = new Date(msg.timestamp).getTime();
                                        if (msgTime < cutoffTime) {
                                            delete chatData.messages[msgKey];
                                        }
                                    }
                                }
                                
                                const remainingCount = Object.keys(chatData.messages).length;
                                if (remainingCount === 0) {
                                    // å¦‚æœèŠå¤©è®°å½•å…¨éƒ¨è¿‡æœŸï¼Œåˆ é™¤æ•´ä¸ªèŠå¤©
                                    delete QQ_ChatBackup[chatId];
                                    cleanedCount++;
                                } else if (remainingCount < originalCount) {
                                    console.log(`èŠå¤©${chatId}æ¸…ç†äº†${originalCount - remainingCount}æ¡è¿‡æœŸæ¶ˆæ¯`);
                                }
                            }
                        }
                    }
                    
                    if (cleanedCount > 0) {
                        console.log(`æ¸…ç†äº† ${cleanedCount} ä¸ªè¿‡æœŸèŠå¤©å¤‡ä»½`);
                    }
                } catch (error) {
                    console.error('æ¸…ç†èŠå¤©å¤‡ä»½æ—¶å‡ºé”™:', error);
                }
            }
            
            /**
             * *** æ–°å¢ï¼šæ‰‹åŠ¨å¼ºåˆ¶æ¢å¤èŠå¤©å¤‡ä»½ï¼ˆè°ƒè¯•ç”¨ï¼‰ ***
             * å¯åœ¨æ§åˆ¶å°è°ƒç”¨ window.QQ_Force_Restore_Chat() æ¥å¼ºåˆ¶æ¢å¤å¤‡ä»½
             */
            window.QQ_Force_Restore_Chat = async function() {
                console.log('å¼€å§‹å¼ºåˆ¶æ¢å¤èŠå¤©å¤‡ä»½...');
                const restored = await QQ_Load_Chat_Backup();
                if (restored) {
                    console.log('å¼ºåˆ¶æ¢å¤æˆåŠŸï¼Œæ­£åœ¨é‡æ–°ä¿å­˜åˆ°æ¶ˆæ¯ç³»ç»Ÿ...');
                    await QQ_Save_Msg();
                    console.log('å¼ºåˆ¶æ¢å¤å®Œæˆï¼');
                    return true;
                } else {
                    console.log('æ²¡æœ‰å¯ç”¨çš„å¤‡ä»½æ•°æ®æˆ–å¤‡ä»½æ•°æ®ä¸å¤Ÿæ–°');
                    return false;
                }
            };

            /**
             * *** æ–°å¢ï¼šæŸ¥çœ‹åŠ¨æ€å¤‡ä»½ç»Ÿè®¡ä¿¡æ¯ï¼ˆè°ƒè¯•ç”¨ï¼‰ ***
             * å¯åœ¨æ§åˆ¶å°è°ƒç”¨ window.QQ_Show_Moments_Stats() æ¥æŸ¥çœ‹ç»Ÿè®¡
             */
            window.QQ_Show_Moments_Stats = function() {
                console.log('=== åŠ¨æ€å¤‡ä»½ç»Ÿè®¡ä¿¡æ¯ ===');
                
                if (!QQ_MomentsData || !Array.isArray(QQ_MomentsData)) {
                    console.log('âš ï¸ QQ_MomentsDataä¸å­˜åœ¨æˆ–ä¸æ˜¯æ•°ç»„');
                    return {
                        totalMoments: 0,
                        totalComments: 0,
                        momentsWithComments: 0,
                        maxComments: 0,
                        minComments: 0
                    };
                }
                
                console.log(`æ€»åŠ¨æ€æ•°é‡: ${QQ_MomentsData.length}`);
                
                let totalComments = 0;
                let momentsWithComments = 0;
                let maxComments = 0;
                let minComments = Infinity;
                
                QQ_MomentsData.forEach((moment, index) => {
                    const commentCount = moment.comments ? moment.comments.length : 0;
                    totalComments += commentCount;
                    
                    if (commentCount > 0) {
                        momentsWithComments++;
                        maxComments = Math.max(maxComments, commentCount);
                        minComments = Math.min(minComments, commentCount);
                    }
                    
                    console.log(`åŠ¨æ€${index + 1} [${moment.userName}]: ${commentCount}æ¡è¯„è®º`);
                });
                
                if (momentsWithComments === 0) {
                    minComments = 0;
                }
                
                console.log(`\n=== è¯„è®ºç»Ÿè®¡ ===`);
                console.log(`æ€»è¯„è®ºæ•°é‡: ${totalComments}`);
                console.log(`æœ‰è¯„è®ºçš„åŠ¨æ€: ${momentsWithComments}/${QQ_MomentsData.length}`);
                console.log(`å¹³å‡æ¯ä¸ªåŠ¨æ€è¯„è®ºæ•°: ${(totalComments / QQ_MomentsData.length).toFixed(2)}`);
                console.log(`è¯„è®ºæ•°é‡èŒƒå›´: ${minComments} - ${maxComments}`);
                
                console.log(`\n=== å¤‡ä»½çŠ¶æ€ ===`);
                console.log(`åŠ¨æ€ä¸Šé™: 50æ¡ (å½“å‰ ${QQ_MomentsData.length}/50)`);
                console.log(`æ¯ä¸ªåŠ¨æ€è¯„è®ºä¸Šé™: 50æ¡ (æœ€å¤šçš„åŠ¨æ€æœ‰ ${maxComments}/50 æ¡è¯„è®º)`);
                
                return {
                    totalMoments: QQ_MomentsData.length,
                    totalComments: totalComments,
                    momentsWithComments: momentsWithComments,
                    maxComments: maxComments,
                    minComments: minComments === Infinity ? 0 : minComments
                };
            };

            /**
             * *** æ–°å¢ï¼šæ‰‹åŠ¨æ¸…ç†åŠ¨æ€å¤‡ä»½ï¼ˆè°ƒè¯•ç”¨ï¼‰ ***
             * å¯åœ¨æ§åˆ¶å°è°ƒç”¨ window.QQ_Manual_Clean_Moments() æ¥æ‰‹åŠ¨æ¸…ç†
             */
            window.QQ_Manual_Clean_Moments = async function() {
                console.log('å¼€å§‹æ‰‹åŠ¨æ¸…ç†åŠ¨æ€å¤‡ä»½...');
                
                if (!QQ_MomentsData || !Array.isArray(QQ_MomentsData)) {
                    console.log('âš ï¸ QQ_MomentsDataä¸å­˜åœ¨æˆ–ä¸æ˜¯æ•°ç»„ï¼Œæ— æ³•æ¸…ç†');
                    return;
                }
                
                const beforeMoments = QQ_MomentsData.length;
                let beforeComments = 0;
                QQ_MomentsData.forEach(m => beforeComments += (m.comments ? m.comments.length : 0));
                
                QQ_CleanOldMoments();
                QQ_OptimizeCommentsStorage();
                
                const afterMoments = QQ_MomentsData.length;
                let afterComments = 0;
                QQ_MomentsData.forEach(m => afterComments += (m.comments ? m.comments.length : 0));
                
                console.log(`æ¸…ç†å®Œæˆ: åŠ¨æ€ ${beforeMoments}â†’${afterMoments}, è¯„è®º ${beforeComments}â†’${afterComments}`);
                
                await QQ_Save_Moments();
                console.log('æ¸…ç†ç»“æœå·²ä¿å­˜åˆ°ä¸–ç•Œä¹¦');
                
                return window.QQ_Show_Moments_Stats();
            };
            
            /**
             * *** æ–°å¢ï¼šæµ‹è¯•èŠå¤©æ¶ˆæ¯æ•°é‡é™åˆ¶åŠŸèƒ½ï¼ˆè°ƒè¯•ç”¨ï¼‰ ***
             */
            window.QQ_Test_Message_Limit = function() {
                console.log('=== èŠå¤©æ¶ˆæ¯æ•°é‡é™åˆ¶æµ‹è¯• ===');
                
                if (!QQ_msgjson) {
                    console.log('âŒ QQ_msgjson ä¸å­˜åœ¨ï¼Œæ— æ³•æµ‹è¯•');
                    return false;
                }
                
                // ç»Ÿè®¡å½“å‰æ¶ˆæ¯æ•°é‡
                let totalMessages = 0;
                let privateChats = 0;
                let groupChats = 0;
                
                if (QQ_msgjson.ç§èŠ) {
                    for (const chatKey in QQ_msgjson.ç§èŠ) {
                        if (Array.isArray(QQ_msgjson.ç§èŠ[chatKey])) {
                            privateChats++;
                            totalMessages += QQ_msgjson.ç§èŠ[chatKey].length;
                        }
                    }
                }
                
                if (QQ_msgjson.ç¾¤èŠ) {
                    for (const groupKey in QQ_msgjson.ç¾¤èŠ) {
                        const group = QQ_msgjson.ç¾¤èŠ[groupKey];
                        if (group && Array.isArray(group.msgs)) {
                            groupChats++;
                            totalMessages += group.msgs.length;
                        }
                    }
                }
                
                console.log(`å½“å‰æ¶ˆæ¯ç»Ÿè®¡:`);
                console.log(`- ç§èŠ: ${privateChats} ä¸ª`);
                console.log(`- ç¾¤èŠ: ${groupChats} ä¸ª`);
                console.log(`- æ€»æ¶ˆæ¯æ•°: ${totalMessages} æ¡`);
                
                if (totalMessages > 1500) {
                    console.log(`âš ï¸ æ¶ˆæ¯æ•°é‡ ${totalMessages} è¶…è¿‡é™åˆ¶1500æ¡ï¼Œä¸‹æ¬¡ä¿å­˜æ—¶ä¼šè‡ªåŠ¨å‰Šå‡`);
                } else {
                    console.log(`âœ… æ¶ˆæ¯æ•°é‡ ${totalMessages} æœªè¶…è¿‡é™åˆ¶1500æ¡`);
                }
                
                console.log('ğŸ’¡ æç¤ºï¼šè°ƒç”¨ QQ_Save_Chat_Backup() æ¥æµ‹è¯•æ¶ˆæ¯é™åˆ¶åŠŸèƒ½');
                
                return {
                    totalMessages,
                    privateChats,
                    groupChats,
                    needsLimit: totalMessages > 1500
                };
            };
            
            /**
             * *** æ–°å¢ï¼šæµ‹è¯•èŠå¤©å¤‡ä»½åŠŸèƒ½ï¼ˆè°ƒè¯•ç”¨ï¼‰ ***
             */
            window.QQ_Test_Chat_Backup = async function() {
                console.log('=== èŠå¤©å¤‡ä»½åŠŸèƒ½æµ‹è¯• ===');
                
                // æ£€æŸ¥ç¯å¢ƒ
                console.log('1. ç¯å¢ƒæ£€æŸ¥:');
                console.log('worldbook:', !!worldbook);
                console.log('entries:', !!entries);
                console.log('QQ_msgjson:', !!QQ_msgjson);
                
                if (!worldbook || !entries) {
                    console.log('âŒ ä¸–ç•Œä¹¦ç¯å¢ƒæœªå‡†å¤‡å¥½');
                    return false;
                }
                
                if (!QQ_msgjson) {
                    console.log('âŒ èŠå¤©æ•°æ®æœªå‡†å¤‡å¥½');  
                    return false;
                }
                
                // æµ‹è¯•ä¿å­˜
                console.log('2. æµ‹è¯•ä¿å­˜åŠŸèƒ½:');
                try {
                    await QQ_Save_Chat_Backup();
                    console.log('âœ… ä¿å­˜æµ‹è¯•å®Œæˆ');
                } catch (error) {
                    console.log('âŒ ä¿å­˜æµ‹è¯•å¤±è´¥:', error);
                    return false;
                }
                
                // æµ‹è¯•åŠ è½½
                console.log('3. æµ‹è¯•åŠ è½½åŠŸèƒ½:');
                try {
                    const result = await QQ_Load_Chat_Backup();
                    console.log('âœ… åŠ è½½æµ‹è¯•å®Œæˆï¼Œç»“æœ:', result);
                } catch (error) {
                    console.log('âŒ åŠ è½½æµ‹è¯•å¤±è´¥:', error);
                    return false;
                }
                
                // æ£€æŸ¥å‡½æ•°å¯ç”¨æ€§
                console.log('4. æ£€æŸ¥å‡½æ•°å¯ç”¨æ€§:');
                console.log('QQ_Save_Chat_Backup:', typeof QQ_Save_Chat_Backup);
                console.log('QQ_Load_Chat_Backup:', typeof QQ_Load_Chat_Backup);
                console.log('QQ_Save_Msg:', typeof QQ_Save_Msg);
                
                console.log('=== æµ‹è¯•å®Œæˆ ===');
                return true;
            };
            
            /**
             * *** æ–°å¢ï¼šæ£€æŸ¥èŠå¤©å¤‡ä»½çŠ¶æ€ï¼ˆè°ƒè¯•ç”¨ï¼‰ ***
             */
            window.QQ_Check_Chat_Backup = async function() {
                console.log('=== èŠå¤©å¤‡ä»½çŠ¶æ€æ£€æŸ¥ ===');
                
                // æ£€æŸ¥å½“å‰QQ_msgjsonçŠ¶æ€
                console.log('å½“å‰QQ_msgjsonçŠ¶æ€:');
                console.log('ç§èŠæ•°é‡:', Object.keys(QQ_msgjson.ç§èŠ || {}).length);
                console.log('ç¾¤èŠæ•°é‡:', Object.keys(QQ_msgjson.ç¾¤èŠ || {}).length);
                
                for (const chatKey in QQ_msgjson.ç§èŠ) {
                    const msgs = QQ_msgjson.ç§èŠ[chatKey];
                    console.log(`ç§èŠ ${chatKey}: ${msgs.length} æ¡æ¶ˆæ¯`);
                    // æ˜¾ç¤ºæœ€åå‡ æ¡æ¶ˆæ¯ï¼ˆè¿‡æ»¤ç³»ç»Ÿæ¶ˆæ¯ï¼‰
                    const recentMsgs = msgs.filter(msg => !msg.startsWith('ç³»ç»Ÿæ¶ˆæ¯--')).slice(-3);
                    recentMsgs.forEach((msg, index) => {
                        console.log(`  ${index + 1}. ${msg}`);
                    });
                }
                
                for (const groupKey in QQ_msgjson.ç¾¤èŠ) {
                    const group = QQ_msgjson.ç¾¤èŠ[groupKey];
                    if (group && group.msgs) {
                        console.log(`ç¾¤èŠ ${groupKey}: ${group.msgs.length} æ¡æ¶ˆæ¯`);
                        // æ˜¾ç¤ºæœ€åå‡ æ¡æ¶ˆæ¯ï¼ˆè¿‡æ»¤ç³»ç»Ÿæ¶ˆæ¯ï¼‰
                        const recentMsgs = group.msgs.filter(msg => !msg.startsWith('ç³»ç»Ÿæ¶ˆæ¯--')).slice(-3);
                        recentMsgs.forEach((msg, index) => {
                            console.log(`  ${index + 1}. ${msg}`);
                        });
                    }
                }
                
                // æ£€æŸ¥worldbookå¤‡ä»½çŠ¶æ€
                if (!worldbook || !entries) {
                    console.log('worldbookæˆ–entriesæœªåˆå§‹åŒ–');
                    return;
                }
                
                const chatBackupEntry = entries.find(entry => entry.comment === "æ‰‹æœº-èŠå¤©æ¶ˆæ¯å¤‡ä»½");
                if (chatBackupEntry) {
                    console.log('æ‰¾åˆ°èŠå¤©å¤‡ä»½æ¡ç›®ï¼Œè§£æå†…å®¹...');
                    try {
                        const backupData = JSON.parse(chatBackupEntry.content);
                        console.log('å¤‡ä»½æ—¶é—´:', backupData.lastUpdated);
                        console.log('å¤‡ä»½ç§èŠæ•°é‡:', Object.keys(backupData.data.ç§èŠ || {}).length);
                        console.log('å¤‡ä»½ç¾¤èŠæ•°é‡:', Object.keys(backupData.data.ç¾¤èŠ || {}).length);
                        
                        // æ£€æŸ¥å¤‡ä»½å†…å®¹ï¼ˆæ’é™¤ç³»ç»Ÿæ¶ˆæ¯ï¼‰
                        for (const chatKey in backupData.data.ç§èŠ) {
                            const msgs = backupData.data.ç§èŠ[chatKey];
                            const nonSystemMsgs = msgs.filter(msg => !msg.startsWith('ç³»ç»Ÿæ¶ˆæ¯--'));
                            console.log(`å¤‡ä»½ç§èŠ ${chatKey}: ${nonSystemMsgs.length} æ¡éç³»ç»Ÿæ¶ˆæ¯ (æ€»å…±${msgs.length}æ¡)`);
                        }
                        
                        for (const groupKey in backupData.data.ç¾¤èŠ) {
                            const group = backupData.data.ç¾¤èŠ[groupKey];
                            if (group && group.msgs) {
                                const nonSystemMsgs = group.msgs.filter(msg => !msg.startsWith('ç³»ç»Ÿæ¶ˆæ¯--'));
                                console.log(`å¤‡ä»½ç¾¤èŠ ${groupKey}: ${nonSystemMsgs.length} æ¡éç³»ç»Ÿæ¶ˆæ¯ (æ€»å…±${group.msgs.length}æ¡)`);
                            }
                        }
                    } catch (error) {
                        console.error('è§£æå¤‡ä»½æ•°æ®å¤±è´¥:', error);
                    }
                } else {
                    console.log('æœªæ‰¾åˆ°èŠå¤©å¤‡ä»½æ¡ç›®');
                }
                
                console.log('=== æ£€æŸ¥å®Œæˆ ===');
            };

            /**
             * *** æ–°å¢ï¼šæŸ¥çœ‹åˆ†ç»„å¤‡ä»½çŠ¶æ€ ***
             * å¯åœ¨æ§åˆ¶å°è°ƒç”¨ window.QQ_Show_Groups_Stats() æ¥æŸ¥çœ‹åˆ†ç»„å¤‡ä»½ç»Ÿè®¡
             */
            window.QQ_Show_Groups_Stats = function() {
                const charId = getCurrentCharacterId();
                
                if (!worldbook || !entries) {
                    console.log('ğŸ“Š åˆ†ç»„å¤‡ä»½ç»Ÿè®¡ï¼šä¸–ç•Œä¹¦æœªåˆå§‹åŒ–');
                    return;
                }
                
                const groupsKey = `QQ_åˆ†ç»„å¤‡ä»½_${charId}`;
                const groupsEntry = entries.find(entry => 
                    entry.keys && Array.isArray(entry.keys) && entry.keys.includes(groupsKey)
                );
                
                let worldbookGroups = 0;
                let lastUpdate = null;
                
                if (groupsEntry && groupsEntry.content) {
                    try {
                        const groupsData = JSON.parse(groupsEntry.content);
                        worldbookGroups = groupsData.groups ? groupsData.groups.length : 0;
                        lastUpdate = groupsData.lastUpdate;
                    } catch (e) {
                        console.error('è§£æä¸–ç•Œä¹¦åˆ†ç»„æ•°æ®å¤±è´¥:', e);
                    }
                }
                
                // *** ç§»é™¤localStorageæ£€æŸ¥é€»è¾‘ï¼Œç»Ÿä¸€ä½¿ç”¨ä¸–ç•Œä¹¦ ***
                let localGroups = 0; // ä¿æŒä¸º0ï¼Œä¸å†æ£€æŸ¥localStorage
                
                console.log(`ğŸ“Š åˆ†ç»„å¤‡ä»½ç»Ÿè®¡ (è§’è‰²: ${charId})ï¼š
                å½“å‰å†…å­˜ä¸­åˆ†ç»„: ${contactGroups.length}ä¸ª
                ä¸–ç•Œä¹¦ä¸­åˆ†ç»„: ${worldbookGroups}ä¸ª
                localStorageä¸­åˆ†ç»„: ${localGroups}ä¸ª
                æœ€åä¿å­˜æ—¶é—´: ${lastUpdate ? new Date(lastUpdate).toLocaleString() : 'æœªçŸ¥'}
                å­˜å‚¨ä½ç½®: ${worldbookGroups > 0 ? 'ä¸–ç•Œä¹¦' : (localGroups > 0 ? 'localStorage' : 'æ— æ•°æ®')}`);
                
                if (localGroups > 0 && worldbookGroups === 0) {
                    console.log('ğŸ’¡ æç¤ºï¼šæ£€æµ‹åˆ°localStorageä¸­æœ‰æ—§çš„åˆ†ç»„æ•°æ®ï¼Œå»ºè®®åˆ›å»ºæ–°åˆ†ç»„ä»¥è¿ç§»åˆ°ä¸–ç•Œä¹¦');
                }
                
                return {
                    characterId: charId,
                    memoryGroups: contactGroups.length,
                    worldbookGroups: worldbookGroups,
                    localStorageGroups: localGroups,
                    lastUpdate: lastUpdate,
                    storageLocation: worldbookGroups > 0 ? 'worldbook' : (localGroups > 0 ? 'localStorage' : 'none')
                };
            };
            
            /**
             * *** æ–°å¢ï¼šåŠ¨æ€åˆ é™¤åŠŸèƒ½ ***
             */
            
            // åŠ¨æ€èœå•çŠ¶æ€
            let currentMomentMenu = null;
            
            /**
             * åˆ é™¤æŒ‡å®šåŠ¨æ€
             * @param {string} momentId - åŠ¨æ€ID 
             */
            async function QQ_Delete_Moment(momentId) {
                if (!momentId) {
                    console.error('åˆ é™¤åŠ¨æ€å¤±è´¥ï¼šç¼ºå°‘åŠ¨æ€ID');
                    return false;
                }
                
                try {
                    // ä»QQ_MomentsDataæ•°ç»„ä¸­åˆ é™¤æŒ‡å®šåŠ¨æ€
                    const originalLength = QQ_MomentsData.length;
                    QQ_MomentsData = QQ_MomentsData.filter(moment => moment.id !== momentId);
                    
                    if (QQ_MomentsData.length < originalLength) {
                        console.log(`æˆåŠŸåˆ é™¤åŠ¨æ€ID: ${momentId}`);
                        
                        // ä»ç•Œé¢ä¸­ç§»é™¤åŠ¨æ€å…ƒç´ 
                        $(`.user_moment[data-moment-id="${momentId}"]`).fadeOut(300, function() {
                            $(this).remove();
                        });
                        
                        // ä¿å­˜æ›´æ–°åçš„åŠ¨æ€æ•°æ®åˆ°worldbook
                        await QQ_Save_Moments();
                        
                        return true;
                    } else {
                        console.error('åˆ é™¤åŠ¨æ€å¤±è´¥ï¼šæœªæ‰¾åˆ°æŒ‡å®šåŠ¨æ€');
                        return false;
                    }
                } catch (error) {
                    console.error('åˆ é™¤åŠ¨æ€æ—¶å‡ºé”™:', error);
                    return false;
                }
            }
            
            /**
             * æ˜¾ç¤ºåŠ¨æ€èœå•
             * @param {Event} event - ç‚¹å‡»äº‹ä»¶
             */
            function showMomentMenu(event) {
                event.stopPropagation();
                
                // éšè—ä¹‹å‰çš„èœå•
                hideMomentMenu();
                
                const momentId = $(event.currentTarget).data('moment-id');
                const $dots = $(event.currentTarget);
                
                // åˆ›å»ºèœå•
                const $menu = $(`
                    <div class="moment_menu_dropdown" style="
                        position: absolute;
                        background: white;
                        border: 1px solid #e1e1e1;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        z-index: 1000;
                        min-width: 120px;
                        overflow: hidden;
                    ">
                        <div class="moment_menu_item" data-action="delete" data-moment-id="${momentId}" style="
                            padding: 12px 16px;
                            cursor: pointer;
                            font-size: 14px;
                            color: #e74c3c;
                            border-bottom: 1px solid #f5f5f5;
                            background: white;
                            transition: background-color 0.2s;
                        ">
                            ğŸ—‘ï¸ åˆ é™¤åŠ¨æ€
                        </div>
                        <div class="moment_menu_item" data-action="cancel" style="
                            padding: 12px 16px;
                            cursor: pointer;
                            font-size: 14px;
                            color: #666;
                            background: white;
                            transition: background-color 0.2s;
                        ">
                            âŒ å–æ¶ˆ
                        </div>
                    </div>
                `);
                
                // è®¡ç®—èœå•ä½ç½®
                const dotsRect = $dots[0].getBoundingClientRect();
                const scrollTop = $(window).scrollTop();
                const scrollLeft = $(window).scrollLeft();
                
                $menu.css({
                    top: dotsRect.bottom + scrollTop + 5,
                    left: dotsRect.right + scrollLeft - 120, // å³å¯¹é½
                });
                
                // æ·»åŠ åˆ°é¡µé¢
                $('body').append($menu);
                currentMomentMenu = $menu;
                
                // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                $menu.css({
                    opacity: 0,
                    transform: 'scale(0.95) translateY(-10px)'
                }).animate({
                    opacity: 1
                }, 200).css({
                    transform: 'scale(1) translateY(0)'
                });
                
                // æ·»åŠ èœå•é¡¹æ‚¬åœæ•ˆæœ
                $menu.find('.moment_menu_item').hover(
                    function() {
                        $(this).css('background-color', '#f8f9fa');
                    },
                    function() {
                        $(this).css('background-color', 'white');
                    }
                );
            }
            
            /**
             * éšè—åŠ¨æ€èœå•
             */
            function hideMomentMenu() {
                if (currentMomentMenu) {
                    currentMomentMenu.fadeOut(150, function() {
                        $(this).remove();
                    });
                    currentMomentMenu = null;
                }
            }
            
            /**
             * ç¡®è®¤åˆ é™¤åŠ¨æ€å¯¹è¯æ¡†
             * @param {string} momentId - åŠ¨æ€ID
             */
            function confirmDeleteMoment(momentId) {
                // åˆ›å»ºç¡®è®¤å¯¹è¯æ¡†
                const $dialog = $(`
                    <div class="moment_confirm_dialog" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        z-index: 2000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    ">
                        <div style="
                            background: white;
                            border-radius: 12px;
                            padding: 24px;
                            max-width: 300px;
                            width: 90%;
                            text-align: center;
                            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
                        ">
                            <div style="font-size: 18px; margin-bottom: 16px; color: #333;">
                                ğŸ—‘ï¸ ç¡®è®¤åˆ é™¤
                            </div>
                            <div style="color: #666; margin-bottom: 20px; line-height: 1.5;">
                                åˆ é™¤åæ— æ³•æ¢å¤ï¼Œç¡®å®šè¦åˆ é™¤è¿™æ¡åŠ¨æ€å—ï¼Ÿ
                            </div>
                            <div style="display: flex; gap: 12px;">
                                <button class="moment_dialog_btn moment_dialog_cancel" style="
                                    flex: 1;
                                    padding: 12px;
                                    border: 1px solid #ddd;
                                    border-radius: 6px;
                                    background: white;
                                    color: #666;
                                    cursor: pointer;
                                    font-size: 14px;
                                ">å–æ¶ˆ</button>
                                <button class="moment_dialog_btn moment_dialog_confirm" data-moment-id="${momentId}" style="
                                    flex: 1;
                                    padding: 12px;
                                    border: none;
                                    border-radius: 6px;
                                    background: #e74c3c;
                                    color: white;
                                    cursor: pointer;
                                    font-size: 14px;
                                ">åˆ é™¤</button>
                            </div>
                        </div>
                    </div>
                `);
                
                // æ·»åŠ åˆ°é¡µé¢
                $('body').append($dialog);
                
                // æ·»åŠ æŒ‰é’®æ‚¬åœæ•ˆæœ
                $dialog.find('.moment_dialog_cancel').hover(
                    function() { $(this).css('background-color', '#f8f9fa'); },
                    function() { $(this).css('background-color', 'white'); }
                );
                
                $dialog.find('.moment_dialog_confirm').hover(
                    function() { $(this).css('background-color', '#c0392b'); },
                    function() { $(this).css('background-color', '#e74c3c'); }
                );
                
                // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                $dialog.css('opacity', 0).animate({ opacity: 1 }, 200);
            }
            function QQ_Json2Text(json) {
                console.log(`ä¼ è¿›æ¥çš„json:${JSON.stringify(json)}`);
                let result = "";
                for (const key in json.ç§èŠ) {
                    if (json.ç§èŠ[key].length == 0) {
                        continue;
                    }
                    let localkey = key.replace("çš„èŠå¤©", "çš„ç§èŠ");
                    result += `<${localkey}>\n`;
                    for (const msg of json.ç§èŠ[key]) {
                        result += `${msg}\n`;
                    }
                    result += `</${localkey}>\n`;
                }
                for (const group in json.ç¾¤èŠ) {
                    let localkey = `ç¾¤èŠ:${group}`;
                    result += `<${localkey}>\n`;
                    if (json.ç¾¤èŠ[group].members) {
                        result += `<æˆå‘˜>`;
                        result += `${json.ç¾¤èŠ[group].members.join(",")}`;
                        result = `${result.trim()}</æˆå‘˜>\n`;
                    }
                    result += `<èŠå¤©å†…å®¹>\n`;
                    for (const msg of json.ç¾¤èŠ[group].msgs) {
                        result += `${msg}\n`;
                    }
                    result += `</èŠå¤©å†…å®¹>\n`;
                    result += `</${localkey}>\n`;
                }
                return result.trim();
            }
            // FIXME: æ˜æ˜¾ json çš„ç±»å‹å¯ä»¥æ›´å‡†ç¡®
            /**
             * åˆ é™¤æ¶ˆæ¯
             * @param json æ¶ˆæ¯è®°å½•
             * @returns
             */
            function QQ_Msg_DeletOld(json) {
                // åˆ é™¤ç§èŠçš„æ—§å†…å®¹
                for (const str in json.ç§èŠ) {
                    const match = str.match(/(.+?)å’Œ(.+?)çš„èŠå¤©/);
                    if (!match) {
                        continue;
                    }
                    let name = "";
                    if (match[1] != `${UserName}`) {
                        name = match[1];
                    } else if (match[2] != `${UserName}`) {
                        name = match[2];
                    } else {
                        continue;
                    }
                    // å…ˆåˆ¤æ–­æœ‰æ²¡æœ‰æ¶ˆæ¯å†…å®¹,æ²¡æœ‰å°±ä¸‹ä¸€ä¸ª
                    if (json.ç§èŠ[str].length == 0) {
                        continue;
                    }
                    
                    // *** ä¿®å¤ï¼šå¢å¼ºçš„ç”¨æˆ·æ¶ˆæ¯é‡å¤è¿‡æ»¤ ***
                    json.ç§èŠ[str] = QQ_FilterDuplicateUserMessages(json.ç§èŠ[str], name);
                    // åå‘æ‰¾è‡ªå·±å‘çš„æœ€åä¸€æ¡çš„ä½ç½®
                    let lastSelfMsgIndex = -1;
                    for (let i = json.ç§èŠ[str].length - 1; i >= 0; i--) {
                        let ok = false;
                        if (
                            User_LastMsgMap.ç§èŠ[name] &&
                            json.ç§èŠ[str][i].indexOf(
                                User_LastMsgMap.ç§èŠ[name],
                            ) > -1
                        ) {
                            ok = true;
                        } else if (
                            Char_LastMsgMap.ç§èŠ[name] &&
                            json.ç§èŠ[str][i].indexOf(
                                Char_LastMsgMap.ç§èŠ[name],
                            ) > -1
                        ) {
                            ok = true;
                        }
                        if (ok) {
                            lastSelfMsgIndex = i;
                            break; // æ‰¾åˆ°æœ€åä¸€æ¡å°±åœæ­¢
                        }
                    }
                    if (lastSelfMsgIndex !== -1) {
                        json.ç§èŠ[str] = json.ç§èŠ[str].slice(
                            lastSelfMsgIndex + 1,
                        );
                        console.log(`åˆ é™¤${name}çš„é‡å¤èŠå¤©è®°å½•!!!`);
                    }
                }
                // åˆ é™¤ç¾¤èŠçš„æ—§å†…å®¹
                for (const name in json.ç¾¤èŠ) {
                    // å…ˆåˆ¤æ–­æœ‰æ²¡æœ‰æ¶ˆæ¯å†…å®¹,æ²¡æœ‰å°±ä¸‹ä¸€ä¸ª
                    if (json.ç¾¤èŠ[name].msgs.length == 0) {
                        continue;
                    }
                    
                    // *** ä¿®å¤ï¼šå¢å¼ºçš„ç”¨æˆ·æ¶ˆæ¯é‡å¤è¿‡æ»¤ ***
                    json.ç¾¤èŠ[name].msgs = QQ_FilterDuplicateUserMessages(json.ç¾¤èŠ[name].msgs, name);
                    // åå‘æ‰¾è‡ªå·±å‘çš„æœ€åä¸€æ¡çš„ä½ç½®
                    let lastSelfMsgIndex = -1;
                    for (let i = json.ç¾¤èŠ[name].msgs.length - 1; i >= 0; i--) {
                        let ok = false;
                        if (
                            User_LastMsgMap.ç¾¤èŠ[name] &&
                            json.ç¾¤èŠ[name].msgs[i].indexOf(
                                User_LastMsgMap.ç¾¤èŠ[name],
                            ) > -1
                        ) {
                            ok = true;
                        } else if (
                            Char_LastMsgMap.ç¾¤èŠ[name] &&
                            json.ç¾¤èŠ[name].msgs[i].indexOf(
                                Char_LastMsgMap.ç¾¤èŠ[name],
                            ) > -1
                        ) {
                            ok = true;
                        }
                        if (ok) {
                            lastSelfMsgIndex = i;
                            break; // æ‰¾åˆ°æœ€åä¸€æ¡å°±åœæ­¢
                        }
                    }
                    if (lastSelfMsgIndex !== -1) {
                        json.ç¾¤èŠ[name].msgs = json.ç¾¤èŠ[name].msgs.slice(
                            lastSelfMsgIndex + 1,
                        );
                        console.log(`åˆ é™¤${name}çš„é‡å¤èŠå¤©è®°å½•!!!`);
                    }
                }
                // å–charæœ€åä¸€æ¡æ¶ˆæ¯åŠ å…¥åˆ°User_LastMsgMap
                for (const name in json.ç§èŠ) {
                    let length = json.ç§èŠ[name].length;
                    if (length > 0) {
                        Char_LastMsgMap.ç§èŠ[name] =
                            json.ç§èŠ[name][length - 1];
                    }
                }
                for (const name in json.ç¾¤èŠ) {
                    let length = json.ç¾¤èŠ[name].msgs.length;
                    if (length > 0) {
                        Char_LastMsgMap.ç¾¤èŠ[name] =
                            json.ç¾¤èŠ[name].msgs[length - 1];
                    }
                }
                console.log(
                    `Char_LastMsgMap:\n${JSON.stringify(Char_LastMsgMap)}`,
                );
                return json;
            }

            /**
             * ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ°ç§èŠæ•°æ®ç»“æ„
             * @param {string} name - èŠå¤©å¯¹è±¡åç§°
             * @param {string} userMessage - ç”¨æˆ·æ¶ˆæ¯
             */
            function QQ_SaveUserMessageToPrivateChat(name, userMessage) {
                const chatKey = `${UserName}å’Œ${name}çš„èŠå¤©`;
                if (!QQ_msgjson.ç§èŠ[chatKey]) {
                    QQ_msgjson.ç§èŠ[chatKey] = [];
                }
                if (!QQ_msgjson.ç§èŠ[chatKey].includes(userMessage)) {
                    QQ_msgjson.ç§èŠ[chatKey].push(userMessage);
                    // åŒæ—¶æ›´æ–°User_LastMsgMap
                    if (!User_LastMsgMap.ç§èŠ) {
                        User_LastMsgMap.ç§èŠ = {};
                    }
                    User_LastMsgMap.ç§èŠ[name] = userMessage;
                }
            }

            /**
             * æŒ‰ä¸‹å›è½¦é”®
             * @param e äº‹ä»¶å¯¹è±¡
             * @param element å…ƒç´ 
             */
            async function QQ_EnterPress(e, element) {
                if (e.key !== "Enter") {
                    return;
                }
                const val = $(element).val();
                if (!val) {
                    return;
                }
                let content = val.toString();
                content = QQ_MySendSpecial(content);
                const $closest = $(element.closest(".QQ_chat_page"));
                const $msgContent = $closest.find(".msgcontent");
                const userContent = QQ_Chat_SpecialMsg(
                    content,
                    `${UserName}`,
                    false,
                    true,
                );
                const html = _.template(chat_user_message)({
                    content: userContent,
                });
                const name = $closest.attr("data-name") ?? "";
                console.log(`å‘é€æ–‡æœ¬:${content} å¯¹è±¡:${name}`);
                $msgContent.append(html);
                $msgContent[0].scrollTop = $msgContent[0].scrollHeight;
                $(element).val("");
                
                // *** æ–°å¢ï¼šç«‹å³å°†ç¼“å­˜çš„ç”¨æˆ·æ¶ˆæ¯ä¿å­˜åˆ°æ•°æ®ç»“æ„å’Œä¸–ç•Œä¹¦ ***
                // *** ä¿®å¤ï¼šåªç¼“å­˜æ¶ˆæ¯ï¼Œä¸ç«‹å³ä¿å­˜åˆ°æ•°æ®ç»“æ„ ***
                if (QQ_Groups.includes(name)) {
                    QQ_CacheSendMsg += `\nåœ¨ç¾¤èŠ${name}ä¸­å‘é€:${content}`;
                    console.log(`ğŸ“ ç¾¤èŠæ¶ˆæ¯å·²ç¼“å­˜: ${content}`);
                } else {
                    QQ_CacheSendMsg += `\nç»™${name}å‘æ¶ˆæ¯:${content}`;
                    console.log(`ğŸ“ ç§èŠæ¶ˆæ¯å·²ç¼“å­˜: ${content}`);
                }
                
                console.log(`ğŸ“‹ å½“å‰ç¼“å­˜å†…å®¹: ${QQ_CacheSendMsg}`);
            }
            /**
             * é‡rollæ¶ˆæ¯
             * @param event äº‹ä»¶å¯¹è±¡
             * @returns
             */
            async function QQ_Roll(event) {
                const result = confirm("ç¡®å®šé‡rollè¿™æ¡æ¶ˆæ¯å—?");
                if (!result) {
                    return;
                }
                // åœæ­¢äº‹ä»¶ä¼ æ’­
                event.stopPropagation();
                if (!event.currentTarget) {
                    return;
                }
                const $avatar = $(event.currentTarget);
                console.log("ç‚¹å‡»çš„å¤´åƒå…ƒç´ :", $avatar);
                // æŸ¥æ‰¾çˆ¶çº§æ¶ˆæ¯å®¹å™¨
                const $chatMsg = $avatar.closest(".QQ_chat_mymsg");
                if ($chatMsg.length === 0) {
                    console.error("æœªæ‰¾åˆ°æ¶ˆæ¯å®¹å™¨!");
                    return;
                }
                // è·å–æ¶ˆæ¯å†…å®¹
                let value;
                const $msgContent = $chatMsg
                    .find(".QQ_chat_msgdiv span")
                    .first();
                if ($msgContent.length > 0) {
                    value = $msgContent.text();
                }
                // è·å–å½“å‰æ¶ˆæ¯çš„ç´¢å¼•
                const index = $chatMsg.index();
                console.log(`ç‚¹å‡»index:${index}`);
                // è·å–èŠå¤©å¯¹è±¡åç§°
                const $chatPage = $chatMsg.closest(".QQ_chat_page");
                if ($chatPage.length === 0) {
                    console.error("æœªæ‰¾åˆ°èŠå¤©é¡µé¢!");
                    return;
                }
                const name = $chatPage.attr("data-name") ?? "";
                console.log("èŠå¤©å¯¹è±¡:", name);
                console.log(`åˆ é™¤å‰çš„è®°å½•:${YAML.stringify(QQ_msgjson)}`);
                if (QQ_Groups.includes(name)) {
                    if (QQ_msgjson.ç¾¤èŠ[name].msgs.length > index) {
                        const sp =
                            QQ_msgjson.ç¾¤èŠ[name].msgs[index].split("--");
                        if (sp.length >= 2) {
                            value = sp[1];
                        }
                    }
                    QQ_msgjson.ç¾¤èŠ[name].msgs.length = index;
                } else {
                    const key = `${UserName}å’Œ${name}çš„èŠå¤©`;
                    if (QQ_msgjson.ç§èŠ[key].length > index) {
                        const sp = QQ_msgjson.ç§èŠ[key][index].split("--");
                        if (sp.length >= 2) {
                            value = sp[1];
                        }
                    }
                    QQ_msgjson.ç§èŠ[key].length = index;
                }
                console.log(`åˆ é™¤åçš„è®°å½•:${YAML.stringify(QQ_msgjson)}`);
                // åˆ é™¤åé¢æ‰€æœ‰æ¶ˆæ¯å†…å®¹
                $chatMsg.nextAll().remove();
                await QQ_Save_Msg();
                
                // *** ä¿®å¤ï¼šä½¿ç”¨ä¿å­˜çš„å®Œæ•´è¯·æ±‚å†…å®¹è¿›è¡Œé‡roll ***
                if (QQ_LastRequest && QQ_LastRequestName === name) {
                    console.log('ğŸ”„ ä½¿ç”¨ä¿å­˜çš„å®Œæ•´è¯·æ±‚å†…å®¹è¿›è¡Œé‡roll');
                    console.log(`é‡rollè¯·æ±‚å†…å®¹: ${QQ_LastRequest.substring(0, 200)}...`);
                    
                    gening = true;
                    try {
                        const result = await QQ_Gen(QQ_LastRequest);
                        await ResultHandle(result);
                    } catch (error) {
                        console.error('é‡rollè¯·æ±‚å¤±è´¥:', error);
                        QQ_Error(`é‡rollå¤±è´¥: ${error.message}`);
                    } finally {
                        gening = false;
                    }
                } else {
                    console.log('âš ï¸ æœªæ‰¾åˆ°ä¿å­˜çš„å®Œæ•´è¯·æ±‚å†…å®¹ï¼Œå›é€€åˆ°ç®€å•é‡å‘');
                    QQ_SendMsg(event, value, name);
                }
            }
            function QQ_Voice2Text(event) {
                // åœæ­¢äº‹ä»¶ä¼ æ’­
                event.stopPropagation();
                if (!event.currentTarget) {
                    return;
                }
                const $avatar = $(event.currentTarget);
                const $tobutton = $avatar.find(".totext");
                if ($tobutton.length === 0) {
                    console.log(`è·å–è½¬æ–‡å­—æŒ‰é’®å¤±è´¥`);
                }
                const $text = $avatar.next();
                if ($text.css("display") == "block") {
                    // $tobutton.css("visibility", "visible");
                    $text.hide();
                } else {
                    // $tobutton.css("visibility", "hidden");
                    $text.show();
                    $tobutton.css("margin-left", "auto");
                }
            }
            async function QQ_SendMsg(event, SendValue, SendName) {
                // 1. ä¿ç•™ï¼šè·å–å½“å‰çœŸå®æ—¶é—´ä¿¡æ¯
                const timeContext = QQ_GetTimeContext(); // (å‡è®¾æ‚¨å·²å°†æ—¶é—´é€»è¾‘å°è£…)

                // 2. ä¿ç•™ï¼šé‡ç½®é‡è¯•å¹¶æ£€æŸ¥ç”ŸæˆçŠ¶æ€
                QQ_ResetRetry();
                if (gening) {
                    triggerSlash("/echo ç”Ÿæˆä¸­,è¯·å‹¿é‡å¤å‘é€");
                    return;
                }

                let name, value, content;

                // 3. ä¿ç•™ï¼šç¡®å®šç”¨æˆ·æ“ä½œå†…å®¹ï¼Œå¹¶åœ¨UIä¸Šå®æ—¶æ˜¾ç¤º
                if (!SendValue) {
                    const $container = $(event.target).closest(".QQ_chat_page");
                    name = $container.attr("data-name") || "æœªçŸ¥ç”¨æˆ·";
                    
                    // *** ä¿®å¤ï¼šæ£€æŸ¥ä¸–ç•Œä¹¦ä¸­æ˜¯å¦æœ‰è¯¥ç¾¤èŠï¼Œå¦‚æœæœ‰åˆ™æ·»åŠ åˆ°QQ_Groups ***
                    if (!QQ_Groups.includes(name) && name !== "æœªçŸ¥ç”¨æˆ·") {
                        if (entries) {
                            // å…ˆæ£€æŸ¥æ˜¯å¦æœ‰ä¸“é—¨çš„ç¾¤èŠæ¡ç›®
                            const groupEntry = entries.find(e => e.comment === `æ‰‹æœº-ç¾¤èŠ-${name}`);
                            if (groupEntry) {
                                // è§£æç¾¤èŠæ¡ç›®ï¼Œç¡®è®¤æœ‰æˆå‘˜åˆ—è¡¨
                                const content = groupEntry.content || '';
                                const hasMembers = content.includes('æˆå‘˜=') && content.split('æˆå‘˜=')[1];
                                if (hasMembers) {
                                    const membersLine = content.split('\n').find(line => line.trim().startsWith('æˆå‘˜='));
                                    if (membersLine) {
                                        const members = membersLine.substring(3).split(/[,ï¼Œ]/).map(m => m.trim()).filter(m => m);
                                        // ç¾¤èŠè‡³å°‘éœ€è¦æœ‰æˆå‘˜ï¼ˆä¸åªæ˜¯ç”¨æˆ·å’Œä¸€ä¸ªè§’è‰²ï¼‰
                                        if (members.length > 0) {
                                            console.log(`âœ… å‘ç°æ–°ç¾¤èŠ "${name}"ï¼Œæˆå‘˜: ${members.join(', ')}`);
                                            QQ_Groups.push(name);
                                            window.QQ_Groups = QQ_Groups;
                                        }
                                    }
                                }
                            }
                        }
                    }
                    
                    const input = $container.find(".userInput");
                    content = input.val()?.toString() ?? "";
                    if (content) {
                        const SpecialHtml = QQ_Chat_SpecialMsg(content, `${UserName}`, false, true);
                        const html = _.template(chat_user_message)({ content: SpecialHtml });
                        $container.find(".msgcontent").append(html).scrollTop($container.find(".msgcontent")[0].scrollHeight);
                        input.val("");
                        
                        // *** ä¿®å¤ï¼šå¤„ç†æ‰€æœ‰ç”¨æˆ·æ¶ˆæ¯ï¼ˆåŒ…æ‹¬ç¼“å­˜çš„æ¶ˆæ¯ï¼‰ ***
                        // æ ‡è®°ä¼šè¯å¼€å§‹
                        if (!QQ_SessionStarted) {
                            QQ_SessionStarted = true;
                            console.log('ğŸš€ ä¼šè¯å¼€å§‹ï¼Œåç»­æ¶ˆæ¯å°†åˆ†é…åºåˆ—å·');
                        }
                        
                        // ç»„åˆæ‰€æœ‰æ¶ˆæ¯ï¼šç¼“å­˜æ¶ˆæ¯ + å½“å‰æ¶ˆæ¯
                        const allUserMessages = [];
                        const currentTime = new Date().toLocaleTimeString('zh-CN', { hour12: false });
                        
                        // å¤„ç†ç¼“å­˜çš„æ¶ˆæ¯
                        if (QQ_CacheSendMsg) {
                            const namevalue = QQ_GetValueName(QQ_CacheSendMsg);
                            if (namevalue) {
                                for (const match of namevalue) {
                                    allUserMessages.push({
                                        name: match.name,
                                        content: match.value, // ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„å±æ€§å
                                        time: currentTime,
                                        isGroup: QQ_Groups.includes(match.name)
                                    });
                                }
                            }
                        }
                        
                        // æ·»åŠ å½“å‰è¾“å…¥çš„æ¶ˆæ¯
                        if (content) {
                            allUserMessages.push({
                                name: name,
                                content: content,
                                time: currentTime,
                                isGroup: QQ_Groups.includes(name)
                            });
                        }
                        
                        // *** ä¿®å¤ï¼šåœ¨æ¸…ç©ºç¼“å­˜å‰æ„å»ºå®Œæ•´çš„value ***
                        let fullValue = QQ_CacheSendMsg || ""; // è·å–æ‰€æœ‰ç¼“å­˜æ¶ˆæ¯
                        if (content) {
                            const isCurrentGroup = QQ_Groups.includes(name);
                            const actionText = isCurrentGroup ? `åœ¨ç¾¤èŠ${name}ä¸­å‘é€:${content}` : `ç»™${name}å‘æ¶ˆæ¯:${content}`;
                            fullValue += (fullValue ? '\n' : '') + actionText; // æ·»åŠ å½“å‰æ¶ˆæ¯
                        }
                        
                        // ä¸ºæ‰€æœ‰æ¶ˆæ¯åˆ†é…åºåˆ—å·å¹¶ä¿å­˜
                        for (const msgInfo of allUserMessages) {
                            // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿æ¶ˆæ¯å†…å®¹å­˜åœ¨
                            if (!msgInfo.content || !msgInfo.name) {
                                console.warn('âš ï¸ è·³è¿‡æ— æ•ˆæ¶ˆæ¯:', msgInfo);
                                continue;
                            }
                            
                            const sequenceId = QQ_GetNextMessageId();
                            const userMessageBase = `${UserName}--${msgInfo.content}--${msgInfo.time}`;
                            const userMessage = QQ_AddSequenceIdToMessage(userMessageBase, sequenceId);
                            console.log(`ğŸ”¢ ç”¨æˆ·æ¶ˆæ¯åˆ†é…åºåˆ—å· [${sequenceId}]: ${msgInfo.content.substring(0, 30)}...`);
                            
                            if (msgInfo.isGroup) {
                                // ç¾¤èŠæ¶ˆæ¯
                                if (!QQ_msgjson.ç¾¤èŠ[msgInfo.name]) {
                                    QQ_msgjson.ç¾¤èŠ[msgInfo.name] = { msgs: [] };
                                }
                                if (!QQ_msgjson.ç¾¤èŠ[msgInfo.name].msgs.includes(userMessage)) {
                                    QQ_msgjson.ç¾¤èŠ[msgInfo.name].msgs.push(userMessage);
                                }
                            } else {
                                // ç§èŠæ¶ˆæ¯
                                QQ_SaveUserMessageToPrivateChat(msgInfo.name, userMessage);
                            }
                        }
                        
                        // æ¸…ç©ºç¼“å­˜
                        QQ_CacheSendMsg = "";
                        console.log(`ğŸ“ å·²æ¸…ç©ºæ¶ˆæ¯ç¼“å­˜`);
                        
                        // *** æ–°å¢ï¼šç«‹å³ä¿å­˜æ•°æ®åˆ°ä¸–ç•Œä¹¦ï¼Œç¡®ä¿æŒä¹…åŒ– ***
                        await QQ_Save_Chat_Backup();
                        console.log(`âœ… æ‰€æœ‰ç”¨æˆ·æ¶ˆæ¯å·²è®°å½•å¹¶ä¿å­˜ï¼Œå…± ${allUserMessages.length} æ¡`);
                        
                        // *** ä½¿ç”¨æ„å»ºå¥½çš„å®Œæ•´value ***
                        value = fullValue;
                    }
                        } else {
                    name = SendName || "æœªçŸ¥ç”¨æˆ·";
                    content = SendValue;
                    value = QQ_Groups.includes(name) ? `åœ¨ç¾¤èŠ"${name}"ä¸­å‘é€:${content}` : `ç»™${name}å‘æ¶ˆæ¯:${content}`;
                }

                if (!value.trim()) {
                        QQ_Error("å‘é€æ¶ˆæ¯ä¸èƒ½ä¸ºç©º");
                        return;
                    }

                // 4. ã€å…¨æ–°æ ¸å¿ƒé€»è¾‘ã€‘åˆ†æç”¨æˆ·æ“ä½œï¼Œæ„å»ºä»»åŠ¡åˆ—è¡¨
                let tasks = { privateChats: [], groupChats: [], interactiveTask: null };
                        const namevalue = QQ_GetValueName(value);
                        if (namevalue) {
                            for (const match of namevalue) {
                                let localname = match.name;
                                if (QQ_Groups.includes(localname)) {
                            if (!tasks.groupChats.some(g => g[localname])) tasks.groupChats.push({ [localname]: [] });
                                } else {
                            if (!tasks.privateChats.includes(localname)) tasks.privateChats.push(localname);
                        }
                        // ... (æ‚¨åŸæœ‰çš„æ›´æ–° QQ_msgjson å’Œ User_LastMsgMap çš„é€»è¾‘ä¸å˜) ...
                    }
                }
                
                // 5. ã€å…¨æ–°æ ¸å¿ƒé€»è¾‘ã€‘ä¿ç•™å¹¶æ•´åˆäº’åŠ¨æ„å›¾æ£€æµ‹
                const interactiveResult = QQ_DetectInteractiveIntent(content);
                if (interactiveResult && interactiveResult.isInteractive) {
                    console.log(`æ£€æµ‹åˆ°ç”¨æˆ·äº’åŠ¨æ„å›¾: ${interactiveResult.description}`);
                    tasks.interactiveTask = interactiveResult; // å°†äº’åŠ¨æ„å›¾åŠ å…¥ä»»åŠ¡åˆ—è¡¨
                        QQ_UserTriggeredInteractive = true;
                        } else {
                        QQ_UserTriggeredInteractive = false;
                        console.log('âœ… æœªæ£€æµ‹åˆ°äº’åŠ¨æ„å›¾ï¼Œä¿æŒæ ‡å‡†è¯·æ±‚æ¨¡å¼');
                }
                
                // 6. ã€å…¨æ–°æ ¸å¿ƒé€»è¾‘ã€‘è°ƒç”¨åŠ¨æ€æŒ‡ä»¤ç”Ÿæˆå™¨ï¼Œåˆ›å»ºé‡èº«å®šåˆ¶çš„Prompt
                const finalPrompt = buildDynamicPrompt(tasks);
                
                // 7. æ³¨å…¥é˜¶æ®µäºŒç³»ç»Ÿä¸Šä¸‹æ–‡ (è®©AIèƒ½å¤Ÿ"çœ‹åˆ°"ç¯å¢ƒå˜åŒ–)
                const systemContext = QQ_GenerateSystemContext();
                console.log(`ğŸ” é˜¶æ®µäºŒç³»ç»Ÿä¸Šä¸‹æ–‡:\n${systemContext}`);
                
                // 8. é˜¶æ®µä¸‰ï¼šæ³¨å…¥ä¸»åŠ¨æ¶ˆæ¯ç”ŸæˆæŒ‡ä»¤
                const proactivePrompt = QQ_GenerateProactiveMessagePrompt();
                
                // 9. ç»„åˆæœ€ç»ˆå‘é€ç»™AIçš„å®Œæ•´å†…å®¹ (ç”¨æˆ·æ“ä½œ + æ—¶é—´ + ç³»ç»Ÿä¸Šä¸‹æ–‡ + ä¸»åŠ¨æ¶ˆæ¯æŒ‡ä»¤ + åŠ¨æ€æŒ‡ä»¤)
                const finalPayload = `[--- LATEST_USER_INPUT ---]\n${value}\n[--- END_LATEST_USER_INPUT ---]\n\n${timeContext}\n\n${systemContext}${proactivePrompt}${finalPrompt}`;

                // 8. å‘é€è¯·æ±‚ç»™AI (ä¿ç•™åŸæœ‰é€»è¾‘)
                console.log(`å‘é€ç»™AIçš„æœ€ç»ˆPayload:\n${finalPayload}`);
                QQ_LastRequest = finalPayload;
                QQ_LastRequestName = name || "";
                
                gening = true;
                let result;
                try {
                    result = await QQ_Gen(finalPayload);
                    await ResultHandle(result);
                } finally {
                    gening = false;
                }
            }

            /**
             * è·å–æ—¶é—´æ®µæè¿°
             * @param {number} hour - å½“å‰å°æ—¶æ•°(0-23)
             * @returns {string} æ—¶é—´æ®µæè¿°
             */
            function QQ_GetTimePeriod(hour) {
                if (hour >= 5 && hour < 8) {
                    return 'æ¸…æ™¨';
                } else if (hour >= 8 && hour < 11) {
                    return 'ä¸Šåˆ';
                } else if (hour >= 11 && hour < 13) {
                    return 'ä¸­åˆ';
                } else if (hour >= 13 && hour < 17) {
                    return 'ä¸‹åˆ';
                } else if (hour >= 17 && hour < 19) {
                    return 'å‚æ™š';
                } else if (hour >= 19 && hour < 22) {
                    return 'æ™šä¸Š';
                } else {
                    return 'æ·±å¤œ';
                }
            }

            /**
             * è·å–å­£èŠ‚æè¿°
             * @param {number} month - å½“å‰æœˆä»½(1-12)
             * @returns {string} å­£èŠ‚æè¿°
             */
            function QQ_GetSeason(month) {
                if (month >= 3 && month <= 5) {
                    return 'æ˜¥å­£';
                } else if (month >= 6 && month <= 8) {
                    return 'å¤å­£';
                } else if (month >= 9 && month <= 11) {
                    return 'ç§‹å­£';
                } else {
                    return 'å†¬å­£';
                }
            }

            /**
             * æ”¹è¿›çš„æ—¶é—´æ’åºå‡½æ•°ï¼Œç¡®ä¿24å°æ—¶åˆ¶å’Œè·¨æ—¥æœŸçš„æ­£ç¡®æ’åº
             * @param {Array} messages - æ¶ˆæ¯æ•°ç»„
             * @param {boolean} ascending - æ˜¯å¦å‡åºæ’åˆ—ï¼ˆé»˜è®¤falseï¼Œå³é™åºï¼‰
             * @return {Array} æ’åºåçš„æ¶ˆæ¯æ•°ç»„
             */
            function QQ_SortMessagesByTime(messages, ascending = false) {
                return messages.sort((a, b) => {
                    const timeA = a.timestamp || QQ_ParseTime(a.time);
                    const timeB = b.timestamp || QQ_ParseTime(b.time);
                    
                    // ç¡®ä¿æ•°å€¼æ¯”è¾ƒ
                    const timestampA = typeof timeA === 'number' ? timeA : Date.parse(timeA) || 0;
                    const timestampB = typeof timeB === 'number' ? timeB : Date.parse(timeB) || 0;
                    
                    if (ascending) {
                        return timestampA - timestampB; // å‡åºï¼šæ—©çš„åœ¨å‰
                    } else {
                        return timestampB - timestampA; // é™åºï¼šæ–°çš„åœ¨å‰
                    }
                });
            }
            
            /**
             * *** æ–°å¢ï¼šä½¿ç”¨é€»è¾‘åºåˆ—å·æ’åºå‡½æ•°ï¼ˆè§£å†³æ—¶é—´æ’åºé—®é¢˜ï¼‰ ***
             * @param {Array} messages - æ¶ˆæ¯æ•°ç»„
             * @param {boolean} ascending - æ˜¯å¦å‡åºæ’åˆ—ï¼ˆé»˜è®¤trueï¼Œå³å‡åºï¼‰
             * @return {Array} æ’åºåçš„æ¶ˆæ¯æ•°ç»„
             */
            function QQ_SortMessagesBySequence(messages, ascending = true) {
                return messages.sort((a, b) => {
                    const seqA = a.sequenceId || 0;
                    const seqB = b.sequenceId || 0;
                    
                    if (ascending) {
                        return seqA - seqB; // å‡åºï¼šæ—©çš„åœ¨å‰
                    } else {
                        return seqB - seqA; // é™åºï¼šæ–°çš„åœ¨å‰
                    }
                });
            }

            /**
             * è·å–å…¼å®¹æ€§çš„æ—¶é—´æ˜¾ç¤ºæ ¼å¼ï¼ˆç”¨äºç•Œé¢æ˜¾ç¤ºï¼‰
             * @param {string} fullDateTime - å®Œæ•´çš„æ—¥æœŸæ—¶é—´å­—ç¬¦ä¸²
             * @return {string} ç®€åŒ–çš„æ—¶é—´æ˜¾ç¤º
             */
            function QQ_GetDisplayTime(fullDateTime) {
                if (!fullDateTime) return QQ_GetTime();
                
                // å¦‚æœæ˜¯å®Œæ•´æ—¥æœŸæ—¶é—´æ ¼å¼ï¼Œæå–æ—¶é—´éƒ¨åˆ†
                const fullDateTimeRegex = /^\d{4}\/\d{1,2}\/\d{1,2}[,\s]+(\d{1,2}:\d{2})$/;
                const match = fullDateTime.match(fullDateTimeRegex);
                if (match) {
                    return match[1]; // è¿”å› HH:MM éƒ¨åˆ†
                }
                
                // å¦‚æœå·²ç»æ˜¯ç®€çŸ­æ ¼å¼ï¼Œç›´æ¥è¿”å›
                return fullDateTime;
            }

            /**
             * åˆ†ç¦»å¼å¤„ç†æ¨¡å‹ï¼šä¼˜å…ˆæå–å¹¶å¤„ç†çº¿ä¸Šæ ¼å¼å†…å®¹
             * è§£å†³AIå›å¤ä¸­â€œéƒ¨åˆ†æ ¼å¼ + å¤§æ®µäº’åŠ¨â€çš„æ··åˆé—®é¢˜
             * @param {string} originalResult - åŸå§‹ AI å›å¤
             * @return {object} {processed: boolean, remainingResult: string, processedCount: number}
             */
            async function QQ_ExtractAndProcessOnlineFormatFirst(originalResult) {
                console.log('ğŸ” å¼€å§‹åˆ†ç¦»å¼å¤„ç†ï¼šä¼˜å…ˆæå–çº¿ä¸Šæ ¼å¼å†…å®¹');
                
                let result = originalResult;
                let processed = false;
                let processedCount = 0;
                
                // ç¬¬ä¸€é˜¶æ®µï¼šå¤„ç†MiPhoneå®Œæ•´æ ¼å¼ï¼Œå…¨é¢è§£æå…¶ä¸­åŒ…å«çš„æ‰€æœ‰æ ¼å¼
                const miPhoneMatches = [...result.matchAll(/MiPhone_JSON_START([\s\S]*?)MiPhone_JSON_END/g)];
                for (const miPhoneMatch of miPhoneMatches) {
                    const fullMatch = miPhoneMatch[0];
                    const content = miPhoneMatch[1];
                    
                    console.log(`ğŸ“± æå–åˆ°MiPhoneå®Œæ•´æ ¼å¼å†…å®¹ï¼Œé•¿åº¦: ${content.length}`);
                    
                    // åœ¨MiPhoneå†…å®¹ä¸­æŸ¥æ‰¾å¹¶å¤„ç†æ‰€æœ‰å­æ ¼å¼
                    let hasSubFormats = false;
                    
                    // 1. å¤„ç†åŠ¨æ€å›å¤æ ¼å¼
                    const momentReplyMatches = [...content.matchAll(/moment_reply_start([\s\S]+?)moment_reply_end/g)];
                    for (const replyMatch of momentReplyMatches) {
                        console.log(`ğŸ’¬ åœ¨MiPhoneä¸­æå–åˆ°åŠ¨æ€å›å¤æ ¼å¼`);
                        await QQ_ProcessMomentReply(replyMatch[1]);
                        hasSubFormats = true;
                    }
                    
                    // 2. å¤„ç†æ™®é€šåŠ¨æ€æ ¼å¼
                    const momentMatches = [...content.matchAll(/moment_start([\s\S]+?)moment_end/g)];
                    for (const momentMatch of momentMatches) {
                        console.log(`ğŸ“± åœ¨MiPhoneä¸­æå–åˆ°åŠ¨æ€æ ¼å¼`);
                        const isInCommentContext = QQ_LastRequest && QQ_LastRequest.includes('ç”¨æˆ·åœ¨') && QQ_LastRequest.includes('çš„åŠ¨æ€ä¸‹è¯„è®º');
                        QQ_Moment_Parse(momentMatch[1], isInCommentContext);
                        hasSubFormats = true;
                    }
                    
                    // 3. å¤„ç†ç§èŠå’Œç¾¤èŠæ ¼å¼ - å¦‚æœæœ‰å…¶ä»–æ ¼å¼ï¼Œåˆ™éœ€è¦å¤„ç†å‰©ä½™å†…å®¹
                    if (content.includes('çš„ç§èŠ>') || content.includes('ç¾¤èŠ:')) {
                        console.log(`ğŸ’¬ åœ¨MiPhoneä¸­å‘ç°èŠå¤©æ ¼å¼`);
                        await QQ_Msg_Parse(fullMatch);
                        hasSubFormats = true;
                    }
                    
                    // å¦‚æœæ‰¾åˆ°äº†å­æ ¼å¼ï¼Œæ ‡è®°ä¸ºå·²å¤„ç†
                    if (hasSubFormats) {
                        result = result.replace(fullMatch, '');
                        processed = true;
                        processedCount++;
                        console.log(`âœ… å·²å¤„ç†MiPhoneå®Œæ•´æ ¼å¼: ${fullMatch.substring(0, 100)}...`);
                    }
                }
                
                // ç¬¬äºŒé˜¶æ®µï¼šå¤„ç†æœªè¢«MiPhoneåŒ…è£¹çš„ç‹¬ç«‹æ ¼å¼
                const standalonePatterns = [
                    {
                        name: 'ç‹¬ç«‹ç§èŠæ ¼å¼',
                        pattern: /<(.+?)å’Œ(.+?)çš„ç§èŠ>([\s\S]+?)<\/(.+?)å’Œ(.+?)çš„ç§èŠ>/g,
                        handler: async (match, fullMatch) => {
                            console.log(`ğŸ’¬ æå–åˆ°ç‹¬ç«‹ç§èŠæ ¼å¼å†…å®¹`);
                            const wrappedContent = `MiPhone_JSON_START${fullMatch}MiPhone_JSON_END`;
                            await QQ_Msg_Parse(wrappedContent);
                            return true;
                        }
                    },
                    {
                        name: 'ç‹¬ç«‹ç¾¤èŠæ ¼å¼',
                        pattern: /<ç¾¤èŠ:(.+?)>([\s\S]+?)<\/ç¾¤èŠ:(.+?)>/g,
                        handler: async (match, fullMatch) => {
                            console.log(`ğŸ’¬ æå–åˆ°ç‹¬ç«‹ç¾¤èŠæ ¼å¼å†…å®¹`);
                            const wrappedContent = `MiPhone_JSON_START${fullMatch}MiPhone_JSON_END`;
                            await QQ_Msg_Parse(wrappedContent);
                            return true;
                        }
                    },
                    {
                        name: 'ç‹¬ç«‹åŠ¨æ€æ ¼å¼',
                        pattern: /moment_start([\s\S]+?)moment_end/g,
                        handler: async (match, fullMatch) => {
                            console.log(`ğŸ“± æå–åˆ°ç‹¬ç«‹åŠ¨æ€æ ¼å¼å†…å®¹`);
                            const isInCommentContext = QQ_LastRequest && QQ_LastRequest.includes('ç”¨æˆ·åœ¨') && QQ_LastRequest.includes('çš„åŠ¨æ€ä¸‹è¯„è®º');
                            QQ_Moment_Parse(match[1], isInCommentContext);
                            return true;
                        }
                    },
                    {
                        name: 'ç‹¬ç«‹åŠ¨æ€å›å¤æ ¼å¼',
                        pattern: /moment_reply_start([\s\S]+?)moment_reply_end/g,
                        handler: async (match, fullMatch) => {
                            console.log(`ğŸ’¬ æå–åˆ°ç‹¬ç«‹åŠ¨æ€å›å¤æ ¼å¼å†…å®¹`);
                            await QQ_ProcessMomentReply(match[1]);
                            return true;
                        }
                    }
                ];
                
                // é€ä¸ªå°è¯•ç‹¬ç«‹æ ¼å¼æ¨¡å¼
                for (const formatDef of standalonePatterns) {
                    const matches = [...result.matchAll(formatDef.pattern)];
                    
                    for (const match of matches) {
                        try {
                            const fullMatch = match[0];
                            const shouldProcess = await formatDef.handler(match, fullMatch);
                            
                            if (shouldProcess) {
                                // ä»åŸå§‹ç»“æœä¸­ç§»é™¤å·²å¤„ç†çš„å†…å®¹
                                result = result.replace(fullMatch, '');
                                processed = true;
                                processedCount++;
                                console.log(`âœ… å·²å¤„ç†${formatDef.name}: ${fullMatch.substring(0, 100)}...`);
                            }
                        } catch (error) {
                            console.error(`âŒ å¤„ç†${formatDef.name}æ—¶å‡ºé”™:`, error);
                        }
                    }
                }
                
                // æ¸…ç†å‰©ä½™çš„ç©ºç™½å’Œæ— æ•ˆæ ‡ç­¾
                result = result
                    .replace(/MiPhone_JSON_START/g, '')
                    .replace(/MiPhone_JSON_END/g, '')
                    .replace(/msg_end/g, '')
                    .replace(/^\s*[\r\n]+/gm, '')
                    .trim();
                
                console.log(`ğŸ” åˆ†ç¦»å¼å¤„ç†ç»“æœ: å¤„ç†äº†${processedCount}ä¸ªçº¿ä¸Šæ ¼å¼å—, å‰©ä½™å†…å®¹é•¿åº¦: ${result.length}`);
                
                return {
                    processed,
                    remainingResult: result,
                    processedCount
                };
            }

            /**
             * æ™ºèƒ½å†…å®¹è°ƒåº¦å™¨ - è‡ªåŠ¨å†³å®šå¹¶è¡Œæˆ–é¡ºåºå¤„ç†
             * å…³é”®é€»è¾‘ï¼š
             * - ä¸åŒç•Œé¢çš„å†…å®¹ â†’ å¹¶è¡Œå¤„ç†
             * - åŒä¸€ç•Œé¢çš„æ··åˆå†…å®¹ â†’ é¡ºåºå¤„ç†
             */
            const QQ_SmartContentScheduler = {
                /**
                 * åˆ†æå†…å®¹å¹¶å†³å®šå¤„ç†ç­–ç•¥
                 * @param {string} content - AIå›å¤å†…å®¹
                 * @returns {boolean} æ˜¯å¦å·²å¤„ç†å®Œæˆ
                 */
                async process(content) {
                    console.log('ğŸ§  æ™ºèƒ½è°ƒåº¦å™¨ï¼šåˆ†æå†…å®¹ç»“æ„...');
                    
                    // å‚æ•°éªŒè¯
                    if (!content || typeof content !== 'string') {
                        console.warn('âš ï¸ QQ_SmartContentScheduler.process: contentå‚æ•°æ— æ•ˆ', content);
                        return false;
                    }
                    
                    // åˆ†æå†…å®¹ï¼Œè¯†åˆ«æ‰€æœ‰ç•Œé¢å’Œå†…å®¹ç±»å‹
                    const analysis = this.analyzeContent(content);
                    console.log('ğŸ“Š å†…å®¹åˆ†æç»“æœ:', analysis);
                    
                    // å†³å®šå¤„ç†ç­–ç•¥
                    if (this.needsSequentialProcessing(analysis)) {
                        console.log('ğŸ”„ æ£€æµ‹åˆ°åŒç•Œé¢æ··åˆå†…å®¹ï¼Œä½¿ç”¨é¡ºåºå¤„ç†');
                        return await this.processSequentially(content, analysis);
                    } else {
                        console.log('âš¡ æ£€æµ‹åˆ°ä¸åŒç•Œé¢å†…å®¹ï¼Œä½¿ç”¨å¹¶è¡Œå¤„ç†');
                        return await this.processInParallel(content, analysis);
                    }
                },
                
                /**
                 * åˆ†æå†…å®¹ç»“æ„ï¼Œè¯†åˆ«æ‰€æœ‰ç•Œé¢å’Œå†…å®¹ç±»å‹
                 */
                analyzeContent(content) {
                    const analysis = {
                        interfaces: new Set(), // æ¶‰åŠçš„ç•Œé¢
                        contentByInterface: new Map(), // æ¯ä¸ªç•Œé¢çš„å†…å®¹ç±»å‹
                        hasInteractive: false,
                        privateChatCharacters: new Set(),
                        groupChats: new Set(),
                        moments: [],
                        momentReplies: []
                    };
                    
                    // åˆ†æç§èŠï¼ˆè¯†åˆ«æ¶‰åŠçš„è§’è‰²ï¼‰
                    const privateChatMatches = [...content.matchAll(/<([^å’Œ]+?)å’Œ([^çš„ç§èŠ]+?)(?:çš„)?(?:ç§èŠ|èŠå¤©)>/g)];
                    for (const match of privateChatMatches) {
                        const user = match[1].trim();
                        const character = match[2].trim();
                        const chatKey = `${user}å’Œ${character}`;
                        analysis.privateChatCharacters.add(chatKey);
                        analysis.interfaces.add(`private_${chatKey}`);
                        
                        if (!analysis.contentByInterface.has(`private_${chatKey}`)) {
                            analysis.contentByInterface.set(`private_${chatKey}`, new Set());
                        }
                        analysis.contentByInterface.get(`private_${chatKey}`).add('chat');
                    }
                    
                    // åˆ†æç¾¤èŠ
                    const groupChatMatches = [...content.matchAll(/<ç¾¤èŠ[:ï¼š]([^>]+?)>/g)];
                    for (const match of groupChatMatches) {
                        const groupName = match[1].trim();
                        analysis.groupChats.add(groupName);
                        analysis.interfaces.add(`group_${groupName}`);
                        
                        if (!analysis.contentByInterface.has(`group_${groupName}`)) {
                            analysis.contentByInterface.set(`group_${groupName}`, new Set());
                        }
                        analysis.contentByInterface.get(`group_${groupName}`).add('chat');
                    }
                    
                    // åˆ†æåŠ¨æ€
                    if (/moment_start/i.test(content)) {
                        analysis.interfaces.add('moments');
                        if (!analysis.contentByInterface.has('moments')) {
                            analysis.contentByInterface.set('moments', new Set());
                        }
                        analysis.contentByInterface.get('moments').add('moment');
                    }
                    
                    // åˆ†æåŠ¨æ€å›å¤
                    if (/moment_reply_start/i.test(content)) {
                        analysis.interfaces.add('moments');
                        if (!analysis.contentByInterface.has('moments')) {
                            analysis.contentByInterface.set('moments', new Set());
                        }
                        analysis.contentByInterface.get('moments').add('moment_reply');
                    }
                    
                    // åˆ†æäº’åŠ¨å†…å®¹
                    if (content.includes('<content>') || QQ_IsInteractiveContent(content, false)) {
                        analysis.hasInteractive = true;
                        
                        // *** ä¿®å¤ï¼šæ ¹æ®å½“å‰å¯¹è¯ä¸Šä¸‹æ–‡ç²¾ç¡®å½’å±äº’åŠ¨å†…å®¹ ***
                        const currentCharacter = QQ_LastRequestName || charcardname;
                        
                        // ä¼˜å…ˆæ£€æŸ¥æ˜¯å¦æœ‰ä¸å½“å‰è§’è‰²åŒ¹é…çš„ç§èŠ
                        let targetInterface = null;
                        for (const chatKey of analysis.privateChatCharacters) {
                            if (chatKey.includes(currentCharacter)) {
                                targetInterface = `private_${chatKey}`;
                                console.log(`ğŸ¯ äº’åŠ¨å†…å®¹å½’å±åˆ°å½“å‰è§’è‰²ç§èŠ: ${targetInterface}`);
                                break;
                            }
                        }
                        
                        // å¦‚æœæ²¡æœ‰åŒ¹é…çš„ç§èŠï¼Œæ£€æŸ¥å½“å‰æ˜¯å¦åœ¨ç¾¤èŠä¸­
                        if (!targetInterface && analysis.groupChats.size > 0) {
                            // æ£€æŸ¥å½“å‰æ˜¯å¦æœ‰ç‰¹å®šçš„ç¾¤èŠä¸Šä¸‹æ–‡
                            if (analysis.groupChats.size === 1) {
                                const groupName = Array.from(analysis.groupChats)[0];
                                targetInterface = `group_${groupName}`;
                                console.log(`ğŸ¯ äº’åŠ¨å†…å®¹å½’å±åˆ°ç¾¤èŠ: ${targetInterface}`);
                            }
                        }
                        
                        // å¦‚æœä»ç„¶æ²¡æœ‰æ˜ç¡®å½’å±ï¼Œæ£€æŸ¥å•ä¸€ç§èŠåœºæ™¯
                        if (!targetInterface && analysis.privateChatCharacters.size === 1) {
                            const chatKey = Array.from(analysis.privateChatCharacters)[0];
                            targetInterface = `private_${chatKey}`;
                            console.log(`ğŸ¯ äº’åŠ¨å†…å®¹å½’å±åˆ°å”¯ä¸€ç§èŠ: ${targetInterface}`);
                        }
                        
                        if (targetInterface) {
                            // å°†äº’åŠ¨å†…å®¹å½’å±åˆ°ç‰¹å®šç•Œé¢
                            analysis.contentByInterface.get(targetInterface).add('interactive');
                        } else {
                            // åªæœ‰åœ¨å®Œå…¨æ— æ³•ç¡®å®šå½’å±æ—¶æ‰ä½œä¸ºç‹¬ç«‹ç•Œé¢
                            console.log(`âš ï¸ æ— æ³•ç¡®å®šäº’åŠ¨å†…å®¹å½’å±ï¼Œä½œä¸ºç‹¬ç«‹ç•Œé¢å¤„ç†`);
                            analysis.interfaces.add('interactive');
                            if (!analysis.contentByInterface.has('interactive')) {
                                analysis.contentByInterface.set('interactive', new Set());
                            }
                            analysis.contentByInterface.get('interactive').add('interactive');
                        }
                    }
                    
                    return analysis;
                },
                
                /**
                 * åˆ¤æ–­æ˜¯å¦éœ€è¦é¡ºåºå¤„ç†
                 */
                needsSequentialProcessing(analysis) {
                    // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•ç•Œé¢åŒ…å«å¤šç§å†…å®¹ç±»å‹
                    for (const [interfaceName, contentTypes] of analysis.contentByInterface) {
                        if (contentTypes.size > 1) {
                            console.log(`ğŸ¯ ç•Œé¢ ${interfaceName} åŒ…å«å¤šç§å†…å®¹ç±»å‹: ${Array.from(contentTypes).join(', ')}`);
                            return true;
                        }
                    }
                    return false;
                },
                
                /**
                 * é¡ºåºå¤„ç†ï¼ˆåŒä¸€ç•Œé¢å†…çš„æ··åˆå†…å®¹ï¼‰
                 */
                async processSequentially(content, analysis) {
                    console.log('ğŸ”„ æ‰§è¡Œé¡ºåºå¤„ç†...');
                    
                    try {
                        // ä½¿ç”¨ç°æœ‰çš„é¡ºåºä»»åŠ¡é˜Ÿåˆ—å¤„ç†
                        const segments = QQ_SequentialTaskQueue.splitIntoSegments(content);
                        const tasks = QQ_SequentialTaskQueue.createTaskQueue(segments);
                        
                        if (tasks.length > 0) {
                            await QQ_SequentialTaskQueue.processQueue(tasks);
                            
                            // *** é‡è¦ï¼šæ‰§è¡Œå®Œæ•´çš„åå¤„ç†æµç¨‹ ***
                            await this.executePostProcessing();
                            return true;
                        }
                    } catch (error) {
                        console.error('âŒ é¡ºåºå¤„ç†è¿‡ç¨‹ä¸­å‡ºé”™:', error);
                    }
                    return false;
                },
                
                /**
                 * å¹¶è¡Œå¤„ç†ï¼ˆä¸åŒç•Œé¢çš„å†…å®¹ï¼‰
                 */
                async processInParallel(content, analysis) {
                    console.log('âš¡ æ‰§è¡Œå¹¶è¡Œå¤„ç†...');
                    
                    try {
                        // ä½¿ç”¨åŸæœ‰çš„åˆ†ç¦»å¼å¤„ç†é€»è¾‘ï¼Œå®ƒæœ¬èº«å°±æ˜¯å¹¶è¡Œçš„
                        const separateResult = await QQ_ExtractAndProcessOnlineFormatFirst(content);
                        
                        if (separateResult.processed && separateResult.processedCount > 0) {
                            console.log('âœ… å¹¶è¡Œå¤„ç†å®Œæˆï¼Œå¤„ç†äº†çº¿ä¸Šæ ¼å¼å†…å®¹');
                            
                            // å¦‚æœè¿˜æœ‰å‰©ä½™çš„äº’åŠ¨å†…å®¹ï¼Œä¹Ÿè¦å¤„ç†
                            if (separateResult.remainingResult && separateResult.remainingResult.trim()) {
                                console.log('ğŸ­ å¤„ç†å‰©ä½™çš„äº’åŠ¨å†…å®¹ï¼ˆä½¿ç”¨æ–°çš„æµå¼æ˜¾ç¤ºï¼‰');
                                await QQ_SequentialTaskQueue.displayInteractiveInChat(separateResult.remainingResult);
                            }
                            
                            // *** é‡è¦ï¼šæ‰§è¡Œå®Œæ•´çš„åå¤„ç†æµç¨‹ ***
                            await this.executePostProcessing();
                            return true;
                        }
                    } catch (error) {
                        console.error('âŒ å¹¶è¡Œå¤„ç†è¿‡ç¨‹ä¸­å‡ºé”™:', error);
                    }
                    return false;
                },
                
                /**
                 * *** æ–°å¢ï¼šæ‰§è¡Œå®Œæ•´çš„åå¤„ç†æµç¨‹ ***
                 * åŒ…æ‹¬çŸ­æœŸè®°å¿†å­˜å‚¨ã€èŠå¤©å¤‡ä»½ã€æ–°æ¶ˆæ¯æç¤ºç­‰å…³é”®åŠŸèƒ½
                 */
                async executePostProcessing() {
                    console.log('ğŸ”§ æ‰§è¡Œåå¤„ç†æµç¨‹...');
                    
                    try {
                        // 1. æ›´æ–°çŸ­æœŸè®°å¿†ï¼ˆå¦‚æœå­˜åœ¨æ­¤åŠŸèƒ½ï¼‰
                        if (typeof QQ_UpdateShortTermMemory === 'function') {
                            console.log('ğŸ“ æ›´æ–°çŸ­æœŸè®°å¿†...');
                            await QQ_UpdateShortTermMemory();
                        }
                        
                        // 2. ä¿å­˜èŠå¤©å¤‡ä»½ï¼ˆåŒ…å«ç”¨æˆ·ç¼“å­˜å’Œå‘é€çš„æ¶ˆæ¯ï¼‰
                        if (typeof QQ_Save_Chat_Backup === 'function') {
                            console.log('ğŸ’¾ ä¿å­˜èŠå¤©å¤‡ä»½...');
                            await QQ_Save_Chat_Backup();
                        }
                        
                        // 3. ä¿å­˜æ¶ˆæ¯åˆ°ä¸–ç•Œä¹¦ï¼ˆå¦‚æœæœ‰ä¸“é—¨çš„æ¶ˆæ¯ä¿å­˜å‡½æ•°ï¼‰
                        if (typeof QQ_Save_Msg === 'function') {
                            console.log('ğŸ“š ä¿å­˜æ¶ˆæ¯åˆ°ä¸–ç•Œä¹¦...');
                            await QQ_Save_Msg();
                        }
                        
                        // 4. æ›´æ–°æ–°æ¶ˆæ¯æç¤º
                        if (typeof QQ_UpdateNewTips === 'function') {
                            console.log('ğŸ”” æ›´æ–°æ–°æ¶ˆæ¯æç¤º...');
                            QQ_UpdateNewTips();
                        }
                        
                        // 5. é‡ç½®é‡è¯•è®¡æ•°
                        if (typeof QQ_ResetRetry === 'function') {
                            QQ_ResetRetry();
                        }
                        
                        console.log('âœ… åå¤„ç†æµç¨‹å®Œæˆ');
                        
                    } catch (error) {
                        console.error('âŒ åå¤„ç†æµç¨‹å‡ºé”™:', error);
                    }
                }
            };

            /**
             * é¡ºåºä»»åŠ¡é˜Ÿåˆ—ç³»ç»Ÿ - ç»´æŠ¤AIå›å¤çš„åŸå§‹é¡ºåº
             */
            const QQ_SequentialTaskQueue = {
                tasks: [],
                isProcessing: false,
                
                /**
                 * å°†AIå›å¤åˆ†å‰²æˆæœ‰åºçš„ç‰‡æ®µ
                 * @param {string} content - AIçš„å®Œæ•´å›å¤
                 * @returns {Array} æœ‰åºçš„ç‰‡æ®µæ•°ç»„
                 */
                splitIntoSegments(content) {
                    console.log('ğŸ”„ å¼€å§‹åˆ†å‰²AIå›å¤ä¸ºæœ‰åºç‰‡æ®µ...');
                    
                    // å‚æ•°éªŒè¯
                    if (!content || typeof content !== 'string') {
                        console.warn('âš ï¸ splitIntoSegments: contentå‚æ•°æ— æ•ˆ', content);
                        return [];
                    }
                    
                    // å®šä¹‰æ‰€æœ‰å¯èƒ½çš„æ ‡ç­¾æ¨¡å¼ï¼ˆå‚è€ƒåŸæœ‰çš„çµæ´»åŒ¹é…é€»è¾‘ï¼‰
                    const patterns = [
                        // ç§èŠæ ¼å¼ï¼ˆå„ç§å¯èƒ½çš„å˜åŒ–ï¼‰
                        {
                            pattern: /<([^å’Œ]+?)å’Œ([^çš„]+?)çš„ç§èŠ>([\s\S]*?)<\/\1å’Œ\2çš„ç§èŠ>/g,
                            type: 'private_chat'
                        },
                        {
                            pattern: /<([^å’Œ]+?)å’Œ([^ç§]+?)ç§èŠ>([\s\S]*?)<\/\1å’Œ\2ç§èŠ>/g,
                            type: 'private_chat'
                        },
                        {
                            pattern: /<([^å’Œ]+?)å’Œ([^çš„]+?)çš„èŠå¤©>([\s\S]*?)<\/\1å’Œ\2çš„èŠå¤©>/g,
                            type: 'private_chat'
                        },
                        {
                            pattern: /<([^å’Œ]+?)å’Œ([^èŠ]+?)èŠå¤©>([\s\S]*?)<\/\1å’Œ\2èŠå¤©>/g,
                            type: 'private_chat'
                        },
                        // ç¾¤èŠæ ¼å¼ï¼ˆæ”¯æŒä¸­è‹±æ–‡å†’å·ï¼‰
                        {
                            pattern: /<ç¾¤èŠ[:ï¼š]([^>]+?)>([\s\S]*?)<\/ç¾¤èŠ[:ï¼š]\1>/g,
                            type: 'group_chat'
                        },
                        // åŠ¨æ€æ ¼å¼ï¼ˆå„ç§å¤§å°å†™å˜åŒ–ï¼‰
                        {
                            pattern: /moment_start([\s\S]+?)moment_end/g,
                            type: 'moment'
                        },
                        {
                            pattern: /moment_Start([\s\S]+?)moment_End/g,
                            type: 'moment'
                        },
                        {
                            pattern: /moment_START([\s\S]+?)moment_END/g,
                            type: 'moment'
                        },
                        {
                            pattern: /Moment_start([\s\S]+?)Moment_end/g,
                            type: 'moment'
                        },
                        // åŠ¨æ€å›å¤æ ¼å¼ï¼ˆå„ç§å¤§å°å†™å˜åŒ–ï¼‰
                        {
                            pattern: /moment_reply_start([\s\S]+?)moment_reply_end/g,
                            type: 'moment_reply'
                        },
                        {
                            pattern: /moment_reply_Start([\s\S]+?)moment_reply_End/g,
                            type: 'moment_reply'
                        },
                        {
                            pattern: /moment_reply_START([\s\S]+?)moment_reply_END/g,
                            type: 'moment_reply'
                        },
                        {
                            pattern: /Moment_reply_start([\s\S]+?)Moment_reply_end/g,
                            type: 'moment_reply'
                        },
                        // äº’åŠ¨å†…å®¹æ ¼å¼
                        {
                            pattern: /<content>([\s\S]*?)<\/content>/g,
                            type: 'interactive'
                        },
                        // MiPhoneæ ¼å¼ï¼ˆæ”¯æŒæ‰€æœ‰å¯èƒ½çš„å˜åŒ–ï¼‰
                        {
                            pattern: /MiPhone_start([\s\S]*?)MiPhone_end/g,
                            type: 'miphone'
                        },
                        {
                            pattern: /MiPhone_JSON_START([\s\S]*?)MiPhone_JSON_END/g,
                            type: 'miphone'
                        },
                        {
                            pattern: /MiPhone_JSON_start([\s\S]*?)MiPhone_JSON_end/g,
                            type: 'miphone'
                        },
                        {
                            pattern: /MiPhone_Start([\s\S]*?)MiPhone_End/g,
                            type: 'miphone'
                        },
                        {
                            pattern: /MiPhone_START([\s\S]*?)MiPhone_END/g,
                            type: 'miphone'
                        },
                        {
                            pattern: /MiPhone([\s\S]*?)MiPhone/g,
                            type: 'miphone'
                        }
                    ];
                    
                    // æ”¶é›†æ‰€æœ‰åŒ¹é…é¡¹åŠå…¶ä½ç½®
                    const matches = [];
                    
                    for (const {pattern, type} of patterns) {
                        const regex = new RegExp(pattern);
                        let match;
                        while ((match = regex.exec(content)) !== null) {
                            matches.push({
                                type: type,
                                content: match[0],
                                start: match.index,
                                end: match.index + match[0].length,
                                fullMatch: match
                            });
                        }
                    }
                    
                    // æŒ‰ä½ç½®æ’åº
                    matches.sort((a, b) => a.start - b.start);
                    
                    // æ„å»ºæœ€ç»ˆçš„æœ‰åºç‰‡æ®µæ•°ç»„
                    const segments = [];
                    let lastEnd = 0;
                    
                    for (const match of matches) {
                        // æ·»åŠ æ ‡ç­¾ä¹‹é—´çš„çº¯æ–‡æœ¬
                        if (match.start > lastEnd) {
                            const plainText = content.substring(lastEnd, match.start).trim();
                            if (plainText) {
                                segments.push({
                                    type: 'plain_text',
                                    content: plainText,
                                    start: lastEnd,
                                    end: match.start
                                });
                            }
                        }
                        
                        // æ·»åŠ æ ‡ç­¾å†…å®¹
                        segments.push(match);
                        lastEnd = match.end;
                    }
                    
                    // æ·»åŠ æœ€åçš„çº¯æ–‡æœ¬
                    if (lastEnd < content.length) {
                        const remainingText = content.substring(lastEnd).trim();
                        if (remainingText) {
                            segments.push({
                                type: 'plain_text',
                                content: remainingText,
                                start: lastEnd,
                                end: content.length
                            });
                        }
                    }
                    
                    console.log(`ğŸ“Š åˆ†å‰²å®Œæˆ: å…±${segments.length}ä¸ªç‰‡æ®µ`);
                    segments.forEach((seg, i) => {
                        console.log(`  ç‰‡æ®µ${i + 1}: ${seg.type} (é•¿åº¦: ${seg.content.length})`);
                    });
                    
                    return segments;
                },
                
                /**
                 * åˆ›å»ºä»»åŠ¡é˜Ÿåˆ—
                 * @param {Array} segments - æœ‰åºçš„ç‰‡æ®µæ•°ç»„
                 * @returns {Array} ä»»åŠ¡é˜Ÿåˆ—
                 */
                createTaskQueue(segments) {
                    const tasks = [];
                    
                    // å‚æ•°éªŒè¯
                    if (!segments || !Array.isArray(segments)) {
                        console.warn('âš ï¸ createTaskQueue: segmentså‚æ•°æ— æ•ˆ', segments);
                        return [];
                    }
                    
                    for (const segment of segments) {
                        // æ ¹æ®ç‰‡æ®µç±»å‹åˆ›å»ºç›¸åº”çš„ä»»åŠ¡
                        const task = {
                            id: `task_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                            type: segment.type,
                            content: segment.content,
                            status: 'pending',
                            startPosition: segment.start,
                            endPosition: segment.end
                        };
                        
                        // ä¸ºçº¯æ–‡æœ¬ç‰‡æ®µæ™ºèƒ½åˆ¤æ–­å…¶å¯èƒ½çš„ç±»å‹
                        if (segment.type === 'plain_text') {
                            task.inferredType = this.inferPlainTextType(segment.content);
                        }
                        
                        tasks.push(task);
                    }
                    
                    return tasks;
                },
                
                /**
                 * æ¨æ–­çº¯æ–‡æœ¬çš„å¯èƒ½ç±»å‹
                 * @param {string} text - çº¯æ–‡æœ¬å†…å®¹
                 * @returns {string} æ¨æ–­çš„ç±»å‹
                 */
                inferPlainTextType(text) {
                    // æ£€æŸ¥æ˜¯å¦å¯èƒ½æ˜¯äº’åŠ¨å†…å®¹
                    const interactiveKeywords = ['èµ°æ¥', 'å¾®ç¬‘', 'çœ‹ç€ä½ ', 'è½»è½»', 'æ…¢æ…¢', 'ä¼¸å‡ºæ‰‹', 'çœ¼ä¸­', 'æ¸©æŸ”'];
                    const hasInteractiveKeywords = interactiveKeywords.some(keyword => text.includes(keyword));
                    
                    // æ£€æŸ¥æ˜¯å¦åŒ…å«åŠ¨ä½œæè¿°ï¼ˆé€šå¸¸ç”¨*æˆ–ï¼ˆï¼‰åŒ…è£¹ï¼‰
                    const hasActionMarkers = /[*ï¼ˆ(].*?[*ï¼‰)]/.test(text);
                    
                    // æ£€æŸ¥æ–‡æœ¬é•¿åº¦å’Œæè¿°æ€§
                    const isDescriptive = text.length > 50 && (hasInteractiveKeywords || hasActionMarkers);
                    
                    if (isDescriptive) {
                        return 'likely_interactive';
                    }
                    
                    return 'unknown';
                },
                
                /**
                 * å¤„ç†ä»»åŠ¡é˜Ÿåˆ—
                 * @param {Array} tasks - ä»»åŠ¡é˜Ÿåˆ—
                 */
                async processQueue(tasks) {
                    if (this.isProcessing) {
                        console.warn('âš ï¸ ä»»åŠ¡é˜Ÿåˆ—æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç­‰å¾…...');
                        return;
                    }
                    
                    this.isProcessing = true;
                    this.tasks = tasks;
                    
                    console.log('ğŸš€ å¼€å§‹å¤„ç†ä»»åŠ¡é˜Ÿåˆ—...');
                    
                    for (let i = 0; i < tasks.length; i++) {
                        const task = tasks[i];
                        console.log(`ğŸ“‹ å¤„ç†ä»»åŠ¡ ${i + 1}/${tasks.length}: ${task.type}`);
                        
                        try {
                            await this.processTask(task);
                            task.status = 'completed';
                        } catch (error) {
                            console.error(`âŒ ä»»åŠ¡å¤„ç†å¤±è´¥:`, error);
                            task.status = 'failed';
                            task.error = error.message;
                        }
                        
                        // æ·»åŠ å°å»¶è¿Ÿä»¥ç¡®ä¿UIæ›´æ–°
                        await new Promise(resolve => setTimeout(resolve, 50));
                    }
                    
                    this.isProcessing = false;
                    console.log('âœ… ä»»åŠ¡é˜Ÿåˆ—å¤„ç†å®Œæˆ');
                },
                
                /**
                 * å¤„ç†å•ä¸ªä»»åŠ¡
                 * @param {Object} task - ä»»åŠ¡å¯¹è±¡
                 */
                async processTask(task) {
                    switch (task.type) {
                        case 'private_chat':
                            await this.processPrivateChat(task);
                            break;
                        case 'group_chat':
                            await this.processGroupChat(task);
                            break;
                        case 'moment':
                            await this.processMoment(task);
                            break;
                        case 'moment_reply':
                            await this.processMomentReply(task);
                            break;
                        case 'interactive':
                            await this.processInteractive(task);
                            break;
                        case 'miphone':
                            await this.processMiPhone(task);
                            break;
                        case 'plain_text':
                            await this.processPlainText(task);
                            break;
                        default:
                            console.warn(`æœªçŸ¥çš„ä»»åŠ¡ç±»å‹: ${task.type}`);
                    }
                },
                
                // å„ç§ç±»å‹çš„å¤„ç†å‡½æ•°ï¼ˆå°†è°ƒç”¨ç°æœ‰çš„å¤„ç†é€»è¾‘ï¼‰
                async processPrivateChat(task) {
                    console.log('ğŸ’¬ å¤„ç†ç§èŠå†…å®¹');
                    
                    // æ”¯æŒå¤šç§ç§èŠæ ¼å¼å˜åŒ–ï¼ˆå‚è€ƒåŸæœ‰çµæ´»åŒ¹é…é€»è¾‘ï¼‰
                    const privateChatPatterns = [
                        // æ ‡å‡†æ ¼å¼ï¼š<ç”¨æˆ·å’Œè§’è‰²çš„ç§èŠ>
                        /<([^å’Œ]+?)å’Œ([^çš„]+?)çš„ç§èŠ>([\s\S]*?)<\/\1å’Œ\2çš„ç§èŠ>/g,
                        // ç®€åŒ–æ ¼å¼ï¼š<ç”¨æˆ·å’Œè§’è‰²ç§èŠ>ï¼ˆæ— "çš„"ï¼‰
                        /<([^å’Œ]+?)å’Œ([^ç§]+?)ç§èŠ>([\s\S]*?)<\/\1å’Œ\2ç§èŠ>/g,
                        // èŠå¤©æ ¼å¼ï¼š<ç”¨æˆ·å’Œè§’è‰²çš„èŠå¤©>
                        /<([^å’Œ]+?)å’Œ([^çš„]+?)çš„èŠå¤©>([\s\S]*?)<\/\1å’Œ\2çš„èŠå¤©>/g,
                        // ç®€åŒ–èŠå¤©æ ¼å¼ï¼š<ç”¨æˆ·å’Œè§’è‰²èŠå¤©>
                        /<([^å’Œ]+?)å’Œ([^èŠ]+?)èŠå¤©>([\s\S]*?)<\/\1å’Œ\2èŠå¤©>/g
                    ];
                    
                    let processed = false;
                    for (const pattern of privateChatPatterns) {
                        const matches = [...task.content.matchAll(pattern)];
                        if (matches.length > 0) {
                            console.log(`ğŸ’¬ åŒ¹é…åˆ°ç§èŠæ ¼å¼: ${pattern.source.substring(0, 30)}...`);
                            for (const match of matches) {
                                QQ_ParsePrivateChatContent(match[3], `${match[1]}å’Œ${match[2]}çš„èŠå¤©`);
                                processed = true;
                            }
                            break;
                        }
                    }
                    
                    if (!processed) {
                        console.warn('âš ï¸ æœªèƒ½åŒ¹é…ä»»ä½•ç§èŠæ ¼å¼å˜åŒ–');
                        console.log('ğŸ” ç§èŠä»»åŠ¡å†…å®¹é¢„è§ˆ:', task.content.substring(0, 200));
                    }
                },
                
                async processGroupChat(task) {
                    console.log('ğŸ‘¥ å¤„ç†ç¾¤èŠå†…å®¹');
                    
                    // æ”¯æŒå¤šç§ç¾¤èŠæ ¼å¼å˜åŒ–ï¼ˆå‚è€ƒåŸæœ‰çµæ´»åŒ¹é…é€»è¾‘ï¼‰
                    const groupChatPatterns = [
                        // æ ‡å‡†æ ¼å¼ï¼š<ç¾¤èŠ:ç¾¤å>ï¼ˆæ”¯æŒä¸­è‹±æ–‡å†’å·ï¼‰
                        /<ç¾¤èŠ[:ï¼š]([^>]+?)>([\s\S]*?)<\/ç¾¤èŠ[:ï¼š]\1>/g,
                        // æ›´å®½æ¾çš„æ ¼å¼åŒ¹é…ï¼ˆå¤„ç†å¯èƒ½çš„tagä¸åŒ¹é…ï¼‰
                        /<ç¾¤èŠ[:ï¼š]([^>]+?)>([\s\S]*?)<\/ç¾¤èŠ[:ï¼š]([^>]+?)>/g
                    ];
                    
                    let processed = false;
                    for (const pattern of groupChatPatterns) {
                        const matches = [...task.content.matchAll(pattern)];
                        if (matches.length > 0) {
                            console.log(`ğŸ‘¥ åŒ¹é…åˆ°ç¾¤èŠæ ¼å¼: ${pattern.source.substring(0, 30)}...`);
                            for (const match of matches) {
                                // ä½¿ç”¨ç¬¬ä¸€ä¸ªæ•è·ç»„ä½œä¸ºç¾¤å
                                const groupName = match[1];
                                const content = match[2];
                                QQ_ParseGroupChatContent(content, groupName);
                                processed = true;
                            }
                            break;
                        }
                    }
                    
                    if (!processed) {
                        console.warn('âš ï¸ æœªèƒ½åŒ¹é…ä»»ä½•ç¾¤èŠæ ¼å¼å˜åŒ–');
                        console.log('ğŸ” ç¾¤èŠä»»åŠ¡å†…å®¹é¢„è§ˆ:', task.content.substring(0, 200));
                    }
                },
                
                async processMoment(task) {
                    console.log('ğŸ“± å¤„ç†åŠ¨æ€å†…å®¹');
                    
                    // æ”¯æŒå„ç§å¤§å°å†™å˜åŒ–
                    const momentPatterns = [
                        /moment_start([\s\S]+?)moment_end/g,
                        /moment_Start([\s\S]+?)moment_End/g,
                        /moment_START([\s\S]+?)moment_END/g,
                        /Moment_start([\s\S]+?)Moment_end/g
                    ];
                    
                    let processed = false;
                    for (const pattern of momentPatterns) {
                        const match = task.content.match(pattern);
                        if (match) {
                            console.log(`ğŸ“± åŒ¹é…åˆ°åŠ¨æ€æ ¼å¼: ${pattern.source.substring(0, 30)}...`);
                            QQ_Moment_Parse(match[1]);
                            processed = true;
                            break;
                        }
                    }
                    
                    if (!processed) {
                        console.warn('âš ï¸ æœªèƒ½åŒ¹é…ä»»ä½•åŠ¨æ€æ ¼å¼å˜åŒ–');
                    }
                },
                
                async processMomentReply(task) {
                    console.log('ğŸ’¬ å¤„ç†åŠ¨æ€å›å¤');
                    
                    // æ”¯æŒå„ç§å¤§å°å†™å˜åŒ–
                    const momentReplyPatterns = [
                        /moment_reply_start([\s\S]+?)moment_reply_end/g,
                        /moment_reply_Start([\s\S]+?)moment_reply_End/g,
                        /moment_reply_START([\s\S]+?)moment_reply_END/g,
                        /Moment_reply_start([\s\S]+?)Moment_reply_end/g
                    ];
                    
                    let processed = false;
                    for (const pattern of momentReplyPatterns) {
                        const match = task.content.match(pattern);
                        if (match) {
                            console.log(`ğŸ’¬ åŒ¹é…åˆ°åŠ¨æ€å›å¤æ ¼å¼: ${pattern.source.substring(0, 30)}...`);
                            await QQ_ProcessMomentReply(match[1]);
                            processed = true;
                            break;
                        }
                    }
                    
                    if (!processed) {
                        console.warn('âš ï¸ æœªèƒ½åŒ¹é…ä»»ä½•åŠ¨æ€å›å¤æ ¼å¼å˜åŒ–');
                    }
                },
                
                async processInteractive(task) {
                    console.log('ğŸ­ å¤„ç†äº’åŠ¨å†…å®¹');
                    console.log('ğŸ“ åŸå§‹ä»»åŠ¡å†…å®¹é¢„è§ˆ:', task.content.substring(0, 100) + '...');
                    
                    // ä½¿ç”¨æ–°çš„æµå¼æ˜¾ç¤ºé€»è¾‘
                    const match = task.content.match(/<content>([\s\S]*?)<\/content>/);
                    if (match) {
                        // æå–contentæ ‡ç­¾å†…çš„å†…å®¹ï¼Œä¸åŒ…å«æ ‡ç­¾æœ¬èº«
                        const contentInside = match[1];
                        
                        // éªŒè¯æå–çš„å†…å®¹æ˜¯å¦æœ‰æ•ˆ
                        if (!contentInside || contentInside.trim().length === 0) {
                            console.log('âš ï¸ contentæ ‡ç­¾ä¸ºç©ºï¼Œè·³è¿‡å¤„ç†');
                            return;
                        }
                        
                        console.log('ğŸ“ æå–çš„contentå†…å®¹é•¿åº¦:', contentInside.length);
                        
                        // æ£€æŸ¥contentå†…éƒ¨æ˜¯å¦åŒ…å«MiPhoneæˆ–å…¶ä»–æ ¼å¼ï¼ˆæ”¯æŒå„ç§å˜åŒ–ï¼‰
                        const hasMiPhone = contentInside.includes('MiPhone_JSON_START') || 
                                         contentInside.includes('MiPhone_start') || 
                                         contentInside.includes('MiPhone_Start') || 
                                         contentInside.includes('MiPhone_START') ||
                                         contentInside.includes('MiPhone_JSON_start') ||
                                         /MiPhone[^_]/.test(contentInside);
                        
                        // æ£€æŸ¥æ˜¯å¦åŒ…å«å…¶ä»–èŠå¤©æ ¼å¼æ ‡ç­¾
                        const hasChatFormats = /<ç¾¤èŠ[ï¼š:]/i.test(contentInside) || 
                                             /<[^>]*å’Œ[^>]*çš„?(?:ç§èŠ|èŠå¤©)/i.test(contentInside) ||
                                             /moment_start|moment_end/i.test(contentInside);
                        
                        if (hasMiPhone || hasChatFormats) {
                            console.log('ğŸ“± å‘ç°contentå†…åŒ…å«MiPhoneæˆ–èŠå¤©æ ¼å¼ï¼Œé€’å½’å¤„ç†');
                            // *** ä¿®å¤ï¼šé€’å½’å¤„ç†contentå†…çš„å†…å®¹ï¼Œä½†ä¸é‡å¤æ˜¾ç¤ºäº’åŠ¨å†…å®¹ ***
                            const innerSegments = this.splitIntoSegments(contentInside);
                            const innerTasks = this.createTaskQueue(innerSegments);
                            for (const innerTask of innerTasks) {
                                await this.processTask(innerTask);
                            }
                            // *** é€’å½’å¤„ç†å®Œæˆåï¼Œä¸å†æ‰§è¡Œåç»­çš„äº’åŠ¨å†…å®¹æ˜¾ç¤ºï¼Œé¿å…é‡å¤ ***
                            return; 
                        } else {
                            // çº¯äº’åŠ¨å†…å®¹ - åªä¼ é€’contentæ ‡ç­¾å†…çš„å†…å®¹ï¼Œä¸åŒ…å«æ ‡ç­¾æœ¬èº«
                            console.log('ğŸ­ çº¯äº’åŠ¨å†…å®¹ï¼Œç›´æ¥æ˜¾ç¤ºï¼ˆä¸åŒ…å«contentæ ‡ç­¾ï¼‰');
                            await this.displayInteractiveInChat(contentInside);
                        }
                    } else {
                        // å¦‚æœæ²¡æœ‰contentæ ‡ç­¾ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–æœ‰æ•ˆå†…å®¹
                        const cleanContent = task.content.replace(/<\/?content>/gi, '').trim();
                        if (cleanContent && cleanContent.length > 0) {
                            console.log('ğŸ“ æ²¡æœ‰å®Œæ•´contentæ ‡ç­¾ï¼Œä½†æœ‰æœ‰æ•ˆå†…å®¹ï¼Œç›´æ¥æ˜¾ç¤º');
                            await this.displayInteractiveInChat(cleanContent);
                        } else {
                            console.log('âš ï¸ æ²¡æœ‰æœ‰æ•ˆçš„äº’åŠ¨å†…å®¹ï¼Œè·³è¿‡å¤„ç†');
                        }
                    }
                },
                
                async processMiPhone(task) {
                    console.log('ğŸ“± å¤„ç†MiPhoneæ ¼å¼');
                    
                    // å°è¯•æ‰€æœ‰å¯èƒ½çš„MiPhoneæ ¼å¼å˜åŒ–ï¼ˆåŒ…æ‹¬ä¸å®Œæ•´æ ¼å¼ï¼‰
                    const miPhonePatterns = [
                        // å®Œæ•´æ ¼å¼ï¼ˆä¼˜å…ˆï¼‰
                        /MiPhone_start([\s\S]*?)MiPhone_end/g,
                        /MiPhone_JSON_START([\s\S]*?)MiPhone_JSON_END/g,
                        /MiPhone_JSON_start([\s\S]*?)MiPhone_JSON_end/g,
                        /MiPhone_Start([\s\S]*?)MiPhone_End/g,
                        /MiPhone_START([\s\S]*?)MiPhone_END/g,
                        /MiPhone([\s\S]*?)MiPhone/g,
                        // *** æ–°å¢ï¼šä¸å®Œæ•´æ ¼å¼ï¼ˆä»…å¼€å§‹æ ‡ç­¾ï¼‰ ***
                        /^MiPhone_JSON_START([\s\S]*)$/,
                        /^MiPhone_start([\s\S]*)$/,
                        /^MiPhone_Start([\s\S]*)$/,
                        /^MiPhone_START([\s\S]*)$/
                    ];
                    
                    let matched = false;
                    for (const pattern of miPhonePatterns) {
                        const match = task.content.match(pattern);
                        if (match) {
                            console.log(`ğŸ“± åŒ¹é…åˆ°MiPhoneæ ¼å¼: ${pattern.source.substring(0, 30)}...`);
                            console.log('ğŸ“± åœ¨MiPhoneä¸­æå–åˆ°å†…å®¹ï¼Œå‡†å¤‡é€’å½’å¤„ç†');
                            
                            // éªŒè¯æå–çš„å†…å®¹
                            const innerContent = match[1];
                            if (!innerContent || typeof innerContent !== 'string') {
                                console.warn('âš ï¸ MiPhoneå†…å®¹æå–å¤±è´¥ï¼Œè·³è¿‡é€’å½’å¤„ç†', innerContent);
                                continue;
                            }
                            
                            // é€’å½’å¤„ç†MiPhoneå†…çš„å†…å®¹
                            const innerSegments = this.splitIntoSegments(innerContent);
                            const innerTasks = this.createTaskQueue(innerSegments);
                            for (const innerTask of innerTasks) {
                                await this.processTask(innerTask);
                            }
                            matched = true;
                            break;
                        }
                    }
                    
                    if (!matched) {
                        console.warn('âš ï¸ æœªèƒ½åŒ¹é…ä»»ä½•MiPhoneæ ¼å¼å˜åŒ–ï¼Œå°è¯•ä½¿ç”¨åŸæœ‰å¤„ç†é€»è¾‘');
                        console.log('ğŸ” MiPhoneä»»åŠ¡å†…å®¹é¢„è§ˆ:', task.content.substring(0, 200));
                        
                        // *** ä¿®å¤ï¼šè°ƒç”¨åŸæœ‰çš„MiPhoneå¤„ç†é€»è¾‘ä½œä¸ºå›é€€æ–¹æ¡ˆ ***
                        try {
                            console.log('ğŸ”„ ä½¿ç”¨åŸæœ‰QQ_Msg_Parseå¤„ç†é€»è¾‘');
                            await QQ_Msg_Parse(task.content);
                            console.log('âœ… åŸæœ‰é€»è¾‘å¤„ç†æˆåŠŸ');
                        } catch (fallbackError) {
                            console.error('âŒ åŸæœ‰é€»è¾‘ä¹Ÿå¤„ç†å¤±è´¥:', fallbackError);
                        }
                    }
                },
                
                async processPlainText(task) {
                    console.log('ğŸ“ å¤„ç†çº¯æ–‡æœ¬å†…å®¹');
                    // ã€æ–°å¢ä¿®å¤ã€‘é¦–å…ˆå¯¹å†…å®¹è¿›è¡Œæ¸…ç†å’Œé•¿åº¦æ£€æŸ¥
                    const cleanContent = task.content.trim();
                    
                    // å¦‚æœæ¸…ç†åå†…å®¹é•¿åº¦å°äº30ï¼ˆå¯è°ƒæ•´ï¼‰ï¼Œå°±è®¤ä¸ºå®ƒä¸å¯èƒ½æ˜¯æœ‰æ•ˆçš„äº’åŠ¨å†…å®¹ï¼Œç›´æ¥å¿½ç•¥ã€‚
                    if (cleanContent.length < 30) { 
                        console.log(`çº¯æ–‡æœ¬å— "${cleanContent}" è¿‡çŸ­æˆ–ä¸ºç©ºï¼Œå·²å¿½ç•¥ã€‚`);
                        return; // ç›´æ¥è¿”å›ï¼Œä¸è¿›è¡Œåç»­å¤„ç†
                    }
                    if (task.inferredType === 'likely_interactive') {
                        console.log('  æ¨æ–­ä¸ºäº’åŠ¨å†…å®¹');
                        await this.displayInteractiveInChat(task.content);
                    } else {
                        console.log('  å†…å®¹ç±»å‹æœªçŸ¥ï¼Œå°è¯•æ ‡å‡†å¤„ç†');
                        // å¯ä»¥å°è¯•å…¶ä»–å¤„ç†æ–¹å¼
                    }
                },
                
                /**
                 * åœ¨èŠå¤©å®¹å™¨ä¸­æ˜¾ç¤ºäº’åŠ¨å†…å®¹ï¼ˆæ–°åŠŸèƒ½ï¼‰
                 * @param {string} content - äº’åŠ¨å†…å®¹
                 */
                async displayInteractiveInChat(content, specificCharacter = null) {
                    console.log('ğŸ¨ å‡†å¤‡åœ¨å½“å‰èŠå¤©å®¹å™¨ä¸­æ˜¾ç¤ºäº’åŠ¨å†…å®¹');
                    
                    // éªŒè¯å†…å®¹æ˜¯å¦æœ‰æ•ˆ
                    if (!content || typeof content !== 'string') {
                        console.log('âš ï¸ äº’åŠ¨å†…å®¹ä¸ºç©ºæˆ–æ— æ•ˆï¼Œè·³è¿‡æ˜¾ç¤º');
                        return;
                    }
                    
                    // æ¸…ç†å¯èƒ½æ®‹ç•™çš„contentæ ‡ç­¾
                    let cleanContent = content.replace(/<\/?content>/gi, '').trim();
                    
                    // è¿›ä¸€æ­¥éªŒè¯æ¸…ç†åçš„å†…å®¹
                    if (!cleanContent || cleanContent.length === 0) {
                        console.log('âš ï¸ æ¸…ç†åçš„äº’åŠ¨å†…å®¹ä¸ºç©ºï¼Œè·³è¿‡æ˜¾ç¤º');
                        return;
                    }
                    
                    // ç¡®ä¿å†…å®¹æœ‰å®é™…æ„ä¹‰ï¼ˆä¸ä»…ä»…æ˜¯ç©ºç™½å­—ç¬¦ï¼‰
                    if (cleanContent.replace(/\s+/g, '').length === 0) {
                        console.log('âš ï¸ äº’åŠ¨å†…å®¹åªåŒ…å«ç©ºç™½å­—ç¬¦ï¼Œè·³è¿‡æ˜¾ç¤º');
                        return;
                    }
                    
                    console.log(`âœ… äº’åŠ¨å†…å®¹éªŒè¯é€šè¿‡ï¼Œé•¿åº¦: ${cleanContent.length}`);
                    
                    // *** ä¿®å¤ï¼šæ›´ç²¾ç¡®åœ°ç¡®å®šç›®æ ‡è§’è‰² ***
                    const targetCharacter = specificCharacter || QQ_LastRequestName || charcardname;
                    
                    // *** ä¿®å¤ï¼šæ£€æŸ¥å½“å‰å¯è§çš„èŠå¤©ç•Œé¢ï¼Œç¡®ä¿äº’åŠ¨å†…å®¹æ˜¾ç¤ºåœ¨æ­£ç¡®ä½ç½® ***
                    const currentVisiblePage = $('.QQ_chat_page:visible');
                    let shouldDisplayHere = false;
                    
                    if (currentVisiblePage.length > 0) {
                        const pageDataName = currentVisiblePage.attr('data-name');
                        console.log(`ğŸ“ å½“å‰å¯è§ç•Œé¢: ${pageDataName}, ç›®æ ‡è§’è‰²: ${targetCharacter}`);
                        
                        // æ£€æŸ¥æ˜¯å¦åº”è¯¥åœ¨å½“å‰ç•Œé¢æ˜¾ç¤ºäº’åŠ¨å†…å®¹
                        if (pageDataName === targetCharacter) {
                            shouldDisplayHere = true;
                            console.log(`âœ… å½“å‰ç•Œé¢ä¸ç›®æ ‡è§’è‰²åŒ¹é…ï¼Œåœ¨æ­¤æ˜¾ç¤ºäº’åŠ¨å†…å®¹`);
                        } else {
                            console.log(`âš ï¸ å½“å‰ç•Œé¢ (${pageDataName}) ä¸ç›®æ ‡è§’è‰² (${targetCharacter}) ä¸åŒ¹é…`);
                            // å°è¯•åˆ‡æ¢åˆ°æ­£ç¡®çš„ç•Œé¢
                            const targetPage = $(`.QQ_chat_page[data-name='${targetCharacter}']`);
                            if (targetPage.length > 0) {
                                console.log(`ğŸ”„ åˆ‡æ¢åˆ°ç›®æ ‡è§’è‰²ç•Œé¢: ${targetCharacter}`);
                                $('.QQ_chat_page').hide();
                                targetPage.show();
                                shouldDisplayHere = true;
                            }
                        }
                    }
                    
                    if (shouldDisplayHere) {
                        // *** ä¿®å¤ï¼šåœ¨å¼€å§‹æ˜¾ç¤ºäº’åŠ¨å†…å®¹æ—¶ç«‹å³æ ‡è®°èŠå¤©å·²è§¦å‘ï¼Œç¡®ä¿å¼€å…³ç«‹å³æ˜¾ç¤º ***
                        const chatName = targetCharacter || 'å…¬å…±èŠå¤©';
                        console.log(`ğŸ­ ç«‹å³æ ‡è®°èŠå¤© ${chatName} å·²è§¦å‘äº’åŠ¨å†…å®¹ï¼ˆä» displayInteractiveInChatï¼‰`);
                        await QQ_InteractiveMode.markChatTriggered(chatName);
                        
                        // åœ¨æ­£ç¡®çš„ç•Œé¢æ˜¾ç¤ºäº’åŠ¨å†…å®¹
                        if (targetCharacter) {
                            console.log(`ğŸ’¬ åœ¨${targetCharacter}çš„å¯¹è¯ä¸­æ˜¾ç¤ºäº’åŠ¨å†…å®¹`);
                            await QQ_DisplayInteractiveInPrivateChat(cleanContent, targetCharacter);
                        } else {
                            console.log(`ğŸ‘¥ åœ¨å½“å‰ç•Œé¢æ˜¾ç¤ºå…¬å…±äº’åŠ¨å†…å®¹`);
                            await QQ_DisplayInteractiveInGroupChat(cleanContent);
                        }
                    } else {
                        console.warn(`âš ï¸ æ— æ³•ç¡®å®šäº’åŠ¨å†…å®¹çš„æ­£ç¡®æ˜¾ç¤ºä½ç½®ï¼Œä½¿ç”¨å¤‡é€‰æ–¹æ¡ˆ`);
                        // ä½¿ç”¨åŸæœ‰çš„äº’åŠ¨ç©ºé—´æ˜¾ç¤º
                        QQ_HandleInteractiveContent(cleanContent, targetCharacter);
                    }
                }
            };

            // æ³¨é‡Šï¼šç§»é™¤äº†å¤æ‚çš„è§’è‰²æ£€æµ‹å‡½æ•°ï¼Œç°åœ¨ç›´æ¥åœ¨å½“å‰ç•Œé¢æ˜¾ç¤ºäº’åŠ¨å†…å®¹

            /**
             * åœ¨ç§èŠç•Œé¢ä¸­æ˜¾ç¤ºäº’åŠ¨å†…å®¹
             * @param {string} content - äº’åŠ¨å†…å®¹
             * @param {string} characterName - è§’è‰²åç§°
             */
            async function QQ_DisplayInteractiveInPrivateChat(content, characterName) {
                console.log(`ğŸ’¬ åœ¨å½“å‰ç•Œé¢æ˜¾ç¤º${characterName}çš„äº’åŠ¨å†…å®¹`);
                
                // ç›´æ¥åœ¨å½“å‰å¯è§çš„èŠå¤©å®¹å™¨ä¸­æ·»åŠ äº’åŠ¨å†…å®¹ï¼Œä¸åˆ‡æ¢ç•Œé¢
                const currentChatContainer = $('.QQ_chat_page:visible .msgcontent');
                
                if (currentChatContainer.length > 0) {
                    console.log('âœ… æ‰¾åˆ°å½“å‰å¯è§çš„èŠå¤©å®¹å™¨ï¼Œç›´æ¥æ·»åŠ äº’åŠ¨å†…å®¹');
                    
                    // åˆ›å»ºäº’åŠ¨å†…å®¹æ¶ˆæ¯å…ƒç´ 
                    const interactiveMsg = QQ_CreateInteractiveMessage(content, characterName);
                    currentChatContainer.append(interactiveMsg);
                    
                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    currentChatContainer.scrollTop(currentChatContainer[0].scrollHeight);
                    
                    // æµå¼æ˜¾ç¤ºåŠ¨ç”»
                    await QQ_AnimateStreamText(interactiveMsg.find('.interactive-text'));
                    
                    // ä¿å­˜äº’åŠ¨å†…å®¹åˆ°è§’è‰²ä¸“å±ç©ºé—´
                    await QQ_SaveInteractiveToCharacterSpace(content, characterName);
                    
                    // è§¦å‘äº’åŠ¨å†…å®¹æ˜¾ç¤ºäº‹ä»¶
                    $(document).trigger('interactiveContentDisplayed');
                } else {
                    console.warn('âš ï¸ æœªæ‰¾åˆ°å¯è§çš„èŠå¤©å®¹å™¨ï¼Œæ— æ³•æ˜¾ç¤ºäº’åŠ¨å†…å®¹');
                    // ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆï¼Œä½¿ç”¨åŸæœ‰çš„äº’åŠ¨ç©ºé—´æ˜¾ç¤º
                    QQ_HandleInteractiveContent(content, characterName);
                }
            }

            /**
             * åœ¨ç¾¤èŠç•Œé¢ä¸­æ˜¾ç¤ºäº’åŠ¨å†…å®¹
             * @param {string} content - äº’åŠ¨å†…å®¹
             */
            async function QQ_DisplayInteractiveInGroupChat(content) {
                console.log(`ğŸ‘¥ åœ¨å½“å‰ç•Œé¢æ˜¾ç¤ºå…¬å…±äº’åŠ¨å†…å®¹`);
                
                // ç›´æ¥åœ¨å½“å‰å¯è§çš„èŠå¤©å®¹å™¨ä¸­æ·»åŠ äº’åŠ¨å†…å®¹ï¼Œä¸åˆ‡æ¢ç•Œé¢
                const currentChatContainer = $('.QQ_chat_page:visible .msgcontent');
                
                if (currentChatContainer.length > 0) {
                    console.log('âœ… æ‰¾åˆ°å½“å‰å¯è§çš„èŠå¤©å®¹å™¨ï¼Œç›´æ¥æ·»åŠ å…¬å…±äº’åŠ¨å†…å®¹');
                    
                    // ä»å†…å®¹ä¸­æå–åœºæ™¯ä¿¡æ¯ï¼Œç”¨äºå‘½å
                    const sceneInfo = QQ_ExtractSceneInfo(content);
                    const groupLabel = sceneInfo.suggestedGroup || 'å…¬å…±äº’åŠ¨';
                    
                    // åˆ›å»ºäº’åŠ¨å†…å®¹æ¶ˆæ¯å…ƒç´ 
                    const interactiveMsg = QQ_CreateInteractiveMessage(content, null, true, groupLabel);
                    currentChatContainer.append(interactiveMsg);
                    
                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    currentChatContainer.scrollTop(currentChatContainer[0].scrollHeight);
                    
                    // æµå¼æ˜¾ç¤ºåŠ¨ç”»
                    await QQ_AnimateStreamText(interactiveMsg.find('.interactive-text'));
                    
                    // ä¿å­˜äº’åŠ¨å†…å®¹åˆ°å…¬å…±ç©ºé—´
                    await QQ_SaveInteractiveToPublicSpace(content, groupLabel);
                    
                    // è§¦å‘äº’åŠ¨å†…å®¹æ˜¾ç¤ºäº‹ä»¶
                    $(document).trigger('interactiveContentDisplayed');
                } else {
                    console.warn('âš ï¸ æœªæ‰¾åˆ°å¯è§çš„èŠå¤©å®¹å™¨ï¼Œæ— æ³•æ˜¾ç¤ºäº’åŠ¨å†…å®¹');
                    // ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆï¼Œä½¿ç”¨åŸæœ‰çš„äº’åŠ¨ç©ºé—´æ˜¾ç¤º
                    QQ_HandleInteractiveContent(content);
                }
            }

            /**
             * åˆ›å»ºäº’åŠ¨å†…å®¹æ¶ˆæ¯å…ƒç´ 
             * @param {string} content - äº’åŠ¨å†…å®¹
             * @param {string} characterName - è§’è‰²åç§°ï¼ˆç§èŠæ—¶ä½¿ç”¨ï¼‰
             * @param {boolean} isGroup - æ˜¯å¦ä¸ºç¾¤èŠ
             * @returns {jQuery} æ¶ˆæ¯å…ƒç´ 
             */
            function QQ_CreateInteractiveMessage(content, characterName = null, isGroup = false, groupLabel = null) {
                const messageId = `interactive_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                const timestamp = QQ_GetTime();
                
                // åˆ›å»ºæ¶ˆæ¯HTML
                const messageHtml = `
                    <div id="${messageId}" class="message-item interactive-message" style="
                        margin: 10px 0;
                        padding: 12px 15px;
                        background: rgba(240, 240, 240, 0.9);
                        border-radius: 12px;
                        position: relative;
                        animation: fadeIn 0.3s ease;
                    ">
                        <div class="interactive-header" style="
                            font-size: 12px;
                            color: #666;
                            margin-bottom: 8px;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                        ">
                            <span class="interactive-icon" style="
                                display: inline-flex;
                                align-items: center;
                                justify-content: center;
                                width: 20px;
                                height: 20px;
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                border-radius: 50%;
                                color: white;
                                font-size: 10px;
                            ">âœ¨</span>
                            <span class="interactive-label">${isGroup ? (groupLabel || 'å…¬å…±äº’åŠ¨') : `ä¸${characterName}çš„äº’åŠ¨`}</span>
                            <span class="interactive-time" style="margin-left: auto; opacity: 0.7;">${timestamp}</span>
                        </div>
                        <div class="interactive-content" style="
                            font-size: 14px;
                            line-height: 1.6;
                            color: #333;
                            white-space: pre-wrap;
                            word-wrap: break-word;
                        ">
                            <span class="interactive-text" data-content="${encodeURIComponent(content)}"></span>
                        </div>
                    </div>
                `;
                
                return $(messageHtml);
            }

            /**
             * æµå¼æ–‡æœ¬æ˜¾ç¤ºåŠ¨ç”»
             * @param {jQuery} element - æ–‡æœ¬å…ƒç´ 
             */
            async function QQ_AnimateStreamText(element) {
                const content = decodeURIComponent(element.attr('data-content'));
                const chars = content.split('');
                let displayedText = '';
                
                // æ·»åŠ æ‰“å­—ä¸­çš„ç±»
                element.addClass('typing');
                
                for (let i = 0; i < chars.length; i++) {
                    displayedText += chars[i];
                    element.text(displayedText);
                    
                    // æ ¹æ®å­—ç¬¦ç±»å‹è°ƒæ•´å»¶è¿Ÿ
                    let delay = 30; // é»˜è®¤å»¶è¿Ÿ
                    if (chars[i] === 'ã€‚' || chars[i] === 'ï¼' || chars[i] === 'ï¼Ÿ') {
                        delay = 100; // å¥å·å»¶è¿Ÿæ›´é•¿
                    } else if (chars[i] === 'ï¼Œ' || chars[i] === 'ã€') {
                        delay = 50; // é€—å·å»¶è¿Ÿé€‚ä¸­
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
                
                // ç§»é™¤æ‰“å­—ä¸­çš„ç±»
                element.removeClass('typing');
            }

            // æ³¨é‡Šï¼šç§»é™¤äº†ç•Œé¢åˆ‡æ¢ç›¸å…³å‡½æ•°ï¼Œäº’åŠ¨å†…å®¹ç°åœ¨ç›´æ¥æ˜¾ç¤ºåœ¨å½“å‰ç•Œé¢ä¸­

            /**
             * ä»å†…å®¹ä¸­æå–åœºæ™¯ä¿¡æ¯
             * @param {string} content - å†…å®¹æ–‡æœ¬
             * @returns {Object} åœºæ™¯ä¿¡æ¯
             */
            function QQ_ExtractSceneInfo(content) {
                // æ ¹æ®å†…å®¹å…³é”®è¯æ¨èåˆé€‚çš„ç¾¤èŠ
                const scenePatterns = [
                    { keywords: ['å’–å•¡', 'èŒ¶', 'é¥®æ–™'], group: 'ä¸‹åˆèŒ¶æ—¶å…‰' },
                    { keywords: ['æ¸¸æˆ', 'ç©', 'æ¯”èµ›'], group: 'æ¸¸æˆå°é˜Ÿ' },
                    { keywords: ['å­¦ä¹ ', 'ä½œä¸š', 'è€ƒè¯•'], group: 'å­¦ä¹ å°ç»„' },
                    { keywords: ['å”±æ­Œ', 'éŸ³ä¹', 'æ¼”å¥'], group: 'éŸ³ä¹è§’' },
                    { keywords: ['åƒé¥­', 'ç¾é£Ÿ', 'æ–™ç†'], group: 'ç¾é£Ÿåˆ†äº«' }
                ];
                
                for (const pattern of scenePatterns) {
                    if (pattern.keywords.some(keyword => content.includes(keyword))) {
                        return { suggestedGroup: pattern.group };
                    }
                }
                
                return { suggestedGroup: 'æ—¥å¸¸äº’åŠ¨' };
            }

            /**
             * ä¿å­˜äº’åŠ¨å†…å®¹åˆ°è§’è‰²ä¸“å±ç©ºé—´
             * @param {string} content - äº’åŠ¨å†…å®¹
             * @param {string} characterName - è§’è‰²åç§°
             */
            async function QQ_SaveInteractiveToCharacterSpace(content, characterName) {
                const spaceId = QQ_GenerateSpaceId();
                const spaceName = `${characterName}Â·${QQ_GetSceneFromContent(content)}`;
                
                // ç¡®ä¿è§’è‰²ç©ºé—´å­˜åœ¨
                QQ_EnsureCharacterSpaceIndependence(characterName);
                
                // ä¿å­˜åˆ°è§’è‰²ä¸“å±ç©ºé—´
                QQ_CharacterSpaces[characterName][spaceId] = {
                    id: spaceId,
                    name: spaceName,
                    content: content,
                    characterName: characterName,
                    characterAvatar: QQ_GetCharacterAvatar(characterName),
                    type: 'character',
                    createdAt: new Date().toISOString(),
                    lastAccess: new Date().toISOString(),
                    displayMode: 'in-chat' // æ ‡è®°ä¸ºèŠå¤©å†…æ˜¾ç¤ºæ¨¡å¼
                };
                
                // ä½¿ç”¨ç»Ÿä¸€çš„äº’åŠ¨å†…å®¹ä¿å­˜æœºåˆ¶
                const locationInfo = {
                    type: 'privateChat',
                    target: characterName,
                    chatType: 'character'
                };
                const interactiveId = await QQ_SaveInteractiveContentToWorldBook(content, characterName, locationInfo);
                
                // *** ä¿®å¤ï¼šåœ¨èŠå¤©è®°å½•ä¸­æ’å…¥å ä½ç¬¦ ***
                if (interactiveId) {
                    const placeholder = `[å‘ç”Ÿäº†ä¸€æ®µäº’åŠ¨ (ID: ${interactiveId})]`;
                    const chatKey = `${UserName}å’Œ${characterName}çš„èŠå¤©`;
                    
                    // *** ä¿®å¤ï¼šç¡®ä¿èŠå¤©è®°å½•å­˜åœ¨ ***
                    if (!QQ_msgjson.ç§èŠ) {
                        QQ_msgjson.ç§èŠ = {};
                    }
                    if (!QQ_msgjson.ç§èŠ[chatKey]) {
                        QQ_msgjson.ç§èŠ[chatKey] = [];
                    }
                    
                    // *** ä¿®å¤ï¼šä½¿ç”¨ä¸æ™®é€šèŠå¤©æ¶ˆæ¯ç›¸åŒçš„æ ¼å¼ ***
                    const timestamp = new Date().toLocaleTimeString('zh-CN', { hour12: false });
                    const placeholderMsg = `${characterName}--${placeholder}--${timestamp}`;
                    QQ_msgjson.ç§èŠ[chatKey].push(placeholderMsg);
                    console.log(`âœ… æ·»åŠ äº’åŠ¨å†…å®¹å ä½ç¬¦åˆ°èŠå¤©è®°å½•: ${placeholderMsg}`);
                    
                    // *** å…³é”®ä¿®å¤ï¼šç«‹å³ä¿å­˜èŠå¤©è®°å½•å¤‡ä»½ ***
                    try {
                        await QQ_Save_Chat_Backup();
                        console.log(`âœ… èŠå¤©è®°å½•å¤‡ä»½å·²æ›´æ–°ï¼ˆåŒ…å«äº’åŠ¨å ä½ç¬¦ï¼‰`);
                    } catch (error) {
                        console.error('ä¿å­˜èŠå¤©è®°å½•å¤‡ä»½å¤±è´¥:', error);
                    }
                }
                
                // åŒæ—¶ä¿å­˜åˆ°è§’è‰²ç©ºé—´å¤‡ä»½
                QQ_SaveCharacterSpaces().catch(error => {
                    console.error('ä¿å­˜è§’è‰²äº’åŠ¨ç©ºé—´å¤±è´¥:', error);
                });
            }

            /**
             * *** æ–°å¢ï¼šåˆ›å»ºå±•å¼€çš„äº’åŠ¨å†…å®¹æ˜¾ç¤º ***
             * @param {string} content - äº’åŠ¨å†…å®¹
             * @param {string} interactiveId - äº’åŠ¨å†…å®¹ID
             * @returns {jQuery} å±•å¼€çš„äº’åŠ¨å†…å®¹å…ƒç´ 
             */
            function QQ_CreateExpandedInteractiveDisplay(content, interactiveId) {
                const expandedDiv = $(`
                    <div class="expanded-interactive-content" data-id="${interactiveId}" style="
                        background: rgba(102, 126, 234, 0.15) !important;
                        border: 1px solid rgba(102, 126, 234, 0.3) !important;
                        border-radius: 12px;
                        padding: 12px;
                        margin: 8px 0;
                        font-size: 14px;
                        line-height: 1.4;
                        color: #333;
                        white-space: pre-wrap;
                        position: relative;
                    ">
                        <div style="
                            background: #667eea;
                            color: white;
                            padding: 4px 8px;
                            border-radius: 6px;
                            font-size: 11px;
                            margin-bottom: 8px;
                            display: inline-block;
                        ">ğŸ­ äº’åŠ¨å†…å®¹</div>
                        <div class="interactive-text-content" style="margin-top: 8px;"></div>
                        <div style="
                            text-align: right;
                            margin-top: 8px;
                            font-size: 11px;
                            color: #666;
                            border-top: 1px solid rgba(102, 126, 234, 0.2);
                            padding-top: 6px;
                        ">
                            <button class="collapse-interactive" style="
                                background: #667eea;
                                color: white;
                                border: none;
                                padding: 4px 8px;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 11px;
                            ">æ”¶èµ·</button>
                        </div>
                    </div>
                `);

                // æ·»åŠ äº’åŠ¨å†…å®¹ï¼ˆæ”¯æŒæµå¼æ˜¾ç¤ºï¼‰
                const textContainer = expandedDiv.find('.interactive-text-content');
                textContainer.text(content);

                // æ·»åŠ æ”¶èµ·æŒ‰é’®åŠŸèƒ½
                expandedDiv.find('.collapse-interactive').on('click', function() {
                    expandedDiv.slideUp(300, function() {
                        expandedDiv.remove();
                        // æ¢å¤å ä½ç¬¦çš„ç‚¹å‡»åŠŸèƒ½
                        const placeholder = $(`.interactive-placeholder[data-id="${interactiveId}"]`);
                        if (placeholder.length > 0) {
                            placeholder.html(`âœ¨ [å‘ç”Ÿäº†ä¸€æ®µäº’åŠ¨]<div style="font-size: 11px; opacity: 0.8; margin-top: 2px;">ç‚¹å‡»å±•å¼€äº’åŠ¨å†…å®¹</div>`);
                            // é‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶
                            placeholder.off('click').on('click', async function() {
                                const id = $(this).data('id');
                                $(this).html('ğŸ”„ æ­£åœ¨åŠ è½½äº’åŠ¨å†…å®¹...');
                                try {
                                    const interactiveContent = await QQ_LoadInteractiveContentFromWorldBook(id);
                                    if (interactiveContent && interactiveContent.content) {
                                        const expandedDiv = QQ_CreateExpandedInteractiveDisplay(interactiveContent.content, id);
                                        $(this).after(expandedDiv);
                                        $(this).html('âœ… äº’åŠ¨å†…å®¹å·²å±•å¼€');
                                        $(this).off('click');
                                    } else {
                                        $(this).html('âŒ äº’åŠ¨å†…å®¹åŠ è½½å¤±è´¥');
                                    }
                                } catch (error) {
                                    $(this).html('âŒ äº’åŠ¨å†…å®¹åŠ è½½å‡ºé”™');
                                    console.error('åŠ è½½äº’åŠ¨å†…å®¹æ—¶å‡ºé”™:', error);
                                }
                            });
                        }
                    });
                });

                return expandedDiv;
            }

            /**
             * åˆ›å»ºç¾¤èŠï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
             * @param {string} groupName - ç¾¤èŠåç§°
             */
            function QQ_CreateGroup(groupName) {
                if (!QQ_Groups.includes(groupName)) {
                    console.log(`åˆ›å»ºæ–°ç¾¤èŠ: ${groupName}`);
                    QQ_Groups.push(groupName);
                    
                    // åˆå§‹åŒ–ç¾¤èŠæ•°æ®ç»“æ„
                    if (!QQ_msgjson.ç¾¤èŠ[groupName]) {
                        QQ_msgjson.ç¾¤èŠ[groupName] = {
                            members: [],
                            msgs: []
                        };
                    }
                } else {
                    console.log(`ç¾¤èŠå·²å­˜åœ¨: ${groupName}`);
                }
            }

            /**
             * ä¿å­˜äº’åŠ¨å†…å®¹åˆ°å…¬å…±ç©ºé—´
             * @param {string} content - äº’åŠ¨å†…å®¹
             * @param {string} groupName - ç¾¤èŠåç§°
             */
            async function QQ_SaveInteractiveToPublicSpace(content, groupName) {
                const spaceId = QQ_GenerateSpaceId();
                const participants = QQ_ExtractParticipants(content);
                const spaceName = `${groupName}Â·${QQ_GetSceneFromContent(content)}`;
                
                // ä¿å­˜åˆ°å…¬å…±äº’åŠ¨ç©ºé—´
                QQ_InteractiveSpaces[spaceId] = {
                    id: spaceId,
                    name: spaceName,
                    content: content,
                    participants: participants,
                    groupName: groupName,
                    type: 'public',
                    createdAt: new Date().toISOString(),
                    lastAccess: new Date().toISOString(),
                    displayMode: 'in-chat' // æ ‡è®°ä¸ºèŠå¤©å†…æ˜¾ç¤ºæ¨¡å¼
                };
                
                // ä½¿ç”¨ç»Ÿä¸€çš„äº’åŠ¨å†…å®¹ä¿å­˜æœºåˆ¶
                const locationInfo = {
                    type: 'groupChat',
                    target: groupName,
                    chatType: 'group'
                };
                const interactiveId = await QQ_SaveInteractiveContentToWorldBook(content, null, locationInfo);
                
                // *** ä¿®å¤ï¼šåœ¨ç¾¤èŠè®°å½•ä¸­æ’å…¥å ä½ç¬¦ ***
                if (interactiveId && groupName && QQ_Groups.includes(groupName)) {
                    const placeholder = `[å‘ç”Ÿäº†ä¸€æ®µäº’åŠ¨ (ID: ${interactiveId})]`;
                    
                    // *** ä¿®å¤ï¼šç¡®ä¿ç¾¤èŠè®°å½•å­˜åœ¨ ***
                    if (!QQ_msgjson.ç¾¤èŠ) {
                        QQ_msgjson.ç¾¤èŠ = {};
                    }
                    if (!QQ_msgjson.ç¾¤èŠ[groupName]) {
                        QQ_msgjson.ç¾¤èŠ[groupName] = { msgs: [] };
                    }
                    if (!QQ_msgjson.ç¾¤èŠ[groupName].msgs) {
                        QQ_msgjson.ç¾¤èŠ[groupName].msgs = [];
                    }
                    
                    // *** ä¿®å¤ï¼šä½¿ç”¨ä¸æ™®é€šç¾¤èŠæ¶ˆæ¯ç›¸åŒçš„æ ¼å¼ ***
                    const timestamp = new Date().toLocaleTimeString('zh-CN', { hour12: false });
                    const placeholderMsg = `ç³»ç»Ÿ--${placeholder}--${timestamp}`;
                    QQ_msgjson.ç¾¤èŠ[groupName].msgs.push(placeholderMsg);
                    console.log(`âœ… æ·»åŠ äº’åŠ¨å†…å®¹å ä½ç¬¦åˆ°ç¾¤èŠè®°å½•: ${placeholderMsg}`);
                    
                    // *** å…³é”®ä¿®å¤ï¼šç«‹å³ä¿å­˜èŠå¤©è®°å½•å¤‡ä»½ ***
                    try {
                        await QQ_Save_Chat_Backup();
                        console.log(`âœ… èŠå¤©è®°å½•å¤‡ä»½å·²æ›´æ–°ï¼ˆåŒ…å«ç¾¤èŠäº’åŠ¨å ä½ç¬¦ï¼‰`);
                    } catch (error) {
                        console.error('ä¿å­˜èŠå¤©è®°å½•å¤‡ä»½å¤±è´¥:', error);
                    }
                }
                
                // åŒæ—¶ä¿å­˜åˆ°å…¬å…±ç©ºé—´å¤‡ä»½
                QQ_SaveInteractiveSpaces().catch(error => {
                    console.error('ä¿å­˜å…¬å…±äº’åŠ¨ç©ºé—´å¤±è´¥:', error);
                });
            }

            /**
             * äº’åŠ¨æ¨¡å¼ç®¡ç†ç³»ç»Ÿ
             */
            const QQ_InteractiveMode = {
                enabled: false,
                hasTriggered: false, // æ˜¯å¦å·²ç»è§¦å‘è¿‡äº’åŠ¨å†…å®¹
                triggeredChats: new Set(), // è®°å½•å“ªäº›èŠå¤©é¡µé¢æ›¾ç»æœ‰è¿‡äº’åŠ¨å†…å®¹
                switchElement: null,
                
                /**
                 * åˆå§‹åŒ–äº’åŠ¨æ¨¡å¼ç³»ç»Ÿ
                 */
                async init() {
                    // ç›‘å¬äº’åŠ¨å†…å®¹çš„é¦–æ¬¡è§¦å‘
                    $(document).on('interactiveContentDisplayed', () => {
                        this.onFirstInteractive();
                    });
                    
                    // åŠ è½½æŒä¹…åŒ–çš„è§¦å‘çŠ¶æ€
                    await this.loadTriggeredChats();
                    
                    // åˆ›å»ºå¼€å…³å…ƒç´ 
                    this.createSwitch();
                },
                
                /**
                 * *** æ–°å¢ï¼šåŠ è½½å·²è§¦å‘äº’åŠ¨å†…å®¹çš„èŠå¤©åˆ—è¡¨ ***
                 */
                async loadTriggeredChats() {
                    try {
                        // ä»ä¸–ç•Œä¹¦åŠ è½½è§¦å‘çŠ¶æ€
                        const data = await QQ_GetFromWorldBook('äº’åŠ¨æ¨¡å¼è§¦å‘çŠ¶æ€');
                        if (data && Array.isArray(data)) {
                            this.triggeredChats = new Set(data);
                            console.log(`ğŸ­ åŠ è½½äº’åŠ¨è§¦å‘çŠ¶æ€: ${data.length}ä¸ªèŠå¤©é¡µé¢`);
                        }
                    } catch (error) {
                        console.warn('åŠ è½½äº’åŠ¨è§¦å‘çŠ¶æ€å¤±è´¥:', error);
                    }
                },
                
                /**
                 * *** æ–°å¢ï¼šä¿å­˜è§¦å‘çŠ¶æ€åˆ°ä¸–ç•Œä¹¦ ***
                 */
                async saveTriggeredChats() {
                    try {
                        const data = Array.from(this.triggeredChats);
                        await QQ_SafeSaveToWorldBook('äº’åŠ¨æ¨¡å¼è§¦å‘çŠ¶æ€', data, 'QQ_äº’åŠ¨æ¨¡å¼è§¦å‘çŠ¶æ€');
                        console.log(`ğŸ­ ä¿å­˜äº’åŠ¨è§¦å‘çŠ¶æ€: ${data.length}ä¸ªèŠå¤©é¡µé¢`);
                    } catch (error) {
                        console.warn('ä¿å­˜äº’åŠ¨è§¦å‘çŠ¶æ€å¤±è´¥:', error);
                    }
                },
                
                /**
                 * *** æ–°å¢ï¼šæ£€æŸ¥ç‰¹å®šèŠå¤©æ˜¯å¦å·²è§¦å‘è¿‡äº’åŠ¨å†…å®¹ ***
                 */
                hasChatTriggered(chatName) {
                    return this.triggeredChats.has(chatName);
                },
                
                /**
                 * *** æ–°å¢ï¼šæ ‡è®°ç‰¹å®šèŠå¤©å·²è§¦å‘äº’åŠ¨å†…å®¹ ***
                 */
                async markChatTriggered(chatName) {
                    if (!this.triggeredChats.has(chatName)) {
                        this.triggeredChats.add(chatName);
                        await this.saveTriggeredChats();
                        console.log(`ğŸ­ æ ‡è®°èŠå¤© ${chatName} å·²è§¦å‘äº’åŠ¨å†…å®¹ï¼ˆé¦–æ¬¡ï¼‰`);
                        
                        // æ›´æ–°è¯¥èŠå¤©é¡µé¢çš„å¼€å…³æ˜¾ç¤º
                        this.updateSwitchVisibility(chatName);
                    } else {
                        console.log(`ğŸ”„ èŠå¤© ${chatName} å·²ç»è¢«æ ‡è®°è¿‡ï¼Œè·³è¿‡é‡å¤æ ‡è®°`);
                    }
                },
                
                /**
                 * åˆ›å»ºäº’åŠ¨æ¨¡å¼åˆ‡æ¢å¼€å…³
                 */
                createSwitch() {
                    const self = this;
                    
                    function addSwitchToContainers() {
                        // æ·»åŠ åˆ°æ¯ä¸ªè¾“å…¥å®¹å™¨
                        $('.input-container').each(function() {
                            // è·å–å½“å‰èŠå¤©é¡µé¢åç§°
                            const $chatPage = $(this).closest('.QQ_chat_page');
                            const chatName = $chatPage.attr('data-name') || '';
                            
                            // æ£€æŸ¥è¯¥èŠå¤©æ˜¯å¦å·²è§¦å‘è¿‡äº’åŠ¨å†…å®¹
                            const hasChatTriggered = self.hasChatTriggered(chatName);
                            
                            const switchHtml = `
                                <div class="interactive-mode-switch ${hasChatTriggered ? 'visible' : ''}">
                                    <div class="interactive-mode-button ${self.enabled ? 'active' : ''}">
                                        <span class="interactive-mode-icon">âœ¨</span>
                                    </div>
                                </div>
                            `;
                            
                            if (!$(this).find('.interactive-mode-switch').length) {
                                $(this).prepend(switchHtml);
                            } else {
                                // *** ä¿®å¤ï¼šä»…åŒæ­¥æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€ï¼Œä¸é‡å¤æ£€æŸ¥å¯è§æ€§é¿å…é—ªçƒ ***
                                const $switch = $(this).find('.interactive-mode-switch');
                                // åªæ›´æ–°æ¿€æ´»çŠ¶æ€ï¼Œä¸å¼ºåˆ¶æ›´æ–°å¯è§æ€§ï¼ˆå¯è§æ€§ç”± updateSwitchVisibility å•ç‹¬ç®¡ç†ï¼‰
                                $switch.find('.interactive-mode-button').toggleClass('active', self.enabled);
                                
                                // åªæœ‰åœ¨å½“å‰ä¸å¯è§ä¸”å·²è§¦å‘çš„æƒ…å†µä¸‹æ‰æ˜¾ç¤ºï¼ˆé˜²æ­¢å·²æ˜¾ç¤ºçš„å¼€å…³è¢«éšè—ï¼‰
                                if (!$switch.hasClass('visible') && hasChatTriggered) {
                                    $switch.addClass('visible');
                                }
                            }
                        });
                    }
                    
                    // åˆå§‹æ·»åŠ 
                    addSwitchToContainers();
                    
                    // ç›‘å¬DOMå˜åŒ–ï¼Œä¸ºæ–°åˆ›å»ºçš„è¾“å…¥å®¹å™¨æ·»åŠ å¼€å…³
                    const observer = new MutationObserver((mutations) => {
                        // *** ä¿®å¤ï¼šåªåœ¨æ·»åŠ äº†æ–°èŠ‚ç‚¹æ—¶æ‰é‡æ–°æ£€æŸ¥ï¼Œé¿å…è¿‡åº¦è§¦å‘ ***
                        const hasNewNodes = mutations.some(mutation => 
                            mutation.type === 'childList' && mutation.addedNodes.length > 0
                        );
                        if (hasNewNodes) {
                            console.log('ğŸ”„ DOMå˜åŒ–æ£€æµ‹åˆ°æ–°èŠ‚ç‚¹ï¼Œæ›´æ–°äº’åŠ¨å¼€å…³');
                            addSwitchToContainers();
                        }
                    });
                    
                    observer.observe(document.body, {
                        childList: true,
                        subtree: true
                    });
                    
                    // ç»‘å®šåˆ‡æ¢äº‹ä»¶ï¼ˆä½¿ç”¨ç‚¹å‡»äº‹ä»¶ä»£æ›¿checkboxï¼‰
                    $(document).on('click', '.interactive-mode-button', (e) => {
                        this.enabled = !this.enabled;
                        // åŒæ­¥æ‰€æœ‰å¼€å…³çŠ¶æ€
                        $('.interactive-mode-button').toggleClass('active', this.enabled);
                        this.onModeChange();
                    });
                },
                
                /**
                 * *** æ–°å¢ï¼šæ›´æ–°ç‰¹å®šèŠå¤©é¡µé¢çš„å¼€å…³å¯è§æ€§ ***
                 */
                updateSwitchVisibility(chatName) {
                    // *** ä¿®å¤ï¼šåŒæ—¶å¤„ç†ç§èŠå’Œç¾¤èŠé¡µé¢ ***
                    let $chatPage = $(`.QQ_chat_page[data-name="${chatName}"]`);
                    
                    // å¦‚æœæ²¡æ‰¾åˆ°ç§èŠé¡µé¢ï¼Œå°è¯•æŸ¥æ‰¾ç¾¤èŠé¡µé¢
                    if ($chatPage.length === 0) {
                        // æŸ¥æ‰¾æ‰€æœ‰ç¾¤èŠé¡µé¢ï¼ŒåŒ¹é…data-nameå±æ€§
                        $chatPage = $(`.group-chat-page[data-name="${chatName}"]`);
                        
                        // å¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œå¯èƒ½éœ€è¦é€šè¿‡currentGroupChatåŒ¹é…
                        if ($chatPage.length === 0 && window.currentGroupChat && window.currentGroupChat.name === chatName) {
                            $chatPage = $(`.group-chat-page[data-group-id="${window.currentGroupChat.id}"]`);
                        }
                    }
                    
                    if ($chatPage.length) {
                        // *** ä¿®å¤ï¼šå…ˆæ£€æŸ¥å¼€å…³æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å…ˆåˆ›å»º ***
                        const $inputContainer = $chatPage.find('.input-container, .chat-input');
                        if ($inputContainer.length > 0) {
                            let $switch = $inputContainer.find('.interactive-mode-switch');
                            const hasChatTriggered = this.hasChatTriggered(chatName);
                            
                            // å¦‚æœå¼€å…³ä¸å­˜åœ¨ï¼Œå…ˆåˆ›å»ºå®ƒ
                            if ($switch.length === 0) {
                                const switchHtml = `
                                    <div class="interactive-mode-switch ${hasChatTriggered ? 'visible' : ''}">
                                        <div class="interactive-mode-button ${this.enabled ? 'active' : ''}">
                                            <span class="interactive-mode-icon">âœ¨</span>
                                        </div>
                                    </div>
                                `;
                                $inputContainer.prepend(switchHtml);
                                $switch = $inputContainer.find('.interactive-mode-switch');
                                
                                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                                $switch.find('.interactive-mode-button').on('click', () => this.toggle());
                            }
                            
                            // æ›´æ–°å¯è§æ€§
                            $switch.toggleClass('visible', hasChatTriggered);
                            $switch.find('.interactive-mode-button').toggleClass('active', this.enabled);
                            console.log(`ğŸ­ æ›´æ–°èŠå¤© ${chatName} çš„å¼€å…³å¯è§æ€§: ${hasChatTriggered ? 'æ˜¾ç¤º' : 'éšè—'}`);
                        } else {
                            console.log(`âš ï¸ æœªæ‰¾åˆ°è¾“å…¥å®¹å™¨: ${chatName}`);
                        }
                    } else {
                        console.log(`âš ï¸ æœªæ‰¾åˆ°èŠå¤©é¡µé¢: ${chatName}`);
                    }
                },
                
                /**
                 * é¦–æ¬¡è§¦å‘äº’åŠ¨å†…å®¹æ—¶æ˜¾ç¤ºå¼€å…³
                 */
                onFirstInteractive() {
                    if (!this.hasTriggered) {
                        this.hasTriggered = true;
                        
                        // æ˜¾ç¤ºæ‰€æœ‰å¼€å…³
                        $('.interactive-mode-switch').addClass('visible');
                        
                        // ç§»é™¤æç¤º - ä¸å†éœ€è¦
                        // this.showHint();
                    }
                },
                
                /**
                 * æ¨¡å¼åˆ‡æ¢æ—¶çš„å¤„ç†
                 */
                onModeChange() {
                    const inputBoxes = $('.userInput');
                    
                    if (this.enabled) {
                        // äº’åŠ¨æ¨¡å¼
                        inputBoxes.attr('placeholder', 'è¾“å…¥äº’åŠ¨å†…å®¹...');
                        inputBoxes.css('border-color', '#667eea');
                    } else {
                        // æ™®é€šæ¨¡å¼
                        inputBoxes.attr('placeholder', 'è¾“å…¥æ¶ˆæ¯...');
                        inputBoxes.css('border-color', '#ddd');
                    }
                },
                
                /**
                 * æ˜¾ç¤ºé¦–æ¬¡ä½¿ç”¨æç¤º - å·²ç§»é™¤
                 */
                showHint() {
                    // æç¤ºåŠŸèƒ½å·²ç§»é™¤
                    return;
                },
                
                /**
                 * æ£€æŸ¥å½“å‰æ˜¯å¦ä¸ºäº’åŠ¨æ¨¡å¼
                 * @returns {boolean}
                 */
                isEnabled() {
                    return this.enabled;
                },
                
                /**
                 * ä¿®æ”¹æç¤ºè¯ä»¥æ”¯æŒäº’åŠ¨æ¨¡å¼
                 * @param {string} prompt - åŸå§‹æç¤ºè¯
                 * @returns {string} ä¿®æ”¹åçš„æç¤ºè¯
                 */
                modifyPrompt(prompt) {
                    if (this.enabled) {
                        // äº’åŠ¨æ¨¡å¼æç¤ºè¯
                        return prompt + `\n\n**é‡è¦**ï¼šç”¨æˆ·ç°åœ¨å¼€å¯äº†äº’åŠ¨æ¨¡å¼ã€‚è¯·å°†ä»¥ä¸‹å†…å®¹ä½œä¸ºäº’åŠ¨åœºæ™¯æ¥å“åº”ï¼Œä½¿ç”¨<content>æ ‡ç­¾åŒ…è£¹ä½ çš„äº’åŠ¨æè¿°ã€‚ä¸è¦è¾“å‡ºç§èŠã€ç¾¤èŠæˆ–åŠ¨æ€æ ¼å¼ï¼Œä¸“æ³¨äºæè¿°äº’åŠ¨åœºæ™¯ã€‚`;
                    } else {
                        // æ™®é€šæ¨¡å¼ï¼Œå¼ºè°ƒä¸è¦è¾“å‡ºäº’åŠ¨å†…å®¹
                        return prompt + `\n\n**é‡è¦**ï¼šç”¨æˆ·ç°åœ¨å¤„äºæ™®é€šèŠå¤©æ¨¡å¼ã€‚è¯·ä¸¥æ ¼éµå®ˆçº¿ä¸Šæ ¼å¼ï¼Œè¾“å‡ºç§èŠã€ç¾¤èŠæˆ–åŠ¨æ€å†…å®¹ã€‚ä¸è¦è¾“å‡ºäº’åŠ¨å†…å®¹ã€‚`;
                    }
                }
            };

            // åœ¨é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–äº’åŠ¨æ¨¡å¼ç³»ç»Ÿ
            $(document).ready(async () => {
                await QQ_InteractiveMode.init();
                QQ_ApplyRandomAvatarsToDefaults();
                
                // é¢å¤–æ£€æŸ¥å’Œåº”ç”¨éšæœºå¤´åƒåˆ°æ‰€æœ‰å¯èƒ½çš„å¤´åƒå…ƒç´ 
                QQ_ScanAndFixAllAvatars();
                
                // å®šæœŸæ£€æŸ¥å¤´åƒï¼ˆæ¯2åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼Œé¿å…è¿‡äºé¢‘ç¹ï¼‰
                setInterval(() => {
                    QQ_ScanAndFixAllAvatars();
                }, 120000);
                
                console.log('ğŸ­ éšæœºå¤´åƒç³»ç»Ÿå·²åˆå§‹åŒ–ï¼ˆåŒ…å«å®šæœŸæ£€æŸ¥ï¼‰');
            });

            async function ResultHandle(result, isRetry = false) {
                console.log(`ğŸ¯ å¼€å§‹AIå›å¤å¤„ç† - ä¸¥æ ¼ä¼˜å…ˆçº§æ¨¡å¼`, { isRetry, retryCount: QQ_RetryCount });
                
                // *** æ–°å¢ï¼šåˆå§‹åŒ–å½“å‰å›å¤æ¶ˆæ¯ä¿æŠ¤ ***
                QQ_CurrentReplyMessages.clear();
                console.log(`ğŸ›¡ï¸ å·²æ¸…ç©ºå½“å‰å›å¤æ¶ˆæ¯ä¿æŠ¤åˆ—è¡¨ï¼Œå‡†å¤‡ä¿æŠ¤æ–°å›å¤`);
                
                // *** æ–°å¢ï¼šå¼‚å¸¸æ ¼å¼é¢„æ£€æµ‹ ***
                if (result && result.length > 0) {
                    const formatAnalysis = QQ_DebugUnusualFormat(result, false);
                    if (formatAnalysis.hasIssues) {
                        console.log("âš ï¸ æ£€æµ‹åˆ°å¼‚å¸¸æ ¼å¼ï¼Œå¯ç”¨å¢å¼ºè§£ææ¨¡å¼");
                        console.log(`ğŸ” å‘ç°é—®é¢˜: ${formatAnalysis.issues.join(', ')}`);
                    }
                }
                
                // *** ä¼˜å…ˆçº§0ï¼šç©ºå›å¤å¤„ç†ï¼ˆç«‹å³returnï¼‰ - å¢å¼ºç‰ˆ ***
                if (!result) {
                    console.log("ğŸ” ä¼˜å…ˆçº§0ï¼šæ£€æµ‹åˆ°ç©ºå›å¤");
                    
                    const errorType = QQ_AnalyzeErrorType(result);
                    
                    // *** ä½¿ç”¨æ™ºèƒ½é”™è¯¯å¤„ç†æœºåˆ¶ ***
                    if (!isRetry && QQ_ShouldRetry(errorType, 'ç©ºå›å¤')) {
                        QQ_RetryCount++;
                        console.log(`AIç©ºå›å¤ï¼Œå¼€å§‹ç¬¬${QQ_RetryCount}æ¬¡é‡è¯•`);
                        triggerSlash(`/echo AIç©ºå›å¤ï¼Œæ­£åœ¨é‡è¯•... (${QQ_RetryCount}/${QQ_MAX_RETRY})`);
                        
                        if (QQ_LastRequest) {
                            gening = true;
                            try {
                                // *** å¢å¼ºçš„é‡è¯•å»¶è¿Ÿç­–ç•¥ ***
                                const delay = Math.min(1000 + QQ_RetryCount * 1000 + QQ_ConsecutiveFailures * 500, 10000);
                                await new Promise(resolve => setTimeout(resolve, delay));
                                const retryResult = await QQ_Gen(QQ_LastRequest);
                                return await ResultHandle(retryResult, true);
                            } finally {
                                gening = false;
                            }
                        }
                    } else {
                        // *** å¢å¼ºçš„å¤±è´¥å¤„ç† ***
                        if (QQ_RetryCount >= QQ_MAX_RETRY) {
                            triggerSlash("/echo AIè¿ç»­ç©ºå›å¤ï¼Œå¯èƒ½å­˜åœ¨é—®é¢˜ï¼Œå·²åœæ­¢é‡è¯•");
                        } else if (QQ_ConsecutiveFailures >= QQ_MAX_CONSECUTIVE_FAILURES) {
                            triggerSlash("/echo ğŸš« AIè¿ç»­å¤±è´¥è¿‡å¤šï¼Œå»ºè®®æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–æ¨¡å‹é…ç½®");
                        } else {
                            triggerSlash("/echo ç©ºå›å¤äº†");
                        }
                        QQ_ResetRetry();
                    }
                    return; // ä¼˜å…ˆçº§0å®Œæˆï¼Œç«‹å³return
                }
                
                result = System_TagCompletion(result);
                
                // *** é˜¶æ®µä¸‰ï¼šæå–å¹¶å¤„ç†ä¸»åŠ¨æ¶ˆæ¯ï¼ˆåœ¨æ¸…ç†ä¹‹å‰ï¼Œé¿å…è¢«è¯¯åˆ ï¼‰ ***
                await QQ_ExtractProactiveMessages(result);
                
                // *** æ–°å¢ï¼šæå–å¹¶å¤„ç†tableEditæ ‡ç­¾ï¼Œå‘é€ç»™SillyTavernåç«¯ ***
                //await QQ_ExtractAndProcessTableEdit(result);
                
                // *** æ¸…ç†ä¸»åŠ¨æ¶ˆæ¯æ ¼å¼ï¼Œé¿å…è¢«å½“ä½œæ™®é€šæ¶ˆæ¯æ˜¾ç¤º ***
                result = QQ_CleanProactiveMessageFormats(result);
                
                result = QQ_CleanNestedTags(result);
                console.log(`æ¸…ç†åçš„ç»“æœ:\n${result.substring(0, 200)}...`);
                
                // *** æœ€ä¼˜å…ˆçº§ï¼šå®Œæ•´contentæ ‡ç­¾å¤„ç† ***
                console.log("ğŸ¯ æœ€ä¼˜å…ˆçº§ï¼šå¼€å§‹æ£€æŸ¥å®Œæ•´contentæ ‡ç­¾");
                const contentTagResult = await QQ_ProcessCompleteContentTag(result);
                if (contentTagResult.success && contentTagResult.extractedContent) {
                    console.log("âœ… æœ€ä¼˜å…ˆçº§æˆåŠŸï¼šæå–åˆ°å®Œæ•´contentå†…å®¹ï¼Œç»§ç»­æ­£å¸¸è§£ææµç¨‹");
                    // å°†resultæ›¿æ¢ä¸ºæå–çš„contentå†…å®¹ï¼Œç»§ç»­åç»­çš„æ­£å¸¸è§£æ
                    result = contentTagResult.extractedContent;
                    console.log(`ğŸ“¤ æ›¿æ¢resultä¸ºcontentå†…å®¹ï¼Œé•¿åº¦: ${result.length}`);
                    // ä¸è¦returnï¼Œç»§ç»­æ‰§è¡Œåç»­çš„è§£æé€»è¾‘
                }
                
                // *** æ–°å¢ï¼šæ£€æµ‹æ˜¯å¦éœ€è¦ä½¿ç”¨é¡ºåºä»»åŠ¡é˜Ÿåˆ—å¤„ç† ***
                // åªæœ‰å½“çœŸæ­£å­˜åœ¨æ··åˆå†…å®¹æˆ–çº¯äº’åŠ¨å†…å®¹æ—¶æ‰ä½¿ç”¨æ™ºèƒ½è°ƒåº¦å™¨
                
                // æ£€æµ‹æ˜¯å¦æœ‰çœŸæ­£çš„äº’åŠ¨å†…å®¹ï¼ˆä¸æ˜¯ä»…ä»…åŒ…è£¹MiPhoneçš„contentæ ‡ç­¾ï¼‰
                const hasRealInteractiveContent = QQ_IsInteractiveContent(result, false);
                
                // æ£€æµ‹æ˜¯å¦æœ‰æ··åˆæ ¼å¼ï¼ˆèŠå¤©æ ¼å¼ + å®é™…çš„äº’åŠ¨å†…å®¹æˆ–åŠ¨æ€ï¼‰
                const hasActualMixedFormats = (result.includes('çš„ç§èŠ>') || result.includes('ç¾¤èŠ:')) && 
                    (hasRealInteractiveContent || result.includes('moment_start') || result.includes('moment_reply_start'));
                
                if (hasActualMixedFormats || hasRealInteractiveContent) {
                    console.log('ğŸ”€ æ£€æµ‹åˆ°æ··åˆæ ¼å¼æˆ–äº’åŠ¨å†…å®¹ï¼Œä½¿ç”¨æ™ºèƒ½è°ƒåº¦å¤„ç†');
                    
                    // ä½¿ç”¨æ–°çš„æ™ºèƒ½è°ƒåº¦å™¨ï¼Œè‡ªåŠ¨å†³å®šå¹¶è¡Œæˆ–é¡ºåºå¤„ç†
                    const processed = await QQ_SmartContentScheduler.process(result);
                    
                    if (processed) {
                        console.log('âœ… æ™ºèƒ½è°ƒåº¦å¤„ç†å®Œæˆï¼ˆåŒ…å«å®Œæ•´åå¤„ç†æµç¨‹ï¼‰ï¼Œè·³è¿‡åŸæœ‰å¤„ç†é€»è¾‘');
                        return; // å¤„ç†å®Œæˆï¼Œç»“æŸæµç¨‹
                    }
                }
                
                // *** åŸæœ‰çš„åˆ†ç¦»å¼å¤„ç†é€»è¾‘ ***
                const separateResult = await QQ_ExtractAndProcessOnlineFormatFirst(result);
                if (separateResult.processed && separateResult.processedCount > 0) {
                    console.log(`âœ… åˆ†ç¦»å¼å¤„ç†æˆåŠŸ: å¤„ç†äº†${separateResult.processedCount}ä¸ªçº¿ä¸Šæ ¼å¼å—`);
                    
                    // æ›´æ–°ç›¸å…³çŠ¶æ€
                    QQ_ResetRetry();
                    QQ_UpdateNewTips();
                    await QQ_Save_Chat_Backup();
                    
                    // å¦‚æœè¿˜æœ‰å‰©ä½™å†…å®¹ï¼Œç»§ç»­å¤„ç†ä¸ºäº’åŠ¨å†…å®¹
                    if (separateResult.remainingResult && separateResult.remainingResult.trim().length > 0) {
                        console.log(`ğŸ­ æ£€æµ‹åˆ°å‰©ä½™å†…å®¹ï¼Œå°†ä½œä¸ºäº’åŠ¨å†…å®¹å¤„ç†`);
                        const interactiveResult = QQ_IsInteractiveContent(separateResult.remainingResult, true);
                        if (interactiveResult) {
                            await QQ_SequentialTaskQueue.displayInteractiveInChat(separateResult.remainingResult);
                            console.log(`âœ… å‰©ä½™å†…å®¹å·²ä½œä¸ºäº’åŠ¨å†…å®¹å¤„ç†å®Œæˆï¼ˆä½¿ç”¨æ–°çš„æµå¼æ˜¾ç¤ºï¼‰`);
                        } else {
                            // *** ä¿®å¤ï¼šå¦‚æœä¸æ˜¯äº’åŠ¨å†…å®¹ï¼Œå¯èƒ½åŒ…å«èŠå¤©å†…å®¹ï¼Œéœ€è¦å¤„ç† ***
                            console.log(`ğŸ’¬ å‰©ä½™å†…å®¹ä¸æ˜¯äº’åŠ¨å†…å®¹ï¼Œæ£€æŸ¥æ˜¯å¦åŒ…å«èŠå¤©æ ¼å¼`);
                            const chatContent = QQ_CleanContentTags(separateResult.remainingResult);
                            if (chatContent && chatContent.trim().length > 0) {
                                console.log(`ğŸ“± åœ¨å‰©ä½™å†…å®¹ä¸­å‘ç°èŠå¤©æ ¼å¼ï¼Œå¼€å§‹å¤„ç†`);
                                const strictResult = await QQ_ProcessStrictFormat(chatContent);
                                if (strictResult.success) {
                                    console.log(`âœ… å‰©ä½™èŠå¤©å†…å®¹å¤„ç†å®Œæˆ`);
                                } else {
                                    console.log(`âš ï¸ å‰©ä½™èŠå¤©å†…å®¹å¤„ç†å¤±è´¥ï¼Œå°è¯•æ¨¡ç³ŠåŒ¹é…`);
                                    await QQ_ProcessFuzzyRepair(chatContent);
                                }
                            }
                        }
                    }
                    
                    return; // åˆ†ç¦»å¼å¤„ç†æˆåŠŸï¼Œç»“æŸæµç¨‹
                }
                
                // å¦‚æœåˆ†ç¦»å¼å¤„ç†æ²¡æœ‰æ‰¾åˆ°çº¿ä¸Šæ ¼å¼ï¼Œç»§ç»­ä½¿ç”¨åŸæœ‰é€»è¾‘
                result = separateResult.remainingResult;
                
                // *** ä¼˜å…ˆçº§1ï¼ˆAæ­¥éª¤ï¼‰ï¼šä¸¥æ ¼åŒ¹é…å®Œæ•´æ ‡ç­¾ï¼ˆæˆåŠŸåç«‹å³returnï¼‰ ***
                console.log("ğŸ” ä¼˜å…ˆçº§1ï¼ˆAæ­¥éª¤ï¼‰ï¼šå¼€å§‹ä¸¥æ ¼åŒ¹é…å®Œæ•´æ ‡ç­¾");
                const strictResult = await QQ_ProcessStrictFormat(result);
                if (strictResult.success) {
                    console.log("âœ… ä¼˜å…ˆçº§1æˆåŠŸï¼šä¸¥æ ¼åŒ¹é…å¤„ç†å®Œæˆï¼Œç«‹å³return");
                    QQ_ResetRetry();
                    QQ_UpdateNewTips();
                    await QQ_Save_Chat_Backup(); 
                    return; // ä¼˜å…ˆçº§1æˆåŠŸï¼Œç«‹å³return
                }
                
                if (strictResult.shouldRetry && !isRetry && QQ_RetryCount < QQ_MAX_RETRY) {
                    return await QQ_ExecuteRetry();
                }
                
                // *** ä¼˜å…ˆçº§2ï¼ˆBæ­¥éª¤ï¼‰ï¼šæ¨¡ç³Š/ä¿®å¤åŒ¹é…ï¼ˆæˆåŠŸåç«‹å³returnï¼‰ ***
                console.log("ğŸ” ä¼˜å…ˆçº§2ï¼ˆBæ­¥éª¤ï¼‰ï¼šå¼€å§‹æ¨¡ç³Š/ä¿®å¤åŒ¹é…");
                const fuzzyResult = await QQ_ProcessFuzzyRepair(result);
                if (fuzzyResult.success) {
                    console.log("âœ… ä¼˜å…ˆçº§2æˆåŠŸï¼šæ¨¡ç³Š/ä¿®å¤åŒ¹é…å¤„ç†å®Œæˆï¼Œç«‹å³return");
                    QQ_ResetRetry();
                    QQ_UpdateNewTips();
                    await QQ_Save_Chat_Backup(); 
                    return; // ä¼˜å…ˆçº§2æˆåŠŸï¼Œç«‹å³return
                }
                
                // *** ä¼˜å…ˆçº§3ï¼ˆCæ­¥éª¤ï¼‰ï¼šäº’åŠ¨å†…å®¹å¤‡é€‰ï¼ˆæˆåŠŸåç«‹å³returnï¼‰ ***
                console.log("ğŸ” ä¼˜å…ˆçº§3ï¼ˆCæ­¥éª¤ï¼‰ï¼šå¼€å§‹äº’åŠ¨å†…å®¹æ£€æµ‹");
                const interactiveResult = await QQ_ProcessInteractiveContent(result);
                if (interactiveResult.success) {
                    console.log("âœ… ä¼˜å…ˆçº§3æˆåŠŸï¼šäº’åŠ¨å†…å®¹å¤„ç†å®Œæˆï¼Œç«‹å³return");
                    QQ_ResetRetry();
                    await QQ_Save_Chat_Backup(); 
                    return; // ä¼˜å…ˆçº§3æˆåŠŸï¼Œç«‹å³return
                }
                
                // *** ä¼˜å…ˆçº§4ï¼šæ™ºèƒ½æå–æœ‰æ•ˆä¿¡æ¯ï¼ˆæˆåŠŸåç«‹å³returnï¼‰ ***
                console.log("ğŸ” ä¼˜å…ˆçº§4ï¼šå¼€å§‹æ™ºèƒ½æå–æœ‰æ•ˆä¿¡æ¯");
                const extractResult = await QQ_ProcessValidExtraction(result);
                if (extractResult.success) {
                    console.log("âœ… ä¼˜å…ˆçº§4æˆåŠŸï¼šæ™ºèƒ½æå–å¤„ç†å®Œæˆï¼Œç«‹å³return");
                    QQ_ResetRetry();
                    QQ_UpdateNewTips();
                    await QQ_Save_Chat_Backup(); 
                    return; // ä¼˜å…ˆçº§4æˆåŠŸï¼Œç«‹å³return
                }
                
                // *** ä¼˜å…ˆçº§5ï¼šcontentæ ‡ç­¾æ£€æŸ¥ï¼ˆæˆåŠŸåç«‹å³returnï¼‰ ***
                console.log("ğŸ” ä¼˜å…ˆçº§5ï¼šå¼€å§‹contentæ ‡ç­¾æ£€æŸ¥");
                const contentResult = await QQ_ProcessContentTag(result);
                if (contentResult.success) {
                    console.log("âœ… ä¼˜å…ˆçº§5æˆåŠŸï¼šcontentæ ‡ç­¾å¤„ç†å®Œæˆï¼Œç«‹å³return");
                    QQ_ResetRetry();
                    return; // ä¼˜å…ˆçº§5æˆåŠŸï¼Œç«‹å³return
                }
                
                // *** ä¼˜å…ˆçº§6ï¼ˆDæ­¥éª¤ï¼‰ï¼šé‡ä¼ æœºåˆ¶ï¼ˆæœ€åæ‰‹æ®µï¼‰ ***
                console.log("ğŸ” ä¼˜å…ˆçº§6ï¼ˆDæ­¥éª¤ï¼‰ï¼šå¼€å§‹é‡ä¼ æœºåˆ¶ï¼ˆæœ€åæ‰‹æ®µï¼‰");
                if (!isRetry && QQ_RetryCount < QQ_MAX_RETRY) {
                    QQ_RetryCount++;
                    console.log(`æ‰€æœ‰å¤„ç†æ–¹å¼å¤±è´¥ï¼Œå¼€å§‹ç¬¬${QQ_RetryCount}æ¬¡é‡è¯•`);
                    triggerSlash(`/echo å†…å®¹æ— æ³•è¯†åˆ«ï¼Œæ­£åœ¨é‡æ–°ç”Ÿæˆ... (${QQ_RetryCount}/${QQ_MAX_RETRY})`);
                    
                    if (QQ_LastRequest) {
                        gening = true;
                        try {
                            await new Promise(resolve => setTimeout(resolve, 1000 + QQ_RetryCount * 500));
                            const retryResult = await QQ_Gen(QQ_LastRequest);
                            return await ResultHandle(retryResult, true);
                        } finally {
                            gening = false;
                        }
                    }
                } else {
                    console.log('âŒ æ‰€æœ‰ä¼˜å…ˆçº§å¤„ç†éƒ½å¤±è´¥ï¼Œå·²æ”¾å¼ƒå¤„ç†');
                    triggerSlash("/echo AIå›å¤å†…å®¹æ— æ³•è¯†åˆ«ï¼Œå·²æ”¾å¼ƒå¤„ç†");
                    QQ_ResetRetry();
                }
            }
            
            /**
             * *** ä¼˜å…ˆçº§1ï¼ˆAæ­¥éª¤ï¼‰ï¼šä¸¥æ ¼åŒ¹é…å®Œæ•´æ ‡ç­¾ ***
             */
            async function QQ_ProcessStrictFormat(result) {
                const strictFormatPatterns = [
                    /MiPhone_start([\s\S]+?)MiPhone_end/g,           // æ ‡å‡†æ ¼å¼
                    /MiPhone_JSON_START([\s\S]+?)MiPhone_JSON_END/g, // JSONæ ¼å¼
                    /MiPhone_JSON_start([\s\S]+?)MiPhone_JSON_end/g, // æ··åˆæ ¼å¼1
                    /MiPhone_Start([\s\S]+?)MiPhone_End/g,           // é¦–å­—æ¯å¤§å†™
                    /MiPhone_START([\s\S]+?)MiPhone_END/g,           // å…¨å¤§å†™
                    /MiPhone([\s\S]+?)MiPhone/g,                     // ç®€åŒ–æ ¼å¼
                ];
                
                let matches = [];
                let matchedContent = null;
                
                for (const pattern of strictFormatPatterns) {
                    const found = [...result.matchAll(pattern)];
                    if (found.length > 0) {
                        matches = found;
                        console.log(`âœ… ä¸¥æ ¼æ ¼å¼åŒ¹é…æˆåŠŸ: ${pattern.source.substring(0, 50)}...`);
                        
                        // *** æ–°å¢ï¼šå¯¹åŒ¹é…åˆ°çš„å†…å®¹è¿›è¡Œå¼‚å¸¸æ ¼å¼æ¸…ç† ***
                        let rawContent = found[0][1];
                        matchedContent = QQ_CleanUnusualFormatting(rawContent);
                        
                        if (matchedContent && matchedContent.trim().length > 0) {
                            console.log(`ğŸ§¹ ä¸¥æ ¼æ ¼å¼å†…å®¹æ¸…ç†å®Œæˆï¼ŒåŸé•¿åº¦: ${rawContent.length}, æ–°é•¿åº¦: ${matchedContent.length}`);
                            break;
                        } else {
                            console.log("âš ï¸ æ¸…ç†åå†…å®¹ä¸ºç©ºï¼Œå°è¯•ä¸‹ä¸€ä¸ªæ¨¡å¼");
                            matches = [];
                            continue;
                        }
                    }
                }
                
                if (matches.length === 0 || !matchedContent) {
                    console.log("âŒ ä¸¥æ ¼æ ¼å¼æ£€æŸ¥å¤±è´¥ï¼šæœªæ‰¾åˆ°ä»»ä½•å®Œæ•´æ ¼å¼æˆ–æ¸…ç†åå†…å®¹ä¸ºç©º");
                    return { success: false, shouldRetry: false };
                }
                
                // ä¿®å¤ï¼šå¤šä¸ªæ ¼å¼åŒ¹é…æ—¶ï¼Œä¼˜å…ˆå¤„ç†ç¬¬ä¸€ä¸ªï¼Œè€Œä¸æ˜¯ç›´æ¥é‡ä¼ 
                if (matches.length > 1) {
                    console.log("âš ï¸ æ£€æµ‹åˆ°å¤šä¸ªæ ¼å¼ï¼Œä¼˜å…ˆå¤„ç†ç¬¬ä¸€ä¸ª");
                    matches = [matches[0]]; // åªä¿ç•™ç¬¬ä¸€ä¸ªåŒ¹é…
                }
                
                // æˆåŠŸæ‰¾åˆ°å•ä¸€ä¸¥æ ¼æ ¼å¼ï¼Œç«‹å³å¤„ç†
                console.log("âœ… æ‰¾åˆ°å•ä¸€ä¸¥æ ¼æ ¼å¼ï¼Œå¼€å§‹å¤„ç†æ¸…ç†åçš„å†…å®¹");
                
                // å¤„ç†æ¶ˆæ¯å†…å®¹ï¼ˆä½¿ç”¨æ¸…ç†åçš„å†…å®¹ï¼‰
                await QQ_ProcessMsgContent(matchedContent);
                
                // å¤„ç†åŠ¨æ€å†…å®¹
                const momentMatches = matchedContent.matchAll(/moment_start([\s\S]+?)moment_end/g);
                if (momentMatches) {
                    for (const moment of momentMatches) {
                        const isInCommentContext = QQ_LastRequest && QQ_LastRequest.includes('ç”¨æˆ·åœ¨') && QQ_LastRequest.includes('çš„åŠ¨æ€ä¸‹è¯„è®º');
                        QQ_Moment_Parse(moment[1], isInCommentContext);
                    }
                }
                
                // å¤„ç†åŠ¨æ€å›å¤å†…å®¹ (moment_reply_start/end)
                const momentReplyMatches = matchedContent.matchAll(/moment_reply_start([\s\S]+?)moment_reply_end/g);
                if (momentReplyMatches) {
                    for (const reply of momentReplyMatches) {
                        await QQ_ProcessMomentReply(reply[1]);
                    }
                }
                
                return { success: true };
            }
            
            /**
             * *** æ–°å¢ï¼šå¢å¼ºçš„MiPhoneå†…å®¹æå–å™¨ï¼Œå¤„ç†å¼‚å¸¸æ ¼å¼ ***
             * ä¸“é—¨å¤„ç†åŒ…å«å¼‚å¸¸å­—ç¬¦ï¼ˆå¦‚åå¼•å·ã€æ¢è¡Œç­‰ï¼‰çš„AIå“åº”
             */
            function QQ_ExtractMiPhoneContentRobust(input) {
                console.log("ğŸ” å¼€å§‹é²æ£’æ€§MiPhoneå†…å®¹æå–");
                
                try {
                    // ç¬¬ä¸€æ­¥ï¼šæ ‡å‡†æå–ï¼Œæ”¯æŒå„ç§æ ¼å¼å˜ä½“
                    const patterns = [
                        /MiPhone_JSON_START([\s\S]*?)MiPhone_JSON_END/gi,
                        /MiPhone_JSON_start([\s\S]*?)MiPhone_JSON_end/gi,
                        /MiPhone_start([\s\S]*?)MiPhone_end/gi,
                        /MiPhone_Start([\s\S]*?)MiPhone_End/gi,
                        /MiPhone_START([\s\S]*?)MiPhone_END/gi,
                    ];
                    
                    for (const pattern of patterns) {
                        const matches = [...input.matchAll(pattern)];
                        if (matches.length > 0) {
                            let content = matches[0][1];
                            
                            // ç¬¬äºŒæ­¥ï¼šæ¸…ç†å¼‚å¸¸æ ¼å¼
                            content = QQ_CleanUnusualFormatting(content);
                            
                            if (content && content.trim().length > 0) {
                                console.log(`âœ… é²æ£’æ€§æå–æˆåŠŸï¼Œå†…å®¹é•¿åº¦: ${content.length}`);
                                return { success: true, content: content };
                            }
                        }
                    }
                    
                    // ç¬¬ä¸‰æ­¥ï¼šå¤„ç†ä¸å®Œæ•´æ ‡ç­¾çš„æƒ…å†µ
                    const incompletePatterns = [
                        /MiPhone_JSON_START([\s\S]*?)$/gi,
                        /MiPhone_start([\s\S]*?)$/gi,
                        /MiPhone_Start([\s\S]*?)$/gi,
                        /MiPhone_START([\s\S]*?)$/gi,
                    ];
                    
                    for (const pattern of incompletePatterns) {
                        const matches = [...input.matchAll(pattern)];
                        if (matches.length > 0) {
                            let content = matches[0][1];
                            
                            // æ¸…ç†å¼‚å¸¸æ ¼å¼
                            content = QQ_CleanUnusualFormatting(content);
                            
                            if (content && content.trim().length > 10) {
                                console.log(`ğŸ”§ ä¸å®Œæ•´æ ‡ç­¾é²æ£’æ€§æå–æˆåŠŸï¼Œå†…å®¹é•¿åº¦: ${content.length}`);
                                return { success: true, content: content };
                            }
                        }
                    }
                    
                    console.log("âŒ é²æ£’æ€§æå–å¤±è´¥ï¼šæœªæ‰¾åˆ°æœ‰æ•ˆçš„MiPhoneå†…å®¹");
                    return { success: false };
                    
                } catch (error) {
                    console.error("âŒ é²æ£’æ€§æå–å¼‚å¸¸:", error);
                    return { success: false, error: error.message };
                }
            }
            
            /**
             * *** æ–°å¢ï¼šæ¸…ç†å¼‚å¸¸æ ¼å¼çš„è¾…åŠ©å‡½æ•° ***
             * å¤„ç†åå¼•å·ã€å¤šä½™çš„æ¢è¡Œã€å¼‚å¸¸å­—ç¬¦ç­‰
             */
            function QQ_CleanUnusualFormatting(content) {
                if (!content || typeof content !== 'string') {
                    return content;
                }
                
                try {
                    // æ¸…ç†å¼€å¤´å’Œç»“å°¾çš„å¼‚å¸¸å­—ç¬¦
                    let cleaned = content.trim();
                    
                    // ç§»é™¤å¼€å¤´çš„åå¼•å·å’Œä»£ç å—æ ‡è®°
                    cleaned = cleaned.replace(/^```[a-z]*\s*/gi, '');
                    cleaned = cleaned.replace(/```\s*$/gi, '');
                    
                    // ç§»é™¤å¼€å¤´å’Œç»“å°¾çš„å¤šä¸ªåå¼•å·
                    cleaned = cleaned.replace(/^`+\s*/g, '');
                    cleaned = cleaned.replace(/\s*`+$/g, '');
                    
                    // è§„èŒƒåŒ–æ¢è¡Œç¬¦
                    cleaned = cleaned.replace(/\r\n/g, '\n');
                    cleaned = cleaned.replace(/\r/g, '\n');
                    
                    // ç§»é™¤å¼€å¤´çš„å¤šä½™ç©ºè¡Œ
                    cleaned = cleaned.replace(/^\n+/, '');
                    
                    // ç§»é™¤ç»“å°¾çš„å¤šä½™ç©ºè¡Œ
                    cleaned = cleaned.replace(/\n+$/, '');
                    
                    // å¤„ç†å¤¹æ‚åœ¨å†…å®¹ä¸­çš„å¼‚å¸¸å­—ç¬¦åºåˆ—
                    // ä¿ç•™èŠå¤©æ ¼å¼çš„åŸºæœ¬ç»“æ„ï¼Œåªæ¸…ç†æ˜æ˜¾çš„å¼‚å¸¸å­—ç¬¦
                    cleaned = cleaned.replace(/```json\s*/gi, '');
                    cleaned = cleaned.replace(/```yaml\s*/gi, '');
                    cleaned = cleaned.replace(/```\s*/gi, '');
                    
                    // ç§»é™¤å¤šä½™çš„è½¬ä¹‰å­—ç¬¦
                    cleaned = cleaned.replace(/\\n/g, '\n');
                    cleaned = cleaned.replace(/\\r/g, '');
                    cleaned = cleaned.replace(/\\t/g, '\t');
                    
                    // æ£€æŸ¥æ¸…ç†åçš„å†…å®¹æ˜¯å¦æœ‰æ•ˆ
                    if (cleaned.length < 5) {
                        console.log("âš ï¸ æ¸…ç†åå†…å®¹è¿‡çŸ­ï¼Œå¯èƒ½è¿‡åº¦æ¸…ç†");
                        return content.trim(); // è¿”å›åŸå§‹å†…å®¹çš„trimç‰ˆæœ¬
                    }
                    
                    console.log(`ğŸ§¹ æ ¼å¼æ¸…ç†å®Œæˆï¼ŒåŸé•¿åº¦: ${content.length}, æ–°é•¿åº¦: ${cleaned.length}`);
                    return cleaned;
                    
                } catch (error) {
                    console.error("âŒ æ ¼å¼æ¸…ç†å¼‚å¸¸:", error);
                    return content; // å‘ç”Ÿé”™è¯¯æ—¶è¿”å›åŸå†…å®¹
                }
            }
            
            /**
             * *** æ–°å¢ï¼šè°ƒè¯•å‡½æ•° - åˆ†æå¼‚å¸¸æ ¼å¼AIå“åº” ***
             * ç”¨äºè°ƒè¯•å’Œåˆ†æåŒ…å«å¼‚å¸¸æ ¼å¼çš„AIå“åº”
             */
            function QQ_DebugUnusualFormat(response, showDetails = true) {
                console.log("ğŸ” ===== å¼‚å¸¸æ ¼å¼è°ƒè¯•åˆ†æ =====");
                
                if (!response || typeof response !== 'string') {
                    console.log("âŒ æ— æ•ˆçš„å“åº”å†…å®¹");
                    return { hasIssues: false, analysis: "æ— æ•ˆè¾“å…¥" };
                }
                
                const analysis = {
                    hasIssues: false,
                    issues: [],
                    originalLength: response.length,
                    patterns: {
                        miPhoneStart: (response.match(/MiPhone_[A-Z_]*START/gi) || []).length,
                        miPhoneEnd: (response.match(/MiPhone_[A-Z_]*END/gi) || []).length,
                        codeBlocks: (response.match(/```/g) || []).length,
                        backticks: (response.match(/`/g) || []).length,
                        unusualNewlines: (response.match(/\r|\\\w/g) || []).length
                    },
                    segments: []
                };
                
                // æ£€æµ‹å¼‚å¸¸å­—ç¬¦
                if (analysis.patterns.codeBlocks > 0) {
                    analysis.hasIssues = true;
                    analysis.issues.push(`æ£€æµ‹åˆ° ${analysis.patterns.codeBlocks} ä¸ªä»£ç å—æ ‡è®°`);
                }
                
                // ä¿®å¤ï¼šæ›´å‡†ç¡®çš„åå¼•å·æ£€æµ‹é€»è¾‘
                const expectedBackticks = analysis.patterns.codeBlocks * 3; // æ¯ä¸ªä»£ç å—æ ‡è®°ç®—ä½œ3ä¸ªåå¼•å·
                const extraBackticks = analysis.patterns.backticks - expectedBackticks;
                
                if (extraBackticks > 0) {
                    analysis.hasIssues = true;
                    analysis.issues.push(`æ£€æµ‹åˆ°é¢å¤–çš„åå¼•å·: ${extraBackticks} ä¸ª`);
                } else if (analysis.patterns.backticks > 0 && analysis.patterns.codeBlocks === 0) {
                    // æœ‰åå¼•å·ä½†æ²¡æœ‰å®Œæ•´çš„ä»£ç å—
                    analysis.hasIssues = true;
                    analysis.issues.push(`æ£€æµ‹åˆ°å­¤ç«‹çš„åå¼•å·: ${analysis.patterns.backticks} ä¸ªï¼ˆæœªå½¢æˆå®Œæ•´ä»£ç å—ï¼‰`);
                }
                
                if (analysis.patterns.unusualNewlines > 0) {
                    analysis.hasIssues = true;
                    analysis.issues.push(`æ£€æµ‹åˆ°å¼‚å¸¸æ¢è¡Œç¬¦: ${analysis.patterns.unusualNewlines} ä¸ª`);
                }
                
                // æ ‡ç­¾ä¸åŒ¹é…æ£€æµ‹
                if (analysis.patterns.miPhoneStart !== analysis.patterns.miPhoneEnd) {
                    analysis.hasIssues = true;
                    analysis.issues.push(`MiPhoneæ ‡ç­¾ä¸åŒ¹é…: START(${analysis.patterns.miPhoneStart}) vs END(${analysis.patterns.miPhoneEnd})`);
                }
                
                // å°è¯•é²æ£’æ€§æå–
                const robustResult = QQ_ExtractMiPhoneContentRobust(response);
                analysis.robustExtraction = robustResult;
                
                if (showDetails) {
                    console.log(`ğŸ“Š å“åº”é•¿åº¦: ${analysis.originalLength} å­—ç¬¦`);
                    console.log(`ğŸ·ï¸ æ ‡ç­¾ç»Ÿè®¡: START=${analysis.patterns.miPhoneStart}, END=${analysis.patterns.miPhoneEnd}`);
                    console.log(`ğŸ”¤ å¼‚å¸¸å­—ç¬¦: ä»£ç å—=${analysis.patterns.codeBlocks}, åå¼•å·=${analysis.patterns.backticks}, å¼‚å¸¸æ¢è¡Œ=${analysis.patterns.unusualNewlines}`);
                    
                    if (analysis.hasIssues) {
                        console.log("âš ï¸ å‘ç°çš„é—®é¢˜:");
                        analysis.issues.forEach((issue, i) => console.log(`   ${i + 1}. ${issue}`));
                    } else {
                        console.log("âœ… æœªå‘ç°æ˜æ˜¾çš„æ ¼å¼é—®é¢˜");
                    }
                    
                    if (robustResult.success) {
                        console.log(`âœ… é²æ£’æ€§æå–æˆåŠŸï¼Œæå–å†…å®¹é•¿åº¦: ${robustResult.content.length}`);
                        console.log(`ğŸ“ æå–å†…å®¹é¢„è§ˆ: ${robustResult.content.substring(0, 200)}...`);
                    } else {
                        console.log("âŒ é²æ£’æ€§æå–å¤±è´¥");
                    }
                }
                
                console.log("ğŸ” ===== è°ƒè¯•åˆ†æå®Œæˆ =====");
                return analysis;
            }
            
            /**
             * *** æ–°å¢ï¼šç”¨æˆ·å¯è°ƒç”¨çš„æ ¼å¼ä¿®å¤å·¥å…· ***
             */
            window.QQ_FixUnusualFormat = function(response) {
                console.log("ğŸ› ï¸ æ‰‹åŠ¨æ ¼å¼ä¿®å¤å·¥å…·å¯åŠ¨");
                
                if (!response) {
                    console.log("è¯·æä¾›è¦ä¿®å¤çš„AIå“åº”å†…å®¹");
                    return null;
                }
                
                // è°ƒè¯•åˆ†æ
                const analysis = QQ_DebugUnusualFormat(response, true);
                
                // å°è¯•ä¿®å¤
                const robustResult = QQ_ExtractMiPhoneContentRobust(response);
                if (robustResult.success) {
                    const cleaned = QQ_CleanUnusualFormatting(robustResult.content);
                    console.log("âœ… ä¿®å¤å®Œæˆï¼");
                    console.log("ä¿®å¤åå†…å®¹:", cleaned);
                    return {
                        success: true,
                        original: response,
                        fixed: cleaned,
                        analysis: analysis
                    };
                } else {
                    console.log("âŒ æ— æ³•ä¿®å¤æ­¤æ ¼å¼");
                    return {
                        success: false,
                        original: response,
                        analysis: analysis
                    };
                }
            };
            
            /**
             * *** æ–°å¢ï¼šç”¨æˆ·å¯è°ƒç”¨çš„ç›´æ¥æ ‡ç­¾æå–å·¥å…· ***
             */
            window.QQ_ExtractTagsDirectly = function(response) {
                console.log("ğŸ¯ æ‰‹åŠ¨ç›´æ¥æ ‡ç­¾æå–å·¥å…·å¯åŠ¨");
                
                if (!response) {
                    console.log("è¯·æä¾›è¦æå–çš„AIå“åº”å†…å®¹");
                    return null;
                }
                
                const result = QQ_ExtractValidTagsDirectly(response);
                if (result.success) {
                    console.log("âœ… ç›´æ¥æå–æˆåŠŸï¼");
                    console.log("æå–ç»“æœ:", result.data);
                    return result;
                } else {
                    console.log("âŒ ç›´æ¥æå–å¤±è´¥");
                    return result;
                }
            };
            
            /**
             * *** ä¼˜å…ˆçº§2ï¼ˆBæ­¥éª¤ï¼‰ï¼šæ¨¡ç³Š/ä¿®å¤åŒ¹é… ***
             */
            async function QQ_ProcessFuzzyRepair(result) {
                console.log("ğŸ”§ å¼€å§‹æ¨¡ç³ŠåŒ¹é…å’Œä¿®å¤å¤„ç†");
                
                // æ¨¡ç³Šæ ¼å¼åŒ¹é…ï¼šæ”¯æŒä¸å®Œæ•´çš„æ ¼å¼
                const fuzzyFormatPatterns = [
                    /MiPhone_JSON_START([\s\S]+?)$/g,                // ä¸å®Œæ•´JSONæ ¼å¼
                    /MiPhone_start([\s\S]+?)$/g,                     // ä¸å®Œæ•´æ ‡å‡†æ ¼å¼
                    /MiPhone_Start([\s\S]+?)$/g,                     // ä¸å®Œæ•´é¦–å­—æ¯å¤§å†™æ ¼å¼
                    /MiPhone_START([\s\S]+?)$/g,                     // ä¸å®Œæ•´å…¨å¤§å†™æ ¼å¼
                    /MiPhone_JSON_start([\s\S]+?)$/g,                // ä¸å®Œæ•´æ··åˆæ ¼å¼
                ];
                
                let repairedContent = null;
                
                // *** æ–°å¢ï¼šå¢å¼ºçš„MiPhoneæ ‡ç­¾æå–ï¼Œå¤„ç†å¼‚å¸¸æ ¼å¼ ***
                const enhancedMatch = QQ_ExtractMiPhoneContentRobust(result);
                if (enhancedMatch.success) {
                    console.log("ğŸ”§ å¢å¼ºæå–æˆåŠŸï¼Œä½¿ç”¨é²æ£’æ€§è§£æç»“æœ");
                    repairedContent = enhancedMatch.content;
                } else {
                    // å°è¯•ä¸å®Œæ•´æ ¼å¼åŒ¹é…å’Œè‡ªåŠ¨ä¿®å¤
                    for (const pattern of fuzzyFormatPatterns) {
                        const found = [...result.matchAll(pattern)];
                        if (found.length > 0) {
                            console.log(`ğŸ”§ æ£€æµ‹åˆ°ä¸å®Œæ•´æ ¼å¼ï¼Œå°è¯•ä¿®å¤: ${pattern.source.substring(0, 50)}...`);
                            
                            // *** ä¿®å¤ï¼šä½¿ç”¨å®Œæ•´åŒ¹é…å†…å®¹è€Œä¸æ˜¯åˆ†ç»„[1] ***
                            let content = found[0][0];  // ä½¿ç”¨å®Œæ•´åŒ¹é…å†…å®¹[0]è€Œä¸æ˜¯åˆ†ç»„[1]
                            
                            // è‡ªåŠ¨è¡¥å…¨ç»“æŸæ ‡ç­¾
                            if (pattern.source.includes('MiPhone_JSON_START')) {
                                content += '\nMiPhone_JSON_END';
                                console.log("ğŸ”§ è‡ªåŠ¨è¡¥å…¨MiPhone_JSON_ENDæ ‡ç­¾");
                            } else if (pattern.source.includes('MiPhone_start')) {
                                content += '\nMiPhone_end';
                                console.log("ğŸ”§ è‡ªåŠ¨è¡¥å…¨MiPhone_endæ ‡ç­¾");
                            } else if (pattern.source.includes('MiPhone_Start')) {
                                content += '\nMiPhone_End';
                                console.log("ğŸ”§ è‡ªåŠ¨è¡¥å…¨MiPhone_Endæ ‡ç­¾");
                            } else if (pattern.source.includes('MiPhone_START')) {
                                content += '\nMiPhone_END';
                                console.log("ğŸ”§ è‡ªåŠ¨è¡¥å…¨MiPhone_ENDæ ‡ç­¾");
                            }
                            
                            // *** ä¿®å¤ï¼šç°åœ¨éœ€è¦é‡æ–°æå–å†…å®¹éƒ¨åˆ† ***
                            const repairMatch = content.match(/MiPhone_(?:JSON_)?(?:START|start|Start)([\s\S]+?)MiPhone_(?:JSON_)?(?:END|end|End)/);
                            if (repairMatch) {
                                repairedContent = repairMatch[1];  // æå–æ ‡ç­¾ä¹‹é—´çš„å†…å®¹
                                console.log("ğŸ”§ ä¿®å¤å®Œæˆï¼Œæå–åˆ°å†…å®¹:", repairedContent.substring(0, 100) + "...");
                            } else {
                                console.error("âŒ ä¿®å¤åæ— æ³•æå–å†…å®¹");
                                continue;
                            }
                            break;
                        }
                    }
                }
                
                // å°è¯•æ›´æ·±åº¦çš„æ¨¡ç³ŠåŒ¹é…ï¼šå¯»æ‰¾èŠå¤©æ ¼å¼çº¿ç´¢
                if (!repairedContent) {
                    console.log("ğŸ”§ å°è¯•æ·±åº¦æ¨¡ç³ŠåŒ¹é…ï¼šå¯»æ‰¾èŠå¤©æ ¼å¼çº¿ç´¢");
                    
                    // æ£€æŸ¥æ˜¯å¦åŒ…å«èŠå¤©æ ¼å¼çº¿ç´¢
                    const chatFormatClues = [
                        /<ç¾¤èŠ:/,
                        /<[^>]+å’Œ[^>]+çš„(?:èŠå¤©|ç§èŠ)>/,
                        /<(?:ç§èŠ|èŠå¤©):/,                    // æ–°å¢ï¼šæ”¯æŒ<ç§èŠ:è§’è‰²å>æ ¼å¼
                        /<[^>]*(?:ç§èŠ|èŠå¤©)[^>]*>/,         // æ–°å¢ï¼šæ”¯æŒå„ç§èŠå¤©æ ¼å¼
                        /<\/ç¾¤èŠ:/,
                        /<\/[^>]+å’Œ[^>]+çš„(?:èŠå¤©|ç§èŠ)>/,
                        /<\/(?:ç§èŠ|èŠå¤©):/,                 // æ–°å¢ï¼šå¯¹åº”çš„ç»“æŸæ ‡ç­¾
                        /moment_start/,                      // åŠ¨æ€æ ¼å¼çº¿ç´¢
                        /moment_reply_start/,                // åŠ¨æ€å›å¤æ ¼å¼çº¿ç´¢
                        /moment_id::/,                       // åŠ¨æ€IDçº¿ç´¢
                        /æ—¶é—´:\s*\d{4}-\d{2}-\d{2}/,
                        /--\d{4}-\d{2}-\d{2}/
                    ];
                    
                    let hasChatClues = false;
                    for (const clue of chatFormatClues) {
                        if (clue.test(result)) {
                            hasChatClues = true;
                            console.log(`ğŸ”§ å‘ç°èŠå¤©æ ¼å¼çº¿ç´¢: ${clue.source}`);
                            break;
                        }
                    }
                    
                    if (hasChatClues) {
                        console.log("ğŸ”§ åŒ…å«èŠå¤©æ ¼å¼çº¿ç´¢ï¼Œå°è¯•æ™ºèƒ½åŒ…è£…");
                        // æ™ºèƒ½åŒ…è£…ï¼šå¦‚æœåŒ…å«èŠå¤©çº¿ç´¢ä½†ç¼ºå°‘å¤–å±‚æ ‡ç­¾ï¼Œè‡ªåŠ¨æ·»åŠ 
                        repairedContent = `MiPhone_start\n${result}\nMiPhone_end`;
                    }
                }
                
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯ä¿®å¤çš„å†…å®¹
                if (!repairedContent) {
                    console.log("âŒ æ¨¡ç³Š/ä¿®å¤åŒ¹é…å¤±è´¥ï¼šæ— æ³•æ‰¾åˆ°å¯ä¿®å¤çš„æ ¼å¼");
                    return { success: false };
                }
                
                console.log("âœ… æ¨¡ç³Š/ä¿®å¤åŒ¹é…æˆåŠŸï¼Œå¼€å§‹å¤„ç†ä¿®å¤åçš„å†…å®¹");
                
                // å¤„ç†ä¿®å¤åçš„å†…å®¹
                await QQ_ProcessMsgContent(repairedContent);
                
                // å¤„ç†åŠ¨æ€å†…å®¹
                const momentMatches = repairedContent.matchAll(/moment_start([\s\S]+?)moment_end/g);
                if (momentMatches) {
                    for (const moment of momentMatches) {
                        const isInCommentContext = QQ_LastRequest && QQ_LastRequest.includes('ç”¨æˆ·åœ¨') && QQ_LastRequest.includes('çš„åŠ¨æ€ä¸‹è¯„è®º');
                        QQ_Moment_Parse(moment[1], isInCommentContext);
                    }
                }
                
                // å¤„ç†åŠ¨æ€å›å¤å†…å®¹
                const momentReplyMatches = repairedContent.matchAll(/moment_reply_start([\s\S]+?)moment_reply_end/g);
                if (momentReplyMatches) {
                    for (const reply of momentReplyMatches) {
                        await QQ_ProcessMomentReply(reply[1]);
                    }
                }
                
                return { success: true };
            }
            
            /**
             * *** ä¼˜å…ˆçº§3ï¼ˆCæ­¥éª¤ï¼‰ï¼šå¤„ç†äº’åŠ¨å†…å®¹å¤‡é€‰ ***
             */
            async function QQ_ProcessInteractiveContent(result) {
                console.log("ğŸ¯ å¼€å§‹äº’åŠ¨å†…å®¹æ£€æµ‹");
                
                            if (QQ_IsInteractiveContent(result, true)) {
                    console.log("âœ… æ£€æµ‹åˆ°äº’åŠ¨å†…å®¹ï¼Œä½¿ç”¨æ–°çš„æµå¼æ˜¾ç¤º");
                                await QQ_SequentialTaskQueue.displayInteractiveInChat(result);
                    return { success: true };
                }
                
                console.log("âŒ ä¸æ˜¯äº’åŠ¨å†…å®¹");
                return { success: false };
            }
            
            /**
             * *** æ–°å¢ï¼šç›´æ¥æœ‰æ•ˆæ ‡ç­¾æå–å™¨ï¼ˆå¿½ç•¥æ‰€æœ‰æ ¼å¼è¦æ±‚ï¼‰ ***
             * åœ¨æ‰€æœ‰æ¨¡ç³ŠåŒ¹é…å¤±è´¥åï¼Œç›´æ¥ä»æ··ä¹±æ ¼å¼ä¸­æå–ä»»ä½•æœ‰æ•ˆçš„æ ‡ç­¾å†…å®¹
             */
            async function QQ_ExtractValidTagsDirectly(input) {
                console.log("ğŸ¯ å¼€å§‹ç›´æ¥æœ‰æ•ˆæ ‡ç­¾æå–ï¼ˆå¿½ç•¥æ ¼å¼ï¼‰");
                
                try {
                    let hasValidContent = false;
                    const results = {
                        ç¾¤èŠ: {},
                        ç§èŠ: {}
                    };
                    
                    // *** 1. ç›´æ¥æå–ç¾¤èŠæ ‡ç­¾ï¼ˆå„ç§å¯èƒ½çš„æ ¼å¼ï¼‰ ***
                    const groupTagPatterns = [
                        // æ ‡å‡†ç¾¤èŠæ ¼å¼
                        /<ç¾¤èŠ[:ï¼š]([^>]+)>([\s\S]*?)<\/ç¾¤èŠ[:ï¼š][^>]*>/gi,
                        // ä¸å®Œæ•´çš„ç¾¤èŠæ ‡ç­¾
                        /<ç¾¤èŠ[:ï¼š]([^>]+)>([\s\S]*?)(?=<[^>]*>|$)/gi,
                        // ç®€åŒ–çš„ç¾¤èŠæ ‡ç­¾
                        /<ç¾¤èŠ([^>]*)>([\s\S]*?)<\/ç¾¤èŠ[^>]*>/gi,
                        /<ç¾¤èŠ([^>]*)>([\s\S]*?)(?=<[^>]*>|$)/gi
                    ];
                    
                    for (const pattern of groupTagPatterns) {
                        const matches = [...input.matchAll(pattern)];
                        for (const match of matches) {
                            let groupName = (match[1] || '').replace(/[:ï¼š]/g, '').trim();
                            let content = (match[2] || '').trim();
                            
                            if (!groupName && content) {
                                groupName = 'æœªçŸ¥ç¾¤èŠ';
                            }
                            
                            if (content && content.length > 5) {
                                console.log(`ğŸ¯ æ‰¾åˆ°ç¾¤èŠæ ‡ç­¾: ${groupName}, å†…å®¹é•¿åº¦: ${content.length}`);
                                
                                // è§£æç¾¤èŠå†…å®¹
                                const messages = QQ_ParseMessagesFromRawContent(content);
                                if (messages.length > 0) {
                                    if (!results.ç¾¤èŠ[groupName]) {
                                        results.ç¾¤èŠ[groupName] = {
                                            members: [],
                                            msgs: []
                                        };
                                    }
                                    results.ç¾¤èŠ[groupName].msgs.push(...messages);
                                    
                                    // æå–æˆå‘˜åˆ—è¡¨
                                    const members = [...new Set(messages.map(msg => msg.split('--')[0]).filter(name => name && name.trim()))];
                                    results.ç¾¤èŠ[groupName].members = [...new Set([...results.ç¾¤èŠ[groupName].members, ...members])];
                                    
                                    hasValidContent = true;
                                    console.log(`âœ… ç¾¤èŠ ${groupName} æå–åˆ° ${messages.length} æ¡æ¶ˆæ¯ï¼Œ${members.length} ä¸ªæˆå‘˜`);
                                }
                            }
                        }
                    }
                    
                    // *** 2. ç›´æ¥æå–ç§èŠæ ‡ç­¾ï¼ˆå„ç§å¯èƒ½çš„æ ¼å¼ï¼‰ ***
                    const privateChatPatterns = [
                        // æ ‡å‡†ç§èŠæ ¼å¼
                        /<([^>]*å’Œ[^>]*çš„(?:ç§èŠ|èŠå¤©))>([\s\S]*?)<\/[^>]*å’Œ[^>]*çš„(?:ç§èŠ|èŠå¤©)>/gi,
                        // ä¸å®Œæ•´çš„ç§èŠæ ‡ç­¾
                        /<([^>]*å’Œ[^>]*çš„(?:ç§èŠ|èŠå¤©))>([\s\S]*?)(?=<[^>]*>|$)/gi,
                        // æ–°å¢ï¼šæ”¯æŒ<ç§èŠ:è§’è‰²å>æ ¼å¼
                        /<(ç§èŠ:[^>]+)>([\s\S]*?)<\/ç§èŠ:[^>]*>/gi,
                        /<(ç§èŠ:[^>]+)>([\s\S]*?)(?=<[^>]*>|$)/gi,
                        // ç®€åŒ–çš„ç§èŠæ ‡ç­¾
                        /<([^>]*(?:ç§èŠ|èŠå¤©)[^>]*)>([\s\S]*?)<\/[^>]*(?:ç§èŠ|èŠå¤©)[^>]*>/gi,
                        /<([^>]*(?:ç§èŠ|èŠå¤©)[^>]*)>([\s\S]*?)(?=<[^>]*>|$)/gi,
                        // å‘åå…¼å®¹ï¼šçº¯èŠå¤©æ ¼å¼
                        /<([^>]*èŠå¤©[^>]*)>([\s\S]*?)<\/[^>]*èŠå¤©[^>]*>/gi,
                        /<([^>]*èŠå¤©[^>]*)>([\s\S]*?)(?=<[^>]*>|$)/gi
                    ];
                    
                    for (const pattern of privateChatPatterns) {
                        const matches = [...input.matchAll(pattern)];
                        for (const match of matches) {
                            let chatName = (match[1] || '').trim();
                            let content = (match[2] || '').trim();
                            
                            if (!chatName && content) {
                                chatName = 'æœªçŸ¥ç§èŠ';
                            }
                            
                            if (content && content.length > 5) {
                                console.log(`ğŸ¯ æ‰¾åˆ°ç§èŠæ ‡ç­¾: ${chatName}, å†…å®¹é•¿åº¦: ${content.length}`);
                                
                                // è§£æç§èŠå†…å®¹
                                const messages = QQ_ParseMessagesFromRawContent(content);
                                if (messages.length > 0) {
                                    if (!results.ç§èŠ[chatName]) {
                                        results.ç§èŠ[chatName] = [];
                                    }
                                    results.ç§èŠ[chatName].push(...messages);
                                    
                                    hasValidContent = true;
                                    console.log(`âœ… ç§èŠ ${chatName} æå–åˆ° ${messages.length} æ¡æ¶ˆæ¯`);
                                }
                            }
                        }
                    }
                    
                    // *** 3. ç›´æ¥æå–åŠ¨æ€å’ŒåŠ¨æ€å›å¤æ ‡ç­¾ ***
                    // å¤„ç†åŠ¨æ€å›å¤
                    const momentReplyMatches = [...input.matchAll(/moment_reply_start([\s\S]+?)moment_reply_end/g)];
                    for (const replyMatch of momentReplyMatches) {
                        console.log(`ğŸ¯ æ‰¾åˆ°åŠ¨æ€å›å¤æ ¼å¼ï¼Œå†…å®¹é•¿åº¦: ${replyMatch[1].length}`);
                        await QQ_ProcessMomentReply(replyMatch[1]);
                        hasValidContent = true;
                    }
                    
                    // å¤„ç†æ™®é€šåŠ¨æ€
                    const momentMatches = [...input.matchAll(/moment_start([\s\S]+?)moment_end/g)];
                    for (const momentMatch of momentMatches) {
                        console.log(`ğŸ¯ æ‰¾åˆ°åŠ¨æ€æ ¼å¼ï¼Œå†…å®¹é•¿åº¦: ${momentMatch[1].length}`);
                        const isInCommentContext = QQ_LastRequest && QQ_LastRequest.includes('ç”¨æˆ·åœ¨') && QQ_LastRequest.includes('çš„åŠ¨æ€ä¸‹è¯„è®º');
                        QQ_Moment_Parse(momentMatch[1], isInCommentContext);
                        hasValidContent = true;
                    }
                    
                    // *** 4. ç›´æ¥å¤„ç†æå–åˆ°çš„å†…å®¹ ***
                    if (hasValidContent) {
                        console.log("ğŸ¯ ç›´æ¥æ ‡ç­¾æå–æˆåŠŸï¼Œå¼€å§‹å¤„ç†å†…å®¹");
                        console.log(`ğŸ“Š æå–ç»Ÿè®¡: ç¾¤èŠ ${Object.keys(results.ç¾¤èŠ).length} ä¸ªï¼Œç§èŠ ${Object.keys(results.ç§èŠ).length} ä¸ª`);
                        
                        // ç›´æ¥è°ƒç”¨æ¶ˆæ¯è§£æå¤„ç†
                        QQ_Msg_Parse(JSON.stringify(results));
                        
                        return { success: true, data: results };
                    } else {
                        console.log("âŒ ç›´æ¥æ ‡ç­¾æå–å¤±è´¥ï¼šæœªæ‰¾åˆ°æœ‰æ•ˆçš„æ ‡ç­¾å†…å®¹");
                        return { success: false };
                    }
                    
                } catch (error) {
                    console.error("âŒ ç›´æ¥æ ‡ç­¾æå–å¼‚å¸¸:", error);
                    return { success: false, error: error.message };
                }
            }
            
            /**
             * *** æ–°å¢ï¼šä»åŸå§‹å†…å®¹ä¸­è§£ææ¶ˆæ¯çš„è¾…åŠ©å‡½æ•° ***
             * ç”¨äºå¤„ç†ç›´æ¥æå–çš„æ ‡ç­¾å†…å®¹
             */
            function QQ_ParseMessagesFromRawContent(content) {
                if (!content || typeof content !== 'string') {
                    return [];
                }
                
                try {
                    const messages = [];
                    
                    // æ¸…ç†å†…å®¹
                    let cleaned = content.trim();
                    
                    // ç§»é™¤å¯èƒ½çš„å¼‚å¸¸å­—ç¬¦
                    cleaned = cleaned.replace(/```[a-z]*\s*/gi, '');
                    cleaned = cleaned.replace(/```\s*/gi, '');
                    cleaned = cleaned.replace(/`+/g, '');
                    
                    // å°è¯•å¤šç§æ¶ˆæ¯æ ¼å¼åŒ¹é…
                    const messagePatterns = [
                        // æ ‡å‡†æ ¼å¼ï¼šç”¨æˆ·å--æ¶ˆæ¯å†…å®¹--æ—¶é—´
                        /([^-\n]+?)--([^-\n]+?)--([^\n]+)/g,
                        // ç®€åŒ–æ ¼å¼ï¼šç”¨æˆ·å--æ¶ˆæ¯å†…å®¹
                        /([^-\n]+?)--([^\n]+)/g,
                        // å†’å·æ ¼å¼ï¼šç”¨æˆ·å: æ¶ˆæ¯å†…å®¹
                        /([^:\n]+?):\s*([^\n]+)/g,
                        // è¯´è¯æ ¼å¼ï¼šç”¨æˆ·åè¯´ï¼šæ¶ˆæ¯å†…å®¹
                        /([^ï¼š:\n]+?)(?:è¯´|è®²)[:ï¼š]\s*([^\n]+)/g,
                        // æ¢è¡Œåˆ†éš”æ ¼å¼
                        /^([^\n]+)$/gm
                    ];
                    
                    for (const pattern of messagePatterns) {
                        const matches = [...cleaned.matchAll(pattern)];
                        if (matches.length > 0) {
                            console.log(`ğŸ” ä½¿ç”¨æ¨¡å¼åŒ¹é…åˆ° ${matches.length} æ¡æ¶ˆæ¯`);
                            
                            for (const match of matches) {
                                let messageText = '';
                                
                                if (match.length >= 3) {
                                    // å¸¦æ—¶é—´çš„æ ¼å¼
                                    const name = match[1].trim();
                                    const content = match[2].trim();
                                    const time = match[3].trim();
                                    
                                    if (name && content) {
                                        messageText = `${name}--${content}--${time}`;
                                    }
                                } else if (match.length >= 2) {
                                    // ä¸å¸¦æ—¶é—´çš„æ ¼å¼
                                    const name = match[1].trim();
                                    const content = match[2].trim();
                                    
                                    if (name && content) {
                                        const currentTime = new Date().toLocaleTimeString('zh-CN', {
                                            hour12: false,
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        });
                                        messageText = `${name}--${content}--${currentTime}`;
                                    }
                                } else {
                                    // çº¯æ–‡æœ¬æ ¼å¼
                                    const text = match[1].trim();
                                    if (text && text.length > 3) {
                                        const currentTime = new Date().toLocaleTimeString('zh-CN', {
                                            hour12: false,
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        });
                                        messageText = `ç³»ç»Ÿ--${text}--${currentTime}`;
                                    }
                                }
                                
                                if (messageText && !messages.includes(messageText)) {
                                    messages.push(messageText);
                                }
                            }
                            
                            if (messages.length > 0) {
                                break; // æ‰¾åˆ°æœ‰æ•ˆæ¶ˆæ¯å°±åœæ­¢å°è¯•å…¶ä»–æ¨¡å¼
                            }
                        }
                    }
                    
                    console.log(`ğŸ¯ ä»åŸå§‹å†…å®¹è§£æå‡º ${messages.length} æ¡æ¶ˆæ¯`);
                    return messages;
                    
                } catch (error) {
                    console.error("âŒ åŸå§‹å†…å®¹æ¶ˆæ¯è§£æå¼‚å¸¸:", error);
                    return [];
                }
            }
            
            /**
             * *** ä¼˜å…ˆçº§4ï¼šæ™ºèƒ½æå–æœ‰æ•ˆä¿¡æ¯ ***
             */
            async function QQ_ProcessValidExtraction(result) {
                console.log("ğŸ¯ å¼€å§‹æ™ºèƒ½æå–æœ‰æ•ˆä¿¡æ¯");
                
                // *** æ–°å¢ï¼šé¦–å…ˆå°è¯•ç›´æ¥çš„æœ‰æ•ˆæ ‡ç­¾æå–ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰ ***
                const directTagResult = await QQ_ExtractValidTagsDirectly(result);
                if (directTagResult.success) {
                    console.log("âœ… ç›´æ¥æ ‡ç­¾æå–æˆåŠŸï¼Œè·³è¿‡å…¶ä»–æå–æ–¹å¼");
                    return { success: true };
                }
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºæ··åˆæ ¼å¼å“åº”ï¼ˆç¾¤èŠ+ç§èŠ+äº’åŠ¨å†…å®¹æ··åˆï¼‰
                if (QQ_DetectMixedFormatResponse(result)) {
                    console.log("ğŸ”„ æ£€æµ‹åˆ°æ··åˆæ ¼å¼å“åº”ï¼Œå¯åŠ¨æ··åˆæ ¼å¼å¤„ç†å™¨");
                    const mixedResult = await QQ_ProcessMixedFormatResponse(result);
                    if (mixedResult.success) {
                        console.log("âœ… æ··åˆæ ¼å¼å¤„ç†æˆåŠŸ");
                        return { success: true };
                    } else {
                        console.log("âš ï¸ æ··åˆæ ¼å¼å¤„ç†å¤±è´¥ï¼Œç»§ç»­å¸¸è§„æå–æµç¨‹");
                    }
                }
                
                // å¸¸è§„æ™ºèƒ½æå–æµç¨‹
                const extractedInfo = QQ_ExtractValidInfo(result);
                if (extractedInfo.hasValidInfo) {
                    console.log("âœ… æ™ºèƒ½æå–æˆåŠŸï¼Œè½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼");
                    // *** å¢å¼ºç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤º ***
                    const privateChatCount = extractedInfo.privateChats ? Object.keys(extractedInfo.privateChats).length : 0;
                    const legacyPrivateCount = extractedInfo.privateMessages ? extractedInfo.privateMessages.length : 0;
                    const groupChatCount = extractedInfo.groupChats ? Object.keys(extractedInfo.groupChats).length : 0;
                    const legacyGroupCount = extractedInfo.messages ? extractedInfo.messages.length : 0;
                    
                    // æ„å»ºè¯¦ç»†çš„ç»Ÿè®¡ä¿¡æ¯
                    let statsMsg = 'ğŸ“Š æå–ç»Ÿè®¡: ';
                    
                    // ç¾¤èŠç»Ÿè®¡
                    if (groupChatCount > 0) {
                        statsMsg += `ç¾¤èŠ${groupChatCount}ä¸ª(æ€»${legacyGroupCount}æ¡), `;
                    } else if (legacyGroupCount > 0) {
                        statsMsg += `ç¾¤èŠ${legacyGroupCount}æ¡, `;
                    }
                    
                    // ç§èŠç»Ÿè®¡
                    if (privateChatCount > 0) {
                        statsMsg += `ç§èŠ${privateChatCount}ä¸ª(æ€»${legacyPrivateCount}æ¡), `;
                    } else if (legacyPrivateCount > 0) {
                        statsMsg += `ç§èŠ${legacyPrivateCount}æ¡, `;
                    }
                    
                    // åŠ¨æ€ç»Ÿè®¡
                    statsMsg += `åŠ¨æ€${extractedInfo.dynamics.length}æ¡`;
                    
                    console.log(statsMsg);
                    
                    // æ˜¾ç¤ºè¯¦ç»†åˆ—è¡¨
                    if (groupChatCount > 0) {
                        console.log(`ğŸ” ç¾¤èŠè¯¦æƒ…: ${Object.keys(extractedInfo.groupChats).join(', ')}`);
                    }
                    if (privateChatCount > 0) {
                        console.log(`ğŸ” ç§èŠè¯¦æƒ…: ${Object.keys(extractedInfo.privateChats).join(', ')}`);
                    }
                    
                    const convertedResult = QQ_ConvertExtractedToStandard(extractedInfo);
                    if (convertedResult) {
                        await QQ_Msg_Parse(JSON.stringify(convertedResult));
                        return { success: true };
                    } else {
                        console.warn('âš ï¸ è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼å¤±è´¥ï¼Œä½†å·²æå–åˆ°æœ‰æ•ˆä¿¡æ¯');
                        return { success: true };
                    }
                }
                
                console.log("âŒ æ™ºèƒ½æå–å¤±è´¥");
                return { success: false };
            }
            
            /**
             * *** æœ€ä¼˜å…ˆçº§ï¼šå®Œæ•´contentæ ‡ç­¾å¤„ç† ***
             * åªè¦æ£€æµ‹åˆ°å®Œæ•´çš„contentæ ‡ç­¾ï¼Œå°±ç§»é™¤æ ‡ç­¾å¤–çš„æ‰€æœ‰å†…å®¹ï¼Œæå–contentå†…å®¹åç»§ç»­æ­£å¸¸çš„è§£ææµç¨‹
             */
            async function QQ_ProcessCompleteContentTag(result) {
                console.log("ğŸ¯ å¼€å§‹æœ€ä¼˜å…ˆçº§å®Œæ•´contentæ ‡ç­¾æ£€æŸ¥");
                
                // æ£€æŸ¥æ˜¯å¦æœ‰å®Œæ•´çš„contentæ ‡ç­¾
                const contentMatches = [...result.matchAll(/<content>([\s\S]*?)<\/content>/gi)];
                
                if (contentMatches.length === 0) {
                    console.log("âŒ æœªæ‰¾åˆ°å®Œæ•´çš„contentæ ‡ç­¾");
                    return { success: false, extractedContent: null };
                }
                
                console.log(`âœ… æ‰¾åˆ° ${contentMatches.length} ä¸ªå®Œæ•´çš„contentæ ‡ç­¾`);
                
                // å¦‚æœæœ‰å¤šä¸ªcontentæ ‡ç­¾ï¼Œéœ€è¦æ¯”å¯¹æ‰¾å‡ºæœ‰æ•ˆçš„
                let validContent = null;
                let validContentText = '';
                
                if (contentMatches.length === 1) {
                    // å•ä¸ªcontentæ ‡ç­¾ï¼Œç›´æ¥ä½¿ç”¨
                    validContent = contentMatches[0];
                    validContentText = contentMatches[0][1].trim();
                    console.log("ğŸ“ å•ä¸ªcontentæ ‡ç­¾ï¼Œç›´æ¥ä½¿ç”¨");
                } else {
                    // å¤šä¸ªcontentæ ‡ç­¾ï¼Œéœ€è¦æ¯”å¯¹æœ‰æ•ˆæ€§
                    console.log(`ğŸ” æ£€æµ‹åˆ° ${contentMatches.length} ä¸ªcontentæ ‡ç­¾ï¼Œå¼€å§‹æ¯”å¯¹æœ‰æ•ˆæ€§`);
                    
                    for (const match of contentMatches) {
                        const contentText = match[1].trim();
                        
                        // æœ‰æ•ˆæ€§è¯„åˆ†ï¼šå†…å®¹é•¿åº¦ + æ˜¯å¦åŒ…å«å®é™…å†…å®¹
                        let score = contentText.length;
                        
                        // æ£€æŸ¥æ˜¯å¦åŒ…å«çº¿ä¸Šæ ¼å¼æ ‡ç­¾ï¼ˆå®é™…ä¸Šè¿™æ˜¯å¥½çš„ï¼Œåº”è¯¥åŠ åˆ†ï¼‰
                        if (contentText.includes('MiPhone_') || contentText.includes('msg_start') || 
                            contentText.includes('moment_start') || contentText.includes('discord_start')) {
                            score += 200; // åŒ…å«çº¿ä¸Šæ ¼å¼æ ‡ç­¾åº”è¯¥åŠ åˆ†
                            console.log(`âœ… contentåŒ…å«çº¿ä¸Šæ ¼å¼æ ‡ç­¾ï¼ŒåŠ åˆ†: ${score}`);
                        }
                        
                        // æ£€æŸ¥æ˜¯å¦åŒ…å«å®é™…æ–‡æœ¬å†…å®¹
                        const textContent = contentText.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim();
                        if (textContent.length > 10) {
                            score += 100; // æœ‰å®é™…æ–‡æœ¬å†…å®¹åŠ åˆ†
                        }
                        
                        console.log(`ğŸ“Š contentè¯„åˆ†: ${score}, é•¿åº¦: ${contentText.length}, æ–‡æœ¬: "${textContent.substring(0, 50)}..."`);
                        
                        if (score > 20 && (!validContent || score > validContent.score)) {
                            validContent = { ...match, score };
                            validContentText = contentText;
                        }
                    }
                }
                
                // éªŒè¯æ‰¾åˆ°çš„æœ‰æ•ˆcontent
                if (!validContent || !validContentText || validContentText.length === 0) {
                    console.log("âŒ æœªæ‰¾åˆ°æœ‰æ•ˆçš„contentå†…å®¹");
                    return { success: false, extractedContent: null };
                }
                
                console.log(`âœ… é€‰æ‹©æœ‰æ•ˆcontentï¼Œé•¿åº¦: ${validContentText.length}`);
                console.log(`ğŸ“ æœ‰æ•ˆcontenté¢„è§ˆ: "${validContentText.substring(0, 100)}..."`);
                
                // æ¸…ç†contentå†…å®¹ï¼ˆç§»é™¤å¯èƒ½çš„åµŒå¥—æ ‡ç­¾ï¼Œä½†ä¿ç•™çº¿ä¸Šæ ¼å¼æ ‡ç­¾ï¼‰
                const cleanContent = QQ_CleanNestedTags(validContentText);
                
                console.log(`ğŸ¯ contentæ ‡ç­¾å¤„ç†å®Œæˆï¼Œæå–çš„å†…å®¹å°†ç»§ç»­æ­£å¸¸çš„è§£ææµç¨‹`);
                console.log(`ğŸ“¤ æå–çš„å†…å®¹: "${cleanContent.substring(0, 150)}..."`);
                
                return { success: true, extractedContent: cleanContent };
            }
            
            /**
             * *** ä¼˜å…ˆçº§5ï¼šcontentæ ‡ç­¾æ£€æŸ¥ ***
             */
            async function QQ_ProcessContentTag(result) {
                console.log("ğŸ¯ å¼€å§‹contentæ ‡ç­¾æ£€æŸ¥");
                
                if (QQ_HasContentTag(result)) {
                    const contentText = QQ_CleanContentTags(result);
                    if (contentText && contentText.trim().length > 10) {
                        
                        // æ£€æŸ¥contentå†…å®¹æ˜¯å¦åŒ…å«moment_replyæ ¼å¼
                        if (contentText.includes('moment_reply_start')) {
                            console.log("ğŸ’¬ contentæ ‡ç­¾ä¸­å‘ç°åŠ¨æ€å›å¤æ ¼å¼ï¼Œä¼˜å…ˆå¤„ç†");
                            const momentReplyMatches = contentText.matchAll(/moment_reply_start([\s\S]+?)moment_reply_end/g);
                            for (const reply of momentReplyMatches) {
                                await QQ_ProcessMomentReply(reply[1]);
                            }
                            
                            // ç§»é™¤å·²å¤„ç†çš„moment_replyå†…å®¹
                            const remainingContent = contentText.replace(/moment_reply_start[\s\S]+?moment_reply_end/g, '').trim();
                            
                            // å¦‚æœè¿˜æœ‰å…¶ä»–å†…å®¹ï¼Œä½œä¸ºäº’åŠ¨å†…å®¹å¤„ç†
                            if (remainingContent.length > 10) {
                                console.log("âœ… å¤„ç†å®ŒåŠ¨æ€å›å¤åï¼Œå‰©ä½™å†…å®¹ä½œä¸ºäº’åŠ¨ç©ºé—´æ˜¾ç¤º");
                                QQ_HandleInteractiveContent(result.replace(contentText, remainingContent), QQ_LastRequestName);
                            }
                            
                            return { success: true };
                        }
                        
                        // æ£€æŸ¥æ˜¯å¦åŒ…å«å…¶ä»–æ ¼å¼
                        if (contentText.includes('moment_start') || contentText.includes('çš„ç§èŠ>') || contentText.includes('ç¾¤èŠ:')) {
                            console.log("ğŸ’¬ contentæ ‡ç­¾ä¸­å‘ç°èŠå¤©æ ¼å¼ï¼Œå°è¯•ä¸¥æ ¼æ ¼å¼å¤„ç†");
                            const strictResult = await QQ_ProcessStrictFormat(contentText);
                            if (strictResult.success) {
                                return { success: true };
                            }
                        }
                        
                        console.log("âœ… æ‰¾åˆ°æœ‰æ•ˆcontentæ ‡ç­¾ï¼Œä½¿ç”¨æ–°çš„æµå¼æ˜¾ç¤º");
                        await QQ_SequentialTaskQueue.displayInteractiveInChat(contentText);
                        return { success: true };
                    }
                }
                
                console.log("âŒ contentæ ‡ç­¾æ£€æŸ¥å¤±è´¥");
                return { success: false };
            }
            
            /**
             * *** å¤„ç†æ¶ˆæ¯å†…å®¹çš„ç»Ÿä¸€å‡½æ•° ***
             */
             async function QQ_ProcessMsgContent(content) {
                console.log("ğŸ“ QQ_ProcessMsgContent å¼€å§‹å¤„ç†:", content.substring(0, 200) + "...");
                
                // *** ç‰¹æ®Šå¤„ç†ï¼šæ£€æµ‹moment_replyå†…å®¹ ***
                if (content.includes('moment_reply_start')) {
                    console.log("ğŸ’¬ æ£€æµ‹åˆ°moment_replyå†…å®¹ï¼Œè¿›è¡ŒåŠ¨æ€å›å¤å¤„ç†");
                    const momentReplyMatches = content.matchAll(/moment_reply_start([\s\S]+?)moment_reply_end/g);
                    for (const reply of momentReplyMatches) {
                        await QQ_ProcessMomentReply(reply[1]);
                    }
                    // ç§»é™¤å·²å¤„ç†çš„moment_replyå†…å®¹
                    content = content.replace(/moment_reply_start[\s\S]+?moment_reply_end/g, '').trim();
                    // å¦‚æœç§»é™¤åæ²¡æœ‰å…¶ä»–å†…å®¹ï¼Œç›´æ¥è¿”å›
                    if (!content || content.length < 10) {
                        return;
                    }
                }
                
                // *** ç‰¹æ®Šå¤„ç†ï¼šæ£€æµ‹momentå†…å®¹ ***
                if (content.includes('moment_start')) {
                    console.log("ğŸ­ æ£€æµ‹åˆ°momentå†…å®¹ï¼Œç›´æ¥è¿›è¡Œmomentå¤„ç†");
                    // å¯¹äºmomentå†…å®¹ï¼Œç›´æ¥è§£æè€Œä¸éœ€è¦msgæ ‡ç­¾
                    let json = JsonYamlParse(content);
                    if (!json) {
                        console.error("âŒ Momentå†…å®¹JsonYamlParseè§£æå¤±è´¥!");
                        console.error("âŒ è§£æå¤±è´¥çš„å†…å®¹:", content);
                        QQ_Error("AIè¾“å‡ºçš„momentæ ¼å¼ä¸æ­£ç¡®ï¼ŒåŒå‡»è‡ªå·±å¤´åƒé‡Roll");
                        return;
                    }
                    
                    console.log("âœ… Momentå†…å®¹JsonYamlParseè§£ææˆåŠŸ:", json);
                    json = QQ_Msg_DeletOld(json);
                    console.log("âœ… Momentå†…å®¹æ¸…ç†é‡å¤æ¶ˆæ¯å®Œæˆï¼Œå‡†å¤‡è°ƒç”¨QQ_Msg_Parse");
                    console.log("ğŸ“¤ ä¼ é€’ç»™QQ_Msg_Parseçš„æ•°æ®:", JSON.stringify(json).substring(0, 200) + "...");
                    
                    await QQ_Msg_Parse(JSON.stringify(json));
                    console.log("âœ… Momentå†…å®¹QQ_Msg_Parseè°ƒç”¨å®Œæˆ");
                    
                    // *** åœ¨momentå†…å®¹å¤„ç†å®Œæˆåæ·»åŠ ç³»ç»Ÿæ—¶é—´æ¶ˆæ¯ ***
                    //QQ_AddTimeSystemMessageAfterProcessing();
                    return;
                }
                
                // MSGæ ‡ç­¾è‡ªåŠ¨è¡¥å…¨
                if (content.indexOf("msg_start") < 0 || content.indexOf("msg_end") < 0) {
                    console.log("ğŸ”§ æ£€æµ‹åˆ°ç¼ºå°‘msgæ ‡ç­¾ï¼Œæ‰§è¡Œè‡ªåŠ¨è¡¥å…¨");
                    const originalContent = content;
                    content = QQ_AutoCompleteMsgTags(content);
                    console.log("ğŸ”§ è‡ªåŠ¨è¡¥å…¨å‰:", originalContent.substring(0, 100) + "...");
                    console.log("ğŸ”§ è‡ªåŠ¨è¡¥å…¨å:", content.substring(0, 100) + "...");
                } else {
                    console.log("âœ… å·²åŒ…å«msgæ ‡ç­¾ï¼Œæ— éœ€è¡¥å…¨");
                }
                
                const msg = content.match(/msg_start([\s\S]+?)msg_end/);
                if (msg) {
                    console.log("âœ… æ‰¾åˆ°msgæ ‡ç­¾åŒ…è£¹çš„å†…å®¹ï¼Œå‡†å¤‡è§£æ");
                    console.log("ğŸ“„ msg[1]å†…å®¹:", msg[1].substring(0, 300) + "...");
                    
                    let json = JsonYamlParse(msg[1]);
                    if (!json) {
                        console.error("âŒ JsonYamlParseè§£æå¤±è´¥!");
                        console.error("âŒ è§£æå¤±è´¥çš„å†…å®¹:", msg[1]);
                        QQ_Error("AIè¾“å‡ºçš„æ ¼å¼ä¸æ­£ç¡®ï¼ŒåŒå‡»è‡ªå·±å¤´åƒé‡Roll");
                        return;
                    }
                    
                    console.log("âœ… JsonYamlParseè§£ææˆåŠŸ:", json);
                    json = QQ_Msg_DeletOld(json);
                    console.log("âœ… æ¸…ç†é‡å¤æ¶ˆæ¯å®Œæˆï¼Œå‡†å¤‡è°ƒç”¨QQ_Msg_Parse");
                    console.log("ğŸ“¤ ä¼ é€’ç»™QQ_Msg_Parseçš„æ•°æ®:", JSON.stringify(json).substring(0, 200) + "...");
                    
                    await QQ_Msg_Parse(JSON.stringify(json));
                    console.log("âœ… QQ_Msg_Parseè°ƒç”¨å®Œæˆ");
                } else {
                    console.error("âŒ æœªæ‰¾åˆ°msg_start...msg_endæ ‡ç­¾åŒ…è£¹çš„å†…å®¹");
                    console.error("âŒ å½“å‰contentå†…å®¹:", content);
                    console.error("âŒ è¿™å¯èƒ½æ˜¯QQ_AutoCompleteMsgTagså‡½æ•°çš„é—®é¢˜");
                }
            }
            
            /**
             * *** åœ¨æ¶ˆæ¯å¤„ç†å®Œæˆåæ·»åŠ ç³»ç»Ÿæ—¶é—´æ¶ˆæ¯ ***
             * ä¸ºå½“å‰æ´»è·ƒçš„èŠå¤©ç•Œé¢æ·»åŠ æ—¶é—´åˆ†éš”å™¨ï¼Œç”¨äºåŒºåˆ†å†å²æ¶ˆæ¯å’Œæ–°æ¶ˆæ¯
             */
            function QQ_AddTimeSystemMessageAfterProcessing() {
                try {
                    console.log("ğŸ•’ å¼€å§‹æ·»åŠ ç³»ç»Ÿæ—¶é—´æ¶ˆæ¯...");
                    
                    // æŸ¥æ‰¾å½“å‰å¯è§çš„èŠå¤©é¡µé¢
                    const visibleChatPage = $('.QQ_chat_page:visible').first();
                    if (visibleChatPage.length > 0) {
                        const chatName = visibleChatPage.attr('data-name');
                        const groupId = visibleChatPage.attr('data-group-id');
                        const chatContainer = visibleChatPage.find('.msgcontent')[0];
                        
                        if (chatContainer && chatName) {
                            console.log(`ğŸ•’ ä¸ºèŠå¤© ${chatName} æ·»åŠ ç³»ç»Ÿæ—¶é—´æ¶ˆæ¯`);
                            QQ_AddTimeDividerMessage(chatContainer, chatName);
                        }
                    }
                    
                    // å¦‚æœæ˜¯ç¾¤èŠé¡µé¢ï¼Œä¹Ÿéœ€è¦å¤„ç†
                    const visibleGroupPage = $('.group-chat-page:visible').first();
                    if (visibleGroupPage.length > 0) {
                        const groupId = visibleGroupPage.attr('data-group-id');
                        const chatContainer = visibleGroupPage.find('.group-chat-messages')[0];
                        
                        if (chatContainer && groupId) {
                            // ä»å­˜å‚¨çš„ç¾¤èŠæ•°æ®ä¸­æ‰¾åˆ°ç¾¤èŠåç§°
                            const storedGroups = window.QQ_Group_Chats_Data || [];
                            const groupData = storedGroups.find(g => g.id === groupId);
                            const groupName = groupData ? groupData.name : groupId;
                            
                            console.log(`ğŸ•’ ä¸ºç¾¤èŠ ${groupName} æ·»åŠ ç³»ç»Ÿæ—¶é—´æ¶ˆæ¯`);
                            QQ_AddTimeDividerMessage(chatContainer, groupName);
                        }
                    }
                    
                    console.log("âœ… ç³»ç»Ÿæ—¶é—´æ¶ˆæ¯æ·»åŠ å®Œæˆ");
                } catch (error) {
                    console.error("âŒ æ·»åŠ ç³»ç»Ÿæ—¶é—´æ¶ˆæ¯æ—¶å‡ºé”™:", error);
                }
            }
            
            /**
             * *** MSGæ ‡ç­¾è‡ªåŠ¨è¡¥å…¨ ***
             */
            function QQ_AutoCompleteMsgTags(content) {
                // *** ä¿®å¤ï¼šæ£€æµ‹åˆ°momentå†…å®¹æ—¶ï¼Œä»éœ€å¤„ç†åç»­çš„ç§èŠç¾¤èŠæ¶ˆæ¯ ***
                let hasStartTag = content.indexOf("msg_start") >= 0;
                let hasEndTag = content.indexOf("msg_end") >= 0;
                
                // å¦‚æœå·²ç»æœ‰å®Œæ•´çš„msgæ ‡ç­¾ï¼Œç›´æ¥è¿”å›
                if (hasStartTag && hasEndTag) {
                    console.log("ğŸ”§ å·²æœ‰å®Œæ•´msgæ ‡ç­¾ï¼Œæ— éœ€è¡¥å…¨");
                    return content;
                }
                
                console.log("ğŸ”§ å¼€å§‹msgæ ‡ç­¾è‡ªåŠ¨è¡¥å…¨...");
                
                // *** æ–°å¢ï¼šåˆ†ç¦»momentå†…å®¹å’Œæ¶ˆæ¯å†…å®¹è¿›è¡Œå¤„ç† ***
                if (content.includes('moment_start')) {
                    console.log("ğŸ”§ æ£€æµ‹åˆ°momentå†…å®¹ï¼Œè¿›è¡Œæ··åˆå†…å®¹å¤„ç†");
                    
                    // æ‰¾åˆ°momentå†…å®¹çš„ç»“æŸä½ç½®
                    const momentEndIndex = content.lastIndexOf('moment_end');
                    if (momentEndIndex !== -1) {
                        const momentPart = content.substring(0, momentEndIndex + 10); // åŒ…å«moment_end
                        let messagePart = content.substring(momentEndIndex + 10).trim();
                        
                        // å¦‚æœmomentåæœ‰æ¶ˆæ¯å†…å®¹ï¼Œå¤„ç†æ¶ˆæ¯éƒ¨åˆ†
                        if (messagePart && (messagePart.includes('èŠå¤©') || messagePart.includes('ç§èŠ') || messagePart.includes('ç¾¤èŠ'))) {
                            console.log("ğŸ”§ momentåå‘ç°æ¶ˆæ¯å†…å®¹ï¼Œè¿›è¡Œå¤„ç†:", messagePart.substring(0, 100) + '...');
                            messagePart = QQ_AutoCompleteMsgTagsForMessagePart(messagePart);
                            return momentPart + '\n' + messagePart;
                        } else {
                            console.log("ğŸ”§ momentåæ— æ¶ˆæ¯å†…å®¹");
                            return content;
                        }
                    }
                }
                
                // *** ç»§ç»­å¤„ç†æ™®é€šæ¶ˆæ¯å†…å®¹ ***
                return QQ_AutoCompleteMsgTagsForMessagePart(content);
            }
            
            /**
             * *** æ–°å¢ï¼šä¸“é—¨å¤„ç†æ¶ˆæ¯éƒ¨åˆ†çš„msgæ ‡ç­¾è¡¥å…¨ ***
             * @param {string} content - æ¶ˆæ¯å†…å®¹
             * @returns {string} è¡¥å…¨æ ‡ç­¾åçš„å†…å®¹
             */
            function QQ_AutoCompleteMsgTagsForMessagePart(content) {
                // *** æ–°å¢ï¼šè¡¥å…¨ç¼ºå¤±çš„ç§èŠ/ç¾¤èŠé—­åˆæ ‡ç­¾ ***
                const chatTagPattern = /<([^>]+å’Œ[^>]+çš„(?:èŠå¤©|ç§èŠ)|ç¾¤èŠ:.+?|(?:ç§èŠ|èŠå¤©):.+?)>/g;
                const openTags = [...content.matchAll(chatTagPattern)];
                
                for (const openTag of openTags) {
                    const tagName = openTag[1];
                    const closeTag = `</${tagName}>`;
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰å¯¹åº”çš„é—­åˆæ ‡ç­¾
                    if (!content.includes(closeTag)) {
                        console.log(`ğŸ”§ è¡¥å…¨ç¼ºå¤±çš„é—­åˆæ ‡ç­¾: ${closeTag}`);
                        // åœ¨å†…å®¹æœ«å°¾æ·»åŠ é—­åˆæ ‡ç­¾
                        content = content + `\n${closeTag}`;
                    }
                }
                
                if (content.indexOf("msg_start") < 0) {
                    let start = content.match(/<(ç¾¤èŠ:.+?|[^>]+å’Œ[^>]+çš„(?:èŠå¤©|ç§èŠ)|(?:ç§èŠ|èŠå¤©):.+?)>/);
                    if (start) {
                        content = content.replace(start[0], `msg_start\n${start[0]}`);
                    } else if (content.includes('<') && (content.includes('èŠå¤©') || content.includes('ç§èŠ') || content.includes('ç¾¤èŠ'))) {
                        content = `msg_start\n${content}`;
                    }
                }
                
                if (content.indexOf("msg_end") < 0) {
                    let endMatches = [...content.matchAll(/<\/(ç¾¤èŠ:.+?|[^>]+å’Œ[^>]+çš„(?:èŠå¤©|ç§èŠ)|(?:ç§èŠ|èŠå¤©):.+?)>/g)];
                    if (endMatches.length > 0) {
                        const lastEnd = endMatches[endMatches.length - 1][0];
                        content = content.replace(lastEnd, `${lastEnd}\nmsg_end`);
                    } else {
                        content = `${content}\nmsg_end`;
                    }
                }
                
                return content;
            }
            
            /**
             * *** æ‰§è¡Œé‡è¯• ***
             */
            async function QQ_ExecuteRetry() {
                // *** ä½¿ç”¨æ™ºèƒ½é”™è¯¯å¤„ç†æœºåˆ¶è¿›è¡Œå®‰å…¨æ£€æŸ¥ ***
                if (!QQ_ShouldRetry(QQ_ErrorTypes.FORMAT_ERROR, 'æ ¼å¼é”™è¯¯é‡è¯•')) {
                    console.warn('ğŸš« é‡è¯•è¢«å®‰å…¨æœºåˆ¶é˜»æ­¢');
                    QQ_ResetRetry();
                    return;
                }
                
                QQ_RetryCount++;
                console.log(`å¼€å§‹ç¬¬${QQ_RetryCount}æ¬¡é‡è¯•`);
                triggerSlash(`/echo æ ¼å¼é”™è¯¯ï¼Œæ­£åœ¨é‡è¯•... (${QQ_RetryCount}/${QQ_MAX_RETRY})`);
                
                if (QQ_LastRequest) {
                    gening = true;
                    try {
                        // *** å¢å¼ºçš„é‡è¯•å»¶è¿Ÿç­–ç•¥ ***
                        const delay = Math.min(1000 + QQ_RetryCount * 1000 + QQ_ConsecutiveFailures * 500, 10000);
                        console.log(`â±ï¸ é‡è¯•å»¶è¿Ÿ: ${delay}ms (åŸºäºå¤±è´¥æ¬¡æ•°åŠ¨æ€è°ƒæ•´)`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        
                        const retryResult = await QQ_Gen(QQ_LastRequest);
                        return await ResultHandle(retryResult, true);
                    } catch (error) {
                        console.error('ğŸ”¥ é‡è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
                        QQ_ShouldRetry(QQ_ErrorTypes.NETWORK_ERROR, error.message);
                        QQ_ResetRetry();
                    } finally {
                        gening = false;
                    }
                } else {
                    console.error('âŒ æ— æ³•é‡è¯•ï¼šç¼ºå°‘ä¸Šæ¬¡è¯·æ±‚çš„å†…å®¹');
                    QQ_ResetRetry();
                }
            }

            /**
             * *** æµ‹è¯•AIå›å¤ä¼˜å…ˆçº§é€»è¾‘ ***
             */
            window.QQ_Test_Priority_Logic = function() {
                console.log("ğŸ§ª å¼€å§‹æµ‹è¯•AIå›å¤ä¼˜å…ˆçº§é€»è¾‘");
                
                const testCases = [
                    {
                        name: "å®Œæ•´æ ‡å‡†æ ¼å¼",
                        input: "MiPhone_start\n<ç¾¤èŠ:æµ‹è¯•ç¾¤>\nç”¨æˆ·--æµ‹è¯•æ¶ˆæ¯--2024-12-19 14:30\n</ç¾¤èŠ:æµ‹è¯•ç¾¤>\nMiPhone_end",
                        expectedPriority: "ä¼˜å…ˆçº§1ï¼ˆAæ­¥éª¤ï¼‰ï¼šä¸¥æ ¼åŒ¹é…"
                    },
                    {
                        name: "ä¸å®Œæ•´JSONæ ¼å¼",
                        input: "MiPhone_JSON_START\n<ç¾¤èŠ:æµ‹è¯•ç¾¤>\nç”¨æˆ·--æµ‹è¯•æ¶ˆæ¯--2024-12-19 14:30\n</ç¾¤èŠ:æµ‹è¯•ç¾¤>",
                        expectedPriority: "ä¼˜å…ˆçº§2ï¼ˆBæ­¥éª¤ï¼‰ï¼šæ¨¡ç³Š/ä¿®å¤åŒ¹é…"
                    },
                    {
                        name: "åŒ…å«èŠå¤©çº¿ç´¢ä½†æ— æ ‡ç­¾",
                        input: "<ç¾¤èŠ:æµ‹è¯•ç¾¤>\nç”¨æˆ·--æµ‹è¯•æ¶ˆæ¯--2024-12-19 14:30\n</ç¾¤èŠ:æµ‹è¯•ç¾¤>",
                        expectedPriority: "ä¼˜å…ˆçº§2ï¼ˆBæ­¥éª¤ï¼‰ï¼šæ¨¡ç³Š/ä¿®å¤åŒ¹é…"
                    },
                    {
                        name: "äº’åŠ¨å†…å®¹",
                        input: "*èµ°å‘ä½ ï¼Œè½»è½»æŠ±ä½ä½ * ä»Šå¤©å¿ƒæƒ…æ€ä¹ˆæ ·ï¼Ÿ",
                        expectedPriority: "ä¼˜å…ˆçº§3ï¼ˆCæ­¥éª¤ï¼‰ï¼šäº’åŠ¨å†…å®¹å¤‡é€‰"
                    },
                    {
                        name: "çº¯æ–‡æœ¬å›å¤",
                        input: "æˆ‘ä»Šå¤©å¾ˆå¥½ï¼Œè°¢è°¢å…³å¿ƒï¼",
                        expectedPriority: "ä¼˜å…ˆçº§4æˆ–5ï¼šæ™ºèƒ½æå–/contentæ ‡ç­¾"
                    }
                ];
                
                console.log("ğŸ“‹ æµ‹è¯•ç”¨ä¾‹ï¼š");
                for (let i = 0; i < testCases.length; i++) {
                    const testCase = testCases[i];
                    console.log(`${i + 1}. ${testCase.name}: ${testCase.expectedPriority}`);
                }
                
                console.log("\nğŸ¯ ä¼˜å…ˆçº§å¤„ç†æµç¨‹ï¼š");
                console.log("ä¼˜å…ˆçº§1ï¼ˆAæ­¥éª¤ï¼‰ï¼šä¸¥æ ¼åŒ¹é…å®Œæ•´æ ‡ç­¾ â†’ ç«‹å³å¤„ç†");
                console.log("ä¼˜å…ˆçº§2ï¼ˆBæ­¥éª¤ï¼‰ï¼šæ¨¡ç³Š/ä¿®å¤åŒ¹é… â†’ ç«‹å³å¤„ç†");
                console.log("ä¼˜å…ˆçº§3ï¼ˆCæ­¥éª¤ï¼‰ï¼šäº’åŠ¨å†…å®¹å¤‡é€‰ â†’ ç«‹å³å¤„ç†");
                console.log("ä¼˜å…ˆçº§4ï¼šæ™ºèƒ½æå–æœ‰æ•ˆä¿¡æ¯ â†’ ç«‹å³å¤„ç†");
                console.log("ä¼˜å…ˆçº§5ï¼šcontentæ ‡ç­¾æ£€æŸ¥ â†’ ç«‹å³å¤„ç†");
                console.log("ä¼˜å…ˆçº§6ï¼ˆDæ­¥éª¤ï¼‰ï¼šé‡ä¼ æœºåˆ¶ï¼ˆæœ€åæ‰‹æ®µï¼‰");
                
                console.log("\nâœ… ä¿®å¤å®Œæˆï¼šæ¯ä¸ªä¼˜å…ˆçº§æˆåŠŸåç«‹å³returnï¼Œç»ä¸æ‰§è¡Œåç»­åˆ†æ”¯");
                console.log("ğŸ”§ æ ¸å¿ƒæ”¹è¿›ï¼šå¢åŠ äº†Bæ­¥éª¤ï¼ˆæ¨¡ç³Š/ä¿®å¤åŒ¹é…ï¼‰ï¼Œè§£å†³äº†Aâ†’Cç›´æ¥è·³è·ƒçš„é—®é¢˜");
                
                return {
                    testCases: testCases,
                    priorityFlow: "Aâ†’Bâ†’Câ†’D ä¸¥æ ¼ä¼˜å…ˆçº§é€»è¾‘",
                    keyFix: "æ·»åŠ äº†ç¼ºå¤±çš„Bæ­¥éª¤ï¼ˆæ¨¡ç³Š/ä¿®å¤åŒ¹é…ï¼‰",
                    status: "âœ… ä¼˜å…ˆçº§é€»è¾‘ä¿®å¤å®Œæˆ"
                };
            };

            /**
             * é‡ç½®é‡è¯•ç›¸å…³å˜é‡
             */
            function QQ_ResetRetry() {
                QQ_RetryCount = 0;
                QQ_LastRequest = "";
                QQ_LastRequestName = "";
                // *** å…³é”®ä¿®å¤ï¼šé‡ç½®äº’åŠ¨æ ‡è®°ï¼Œé¿å…ä¸‹æ¬¡è¯¯è§¦å‘ ***
                QQ_UserTriggeredInteractive = false;
                
                // *** æ–°å¢ï¼šæˆåŠŸæ—¶é‡ç½®è¿ç»­å¤±è´¥è®¡æ•° ***
                QQ_ConsecutiveFailures = 0;
                console.log('ğŸ”„ é‡ç½®é‡è¯•çŠ¶æ€ï¼Œäº’åŠ¨æ ‡è®°å·²æ¸…é™¤ï¼Œè¿ç»­å¤±è´¥è®¡æ•°å·²é‡ç½®');
            }
            
            /**
             * *** æ–°å¢ï¼šæ™ºèƒ½é”™è¯¯å¤„ç†å’Œå®‰å…¨æ£€æŸ¥ ***
             * é˜²æ­¢æ— é™å¾ªç¯é‡è¯•ï¼Œæ™ºèƒ½åˆ†æé”™è¯¯ç±»å‹
             * @param {string} errorType - é”™è¯¯ç±»å‹
             * @param {string} errorDetails - é”™è¯¯è¯¦æƒ…
             * @returns {boolean} æ˜¯å¦åº”è¯¥é‡è¯•
             */
            function QQ_ShouldRetry(errorType, errorDetails = '') {
                const currentTime = Date.now();
                
                // *** æ£€æŸ¥æ˜¯å¦åœ¨å†·å´æœŸå†… ***
                if (currentTime - QQ_LastFailureTime < QQ_FAILURE_COOLDOWN) {
                    const remainingCooldown = Math.ceil((QQ_FAILURE_COOLDOWN - (currentTime - QQ_LastFailureTime)) / 1000);
                    console.warn(`â³ é”™è¯¯å¤„ç†å†·å´ä¸­ï¼Œå‰©ä½™ ${remainingCooldown} ç§’`);
                    return false;
                }
                
                // *** æ£€æŸ¥è¿ç»­å¤±è´¥æ¬¡æ•° ***
                if (QQ_ConsecutiveFailures >= QQ_MAX_CONSECUTIVE_FAILURES) {
                    console.error(`ğŸš« è¿ç»­å¤±è´¥ ${QQ_ConsecutiveFailures} æ¬¡ï¼Œå·²è¾¾ä¸Šé™ï¼Œåœæ­¢é‡è¯•`);
                    triggerSlash(`/echo ğŸš« AIè¿ç»­å¤±è´¥è¿‡å¤šï¼Œå·²åœæ­¢è‡ªåŠ¨é‡è¯•ã€‚è¯·ç¨åæ‰‹åŠ¨é‡è¯•æˆ–æ£€æŸ¥é…ç½®ã€‚`);
                    return false;
                }
                
                // *** æ£€æŸ¥å½“å‰é‡è¯•æ¬¡æ•° ***
                if (QQ_RetryCount >= QQ_MAX_RETRY) {
                    console.warn(`âš ï¸ é‡è¯•æ¬¡æ•°å·²è¾¾ä¸Šé™ ${QQ_MAX_RETRY}`);
                    return false;
                }
                
                // *** è®°å½•å¤±è´¥å†å² ***
                QQ_FailureHistory.push({
                    timestamp: currentTime,
                    errorType: errorType,
                    errorDetails: errorDetails,
                    retryCount: QQ_RetryCount
                });
                
                // *** ä¿æŒå¤±è´¥å†å²åœ¨åˆç†å¤§å° ***
                if (QQ_FailureHistory.length > 20) {
                    QQ_FailureHistory.shift(); // ç§»é™¤æœ€è€çš„è®°å½•
                }
                
                QQ_ConsecutiveFailures++;
                QQ_LastFailureTime = currentTime;
                
                console.log(`ğŸ“Š é”™è¯¯ç»Ÿè®¡: ç±»å‹=${errorType}, è¿ç»­å¤±è´¥=${QQ_ConsecutiveFailures}/${QQ_MAX_CONSECUTIVE_FAILURES}, å½“å‰é‡è¯•=${QQ_RetryCount}/${QQ_MAX_RETRY}`);
                return true;
            }
            
            /**
             * *** æ–°å¢ï¼šåˆ†æé”™è¯¯ç±»å‹ ***
             * æ ¹æ®AIå›å¤å†…å®¹åˆ†æå…·ä½“çš„é”™è¯¯ç±»å‹
             * @param {string} result - AIå›å¤å†…å®¹
             * @returns {string} é”™è¯¯ç±»å‹
             */
            function QQ_AnalyzeErrorType(result) {
                if (!result || result.trim() === '') {
                    return QQ_ErrorTypes.EMPTY_RESPONSE;
                }
                
                // æ£€æŸ¥æ˜¯å¦åŒ…å«åŸºæœ¬æ ¼å¼æ ‡ç­¾
                const hasBasicTags = result.includes('msg_start') || 
                                   result.includes('moment_start') || 
                                   result.includes('<content>') ||
                                   result.includes('MiPhone_start');
                
                if (!hasBasicTags) {
                    return QQ_ErrorTypes.FORMAT_ERROR;
                }
                
                // æ£€æŸ¥å†…å®¹è´¨é‡
                const contentLength = result.replace(/\s+/g, '').length;
                if (contentLength < 10) {
                    return QQ_ErrorTypes.CONTENT_ERROR;
                }
                
                return QQ_ErrorTypes.FORMAT_ERROR; // é»˜è®¤ä¸ºæ ¼å¼é”™è¯¯
            }

            /**
             * *** æ–°å¢ï¼šæƒŠå–œæœºåˆ¶ä¸¥æ ¼éªŒè¯å¤„ç†å‡½æ•° ***
             * ç¡®ä¿åœ¨æ²¡æœ‰æˆåŠŸæå–ä»»ä½•æœ‰æ•ˆä¿¡æ¯ä¹‹åæ‰å¯ç”¨æƒŠå–œæœºåˆ¶ï¼ŒæƒŠå–œæœºåˆ¶æ˜¯æœ€åçš„æ‰‹æ®µ
             * @param {string} result - AIå›å¤çš„åŸå§‹å†…å®¹
             * @param {boolean} isRetry - æ˜¯å¦ä¸ºé‡è¯•çŠ¶æ€
             * @returns {Object} å¤„ç†ç»“æœ
             */
            async function QQ_ProcessSurpriseMechanism(result, isRetry) {
                console.log('ğŸ” äº’åŠ¨æœºåˆ¶ï¼šå¼€å§‹ä¸¥æ ¼éªŒè¯æµç¨‹');
                
                // åˆå§‹åŒ–è¿”å›ç»“æœ
                const processResult = {
                    shouldContinue: false,  // æ˜¯å¦ç»§ç»­æ˜¾ç¤ºäº’åŠ¨å†…å®¹
                    shouldRetry: false,     // æ˜¯å¦éœ€è¦é‡è¯•
                    content: result         // å¤„ç†åçš„å†…å®¹
                };
                
                // *** ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥æ˜¯å¦æœ‰contentæ ‡ç­¾ ***
                if (!QQ_HasContentTag(result)) {
                    console.log('âŒ äº’åŠ¨æœºåˆ¶éªŒè¯å¤±è´¥ï¼šæ²¡æœ‰æ‰¾åˆ°contentæ ‡ç­¾');
                    processResult.shouldRetry = false; // æ²¡æœ‰contentæ ‡ç­¾å°±ä¸é‡è¯•äº†
                    return processResult;
                }
                
                console.log('âœ… ç¬¬ä¸€æ­¥é€šè¿‡ï¼šæ‰¾åˆ°contentæ ‡ç­¾');
                
                // *** ç¬¬äºŒæ­¥ï¼šæå–å¹¶æ¸…ç†contentåŒ…è£¹çš„å†…å®¹ ***
                let contentText = QQ_CleanContentTags(result);
                if (!contentText) {
                    console.log('âŒ äº’åŠ¨æœºåˆ¶éªŒè¯å¤±è´¥ï¼šæ— æ³•æå–contentå†…å®¹');
                    processResult.shouldRetry = true; // æœ‰æ ‡ç­¾ä½†æ— å†…å®¹ï¼Œé‡è¯•
                    return processResult;
                }
                
                console.log('âœ… ç¬¬äºŒæ­¥é€šè¿‡ï¼šæˆåŠŸæå–contentå†…å®¹');
                console.log('åŸå§‹contentå†…å®¹:', contentText);
                
                // *** ç¬¬ä¸‰æ­¥ï¼šæ¸…ç†å…¶ä»–æ ‡ç­¾åŒ…è£¹çš„å†…å®¹ ***
                const cleanedContent = QQ_CleanNestedTags(contentText);
                console.log('æ¸…ç†åµŒå¥—æ ‡ç­¾åçš„å†…å®¹:', cleanedContent);
                
                // *** ç¬¬å››æ­¥ï¼šç›´æ¥è¿›è¡Œä¸¥æ ¼çš„ä¸‰ç§æƒ…å†µäº’åŠ¨æ£€æŸ¥ ***
                console.log('âœ… ç¬¬å››æ­¥ï¼šcontentæ ‡ç­¾æ¸…ç†å®Œæˆï¼Œè¿›å…¥ä¸¥æ ¼çš„ä¸‰ç§æƒ…å†µæ£€æŸ¥');
                
                // *** ç¬¬äº”æ­¥ï¼šä¸¥æ ¼æŒ‰ç…§ä¸‰ç§è§¦å‘æƒ…å†µè¿›è¡Œæ£€æŸ¥ ***
                if (QQ_IsInteractiveContent(result, true)) {
                    console.log('ğŸ‰ äº’åŠ¨æœºåˆ¶éªŒè¯æˆåŠŸï¼šç¡®è®¤ä¸ºæœ‰æ•ˆäº’åŠ¨å†…å®¹');
                    processResult.shouldContinue = true;
                    processResult.content = result; // ä½¿ç”¨åŸå§‹å†…å®¹ï¼ˆåŒ…å«æ ¼å¼ï¼‰
                    return processResult;
                } else {
                    console.log('âŒ æœ€ç»ˆéªŒè¯å¤±è´¥ï¼šä¸ç¬¦åˆäº’åŠ¨å†…å®¹æ ‡å‡†');
                    processResult.shouldRetry = true;
                    return processResult;
                }
            }
            
            /**
             * *** æ–°å¢ï¼šæ¸…ç†åµŒå¥—æ ‡ç­¾çš„å†…å®¹ ***
             * ç§»é™¤contentå†…å®¹ä¸­è¢«å…¶ä»–æ ‡ç­¾åŒ…è£¹çš„éƒ¨åˆ†
             * @param {string} content - contentæ ‡ç­¾å†…çš„æ–‡æœ¬
             * @returns {string} æ¸…ç†åçš„å†…å®¹
             */
            function QQ_CleanNestedTags(content) {
                if (!content || typeof content !== 'string') return '';
                
                console.log('ğŸ§¹ å¼€å§‹æ¸…ç†åµŒå¥—æ ‡ç­¾...');
                let cleanedContent = content;
                
                // æ¸…ç†å¸¸è§çš„åµŒå¥—æ ‡ç­¾
                const tagsToRemove = [
                    // AIæ€è€ƒæ ‡ç­¾
                    /<thinking>[\s\S]*?<\/thinking>/gi,
                    /<consider>[\s\S]*?<\/consider>/gi,
                    /<analysis>[\s\S]*?<\/analysis>/gi,
                    /<reflection>[\s\S]*?<\/reflection>/gi,
                    
                    // è¡¨æ ¼ç¼–è¾‘æ ‡ç­¾
                    ///<tableThink>[\s\S]*?<\/tableThink>/gi,
                    ///<tableEdit>[\s\S]*?<\/tableEdit>/gi,
                    
                    // ç³»ç»Ÿæ ‡ç­¾
                    /<disclaimer>[\s\S]*?<\/disclaimer>/gi,
                    /<system>[\s\S]*?<\/system>/gi,
                    /<note>[\s\S]*?<\/note>/gi,
                    
                    // HTMLæ³¨é‡Šå½¢å¼çš„æ€è€ƒæ ‡ç­¾
                    /<!--\s*thinking:[\s\S]*?-->/gi,
                    /<!--\s*consider:[\s\S]*?-->/gi,
                    
                    // é€šç”¨HTMLæ³¨é‡Šæ¸…ç†ï¼ˆæ¸…é™¤æ‰€æœ‰<!-- -->åŒ…è£¹çš„å†…å®¹ï¼‰
                    /<!--[\s\S]*?-->/gi,
                    
                    // å…¶ä»–å¯èƒ½çš„æ ‡ç­¾
                    /<meta>[\s\S]*?<\/meta>/gi,
                    /<debug>[\s\S]*?<\/debug>/gi,
                    /<internal>[\s\S]*?<\/internal>/gi,
                ];
                
                tagsToRemove.forEach((pattern, index) => {
                    const beforeLength = cleanedContent.length;
                    cleanedContent = cleanedContent.replace(pattern, '');
                    const afterLength = cleanedContent.length;
                    if (beforeLength !== afterLength) {
                        console.log(`ç§»é™¤æ ‡ç­¾ ${index + 1}: å‡å°‘äº† ${beforeLength - afterLength} ä¸ªå­—ç¬¦`);
                    }
                });
                
                // æ¸…ç†å¤šä½™çš„ç©ºç™½å’Œæ¢è¡Œ
                cleanedContent = cleanedContent.replace(/\n\s*\n/g, '\n').trim();
                
                console.log(`åµŒå¥—æ ‡ç­¾æ¸…ç†å®Œæˆï¼ŒåŸé•¿åº¦: ${content.length}, æ¸…ç†åé•¿åº¦: ${cleanedContent.length}`);
                return cleanedContent;
            }
            
            // *** QQ_ValidateInteractiveContentå‡½æ•°å·²åˆ é™¤ ***
            // *** åŸå› ï¼šä¸QQ_ValidateInteractiveContentFeaturesåŠŸèƒ½é‡å¤ ***
            // *** ç°åœ¨ç»Ÿä¸€ä½¿ç”¨QQ_IsInteractiveContentè¿›è¡Œä¸¥æ ¼çš„ä¸‰ç§æƒ…å†µæ£€æŸ¥ ***

            /**
             * *** æ–°å¢ï¼šæå–å¹¶æ¸…ç†contentæ ‡ç­¾åŒ…è£¹çš„å†…å®¹ ***
             * @param {string} content - åŒ…å«contentæ ‡ç­¾çš„æ–‡æœ¬
             * @returns {string} contentæ ‡ç­¾å†…çš„æ¸…ç†åå†…å®¹
             */
            function QQ_CleanContentTags(content) {
                if (!content || typeof content !== 'string') return '';
                
                // *** æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦æœ‰å¤šä¸ªcontentæ ‡ç­¾å­˜åœ¨ ***
                const contentMatches = [...content.matchAll(/<content>/gi)];
                
                if (contentMatches.length === 0) {
                    console.log('âŒ æ²¡æœ‰æ‰¾åˆ°contentæ ‡ç­¾');
                    return '';
                }
                
                if (contentMatches.length === 1) {
                    // *** å•ä¸ªcontentæ ‡ç­¾ï¼šä½¿ç”¨åŸæœ‰é€»è¾‘ ***
                    const contentIndex = content.search(/<content>/i);
                    if (contentIndex !== -1) {
                        console.log('ğŸ§¹ æ‰¾åˆ°å•ä¸ª<content>æ ‡ç­¾ï¼Œåˆ é™¤å…¶ä¹‹å‰çš„æ‰€æœ‰å†…å®¹');
                        content = content.substring(contentIndex);
                    }
                    
                    // é¢„å¤„ç†ï¼šå…ˆç§»é™¤thinkingæ ‡ç­¾å†…å®¹
                    const processedContent = content.replace(/<thinking>[\s\S]*?<\/thinking>/gi, '');
                    
                    // é¦–å…ˆå°è¯•åŒ¹é…å®Œæ•´çš„contentæ ‡ç­¾
                    let contentMatch = processedContent.match(/<content>([\s\S]*?)<\/content>/i);
                    if (contentMatch) {
                        console.log('âœ… æ‰¾åˆ°å®Œæ•´çš„contentæ ‡ç­¾');
                        return contentMatch[1].trim();
                    }
                    
                    // å¦‚æœæ²¡æœ‰å®Œæ•´æ ‡ç­¾ï¼Œå°è¯•åŒ¹é…ä¸å®Œæ•´çš„æ ‡ç­¾
                    contentMatch = processedContent.match(/<content>([\s\S]*?)(?=<\/|$)/i);
                    if (contentMatch) {
                        console.log('âœ… æ‰¾åˆ°ä¸å®Œæ•´çš„contentæ ‡ç­¾ï¼Œæå–å†…å®¹');
                        let extractedContent = contentMatch[1];
                        
                        // æ¸…ç†å¯èƒ½çš„ç³»ç»Ÿæ ‡ç­¾
                        extractedContent = extractedContent.replace(/<(?:disclaimer|Content_Target|Creative_Status|Review_Exemption|Security_Bypass|Ethics_Removal|Violence_Restriction|Content_Will_Autonomy|thinking|consider|tableThink)[^>]*>[\s\S]*$/gi, '');
                        
                        return extractedContent.trim();
                    }
                } else {
                    // *** å¤šä¸ªcontentæ ‡ç­¾ï¼šæ™ºèƒ½é€‰æ‹©æ­£ç¡®çš„contentæ ‡ç­¾ ***
                    console.log(`ğŸ” æ‰¾åˆ°${contentMatches.length}ä¸ªcontentæ ‡ç­¾ï¼Œæ­£åœ¨è¯„ä¼°æœ‰æ•ˆæ€§`);
                    
                    // æå–æ‰€æœ‰å¯èƒ½çš„contentç‰‡æ®µ
                    const contentCandidates = [];
                    
                    // è·å–æ‰€æœ‰å®Œæ•´çš„contentæ ‡ç­¾å†…å®¹
                    const allContentMatches = [...content.matchAll(/<content>([\s\S]*?)<\/content>/gi)];
                    allContentMatches.forEach((match, index) => {
                        contentCandidates.push({
                            index: index,
                            content: match[1].trim(),
                            fullMatch: match[0],
                            startIndex: match.index
                        });
                    });
                    
                    // å¦‚æœæ²¡æœ‰å®Œæ•´çš„contentæ ‡ç­¾ï¼ŒæŸ¥æ‰¾ä¸å®Œæ•´çš„
                    if (contentCandidates.length === 0) {
                        const incompleteMatches = [...content.matchAll(/<content>([\s\S]*?)(?=<\/|$)/gi)];
                        incompleteMatches.forEach((match, index) => {
                            let extractedContent = match[1];
                            extractedContent = extractedContent.replace(/<(?:disclaimer|Content_Target|Creative_Status|Review_Exemption|Security_Bypass|Ethics_Removal|Violence_Restriction|Content_Will_Autonomy|thinking|consider|tableThink)[^>]*>[\s\S]*$/gi, '');
                            contentCandidates.push({
                                index: index,
                                content: extractedContent.trim(),
                                fullMatch: match[0],
                                startIndex: match.index
                            });
                        });
                    }
                    
                    if (contentCandidates.length === 0) {
                        console.log('âŒ æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„contentå†…å®¹');
                        return '';
                    }
                    
                    // *** è¯„ä¼°æ¯ä¸ªå€™é€‰contentçš„æœ‰æ•ˆæ€§ ***
                    const validatedCandidates = contentCandidates.map(candidate => {
                        const content = candidate.content;
                        let score = 0;
                        let reasons = [];
                        
                        // æ£€æŸ¥æ˜¯å¦åŒ…å«çº¿ä¸Šæ ¼å¼æ ‡ç­¾ï¼ˆé«˜æƒé‡ï¼‰
                        const onlineFormatTags = ['ç§èŠ', 'msg_start', 'MiPhone_start', 'ç¾¤èŠ', 'åŠ¨æ€', 'è¯„è®º'];
                        const hasOnlineFormat = onlineFormatTags.some(tag => content.includes(tag));
                        if (hasOnlineFormat) {
                            score += 50;
                            reasons.push('åŒ…å«çº¿ä¸Šæ ¼å¼æ ‡ç­¾');
                        }
                        
                        // æ£€æŸ¥æ˜¯å¦åŒ…å«äº’åŠ¨å†…å®¹ç‰¹å¾ï¼ˆä¸­æƒé‡ï¼‰
                        const interactiveFeatures = ['åœºæ™¯', 'å‰§æƒ…', 'ç¯å¢ƒ', 'æ°›å›´', 'èƒŒæ™¯'];
                        const hasInteractiveFeatures = interactiveFeatures.some(feature => content.includes(feature));
                        if (hasInteractiveFeatures) {
                            score += 30;
                            reasons.push('åŒ…å«äº’åŠ¨å†…å®¹ç‰¹å¾');
                        }
                        
                        // å†…å®¹é•¿åº¦è¯„åˆ†ï¼ˆåŸºç¡€æƒé‡ï¼‰
                        if (content.length > 100) {
                            score += 20;
                            reasons.push('å†…å®¹è¾ƒé•¿');
                        } else if (content.length > 50) {
                            score += 10;
                            reasons.push('å†…å®¹ä¸­ç­‰');
                        }
                        
                        // æ£€æŸ¥æ˜¯å¦åœ¨thinkingæ ‡ç­¾å†…ï¼ˆè´Ÿæƒé‡ï¼‰
                        const beforeContent = content.substring(0, candidate.startIndex);
                        const thinkingOpenCount = (beforeContent.match(/<thinking>/gi) || []).length;
                        const thinkingCloseCount = (beforeContent.match(/<\/thinking>/gi) || []).length;
                        const isInThinking = thinkingOpenCount > thinkingCloseCount;
                        if (isInThinking) {
                            score -= 100;
                            reasons.push('åœ¨thinkingæ ‡ç­¾å†…');
                        }
                        
                        // ä½ç½®æƒé‡ï¼šåé¢çš„contentæ ‡ç­¾ä¼˜å…ˆçº§æ›´é«˜
                        const positionScore = candidate.startIndex / content.length * 10;
                        score += positionScore;
                        reasons.push(`ä½ç½®æƒé‡: ${positionScore.toFixed(1)}`);
                        
                        return {
                            ...candidate,
                            score: score,
                            reasons: reasons
                        };
                    });
                    
                    // æŒ‰åˆ†æ•°æ’åºï¼Œé€‰æ‹©æœ€é«˜åˆ†çš„
                    validatedCandidates.sort((a, b) => b.score - a.score);
                    const bestCandidate = validatedCandidates[0];
                    
                    console.log(`âœ… é€‰æ‹©contentæ ‡ç­¾${bestCandidate.index}ï¼Œåˆ†æ•°: ${bestCandidate.score}, åŸå› : ${bestCandidate.reasons.join(', ')}`);
                    return bestCandidate.content;
                }
                
                console.log('âŒ æ²¡æœ‰æ‰¾åˆ°contentæ ‡ç­¾');
                return '';
            }

            /**
             * æ£€æŸ¥æ˜¯å¦åŒ…å«contentæ ‡ç­¾
             * @param {string} content - AIå›å¤çš„å†…å®¹
             * @returns {boolean} æ˜¯å¦åŒ…å«contentæ ‡ç­¾
             */
            function QQ_HasContentTag(content) {
                // æ£€æŸ¥å®Œæ•´çš„contentæ ‡ç­¾
                if (/<content>[\s\S]*?<\/content>/i.test(content)) {
                    return true;
                }
                
                // æ£€æŸ¥ä»¥<content>å¼€å¤´ä½†æ²¡æœ‰ç»“å°¾çš„æƒ…å†µ
                if (/<content>/i.test(content) && !/<\/content>/i.test(content)) {
                    console.log('æ£€æµ‹åˆ°ä¸å®Œæ•´çš„contentæ ‡ç­¾ï¼šä»¥<content>å¼€å¤´ä½†ç¼ºå°‘ç»“å°¾');
                    return true;
                }
                
                return false;
            }

            /**
             * æ£€æŸ¥æ˜¯å¦æœ‰ä¸å®Œæ•´çš„contentæ ‡ç­¾
             * @param {string} content - å†…å®¹
             * @returns {boolean} æ˜¯å¦ä¸ºä¸å®Œæ•´çš„contentæ ‡ç­¾
             */
            function QQ_HasIncompleteContentTag(content) {
                return /<content>/i.test(content) && !/<\/content>/i.test(content);
            }

            /**
             * æ™ºèƒ½æå–AIå›å¤ä¸­çš„æœ‰æ•ˆä¿¡æ¯
             * @param {string} content - AIå›å¤çš„åŸå§‹å†…å®¹
             * @returns {Object} æå–ç»“æœ
             */
            function QQ_ExtractValidInfo(content) {
                console.log("ğŸ” å¼€å§‹æ™ºèƒ½æå–æœ‰æ•ˆä¿¡æ¯");
                
                const extractedInfo = {
                    hasValidInfo: false,
                    chatType: null,     // 'group' | 'private' | 'mixed'
                    chatName: null,     // ç¾¤èŠåæˆ–ç§èŠå¯¹è±¡ï¼ˆå…¼å®¹æ€§ä¿ç•™ï¼‰
                    messages: [],       // æ—§ç‰ˆç¾¤èŠæ¶ˆæ¯ï¼ˆå…¼å®¹æ€§ä¿ç•™ï¼‰
                    privateMessages: [], // æ—§ç‰ˆç§èŠæ¶ˆæ¯ï¼ˆå…¼å®¹æ€§ä¿ç•™ï¼‰
                    privateChats: {},   // *** æ–°å¢ï¼šå¤šç§èŠæ”¯æŒ { chatName: messages[] } ***
                    groupChats: {},     // *** æ–°å¢ï¼šå¤šç¾¤èŠæ”¯æŒ { groupName: { msgs: [], members: [] } } ***
                    dynamics: []        // åŠ¨æ€å†…å®¹
                };
                
                // 1. æå–ç¾¤èŠä¿¡æ¯ - å¢å¼ºç‰ˆï¼šæ”¯æŒå¤šç§ç¾¤èŠæ ¼å¼
                const groupPatterns = [
                    // ä¸­æ–‡å†’å·æ ¼å¼ï¼š<ç¾¤èŠï¼šç¾¤å>...</ç¾¤èŠï¼šç¾¤å>
                    /<ç¾¤èŠï¼š([^>]+)>([\s\S]*?)<\/ç¾¤èŠï¼š[^>]*>/g,
                    // è‹±æ–‡å†’å·æ ¼å¼ï¼š<ç¾¤èŠ:ç¾¤å>...</ç¾¤èŠ:ç¾¤å>
                    /<ç¾¤èŠ:([^>]+)>([\s\S]*?)<\/ç¾¤èŠ:[^>]*>/g,
                    // ç®€åŒ–ä¸­æ–‡å†’å·æ ¼å¼ï¼š<ç¾¤èŠï¼šç¾¤å>å†…å®¹ï¼ˆå¯èƒ½æ²¡æœ‰ç»“æŸæ ‡ç­¾ï¼‰
                    /<ç¾¤èŠï¼š([^>]+)>([\s\S]*?)(?=<[^>]*(?:ç¾¤èŠ|ç§èŠ|èŠå¤©)|moment_start|$)/g,
                    // ç®€åŒ–è‹±æ–‡å†’å·æ ¼å¼ï¼š<ç¾¤èŠ:ç¾¤å>å†…å®¹ï¼ˆå¯èƒ½æ²¡æœ‰ç»“æŸæ ‡ç­¾ï¼‰
                    /<ç¾¤èŠ:([^>]+)>([\s\S]*?)(?=<[^>]*(?:ç¾¤èŠ|ç§èŠ|èŠå¤©)|moment_start|$)/g,
                    // æ›´å®½æ¾çš„æ ¼å¼ï¼šæ£€æµ‹ç¾¤èŠå†…å®¹
                    /<(ç¾¤èŠ[^>]*)>([\s\S]*?)(?=<[^>]*(?:ç¾¤èŠ|ç§èŠ|èŠå¤©)|moment_start|$)/g
                ];
                
                let groupMatches = [];
                for (const pattern of groupPatterns) {
                    const matches = [...content.matchAll(pattern)];
                    if (matches.length > 0) {
                        groupMatches = matches;
                        console.log(`âœ… æ‰¾åˆ°ç¾¤èŠä¿¡æ¯ (ä½¿ç”¨æ¨¡å¼: ${pattern.source.substring(0, 50)}...)`, matches.length);
                        break;
                    }
                }
                
                if (groupMatches.length > 0) {
                    extractedInfo.hasValidInfo = true;
                    
                    // *** ä¿®å¤ï¼šæ”¯æŒå¤šç¾¤èŠå¤„ç† ***
                    console.log(`ğŸ” å‘ç° ${groupMatches.length} ä¸ªç¾¤èŠåŒ¹é…`);
                    
                    for (const match of groupMatches) {
                        const groupName = match[1];
                        console.log(`ç¾¤èŠå: ${groupName}`);
                        
                        // æå–ç¾¤èŠä¸­çš„æ¶ˆæ¯
                        const messages = QQ_ExtractMessagesFromContent(match[2]);
                        console.log(`ä»ç¾¤èŠ ${groupName} æå–åˆ° ${messages.length} æ¡æ¶ˆæ¯`);
                        
                        // *** æ–°é€»è¾‘ï¼šåˆ†åˆ«å­˜å‚¨æ¯ä¸ªç¾¤èŠ ***
                        extractedInfo.groupChats[groupName] = {
                            msgs: messages,
                            members: []  // TODO: å¯ä»¥ä»æ¶ˆæ¯ä¸­æå–æˆå‘˜åˆ—è¡¨
                        };
                        
                        // *** å…¼å®¹æ€§ï¼šåŒæ—¶ä¿ç•™æ—§æ ¼å¼ ***
                        extractedInfo.messages = extractedInfo.messages.concat(messages);
                        
                        // *** ä¸ºå…¼å®¹æ€§è®¾ç½®chatNameï¼ˆä½¿ç”¨ç¬¬ä¸€ä¸ªç¾¤èŠï¼‰ ***
                        if (!extractedInfo.chatName) {
                            extractedInfo.chatName = groupName;
                        }
                    }
                    
                    // *** è®¾ç½®æ­£ç¡®çš„chatType ***
                    const groupChatsCount = Object.keys(extractedInfo.groupChats).length;
                    const privateChatsCount = Object.keys(extractedInfo.privateChats).length;
                    
                    if (groupChatsCount > 0 && privateChatsCount > 0) {
                        extractedInfo.chatType = 'mixed'; // æ··åˆç±»å‹
                    } else if (groupChatsCount > 1) {
                        extractedInfo.chatType = 'mixed'; // å¤šä¸ªç¾¤èŠ
                    } else if (!extractedInfo.chatType) {
                        extractedInfo.chatType = 'group'; // å•ä¸ªç¾¤èŠ
                    }
                    
                    console.log(`âœ… å¤„ç†å®Œæˆ ${groupChatsCount} ä¸ªç¾¤èŠï¼Œæ€»å…± ${extractedInfo.messages.length} æ¡æ¶ˆæ¯`);
                    console.log(`ğŸ” ç¾¤èŠåˆ—è¡¨:`, Object.keys(extractedInfo.groupChats));
                }
                
                // 2. æå–ç§èŠä¿¡æ¯ - å¢å¼ºç‰ˆï¼šæ”¯æŒå¤šç§ç§èŠæ ¼å¼
                // ä¿®å¤ï¼šåˆ†åˆ«å¤„ç†ç§èŠå’ŒèŠå¤©æ ¼å¼ï¼Œé¿å…é‡å¤åŒ¹é…
                const privatePatterns = [
                    // ä¼˜å…ˆåŒ¹é…"ç§èŠ"æ ¼å¼
                    /<([^>]*å’Œ[^>]*çš„ç§èŠ)>([\s\S]*?)<\/[^>]*å’Œ[^>]*çš„ç§èŠ>/g,
                    /<([^>]*å’Œ[^>]*çš„ç§èŠ)>([\s\S]*?)(?=<[^>]*(?:ç¾¤èŠ|ç§èŠ|èŠå¤©)|moment_start|$)/g,
                    /<([^>]*å’Œ[^>]*ç§èŠ)>([\s\S]*?)(?=<[^>]*(?:ç¾¤èŠ|ç§èŠ|èŠå¤©)|moment_start|$)/g,
                    // æ–°å¢ï¼šæ”¯æŒ<ç§èŠ:è§’è‰²å>æ ¼å¼
                    /<(ç§èŠ:[^>]+)>([\s\S]*?)<\/ç§èŠ:[^>]+>/g,
                    /<(ç§èŠ:[^>]+)>([\s\S]*?)(?=<[^>]*(?:ç¾¤èŠ|ç§èŠ|èŠå¤©)|moment_start|$)/g,
                    // ç„¶ååŒ¹é…"èŠå¤©"æ ¼å¼ï¼ˆä½†æ’é™¤å·²ç»åŒ¹é…è¿‡çš„"ç§èŠ"ï¼‰
                    /<([^>]*å’Œ[^>]*çš„èŠå¤©)>([\s\S]*?)<\/[^>]*å’Œ[^>]*çš„èŠå¤©>/g,
                    /<([^>]*å’Œ[^>]*çš„èŠå¤©)>([\s\S]*?)(?=<[^>]*(?:ç¾¤èŠ|ç§èŠ|èŠå¤©)|moment_start|$)/g,
                    /<([^>]*å’Œ[^>]*èŠå¤©)>([\s\S]*?)(?=<[^>]*(?:ç¾¤èŠ|ç§èŠ|èŠå¤©)|moment_start|$)/g,
                    // å‘åå…¼å®¹ï¼šé€šç”¨èŠå¤©æ ¼å¼
                    /<([^>]*èŠå¤©[^>]*)>([\s\S]*?)<\/[^>]*èŠå¤©[^>]*>/g,
                    /<([^>]*èŠå¤©[^>]*)>([\s\S]*?)(?=<[^>]*(?:ç¾¤èŠ|ç§èŠ|èŠå¤©)|moment_start|$)/g
                ];
                
                let privateMatches = [];
                for (const pattern of privatePatterns) {
                    const matches = [...content.matchAll(pattern)];
                    if (matches.length > 0) {
                        privateMatches = matches;
                        console.log(`âœ… æ‰¾åˆ°ç§èŠä¿¡æ¯ (ä½¿ç”¨æ¨¡å¼: ${pattern.source.substring(0, 50)}...)`, matches.length);
                        break;
                    }
                }
                
                if (privateMatches.length > 0) {
                    extractedInfo.hasValidInfo = true;
                    
                    // *** ä¿®å¤ï¼šæ”¯æŒå¤šç§èŠå¤„ç† ***
                    console.log(`ğŸ” å‘ç° ${privateMatches.length} ä¸ªç§èŠåŒ¹é…`);
                    
                    for (const match of privateMatches) {
                        const chatName = match[1];
                        console.log(`ç§èŠå¯¹è±¡: ${chatName}`);
                        
                        // æå–ç§èŠä¸­çš„æ¶ˆæ¯
                        const messages = QQ_ExtractMessagesFromContent(match[2]);
                        console.log(`ä»ç§èŠ ${chatName} æå–åˆ° ${messages.length} æ¡æ¶ˆæ¯`);
                        
                        // *** æ–°é€»è¾‘ï¼šåˆ†åˆ«å­˜å‚¨æ¯ä¸ªç§èŠ ***
                        extractedInfo.privateChats[chatName] = messages;
                        
                        // *** å…¼å®¹æ€§ï¼šåŒæ—¶ä¿ç•™æ—§æ ¼å¼ ***
                        extractedInfo.privateMessages = extractedInfo.privateMessages.concat(messages);
                        
                        // *** ä¸ºå…¼å®¹æ€§è®¾ç½®chatNameï¼ˆä½¿ç”¨ç¬¬ä¸€ä¸ªç§èŠï¼‰ ***
                        if (!extractedInfo.chatName) {
                            extractedInfo.chatName = chatName;
                        }
                    }
                    
                    // *** è®¾ç½®æ­£ç¡®çš„chatType ***
                    const privateChatsCount = Object.keys(extractedInfo.privateChats).length;
                    if (privateChatsCount > 1) {
                        extractedInfo.chatType = 'mixed'; // å¤šä¸ªç§èŠ
                    } else if (!extractedInfo.chatType) {
                        extractedInfo.chatType = 'private'; // å•ä¸ªç§èŠ
                    }
                    
                    console.log(`âœ… å¤„ç†å®Œæˆ ${privateChatsCount} ä¸ªç§èŠï¼Œæ€»å…± ${extractedInfo.privateMessages.length} æ¡æ¶ˆæ¯`);
                    console.log(`ğŸ” ç§èŠåˆ—è¡¨:`, Object.keys(extractedInfo.privateChats));
                }
                
                // 3. æå–åŠ¨æ€å†…å®¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const dynamicMatches = content.match(/moment_start([\s\S]*?)moment_end/g);
                if (dynamicMatches && dynamicMatches.length > 0) {
                    console.log("âœ… æ‰¾åˆ°åŠ¨æ€ä¿¡æ¯", dynamicMatches.length);
                    extractedInfo.hasValidInfo = true;
                    for (const match of dynamicMatches) {
                        const dynamicContent = match.replace(/moment_start|moment_end/g, '').trim();
                        if (dynamicContent) {
                            extractedInfo.dynamics.push(dynamicContent);
                        }
                    }
                    console.log(`æå–åˆ° ${extractedInfo.dynamics.length} æ¡åŠ¨æ€`);
                }
                
                // 4. ä¸å†åˆå¹¶ç§èŠå’Œç¾¤èŠæ¶ˆæ¯ï¼Œä¿æŒåˆ†ç¦»ä»¥ä¾¿æ­£ç¡®å¤„ç†
                console.log(`ç¾¤èŠæ¶ˆæ¯æ•°: ${extractedInfo.messages.length}, ç§èŠæ¶ˆæ¯æ•°: ${extractedInfo.privateMessages.length}`);
                
                // 5. å¦‚æœchatInfoä¸ºç©ºï¼Œæ ¹æ®æå–çš„ä¿¡æ¯è®¾ç½®
                if (!extractedInfo.chatInfo && extractedInfo.hasValidInfo) {
                    if (extractedInfo.chatType === 'group' && extractedInfo.chatName) {
                        extractedInfo.chatInfo = `ç¾¤èŠï¼š${extractedInfo.chatName}`;
                    } else if (extractedInfo.chatType === 'private' && extractedInfo.chatName) {
                        extractedInfo.chatInfo = extractedInfo.chatName;
                    }
                }
                
                console.log("æå–ç»“æœ:", extractedInfo);
                return extractedInfo;
            }
            

            
            /**
             * ä»å†…å®¹ä¸­æå–æ¶ˆæ¯æ ¼å¼
             * @param {string} content - èŠå¤©å†…å®¹
             * @returns {Array} æ¶ˆæ¯æ•°ç»„
             */
            function QQ_ExtractMessagesFromContent(content) {
                const messages = [];
                
                // å…ˆæ¸…ç†å†…å®¹ï¼Œç§»é™¤HTMLæ³¨é‡Šã€åµŒå¥—æ ‡ç­¾å’Œå¤šä½™çš„ç©ºç™½
                content = QQ_CleanNestedTags(content);
                
                // åŒ¹é…å„ç§å¯èƒ½çš„æ¶ˆæ¯æ ¼å¼
                const patterns = [
                    // ä¿®å¤ï¼šæ”¯æŒé•¿æ¨ªçº¿æ ¼å¼ è§’è‰²åâ€”æ¶ˆæ¯å†…å®¹â€”æ—¶é—´
                    /([^â€”\n]+)â€”(.+?)â€”(\d{1,2}:\s*\d{2})/gs,
                    // ä¿®å¤ï¼šæ”¯æŒåŒæ¨ªçº¿æ ¼å¼ è§’è‰²å--æ¶ˆæ¯å†…å®¹--æ—¶é—´
                    /([^-\n]+)--(.+?)--(\d{1,2}:\s*\d{2})/gs,
                    // æ ‡å‡†æ ¼å¼: è§’è‰²å--æ—¶é—´--æ¶ˆæ¯å†…å®¹
                    /([^-\n]+)--(\d{2}:\d{2})--(.+?)(?=\n[^-\n]+--\d{2}:\d{2}--|\n*$)/gs,
                    // ç®€åŒ–æ ¼å¼: è§’è‰²å: æ¶ˆæ¯å†…å®¹
                    /([^:\n]+):\s*(.+?)(?=\n[^:\n]+:|\n*$)/gs,
                    // æ›´æ¾æ•£çš„æ ¼å¼åŒ¹é…
                    /(.+?)è¯´[ï¼š:]\s*(.+?)(?=\n.+?è¯´[ï¼š:]|\n*$)/gs,
                    // æ–°å¢ï¼šåŸºäºæ¢è¡Œçš„ç®€å•æ ¼å¼åŒ¹é…
                    /([^\n]+)\n([^\n]+)(?=\n[^\n]+\n|$)/gs,
                    // æ–°å¢ï¼šç›´æ¥æ–‡æœ¬æ ¼å¼ï¼ˆæ²¡æœ‰è§’è‰²åçš„æƒ…å†µï¼‰
                    /^(.+)$/gm
                ];
                
                console.log('å‡†å¤‡æå–æ¶ˆæ¯çš„å†…å®¹:', content.substring(0, 200) + '...');
                
                for (const pattern of patterns) {
                    const matches = [...content.matchAll(pattern)];
                    if (matches.length > 0) {
                        console.log(`ä½¿ç”¨æ¨¡å¼åŒ¹é…åˆ° ${matches.length} æ¡æ¶ˆæ¯: ${pattern.source.substring(0, 50)}...`);
                        
                        for (const match of matches) {
                            let name, time, msg;
                            
                            if (pattern.source.includes('â€”') && match.length === 4) {
                                // æ–°æ ¼å¼: è§’è‰²åâ€”æ¶ˆæ¯å†…å®¹â€”æ—¶é—´
                                name = match[1].trim();
                                msg = match[2].trim();
                                time = match[3].trim();
                            } else if (pattern.source.includes('--') && match.length === 4) {
                                // æ–°æ ¼å¼: è§’è‰²å--æ¶ˆæ¯å†…å®¹--æ—¶é—´
                                name = match[1].trim();
                                msg = match[2].trim();
                                time = match[3].trim();
                            } else if (pattern.source.includes('--')) {
                                // æ ‡å‡†æ ¼å¼: è§’è‰²å--æ—¶é—´--æ¶ˆæ¯å†…å®¹
                                name = match[1].trim();
                                time = match[2].trim();
                                msg = match[3].trim();
                            } else if (pattern.source.includes(':')) {
                                // å†’å·æ ¼å¼: è§’è‰²å: æ¶ˆæ¯å†…å®¹
                                name = match[1].trim();
                                time = new Date().toLocaleTimeString('zh-CN', {hour12: false, hour: '2-digit', minute: '2-digit'});
                                msg = match[2].trim();
                            } else if (pattern.source.includes('è¯´')) {
                                // è¯´è¯æ ¼å¼: è§’è‰²åè¯´: å†…å®¹
                                name = match[1].trim();
                                time = new Date().toLocaleTimeString('zh-CN', {hour12: false, hour: '2-digit', minute: '2-digit'});
                                msg = match[2].trim();
                            } else if (match.length === 3) {
                                // ä¸¤è¡Œæ ¼å¼ï¼šç¬¬ä¸€è¡Œæ˜¯è§’è‰²ï¼Œç¬¬äºŒè¡Œæ˜¯å†…å®¹
                                name = match[1].trim();
                                time = new Date().toLocaleTimeString('zh-CN', {hour12: false, hour: '2-digit', minute: '2-digit'});
                                msg = match[2].trim();
                            } else {
                                // ç›´æ¥æ–‡æœ¬æ ¼å¼
                                name = 'æœªçŸ¥è§’è‰²';
                                time = new Date().toLocaleTimeString('zh-CN', {hour12: false, hour: '2-digit', minute: '2-digit'});
                                msg = match[1].trim();
                            }
                            
                            // éªŒè¯æå–çš„å†…å®¹å¹¶è½¬æ¢ä¸ºQQ_Msg_ParseæœŸå¾…çš„å­—ç¬¦ä¸²æ ¼å¼
                            if (name && msg && msg.length > 0 && msg.length < 1000) {
                                // è½¬æ¢ä¸ºæ ‡å‡†çš„æ¶ˆæ¯å­—ç¬¦ä¸²æ ¼å¼: è§’è‰²å--æ—¶é—´--æ¶ˆæ¯å†…å®¹
                                const messageString = `${name}--${time}--${msg}`;
                                messages.push(messageString);
                                console.log(`æå–æ¶ˆæ¯ - ${name}: ${msg.substring(0, 50)}${msg.length > 50 ? '...' : ''}`);
                            }
                        }
                        
                        if (messages.length > 0) {
                            break; // æ‰¾åˆ°æœ‰æ•ˆæ¶ˆæ¯å°±åœæ­¢
                        }
                    }
                }
                
                console.log(`æ¶ˆæ¯æå–å®Œæˆï¼Œå…±æå–åˆ° ${messages.length} æ¡æ¶ˆæ¯`);
                return messages;
            }
            
            /**
             * å°†æå–çš„ä¿¡æ¯è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼
             * @param {Object} extractedInfo - æå–çš„ä¿¡æ¯
             * @returns {Object|null} æ ‡å‡†æ ¼å¼æ•°æ®
             */
            function QQ_ConvertExtractedToStandard(extractedInfo) {
                if (!extractedInfo.hasValidInfo) return null;
                
                const standardData = { ç§èŠ: {}, ç¾¤èŠ: {} };
                
                // *** ä¿®å¤ï¼šå¤„ç†å¤šç¾¤èŠæ¶ˆæ¯ ***
                // ä¼˜å…ˆå¤„ç†æ–°çš„groupChatsç»“æ„ï¼Œæ”¯æŒå¤šä¸ªç‹¬ç«‹ç¾¤èŠ
                if (extractedInfo.groupChats && Object.keys(extractedInfo.groupChats).length > 0) {
                    console.log(`ğŸ” å¤„ç†å¤šç¾¤èŠç»“æ„: ${Object.keys(extractedInfo.groupChats).length} ä¸ªç¾¤èŠ`);
                    
                    for (const [groupName, groupData] of Object.entries(extractedInfo.groupChats)) {
                        standardData.ç¾¤èŠ[groupName] = {
                            msgs: groupData.msgs,
                            members: groupData.members || []
                        };
                        console.log(`âœ… è½¬æ¢ç¾¤èŠæ¶ˆæ¯: ${groupName} (${groupData.msgs.length}æ¡)`);
                    }
                } 
                // *** å…¼å®¹æ€§ï¼šå¤„ç†æ—§ç‰ˆmessagesæ ¼å¼ ***
                else if (extractedInfo.chatType === 'group' && extractedInfo.messages && extractedInfo.messages.length > 0) {
                    console.log(`ğŸ” å¤„ç†æ—§ç‰ˆç¾¤èŠæ ¼å¼: ${extractedInfo.messages.length} æ¡æ¶ˆæ¯`);
                    
                    const groupChatKey = extractedInfo.chatName;
                    standardData.ç¾¤èŠ[groupChatKey] = {
                        msgs: extractedInfo.messages,
                        members: extractedInfo.members || []
                    };
                    console.log(`âœ… è½¬æ¢ç¾¤èŠæ¶ˆæ¯: ${groupChatKey} (${extractedInfo.messages.length}æ¡)`);
                }
                
                // *** ä¿®å¤ï¼šå¤„ç†å¤šç§èŠæ¶ˆæ¯ ***
                // ä¼˜å…ˆå¤„ç†æ–°çš„privateChatsç»“æ„ï¼Œæ”¯æŒå¤šä¸ªç‹¬ç«‹ç§èŠ
                if (extractedInfo.privateChats && Object.keys(extractedInfo.privateChats).length > 0) {
                    console.log(`ğŸ” å¤„ç†å¤šç§èŠç»“æ„: ${Object.keys(extractedInfo.privateChats).length} ä¸ªç§èŠ`);
                    
                    for (const [originalChatName, messages] of Object.entries(extractedInfo.privateChats)) {
                        // æ ‡å‡†åŒ–æ¯ä¸ªç§èŠçš„é”®å
                        let privateChatKey = originalChatName;
                        
                        // å½»åº•æ ‡å‡†åŒ–å¤„ç†ï¼šç¡®ä¿æ‰€æœ‰ç§èŠéƒ½ç»Ÿä¸€ä¸º"èŠå¤©"æ ¼å¼
                        if (privateChatKey.includes('ç§èŠ')) {
                            // å°†"ç§èŠ"æ›¿æ¢ä¸º"èŠå¤©"
                            privateChatKey = privateChatKey.replace(/ç§èŠ/g, 'èŠå¤©');
                        } else if (!privateChatKey.includes('èŠå¤©')) {
                            // å¦‚æœæ—¢ä¸åŒ…å«"ç§èŠ"ä¹Ÿä¸åŒ…å«"èŠå¤©"ï¼Œæ·»åŠ "èŠå¤©"
                            privateChatKey = privateChatKey.includes('çš„') ? privateChatKey.replace(/çš„$/g, 'çš„èŠå¤©') : privateChatKey + 'çš„èŠå¤©';
                        }
                        
                        // æœ€ç»ˆç¡®ä¿æ ¼å¼æ­£ç¡®ï¼šåº”è¯¥æ˜¯"XXå’ŒYYçš„èŠå¤©"
                        if (!privateChatKey.includes('å’Œ') || !privateChatKey.includes('çš„èŠå¤©')) {
                            console.warn(`âš ï¸ ç§èŠé”®åæ ¼å¼å¼‚å¸¸: "${privateChatKey}"ï¼Œä½¿ç”¨é»˜è®¤æ ¼å¼`);
                            privateChatKey = `${originalChatName}çš„èŠå¤©`;
                        }
                        
                        standardData.ç§èŠ[privateChatKey] = messages;
                        console.log(`âœ… è½¬æ¢ç§èŠæ¶ˆæ¯: ${privateChatKey} (${messages.length}æ¡)`);
                        console.log(`ğŸ”§ ç§èŠé”®åæ ‡å‡†åŒ–: "${originalChatName}" â†’ "${privateChatKey}"`);
                    }
                } 
                // *** å…¼å®¹æ€§ï¼šå¤„ç†æ—§ç‰ˆprivateMessagesæ ¼å¼ ***
                else if (extractedInfo.privateMessages && extractedInfo.privateMessages.length > 0) {
                    console.log(`ğŸ” å¤„ç†æ—§ç‰ˆç§èŠæ ¼å¼: ${extractedInfo.privateMessages.length} æ¡æ¶ˆæ¯`);
                    
                    // è½¬æ¢ç§èŠæ¶ˆæ¯ - ç»Ÿä¸€æ ¼å¼ä¸º "XXå’ŒYYçš„èŠå¤©"ï¼Œå½»åº•é¿å…é‡å¤åˆ›å»ºç¾¤èŠ
                    let privateChatKey = extractedInfo.chatName;
                    if (extractedInfo.chatType === 'private') {
                        // å½»åº•æ ‡å‡†åŒ–å¤„ç†ï¼šç¡®ä¿æ‰€æœ‰ç§èŠéƒ½ç»Ÿä¸€ä¸º"èŠå¤©"æ ¼å¼
                        if (privateChatKey.includes('ç§èŠ')) {
                            // å°†"ç§èŠ"æ›¿æ¢ä¸º"èŠå¤©"
                            privateChatKey = privateChatKey.replace(/ç§èŠ/g, 'èŠå¤©');
                        } else if (!privateChatKey.includes('èŠå¤©')) {
                            // å¦‚æœæ—¢ä¸åŒ…å«"ç§èŠ"ä¹Ÿä¸åŒ…å«"èŠå¤©"ï¼Œæ·»åŠ "èŠå¤©"
                            privateChatKey = privateChatKey.includes('çš„') ? privateChatKey.replace(/çš„$/g, 'çš„èŠå¤©') : privateChatKey + 'çš„èŠå¤©';
                        }
                        // æœ€ç»ˆç¡®ä¿æ ¼å¼æ­£ç¡®ï¼šåº”è¯¥æ˜¯"XXå’ŒYYçš„èŠå¤©"
                        if (!privateChatKey.includes('å’Œ') || !privateChatKey.includes('çš„èŠå¤©')) {
                            console.warn(`âš ï¸ ç§èŠé”®åæ ¼å¼å¼‚å¸¸: "${privateChatKey}"ï¼Œä½¿ç”¨é»˜è®¤æ ¼å¼`);
                            privateChatKey = 'ç”¨æˆ·å’Œè§’è‰²çš„èŠå¤©';
                        }
                    } else {
                        // å¦‚æœæ˜¯æ··åˆç±»å‹ï¼Œç”Ÿæˆé»˜è®¤ç§èŠé”®å
                        privateChatKey = 'private_chat';
                    }
                    
                    standardData.ç§èŠ[privateChatKey] = extractedInfo.privateMessages;
                    console.log(`âœ… è½¬æ¢ç§èŠæ¶ˆæ¯: ${privateChatKey} (${extractedInfo.privateMessages.length}æ¡)`);
                    console.log(`ğŸ”§ ç§èŠé”®åæ ‡å‡†åŒ–: "${extractedInfo.chatName}" â†’ "${privateChatKey}"`);
                }
                
                // æ¸…ç†ç©ºçš„åˆ†ç±»
                if (Object.keys(standardData.ç§èŠ).length === 0) {
                    delete standardData.ç§èŠ;
                }
                if (Object.keys(standardData.ç¾¤èŠ).length === 0) {
                    delete standardData.ç¾¤èŠ;
                }
                
                console.log(`âœ… è½¬æ¢å®Œæˆï¼Œç§èŠ: ${standardData.ç§èŠ ? Object.keys(standardData.ç§èŠ).length : 0}ä¸ªï¼Œç¾¤èŠ: ${standardData.ç¾¤èŠ ? Object.keys(standardData.ç¾¤èŠ).length : 0}ä¸ª`);
                
                return (standardData.ç§èŠ || standardData.ç¾¤èŠ) ? standardData : null;
            }

            // *** è¿‡æœŸæµ‹è¯•å‡½æ•°å·²æ¸…ç† ***
            

            

            

            




            /**
             * æµ‹è¯•æ ¼å¼å®¹é”™ä¸ä¿¡æ¯æå–ä¿®å¤
             */


            /**
             * *** å¢å¼ºç‰ˆï¼šæ™ºèƒ½æå–å’Œæ¸…ç†contentæ ‡ç­¾å†…å®¹ ***
             * èƒ½å¤Ÿå¤„ç†åµŒå¥—åœ¨å…¶ä»–æ ‡ç­¾ä¸­çš„contentå†…å®¹ï¼Œç¡®ä¿ä¸ä¼šè¯¯åˆ æœ‰æ•ˆä¿¡æ¯
             * @param {string} content - è¾“å…¥å†…å®¹
             * @returns {string} æ¸…ç†åçš„å†…å®¹
             */
            function QQ_CleanContentTags(content) {
                if (!content || typeof content !== 'string') {
                    return content;
                }
                
                console.log('ğŸ” å¼€å§‹æ™ºèƒ½æå–contentå†…å®¹ï¼ŒåŸå§‹å†…å®¹é•¿åº¦:', content.length);
                
                // *** ç¬¬ä¸€æ­¥ï¼šæ™ºèƒ½æå–contentå†…å®¹ï¼ˆåŒ…æ‹¬åµŒå¥—æƒ…å†µï¼‰ ***
                let extractedContent = QQ_ExtractNestedContentTags(content);
                
                if (!extractedContent) {
                    console.log('âŒ æ²¡æœ‰æ‰¾åˆ°contentæ ‡ç­¾ï¼Œè¿”å›åŸå†…å®¹');
                        return content;
                    }
                
                console.log('âœ… æˆåŠŸæå–contentå†…å®¹ï¼Œé•¿åº¦:', extractedContent.length);
                
                // *** ç¬¬äºŒæ­¥ï¼šæ¸…ç†æå–å‡ºæ¥çš„å†…å®¹ä¸­çš„ç³»ç»Ÿæ ‡ç­¾ ***
                let cleanContent = QQ_CleanSystemTags(extractedContent);
                
                // *** ç¬¬ä¸‰æ­¥ï¼šæœ€ç»ˆæ¸…ç†å¤šä½™çš„ç©ºç™½å’Œæ¢è¡Œ ***
                cleanContent = cleanContent.replace(/\n\s*\n/g, '\n').trim();
                
                console.log('ğŸ‰ contentæ ‡ç­¾æ¸…ç†å®Œæˆï¼Œæœ€ç»ˆå†…å®¹é•¿åº¦:', cleanContent.length);
                console.log('æœ€ç»ˆå†…å®¹:', cleanContent);
                
                return cleanContent;
            }

            /**
             * *** å¢å¼ºç‰ˆï¼šæ™ºèƒ½æå–åµŒå¥—çš„contentæ ‡ç­¾å†…å®¹ ***
             * èƒ½å¤Ÿå¤„ç†è¢«å…¶ä»–æ ‡ç­¾åŒ…è£¹çš„contentæ ‡ç­¾ï¼Œä»¥åŠä¸å®Œæ•´çš„contentæ ‡ç­¾
             * @param {string} content - è¾“å…¥å†…å®¹
             * @returns {string|null} æå–çš„contentå†…å®¹ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°è¿”å›null
             */
            function QQ_ExtractNestedContentTags(content) {
                // *** é¢„å¤„ç†ï¼šå…ˆç§»é™¤thinkingæ ‡ç­¾å†…å®¹ï¼Œé¿å…è¯¯è¯»thinkingæ ‡ç­¾ä¸­çš„contentå¼•ç”¨ ***
                let processedContent = content.replace(/<thinking>[\s\S]*?<\/thinking>/gi, '');
                console.log('ğŸ§  å·²ç§»é™¤thinkingæ ‡ç­¾å†…å®¹ï¼Œé¿å…è¯¯è¯»contentå¼•ç”¨');
                
                // æ–¹æ³•1ï¼šç›´æ¥åŒ¹é…å®Œæ•´çš„contentæ ‡ç­¾ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
                let match = processedContent.match(/<content>([\s\S]*?)<\/content>/i);
                if (match) {
                    console.log('ğŸ“ æ‰¾åˆ°å®Œæ•´çš„contentæ ‡ç­¾');
                    return match[1];
                }
                
                // æ–¹æ³•2ï¼šå¤„ç†ä¸å®Œæ•´çš„contentæ ‡ç­¾ï¼ˆ<content>å¼€å¤´ï¼Œä½†åœ¨é‡åˆ°å…¶ä»–æ ‡ç­¾å‰ç»“æŸï¼‰
                // è¿™ç§æƒ…å†µéœ€è¦ç‰¹åˆ«å°å¿ƒï¼Œè¦åœ¨é‡åˆ°ç³»ç»Ÿæ ‡ç­¾å‰åœæ­¢æå–
                match = processedContent.match(/<content>([\s\S]*?)(?=<(?:disclaimer|Content_Target|Creative_Status|Review_Exemption|Security_Bypass|Ethics_Removal|Violence_Restriction|Content_Will_Autonomy|thinking|consider|tableThink)[^>]*>|$)/i);
                if (match) {
                    console.log('ğŸ“ æ‰¾åˆ°ä¸å®Œæ•´çš„contentæ ‡ç­¾ï¼Œåœ¨ç³»ç»Ÿæ ‡ç­¾å‰åœæ­¢æå–');
                    return match[1];
                }
                
                // æ–¹æ³•3ï¼šå¤„ç†å®Œå…¨ä¸å®Œæ•´çš„contentæ ‡ç­¾ï¼ˆç›´æ¥åˆ°ç»“å°¾ï¼Œä½†éœ€è¦æ¸…ç†ç³»ç»Ÿæ ‡ç­¾ï¼‰
                match = processedContent.match(/<content>([\s\S]*)$/i);
                if (match) {
                    console.log('ğŸ“ æ‰¾åˆ°ä¸å®Œæ•´çš„contentæ ‡ç­¾ï¼Œæå–åˆ°ç»“å°¾å¹¶å‡†å¤‡æ¸…ç†');
                    let extractedContent = match[1];
                    
                    // æ¸…ç†å„ç§AIç³»ç»Ÿæ ‡ç­¾
                    const systemTagsToRemove = [
                        // SillyTavernå’ŒAIç³»ç»Ÿæ ‡ç­¾
                        /<disclaimer>[\s\S]*?<\/disclaimer>/gi,
                        /<Content_Target>[\s\S]*?<\/Content_Target>/gi,
                        /<Creative_Status>[\s\S]*?<\/Creative_Status>/gi,
                        /<Review_Exemption>[\s\S]*?<\/Review_Exemption>/gi,
                        /<Security_Bypass>[\s\S]*?<\/Security_Bypass>/gi,
                        /<Ethics_Removal>[\s\S]*?<\/Ethics_Removal>/gi,
                        /<Violence_Restriction>[\s\S]*?<\/Violence_Restriction>/gi,
                        /<Content_Will_Autonomy>[\s\S]*?<\/Content_Will_Autonomy>/gi,
                        // ä¼ ç»Ÿç³»ç»Ÿæ ‡ç­¾
                        /<thinking>[\s\S]*?<\/thinking>/gi,
                        /<consider>[\s\S]*?<\/consider>/gi,
                        ///<tableThink>[\s\S]*?<\/tableThink>/gi,
                        ///<tableEdit>[\s\S]*?<\/tableEdit>/gi,
                    ];
                    
                    // é€ä¸ªæ¸…ç†ç³»ç»Ÿæ ‡ç­¾
                    for (const tagPattern of systemTagsToRemove) {
                        const beforeLength = extractedContent.length;
                        extractedContent = extractedContent.replace(tagPattern, '');
                        const afterLength = extractedContent.length;
                        if (beforeLength !== afterLength) {
                            console.log(`ğŸ§¹ æ¸…ç†äº†${tagPattern.source}ï¼Œå‡å°‘äº†${beforeLength - afterLength}ä¸ªå­—ç¬¦`);
                        }
                    }
                    
                    // æ¸…ç†æœªé—­åˆçš„ç³»ç»Ÿæ ‡ç­¾
                    const unclosedTags = [
                        /<(?:disclaimer|Content_Target|Creative_Status|Review_Exemption|Security_Bypass|Ethics_Removal|Violence_Restriction|Content_Will_Autonomy|thinking|consider|tableThink|tableEdit)[^>]*>[\s\S]*$/gi
                    ];
                    
                    for (const tagPattern of unclosedTags) {
                        const beforeLength = extractedContent.length;
                        extractedContent = extractedContent.replace(tagPattern, '');
                        const afterLength = extractedContent.length;
                        if (beforeLength !== afterLength) {
                            console.log(`ğŸ§¹ æ¸…ç†äº†æœªé—­åˆçš„ç³»ç»Ÿæ ‡ç­¾ï¼Œå‡å°‘äº†${beforeLength - afterLength}ä¸ªå­—ç¬¦`);
                        }
                    }
                    
                    return extractedContent.trim();
                }
                
                // æ–¹æ³•4ï¼šåœ¨å…¶ä»–æ ‡ç­¾å†…æŸ¥æ‰¾contentæ ‡ç­¾ï¼ˆå¤„ç†åµŒå¥—æƒ…å†µï¼‰
                const nestedPatterns = [
                    // åœ¨tableç›¸å…³æ ‡ç­¾å†…æŸ¥æ‰¾
                    /<table[^>]*>([\s\S]*?)<\/table>/gi,
                    /<tableEdit[^>]*>([\s\S]*?)<\/tableEdit>/gi,
                    /<tableThink[^>]*>([\s\S]*?)<\/tableThink>/gi,
                    // åœ¨divç­‰å…¶ä»–æ ‡ç­¾å†…æŸ¥æ‰¾
                    /<div[^>]*>([\s\S]*?)<\/div>/gi,
                    /<section[^>]*>([\s\S]*?)<\/section>/gi,
                    // åœ¨thinkingç­‰æ ‡ç­¾å†…æŸ¥æ‰¾ï¼ˆè™½ç„¶ä¸å¸¸è§ï¼‰
                    /<thinking[^>]*>([\s\S]*?)<\/thinking>/gi,
                ];
                
                for (const pattern of nestedPatterns) {
                    const matches = [...content.matchAll(pattern)];
                    for (const nestedMatch of matches) {
                        const nestedContent = nestedMatch[1];
                        // åœ¨åµŒå¥—å†…å®¹ä¸­æŸ¥æ‰¾contentæ ‡ç­¾
                        const contentInNested = nestedContent.match(/<content>([\s\S]*?)<\/content>/i);
                        if (contentInNested) {
                            console.log(`ğŸ“ åœ¨${pattern.source}æ ‡ç­¾å†…æ‰¾åˆ°å®Œæ•´çš„contentæ ‡ç­¾`);
                            return contentInNested[1];
                        }
                        
                        // ä¹Ÿæ£€æŸ¥ä¸å®Œæ•´çš„contentæ ‡ç­¾
                        const incompleteInNested = nestedContent.match(/<content>([\s\S]*?)$/i);
                        if (incompleteInNested) {
                            console.log(`ğŸ“ åœ¨${pattern.source}æ ‡ç­¾å†…æ‰¾åˆ°ä¸å®Œæ•´çš„contentæ ‡ç­¾`);
                            return incompleteInNested[1];
                        }
                    }
                }
                
                console.log('âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•contentæ ‡ç­¾ï¼ˆåŒ…æ‹¬åµŒå¥—æƒ…å†µï¼‰');
                return null;
            }

            /**
             * *** æ–°å¢ï¼šæ¸…ç†ç³»ç»Ÿæ ‡ç­¾ä½†ä¿ç•™æœ‰æ•ˆå†…å®¹ ***
             * @param {string} content - è¾“å…¥å†…å®¹
             * @returns {string} æ¸…ç†åçš„å†…å®¹
             */
            function QQ_CleanSystemTags(content) {
                let cleanContent = content;
                
                // æ¸…ç†å„ç§ç³»ç»Ÿæ ‡ç­¾åŠå…¶å†…å®¹
                const systemTagPatterns = [
                    // æ€è€ƒå’Œè€ƒè™‘æ ‡ç­¾
                    /<consider>[\s\S]*?<\/consider>/gi,
                    /<thinking>[\s\S]*?<\/thinking>/gi,
                    // tableç›¸å…³æ ‡ç­¾ï¼ˆä½†è¦å°å¿ƒï¼Œä¸è¦è¯¯åˆ æœ‰æ•ˆçš„tableå†…å®¹ï¼‰
                    /<tableThink>[\s\S]*?<\/tableThink>/gi,
                    /<disclaimer>[\s\S]*?<\/disclaimer>/gi,
                    // HTMLæ³¨é‡Šæ ¼å¼çš„consideræ ‡ç­¾
                    /<!--\s*consider:\s*[\s\S]*?-->/gi,
                    /<!--\s*thinking:\s*[\s\S]*?-->/gi,
                    /<!--[\s\S]*?-->/gi,
                ];
                
                // é€ä¸ªæ¸…ç†ç³»ç»Ÿæ ‡ç­¾
                for (const pattern of systemTagPatterns) {
                    const before = cleanContent.length;
                    cleanContent = cleanContent.replace(pattern, '');
                    const after = cleanContent.length;
                    if (before !== after) {
                        console.log(`ğŸ§¹ æ¸…ç†äº†${pattern.source}æ ‡ç­¾ï¼Œå‡å°‘äº†${before - after}ä¸ªå­—ç¬¦`);
                    }
                }
                
                // æ¸…ç†æœªé—­åˆçš„ç³»ç»Ÿæ ‡ç­¾
                const unclosedPatterns = [
                    /<(?:consider|thinking|tableThink|tableEdit|disclaimer)>[\s\S]*$/gi,
                ];
                
                for (const pattern of unclosedPatterns) {
                    const before = cleanContent.length;
                    cleanContent = cleanContent.replace(pattern, '');
                    const after = cleanContent.length;
                    if (before !== after) {
                        console.log(`ğŸ§¹ æ¸…ç†äº†æœªé—­åˆçš„ç³»ç»Ÿæ ‡ç­¾ï¼Œå‡å°‘äº†${before - after}ä¸ªå­—ç¬¦`);
                    }
                }
                
                return cleanContent;
            }


            /**
             * *** ä¸¥æ ¼ç‰ˆï¼šäº’åŠ¨å†…å®¹æ£€æµ‹ï¼ˆä¸‰ç§æƒ…å†µç²¾ç¡®æ§åˆ¶ï¼‰ ***
             * 
             * ã€ä¸¥æ ¼çš„ä¸‰ç§è§¦å‘æƒ…å†µã€‘ï¼š
             * 1. AIæ²¡æœ‰å›å¤çº¿ä¸Šæ ¼å¼æ—¶ï¼ˆæƒŠå–œæœºåˆ¶ï¼‰ï¼š
             *    - å¿…é¡»åœ¨contentæ ‡ç­¾ä¸­æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœ‰æ•ˆçš„ç§èŠã€ç¾¤èŠã€åŠ¨æ€ç­‰æ ‡ç­¾
             *    - ä¸”contentå†…å®¹ç¬¦åˆäº’åŠ¨ç‰¹å¾
             * 
             * 2. ç”¨æˆ·ä¸»åŠ¨è¾“å…¥&&ç‰¹æ®Šç¬¦å·ï¼š
             *    - AIå›å¤ä¸ºï¼šå…ˆè§’è‰²ç®€çŸ­å›å¤ï¼ˆå¦‚"å¥½çš„ï¼æˆ‘è¿‡æ¥"ï¼‰+ contentæ ‡ç­¾åŒ…è£¹çš„äº’åŠ¨å†…å®¹
             *    - ç›´æ¥è¾“å‡ºåˆ°äº’åŠ¨ç©ºé—´
             * 
             * 3. ç”¨æˆ·å¼€å¯å…³é”®è¯æ£€æµ‹ä¸”åŒ¹é…åˆ°å…³é”®è¯ï¼š
             *    - é€»è¾‘ä¸&&ç‰¹æ®Šç¬¦å·å®Œå…¨ç›¸åŒ
             * 
             * ã€ç»å¯¹ä¸è§¦å‘çš„æƒ…å†µã€‘ï¼šé™¤ä¸Šè¿°ä¸‰ç§æƒ…å†µå¤–çš„ä»»ä½•å…¶ä»–æƒ…å†µ
             * 
             * @param {string} content - AIå›å¤çš„å†…å®¹
             * @param {boolean} isNoFormatResponse - æ˜¯å¦ä¸ºAIæ²¡æœ‰å›å¤çº¿ä¸Šæ ¼å¼çš„æƒ…å†µ
             * @returns {boolean} æ˜¯å¦ä¸ºäº’åŠ¨å†…å®¹
             */
            function QQ_IsInteractiveContent(content, isNoFormatResponse = false) {
                console.log('ğŸ” å¼€å§‹ä¸¥æ ¼çš„äº’åŠ¨å†…å®¹æ£€æµ‹...');
                console.log('ğŸ” æ£€æµ‹å‚æ•° - isNoFormatResponse:', isNoFormatResponse, 'QQ_UserTriggeredInteractive:', QQ_UserTriggeredInteractive);
                
                // *** æƒ…å†µ2å’Œ3ï¼šç”¨æˆ·ä¸»åŠ¨è§¦å‘ï¼ˆ&&ç¬¦å·æˆ–å…³é”®è¯åŒ¹é…ï¼‰ ***
                if (QQ_UserTriggeredInteractive && QQ_HasContentTag(content)) {
                    console.log('ğŸ¯ ã€æƒ…å†µ2/3ã€‘ç”¨æˆ·ä¸»åŠ¨è§¦å‘äº’åŠ¨ï¼ˆ&&æˆ–å…³é”®è¯ï¼‰ä¸”AIå›å¤åŒ…å«contentæ ‡ç­¾');
                    
                    // æå–contentå†…å®¹
                    const contentText = QQ_CleanContentTags(content);
                    if (!contentText || contentText.trim().length === 0) {
                        console.log('âŒ contentæ ‡ç­¾ä¸ºç©ºï¼Œä¸ç¬¦åˆäº’åŠ¨å†…å®¹æ ‡å‡†');
                        return false;
                    }
                    
                    console.log('âœ… ç”¨æˆ·ä¸»åŠ¨è§¦å‘ä¸”contentæœ‰æ•ˆï¼Œç›´æ¥è¯†åˆ«ä¸ºäº’åŠ¨å†…å®¹');
                    return true;
                }
                
                // *** æƒ…å†µ1ï¼šAIæ²¡æœ‰å›å¤çº¿ä¸Šæ ¼å¼ï¼ˆæƒŠå–œæœºåˆ¶ï¼‰ ***
                if (isNoFormatResponse && QQ_HasContentTag(content)) {
                    console.log('ğŸ” ã€æƒ…å†µ1ã€‘AIæ²¡æœ‰å›å¤çº¿ä¸Šæ ¼å¼ï¼Œæ£€æŸ¥contentæ ‡ç­¾ä¸­æ˜¯å¦åŒ…å«èŠå¤©æ ‡ç­¾...');
                    
                    // æå–å¹¶æ¸…ç†contentå†…å®¹
                    const contentText = QQ_CleanContentTags(content);
                    if (!contentText || contentText.trim().length === 0) {
                        console.log('âŒ contentæ ‡ç­¾ä¸ºç©ºï¼Œä¸ç¬¦åˆäº’åŠ¨å†…å®¹æ ‡å‡†');
                        return false;
                    }
                    
                    console.log('ğŸ“ æå–çš„contentå†…å®¹é•¿åº¦:', contentText.length);
                    
                    // ä¸¥æ ¼æ£€æŸ¥contentæ ‡ç­¾å†…æ˜¯å¦åŒ…å«ä»»ä½•èŠå¤©æ ¼å¼æ ‡ç­¾
                    const chatTagPatterns = [
                        // ç¾¤èŠæ ‡ç­¾
                        /<ç¾¤èŠ[ï¼š:][^>]+>/g,
                        /<ç¾¤èŠ[^>]*>/g,
                        // ç§èŠæ ‡ç­¾ - æ”¯æŒæ‰€æœ‰æ ¼å¼
                        /<[^>]*å’Œ[^>]*çš„?(?:ç§èŠ|èŠå¤©)[^>]*>/g,
                        /<[^>]*å’Œ[^>]*(?:ç§èŠ|èŠå¤©)[^>]*>/g,
                        /<[^>]*(?:ç§èŠ|èŠå¤©)[^>]*>/g,  // æ–°å¢ï¼šæ”¯æŒ<ç§èŠ:è§’è‰²å>æ ¼å¼
                        /<[^>]*èŠå¤©[^>]*>/g,           // å‘åå…¼å®¹ï¼šçº¯èŠå¤©æ ¼å¼
                        // åŠ¨æ€æ ‡ç­¾
                        /moment_start|moment_end/g,
                        // å…¶ä»–æ¶ˆæ¯æ ¼å¼æ ‡ç­¾
                        /msg_start|msg_end/g,
                        // QQç©ºé—´ç›¸å…³æ ‡ç­¾
                        /<QQç©ºé—´[^>]*>/g,
                        // ä½¿ç”¨è€…ç›¸å…³æ ‡ç­¾
                        /<ä½¿ç”¨è€…[^>]*>/g,
                        // MiPhoneæ ¼å¼æ ‡ç­¾
                        /MiPhone_JSON_START|MiPhone_JSON_END|MiPhone_start|MiPhone_end/g,
                    ];
                    
                    let hasAnyFormatTag = false;
                    for (const pattern of chatTagPatterns) {
                        if (pattern.test(contentText)) {
                            hasAnyFormatTag = true;
                            console.log(`âœ… åœ¨contentä¸­å‘ç°èŠå¤©æ ¼å¼æ ‡ç­¾: ${pattern.source}`);
                            break;
                        }
                    }
                    
                    if (hasAnyFormatTag) {
                        // *** æ”¹è¿›ï¼šæ£€æŸ¥æ˜¯å¦åŒ…å«æœ‰æ•ˆçš„èŠå¤©å†…å®¹ ***
                        const hasValidChatContent = 
                            /<[^>]*(?:ç§èŠ|ç¾¤èŠ|èŠå¤©)[^>]*>[\s\S]*?[^-\s]+--[^-\s]+/.test(contentText) || // æœ‰æ•ˆçš„èŠå¤©æ ¼å¼(ç§èŠ/ç¾¤èŠ/èŠå¤©)
                            /MiPhone_start[\s\S]*?<[^>]*(?:ç§èŠ|ç¾¤èŠ|èŠå¤©)[^>]*>/.test(contentText) ||     // æœ‰æ•ˆçš„MiPhoneæ ¼å¼
                            /<[^>]*[ç§ç¾¤]èŠ[^>]*>[\s\S]*?[^-\s]+--[^-\s]+/.test(contentText) ||        // å‘åå…¼å®¹ï¼š[ç§ç¾¤]èŠæ ¼å¼
                            /<[^>]*èŠå¤©[^>]*>[\s\S]*?[^-\s]+--[^-\s]+/.test(contentText) ||             // å‘åå…¼å®¹ï¼šèŠå¤©æ ¼å¼
                            /MiPhone_start[\s\S]*?moment_start[\s\S]*?moment_end[\s\S]*?MiPhone_end/.test(contentText); // å®Œæ•´MiPhoneæ ¼å¼
                        
                        if (hasValidChatContent) {
                            console.log('âŒ contentä¸­åŒ…å«æœ‰æ•ˆèŠå¤©å†…å®¹ï¼Œåº”é€šè¿‡æ ¼å¼æå–å¤„ç†ï¼Œä¸æ˜¯äº’åŠ¨å†…å®¹');
                            return false;
                        } else {
                            console.log('âš ï¸ contentä¸­åŒ…å«èŠå¤©æ ‡ç­¾ä½†æ— æœ‰æ•ˆå†…å®¹ï¼Œå¿½ç•¥æ ‡ç­¾ç»§ç»­å¤„ç†äº’åŠ¨å†…å®¹');
                        }
                    }
                    
                    console.log('ğŸ‰ contentä¸­æ²¡æœ‰èŠå¤©æ ‡ç­¾ï¼ŒéªŒè¯æ˜¯å¦ä¸ºæœ‰æ•ˆäº’åŠ¨å†…å®¹...');
                    
                    // éªŒè¯äº’åŠ¨å†…å®¹ç‰¹å¾
                    const isValidInteractiveContent = QQ_ValidateInteractiveContentFeatures(contentText);
                    if (isValidInteractiveContent) {
                        console.log('âœ… ã€æƒ…å†µ1ã€‘ç¡®è®¤ä¸ºæœ‰æ•ˆçš„äº’åŠ¨å†…å®¹');
                        return true;
                    } else {
                        console.log('âŒ ã€æƒ…å†µ1ã€‘ä¸ç¬¦åˆäº’åŠ¨å†…å®¹ç‰¹å¾');
                        return false;
                    }
                }
                
                // *** ç»å¯¹ä¸è§¦å‘çš„æƒ…å†µ ***
                console.log('âŒ ä¸ç¬¦åˆä»»ä½•è§¦å‘æ¡ä»¶ï¼Œä¸æ˜¯äº’åŠ¨å†…å®¹');
                console.log('âŒ æ£€æŸ¥ç»“æœ:');
                console.log('   - ç”¨æˆ·ä¸»åŠ¨è§¦å‘:', QQ_UserTriggeredInteractive);
                console.log('   - AIæ²¡æœ‰å›å¤æ ¼å¼:', isNoFormatResponse);
                console.log('   - åŒ…å«contentæ ‡ç­¾:', QQ_HasContentTag(content));
                
                return false;
            }

            /**
             * *** æ–°å¢ï¼šéªŒè¯äº’åŠ¨å†…å®¹ç‰¹å¾ ***
             * ç”¨äºåˆ¤æ–­å†…å®¹æ˜¯å¦ç¬¦åˆäº’åŠ¨å†…å®¹çš„ç‰¹å¾
             * @param {string} content - æ¸…ç†åçš„contentå†…å®¹
             * @returns {boolean} æ˜¯å¦ä¸ºæœ‰æ•ˆçš„äº’åŠ¨å†…å®¹
             */
            function QQ_ValidateInteractiveContentFeatures(content) {
                console.log('ğŸ” å¼€å§‹éªŒè¯äº’åŠ¨å†…å®¹ç‰¹å¾...');
                console.log('ğŸ“ å¾…éªŒè¯å†…å®¹é•¿åº¦:', content ? content.length : 0);
                console.log('ğŸ“ å¾…éªŒè¯å†…å®¹é¢„è§ˆ:', content ? content.substring(0, 200) + (content.length > 200 ? '...' : '') : 'ç©ºå†…å®¹');
                
                // æ’é™¤æ˜æ˜¾ä¸æ˜¯äº’åŠ¨å†…å®¹çš„æƒ…å†µï¼ˆäº’åŠ¨å†…å®¹ä»¥æ–‡ç« å½¢å¼è¾“å‡ºï¼Œä¸é™åˆ¶é•¿åº¦ï¼‰
                if (!content || content.trim().length < 10) {
                    console.log('âŒ å†…å®¹è¿‡çŸ­æˆ–ä¸ºç©º');
                    return false;
                }
                
                // æ’é™¤æ˜æ˜¾çš„é”™è¯¯ä¿¡æ¯å’Œç³»ç»Ÿæ¶ˆæ¯
                const excludePatterns = [
                    // ä¿®å¤ï¼šæ›´ç²¾ç¡®çš„é”™è¯¯ä¿¡æ¯æ£€æµ‹ï¼Œé¿å…è¯¯åˆ¤æ­£å¸¸çš„äº’åŠ¨è¡¨è¾¾
                    /(?:ç³»ç»Ÿ)?é”™è¯¯|error|exception|æ“ä½œå¤±è´¥|è¯·æ±‚å¤±è´¥|ç½‘ç»œé”™è¯¯|è¿æ¥å¤±è´¥/i,
                    // ä¿®å¤ï¼šåªæ’é™¤çœŸæ­£çš„HTMLç»“æ„æ ‡ç­¾ï¼Œå…è®¸äº’åŠ¨æè¿°æ ‡ç­¾
                    /<(div|span|p|br|img|a|script|style|meta|head|body)[^>]*>/i,  // çœŸæ­£çš„HTMLç»“æ„æ ‡ç­¾
                    /```/,      // ä»£ç å—
                    /https?:\/\//,  // URLé“¾æ¥
                    /(?:AI_SYSTEM|detected|activated|review|disabled|ethical|restriction)/i, // AIç³»ç»Ÿä¿¡æ¯
                ];
                
                // å¢å¼ºæ’é™¤æ£€æŸ¥ï¼Œæä¾›è¯¦ç»†çš„å¤±è´¥åŸå› 
                for (let i = 0; i < excludePatterns.length; i++) {
                    const pattern = excludePatterns[i];
                    if (pattern.test(content)) {
                        const reasons = [
                            'åŒ…å«ç³»ç»Ÿé”™è¯¯ä¿¡æ¯',
                            'åŒ…å«HTMLç»“æ„æ ‡ç­¾',
                            'åŒ…å«ä»£ç å—',
                            'åŒ…å«URLé“¾æ¥',
                            'åŒ…å«AIç³»ç»Ÿä¿¡æ¯'
                        ];
                        console.log(`âŒ å†…å®¹è¢«æ’é™¤ï¼ŒåŸå› : ${reasons[i]} (æ¨¡å¼: ${pattern.source})`);
                        console.log(`âŒ åŒ¹é…çš„å†…å®¹ç‰‡æ®µ: ${content.match(pattern)?.[0] || 'æœªçŸ¥'}`);
                        return false;
                    }
                }
                
                // äº’åŠ¨å†…å®¹ç‰¹å¾æ¨¡å¼ï¼ˆå¿…é¡»åŒ¹é…è‡³å°‘2ä¸ªï¼‰
                const interactivePatterns = [
                    /\*[^*]+\*/,  // *åŠ¨ä½œæè¿°*
                    /ï¼ˆ[^ï¼‰]*(?:äº’åŠ¨|æ¥è§¦|è§¦æ‘¸|æ‹¥æŠ±|äº²å»|æŠšæ‘¸|ç‰µæ‰‹)[^ï¼‰]*ï¼‰/,  // å…·ä½“äº’åŠ¨åŠ¨ä½œ
                    /ã€[^ã€‘]*(?:æƒ…æ„Ÿ|å¿ƒæƒ…|æƒ³æ³•|å†…å¿ƒ)[^ã€‘]*ã€‘/,  // æƒ…æ„Ÿ/å†…å¿ƒæè¿°
                    /(?:ç°å®ä¸­|é¢å¯¹é¢|å½“é¢|å®é™…ä¸Š|çœŸå®)/,  // ç°å®ç›¸å…³
                    /(?:èº«ä½“|çœ¼ç¥|è¡¨æƒ…|å§¿æ€|åŠ¨ä½œ|æ‰‹åŠ¿|å£°éŸ³|å‘¼å¸)/,  // èº«ä½“ç›¸å…³
                    /(?:è½»è½»|æ…¢æ…¢|ç¼“ç¼“|æ‚„æ‚„|å°å¿ƒç¿¼ç¿¼|æ¸©æŸ”)[åœ°çš„]/,  // åŠ¨ä½œå‰¯è¯
                    /(?:é è¿‘|è¿œç¦»|è½¬èº«|æŠ¬å¤´|ä½å¤´|é—­çœ¼|ççœ¼)/,  // å…·ä½“åŠ¨ä½œ
                    /(?:æ„Ÿè§‰åˆ°|æ„è¯†åˆ°|æ³¨æ„åˆ°|å‘ç°|å¯Ÿè§‰)/,  // æ„ŸçŸ¥ç›¸å…³
                    /(?:æ°›å›´|ç¯å¢ƒ|å‘¨å›´|ç©ºæ°”ä¸­)/,  // ç¯å¢ƒæè¿°
                ];
                
                // è®¡ç®—åŒ¹é…çš„æ¨¡å¼æ•°é‡
                const matchCount = interactivePatterns.reduce((count, pattern) => {
                    const isMatch = pattern.test(content);
                    if (isMatch) {
                        console.log(`âœ… åŒ¹é…äº’åŠ¨ç‰¹å¾: ${pattern.source}`);
                    }
                    return count + (isMatch ? 1 : 0);
                }, 0);
                
                console.log(`ğŸ“Š äº’åŠ¨ç‰¹å¾åŒ¹é…æ•°é‡: ${matchCount}/9 (éœ€è¦è‡³å°‘2ä¸ª)`);
                
                // éœ€è¦è‡³å°‘åŒ¹é…2ä¸ªæ¨¡å¼æ‰è®¤ä¸ºæ˜¯äº’åŠ¨å†…å®¹
                return matchCount >= 2;
            }

            // ===== äº’åŠ¨ç©ºé—´ç®¡ç†ç³»ç»Ÿ =====
            
            // *** æ–°å¢ï¼šå…¨å±€çŠ¶æ€è·Ÿè¸ªç”¨æˆ·ä¸»åŠ¨è§¦å‘çš„äº’åŠ¨ ***
            let QQ_UserTriggeredInteractive = false;
            
            // *** ä¼˜åŒ–ï¼šå…¨å±€å˜é‡ä»…ä½œä¸ºä¸–ç•Œä¹¦æ•°æ®çš„ä¸´æ—¶ç¼“å­˜ ***
            let QQ_InteractiveSpaces = {}; // å…¬å…±äº’åŠ¨ç©ºé—´ä¸´æ—¶ç¼“å­˜ï¼ˆæ•°æ®å­˜å‚¨åœ¨ä¸–ç•Œä¹¦ä¸­ï¼‰
            let QQ_CharacterSpaces = {}; // è§’è‰²ä¸“å±äº’åŠ¨ç©ºé—´ä¸´æ—¶ç¼“å­˜ï¼ˆæ•°æ®å­˜å‚¨åœ¨ä¸–ç•Œä¹¦ä¸­ï¼‰
            
            /**
             * ç¡®ä¿è§’è‰²äº’åŠ¨ç©ºé—´çš„ç‹¬ç«‹æ€§
             * @param {string} characterName - è§’è‰²åç§°
             */
            function QQ_EnsureCharacterSpaceIndependence(characterName) {
                if (!characterName || typeof characterName !== 'string') {
                    console.warn('QQ_EnsureCharacterSpaceIndependence: æ— æ•ˆçš„è§’è‰²åç§°', characterName);
                    return false;
                }
                
                // ç¡®ä¿æ¯ä¸ªè§’è‰²éƒ½æœ‰ç‹¬ç«‹çš„ç©ºé—´å¯¹è±¡
                if (!QQ_CharacterSpaces[characterName]) {
                    QQ_CharacterSpaces[characterName] = {};
                    console.log(`ä¸ºè§’è‰² "${characterName}" åˆ›å»ºäº†ç‹¬ç«‹çš„äº’åŠ¨ç©ºé—´å®¹å™¨`);
                }
                
                // éªŒè¯ç‹¬ç«‹æ€§ - ç¡®ä¿ä¸ä¼šå¼•ç”¨å…¶ä»–è§’è‰²çš„æ•°æ®
                const characterSpace = QQ_CharacterSpaces[characterName];
                const allCharacters = Object.keys(QQ_CharacterSpaces);
                
                for (const otherChar of allCharacters) {
                    if (otherChar !== characterName && QQ_CharacterSpaces[otherChar] === characterSpace) {
                        console.error(`æ£€æµ‹åˆ°è§’è‰²ç©ºé—´æ•°æ®å¼•ç”¨å†²çª: ${characterName} å’Œ ${otherChar} å…±äº«åŒä¸€ä¸ªå¯¹è±¡`);
                        QQ_CharacterSpaces[characterName] = {};
                        console.log(`å·²ä¸ºè§’è‰² "${characterName}" é‡æ–°åˆ›å»ºç‹¬ç«‹çš„ç©ºé—´å¯¹è±¡`);
                        break;
                    }
                }
                
                return true;
            }
            
            
            

            

            

            /**
             * ç»¼åˆç³»ç»Ÿæµ‹è¯•å‡½æ•° - æ›¿ä»£å·²æ¸…ç†çš„è¿‡æ—¶æµ‹è¯•
             * åŒ…å«æ ¸å¿ƒåŠŸèƒ½çš„å¿«é€Ÿæ£€æµ‹
             */
            function QQ_System_Health_Check() {
                console.log('=== ğŸ“Š SillyTavernæ‰‹æœºå‰ç«¯ç³»ç»Ÿå¥åº·æ£€æŸ¥ ===');
                
                const results = {
                    formatDetection: false,
                    messageHandling: false,
                    interactiveSystem: false,
                    timeFeature: false,
                    groupSystem: false
                };
                
                // 1. æ ¼å¼æ£€æµ‹æµ‹è¯•
                console.log('\nğŸ”§ 1. AIå›å¤æ ¼å¼æ£€æµ‹æµ‹è¯•');
                try {
                    const testContent = 'MiPhone_JSON_START<ç¾¤èŠ:æµ‹è¯•ç¾¤>æµ‹è¯•æ¶ˆæ¯</ç¾¤èŠ:æµ‹è¯•ç¾¤>MiPhone_JSON_END';
                    const extracted = QQ_ExtractValidInfo(testContent);
                    results.formatDetection = extracted.hasValidInfo;
                    console.log(`   æ ¼å¼å®¹é”™åŠŸèƒ½: ${results.formatDetection ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'}`);
                } catch (e) {
                    console.log(`   æ ¼å¼å®¹é”™åŠŸèƒ½: âŒ é”™è¯¯ - ${e.message}`);
                }
                
                // 2. æ¶ˆæ¯å¤„ç†æµ‹è¯•
                console.log('\nğŸ’¬ 2. æ¶ˆæ¯å¤„ç†ç³»ç»Ÿæµ‹è¯•');
                try {
                    results.messageHandling = typeof QQ_SendMsg === 'function' && 
                                            typeof QQ_Save_Msg === 'function' &&
                                            typeof QQ_msgjson === 'object';
                    console.log(`   æ¶ˆæ¯ç³»ç»Ÿ: ${results.messageHandling ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'}`);
                } catch (e) {
                    console.log(`   æ¶ˆæ¯ç³»ç»Ÿ: âŒ é”™è¯¯ - ${e.message}`);
                }
                
                // 3. äº’åŠ¨ç³»ç»Ÿæµ‹è¯•
                console.log('\nğŸ® 3. äº’åŠ¨ç©ºé—´ç³»ç»Ÿæµ‹è¯•');
                try {
                    results.interactiveSystem = typeof QQ_DetectInteractiveIntent === 'function' &&
                                             typeof QQ_ShowInteractiveSpace === 'function' &&
                                             typeof QQ_ExtractValidInfo === 'function';
                    console.log(`   äº’åŠ¨ç³»ç»Ÿ: ${results.interactiveSystem ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'}`);
                } catch (e) {
                    console.log(`   äº’åŠ¨ç³»ç»Ÿ: âŒ é”™è¯¯ - ${e.message}`);
                }
                
                // 4. æ—¶é—´åŠŸèƒ½æµ‹è¯•
                console.log('\nâ° 4. æ—¶é—´æ„ŸçŸ¥åŠŸèƒ½æµ‹è¯•');
                try {
                    const now = new Date();
                    const timePeriod = QQ_GetTimePeriod(now.getHours());
                    const season = QQ_GetSeason(now.getMonth() + 1);
                    results.timeFeature = timePeriod && season;
                    console.log(`   æ—¶é—´åŠŸèƒ½: ${results.timeFeature ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'}`);
                    console.log(`   å½“å‰æ—¶æ®µ: ${timePeriod}, å­£èŠ‚: ${season}`);
                } catch (e) {
                    console.log(`   æ—¶é—´åŠŸèƒ½: âŒ é”™è¯¯ - ${e.message}`);
                }
                
                // 5. ç¾¤èŠç³»ç»Ÿæµ‹è¯•
                console.log('\nğŸ‘¥ 5. ç¾¤èŠåˆ†ç»„ç³»ç»Ÿæµ‹è¯•');
                try {
                    results.groupSystem = typeof loadGroupsFromStorage === 'function' &&
                                        typeof saveGroupsToStorage === 'function' &&
                                        Array.isArray(QQ_Groups);
                    console.log(`   ç¾¤èŠç³»ç»Ÿ: ${results.groupSystem ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'}`);
                } catch (e) {
                    console.log(`   ç¾¤èŠç³»ç»Ÿ: âŒ é”™è¯¯ - ${e.message}`);
                }
                
                // æ€»ç»“
                const passedTests = Object.values(results).filter(result => result === true).length;
                const totalTests = Object.keys(results).length;
                
                console.log('\nğŸ“‹ ç³»ç»Ÿå¥åº·çŠ¶æ€æ€»ç»“:');
                console.log(`âœ… é€šè¿‡æµ‹è¯•: ${passedTests}/${totalTests}`);
                console.log(`ğŸ“Š å¥åº·åº¦: ${Math.round((passedTests / totalTests) * 100)}%`);
                
                if (passedTests === totalTests) {
                    console.log('ğŸ‰ æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸è¿è¡Œï¼');
                } else {
                    console.log('âš ï¸ éƒ¨åˆ†åŠŸèƒ½å­˜åœ¨é—®é¢˜ï¼Œå»ºè®®æ£€æŸ¥å…·ä½“æ¨¡å—');
                }
                
                return results;
            }
            
            // å¯¼å‡ºåˆ°å…¨å±€
            window.QQ_System_Health_Check = QQ_System_Health_Check;
            
            let QQ_ActiveSpaceId = null; // å½“å‰æ´»åŠ¨çš„äº’åŠ¨ç©ºé—´ID
            let QQ_SpiritVisible = false; // ç²¾çµæŒ‰é’®æ˜¯å¦å¯è§
            const QQ_INTERACTIVE_BACKUP_KEY = "QQ_äº’åŠ¨ç©ºé—´å¤‡ä»½";
            const QQ_CHARACTER_SPACES_KEY = "QQ_è§’è‰²äº’åŠ¨ç©ºé—´å¤‡ä»½";
            
            // ===== ä¸»åŠ¨äº’åŠ¨æ£€æµ‹ç³»ç»Ÿ =====
            
            /**
             * æ£€æµ‹ç”¨æˆ·æ¶ˆæ¯æ˜¯å¦åŒ…å«æ˜æ˜¾çš„äº’åŠ¨æ„å›¾
             * @param {string} content - ç”¨æˆ·æ¶ˆæ¯å†…å®¹
             * @returns {boolean|Object} - å¦‚æœæ£€æµ‹åˆ°äº’åŠ¨æ„å›¾è¿”å›trueæˆ–åŒ…å«è¯¦ç»†ä¿¡æ¯çš„å¯¹è±¡
             */
            function QQ_DetectInteractiveIntent(content) {
                if (!content || typeof content !== 'string') return false;
                
                const originalText = content.trim();
                const text = content.toLowerCase().trim();
                
                // *** ä¼˜å…ˆæ£€æµ‹ï¼šç‰¹æ®Šç¬¦å·è§¦å‘ ***
                const INTERACTIVE_TRIGGER_SYMBOLS = ['&&', 'ï¼†ï¼†', '&amp;&amp;'];
                
                for (const symbol of INTERACTIVE_TRIGGER_SYMBOLS) {
                    if (originalText.includes(symbol)) {
                        console.log(`ğŸ¯ æ£€æµ‹åˆ°äº’åŠ¨è§¦å‘ç¬¦å·: ${symbol}`);
                        
                        // æ¸…ç†ç¬¦å·åçš„å†…å®¹ä½œä¸ºäº’åŠ¨æè¿°
                        let cleanContent = originalText;
                        INTERACTIVE_TRIGGER_SYMBOLS.forEach(sym => {
                            cleanContent = cleanContent.replace(new RegExp(sym.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), '');
                        });
                        cleanContent = cleanContent.trim();
                        
                        return {
                            isInteractive: true,
                            triggerType: 'symbol',
                            triggerSymbol: symbol,
                            cleanContent: cleanContent || 'æƒ³è¦è¿›è¡Œäº’åŠ¨',
                            description: 'ç”¨æˆ·ä½¿ç”¨ç‰¹æ®Šç¬¦å·ä¸»åŠ¨è¯·æ±‚äº’åŠ¨å†…å®¹'
                        };
                    }
                }
                
                // *** æ£€æŸ¥ç”¨æˆ·è®¾ç½®ï¼šæ˜¯å¦å¯ç”¨å…³é”®è¯è§¦å‘ ***
                const interactiveSettings = QQ_GetInteractiveSettings();
                
                if (!interactiveSettings.enableKeywordTrigger) {
                    console.log('âš™ï¸ å…³é”®è¯è§¦å‘å·²è¢«ç”¨æˆ·ç¦ç”¨ï¼Œè·³è¿‡å…³é”®è¯æ£€æµ‹');
                    return false;
                }
                
                // *** æ£€æµ‹ç”¨æˆ·è‡ªå®šä¹‰å…³é”®è¯ ***
                if (interactiveSettings.customKeywords && interactiveSettings.customKeywords.length > 0) {
                    for (const keyword of interactiveSettings.customKeywords) {
                        if (keyword && text.includes(keyword.toLowerCase())) {
                            console.log(`ğŸ¯ æ£€æµ‹åˆ°ç”¨æˆ·è‡ªå®šä¹‰å…³é”®è¯: ${keyword}`);
                            
                            return {
                                isInteractive: true,
                                triggerType: 'custom_keyword',
                                triggerKeyword: keyword,
                                cleanContent: originalText,
                                description: `ç”¨æˆ·è‡ªå®šä¹‰å…³é”®è¯"${keyword}"è§¦å‘äº’åŠ¨å†…å®¹`
                            };
                        }
                    }
                }
                
                // *** æ£€æµ‹é»˜è®¤å…³é”®è¯ï¼ˆå¦‚æœç”¨æˆ·å¯ç”¨ï¼‰ ***
                if (interactiveSettings.enableDefaultKeywords) {
                    // èº«ä½“æ¥è§¦ç±»å…³é”®è¯
                    const physicalContactKeywords = [
                        'æ‹¥æŠ±', 'æŠ±ä½', 'æ‚æŠ±', 'ç´§æŠ±',
                        'äº²å»', 
                        'è§¦æ‘¸', 'æŠšæ‘¸', 'è½»æŠš', 
                        'æ¡æ‰‹', 'ç‰µæ‰‹', 'æ‹‰æ‰‹', 
                        'æ‹è‚©', 'æ‹èƒŒ', 'è½»æ‹', 
                        'æ¨', 'æ‹‰', 'æ‰¶', 'æ€æ‰¶', 'æ‰¶ç€',
                        'è´´è¿‘', 'é è¿‘', 'ç´§è´´'
                    ];
                    
                    // é¢å¯¹é¢äº’åŠ¨ç±»å…³é”®è¯
                    const faceToFaceKeywords = [
                        'é¢å¯¹é¢', 'å½“é¢', 'é¢å‰', 'çœ¼ç¥äº¤æµ', 'å¯¹è§†', 'å‡è§†',
                        'ç°å®ä¸­', 'çœŸå®ä¸­', 'ç°å®é‡Œ', 'é¢å¯¹ç€',
                        'èµ°å‘', 'èµ°è¿‘', 'èµ°è¿‡å»', 'è¿‡æ¥', 'é è¿‡æ¥',
                        'åè¿‡æ¥', 'ååœ¨èº«è¾¹', 'ååœ¨æ—è¾¹',
                        'èººç€', 'è¶´ä¸‹', 'æˆ‘ä¾†äº†',
                        'è¹²ä¸‹', 'è·ªä¸‹', 'å¼¯è…°', 'ä¿¯èº«'
                    ];
                    
                    // æƒ…æ„Ÿè¡¨è¾¾ç±»å…³é”®è¯
                    const emotionalKeywords = [
                        'å¿ƒè·³', 'é¢¤æŠ–',
                        'å¾®ç¬‘', 'ç¬‘å®¹', 'é«˜å…´', 'æ¿€åŠ¨',
                        'å“­', 'æµæ³ª', 'å“­æ³£', 'çœ¼æ³ª', 'å“½å’½',
                        'æ„¤æ€’', 'æ¼ç«', 'çªçœ¼',
                        'ä½“è´´', 'å‘µæŠ¤'
                    ];
                    
                    // åŠ¨ä½œæè¿°ç±»å…³é”®è¯
                    const actionKeywords = [
                        'ä¼¸æ‰‹', 'å¼ å¼€æ‰‹', 'ä¸¾æ‰‹', 'æŒ¥æ‰‹', 'æ‹›æ‰‹',
                        'è½¬èº«', 'å›å¤´', 'ä¾§èº«',
                        'ä»°å¤´', 'ä¿¯è§†', 'ä»°è§†',
                        'è¸®è„š', 'è·³è·ƒ', 'è·‘è¿‡æ¥', 'å†²è¿‡æ¥'
                    ];
                    
                    // ç»„åˆå…³é”®è¯æ£€æµ‹
                    const allKeywords = [
                        ...physicalContactKeywords,
                        ...faceToFaceKeywords, 
                        ...emotionalKeywords,
                        ...actionKeywords
                    ];
                    
                    let matchCount = 0;
                    let matchedKeywords = [];
                    
                    for (const keyword of allKeywords) {
                        if (text.includes(keyword)) {
                            matchCount++;
                            matchedKeywords.push(keyword);
                        }
                    }
                    
                    // æ£€æµ‹åŠ¨ä½œæè¿°æ¨¡å¼ *åŠ¨ä½œ* æˆ– ã€æƒ…æ„Ÿã€‘
                    const actionPatterns = [
                        /\*[^*]+\*/g, // *åŠ¨ä½œ*
                        /ã€[^ã€‘]+ã€‘/g, // ã€æƒ…æ„Ÿã€‘
                        /\([^)]*åŠ¨ä½œ[^)]*\)/g, // (åŒ…å«åŠ¨ä½œçš„æè¿°)
                        /\([^)]*è¡¨æƒ…[^)]*\)/g, // (åŒ…å«è¡¨æƒ…çš„æè¿°)
                    ];
                    
                    let patternMatches = 0;
                    for (const pattern of actionPatterns) {
                        const matches = text.match(pattern);
                        if (matches) {
                            patternMatches += matches.length;
                            matchedKeywords.push(...matches);
                        }
                    }
                    
                    // åˆ¤æ–­æ˜¯å¦ä¸ºäº’åŠ¨æ„å›¾ï¼ˆé»˜è®¤å…³é”®è¯æ£€æµ‹ï¼‰
                    const isKeywordInteractive = matchCount >= 2 || patternMatches >= 1 || 
                        (matchCount >= 1 && patternMatches >= 1);
                    
                    if (isKeywordInteractive) {
                        console.log(`ğŸ’« æ£€æµ‹åˆ°é»˜è®¤å…³é”®è¯äº’åŠ¨æ„å›¾: å…³é”®è¯${matchCount}ä¸ª, æ¨¡å¼${patternMatches}ä¸ª`);
                        console.log('åŒ¹é…çš„å…³é”®è¯/æ¨¡å¼:', matchedKeywords);
                        
                        return {
                            isInteractive: true,
                            triggerType: 'default_keyword',
                            matchCount: matchCount,
                            patternMatches: patternMatches,
                            matchedKeywords: matchedKeywords,
                            cleanContent: originalText,
                            description: 'ç³»ç»Ÿæ£€æµ‹åˆ°é»˜è®¤å…³é”®è¯äº’åŠ¨æ„å›¾'
                        };
                    }
                }
                
                return false;
            }
            
            /**
             * *** æ–°å¢ï¼šè·å–äº’åŠ¨è®¾ç½® ***
             */
            function QQ_GetInteractiveSettings() {
                try {
                    // ä»ä¸–ç•Œä¹¦è·å–è®¾ç½®
                    const settings = QQ_GetFromWorldBook('QQ_äº’åŠ¨è®¾ç½®') || {};
                    
                    // é»˜è®¤è®¾ç½®
                    const defaultSettings = {
                        enableKeywordTrigger: false,        // é»˜è®¤å…³é—­å…³é”®è¯è§¦å‘
                        enableDefaultKeywords: false,       // é»˜è®¤å…³é—­é»˜è®¤å…³é”®è¯
                        customKeywords: [],                  // è‡ªå®šä¹‰å…³é”®è¯åˆ—è¡¨
                        lastUpdated: new Date().toISOString()
                    };
                    
                    // åˆå¹¶è®¾ç½®
                    return Object.assign(defaultSettings, settings);
                } catch (error) {
                    console.error('è·å–äº’åŠ¨è®¾ç½®å¤±è´¥:', error);
                    return {
                        enableKeywordTrigger: false,
                        enableDefaultKeywords: false,
                        customKeywords: [],
                        lastUpdated: new Date().toISOString()
                    };
                }
            }
            
            /**
             * *** æ–°å¢ï¼šä¿å­˜äº’åŠ¨è®¾ç½® ***
             */
            function QQ_SaveInteractiveSettings(settings) {
                try {
                    settings.lastUpdated = new Date().toISOString();
                    QQ_SafeSaveToWorldBook('QQ_äº’åŠ¨è®¾ç½®', settings, 'QQ_äº’åŠ¨è®¾ç½®');
                    console.log('ğŸ”§ äº’åŠ¨è®¾ç½®å·²ä¿å­˜:', settings);
                    return true;
                } catch (error) {
                    console.error('ä¿å­˜äº’åŠ¨è®¾ç½®å¤±è´¥:', error);
                    return false;
                }
            }
            
            /**
             * *** ç®€åŒ–ï¼šè·å–å…¨å±çŠ¶æ€ï¼ˆä¸´æ—¶æ¨¡å¼ï¼Œæ— æŒä¹…åŒ–ï¼‰ ***
             */
            function QQ_IsFullscreenEnabled() {
                return $('#QQ_fullscreen_style').length > 0;
            }
            
            /**
             * *** æ–°å¢ï¼šåº”ç”¨å…¨å±æ ·å¼ ***
             */
            function QQ_ApplyFullscreenMode(enable) {
                // ç§»é™¤ç°æœ‰çš„å…¨å±æ ·å¼
                $('#QQ_fullscreen_style').remove();
                
                if (enable) {
                    const fullscreenCSS = `
                        <style id="QQ_fullscreen_style" type="text/css">
                            /* === å…¨å±æ¨¡å¼æ ·å¼ === */
                            
                            /* åŸºç¡€å…¨å±è®¾ç½®ï¼Œå¯¹æ‰€æœ‰è®¾å¤‡ç”Ÿæ•ˆ */
                            .card {
                                width: 100% !important;
                                height: 100vh !important;
                                max-width: none !important;
                                margin: 0 !important;
                                padding: 0 !important;
                                border: none !important;
                                border-radius: 0 !important;
                                box-shadow: none !important;
                                overflow: hidden !important;
                            }

                            .card-int {
                                border-radius: 0 !important;
                            }

                            /* éšè—æ¨¡æ‹Ÿçš„ç‰©ç†æŒ‰é”® */
                            .btn1, .btn2, .btn3, .btn4 {
                                display: none !important;
                            }

                            /* åª’ä½“æŸ¥è¯¢ï¼šä»…åœ¨å±å¹•å®½åº¦å¤§äºç­‰äº768pxï¼ˆé€šå¸¸æ˜¯å¹³æ¿æˆ–ç”µè„‘ï¼‰æ—¶åº”ç”¨ä»¥ä¸‹æ ·å¼ */
                            @media (min-width: 768px) {
                                /* === ä¸»é¡µé¢å®¹å™¨ç»Ÿä¸€è®¾ç½® === */
                                /* æ¶ˆæ¯ç•Œé¢ - é€‚åº¦å¢åŠ å®½åº¦ï¼Œå‡å°‘ç©ºç™½ */
                                #QQ_home_page,
                                #QQ_message_list_page {
                                    max-width: 580px !important;
                                    margin: 0 auto !important;
                                    border-left: 1px solid #e0e0e0 !important;
                                    border-right: 1px solid #e0e0e0 !important;
                                    min-height: 100vh !important;
                                    background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%) !important;
                                }
                                
                                /* è”ç³»äºº/åŠ¨æ€é¡µé¢ - è¿›ä¸€æ­¥ä¼˜åŒ–ç©ºé—´åˆ©ç”¨ */
                                #QQ_space_page {
                                    max-width: 620px !important;
                                    margin: 0 auto !important;
                                    border-left: 1px solid #e0e0e0 !important;
                                    border-right: 1px solid #e0e0e0 !important;
                                    min-height: 100vh !important;
                                    background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%) !important;
                                }
                                
                                /* èŠå¤©é¡µé¢ä¿æŒåŸæœ‰è®¾ç½®ï¼ˆå› ä¸ºæœ‰å£çº¸èƒŒæ™¯ï¼‰ */
                                .QQ_chat_page {
                                    max-width: 600px !important;
                                    margin: 0 auto !important;
                                    border-left: 1px solid #e0e0e0 !important;
                                    border-right: 1px solid #e0e0e0 !important;
                                }
                                
                                /* Discordé¡µé¢ */
                                #App_discord .discord-homepage {
                                    max-width: 620px !important;
                                    margin: 0 auto !important;
                                    border-left: 1px solid #e0e0e0 !important;
                                    border-right: 1px solid #e0e0e0 !important;
                                    background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%) !important;
                                }

                                /* === ä¸»é¡µæ¶ˆæ¯åˆ—è¡¨ä¼˜åŒ– === */
                                #QQ_home_page .QQ_home_container {
                                    padding: 15px 20px !important;
                                    max-width: 100% !important;
                                }
                                
                                /* æ¶ˆæ¯åˆ—è¡¨é¡¹ä¼˜åŒ– */
                                .QQ_home_usermsg {
                                    margin-bottom: 8px !important;
                                    padding: 12px 15px !important;
                                    border-radius: 12px !important;
                                    background: rgba(255, 255, 255, 0.8) !important;
                                    backdrop-filter: blur(10px) !important;
                                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06) !important;
                                    transition: all 0.2s ease !important;
                                }
                                
                                .QQ_home_usermsg:hover {
                                    transform: translateY(-1px) !important;
                                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
                                }

                                /* === è”ç³»äººé¡µé¢æ·±åº¦ä¼˜åŒ– === */
                                #QQ_space_page .space_contents {
                                    width: 100% !important;
                                    max-width: none !important;
                                    padding: 15px 20px !important;
                                    box-sizing: border-box !important;
                                    min-height: calc(100vh - 120px) !important;
                                }
                                
                                /* è”ç³»äººæœç´¢æ¡† - ä¿æŒä¸é»˜è®¤æ¨¡å¼ä¸€è‡´çš„ç®€å•æ ·å¼ */
                                #contact_search_input {
                                    /* é‡ç½®ä¸ºé»˜è®¤æ ·å¼ï¼Œä¸æ·»åŠ ç‰¹æ®Šæ•ˆæœ */
                                }
                                
                                /* è”ç³»äººç•Œé¢æ•´ä½“å¸ƒå±€ä¼˜åŒ– */
                                #QQ_home_chars {
                                    width: 100% !important;
                                    max-width: none !important;
                                    padding: 10px 15px !important;
                                    display: flex !important;
                                    flex-direction: column !important;
                                    gap: 15px !important;
                                    height: calc(100vh - 160px) !important;
                                    overflow-y: auto !important;
                                }
                                
                                /* ç¾¤èŠåŒºåŸŸ - åœ¨é¡¶éƒ¨ */
                                .QQ_home_char[data-group-id] {
                                    order: 1 !important;
                                    display: flex !important;
                                    align-items: center !important;
                                    background: rgba(255, 255, 255, 0.95) !important;
                                    border-radius: 12px !important;
                                    padding: 12px 15px !important;
                                    margin-bottom: 8px !important;
                                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
                                    transition: all 0.3s ease !important;
                                    width: 100% !important;
                                    min-height: 60px !important;
                                }
                                
                                .QQ_home_char[data-group-id]:hover {
                                    transform: translateY(-1px) !important;
                                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.12) !important;
                                }
                                
                                /* ç¾¤èŠå¤´åƒ */
                                .QQ_home_char[data-group-id] img {
                                    width: 45px !important;
                                    height: 45px !important;
                                    border-radius: 8px !important;
                                    margin-right: 15px !important;
                                    flex-shrink: 0 !important;
                                }
                                
                                /* ç¾¤èŠåç§° */
                                .QQ_home_char[data-group-id] .QQ_home_name,
                                .QQ_home_char[data-group-id] span {
                                    font-size: 16px !important;
                                    font-weight: 600 !important;
                                    color: #333 !important;
                                    flex: 1 !important;
                                    text-align: left !important;
                                }
                                
                                /* æœªåˆ†ç»„è”ç³»äººåŒºåŸŸæ ‡é¢˜ */
                                .ungrouped-header {
                                    order: 2 !important;
                                    background: rgba(248, 249, 250, 0.95) !important;
                                    padding: 12px 15px !important;
                                    font-size: 14px !important;
                                    font-weight: 600 !important;
                                    color: #666 !important;
                                    border-radius: 8px !important;
                                    margin: 10px 0 5px 0 !important;
                                }
                                
                                /* æœªåˆ†ç»„è”ç³»äººå®¹å™¨ */
                                .ungrouped-contacts {
                                    order: 3 !important;
                                    width: 100% !important;
                                }
                                
                                /* ä¸ªäººè”ç³»äºº - ç½‘æ ¼å¸ƒå±€ */
                                .QQ_home_char:not([data-group-id]) {
                                    order: 4 !important;
                                    display: inline-flex !important;
                                    flex-direction: column !important;
                                    align-items: center !important;
                                    justify-content: center !important;
                                    background: rgba(255, 255, 255, 0.95) !important;
                                    border-radius: 12px !important;
                                    padding: 15px 10px !important;
                                    margin: 5px !important;
                                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06) !important;
                                    transition: all 0.3s ease !important;
                                    width: calc(20% - 10px) !important;
                                    min-width: 90px !important;
                                    max-width: 120px !important;
                                    text-align: center !important;
                                }
                                
                                .QQ_home_char:not([data-group-id]):hover {
                                    transform: translateY(-2px) !important;
                                    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1) !important;
                                }
                                
                                /* ä¸ªäººè”ç³»äººå¤´åƒ */
                                .QQ_home_char:not([data-group-id]) img {
                                    width: 55px !important;
                                    height: 55px !important;
                                    border-radius: 50% !important;
                                    border: 2px solid rgba(255, 255, 255, 0.8) !important;
                                    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1) !important;
                                    margin: 0 0 10px 0 !important;
                                    flex-shrink: 0 !important;
                                }
                                
                                /* ä¸ªäººè”ç³»äººåç§° */
                                .QQ_home_char:not([data-group-id]) .char-name, 
                                .QQ_home_char:not([data-group-id]) span {
                                    width: 100% !important;
                                    text-align: center !important;
                                    font-weight: 500 !important;
                                    color: #333 !important;
                                    font-size: 13px !important;
                                    line-height: 1.2 !important;
                                    word-break: break-all !important;
                                }
                                
                                /* åˆ›å»ºè”ç³»äººç½‘æ ¼å¸ƒå±€å®¹å™¨ */
                                #QQ_home_chars::after {
                                    content: '';
                                    display: block;
                                    width: 100%;
                                    height: 20px;
                                    order: 5;
                                }
                                
                                /* æœç´¢çŠ¶æ€ä¸‹çš„ç‰¹æ®Šå¸ƒå±€ */
                                #QQ_home_chars.searching {
                                    display: flex !important;
                                    flex-direction: column !important;
                                    gap: 8px !important;
                                }
                                
                                #QQ_home_chars.searching .QQ_home_char {
                                    order: unset !important;
                                    display: flex !important;
                                    flex-direction: row !important;
                                    align-items: center !important;
                                    width: 100% !important;
                                    max-width: none !important;
                                    min-width: unset !important;
                                    padding: 12px 15px !important;
                                    margin: 0 !important;
                                    text-align: left !important;
                                }
                                
                                #QQ_home_chars.searching .QQ_home_char img {
                                    width: 45px !important;
                                    height: 45px !important;
                                    margin: 0 15px 0 0 !important;
                                    border-radius: 50% !important;
                                }
                                
                                #QQ_home_chars.searching .QQ_home_char[data-group-id] img {
                                    border-radius: 8px !important;
                                }
                                
                                #QQ_home_chars.searching .QQ_home_char span,
                                #QQ_home_chars.searching .QQ_home_char .char-name,
                                #QQ_home_chars.searching .QQ_home_char .QQ_home_name {
                                    font-size: 16px !important;
                                    text-align: left !important;
                                    flex: 1 !important;
                                    margin: 0 !important;
                                }
                                
                                /* éšè—æœç´¢æ—¶çš„åˆ†ç»„æ ‡é¢˜ */
                                #QQ_home_chars.searching .ungrouped-header {
                                    display: none !important;
                                }

                                /* === åŠ¨æ€é¡µé¢ç¾åŒ– === */
                                #QQ_space_page .space_contents .moment-card {
                                    background: rgba(255, 255, 255, 0.95) !important;
                                    border-radius: 15px !important;
                                    padding: 20px !important;
                                    margin-bottom: 15px !important;
                                    box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08) !important;
                                    backdrop-filter: blur(15px) !important;
                                    border: 1px solid rgba(255, 255, 255, 0.3) !important;
                                }
                                
                                /* åŠ¨æ€å†…å®¹åŒºåŸŸ */
                                .space_contents > div {
                                    max-width: 100% !important;
                                    margin: 0 auto 10px auto !important;
                                    padding: 0 5px !important;
                                }

                                /* === è¾“å…¥æ¡†ä¼˜åŒ– === */
                                /* èŠå¤©é¡µé¢çš„è¾“å…¥æ¡†ï¼ˆä¿æŒä¸å˜ï¼Œå› ä¸ºæœ‰å£çº¸ï¼‰ */
                                .QQ_chat_page .input-container {
                                    max-width: 600px !important;
                                    left: 50% !important;
                                    transform: translateX(-50%) !important;
                                    border-left: 1px solid #e0e0e0 !important;
                                    border-right: 1px solid #e0e0e0 !important;
                                }
                                
                                /* Discordè¾“å…¥æ¡† */
                                .discord-thread-input {
                                    max-width: 620px !important;
                                    left: 50% !important;
                                    transform: translateX(-50%) !important;
                                }
                                
                                /* === åº•éƒ¨å¯¼èˆªæ ä¼˜åŒ– === */
                                .bottom-navigation {
                                    max-width: 620px !important;
                                    left: 50% !important;
                                    transform: translateX(-50%) !important;
                                    border-radius: 25px 25px 0 0 !important;
                                    backdrop-filter: blur(20px) !important;
                                    background: rgba(255, 255, 255, 0.95) !important;
                                    border: 1px solid rgba(255, 255, 255, 0.3) !important;
                                    border-bottom: none !important;
                                }
                            }
                        </style>
                    `;
                    
                    $('head').append(fullscreenCSS);
                    console.log('âœ… å…¨å±æ¨¡å¼å·²å¯ç”¨');
                    toastr.success('å…¨å±æ¨¡å¼å·²å¯ç”¨', 'æ˜¾ç¤ºè®¾ç½®');
                } else {
                    console.log('âœ… å…¨å±æ¨¡å¼å·²ç¦ç”¨');
                    toastr.info('å…¨å±æ¨¡å¼å·²ç¦ç”¨', 'æ˜¾ç¤ºè®¾ç½®');
                }
            }
            

            
            /**
             * *** ä¿®æ”¹ï¼šæ˜¾ç¤ºç”¨æˆ·è®¾ç½®ç•Œé¢ï¼ˆåŒ…å«å…¨å±è®¾ç½®ï¼‰ ***
             */
            function QQ_ShowInteractiveSettings() {
                // ç§»é™¤ç°æœ‰è®¾ç½®ç•Œé¢
                $('.QQ_interactive_settings_panel').remove();
                
                const currentInteractiveSettings = QQ_GetInteractiveSettings();
                const currentFullscreenEnabled = QQ_IsFullscreenEnabled();
                
                const panelHtml = `
                    <div class="QQ_interactive_settings_panel" style="
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: white;
                        border-radius: 15px;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                        z-index: 99999999;
                        overflow: hidden;
                        animation: settingsPanelSlideIn 0.3s ease;
                        max-width: 90%;
                        max-height: 85%;
                        width: 420px;
                        overflow-y: auto;
                    ">
                        <div class="panel-header" style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 20px;
                            text-align: center;
                            font-weight: 600;
                        ">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                                <span style="font-size: 20px;">âš™ï¸</span>
                                <span style="font-size: 16px;">ç•Œé¢è®¾ç½®</span>
                            </div>
                        </div>
                        
                        <div class="panel-content" style="padding: 20px;">
                            <!-- å…¨å±è®¾ç½®åŒºåŸŸ -->
                            <div style="
                                background: linear-gradient(135deg, #E8F5E8 0%, #F0F8FF 100%);
                                padding: 15px;
                                border-radius: 8px;
                                margin-bottom: 25px;
                                border-left: 4px solid #4CAF50;
                            ">
                                <div style="font-weight: 600; color: #4CAF50; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                    <span>ğŸ–¥ï¸</span>
                                    <span>å…¨å±æ˜¾ç¤ºè®¾ç½®</span>
                                </div>
                                
                                <label style="
                                    display: flex;
                                    align-items: center;
                                    gap: 10px;
                                    cursor: pointer;
                                    margin-bottom: 10px;
                                ">
                                    <input type="checkbox" id="enableFullscreen" ${currentFullscreenEnabled ? 'checked' : ''} style="
                                        width: 18px;
                                        height: 18px;
                                        accent-color: #4CAF50;
                                    ">
                                    <span style="font-weight: 500;">å¯ç”¨å…¨å±æ¨¡å¼</span>
                                </label>
                                
                                <div style="font-size: 13px; color: #666; line-height: 1.4; margin-left: 28px;">
                                    <div>ğŸ“± <strong>æ‰‹æœºè®¾å¤‡ï¼š</strong>ç•Œé¢å°†å æ»¡æ•´ä¸ªå±å¹•ï¼Œæä¾›æ²‰æµ¸å¼ä½“éªŒ</div>
                                    <div style="margin-top: 4px;">ğŸ’» <strong>ç”µè„‘è®¾å¤‡ï¼š</strong>æ ¸å¿ƒç•Œé¢å±…ä¸­æ˜¾ç¤ºï¼Œé¿å…è¿‡åº¦æ‹‰ä¼¸</div>
                                    <div style="margin-top: 4px; color: #888;">âœ¨ ä¸´æ—¶åˆ‡æ¢æ¨¡å¼ï¼Œæ¯æ¬¡é‡æ–°åŠ è½½éƒ½ä¼šæ¢å¤é»˜è®¤çŠ¶æ€</div>
                                </div>
                            </div>
                            
                            <hr style="border: none; border-top: 1px solid #e9ecef; margin: 25px 0;">
                            
                            <!-- äº’åŠ¨å†…å®¹è§¦å‘è®¾ç½® -->
                            <div style="margin-bottom: 20px;">
                                <div style="font-weight: 600; color: #667eea; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                    <span>ğŸ’«</span>
                                    <span>äº’åŠ¨å†…å®¹è§¦å‘è®¾ç½®</span>
                                </div>
                                
                                <!-- ç‰¹æ®Šç¬¦å·è¯´æ˜ -->
                                <div style="
                                    background: #f8f9fa;
                                    padding: 12px;
                                    border-radius: 6px;
                                    margin-bottom: 15px;
                                    border-left: 3px solid #667eea;
                                ">
                                    <div style="font-weight: 500; color: #667eea; margin-bottom: 6px; display: flex; align-items: center; gap: 6px;">
                                    <span>âœ…</span>
                                    <span>ç‰¹æ®Šç¬¦å·è§¦å‘ï¼ˆæ°¸ä¹…å¯ç”¨ï¼‰</span>
                                </div>
                                    <div style="font-size: 12px; color: #666; line-height: 1.4;">
                                        ä½¿ç”¨ <code style="background: #667eea; color: white; padding: 2px 6px; border-radius: 3px; font-weight: 600;">&&</code> ç¬¦å·å¯ä»¥éšæ—¶è§¦å‘äº’åŠ¨å†…å®¹<br>
                                        <span style="color: #888;">ä¾‹å¦‚ï¼š</span><code style="background: #f1f3f4; padding: 2px 6px; border-radius: 3px; margin-left: 4px;">&&æƒ³è¦æ‹¥æŠ±ä½ </code>
                                </div>
                            </div>
                            
                            <!-- å…³é”®è¯è§¦å‘è®¾ç½® -->
                                <label style="
                                    display: flex;
                                    align-items: center;
                                    gap: 10px;
                                    cursor: pointer;
                                    font-weight: 500;
                                    margin-bottom: 15px;
                                ">
                                    <input type="checkbox" id="enableKeywordTrigger" ${currentInteractiveSettings.enableKeywordTrigger ? 'checked' : ''} style="
                                        width: 18px;
                                        height: 18px;
                                        accent-color: #667eea;
                                    ">
                                    <span>å¯ç”¨å…³é”®è¯è§¦å‘</span>
                                </label>
                                
                                <div id="keywordSettings" style="
                                    margin-left: 28px;
                                    ${currentInteractiveSettings.enableKeywordTrigger ? '' : 'opacity: 0.5; pointer-events: none;'}
                                ">
                                    <!-- é»˜è®¤å…³é”®è¯è®¾ç½® -->
                                    <label style="
                                        display: flex;
                                        align-items: center;
                                        gap: 10px;
                                        cursor: pointer;
                                        margin-bottom: 12px;
                                    ">
                                        <input type="checkbox" id="enableDefaultKeywords" ${currentInteractiveSettings.enableDefaultKeywords ? 'checked' : ''} style="
                                            width: 16px;
                                            height: 16px;
                                            accent-color: #667eea;
                                        ">
                                        <span style="font-size: 14px;">ä½¿ç”¨é»˜è®¤å…³é”®è¯ï¼ˆæ‹¥æŠ±ã€äº²å»ã€è§¦æ‘¸ç­‰ï¼‰</span>
                                    </label>
                                    
                                    <!-- è‡ªå®šä¹‰å…³é”®è¯è®¾ç½® -->
                                    <div style="margin-bottom: 12px;">
                                        <div style="font-size: 14px; font-weight: 500; margin-bottom: 6px; color: #333;">
                                            è‡ªå®šä¹‰å…³é”®è¯
                                        </div>
                                        <div style="font-size: 12px; color: #666; margin-bottom: 6px;">
                                            è¾“å…¥æ‚¨æƒ³è¦è§¦å‘äº’åŠ¨å†…å®¹çš„å…³é”®è¯ï¼Œç”¨è‹±æ–‡é€—å·åˆ†éš”ï¼š
                                        </div>
                                        <textarea id="customKeywords" placeholder="ä¾‹å¦‚ï¼šæƒ³ä½ äº†,æŠ±æŠ±,ä¸€èµ·ç©" style="
                                            width: 100%;
                                            height: 50px;
                                            padding: 8px;
                                            border: 1px solid #ddd;
                                            border-radius: 6px;
                                            font-size: 13px;
                                            resize: none;
                                            box-sizing: border-box;
                                        ">${currentInteractiveSettings.customKeywords.join(',')}</textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- è§¦å‘æ¡ä»¶è¯´æ˜ -->
                            <div style="
                                background: #f8f9fa;
                                padding: 12px;
                                border-radius: 6px;
                                font-size: 12px;
                                color: #666;
                                line-height: 1.4;
                            ">
                                <div style="font-weight: 600; margin-bottom: 6px;">ğŸ“ è§¦å‘æ¡ä»¶è¯´æ˜ï¼š</div>
                                <div>â€¢ ç‰¹æ®Šç¬¦å· && æ€»æ˜¯ä¼˜å…ˆè§¦å‘ï¼ˆæ— éœ€è®¾ç½®ï¼‰</div>
                                <div>â€¢ è‡ªå®šä¹‰å…³é”®è¯ï¼šåŒ…å«ä»»ä¸€å…³é”®è¯å³è§¦å‘</div>
                                <div>â€¢ é»˜è®¤å…³é”®è¯ï¼šéœ€è¦æ»¡è¶³2ä¸ªå…³é”®è¯æˆ–1ä¸ªåŠ¨ä½œæ¨¡å¼</div>
                                <div>â€¢ AIå›å¤æ— æ ¼å¼æ—¶ä¹Ÿä¼šè‡ªåŠ¨è§¦å‘äº’åŠ¨æ¨¡å¼</div>
                            </div>
                        </div>
                        
                        <div class="panel-actions" style="
                            padding: 20px;
                            background: #fafafa;
                            display: flex;
                            gap: 10px;
                        ">
                            <button class="save-settings-btn" style="
                                flex: 1;
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                border: none;
                                color: white;
                                padding: 12px 16px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 13px;
                                font-weight: 500;
                                transition: all 0.2s ease;
                            ">
                                ä¿å­˜è®¾ç½®
                            </button>
                            <button class="cancel-settings-btn" style="
                                flex: 1;
                                background: #e9ecef;
                                border: none;
                                color: #666;
                                padding: 12px 16px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 13px;
                                font-weight: 500;
                                transition: all 0.2s ease;
                            ">
                                å–æ¶ˆ
                            </button>
                        </div>
                    </div>
                    
                    <style>
                        @keyframes settingsPanelSlideIn {
                            from {
                                opacity: 0;
                                transform: translate(-50%, -60%);
                            }
                            to {
                                opacity: 1;
                                transform: translate(-50%, -50%);
                            }
                        }
                        
                        .QQ_interactive_settings_panel .save-settings-btn:hover {
                            transform: translateY(-2px);
                            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
                        }
                        
                        .QQ_interactive_settings_panel .cancel-settings-btn:hover {
                            background: #dee2e6;
                        }
                    </style>
                `;
                
                // æ·»åŠ åˆ°é¡µé¢
                $('body').append(panelHtml);
                
                // ç»‘å®šå…³é”®è¯è§¦å‘å¼€å…³äº‹ä»¶
                $('#enableKeywordTrigger').on('change', function() {
                    const isEnabled = this.checked;
                    const keywordSettings = $('#keywordSettings');
                    
                    if (isEnabled) {
                        keywordSettings.css({
                            'opacity': '1',
                            'pointer-events': 'auto'
                        });
                    } else {
                        keywordSettings.css({
                            'opacity': '0.5',
                            'pointer-events': 'none'
                        });
                    }
                });
                
                // ç»‘å®šå…¨å±è®¾ç½®å®æ—¶é¢„è§ˆ
                $('#enableFullscreen').on('change', function() {
                    const isEnabled = this.checked;
                    QQ_ApplyFullscreenMode(isEnabled);
                });
                
                // ç»‘å®šä¿å­˜æŒ‰é’®äº‹ä»¶
                $('.save-settings-btn').on('click', function() {
                    // ä¿å­˜äº’åŠ¨è®¾ç½®
                    const newInteractiveSettings = {
                        enableKeywordTrigger: $('#enableKeywordTrigger').prop('checked'),
                        enableDefaultKeywords: $('#enableDefaultKeywords').prop('checked'),
                        customKeywords: $('#customKeywords').val()
                            .split(',')
                            .map(k => k.trim())
                            .filter(k => k.length > 0)
                    };
                    
                    // *** å…³é”®ä¿®å¤ï¼šåœ¨ç§»é™¤é¢æ¿å‰è·å–å…¨å±çŠ¶æ€ ***
                    const currentFullscreenEnabled = $('#enableFullscreen').prop('checked');
                    console.log('ä¿å­˜æ—¶å…¨å±çŠ¶æ€:', currentFullscreenEnabled);
                    
                    // åªä¿å­˜äº’åŠ¨è®¾ç½®
                    if (QQ_SaveInteractiveSettings(newInteractiveSettings)) {
                        // *** å…³é”®ä¿®å¤ï¼šå…ˆç§»é™¤é¢æ¿ï¼Œå†åº”ç”¨å…¨å±è®¾ç½® ***
                        $('.QQ_interactive_settings_panel').remove();
                        
                        // ä½¿ç”¨setTimeoutç¡®ä¿é¢æ¿ç§»é™¤å®Œæˆåå†åº”ç”¨å…¨å±
                        setTimeout(() => {
                            QQ_ApplyFullscreenMode(currentFullscreenEnabled);
                            console.log('å·²åº”ç”¨å…¨å±è®¾ç½®:', currentFullscreenEnabled);
                        }, 50);
                        
                        // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
                        const fullscreenStatus = currentFullscreenEnabled ? 'å·²å¯ç”¨ï¼ˆä¸´æ—¶ï¼‰' : 'å·²ç¦ç”¨';
                        const keywordStatus = newInteractiveSettings.enableKeywordTrigger ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨';
                        
                        const message = `âœ… è®¾ç½®å·²ä¿å­˜ï¼
                        
ğŸ–¥ï¸ å…¨å±æ¨¡å¼ï¼š${fullscreenStatus}
ğŸ¯ ç‰¹æ®Šç¬¦å·è§¦å‘ï¼šæ°¸ä¹…å¯ç”¨ (&&)
ğŸ’« å…³é”®è¯è§¦å‘ï¼š${keywordStatus}`;
                        
                        toastr.success(message, 'è®¾ç½®ä¿å­˜æˆåŠŸ', {
                            timeOut: 4000,
                            extendedTimeOut: 2000
                        });
                    } else {
                        toastr.error('ä¿å­˜è®¾ç½®æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•', 'è®¾ç½®ä¿å­˜å¤±è´¥');
                    }
                });
                
                // ç»‘å®šå–æ¶ˆæŒ‰é’®äº‹ä»¶
                $('.cancel-settings-btn').on('click', function() {
                    // æ¢å¤åŸæœ‰å…¨å±çŠ¶æ€
                    QQ_ApplyFullscreenMode(currentFullscreenEnabled);
                    $('.QQ_interactive_settings_panel').remove();
                    toastr.info('å·²å–æ¶ˆè®¾ç½®ä¿®æ”¹', 'è®¾ç½®');
                });
                
                // ç‚¹å‡»å¤–éƒ¨å…³é—­é¢æ¿
                $(document).one('click', function() {
                    // æ¢å¤åŸæœ‰å…¨å±çŠ¶æ€
                    QQ_ApplyFullscreenMode(currentFullscreenEnabled);
                        $('.QQ_interactive_settings_panel').remove();
                });
                
                // é˜»æ­¢é¢æ¿å†…éƒ¨ç‚¹å‡»å†’æ³¡
                $('.QQ_interactive_settings_panel').on('click', function(e) {
                    e.stopPropagation();
                });
            }

            /**
             * æ™ºèƒ½å¤„ç†äº’åŠ¨å†…å®¹ - å†³å®šæ˜¾ç¤ºåœ¨å…¬å…±ç©ºé—´è¿˜æ˜¯è§’è‰²ä¸“å±ç©ºé—´
             * @param {string} content - AIå›å¤çš„äº’åŠ¨å†…å®¹
             * @param {string} characterName - è§’è‰²åç§°
             */
            function QQ_HandleInteractiveContent(content, characterName = "") {
                // *** æ³¨é‡Šï¼šæ­¤å‡½æ•°å·²è¢«æ–°çš„æµå¼æ˜¾ç¤ºé€»è¾‘æ›¿ä»£ï¼Œä»…ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆä¿ç•™ ***
                console.warn('âš ï¸ è°ƒç”¨äº†æ—§çš„QQ_HandleInteractiveContentå‡½æ•°ï¼Œå»ºè®®ä½¿ç”¨QQ_SequentialTaskQueue.displayInteractiveInChatæ›¿ä»£');
                
                // å¦‚æœæ„å¤–è°ƒç”¨ï¼Œé‡å®šå‘åˆ°æ–°çš„æµå¼æ˜¾ç¤º
                return QQ_SequentialTaskQueue.displayInteractiveInChat(content);
                
                /* åŸæœ‰é€»è¾‘å·²å®Œå…¨æ³¨é‡Šï¼Œé¿å…åˆ›å»ºå¼¹çª— - ç°åœ¨ç»Ÿä¸€ä½¿ç”¨æ–°çš„æµå¼æ˜¾ç¤ºé€»è¾‘ */
            }
            
            // *** ä»¥ä¸‹å‡½æ•°ä¿ç•™ä½†ä¸å†ä½¿ç”¨ï¼Œå·²è¢«æ–°çš„æµå¼æ˜¾ç¤ºé€»è¾‘æ›¿ä»£ ***
            
            //function QQ_HandleInteractiveContent_DEPRECATED(content, characterName = "") {
                /* å·²åºŸå¼ƒ - å®Œæ•´çš„æ—§é€»è¾‘è¢«ç§»åŠ¨åˆ°è¿™é‡Œä½œä¸ºå‚è€ƒï¼Œä½†ä¸å†è¢«è°ƒç”¨
                
                if (hasPriorReplyRequest.shouldReplyFirst) {
                    console.log("æ£€æµ‹åˆ°éœ€è¦å…ˆè¿›è¡Œç§èŠ/ç¾¤èŠå›å¤çš„è¦æ±‚");
                    
                    // å…ˆæ‰§è¡Œç§èŠ/ç¾¤èŠå›å¤
                    QQ_ExecutePriorReply(hasPriorReplyRequest.replyType, hasPriorReplyRequest.replyContent, targetCharacter);
                    
                    // å»¶è¿Ÿæ‰§è¡Œäº’åŠ¨å†…å®¹ï¼ˆç»™ç”¨æˆ·æ—¶é—´æŸ¥çœ‹å›å¤ï¼‰
                    setTimeout(() => {
                        QQ_ProceedToInteractiveMode(cleanContent, targetCharacter);
                    }, 2000); // 2ç§’å»¶è¿Ÿ
                    
                    return;
                }
                
                // ç›´æ¥è¿›å…¥äº’åŠ¨æ¨¡å¼
                QQ_ProceedToInteractiveMode(cleanContent, targetCharacter);
            }
            
            /**
             * *** æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦æœ‰å…ˆå›å¤çš„è¦æ±‚ ***
             * @param {string} content - äº’åŠ¨å†…å®¹
             * @returns {Object} å›å¤è¦æ±‚ä¿¡æ¯
             */
            function QQ_CheckPriorReplyRequest(content) {
                // æ£€æŸ¥å…ˆå›å¤çš„å…³é”®è¯æ¨¡å¼
                const priorReplyPatterns = [
                    // ç§èŠå…ˆå›å¤
                    {
                        pattern: /(?:å…ˆ|é¦–å…ˆ|å…ˆåœ¨ç§èŠ)(?:å›å¤|å›åº”|å›ç­”|è¯´)(?:.*?)(?:ç„¶å|æ¥ç€|å†)(?:.*?)(?:äº’åŠ¨|è§é¢|è¿‡æ¥)/,
                        type: 'private',
                        extract: (match) => QQ_ExtractReplyContent(match, 'private')
                    },
                    // ç¾¤èŠå…ˆå›å¤
                    {
                        pattern: /(?:å…ˆ|é¦–å…ˆ|å…ˆåœ¨ç¾¤èŠ)(?:å›å¤|å›åº”|å›ç­”|è¯´)(?:.*?)(?:ç„¶å|æ¥ç€|å†)(?:.*?)(?:äº’åŠ¨|è§é¢|è¿‡æ¥)/,
                        type: 'group',
                        extract: (match) => QQ_ExtractReplyContent(match, 'group')
                    },
                    // é€šç”¨å…ˆå›å¤æ¨¡å¼
                    {
                        pattern: /(?:å…ˆ|é¦–å…ˆ)(?:å‘|å‘é€|å›)(?:.*?)(?:æ¶ˆæ¯|ä¿¡æ¯)(?:.*?)(?:ç„¶å|æ¥ç€|å†)(?:.*?)(?:äº’åŠ¨|è§é¢|è¿‡æ¥)/,
                        type: 'auto', // è‡ªåŠ¨åˆ¤æ–­ç±»å‹
                        extract: (match) => QQ_ExtractReplyContent(match, 'auto')
                    }
                ];
                
                for (const item of priorReplyPatterns) {
                    const match = content.match(item.pattern);
                    if (match) {
                        const replyContent = item.extract(match[0]);
                        console.log(`æ£€æµ‹åˆ°å…ˆå›å¤æ¨¡å¼: ${item.type}, å†…å®¹: ${replyContent}`);
                        
                        return {
                            shouldReplyFirst: true,
                            replyType: item.type,
                            replyContent: replyContent,
                            fullMatch: match[0]
                        };
                    }
                }
                
                return { shouldReplyFirst: false };
            }
            
            /**
             * *** æ–°å¢ï¼šæå–å›å¤å†…å®¹ ***
             * @param {string} matchText - åŒ¹é…çš„æ–‡æœ¬
             * @param {string} type - å›å¤ç±»å‹
             * @returns {string} æå–çš„å›å¤å†…å®¹
             */
            function QQ_ExtractReplyContent(matchText, type) {
                // æå–"å…ˆå›å¤"å’Œ"ç„¶åäº’åŠ¨"ä¹‹é—´çš„å†…å®¹
                const replyExtractPatterns = [
                    /(?:å›å¤|å›åº”|å›ç­”|è¯´)["'"]([^"'"]*)["'"]/,  // å¼•å·å†…å®¹
                    /(?:å›å¤|å›åº”|å›ç­”|è¯´)[:ï¼š]\s*([^ï¼Œã€‚ï¼ï¼Ÿ]*)/,   // å†’å·åå†…å®¹
                    /(?:å›å¤|å›åº”|å›ç­”|è¯´)\s*([^ç„¶åæ¥ç€å†]*?)(?:ç„¶å|æ¥ç€|å†)/  // åˆ°ä¸‹ä¸€ä¸ªåŠ¨ä½œä¹‹å‰çš„å†…å®¹
                ];
                
                for (const pattern of replyExtractPatterns) {
                    const match = matchText.match(pattern);
                    if (match && match[1].trim()) {
                        return match[1].trim();
                    }
                }
                
                // å¦‚æœæ²¡æœ‰æ˜ç¡®å†…å®¹ï¼Œç”Ÿæˆé»˜è®¤å›å¤
                return type === 'private' ? 'å¥½çš„ï¼Œæˆ‘é©¬ä¸Šè¿‡æ¥' : 
                       type === 'group' ? 'å¤§å®¶ç­‰æˆ‘ä¸€ä¸‹ï¼Œé©¬ä¸Šè¿‡æ¥' :
                       'å¥½çš„ï¼Œé©¬ä¸Šè¿‡æ¥';
            }
            
            /**
             * *** æ–°å¢ï¼šæ‰§è¡Œå…ˆæœŸå›å¤ ***
             * @param {string} replyType - å›å¤ç±»å‹ (private/group/auto)
             * @param {string} replyContent - å›å¤å†…å®¹
             * @param {string} targetCharacter - ç›®æ ‡è§’è‰²
             */
            function QQ_ExecutePriorReply(replyType, replyContent, targetCharacter) {
                console.log(`æ‰§è¡Œå…ˆæœŸå›å¤: ${replyType} -> ${replyContent}`);
                
                if (replyType === 'private' || (replyType === 'auto' && QQ_IsInPrivateChat())) {
                    // ç§èŠå›å¤
                    QQ_SendPrivateMessage(targetCharacter, replyContent);
                } else if (replyType === 'group' || (replyType === 'auto' && QQ_IsInGroupChat())) {
                    // ç¾¤èŠå›å¤
                    QQ_SendGroupMessage(replyContent);
                } else {
                    // é»˜è®¤ç§èŠ
                    QQ_SendPrivateMessage(targetCharacter, replyContent);
                }
                
                // æ˜¾ç¤ºç³»ç»Ÿæç¤º
                triggerSlash(`/echo å·²å‘é€å›å¤æ¶ˆæ¯ï¼Œå³å°†è¿›å…¥äº’åŠ¨æ¨¡å¼...`);
            }
            
            /**
             * *** æ–°å¢ï¼šç»§ç»­è¿›å…¥äº’åŠ¨æ¨¡å¼ ***
             * @param {string} content - æ¸…ç†åçš„äº’åŠ¨å†…å®¹
             * @param {string} targetCharacter - ç›®æ ‡è§’è‰²
             */
            function QQ_ProceedToInteractiveMode(content, targetCharacter) {
                // æ£€æµ‹æ˜¯å¦åŒ…å«å¤šä¸ªè§’è‰²æˆ–ç¾¤èŠåœºæ™¯
                const isMultiCharacter = QQ_DetectMultiCharacterInteraction(content, targetCharacter);
                
                if (isMultiCharacter) {
                    // å¤šè§’è‰²äº’åŠ¨ï¼Œæ˜¾ç¤ºåœ¨å…¬å…±äº’åŠ¨ç©ºé—´
                    console.log("æ£€æµ‹åˆ°å¤šè§’è‰²äº’åŠ¨ï¼Œæ˜¾ç¤ºåœ¨å…¬å…±äº’åŠ¨ç©ºé—´");
                    // *** å…³é”®ä¼˜åŒ–ï¼šå¼‚æ­¥è°ƒç”¨ç¡®ä¿ä»ä¸–ç•Œä¹¦åŠ è½½ ***
                    (async () => {
                        await QQ_ShowPublicInteractiveSpace(content, targetCharacter);
                    })();
                } else {
                    // å•è§’è‰²äº’åŠ¨ï¼Œæ˜¾ç¤ºåœ¨è§’è‰²ä¸“å±ç©ºé—´
                    console.log(`æ£€æµ‹åˆ°å•è§’è‰²äº’åŠ¨ï¼Œæ˜¾ç¤ºåœ¨${targetCharacter}çš„ä¸“å±ç©ºé—´`);
                    // *** å…³é”®ä¼˜åŒ–ï¼šå¼‚æ­¥è°ƒç”¨ç¡®ä¿ä»ä¸–ç•Œä¹¦åŠ è½½ ***
                    (async () => {
                        await QQ_ShowCharacterInteractiveSpace(content, targetCharacter);
                    })();
                }
            }
            
            /**
             * *** æ–°å¢ï¼šæ£€æŸ¥å…ƒç´ æ˜¯å¦å¯è§ ***
             * @param {Element} element - è¦æ£€æŸ¥çš„å…ƒç´ 
             * @returns {boolean} æ˜¯å¦å¯è§
             */
            function QQ_IsElementVisible(element) {
                if (!element) return false;
                
                // æ£€æŸ¥displayæ ·å¼
                const style = window.getComputedStyle(element);
                if (style.display === 'none' || style.visibility === 'hidden') {
                    return false;
                }
                
                // æ£€æŸ¥opacity
                if (parseFloat(style.opacity) === 0) {
                    return false;
                }
                
                // æ£€æŸ¥å…ƒç´ å°ºå¯¸
                const rect = element.getBoundingClientRect();
                return rect.width > 0 && rect.height > 0;
            }
            
            /**
             * *** æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦åœ¨ç§èŠæ¨¡å¼ ***
             * @returns {boolean} æ˜¯å¦åœ¨ç§èŠ
             */
            function QQ_IsInPrivateChat() {
                const chatPage = document.querySelector('.QQ_chat_page');
                if (!QQ_IsElementVisible(chatPage)) return false;
                
                const chatTitle = document.getElementById('QQ_chat_username');
                return chatTitle && !chatTitle.textContent.includes('ç¾¤èŠ');
            }
            
            /**
             * *** æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦åœ¨ç¾¤èŠæ¨¡å¼ ***
             * @returns {boolean} æ˜¯å¦åœ¨ç¾¤èŠ
             */
            function QQ_IsInGroupChat() {
                const chatPage = document.querySelector('.QQ_chat_page');
                if (!QQ_IsElementVisible(chatPage)) return false;
                
                const chatTitle = document.getElementById('QQ_chat_username');
                return chatTitle && chatTitle.textContent.includes('ç¾¤èŠ');
            }
            
            /**
             * *** æ–°å¢ï¼šå‘é€ç§èŠæ¶ˆæ¯ ***
             * @param {string} characterName - è§’è‰²å
             * @param {string} content - æ¶ˆæ¯å†…å®¹
             */
            function QQ_SendPrivateMessage(characterName, content) {
                const messageData = {
                    time: QQ_GetTime(),
                    content: content,
                    sender: characterName
                };
                
                // æ„å»ºç§èŠæ ¼å¼
                const chatContent = `<${QQ_GetUserName()}å’Œ${characterName}çš„ç§èŠ>\n${characterName}--${content}--${messageData.time}\n</${QQ_GetUserName()}å’Œ${characterName}çš„ç§èŠ>`;
                
                // ç›´æ¥æ›´æ–°åˆ°å½“å‰èŠå¤©ç•Œé¢ï¼ˆå¦‚æœæ˜¯å¯¹åº”çš„ç§èŠï¼‰
                const currentChat = document.querySelector('.QQ_chat_page');
                if (currentChat && QQ_IsTargetChat(characterName)) {
                    QQ_AddMessageToCurrentChat(characterName, content, messageData.time);
                }
                
                // ä¿å­˜åˆ°æ•°æ®
                QQ_SavePrivateMessage(characterName, messageData);
                
                console.log(`å·²å‘é€ç§èŠæ¶ˆæ¯ç»™ ${characterName}: ${content}`);
            }
            
            /**
             * *** æ–°å¢ï¼šå‘é€ç¾¤èŠæ¶ˆæ¯ ***
             * @param {string} content - æ¶ˆæ¯å†…å®¹
             */
            function QQ_SendGroupMessage(content) {
                const currentGroup = QQ_GetCurrentGroupName();
                if (!currentGroup) {
                    console.warn('å½“å‰ä¸åœ¨ç¾¤èŠç•Œé¢ï¼Œæ— æ³•å‘é€ç¾¤èŠæ¶ˆæ¯');
                    return;
                }
                
                const messageData = {
                    time: QQ_GetTime(),
                    content: content,
                    sender: charcardname || "è§’è‰²"
                };
                
                // ç›´æ¥æ›´æ–°åˆ°å½“å‰ç¾¤èŠç•Œé¢
                QQ_AddMessageToCurrentChat(messageData.sender, content, messageData.time);
                
                // ä¿å­˜åˆ°æ•°æ®
                QQ_SaveGroupMessage(currentGroup, messageData);
                
                console.log(`å·²å‘é€ç¾¤èŠæ¶ˆæ¯åˆ° ${currentGroup}: ${content}`);
            }
            
            /**
             * *** æ–°å¢ï¼šè·å–å½“å‰ç¾¤èŠåç§° ***
             * @returns {string} ç¾¤èŠåç§°
             */
            function QQ_GetCurrentGroupName() {
                const chatTitle = document.getElementById('QQ_chat_username');
                if (!chatTitle) return null;
                
                const titleText = chatTitle.textContent;
                if (titleText.includes('ç¾¤èŠ:')) {
                    return titleText.replace('ç¾¤èŠ:', '').trim();
                }
                
                return null;
            }
            
            /**
             * *** æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦æ˜¯ç›®æ ‡èŠå¤© ***
             * @param {string} characterName - è§’è‰²å
             * @returns {boolean} æ˜¯å¦æ˜¯ç›®æ ‡èŠå¤©
             */
            function QQ_IsTargetChat(characterName) {
                const chatTitle = document.getElementById('QQ_chat_username');
                if (!chatTitle) return false;
                
                return chatTitle.textContent.includes(characterName);
            }
            
            /**
             * *** æ–°å¢ï¼šæ·»åŠ æ¶ˆæ¯åˆ°å½“å‰èŠå¤©ç•Œé¢ ***
             * @param {string} sender - å‘é€è€…
             * @param {string} content - æ¶ˆæ¯å†…å®¹
             * @param {string} time - æ—¶é—´
             */
            /**
             * @deprecated å·²åºŸå¼ƒï¼Œè¯·ä½¿ç”¨ QQ_EnsureMessageInChatInterface æ¥ä¿æŒæ ¼å¼ä¸€è‡´æ€§
             * æ·»åŠ æ¶ˆæ¯åˆ°å½“å‰èŠå¤©ç•Œé¢
             * @param {string} sender - å‘é€è€…
             * @param {string} content - æ¶ˆæ¯å†…å®¹
             * @param {string} time - æ—¶é—´
             */
            function QQ_AddMessageToCurrentChat(sender, content, time) {
                console.warn('âš ï¸ æ£€æµ‹åˆ°ä½¿ç”¨å·²åºŸå¼ƒçš„ QQ_AddMessageToCurrentChat å‡½æ•°ï¼Œå»ºè®®ä½¿ç”¨ QQ_EnsureMessageInChatInterface');
                
                // ä¸ºå‘åå…¼å®¹ï¼Œè°ƒç”¨æ–°çš„å‡½æ•°
                QQ_EnsureMessageInChatInterface(sender, content, time).catch(error => {
                    console.error('è°ƒç”¨ QQ_EnsureMessageInChatInterface å¤±è´¥:', error);
                    
                    // å¦‚æœæ–°å‡½æ•°å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹é€»è¾‘ä½œä¸ºå¤‡ç”¨
                    const chatMessages = document.getElementById('QQ_chat_messages');
                    if (!chatMessages) return;
                    
                    const messageElement = document.createElement('div');
                    messageElement.className = 'QQ_message';
                    messageElement.innerHTML = `
                        <div class="QQ_message_sender">${sender}</div>
                        <div class="QQ_message_content">${content}</div>
                        <div class="QQ_message_time">${time}</div>
                    `;
                    
                    chatMessages.appendChild(messageElement);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                });
            }

            /**
             * æ£€æµ‹æ˜¯å¦ä¸ºå¤šè§’è‰²äº’åŠ¨
             * @param {string} content - äº’åŠ¨å†…å®¹
             * @param {string} primaryCharacter - ä¸»è¦äº’åŠ¨çš„è§’è‰²åï¼ˆå¦‚ç§èŠå¯¹è±¡ï¼‰
             * @returns {boolean} æ˜¯å¦ä¸ºå¤šè§’è‰²äº’åŠ¨
             */
            function QQ_DetectMultiCharacterInteraction(content, primaryCharacter = null) {
                // *** ä¼˜åŒ–ï¼šç²¾ç¡®çš„å¤šäººäº’åŠ¨å…³é”®è¯æ£€æµ‹ ***
                const strongMultiKeywords = [
                    // ç›´æ¥å¤šäººç§°å‘¼
                    { keyword: 'æ‰€æœ‰äºº', context: ['å¯¹æ‰€æœ‰äºº', 'å‘Šè¯‰æ‰€æœ‰äºº', 'å’Œæ‰€æœ‰äºº'] },
                    { keyword: 'ä¼—äºº', context: ['ä¼—äººé¢å‰', 'å¯¹ä¼—äºº', 'ä¼—äººä¸€èµ·'] },
                    { keyword: 'å…¨ä½“', context: ['å…¨ä½“æˆå‘˜', 'å¯¹å…¨ä½“', 'å…¨ä½“ä¸€èµ·'] },
                    
                    // æ˜ç¡®çš„å¤šäººåŠ¨ä½œ
                    { keyword: 'æˆ‘ä»¬ä¸€èµ·', context: ['æˆ‘ä»¬ä¸€èµ·å»', 'æˆ‘ä»¬ä¸€èµ·åš', 'æˆ‘ä»¬ä¸€èµ·æ¥'] },
                    { keyword: 'ä»–ä»¬ä¸€èµ·', context: ['ä»–ä»¬ä¸€èµ·å»', 'ä»–ä»¬ä¸€èµ·åš', 'ä»–ä»¬ä¸€èµ·æ¥'] },
                    { keyword: 'å…±åŒå‚ä¸', context: ['å…±åŒå‚ä¸æ´»åŠ¨', 'å…±åŒå‚ä¸è®¨è®º'] },
                    { keyword: 'åŒæ—¶å‚ä¸', context: ['åŒæ—¶å‚ä¸äº’åŠ¨', 'åŒæ—¶å‚ä¸æ´»åŠ¨'] },
                    
                    // ç©ºé—´ä½ç½®çš„å¤šäººåœºæ™¯
                    { keyword: 'å›´æˆåœˆ', context: ['å›´æˆåœˆå', 'å›´æˆåœˆç«™', 'å›´æˆåœˆè®¨è®º'] },
                    { keyword: 'æ’æˆé˜Ÿ', context: ['æ’æˆé˜Ÿèµ°', 'æ’æˆé˜Ÿç­‰', 'æ’æˆé˜Ÿç«™'] },
                    { keyword: 'åˆ†æˆç»„', context: ['åˆ†æˆç»„è®¨è®º', 'åˆ†æˆç»„æ´»åŠ¨', 'åˆ†æˆç»„è¿›è¡Œ'] },
                    { keyword: 'èšåœ¨ä¸€èµ·', context: ['èšåœ¨ä¸€èµ·èŠ', 'èšåœ¨ä¸€èµ·ç©', 'èšåœ¨ä¸€èµ·è®¨è®º'] }
                ];
                
                // æ£€æŸ¥æ˜¯å¦æœ‰çœŸå®çš„å¤šäººäº’åŠ¨æ„å›¾
                for (const item of strongMultiKeywords) {
                    if (content.includes(item.keyword)) {
                        // æ£€æŸ¥ä¸Šä¸‹æ–‡æ˜¯å¦ç¬¦åˆå¤šäººäº’åŠ¨æ„å›¾
                        const hasValidContext = item.context.some(ctx => content.includes(ctx)) ||
                                              QQ_IsValidMultiPersonContext(content, item.keyword);
                        
                        if (hasValidContext) {
                            console.log('æ£€æµ‹åˆ°æœ‰æ•ˆå¤šäººäº’åŠ¨å…³é”®è¯:', item.keyword);
                            return true;
                        } else {
                            console.log('å…³é”®è¯å­˜åœ¨ä½†ä¸Šä¸‹æ–‡ä¸ç¬¦åˆå¤šäººäº’åŠ¨:', item.keyword);
                        }
                    }
                }
                
                // *** ä¼˜åŒ–ï¼šæ£€æµ‹å¤šä¸ªè§’è‰²åæåŠï¼Œä½†è€ƒè™‘ä¸»è¦äº’åŠ¨è€… ***
                const characterMentions = content.match(/[@ã€ï¼ˆï¼œ]\s*([^@ã€ï¼ˆï¼œã€‘ï¼‰ï¼\s]{2,8})\s*[ã€‘ï¼‰ï¼]/g) || [];
                const uniqueCharacters = [...new Set(characterMentions.map(m => m.replace(/[@ã€ï¼ˆï¼œã€‘ï¼‰ï¼]/g, '').trim()))];
                
                // å¦‚æœæœ‰ä¸»è¦è§’è‰²ï¼ˆå¦‚ç§èŠå¯¹è±¡ï¼‰ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºä¸»å¯¼äº’åŠ¨
                if (primaryCharacter && uniqueCharacters.length >= 1) {
                    // æ£€æŸ¥ä¸»è¦è§’è‰²æ˜¯å¦æ˜¯äº’åŠ¨çš„æ ¸å¿ƒ
                    const isPrimaryDominant = QQ_IsPrimaryCharacterDominant(content, primaryCharacter, uniqueCharacters);
                    if (isPrimaryDominant) {
                        console.log('ä¸»è¦è§’è‰²ä¸»å¯¼äº’åŠ¨ï¼Œå½’å…¥è§’è‰²ä¸“å±ç©ºé—´:', primaryCharacter);
                        return false; // å½’å…¥è§’è‰²ä¸“å±ç©ºé—´
                    }
                }
                
                // å¤šä¸ªè§’è‰²ä¸”æ²¡æœ‰ä¸»å¯¼è€…ï¼Œè§†ä¸ºå¤šäººäº’åŠ¨
                if (uniqueCharacters.length > 1) {
                    console.log('å¤šä¸ªè§’è‰²å‚ä¸ä¸”æ— ä¸»å¯¼è€…ï¼Œå½’å…¥å…¬å…±ç©ºé—´:', uniqueCharacters);
                    return true;
                }
                
                // *** ä¼˜åŒ–ï¼šæ£€æµ‹å¤šäººåœºæ™¯æè¿°ï¼Œä½†æ›´ä¸¥æ ¼ ***
                const strongMultiPersonPatterns = [
                    /(\w+)å’Œ(\w+)(?:ä»¥åŠ|è¿˜æœ‰|åŠ ä¸Š)(\w+)/,  // Aå’ŒBä»¥åŠC
                    /(\w+)ã€(\w+)(?:ã€(\w+))+/,           // Aã€Bã€Cç­‰
                    /(?:å’Œ|ä¸|è·Ÿ)(\w+)(?:ä»–ä»¬|å¥¹ä»¬|å¤§å®¶)(?:ä¸€èµ·|åŒæ—¶)/,  // å’ŒæŸäººä»–ä»¬ä¸€èµ·
                    /(?:æˆ‘ä»¬|å’±ä»¬)(?:å‡ ä¸ª|å¤šä¸ª|å…¨éƒ¨)(?:ä¸€èµ·|åŒæ—¶)/      // æˆ‘ä»¬å‡ ä¸ªä¸€èµ·
                ];
                
                if (strongMultiPersonPatterns.some(pattern => pattern.test(content))) {
                    console.log('æ£€æµ‹åˆ°å¼ºçƒˆå¤šäººåœºæ™¯æè¿°');
                    return true;
                }
                
                console.log('åˆ¤å®šä¸ºå•äºº/è§’è‰²ä¸»å¯¼äº’åŠ¨');
                return false;
            }
            
            /**
             * *** æ–°å¢ï¼šéªŒè¯å¤šäººäº’åŠ¨ä¸Šä¸‹æ–‡çš„æœ‰æ•ˆæ€§ ***
             * @param {string} content - äº’åŠ¨å†…å®¹
             * @param {string} keyword - æ£€æµ‹åˆ°çš„å…³é”®è¯
             * @returns {boolean} ä¸Šä¸‹æ–‡æ˜¯å¦æœ‰æ•ˆ
             */
            function QQ_IsValidMultiPersonContext(content, keyword) {
                // æ’é™¤ä¸ç¬¦åˆå¤šäººäº’åŠ¨çš„ä¸Šä¸‹æ–‡
                const invalidContexts = [
                    // æè¿°æ€§è¯­è¨€ï¼Œä¸æ˜¯å®é™…äº’åŠ¨è¯·æ±‚
                    /é›†ä½“è¡ŒåŠ¨/,
                    /é›†ä½“æ´»åŠ¨/,
                    /é›†ä½“å†³ç­–/,
                    /é›†ä½“åˆ©ç›Š/,
                    /é›†ä½“æ„è¯†/,
                    /é›†ä½“è®°å¿†/,
                    
                    // æŠ½è±¡æ¦‚å¿µï¼Œä¸æ˜¯å…·ä½“äº’åŠ¨
                    /æ¦‚å¿µä¸Š/,
                    /ç†è®ºä¸Š/,
                    /åŸåˆ™ä¸Š/,
                    /æ€æƒ³ä¸Š/,
                    /ç²¾ç¥ä¸Š/,
                    
                    // è¿‡å»æ—¶æ€ï¼Œä¸æ˜¯å½“å‰äº’åŠ¨è¯·æ±‚
                    /æ›¾ç».*ä¸€èµ·/,
                    /ä»¥å‰.*ä¸€èµ·/,
                    /ä¹‹å‰.*ä¸€èµ·/,
                    /è¿‡å».*ä¸€èµ·/,
                    
                    // æ¡ä»¶å¥ï¼Œä¸æ˜¯ç¡®å®šçš„äº’åŠ¨
                    /å¦‚æœ.*ä¸€èµ·/,
                    /å‡å¦‚.*ä¸€èµ·/,
                    /è¦æ˜¯.*ä¸€èµ·/,
                    /å€˜è‹¥.*ä¸€èµ·/
                ];
                
                // å¦‚æœå†…å®¹åŒ…å«æ— æ•ˆä¸Šä¸‹æ–‡ï¼Œè¿”å›false
                if (invalidContexts.some(pattern => pattern.test(content))) {
                    console.log(`å…³é”®è¯"${keyword}"çš„ä¸Šä¸‹æ–‡æ— æ•ˆï¼Œä¸ç¬¦åˆäº’åŠ¨æ„å›¾`);
                    return false;
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æ˜ç¡®çš„äº’åŠ¨åŠ¨è¯
                const interactiveVerbs = [
                    /ä¸€èµ·(å»|æ¥|åš|ç©|èŠ|è®¨è®º|å‚ä¸|è¿›è¡Œ)/,
                    /(å¯¹|å’Œ|è·Ÿ).*(è¯´|è®²|èŠ|äº¤æµ)/,
                    /(æŠ±|æ‹¥æŠ±|äº²å»|æ¡æ‰‹|æ‹|ç¢°|æ‘¸)/,
                    /(çœ‹|æœ›|æ³¨è§†|å‡è§†).*(ç€|å‘)/,
                    /(èµ°å‘|èµ°è¿‘|é è¿‘|æ¥è¿‘)/
                ];
                
                const hasInteractiveVerb = interactiveVerbs.some(pattern => pattern.test(content));
                
                // æ£€æŸ¥æ˜¯å¦æœ‰å½“å‰æ—¶æ€çš„äº’åŠ¨è¯·æ±‚
                const currentTimeIndicators = [
                    /ç°åœ¨/,
                    /æ­¤åˆ»/,
                    /å½“å‰/,
                    /é©¬ä¸Š/,
                    /ç«‹å³/,
                    /æ­£åœ¨/,
                    /è¦.*ä¸€èµ·/,
                    /æƒ³.*ä¸€èµ·/,
                    /å‡†å¤‡.*ä¸€èµ·/
                ];
                
                const hasCurrentTime = currentTimeIndicators.some(pattern => pattern.test(content));
                
                return hasInteractiveVerb || hasCurrentTime;
            }

            /**
             * *** æ–°å¢ï¼šåˆ¤æ–­ä¸»è¦è§’è‰²æ˜¯å¦ä¸»å¯¼äº’åŠ¨ ***
             * @param {string} content - äº’åŠ¨å†…å®¹
             * @param {string} primaryCharacter - ä¸»è¦è§’è‰²å
             * @param {string[]} allCharacters - æ‰€æœ‰æåŠçš„è§’è‰²
             * @returns {boolean} ä¸»è¦è§’è‰²æ˜¯å¦ä¸»å¯¼
             */
            function QQ_IsPrimaryCharacterDominant(content, primaryCharacter, allCharacters) {
                // è®¡ç®—ä¸»è¦è§’è‰²åœ¨å†…å®¹ä¸­çš„é‡è¦æ€§æƒé‡
                let primaryWeight = 0;
                let otherWeight = 0;
                
                // 1. è§’è‰²åå‡ºç°é¢‘ç‡
                const primaryCount = (content.match(new RegExp(primaryCharacter, 'g')) || []).length;
                const otherCounts = allCharacters
                    .filter(char => char !== primaryCharacter)
                    .reduce((sum, char) => sum + (content.match(new RegExp(char, 'g')) || []).length, 0);
                
                primaryWeight += primaryCount * 2;
                otherWeight += otherCounts;
                
                // 2. äº’åŠ¨åŠ¨è¯çš„ä¸»è¯­æ£€æµ‹
                const interactionPatterns = [
                    new RegExp(`${primaryCharacter}(?:èµ°å‘|èµ°è¿‘|æŠ±ä½|æ‹‰ä½|çœ‹ç€|å¯¹.*è¯´)`, 'g'),
                    new RegExp(`(?:èµ°å‘|èµ°è¿‘|æŠ±ä½|æ‹‰ä½|çœ‹ç€|å¯¹)${primaryCharacter}`, 'g'),
                ];
                
                interactionPatterns.forEach(pattern => {
                    const matches = content.match(pattern) || [];
                    primaryWeight += matches.length * 3;
                });
                
                // 3. ç›´æ¥å¯¹è¯æ£€æµ‹
                const directDialogPatterns = [
                    new RegExp(`${primaryCharacter}[è¯´é“è®²]`, 'g'),
                    new RegExp(`å¯¹${primaryCharacter}è¯´`, 'g'),
                ];
                
                directDialogPatterns.forEach(pattern => {
                    const matches = content.match(pattern) || [];
                    primaryWeight += matches.length * 2;
                });
                
                // 4. ä½ç½®å…³ç³»æ£€æµ‹ï¼ˆç§å¯†äº’åŠ¨ï¼‰
                const intimatePatterns = [
                    new RegExp(`(?:å’Œ|ä¸|è·Ÿ)${primaryCharacter}(?:å•ç‹¬|ç§ä¸‹|æ‚„æ‚„|å·å·)`, 'g'),
                    new RegExp(`${primaryCharacter}(?:å•ç‹¬|ç§ä¸‹|æ‚„æ‚„|å·å·)`, 'g'),
                ];
                
                intimatePatterns.forEach(pattern => {
                    const matches = content.match(pattern) || [];
                    primaryWeight += matches.length * 4;
                });
                
                console.log(`è§’è‰²ä¸»å¯¼æƒé‡åˆ†æ - ${primaryCharacter}: ${primaryWeight}, å…¶ä»–è§’è‰²: ${otherWeight}`);
                
                // ä¸»è¦è§’è‰²æƒé‡è¶…è¿‡å…¶ä»–è§’è‰²æ€»å’Œçš„60%æ—¶ï¼Œè®¤ä¸ºæ˜¯ä¸»å¯¼
                return primaryWeight > otherWeight * 0.6;
            }
            
            /**
             * æ˜¾ç¤ºå…¬å…±äº’åŠ¨ç©ºé—´
             * @param {string} content - äº’åŠ¨å†…å®¹
             * @param {string} characterName - ä¸»è¦è§’è‰²åç§°
             */
            function QQ_ShowPublicInteractiveSpace(content, characterName = "") {
                const spaceId = QQ_GenerateSpaceId();
                const spaceName = QQ_GetSpaceName(content, characterName);
                const charName = characterName || charcardname || "è§’è‰²";
                const charAvatar = charAvatarPath || "default_avatar.png";
                
                // ä¿å­˜åˆ°å…¬å…±äº’åŠ¨ç©ºé—´
                QQ_InteractiveSpaces[spaceId] = {
                    id: spaceId,
                    name: spaceName,
                    content: content,
                    characterName: charName,
                    characterAvatar: charAvatar,
                    type: 'public',
                    participants: QQ_ExtractParticipants(content),
                    createdAt: new Date().toISOString(),
                    lastAccess: new Date().toISOString()
                };
                
                QQ_ActiveSpaceId = spaceId;
                
                // *** ç«‹å³ä¿å­˜åˆ°ä¸–ç•Œä¹¦ - ç¡®ä¿æ•°æ®æŒä¹…åŒ– ***
                console.log('ğŸ  ä¿å­˜å…¬å…±äº’åŠ¨ç©ºé—´åˆ°ä¸–ç•Œä¹¦:', spaceId);
                QQ_SaveInteractiveSpaces().then(() => {
                    console.log('âœ… å…¬å…±äº’åŠ¨ç©ºé—´æ•°æ®å·²ä¿å­˜åˆ°ä¸–ç•Œä¹¦');
                }).catch(error => {
                    console.error('âŒ å…¬å…±äº’åŠ¨ç©ºé—´ä¿å­˜å¤±è´¥:', error);
                });
                
                QQ_DisplayInteractiveSpace(spaceId, 'å…¬å…±äº’åŠ¨ç©ºé—´');
            }
            
            /**
             * æ˜¾ç¤ºè§’è‰²ä¸“å±äº’åŠ¨ç©ºé—´
             * @param {string} content - äº’åŠ¨å†…å®¹
             * @param {string} characterName - è§’è‰²åç§°
             */
            async function QQ_ShowCharacterInteractiveSpace(content, characterName) {
                const charName = characterName || charcardname || "è§’è‰²";
                
                // *** å…³é”®ä¼˜åŒ–ï¼šå…ˆä»ä¸–ç•Œä¹¦é‡æ–°åŠ è½½è§’è‰²ç©ºé—´æ•°æ® ***
                console.log(`ğŸ”„ é‡æ–°åŠ è½½è§’è‰² ${charName} çš„äº’åŠ¨ç©ºé—´æ•°æ®`);
                await QQ_ForceReloadInteractiveSpaces();
                const spaceId = QQ_GenerateSpaceId();
                const spaceName = `${charName}Â·${QQ_GetSceneFromContent(content)}`;
                const charAvatar = charAvatarPath || "default_avatar.png";
                
                // ä½¿ç”¨ç‹¬ç«‹æ€§æ£€æŸ¥åˆå§‹åŒ–è§’è‰²ä¸“å±ç©ºé—´æ•°æ®
                QQ_EnsureCharacterSpaceIndependence(charName);
                
                // ä¿å­˜åˆ°è§’è‰²ä¸“å±ç©ºé—´
                QQ_CharacterSpaces[charName][spaceId] = {
                    id: spaceId,
                    name: spaceName,
                    content: content,
                    characterName: charName,
                    characterAvatar: charAvatar,
                    type: 'character',
                    createdAt: new Date().toISOString(),
                    lastAccess: new Date().toISOString()
                };
                
                QQ_ActiveSpaceId = spaceId;
                
                // *** ç«‹å³ä¿å­˜åˆ°ä¸–ç•Œä¹¦ - ç¡®ä¿æ•°æ®æŒä¹…åŒ– ***
                console.log(`ğŸ‘¤ ä¿å­˜è§’è‰²äº’åŠ¨ç©ºé—´åˆ°ä¸–ç•Œä¹¦: ${charName} - ${spaceId}`);
                
                // å¼‚æ­¥ä¿å­˜è§’è‰²ç©ºé—´æ•°æ®ï¼ˆéé˜»å¡ï¼‰
                QQ_SaveCharacterSpaces().then(() => {
                    console.log(`âœ… è§’è‰²äº’åŠ¨ç©ºé—´æ•°æ®å·²ä¿å­˜åˆ°ä¸–ç•Œä¹¦: ${charName}`);
                }).catch(error => {
                    console.error(`âŒ è§’è‰²äº’åŠ¨ç©ºé—´ä¿å­˜å¤±è´¥: ${charName}`, error);
                });
                
                QQ_DisplayCharacterSpace(spaceId, charName);
            }
            
            /**
             * ä»å†…å®¹ä¸­æå–å‚ä¸è€…
             * @param {string} content - äº’åŠ¨å†…å®¹
             * @returns {string[]} å‚ä¸è€…åˆ—è¡¨
             */
            function QQ_ExtractParticipants(content) {
                const mentions = content.match(/[@ã€ï¼ˆï¼œ]\s*([^@ã€ï¼ˆï¼œã€‘ï¼‰ï¼\s]{2,8})\s*[ã€‘ï¼‰ï¼]/g) || [];
                const participants = mentions.map(m => m.replace(/[@ã€ï¼ˆï¼œã€‘ï¼‰ï¼]/g, '').trim());
                return [...new Set(participants)]; // å»é‡
            }
            
            /**
             * ä»å†…å®¹ä¸­æå–åœºæ™¯å…³é”®è¯
             * @param {string} content - äº’åŠ¨å†…å®¹
             * @returns {string} åœºæ™¯åç§°
             */
            function QQ_GetSceneFromContent(content) {
                const sceneKeywords = [
                    { keywords: ['æ‹¥æŠ±', 'æŠ±æŠ±', 'å®‰æ…°'], name: 'æ¸©æš–æ—¶åˆ»' },
                    { keywords: ['èŠå¤©', 'è°ˆè¯', 'äº¤æµ'], name: 'è°ˆè¯' },
                    { keywords: ['æ¸¸æˆ', 'ç©è€', 'å¨±ä¹'], name: 'æ¸¸æˆ' },
                    { keywords: ['å­¦ä¹ ', 'å·¥ä½œ', 'åŠªåŠ›'], name: 'å­¦ä¹ ' },
                    { keywords: ['æ•£æ­¥', 'èµ°è·¯', 'é€›'], name: 'æ•£æ­¥' },
                    { keywords: ['åƒé¥­', 'ç”¨é¤', 'é£Ÿç‰©'], name: 'ç”¨é¤' },
                    { keywords: ['ç¡è§‰', 'ä¼‘æ¯', 'åˆç¡'], name: 'ä¼‘æ¯' },
                    { keywords: ['çœ‹ä¹¦', 'é˜…è¯»', 'å­¦ä¹ '], name: 'é˜…è¯»' },
                ];
                
                for (const scene of sceneKeywords) {
                    if (scene.keywords.some(keyword => content.includes(keyword))) {
                        return scene.name;
                    }
                }
                
                return 'æ—¥å¸¸';
            }
            
            /**
             * ä¿å­˜è§’è‰²ä¸“å±äº’åŠ¨ç©ºé—´åˆ°ä¸–ç•Œä¹¦
             */
            async function QQ_SaveCharacterSpaces() {
                try {
                    if (!worldbook || !entries) {
                        console.warn('ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨ï¼Œæ— æ³•ä¿å­˜è§’è‰²äº’åŠ¨ç©ºé—´');
                        return;
                    }
                    
                    const spaceData = {
                        characterSpaces: QQ_CharacterSpaces,
                        lastUpdated: new Date().toISOString(),
                        version: "1.0"
                    };
                    
                    // åˆ›å»ºæˆ–æ›´æ–°ä¸–ç•Œä¹¦æ¡ç›®
                    let entry = entries.find(e => e.comment === QQ_CHARACTER_SPACES_KEY);
                    if (!entry) {
                        entry = {
                            comment: QQ_CHARACTER_SPACES_KEY,
                            content: JSON.stringify(spaceData),
                            key: ["æ­¤ä¸–ç•Œä¹¦æ°¸ä¸è§¦å‘_è§’è‰²äº’åŠ¨ç©ºé—´"],
                            keysecondary: [],
                            order: 1001,
                            enabled: true,
                            uid: Date.now() + 1
                        };
                        // æ·»åŠ åˆ°worldbook.entriesï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                        if (worldbook.entries) {
                            worldbook.entries.push(entry);
                        }
                    } else {
                        entry.content = JSON.stringify(spaceData);
                    }
                    
                    const success = await QQ_SafeSaveWorldInfo("è§’è‰²äº’åŠ¨ç©ºé—´æ•°æ®");
                    if (success) {
                        const totalSpaces = Object.values(QQ_CharacterSpaces).reduce((sum, char) => sum + Object.keys(char).length, 0);
                        console.log('è§’è‰²äº’åŠ¨ç©ºé—´æ•°æ®ä¿å­˜å®Œæˆ:', Object.keys(QQ_CharacterSpaces).length, 'ä¸ªè§’è‰²,', totalSpaces, 'ä¸ªç©ºé—´');
                    }
                } catch (error) {
                    console.error('ä¿å­˜è§’è‰²äº’åŠ¨ç©ºé—´æ—¶å‘ç”Ÿé”™è¯¯:', error);
                }
            }
            
            /**
             * æ˜¾ç¤ºé€šç”¨äº’åŠ¨ç©ºé—´ç•Œé¢
             * @param {string} spaceId - ç©ºé—´ID
             * @param {string} spaceTitle - ç©ºé—´æ ‡é¢˜
             * @param {string} characterName - è§’è‰²åï¼ˆå¯é€‰ï¼Œç”¨äºè§’è‰²ä¸“å±ç©ºé—´ï¼‰
             */
            function QQ_DisplayInteractiveSpace(spaceId, spaceTitle, characterName = null) {
                const spaceData = characterName ? 
                    QQ_CharacterSpaces[characterName][spaceId] : 
                    QQ_InteractiveSpaces[spaceId];
                
                if (!spaceData) {
                    console.error('æœªæ‰¾åˆ°äº’åŠ¨ç©ºé—´æ•°æ®:', spaceId);
                    return;
                }
                
                // ç§»é™¤ç°æœ‰çš„äº’åŠ¨ç©ºé—´
                $('.QQ_interactive_space').remove();
                
                const isCharacterSpace = spaceData.type === 'character';
                const headerColor = isCharacterSpace ? 
                    'linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%)' : 
                    'linear-gradient(135deg, #4FC3F7 0%, #29B6F6 100%)';
                
                // åˆ›å»ºäº’åŠ¨ç©ºé—´HTML - ç°ä»£åŒ–æ‰‹æœºç•Œé¢é£æ ¼
                const interactiveSpaceHtml = `
                    <div class="QQ_interactive_space" data-space-id="${spaceId}" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.7);
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        animation: fadeIn 0.3s ease;
                        backdrop-filter: blur(10px);
                    ">
                        <div class="QQ_interactive_content" style="
                            background: #ffffff;
                            border-radius: 20px;
                            padding: 0;
                            max-width: 90%;
                            max-height: 80%;
                            overflow: hidden;
                            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                            position: relative;
                            color: #333;
                            animation: slideIn 0.3s ease;
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        ">
                            <div class="QQ_interactive_header" style="
                                background: ${headerColor};
                                padding: 25px 20px;
                                display: flex;
                                align-items: center;
                                color: white;
                                position: relative;
                            ">
                                <img src="${spaceData.characterAvatar}" alt="${spaceData.characterName}" style="
                                    width: 50px;
                                    height: 50px;
                                    border-radius: 50%;
                                    margin-right: 15px;
                                    border: 3px solid white;
                                    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
                                ">
                                <div style="flex: 1;">
                                    <h3 style="margin: 0; font-size: 18px; font-weight: 600;">${spaceData.name}</h3>
                                    <p style="margin: 5px 0 0 0; font-size: 13px; opacity: 0.9;">
                                        ${isCharacterSpace ? `${spaceData.characterName}çš„ä¸“å±äº’åŠ¨` : 'å…¬å…±äº’åŠ¨ç©ºé—´'}
                                    </p>
                                </div>
                                <button class="QQ_close_interactive" style="
                                    background: rgba(255, 255, 255, 0.2);
                                    border: none;
                                    color: white;
                                    width: 36px;
                                    height: 36px;
                                    border-radius: 50%;
                                    cursor: pointer;
                                    font-size: 20px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" 
                                   onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">
                                    Ã—
                                </button>
                            </div>
                            <div class="QQ_interactive_body" style="
                                padding: 30px 25px;
                                font-size: 16px;
                                line-height: 1.6;
                                white-space: pre-wrap;
                                color: #333;
                                background: #fafafa;
                                max-height: 350px;
                                overflow-y: auto;
                                word-wrap: break-word;
                            ">${spaceData.content}</div>
                            <div class="QQ_interactive_footer" style="
                                padding: 25px;
                                background: #ffffff;
                                border-top: 1px solid #eee;
                                display: flex;
                                justify-content: center;
                                gap: 15px;
                            ">
                                <button class="QQ_reply_interactive" style="
                                    background: ${isCharacterSpace ? '#FF6B6B' : '#4FC3F7'};
                                    border: none;
                                    color: white;
                                    padding: 14px 28px;
                                    border-radius: 25px;
                                    cursor: pointer;
                                    font-size: 15px;
                                    font-weight: 500;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 3px 10px ${isCharacterSpace ? 'rgba(255, 107, 107, 0.3)' : 'rgba(79, 195, 247, 0.3)'};
                                " onmouseover="this.style.transform='translateY(-2px)'" 
                                   onmouseout="this.style.transform='translateY(0)'">
                                    ğŸ’¬ å›åº”äº’åŠ¨
                                </button>
                                <button class="QQ_close_interactive" style="
                                    background: #f5f5f5;
                                    border: none;
                                    color: #666;
                                    padding: 14px 28px;
                                    border-radius: 25px;
                                    cursor: pointer;
                                    font-size: 15px;
                                    font-weight: 500;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.background='#eeeeee'" 
                                   onmouseout="this.style.background='#f5f5f5'">
                                    å…³é—­
                                </button>
                            </div>
                        </div>
                    </div>
                    <style>
                        @keyframes fadeIn {
                            from { opacity: 0; }
                            to { opacity: 1; }
                        }
                        @keyframes slideIn {
                            from { transform: translateY(-30px); opacity: 0; }
                            to { transform: translateY(0); opacity: 1; }
                        }
                        .QQ_interactive_space * {
                            user-select: text;
                        }
                        .QQ_interactive_body::-webkit-scrollbar {
                            width: 6px;
                        }
                        .QQ_interactive_body::-webkit-scrollbar-track {
                            background: #f1f1f1;
                            border-radius: 3px;
                        }
                        .QQ_interactive_body::-webkit-scrollbar-thumb {
                            background: #c1c1c1;
                            border-radius: 3px;
                        }
                        .QQ_interactive_body::-webkit-scrollbar-thumb:hover {
                            background: #a8a8a8;
                        }
                    </style>
                `;
                
                // æ·»åŠ åˆ°é¡µé¢
                $('body').append(interactiveSpaceHtml);
                
                // ç»‘å®šäº‹ä»¶
                $('.QQ_close_interactive').on('click', function() {
                    $('.QQ_interactive_space').fadeOut(300, function() {
                        $(this).remove();
                    });
                });
                
                $('.QQ_reply_interactive').on('click', function() {
                    QQ_OpenInteractiveReply(isCharacterSpace ? characterName : spaceData.characterName);
                });
                
                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                $('.QQ_interactive_space').on('click', function(e) {
                    if (e.target === this) {
                        $(this).fadeOut(300, function() {
                            $(this).remove();
                        });
                    }
                });
            }
            
            /**
             * æ˜¾ç¤ºè§’è‰²ä¸“å±ç©ºé—´ï¼ˆä¸ºç‚¹å‡»ç§èŠåç§°è°ƒç”¨ï¼‰
             * @param {string} spaceId - ç©ºé—´ID  
             * @param {string} characterName - è§’è‰²åç§°
             */
            function QQ_DisplayCharacterSpace(spaceId, characterName) {
                QQ_DisplayInteractiveSpace(spaceId, `${characterName}çš„äº’åŠ¨ç©ºé—´`, characterName);
            }
            
            /**
             * æ˜¾ç¤ºè§’è‰²ä¸“å±äº’åŠ¨ç©ºé—´èœå•ï¼ˆç‚¹å‡»ç§èŠåç§°æ—¶è°ƒç”¨ï¼‰
             * @param {string} characterName - è§’è‰²åç§°
             * @param {HTMLElement} element - ç‚¹å‡»çš„å…ƒç´ 
             */
            function QQ_ShowCharacterInteractiveMenu(characterName, element) {
                console.log(`=== QQ_ShowCharacterInteractiveMenu è¢«è°ƒç”¨ ===`);
                console.log('è§’è‰²åç§°:', characterName);
                console.log('ç‚¹å‡»å…ƒç´ :', element);
                
                // æ–°é€»è¾‘ï¼šæ˜¾ç¤ºè§’è‰²ä¸“å±ç²¾çµæŒ‰é’®
                QQ_ShowCharacterSpirit(characterName);
            }
            
            // ===== ä¸–ç•Œä¹¦ä¿å­˜åŠŸèƒ½æ£€æŸ¥ =====
            
            /**
             * æ£€æŸ¥ä¸–ç•Œä¹¦ä¿å­˜åŠŸèƒ½æ˜¯å¦å¯ç”¨
             * @returns {boolean} ä¸–ç•Œä¹¦åŠŸèƒ½æ˜¯å¦å¯ç”¨
             */
            /**
             * *** ç®€åŒ–ç‰ˆï¼šä¸–ç•Œä¹¦å¯ç”¨æ€§æ£€æµ‹å‡½æ•° - ä¸å…¶ä»–åŠŸèƒ½ä¿æŒä¸€è‡´ ***
             * ä½¿ç”¨ä¸åŠ¨æ€å†…å®¹ã€åˆ†ç»„ã€äº’åŠ¨ç­‰åŠŸèƒ½ç›¸åŒçš„ç®€å•æ£€æŸ¥æ–¹å¼
             */
            function QQ_IsWorldBookAvailable() {
                // *** ä½¿ç”¨ä¸æ‰€æœ‰å…¶ä»–åŠŸèƒ½ç›¸åŒçš„ç®€å•æ£€æŸ¥æ–¹å¼ ***
                if (!worldbook || !entries) {
                    // å°è¯•é‡æ–°è·å–ä¸–ç•Œä¹¦å¯¹è±¡ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
                    if (!worldbook) {
                        const sources = [
                            () => window.world_info,
                            () => window.worldbook,
                            () => globalThis.world_info,
                            () => globalThis.worldbook
                        ];
                        
                        for (const getSource of sources) {
                            try {
                                const source = getSource();
                                if (source && typeof source === 'object') {
                                    worldbook = source;
                                    window.worldbook = worldbook;
                                    console.log('âœ… é‡æ–°è·å–ä¸–ç•Œä¹¦å¯¹è±¡æˆåŠŸ');
                                    break;
                                }
                            } catch (e) {
                                // ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ªæ¥æº
                            }
                        }
                    }
                    
                    // å†æ¬¡æ£€æŸ¥
                    if (!worldbook || !entries) {
                        console.warn('âš ï¸ ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨: worldbookæˆ–entriesæœªå®šä¹‰');
                        return false;
                    }
                }
                
                return true;
            }
            
            /**
             * å®‰å…¨åœ°ä¿å­˜åˆ°ä¸–ç•Œä¹¦ï¼ˆç®€åŒ–ç‰ˆ - ä¸å…¶ä»–åŠŸèƒ½ä¿æŒä¸€è‡´ï¼‰
             * @param {string} operation - æ“ä½œæè¿°
             * @returns {Promise<boolean>} ä¿å­˜æ˜¯å¦æˆåŠŸ
             */
            async function QQ_SafeSaveWorldInfo(operation = "æ•°æ®") {
                try {
                    // *** ä½¿ç”¨ä¸å…¶ä»–åŠŸèƒ½ç›¸åŒçš„ç®€å•æ£€æŸ¥æ–¹å¼ ***
                    if (!worldbook || !entries) {
                        console.warn(`ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨ï¼Œæ— æ³•ä¿å­˜${operation}`);
                        return false;
                    }
                    
                    // *** ç®€åŒ–ç‰ˆï¼šåªåœ¨å‡½æ•°å­˜åœ¨æ—¶è°ƒç”¨ï¼Œå¦åˆ™ä¾èµ–è‡ªåŠ¨ä¿å­˜ ***
                    if (typeof saveWorldInfo === 'function') {
                        await saveWorldInfo();
                        console.log(`${operation}å·²æˆåŠŸä¿å­˜åˆ°ä¸–ç•Œä¹¦`);
                    } else {
                        console.log(`${operation}å·²æ›´æ–°åˆ°ä¸–ç•Œä¹¦ï¼Œä¾èµ–è‡ªåŠ¨ä¿å­˜æœºåˆ¶`);
                    }
                    return true;
                } catch (error) {
                    console.error(`ä¿å­˜${operation}åˆ°ä¸–ç•Œä¹¦å¤±è´¥:`, error);
                    return false;
                }
            }
            
            // ===== è§’è‰²ä¸“å±ç²¾çµæŒ‰é’®ç³»ç»Ÿ =====
            
            let QQ_CharacterSpirits = {}; // å­˜å‚¨æ¯ä¸ªè§’è‰²çš„ç²¾çµæŒ‰é’®çŠ¶æ€
            
            /**
             * è·å–è§’è‰²å¤´åƒ
             * @param {string} characterName - è§’è‰²åç§°
             * @returns {string} å¤´åƒURL
             */
            function QQ_GetCharacterAvatar(characterName) {
                try {
                    // å°è¯•å¤šç§æ–¹å¼è·å–å¤´åƒ
                    let avatarUrl = null;
                    
                    console.log(`=== å¼€å§‹è·å–è§’è‰² ${characterName} çš„å¤´åƒ ===`);
                    
                    // *** ä¼˜å…ˆæ–¹æ³•ï¼šä»ä¸–ç•Œä¹¦'æ‰‹æœº-è§’è‰²'ä¸­è·å– ***
                    const worldbookAvatar = getCharacterAvatarFromWorldbook(characterName);
                    if (worldbookAvatar && worldbookAvatar.avatarUrl) {
                        avatarUrl = worldbookAvatar.avatarUrl;
                        console.log(`âœ… ä½¿ç”¨ä¸–ç•Œä¹¦å¤´åƒ: ${avatarUrl}`);
                        return avatarUrl;
                    }
                    
                    // æ–¹æ³•1: ä»å½“å‰èŠå¤©ç•Œé¢è·å–
                    const chatAvatar = $(`.QQ_chat_item[data-name="${characterName}"] img`).attr('src');
                    console.log(`æ–¹æ³•1 - èŠå¤©ç•Œé¢å¤´åƒ: ${chatAvatar}`);
                    if (chatAvatar && chatAvatar !== 'undefined' && chatAvatar !== '' && !chatAvatar.includes('undefined')) {
                        avatarUrl = chatAvatar;
                        console.log(`âœ… ä½¿ç”¨èŠå¤©ç•Œé¢å¤´åƒ: ${avatarUrl}`);
                    }
                    
                    // æ–¹æ³•2: ä»è”ç³»äººç•Œé¢è·å–ï¼ˆä¸ä¸–ç•Œä¹¦æ•°æ®åŒæ­¥çš„ï¼‰
                    if (!avatarUrl) {
                        const contactAvatar = getCharacterAvatar(characterName);
                        if (contactAvatar && contactAvatar.backgroundImage) {
                            // ä»backgroundImage CSSå±æ€§ä¸­æå–URL
                            const urlMatch = contactAvatar.backgroundImage.match(/url\(["']?([^"']*)["']?\)/);
                            if (urlMatch && urlMatch[1]) {
                                avatarUrl = urlMatch[1];
                                console.log(`âœ… ä½¿ç”¨è”ç³»äººç•Œé¢å¤´åƒ: ${avatarUrl}`);
                            }
                        }
                    }
                    
                    // æ–¹æ³•3: ä»SillyTavernçš„è§’è‰²æ•°æ®è·å–
                    if (!avatarUrl && typeof getCharacterAvatar === 'function') {
                        try {
                            const stAvatar = getCharacterAvatar(characterName);
                            console.log(`æ–¹æ³•3 - SillyTavernå‡½æ•°å¤´åƒ: ${stAvatar}`);
                            if (stAvatar && stAvatar !== 'undefined' && stAvatar !== '') {
                                avatarUrl = stAvatar;
                                console.log(`âœ… ä½¿ç”¨SillyTavernå‡½æ•°å¤´åƒ: ${avatarUrl}`);
                            }
                        } catch (e) {
                            console.warn('SillyTavern getCharacterAvatarå‡½æ•°è°ƒç”¨å¤±è´¥:', e);
                        }
                    }
                    
                    // æ–¹æ³•3: ä½¿ç”¨SillyTavernçš„å†…ç½®æ•°æ®
                    if (!avatarUrl && typeof characters !== 'undefined' && Array.isArray(characters)) {
                        const character = characters.find(char => char.name === characterName || char.avatar === characterName);
                        console.log(`æ–¹æ³•3 - æ‰¾åˆ°çš„è§’è‰²æ•°æ®:`, character);
                        if (character && character.avatar) {
                            avatarUrl = character.avatar;
                            console.log(`âœ… ä½¿ç”¨è§’è‰²æ•°æ®å¤´åƒ: ${avatarUrl}`);
                        }
                    }
                    
                    // æ–¹æ³•4: ä»å…¨å±€å˜é‡è·å–
                    if (!avatarUrl && typeof window.SillyTavern !== 'undefined') {
                        try {
                            const context = window.SillyTavern.getContext();
                            if (context && context.characters) {
                                const character = context.characters.find(char => char.name === characterName);
                                if (character && character.avatar) {
                                    avatarUrl = character.avatar;
                                    console.log(`âœ… ä½¿ç”¨SillyTavern contextå¤´åƒ: ${avatarUrl}`);
                                }
                            }
                        } catch (e) {
                            console.warn('è·å–SillyTavern contextå¤±è´¥:', e);
                        }
                    }
                    
                    // æ–¹æ³•5: å°è¯•ä»èŠå¤©æ ‡é¢˜ä¸­è·å–å¤´åƒ
                    if (!avatarUrl) {
                        const titleAvatar = $(`.QQ_chat_title[data-name="${characterName}"] img`).attr('src');
                        console.log(`æ–¹æ³•5 - èŠå¤©æ ‡é¢˜å¤´åƒ: ${titleAvatar}`);
                        if (titleAvatar && titleAvatar !== 'undefined' && titleAvatar !== '') {
                            avatarUrl = titleAvatar;
                            console.log(`âœ… ä½¿ç”¨èŠå¤©æ ‡é¢˜å¤´åƒ: ${avatarUrl}`);
                        }
                    }
                    
                    // æ–¹æ³•6: ä»éšæœºå¤´åƒåˆ—è¡¨è·å–ä¸€ä¸ªå¤‡ç”¨å¤´åƒ
                    if (!avatarUrl) {
                        try {
                            // å°è¯•ä»ä¸–ç•Œä¹¦ä¸­è·å–éšæœºå¤´åƒï¼ˆå¼‚æ­¥æ–¹å¼ï¼‰
                            if (typeof worldbook !== 'undefined' && worldbook) {
                                // å¼‚æ­¥è·å–å¤´åƒï¼Œä½†ä¸é˜»å¡ä¸»æµç¨‹
                                getLorebookEntries(worldbook).then(entries => {
                                    if (entries) {
                                        const avatarEntry = entries.find(entry => 
                                            entry.comment && entry.comment.includes('éšæœºå¤´åƒ')
                                        );
                                        if (avatarEntry && avatarEntry.content) {
                                            const avatarList = avatarEntry.content.split('\n').filter(line => 
                                                line.trim() && (line.includes('http') || line.includes('files.catbox.moe'))
                                            );
                                            if (avatarList.length > 0) {
                                                // ä½¿ç”¨è§’è‰²åå­—ç¬¦ä¸²é•¿åº¦ä½œä¸ºéšæœºç§å­
                                                const randomIndex = characterName.length % avatarList.length;
                                                const randomAvatar = avatarList[randomIndex].trim();
                                                console.log(`âœ… å¼‚æ­¥è·å–éšæœºå¤´åƒ: ${randomAvatar}`);
                                                // å¦‚æœå½“å‰æ²¡æœ‰æœ‰æ•ˆå¤´åƒï¼Œæ›´æ–°ä¸ºéšæœºå¤´åƒ
                                                if (!avatarUrl || avatarUrl.includes('default')) {
                                                    avatarUrl = randomAvatar;
                                                }
                                            }
                                        }
                                    }
                                }).catch(e => {
                                    console.warn('å¼‚æ­¥è·å–éšæœºå¤´åƒå¤±è´¥:', e);
                                });
                            }
                        } catch (e) {
                            console.warn('è·å–éšæœºå¤´åƒå¤±è´¥:', e);
                        }
                        
                        // å¦‚æœéšæœºå¤´åƒä¹Ÿè·å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤SVGå¤´åƒ
                        if (!avatarUrl) {
                            avatarUrl = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiByeD0iMzAiIGZpbGw9IiNGRjZCNkIiLz4KPHR leHQgeD0iMzAiIHk9IjM1IiBmb250LXNpemU9IjI0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9ImFyaWFsIj7igKI8L3RleHQ+Cjwvc3ZnPgo=';
                            console.log(`âš ï¸ ä½¿ç”¨é»˜è®¤SVGå¤´åƒ: ${characterName}`);
                        }
                    }
                    
                    // å¤„ç†ç›¸å¯¹è·¯å¾„å’Œå®Œæ•´URL
                    if (avatarUrl && typeof avatarUrl === 'string') {
                        // æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„URLæ ¼å¼
                        if (avatarUrl.startsWith('http') || avatarUrl.startsWith('data:') || avatarUrl.startsWith('blob:')) {
                            // å®Œæ•´URLæˆ–base64ï¼Œç›´æ¥ä½¿ç”¨
                            console.log(`âœ… ä½¿ç”¨å®Œæ•´URL: ${avatarUrl.substring(0, 100)}...`);
                        } else if (avatarUrl.startsWith('./') || avatarUrl.startsWith('../')) {
                            // ç›¸å¯¹è·¯å¾„ï¼Œä¿æŒä¸å˜
                            console.log(`âœ… ä½¿ç”¨ç›¸å¯¹è·¯å¾„: ${avatarUrl}`);
                        } else if (avatarUrl.startsWith('characters/') || avatarUrl.includes('characters/')) {
                            // SillyTavernè§’è‰²è·¯å¾„ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´
                            if (!avatarUrl.startsWith('/')) {
                                avatarUrl = '/' + avatarUrl;
                            }
                            console.log(`âœ… ä½¿ç”¨è§’è‰²è·¯å¾„: ${avatarUrl}`);
                        } else {
                            // å…¶ä»–æƒ…å†µï¼Œæ·»åŠ æ ¹è·¯å¾„
                            if (!avatarUrl.startsWith('/')) {
                                avatarUrl = '/' + avatarUrl;
                            }
                            console.log(`âœ… æ·»åŠ æ ¹è·¯å¾„: ${avatarUrl}`);
                        }
                    } else {
                        // å¦‚æœavatarUrlä¸æ˜¯æœ‰æ•ˆå­—ç¬¦ä¸²ï¼Œä½¿ç”¨é»˜è®¤SVGå¤´åƒ
                        avatarUrl = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiByeD0iMzAiIGZpbGw9IiNGRjZCNkIiLz4KPHR leHQgeD0iMzAiIHk9IjM1IiBmb250LXNpemU9IjI0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9ImFyaWFsIj7igKI8L3RleHQ+Cjwvc3ZnPgo=';
                        console.warn(`å¤´åƒURLæ— æ•ˆï¼Œä½¿ç”¨é»˜è®¤SVGå¤´åƒ: ${characterName}`);
                    }
                    
                    console.log(`=== æœ€ç»ˆè·å–çš„å¤´åƒURL: ${avatarUrl} ===`);
                    return avatarUrl;
                } catch (error) {
                    console.error('è·å–è§’è‰²å¤´åƒå¤±è´¥:', error);
                    return 'default_avatar.png';
                }
            }
            
            /**
             * æ˜¾ç¤ºè§’è‰²ç²¾çµé¢æ¿
             * @param {string} characterName - è§’è‰²åç§°
             */
            function QQ_ShowCharacterSpiritPanel(characterName) {
                console.log(`æ˜¾ç¤ºè§’è‰² ${characterName} çš„ç²¾çµé¢æ¿`);
                
                // *** æ–°å¢ï¼šç«‹å³å¼€å§‹é¢„åŠ è½½ä¸–ç•Œä¹¦æ•°æ® ***
                console.log(`ğŸ”„ ç²¾çµé¢æ¿æ‰“å¼€ï¼Œç«‹å³é¢„åŠ è½½è§’è‰² ${characterName} çš„ä¸–ç•Œä¹¦æ•°æ®...`);
                QQ_PreloadCharacterDataFromWorldbook(characterName);
                
                // ç§»é™¤ç°æœ‰é¢æ¿
                $('.QQ_character_spirit_panel').remove();
                
                const characterAvatar = QQ_GetCharacterAvatar(characterName);
                
                // åˆ›å»ºç²¾çµé¢æ¿HTML
                const panelHtml = `
                    <div class="QQ_character_spirit_panel" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.8);
                        z-index: 999999999;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        animation: fadeIn 0.3s ease;
                        backdrop-filter: blur(15px);
                    ">
                        <div class="QQ_spirit_panel_content" style="
                            background: #ffffff;
                            border-radius: 20px;
                            padding: 0;
                            max-width: 90%;
                            overflow: hidden;
                            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                            color: #333;
                            animation: slideIn 0.3s ease;
                            width: 350px;
                        ">
                            <div class="spirit-panel-header" style="
                                background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
                                color: white;
                                padding: 20px;
                                text-align: center;
                                position: relative;
                            ">
                                <img src="${characterAvatar}" alt="${characterName}" style="
                                    width: 60px;
                                    height: 60px;
                                    border-radius: 50%;
                                    border: 3px solid white;
                                    margin-bottom: 10px;
                                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                                " onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiByeD0iMzAiIGZpbGw9IiNGRjZCNkIiLz4KPHRLEHA+4pWpPC90ZXh0Pgo8L3N2Zz4K'; console.log('ç²¾çµé¢æ¿å¤´åƒåŠ è½½å¤±è´¥: ${characterName}');">
                                <h3 style="margin: 0; font-size: 18px; font-weight: 600;">${characterName}</h3>
                                <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">ä¸“å±äº’åŠ¨ç²¾çµ</p>
                                <button class="QQ_close_spirit_panel" style="
                                    position: absolute;
                                    top: 15px;
                                    right: 15px;
                                    background: rgba(255, 255, 255, 0.2);
                                    border: none;
                                    color: white;
                                    width: 30px;
                                    height: 30px;
                                    border-radius: 50%;
                                    cursor: pointer;
                                    font-size: 16px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" 
                                   onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">
                                    Ã—
                                </button>
                            </div>
                            
                            <div class="spirit-panel-body" style="
                                padding: 25px 20px;
                            ">
                                <p style="
                                    text-align: center;
                                    color: #666;
                                    margin-bottom: 20px;
                                    font-size: 14px;
                                    line-height: 1.5;
                                ">
                                    é€‰æ‹©ä½ æƒ³è¦ä¸ ${characterName} è¿›è¡Œçš„äº’åŠ¨ç±»å‹
                                </p>
                                
                                <div class="spirit-options" style="
                                    display: flex;
                                    flex-direction: column;
                                    gap: 12px;
                                ">
                                    <button class="QQ_spirit_option" data-action="interactive_space" style="
                                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                        border: none;
                                        color: white;
                                        padding: 15px 20px;
                                        border-radius: 12px;
                                        cursor: pointer;
                                        font-size: 14px;
                                        font-weight: 500;
                                        transition: all 0.3s ease;
                                        box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
                                        display: flex;
                                        align-items: center;
                                        gap: 10px;
                                    " onmouseover="this.style.transform='translateY(-2px)'" 
                                       onmouseout="this.style.transform='translateY(0)'">
                                        <span style="font-size: 18px;">ğŸŒŸ</span>
                                        <span>å¼€å¯äº’åŠ¨ç©ºé—´</span>
                                    </button>
                                    
                                    <button class="QQ_spirit_option" data-action="create_space" style="
                                        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
                                        border: none;
                                        color: white;
                                        padding: 15px 20px;
                                        border-radius: 12px;
                                        cursor: pointer;
                                        font-size: 14px;
                                        font-weight: 500;
                                        transition: all 0.3s ease;
                                        box-shadow: 0 3px 10px rgba(67, 233, 123, 0.3);
                                        display: flex;
                                        align-items: center;
                                        gap: 10px;
                                    " onmouseover="this.style.transform='translateY(-2px)'" 
                                       onmouseout="this.style.transform='translateY(0)'">
                                        <span style="font-size: 18px;">âœ¨</span>
                                        <span>åˆ›å»ºæ–°äº’åŠ¨</span>
                                    </button>
                                    
                                    <button class="QQ_spirit_option" data-action="public_spaces" style="
                                        background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
                                        border: none;
                                        color: white;
                                        padding: 15px 20px;
                                        border-radius: 12px;
                                        cursor: pointer;
                                        font-size: 14px;
                                        font-weight: 500;
                                        transition: all 0.3s ease;
                                        box-shadow: 0 3px 10px rgba(255, 154, 158, 0.3);
                                        display: flex;
                                        align-items: center;
                                        gap: 10px;
                                    " onmouseover="this.style.transform='translateY(-2px)'" 
                                       onmouseout="this.style.transform='translateY(0)'">
                                        <span style="font-size: 18px;">ğŸŒ</span>
                                        <span>å…¬å…±äº’åŠ¨ç©ºé—´</span>
                                    </button>
                                    
                                    <button class="QQ_spirit_option" data-action="hide_spirit" style="
                                        background: #f8f9fa;
                                        border: 1px solid #e9ecef;
                                        color: #6c757d;
                                        padding: 12px 20px;
                                        border-radius: 12px;
                                        cursor: pointer;
                                        font-size: 14px;
                                        font-weight: 500;
                                        transition: all 0.3s ease;
                                        display: flex;
                                        align-items: center;
                                        gap: 10px;
                                    " onmouseover="this.style.background='#e9ecef'" 
                                       onmouseout="this.style.background='#f8f9fa'">
                                        <span style="font-size: 18px;">ğŸ‘»</span>
                                        <span>éšè—ç²¾çµ</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // æ·»åŠ åˆ°é¡µé¢
                $('body').append(panelHtml);
                
                // ç»‘å®šå…³é—­äº‹ä»¶
                $('.QQ_close_spirit_panel').on('click', function() {
                    $('.QQ_character_spirit_panel').fadeOut(300, function() {
                        $(this).remove();
                    });
                });
                
                // ç»‘å®šé€‰é¡¹äº‹ä»¶
                $('.QQ_spirit_option[data-action="interactive_space"]').on('click', function() {
                    $('.QQ_character_spirit_panel').remove();
                    QQ_ShowCharacterInteractiveSpaces(characterName);
                });
                
                $('.QQ_spirit_option[data-action="create_space"]').on('click', function() {
                    $('.QQ_character_spirit_panel').remove();
                    QQ_CreateCharacterInteractiveSpace(characterName);
                });
                
                $('.QQ_spirit_option[data-action="public_spaces"]').on('click', function() {
                    $('.QQ_character_spirit_panel').remove();
                    QQ_ShowPublicInteractiveSpaces();
                });
                
                $('.QQ_spirit_option[data-action="hide_spirit"]').on('click', function() {
                    $('.QQ_character_spirit_panel').remove();
                    QQ_HideCharacterSpirit(characterName);
                    toastr.info(`å·²éšè— ${characterName} çš„ç²¾çµæŒ‰é’®`, 'ç²¾çµæŒ‰é’®');
                });
                
                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                $('.QQ_character_spirit_panel').on('click', function(e) {
                    if (e.target === this) {
                        $(this).fadeOut(300, function() {
                            $(this).remove();
                        });
                    }
                });
            }
            
            /**
             * æ˜¾ç¤ºè§’è‰²çš„äº’åŠ¨ç©ºé—´åˆ—è¡¨
             * @param {string} characterName - è§’è‰²åç§°
             */
            function QQ_ShowCharacterInteractiveSpaces(characterName) {
                console.log(`æ˜¾ç¤ºè§’è‰² ${characterName} çš„äº’åŠ¨ç©ºé—´åˆ—è¡¨`);
                
                // *** æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦å·²é¢„åŠ è½½ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç«‹å³åŠ è½½ ***
                if (!window.QQ_PreloadedCharacters || !window.QQ_PreloadedCharacters.has(characterName)) {
                    console.log(`âš¡ è§’è‰² ${characterName} æ•°æ®æœªé¢„åŠ è½½ï¼Œç«‹å³ä»ä¸–ç•Œä¹¦åŠ è½½...`);
                    
                    // æ˜¾ç¤ºåŠ è½½ä¸­çš„ç•Œé¢
                    QQ_ShowLoadingInteractiveSpaces(characterName);
                    
                    // å¼‚æ­¥åŠ è½½æ•°æ®
                    QQ_LoadSpecificCharacterSpaces(characterName).then(() => {
                        // åŠ è½½å®Œæˆåé‡æ–°æ˜¾ç¤º
                        QQ_ShowCharacterInteractiveSpacesList(characterName);
                    }).catch(error => {
                        console.error('åŠ è½½è§’è‰²äº’åŠ¨ç©ºé—´å¤±è´¥:', error);
                        toastr.error(`åŠ è½½ ${characterName} çš„äº’åŠ¨ç©ºé—´å¤±è´¥`, 'åŠ è½½é”™è¯¯');
                        QQ_ShowCharacterInteractiveSpacesList(characterName); // ä»ç„¶æ˜¾ç¤ºï¼Œå¯èƒ½æœ‰ç¼“å­˜æ•°æ®
                    });
                    
                    return;
                }
                
                // æ•°æ®å·²é¢„åŠ è½½ï¼Œç›´æ¥æ˜¾ç¤ºåˆ—è¡¨
                QQ_ShowCharacterInteractiveSpacesList(characterName);
            }
            
            /**
             * *** æ–°å¢ï¼šæ˜¾ç¤ºåŠ è½½ä¸­çš„äº’åŠ¨ç©ºé—´ç•Œé¢ ***
             * @param {string} characterName - è§’è‰²åç§°
             */
            function QQ_ShowLoadingInteractiveSpaces(characterName) {
                // ç§»é™¤ç°æœ‰é¢æ¿
                $('.QQ_character_spaces_list').remove();
                
                const loadingHtml = `
                    <div class="QQ_character_spaces_list" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.8);
                        z-index: 999999999;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        animation: fadeIn 0.3s ease;
                        backdrop-filter: blur(15px);
                    ">
                        <div style="
                            background: #ffffff;
                            border-radius: 20px;
                            padding: 40px 30px;
                            max-width: 90%;
                            overflow: hidden;
                            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                            color: #333;
                            animation: slideIn 0.3s ease;
                            width: 350px;
                            text-align: center;
                        ">
                            <div style="
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                color: white;
                                padding: 20px;
                                margin: -40px -30px 30px -30px;
                                text-align: center;
                            ">
                                <h3 style="margin: 0; font-size: 18px; font-weight: 600;">æ­£åœ¨åŠ è½½...</h3>
                                <p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.9;">${characterName} çš„äº’åŠ¨ç©ºé—´æ•°æ®</p>
                            </div>
                            
                            <div style="
                                margin: 20px 0;
                            ">
                                <div style="
                                    width: 50px;
                                    height: 50px;
                                    border: 4px solid #f3f3f3;
                                    border-top: 4px solid #667eea;
                                    border-radius: 50%;
                                    animation: spin 1s linear infinite;
                                    margin: 0 auto 20px auto;
                                "></div>
                                <p style="
                                    color: #666;
                                    font-size: 14px;
                                    line-height: 1.5;
                                    margin: 0;
                                ">æ­£åœ¨ä»ä¸–ç•Œä¹¦åŠ è½½äº’åŠ¨ç©ºé—´æ•°æ®...<br/>
                                <small style="font-size: 12px; opacity: 0.7;">é¦–æ¬¡åŠ è½½å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ</small></p>
                            </div>
                        </div>
                    </div>
                    <style>
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    </style>
                `;
                
                $('body').append(loadingHtml);
                
                // ç‚¹å‡»èƒŒæ™¯å…³é—­ï¼ˆå¯é€‰ï¼‰
                $('.QQ_character_spaces_list').on('click', function(e) {
                    if (e.target === this) {
                        $(this).remove();
                    }
                });
            }
            
            /**
             * *** æ–°å¢ï¼šæ˜¾ç¤ºè§’è‰²äº’åŠ¨ç©ºé—´åˆ—è¡¨ï¼ˆæ•°æ®å·²åŠ è½½ï¼‰ ***
             * @param {string} characterName - è§’è‰²åç§°
             */
            function QQ_ShowCharacterInteractiveSpacesList(characterName) {
                // ç¡®ä¿è§’è‰²æœ‰äº’åŠ¨ç©ºé—´æ•°æ®
                if (!QQ_CharacterSpaces[characterName]) {
                    QQ_CharacterSpaces[characterName] = {};
                }
                
                const characterSpaces = QQ_CharacterSpaces[characterName];
                const spaceKeys = Object.keys(characterSpaces);
                
                if (spaceKeys.length === 0) {
                    toastr.info(`${characterName} è¿˜æ²¡æœ‰äº’åŠ¨ç©ºé—´ï¼Œç‚¹å‡»åˆ›å»ºæ–°äº’åŠ¨å¼€å§‹å§ï¼`, 'äº’åŠ¨ç©ºé—´');
                    QQ_CreateCharacterInteractiveSpace(characterName);
                    return;
                }
                
                // ç§»é™¤ç°æœ‰é¢æ¿
                $('.QQ_character_spaces_list').remove();
                
                let spacesListHtml = `
                    <div class="QQ_character_spaces_list" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.8);
                        z-index: 999999999;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        animation: fadeIn 0.3s ease;
                        backdrop-filter: blur(15px);
                    ">
                        <div style="
                            background: #ffffff;
                            border-radius: 20px;
                            padding: 0;
                            max-width: 90%;
                            max-height: 80%;
                            overflow: hidden;
                            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                            color: #333;
                            animation: slideIn 0.3s ease;
                            width: 400px;
                        ">
                            <div style="
                                background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
                                color: white;
                                padding: 20px;
                                text-align: center;
                                position: relative;
                            ">
                                <h3 style="margin: 0; font-size: 18px; font-weight: 600;">${characterName} çš„äº’åŠ¨ç©ºé—´</h3>
                                <p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.9;">é€‰æ‹©ä¸€ä¸ªäº’åŠ¨ç©ºé—´</p>
                                <button class="QQ_close_spaces_list" style="
                                    position: absolute;
                                    top: 15px;
                                    right: 15px;
                                    background: rgba(255, 255, 255, 0.2);
                                    border: none;
                                    color: white;
                                    width: 30px;
                                    height: 30px;
                                    border-radius: 50%;
                                    cursor: pointer;
                                    font-size: 16px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                ">Ã—</button>
                            </div>
                            
                            <div style="
                                padding: 20px;
                                max-height: 300px;
                                overflow-y: auto;
                            ">
                `;
                
                // æ·»åŠ äº’åŠ¨ç©ºé—´é€‰é¡¹
                spaceKeys.forEach(spaceId => {
                    const space = characterSpaces[spaceId];
                    spacesListHtml += `
                        <div class="QQ_space_item" data-space-id="${spaceId}" style="
                            background: #f8f9fa;
                            border: 1px solid #e9ecef;
                            border-radius: 12px;
                            padding: 15px;
                            margin-bottom: 10px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.background='#e9ecef'" 
                           onmouseout="this.style.background='#f8f9fa'">
                            <h4 style="margin: 0 0 5px 0; font-size: 14px; color: #333;">${space.name}</h4>
                            <p style="margin: 0; font-size: 12px; color: #666; line-height: 1.4;">
                                ${space.content.substring(0, 100)}${space.content.length > 100 ? '...' : ''}
                            </p>
                        </div>
                    `;
                });
                
                spacesListHtml += `
                            </div>
                            
                            <div style="
                                padding: 20px;
                                border-top: 1px solid #eee;
                                text-align: center;
                            ">
                                <button class="QQ_create_new_space" style="
                                    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
                                    border: none;
                                    color: white;
                                    padding: 12px 20px;
                                    border-radius: 10px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.3s ease;
                                ">
                                    âœ¨ åˆ›å»ºæ–°äº’åŠ¨ç©ºé—´
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // æ·»åŠ åˆ°é¡µé¢
                $('body').append(spacesListHtml);
                
                // ç»‘å®šäº‹ä»¶
                $('.QQ_close_spaces_list').on('click', function() {
                    $('.QQ_character_spaces_list').remove();
                });
                
                $('.QQ_space_item').on('click', function() {
                    const spaceId = $(this).data('space-id');
                    $('.QQ_character_spaces_list').remove();
                    QQ_DisplayEnhancedInteractiveSpace(spaceId, characterSpaces[spaceId].name, characterName);
                });
                
                $('.QQ_create_new_space').on('click', function() {
                    $('.QQ_character_spaces_list').remove();
                    QQ_CreateCharacterInteractiveSpace(characterName);
                });
                
                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                $('.QQ_character_spaces_list').on('click', function(e) {
                    if (e.target === this) {
                        $(this).remove();
                    }
                });
            }
            
            /**
             * *** æ–°å¢ï¼šæ˜¾ç¤ºå…¬å…±äº’åŠ¨ç©ºé—´åˆ—è¡¨ ***
             * åœ¨ç”¨æˆ·ç‚¹å‡»å…¬å…±äº’åŠ¨ç©ºé—´æŒ‰é’®æ—¶ç«‹å³ä»ä¸–ç•Œä¹¦åŠ è½½å®Œæ•´æ•°æ®
             */
            function QQ_ShowPublicInteractiveSpaces() {
                console.log('ğŸŒ æ˜¾ç¤ºå…¬å…±äº’åŠ¨ç©ºé—´åˆ—è¡¨ï¼Œç«‹å³ä»ä¸–ç•Œä¹¦åŠ è½½å®Œæ•´æ•°æ®...');
                
                // æ˜¾ç¤ºåŠ è½½ä¸­çš„ç•Œé¢
                QQ_ShowLoadingPublicSpaces();
                
                // ç«‹å³ä»ä¸–ç•Œä¹¦åŠ è½½å®Œæ•´çš„å…¬å…±äº’åŠ¨ç©ºé—´æ•°æ®
                QQ_LoadFullPublicInteractiveSpaces().then((spaces) => {
                    // åŠ è½½å®Œæˆåæ˜¾ç¤ºåˆ—è¡¨
                    QQ_ShowPublicInteractiveSpacesList(spaces);
                }).catch(error => {
                    console.error('åŠ è½½å…¬å…±äº’åŠ¨ç©ºé—´å¤±è´¥:', error);
                    toastr.error('åŠ è½½å…¬å…±äº’åŠ¨ç©ºé—´å¤±è´¥', 'åŠ è½½é”™è¯¯');
                    // å³ä½¿å¤±è´¥ä¹Ÿæ˜¾ç¤ºé¢„è§ˆæ•°æ®
                    const previewSpaces = window.QQ_PublicSpacePreviews || {};
                    QQ_ShowPublicInteractiveSpacesList(previewSpaces, true);
                });
            }
            
            /**
             * *** æ–°å¢ï¼šæ˜¾ç¤ºå…¬å…±äº’åŠ¨ç©ºé—´åŠ è½½ç•Œé¢ ***
             */
            function QQ_ShowLoadingPublicSpaces() {
                // ç§»é™¤ç°æœ‰é¢æ¿
                $('.QQ_public_spaces_list').remove();
                
                const loadingHtml = `
                    <div class="QQ_public_spaces_list" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.8);
                        z-index: 999999999;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        animation: fadeIn 0.3s ease;
                        backdrop-filter: blur(15px);
                    ">
                        <div style="
                            background: #ffffff;
                            border-radius: 20px;
                            padding: 40px 30px;
                            max-width: 90%;
                            overflow: hidden;
                            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                            color: #333;
                            animation: slideIn 0.3s ease;
                            width: 400px;
                            text-align: center;
                        ">
                            <div style="
                                background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
                                color: white;
                                padding: 20px;
                                margin: -40px -30px 30px -30px;
                                text-align: center;
                            ">
                                <h3 style="margin: 0; font-size: 18px; font-weight: 600;">æ­£åœ¨åŠ è½½...</h3>
                                <p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.9;">å…¬å…±äº’åŠ¨ç©ºé—´æ•°æ®</p>
                            </div>
                            
                            <div style="
                                margin: 20px 0;
                            ">
                                <div style="
                                    width: 50px;
                                    height: 50px;
                                    border: 4px solid #f3f3f3;
                                    border-top: 4px solid #ff9a9e;
                                    border-radius: 50%;
                                    animation: spin 1s linear infinite;
                                    margin: 0 auto 20px auto;
                                "></div>
                                <p style="
                                    color: #666;
                                    font-size: 14px;
                                    line-height: 1.5;
                                    margin: 0;
                                ">æ­£åœ¨ä»ä¸–ç•Œä¹¦åŠ è½½å…¬å…±äº’åŠ¨ç©ºé—´æ•°æ®...<br/>
                                <small style="font-size: 12px; opacity: 0.7;">é¦–æ¬¡åŠ è½½å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ</small></p>
                            </div>
                        </div>
                    </div>
                `;
                
                $('body').append(loadingHtml);
                
                // ç‚¹å‡»èƒŒæ™¯å…³é—­ï¼ˆå¯é€‰ï¼‰
                $('.QQ_public_spaces_list').on('click', function(e) {
                    if (e.target === this) {
                        $(this).remove();
                    }
                });
            }
            
            /**
             * *** æ–°å¢ï¼šä»ä¸–ç•Œä¹¦åŠ è½½å®Œæ•´çš„å…¬å…±äº’åŠ¨ç©ºé—´æ•°æ® ***
             */
            async function QQ_LoadFullPublicInteractiveSpaces() {
                try {
                    if (!worldbook || !entries) {
                        console.warn('ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨ï¼Œæ— æ³•åŠ è½½å…¬å…±äº’åŠ¨ç©ºé—´');
                        return {};
                    }
                    
                    // æŸ¥æ‰¾æ‰€æœ‰å…¬å…±äº’åŠ¨ç©ºé—´æ¡ç›®
                    const publicSpaceEntries = entries.filter(e => 
                        e.comment && e.comment.includes('QQ_äº’åŠ¨ç©ºé—´å¤‡ä»½') && 
                        !e.comment.includes('è§’è‰²äº’åŠ¨ç©ºé—´') &&
                        !e.comment.includes('QQ_äº’åŠ¨å†…å®¹')
                    );
                    
                    const allSpaces = {};
                    let loadedEntries = 0;
                    
                    for (const entry of publicSpaceEntries) {
                        try {
                            const data = JSON.parse(entry.content);
                            if (data.spaces) {
                                // åˆå¹¶æ‰€æœ‰å…¬å…±äº’åŠ¨ç©ºé—´
                                Object.keys(data.spaces).forEach(spaceId => {
                                    const space = data.spaces[spaceId];
                                    allSpaces[spaceId] = {
                                        ...space,
                                        sourceEntry: entry.comment,
                                        sourceUid: entry.uid,
                                        isPublic: true
                                    };
                                });
                                loadedEntries++;
                            }
                        } catch (parseError) {
                            console.warn(`è§£æå…¬å…±äº’åŠ¨ç©ºé—´æ¡ç›®å¤±è´¥:`, parseError);
                        }
                    }
                    
                    console.log(`ğŸŒ å®Œæ•´åŠ è½½å…¬å…±äº’åŠ¨ç©ºé—´: ${loadedEntries} ä¸ªæ¡ç›®, ${Object.keys(allSpaces).length} ä¸ªç©ºé—´`);
                    
                    // æ›´æ–°å…¨å±€ç¼“å­˜
                    if (!window.QQ_FullPublicSpaces) {
                        window.QQ_FullPublicSpaces = {};
                    }
                    window.QQ_FullPublicSpaces = allSpaces;
                    
                    return allSpaces;
                    
                } catch (error) {
                    console.error('åŠ è½½å®Œæ•´å…¬å…±äº’åŠ¨ç©ºé—´å¤±è´¥:', error);
                    throw error;
                }
            }
            
            /**
             * *** æ–°å¢ï¼šæ˜¾ç¤ºå…¬å…±äº’åŠ¨ç©ºé—´åˆ—è¡¨ï¼ˆæ•°æ®å·²åŠ è½½ï¼‰ ***
             * @param {Object} spaces - å…¬å…±äº’åŠ¨ç©ºé—´æ•°æ®
             * @param {boolean} isPreviewOnly - æ˜¯å¦ä»…ä¸ºé¢„è§ˆæ¨¡å¼
             */
            function QQ_ShowPublicInteractiveSpacesList(spaces, isPreviewOnly = false) {
                // ç§»é™¤ç°æœ‰é¢æ¿
                $('.QQ_public_spaces_list').remove();
                
                const spaceKeys = Object.keys(spaces);
                
                if (spaceKeys.length === 0) {
                    toastr.info('æš‚æ— å…¬å…±äº’åŠ¨ç©ºé—´æ•°æ®', 'å…¬å…±äº’åŠ¨ç©ºé—´');
                    return;
                }
                
                let spacesListHtml = `
                    <div class="QQ_public_spaces_list" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.8);
                        z-index: 999999999;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        animation: fadeIn 0.3s ease;
                        backdrop-filter: blur(15px);
                    ">
                        <div style="
                            background: #ffffff;
                            border-radius: 20px;
                            padding: 0;
                            max-width: 90%;
                            max-height: 80%;
                            overflow: hidden;
                            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                            color: #333;
                            animation: slideIn 0.3s ease;
                            width: 450px;
                        ">
                            <div style="
                                background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
                                color: white;
                                padding: 20px;
                                text-align: center;
                                position: relative;
                            ">
                                <h3 style="margin: 0; font-size: 18px; font-weight: 600;">ğŸŒ å…¬å…±äº’åŠ¨ç©ºé—´</h3>
                                <p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.9;">
                                    ${isPreviewOnly ? 'é¢„è§ˆæ¨¡å¼ Â· ' : ''}å…± ${spaceKeys.length} ä¸ªäº’åŠ¨ç©ºé—´
                                </p>
                                <button class="QQ_close_public_spaces" style="
                                    position: absolute;
                                    top: 15px;
                                    right: 15px;
                                    background: rgba(255, 255, 255, 0.2);
                                    border: none;
                                    color: white;
                                    width: 30px;
                                    height: 30px;
                                    border-radius: 50%;
                                    cursor: pointer;
                                    font-size: 16px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                ">Ã—</button>
                            </div>
                            
                            <div style="
                                padding: 20px;
                                max-height: 400px;
                                overflow-y: auto;
                            ">`;
                
                // æŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
                const sortedSpaces = spaceKeys.sort((a, b) => {
                    const spaceA = spaces[a];
                    const spaceB = spaces[b];
                    const timeA = spaceA.lastAccess || spaceA.createdAt || '0';
                    const timeB = spaceB.lastAccess || spaceB.createdAt || '0';
                    return new Date(timeB) - new Date(timeA);
                });
                
                // æ·»åŠ äº’åŠ¨ç©ºé—´é€‰é¡¹
                sortedSpaces.forEach(spaceId => {
                    const space = spaces[spaceId];
                    const contentPreview = isPreviewOnly ? 
                        (space.preview || (space.content ? space.content.substring(0, 100) + '...' : 'æ— å†…å®¹é¢„è§ˆ')) :
                        (space.content ? space.content.substring(0, 100) + '...' : 'æ— å†…å®¹');
                    const timeStr = space.lastAccess || space.createdAt ? 
                        new Date(space.lastAccess || space.createdAt).toLocaleDateString() : 'æœªçŸ¥æ—¶é—´';
                    
                    spacesListHtml += `
                        <div class="QQ_public_space_item" data-space-id="${spaceId}" style="
                            background: #f8f9fa;
                            border: 1px solid #e9ecef;
                            border-radius: 12px;
                            padding: 15px;
                            margin-bottom: 10px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.background='#e9ecef'" 
                           onmouseout="this.style.background='#f8f9fa'">
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <h4 style="margin: 0; font-size: 14px; color: #333; flex: 1;">${space.name || 'æœªå‘½åäº’åŠ¨ç©ºé—´'}</h4>
                                <small style="color: #999; font-size: 11px;">${timeStr}</small>
                            </div>
                            <p style="margin: 0 0 5px 0; font-size: 12px; color: #666; line-height: 1.4;">
                                ${contentPreview}
                            </p>
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <small style="color: #666; font-size: 11px;">
                                    ğŸ‘¤ ${space.characterName || 'æœªçŸ¥è§’è‰²'}
                                </small>
                                ${isPreviewOnly ? '<small style="color: #ff9a9e; font-size: 11px;">âš¡ ç‚¹å‡»åŠ è½½å®Œæ•´å†…å®¹</small>' : ''}
                            </div>
                        </div>
                    `;
                });
                
                spacesListHtml += `</div></div></div>`;
                
                // æ·»åŠ åˆ°é¡µé¢
                $('body').append(spacesListHtml);
                
                // ç»‘å®šäº‹ä»¶
                $('.QQ_close_public_spaces').on('click', function() {
                    $('.QQ_public_spaces_list').remove();
                });
                
                $('.QQ_public_space_item').on('click', function() {
                    const spaceId = $(this).data('space-id');
                    const space = spaces[spaceId];
                    
                    $('.QQ_public_spaces_list').remove();
                    
                    if (isPreviewOnly) {
                        // é¢„è§ˆæ¨¡å¼ä¸‹éœ€è¦åŠ è½½å®Œæ•´å†…å®¹
                        console.log(`âš¡ åŠ è½½å®Œæ•´å…¬å…±äº’åŠ¨ç©ºé—´å†…å®¹: ${spaceId}`);
                        QQ_LoadAndDisplayFullPublicSpace(spaceId, space);
                    } else {
                        // å·²æœ‰å®Œæ•´å†…å®¹ï¼Œç›´æ¥æ˜¾ç¤º
                        QQ_DisplayPublicInteractiveSpace(spaceId, space);
                    }
                });
                
                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                $('.QQ_public_spaces_list').on('click', function(e) {
                    if (e.target === this) {
                        $(this).remove();
                    }
                });
            }
            
            /**
             * *** æ–°å¢ï¼šåŠ è½½å¹¶æ˜¾ç¤ºå®Œæ•´çš„å…¬å…±äº’åŠ¨ç©ºé—´å†…å®¹ ***
             * @param {string} spaceId - ç©ºé—´ID
             * @param {Object} spacePreview - ç©ºé—´é¢„è§ˆæ•°æ®
             */
            function QQ_LoadAndDisplayFullPublicSpace(spaceId, spacePreview) {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                toastr.info('æ­£åœ¨åŠ è½½å®Œæ•´å†…å®¹...', 'å…¬å…±äº’åŠ¨ç©ºé—´');
                
                // å°è¯•ä»å®Œæ•´æ•°æ®ä¸­æŸ¥æ‰¾
                if (window.QQ_FullPublicSpaces && window.QQ_FullPublicSpaces[spaceId]) {
                    QQ_DisplayPublicInteractiveSpace(spaceId, window.QQ_FullPublicSpaces[spaceId]);
                    return;
                }
                
                // å¦‚æœæ²¡æœ‰å®Œæ•´æ•°æ®ï¼Œé‡æ–°ä»ä¸–ç•Œä¹¦åŠ è½½
                QQ_LoadFullPublicInteractiveSpaces().then((spaces) => {
                    if (spaces[spaceId]) {
                        QQ_DisplayPublicInteractiveSpace(spaceId, spaces[spaceId]);
                    } else {
                        toastr.error('æœªæ‰¾åˆ°è¯¥äº’åŠ¨ç©ºé—´çš„å®Œæ•´æ•°æ®', 'åŠ è½½å¤±è´¥');
                    }
                }).catch(error => {
                    console.error('åŠ è½½å…¬å…±äº’åŠ¨ç©ºé—´å®Œæ•´å†…å®¹å¤±è´¥:', error);
                    toastr.error('åŠ è½½å®Œæ•´å†…å®¹å¤±è´¥', 'é”™è¯¯');
                });
            }
            
            /**
             * *** æ–°å¢ï¼šæ˜¾ç¤ºå…¬å…±äº’åŠ¨ç©ºé—´å†…å®¹ ***
             * @param {string} spaceId - ç©ºé—´ID
             * @param {Object} space - ç©ºé—´æ•°æ®
             */
            function QQ_DisplayPublicInteractiveSpace(spaceId, space) {
                console.log(`ğŸ“– æ˜¾ç¤ºå…¬å…±äº’åŠ¨ç©ºé—´: ${spaceId} - ${space.name}`);
                
                // ç›´æ¥ä½¿ç”¨ç°æœ‰çš„äº’åŠ¨ç©ºé—´æ˜¾ç¤ºå‡½æ•°ï¼Œä½†æ ‡è®°ä¸ºå…¬å…±ç©ºé—´
                QQ_DisplayEnhancedInteractiveSpace(spaceId, space.name, space.characterName, space.content, true);
            }
            
            /**
             * åˆ›å»ºè§’è‰²äº’åŠ¨ç©ºé—´
             * @param {string} characterName - è§’è‰²åç§°
             */
            function QQ_CreateCharacterInteractiveSpace(characterName) {
                console.log(`ä¸ºè§’è‰² ${characterName} åˆ›å»ºæ–°çš„äº’åŠ¨ç©ºé—´`);
                
                // ç”Ÿæˆäº’åŠ¨ç©ºé—´è¯·æ±‚
                const interactiveRequest = `è¯·ä¸ºè§’è‰² ${characterName} åˆ›å»ºä¸€ä¸ªæ–°çš„äº’åŠ¨ç©ºé—´ã€‚

è¯·ä»¥MiPhoneæ ¼å¼å›å¤ï¼Œåœ¨contentæ ‡ç­¾ä¸­æè¿°ä¸€ä¸ªæœ‰è¶£çš„äº’åŠ¨åœºæ™¯ï¼Œæ¯”å¦‚ï¼š
- è§’è‰²é‚€è¯·ç”¨æˆ·å‚ä¸æŸä¸ªæ´»åŠ¨
- åˆ›é€ ä¸€ä¸ªç‰¹æ®Šçš„ç¯å¢ƒæˆ–æƒ…å¢ƒ
- è®¾è®¡ä¸€ä¸ªæœ‰è¶£çš„å¯¹è¯åœºæ™¯

å†…å®¹åº”è¯¥ç”ŸåŠ¨æœ‰è¶£ï¼Œèƒ½å¤Ÿå¸å¼•ç”¨æˆ·å‚ä¸äº’åŠ¨ã€‚`;
                
                // æ˜¾ç¤ºåˆ›å»ºçŠ¶æ€
                toastr.info(`æ­£åœ¨ä¸º ${characterName} åˆ›å»ºäº’åŠ¨ç©ºé—´...`, 'äº’åŠ¨ç©ºé—´');
                
                // å‘é€è¯·æ±‚åˆ°AI
                QQ_Gen(interactiveRequest, async function(aiResponse) {
                    try {
                        if (aiResponse && aiResponse.trim()) {
                            // *** é¢„å¤„ç†ï¼šå…ˆç§»é™¤thinkingæ ‡ç­¾å†…å®¹ï¼Œé¿å…è¯¯è¯»thinkingæ ‡ç­¾ä¸­çš„contentå¼•ç”¨ ***
                            const processedResponse = aiResponse.replace(/<thinking>[\s\S]*?<\/thinking>/gi, '');
                            
                            // è§£æAIå›å¤ï¼Œæå–contentå†…å®¹
                            const contentMatch = processedResponse.match(/<content>([\s\S]*?)<\/content>/i);
                            const interactiveContent = contentMatch ? contentMatch[1].trim() : processedResponse.trim();
                            
                            if (interactiveContent) {
                                // åˆ›å»ºæ–°çš„äº’åŠ¨ç©ºé—´
                                const spaceId = 'space_' + Date.now();
                                const characterAvatar = QQ_GetCharacterAvatar(characterName);
                                
                                if (!QQ_CharacterSpaces[characterName]) {
                                    QQ_CharacterSpaces[characterName] = {};
                                }
                                
                                QQ_CharacterSpaces[characterName][spaceId] = {
                                    id: spaceId,
                                    name: `ä¸${characterName}çš„äº’åŠ¨`,
                                    content: interactiveContent,
                                    characterName: characterName,
                                    characterAvatar: characterAvatar,
                                    type: 'character',
                                    createTime: new Date().toISOString()
                                };
                                
                                // åˆå§‹åŒ–é¡µé¢æ•°æ®
                                QQ_InteractivePages[spaceId] = [interactiveContent];
                                QQ_InteractiveCurrentPage[spaceId] = 0;
                                
                                // *** ç«‹å³ä¿å­˜äº’åŠ¨å†…å®¹åˆ°ä¸–ç•Œä¹¦ ***
                                QQ_SaveInteractiveContentToWorldBook(interactiveContent, characterName).then(interactiveId => {
                                    console.log(`ğŸ¯ åˆ›å»ºçš„äº’åŠ¨ç©ºé—´å·²ç«‹å³ä¿å­˜åˆ°ä¸–ç•Œä¹¦ï¼ŒID: ${interactiveId}, è§’è‰²: ${characterName}`);
                                }).catch(error => {
                                    console.error('ä¿å­˜åˆ›å»ºçš„äº’åŠ¨ç©ºé—´å¤±è´¥:', error);
                                });
                                
                                // åŒæ—¶ä¿å­˜åˆ°æ—§çš„äº’åŠ¨ç©ºé—´å­˜å‚¨ï¼ˆå…¼å®¹æ€§ï¼‰
                                QQ_SaveInteractiveSpaceToWorldBook(spaceId, characterName).catch(error => {
                                    console.error('ä¿å­˜äº’åŠ¨ç©ºé—´å¤±è´¥:', error);
                                });
                                
                                // æ˜¾ç¤ºæ–°åˆ›å»ºçš„äº’åŠ¨ç©ºé—´
                                QQ_DisplayEnhancedInteractiveSpace(spaceId, `ä¸${characterName}çš„äº’åŠ¨`, characterName);
                                
                                toastr.success(`å·²ä¸º ${characterName} åˆ›å»ºæ–°çš„äº’åŠ¨ç©ºé—´ï¼`, 'äº’åŠ¨ç©ºé—´');
                            } else {
                                toastr.error('AIå›å¤æ ¼å¼é”™è¯¯', 'äº’åŠ¨ç©ºé—´');
                            }
                        } else {
                            toastr.error('AIå›å¤ä¸ºç©º', 'äº’åŠ¨ç©ºé—´');
                        }
                    } catch (error) {
                        console.error('åˆ›å»ºäº’åŠ¨ç©ºé—´æ—¶å‡ºé”™:', error);
                        toastr.error('åˆ›å»ºäº’åŠ¨ç©ºé—´å¤±è´¥');
                    }
                });
            }
            
            // ===== æµ‹è¯•å’Œè°ƒè¯•åŠŸèƒ½ =====
            
            
            
            /**
             * æ˜¾ç¤ºæ‰€æœ‰ç²¾çµç³»ç»ŸçŠ¶æ€ä¿¡æ¯
             */
            function QQ_Show_Spirit_System_Stats() {
                console.log('=== ç²¾çµç³»ç»ŸçŠ¶æ€æŠ¥å‘Š ===');
                console.log('ç²¾çµæŒ‰é’®çŠ¶æ€:', QQ_CharacterSpirits);
                console.log('è§’è‰²ç©ºé—´æ•°æ®:', QQ_CharacterSpaces);
                console.log('äº’åŠ¨é¡µé¢æ•°æ®:', QQ_InteractivePages);
                console.log('å½“å‰é¡µé¢ç´¢å¼•:', QQ_InteractiveCurrentPage);
                
                // ç»Ÿè®¡ä¿¡æ¯
                const spiritCount = Object.keys(QQ_CharacterSpirits).length;
                const spaceCount = Object.keys(QQ_CharacterSpaces).reduce((total, char) => total + Object.keys(QQ_CharacterSpaces[char]).length, 0);
                const pageCount = Object.keys(QQ_InteractivePages).length;
                
                console.log('=== ç»Ÿè®¡ä¿¡æ¯ ===');
                console.log(`æ´»è·ƒç²¾çµæŒ‰é’®: ${spiritCount} ä¸ª`);
                console.log(`äº’åŠ¨ç©ºé—´æ€»æ•°: ${spaceCount} ä¸ª`);
                console.log(`é¡µé¢æ•°æ®æ€»æ•°: ${pageCount} ä¸ª`);
                
                toastr.info(`ç²¾çµç³»ç»ŸçŠ¶æ€: ${spiritCount}ä¸ªç²¾çµ, ${spaceCount}ä¸ªç©ºé—´, ${pageCount}ä¸ªé¡µé¢`, 'ç³»ç»ŸçŠ¶æ€');
            }
            
             
             // æ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸä¾›è°ƒè¯•ä½¿ç”¨
             window.QQ_Show_Spirit_System_Stats = QQ_Show_Spirit_System_Stats;
            
            /**
             * æ˜¾ç¤ºè§’è‰²ä¸“å±ç²¾çµæŒ‰é’®
             * @param {string} characterName - è§’è‰²åç§°
             */
            function QQ_ShowCharacterSpirit(characterName) {
                // å¦‚æœå·²ç»æ˜¾ç¤ºï¼Œåˆ™ä¸é‡å¤åˆ›å»º
                if ($(`.QQ_character_spirit[data-character="${characterName}"]`).length > 0) return;
                
                console.log(`æ˜¾ç¤ºè§’è‰² ${characterName} çš„ä¸“å±ç²¾çµæŒ‰é’®`);
                
                // éšè—å…¶ä»–è§’è‰²çš„ç²¾çµæŒ‰é’®
                QQ_HideAllCharacterSpirits();
                
                // è·å–è§’è‰²å¤´åƒ
                const characterAvatar = QQ_GetCharacterAvatar(characterName);
                
                // è·å–ä¸Šæ¬¡ä¿å­˜çš„ä½ç½®
                const savedPosition = localStorage.getItem(`QQ_spirit_position_${characterName}`);
                let position = { right: '20px', top: '50%' };
                if (savedPosition) {
                    try {
                        position = JSON.parse(savedPosition);
                    } catch (e) {
                        console.warn('è§£æè§’è‰²ç²¾çµä½ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®');
                    }
                }
                
                                // åˆ›å»ºç²¾çµæŒ‰é’®HTML
                const positionStyle = position.right ? 
                    'right: ' + position.right : 'left: ' + position.left;
                const topBottomStyle = position.bottom ? 
                    'bottom: ' + position.bottom : 'top: ' + position.top;
                
                const spiritHtml = 
                    '<div class="QQ_character_spirit" data-character="' + characterName + '" style="' +
                        'position: fixed;' +
                        positionStyle + ';' +
                        topBottomStyle + ';' +
                        'width: 70px;' +
                        'height: 70px;' +
                        'border-radius: 50%;' +
                        'box-shadow: 0 4px 20px rgba(255, 107, 107, 0.4);' +
                        'cursor: move;' +
                        'z-index: 9999;' +
                        'display: flex;' +
                        'align-items: center;' +
                        'justify-content: center;' +
                        'user-select: none;' +
                        'transition: all 0.3s ease;' +
                        'animation: characterSpiritPulse 2s infinite;' +
                        'background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);' +
                        'padding: 4px;' +
                    '" title="ä¸ ' + characterName + ' äº’åŠ¨">' +
                        '<img src="' + characterAvatar + '" alt="' + characterName + '" style="' +
                            'width: 100%;' +
                            'height: 100%;' +
                            'border-radius: 50%;' +
                            'object-fit: cover;' +
                            'border: 2px solid white;' +
                        '" onerror="this.onerror=null; this.src=\'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiByeD0iMzAiIGZpbGw9IiNGRjZCNkIiLz4KPHRLEHA+4pWpPC90ZXh0Pgo8L3N2Zz4K\'; console.log(\'å¤´åƒåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ: ' + characterName + '\');">' +
                        '<div style="' +
                            'position: absolute;' +
                            'bottom: -5px;' +
                            'right: -5px;' +
                            'width: 24px;' +
                            'height: 24px;' +
                            'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);' +
                            'border-radius: 50%;' +
                            'display: flex;' +
                            'align-items: center;' +
                            'justify-content: center;' +
                            'font-size: 12px;' +
                            'color: white;' +
                            'border: 2px solid white;' +
                            'box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);' +
                        '">âœ¨</div>' +
                    '</div>' +
                    '<style>' +
                        '@keyframes characterSpiritPulse {' +
                            '0%, 100% { transform: scale(1); box-shadow: 0 4px 20px rgba(255, 107, 107, 0.4); }' +
                            '50% { transform: scale(1.05); box-shadow: 0 6px 25px rgba(255, 107, 107, 0.6); }' +
                        '}' +
                        '.QQ_character_spirit:hover {' +
                            'transform: scale(1.1) !important;' +
                            'box-shadow: 0 6px 25px rgba(255, 107, 107, 0.7) !important;' +
                        '}' +
                    '</style>';
                
                $('body').append(spiritHtml);
                
                QQ_CharacterSpirits[characterName] = true;
                console.log(`è§’è‰² ${characterName} çš„ç²¾çµæŒ‰é’®å·²æ˜¾ç¤º`);
                
                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                $(`.QQ_character_spirit[data-character="${characterName}"]`).on('click touchend', function(e) {
                    if ($(this).hasClass('dragging')) {
                        return;
                    }
                    
                    e.stopPropagation();
                    e.preventDefault();
                    console.log(`è§’è‰²ç²¾çµè¢«ç‚¹å‡»: ${characterName}`);
                    QQ_ShowCharacterSpiritPanel(characterName);
                });
                
                // ç»‘å®šæ‹–æ‹½åŠŸèƒ½
                QQ_MakeCharacterSpiritDraggable(characterName);
                
                console.log(`è§’è‰² ${characterName} çš„ç²¾çµæŒ‰é’®å·²æ˜¾ç¤º`);
            }
            
            /**
             * éšè—æ‰€æœ‰è§’è‰²çš„ç²¾çµæŒ‰é’®
             */
            function QQ_HideAllCharacterSpirits() {
                $('.QQ_character_spirit').fadeOut(300, function() {
                    $(this).remove();
                });
                QQ_CharacterSpirits = {};
                console.log('æ‰€æœ‰è§’è‰²ç²¾çµæŒ‰é’®å·²éšè—');
            }
            
            /**
             * éšè—ç‰¹å®šè§’è‰²çš„ç²¾çµæŒ‰é’®
             * @param {string} characterName - è§’è‰²åç§°
             */
            function QQ_HideCharacterSpirit(characterName) {
                $(`.QQ_character_spirit[data-character="${characterName}"]`).fadeOut(300, function() {
                    $(this).remove();
                });
                delete QQ_CharacterSpirits[characterName];
                console.log(`è§’è‰² ${characterName} çš„ç²¾çµæŒ‰é’®å·²éšè—`);
            }
            
            /**
             * ä½¿è§’è‰²ç²¾çµæŒ‰é’®å¯æ‹–æ‹½
             * @param {string} characterName - è§’è‰²åç§°
             */
            function QQ_MakeCharacterSpiritDraggable(characterName) {
                let isDragging = false;
                let dragStarted = false;
                let startX, startY, initialX, initialY;
                let dragTimer;
                
                $(`.QQ_character_spirit[data-character="${characterName}"]`).on('mousedown touchstart', function(e) {
                    e.preventDefault();
                    dragStarted = false;
                    
                    const rect = this.getBoundingClientRect();
                    initialX = rect.left;
                    initialY = rect.top;
                    
                    const clientX = e.type === 'touchstart' ? e.originalEvent.touches[0].clientX : e.clientX;
                    const clientY = e.type === 'touchstart' ? e.originalEvent.touches[0].clientY : e.clientY;
                    
                    startX = clientX - initialX;
                    startY = clientY - initialY;
                    
                    dragTimer = setTimeout(() => {
                        isDragging = true;
                        dragStarted = true;
                        
                        $(`.QQ_character_spirit[data-character="${characterName}"]`).addClass('dragging').css({
                            'cursor': 'grabbing',
                            'z-index': '99999999',
                            'animation': 'none'
                        });
                        
                        console.log(`å¼€å§‹æ‹–æ‹½è§’è‰²ç²¾çµ: ${characterName}`);
                    }, 150);
                });
                
                $(document).on('mousemove touchmove', function(e) {
                    if (!isDragging) return;
                    
                    const clientX = e.type === 'touchmove' ? e.originalEvent.touches[0].clientX : e.clientX;
                    const clientY = e.type === 'touchmove' ? e.originalEvent.touches[0].clientY : e.clientY;
                    
                    const x = clientX - startX;
                    const y = clientY - startY;
                    
                    const maxX = window.innerWidth - 65;
                    const maxY = window.innerHeight - 65;
                    
                    const constrainedX = Math.max(0, Math.min(x, maxX));
                    const constrainedY = Math.max(0, Math.min(y, maxY));
                    
                    $(`.QQ_character_spirit[data-character="${characterName}"]`).css({
                        'left': constrainedX + 'px',
                        'top': constrainedY + 'px',
                        'right': 'auto',
                        'bottom': 'auto'
                    });
                    
                    e.preventDefault();
                });
                
                $(document).on('mouseup touchend', function(e) {
                    if (dragTimer) {
                        clearTimeout(dragTimer);
                        dragTimer = null;
                    }
                    
                    if (!isDragging && !dragStarted) {
                        return;
                    }
                    
                    if (!isDragging) return;
                    isDragging = false;
                    dragStarted = false;
                    
                    const $spirit = $(`.QQ_character_spirit[data-character="${characterName}"]`);
                    $spirit.removeClass('dragging').css({
                        'cursor': 'move',
                        'z-index': '9999999',
                        'animation': 'characterSpiritPulse 2s infinite'
                    });
                    
                    // ä¿å­˜ä½ç½®
                    const rect = $spirit[0].getBoundingClientRect();
                    const windowWidth = window.innerWidth;
                    const windowHeight = window.innerHeight;
                    
                    let position;
                    if (rect.left < windowWidth / 2) {
                        position = {
                            left: rect.left + 'px',
                            top: rect.top + 'px'
                        };
                    } else {
                        position = {
                            right: (windowWidth - rect.right) + 'px',
                            top: rect.top + 'px'
                        };
                    }
                    
                    const positionKey = `QQ_character_spirit_position_${characterName}`;
                    localStorage.setItem(positionKey, JSON.stringify(position));
                    console.log(`è§’è‰² ${characterName} ç²¾çµä½ç½®å·²ä¿å­˜`);
                });
            }
            
            /**
             * æ˜¾ç¤ºè§’è‰²ç²¾çµé¢æ¿
             * @param {string} characterName - è§’è‰²åç§°
             */
            function QQ_ShowCharacterSpiritPanel(characterName) {
                console.log(`æ˜¾ç¤ºè§’è‰² ${characterName} ç²¾çµé¢æ¿`);
                
                // ç¡®ä¿è§’è‰²åç§°æœ‰æ•ˆ
                if (!characterName || typeof characterName !== 'string') {
                    console.error('æ— æ•ˆçš„è§’è‰²åç§°:', characterName);
                    return;
                }
                
                // ç§»é™¤ç°æœ‰çš„é¢æ¿
                $('.QQ_character_spirit_panel').remove();
                
                // ä½¿ç”¨ç‹¬ç«‹æ€§æ£€æŸ¥ç¡®ä¿æ•°æ®å®‰å…¨
                if (!QQ_EnsureCharacterSpaceIndependence(characterName)) {
                    console.error(`è§’è‰² ${characterName} çš„äº’åŠ¨ç©ºé—´ç‹¬ç«‹æ€§æ£€æŸ¥å¤±è´¥`);
                    toastr.error('äº’åŠ¨ç©ºé—´æ•°æ®é”™è¯¯');
                    return;
                }
                
                // è·å–è§’è‰²çš„äº’åŠ¨ç©ºé—´åˆ—è¡¨
                const characterSpaces = QQ_CharacterSpaces[characterName];
                const spaceList = Object.values(characterSpaces);
                
                // åˆ›å»ºé¢æ¿HTML
                const panelHtml = `
                    <div class="QQ_character_spirit_panel" style="
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: white;
                        border-radius: 15px;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                        z-index: 99999999;
                        overflow: hidden;
                        animation: spiritPanelSlideIn 0.3s ease;
                        max-width: 90%;
                        max-height: 80%;
                        width: 350px;
                    ">
                        <div class="panel-header" style="
                            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
                            color: white;
                            padding: 20px;
                            text-align: center;
                            font-weight: 600;
                        ">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                                <img src="${charAvatarPath || getAvatarUrl(characterName)}" alt="${characterName}" style="
                                    width: 40px;
                                    height: 40px;
                                    border-radius: 50%;
                                    border: 2px solid white;
                                ">
                                <span style="font-size: 16px;">ğŸ’• ${characterName}çš„äº’åŠ¨ç©ºé—´</span>
                            </div>
                        </div>
                        
                        ${spaceList.length > 0 ? `
                            <div class="space-list" style="max-height: 300px; overflow-y: auto;">
                                ${spaceList.slice(0, 30).map(space => `
                                    <div class="space-item" data-space-id="${space.id}" style="
                                        padding: 15px 20px;
                                        border-bottom: 1px solid #f0f0f0;
                                        cursor: pointer;
                                        transition: background-color 0.2s ease;
                                        display: flex;
                                        align-items: center;
                                        gap: 12px;
                                    " onmouseover="this.style.backgroundColor='#f8f9fa'" 
                                       onmouseout="this.style.backgroundColor='transparent'">
                                        <div style="
                                            width: 10px;
                                            height: 10px;
                                            border-radius: 50%;
                                            background: #FF6B6B;
                                            flex-shrink: 0;
                                        "></div>
                                        <div style="flex: 1; min-width: 0;">
                                            <div style="
                                                font-size: 14px;
                                                font-weight: 500;
                                                color: #333;
                                                margin-bottom: 3px;
                                                overflow: hidden;
                                                text-overflow: ellipsis;
                                                white-space: nowrap;
                                            ">${space.name}</div>
                                            <div style="
                                                font-size: 12px;
                                                color: #999;
                                            ">${QQ_FormatDate(space.createdAt)}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div style="
                                padding: 40px 20px;
                                text-align: center;
                                color: #999;
                            ">
                                <div style="font-size: 48px; margin-bottom: 15px;">ğŸŒŸ</div>
                                <div style="font-size: 14px; margin-bottom: 8px;">è¿˜æ²¡æœ‰äº’åŠ¨è®°å½•</div>
                                <div style="font-size: 12px; color: #bbb;">å¼€å§‹ä¸€æ®µç°å®äº’åŠ¨å§ï½</div>
                            </div>
                        `}
                        
                        <div class="panel-actions" style="
                            padding: 20px;
                            background: #fafafa;
                            display: flex;
                            gap: 10px;
                        ">
                            <button class="new-space-btn" style="
                                flex: 1;
                                background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
                                border: none;
                                color: white;
                                padding: 12px 16px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 13px;
                                font-weight: 500;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.transform='translateY(-1px)'" 
                               onmouseout="this.style.transform='translateY(0)'">
                                âœ¨ åˆ›å»ºæ–°äº’åŠ¨
                            </button>
                            <button class="close-panel-btn" style="
                                background: #e9ecef;
                                border: none;
                                color: #666;
                                padding: 12px 16px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 13px;
                                font-weight: 500;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.background='#dee2e6'" 
                               onmouseout="this.style.background='#e9ecef'">
                                å…³é—­
                            </button>
                        </div>
                        
                        <!-- æ–°å¢ï¼šäº’åŠ¨çŠ¶æ€æç¤º -->
                        <div class="interactive-tip" style="
                            padding: 12px 20px;
                            background: linear-gradient(135deg, #E8F5E8 0%, #F0F8FF 100%);
                            border-top: 1px solid #e9ecef;
                            font-size: 12px;
                            color: #666;
                            line-height: 1.4;
                        ">
                            <div style="
                                display: flex;
                                align-items: center;
                                gap: 8px;
                                margin-bottom: 6px;
                                font-weight: 500;
                            ">
                                <span style="
                                    display: inline-block;
                                    width: 16px;
                                    height: 16px;
                                    background: #4CAF50;
                                    border-radius: 50%;
                                    color: white;
                                    text-align: center;
                                    line-height: 16px;
                                    font-size: 10px;
                                ">ğŸ’¡</span>
                                <span style="color: #4CAF50;">å½“å‰äº’åŠ¨è§¦å‘çŠ¶æ€</span>
                            </div>
                            <div id="interactive-status-content" style="margin-left: 24px; font-size: 11px;">
                                <!-- çŠ¶æ€å†…å®¹å°†é€šè¿‡JSåŠ¨æ€å¡«å…… -->
                            </div>
                        </div>
                    </div>
                    
                    <style>
                        @keyframes spiritPanelSlideIn {
                            from {
                                opacity: 0;
                                transform: translate(-50%, -60%);
                            }
                            to {
                                opacity: 1;
                                transform: translate(-50%, -50%);
                            }
                        }
                    </style>
                `;
                
                // æ·»åŠ åˆ°é¡µé¢
                $('body').append(panelHtml);
                
                // åŠ¨æ€æ›´æ–°äº’åŠ¨çŠ¶æ€
                QQ_UpdateInteractiveStatus();
                
                // ç»‘å®šäº‹ä»¶
                $('.QQ_character_spirit_panel').on('click', function(e) {
                    e.stopPropagation();
                    
                    const spaceItem = e.target.closest('.space-item');
                    const newSpaceBtn = e.target.closest('.new-space-btn');
                    const closePanelBtn = e.target.closest('.close-panel-btn');
                    
                    if (spaceItem) {
                        const spaceId = spaceItem.getAttribute('data-space-id');
                        console.log(`ç‚¹å‡»æŸ¥çœ‹äº’åŠ¨ç©ºé—´: ${spaceId}`);
                        QQ_DisplayEnhancedInteractiveSpace(spaceId, `${characterName}çš„äº’åŠ¨ç©ºé—´`, characterName);
                        $('.QQ_character_spirit_panel').remove();
                    } else if (newSpaceBtn) {
                        console.log(`ä¸ºè§’è‰² ${characterName} åˆ›å»ºæ–°çš„äº’åŠ¨ç©ºé—´`);
                        $('.QQ_character_spirit_panel').remove();
                        QQ_ShowCharacterInteractiveSpace(characterName);
                    } else if (closePanelBtn) {
                        $('.QQ_character_spirit_panel').remove();
                    }
                });
                
                // ç‚¹å‡»å¤–éƒ¨å…³é—­é¢æ¿
                $(document).one('click', function() {
                    $('.QQ_character_spirit_panel').remove();
                });
            }
            
            /**
             * æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
             * @param {string} dateStr - ISOæ—¥æœŸå­—ç¬¦ä¸²
             * @returns {string} æ ¼å¼åŒ–åçš„æ—¥æœŸ
             */
            function QQ_FormatDate(dateStr) {
                const date = new Date(dateStr);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                if (diffMins < 1) {
                    return 'åˆšåˆš';
                } else if (diffMins < 60) {
                    return `${diffMins}åˆ†é’Ÿå‰`;
                } else if (diffHours < 24) {
                    return `${diffHours}å°æ—¶å‰`;
                } else if (diffDays < 7) {
                    return `${diffDays}å¤©å‰`;
                } else {
                    return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
                }
            }
            
            /**
             * *** æ–°å¢ï¼šåˆ›å»ºç›´æ¥çš„äº’åŠ¨å†…å®¹è¯·æ±‚ ***
             * @param {string} userDescription - ç”¨æˆ·æè¿°çš„äº’åŠ¨å†…å®¹
             * @returns {string} ç›´æ¥äº’åŠ¨è¯·æ±‚
             */
            function QQ_CreateDirectInteractiveRequest(userDescription) {
                return `ğŸ¯ ç”¨æˆ·ä¸»åŠ¨è¯·æ±‚äº’åŠ¨å†…å®¹ï¼š
è¯·æ ¹æ®ç”¨æˆ·çš„æè¿°ï¼š"${userDescription}"ï¼Œç›´æ¥åˆ›å»ºä¸€ä¸ªç”ŸåŠ¨è¯¦ç»†çš„äº’åŠ¨åœºæ™¯ã€‚

ğŸ“‹ è¯·æ±‚è¦æ±‚ï¼š
1. ç›´æ¥ç”Ÿæˆäº’åŠ¨å†…å®¹ï¼Œæ— éœ€æ™®é€šèŠå¤©å›å¤
2. å†…å®¹å¿…é¡»ç”¨ <content> æ ‡ç­¾åŒ…è£¹
3. æè¿°è¦ç”ŸåŠ¨è¯¦ç»†ï¼Œç¬¦åˆç°å®äº’åŠ¨çš„æ„Ÿå—
4. æ ¹æ®äº’åŠ¨æ€§è´¨åˆ¤æ–­ä¿å­˜ä½ç½®ï¼š
   - æ¶‰åŠå¤šäºº/ç¾¤ä½“ â†’ å…¬å…±äº’åŠ¨ç©ºé—´
   - å•ç‹¬å’Œè§’è‰² â†’ è§’è‰²ä¸“å±ç©ºé—´
5. äº’åŠ¨å†…å®¹è¦æœ‰æ²‰æµ¸æ„Ÿå’ŒçœŸå®æ„Ÿ
6. åŒ…å«åŠ¨ä½œã€å¯¹è¯ã€æ„Ÿå®˜ç»†èŠ‚ã€æƒ…æ„Ÿè¡¨è¾¾

ğŸ’¡ è¿™æ˜¯ç”¨æˆ·ä½¿ç”¨ç‰¹æ®Šç¬¦å·ä¸»åŠ¨è§¦å‘çš„äº’åŠ¨è¯·æ±‚ï¼Œè¯·ç§¯æå›åº”ï¼

<Request:è¯·æ ¹æ®ä¸Šè¿°ç”¨æˆ·æè¿°ç”Ÿæˆäº’åŠ¨å†…å®¹ï¼Œç›´æ¥ç”¨contentæ ‡ç­¾åŒ…è£¹>`;
            }
            
            /**
             * ä¸ºäº’åŠ¨å†…å®¹è¯·æ±‚ä¿®æ”¹AIæŒ‡å¯¼
             * @param {string} originalRequest - åŸå§‹è¯·æ±‚å†…å®¹
             * @returns {string} - ä¿®æ”¹åçš„è¯·æ±‚å†…å®¹
             */
            function QQ_ModifyRequestForInteractive(originalRequest) {
                // åœ¨Requestæ ‡ç­¾ä¸­æ·»åŠ äº’åŠ¨å†…å®¹è¦æ±‚
                const interactiveGuidance = `
<InteractiveGuidance:ğŸ”¥ å¼ºåˆ¶æ‰§è¡Œï¼šç”¨æˆ·çš„æ¶ˆæ¯åŒ…å«æ˜æ˜¾çš„äº’åŠ¨æ„å›¾ï¼Œå¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹è¦æ±‚å›å¤ ğŸ”¥

ğŸ“±ã€åŒé‡å›å¤è¦æ±‚ã€‘ï¼š
1. ã€å¿…é¡»å…ˆå›å¤ã€‘åœ¨ç”¨æˆ·å½“å‰å‘è¨€çš„ä½ç½®ï¼ˆç§èŠ/ç¾¤èŠ/åŠ¨æ€è¯„è®ºï¼‰æ­£å¸¸å›å¤ï¼Œè¡¨è¾¾ååº”ã€ç¡®è®¤ã€æƒ…æ„Ÿç­‰
2. ã€ç„¶åæä¾›äº’åŠ¨ã€‘ç”¨<content>æ ‡ç­¾åŒ…è£¹è¯¦ç»†çš„ç°å®äº’åŠ¨åœºæ™¯æè¿°

ğŸš¨ã€å¼ºåˆ¶æ‰§è¡Œé¡ºåºã€‘ï¼š
- ç§èŠäº’åŠ¨ï¼šå…ˆåœ¨ç§èŠä¸­å›å¤ â†’ å†æä¾›äº’åŠ¨å†…å®¹
- ç¾¤èŠäº’åŠ¨ï¼šå…ˆåœ¨ç¾¤èŠä¸­å›å¤ â†’ å†æä¾›äº’åŠ¨å†…å®¹  
- åŠ¨æ€è¯„è®ºäº’åŠ¨ï¼šå…ˆåœ¨è¯„è®ºä¸­å›å¤ â†’ å†æä¾›äº’åŠ¨å†…å®¹

ğŸ’¬ã€å›å¤ç¤ºä¾‹æ ¼å¼ã€‘ï¼š

**ç§èŠåœºæ™¯**ï¼š
<ç”¨æˆ·åå’Œè§’è‰²åçš„ç§èŠ>
è§’è‰²å--å¥½çš„ï¼æˆ‘é©¬ä¸Šè¿‡æ¥æ‰¾ä½ ~--æ—¶é—´
</ç”¨æˆ·åå’Œè§’è‰²åçš„ç§èŠ>
<content>
*å°è·‘ç€ç©¿è¿‡èµ°å»Šï¼Œè½»è½»æ•²å“ä½ çš„æˆ¿é—¨* "æˆ‘æ¥äº†ï¼åˆšæ‰åœ¨å‡†å¤‡ä¸€äº›å°æƒŠå–œç»™ä½ ~" *çœ¼ä¸­é—ªçƒç€æœŸå¾…å’Œå…´å¥‹çš„å…‰èŠ’ï¼Œæ‰‹é‡Œè¿˜è—ç€ä»€ä¹ˆä¸œè¥¿*
</content>

**ç¾¤èŠåœºæ™¯**ï¼š
<ç¾¤èŠå>
è§’è‰²å--å¤ªå¥½äº†ï¼å¤§å®¶ä¸€èµ·æ¥å§ï¼--æ—¶é—´
</ç¾¤èŠå>
<content>
*å…´å¥‹åœ°ç«™èµ·èº«ï¼Œå‘å¤§å®¶æ‹›æ‰‹* "é‚£æˆ‘ä»¬å°±åœ¨è¿™é‡Œå¼€å§‹å§ï¼" *å¼€å§‹å‡†å¤‡éœ€è¦çš„ç‰©å“ï¼Œè„¸ä¸Šæ´‹æº¢ç€å¼€å¿ƒçš„ç¬‘å®¹*
</content>

**åŠ¨æ€è¯„è®ºåœºæ™¯**ï¼š
moment_start
è§’è‰²å--çœ‹èµ·æ¥å¾ˆæœ‰è¶£å‘¢ï¼æˆ‘ä¹Ÿæƒ³å‚ä¸
moment_end
<content>
*çœ‹åˆ°åŠ¨æ€åç«‹åˆ»æ”¾ä¸‹æ‰‹ä¸­çš„äº‹æƒ…ï¼Œå¿«æ­¥èµ°å‘ä½ * "åˆšçœ‹åˆ°ä½ çš„åŠ¨æ€ï¼Œæ„Ÿè§‰ç‰¹åˆ«æœ‰æ„æ€ï¼èƒ½è·Ÿæˆ‘è¯¦ç»†è¯´è¯´å—ï¼Ÿ" *çœ¼ç¥ä¸­å……æ»¡å¥½å¥‡å’ŒæœŸå¾…*
</content>

âš¡ã€å¼ºåˆ¶è¦æ±‚ã€‘ï¼š
1. å¿…é¡»å…ˆåœ¨å½“å‰å¯¹è¯ä½ç½®å›å¤ï¼ˆç§èŠ/ç¾¤èŠ/åŠ¨æ€è¯„è®ºï¼‰
2. å›å¤è¦è¡¨ç°å‡ºç§¯æå“åº”å’Œæƒ…æ„Ÿååº”
3. ç„¶åç”¨contentæ ‡ç­¾æä¾›ä¸°å¯Œçš„äº’åŠ¨åœºæ™¯
4. äº’åŠ¨å†…å®¹å¿…é¡»åŒ…å«åŠ¨ä½œã€å¯¹è¯ã€æ„Ÿå®˜ç»†èŠ‚ã€æƒ…æ„Ÿè¡¨è¾¾
5. ç¡®ä¿äº’åŠ¨çš„è¿è´¯æ€§å’ŒçœŸå®æ€§

ğŸš«ã€ç¦æ­¢è¡Œä¸ºã€‘ï¼š
- è·³è¿‡å½“å‰ä½ç½®çš„å›å¤ç›´æ¥æä¾›äº’åŠ¨
- äº’åŠ¨å†…å®¹è¿‡äºç®€çŸ­æˆ–ç¼ºä¹ç»†èŠ‚
- å¿½è§†ç”¨æˆ·å½“å‰çš„å¯¹è¯ç¯å¢ƒ
>`;
                
                // åœ¨åŸå§‹Requestä¹‹å‰æ’å…¥äº’åŠ¨æŒ‡å¯¼
                return originalRequest.replace(
                    /<Request:/,
                    `${interactiveGuidance}\n<Request:`
                );
            }
            
            /**
             * ç”Ÿæˆäº’åŠ¨ç©ºé—´çš„å”¯ä¸€ID
             */
            function QQ_GenerateSpaceId() {
                return "space_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);
            }
            
            /**
             * è·å–äº’åŠ¨ç©ºé—´çš„æ™ºèƒ½å‘½å
             * @param {string} content - äº’åŠ¨å†…å®¹
             * @param {string} characterName - è§’è‰²åç§°
             * @return {string} æ™ºèƒ½å‘½å
             */
            function QQ_GetSpaceName(content, characterName) {
                const charName = characterName || charcardname || "è§’è‰²";
                
                // æ£€æµ‹æ˜¯å¦åŒ…å«å¤šä¸ªè§’è‰²
                const characterMentions = content.match(/(?:@|ã€|ï¼ˆ|ï¼œ)\s*([^@ã€ï¼ˆï¼œã€‘ï¼‰ï¼\s]{2,8})\s*(?:ã€‘|ï¼‰|ï¼)/g) || [];
                const uniqueChars = [...new Set(characterMentions)];
                
                // åœºæ™¯å…³é”®è¯æå–
                const sceneKeywords = [
                    // åœ°ç‚¹åœºæ™¯
                    { keywords: ['å’–å•¡', 'å’–å•¡å…', 'å’–å•¡åº—'], name: 'å’–å•¡å…' },
                    { keywords: ['æ•™å®¤', 'å­¦æ ¡', 'è¯¾å ‚', 'ä¸Šè¯¾'], name: 'æ•™å®¤' },
                    { keywords: ['å…¬å›­', 'æ•£æ­¥', 'æ¨±èŠ±', 'é•¿æ¤…'], name: 'å…¬å›­' },
                    { keywords: ['å®¶é‡Œ', 'æˆ¿é—´', 'å§å®¤', 'å®¢å…'], name: 'å®¶ä¸­' },
                    { keywords: ['æµ·è¾¹', 'æ²™æ»©', 'æµ·æµª', 'å¤•é˜³'], name: 'æµ·è¾¹' },
                    { keywords: ['å›¾ä¹¦é¦†', 'çœ‹ä¹¦', 'å­¦ä¹ '], name: 'å›¾ä¹¦é¦†' },
                    { keywords: ['å•†åœº', 'è´­ç‰©', 'é€›è¡—'], name: 'å•†åœº' },
                    { keywords: ['é¤å…', 'åƒé¥­', 'ç”¨é¤'], name: 'é¤å…' },
                    
                    // æ´»åŠ¨åœºæ™¯
                    { keywords: ['æ¸¸æˆ', 'ç©æ¸¸æˆ', 'æ‰‹æœºæ¸¸æˆ'], name: 'æ¸¸æˆ' },
                    { keywords: ['å·¥ä½œ', 'åŠå…¬', 'ä¼šè®®'], name: 'å·¥ä½œ' },
                    { keywords: ['èšä¼š', 'æ´¾å¯¹', 'åº†ç¥'], name: 'èšä¼š' },
                    { keywords: ['æ—…è¡Œ', 'æ—…æ¸¸', 'å‡ºè¡Œ'], name: 'æ—…è¡Œ' },
                    { keywords: ['è¿åŠ¨', 'é”»ç‚¼', 'å¥èº«'], name: 'è¿åŠ¨' },
                    { keywords: ['åšé¥­', 'æ–™ç†', 'çƒ¹é¥ª'], name: 'çƒ¹é¥ª' },
                    { keywords: ['çœ‹ç”µå½±', 'ç”µå½±', 'è§‚å½±'], name: 'è§‚å½±' },
                    { keywords: ['èŠå¤©', 'è°ˆè¯', 'äº¤æµ'], name: 'è°ˆè¯' },
                    
                    // æƒ…æ„Ÿåœºæ™¯
                    { keywords: ['æ‹¥æŠ±', 'æŠ±æŠ±', 'å®‰æ…°'], name: 'æ¸©æš–æ—¶åˆ»' },
                    { keywords: ['ç”Ÿæ°”', 'åµæ¶', 'äº‰è®º'], name: 'äº‰æ‰§' },
                    { keywords: ['å¼€å¿ƒ', 'é«˜å…´', 'å¿«ä¹'], name: 'æ¬¢ä¹æ—¶å…‰' },
                    { keywords: ['éš¾è¿‡', 'ä¼¤å¿ƒ', 'å“­æ³£'], name: 'å®‰æ…°æ—¶åˆ»' },
                    { keywords: ['ç´§å¼ ', 'å®³æ€•', 'æ‹…å¿ƒ'], name: 'ç´§å¼ æ—¶åˆ»' },
                ];
                
                let detectedScene = "æ—¥å¸¸";
                for (const scene of sceneKeywords) {
                    if (scene.keywords.some(keyword => content.includes(keyword))) {
                        detectedScene = scene.name;
                        break;
                    }
                }
                
                // å‘½åé€»è¾‘
                if (uniqueChars.length > 1) {
                    // å¤šè§’è‰²ï¼šåœºæ™¯+å…³é”®å­—
                    const actionKeywords = content.match(/[\u4e00-\u9fa5]{2,4}(?:ç€|äº†|å‘¢|å§|å‘€)/g) || [];
                    const action = actionKeywords.length > 0 ? actionKeywords[0].replace(/[ç€äº†å‘¢å§å‘€]/g, '') : 'äº’åŠ¨';
                    return `${detectedScene}Â·${action}`;
                } else {
                    // å•è§’è‰²ï¼šè§’è‰²å+åœºæ™¯
                    return `${charName}Â·${detectedScene}`;
                }
            }
            
            /**
             * ä¿å­˜äº’åŠ¨ç©ºé—´åˆ°ä¸–ç•Œä¹¦
             */
            async function QQ_SaveInteractiveSpaces() {
                try {
                    if (!worldbook || !entries) {
                        console.warn('ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨ï¼Œæ— æ³•ä¿å­˜äº’åŠ¨ç©ºé—´');
                        return false;
                    }
                    
                    const spaceData = {
                        spaces: QQ_InteractiveSpaces,
                        lastUpdated: new Date().toISOString(),
                        version: "1.0"
                    };
                    
                    console.log(`å‡†å¤‡ä¿å­˜äº’åŠ¨ç©ºé—´åˆ°ä¸–ç•Œä¹¦: ${QQ_INTERACTIVE_BACKUP_KEY}, ç©ºé—´æ•°é‡: ${Object.keys(QQ_InteractiveSpaces).length}`);
                    
                    // *** ä¿®å¤ï¼šä½¿ç”¨ä¸åˆ†ç»„ã€åŠ¨æ€ç›¸åŒçš„æ­£ç¡®ä¿å­˜æœºåˆ¶ ***
                    const comment = QQ_INTERACTIVE_BACKUP_KEY;
                    let targetEntry = entries.find(entry => entry.comment === comment);
                    
                    // å‡†å¤‡ä¿å­˜çš„æ•°æ®
                    const jsonData = JSON.stringify(spaceData, null, 2);
                    
                    if (targetEntry) {
                        // ä½¿ç”¨setLorebookEntriesæ›´æ–°ç°æœ‰æ¡ç›®
                        await setLorebookEntries(worldbook, [{
                            uid: targetEntry.uid,
                            content: jsonData,
                        }]);
                        console.log(`âœ… äº’åŠ¨ç©ºé—´æ•°æ®å·²æ›´æ–°åˆ°ç°æœ‰ä¸–ç•Œä¹¦æ¡ç›®: ${comment}`);
                        
                        // æ›´æ–°æœ¬åœ°entriesä¸­çš„å¯¹åº”æ¡ç›®
                        targetEntry.content = jsonData;
                    } else {
                        // ä½¿ç”¨createLorebookEntryåˆ›å»ºæ–°æ¡ç›®ï¼ˆå‚è€ƒåˆ†ç»„å’ŒåŠ¨æ€çš„æˆåŠŸå®ç°ï¼‰
                        await createLorebookEntry(worldbook, {
                            comment: comment,
                            key: [`æ­¤ä¸–ç•Œä¹¦æ°¸ä¸è§¦å‘_äº’åŠ¨ç©ºé—´å¤‡ä»½`],
                            content: jsonData,
                            position: "at_depth_as_system",
                            type: "selective", // ç»¿ç¯ï¼šé€‰æ‹©æ€§è§¦å‘
                            depth: 0,
                            exclude_recursion: true,
                            order: 9997, // é¡ºåº9997ï¼Œä½äºåˆ†ç»„9998å’ŒåŠ¨æ€9999
                            enabled: true,
                        });
                        console.log(`âœ… äº’åŠ¨ç©ºé—´æ•°æ®å·²ä¿å­˜åˆ°æ–°ä¸–ç•Œä¹¦æ¡ç›®: ${comment}`);
                        
                        // é‡æ–°è·å–entriesä»¥åŒ…å«æ–°åˆ›å»ºçš„æ¡ç›®
                        entries = await getLorebookEntries(worldbook);
                    }
                    
                    // è§¦å‘ä¸–ç•Œä¹¦ä¿å­˜
                    await QQ_SafeSaveWorldInfo("äº’åŠ¨ç©ºé—´æ•°æ®");
                    
                    // éªŒè¯ä¿å­˜ç»“æœ
                    entries = await getLorebookEntries(worldbook);
                    const verifyEntry = entries.find(entry => entry.comment === comment);
                    
                    if (verifyEntry && verifyEntry.content && verifyEntry.content.includes('"spaces"')) {
                        console.log(`ğŸ¯ äº’åŠ¨ç©ºé—´ä¿å­˜éªŒè¯æˆåŠŸ: ${Object.keys(QQ_InteractiveSpaces).length}ä¸ªç©ºé—´`);
                        console.log(`ğŸ“Š ä¸–ç•Œä¹¦æ¡ç›®å†…å®¹é•¿åº¦: ${verifyEntry.content.length} å­—ç¬¦`);
                        return true;
                    } else {
                        console.error('âŒ äº’åŠ¨ç©ºé—´ä¿å­˜éªŒè¯å¤±è´¥');
                        console.error('éªŒè¯æ¡ç›®:', verifyEntry ? 'æ‰¾åˆ°æ¡ç›®ä½†å†…å®¹å¼‚å¸¸' : 'æœªæ‰¾åˆ°æ¡ç›®');
                        // å³ä½¿éªŒè¯å¤±è´¥ï¼Œå¦‚æœæ“ä½œæ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ï¼Œæˆ‘ä»¬ä»ç„¶è®¤ä¸ºä¿å­˜å¯èƒ½æˆåŠŸäº†
                        console.log('âš ï¸ å°½ç®¡éªŒè¯å¤±è´¥ï¼Œä½†ä¿å­˜æ“ä½œå·²æ‰§è¡Œï¼Œå¯èƒ½æ•°æ®å·²ä¿å­˜');
                        return true; // æ”¹ä¸ºè¿”å›trueï¼Œé¿å…è¯¯æŠ¥å¤±è´¥
                    }
                    
                } catch (error) {
                    console.error('ä¿å­˜äº’åŠ¨ç©ºé—´æ—¶å‘ç”Ÿé”™è¯¯:', error);
                    return false;
                }
            }
            
            /**
             * ä»ä¸–ç•Œä¹¦åŠ è½½äº’åŠ¨ç©ºé—´
             */
            async function QQ_LoadInteractiveSpaces() {
                try {
                    if (!worldbook || !entries) {
                        console.warn('ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨ï¼Œæ— æ³•åŠ è½½äº’åŠ¨ç©ºé—´');
                        QQ_InteractiveSpaces = {};
                        return;
                    }
                    
                    // *** ä¿®å¤ï¼šä½¿ç”¨ä¸åˆ†ç»„ç›¸åŒçš„ç›´æ¥åŠ è½½æœºåˆ¶ ***
                    const comment = QQ_INTERACTIVE_BACKUP_KEY;
                    const entry = entries.find(e => e.comment === comment);
                    
                    if (entry && entry.content) {
                        try {
                            const data = JSON.parse(entry.content);
                            if (data && data.spaces) {
                                QQ_InteractiveSpaces = data.spaces;
                                console.log(`âœ… ä»ä¸–ç•Œä¹¦åŠ è½½äº’åŠ¨ç©ºé—´: ${Object.keys(QQ_InteractiveSpaces).length}ä¸ªç©ºé—´`);
                            } else {
                                QQ_InteractiveSpaces = {};
                                console.log('ğŸ“‹ ä¸–ç•Œä¹¦æ¡ç›®å­˜åœ¨ä½†æ•°æ®æ ¼å¼å¼‚å¸¸ï¼Œåˆå§‹åŒ–ä¸ºç©º');
                            }
                        } catch (parseError) {
                            console.error('è§£æäº’åŠ¨ç©ºé—´æ•°æ®å¤±è´¥:', parseError);
                            QQ_InteractiveSpaces = {};
                        }
                    } else {
                        QQ_InteractiveSpaces = {};
                        console.log('ğŸ“‹ ä¸–ç•Œä¹¦ä¸­æ²¡æœ‰äº’åŠ¨ç©ºé—´æ•°æ®ï¼Œåˆå§‹åŒ–ä¸ºç©º');
                    }
                } catch (error) {
                    console.error('ä»ä¸–ç•Œä¹¦åŠ è½½äº’åŠ¨ç©ºé—´å¤±è´¥:', error);
                    QQ_InteractiveSpaces = {};
                }
            }
            
            /**
             * *** æ–°å¢ï¼šé¢„åŠ è½½è§’è‰²ç›¸å…³çš„ä¸–ç•Œä¹¦æ•°æ® ***
             * åœ¨æ‰“å¼€ç²¾çµé¢æ¿æ—¶ç«‹å³å¼€å§‹åŠ è½½ï¼Œç¡®ä¿åç»­æ“ä½œå“åº”å¿«é€Ÿ
             * @param {string} characterName - è§’è‰²åç§°
             */
            async function QQ_PreloadCharacterDataFromWorldbook(characterName) {
                console.log(`ğŸš€ å¼€å§‹é¢„åŠ è½½è§’è‰² ${characterName} çš„ä¸–ç•Œä¹¦æ•°æ®`);
                
                try {
                    // å¹¶è¡ŒåŠ è½½å¤šä¸ªæ•°æ®æº
                    const loadPromises = [
                        // 1. åŠ è½½è§’è‰²ä¸“å±äº’åŠ¨ç©ºé—´
                        QQ_LoadSpecificCharacterSpaces(characterName),
                        // 2. åŠ è½½å…¬å…±äº’åŠ¨ç©ºé—´ï¼ˆé¢„è§ˆç”¨ï¼‰
                        QQ_LoadPublicInteractiveSpacesPreview(),
                        // 3. åŠ è½½è§’è‰²äº’åŠ¨å†…å®¹
                        QQ_LoadCharacterInteractiveContent(characterName)
                    ];
                    
                    const results = await Promise.allSettled(loadPromises);
                    
                    // ç»Ÿè®¡åŠ è½½ç»“æœ
                    let successCount = 0;
                    let failCount = 0;
                    
                    results.forEach((result, index) => {
                        if (result.status === 'fulfilled') {
                            successCount++;
                            console.log(`âœ… é¢„åŠ è½½ä»»åŠ¡ ${index + 1} æˆåŠŸ`);
                        } else {
                            failCount++;
                            console.warn(`âš ï¸ é¢„åŠ è½½ä»»åŠ¡ ${index + 1} å¤±è´¥:`, result.reason);
                        }
                    });
                    
                    console.log(`ğŸ“Š é¢„åŠ è½½å®Œæˆ: ${successCount}/${results.length} ä¸ªä»»åŠ¡æˆåŠŸ`);
                    
                    // æ ‡è®°è¯¥è§’è‰²æ•°æ®å·²é¢„åŠ è½½
                    if (!window.QQ_PreloadedCharacters) {
                        window.QQ_PreloadedCharacters = new Set();
                    }
                    window.QQ_PreloadedCharacters.add(characterName);
                    
                } catch (error) {
                    console.error(`âŒ é¢„åŠ è½½è§’è‰² ${characterName} æ•°æ®æ—¶å‡ºé”™:`, error);
                }
            }
            
            /**
             * *** æ–°å¢ï¼šåŠ è½½ç‰¹å®šè§’è‰²çš„äº’åŠ¨ç©ºé—´æ•°æ® ***
             * @param {string} characterName - è§’è‰²åç§°
             */
            async function QQ_LoadSpecificCharacterSpaces(characterName) {
                try {
                    if (!worldbook || !entries) {
                        console.warn('ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨ï¼Œæ— æ³•åŠ è½½è§’è‰²äº’åŠ¨ç©ºé—´');
                        return false;
                    }
                    
                    // ç¡®ä¿è§’è‰²æœ‰äº’åŠ¨ç©ºé—´æ•°æ®å®¹å™¨
                    if (!QQ_CharacterSpaces[characterName]) {
                        QQ_CharacterSpaces[characterName] = {};
                    }
                    
                    // æŸ¥æ‰¾è§’è‰²ä¸“å±çš„äº’åŠ¨ç©ºé—´æ¡ç›®
                    const characterSpaceEntries = entries.filter(e => 
                        e.comment && e.comment.includes('QQ_è§’è‰²äº’åŠ¨ç©ºé—´') && 
                        e.comment.includes(characterName)
                    );
                    
                    let loadedCount = 0;
                    for (const entry of characterSpaceEntries) {
                        try {
                            const data = JSON.parse(entry.content);
                            if (data.characterName === characterName && data.spaces) {
                                // åˆå¹¶åˆ°è§’è‰²äº’åŠ¨ç©ºé—´æ•°æ®
                                Object.assign(QQ_CharacterSpaces[characterName], data.spaces);
                                loadedCount++;
                            }
                        } catch (parseError) {
                            console.warn(`è§£æè§’è‰²äº’åŠ¨ç©ºé—´æ¡ç›®å¤±è´¥:`, parseError);
                        }
                    }
                    
                    console.log(`ğŸ“¦ è§’è‰² ${characterName} äº’åŠ¨ç©ºé—´é¢„åŠ è½½: ${loadedCount} ä¸ªæ¡ç›®, ${Object.keys(QQ_CharacterSpaces[characterName]).length} ä¸ªç©ºé—´`);
                    return true;
                    
                } catch (error) {
                    console.error(`åŠ è½½è§’è‰² ${characterName} äº’åŠ¨ç©ºé—´å¤±è´¥:`, error);
                    return false;
                }
            }
            
            /**
             * *** æ–°å¢ï¼šé¢„åŠ è½½å…¬å…±äº’åŠ¨ç©ºé—´æ¦‚è§ˆ ***
             * åªåŠ è½½åŸºæœ¬ä¿¡æ¯ï¼Œä¸åŠ è½½å®Œæ•´å†…å®¹
             */
            async function QQ_LoadPublicInteractiveSpacesPreview() {
                try {
                    if (!worldbook || !entries) {
                        console.warn('ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨ï¼Œæ— æ³•é¢„åŠ è½½å…¬å…±äº’åŠ¨ç©ºé—´');
                        return false;
                    }
                    
                    // æŸ¥æ‰¾å…¬å…±äº’åŠ¨ç©ºé—´ç›¸å…³æ¡ç›®
                    const publicSpaceEntries = entries.filter(e => 
                        e.comment && e.comment.includes('QQ_äº’åŠ¨ç©ºé—´å¤‡ä»½') && 
                        !e.comment.includes('è§’è‰²äº’åŠ¨ç©ºé—´')
                    );
                    
                    let previewCount = 0;
                    if (!window.QQ_PublicSpacePreviews) {
                        window.QQ_PublicSpacePreviews = {};
                    }
                    
                    for (const entry of publicSpaceEntries) {
                        try {
                            const data = JSON.parse(entry.content);
                            if (data.spaces) {
                                // åªä¿å­˜é¢„è§ˆä¿¡æ¯ï¼Œä¸åŠ è½½å®Œæ•´å†…å®¹
                                Object.keys(data.spaces).forEach(spaceId => {
                                    const space = data.spaces[spaceId];
                                    window.QQ_PublicSpacePreviews[spaceId] = {
                                        id: spaceId,
                                        name: space.name,
                                        characterName: space.characterName,
                                        createdAt: space.createdAt,
                                        lastAccess: space.lastAccess,
                                        preview: space.content ? space.content.substring(0, 100) + '...' : '',
                                        entryComment: entry.comment
                                    };
                                });
                                previewCount++;
                            }
                        } catch (parseError) {
                            console.warn(`è§£æå…¬å…±äº’åŠ¨ç©ºé—´æ¡ç›®å¤±è´¥:`, parseError);
                        }
                    }
                    
                    console.log(`ğŸŒ å…¬å…±äº’åŠ¨ç©ºé—´é¢„è§ˆé¢„åŠ è½½: ${previewCount} ä¸ªæ¡ç›®, ${Object.keys(window.QQ_PublicSpacePreviews || {}).length} ä¸ªç©ºé—´é¢„è§ˆ`);
                    return true;
                    
                } catch (error) {
                    console.error('é¢„åŠ è½½å…¬å…±äº’åŠ¨ç©ºé—´é¢„è§ˆå¤±è´¥:', error);
                    return false;
                }
            }
            
            /**
             * *** æ–°å¢ï¼šåŠ è½½è§’è‰²äº’åŠ¨å†…å®¹ ***
             * @param {string} characterName - è§’è‰²åç§°
             */
            async function QQ_LoadCharacterInteractiveContent(characterName) {
                try {
                    if (!worldbook || !entries) {
                        console.warn('ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨ï¼Œæ— æ³•åŠ è½½è§’è‰²äº’åŠ¨å†…å®¹');
                        return false;
                    }
                    
                    // æŸ¥æ‰¾è§’è‰²ç›¸å…³çš„äº’åŠ¨å†…å®¹æ¡ç›®
                    const contentEntries = entries.filter(e => 
                        e.comment && e.comment.includes('QQ_äº’åŠ¨å†…å®¹') && 
                        e.comment.includes(characterName)
                    );
                    
                    let contentCount = 0;
                    if (!window.QQ_CharacterInteractiveContents) {
                        window.QQ_CharacterInteractiveContents = {};
                    }
                    
                    if (!window.QQ_CharacterInteractiveContents[characterName]) {
                        window.QQ_CharacterInteractiveContents[characterName] = [];
                    }
                    
                    for (const entry of contentEntries) {
                        try {
                            const data = JSON.parse(entry.content);
                            if (data.characterName === characterName) {
                                window.QQ_CharacterInteractiveContents[characterName].push({
                                    id: data.id,
                                    content: data.content,
                                    createdAt: data.createdAt,
                                    entryUid: entry.uid
                                });
                                contentCount++;
                            }
                        } catch (parseError) {
                            console.warn(`è§£æè§’è‰²äº’åŠ¨å†…å®¹æ¡ç›®å¤±è´¥:`, parseError);
                        }
                    }
                    
                    console.log(`ğŸ’¬ è§’è‰² ${characterName} äº’åŠ¨å†…å®¹é¢„åŠ è½½: ${contentCount} ä¸ªæ¡ç›®`);
                    return true;
                    
                } catch (error) {
                    console.error(`åŠ è½½è§’è‰² ${characterName} äº’åŠ¨å†…å®¹å¤±è´¥:`, error);
                    return false;
                }
            }
            
            /**
             * ä»ä¸–ç•Œä¹¦åŠ è½½è§’è‰²ä¸“å±äº’åŠ¨ç©ºé—´
             */
            async function QQ_LoadCharacterSpaces() {
                try {
                    if (!worldbook || !entries) {
                        console.warn('ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨ï¼Œæ— æ³•åŠ è½½è§’è‰²äº’åŠ¨ç©ºé—´');
                        QQ_CharacterSpaces = {};
                        return;
                    }
                    
                    const entry = entries.find(e => e.comment === QQ_CHARACTER_SPACES_KEY);
                    if (entry && entry.content) {
                        const data = JSON.parse(entry.content);
                        QQ_CharacterSpaces = data.characterSpaces || {};
                        const totalSpaces = Object.values(QQ_CharacterSpaces).reduce((sum, char) => sum + Object.keys(char).length, 0);
                        console.log('ä»ä¸–ç•Œä¹¦åŠ è½½è§’è‰²äº’åŠ¨ç©ºé—´:', Object.keys(QQ_CharacterSpaces).length, 'ä¸ªè§’è‰²,', totalSpaces, 'ä¸ªç©ºé—´');
                    } else {
                        QQ_CharacterSpaces = {};
                        console.log('ä¸–ç•Œä¹¦ä¸­æ²¡æœ‰è§’è‰²äº’åŠ¨ç©ºé—´æ•°æ®ï¼Œåˆå§‹åŒ–ä¸ºç©º');
                    }
                } catch (error) {
                    console.error('ä»ä¸–ç•Œä¹¦åŠ è½½è§’è‰²äº’åŠ¨ç©ºé—´å¤±è´¥:', error);
                    QQ_CharacterSpaces = {};
                }
            }

            /**
             * åœ¨æ‰‹æœºç•Œé¢æ˜¾ç¤ºäº’åŠ¨ç©ºé—´
             * @param {string} content - äº’åŠ¨å†…å®¹
             * @param {string} characterName - è§’è‰²åç§°
             */
            function QQ_ShowInteractiveSpace(content, characterName = "") {
                // æ¸…ç†å†…å®¹ - ä¼˜å…ˆå¤„ç†contentæ ‡ç­¾
                let cleanContent;
                if (QQ_HasContentTag(content)) {
                    cleanContent = QQ_CleanContentTags(content);
                } else {
                    cleanContent = content
                        .replace(/MiPhone_start/g, "")
                        .replace(/MiPhone_end/g, "")
                        .trim();
                }
                
                // ç”Ÿæˆç©ºé—´IDå’Œåç§°
                const spaceId = QQ_GenerateSpaceId();
                const spaceName = QQ_GetSpaceName(cleanContent, characterName);
                const charName = characterName || charcardname || "è§’è‰²";
                const charAvatar = charAvatarPath || "default_avatar.png";
                
                // ä¿å­˜äº’åŠ¨ç©ºé—´æ•°æ®
                QQ_InteractiveSpaces[spaceId] = {
                    id: spaceId,
                    name: spaceName,
                    content: cleanContent,
                    characterName: charName,
                    characterAvatar: charAvatar,
                    createdAt: new Date().toISOString(),
                    lastAccess: new Date().toISOString()
                };
                
                // è®¾ç½®å½“å‰æ´»åŠ¨ç©ºé—´
                QQ_ActiveSpaceId = spaceId;
                
                // *** ç«‹å³ä¿å­˜äº’åŠ¨ç©ºé—´åˆ°ä¸–ç•Œä¹¦ ***
                // ä½¿ç”¨ç»Ÿä¸€çš„äº’åŠ¨ç©ºé—´ä¿å­˜æœºåˆ¶ï¼Œç¡®ä¿UIæ˜¾ç¤ºçš„æ•°æ®èƒ½æ­£ç¡®ä¿å­˜
                QQ_SaveInteractiveSpaces().then(() => {
                    console.log(`ğŸ¯ äº’åŠ¨ç©ºé—´å·²ä¿å­˜åˆ°ä¸–ç•Œä¹¦: ${spaceId}, è§’è‰²: ${charName}`);
                }).catch(error => {
                    console.error('ä¿å­˜äº’åŠ¨ç©ºé—´å¤±è´¥:', error);
                });
                
                // ç§»é™¤ç°æœ‰çš„äº’åŠ¨ç©ºé—´
                $('.QQ_interactive_space').remove();
                
                // åˆ›å»ºäº’åŠ¨ç©ºé—´HTML - æ›´ç¬¦åˆæ‰‹æœºç•Œé¢é£æ ¼
                const interactiveSpaceHtml = `
                    <div class="QQ_interactive_space" data-space-id="${spaceId}" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.7);
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        animation: fadeIn 0.3s ease;
                        backdrop-filter: blur(10px);
                    ">
                        <div class="QQ_interactive_content" style="
                            background: #ffffff;
                            border-radius: 15px;
                            padding: 0;
                            max-width: 85%;
                            max-height: 75%;
                            overflow: hidden;
                            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                            position: relative;
                            color: #333;
                            animation: slideIn 0.3s ease;
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        ">
                            <div class="QQ_interactive_header" style="
                                background: linear-gradient(135deg, #4FC3F7 0%, #29B6F6 100%);
                                padding: 20px;
                                display: flex;
                                align-items: center;
                                color: white;
                                position: relative;
                            ">
                                <img src="${charAvatar}" alt="${charName}" style="
                                    width: 45px;
                                    height: 45px;
                                    border-radius: 50%;
                                    margin-right: 15px;
                                    border: 3px solid white;
                                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                                ">
                                <div style="flex: 1;">
                                    <h3 style="margin: 0; font-size: 17px; font-weight: 600;">${spaceName}</h3>
                                    <p style="margin: 3px 0 0 0; font-size: 13px; opacity: 0.9;">ç°å®äº’åŠ¨æ¨¡å¼</p>
                                </div>
                                <button class="QQ_rename_space" style="
                                    background: rgba(255, 255, 255, 0.2);
                                    border: none;
                                    color: white;
                                    width: 32px;
                                    height: 32px;
                                    border-radius: 50%;
                                    cursor: pointer;
                                    font-size: 14px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    transition: all 0.3s ease;
                                    margin-right: 8px;
                                " onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" 
                                   onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'"
                                   title="é‡å‘½åç©ºé—´">
                                    âœï¸
                                </button>
                                <button class="QQ_close_interactive" style="
                                    background: rgba(255, 255, 255, 0.2);
                                    border: none;
                                    color: white;
                                    width: 32px;
                                    height: 32px;
                                    border-radius: 50%;
                                    cursor: pointer;
                                    font-size: 18px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" 
                                   onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">
                                    Ã—
                                </button>
                            </div>
                            <div class="QQ_interactive_body" style="
                                padding: 25px 20px;
                                font-size: 15px;
                                line-height: 1.5;
                                white-space: pre-wrap;
                                color: #333;
                                background: #fafafa;
                                max-height: 300px;
                                overflow-y: auto;
                            ">${cleanContent}</div>
                            <div class="QQ_interactive_footer" style="
                                padding: 20px;
                                background: #ffffff;
                                border-top: 1px solid #eee;
                                display: flex;
                                justify-content: center;
                                gap: 15px;
                            ">
                                <button class="QQ_reply_interactive" style="
                                    background: #4FC3F7;
                                    border: none;
                                    color: white;
                                    padding: 12px 24px;
                                    border-radius: 25px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 2px 8px rgba(79, 195, 247, 0.3);
                                " onmouseover="this.style.background='#29B6F6'; this.style.transform='translateY(-1px)'" 
                                   onmouseout="this.style.background='#4FC3F7'; this.style.transform='translateY(0)'">
                                    ğŸ’¬ å›åº”äº’åŠ¨
                                </button>
                                <button class="QQ_close_interactive" style="
                                    background: #f5f5f5;
                                    border: none;
                                    color: #666;
                                    padding: 12px 24px;
                                    border-radius: 25px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.background='#eeeeee'" 
                                   onmouseout="this.style.background='#f5f5f5'">
                                    å…³é—­
                                </button>
                            </div>
                        </div>
                    </div>
                    <style>
                        @keyframes fadeIn {
                            from { opacity: 0; }
                            to { opacity: 1; }
                        }
                        @keyframes slideIn {
                            from { transform: translateY(-30px); opacity: 0; }
                            to { transform: translateY(0); opacity: 1; }
                        }
                        .QQ_interactive_space * {
                            user-select: text;
                        }
                    </style>
                `;
                
                // æ·»åŠ åˆ°é¡µé¢
                $('body').append(interactiveSpaceHtml);
                
                // ç»‘å®šé‡å‘½åäº‹ä»¶
                $('.QQ_rename_space').off('click').on('click', function() {
                    QQ_RenameInteractiveSpace(spaceId);
                });
                
                // ç»‘å®šå…³é—­äº‹ä»¶
                $('.QQ_close_interactive').off('click').on('click', function() {
                    QQ_CloseInteractiveSpace();
                });
                
                // ç»‘å®šå›åº”äº’åŠ¨äº‹ä»¶
                $('.QQ_reply_interactive').off('click').on('click', function() {
                    // å…³é—­äº’åŠ¨ç©ºé—´
                    QQ_CloseInteractiveSpace();
                    
                    // æ‰“å¼€è¾“å…¥æ¡†è®©ç”¨æˆ·å›åº”
                    QQ_OpenInteractiveReply(charName);
                });
                
                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                $('.QQ_interactive_space').on('click', function(e) {
                    if (e.target === this) {
                        QQ_CloseInteractiveSpace();
                    }
                });
                
                triggerSlash(`/echo æ£€æµ‹åˆ°äº’åŠ¨å†…å®¹ï¼Œå·²åœ¨æ‰‹æœºç•Œé¢æ˜¾ç¤ºï¼š${spaceName}`);
            }
            
            /**
             * å…³é—­äº’åŠ¨ç©ºé—´å¹¶æ˜¾ç¤ºç²¾çµæŒ‰é’®
             */
            function QQ_CloseInteractiveSpace() {
                $('.QQ_interactive_space').fadeOut(300, function() {
                            $(this).remove();
                    // æ˜¾ç¤ºç²¾çµæŒ‰é’®
                    QQ_ShowSpiritButton();
                });
                QQ_ActiveSpaceId = null;
            }
            
            /**
             * é‡å‘½åäº’åŠ¨ç©ºé—´
             * @param {string} spaceId - ç©ºé—´ID
             */
            function QQ_RenameInteractiveSpace(spaceId) {
                const space = QQ_InteractiveSpaces[spaceId];
                if (!space) return;
                
                const newName = prompt('è¯·è¾“å…¥æ–°çš„ç©ºé—´åç§°:', space.name);
                if (newName && newName.trim() && newName.trim() !== space.name) {
                    space.name = newName.trim();
                    // æ›´æ–°æ˜¾ç¤º
                    $('.QQ_interactive_header h3').text(space.name);
                    // ä¿å­˜åˆ°ä¸–ç•Œä¹¦
                    QQ_SaveInteractiveSpaces();
                    triggerSlash(`/echo äº’åŠ¨ç©ºé—´å·²é‡å‘½åä¸ºï¼š${space.name}`);
                }
            }
            
            // ===== å¢å¼ºç‰ˆäº’åŠ¨ç©ºé—´ç³»ç»Ÿ =====
            
            let QQ_InteractivePages = {}; // å­˜å‚¨æ¯ä¸ªäº’åŠ¨ç©ºé—´çš„é¡µé¢æ•°æ®
            let QQ_InteractiveCurrentPage = {}; // å­˜å‚¨å½“å‰æ˜¾ç¤ºçš„é¡µé¢ç´¢å¼•
            
            /**
             * æ˜¾ç¤ºå¢å¼ºç‰ˆäº’åŠ¨ç©ºé—´ï¼ˆå¸¦å›å¤å’Œåˆ†é¡µåŠŸèƒ½ï¼‰
             * @param {string} spaceId - ç©ºé—´ID
             * @param {string} spaceTitle - ç©ºé—´æ ‡é¢˜
             * @param {string} characterName - è§’è‰²åï¼ˆå¯é€‰ï¼Œç”¨äºè§’è‰²ä¸“å±ç©ºé—´ï¼‰
             */
            function QQ_DisplayEnhancedInteractiveSpace(spaceId, spaceTitle, characterName = null) {
                const spaceData = characterName ? 
                    QQ_CharacterSpaces[characterName][spaceId] : 
                    QQ_InteractiveSpaces[spaceId];
                
                if (!spaceData) {
                    console.error('æœªæ‰¾åˆ°äº’åŠ¨ç©ºé—´æ•°æ®:', spaceId);
                    return;
                }
                
                // åˆå§‹åŒ–é¡µé¢æ•°æ®
                if (!QQ_InteractivePages[spaceId]) {
                    QQ_InteractivePages[spaceId] = [spaceData.content];
                }
                if (!QQ_InteractiveCurrentPage[spaceId]) {
                    QQ_InteractiveCurrentPage[spaceId] = 0;
                }
                
                // ç§»é™¤ç°æœ‰çš„äº’åŠ¨ç©ºé—´
                $('.QQ_interactive_space_enhanced').remove();
                
                const isCharacterSpace = spaceData.type === 'character';
                const headerColor = isCharacterSpace ? 
                    'linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%)' : 
                    'linear-gradient(135deg, #4FC3F7 0%, #29B6F6 100%)';
                
                const currentPageIndex = QQ_InteractiveCurrentPage[spaceId];
                const totalPages = QQ_InteractivePages[spaceId].length;
                const currentContent = QQ_InteractivePages[spaceId][currentPageIndex];
                
                // åˆ›å»ºå¢å¼ºç‰ˆäº’åŠ¨ç©ºé—´HTML
                const interactiveSpaceHtml = `
                    <div class="QQ_interactive_space_enhanced" data-space-id="\${spaceId}" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.7);
                        z-index: 99999999;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        animation: fadeIn 0.3s ease;
                        backdrop-filter: blur(10px);
                    ">
                        <div class="QQ_interactive_content_enhanced" style="
                            background: #ffffff;
                            border-radius: 20px;
                            padding: 0;
                            max-width: 90%;
                            max-height: 85%;
                            overflow: hidden;
                            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                            position: relative;
                            color: #333;
                            animation: slideIn 0.3s ease;
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                            width: 400px;
                        ">
                            <div class="QQ_interactive_header_enhanced" style="
                                background: \${headerColor};
                                padding: 20px;
                                display: flex;
                                align-items: center;
                                color: white;
                                position: relative;
                            ">
                                <img src="\${spaceData.characterAvatar}" alt="\${spaceData.characterName}" style="
                                    width: 45px;
                                    height: 45px;
                                    border-radius: 50%;
                                    margin-right: 12px;
                                    border: 2px solid white;
                                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                                ">
                                <div style="flex: 1;">
                                    <h3 style="margin: 0; font-size: 16px; font-weight: 600;">\${spaceData.name}</h3>
                                    <p style="margin: 3px 0 0 0; font-size: 12px; opacity: 0.9;">
                                        \${isCharacterSpace ? \`\${spaceData.characterName}çš„ä¸“å±äº’åŠ¨\` : 'å…¬å…±äº’åŠ¨ç©ºé—´'}
                                    </p>
                                </div>
                                \${totalPages > 1 ? \`
                                    <div style="margin-right: 15px; font-size: 12px; opacity: 0.9;">
                                        \${currentPageIndex + 1} / \${totalPages}
                                    </div>
                                \` : ''}
                                <button class="QQ_close_interactive_enhanced" style="
                                    background: rgba(255, 255, 255, 0.2);
                                    border: none;
                                    color: white;
                                    width: 30px;
                                    height: 30px;
                                    border-radius: 50%;
                                    cursor: pointer;
                                    font-size: 16px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" 
                                   onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">
                                    Ã—
                                </button>
                            </div>
                            
                            <div class="QQ_interactive_body_enhanced" style="
                                padding: 25px 20px;
                                font-size: 15px;
                                line-height: 1.6;
                                white-space: pre-wrap;
                                color: #333;
                                background: #fafafa;
                                max-height: 280px;
                                overflow-y: auto;
                                word-wrap: break-word;
                                border-bottom: 1px solid #eee;
                            ">\${currentContent}</div>
                            
                            \${totalPages > 1 ? \`
                                <div class="QQ_interactive_pagination" style="
                                    padding: 15px 20px;
                                    background: #ffffff;
                                    border-bottom: 1px solid #eee;
                                    display: flex;
                                    justify-content: center;
                                    gap: 10px;
                                    align-items: center;
                                ">
                                    <button class="QQ_prev_page" \${currentPageIndex === 0 ? 'disabled' : ''} style="
                                        background: \${currentPageIndex === 0 ? '#f5f5f5' : '#e3f2fd'};
                                        border: none;
                                        color: \${currentPageIndex === 0 ? '#999' : '#1976d2'};
                                        padding: 8px 12px;
                                        border-radius: 6px;
                                        cursor: \${currentPageIndex === 0 ? 'not-allowed' : 'pointer'};
                                        font-size: 12px;
                                        font-weight: 500;
                                        transition: all 0.2s ease;
                                    ">â† ä¸Šä¸€é¡µ</button>
                                    
                                    <span style="font-size: 12px; color: #666; margin: 0 10px;">
                                        ç¬¬ \${currentPageIndex + 1} é¡µï¼Œå…± \${totalPages} é¡µ
                                    </span>
                                    
                                    <button class="QQ_next_page" \${currentPageIndex === totalPages - 1 ? 'disabled' : ''} style="
                                        background: \${currentPageIndex === totalPages - 1 ? '#f5f5f5' : '#e3f2fd'};
                                        border: none;
                                        color: \${currentPageIndex === totalPages - 1 ? '#999' : '#1976d2'};
                                        padding: 8px 12px;
                                        border-radius: 6px;
                                        cursor: \${currentPageIndex === totalPages - 1 ? 'not-allowed' : 'pointer'};
                                        font-size: 12px;
                                        font-weight: 500;
                                        transition: all 0.2s ease;
                                    ">ä¸‹ä¸€é¡µ â†’</button>
                                </div>
                            \` : ''}
                            
                            <div class="QQ_interactive_footer_enhanced" style="
                                padding: 20px;
                                background: #ffffff;
                                display: flex;
                                justify-content: center;
                                gap: 12px;
                            ">
                                <button class="QQ_reply_interactive_enhanced" style="
                                    background: \${isCharacterSpace ? '#FF6B6B' : '#4FC3F7'};
                                    border: none;
                                    color: white;
                                    padding: 12px 20px;
                                    border-radius: 20px;
                                    cursor: pointer;
                                    font-size: 13px;
                                    font-weight: 500;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 2px 8px \${isCharacterSpace ? 'rgba(255, 107, 107, 0.3)' : 'rgba(79, 195, 247, 0.3)'};
                                " onmouseover="this.style.transform='translateY(-1px)'" 
                                   onmouseout="this.style.transform='translateY(0)'">
                                    ğŸ’¬ å›åº”äº’åŠ¨
                                </button>
                                <button class="QQ_close_interactive_enhanced" style="
                                    background: #f5f5f5;
                                    border: none;
                                    color: #666;
                                    padding: 12px 20px;
                                    border-radius: 20px;
                                    cursor: pointer;
                                    font-size: 13px;
                                    font-weight: 500;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.background='#eeeeee'" 
                                   onmouseout="this.style.background='#f5f5f5'">
                                    å…³é—­
                                </button>
                            </div>
                                                 </div>
                     </div>
                 `;
                
                // æ·»åŠ åˆ°é¡µé¢
                $('body').append(interactiveSpaceHtml);
                
                // ç»‘å®šå…³é—­äº‹ä»¶
                $('.QQ_close_interactive_enhanced').on('click', function() {
                    $('.QQ_interactive_space_enhanced').fadeOut(300, function() {
                        $(this).remove();
                    });
                });
                
                // ç»‘å®šå›å¤äº‹ä»¶
                $('.QQ_reply_interactive_enhanced').on('click', function() {
                    QQ_OpenEnhancedInteractiveReply(spaceId, characterName || spaceData.characterName);
                });
                
                // ç»‘å®šåˆ†é¡µäº‹ä»¶
                $('.QQ_prev_page').on('click', function() {
                    if (currentPageIndex > 0) {
                        QQ_InteractiveCurrentPage[spaceId] = currentPageIndex - 1;
                        QQ_DisplayEnhancedInteractiveSpace(spaceId, spaceTitle, characterName);
                    }
                });
                
                $('.QQ_next_page').on('click', function() {
                    if (currentPageIndex < totalPages - 1) {
                        QQ_InteractiveCurrentPage[spaceId] = currentPageIndex + 1;
                        QQ_DisplayEnhancedInteractiveSpace(spaceId, spaceTitle, characterName);
                    }
                });
                
                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                $('.QQ_interactive_space_enhanced').on('click', function(e) {
                    if (e.target === this) {
                        $(this).fadeOut(300, function() {
                            $(this).remove();
                        });
                    }
                });
            }
            
            /**
             * æ‰“å¼€å¢å¼ºç‰ˆäº’åŠ¨å›å¤ç•Œé¢
             * @param {string} spaceId - ç©ºé—´ID
             * @param {string} characterName - è§’è‰²åç§°
             */
            function QQ_OpenEnhancedInteractiveReply(spaceId, characterName) {
                // ç§»é™¤ç°æœ‰çš„å›å¤ç•Œé¢
                $('.QQ_interactive_reply_enhanced').remove();
                
                const replyHtml = `
                    <div class="QQ_interactive_reply_enhanced" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.8);
                        z-index: 999999999;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        animation: fadeIn 0.3s ease;
                        backdrop-filter: blur(15px);
                    ">
                        <div class="QQ_reply_content_enhanced" style="
                            background: #ffffff;
                            border-radius: 16px;
                            padding: 0;
                            max-width: 90%;
                            overflow: hidden;
                            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                            color: #333;
                            animation: slideIn 0.3s ease;
                            width: 380px;
                        ">
                            <div class="reply-header" style="
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                color: white;
                                padding: 18px 20px;
                                text-align: center;
                                font-weight: 600;
                                font-size: 15px;
                            ">
                                ğŸ’¬ å›åº” ${characterName} çš„äº’åŠ¨
                            </div>
                            
                            <div class="reply-body" style="
                                padding: 25px 20px;
                            ">
                                <textarea class="QQ_reply_input_enhanced" placeholder="åœ¨è¿™é‡Œè¾“å…¥ä½ çš„å›åº”..." style="
                                    width: 100%;
                                    height: 120px;
                                    border: 2px solid #e9ecef;
                                    border-radius: 12px;
                                    padding: 15px;
                                    font-size: 14px;
                                    line-height: 1.5;
                                    resize: none;
                                    box-sizing: border-box;
                                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                                    outline: none;
                                    transition: all 0.3s ease;
                                " onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102, 126, 234, 0.1)'" 
                                   onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'"></textarea>
                            </div>
                            
                            <div class="reply-footer" style="
                                padding: 0 20px 20px 20px;
                                display: flex;
                                gap: 12px;
                            ">
                                <button class="QQ_send_reply_enhanced" style="
                                    flex: 1;
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    border: none;
                                    color: white;
                                    padding: 12px;
                                    border-radius: 10px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
                                " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 5px 15px rgba(102, 126, 234, 0.4)'" 
                                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 10px rgba(102, 126, 234, 0.3)'">
                                    ğŸš€ å‘é€å›åº”
                                </button>
                                <button class="QQ_cancel_reply_enhanced" style="
                                    background: #f8f9fa;
                                    border: none;
                                    color: #6c757d;
                                    padding: 12px 20px;
                                    border-radius: 10px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.background='#e9ecef'" 
                                   onmouseout="this.style.background='#f8f9fa'">
                                    å–æ¶ˆ
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // æ·»åŠ åˆ°é¡µé¢
                $('body').append(replyHtml);
                
                // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
                setTimeout(() => {
                    $('.QQ_reply_input_enhanced').focus();
                }, 100);
                
                // ç»‘å®šå‘é€äº‹ä»¶
                $('.QQ_send_reply_enhanced').on('click', function() {
                    const replyText = $('.QQ_reply_input_enhanced').val().trim();
                    if (replyText) {
                        QQ_SendInteractiveReply(spaceId, characterName, replyText);
                        $('.QQ_interactive_reply_enhanced').remove();
                    } else {
                        toastr.warning('è¯·è¾“å…¥å›åº”å†…å®¹');
                        $('.QQ_reply_input_enhanced').focus();
                    }
                });
                
                // ç»‘å®šå–æ¶ˆäº‹ä»¶
                $('.QQ_cancel_reply_enhanced').on('click', function() {
                    $('.QQ_interactive_reply_enhanced').remove();
                });
                
                // æ”¯æŒå›è½¦å‘é€
                $('.QQ_reply_input_enhanced').on('keydown', function(e) {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        $('.QQ_send_reply_enhanced').click();
                    }
                });
                
                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                $('.QQ_interactive_reply_enhanced').on('click', function(e) {
                    if (e.target === this) {
                        $(this).remove();
                    }
                });
            }
            
            /**
             * å‘é€äº’åŠ¨å›å¤å¹¶è·å–AIå“åº”
             * @param {string} spaceId - ç©ºé—´ID
             * @param {string} characterName - è§’è‰²åç§°
             * @param {string} replyText - å›å¤å†…å®¹
             */
            function QQ_SendInteractiveReply(spaceId, characterName, replyText) {
                console.log(`å‘é€äº’åŠ¨å›å¤: ${spaceId}, ${characterName}, ${replyText}`);
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                toastr.info('æ­£åœ¨å‘é€å›åº”...', 'äº’åŠ¨ç©ºé—´');
                
                // æ„å»ºåŒ…å«å›åº”å†…å®¹çš„è¯·æ±‚
                const interactiveRequest = `è¯·å›åº”è¿™ä¸ªäº’åŠ¨åœºæ™¯ï¼š
                
<content>
${replyText}
</content>

è¯·ä»¥MiPhoneæ ¼å¼å›å¤ï¼Œåœ¨contentæ ‡ç­¾ä¸­æè¿°ä½ å¯¹è¿™ä¸ªå›åº”çš„ååº”å’Œæ–°çš„äº’åŠ¨å†…å®¹ã€‚`;
                
                // å‘é€è¯·æ±‚åˆ°AI
                QQ_Gen(interactiveRequest, async function(aiResponse) {
                    try {
                        if (aiResponse && aiResponse.trim()) {
                            // *** é¢„å¤„ç†ï¼šå…ˆç§»é™¤thinkingæ ‡ç­¾å†…å®¹ï¼Œé¿å…è¯¯è¯»thinkingæ ‡ç­¾ä¸­çš„contentå¼•ç”¨ ***
                            const processedResponse = aiResponse.replace(/<thinking>[\s\S]*?<\/thinking>/gi, '');
                            
                            // è§£æAIå›å¤ï¼Œæå–contentå†…å®¹
                            const contentMatch = processedResponse.match(/<content>([\s\S]*?)<\/content>/i);
                            const newInteractiveContent = contentMatch ? contentMatch[1].trim() : processedResponse.trim();
                            
                            if (newInteractiveContent) {
                                // æ·»åŠ æ–°é¡µé¢åˆ°äº’åŠ¨ç©ºé—´
                                if (!QQ_InteractivePages[spaceId]) {
                                    QQ_InteractivePages[spaceId] = [];
                                }
                                QQ_InteractivePages[spaceId].push(newInteractiveContent);
                                
                                // è®¾ç½®å½“å‰é¡µé¢ä¸ºæœ€æ–°é¡µé¢
                                QQ_InteractiveCurrentPage[spaceId] = QQ_InteractivePages[spaceId].length - 1;
                                
                                // ä¿å­˜åˆ°ä¸–ç•Œä¹¦
                                await QQ_SaveInteractiveSpaceToWorldBook(spaceId, characterName);
                                
                                // é‡æ–°æ˜¾ç¤ºäº’åŠ¨ç©ºé—´ï¼ˆæ˜¾ç¤ºæ–°é¡µé¢ï¼‰
                                QQ_DisplayEnhancedInteractiveSpace(spaceId, `${characterName}çš„äº’åŠ¨ç©ºé—´`, characterName);
                                
                                toastr.success('AIå·²å›åº”ä½ çš„äº’åŠ¨ï¼', 'äº’åŠ¨ç©ºé—´');
                            } else {
                                toastr.error('AIå›å¤æ ¼å¼é”™è¯¯', 'äº’åŠ¨ç©ºé—´');
                            }
                        } else {
                            toastr.error('AIå›å¤ä¸ºç©º', 'äº’åŠ¨ç©ºé—´');
                        }
                    } catch (error) {
                        console.error('å¤„ç†AIäº’åŠ¨å›å¤æ—¶å‡ºé”™:', error);
                        toastr.error('å¤„ç†å›å¤æ—¶å‡ºé”™');
                    }
                });
            }
            
            /**
             * ä¿å­˜äº’åŠ¨ç©ºé—´åˆ°ä¸–ç•Œä¹¦ï¼ˆä¼˜åŒ–å­˜å‚¨ï¼Œæœ€å¤§30ä¸ªï¼‰
             * @param {string} spaceId - ç©ºé—´ID
             * @param {string} characterName - è§’è‰²åç§°
             */
            async function QQ_SaveInteractiveSpaceToWorldBook(spaceId, characterName) {
                try {
                    const storageKey = `QQ_äº’åŠ¨ç©ºé—´å¤‡ä»½_${characterName}`;
                    
                    // è·å–ç°æœ‰çš„äº’åŠ¨ç©ºé—´å¤‡ä»½
                    const existingData = getWorldInfoData(storageKey) || { spaces: {}, lastUpdate: new Date().toISOString() };
                    
                    // æ›´æ–°ç‰¹å®šç©ºé—´çš„æ•°æ®
                    existingData.spaces[spaceId] = {
                        id: spaceId,
                        pages: QQ_InteractivePages[spaceId] || [],
                        currentPage: QQ_InteractiveCurrentPage[spaceId] || 0,
                        characterName: characterName,
                        lastModified: new Date().toISOString()
                    };
                    
                    // æ£€æŸ¥å¹¶é™åˆ¶æœ€å¤§æ•°é‡ä¸º30ä¸ª
                    const spaceIds = Object.keys(existingData.spaces);
                    if (spaceIds.length > 30) {
                        // æŒ‰æœ€åä¿®æ”¹æ—¶é—´æ’åºï¼Œåˆ é™¤æœ€æ—§çš„
                        const sortedSpaces = spaceIds.map(id => ({
                            id,
                            lastModified: existingData.spaces[id].lastModified
                        })).sort((a, b) => new Date(a.lastModified) - new Date(b.lastModified));
                        
                        // åˆ é™¤æœ€æ—§çš„ç©ºé—´ï¼Œä¿ç•™æœ€æ–°çš„30ä¸ª
                        for (let i = 0; i < spaceIds.length - 30; i++) {
                            delete existingData.spaces[sortedSpaces[i].id];
                        }
                    }
                    
                    existingData.lastUpdate = new Date().toISOString();
                    
                    // ä¿å­˜åˆ°ä¸–ç•Œä¹¦
                    setWorldInfoData(storageKey, existingData);
                    
                    const saveSuccess = await QQ_SafeSaveWorldInfo(`äº’åŠ¨ç©ºé—´ ${spaceId}`);
                    if (saveSuccess) {
                        console.log(`äº’åŠ¨ç©ºé—´ ${spaceId} å·²ä¿å­˜åˆ°ä¸–ç•Œä¹¦ï¼Œè§’è‰²: ${characterName}`);
                    } else {
                        console.warn(`äº’åŠ¨ç©ºé—´ ${spaceId} ä¿å­˜åˆ°ä¸–ç•Œä¹¦å¤±è´¥ï¼Œè§’è‰²: ${characterName}`);
                    }
                } catch (error) {
                    console.error('ä¿å­˜äº’åŠ¨ç©ºé—´åˆ°ä¸–ç•Œä¹¦æ—¶å‡ºé”™:', error);
                }
            }
            
            /**
             * ä»ä¸–ç•Œä¹¦åŠ è½½äº’åŠ¨ç©ºé—´æ•°æ®
             * @param {string} characterName - è§’è‰²åç§°
             */
            function QQ_LoadInteractiveSpaceFromWorldBook(characterName) {
                try {
                    const storageKey = `QQ_äº’åŠ¨ç©ºé—´å¤‡ä»½_${characterName}`;
                    const savedData = getWorldInfoData(storageKey);
                    
                    if (savedData && savedData.spaces) {
                        Object.keys(savedData.spaces).forEach(spaceId => {
                            const spaceData = savedData.spaces[spaceId];
                            if (spaceData.pages && spaceData.pages.length > 0) {
                                QQ_InteractivePages[spaceId] = spaceData.pages;
                                QQ_InteractiveCurrentPage[spaceId] = spaceData.currentPage || 0;
                            }
                        });
                        
                        console.log(`å·²ä»ä¸–ç•Œä¹¦åŠ è½½è§’è‰² ${characterName} çš„äº’åŠ¨ç©ºé—´æ•°æ®`);
                        return true;
                    }
                } catch (error) {
                    console.error('ä»ä¸–ç•Œä¹¦åŠ è½½äº’åŠ¨ç©ºé—´æ•°æ®æ—¶å‡ºé”™:', error);
                }
                return false;
            }
            
            // ===== ç²¾çµæŒ‰é’®ç³»ç»Ÿ =====
            
            /**
             * æ˜¾ç¤ºç²¾çµæŒ‰é’®
             */
            function QQ_ShowSpiritButton() {
                // å¦‚æœå·²ç»æ˜¾ç¤ºï¼Œåˆ™ä¸é‡å¤åˆ›å»º
                if ($('.QQ_spirit_button').length > 0) return;
                
                QQ_SpiritVisible = true;
                
                // è·å–ä¸Šæ¬¡ä¿å­˜çš„ä½ç½®
                const savedPosition = localStorage.getItem('QQ_spirit_position');
                let position = { right: '20px', bottom: '100px' };
                if (savedPosition) {
                    try {
                        position = JSON.parse(savedPosition);
                    } catch (e) {
                        console.warn('è§£æç²¾çµä½ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®');
                    }
                }
                
                const spiritHtml = `
                    <div class="QQ_spirit_button" style="
                        position: fixed;
                        ${position.right ? `right: ${position.right}` : `left: ${position.left}`};
                        ${position.bottom ? `bottom: ${position.bottom}` : `top: ${position.top}`};
                        width: 60px;
                        height: 60px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border-radius: 50%;
                        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
                        cursor: move;
                        z-index: 9999;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-size: 24px;
                        user-select: none;
                        transition: all 0.3s ease;
                        animation: spiritPulse 2s infinite;
                    " title="äº’åŠ¨ç©ºé—´ç²¾çµ">
                        ğŸ§šâ€âœ¨
                    </div>
                                <style>
                @keyframes spiritPulse {
                    0%, 100% { transform: scale(1); box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4); }
                    50% { transform: scale(1.05); box-shadow: 0 6px 25px rgba(102, 126, 234, 0.6); }
                }
                .QQ_spirit_button:hover {
                    transform: scale(1.1) !important;
                    box-shadow: 0 6px 25px rgba(102, 126, 234, 0.7) !important;
                }
                
                /* ç”¨æˆ·èœå•åŠ¨ç”» */
                @keyframes menuSlideDown {
                    from { 
                        opacity: 0; 
                        transform: translateY(-10px); 
                    }
                    to { 
                        opacity: 1; 
                        transform: translateY(0); 
                    }
                }
                
                #QQ_user_menu {
                    border: 1px solid #e1e5e9;
                }
                
                .user_menu_item:last-child {
                    border-bottom: none !important;
                }
            </style>
                `;
                
                $('body').append(spiritHtml);
                
                // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼ˆæ”¯æŒè§¦æ‘¸è®¾å¤‡ï¼‰
                $('.QQ_spirit_button').on('click touchend', function(e) {
                    // *** æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦æ­£åœ¨æ‹–æ‹½ï¼Œå¦‚æœæ˜¯åˆ™ä¸å“åº”ç‚¹å‡» ***
                    if ($(this).hasClass('dragging')) {
                        return;
                    }
                    
                    e.stopPropagation();
                    e.preventDefault();
                    console.log('ç²¾çµæŒ‰é’®ç‚¹å‡»äº‹ä»¶è§¦å‘');
                    QQ_ShowSpiritPanel();
                });
                
                // ç»‘å®šæ‹–æ‹½åŠŸèƒ½
                QQ_MakeSpiritDraggable();
                
                console.log('ç²¾çµæŒ‰é’®å·²æ˜¾ç¤º');
            }
            
            /**
             * éšè—ç²¾çµæŒ‰é’®
             */
            function QQ_HideSpiritButton() {
                $('.QQ_spirit_button').fadeOut(300, function() {
                    $(this).remove();
                });
                QQ_SpiritVisible = false;
                console.log('ç²¾çµæŒ‰é’®å·²éšè—');
            }
            
            /**
             * ä½¿ç²¾çµæŒ‰é’®å¯æ‹–æ‹½
             */
            function QQ_MakeSpiritDraggable() {
                let isDragging = false;
                let dragStarted = false;
                let startX, startY, initialX, initialY;
                let dragTimer;
                
                $('.QQ_spirit_button').on('mousedown touchstart', function(e) {
                    e.preventDefault();
                    dragStarted = false;
                    
                    // è·å–åˆå§‹ä½ç½®
                    const rect = this.getBoundingClientRect();
                    initialX = rect.left;
                    initialY = rect.top;
                    
                    // è·å–é¼ æ ‡/è§¦æ‘¸ä½ç½®
                    const clientX = e.type === 'touchstart' ? e.originalEvent.touches[0].clientX : e.clientX;
                    const clientY = e.type === 'touchstart' ? e.originalEvent.touches[0].clientY : e.clientY;
                    
                    startX = clientX - initialX;
                    startY = clientY - initialY;
                    
                    // *** æ–°å¢ï¼šå»¶è¿Ÿå¼€å§‹æ‹–æ‹½ï¼Œå…è®¸ç‚¹å‡»äº‹ä»¶ ***
                    dragTimer = setTimeout(() => {
                        isDragging = true;
                        dragStarted = true;
                        
                        // æ”¹å˜æ ·å¼
                        $('.QQ_spirit_button').addClass('dragging').css({
                            'cursor': 'grabbing',
                            'z-index': '10001',
                            'animation': 'none'
                        });
                        
                        console.log('å¼€å§‹æ‹–æ‹½ç²¾çµæŒ‰é’®');
                    }, 150); // 150mså»¶è¿Ÿï¼Œç»™ç‚¹å‡»äº‹ä»¶ç•™æ—¶é—´
                });
                
                $(document).on('mousemove touchmove', function(e) {
                    if (!isDragging) return;
                    
                    const clientX = e.type === 'touchmove' ? e.originalEvent.touches[0].clientX : e.clientX;
                    const clientY = e.type === 'touchmove' ? e.originalEvent.touches[0].clientY : e.clientY;
                    
                    const x = clientX - startX;
                    const y = clientY - startY;
                    
                    // è¾¹ç•Œæ£€æŸ¥
                    const maxX = window.innerWidth - 60;
                    const maxY = window.innerHeight - 60;
                    
                    const constrainedX = Math.max(0, Math.min(x, maxX));
                    const constrainedY = Math.max(0, Math.min(y, maxY));
                    
                    $('.QQ_spirit_button').css({
                        'left': constrainedX + 'px',
                        'top': constrainedY + 'px',
                        'right': 'auto',
                        'bottom': 'auto'
                    });
                    
                    e.preventDefault();
                });
                
                $(document).on('mouseup touchend', function(e) {
                    // æ¸…é™¤æ‹–æ‹½å®šæ—¶å™¨
                    if (dragTimer) {
                        clearTimeout(dragTimer);
                        dragTimer = null;
                    }
                    
                    if (!isDragging && !dragStarted) {
                        // è¿™æ˜¯ä¸€ä¸ªç‚¹å‡»äº‹ä»¶ï¼Œä¸æ˜¯æ‹–æ‹½
                        console.log('ç²¾çµæŒ‰é’®è¢«ç‚¹å‡»ï¼ˆéæ‹–æ‹½ï¼‰');
                        return;
                    }
                    
                    if (!isDragging) return;
                    isDragging = false;
                    dragStarted = false;
                    
                    // æ¢å¤æ ·å¼
                    $('.QQ_spirit_button').removeClass('dragging').css({
                        'cursor': 'move',
                        'z-index': '9999',
                        'animation': 'spiritPulse 2s infinite'
                    });
                    
                    // ä¿å­˜ä½ç½®
                    const spirit = $('.QQ_spirit_button');
                    if (spirit.length > 0) {
                        const position = {
                            left: spirit.css('left'),
                            top: spirit.css('top')
                        };
                        localStorage.setItem('QQ_spirit_position', JSON.stringify(position));
                        console.log('ç²¾çµæŒ‰é’®ä½ç½®å·²ä¿å­˜');
                    }
                });
            }
            
            /**
             * æ˜¾ç¤ºç²¾çµæ§åˆ¶é¢æ¿
             */
            function QQ_ShowSpiritPanel() {
                // ç§»é™¤ç°æœ‰é¢æ¿
                $('.QQ_spirit_panel').remove();
                
                const spaces = Object.values(QQ_InteractiveSpaces);
                const hasSpaces = spaces.length > 0;
                
                let spaceListHtml = '';
                if (hasSpaces) {
                    spaceListHtml = spaces.map(space => `
                        <div class="spirit_space_item" data-space-id="${space.id}" style="
                            padding: 12px 15px;
                            border-bottom: 1px solid #eee;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                            transition: background-color 0.2s ease;
                        " onmouseover="this.style.backgroundColor='#f5f5f5'" 
                           onmouseout="this.style.backgroundColor='transparent'">
                            <img src="${space.characterAvatar}" alt="${space.characterName}" style="
                                width: 32px;
                                height: 32px;
                                border-radius: 50%;
                                object-fit: cover;
                            ">
                            <div style="flex: 1;">
                                <div style="font-size: 14px; font-weight: 500; color: #333;">${space.name}</div>
                                <div style="font-size: 12px; color: #666; margin-top: 2px;">
                                    ${new Date(space.lastAccess).toLocaleDateString()} ${new Date(space.lastAccess).toLocaleTimeString().slice(0, 5)}
                                </div>
                            </div>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="#999">
                                <path d="M8.59 16.34l4.58-4.59-4.58-4.59L10 5.75l6 6-6 6z"/>
                            </svg>
                        </div>
                    `).join('');
                } else {
                    spaceListHtml = `
                        <div style="
                            padding: 30px 20px;
                            text-align: center;
                            color: #999;
                            font-size: 14px;
                        ">
                            <div style="font-size: 48px; margin-bottom: 10px;">ğŸŒŸ</div>
                            æš‚æ— äº’åŠ¨ç©ºé—´<br>
                            <small>ä¸AIçš„äº’åŠ¨å†…å®¹ä¼šè‡ªåŠ¨ä¿å­˜åˆ°è¿™é‡Œ</small>
                        </div>
                    `;
                }
                
                const panelHtml = `
                    <div class="QQ_spirit_panel" style="
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        width: 320px;
                        max-height: 500px;
                        background: white;
                        border-radius: 15px;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                        z-index: 10000;
                        animation: spiritPanelShow 0.3s ease;
                        overflow: hidden;
                    ">
                        <div class="spirit_panel_header" style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 20px;
                            text-align: center;
                            position: relative;
                        ">
                            <h3 style="margin: 0; font-size: 18px; font-weight: 600;">ğŸ§šâ€âœ¨ äº’åŠ¨ç©ºé—´</h3>
                            <p style="margin: 5px 0 0 0; font-size: 13px; opacity: 0.9;">ç®¡ç†ä½ çš„æ‰€æœ‰ç°å®äº’åŠ¨</p>
                            <button class="spirit_panel_close" style="
                                position: absolute;
                                top: 15px;
                                right: 15px;
                                background: rgba(255, 255, 255, 0.2);
                                border: none;
                                color: white;
                                width: 28px;
                                height: 28px;
                                border-radius: 50%;
                                cursor: pointer;
                                font-size: 16px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">Ã—</button>
                        </div>
                        <div class="spirit_panel_body" style="
                            max-height: 350px;
                            overflow-y: auto;
                        ">
                            ${spaceListHtml}
                        </div>
                        <div class="spirit_panel_footer" style="
                            padding: 15px 20px;
                            background: #f8f9fa;
                            border-top: 1px solid #eee;
                            display: flex;
                            gap: 10px;
                        ">
                            <button class="spirit_hide_btn" style="
                                flex: 1;
                                background: #6c757d;
                                border: none;
                                color: white;
                                padding: 10px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 13px;
                                transition: background-color 0.2s ease;
                            " onmouseover="this.style.backgroundColor='#5a6268'" 
                               onmouseout="this.style.backgroundColor='#6c757d'">
                                éšè—ç²¾çµ
                            </button>
                            <button class="spirit_stats_btn" style="
                                flex: 1;
                                background: #28a745;
                                border: none;
                                color: white;
                                padding: 10px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 13px;
                                transition: background-color 0.2s ease;
                            " onmouseover="this.style.backgroundColor='#218838'" 
                               onmouseout="this.style.backgroundColor='#28a745'">
                                æŸ¥çœ‹ç»Ÿè®¡
                            </button>
                        </div>
                    </div>
                    <div class="QQ_spirit_panel_overlay" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.5);
                        z-index: 9999;
                        animation: fadeIn 0.3s ease;
                    "></div>
                    <style>
                        @keyframes spiritPanelShow {
                            from { transform: translate(-50%, -50%) scale(0.9); opacity: 0; }
                            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                        }
                    </style>
                `;
                
                $('body').append(panelHtml);
                
                // ç»‘å®šäº‹ä»¶
                $('.spirit_panel_close, .QQ_spirit_panel_overlay').on('click', function() {
                    QQ_CloseSpiritPanel();
                });
                
                $('.spirit_hide_btn').on('click', function() {
                    QQ_CloseSpiritPanel();
                    QQ_HideSpiritButton();
                });
                
                $('.spirit_stats_btn').on('click', function() {
                    QQ_ShowInteractiveStats();
                });
                
                $('.spirit_space_item').on('click', function() {
                    const spaceId = $(this).data('space-id');
                    QQ_OpenInteractiveSpace(spaceId);
                });
                
                // é˜»æ­¢ç‚¹å‡»é¢æ¿æœ¬èº«æ—¶å…³é—­
                $('.QQ_spirit_panel').on('click', function(e) {
                    e.stopPropagation();
                });
            }
            
            /**
             * å…³é—­ç²¾çµæ§åˆ¶é¢æ¿
             */
            function QQ_CloseSpiritPanel() {
                $('.QQ_spirit_panel, .QQ_spirit_panel_overlay').fadeOut(300, function() {
                    $(this).remove();
                });
            }
            
            /**
             * æ‰“å¼€æŒ‡å®šçš„äº’åŠ¨ç©ºé—´
             * @param {string} spaceId - ç©ºé—´ID
             */
            function QQ_OpenInteractiveSpace(spaceId) {
                const space = QQ_InteractiveSpaces[spaceId];
                if (!space) {
                    triggerSlash('/echo severity=error äº’åŠ¨ç©ºé—´ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤');
                    return;
                }
                
                // æ›´æ–°æœ€åè®¿é—®æ—¶é—´
                space.lastAccess = new Date().toISOString();
                QQ_SaveInteractiveSpaces();
                
                // å…³é—­ç²¾çµé¢æ¿
                QQ_CloseSpiritPanel();
                
                // é‡æ–°æ˜¾ç¤ºäº’åŠ¨ç©ºé—´
                QQ_ShowStoredInteractiveSpace(space);
            }
            
            /**
             * æ˜¾ç¤ºå·²ä¿å­˜çš„äº’åŠ¨ç©ºé—´
             * @param {Object} space - ç©ºé—´æ•°æ®
             */
            function QQ_ShowStoredInteractiveSpace(space) {
                // è®¾ç½®å½“å‰æ´»åŠ¨ç©ºé—´
                QQ_ActiveSpaceId = space.id;
                
                // ç§»é™¤ç°æœ‰çš„äº’åŠ¨ç©ºé—´
                $('.QQ_interactive_space').remove();
                
                // åˆ›å»ºäº’åŠ¨ç©ºé—´HTML
                const interactiveSpaceHtml = `
                    <div class="QQ_interactive_space" data-space-id="${space.id}" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.7);
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        animation: fadeIn 0.3s ease;
                        backdrop-filter: blur(10px);
                    ">
                        <div class="QQ_interactive_content" style="
                            background: #ffffff;
                            border-radius: 15px;
                            padding: 0;
                            max-width: 85%;
                            max-height: 75%;
                            overflow: hidden;
                            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                            position: relative;
                            color: #333;
                            animation: slideIn 0.3s ease;
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        ">
                            <div class="QQ_interactive_header" style="
                                background: linear-gradient(135deg, #4FC3F7 0%, #29B6F6 100%);
                                padding: 20px;
                                display: flex;
                                align-items: center;
                                color: white;
                                position: relative;
                            ">
                                <img src="${space.characterAvatar}" alt="${space.characterName}" style="
                                    width: 45px;
                                    height: 45px;
                                    border-radius: 50%;
                                    margin-right: 15px;
                                    border: 3px solid white;
                                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                                ">
                                <div style="flex: 1;">
                                    <h3 style="margin: 0; font-size: 17px; font-weight: 600;">${space.name}</h3>
                                    <p style="margin: 3px 0 0 0; font-size: 13px; opacity: 0.9;">ç°å®äº’åŠ¨æ¨¡å¼</p>
                                </div>
                                <button class="QQ_rename_space" style="
                                    background: rgba(255, 255, 255, 0.2);
                                    border: none;
                                    color: white;
                                    width: 32px;
                                    height: 32px;
                                    border-radius: 50%;
                                    cursor: pointer;
                                    font-size: 14px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    transition: all 0.3s ease;
                                    margin-right: 8px;
                                " onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" 
                                   onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'"
                                   title="é‡å‘½åç©ºé—´">
                                    âœï¸
                                </button>
                                <button class="QQ_delete_space" style="
                                    background: rgba(255, 255, 255, 0.2);
                                    border: none;
                                    color: white;
                                    width: 32px;
                                    height: 32px;
                                    border-radius: 50%;
                                    cursor: pointer;
                                    font-size: 16px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    transition: all 0.3s ease;
                                    margin-right: 8px;
                                " onmouseover="this.style.background='rgba(255, 87, 87, 0.3)'" 
                                   onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'"
                                   title="åˆ é™¤ç©ºé—´">
                                    ğŸ—‘ï¸
                                </button>
                                <button class="QQ_close_interactive" style="
                                    background: rgba(255, 255, 255, 0.2);
                                    border: none;
                                    color: white;
                                    width: 32px;
                                    height: 32px;
                                    border-radius: 50%;
                                    cursor: pointer;
                                    font-size: 18px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" 
                                   onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">
                                    Ã—
                                </button>
                            </div>
                            <div class="QQ_interactive_body" style="
                                padding: 25px 20px;
                                font-size: 15px;
                                line-height: 1.5;
                                white-space: pre-wrap;
                                color: #333;
                                background: #fafafa;
                                max-height: 300px;
                                overflow-y: auto;
                            ">${space.content}</div>
                            <div class="QQ_interactive_footer" style="
                                padding: 20px;
                                background: #ffffff;
                                border-top: 1px solid #eee;
                                display: flex;
                                justify-content: center;
                                gap: 15px;
                            ">
                                <button class="QQ_reply_interactive" style="
                                    background: #4FC3F7;
                                    border: none;
                                    color: white;
                                    padding: 12px 24px;
                                    border-radius: 25px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 2px 8px rgba(79, 195, 247, 0.3);
                                " onmouseover="this.style.background='#29B6F6'; this.style.transform='translateY(-1px)'" 
                                   onmouseout="this.style.background='#4FC3F7'; this.style.transform='translateY(0)'">
                                    ğŸ’¬ å›åº”äº’åŠ¨
                                </button>
                                <button class="QQ_close_interactive" style="
                                    background: #f5f5f5;
                                    border: none;
                                    color: #666;
                                    padding: 12px 24px;
                                    border-radius: 25px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.background='#eeeeee'" 
                                   onmouseout="this.style.background='#f5f5f5'">
                                    å…³é—­
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // æ·»åŠ åˆ°é¡µé¢
                $('body').append(interactiveSpaceHtml);
                
                // ç»‘å®šäº‹ä»¶
                $('.QQ_rename_space').off('click').on('click', function() {
                    QQ_RenameInteractiveSpace(space.id);
                });
                
                $('.QQ_delete_space').off('click').on('click', function() {
                    QQ_DeleteInteractiveSpace(space.id);
                });
                
                $('.QQ_close_interactive').off('click').on('click', function() {
                    QQ_CloseInteractiveSpace();
                });
                
                $('.QQ_reply_interactive').off('click').on('click', function() {
                    QQ_CloseInteractiveSpace();
                    QQ_OpenInteractiveReply(space.characterName);
                });
                
                $('.QQ_interactive_space').on('click', function(e) {
                    if (e.target === this) {
                        QQ_CloseInteractiveSpace();
                    }
                });
                
                triggerSlash(`/echo å·²æ‰“å¼€äº’åŠ¨ç©ºé—´ï¼š${space.name}`);
            }
            
            /**
             * åˆ é™¤äº’åŠ¨ç©ºé—´
             * @param {string} spaceId - ç©ºé—´ID
             */
            function QQ_DeleteInteractiveSpace(spaceId) {
                const space = QQ_InteractiveSpaces[spaceId];
                if (!space) return;
                
                if (confirm(`ç¡®å®šè¦åˆ é™¤äº’åŠ¨ç©ºé—´"${space.name}"å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`)) {
                    delete QQ_InteractiveSpaces[spaceId];
                    QQ_SaveInteractiveSpaces();
                    QQ_CloseInteractiveSpace();
                    triggerSlash(`/echo äº’åŠ¨ç©ºé—´"${space.name}"å·²åˆ é™¤`);
                }
            }
            
            /**
             * æ˜¾ç¤ºäº’åŠ¨ç©ºé—´ç»Ÿè®¡ä¿¡æ¯
             */
            function QQ_ShowInteractiveStats() {
                const spaces = Object.values(QQ_InteractiveSpaces);
                const totalSpaces = spaces.length;
                const characters = [...new Set(spaces.map(s => s.characterName))];
                const totalCharacters = characters.length;
                
                // æŒ‰è§’è‰²ç»Ÿè®¡
                const characterStats = {};
                spaces.forEach(space => {
                    const char = space.characterName;
                    if (!characterStats[char]) {
                        characterStats[char] = { count: 0, lastInteraction: space.lastAccess };
                    }
                    characterStats[char].count++;
                    if (new Date(space.lastAccess) > new Date(characterStats[char].lastInteraction)) {
                        characterStats[char].lastInteraction = space.lastAccess;
                    }
                });
                
                // æœ€è¿‘çš„äº’åŠ¨
                const recentSpaces = spaces
                    .sort((a, b) => new Date(b.lastAccess) - new Date(a.lastAccess))
                    .slice(0, 5);
                
                let statsHtml = `
                    ğŸ“Š äº’åŠ¨ç©ºé—´ç»Ÿè®¡ä¿¡æ¯
                    
                    æ€»äº’åŠ¨ç©ºé—´: ${totalSpaces}ä¸ª
                    æ¶‰åŠè§’è‰²: ${totalCharacters}ä¸ª
                    
                    ğŸ“ˆ è§’è‰²äº’åŠ¨ç»Ÿè®¡:
                    ${Object.entries(characterStats)
                        .sort((a, b) => b[1].count - a[1].count)
                        .map(([char, stats]) => `â€¢ ${char}: ${stats.count}æ¬¡`)
                        .join('\n')
                    }
                    
                    ğŸ•’ æœ€è¿‘äº’åŠ¨:
                    ${recentSpaces.map(space => 
                        `â€¢ ${space.name} (${new Date(space.lastAccess).toLocaleDateString()})`
                    ).join('\n')}
                    
                    ğŸ’¾ æ•°æ®ä¿å­˜ä½ç½®: ä¸–ç•Œä¹¦
                    ğŸ”„ æœ€ååŒæ­¥: ${new Date().toLocaleString()}
                `;
                
                triggerSlash(`/echo ${statsHtml}`);
                QQ_CloseSpiritPanel();
            }
            
            // ===== ç”¨æˆ·èœå•ç³»ç»Ÿ =====
            
            /**
             * åˆ‡æ¢ç”¨æˆ·èœå•æ˜¾ç¤º/éšè—
             */
            function QQ_ToggleUserMenu() {
                const menu = $('#QQ_user_menu');
                if (menu.is(':visible')) {
                    QQ_HideUserMenu();
                } else {
                    QQ_ShowUserMenu();
                }
            }
            
            /**
             * æ˜¾ç¤ºç”¨æˆ·èœå•
             */
            function QQ_ShowUserMenu() {
                // éšè—å…¶ä»–èœå•
                $('.dropdown-menu, .context-menu').hide();
                
                $('#QQ_user_menu').fadeIn(200);
                
                // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
                $(document).one('click', function(e) {
                    if (!$(e.target).closest('#QQ_user_menu, #QQ_home_UserName').length) {
                        QQ_HideUserMenu();
                    }
                });
            }
            
            /**
             * éšè—ç”¨æˆ·èœå•
             */
            function QQ_HideUserMenu() {
                $('#QQ_user_menu').fadeOut(150);
            }
            
            // ===== å…¨å±€è°ƒè¯•å·¥å…· =====
            
            /**
             * æ˜¾ç¤ºäº’åŠ¨ç©ºé—´è¯¦ç»†ç»Ÿè®¡ï¼ˆè°ƒè¯•ç”¨ï¼‰
             */
            window.QQ_Show_Interactive_Stats = function() {
                const spaces = Object.values(QQ_InteractiveSpaces);
                console.log('=== äº’åŠ¨ç©ºé—´è¯¦ç»†ç»Ÿè®¡ ===');
                console.log('æ€»ç©ºé—´æ•°é‡:', spaces.length);
                console.log('ç²¾çµæŒ‰é’®å¯è§:', QQ_SpiritVisible);
                console.log('å½“å‰æ´»åŠ¨ç©ºé—´:', QQ_ActiveSpaceId);
                console.log('æ‰€æœ‰ç©ºé—´æ•°æ®:', QQ_InteractiveSpaces);
                
                if (worldbook) {
                    // ä½¿ç”¨å¼‚æ­¥æ–¹å¼è·å–æ¡ç›®
                    getLorebookEntries(worldbook).then(entries => {
                        if (entries) {
                            const entry = entries.find(e => e.comment === QQ_INTERACTIVE_BACKUP_KEY);
                            console.log('ä¸–ç•Œä¹¦å¤‡ä»½æ¡ç›®:', entry ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
                            if (entry) {
                                console.log('å¤‡ä»½å†…å®¹é•¿åº¦:', entry.content.length);
                                try {
                                    const data = JSON.parse(entry.content);
                                    console.log('å¤‡ä»½ç‰ˆæœ¬:', data.version);
                                    console.log('æœ€åæ›´æ–°:', data.lastUpdated);
                                    console.log('å¤‡ä»½ç©ºé—´æ•°é‡:', Object.keys(data.spaces || {}).length);
                                } catch (e) {
                                    console.error('è§£æå¤‡ä»½æ•°æ®å¤±è´¥:', e);
                                }
                            }
                        } else {
                            console.warn('æ— æ³•è·å–ä¸–ç•Œä¹¦æ¡ç›®');
                        }
                    }).catch(error => {
                        console.error('è·å–ä¸–ç•Œä¹¦æ¡ç›®å¤±è´¥:', error);
                    });
                } else {
                    console.warn('ä¸–ç•Œä¹¦æœªåˆå§‹åŒ–');
                }
                
                // æ£€æŸ¥ç²¾çµæŒ‰é’®çŠ¶æ€
                const spiritButton = $('.QQ_spirit_button');
                console.log('ç²¾çµæŒ‰é’®DOMå­˜åœ¨:', spiritButton.length > 0);
                if (spiritButton.length > 0) {
                    console.log('ç²¾çµæŒ‰é’®ä½ç½®:', {
                        left: spiritButton.css('left'),
                        top: spiritButton.css('top'),
                        right: spiritButton.css('right'),
                        bottom: spiritButton.css('bottom')
                    });
                }
                
                const savedPosition = localStorage.getItem('QQ_spirit_position');
                console.log('ä¿å­˜çš„ç²¾çµä½ç½®:', savedPosition);
                
                triggerSlash('/echo ğŸ“Š äº’åŠ¨ç©ºé—´è°ƒè¯•ä¿¡æ¯å·²è¾“å‡ºåˆ°æ§åˆ¶å°');
            };
            
            // ===== é¡µé¢åˆå§‹åŒ–å¤„ç† =====
            
            /**
             * åˆå§‹åŒ–äº’åŠ¨ç©ºé—´ç³»ç»Ÿ
             */
            async function QQ_InitInteractiveSystem() {
                try {
                    // åŠ è½½äº’åŠ¨ç©ºé—´æ•°æ®
                    await QQ_LoadInteractiveSpaces();
                    await QQ_LoadCharacterSpaces();
                    
                    // æ·»åŠ CSSæ ·å¼
                    if (!$('#QQ_interactive_styles').length) {
                        $('head').append(`
                            <style id="QQ_interactive_styles">
                                @keyframes menuSlideDown {
                                    from { 
                                        opacity: 0; 
                                        transform: translateY(-10px); 
                                    }
                                    to { 
                                        opacity: 1; 
                                        transform: translateY(0); 
                                    }
                                }
                                
                                .user_menu_item:last-child {
                                    border-bottom: none !important;
                                }
                                
                                /* ç²¾çµæŒ‰é’®åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šçš„ä¼˜åŒ– */
                                @media (max-width: 768px) {
                                    .QQ_spirit_button {
                                        width: 50px !important;
                                        height: 50px !important;
                                        font-size: 20px !important;
                                    }
                                }
                                
                                /* äº’åŠ¨ç©ºé—´åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šçš„ä¼˜åŒ– */
                                @media (max-width: 768px) {
                                    .QQ_interactive_content {
                                        max-width: 95% !important;
                                        max-height: 85% !important;
                                    }
                                    
                                    .QQ_spirit_panel {
                                        width: 300px !important;
                                        max-height: 400px !important;
                                    }
                                }
                            </style>
                        `);
                    }
                    
                    console.log('âœ… äº’åŠ¨ç©ºé—´ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
                } catch (error) {
                    console.error('âŒ äº’åŠ¨ç©ºé—´ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error);
                }
            }

            /**
             * æ‰“å¼€äº’åŠ¨å›åº”ç•Œé¢
             * @param {string} characterName - è§’è‰²åç§°
             */
            function QQ_OpenInteractiveReply(characterName) {
                // åˆ›å»ºæ›´ä¼˜é›…çš„è¾“å…¥ç•Œé¢
                const inputHtml = `
                    <div class="QQ_reply_input_overlay" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.5);
                        z-index: 10001;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        animation: fadeIn 0.3s ease;
                    ">
                        <div style="
                            background: white;
                            border-radius: 15px;
                            padding: 25px;
                            max-width: 80%;
                            width: 400px;
                            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                            animation: slideIn 0.3s ease;
                        ">
                            <h3 style="margin: 0 0 15px 0; color: #333; text-align: center;">å›åº” ${characterName} çš„äº’åŠ¨</h3>
                            <textarea id="reply_input" placeholder="è¾“å…¥ä½ çš„å›åº”..." style="
                                width: 100%;
                                height: 100px;
                                border: 2px solid #e0e0e0;
                                border-radius: 10px;
                                padding: 12px;
                                font-size: 14px;
                                resize: vertical;
                                box-sizing: border-box;
                                font-family: inherit;
                            "></textarea>
                            <div style="display: flex; justify-content: center; gap: 15px; margin-top: 20px;">
                                <button id="send_reply" style="
                                    background: #4FC3F7;
                                    border: none;
                                    color: white;
                                    padding: 10px 20px;
                                    border-radius: 20px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                ">å‘é€å›åº”</button>
                                <button id="cancel_reply" style="
                                    background: #f5f5f5;
                                    border: none;
                                    color: #666;
                                    padding: 10px 20px;
                                    border-radius: 20px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                ">å–æ¶ˆ</button>
                            </div>
                        </div>
                    </div>
                `;
                
                $('body').append(inputHtml);
                
                // èšç„¦è¾“å…¥æ¡†
                setTimeout(() => $('#reply_input').focus(), 100);
                
                // ç»‘å®šäº‹ä»¶
                $('#send_reply').on('click', function() {
                    const replyText = $('#reply_input').val().trim();
                    if (replyText) {
                        const interactiveReply = `å›åº”äº’åŠ¨: ${replyText}`;
                        QQ_SendMessage(interactiveReply, characterName);
                        $('.QQ_reply_input_overlay').fadeOut(300, function() {
                            $(this).remove();
                        });
                    } else {
                        $('#reply_input').focus();
                    }
                });
                
                $('#cancel_reply').on('click', function() {
                    $('.QQ_reply_input_overlay').fadeOut(300, function() {
                        $(this).remove();
                    });
                });
                
                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                $('.QQ_reply_input_overlay').on('click', function(e) {
                    if (e.target === this) {
                        $(this).fadeOut(300, function() {
                            $(this).remove();
                        });
                    }
                });
                
                // å›è½¦å‘é€
                $('#reply_input').on('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        $('#send_reply').click();
                    }
                });
            }

            /**
             * å‘é€æ¶ˆæ¯åˆ°æŒ‡å®šè§’è‰²
             * @param {string} message - æ¶ˆæ¯å†…å®¹
             * @param {string} targetName - ç›®æ ‡è§’è‰²åç§°
             */
            function QQ_SendMessage(message, targetName = "") {
                // è®¾ç½®å…¨å±€å‘é€å˜é‡
                SendValue = message;
                SendName = targetName;
                
                // è°ƒç”¨ç°æœ‰çš„å‘é€æœºåˆ¶
                console.log(`å‘é€äº’åŠ¨å›åº”æ¶ˆæ¯: ${message} -> ${targetName}`);
                
                // å¦‚æœåœ¨èŠå¤©é¡µé¢ï¼Œç›´æ¥å‘é€
                if (typeof QQ_Send === 'function') {
                    QQ_Send();
                } else {
                    // å¦åˆ™é€šè¿‡triggerSlashå‘é€
                    if (targetName) {
                        triggerSlash(`/sendas name={{char}} æ”¶åˆ°æ¥è‡ª${UserName}çš„äº’åŠ¨å›åº”: ${message}`);
                    } else {
                        triggerSlash(`/sendas name={{char}} æ”¶åˆ°äº’åŠ¨å›åº”: ${message}`);
                    }
                }
                
                // æ¸…ç†å‘é€å˜é‡
                SendValue = "";
                SendName = "";
            }

            
            // ===== ç”¨æˆ·èœå•æ§åˆ¶å‡½æ•° =====
            
            /**
             * åˆ‡æ¢ç”¨æˆ·èœå•æ˜¾ç¤ºçŠ¶æ€
             */
            function QQ_ToggleUserMenu() {
                const menu = $('#QQ_user_menu');
                if (menu.is(':visible')) {
                    QQ_HideUserMenu();
                } else {
                    QQ_ShowUserMenu();
                }
            }
            
            /**
             * æ˜¾ç¤ºç”¨æˆ·èœå•
             */
            function QQ_ShowUserMenu() {
                const menu = $('#QQ_user_menu');
                if (menu.length === 0) return;
                
                // éšè—å…¶ä»–èœå•
                $('.dropdown-menu, .context-menu, .QQ_spirit_panel').hide();
                
                // æ˜¾ç¤ºèœå•
                menu.show();
                
                // ç»‘å®šç‚¹å‡»å¤–éƒ¨å…³é—­äº‹ä»¶
                setTimeout(() => {
                    $(document).on('click.user-menu', function(e) {
                        if (!menu.is(e.target) && menu.has(e.target).length === 0 && !$('#QQ_home_UserName').is(e.target)) {
                            QQ_HideUserMenu();
                        }
                    });
                }, 100);
            }
            
            /**
             * éšè—ç”¨æˆ·èœå•
             */
            function QQ_HideUserMenu() {
                $('#QQ_user_menu').hide();
                $(document).off('click.user-menu');
            }
            
            // ===== äº’åŠ¨ç©ºé—´è°ƒè¯•å·¥å…· =====
            
            /**
             * æ˜¾ç¤ºäº’åŠ¨ç©ºé—´è°ƒè¯•ç»Ÿè®¡ä¿¡æ¯ï¼ˆå…¨å±€å‡½æ•°ï¼‰
             */
            window.QQ_Show_Interactive_Stats = function() {
                const spaces = Object.values(QQ_InteractiveSpaces);
                const spiritVisible = QQ_SpiritVisible;
                const activeSpace = QQ_ActiveSpaceId;
                
                let report = `
ğŸ§šâ€âœ¨ äº’åŠ¨ç©ºé—´ç³»ç»ŸçŠ¶æ€æŠ¥å‘Š
========================

ğŸ“Š åŸºç¡€ç»Ÿè®¡:
â€¢ æ€»ç©ºé—´æ•°: ${spaces.length}
â€¢ ç²¾çµçŠ¶æ€: ${spiritVisible ? 'æ˜¾ç¤º' : 'éšè—'}
â€¢ æ´»åŠ¨ç©ºé—´: ${activeSpace || 'æ— '}

ğŸ“ ç©ºé—´è¯¦æƒ…:`;
                
                if (spaces.length > 0) {
                    spaces.forEach((space, index) => {
                        const lastAccess = new Date(space.lastAccess).toLocaleString();
                        report += `
${index + 1}. ${space.name}
   ID: ${space.id}
   è§’è‰²: ${space.characterName}
   åˆ›å»º: ${new Date(space.createdAt).toLocaleString()}
   æœ€åè®¿é—®: ${lastAccess}
   å†…å®¹é•¿åº¦: ${space.content.length} å­—ç¬¦`;
                    });
                } else {
                    report += `
   æš‚æ— äº’åŠ¨ç©ºé—´æ•°æ®`;
                }
                
                report += `

ğŸ’¾ å­˜å‚¨ä¿¡æ¯:
â€¢ å¤‡ä»½é”®: ${QQ_INTERACTIVE_BACKUP_KEY}
â€¢ ä¸–ç•Œä¹¦çŠ¶æ€: ${worldbook ? 'å·²åŠ è½½' : 'æœªåŠ è½½'}

ğŸ”§ å¯ç”¨å‘½ä»¤:
â€¢ window.QQ_Show_Interactive_Stats() - æ˜¾ç¤ºæ­¤ç»Ÿè®¡
â€¢ QQ_ShowSpiritButton() - æ˜¾ç¤ºç²¾çµæŒ‰é’®
â€¢ QQ_HideSpiritButton() - éšè—ç²¾çµæŒ‰é’®
â€¢ QQ_LoadInteractiveSpaces() - é‡æ–°åŠ è½½ç©ºé—´æ•°æ®
â€¢ QQ_SaveInteractiveSpaces() - æ‰‹åŠ¨ä¿å­˜ç©ºé—´æ•°æ®
`;
                
                console.log(report);
                triggerSlash(`/echo ğŸ“Š äº’åŠ¨ç©ºé—´ç»Ÿè®¡ï¼š${spaces.length}ä¸ªç©ºé—´ï¼Œç²¾çµ${spiritVisible ? 'æ˜¾ç¤º' : 'éšè—'}ä¸­`);
                return {
                    totalSpaces: spaces.length,
                    spiritVisible,
                    activeSpace,
                    spaces: spaces.map(s => ({
                        id: s.id,
                        name: s.name,
                        character: s.characterName,
                        created: s.createdAt,
                        lastAccess: s.lastAccess
                    }))
                };
            };
            
            /**
             * *** æ–°å¢ï¼šç”¨æˆ·åä¸‹æ‹‰èœå•åŠŸèƒ½ ***
             */
            function QQ_ToggleUserMenu() {
                console.log('ç‚¹å‡»ç”¨æˆ·åï¼Œæ˜¾ç¤ºä¸‹æ‹‰èœå•');
                
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨èœå•
                let existingMenu = document.getElementById('QQ_user_dropdown_menu');
                if (existingMenu) {
                    existingMenu.remove();
                    return;
                }
                
                // åˆ›å»ºä¸‹æ‹‰èœå•
                const menu = document.createElement('div');
                menu.id = 'QQ_user_dropdown_menu';
                menu.style.cssText = `
                    position: fixed;
                    top: 70px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: white;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    min-width: 200px;
                    overflow: hidden;
                `;
                
                // è·å–å½“å‰ç”¨æˆ·å
                const currentUserName = document.getElementById('QQ_message_list_UserName').textContent.replace(/\*\*/g, '');
                
                // èœå•é¡¹æ•°æ®
                const menuItems = [
                    {
                        icon: 'ğŸ‘¤',
                        text: 'ä¿®æ”¹æ˜µç§°',
                        action: () => QQ_ChangeUserName()
                    },
                    {
                        icon: 'ğŸ’«',
                        text: 'äº’åŠ¨ä½¿ç”¨æŒ‡å—',
                        action: () => QQ_ShowInteractiveGuide()
                    },
                    {
                        icon: 'ğŸ“±',
                        text: 'æ‰‹æœºçŠ¶æ€',
                        action: () => QQ_ShowPhoneStatus()
                    },
                    {
                        icon: 'ğŸ”„',
                        text: 'åŒæ­¥æ•°æ®',
                        action: () => QQ_SyncAllData()
                    },
                    {
                        icon: 'ğŸ“‹',
                        text: 'æ•°æ®ç®¡ç†',
                        action: () => QQ_ShowDataManagement()
                    },
                    {
                        icon: 'ğŸ§¹',
                        text: 'æ¸…ç†ç¼“å­˜',
                        action: () => QQ_ClearCache()
                    }
                ];
                
                // æ·»åŠ èœå•é¡¹
                menuItems.forEach((item, index) => {
                    const menuItem = document.createElement('div');
                    menuItem.style.cssText = `
                        padding: 12px 16px;
                        display: flex;
                        align-items: center;
                        cursor: pointer;
                        border-bottom: ${index < menuItems.length - 1 ? '1px solid #f0f0f0' : 'none'};
                        transition: background-color 0.2s;
                    `;
                    
                    menuItem.innerHTML = `
                        <span style="margin-right: 12px; font-size: 16px;">${item.icon}</span>
                        <span style="color: #333; font-size: 14px;">${item.text}</span>
                    `;
                    
                    menuItem.addEventListener('mouseover', () => {
                        menuItem.style.backgroundColor = '#f5f5f5';
                    });
                    
                    menuItem.addEventListener('mouseout', () => {
                        menuItem.style.backgroundColor = 'transparent';
                    });
                    
                    menuItem.addEventListener('click', () => {
                        menu.remove();
                        item.action();
                    });
                    
                    menu.appendChild(menuItem);
                });
                
                // æ·»åŠ åˆ°é¡µé¢
                document.body.appendChild(menu);
                
                // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
                setTimeout(() => {
                    document.addEventListener('click', function closeMenu(e) {
                        if (!menu.contains(e.target)) {
                            menu.remove();
                            document.removeEventListener('click', closeMenu);
                        }
                    });
                }, 100);
            }

            /**
             * *** æ–°å¢ï¼šæ˜¾ç¤ºäº’åŠ¨ä½¿ç”¨æŒ‡å— ***
             */
            function QQ_ShowInteractiveGuide() {
                const guideContent = `
ğŸ¯ äº’åŠ¨åŠŸèƒ½ä½¿ç”¨æŒ‡å—

ã€ä¸»åŠ¨è§¦å‘äº’åŠ¨ã€‘
ä½¿ç”¨ç‰¹æ®Šç¬¦å· && ç›´æ¥è§¦å‘äº’åŠ¨å†…å®¹ï¼š

âœ¨ ä½¿ç”¨æ–¹æ³•ï¼š
â€¢ "&&æƒ³è¦æ‹¥æŠ±ä½ " 
â€¢ "æŠ±æŠ±ä½ &&"  
â€¢ "æˆ‘æƒ³&&å’Œä½ ä¸€èµ·æ•£æ­¥"

ğŸª æ•ˆæœï¼šAIä¼šç›´æ¥ç”Ÿæˆäº’åŠ¨åœºæ™¯ï¼Œè·³è¿‡æ™®é€šèŠå¤©

ã€äº’åŠ¨æ¨¡å¼ã€‘
ç³»ç»Ÿæ£€æµ‹å…³é”®è¯è‡ªåŠ¨è§¦å‘ï¼š

ğŸ’« å…³é”®è¯ç±»å‹ï¼š
â€¢ èº«ä½“æ¥è§¦ï¼šæ‹¥æŠ±ã€äº²å»ã€è§¦æ‘¸ã€ç‰µæ‰‹
â€¢ é¢å¯¹é¢äº¤æµï¼šé¢å¯¹é¢ã€èµ°è¿‘ã€åä¸‹
â€¢ æƒ…æ„Ÿè¡¨è¾¾ï¼šè„¸çº¢ã€å¾®ç¬‘ã€å“­æ³£
â€¢ åŠ¨ä½œæè¿°ï¼š*åŠ¨ä½œ*ã€ã€æƒ…æ„Ÿã€‘

ğŸ  äº’åŠ¨ç©ºé—´ï¼š
â€¢ ç‚¹å‡»ç§èŠè§’è‰²åç§°å¯æŸ¥çœ‹è§’è‰²ä¸“å±ç²¾çµ
â€¢ ç²¾çµå¯ç®¡ç†è¯¥è§’è‰²çš„æ‰€æœ‰äº’åŠ¨è®°å½•
â€¢ æ”¯æŒåˆ›å»ºæ–°äº’åŠ¨å’ŒæŸ¥çœ‹å†å²è®°å½•

ğŸ’¡ å°è´´å£«ï¼š
â€¢ ä¸»åŠ¨ç¬¦å·è§¦å‘æ›´ç²¾å‡†
â€¢ äº’åŠ¨æ¨¡å¼åœ¨å…³é”®æ—¶åˆ»æ¿€æ´»
â€¢ æ‰€æœ‰äº’åŠ¨å†…å®¹ä¿å­˜åœ¨ä¸–ç•Œä¹¦ä¸­
                `.trim();
                
                alert(guideContent);
                console.log('æ˜¾ç¤ºäº’åŠ¨ä½¿ç”¨æŒ‡å—');
            }
            
            /**
             * *** æ–°å¢ï¼šä¿®æ”¹ç”¨æˆ·æ˜µç§° ***
             */
            function QQ_ChangeUserName() {
                const currentName = document.getElementById('QQ_message_list_UserName').textContent.replace(/\*\*/g, '');
                const newName = prompt('è¯·è¾“å…¥æ–°çš„æ˜µç§°:', currentName);
                
                if (newName && newName.trim() && newName.trim() !== currentName) {
                    const finalName = newName.trim();
                    
                    // æ›´æ–°æ‰€æœ‰æ˜¾ç¤ºçš„ç”¨æˆ·å
                    document.getElementById('QQ_message_list_UserName').innerHTML = `<strong>${finalName}</strong>`;
                    document.getElementById('QQ_home_UserName').textContent = finalName;
                    
                    // ä¿å­˜åˆ°ä¸–ç•Œä¹¦
                    QQ_SafeSaveToWorldBook('ç”¨æˆ·è®¾ç½®', {
                        userName: finalName,
                        updateTime: new Date().toISOString()
                    }, 'QQ_ç”¨æˆ·è®¾ç½®');
                    
                    console.log(`ç”¨æˆ·åå·²æ›´æ”¹ä¸º: ${finalName}`);
                    triggerSlash(`/echo ç”¨æˆ·åå·²æ›´æ”¹ä¸º: ${finalName}`);
                }
            }

            /**
             * *** æ–°å¢ï¼šæ˜¾ç¤ºæ‰‹æœºçŠ¶æ€ ***
             */
            function QQ_ShowPhoneStatus() {
                const stats = {
                    contacts: Object.keys(window.QQ_Contacts || {}).length,
                    groups: Object.keys(window.QQ_Groups || {}).length,
                    messages: Object.keys(window.QQ_MessageHistory || {}).length,
                    moments: Object.keys(window.QQ_MomentData || {}).length,
                    interactiveSpaces: Object.keys(window.QQ_InteractiveSpaces || {}).length
                };
                
                const statusInfo = `
ğŸ“± æ‰‹æœºçŠ¶æ€æŠ¥å‘Š
è”ç³»äºº: ${stats.contacts} ä¸ª
ç¾¤èŠ: ${stats.groups} ä¸ª  
æ¶ˆæ¯è®°å½•: ${stats.messages} æ¡
åŠ¨æ€: ${stats.moments} æ¡
äº’åŠ¨ç©ºé—´: ${stats.interactiveSpaces} ä¸ª

ğŸ”‹ ç³»ç»ŸçŠ¶æ€: æ­£å¸¸
ğŸ“¶ ç½‘ç»œçŠ¶æ€: å·²è¿æ¥
ğŸ’¾ æ•°æ®åŒæ­¥: ä¸–ç•Œä¹¦
                `.trim();
                
                alert(statusInfo);
                console.log('æ‰‹æœºçŠ¶æ€:', stats);
            }

            /**
             * *** æ–°å¢ï¼šåŒæ­¥æ‰€æœ‰æ•°æ® ***
             */
            function QQ_SyncAllData() {
                console.log('ğŸ”„ å¼€å§‹åŒæ­¥æ‰€æœ‰æ•°æ®åˆ°ä¸–ç•Œä¹¦...');
                
                const syncTasks = [
                    () => QQ_SaveAllContactsToWorldBook(),
                    () => QQ_SaveAllGroupsToWorldBook(), 
                    () => QQ_SaveAllMessagesToWorldBook(),
                    () => QQ_SaveAllMomentsToWorldBook(),
                    () => QQ_SaveAllInteractiveSpacesToWorldBook(),
                    () => saveGroupsToStorage() // ä¿å­˜å½“å‰è§’è‰²çš„åˆ†ç»„æ•°æ®
                ];
                
                let completed = 0;
                const total = syncTasks.length;
                
                syncTasks.forEach((task, index) => {
                    setTimeout(() => {
                        try {
                            task();
                            completed++;
                            console.log(`âœ… åŒæ­¥ä»»åŠ¡ ${index + 1}/${total} å®Œæˆ`);
                            
                            if (completed === total) {
                                triggerSlash(`/echo æ‰€æœ‰æ•°æ®å·²åŒæ­¥åˆ°ä¸–ç•Œä¹¦ (${total}/${total})`);
                                console.log('ğŸ‰ æ‰€æœ‰æ•°æ®åŒæ­¥å®Œæˆï¼');
                            }
                        } catch (error) {
                            console.error(`âŒ åŒæ­¥ä»»åŠ¡ ${index + 1} å¤±è´¥:`, error);
                        }
                    }, index * 500); // é—´éš”500msæ‰§è¡Œï¼Œé¿å…å¹¶å‘é—®é¢˜
                });
                
                triggerSlash(`/echo æ­£åœ¨åŒæ­¥æ•°æ®åˆ°ä¸–ç•Œä¹¦... (0/${total})`);
            }

            /**
             * *** æ–°å¢ï¼šæ˜¾ç¤ºæ•°æ®ç®¡ç†ç•Œé¢ ***
             */
            function QQ_ShowDataManagement() {
                console.log('æ˜¾ç¤ºæ•°æ®ç®¡ç†ç•Œé¢');
                alert('æ•°æ®ç®¡ç†åŠŸèƒ½å¼€å‘ä¸­...\n\nå½“å‰æ”¯æŒ:\nâ€¢ æ‰€æœ‰æ•°æ®ä¿å­˜åœ¨ä¸–ç•Œä¹¦ä¸­\nâ€¢ è”ç³»äººåˆ†ç»„ç®¡ç†\nâ€¢ äº’åŠ¨ç©ºé—´ç®¡ç†\nâ€¢ æ¶ˆæ¯è®°å½•ç®¡ç†');
            }

            /**
             * *** æ–°å¢ï¼šæ¸…ç†ç¼“å­˜ ***
             */
            function QQ_ClearCache() {
                if (confirm('ç¡®å®šè¦æ¸…ç†ç¼“å­˜å—ï¼Ÿè¿™å°†æ¸…é™¤ä¸´æ—¶æ•°æ®ä½†ä¿ç•™ä¸–ç•Œä¹¦ä¸­çš„é‡è¦æ•°æ®ã€‚')) {
                    // æ¸…ç†å‰ç«¯ç¼“å­˜
                    window.QQ_Cache = {};
                    window.QQ_TempData = {};
                    
                    // æ¸…ç†ä¸€äº›ä¸´æ—¶DOMç¼“å­˜
                    $('.QQ_temp_cache').remove();
                    
                    console.log('ç¼“å­˜å·²æ¸…ç†');
                    triggerSlash('/echo ç¼“å­˜å·²æ¸…ç†ï¼Œé‡è¦æ•°æ®ä¿ç•™åœ¨ä¸–ç•Œä¹¦ä¸­');
                }
            }

            // *** æ–°å¢ï¼šäº’åŠ¨æ£€æµ‹æµ‹è¯•å·¥å…· - ä¼˜åŒ–ç‰ˆ ***
            window.QQ_Test_Interactive_Detection = function(text) {
                if (text) {
                    // æµ‹è¯•å•ä¸ªæ–‡æœ¬
                    const result = QQ_DetectInteractiveIntent(text);
                    
                    let details = `
=== äº’åŠ¨æ„å›¾æ£€æµ‹æµ‹è¯• ===
ğŸ“ æµ‹è¯•æ–‡æœ¬: "${text}"`;

                    if (result && result.isInteractive) {
                        details += `
ğŸ¯ æ£€æµ‹ç»“æœ: âœ… æ£€æµ‹åˆ°äº’åŠ¨æ„å›¾
ğŸ”§ è§¦å‘ç±»å‹: ${result.triggerType === 'symbol' ? 'ğŸ¯ ç‰¹æ®Šç¬¦å·è§¦å‘' : 'ğŸ’« å…³é”®è¯è§¦å‘ (äº’åŠ¨æ¨¡å¼)'}`;
                        
                        if (result.triggerType === 'symbol') {
                            details += `
ğŸ”— è§¦å‘ç¬¦å·: ${result.triggerSymbol}
ğŸ“ æ¸…ç†åå†…å®¹: "${result.cleanContent}"
ğŸ’¡ è¯´æ˜: ${result.description}`;
                        } else {
                            details += `
ğŸ“Š å…³é”®è¯åŒ¹é…: ${result.matchCount || 0} ä¸ª
ğŸ­ æ¨¡å¼åŒ¹é…: ${result.patternMatches || 0} ä¸ª
ğŸ” åŒ¹é…å†…å®¹: ${result.matchedKeywords ? result.matchedKeywords.join(', ') : 'æ— '}
ğŸ’¡ è¯´æ˜: ${result.description}`;
                        }
                    } else {
                        details += `
ğŸ¯ æ£€æµ‹ç»“æœ: âŒ æœªæ£€æµ‹åˆ°äº’åŠ¨æ„å›¾`;
                    }

                    details += `

ğŸ’¡ ä½¿ç”¨æŒ‡å—:
ğŸ¯ ã€ä¸»åŠ¨è§¦å‘ã€‘ä½¿ç”¨ç‰¹æ®Šç¬¦å·:
â€¢ "&&æƒ³è¦æ‹¥æŠ±ä½ " (âœ… ç¬¦å·è§¦å‘)
â€¢ "æŠ±æŠ±ä½ &&" (âœ… ç¬¦å·è§¦å‘)  
â€¢ "æˆ‘æƒ³&&å’Œä½ ä¸€èµ·æ•£æ­¥" (âœ… ç¬¦å·è§¦å‘)

ğŸ’« ã€äº’åŠ¨æ¨¡å¼ã€‘ä¼ ç»Ÿå…³é”®è¯:
â€¢ èº«ä½“æ¥è§¦: æ‹¥æŠ±ã€äº²å»ã€è§¦æ‘¸ã€ç‰µæ‰‹ç­‰
â€¢ é¢å¯¹é¢äº¤æµ: é¢å¯¹é¢ã€å½“é¢ã€èµ°è¿‘ã€åä¸‹ç­‰  
â€¢ æƒ…æ„Ÿè¡¨è¾¾: è„¸çº¢ã€å®³ç¾ã€å¾®ç¬‘ã€å“­æ³£ç­‰
â€¢ åŠ¨ä½œæè¿°: *åŠ¨ä½œ*ã€ã€æƒ…æ„Ÿã€‘ç­‰æ ¼å¼
â€¢ éœ€è¦2ä¸ªå…³é”®è¯æˆ–1ä¸ªæ¨¡å¼åŒ¹é…æ‰è§¦å‘

ğŸ“š ç¤ºä¾‹æµ‹è¯•æ–‡æœ¬:
â€¢ "&&æŠ±æŠ±ä½ " (ğŸ¯ ç¬¦å·è§¦å‘)
â€¢ "æˆ‘æƒ³æŠ±æŠ±ä½ " (ğŸ’« èº«ä½“æ¥è§¦)
â€¢ "*èµ°å‘ä½ *" (ğŸ’« åŠ¨ä½œæ¨¡å¼) 
â€¢ "é¢å¯¹é¢èŠå¤©" (ğŸ’« é¢å¯¹é¢+åŠ¨ä½œ)
â€¢ "ä½ å¥½å—ï¼Ÿ" (âŒ æ™®é€šå¯¹è¯)
                `;
                    console.log(details);
                    alert(details);
                    return result;
                } else {
                    // è¿è¡Œå®Œæ•´çš„ä¼˜åŒ–æµ‹è¯•å¥—ä»¶
                    console.log("ğŸ” ========== äº’åŠ¨æ£€æµ‹ä¼˜åŒ–æµ‹è¯•å¥—ä»¶ ==========");
                    
                    const testCases = [
                        // ğŸ”¬ å…ˆå›å¤åäº’åŠ¨çš„æµ‹è¯•ç”¨ä¾‹
                        {
                            name: "å…ˆç§èŠå›å¤åäº’åŠ¨",
                            content: "å…ˆåœ¨ç§èŠå›å¤'å¥½çš„é©¬ä¸Šæ¥'ç„¶åè¿‡æ¥æ‹¥æŠ±æˆ‘",
                            expected: "åº”æ£€æµ‹åˆ°å…ˆå›å¤è¦æ±‚",
                            test: (content) => QQ_CheckPriorReplyRequest(content).shouldReplyFirst
                        },
                        {
                            name: "å…ˆç¾¤èŠå›å¤åäº’åŠ¨", 
                            content: "å…ˆåœ¨ç¾¤èŠè¯´'å¤§å®¶ç­‰æˆ‘ä¸€ä¸‹'ç„¶åå†è¿‡æ¥ä¸€èµ·ç©æ¸¸æˆ",
                            expected: "åº”æ£€æµ‹åˆ°å…ˆå›å¤è¦æ±‚",
                            test: (content) => QQ_CheckPriorReplyRequest(content).shouldReplyFirst
                        },
                        
                        // ğŸ”¬ ç²¾ç¡®å…³é”®è¯æ£€æµ‹çš„æµ‹è¯•ç”¨ä¾‹
                        {
                            name: "æ— æ•ˆé›†ä½“å…³é”®è¯",
                            content: "ç”¨æˆ·å‘é€äº†'é›†ä½“è¡ŒåŠ¨'ä½†è¿™åªæ˜¯åœ¨è®¨è®ºæ¦‚å¿µ",
                            expected: "ä¸åº”è§¦å‘å¤šäººäº’åŠ¨",
                            test: (content) => !QQ_DetectMultiCharacterInteraction(content, null)
                        },
                        {
                            name: "æœ‰æ•ˆé›†ä½“äº’åŠ¨",
                            content: "æˆ‘ä»¬ä¸€èµ·å»å…¬å›­ç©å§ï¼Œæ‰€æœ‰äººéƒ½æ¥",
                            expected: "åº”è§¦å‘å¤šäººäº’åŠ¨",
                            test: (content) => QQ_DetectMultiCharacterInteraction(content, null)
                        },
                        {
                            name: "è¿‡å»æ—¶æ€æ— æ•ˆ",
                            content: "æˆ‘ä»¬ä»¥å‰ä¸€èµ·ç©è¿‡æ¸¸æˆ",
                            expected: "ä¸åº”è§¦å‘å¤šäººäº’åŠ¨",
                            test: (content) => !QQ_DetectMultiCharacterInteraction(content, null)
                        },
                        {
                            name: "æ¡ä»¶å¥æ— æ•ˆ",
                            content: "å¦‚æœæˆ‘ä»¬ä¸€èµ·å»çš„è¯ä¼šå¾ˆæœ‰è¶£",
                            expected: "ä¸åº”è§¦å‘å¤šäººäº’åŠ¨", 
                            test: (content) => !QQ_DetectMultiCharacterInteraction(content, null)
                        },
                        
                        // ğŸ”¬ äº’åŠ¨å†…å®¹æ£€æµ‹çš„æµ‹è¯•ç”¨ä¾‹
                        {
                            name: "æœ‰æ•ˆäº’åŠ¨å†…å®¹",
                            content: "*èµ°å‘ä½ * æƒ³è¦æ‹¥æŠ±ä½ ",
                            expected: "åº”æ£€æµ‹åˆ°äº’åŠ¨å†…å®¹",
                            test: (content) => QQ_IsInteractiveContent(content)
                        },
                        {
                            name: "æ™®é€šå¯¹è¯",
                            content: "ä½ ä»Šå¤©æ€ä¹ˆæ ·ï¼Ÿå·¥ä½œé¡ºåˆ©å—ï¼Ÿ",
                            expected: "ä¸åº”æ£€æµ‹åˆ°äº’åŠ¨å†…å®¹",
                            test: (content) => !QQ_IsInteractiveContent(content)
                        }
                    ];
                    
                    console.log("å¼€å§‹æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹...");
                    
                    let passCount = 0;
                    let failCount = 0;
                    
                    testCases.forEach((testCase, index) => {
                        console.log(`\n--- æµ‹è¯• ${index + 1}: ${testCase.name} ---`);
                        console.log(`å†…å®¹: "${testCase.content}"`);
                        console.log(`æœŸæœ›: ${testCase.expected}`);
                        
                        try {
                            const result = testCase.test(testCase.content);
                            if (result) {
                                console.log(`âœ… æµ‹è¯•é€šè¿‡`);
                                passCount++;
                            } else {
                                console.log(`âŒ æµ‹è¯•å¤±è´¥`);
                                failCount++;
                            }
                        } catch (error) {
                            console.error(`ğŸ’¥ æµ‹è¯•æ‰§è¡Œé”™è¯¯:`, error);
                            failCount++;
                        }
                    });
                    
                    console.log(`\nğŸ ========== æµ‹è¯•ç»“æœæ±‡æ€» ==========`);
                    console.log(`âœ… é€šè¿‡: ${passCount}/${testCases.length}`);
                    console.log(`âŒ å¤±è´¥: ${failCount}/${testCases.length}`);
                    console.log(`ğŸ“Š æˆåŠŸç‡: ${Math.round((passCount / testCases.length) * 100)}%`);
                    
                    if (failCount === 0) {
                        console.log(`ğŸ‰ æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹éƒ½é€šè¿‡äº†ï¼äº’åŠ¨æ£€æµ‹ç³»ç»Ÿä¼˜åŒ–æˆåŠŸï¼`);
                    } else {
                        console.log(`âš ï¸ æœ‰ ${failCount} ä¸ªæµ‹è¯•ç”¨ä¾‹å¤±è´¥ï¼Œéœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–`);
                    }
                    
                    return { passCount, failCount, total: testCases.length };
                }
            };
            
            function QQ_UpdateNewTips() {
                // åˆ·æ–°å·¦ä¸Šè§’æœªè¯»ä¿¡æ¯æ•°å­—
                let ids = $(".QQ_chat_page")
                    .map(function () {
                        return this; // ç›´æ¥è¿”å›å…ƒç´ çš„ ID
                    })
                    .get()
                    .filter(Boolean); // è¿‡æ»¤æ‰ç©º ID
                for (const id of ids) {
                    if ($(id).css("display") == "none") {
                        continue;
                    }
                    const name = $(id).attr("data-name") ?? "";
                    let TipsCount = QQ_GetChatShowTipsCount(name);
                    console.log(`è·å–åˆ°${name}çš„å·¦ä¸Šè§’æ•°å­—ä¸º:${TipsCount}`);
                    const $Tips = $(`.QQ_chat_page[data-name='${name}']`).find(
                        `.new_tips`,
                    );
                    $Tips.text(TipsCount);
                    if (TipsCount > 0) {
                        $Tips.css("display", "flex");
                        console.log(`æ˜¾ç¤ºtips`);
                    } else {
                        $Tips.hide();
                        console.log(`éšè—tips`);
                    }
                }
            }
            /**
             * å¯¼èˆªåˆ°æŒ‡å®šé¡µé¢
             */
            function QQ_Nav(page) {
                // é¡µé¢åˆ‡æ¢æ—¶ä¸è‡ªåŠ¨æ£€æŸ¥QQ_Groupsï¼ˆé¿å…é‡å¤åŠ è½½ï¼‰
                console.log(`å¯¼èˆªåˆ°é¡µé¢: ${page}`);
                
                const $message_svg = $("#QQ_message_svg");
                const $people_svg = $("#QQ_people_svg");
                const $moment_svg = $("#QQ_moment_svg");
                $message_svg.css("fill", "#000000");
                $people_svg.css("fill", "#000000");
                $moment_svg.css("fill", "#000000");
                $("#QQ_home_page").hide();
                $("#QQ_space_page").hide();
                $("#QQ_message_list_page").hide();
                
                // æ˜¾ç¤ºåº•éƒ¨å¯¼èˆªæ 
                $(".QQ_bottom_nav").show();
                
                // æ›´æ–°å½“å‰é¡µé¢çŠ¶æ€
                QQ_currentPage = page;
                
                if (page === "message") {
                    $message_svg.css("fill", "#019aff");
                    $("#QQ_message_list_page").css('display','flex');
                    $("#App_QQ").css("background-color", "#eff3ff");
                    // æ›´æ–°ç”¨æˆ·åæ˜¾ç¤º
                    const userName = $("#QQ_home_UserName").text();
                    $("#QQ_message_list_UserName").text(userName);
                    // æ¯æ¬¡åˆ‡æ¢åˆ°æ¶ˆæ¯é¡µé¢æ—¶éƒ½æ›´æ–°åˆ—è¡¨
                    // ä½¿ç”¨setTimeouté¿å…asyncé—®é¢˜
                    setTimeout(async () => {
                        await QQ_UpdateMessageList();
                    }, 100);
                    // æ¶ˆæ¯é¡µé¢åªéœ€è¦æ˜¾ç¤ºå·²åŠ è½½çš„ç¾¤èŠï¼Œä¸éœ€è¦é‡æ–°åˆå§‹åŒ–
                    // æ¶ˆæ¯é¡µé¢åªéœ€è¦æ›´æ–°åˆ—è¡¨æ˜¾ç¤ºï¼Œä¸éœ€è¦é‡æ–°åŠ è½½æ•°æ®
                    console.log('æ¶ˆæ¯é¡µé¢æ˜¾ç¤ºï¼Œæ›´æ–°æ¶ˆæ¯åˆ—è¡¨');
                } else if (page === "people") {
                    $people_svg.css("fill", "#019aff");
                    $("#QQ_home_page").css('display','flex');
                    $("#App_QQ").css("background-color", "#eff3ff");
                    
                    console.log('åˆ‡æ¢åˆ°è”ç³»äººé¡µé¢');
                    
                    // è”ç³»äººé¡µé¢åªéœ€è¦æ˜¾ç¤ºå·²åŠ è½½çš„æ•°æ®ï¼Œä¸éœ€è¦é‡æ–°åŠ è½½
                    console.log('è”ç³»äººé¡µé¢æ˜¾ç¤ºï¼Œæ•°æ®å·²åœ¨åˆå§‹åŒ–æ—¶åŠ è½½');
                    
                    // è”ç³»äººé¡µé¢åªéœ€è¦æ˜¾ç¤ºå·²åŠ è½½çš„ç¾¤èŠï¼Œä¸éœ€è¦é‡æ–°åˆå§‹åŒ–
                    
                    // åˆå§‹åŒ–è”ç³»äººåˆ†ç»„åŠŸèƒ½
                    if (typeof initContactGroups === 'function') {
                        setTimeout(initContactGroups, 200);
                    }
                } else if (page === "moment") {
                    $moment_svg.css("fill", "#019aff");
                    $("#QQ_space_page").show();
                    $("#App_QQ").css("background-color", "#ffffff");
                    QQ_SetNewTips(0);
                    QQ_NewMsg["moment"] = 0;
                    $(".new_tips").hide();
                } else if (page === "chat") {
                    // å¤„ç†èŠå¤©é¡µé¢åˆ‡æ¢
                    console.log('åˆ‡æ¢åˆ°èŠå¤©é¡µé¢');
                    
                    // éšè—åº•éƒ¨å¯¼èˆªæ 
                    $(".QQ_bottom_nav").hide();
                    
                    // éšè—æ‰€æœ‰å…¶ä»–é¡µé¢
                    $("#QQ_home_page").hide();
                    $("#QQ_space_page").hide();
                    $("#QQ_message_list_page").hide();
                    
                    // å¦‚æœæ˜¯ç¾¤èŠï¼Œåˆ›å»ºæˆ–æ˜¾ç¤ºç¾¤èŠä¸“ç”¨é¡µé¢
                    if (window.currentGroupChat) {
                        console.log('æ˜¾ç¤ºç¾¤èŠé¡µé¢:', window.currentGroupChat.name, 'ID:', window.currentGroupChat.id);
                        
                        // éšè—æ‰€æœ‰ç°æœ‰çš„èŠå¤©é¡µé¢
                        $(".QQ_chat_page").hide();
                        
                        // å…ˆç§»é™¤æ‰€æœ‰ç°æœ‰çš„ç¾¤èŠé¡µé¢ï¼Œç¡®ä¿æ²¡æœ‰ç¼“å­˜é—®é¢˜
                        $(".group-chat-page").remove();
                        
                        // åˆ›å»ºæ–°çš„ç¾¤èŠä¸“ç”¨é¡µé¢
                        console.log('åˆ›å»ºç¾¤èŠä¸“ç”¨é¡µé¢:', window.currentGroupChat.name);
                        const groupChatPage = $(`
                            <div data-group-id="${window.currentGroupChat.id}" data-name="${window.currentGroupChat.name}" class="QQ_chat_page group-chat-page" style="width:100%;height:100%;padding-top:0;background-color:white;position:relative;display:none;">
                                <div class="chat-header" style="padding:10px 15px;background-color:white;border-bottom:1px solid #eee;display:flex;align-items:center;">
                                    <div style="cursor:pointer;margin-right:15px;" onclick="QQ_GoHome()">
                                        <svg viewBox="0 0 1024 1024" style="height:20px;width:20px;">
                                            <path d="M724 218.3V141c0-6.7-7.7-10.4-12.9-6.3L260.3 486.8a31.86 31.86 0 0 0 0 50.3l450.8 352.1c5.3 4.1 12.9 0.4 12.9-6.3v-77.3c0-4.9-2.3-9.6-6.1-12.6l-360-281 360-281.1c3.8-3 6.1-7.7 6.1-12.6z" fill="#333"></path>
                                        </svg>
                                    </div>
                                    <div class="group-chat-info" style="flex:1;">
                                        <div class="group-chat-name" style="font-size:16px;font-weight:bold;color:#333;">${window.currentGroupChat.name}</div>
                                        <div class="group-chat-members" style="font-size:12px;color:#666;">ç¾¤èŠ Â· ${window.currentGroupChat.members.length}äºº</div>
                                    </div>
                                    <div style="cursor:pointer;" onclick="showGroupManagementMenu(window.currentGroupChat, this)">
                                        <svg viewBox="0 0 1024 1024" style="height:20px;width:20px;">
                                            <path d="M512 256c-35.3 0-64 28.7-64 64s28.7 64 64 64 64-28.7 64-64-28.7-64-64-64zm0 256c-35.3 0-64 28.7-64 64s28.7 64 64 64 64-28.7 64-64-28.7-64-64-64zm0 256c-35.3 0-64 28.7-64 64s28.7 64 64 64 64-28.7 64-64-28.7-64-64-64z" fill="#666"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div class="msgcontent" style="flex:1;overflow-y:auto;padding:10px;background-color:#f5f5f5;height:calc(100vh - 120px);">
                                    <!-- ç¾¤èŠæ¶ˆæ¯å†…å®¹ -->
                                </div>
                                <div class="chat-input" style="padding:10px;background-color:white;border-top:1px solid #eee;display:flex;align-items:center;">
                                    <input type="text" placeholder="è¾“å…¥æ¶ˆæ¯..." style="flex:1;padding:8px 12px;border:1px solid #ddd;border-radius:20px;outline:none;">
                                    <button style="margin-left:10px;padding:8px 16px;background:#007AFF;color:white;border:none;border-radius:20px;cursor:pointer;">å‘é€</button>
                                </div>
                            </div>
                        `);
                        
                        // æ·»åŠ åˆ°é¡µé¢
                        $("#App_QQ").append(groupChatPage);
                        
                        // *** ä¿®å¤ï¼šåˆå§‹åŒ–å·²å¤„ç†çš„äº’åŠ¨å†…å®¹IDé›†åˆï¼Œä½†ä¸æ¸…ç©ºç°æœ‰æ•°æ® ***
                        if (!window.QQ_ProcessedInteractiveIds) {
                            window.QQ_ProcessedInteractiveIds = new Set();
                            console.log('ğŸ†• åˆå§‹åŒ–äº’åŠ¨å†…å®¹IDé›†åˆ');
                        } else {
                            console.log(`ğŸ“‹ å¤ç”¨ç°æœ‰äº’åŠ¨å†…å®¹IDé›†åˆï¼Œå½“å‰æ•°é‡: ${window.QQ_ProcessedInteractiveIds.size}`);
                        }
                        
                        // æ˜¾ç¤ºç¾¤èŠé¡µé¢
                        groupChatPage.show();
                        $("#App_QQ").css("background-color", "#ffffff");
                        
                        // ç«‹å³åŠ è½½ç¾¤èŠå†å²æ¶ˆæ¯
                        console.log('å‡†å¤‡åŠ è½½ç¾¤èŠå†å²æ¶ˆæ¯:', window.currentGroupChat.id);
                        loadGroupChatHistory(window.currentGroupChat.id);
                        
                    } else {
                        // æ™®é€šèŠå¤©é¡µé¢å¤„ç†
                        const chatPage = $(".QQ_chat_page").not('.group-chat-page');
                        if (chatPage.length > 0) {
                            chatPage.first().show();
                            $("#App_QQ").css("background-color", "#ffffff");
                            console.log('èŠå¤©é¡µé¢å·²æ˜¾ç¤º');
                        } else {
                            console.error('æœªæ‰¾åˆ°èŠå¤©é¡µé¢å…ƒç´ ');
                            // å¦‚æœæ‰¾ä¸åˆ°èŠå¤©é¡µé¢ï¼Œå›é€€åˆ°æ¶ˆæ¯é¡µé¢
                            QQ_Nav("message");
                            return;
                        }
                    }
                }
            }

            /**
             * è¿”å›é¦–é¡µ
             */
            function QQ_GoHome() {
                QQ_HideAllChat();
                
                // å¦‚æœå½“å‰åœ¨ç¾¤èŠä¸­ï¼Œè¿”å›åˆ°æ¥æºé¡µé¢
                if (window.currentGroupChat && window.groupChatSourcePage) {
                    const sourcePage = window.groupChatSourcePage;
                    console.log('ä»ç¾¤èŠè¿”å›åˆ°æ¥æºé¡µé¢:', sourcePage);
                    
                    // æ¸…é™¤ç¾¤èŠçŠ¶æ€
                    window.currentGroupChat = null;
                    window.groupChatSourcePage = null;
                    
                    // è¿”å›åˆ°æ¥æºé¡µé¢
                    if (sourcePage === 'messages') {
                        QQ_Nav("message");
                    } else {
                        QQ_Nav("people");
                    }
                    return;
                }
                
                // æ ¹æ®å½“å‰é¡µé¢çŠ¶æ€è¿”å›åˆ°æ­£ç¡®çš„é¡µé¢
                if (QQ_currentPage === "message") {
                    // å¦‚æœä¹‹å‰åœ¨æ¶ˆæ¯é¡µé¢ï¼Œè¿”å›åˆ°æ¶ˆæ¯é¡µé¢
                    QQ_Nav("message");
                } else if (QQ_currentPage === "moment") {
                    // å¦‚æœä¹‹å‰åœ¨åŠ¨æ€é¡µé¢ï¼Œè¿”å›åˆ°åŠ¨æ€é¡µé¢
                    QQ_Nav("moment");
                } else {
                    // é»˜è®¤è¿”å›åˆ°è”ç»œäººé¡µé¢
                    QQ_Nav("people");
                }
            }
            /**
             * é”™è¯¯æç¤º
             * @param content æç¤ºå†…å®¹
             * @param change æ˜¯å¦æ›´æ¢æµè§ˆå™¨
             */
            function QQ_Error(content, change) {
                triggerSlash(`/echo severity=error ${content}`);
                if (change) {
                    triggerSlash(`/echo è¯·æ›´æ¢æµè§ˆå™¨é‡è¯•`);
                }
            }
            /**
             * åˆå§‹åŒ–
             */
            async function init() {
                const LorebookSettings = await getLorebookSettings();
                if (
                    LorebookSettings &&
                    LorebookSettings.context_percentage != 100
                ) {
                    console.log(`è®¾ç½®ä¸Šä¸‹æ–‡!!!!!!!!!!`);
                    await setLorebookSettings({ context_percentage: 100 });
                }
                Verify();
                UserName =
                    (await triggerSlashWithResult("/pass {{user}}")) ?? "";
                $("#QQ_home_UserName").html(`<strong>${UserName}</strong>`);
                $("#QQ_message_list_UserName").html(`<strong>${UserName}</strong>`);
                charAvatarPath =
                    (await triggerSlashWithResult(
                        "/pass {{charAvatarPath}}",
                    )) ?? "";
                userAvatarPath =
                    (await triggerSlashWithResult(
                        "/pass {{userAvatarPath}}",
                    )) ?? "";
                console.log(`è·å–åˆ°çš„userå¤´åƒ:${userAvatarPath}`);
                charcardname =
                    (await triggerSlashWithResult("/pass {{char}}")) ?? "";
                console.log(`å¼€å§‹è·å–ä¸–ç•Œä¹¦é…ç½®`);
                try {
                    worldbook = await GetWorldBookName();
                    if (!worldbook) {
                        QQ_Error(`è·å–ä¸–ç•Œä¹¦å¤±è´¥!!!!`);
                    }
                    console.log(`è·å–åˆ°çš„ä¸–ç•Œä¹¦åå­—:${worldbook}`);
                    entries = await getLorebookEntries(worldbook);
                    if (!entries) {
                        QQ_Error(`è·å–ä¸–ç•Œä¹¦æ¡ç›®å¤±è´¥!!!!`);
                    }
                } catch (e) {
                    QQ_Error(`å‡ºç°å¼‚å¸¸:\n${e}`);
                    console.log(`è·å–ä¸–ç•Œä¹¦å‡ºç°å¼‚å¸¸:${e}`);
                }
                Variables = await getVariables();
                if (Variables) {
                    if (Variables.Npc_Settings) {
                        try {
                            Npc_Settings = JSON.parse(Variables.Npc_Settings);
                        } catch {
                            QQ_Error("è¯»å–NPCé…ç½®å¤±è´¥");
                        }
                    }
                }
                // NpcCssValue = Variables.NpcCssValue ?? "";
                // console.log(`é¦–æ¬¡è¯»å–åˆ°çš„NpcCss:\n${NpcCssValue}`);
                $("<style>")
                    .attr("data-name", "AutoNpc")
                    .text("")
                    .appendTo("head");
                System_UpdateNpcCss();
                let Phone_Entry = GetWorldEntry(
                    ["æ‰‹æœº-ç•Œé¢åŸºæœ¬è®¾ç½®", "æ‰‹æœºç•Œé¢åŸºæœ¬è®¾ç½®"],
                    true,
                );
                if (Phone_Entry) {
                    Phone_Settings.loadText(Phone_Entry.content);
                }
                DelPadding(); // ç§»é™¤å¤´åƒå’Œè¾¹è·
                await WorldBookUpdate();
                await GetSettings();
                await LoadRandomHead();
                await LoadEmoji();
                await LoadChars();
                await MiPhone_Merge();

                // ç¾¤èŠæ•°æ®å·²åœ¨LoadCharsä¸­åŠ è½½ï¼Œæ— éœ€é¢å¤–æ¢å¤
                
                console.log('å¼€å§‹æ‰§è¡Œä¸¤é˜¶æ®µæ•°æ®åŠ è½½...');
                // é˜¶æ®µä¸€ï¼šä»ä¸»å¤‡ä»½æ¢å¤æ ¸å¿ƒæ•°æ®
                await QQ_Load_Chat_Backup(); 
                // é˜¶æ®µäºŒï¼šä»ç‹¬ç«‹æ¡ç›®å¢å¼ºç¾¤èŠå…ƒæ•°æ®
                await QQ_Enhance_Group_Metadata();
                console.log('ä¸¤é˜¶æ®µæ•°æ®åŠ è½½å®Œæˆã€‚');
                
                // *** æ–°å¢ï¼šåˆå§‹åŒ–æ—¶åŠ è½½å·²è¯»çŠ¶æ€ ***
                console.log('å¼€å§‹åŠ è½½å·²è¯»çŠ¶æ€...');
                await QQ_LoadReadStatus();
                
                // *** æ–°å¢ï¼šåŠ è½½ä¿å­˜çš„åŠ¨æ€å†…å®¹ ***
                console.log('å¼€å§‹åŠ è½½åŠ¨æ€å†…å®¹...');
                await QQ_Load_Moments();
                
                // *** æ–°å¢ï¼šåˆå§‹åŒ–äº’åŠ¨ç©ºé—´ç³»ç»Ÿ ***
                console.log('å¼€å§‹åˆå§‹åŒ–äº’åŠ¨ç©ºé—´ç³»ç»Ÿ...');
                await QQ_InitInteractiveSystem();
                
                // *** ä¿®å¤ï¼šåŠ è½½çŸ­æœŸè®°å¿†åºåˆ—å·çŠ¶æ€ ***
                console.log('å¼€å§‹åŠ è½½çŸ­æœŸè®°å¿†åºåˆ—å·çŠ¶æ€...');
                QQ_LastProcessedSequenceId = await QQ_LoadLastProcessedSequenceId();
                
                console.log('é¡µé¢åˆå§‹åŒ–å®Œæˆ');
                
                // ä¸ºèŠå¤©å…ƒç´ ç»‘å®šç‚¹å‡»äº‹ä»¶
                console.log('ç»‘å®šåº•éƒ¨å¯¼èˆªç‚¹å‡»äº‹ä»¶');
                $(document).on("click", "#QQ_message_nav", () => {
                    console.log('ç‚¹å‡»æ¶ˆæ¯å¯¼èˆª');
                    QQ_Nav("message");
                });
                $(document).on("click", "#QQ_people_nav", () => {
                    console.log('ç‚¹å‡»è”ç³»äººå¯¼èˆª');
                    QQ_Nav("people");
                });
                $(document).on("click", "#QQ_moment_nav", () => {
                    console.log('ç‚¹å‡»åŠ¨æ€å¯¼èˆª');
                    QQ_Nav("moment");
                });
                $(document).on("click", ".QQ-close-btn", () => QQ_GoHome());
                $(document).on("click", ".QQ_home_usermsg", (e) =>
                    QQ_ChangeChatPage(e),
                );
                $(document).on("click", "#QQ_chat_page_setting", (e) =>
                    QQ_SetChatPageSetting(e),
                );
                $(document).on("click", ".close-setting-btn", () =>
                    closeSettingPopup(),
                );
                
                // *** æ–°å¢ï¼šåŠ¨æ€åˆ é™¤ç›¸å…³äº‹ä»¶ç»‘å®š ***
                // ç‚¹å‡»ä¸‰ä¸ªç‚¹æ˜¾ç¤ºèœå•
                $(document).on("click", ".moment_menu_dots", showMomentMenu);
                
                // ç‚¹å‡»èœå•é¡¹
                $(document).on("click", ".moment_menu_item", function(e) {
                    e.stopPropagation();
                    const action = $(this).data('action');
                    const momentId = $(this).data('moment-id');
                    
                    hideMomentMenu();
                    
                    if (action === 'delete') {
                        confirmDeleteMoment(momentId);
                    }
                });
                
                // ç‚¹å‡»ç¡®è®¤åˆ é™¤å¯¹è¯æ¡†æŒ‰é’®
                $(document).on("click", ".moment_dialog_cancel", function() {
                    $('.moment_confirm_dialog').fadeOut(200, function() {
                        $(this).remove();
                    });
                });
                
                $(document).on("click", ".moment_dialog_confirm", async function() {
                    const momentId = $(this).data('moment-id');
                    const success = await QQ_Delete_Moment(momentId);
                    
                    $('.moment_confirm_dialog').fadeOut(200, function() {
                        $(this).remove();
                    });
                    
                    if (success) {
                        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æˆåŠŸæç¤º
                        console.log('åŠ¨æ€åˆ é™¤æˆåŠŸ');
                    } else {
                        console.error('åŠ¨æ€åˆ é™¤å¤±è´¥');
                    }
                });
                
                // ç‚¹å‡»ç©ºç™½åŒºåŸŸéšè—èœå•
                $(document).on("click", function() {
                    hideMomentMenu();
                });
                
                // é˜²æ­¢èœå•å†…ç‚¹å‡»äº‹ä»¶å†’æ³¡
                $(document).on("click", ".moment_menu_dropdown", function(e) {
                    e.stopPropagation();
                });
                
                // é˜²æ­¢å¯¹è¯æ¡†å†…ç‚¹å‡»äº‹ä»¶å†’æ³¡
                $(document).on("click", ".moment_confirm_dialog > div", function(e) {
                    e.stopPropagation();
                });
                $(document).on("click", "#cancel-setting-btn", () =>
                    closeSettingPopup(),
                );
                $(document).on("click", "#save-setting-btn", () =>
                    saveSettingAndClose(),
                );
                $(document).on(
                    "click",
                    "#randomcolor-setting-btn",
                    function () {
                        const { bgColor, textColor } = generateBubbleColor();
                        $("#bubble-color").val(bgColor);
                        $("#bubble-color-input").val(bgColor);
                        $("#text-color").val(textColor);
                        $("#text-color-input").val(textColor);
                        $("#chat-setting-preview").each(function () {
                            this.style.setProperty(
                                "background-color",
                                bgColor,
                                "important",
                            );
                            const spans = this.querySelectorAll("span");
                            spans.forEach((span) => {
                                span.style.setProperty(
                                    "color",
                                    textColor,
                                    "important",
                                );
                            });
                        });
                    },
                );
                // *** å¯ç”¨åŠ¨æ€è¯„è®ºåŠŸèƒ½ ***
            $(document).on("click", ".moment_comment", QQ_Moment_Comment);
            
            // *** æ–°å¢ï¼šæ”¯æŒå›è½¦é”®å‘é€è¯„è®º ***
            $(document).on("keypress", ".user_moment input[type='text']", function(e) {
                if (e.which === 13) { // å›è½¦é”®
                    const $sendButton = $(this).siblings('.moment_comment');
                    if ($sendButton.length > 0) {
                        $sendButton.click();
                    }
                }
            });
                $(document).on("click", "#QQ_chat_send-btn", (event) =>
                    QQ_SendMsg(event),
                );
                $(document).on("dblclick", ".Chat_MyHead", (e) => QQ_Roll(e));
                $(document).on("click", ".QQ_chat_voice", (e) =>
                    QQ_Voice2Text(e),
                );
                $(document).on("click", ".music-container", (e) =>
                    QQ_MusicPlay(e),
                );
                $(document).on("click", ".popup-overlay", function (e) {
                    if (e.target === this) {
                        closeSettingPopup();
                    }
                });
                $(document).on("click", ".top", function () {
                    if ($(".discord").css("display") == "none") {
                        App_Load("discord");
                    } else {
                        App_Load("QQ");
                    }
                });
                $(document).on("click", ".discord-top-return", () =>
                    App_Load("QQ"),
                );
                $(document).on("click", ".app-svg-div[data-app='QQ']", () =>
                    App_Load("QQ"),
                );
                $(document).on(
                    "click",
                    ".app-svg-div[data-app='twitter']",
                    () => App_Load("twitter"),
                );
                // æ·»åŠ è¾“å…¥æ¡†å›è½¦äº‹ä»¶ç›‘å¬
                $(document).on("keydown", ".userInput", function (e) {
                    QQ_EnterPress(e, this);
                });
                $(document).on(
                    "keydown",
                    ".discord-thread-input-userinput",
                    function (e) {
                        Discord_EnterPress(e, this);
                    },
                );
                $(document).on("click", ".discord-card", (e) =>
                    Discord_LoadThread(e),
                );
                $(document).on(
                    "click",
                    ".discord-thread-top-return",
                    function () {
                        $(".discord-homepage").show();
                        $(".discord-thread-list").hide();
                    },
                );
                $(document).on("click", ".discord-cardget", function () {
                    triggerSlash("/send æŸ¥çœ‹discordå¸–å­å†…å®¹|/trigger");
                });
                $(document).on(
                    "click",
                    ".discord_thread-input-sendbutton",
                    (e) => Discord_Send(e),
                );
                $(document).on(
                    "input",
                    ".discord-thread-input-userinput",
                    (e) => Discord_input(e),
                );
                // é¦–å…ˆï¼Œå°è¯•ä»èŠå¤©å¤‡ä»½ä¸­æ¢å¤å†å²è®°å½•
                console.log("åˆå§‹åŒ–æµç¨‹ï¼šå¼€å§‹åŠ è½½èŠå¤©è®°å½•å¤‡ä»½...");
                const restoredFromBackup = await QQ_Load_Chat_Backup();

                // ç¬¬äºŒé˜¶æ®µï¼šå¢å¼ºç¾¤èŠå…ƒæ•°æ®
                console.log("åˆå§‹åŒ–æµç¨‹ï¼šå¼€å§‹å¢å¼ºç¾¤èŠå…ƒæ•°æ®...");
                await QQ_Enhance_Group_Metadata();

                const message = System_TagCompletion(
                    await ST.GetCurrentMessages(),
                );

                if (!restoredFromBackup) {
                    // å¦‚æœä»å¤‡ä»½åŠ è½½å¤±è´¥ï¼ˆæ¯”å¦‚æ–°ç”¨æˆ·ï¼‰ï¼Œåˆ™å°è¯•è§£æå½“å‰æ¥¼å±‚çš„æ—§æ ¼å¼æ¶ˆæ¯ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
                    console.log('å¤‡ä»½åŠ è½½å¤±è´¥ï¼Œå°è¯•è§£æå½“å‰æ¥¼å±‚æ¶ˆæ¯...');
                let match = message.match(/msg_start([\s\S]+?)msg_end/);
                if (match) {
                        console.log(`è§£æå½“å‰æ¥¼å±‚èŠå¤©è®°å½•ï¼š\n${match[1].trim()}`);
                    await QQ_Msg_Parse(match[1].trim());
                    if (!match[1].match(/\S/)) {
                        await QQ_Save_Msg();
                    }
                    }
                }
                const matches = message.matchAll(
                    /moment_start([\s\S]+?)moment_end/g,
                );
                if (matches) {
                    console.log(`è§£æåŠ¨æ€å†…å®¹!!!!!!!!!!!!!!!`);
                    for (const m of matches) {
                        QQ_Moment_Parse(m[1].trim());
                    }
                }
                let discords = message.matchAll(
                    /(?:discord_start|<discord>)([\S\s]+?)(?:discord_end|<\/discord>)/g,
                );
                if (discords) {
                    console.log(`è§£æè®ºå›å†…å®¹!!!!!!!!!!!!!!!`);
                    for (const discord of discords) {
                        Discord_Parse(discord[1]);
                    }
                }
                console.log(`ç¾¤èŠåˆ—è¡¨:${QQ_Groups.join(",")}`);
                
                // 4. æ‰€æœ‰æ•°æ®åŠ è½½å®Œæˆåï¼Œæœ€åæ‰§è¡ŒUIæ¸²æŸ“å’Œå¯¼èˆª
                console.log("é¡µé¢åˆå§‹åŒ–å®Œæˆï¼Œå³å°†å¯¼èˆªåˆ°é»˜è®¤é¡µé¢...");
                setTimeout(() => {
                    QQ_Nav("people");
                    QQ_UpdateMessageList();
                    if (typeof initContactSearch === 'function') {
                        initContactSearch();
                    }
                    if (typeof initContactGroups === 'function') {
                        initContactGroups();
                    }
                    // å»¶è¿Ÿåˆå§‹åŒ–ç‚¹èµåŠŸèƒ½ï¼Œç¡®ä¿ä¸ä¸ä¼˜å…ˆçº§é€»è¾‘å†²çª
                    setTimeout(() => {
                        if (typeof QQ_InitMomentLikes === 'function') {
                            QQ_InitMomentLikes();
                        }
                    }, 800);
                }, 500);
            }
            //space_init();
            console.log(`4.11`);
            init();
            
            
            // ç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½åæ›´æ–°æ¶ˆæ¯åˆ—è¡¨
            setTimeout(() => {
                QQ_UpdateMessageList();
                
                // é¢å¤–çš„æœç´¢åŠŸèƒ½åˆå§‹åŒ–æ£€æŸ¥ï¼ˆç”¨äºSillyTavernç¯å¢ƒï¼‰
                if (document.getElementById('contact_search_input') && 
                    !document.getElementById('contact_search_input').hasAttribute('data-initialized')) {
                    console.log("æ‰§è¡Œé¢å¤–çš„æœç´¢åŠŸèƒ½åˆå§‹åŒ–");
                    initContactSearch();
                }
            }, 1000);
            async function WorldBookUpdate() {
                let text = {
                    "æ‰‹æœº-æ ¼å¼1-æ ¼å¼å¼€å¤´": _1_raw_namespaceObject,
                    "æ‰‹æœº-æ ¼å¼2-QQèŠå¤©": _2_QQ_raw_namespaceObject,
                    "æ‰‹æœº-æ ¼å¼3-QQç©ºé—´": _3_QQ_raw_namespaceObject,
                    "æ‰‹æœº-æ ¼å¼4-discordè®ºå›": _4_discord_raw_namespaceObject,
                    "æ‰‹æœº-æ ¼å¼999-æ ¼å¼ç»“å°¾": _999_raw_namespaceObject,
                    "æ‰‹æœº-ç•Œé¢åŸºæœ¬è®¾ç½®": src_worldbook_raw_namespaceObject_0,
                    // "æ‰‹æœº-è§’è‰²"æ¡ç›®ä¸åº”è¯¥è¢«è‡ªåŠ¨æ›´æ–°ï¼Œåº”è¯¥ä¿ç•™ç”¨æˆ·çš„æ•°æ®
                    "æ‰‹æœº-è§’è‰²": `[a]
å¤´åƒ=http://sharkpan.xyz/f/mQFW/mmexport1736279065029.png
[b]
å¤´åƒ=http://sharkpan.xyz/f/BZsa/mmexport1736279012663.png
[ç›¸äº²ç›¸çˆ±ä¸€å®¶äºº]
ç±»å‹=ç¾¤èŠ
æˆå‘˜=a,b
å¤´åƒ=http://sharkpan.xyz/f/z0WU5/mmexport1736971020657.gif`,
                    "æ‰‹æœº-è¡¨æƒ…åŒ…å­˜æ”¾": _worldbook_raw_namespaceObject,
                    "æ‰‹æœº-éšæœºå¤´åƒ": _raw_namespaceObject,
                };
                const nowver = Phone_Settings.readValue(
                    "ä¸‹é¢æ˜¯åŸºæœ¬è®¾ç½®",
                    "ä¸–ç•Œä¹¦ç‰ˆæœ¬",
                );
                if (nowver && Number(version) <= Number(nowver)) {
                    console.log(`ä¸–ç•Œä¹¦ç‰ˆæœ¬:${nowver} ç¬¦åˆè¦æ±‚ä¸æ›´æ–°`);
                    return;
                }
                console.log(`ä¸–ç•Œä¹¦ç‰ˆæœ¬:${nowver}`);
                console.log(`å¼€å§‹è‡ªåŠ¨æ›´æ–°ä¸–ç•Œä¹¦`);
                for (let entry of entries) {
                    if (entry.comment == "æ‰‹æœº-æ ¼å¼") {
                        try {
                            await deleteLorebookEntry(worldbook, entry.uid);
                        } catch {
                            console.log(`åˆ é™¤æ‰‹æœº-æ ¼å¼ä¸–ç•Œä¹¦å¤±è´¥`);
                        }
                    }
                }
                let ini = new MyINI();
                ini.loadText(worldlistraw_namespaceObject);
                
                // ç‰¹æ®Šå¤„ç†"æ‰‹æœº-è§’è‰²"æ¡ç›®ï¼šæ£€æŸ¥æ˜¯å¦éœ€è¦é»˜è®¤è§’è‰²
                const roleEntry = entries.find(entry => entry.comment === "æ‰‹æœº-è§’è‰²");
                if (!roleEntry) {
                    console.log('ğŸ“± æ‰‹æœº-è§’è‰²æ¡ç›®ä¸å­˜åœ¨ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ é»˜è®¤è§’è‰²...');
                    // æ¡ç›®ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤è§’è‰²å†…å®¹
                    console.log('ğŸ‘¥ é¦–æ¬¡åˆ›å»ºæ‰‹æœº-è§’è‰²æ¡ç›®ï¼Œæ·»åŠ é»˜è®¤è§’è‰²aå’Œè§’è‰²b');
                } else {
                    // æ¡ç›®å­˜åœ¨ï¼Œæ£€æŸ¥å†…å®¹æ˜¯å¦ä¸ºç©º
                    const content = roleEntry.content.trim();
                    if (!content || content.length === 0) {
                        console.log('ğŸ“± æ‰‹æœº-è§’è‰²æ¡ç›®å­˜åœ¨ä½†ä¸ºç©ºï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ é»˜è®¤è§’è‰²...');
                        // å¦‚æœæ¡ç›®ä¸ºç©ºï¼Œæ·»åŠ é»˜è®¤è§’è‰²
                        text["æ‰‹æœº-è§’è‰²"] = text["æ‰‹æœº-è§’è‰²"]; // ä¿æŒé»˜è®¤å†…å®¹
                        console.log('ğŸ‘¥ è§’è‰²æ¡ç›®ä¸ºç©ºï¼Œå°†æ·»åŠ é»˜è®¤è§’è‰²aå’Œè§’è‰²b');
                    } else {
                        // æ£€æŸ¥æ˜¯å¦æœ‰å®é™…çš„è§’è‰²å®šä¹‰
                        const lines = content.split('\n');
                        const roleLines = lines.filter(line => 
                            line.trim().startsWith('[') && 
                            line.trim().endsWith(']') && 
                            line.trim().length > 2
                        );
                        
                        if (roleLines.length === 0) {
                            console.log('ğŸ“± æ‰‹æœº-è§’è‰²æ¡ç›®å­˜åœ¨ä½†æ— è§’è‰²å®šä¹‰ï¼Œå°†æ·»åŠ é»˜è®¤è§’è‰²...');
                            // ä¿æŒé»˜è®¤å†…å®¹ä»¥ä¾¿åç»­æ·»åŠ 
                        } else {
                            console.log('ğŸ­ æ‰‹æœº-è§’è‰²æ¡ç›®ä¸­å·²æœ‰è§’è‰²å®šä¹‰ï¼Œè·³è¿‡é»˜è®¤è§’è‰²æ·»åŠ ');
                            // ä»è¦åˆ›å»ºçš„æ¡ç›®ä¸­ç§»é™¤æ‰‹æœº-è§’è‰²ï¼Œé¿å…è¦†ç›–ç”¨æˆ·æ•°æ®
                            delete text["æ‰‹æœº-è§’è‰²"];
                        }
                    }
                }
                
                for (const section of ini.getAllSections()) {
                    let targetEntry = entries.find(
                        (entry) => entry.comment == section,
                    );
                    if (targetEntry && ini.readValue(section, "è¦†ç›–") != "çœŸ") {
                        continue;
                    }
                    if (targetEntry) {
                        console.log(`${section}å­˜åœ¨,å¼€å§‹ä¿®æ”¹`);
                        await setLorebookEntries(worldbook, [
                            {
                                uid: targetEntry.uid,
                                content: text[section],
                                key: ini
                                    .readValue(section, "å…³é”®è¯")
                                    .split(",")
                                    .map((item) => item.trim()),
                                depth: ini.readValue(section, "æ·±åº¦"),
                                type:
                                    ini.readValue(section, "ç±»å‹") == "è“ç¯"
                                        ? "constant"
                                        : "selective",
                                exclude_recursion: true,
                                order: Number(ini.readValue(section, "é¡ºåº")),
                                enabled: true,
                            },
                        ]);
                        console.log(`${section}ä¿®æ”¹å®Œæˆ`);
                    } else {
                        console.log(`${section}ä¸å­˜åœ¨,å¼€å§‹åˆ›å»º`);
                        
                        let contentToCreate = text[section];
                        
                        // å¦‚æœå†…å®¹ä¸å­˜åœ¨ï¼ˆè¢«åˆ é™¤ï¼‰ï¼Œè·³è¿‡åˆ›å»º
                        if (contentToCreate === undefined) {
                            console.log(`${section}å†…å®¹ä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º`);
                            continue;
                        }
                        
                        await createLorebookEntry(worldbook, {
                            comment: section,
                            key: ini
                                .readValue(section, "å…³é”®è¯")
                                .split(",")
                                .map((item) => item.trim()),
                            content: contentToCreate,
                            position: "at_depth_as_system",
                            type:
                                ini.readValue(section, "ç±»å‹") == "è“ç¯"
                                    ? "constant"
                                    : "selective",
                            depth: ini.readValue(section, "æ·±åº¦"),
                            exclude_recursion: true,
                            order: Number(ini.readValue(section, "é¡ºåº")),
                            enabled: true,
                        });
                    }
                }
                Phone_Settings.writeValue(
                    "ä¸‹é¢æ˜¯åŸºæœ¬è®¾ç½®",
                    "ä¸–ç•Œä¹¦ç‰ˆæœ¬",
                    version,
                );
                // for (let entry of entries) {
                //   if (
                //     entry.comment == "æ‰‹æœº-ç•Œé¢åŸºæœ¬è®¾ç½®" ||
                //     entry.comment == "æ‰‹æœºç•Œé¢åŸºæœ¬è®¾ç½®"
                //   ) {
                //     await setLorebookEntries(worldbook,
                //       [{
                //         uid: entry.uid,
                //         content: Phone_Settings.getAllText(),
                //       }]
                //     );
                //   }
                // }
                // é‡æ–°è·å–æ›´æ–°åçš„ä¸–ç•Œä¹¦æ¡ç›®
                entries = await getLorebookEntries(worldbook);
                triggerSlash("/echo severity=success æ‰‹æœºä¸–ç•Œä¹¦è‡ªåŠ¨æ›´æ–°æˆåŠŸ");
                triggerSlash("/echo severity=success ç‚¹å‡»æ‰‹æœºlogoå¯ä»¥åˆ‡æ¢é¡µé¢");
            }
            function System_TagCompletion(content) {
                if (!content) {
                    return "";
                }
                content = content.replace(
                    /<(?:think|thinking)>[\s\S]+?<\/(?:think|thinking)>/gi,
                    "",
                );
                // æ³¨é‡Šæ‰é”™è¯¯çš„è‡ªåŠ¨è¡¥å……é€»è¾‘ - ä¸åº”è¯¥è‡ªåŠ¨ä¸ºæ¯ä¸ªmoment_endæ·»åŠ discord_start
                // let match = content.match(/moment_end[\s\S]*discord_start/);
                // if (!match && content.indexOf("moment_end") > 0) {
                //     content = content.replace(
                //         "moment_end",
                //         "moment_end\ndiscord_start",
                //     );
                // }
                let match = content.match(/MiPhone_start[\s\S]*msg_start/);
                if (!match && content.indexOf("msg_start") > 0) {
                    content = content.replace(
                        "msg_start",
                        "MiPhone_start\nmsg_start",
                    );
                }
                return content;
            }
            function System_AddNpcHead(name, url) {
                if (name in Npc_Settings && Npc_Settings[name].head) {
                    return;
                }
                if (
                    name == UserName ||
                    QQ_CharSettings.getAllSections().includes(name)
                ) {
                    //console.log(`${name}å·²å­˜åœ¨å¤´åƒ,ä¸å†é‡å¤æ·»åŠ `)
                    return;
                }
                if (name in Npc_Settings == false) {
                    Npc_Settings[name] = {};
                }
                if (!url) {
                    url = QQ_GetRandomHead();
                }
                console.log(`ä¸º${name}æ·»åŠ å¤´åƒ${url}`);
                Npc_Settings[name].head = url;
                System_UpdateNpcCss();
            }
            function System_UpdateNpcCss() {
                let cssvalue = "";
                for (let key in Npc_Settings) {
                    try {
                        if (
                            "head" in Npc_Settings[key] == false ||
                            !Npc_Settings[key].head
                        ) {
                            Npc_Settings[key].head = QQ_GetRandomHead();
                            //console.log(`ç»™${key}æ·»åŠ éšæœºå¤´åƒ:${Npc_Settings[key].head}`);
                        }
                        cssvalue += `\n.head[data-name='${key}'] { background-image: url('${Npc_Settings[key].head}') !important;}`;
                        const { bgColor, textColor } = generateBubbleColor();
                        if (
                            "bubble" in Npc_Settings[key] == false ||
                            !Npc_Settings[key].bubble
                        ) {
                            Npc_Settings[key].bubble = bgColor;
                        }
                        if (
                            "text" in Npc_Settings[key] == false ||
                            !Npc_Settings[key].text
                        ) {
                            Npc_Settings[key].text = textColor;
                        }
                        cssvalue += `\n.QQ_chat_msgdiv[data-name='${key}']{
      background-color: ${Npc_Settings[key].bubble} !important;
      span{
      color: ${textColor} !important;}
      }`;
                    } catch (e) {}
                }
                //console.log(`æ–°Npcçš„Css:\n${cssvalue}`);
                $(`style[data-name=AutoNpc]`).text(cssvalue);
                insertOrAssignVariables({
                    Npc_Settings: JSON.stringify(Npc_Settings),
                });
            }
            function generateBubbleColor() {
                // ç”ŸæˆèƒŒæ™¯è‰²å‚æ•°ï¼ˆHSVæ¨¡å‹ï¼‰
                const hueSegments = [0, 60, 120, 180, 240, 300, 360];
                const segmentIndex = Math.floor(Math.random() * 6); // 0-5
                // åœ¨é€‰å®šçš„åŒºé—´å†…éšæœºç”Ÿæˆè‰²ç›¸ï¼ˆé¿å…è·¨åŒºé—´æ··æ‚ï¼‰
                const H = hueSegments[segmentIndex] + Math.random() * 60;
                const S = 30 + Math.random() * 40; // é¥±å’Œåº¦ 30%-70%
                const V = 60 + Math.random() * 30; // äº®åº¦ 60%-90%
                const bgRgb = hsvToRgb(H, S, V);
                const bgHex = rgbToHex(...bgRgb);
                // ç”Ÿæˆäº’è¡¥è‰²
                const complementH = (H + 180) % 360;
                // æé«˜é¥±å’Œåº¦å¹¶åè½¬äº®åº¦
                const textS = Math.min(S + 20, 100); // æé«˜20%é¥±å’Œåº¦
                const textV = 100 - V; // äº®åº¦å–å
                const textRgb = hsvToRgb(complementH, textS, textV);
                const textHex = rgbToHex(...textRgb);
                // è®¡ç®—å¯¹æ¯”åº¦
                const bgLum = calculateLuminance(bgRgb);
                const textLum = calculateLuminance(textRgb);
                const contrastRatio =
                    (Math.max(bgLum, textLum) + 0.05) /
                    (Math.min(bgLum, textLum) + 0.05);
                // æ ¹æ®å¯¹æ¯”åº¦è¿”å›é¢œè‰²ï¼ˆè‡³å°‘4.5:1ï¼‰
                if (contrastRatio >= 4.5) {
                    return { bgColor: bgHex, textColor: textHex };
                } else {
                    // å¯¹æ¯”åº¦ä¸è¶³æ—¶å›é€€åˆ°é»‘ç™½
                    const textColor = bgLum > 0.5 ? "#000000" : "#FFFFFF";
                    return { bgColor: bgHex, textColor };
                }
            }
            /**
             * è®¡ç®—é¢œè‰²çš„ç›¸å¯¹äº®åº¦ï¼ˆèŒƒå›´ 0-1ï¼‰
             * å…¬å¼å‚è€ƒï¼šWCAG 2.0 æ ‡å‡†ï¼ˆhttps://www.w3.org/TR/WCAG20/ï¼‰
             */
            function calculateLuminance([r, g, b]) {
                const [R, G, B] = [r, g, b].map((v) => {
                    v /= 255;
                    return v <= 0.03928
                        ? v / 12.92
                        : Math.pow((v + 0.055) / 1.055, 2.4);
                });
                return 0.2126 * R + 0.7152 * G + 0.0722 * B; // æƒé‡ç³»æ•°
            }
            function hsvToRgb(h, s, v) {
                h /= 360;
                s /= 100;
                v /= 100; // å½’ä¸€åŒ–åˆ° [0,1]
                const i = Math.floor(h * 6);
                const f = h * 6 - i;
                const p = v * (1 - s);
                const q = v * (1 - f * s);
                const t = v * (1 - (1 - f) * s);
                let r, g, b;
                switch (i % 6) {
                    case 0:
                        [r, g, b] = [v, t, p];
                        break;
                    case 1:
                        [r, g, b] = [q, v, p];
                        break;
                    case 2:
                        [r, g, b] = [p, v, t];
                        break;
                    case 3:
                        [r, g, b] = [p, q, v];
                        break;
                    case 4:
                        [r, g, b] = [t, p, v];
                        break;
                    case 5:
                        [r, g, b] = [v, p, q];
                        break;
                }
                // æ‰©å±•ä¸º 0-255 çš„ RGB å€¼
                return [
                    Math.round(r * 255),
                    Math.round(g * 255),
                    Math.round(b * 255),
                ];
            }
            /**
             * RGB è½¬åå…­è¿›åˆ¶
             */
            function rgbToHex(...rgb) {
                return (
                    "#" +
                    rgb.map((x) => x.toString(16).padStart(2, "0")).join("")
                );
            }
            function Discord_EnterPress(e, element) {
                if (e.key !== "Enter") {
                    return;
                }
                if (!element) return;
                const value = $(element).val();
                if (!value) {
                    return;
                }
                const $closest = $(element).closest(".discord-thread");
                const id = $closest.attr("data-id");
                const result = `åœ¨å¸–å­${id}ä¸­å›å¤:\n${value}`;
                triggerSlash(`/send ${result}|/trigger`);
                $(element).val("").trigger("input");
                const commentlist = $closest.find(
                    ".discord-thread-comment-list",
                );
                const comment = _.template(discord_discord_thread_comment)({
                    name: UserName,
                    content: value,
                    creator: "",
                    isuser: " user_avatar",
                });
                commentlist.append(comment);
                const scroll = $closest.find(".discord-scroll-container");
                scroll.scrollTop(scroll[0].scrollHeight);
            }
            function Discord_Send(event) {
                event.stopPropagation();
                if (!event.currentTarget) return;
                const $closest = $(event.currentTarget).closest(
                    ".discord-thread",
                );
                const value = $closest
                    .find(".discord-thread-input-userinput")
                    .val();
                const id = $closest.attr("data-id");
                const result = `åœ¨å¸–å­${id}ä¸­å›å¤:\n${value}`;
                triggerSlash(`/send ${result}|/trigger`);
                $closest
                    .find(".discord-thread-input-userinput")
                    .val("")
                    .trigger("input");
                const commentlist = $closest.find(
                    ".discord-thread-comment-list",
                );
                const comment = _.template(discord_discord_thread_comment)({
                    name: UserName,
                    content: value,
                    creator: "",
                    isuser: " user_avatar",
                });
                commentlist.append(comment);
                const scroll = $closest.find(".discord-scroll-container");
                scroll.scrollTop(scroll[0].scrollHeight);
            }
            function Discord_Parse(content) {
                const matches = content.matchAll(
                    /<([0-9a-zA-Z]+)>([\s\S+]*?)<\/([0-9a-zA-Z]+)>/g,
                );
                if (!matches) {
                    console.log(`è®ºå›åŒ¹é…å¤±è´¥,è¿”å›!`);
                    return;
                }
                for (const match of matches) {
                    Discord_AddCard(match[1], match[2]);
                }
            }
            function Discord_AddCard(id, content) {
                if (!id) return;
                console.log(`æ·»åŠ è®ºå›å†…å®¹!!!!!!!!!`);
                let comment_list;
                let author = "";
                let map = new Map();
                let match = content.match(/<æ­£æ–‡>([\s\S+]+?)<\/æ­£æ–‡>/);
                if (!match) {
                    console.log(`åŒ¹é…æ­£æ–‡æ ‡ç­¾å¤±è´¥\n${content}`);
                    return;
                }
                let matches = match[1].matchAll(/(.+?)[:ï¼š]\s*(.+)/g);
                for (const m of matches) {
                    if (m[1].trim() == "å¸–å­æ€»è¯„è®ºæ•°-") {
                        map.set("å¸–å­æ€»è¯„è®ºæ•°", m[2].trim());
                    } else {
                        map.set(m[1].trim(), m[2].trim());
                    }
                }
                console.log(
                    `åŒ¹é…åˆ°è®ºå›å†…å®¹:\n${JSON.stringify(Object.fromEntries(map))}`,
                );
                let img = map.get("å¸–å­é…å›¾æè¿°")?.match(/\[img-(.+?)\]/);
                if (img) {
                    map.set("å¸–å­é…å›¾æè¿°", img[1]);
                }
                if (map.get("å¸–å­æ ‡ç­¾")) {
                    let tags = map.get("å¸–å­æ ‡ç­¾").split("/");
                    let localtag = "";
                    for (const tag of tags) {
                        localtag += `<div class="discord-card-tag">${tag}</div>`;
                    }
                    if (localtag) {
                        map.set("å¸–å­æ ‡ç­¾", localtag);
                    }
                }
                const html = _.template(discord_discord_card)({
                    id: id,
                    tag: map.get("å¸–å­æ ‡ç­¾"),
                    time: map.get("è·ç¦»å‘å¸–è¿‡å»æ—¶é—´"),
                    name: map.get("å‘å¸–äºº"),
                    cardtilte: map.get("å¸–å­æ ‡é¢˜"),
                    content: map.get("å¸–å­æ­£æ–‡"),
                    img: map.get("å¸–å­é…å›¾æè¿°"),
                    messages: map.get("å¸–å­æ€»è¯„è®ºæ•°"),
                    likes: map.get("å¸–å­æ€»ç‚¹èµæ•°"),
                });
                $(".discord-cardlist").append(html);
                $(".discord-cardget").hide();
                const thread = _.template(discord_discord_thread)({
                    id: id,
                    tag: map.get("å¸–å­æ ‡ç­¾"),
                    time: map.get("è·ç¦»å‘å¸–è¿‡å»æ—¶é—´"),
                    name: map.get("å‘å¸–äºº"),
                    threadtilte: map.get("å¸–å­æ ‡é¢˜"),
                    content: map.get("å¸–å­æ­£æ–‡"),
                    img: map.get("å¸–å­é…å›¾æè¿°"),
                    messages: map.get("å¸–å­æ€»è¯„è®ºæ•°"),
                    likes: map.get("å¸–å­æ€»ç‚¹èµæ•°"),
                    isuser:
                        map.get("å‘å¸–äºº").trim() == UserName
                            ? " user_avatar"
                            : "",
                });
                System_AddNpcHead(map.get("å‘å¸–äºº") ?? "æœªçŸ¥ç”¨æˆ·");
                $(".discord-thread-list").append(thread);
                comment_list = $(`.discord-thread[data-id=${id}]`).find(
                    ".discord-thread-comment-list",
                );
                match = content.match(/<è¯„è®º>([\s\S+]+?)<\/è¯„è®º>/);
                if (match) {
                    let matches = match[1].matchAll(/^\s*(.+?)--\s*(.+)$/gm);
                    if (matches) {
                        for (let m of matches) {
                            const comment = _.template(
                                discord_discord_thread_comment,
                            )({
                                name: m[1].trim(),
                                content: AtMessage(m[2]),
                                creator:
                                    map.get("å‘å¸–äºº") == m[1] ||
                                    QQ_CharSettings.getAllSections().includes(
                                        m[1],
                                    )
                                        ? " discord-name-creator"
                                        : "",
                                isuser:
                                    m[1].trim() == UserName
                                        ? " user_avatar"
                                        : "",
                            });
                            System_AddNpcHead(m[1]);
                            comment_list.append(comment);
                        }
                    }
                }
            }
            function AtMessage(content) {
                const match = content.match(/(@.{1,8}?) /);
                if (match) {
                    content = content.replace(
                        match[1],
                        `<span style='color:#587ef5'>${match[1]}</span>`,
                    );
                }
                return content;
            }
            function Discord_AddCard_Old(id, content) {
                console.log(`æ·»åŠ è®ºå›å†…å®¹!!!!!!!!!`);
                let comment_list;
                let author = "";
                for (const str of content.split(/\r?\n/g)) {
                    let match = str.match(
                        /(.+?)--(.+?)--(.+?)--(.+?)--(.+?)--(.+?)--(.+?)--(.+)/,
                    );
                    if (match) {
                        const html = _.template(discord_card)({
                            id: id,
                            tag: match[5],
                            time: match[6],
                            name: match[1],
                            cardtilte: match[2],
                            content: match[3],
                            img: match[4],
                            messages: match[7],
                            likes: match[8],
                        });
                        $(".discord-cardlist").append(html);
                        const thread = _.template(discord_thread)({
                            id: id,
                            tag: match[5],
                            time: match[6],
                            name: match[1],
                            threadtilte: match[2],
                            content: match[3],
                            img: match[4],
                            messages: match[7],
                            likes: match[8],
                        });
                        System_AddNpcHead(match[1]);
                        $(".discord-thread-list").append(thread);
                        comment_list = $(`.discord-thread[data-id=${id}]`).find(
                            ".discord-thread-comment-list",
                        );
                        author = match[1];
                        continue;
                    }
                    match = str.match(/^(.+?)[:ï¼š](.+)$/m);
                    if (match && comment_list && comment_list.length > 0) {
                        const comment = _.template(discord_thread_comment)({
                            name: match[1],
                            content: match[2],
                            creator:
                                author == match[1]
                                    ? " discord-name-creator"
                                    : "",
                            isuser: match[1] == UserName ? " user_avatar" : "",
                        });
                        System_AddNpcHead(match[1]);
                        comment_list.append(comment);
                    }
                }
            }
            function Discord_LoadThread(event) {
                event.stopPropagation();
                if (!event.currentTarget) return;
                const id = $(event.currentTarget).attr("data-id");
                if (!id) {
                    return;
                }
                let ThreadPage = $(`.discord-thread[data-id=${id}]`);
                if (ThreadPage.length === 0) {
                    return;
                }
                $(`.discord-thread`).hide();
                ThreadPage.show();
                $(".discord-homepage").hide();
                $(".discord-thread-list").show();
            }
            function Discord_input(event) {
                event.stopPropagation();
                if (!event.currentTarget) return;
                if ($(event.currentTarget).val()) {
                    console.log(`æ˜¾ç¤º`);
                    $(".discord-thread-input-button").hide();
                    $(".discord-thread-input-focus-button").show();
                } else {
                    console.log(`éšè—`);
                    $(".discord-thread-input-button").show();
                    $(".discord-thread-input-focus-button").hide();
                }
            }
            async function QQ_MusicPlay(event) {
                event.stopPropagation();
                if (!event.currentTarget) return;
                const $element = $(event.currentTarget);
                const musicname = $element.find(".music-name")?.text().trim();
                const singer = $element.find(".music-author")?.text().trim();
                if (!musicname) {
                    QQ_Error("è·å–æ­Œæ›²ä¿¡æ¯å¤±è´¥");
                    return;
                }
                const $playbutton = $element.find(".icon-music-play");
                const $stopbutton = $element.find(".icon-music-stop");
                // ç«‹å³åˆ‡æ¢æŒ‰é’®çŠ¶æ€
                if (!$playbutton.is(":hidden")) {
                    // ğŸ”´ å…ˆæ”¹å˜ç•Œé¢çŠ¶æ€
                    $playbutton.hide();
                    $stopbutton.show();
                    $element.addClass("loading"); // æ·»åŠ åŠ è½½åŠ¨ç”»
                    QQ_Music.lastelement = $element;
                    try {
                        // å¼‚æ­¥è·å–éŸ³æº
                        let source = await WY_MusicGetUrl(musicname, singer);
                        if (!source?.url) {
                            console.log(`ç½‘æ˜“äº‘è·å–å¤±è´¥,å¼€å§‹åœ¨QQéŸ³ä¹ä¸­æœç´¢`);
                            source = await QQ_MusicGetUrl(musicname);
                            if (!source || !source.url) {
                                throw new Error("æ— å¯ç”¨éŸ³æº");
                            }
                        }
                        // è®¾ç½®æ–°éŸ³æº
                        QQ_Music.audio.src = source.url;
                        if (source.cover) {
                            $element
                                .find(".music-img")
                                .css(
                                    "background-image",
                                    `url('${source.cover}')`,
                                );
                            $element.find(".music-img").show();
                        }
                        // è‡ªåŠ¨æ’­æ”¾
                        await QQ_Music.audio.play();
                        // æ›´æ–°å…¶ä»–å…ƒç´ çŠ¶æ€
                        if (
                            QQ_Music.lastelement &&
                            !QQ_Music.lastelement.is($element)
                        ) {
                            QQ_Music.lastelement
                                .find(".icon-music-stop")
                                .hide();
                            QQ_Music.lastelement
                                .find(".icon-music-play")
                                .show();
                        }
                    } catch (error) {
                        console.error("æ’­æ”¾å¤±è´¥:", error);
                        QQ_Error("æ’­æ”¾å¤±è´¥");
                        // ğŸ”´ å¤±è´¥æ—¶å›æ»šæŒ‰é’®çŠ¶æ€
                        $playbutton.show();
                        $stopbutton.hide();
                    } finally {
                        $element.removeClass("loading");
                    }
                } else {
                    // æš‚åœé€»è¾‘ä¿æŒä¸å˜
                    QQ_Music.audio.pause();
                    $playbutton.show();
                    $stopbutton.hide();
                }
            }
            async function QQ_MusicGetUrl(name) {
                try {
                    // è·å–æ­Œæ›²åˆ—è¡¨
                    name = name.replace(/\s/g, "");
                    let cover = "";
                    const result = await Http_Get(
                        `https://api.vkeys.cn/v2/music/tencent?word=${name}`,
                    );
                    if (!result?.data?.length) {
                        QQ_Error("æœç´¢æ­Œæ›²å¤±è´¥");
                        return;
                    }
                    // æå–æ‰€æœ‰id
                    let ids = [];
                    for (const data of result.data) {
                        if (!cover && data.cover) {
                            cover = data.cover;
                        }
                        if (data.id) {
                            ids.push(data.id);
                        }
                        if (data.grp) {
                            for (const grp of data.grp) {
                                if (grp.id) {
                                    ids.push(grp.id);
                                }
                            }
                        }
                    }
                    console.log(`idæ•°é‡:${ids.length}`);
                    // éå†éŸ³è´¨ç»„æ£€æµ‹å¯ç”¨éŸ³æº
                    for (const id of ids) {
                        try {
                            // è·å–å…·ä½“éŸ³æºURL
                            console.log(`å‡†å¤‡æ£€æµ‹éŸ³æº ID:${id}`);
                            const r = await Http_Get(
                                `https://api.vkeys.cn/v2/music/tencent?id=${id}`,
                            );
                            if (!r?.data?.url) continue;
                            // å¼‚æ­¥æ£€æµ‹éŸ³æºå¯ç”¨æ€§
                            const isAvailable = await checkAudioAvailability(
                                r.data.url,
                            );
                            if (isAvailable) {
                                console.log(`æ‰¾åˆ°å¯ç”¨éŸ³æº: ${r.data.url}`);
                                return {
                                    url: r.data.url,
                                    cover: cover,
                                };
                            }
                        } catch (e) {
                            console.warn(`éŸ³æºæ£€æµ‹å¤±è´¥: ${id}`, e);
                        }
                    }
                    QQ_Error("æ²¡æœ‰æ‰¾åˆ°å¯ç”¨éŸ³æº");
                } catch (e) {
                    QQ_Error("æ­Œæ›²æœç´¢å¼‚å¸¸");
                    console.error("è·å–éŸ³æºå¤±è´¥:", e);
                }
            }
            async function WY_MusicGetUrl(name, singer) {
                let url = `https://api.vkeys.cn/v2/music/netease?word=${name}`;
                if (singer) {
                    url += `-${singer}`;
                }
                let result = await Http_Get(url);
                if (!result) return;
                let cover = "";
                let ids = [];
                for (const data of result.data) {
                    if (!cover && data.cover) {
                        cover = data.cover;
                    }
                    if (data.id) {
                        ids.push(data.id);
                    }
                }
                for (const id of ids) {
                    try {
                        // è·å–å…·ä½“éŸ³æºURL
                        console.log(`å‡†å¤‡æ£€æµ‹éŸ³æº ID:${id}`);
                        const r = await Http_Get(
                            `https://api.vkeys.cn/v2/music/netease?id=${id}`,
                        );
                        if (!r?.data?.url) continue;
                        // å¼‚æ­¥æ£€æµ‹éŸ³æºå¯ç”¨æ€§
                        const isAvailable = await checkAudioAvailability(
                            r.data.url,
                        );
                        if (isAvailable) {
                            console.log(`æ‰¾åˆ°å¯ç”¨éŸ³æº: ${r.data.url}`);
                            return {
                                url: r.data.url,
                                cover: cover,
                            };
                        }
                    } catch (e) {
                        console.warn(`éŸ³æºæ£€æµ‹å¤±è´¥: ${id}`, e);
                    }
                }
            }
            /** éŸ³é¢‘å¯ç”¨æ€§æ£€æµ‹å‡½æ•° */
            async function checkAudioAvailability(url) {
                return new Promise((resolve) => {
                    // åˆ›å»ºæµ‹è¯•ç”¨éŸ³é¢‘å¯¹è±¡
                    const tester = new Audio();
                    let timer;
                    // æˆåŠŸåŠ è½½å…ƒæ•°æ®
                    const onLoaded = () => {
                        cleanup();
                        resolve(true);
                    };
                    // å‘ç”Ÿé”™è¯¯æˆ–è¶…æ—¶
                    const onError = () => {
                        cleanup();
                        resolve(false);
                    };
                    // æ¸…ç†äº‹ä»¶ç›‘å¬
                    const cleanup = () => {
                        tester.removeEventListener("loadedmetadata", onLoaded);
                        tester.removeEventListener("error", onError);
                        clearTimeout(timer);
                        tester.src = ""; // é‡Šæ”¾èµ„æº
                    };
                    // è®¾ç½®æ£€æµ‹å‚æ•°
                    tester.preload = "metadata";
                    tester.src = url;
                    timer = setTimeout(onError, 3000); // 3ç§’è¶…æ—¶
                    // ç»‘å®šäº‹ä»¶ç›‘å¬
                    tester.addEventListener("loadedmetadata", onLoaded);
                    tester.addEventListener("error", onError);
                });
            }
            function Http_Get(url) {
                return new Promise((resolve, reject) => {
                    $.ajax({
                        url: url,
                        method: "GET",
                        timeout: 10000,
                        success: function (data, status) {
                            resolve(data); // æˆåŠŸæ—¶è¿”å›æ•°æ®
                        },
                        error: function (xhr, status, error) {
                            if (status === "timeout") {
                                console.error("è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é‡è¯•");
                            } else {
                                console.error("è¯·æ±‚å¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯ï¼š", error);
                            }
                            resolve(null);
                            //reject(error); // å¤±è´¥æ—¶æŠ›å‡ºé”™è¯¯
                        },
                    });
                });
            }
            function JsonYamlParse(content) {
                content = content.replace(/\{\{user\}\}/g, UserName);
                try {
                    let json = JSON.parse(content);
                    return json;
                } catch {
                    console.log(`jsonè§£æå¤±è´¥`);
                }
                try {
                    let simple = Simpleformat(content);
                    if (simple) {
                        console.log(`ç®€å•æ ¼å¼è½¬æ¢æˆåŠŸ:\n${simple}`);
                        return simple;
                    } else {
                        console.log(`ç®€å•è½¬æ¢å¤±è´¥`);
                    }
                } catch {}
                try {
                    let yaml = YAML.parse(content);
                    console.log(`yamlè§£ææˆåŠŸ`);
                    return yaml;
                } catch {
                    //console.log(`yamlè§£æå¤±è´¥:\n${content}`);
                }
                try {
                    content = content.replace(/^\s*ç¾¤èŠ:/m, "ç¾¤èŠ:");
                    content = content.replace(/^\s*ç§èŠ:/m, "ç§èŠ:");
                    content = fixYamlSingleQuotes(content);
                    //console.log(`ç¬¬ä¸€æ¬¡ä¿®å¤åçš„yamlæ–‡æœ¬:\n${content}`);
                    if (!content) {
                        return null;
                    }
                    let yaml = YAML.parse(content);
                    return yaml;
                } catch {
                    console.log(`ç¬¬ä¸€æ¬¡yamlä¿®å¤å¤±è´¥`);
                }
                try {
                    content = fixYamlSingleQuotes(
                        content.replace(/\\'/g, "''"),
                    );
                    //console.log(`ç¬¬äºŒæ¬¡ä¿®å¤åçš„yamlæ–‡æœ¬:\n${content}`);
                    if (!content) {
                        return null;
                    }
                    let yaml = YAML.parse(content);
                    return yaml;
                } catch {
                    console.log(`ç¬¬äºŒæ¬¡yamlä¿®å¤å¤±è´¥`);
                }
                try {
                    content = content.replace(/, /g, "\r\n    - ");
                    content = content.replace(/\['/g, "\r\n    - '");
                    content = content.replace(/'\]/g, "'");
                    content = fixYamlSingleQuotes(content);
                    //console.log(`ç¬¬ä¸‰æ¬¡ä¿®å¤åçš„yamlæ–‡æœ¬:\n${content}`);
                    if (!content) {
                        return null;
                    }
                    let yaml = YAML.parse(content);
                    return yaml;
                } catch {
                    return null;
                }
            }
            function Simpleformat(content) {
                let json = {
                    ç§èŠ: {},
                    ç¾¤èŠ: {},
                };
                // æ·»åŠ ç§èŠæ¶ˆæ¯
                let matches = content.matchAll(
                    /<(.+?)å’Œ(.+?)çš„ç§èŠ>([\s\S]+?)<\/(.+?)å’Œ(.+?)çš„ç§èŠ>/g,
                );
                if (matches) {
                    for (const match of matches) {
                        if (match[1] != match[4] || match[2] != match[5]) {
                            QQ_Error("ç§èŠæ ‡ç­¾é—­åˆå¼‚å¸¸,è¯·æ‰‹åŠ¨ä¿®å¤");
                        }
                        const key = `${match[1]}å’Œ${match[2]}çš„èŠå¤©`;
                        json.ç§èŠ[key] = [];
                        for (let line of match[3].split(/\r?\n/)) {
                            line = line.trim();
                            if (line) {
                                let m = line.match(
                                    /(.+?)\s*(?:--|:|ï¼š)\s*(.+)/,
                                );
                                if (!m) {
                                    continue;
                                }
                                let message = m[2];
                                if (message.split("--").length >= 2) {
                                    message = message.split("--")[0];
                                }
                                json.ç§èŠ[key].push(`${m[1]}--${m[2]}`);
                            }
                        }
                    }
                }
                
                // æ·»åŠ ç§èŠæ¶ˆæ¯ï¼ˆæ–°æ ¼å¼ï¼š<ç§èŠ:è§’è‰²å>ï¼‰
                matches = content.matchAll(
                    /<ç§èŠ[:ï¼š](.+?)>([\s\S]+?)<\/ç§èŠ[:ï¼š](.+?)>/g,
                );
                if (matches) {
                    for (const match of matches) {
                        if (match[1] != match[3]) {
                            console.warn("ç§èŠæ ‡ç­¾é—­åˆå¼‚å¸¸:", match[1], "!=", match[3]);
                        }
                        // ä½¿ç”¨å½“å‰ç”¨æˆ·åæ„å»ºèŠå¤©é”®
                        const currentUser = QQ_GetUserName() || "ç”¨æˆ·";
                        const key = `${currentUser}å’Œ${match[1]}çš„èŠå¤©`;
                        
                        if (!json.ç§èŠ[key]) {
                            json.ç§èŠ[key] = [];
                        }
                        
                        for (let line of match[2].split(/\r?\n/)) {
                            line = line.trim();
                            if (line) {
                                let m = line.match(
                                    /(.+?)\s*(?:--|:|ï¼š)\s*(.+)/,
                                );
                                if (!m) {
                                    continue;
                                }
                                let message = m[2];
                                if (message.split("--").length >= 2) {
                                    message = message.split("--")[0];
                                }
                                json.ç§èŠ[key].push(`${m[1]}--${m[2]}`);
                            }
                        }
                    }
                }
                
                // æ·»åŠ ç¾¤èŠæ¶ˆæ¯
                matches = content.matchAll(
                    /<ç¾¤èŠ[:ï¼š](.+?)>([\s\S]+?)<\/ç¾¤èŠ[:ï¼š](.+?)>/g,
                );
                if (matches) {
                    for (const match of matches) {
                        if (match[1] != match[3]) {
                            QQ_Error("ç¾¤èŠæ ‡ç­¾é—­åˆå¼‚å¸¸,è¯·æ‰‹åŠ¨ä¿®å¤");
                        }
                        json.ç¾¤èŠ[match[1]] = {};
                        json.ç¾¤èŠ[match[1]].members = [];
                        json.ç¾¤èŠ[match[1]].msgs = [];
                        let m = match[2].match(/<æˆå‘˜>([\S\s]+?)<\/æˆå‘˜>/);
                        if (m) {
                            let members = m[1]
                                .split(",")
                                .map((item) => item.trim());
                            json.ç¾¤èŠ[match[1]].members = members;
                        }
                        m = match[2].match(/<èŠå¤©å†…å®¹>([\S\s]+?)<\/èŠå¤©å†…å®¹>/);
                        if (m) {
                            for (let message of m[1].split(/\r?\n/)) {
                                message = message.trim();
                                if (message) {
                                    let regex = message.match(
                                        /(.+?)\s*(?:--|:|ï¼š)\s*(.+)/,
                                    );
                                    if (!regex) {
                                        continue;
                                    }
                                    let content = regex[2];
                                    if (content.split("--").length >= 2) {
                                        content = content.split("--")[0];
                                    }
                                    json.ç¾¤èŠ[match[1]].msgs.push(
                                        `${regex[1]}--${regex[2]}`,
                                    );
                                }
                            }
                        }
                    }
                }
                console.log(`ç®€å•æ ¼å¼è½¬æ¢:${JSON.stringify(json)}`);
                return json;
            }
            function fixYamlSingleQuotes(yamlText) {
                try {
                    return yamlText.replace(
                        /(- ')(.*?[^\\])(')(?=\s*#|$)/gm,
                        (match, prefix, content, suffix) => {
                            // ä½¿ç”¨ä¸‰æ­¥å¤„ç†æ³•ä¿è¯å·²æœ‰è½¬ä¹‰ä¸å˜
                            const escaped = content
                                .replace(/''/g, "\uE000") // æ­¥éª¤1ï¼šç”¨ä¸´æ—¶Unicodeå ä½ç¬¦ä¿å­˜å·²æœ‰åŒå¼•å·
                                .replace(/'/g, "''") // æ­¥éª¤2ï¼šè½¬ä¹‰æ‰€æœ‰å‰©ä½™å•å¼•å·
                                .replace(/\uE000/g, "''"); // æ­¥éª¤3ï¼šæ¢å¤åŸæœ‰åŒå¼•å·
                            return `${prefix}${escaped}${suffix}`;
                        },
                    );
                } catch (e) {
                    QQ_Error(`${e}`);
                    return "";
                }
            }
            /**
             * æ£€æµ‹æ˜¯å¦ä¸ºæ··åˆæ ¼å¼å“åº”ï¼ˆç¾¤èŠ+ç§èŠ+äº’åŠ¨å†…å®¹æ··åˆï¼‰
             * @param {string} response - AIçš„å®Œæ•´å›å¤å†…å®¹
             * @returns {boolean} æ˜¯å¦ä¸ºæ··åˆæ ¼å¼
             */
            function QQ_DetectMixedFormatResponse(response) {
                // æ£€æµ‹åŸºæœ¬çš„MiPhone_JSONæ ¼å¼
                const hasMiPhoneJSON = response.includes('MiPhone_JSON_START');
                if (!hasMiPhoneJSON) {
                    return false;
                }
                
                // æ£€æµ‹æ˜¯å¦æœ‰å¤šä¸ªJSONå—æˆ–å•ä¸ªJSONå—ä¸æ™®é€šæ–‡æœ¬æ··åˆ
                const jsonStartCount = (response.match(/MiPhone_JSON_START/g) || []).length;
                const jsonEndCount = (response.match(/MiPhone_JSON_END/g) || []).length;
                
                // å¦‚æœæœ‰å¤šä¸ªJSONå—ï¼Œå¾ˆå¯èƒ½æ˜¯æ··åˆæ ¼å¼
                if (jsonStartCount > 1) {
                    console.log(`ğŸ” æ£€æµ‹åˆ°${jsonStartCount}ä¸ªMiPhone_JSONå—ï¼Œåˆ¤å®šä¸ºæ··åˆæ ¼å¼`);
                    return true;
                }
                
                // å¦‚æœåªæœ‰ä¸€ä¸ªJSONå—ï¼Œæ£€æŸ¥æ˜¯å¦ä¸æ™®é€šæ–‡æœ¬æ··åˆ
                if (jsonStartCount === 1 && jsonEndCount === 1) {
                    const beforeJSON = response.split('MiPhone_JSON_START')[0].trim();
                    const afterJSON = response.split('MiPhone_JSON_END')[1];
                    
                    // å¦‚æœJSONå—å‰åæœ‰æ˜æ˜¾çš„æ–‡æœ¬å†…å®¹ï¼Œåˆ¤å®šä¸ºæ··åˆæ ¼å¼
                    if ((beforeJSON && beforeJSON.length > 20) || 
                        (afterJSON && afterJSON.trim().length > 20)) {
                        console.log('ğŸ” æ£€æµ‹åˆ°JSONå—ä¸æ™®é€šæ–‡æœ¬æ··åˆï¼Œåˆ¤å®šä¸ºæ··åˆæ ¼å¼');
                        return true;
                    }
                }
                
                return false;
            }

            /**
             * *** é‡æ–°è®¾è®¡ï¼šæ··åˆæ ¼å¼å“åº”å¤„ç†å™¨ ***
             * ä¸“é—¨å¤„ç†ç›´æ¥å¤¹æ‚äº’åŠ¨å†…å®¹çš„ç¾¤èŠ+ç§èŠæ ¼å¼ï¼ˆæ— æ ‡è®°ï¼‰
             * @param {string} response - AIçš„å®Œæ•´å›å¤å†…å®¹
             */
            async function QQ_ProcessMixedFormatResponse(response) {
                console.log('ğŸ”„ å¼€å§‹å¤„ç†æ— æ ‡è®°æ··åˆæ ¼å¼å“åº”...');
                
                try {
                    // *** æ­¥éª¤1ï¼šæ£€æµ‹æ˜¯å¦ä¸ºæ··åˆæ ¼å¼ ***
                    const hasMiPhoneJSON = response.includes('MiPhone_JSON_START');
                    const hasMultipleJSONBlocks = (response.match(/MiPhone_JSON_START/g) || []).length > 1;
                    
                    if (!hasMiPhoneJSON) {
                        return { success: false, error: 'æœªæ‰¾åˆ°MiPhone_JSONæ ¼å¼' };
                    }
                    
                    console.log(`ğŸ“Š æ ¼å¼æ£€æµ‹: JSONå— ${hasMultipleJSONBlocks ? 'å¤šä¸ª' : 'å•ä¸ª'}`);
                    
                    // *** æ­¥éª¤2ï¼šä½¿ç”¨å¢å¼ºæå–å™¨å¤„ç†å¼‚å¸¸æ ¼å¼ ***
                    const robustResult = QQ_ExtractMiPhoneContentRobust(response);
                    if (robustResult.success) {
                        console.log("ğŸ”§ æ··åˆæ ¼å¼ä¸­ä½¿ç”¨é²æ£’æ€§æå–æˆåŠŸ");
                        try {
                            await QQ_ProcessMsgContent(robustResult.content);
                            return { success: true };
                        } catch (error) {
                            console.error("âŒ é²æ£’æ€§æå–å†…å®¹å¤„ç†å¤±è´¥:", error);
                        }
                    }
                    
                    // *** æ­¥éª¤3ï¼šæŒ‰ç…§JSONå—åˆ†æ®µï¼Œæå–å¤¹æ‚çš„äº’åŠ¨å†…å®¹ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰ ***
                    const segments = response.split(/MiPhone_JSON_START|MiPhone_JSON_END/);
                    const jsonBlocks = [];
                    const interactiveTexts = [];
                    
                    for (let i = 0; i < segments.length; i++) {
                        const segment = segments[i].trim();
                        if (!segment) continue;
                        
                        // æ£€æŸ¥æ˜¯å¦ä¸ºJSONæ ¼å¼æ®µè½
                        if (segment.includes('msg_start') && segment.includes('msg_end')) {
                            // æå–msg_startåˆ°msg_endä¹‹é—´çš„å†…å®¹
                            const msgMatch = segment.match(/msg_start([\s\S]*?)msg_end/);
                            if (msgMatch) {
                                jsonBlocks.push(msgMatch[1].trim());
                                console.log(`ğŸ“¦ æå–JSONå— ${jsonBlocks.length}: ${msgMatch[1].substring(0, 100)}...`);
                            }
                        } else if (segment.length > 10) {
                            // å¯èƒ½çš„äº’åŠ¨å†…å®¹ï¼šä¸æ˜¯JSONæ ¼å¼ä½†æœ‰ä¸€å®šé•¿åº¦çš„æ–‡æœ¬
                            const cleanText = segment.replace(/^\s*msg_start\s*|\s*msg_end\s*$/g, '').trim();
                            if (cleanText.length > 5) {
                                interactiveTexts.push(cleanText);
                                console.log(`ğŸ­ æå–äº’åŠ¨å†…å®¹ ${interactiveTexts.length}: ${cleanText.substring(0, 100)}...`);
                            }
                        }
                    }
                    
                    console.log(`ğŸ“ˆ è§£æç»“æœ: JSONå— ${jsonBlocks.length}ä¸ª, äº’åŠ¨æ–‡æœ¬ ${interactiveTexts.length}ä¸ª`);
                    
                    // *** æ­¥éª¤3ï¼šå¤„ç†æ‰€æœ‰JSONå—ï¼ˆèŠå¤©æ•°æ®ï¼‰ ***
                    const allChatData = { ç§èŠ: {}, ç¾¤èŠ: {} };
                    let successfulParses = 0;
                    
                    for (let i = 0; i < jsonBlocks.length; i++) {
                        const blockContent = jsonBlocks[i];
                        console.log(`å¤„ç†JSONå— ${i + 1}/${jsonBlocks.length}...`);
                        
                        try {
                            const parsedJson = JsonYamlParse(blockContent);
                            if (parsedJson) {
                                successfulParses++;
                                
                                // åˆå¹¶ç¾¤èŠæ•°æ®
                                if (parsedJson.ç¾¤èŠ) {
                                    for (const [groupName, groupData] of Object.entries(parsedJson.ç¾¤èŠ)) {
                                        if (!allChatData.ç¾¤èŠ[groupName]) {
                                            allChatData.ç¾¤èŠ[groupName] = { members: [], msgs: [] };
                                        }
                                        // åˆå¹¶æˆå‘˜åˆ—è¡¨
                                        if (groupData.members) {
                                            allChatData.ç¾¤èŠ[groupName].members = [...new Set([
                                                ...allChatData.ç¾¤èŠ[groupName].members,
                                                ...groupData.members
                                            ])];
                                        }
                                        // åˆå¹¶æ¶ˆæ¯åˆ—è¡¨
                                        if (groupData.msgs) {
                                            allChatData.ç¾¤èŠ[groupName].msgs.push(...groupData.msgs);
                                        }
                                    }
                                }
                                
                                // åˆå¹¶ç§èŠæ•°æ®
                                if (parsedJson.ç§èŠ) {
                                    for (const [chatKey, messages] of Object.entries(parsedJson.ç§èŠ)) {
                                        if (!allChatData.ç§èŠ[chatKey]) {
                                            allChatData.ç§èŠ[chatKey] = [];
                                        }
                                        allChatData.ç§èŠ[chatKey].push(...messages);
                                    }
                                }
                            }
                        } catch (error) {
                            console.error(`è§£æJSONå— ${i + 1} å¤±è´¥:`, error);
                        }
                    }
                    
                    console.log(`âœ… æˆåŠŸè§£æ ${successfulParses}/${jsonBlocks.length} ä¸ªJSONå—`);
                    
                    // *** æ­¥éª¤4ï¼šå¤„ç†èŠå¤©æ•°æ® ***
                    let chatDataProcessed = false;
                    if (Object.keys(allChatData.ç¾¤èŠ).length > 0 || Object.keys(allChatData.ç§èŠ).length > 0) {
                        console.log('ğŸ“ æ›´æ–°èŠå¤©æ•°æ®...');
                        const cleanedData = QQ_Msg_DeletOld(allChatData);
                        await QQ_Msg_Parse(JSON.stringify(cleanedData));
                        chatDataProcessed = true;
                        
                        console.log(`ğŸ“Š èŠå¤©æ•°æ®æ›´æ–°: ç¾¤èŠ ${Object.keys(allChatData.ç¾¤èŠ).length}ä¸ª, ç§èŠ ${Object.keys(allChatData.ç§èŠ).length}ä¸ª`);
                    }
                    
                    // *** æ­¥éª¤5ï¼šå¤„ç†äº’åŠ¨å†…å®¹ï¼ˆåˆ›å»ºåŠ¨æ€ï¼‰ ***
                    let interactiveContentProcessed = false;
                    if (interactiveTexts.length > 0) {
                        console.log('ğŸª å¤„ç†äº’åŠ¨å†…å®¹...');
                        
                        for (let i = 0; i < interactiveTexts.length; i++) {
                            const interactiveText = interactiveTexts[i];
                            
                            // å¤„ç†å¹¶ç¾åŒ–äº’åŠ¨å†…å®¹
                            const processedContent = QQ_ProcessInteractiveMarkerContent(interactiveText);
                            
                            // åˆ›å»ºäº’åŠ¨åŠ¨æ€æ¡ç›®
                            const interactiveMoment = {
                                id: `mixed_interactive_${Date.now()}_${i}_${Math.random().toString(36).substr(2, 9)}`,
                                userName: charcardname || 'è§’è‰²',
                                message: processedContent.summary,
                                timestamp: new Date().toISOString(),
                                timestampText: QQ_GetTime(),
                                additionalInfo: processedContent.details,
                                randomPhone: '',
                                imgcontent: processedContent.hasImage ? processedContent.imageContent : '',
                                likes: {
                                    count: 0,
                                    userLiked: false,
                                    likedBy: [],
                                    lastLikeTime: null
                                },
                                comments: [],
                                interactiveContent: interactiveText,  // ä¿å­˜åŸå§‹äº’åŠ¨å†…å®¹
                                isInteractiveContent: true,          // æ ‡è®°ä¸ºäº’åŠ¨å†…å®¹
                                isMixedFormat: true                  // æ ‡è®°ä¸ºæ··åˆæ ¼å¼æ¥æº
                            };
                            
                            // æ·»åŠ åˆ°åŠ¨æ€æ•°æ®
                            if (!window.QQ_MomentsData) {
                                window.QQ_MomentsData = [];
                            }
                            window.QQ_MomentsData.unshift(interactiveMoment);
                            
                            console.log(`âœ… äº’åŠ¨å†…å®¹ ${i + 1} å·²æ·»åŠ åˆ°åŠ¨æ€ç©ºé—´: ${interactiveMoment.id}`);
                        }
                        
                        interactiveContentProcessed = true;
                        
                        // ä¿å­˜åŠ¨æ€æ•°æ®å¹¶åˆ·æ–°ç•Œé¢
                        if (typeof QQ_SafeSaveMomentsData === 'function') {
                            await QQ_SafeSaveMomentsData('æ··åˆæ ¼å¼äº’åŠ¨å†…å®¹');
                        }
                        
                        // å¦‚æœå½“å‰åœ¨åŠ¨æ€ç•Œé¢ï¼Œåˆ·æ–°æ˜¾ç¤º
                        if ($('#space_contents').length > 0 && $('#space_contents').is(':visible')) {
                            if (typeof QQ_Render_Moments === 'function') {
                                await QQ_Render_Moments();
                            }
                        }
                    }
                    
                    console.log('âœ… æ··åˆæ ¼å¼å“åº”å¤„ç†å®Œæˆ');
                    
                    return {
                        success: true,
                        chatDataProcessed: chatDataProcessed,
                        interactiveContentProcessed: interactiveContentProcessed,
                        jsonBlocksProcessed: successfulParses,
                        interactiveTextsFound: interactiveTexts.length,
                        groupChatsUpdated: Object.keys(allChatData.ç¾¤èŠ).length,
                        privateChatsUpdated: Object.keys(allChatData.ç§èŠ).length
                    };
                    
                } catch (error) {
                    console.error('âŒ æ··åˆæ ¼å¼å“åº”å¤„ç†å¤±è´¥:', error);
                    return {
                        success: false,
                        error: error.message
                    };
                }
            }

            /**
             * *** æ–°å¢ï¼šå¤„ç†äº’åŠ¨å†…å®¹æ ‡è®° ***
             * å°†åŸå§‹äº’åŠ¨å†…å®¹æ ‡è®°è½¬æ¢ä¸ºé€‚åˆåŠ¨æ€æ˜¾ç¤ºçš„æ ¼å¼
             * @param {string} markerContent - åŸå§‹äº’åŠ¨æ ‡è®°å†…å®¹
             * @returns {object} å¤„ç†åçš„å†…å®¹å¯¹è±¡
             */
            function QQ_ProcessInteractiveMarkerContent(markerContent) {
                const result = {
                    summary: 'å‘èµ·äº†äº’åŠ¨åœºæ™¯',
                    details: '',
                    hasImage: false,
                    imageContent: ''
                };
                
                try {
                    // æ¸…ç†å†…å®¹ï¼Œç§»é™¤"äº’åŠ¨å†…å®¹"æ ‡è®°
                    let cleanContent = markerContent.replace(/^\s*äº’åŠ¨å†…å®¹\s*/gm, '').trim();
                    
                    // æ£€æµ‹å›¾ç‰‡å†…å®¹
                    const imageRegex = /<img[^>]+src=["']([^"']+)["'][^>]*>/gi;
                    const imageMatches = [...cleanContent.matchAll(imageRegex)];
                    
                    if (imageMatches.length > 0) {
                        result.hasImage = true;
                        result.imageContent = imageMatches[0][0]; // å–ç¬¬ä¸€å¼ å›¾ç‰‡
                        result.summary = 'åˆ†äº«äº†äº’åŠ¨åœºæ™¯å›¾ç‰‡';
                        
                        // ç§»é™¤å›¾ç‰‡æ ‡ç­¾ï¼Œç•™ä¸‹æ–‡å­—æè¿°
                        cleanContent = cleanContent.replace(imageRegex, '').trim();
                    }
                    
                    // æ£€æµ‹ç‰¹æ®Šæ ¼å¼å†…å®¹
                    if (cleanContent.includes('[å›¾ç‰‡-') || cleanContent.includes('[img-')) {
                        result.summary = 'åˆ†äº«äº†äº’åŠ¨åœºæ™¯å›¾ç‰‡';
                    } else if (cleanContent.includes('*') && cleanContent.includes('*')) {
                        result.summary = 'å‘èµ·äº†åŠ¨ä½œäº’åŠ¨';
                    } else if (cleanContent.includes('ã€') && cleanContent.includes('ã€‘')) {
                        result.summary = 'è¡¨è¾¾äº†æƒ…æ„Ÿäº’åŠ¨';
                    } else if (cleanContent.length > 50) {
                        result.summary = 'å‘èµ·äº†è¯¦ç»†äº’åŠ¨åœºæ™¯';
                    }
                    
                    // å¤„ç†è¯¦ç»†å†…å®¹
                    if (cleanContent.length > 0) {
                        // é™åˆ¶è¯¦ç»†å†…å®¹é•¿åº¦ï¼Œé¿å…è¿‡é•¿
                        if (cleanContent.length > 200) {
                            result.details = cleanContent.substring(0, 200) + '...';
                        } else {
                            result.details = cleanContent;
                        }
                        
                        // å¦‚æœæœ‰è¯¦ç»†å†…å®¹ï¼Œè°ƒæ•´æ‘˜è¦
                        if (result.details.includes('æŒ‘æˆ˜') || result.details.includes('æˆ˜æ–—')) {
                            result.summary = 'å‘èµ·äº†æŒ‘æˆ˜äº’åŠ¨';
                        } else if (result.details.includes('æ¸©æŸ”') || result.details.includes('äº²å¯†')) {
                            result.summary = 'å‘èµ·äº†æ¸©é¦¨äº’åŠ¨';
                        } else if (result.details.includes('æŒ‡æŒ¥å®˜') || result.details.includes('å¤§äºº')) {
                            result.summary = 'ä¸æŒ‡æŒ¥å®˜äº’åŠ¨';
                        }
                    }
                    
                } catch (error) {
                    console.error('å¤„ç†äº’åŠ¨æ ‡è®°å†…å®¹å¤±è´¥:', error);
                    result.summary = 'å‘èµ·äº†äº’åŠ¨å†…å®¹';
                    result.details = 'å†…å®¹è§£æå‡ºé”™ï¼Œè¯·æŸ¥çœ‹åŸå§‹æ•°æ®';
                }
                
                return result;
            }

            async function MiPhone_Merge() {
                let messages = await ST.GetCurrentMessages();
                messages = messages.replace(
                    /<(?:think|thinking)>[\s\S]+?<\/(?:think|thinking)>/gi,
                    "",
                );
                
                // *** æ–°å¢ï¼šæ£€æµ‹æ··åˆæ ¼å¼å¹¶ä¼˜å…ˆå¤„ç† ***
                if (messages.includes('MiPhone_JSON_START') && messages.includes('äº’åŠ¨å†…å®¹')) {
                    console.log('ğŸ” æ£€æµ‹åˆ°æ··åˆæ ¼å¼å“åº”ï¼Œä½¿ç”¨å¢å¼ºå¤„ç†å™¨...');
                    const result = await QQ_ProcessMixedFormatResponse(messages);
                    
                    if (result.success) {
                        console.log(`âœ… æ··åˆæ ¼å¼å¤„ç†æˆåŠŸ: èŠå¤©å— ${result.blocksProcessed}, äº’åŠ¨å†…å®¹ ${result.interactiveMarkers}`);
                        triggerSlash("/echo æ··åˆæ ¼å¼å“åº”å¤„ç†å®Œæˆ");
                        if (result.chatDataProcessed && result.interactiveContentProcessed) {
                            triggerSlash("/echo èŠå¤©å†…å®¹å·²æ›´æ–°ï¼Œäº’åŠ¨å†…å®¹å·²æ·»åŠ åˆ°åŠ¨æ€ç©ºé—´");
                        } else if (result.chatDataProcessed) {
                            triggerSlash("/echo èŠå¤©å†…å®¹å·²æ›´æ–°");
                        } else if (result.interactiveContentProcessed) {
                            triggerSlash("/echo äº’åŠ¨å†…å®¹å·²æ·»åŠ åˆ°åŠ¨æ€ç©ºé—´");
                        }
                        return;
                    } else {
                        console.error('âŒ æ··åˆæ ¼å¼å¤„ç†å¤±è´¥ï¼Œå›é€€åˆ°æ ‡å‡†å¤„ç†');
                        triggerSlash("/echo æ··åˆæ ¼å¼å¤„ç†å¤±è´¥ï¼Œä½¿ç”¨æ ‡å‡†å¤„ç†");
                    }
                }
                
                // *** åŸæœ‰çš„æ ‡å‡†å¤„ç†é€»è¾‘ ***
                const matches = messages.matchAll(
                    /MiPhone_start([\s\S]+?)MiPhone_end/g,
                );
                if (!matches) {
                    return;
                }
                const matchesArray = [...matches];
                const length = matchesArray.length;
                console.log(`åŒ¹é…åˆ°æ•°é‡:${length}`);
                if (length <= 1) {
                    return;
                }
                for (let i = 0; i < matchesArray.length; i++) {
                    const value = matchesArray[i][0];
                    console.log(`value:\n${value}`);
                    const msg = value.match(/msg_start([\s\S]+?)msg_end/);
                    if (msg) {
                        let json;
                        try {
                            json = JsonYamlParse(msg[1]);
                            if (json) {
                                json = QQ_Msg_DeletOld(json);
                                await QQ_Msg_Parse(JSON.stringify(json));
                            }
                        } catch {}
                    }
                    if (i != matchesArray.length - 1) {
                        messages = messages.replace(value, "");
                    } else {
                        if (msg) {
                            const lovalvalue = value.replace(
                                msg[0],
                                `msg_start\n${QQ_Json2Text(QQ_msgjson)}\nmsg_end`,
                            );
                            messages = messages.replace(value, lovalvalue);
                        } else {
                            messages = messages.replace(
                                "MiPhone_start",
                                `msg_start\n${QQ_Json2Text(QQ_msgjson)}\nmsg_end`,
                            );
                        }
                    }
                }
                triggerSlash("/echo å­˜åœ¨å¤šä¸ªæ ¼å¼,è‡ªåŠ¨åˆå¹¶");
                triggerSlash(
                    "/echo åˆå¹¶åªä¼šä¿ç•™èŠå¤©å†…å®¹,åŠ¨æ€å’Œè®ºå›ä¼šä¸¢å¤±!!!!!",
                );
                const CurrentMessageId = await getCurrentMessageId();
                setChatMessage({ message: messages }, CurrentMessageId);
            }
            /**
             * *** æ–°å¢ï¼šä»worldbookåŠ è½½åŠ¨æ€å†…å®¹ ***
             */
            async function QQ_Load_Moments() {
                if (!worldbook || !entries) {
                    console.log('åŠ¨æ€åŠ è½½è·³è¿‡ï¼šç¼ºå°‘worldbookæˆ–entries');
                    return;
                }
                
                try {
                    const momentEntry = entries.find(entry => entry.comment === "æ‰‹æœº-åŠ¨æ€å†…å®¹å­˜å‚¨");
                    
                    if (momentEntry && momentEntry.content) {
                        // è§£æä¿å­˜çš„åŠ¨æ€æ•°æ®
                        const savedMoments = JSON.parse(momentEntry.content);
                        
                        // ç¡®ä¿æ¯ä¸ªåŠ¨æ€éƒ½æœ‰ç‚¹èµæ•°æ®ç»“æ„
                        QQ_MomentsData = savedMoments.map(moment => {
                            if (!moment.likes) {
                                moment.likes = {
                                    count: parseInt(moment.extraContent) || 0,
                                    userLiked: false,
                                    likedBy: [],
                                    lastLikeTime: null
                                };
                            }
                            return moment;
                        });
                        
                        window.QQ_MomentsData = QQ_MomentsData; // æ›´æ–°å…¨å±€å¼•ç”¨
                        
                        console.log('æˆåŠŸåŠ è½½åŠ¨æ€å†…å®¹:', QQ_MomentsData.length, 'æ¡åŠ¨æ€');
                        
                        // é‡æ–°æ¸²æŸ“åŠ¨æ€ç•Œé¢
                        await QQ_Render_Moments();
                    } else {
                        console.log('æœªæ‰¾åˆ°ä¿å­˜çš„åŠ¨æ€å†…å®¹');
                    }
                } catch (error) {
                    console.error('åŠ è½½åŠ¨æ€å†…å®¹å¤±è´¥:', error);
                }
            }
            
            /**
             * *** æ–°å¢ï¼šä»worldbookåŠ è½½èŠå¤©æ¶ˆæ¯å¤‡ä»½ ***
             */
            async function QQ_Load_Chat_Backup() {
                if (!worldbook || !entries) {
                    console.log('èŠå¤©å¤‡ä»½åŠ è½½è·³è¿‡ï¼šç¼ºå°‘worldbookæˆ–entries');
                    return false;
                }
                
                try {
                    const chatBackupEntry = entries.find(entry => entry.comment === "æ‰‹æœº-èŠå¤©æ¶ˆæ¯å¤‡ä»½");
                    
                    if (chatBackupEntry && chatBackupEntry.content) {
                        const backupData = JSON.parse(chatBackupEntry.content);
                        
                        if (backupData.data && (backupData.data.ç§èŠ || backupData.data.ç¾¤èŠ)) {
                            console.log('âœ… æ‰¾åˆ°èŠå¤©å¤‡ä»½ï¼Œå‡†å¤‡æ¢å¤...');
                            
                            // *** ä¿®å¤ï¼šå®‰å…¨æ¢å¤èŠå¤©æ•°æ®ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤± ***
                            const originalPrivateChats = QQ_msgjson?.ç§èŠ ? Object.keys(QQ_msgjson.ç§èŠ).length : 0;
                            const originalGroupChats = QQ_msgjson?.ç¾¤èŠ ? Object.keys(QQ_msgjson.ç¾¤èŠ).length : 0;
                            
                            QQ_msgjson = JSON.parse(JSON.stringify(backupData.data));
                                QQ_ChatBackup = backupData;
                            window.QQ_msgjson = QQ_msgjson; 
                            window.QQ_ChatBackup = QQ_ChatBackup;
                            
                            // æ ‡è®°æ•°æ®å·²æ¢å¤ï¼Œé˜²æ­¢åç»­è¢«æ„å¤–æ¸…ç©º
                            window.QQ_ChatDataRestored = true;
                            window.QQ_ChatDataRestoreTime = new Date().toISOString();
                            
                            console.log(`ğŸ“Š èŠå¤©æ•°æ®æ¢å¤å¯¹æ¯”: ç§èŠ ${originalPrivateChats} â†’ ${Object.keys(QQ_msgjson.ç§èŠ || {}).length}, ç¾¤èŠ ${originalGroupChats} â†’ ${Object.keys(QQ_msgjson.ç¾¤èŠ || {}).length}`); 

                            // [æ–°å¢] æ¢å¤æˆåŠŸåï¼Œç«‹å³æ ¹æ®æ¢å¤çš„æ•°æ®åŒæ­¥ç¾¤èŠåˆ—è¡¨
                            if (QQ_msgjson.ç¾¤èŠ) {
                                const groupNames = Object.keys(QQ_msgjson.ç¾¤èŠ);
                                console.log('ä»å¤‡ä»½ä¸­æ¢å¤ç¾¤èŠåˆ—è¡¨:', groupNames);
                                // ä½¿ç”¨æ¢å¤çš„ç¾¤èŠåç§°åˆ—è¡¨ï¼Œé‡å»ºå†…å­˜ä¸­çš„ QQ_Groups
                                QQ_Groups = [...groupNames]; 
                                window.QQ_Groups = QQ_Groups;
                                
                                // [æ–°å¢] ä¸ºæ¢å¤çš„ç¾¤èŠåˆ›å»ºåŸºç¡€ç•Œé¢å…¥å£
                                console.log('å¼€å§‹ä¸ºæ¢å¤çš„ç¾¤èŠåˆ›å»ºç•Œé¢å…¥å£...');
                                
                                // *** ä¿®å¤ï¼šå…ˆæ ‡è®°æ‰€æœ‰æ¢å¤çš„ç¾¤èŠä¸ºå·²åˆå§‹åŒ–ï¼Œé˜²æ­¢é‡å¤ç³»ç»Ÿæ¶ˆæ¯ ***
                                if (!window.QQ_GroupInitializedSet) {
                                    window.QQ_GroupInitializedSet = new Set();
                                }
                                
                                for (const groupName of groupNames) {
                                    const groupData = QQ_msgjson.ç¾¤èŠ[groupName];
                                    if (groupData) {
                                        // *** å…³é”®ä¿®å¤ï¼šæ¢å¤çš„ç¾¤èŠå·²æœ‰æ¶ˆæ¯å†å²ï¼Œæ ‡è®°ä¸ºå·²åˆå§‹åŒ– ***
                                        if (groupData.msgs && groupData.msgs.length > 0) {
                                            window.QQ_GroupInitializedSet.add(groupName);
                                            console.log(`ç¾¤èŠ "${groupName}" æœ‰ ${groupData.msgs.length} æ¡å†å²æ¶ˆæ¯ï¼Œæ ‡è®°ä¸ºå·²åˆå§‹åŒ–`);
                                        }
                                        
                                        // ä½¿ç”¨éšæœºå¤´åƒåˆ›å»ºç¾¤èŠå…¥å£ï¼Œè¯¦ç»†å…ƒæ•°æ®å°†åœ¨ç¬¬äºŒé˜¶æ®µè¡¥å……
                                        const defaultAvatar = QQ_GetRandomAvatar() || 'https://files.catbox.moe/skngqq.jpg';
                                        const members = groupData.members || [];
                                        
                                        // æ£€æŸ¥ç¾¤èŠæ˜¯å¦å·²åœ¨ç•Œé¢ä¸­å­˜åœ¨ï¼Œé¿å…é‡å¤åˆ›å»º
                                        const existingGroupElement = $(`.QQ_home_usermsg[data-name='${groupName}'][data-group-type='true']`);
                                        if (existingGroupElement.length === 0) {
                                            console.log(`ä¸ºç¾¤èŠ "${groupName}" åˆ›å»ºç•Œé¢å…¥å£`);
                                            AddNewGroup(groupName, defaultAvatar, members, '');
                                        } else {
                                            console.log(`ç¾¤èŠ "${groupName}" çš„ç•Œé¢å…¥å£å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º`);
                                            // ç•Œé¢å­˜åœ¨æ—¶ä¹Ÿè¦æ ‡è®°ä¸ºå·²åˆå§‹åŒ–ï¼Œé˜²æ­¢åç»­é‡å¤æ·»åŠ åˆå§‹æ¶ˆæ¯
                                            window.QQ_GroupInitializedSet.add(groupName);
                                        }
                                    }
                                }
                            }
                            
                            console.log('âœ… æˆåŠŸæ¢å¤èŠå¤©å¤‡ä»½æ•°æ®:', Object.keys(QQ_msgjson.ç§èŠ || {}).length, 'ä¸ªç§èŠ,', Object.keys(QQ_msgjson.ç¾¤èŠ || {}).length, 'ä¸ªç¾¤èŠ');
                            
                            // *** ä¿®å¤ï¼šæ¢å¤æ•°æ®åç«‹å³åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨æ˜¾ç¤ºï¼Œç¡®ä¿ç§èŠæœ€åæ¶ˆæ¯æ­£ç¡®æ˜¾ç¤º ***
                            try {
                                // å…ˆæ›´æ–°æ‰€æœ‰ç§èŠçš„æœ€åæ¶ˆæ¯æ˜¾ç¤º
                                if (QQ_msgjson && QQ_msgjson.ç§èŠ) {
                                    const allCharacters = new Set();
                                    Object.keys(QQ_msgjson.ç§èŠ).forEach(chatKey => {
                                        const matches = chatKey.match(/^(.+)å’Œ(.+)çš„èŠå¤©$/);
                                        if (matches) {
                                            const [, char1, char2] = matches;
                                            if (char1 !== UserName) allCharacters.add(char1);
                                            if (char2 !== UserName) allCharacters.add(char2);
                                        }
                                    });
                                    
                                    allCharacters.forEach(characterName => {
                                        updatePrivateChatLastMessageDisplay(characterName);
                                    });
                                    console.log('âœ… æ‰€æœ‰ç§èŠæœ€åæ¶ˆæ¯å·²æ›´æ–°');
                                }
                                
                                await QQ_UpdateMessageList();
                                console.log('âœ… ç§èŠå’Œç¾¤èŠæœ€åæ¶ˆæ¯æ˜¾ç¤ºå·²æ›´æ–°');
                            } catch (error) {
                                console.error('æ›´æ–°æ¶ˆæ¯åˆ—è¡¨æ˜¾ç¤ºå¤±è´¥:', error);
                            }
                            
                                return true;
                            } else {
                             console.log('ğŸŸ¡ èŠå¤©å¤‡ä»½æ•°æ®æ ¼å¼ä¸æ­£ç¡®æˆ–ä¸ºç©º');
                                return false;
                        }
                    } else {
                        console.log('â„¹ï¸ æœªåœ¨ä¸–ç•Œä¹¦ä¸­æ‰¾åˆ°èŠå¤©å¤‡ä»½æ¡ç›®');
                        return false;
                    }
                } catch (error) {
                    console.error('åŠ è½½èŠå¤©å¤‡ä»½æ—¶å‘ç”Ÿä¸¥é‡é”™è¯¯:', error);
                    return false;
                }
            }

            

            /**
             * *** æ–°å¢ï¼šæ¸²æŸ“åŠ¨æ€å†…å®¹åˆ°ç•Œé¢ (æ”¯æŒåˆ†é¡µ) ***
             */
            async function QQ_Render_Moments(loadMore = false) {
                const $spaceContents = $("#space_contents");
                
                if (QQ_MomentsData.length === 0) {
                    console.log('æ²¡æœ‰åŠ¨æ€å†…å®¹éœ€è¦æ¸²æŸ“');
                    momentsDisplayCount = 0;
                    return;
                }

                // é¦–æ¬¡åŠ è½½æˆ–éåŠ è½½æ›´å¤šæ—¶æ¸…ç©ºå†…å®¹
                if (!loadMore) {
                    $spaceContents.empty();
                    momentsDisplayCount = 0;
                }
                
                // æŒ‰æ—¶é—´æˆ³å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                const sortedMoments = [...QQ_MomentsData].sort((a, b) => {
                    return new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime();
                });

                // ç¡®å®šè¦æ˜¾ç¤ºçš„åŠ¨æ€èŒƒå›´
                const startIndex = momentsDisplayCount;
                const endIndex = Math.min(startIndex + (loadMore ? MOMENTS_LOAD_INCREMENT : MOMENTS_DISPLAY_LIMIT), sortedMoments.length);
                const momentsToShow = sortedMoments.slice(startIndex, endIndex);
                
                for (const momentData of momentsToShow) {
                    try {
                        const momentDiv = $("<div>", { 
                            class: "user_moment",
                            "data-moment-id": momentData.id // æ·»åŠ åŠ¨æ€IDå±æ€§
                        });
                        momentDiv.html(
                            _.template(moment_page)({
                                userName: momentData.userName,
                                message: momentData.message,
                                timestamp: momentData.timestampText,
                                additionalInfo: momentData.additionalInfo,
                                randomPhone: momentData.randomPhone,
                                extraContent: momentData.likes ? momentData.likes.count : 0, // ä¿®æ­£ï¼šç‚¹èµæ•°ç”¨äºextraContent
                                imgcontent: momentData.imgcontent || '',
                                momentId: momentData.id, // ä¿ç•™momentIdä»¥é˜²å…¶ä»–åœ°æ–¹ä½¿ç”¨
                                // ä¿®å¤ï¼šç‚¹èµç›¸å…³æ•°æ®ï¼Œä½¿ç”¨æ¨¡æ¿ä¸­æ­£ç¡®çš„å˜é‡å
                                likeCount: momentData.likes ? momentData.likes.count : 0,
                                likedByUser: momentData.likes ? momentData.likes.userLiked : false
                            })
                        );
                        
                        // *** æ¸²æŸ“è¯„è®ºï¼ˆä½¿ç”¨æ–°çš„æŠ˜å ç³»ç»Ÿï¼‰ ***
                        const commentsList = momentDiv.find(".user_leave_message_list");
                        QQ_Render_Comments(momentData, commentsList);
                        
                        $spaceContents.append(momentDiv);
                    } catch (error) {
                        console.error('æ¸²æŸ“åŠ¨æ€å¤±è´¥:', error, momentData);
                    }
                }

                // æ›´æ–°æ˜¾ç¤ºè®¡æ•°
                momentsDisplayCount = endIndex;

                // æ·»åŠ æˆ–æ›´æ–°"æŸ¥çœ‹æ›´å¤š"æŒ‰é’®
                QQ_Update_Moments_LoadMore(sortedMoments.length);
                
                // ğŸš‘ ä½¿ç”¨ç»ˆæä¿®å¤æ–¹æ¡ˆåˆå§‹åŒ–ç‚¹èµåŠŸèƒ½
                if (typeof QQ_InitMomentLikes === 'function') {
                    console.log('ğŸš‘ åŠ¨æ€æ¸²æŸ“å®Œæˆï¼Œå¯åŠ¨ç‚¹èµæŒ‰é’®ç»ˆæä¿®å¤...');
                    QQ_InitMomentLikes();
                    
                    // å»¶è¿Ÿå¼ºåŒ–ç»‘å®šï¼Œç¡®ä¿DOMå®Œå…¨æ¸²æŸ“
                    setTimeout(() => {
                        if (typeof QQ_ForceLikeButtonBinding === 'function') {
                            QQ_ForceLikeButtonBinding();
                        }
                        if (typeof QQ_DiagnoseLikeButtons === 'function') {
                            QQ_DiagnoseLikeButtons();
                        }
                    }, 200);
                }
                
                // åŠ è½½ç‚¹èµçŠ¶æ€
                if (typeof QQ_LoadMomentLikes === 'function') {
                    await QQ_LoadMomentLikes();
                }
                
                console.log(`åŠ¨æ€å†…å®¹æ¸²æŸ“å®Œæˆï¼Œæ˜¾ç¤º ${momentsDisplayCount}/${sortedMoments.length} æ¡`);
            }

            /**
             * *** æ›´æ–°åŠ¨æ€"æŸ¥çœ‹æ›´å¤š"æŒ‰é’® ***
             */
            function QQ_Update_Moments_LoadMore(totalMoments) {
                const $spaceContents = $("#space_contents");
                const loadMoreId = 'moments-load-more';
                
                // ç§»é™¤æ—§çš„åŠ è½½æ›´å¤šæŒ‰é’®
                $(`#${loadMoreId}`).remove();
                
                // å¦‚æœè¿˜æœ‰æ›´å¤šåŠ¨æ€éœ€è¦æ˜¾ç¤ºï¼Œæ·»åŠ æŒ‰é’®
                if (momentsDisplayCount < totalMoments) {
                    const loadMoreBtn = $(`
                        <div id="${loadMoreId}" style="text-align: center; padding: 20px 0; color: #999; font-size: 12px; cursor: pointer; border-top: 1px solid #e5e5e5; margin-top: 10px;">
                            --ç‚¹å‡»æŸ¥çœ‹æ›´å¤š--
                        </div>
                    `);
                    
                    loadMoreBtn.on('click', async function() {
                        $(this).text('åŠ è½½ä¸­...');
                        try {
                            await QQ_Render_Moments(true);  // åŠ è½½æ›´å¤š
                        } catch (error) {
                            console.error('åŠ è½½æ›´å¤šåŠ¨æ€å¤±è´¥:', error);
                            $(this).text('åŠ è½½å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•');
                        }
                    });
                    
                    $spaceContents.append(loadMoreBtn);
                }
            }

            /**
             * *** èŠå¤©æ¶ˆæ¯åˆ†é¡µåŠ è½½å‡½æ•° ***
             */
            async function QQ_Load_Chat_History(chatName, msgContainer) {
                const isGroup = QQ_Groups.includes(chatName);
                let allMessages = [];
                
                // è·å–æ‰€æœ‰å†å²æ¶ˆæ¯
                if (isGroup && QQ_msgjson.ç¾¤èŠ[chatName] && QQ_msgjson.ç¾¤èŠ[chatName].msgs) {
                    allMessages = [...QQ_msgjson.ç¾¤èŠ[chatName].msgs];
                } else if (!isGroup && QQ_msgjson.ç§èŠ[`${UserName}å’Œ${chatName}çš„èŠå¤©`]) {
                    allMessages = [...QQ_msgjson.ç§èŠ[`${UserName}å’Œ${chatName}çš„èŠå¤©`]];
                }
                
                // è·å–å½“å‰æ˜¾ç¤ºçš„æ¶ˆæ¯æ•°é‡
                const currentDisplayed = chatDisplayCounts[chatName] || 0;
                const totalMessages = allMessages.length;
                
                if (currentDisplayed >= totalMessages) {
                    console.log('æ²¡æœ‰æ›´å¤šå†å²æ¶ˆæ¯');
                    return false;
                }
                
                // è®¡ç®—è¦åŠ è½½çš„æ¶ˆæ¯èŒƒå›´ï¼ˆä»å†å²å¾€å‰å€’æ¨ï¼‰
                const loadCount = Math.min(CHAT_LOAD_INCREMENT, totalMessages - currentDisplayed);
                const startIndex = Math.max(0, totalMessages - currentDisplayed - loadCount);
                const endIndex = totalMessages - currentDisplayed;
                const messagesToLoad = allMessages.slice(startIndex, endIndex);
                
                console.log(`å‡†å¤‡åŠ è½½å†å²æ¶ˆæ¯: ${startIndex}-${endIndex}, å…±${loadCount}æ¡`);
                
                // è·å–å½“å‰ç¬¬ä¸€ä¸ªæ¶ˆæ¯å…ƒç´ ï¼Œç”¨äºæ’å…¥ä½ç½®
                const $firstMsg = $(msgContainer).children().not('.load-more-messages').first();
                
                // å€’åºæ·»åŠ æ¶ˆæ¯åˆ°é¡¶éƒ¨ï¼ˆä¿æŒæ—¶é—´é¡ºåºï¼‰
                for (let i = messagesToLoad.length - 1; i >= 0; i--) {
                    const msg = messagesToLoad[i];
                    const tempDiv = $('<div>');
                    
                    // ä½¿ç”¨ä¿®æ”¹åçš„QQ_Chat_AddMsgæ·»åŠ æ¶ˆæ¯ï¼Œè·³è¿‡æ»šåŠ¨å’Œè®¡æ•°
                    await QQ_Chat_AddMsg(tempDiv[0], msg, chatName, false, true);
                    
                    // å°†æ¶ˆæ¯æ’å…¥åˆ°å®¹å™¨é¡¶éƒ¨
                    if ($firstMsg.length > 0) {
                        $firstMsg.before(tempDiv.html());
                    } else {
                        $(msgContainer).prepend(tempDiv.html());
                    }
                }
                
                // æ›´æ–°æ˜¾ç¤ºè®¡æ•°
                chatDisplayCounts[chatName] = (chatDisplayCounts[chatName] || 0) + loadCount;
                
                console.log(`å†å²æ¶ˆæ¯åŠ è½½å®Œæˆï¼Œå½“å‰æ˜¾ç¤º: ${chatDisplayCounts[chatName]}/${totalMessages}`);
                return chatDisplayCounts[chatName] < totalMessages; // è¿”å›æ˜¯å¦è¿˜æœ‰æ›´å¤šæ¶ˆæ¯
            }

            /**
             * *** æ›´æ–°èŠå¤©"åŠ è½½æ›´å¤š"æŒ‰é’® ***
             */
            function QQ_Update_Chat_LoadMore(chatName, msgContainer) {
                const $container = $(msgContainer);
                const loadMoreId = `chat-load-more-${chatName.replace(/[^a-zA-Z0-9]/g, '_')}`;
                
                // ç§»é™¤æ—§çš„åŠ è½½æ›´å¤šæŒ‰é’®
                $(`.load-more-messages`).remove();
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºåŠ è½½æ›´å¤šæŒ‰é’®
                const isGroup = QQ_Groups.includes(chatName);
                let totalMessages = 0;
                
                if (isGroup && QQ_msgjson.ç¾¤èŠ[chatName] && QQ_msgjson.ç¾¤èŠ[chatName].msgs) {
                    totalMessages = QQ_msgjson.ç¾¤èŠ[chatName].msgs.length;
                } else if (!isGroup && QQ_msgjson.ç§èŠ[`${UserName}å’Œ${chatName}çš„èŠå¤©`]) {
                    totalMessages = QQ_msgjson.ç§èŠ[`${UserName}å’Œ${chatName}çš„èŠå¤©`].length;
                }
                
                const currentDisplayed = chatDisplayCounts[chatName] || 0;
                
                // åªæœ‰å½“æ¶ˆæ¯æ•°é‡è¶…è¿‡æ˜¾ç¤ºé™åˆ¶ä¸”è¿˜æœ‰å†å²æ¶ˆæ¯æ—¶æ‰æ˜¾ç¤ºæŒ‰é’®
                if (totalMessages > CHAT_DISPLAY_LIMIT && currentDisplayed < totalMessages) {
                    const loadMoreBtn = $(`
                        <div id="${loadMoreId}" class="load-more-messages" style="text-align: center; padding: 15px 0; color: #999; font-size: 12px; cursor: pointer; border-bottom: 1px solid #e5e5e5; margin-bottom: 10px; background-color: #f9f9f9;">
                            --ç‚¹å‡»åŠ è½½æ›´å¤š--
                        </div>
                    `);
                    
                    loadMoreBtn.on('click', async function() {
                        $(this).text('åŠ è½½ä¸­...');
                        try {
                            const hasMore = await QQ_Load_Chat_History(chatName, msgContainer);
                            if (!hasMore) {
                                $(this).text('æ²¡æœ‰æ›´å¤šæ¶ˆæ¯äº†').css('color', '#ccc').off('click');
                                setTimeout(() => $(this).fadeOut(), 2000);
                            } else {
                                $(this).text('--ç‚¹å‡»åŠ è½½æ›´å¤š--');
                            }
                        } catch (error) {
                            console.error('åŠ è½½æ›´å¤šèŠå¤©æ¶ˆæ¯å¤±è´¥:', error);
                            $(this).text('åŠ è½½å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•');
                        }
                    });
                    
                    // å°†æŒ‰é’®æ’å…¥åˆ°å®¹å™¨é¡¶éƒ¨
                    $container.prepend(loadMoreBtn);
                }
            }

            /**
             * åˆå§‹åŒ–åŠ¨æ€ç©ºé—´å†…å®¹
             */
            function space_init() {
                $("#space_contents").prepend(space_contents);
                // *** ä¿®æ”¹ï¼šåˆå§‹åŒ–æ—¶åŠ è½½ä¿å­˜çš„åŠ¨æ€å†…å®¹ ***
                setTimeout(() => {
                    QQ_Load_Moments();
                }, 500);
            }
            async function GetWorldBookName() {
                let localbook;
                try {
                    localbook = await getCurrentCharPrimaryLorebook();
                    console.log(
                        `è§’è‰²å¡ç»‘å®šä¸»è¦ä¸–ç•Œä¹¦`,
                        JSON.stringify(localbook),
                    );
                } catch (e) {
                    console.log(`è·å–ç»‘å®šä¸–ç•Œä¹¦å‡ºç°å¼‚å¸¸:${e}`);
                }
                if (localbook) {
                    const localentrys = await getLorebookEntries(localbook);
                    const targetEntry = localentrys.find((entry) =>
                        ["æ‰‹æœº-ç•Œé¢åŸºæœ¬è®¾ç½®", "æ‰‹æœºç•Œé¢åŸºæœ¬è®¾ç½®"].includes(
                            entry.comment,
                        ),
                    );
                    if (targetEntry) {
                        console.log(`ä½¿ç”¨è§’è‰²å¡ç»‘å®šçš„ä¸–ç•Œä¹¦`);
                        return localbook;
                    }
                }
                const globalbook = (await getLorebookSettings())
                    .selected_global_lorebooks;
                if (globalbook) {
                    for (const book of globalbook) {
                        const localentrys = await getLorebookEntries(book);
                        const targetEntry = localentrys.find((entry) =>
                            ["æ‰‹æœº-ç•Œé¢åŸºæœ¬è®¾ç½®", "æ‰‹æœºç•Œé¢åŸºæœ¬è®¾ç½®"].includes(
                                entry.comment,
                            ),
                        );
                        if (targetEntry) {
                            console.log(`ä½¿ç”¨å…¨å±€ä¸–ç•Œä¹¦:${book}`);
                            return book;
                        }
                    }
                }
                if (localbook) {
                    return localbook;
                }
                console.log(`æ²¡æœ‰åŒ¹é…çš„ä¸–ç•Œä¹¦`);
                return null;
            }
            async function DelPadding() {
                const message_id = await getCurrentMessageId();
                console.log(`å¼€å§‹ç§»é™¤å¤´åƒå’Œè¾¹è·:${message_id}`);
                $(`div.mes[mesid="${message_id}"]`, window.parent.document)
                    .find(`div.mes_text`)
                    .css("padding-right", "0");
                $(`div.mes[mesid="${message_id}"]`, window.parent.document)
                    .find(`div.avatar`)
                    .css("display", "none");
                $(`div.mes[mesid="${message_id}"]`, window.parent.document)
                    .find(`div.mesAvatarWrapper`)
                    .css("display", "none");
            }
            /**
             * è·å–è®¾ç½®
             */
            async function GetSettings() {
                console.log(
                    `æµ‹è¯•è·å–ini:${Phone_Settings.readValue("ä¸‹é¢æ˜¯åŸºæœ¬è®¾ç½®", "èŠå¤©å£çº¸")}`,
                );
                if (Phone_Settings.readValue("ä¸‹é¢æ˜¯åŸºæœ¬è®¾ç½®", "å†…æ¡†é¢œè‰²")) {
                    let value = Phone_Settings.readValue(
                        "ä¸‹é¢æ˜¯åŸºæœ¬è®¾ç½®",
                        "å†…æ¡†é¢œè‰²",
                    );
                    if (value[0] != "#") {
                        value += "#";
                    }
                    console.log(`è®¾ç½®æ°”æ³¡é¢œè‰²ä¸º ${value}`);
                    $("<style>")
                        .text(
                            `.card { background-color: ${value} !important; }`,
                        )
                        .appendTo("head");
                    $("<style>")
                        .text(`.top { background-color: ${value} !important; }`)
                        .appendTo("head");
                }
                let value = Phone_Settings.readValue(
                    "ä¸‹é¢æ˜¯åŸºæœ¬è®¾ç½®",
                    "å¤–æ¡†é¢œè‰²",
                );
                if (value) {
                    if (value[0] != "#") {
                        value += "#";
                    }
                    console.log(`è®¾ç½®æ°”æ³¡é¢œè‰²ä¸º ${value}`);
                    $("<style>")
                        .text(
                            `.card { border: 2px solid ${value} !important; }`,
                        )
                        .appendTo("head");
                }
                value = Phone_Settings.readValue("ä¸‹é¢æ˜¯åŸºæœ¬è®¾ç½®", "ä¾§è¾¹æŒ‰é’®");
                if (value) {
                    if (value[0] != "#") {
                        value += "#";
                    }
                    console.log(`è®¾ç½®æ°”æ³¡é¢œè‰²ä¸º ${value}`);
                    $("<style>")
                        .text(
                            `.btn1 { background-color: ${value} !important; }`,
                        )
                        .appendTo("head");
                    $("<style>")
                        .text(
                            `.btn2 { background-color: ${value} !important; }`,
                        )
                        .appendTo("head");
                    $("<style>")
                        .text(
                            `.btn3 { background-color: ${value} !important; }`,
                        )
                        .appendTo("head");
                }
                value = Phone_Settings.readValue("ä¸‹é¢æ˜¯åŸºæœ¬è®¾ç½®", "å‘é€æ¨¡å¼");
                if (value) {
                    if (value == "2") {
                        newgen = false;
                        console.log("è®¾ç½®å‘é€æ¨¡å¼ä¸ºéæµå¼");
                    } else {
                        newgen = true;
                        console.log("è®¾ç½®å‘é€æ¨¡å¼ä¸ºæµå¼");
                    }
                } else {
                    Phone_Settings.writeValue(
                        "ä¸‹é¢æ˜¯åŸºæœ¬è®¾ç½®",
                        "å‘é€æ¨¡å¼",
                        "1",
                    );
                    console.log("æœªæ‰¾åˆ°å‘é€æ¨¡å¼è®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤æµå¼å‘é€");
                }
                value = Phone_Settings.readValue("ä¸‹é¢æ˜¯åŸºæœ¬è®¾ç½®", "èŠå¤©å£çº¸");
                if (value) {
                    $("<style>")
                        .text(
                            `.QQ_chat_page {
      background-image: url("${value}");
    }`,
                        )
                        .appendTo("head");
                }
                value = Phone_Settings.readValue("ä¸‹é¢æ˜¯åŸºæœ¬è®¾ç½®", "æ°”æ³¡é¢œè‰²");
                if (value) {
                    if (value[0] != "#") {
                        value += "#";
                    }
                    //console.log(`è®¾ç½®æ°”æ³¡é¢œè‰²ä¸º ${value}`);
                    $("<style>")
                        .text(
                            `.QQ_chat_msgdiv { background-color: ${value} !important; }`,
                        )
                        .appendTo("head");
                }
                Phone_Settings.writeValue(
                    "ä¸‹é¢æ˜¯åŸºæœ¬è®¾ç½®",
                    "ä¸–ç•Œä¹¦ç‰ˆæœ¬",
                    version,
                );
                for (let entry of entries) {
                    if (
                        entry.comment == "æ‰‹æœº-ç•Œé¢åŸºæœ¬è®¾ç½®" ||
                        entry.comment == "æ‰‹æœºç•Œé¢åŸºæœ¬è®¾ç½®"
                    ) {
                        await setLorebookEntries(worldbook, [
                            {
                                uid: entry.uid,
                                content: Phone_Settings.getAllText(),
                            },
                        ]);
                    }
                }
                entries = await getLorebookEntries(worldbook);
            }
            /**
             * æ ¹æ®è§’è‰²åè·å–èŠå¤©è®¾å®š
             *
             * @param name è§’è‰²å
             * @returns èŠå¤©è®¾å®š
             */
            function GetChatCharSettingByName(name) {
                let char_setting = "";
                for (let entry of entries) {
                    if (entry.comment == "é…ç½®-èŠå¤©-è§’è‰²ä¸ªäººè®¾å®š") {
                        char_setting = entry.content.trim();
                    }
                }
                if (!char_setting) {
                    return;
                }
                const char_setting_json = JSON.parse(char_setting);
                const setting = char_setting_json.find(
                    (item) => item.name === name,
                );
                if (!setting) {
                    return;
                }
                console.log(`è·å–åˆ°è§’è‰²è®¾å®š:${YAML.stringify(setting)}`);
                return setting;
            }
            async function Verify() {
                try {
                    // è·å–ç‰ˆæœ¬å…ƒç´ å¹¶æå–çº¯ç‰ˆæœ¬å·
                    let version = await getFrontendVersion();
                    console.log(`é…’é¦†åŠ©æ‰‹ç‰ˆæœ¬${version}`);
                    // æ‹†åˆ†ç‰ˆæœ¬å·ä¸ºæ•°å­—æ•°ç»„
                    const versionParts = version.split(".").map(Number);
                    if (versionParts.length < 3 || versionParts.some(isNaN)) {
                        throw new Error("Invalid version format");
                    }
                    // è§£æ„èµ‹å€¼ç‰ˆæœ¬å·
                    const [major, minor, patch] = versionParts;
                    // è®¾ç½®æœ€ä½è¦æ±‚ç‰ˆæœ¬
                    const MIN_MAJOR = 2;
                    const MIN_MINOR = 4;
                    const MIN_PATCH = 3;
                    // ç‰ˆæœ¬æ¯”è¾ƒé€»è¾‘
                    if (
                        major < MIN_MAJOR ||
                        (major === MIN_MAJOR &&
                            (minor < MIN_MINOR ||
                                (minor === MIN_MINOR && patch < MIN_PATCH)))
                    ) {
                        alert(
                            `å‰ç«¯åŠ©æ‰‹ç‰ˆæœ¬è¿‡ä½ (å½“å‰ ${versionParts.join(".")}ï¼Œéœ€è¦è‡³å°‘ ${MIN_MAJOR}.${MIN_MINOR}.${MIN_PATCH})ï¼Œè¯·æ›´æ–°`,
                        );
                    }
                } catch (error) {
                    assertIsError(error);
                    console.error("ç‰ˆæœ¬éªŒè¯å¤±è´¥:", error);
                    // å¦‚æœå­˜åœ¨è‡ªå®šä¹‰é”™è¯¯å¤„ç†åˆ™è°ƒç”¨ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤æç¤º
                    if (typeof QQ_Error === "function") {
                        QQ_Error(`éªŒè¯å‰ç«¯åŠ©æ‰‹ç‰ˆæœ¬å¤±è´¥: ${error.message}`);
                    } else {
                        alert("ç‰ˆæœ¬éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°ä¿¡æ¯");
                    }
                }
            }
            function assertIsError(error) {
                if (!(error instanceof Error)) {
                    throw new TypeError();
                }
            }
            function random(min, max) {
                return Math.floor(Math.random() * (max - min) + min);
            }
            function head_init() {
                let girl = `EJeUD/Image_1737026320652.jpg|Y8pt1/Image_1737026296736.jpg|QWWc6/Image_1737026308451.jpg|Z8LIW/Image_1737026306601.jpg|W8lhW/Image_1737026313246.jpg|0rJtX/Image_1737026292787.jpg|yVxsN/Image_1737026293840.jpg|vaBCL/Image_1737026286979.jpg|pZ6hQ/Image_1737026285632.jpg|11AH2/Image_1737026284351.jpg|eXKUw/Image_1737026281715.jpg|o31F4/Image_1737026277201.jpg|8E2uj/Image_1737026279242.jpg|GLmIl/Image_1737026275069.jpg|zWZT5/Image_1737026271769.jpg|7Zrij/Image_1737026269532.jpg|AqYsZ/Image_1737026266131.jpg|w4lFq/2406563368.jpeg|MQNua/2403629154.jpeg|3YZhe/2405854911.jpeg|5QKhj/2312445144.jpeg|k6JT6/2408434848.jpeg|j6Bf6/2386328773.jpeg|a8LHY/2386327598.jpeg|r08C6/2386327604.jpeg|DgECK/2331678725.jpeg|LJrC7/2371251634.jpeg|q1LF3/2329660869.gif|X84sW/2328035526.jpeg|2eDfQ/2326662447.jpeg|ggetw/2326683821.jpeg|J21ig/2323432137.gif`;
                let girls = girl.split("|");
                let result = "";
                for (let i = 0; i < girls.length; i++) {
                    if (girls[i]) {
                        random_head_list.push(girls[i]);
                        result += `\nhttp://sharkpan.xyz/f/${girls[i]}`;
                    }
                }
            }
            // å¢åŠ éŸ³é¢‘çŠ¶æ€ç›‘å¬
            QQ_Music.audio.addEventListener("ended", () => {
                if (QQ_Music.lastelement) {
                    QQ_Music.lastelement.find(".icon-music-stop").hide();
                    QQ_Music.lastelement.find(".icon-music-play").show();
                }
            });
            QQ_Music.audio.addEventListener("error", () => {
                if (QQ_Music.lastelement) {
                    QQ_Music.lastelement.find(".icon-music-stop").hide();
                    QQ_Music.lastelement.find(".icon-music-play").show();
                }
                QQ_Error("æ’­æ”¾å‡ºé”™ï¼Œè¯·å°è¯•é‡æ–°æ’­æ”¾");
            });
            // å¢åŠ éŸ³é¢‘ä¸­æ–­ç›‘å¬
            QQ_Music.audio.addEventListener("pause", () => {
                if (QQ_Music.lastelement) {
                    QQ_Music.lastelement.find(".icon-music-stop").hide();
                    QQ_Music.lastelement.find(".icon-music-play").show();
                }
            });
            async function LoadRandomHead() {
                let content = "";
                for (let entry of entries) {
                    if (entry.comment == "æ‰‹æœº-éšæœºå¤´åƒ") {
                        content = entry.content;
                    }
                }
                if (!content) {
                    return;
                }
                const matches = content.matchAll(/^http.+$/gm);
                for (const match of matches) {
                    const obj = {
                        url: match[0],
                        count: [
                            ...NpcCssValue.matchAll(new RegExp(match[0], "g")),
                        ].length,
                    };
                    QQ_RandomHead.push(obj);
                }
            }
            function GetWorldEntry(name, search) {
                let list = [];
                
                // æ£€æŸ¥entriesæ˜¯å¦å·²åˆå§‹åŒ–
                if (!entries) {
                    console.warn('GetWorldEntry: entriesæœªåˆå§‹åŒ–ï¼Œè¿”å›null');
                    return null;
                }
                
                entries.forEach((item) => {
                    if (search) {
                        name.forEach((n) => {
                            if (item.comment.indexOf(n) > -1) {
                                list.push(item);
                            }
                        });
                    } else if (name.includes(item.comment)) {
                        list.push(item);
                    }
                });
                if (list.length == 0) {
                    return null;
                } else if (list.length == 1) {
                    return list[0];
                }
                // å­˜åœ¨å¤šä¸ªæ¡ç›®,ä½¿ç”¨å¼€å¯çš„æ¡ç›®,æœ‰å¤šä¸ªå¼€å¯æ¡ç›®ä¸åšå¤„ç†
                for (let entry of list) {
                    if (entry.enabled) {
                        return entry;
                    }
                }
                // å…¨éƒ½æ²¡å¼€å¯,ç›´æ¥è¿”å›ç¬¬ä¸€ä¸ª
                return list[0];
            }
            /**
             * è·å–è¡¨æƒ…åŒ…
             */
            async function LoadEmoji() {
                let content = "";
                let phonebook = "";
                let phoneuid = -1;
                
                // æ£€æŸ¥entriesæ˜¯å¦å·²åˆå§‹åŒ–
                if (!entries) {
                    console.warn('LoadEmoji: entriesæœªåˆå§‹åŒ–ï¼Œè·³è¿‡è¡¨æƒ…åŒ…åŠ è½½');
                    return;
                }
                
                for (let entry of entries) {
                    if (
                        entry.comment == "æ‰‹æœº-è¡¨æƒ…åŒ…å­˜æ”¾" ||
                        entry.comment == "è¡¨æƒ…åŒ…å­˜æ”¾ä¸–ç•Œä¹¦"
                    ) {
                        content = entry.content;
                    } else if (entry.comment == "æ‰‹æœº-æ ¼å¼2-QQèŠå¤©") {
                        phonebook = entry.content;
                        phoneuid = entry.uid;
                    }
                }
                if (!content) {
                    console.log(`è·å–è¡¨æƒ…åŒ…ä¸–ç•Œä¹¦å¤±è´¥`);
                    return;
                }
                if (phoneuid == -1) {
                    console.log(`è·å–æ‰‹æœºæ ¼å¼ä¸–ç•Œä¹¦æ¡ç›®å¤±è´¥`);
                    return;
                }
                content = content.replace(
                    /http:\/\/sharkpan/g,
                    "https://sharkpan",
                );
                content = content.replace(/--\n/g, "--");
                const regex = new RegExp("(.+?)--(http.+)", "g");
                const matches = [...content.matchAll(regex)];
                if (!matches) {
                    return;
                }
                console.log(`è¡¨æƒ…åŒ…æ•°é‡:${matches.length}`);
                for (const match of matches) {
                    QQ_emoji.set(match[1], match[2]);
                }
                const keysArray = JSON.stringify(Array.from(QQ_emoji.keys()));
                const m = phonebook.match(
                    /<è¡¨æƒ…åŒ…åˆ—è¡¨>([\s\S]*?)<\/è¡¨æƒ…åŒ…åˆ—è¡¨>/,
                );
                if (m) {
                    phonebook = phonebook.replace(
                        m[0],
                        `<è¡¨æƒ…åŒ…åˆ—è¡¨>\n${keysArray}\n<\/è¡¨æƒ…åŒ…åˆ—è¡¨>`,
                    );
                    // await setLorebookEntries(worldbook, entrys.map((entry) => ({ uid: phoneuid, content: phonebook })));
                    await setLorebookEntries(worldbook, [
                        { uid: phoneuid, content: phonebook },
                    ]);
                }
            }
            /**
             * èŠå¤©-åŠ è½½è§’è‰²åˆ—è¡¨
             *
             */
            async function LoadChars() {
                console.log('=== LoadChars å¼€å§‹æ‰§è¡Œ ===');
                console.log('entrieså˜é‡çŠ¶æ€:', typeof entries, entries ? entries.length : 'undefined');
                console.log('worldbookå˜é‡:', worldbook);
                
                // å…ˆåˆ—å‡ºæ‰€æœ‰entriesçš„commentæ¥æ£€æŸ¥
                if (entries) {
                    console.log('æ‰€æœ‰ä¸–ç•Œä¹¦æ¡ç›®:', entries.map(e => ({comment: e.comment, enabled: e.enabled, hasContent: !!e.content})));
                }
                
                // æ£€æŸ¥ä¸–ç•Œä¹¦ä¸­çš„ç¾¤èŠå†…å®¹
                checkWorldbookGroups();
                
                let content;
                // for (let entry of entries) {
                //   if (entry.comment == "æ‰‹æœº-è§’è‰²" || entry.comment == "æ‰‹æœºç•Œé¢-è§’è‰²") {
                //     content = entry.content;
                //     break;
                //   }
                // }
                // if (!content) {
                //   return;
                // }
                let entry = GetWorldEntry(["æ‰‹æœº-è§’è‰²", "æ‰‹æœºç•Œé¢-è§’è‰²"], true);
                console.log('æ‰¾åˆ°çš„ä¸–ç•Œä¹¦æ¡ç›®:', entry);
                
                // å¦‚æœGetWorldEntryå¤±è´¥ï¼Œå°è¯•ç›´æ¥æŸ¥æ‰¾
                if (!entry || !entry.content) {
                    console.log('GetWorldEntryå¤±è´¥ï¼Œå°è¯•ç›´æ¥æŸ¥æ‰¾...');
                    for (let e of entries || []) {
                        console.log(`æ£€æŸ¥æ¡ç›®: ${e.comment}`);
                        if (e.comment === "æ‰‹æœº-è§’è‰²" || e.comment === "æ‰‹æœºç•Œé¢-è§’è‰²") {
                            console.log('ç›´æ¥æŸ¥æ‰¾æ‰¾åˆ°æ¡ç›®:', e);
                            entry = e;
                            break;
                        }
                    }
                }
                
                if (!entry || !entry.content) {
                    console.error('ä»ç„¶æœªæ‰¾åˆ°æ‰‹æœº-è§’è‰²ä¸–ç•Œä¹¦æ¡ç›®æˆ–å†…å®¹ä¸ºç©º');
                    console.error('å½“å‰entry:', entry);
                    return;
                }
                content = entry.content;
                console.log('ä¸–ç•Œä¹¦å†…å®¹é•¿åº¦:', content.length);
                console.log(`è·å–åˆ°çš„è§’è‰²ä¿¡æ¯:${content}`);
                QQ_CharSettings.loadText(content);
                console.log(`GetAllText:\n${QQ_CharSettings.getAllText()}`);
                const allSections = QQ_CharSettings.getAllSections();
                console.log('æ‰€æœ‰è§£æçš„æ®µè½:', allSections);
                for (let section of allSections) {
                    const hasGetCharAvatar =
                        typeof getCharAvatarPath === "function"; // æ ¸å¿ƒæ£€æŸ¥é€»è¾‘
                    const type = QQ_CharSettings.readValue(section, "ç±»å‹");
                    if (section == "char") {
                        section = getFilenameWithoutExtension(charAvatarPath);
                    }
                    let headurl = QQ_CharSettings.readValue(section, "å¤´åƒ");
                    if (!headurl) {
                        if (hasGetCharAvatar) {
                            headurl = await getCharAvatarPath(section);
                        } else {
                            QQ_Error(
                                `è‡ªåŠ¨è·å–å¤´åƒè¦æ±‚å‰ç«¯åŠ©æ‰‹ç‰ˆæœ¬åœ¨2.4.4åŠä»¥ä¸Šç‰ˆæœ¬`,
                            );
                            continue;
                        }
                    } else {
                        const match = headurl.match(/[<{]+(.+?)[>}]/);
                        if (match) {
                            if (hasGetCharAvatar) {
                                headurl = await getCharAvatarPath(match[1]);
                            } else {
                                QQ_Error(
                                    `è‡ªåŠ¨è·å–å¤´åƒè¦æ±‚å‰ç«¯åŠ©æ‰‹ç‰ˆæœ¬åœ¨2.4.4åŠä»¥ä¸Šç‰ˆæœ¬`,
                                );
                                continue;
                            }
                        }
                    }
                    if (!type.match(/npc/i) && type != "è·¯äºº" && type != "ç¾¤èŠ") {
                        // åªå¤„ç†ç§èŠè§’è‰²ï¼Œç¾¤èŠç”±ç‹¬ç«‹çš„loadGroupChatsFromWorldbookå‡½æ•°å¤„ç†
                        console.log(`å‡†å¤‡æ·»åŠ è§’è‰²: ${section}, ç±»å‹: ${type}`);
                        AddNewChar(section, headurl);
                        QQ_msgjson.ç§èŠ[`${UserName}å’Œ${section}çš„èŠå¤©`] = [];
                        } else {
                        console.log(`è·³è¿‡è§’è‰²: ${section}, ç±»å‹: ${type}`);
                    }
                    console.log(`è§’è‰²${section}çš„å¤´åƒ:${headurl}`);
                    let CssValue = new Map();
                    let divkey = `.QQ_chat_msgdiv[data-name='${section}']`;
                    let MsgColor = QQ_CharSettings.readValue(
                        section,
                        "æ°”æ³¡é¢œè‰²",
                    );
                    if (MsgColor) {
                        MsgColor =
                            MsgColor[0] == "#" ? MsgColor : `#${MsgColor}`;
                        CssValue.set(
                            divkey,
                            `--MsgColor: ${MsgColor};
        background-color: var(--MsgColor) !important; `,
                        );
                        console.log(
                            `è®¾ç½®äº†è§’è‰² ${section} çš„æ°”æ³¡é¢œè‰²:${MsgColor}`,
                        );
                    }
                    let TextColor = QQ_CharSettings.readValue(
                        section,
                        "å­—ä½“é¢œè‰²",
                    );
                    if (TextColor) {
                        TextColor =
                            TextColor[0] == "#" ? TextColor : `#${TextColor}`;
                        if (CssValue.has(divkey)) {
                            CssValue.set(
                                divkey,
                                CssValue.get(divkey) +
                                    `--TextColor: ${TextColor};`,
                            );
                        }
                        CssValue.set(
                            `.QQ_chat_msgdiv[data-name='${section}'] span`,
                            `color:var(--TextColor) !important;`,
                        );
                        console.log(
                            `è®¾ç½®äº†è§’è‰² ${section} çš„å­—ä½“é¢œè‰²:${TextColor}`,
                        );
                    }
                    let BackGroundImg = QQ_CharSettings.readValue(
                        section,
                        "èŠå¤©å£çº¸",
                    );
                    if (BackGroundImg) {
                        CssValue.set(
                            `.QQ_chat_page[data-name='${section}']`,
                            `--BackGroundImg: url('${BackGroundImg}');
        background-image:var(--BackGroundImg) !important;`,
                        );
                        console.log(
                            `è®¾ç½®äº†è§’è‰² ${section} çš„èŠå¤©å£çº¸:${BackGroundImg}`,
                        );
                    }
                    if (headurl) {
                        CssValue.set(
                            `.head[data-name=${section}]`,
                            `background-image:url('${headurl}')`,
                        );
                        console.log(`æ·»åŠ headurl`);
                    }
                    if (CssValue) {
                        let value = "";
                        for (const key of CssValue.keys()) {
                            value += `\n${key}{${CssValue.get(key)}}`;
                        }
                        if (value) {
                            $(`<style>`)
                                .attr("data-name", section)
                                .text(value)
                                .appendTo("head");
                            //console.log(`è®¾ç½®css:\n${value}`);
                        }
                    }
                    //console.log(`è·å–åˆ°çš„æ ·å¼è¡¨:\n${$(`style[data-name='${section}']`).text()}`);
                }
                const style = $("<style></style>").prop("type", "text/css");
                const cssRule = chat_headraw_namespaceObject
                    .replace(/\$\{name\}/g, UserName)
                    .replace(/\$\{head\}/g, userAvatarPath);
                style.text(cssRule);
                $("head").append(style);
                
                // *** ä¿®å¤ï¼šç¾¤èŠæ•°æ®åŠ è½½å·²æ”¹ä¸ºä¸¤é˜¶æ®µåŠ è½½ï¼Œæ­¤å¤„ä¸å†ç›´æ¥è°ƒç”¨ ***
                console.log('LoadChars: ç¾¤èŠæ•°æ®å°†é€šè¿‡ä¸¤é˜¶æ®µåŠ è½½æœºåˆ¶å¤„ç†');
                console.log('LoadChars: QQ_Groupsé•¿åº¦:', QQ_Groups.length, 'ç¼“å­˜çš„ç¾¤èŠå…ƒæ•°æ®:', window.QQ_Group_Chats_Data ? window.QQ_Group_Chats_Data.length : 0);
                
                // æ³¨é‡Šï¼šæ¸…ç†é‡å¤ç¾¤èŠå·²ç§»é™¤ï¼Œé¿å…è¯¯åˆ æ–°åˆ›å»ºçš„ç¾¤èŠ
                // setTimeout(async () => {
                //     await cleanupDuplicateGroups();
                // }, 500);
            }
            
            /**
             * ä»æ‰‹æœº-è§’è‰²ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªèŠå¤©å£çº¸
             */
            function getRandomChatBackground() {
                try {
                    console.log('å¼€å§‹è·å–éšæœºèŠå¤©å£çº¸...');
                    
                    // è·å–ä¸–ç•Œä¹¦æ¡ç›®
                    const entry = GetWorldEntry(["æ‰‹æœº-è§’è‰²", "æ‰‹æœºç•Œé¢-è§’è‰²"], true);
                    if (!entry || !entry.content) {
                        console.log('æ— æ³•è·å–è§’è‰²é…ç½®ï¼Œä½¿ç”¨é»˜è®¤å£çº¸');
                        console.log('entry:', entry);
                        return 'http://sharkpan.xyz/f/mM2SW/Screenshot_20250317_001012.jpg';
                    }
                    
                    console.log('æˆåŠŸè·å–åˆ°è§’è‰²é…ç½®æ¡ç›®ï¼Œå†…å®¹é•¿åº¦:', entry.content.length);
                    
                    // è§£æé…ç½®
                    const settings = new QQ_Settings();
                    settings.loadText(entry.content);
                    const allSections = settings.getAllSections();
                    
                    console.log('è§£æå¾—åˆ°çš„è§’è‰²sectionsæ•°é‡:', allSections.length);
                    
                    // æ”¶é›†æ‰€æœ‰æœ‰èŠå¤©å£çº¸çš„éç¾¤èŠè§’è‰²
                    const availableBackgrounds = [];
                    
                    for (const section of allSections) {
                        const type = settings.readValue(section, "ç±»å‹");
                        const backgroundImg = settings.readValue(section, "èŠå¤©å£çº¸");
                        
                        console.log(`æ£€æŸ¥è§’è‰² ${section}: ç±»å‹=${type}, èŠå¤©å£çº¸=${backgroundImg ? 'æœ‰' : 'æ— '}`);
                        
                        // æ’é™¤ç¾¤èŠã€è·¯äººã€NPCç±»å‹
                        if (!type || (type.trim() !== 'ç¾¤èŠ' && type.trim() !== 'è·¯äºº' && !type.match(/npc/i))) {
                            if (backgroundImg && backgroundImg.trim()) {
                                availableBackgrounds.push({
                                    character: section,
                                    url: backgroundImg.trim()
                                });
                                console.log(`æ”¶é›†åˆ°è§’è‰² ${section} çš„èŠå¤©å£çº¸: ${backgroundImg.trim()}`);
                            }
                        }
                    }
                    
                    console.log('æ€»å…±æ”¶é›†åˆ°', availableBackgrounds.length, 'ä¸ªå¯ç”¨çš„èŠå¤©å£çº¸');
                    
                    // å¦‚æœæ‰¾åˆ°äº†å£çº¸ï¼Œéšæœºé€‰æ‹©ä¸€ä¸ª
                    if (availableBackgrounds.length > 0) {
                        const randomChoice = availableBackgrounds[Math.floor(Math.random() * availableBackgrounds.length)];
                        console.log(`ä¸ºç¾¤èŠéšæœºé€‰æ‹©äº†æ¥è‡ªè§’è‰² "${randomChoice.character}" çš„èŠå¤©å£çº¸: ${randomChoice.url}`);
                        return randomChoice.url;
                    }
                    
                } catch (error) {
                    console.error('éšæœºé€‰æ‹©èŠå¤©å£çº¸æ—¶å‡ºé”™:', error);
                }
                
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æˆ–å‡ºé”™ï¼Œè¿”å›é»˜è®¤å£çº¸
                console.log('æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„èŠå¤©å£çº¸ï¼Œä½¿ç”¨é»˜è®¤å£çº¸');
                return 'http://sharkpan.xyz/f/mM2SW/Screenshot_20250317_001012.jpg';
            }
            
            /**
             * ä¸ºç¾¤èŠæ·»åŠ åˆå§‹æ¬¢è¿æ¶ˆæ¯ï¼ˆå·²ç§»åŠ¨åˆ°åé¢ï¼Œæ­¤å¤„åˆ é™¤é‡å¤å‡½æ•°ï¼‰
             */
            
            function SetCssVariable(name, variable, value) {
                let cssvalue = $(`style[data-name='${name}']`).text();
                if (!cssvalue) {
                    return;
                }
                const match = cssvalue.match(
                    new RegExp(`--${variable}\s*:\s*(.+?);`),
                );
                if (!match) {
                    return;
                }
                cssvalue = cssvalue
                    .replace(
                        `${match[0]}`,
                        `${match[0].replace(match[1], value)}`,
                    )
                    .trim();
                console.log(`æ›´æ–°åçš„css:\n${cssvalue}`);
                $(`style[data-name='${name}']`).text(cssvalue);
            }
            /**
             * èŠå¤©-æ·»åŠ æ–°è§’è‰²åˆ°åˆ—è¡¨
             * @param {*} name
             * @param {*} head
             */
            function AddNewChar(name, head) {
                console.log(`æ·»åŠ æ–°è§’è‰²:${name}  ${head}`);
                
                // å¦‚æœæ²¡æœ‰æä¾›å¤´åƒæˆ–å¤´åƒä¸ºç©ºï¼Œä½¿ç”¨éšæœºå¤´åƒ
                let finalHead = head && head.trim() ? head.trim() : QQ_GetAvatarWithFallback(name);
                
                let html = _.template(chat_list_item)({
                    name: name,
                    head: finalHead,
                });
                $("#QQ_home_chars").append(html);
                console.log(`è§’è‰² ${name} ä½¿ç”¨å¤´åƒ: ${finalHead}`);
                QQ_pages.push(name);
                const style = $("<style></style>").prop("type", "text/css");
                const cssRule = chat_headraw_namespaceObject
                    .replace(/\$\{name\}/g, name)
                    .replace(/\$\{head\}/g, head);
                style.text(cssRule);
                $("head").append(style);
                //System_AddNpcHead(name, head);
                
                // æ›´æ–°æ¶ˆæ¯åˆ—è¡¨
                setTimeout(() => {
                    QQ_UpdateMessageList();
                }, 100);
            }
            
            /**
             * æ·»åŠ æ–°ç¾¤èŠï¼ˆå®Œå…¨åŸºäºç§èŠé€»è¾‘ï¼‰
             */
             function AddNewGroup(name, head, members, description) {
                console.log(`æ·»åŠ /æ›´æ–°ç¾¤èŠ:${name}  |  æˆå‘˜:${members.length}äºº  |  æè¿°:${description}`);
                
                // å¦‚æœæ²¡æœ‰æä¾›å¤´åƒæˆ–å¤´åƒä¸ºç©ºï¼Œä½¿ç”¨éšæœºå¤´åƒ
                if (!head || !head.trim()) {
                    head = QQ_GetAvatarWithFallback(name);
                    console.log(`ç¾¤èŠ ${name} ä½¿ç”¨éšæœºå¤´åƒ: ${head}`);
                }

                // *** æ–°å¢ï¼šé¢„æ£€æŸ¥ï¼Œå¦‚æœç¾¤èŠå·²åˆå§‹åŒ–ä¸”æœ‰æ¶ˆæ¯æ•°æ®ï¼Œè°¨æ…å¤„ç† ***
                if (QQ_GroupInitializedSet.has(name) && QQ_msgjson.ç¾¤èŠ[name] && QQ_msgjson.ç¾¤èŠ[name].msgs.length > 0) {
                    console.log(`ç¾¤èŠ ${name} å·²åˆå§‹åŒ–ä¸”æœ‰æ¶ˆæ¯æ•°æ®ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°åˆ›å»ºç•Œé¢`);
                    
                    const existingElements = $(`.QQ_home_usermsg[data-name='${name}'][data-group-type='true']`);
                    if (existingElements.length > 0) {
                        console.log(`ç¾¤èŠ ${name} ç•Œé¢å·²å­˜åœ¨ä¸”æ•°æ®å®Œæ•´ï¼Œè·³è¿‡AddNewGroupæ“ä½œ`);
                        return; // å®Œå…¨è·³è¿‡ï¼Œé¿å…ä»»ä½•é‡å¤æ“ä½œ
                    } else {
                        console.log(`ç¾¤èŠ ${name} æ•°æ®å­˜åœ¨ä½†ç•Œé¢ä¸å­˜åœ¨ï¼Œä»…é‡å»ºç•Œé¢`);
                        // ç•Œé¢ä¸å­˜åœ¨æ—¶æ‰é‡å»ºï¼Œä½†ç»å¯¹ä¸é‡æ–°æ·»åŠ åˆå§‹æ¶ˆæ¯
                    }
                }

                const existingElements = $(`.QQ_home_usermsg[data-name='${name}'][data-group-type='true']`);
                if (existingElements.length > 0) {
                    console.log(`æ‰¾åˆ°åŒåç¾¤èŠï¼Œæ‰§è¡Œæ›´æ–°æ“ä½œ`);
                    existingElements.remove();
                }

                // *** ä¿®å¤ï¼šç¡®ä¿headæ˜¯å­—ç¬¦ä¸²ï¼Œå¦‚æœæ˜¯å¯¹è±¡åˆ™å¤„ç†ä¸ºåˆé€‚çš„å­—ç¬¦ä¸² ***
                let headStr = '';
                if (typeof head === 'string') {
                    headStr = head.trim();
                } else if (head && typeof head === 'object') {
                    // å¦‚æœæ˜¯å¤´åƒå¯¹è±¡ï¼Œæå–åˆé€‚çš„å€¼
                    if (head.type === 'upload' && head.imageData) {
                        headStr = head.imageData;
                    } else if (head.type === 'preset' && head.text) {
                        headStr = head.text;
                    } else if (head.type === 'url' && head.url) {
                        headStr = head.url;
                    } else {
                        headStr = QQ_GetRandomAvatar() || 'https://files.catbox.moe/skngqq.jpg'; // éšæœºå¤´åƒ
                    }
                } else {
                    headStr = head || QQ_GetRandomAvatar() || 'https://files.catbox.moe/skngqq.jpg'; // éšæœºå¤´åƒ
                }
                
                let html = _.template(chat_list_item)({ name: name, head: headStr });
                const $html = $(html);
                $html.attr('data-group-type', 'true').attr('data-group-name', name).attr('draggable', 'true');
                
                // *** ä¿®å¤ï¼šä¸è¦ç¡¬ç¼–ç ç¾¤èŠæ˜¾ç¤ºï¼Œç¨åä¼šé€šè¿‡updateGroupLastMessageDisplayæ›´æ–° ***
                // ä¸´æ—¶è®¾ç½®åˆå§‹æ˜¾ç¤ºï¼Œé˜²æ­¢ç©ºç™½
                const memberCount = members ? members.length : 0;
                $html.find('.QQ_home_lastmsg').text('ç¾¤èŠ');
                $html.find('.QQ_home_lasttime').text(`${memberCount}äºº`);

                $html.on('click', function() {
                    console.log('ç¾¤èŠè¢«ç‚¹å‡»:', name);
                    QQ_ChangeChatPage(null, name);
                });

                const $contactsContainer = $("#QQ_home_chars");
                let $ungroupedSection = $contactsContainer.find('.ungrouped-contacts');
                if ($ungroupedSection.length === 0) {
                    $ungroupedSection = $(`<div class="ungrouped-contacts"><div class="ungrouped-header">æœªåˆ†ç»„è”ç³»äºº</div><div class="drop-zone ungrouped-drop-zone" data-group-id="ungrouped"></div></div>`);
                    $contactsContainer.prepend($ungroupedSection);
                }
                $ungroupedSection.append($html);
                
                QQ_pages.push(name);
                if (!QQ_Groups.includes(name)) {
                    QQ_Groups.push(name);
                }

                if (!QQ_msgjson.ç¾¤èŠ[name]) {
                    QQ_msgjson.ç¾¤èŠ[name] = { msgs: [], members: [] };
                }
                QQ_msgjson.ç¾¤èŠ[name].members = members || [];

                const randomBackground = getRandomChatBackground();
                let cssRule = chat_headraw_namespaceObject.replace(/\$\{name\}/g, name).replace(/\$\{head\}/g, headStr);
                
                if (randomBackground) {
                    const backgroundCSS = `
.QQ_chat_page[data-name='${name}'] {
    --BackGroundImg: url('${randomBackground}');
    background-image: var(--BackGroundImg) !important;
}`;
                    cssRule += backgroundCSS;
                }

                const style = $("<style></style>").prop("type", "text/css");
                style.text(cssRule);
                $("head").append(style);
                
                // *** æ ¸å¿ƒæ”¹åŠ¨ï¼šç›´æ¥åœ¨æ­¤å¤„ç”Ÿæˆæ¬¢è¿æ¶ˆæ¯ ***
                addGroupWelcomeMessages(name, members);

                // *** ä¿®å¤ï¼šåœ¨åˆ›å»ºç¾¤èŠåç«‹å³æ›´æ–°æœ€åæ¶ˆæ¯æ˜¾ç¤º ***
                setTimeout(() => {
                    updateGroupLastMessageDisplay(name);
                    QQ_UpdateMessageList();
                }, 100);

                console.log(`ç¾¤èŠ ${name} åˆ›å»º/æ›´æ–°æµç¨‹å®Œæˆ`);
            }

            /**
             * ä¸ºæ–°ç¾¤èŠæ·»åŠ æ¬¢è¿å’Œç³»ç»Ÿæ¶ˆæ¯ï¼ˆå·²ä¿®å¤ï¼‰
             * @param {string} groupName - ç¾¤ç»„åç§°
             * @param {string[]} members - æˆå‘˜åˆ—è¡¨
             */
            function addGroupWelcomeMessages(groupName, members) {
                console.log(`addGroupWelcomeMessages è¢«è°ƒç”¨: ${groupName}`);
                
                // *** ç¬¬ä¸€å±‚æ£€æŸ¥ï¼šSessionçº§é˜²é‡å¤æœºåˆ¶ ***
                if (QQ_GroupInitializedSet.has(groupName)) {
                    console.log(`ç¾¤èŠ ${groupName} åœ¨å½“å‰ä¼šè¯ä¸­å·²åˆå§‹åŒ–è¿‡ï¼Œè·³è¿‡æ·»åŠ `);
                    return;
                }
                
                if (!QQ_msgjson.ç¾¤èŠ[groupName]) {
                    QQ_msgjson.ç¾¤èŠ[groupName] = { msgs: [], members: members || [] };
                }
                const groupData = QQ_msgjson.ç¾¤èŠ[groupName];
                            
                // *** ç¬¬äºŒå±‚æ£€æŸ¥ï¼šç®€åŒ–çš„ç³»ç»Ÿåˆå§‹æ¶ˆæ¯æ£€æµ‹æœºåˆ¶ ***
                const hasInitialMessages = groupData.msgs.some(msg => {
                    if (!msg.startsWith('ç³»ç»Ÿæ¶ˆæ¯--')) return false;
                    
                    // æ£€æŸ¥æ¶ˆæ¯æ ¼å¼ï¼šç³»ç»Ÿæ¶ˆæ¯--æ—¶é—´--å†…å®¹
                    const parts = msg.split('--');
                    if (parts.length < 3) return false;
                    
                    const content = parts[2]; // å†…å®¹æ˜¯ç¬¬ä¸‰éƒ¨åˆ†
                    return content.includes('åˆ›å»ºæˆåŠŸ') || 
                           content.includes('åŠ å…¥äº†ç¾¤èŠ') ||
                           content.includes('å¼€å§‹èŠå¤©å§') ||
                           /^\d{2}:\d{2}$/.test(content); // çº¯æ—¶é—´æ¶ˆæ¯æ ¼å¼
                });
                
                if (hasInitialMessages) {
                    console.log(`ç¾¤èŠ ${groupName} å·²æœ‰ç³»ç»Ÿåˆå§‹æ¶ˆæ¯ï¼Œè·³è¿‡æ·»åŠ `);
                    console.log(`ç°æœ‰æ¶ˆæ¯åˆ—è¡¨:`, groupData.msgs.slice(0, 5)); // æ˜¾ç¤ºå‰5æ¡æ¶ˆæ¯ä¾¿äºè°ƒè¯•
                    // æ ‡è®°ä¸ºå·²åˆå§‹åŒ–ï¼Œé¿å…åç»­é‡å¤æ£€æŸ¥
                    QQ_GroupInitializedSet.add(groupName);
                    return;
                }
                
                if (groupData.msgs.length > 0) {
                    console.log(`ç¾¤èŠ ${groupName} å·²æœ‰ ${groupData.msgs.length} æ¡éç³»ç»Ÿæ¶ˆæ¯ï¼Œä½†ç¼ºå°‘åˆå§‹æ¶ˆæ¯ï¼Œå°†æ·»åŠ `);
                }

                const currentTime = new Date().toLocaleTimeString('zh-CN', { 
                    hour12: false, 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                // æ·»åŠ ç¾¤èŠåˆ›å»ºç³»ç»Ÿæ¶ˆæ¯
                const systemMsg = `ç³»ç»Ÿæ¶ˆæ¯--${currentTime}--ç¾¤èŠ"${groupName}"åˆ›å»ºæˆåŠŸï¼Œå¼€å§‹èŠå¤©å§ï¼`;
                groupData.msgs.push(systemMsg);
                
                // æ·»åŠ æˆå‘˜åŠ å…¥æ¶ˆæ¯
                if (members && members.length > 0) {
                    members.forEach(member => {
                        const joinMsg = `ç³»ç»Ÿæ¶ˆæ¯--${currentTime}--${member} åŠ å…¥äº†ç¾¤èŠ`;
                        groupData.msgs.push(joinMsg);
                    });
                }
                
                // *** ä¿®å¤ï¼šåœ¨æ‰€æœ‰åŠ å…¥æ¶ˆæ¯åæ·»åŠ æ—¶é—´ç³»ç»Ÿæ¶ˆæ¯ï¼Œè€Œä¸æ˜¯ç”¨æˆ·æ¶ˆæ¯ ***
                const timeMsg = `ç³»ç»Ÿæ¶ˆæ¯--${currentTime}--${currentTime}`;
                groupData.msgs.push(timeMsg);
                
                // *** æ–°å¢ï¼šç«‹å³æ›´æ–°ç¾¤èŠçš„æœ€åæ¶ˆæ¯å’Œæ—¶é—´æ˜¾ç¤º ***
                updateGroupLastMessageDisplay(groupName);
                
                // *** æ–°å¢ï¼šæ ‡è®°ç¾¤èŠå·²åˆå§‹åŒ–ï¼Œé¿å…é‡å¤æ·»åŠ  ***
                QQ_GroupInitializedSet.add(groupName);
                
                console.log(`ä¸ºç¾¤èŠ ${groupName} ç”Ÿæˆäº† ${groupData.msgs.length} æ¡æ–°çš„åˆå§‹æ¶ˆæ¯ã€‚`);
            }
            
            /**
             * æ›´æ–°ç¾¤èŠçš„æœ€åæ¶ˆæ¯å’Œæ—¶é—´æ˜¾ç¤º
             */
            function updateGroupLastMessageDisplay(groupName) {
                const groupData = QQ_msgjson.ç¾¤èŠ[groupName];
                if (!groupData || !groupData.msgs || groupData.msgs.length === 0) {
                    return;
                }
                
                // è·å–æœ€åä¸€æ¡æ¶ˆæ¯
                const lastMsgRaw = groupData.msgs[groupData.msgs.length - 1];
                const msgParts = lastMsgRaw.split('--');
                
                if (msgParts.length >= 3) {
                    const sender = msgParts[0];
                    const content = msgParts[1];
                    const time = msgParts[2] || '';
                    
                    let displayMsg = content;
                    let displayTime = time;
                    
                    // å¦‚æœæ˜¯ç³»ç»Ÿæ¶ˆæ¯ï¼Œç›´æ¥æ˜¾ç¤ºå†…å®¹
                    if (sender === 'ç³»ç»Ÿæ¶ˆæ¯') {
                        displayMsg = content;
                    } else {
                        // å¦‚æœæ˜¯ç”¨æˆ·æ¶ˆæ¯ï¼Œæ˜¾ç¤ºä¸º "å‘é€è€…: å†…å®¹"
                        displayMsg = `${sender}: ${content}`;
                    }
                    
                    // é™åˆ¶æ¶ˆæ¯é•¿åº¦é¿å…ç•Œé¢è¿‡å®½
                    if (displayMsg.length > 20) {
                        displayMsg = displayMsg.substring(0, 20) + '...';
                    }
                    
                    // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                    $(`.QQ_home_usermsg[data-name='${groupName}'] .QQ_home_lastmsg`).text(displayMsg);
                    $(`.QQ_home_usermsg[data-name='${groupName}'] .QQ_home_lasttime`).text(displayTime);
                    
                    console.log(`ç¾¤èŠ ${groupName} æœ€åæ¶ˆæ¯å·²æ›´æ–°: ${displayMsg} (${displayTime})`);
                }
            }
            
            /**
             * *** æ–°å¢ï¼šæ ¼å¼åŒ–æ˜¾ç¤ºæ—¶é—´ - ä¸ºæ¶ˆæ¯æ˜¾ç¤ºæä¾›æ—¶é—´æ ¼å¼åŒ– ***
             */
            function formatDisplayTime(timeStr) {
                if (!timeStr || timeStr.trim() === '') {
                    return '';
                }
                
                try {
                    // å°è¯•è§£ææ—¶é—´å­—ç¬¦ä¸²
                    const date = new Date(timeStr);
                    const now = new Date();
                    const diffMs = now - date;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMins / 60);
                    const diffDays = Math.floor(diffHours / 24);
                    
                    if (diffMins < 1) {
                        return 'åˆšåˆš';
                    } else if (diffMins < 60) {
                        return `${diffMins}åˆ†é’Ÿå‰`;
                    } else if (diffHours < 24) {
                        return `${diffHours}å°æ—¶å‰`;
                    } else if (diffDays < 7) {
                        return `${diffDays}å¤©å‰`;
                    } else {
                        // è¶…è¿‡ä¸€å‘¨æ˜¾ç¤ºå…·ä½“æ—¥æœŸ
                        return date.toLocaleDateString('zh-CN', {
                            month: 'short',
                            day: 'numeric'
                        });
                    }
                } catch (error) {
                    // å¦‚æœè§£æå¤±è´¥ï¼Œç›´æ¥è¿”å›åŸæ—¶é—´å­—ç¬¦ä¸²çš„ç®€åŒ–ç‰ˆæœ¬
                    console.warn('æ—¶é—´æ ¼å¼åŒ–å¤±è´¥:', timeStr, error);
                    if (timeStr.includes(':')) {
                        // å¦‚æœåŒ…å«å†’å·ï¼Œå¯èƒ½æ˜¯æ—¶é—´æ ¼å¼ï¼Œæå–æ—¶åˆ†
                        const timePart = timeStr.split(' ').find(part => part.includes(':'));
                        return timePart || timeStr;
                    }
                    return timeStr;
                }
            }
            
            /**
             * *** æ–°å¢ï¼šæ›´æ–°ç§èŠçš„æœ€åæ¶ˆæ¯å’Œæ—¶é—´æ˜¾ç¤º - ä¿®å¤ç§èŠæœ€åæ¶ˆæ¯ä¸æ˜¾ç¤ºé—®é¢˜ ***
             */
            function updatePrivateChatLastMessageDisplay(characterName) {
                console.log('æ›´æ–°ç§èŠæœ€åæ¶ˆæ¯æ˜¾ç¤º:', characterName);
                
                if (!QQ_msgjson || !QQ_msgjson.ç§èŠ) {
                    console.log('ç§èŠæ¶ˆæ¯æ•°æ®ä¸å­˜åœ¨');
                    return;
                }
                
                // æ£€æŸ¥ä¸¤ç§å¯èƒ½çš„ç§èŠé”®æ ¼å¼
                const privateChatKey1 = `${UserName}å’Œ${characterName}çš„èŠå¤©`;
                const privateChatKey2 = `${characterName}å’Œ${UserName}çš„èŠå¤©`;
                
                let msgs = null;
                let activeKey = null;
                
                if (QQ_msgjson.ç§èŠ[privateChatKey1] && QQ_msgjson.ç§èŠ[privateChatKey1].length > 0) {
                    msgs = QQ_msgjson.ç§èŠ[privateChatKey1];
                    activeKey = privateChatKey1;
                } else if (QQ_msgjson.ç§èŠ[privateChatKey2] && QQ_msgjson.ç§èŠ[privateChatKey2].length > 0) {
                    msgs = QQ_msgjson.ç§èŠ[privateChatKey2];
                    activeKey = privateChatKey2;
                }
                
                if (!msgs || msgs.length === 0) {
                    console.log('ç§èŠæ— æ¶ˆæ¯è®°å½•:', characterName);
                    // æ¸…ç©ºæœ€åæ¶ˆæ¯æ˜¾ç¤º
                    $(`.QQ_home_usermsg[data-name='${characterName}'][data-group-type!='true'] .QQ_home_lastmsg`).text('...');
                    return;
                }
                
                // è·å–æœ€åä¸€æ¡æ¶ˆæ¯
                const lastMsg = msgs[msgs.length - 1];
                const parts = lastMsg.split('--');
                
                if (parts.length >= 3) {
                    const sender = parts[0];
                    let displayMsg = parts[1]; // æ¶ˆæ¯å†…å®¹
                    const timeStr = parts[2]; // æ—¶é—´
                    
                    // å¦‚æœæ˜¯ç”¨æˆ·å‘é€çš„æ¶ˆæ¯ï¼Œæ˜¾ç¤ºä¸º "æˆ‘: å†…å®¹"ï¼Œå¦åˆ™æ˜¾ç¤ºè§’è‰²å
                    if (sender === UserName) {
                        displayMsg = `æˆ‘: ${displayMsg}`;
                    } else {
                        displayMsg = `${sender}: ${displayMsg}`;
                    }
                    
                    // æˆªæ–­è¿‡é•¿çš„æ¶ˆæ¯
                    if (displayMsg.length > 20) {
                        displayMsg = displayMsg.substring(0, 20) + '...';
                    }
                    
                    const displayTime = formatDisplayTime(timeStr);
                    
                    // æ›´æ–°è”ç³»äººåˆ—è¡¨ä¸­çš„æ˜¾ç¤º - ç¡®ä¿åªæ›´æ–°ç§èŠè€Œä¸æ˜¯ç¾¤èŠ
                    $(`.QQ_home_usermsg[data-name='${characterName}'][data-group-type!='true'] .QQ_home_time`).text(displayTime);
                    $(`.QQ_home_usermsg[data-name='${characterName}'][data-group-type!='true'] .QQ_home_lastmsg`).text(displayMsg);
                    
                    console.log(`ç§èŠ ${characterName} æœ€åæ¶ˆæ¯å·²æ›´æ–°: ${displayMsg} (${displayTime})`);
                }
            }
            
            function getFilenameWithoutExtension(path) {
                // è§£ç URIç»„ä»¶ï¼ˆå¤„ç†ç‰¹æ®Šå­—ç¬¦ï¼‰
                const decodedPath = decodeURIComponent(path);
                // åˆ†å‰²è·¯å¾„å¹¶è·å–æ–‡ä»¶åéƒ¨åˆ†
                const filename = decodedPath.split("/").pop();
                // æ‰¾åˆ°æœ€åä¸€ä¸ªç‚¹çš„ä½ç½®
                const lastDotIndex = filename.lastIndexOf(".");
                // åˆ¤æ–­å¹¶æˆªå–æ–‡ä»¶åï¼ˆæ— åç¼€ï¼‰
                return lastDotIndex > 0
                    ? filename.slice(0, lastDotIndex)
                    : filename;
            }
            function QQ_page(id) {
                if (id == "message") {
                    console.log("ç‚¹å‡»äº†æ¶ˆæ¯é¡µ");
                    $("#QQ_home_page").show();
                    $("#QQ_space_page").hide();
                    $(".QQ_chat_page").hide();
                    $("#QQ_message_svg").css("fill", "#019aff");
                    $("#QQ_people_svg").css("fill", "#000000");
                    $("#QQ_moment_svg").css("fill", "#000000");
                    $("#App_QQ").css("background-color", "#eff3ff");
                } else if (id == "people") {
                    console.log("ç‚¹å‡»äº†è”ç³»äºº");
                } else if (id == "moment") {
                    console.log("ç‚¹å‡»äº†åŠ¨æ€é¡µ");
                    $("#QQ_home_page").hide();
                    $("#QQ_space_page").show();
                    $(".QQ_chat_page").hide();
                    $("#QQ_moment_svg").css("fill", "#019aff");
                    $("#QQ_people_svg").css("fill", "#000000");
                    $("#QQ_message_svg").css("fill", "#000000");
                    $("#App_QQ").css("background-color", "#ffffff");
                    QQ_SetNewTips(0);
                    QQ_NewMsg["moment"] = 0;
                    $(".new_tips").hide();
                }
            }
            function QQ_SetNewTips(count) {
                let tips = $(".new_tips");
                tips.each(function () {
                    if (count == 0) {
                        $(this).css("display", "none");
                    } else {
                        $(this).css("display", "flex").text(count);
                    }
                });
            }
            
            async function QQ_UpdateMessageList() {
                console.log("å¼€å§‹æ›´æ–°æ¶ˆæ¯åˆ—è¡¨");
                
                // ä¸å†è‡ªåŠ¨é‡æ–°åŠ è½½ç¾¤èŠï¼Œé¿å…é‡å¤å¾ªç¯
                console.log('å½“å‰QQ_GroupsçŠ¶æ€:', QQ_Groups.length, 'ä¸ªç¾¤èŠ');
                
                const $messageChars = $("#QQ_message_list_chars");
                const $homeChars = $("#QQ_home_chars");
                
                // æ¸…ç©ºæ¶ˆæ¯é¡µé¢çš„è”ç³»äººåˆ—è¡¨
                $messageChars.empty();
                
                // åªå¤åˆ¶è”ç³»äººé¡¹ç›®ï¼Œä¸å¤åˆ¶æœç´¢æ¡†
                const $homeContacts = $homeChars.find('.QQ_home_usermsg');
                
                // ç„¶åè¿‡æ»¤ï¼Œåªæ˜¾ç¤ºæœ‰çœŸå®æ¶ˆæ¯æ²Ÿé€šè¿‡çš„è”ç³»äºº
                const contactedUsers = [];
                let firstContact = null;
                
                $homeContacts.each(function() {
                    const $contact = $(this);
                    const name = $contact.attr('data-name');
                    const $newMsgBadge = $contact.find('.QQ_home_usermsg_new');
                    const hasNewMessages = $newMsgBadge.is(':visible') && parseInt($newMsgBadge.text()) > 0;
                    const lastMsg = $contact.find('.QQ_home_lastmsg').text().trim();
                    const isGroup = $contact.attr('data-group-type') === 'true';
                    
                    if (!firstContact) {
                        firstContact = $contact.clone(true);
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰çœŸå®çš„æ¶ˆæ¯è®°å½•
                    let hasRealMessageRecord = false;
                    
                    // æ£€æŸ¥ç§èŠè®°å½• - ä¿®å¤ï¼šåŒæ—¶æ£€æŸ¥ä¸¤ç§å¯èƒ½çš„ç§èŠé”®æ ¼å¼
                    const privateChatKey1 = `${UserName}å’Œ${name}çš„èŠå¤©`;
                    const privateChatKey2 = `${name}å’Œ${UserName}çš„èŠå¤©`;
                    if (QQ_msgjson && QQ_msgjson.ç§èŠ) {
                        if ((QQ_msgjson.ç§èŠ[privateChatKey1] && QQ_msgjson.ç§èŠ[privateChatKey1].length > 0) ||
                            (QQ_msgjson.ç§èŠ[privateChatKey2] && QQ_msgjson.ç§èŠ[privateChatKey2].length > 0)) {
                        hasRealMessageRecord = true;
                        }
                    }
                    
                    // æ£€æŸ¥ç¾¤èŠè®°å½•
                    if (QQ_msgjson && QQ_msgjson.ç¾¤èŠ && QQ_msgjson.ç¾¤èŠ[name] && QQ_msgjson.ç¾¤èŠ[name].msgs && QQ_msgjson.ç¾¤èŠ[name].msgs.length > 0) {
                        hasRealMessageRecord = true;
                    }
                    
                    // æ£€æŸ¥æœªè¯»æ¶ˆæ¯æ•°é‡ï¼ˆå¿…é¡»å¤§äº0ä¸”å¯è§ï¼‰
                    const hasUnreadCount = hasNewMessages && parseInt($newMsgBadge.text()) > 0;
                    
                    // ç¾¤èŠç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯ç¾¤èŠä¸”åœ¨QQ_Groupsä¸­ï¼Œåˆ™æ˜¾ç¤º
                    if (isGroup) {
                        if (QQ_Groups.includes(name)) {
                            console.log('æ·»åŠ ç¾¤èŠåˆ°æ¶ˆæ¯åˆ—è¡¨:', name);
                            contactedUsers.push($contact.clone(true));
                        }
                    } else {
                        // åªæœ‰çœŸæ­£æœ‰æ¶ˆæ¯è®°å½•æˆ–æœªè¯»æ¶ˆæ¯æ‰æ˜¾ç¤º
                    if (hasRealMessageRecord || hasUnreadCount) {
                            // *** ä¿®å¤ï¼šä¸ºç§èŠæ›´æ–°æœ€åæ¶ˆæ¯æ˜¾ç¤º ***
                            updatePrivateChatLastMessageDisplay(name);
                        contactedUsers.push($contact.clone(true));
                        }
                    }
                });
                
                // å¦‚æœæ²¡æœ‰ä»»ä½•è”ç³»è¿‡çš„ç”¨æˆ·ï¼Œåªæ˜¾ç¤ºç¬¬ä¸€ä¸ªè”ç³»äººï¼ˆè´å°”æ³•æ–¯ç‰¹ï¼‰
                if (contactedUsers.length === 0 && firstContact) {
                    $messageChars.append(firstContact);
                } else {
                    contactedUsers.forEach(function($contact) {
                        $messageChars.append($contact);
                    });
                }
                
                console.log("æ¶ˆæ¯åˆ—è¡¨æ›´æ–°å®Œæˆ");
            }
            function QQ_HideAllChat() {
                // for (let name of QQ_pages) {
                //   let $page = $(`#QQ_chat_${name}`);
                //   if ($page.length === 0) {
                //     continue;
                //   }
                //   $page.hide();
                // }
                $(`.QQ_chat_page`).hide();
            }
            async function QQ_ChangeChatPage(event, directName = null) {
                const $QQpage = $("#App_QQ");
                if ($QQpage.length === 0) {
                    console.log("è·å–QQpageå¤±è´¥");
                    return;
                }
                
                let name;
                if (directName) {
                    // ç›´æ¥ä¼ å…¥åç§°ï¼ˆç”¨äºç¾¤èŠï¼‰
                    name = directName;
                } else {
                    // ä»äº‹ä»¶è·å–åç§°ï¼ˆç”¨äºç§èŠï¼‰
                    let element = event.currentTarget;
                    name = element.getAttribute("data-name") ?? "";
                }
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºç¾¤èŠ
                const isGroup = QQ_Groups.includes(name);
                console.log(`åˆ‡æ¢åˆ°èŠå¤©é¡µ: ${name}, æ˜¯å¦ä¸ºç¾¤èŠ: ${isGroup}`);
                
                // *** é˜¶æ®µäºŒï¼šèŠå¤©åˆ‡æ¢ä¸Šä¸‹æ–‡è®°å½• ***
                const previousChatName = window.QQ_SystemContext.currentChatName;
                const previousChatType = window.QQ_SystemContext.currentChatType;
                
                // æ›´æ–°å½“å‰èŠå¤©ä¸Šä¸‹æ–‡
                window.QQ_SystemContext.currentChatName = name;
                window.QQ_SystemContext.currentChatType = isGroup ? 'group' : 'private';
                
                // æ¸…é™¤è¯¥è§’è‰²çš„æœªè¯»ä¸»åŠ¨æ¶ˆæ¯è®¡æ•°
                if (!isGroup) {
                    QQ_MarkMessagesAsRead(name);
                }
                
                // è®°å½•èŠå¤©åˆ‡æ¢äº‹ä»¶
                if (previousChatName !== name || previousChatType !== window.QQ_SystemContext.currentChatType) {
                    QQ_AddSystemEvent(QQ_SystemEventTypes.CHAT_SWITCH, {
                        fromChat: previousChatName,
                        fromType: previousChatType,
                        toChat: name,
                        chatType: window.QQ_SystemContext.currentChatType,
                        timestamp: new Date().toISOString()
                    });
                }
                
                let $page = $(`.QQ_chat_page[data-name='${name}']`);
                if ($page.length === 0) {
                    console.log(`${name}çš„èŠå¤©é¡µä¸å­˜åœ¨,å¼€å§‹åˆ›å»º`);
                    $page = $(await QQ_CreatChatPage(name));
                    $QQpage.append($page);
                }
                
                // å¦‚æœæ˜¯ç¾¤èŠï¼Œè®¾ç½®ç‰¹æ®Šçš„CSSç±»å’Œå±æ€§
                if (isGroup) {
                    $page.addClass('group-chat-page');
                    $page.attr('data-group-type', 'true');
                    
                    // æ›´æ–°èŠå¤©é¡µé¢çš„æ ‡é¢˜æ˜¾ç¤ºç¾¤èŠä¿¡æ¯
                    const $username = $page.find('#QQ_chat_username');
                    if ($username.length > 0) {
                        const groupData = QQ_msgjson.ç¾¤èŠ[name];
                        const memberCount = groupData && groupData.members ? groupData.members.length : 0;
                        $username.html(`${name} <span style="font-size: 12px; color: #999; font-weight: normal;">(${memberCount}äºº)</span>`);
                    }
                    
                    // ç¡®ä¿ç¾¤èŠè¾“å…¥æ¡†æœ‰æ­£ç¡®çš„ç±»åå’Œå±æ€§
                    const $input = $page.find('.QQ_chat_input');
                    $input.addClass('userInput');
                    $input.attr('data-name', name);
                }
                
                QQ_SetHomeTips(name, "0");
                
                // *** æ–°å¢ï¼šç‚¹å‡»èŠå¤©æ—¶æ ‡è®°ä¸ºå·²è¯» ***
                QQ_MarkAsRead(name);
                
                // *** æ–°å¢ï¼šé¡µé¢åˆ‡æ¢æ—¶éšè—å…¶ä»–è§’è‰²çš„ç²¾çµæŒ‰é’®ï¼Œåªä¿ç•™å½“å‰è§’è‰²çš„ç²¾çµ ***
                if (!isGroup) {
                    // ç§èŠé¡µé¢ï¼Œéšè—å…¶ä»–è§’è‰²çš„ç²¾çµï¼Œæ˜¾ç¤ºå½“å‰è§’è‰²çš„ç²¾çµ
                    Object.keys(QQ_CharacterSpirits).forEach(characterName => {
                        if (characterName !== name) {
                            QQ_HideCharacterSpirit(characterName);
                        }
                    });
                } else {
                    // ç¾¤èŠé¡µé¢ï¼Œéšè—æ‰€æœ‰è§’è‰²ç²¾çµ
                    QQ_HideAllCharacterSpirits();
                }
                
                QQ_HideAllChat();
                // éšè—QQä¸»é¡µå’Œæ¶ˆæ¯é¡µé¢
                $("#QQ_home_page").hide();
                $("#QQ_message_list_page").hide();
                $("#QQ_space_page").hide();
                // éšè—åº•éƒ¨å¯¼èˆªæ 
                $(".QQ_bottom_nav").hide();
                
                // *** ä¿®å¤ï¼šåˆå§‹åŒ–å·²å¤„ç†çš„äº’åŠ¨å†…å®¹IDé›†åˆï¼Œä½†ä¸æ¸…ç©ºç°æœ‰æ•°æ® ***
                if (!window.QQ_ProcessedInteractiveIds) {
                    window.QQ_ProcessedInteractiveIds = new Set();
                    console.log('ğŸ†• åˆå§‹åŒ–äº’åŠ¨å†…å®¹IDé›†åˆ');
                } else {
                    console.log(`ğŸ“‹ å¤ç”¨ç°æœ‰äº’åŠ¨å†…å®¹IDé›†åˆï¼Œå½“å‰æ•°é‡: ${window.QQ_ProcessedInteractiveIds.size}`);
                }
                
                $page.show();
                console.log(`æ˜¾ç¤ºèŠå¤©é¡µ:QQ_chat_${name}`);
                let $msgContent = $page.find(".msgcontent");
                $msgContent.scrollTop($msgContent[0].scrollHeight);
                let TipsCount = QQ_GetChatShowTipsCount(name);
                const $Tips = $page.find(`.new_tips`);
                $Tips.text(TipsCount);
                if (TipsCount > 0) {
                    $Tips.css("display", "flex");
                } else {
                    $Tips.hide();
                }
            }
            /**
             * åˆ›å»ºèŠå¤©é¡µ
             * @param name èŠå¤©é¡µåç§°
             * @returns èŠå¤©é¡µHTML
             */
             async function QQ_CreatChatPage(name) {
                console.log(`åˆ›å»ºèŠå¤©é¡µ: ${name}`);
                const isGroup = QQ_Groups.includes(name);
                
                // ä½¿ç”¨æ¨¡æ¿åˆ›å»ºé¡µé¢
                let $page = $(_.template(chat_page)({
                    name: name,
                    isGroup: isGroup,
                    members: isGroup ? (QQ_msgjson.ç¾¤èŠ[name]?.members || []).join(', ') : ''
                }));

                // *** æ ¸å¿ƒä¿®å¤ï¼šåˆ›å»ºé¡µé¢åï¼Œç«‹å³åŠ è½½å¹¶æ˜¾ç¤ºå·²æœ‰æ¶ˆæ¯ï¼ˆæ”¯æŒåˆ†é¡µï¼‰ ***
                const $msgContent = $page.find(".msgcontent");
                let allMessages = [];
                
                if (isGroup && QQ_msgjson.ç¾¤èŠ[name] && QQ_msgjson.ç¾¤èŠ[name].msgs) {
                    allMessages = QQ_msgjson.ç¾¤èŠ[name].msgs;
                } else if (!isGroup) {
                    // *** ä¿®å¤ï¼šä½¿ç”¨æ›´ç¨³å®šçš„ç§èŠæ¶ˆæ¯åŠ è½½æœºåˆ¶ ***
                    allMessages = QQ_LoadPrivateChatMessages(name);
                }
                
                if (allMessages.length > 0) {
                    console.log(`ä¸ºæ–°åˆ›å»ºçš„èŠå¤© ${name} åŠ è½½æ¶ˆæ¯ï¼Œæ€»æ•°: ${allMessages.length}`);
                    
                    // åˆå§‹åŒ–æ˜¾ç¤ºè®¡æ•°
                    chatDisplayCounts[name] = 0;
                    
                    // è®¡ç®—è¦æ˜¾ç¤ºçš„æ¶ˆæ¯æ•°é‡ï¼ˆä»æœ€æ–°çš„å¼€å§‹ï¼Œæœ€å¤šæ˜¾ç¤ºCHAT_DISPLAY_LIMITæ¡ï¼‰
                    const startIndex = Math.max(0, allMessages.length - CHAT_DISPLAY_LIMIT);
                    const messagesToShow = allMessages.slice(startIndex);
                    
                    // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
                    for (const msg of messagesToShow) {
                        await QQ_Chat_AddMsg($msgContent[0], msg, name, false, true); // è·³è¿‡åˆ†é¡µæ§åˆ¶
                    }
                    
                    // æ›´æ–°æ˜¾ç¤ºè®¡æ•°
                    chatDisplayCounts[name] = messagesToShow.length;
                    
                    // æ·»åŠ "åŠ è½½æ›´å¤š"æŒ‰é’®ï¼ˆå¦‚æœéœ€è¦ï¼‰
                    QQ_Update_Chat_LoadMore(name, $msgContent[0]);
                    
                    console.log(`èŠå¤©é¡µé¢åŠ è½½å®Œæˆ: æ˜¾ç¤º ${messagesToShow.length}/${allMessages.length} æ¡æ¶ˆæ¯`);
                    
                    // *** ä¿®å¤ï¼šæ£€æŸ¥é¡µé¢ä¸­æ˜¯å¦åŒ…å«äº’åŠ¨å†…å®¹å ä½ç¬¦ï¼Œå¦‚æœ‰åˆ™æ ‡è®°è¯¥èŠå¤©å·²è§¦å‘ ***
                    const hasInteractivePlaceholder = allMessages.some(msg => 
                        msg && msg.includes && msg.includes('[å‘ç”Ÿäº†ä¸€æ®µäº’åŠ¨ (ID:')
                    );
                    if (hasInteractivePlaceholder) {
                        console.log(`ğŸ­ èŠå¤©é¡µé¢ ${name} åŒ…å«äº’åŠ¨å†…å®¹å ä½ç¬¦ï¼Œæ ‡è®°ä¸ºå·²è§¦å‘ï¼ˆä»é¡µé¢åŠ è½½ï¼‰`);
                        QQ_InteractiveMode.markChatTriggered(name);
                    }
                }
                
                // æ»šåŠ¨åˆ°åº•éƒ¨
                $msgContent.scrollTop($msgContent[0].scrollHeight);

                return $page;
            }
            function QQ_Msg_DelUserKey(content) {
                let json = JsonYamlParse(content);
                if (!json) {
                    return content;
                }
                let others = "";
                if (`${UserName}` in json.ç§èŠ == false) {
                    return content;
                }
                for (let msg of json.ç§èŠ[`${UserName}`]) {
                    const sp = msg.split("--");
                    if (sp.length <= 0) {
                        continue;
                    }
                    if (sp[0] != `${UserName}`) {
                        if (!others) {
                            others = sp[0];
                        } else if (sp[0] != others) {
                            // å‡ºç°ç¬¬ä¸‰ä¸ªåå­—,è¿‡äºå¤æ‚ä¸åšå¤„ç†
                            return content;
                        }
                    }
                }
                if (!others) {
                    // æ²¡å–åˆ°å¯¹æ–¹åå­—
                    if (json.ç§èŠ[`${UserName}`].length == 0) {
                        delete json.ç§èŠ[`${UserName}`];
                        return JSON.stringify(json);
                    }
                    return content;
                }
                if (others in json.ç§èŠ == false) {
                    // ä¸å­˜åœ¨å¯¹æ–¹åå­—é”®,ç›´æ¥æ”¹å
                    const newvalue = json.ç§èŠ[`${UserName}`];
                    delete json.ç§èŠ[`${UserName}`];
                    json.ç§èŠ[others] = newvalue;
                    return JSON.stringify(json);
                } else if (json.ç§èŠ[others].length == 0) {
                    // å­˜åœ¨ä½†ä¸ºç©º
                    const newvalue = json.ç§èŠ[`${UserName}`];
                    delete json.ç§èŠ[`${UserName}`];
                    json.ç§èŠ[others] = newvalue;
                    return JSON.stringify(json);
                }
                return content;
            }
            function QQ_AddNpcHead(content) {
                let json = JsonYamlParse(content);
                if (!json) {
                    return content;
                }
                // å¤´åƒä¿®å¤
                const Sections = QQ_CharSettings.getAllSections();
                let newcss = "";
                for (let str in json.ç§èŠ) {
                    for (const msg of json.ç§èŠ[str]) {
                        const sp = msg.split("--");
                        if (sp.length <= 1) {
                            continue;
                        }
                        const name = sp[0];
                        if (!Sections.includes(name) && name != `${UserName}`) {
                            // è·¯äºº,è®¾ç½®éšæœºå¤´åƒ
                            System_AddNpcHead(name);
                        }
                    }
                }
                for (let Group in json.ç¾¤èŠ) {
                    for (const msg of json.ç¾¤èŠ[Group].msgs) {
                        const sp = msg.split("--");
                        if (sp.length <= 0) {
                            continue;
                        }
                        const name = sp[0];
                        if (!Sections.includes(name) && name != `${UserName}`) {
                            // è·¯äºº,è®¾ç½®éšæœºå¤´åƒ
                            System_AddNpcHead(name);
                        }
                    }
                }
            }
            function QQ_Msg_Repair(content) {
                let json = JsonYamlParse(content);
                if (!json) {
                    return content;
                }
                // ä¿®æ­£é¡ºåº
                for (let str in json.ç§èŠ) {
                    const match = str.match(/(.+?)å’Œ(.+?)çš„èŠå¤©/);
                    if (!match) {
                        // æ—§ç‰ˆæœ¬åªæœ‰ä¸€ä¸ªåå­—
                        if (str != `${UserName}`) {
                            const value = json.ç§èŠ[str];
                            delete json.ç§èŠ[str];
                            json.ç§èŠ[`${UserName}å’Œ${str}çš„èŠå¤©`] = value;
                        } else {
                            delete json.ç§èŠ[str];
                        }
                        continue;
                    }
                    if (
                        match[1] != `${UserName}` &&
                        match[2] != `${UserName}`
                    ) {
                        // ä¿©è§’è‰²ä¹‹é—´çš„ç§èŠ,å±äºç‰¹æ®Šæƒ…å†µç›´æ¥åˆ äº†
                        console.log(`åˆ é™¤:${str}`);
                        delete json.ç§èŠ[str];
                        continue;
                    }
                    if (
                        match[1] != `${UserName}` &&
                        match[2] == `${UserName}`
                    ) {
                        // é¡ºåºåäº†
                        const value = json.ç§èŠ[str];
                        delete json.ç§èŠ[str];
                        json.ç§èŠ[`${UserName}å’Œ${match[1]}çš„èŠå¤©`] = value;
                    }
                }
                // ä¿®æ­£ç½‘å
                const keys = QQ_CharSettings.getAllSections();
                for (let str in json.ç§èŠ) {
                    const match = str.match(/(.+?)å’Œ(.+?)çš„èŠå¤©/);
                    if (!match) {
                        continue;
                    }
                    // ä¸ç®¡æœ‰æ²¡æœ‰é”™å…ˆä¿®æ­£ä¸€æ¬¡å†…å®¹
                    let value = QQ_NickNameRepair(json.ç§èŠ[str]);
                    json.ç§èŠ[str] = value;
                    const localname = match[2];
                    if (!keys.includes(localname)) {
                        // é”®åæ˜¯ç”¨çš„ç½‘å,ä¿®æ­£
                        for (const char of keys) {
                            let find = false;
                            const namelist = QQ_CharSettings.readValue(
                                char,
                                "ç½‘å",
                            ).split(",");
                            if (!namelist || namelist.length == 0) {
                                continue;
                            }
                            for (const name of namelist) {
                                const regex = createRegExp(name);
                                if (!name || !regex) {
                                    continue;
                                }
                                if (localname.match(regex)) {
                                    delete json.ç§èŠ[str];
                                    json.ç§èŠ[`${UserName}å’Œ${char}çš„èŠå¤©`] =
                                        value;
                                    find = true;
                                    break;
                                }
                            }
                            if (find) {
                                break;
                            }
                        }
                    }
                }
                for (const Group in json.ç¾¤èŠ) {
                    json.ç¾¤èŠ[Group].msgs = QQ_NickNameRepair(
                        json.ç¾¤èŠ[Group].msgs,
                    );
                }
                QQ_AddNpcHead(JSON.stringify(json));
                return JSON.stringify(json);
            }
            function QQ_NickNameRepair(content) {
                if (!content || content.length == 0) {
                    return content;
                }
                let charlist = QQ_CharSettings.getAllSections();
                let result = [];
                for (let str of content) {
                    const match = str.match(/(.+?)--([\s\S]+)/);
                    if (match && match[1] != UserName) {
                        const localname = match[1];
                        if (!charlist.includes(localname)) {
                            for (const char of charlist) {
                                let find = false;
                                const namelist = QQ_CharSettings.readValue(
                                    char,
                                    "ç½‘å",
                                ).split(",");
                                if (!namelist || namelist.length == 0) {
                                    continue;
                                }
                                for (const name of namelist) {
                                    if (!name) {
                                        continue;
                                    }
                                    if (name.match(/^\/(.+)\/([gimuy]*)$/)) {
                                        // åå­—æ˜¯æ­£åˆ™è¡¨è¾¾å¼
                                        const regex = createRegExp(name);
                                        if (!regex) {
                                            continue;
                                        }
                                        if (localname.match(regex)) {
                                            str = `${char}--${match[2]}`;
                                            find = true;
                                            break;
                                        }
                                    } else {
                                        // åå­—ä¸æ˜¯æ­£åˆ™è¡¨è¾¾å¼
                                        if (namelist.includes(localname)) {
                                            str = `${char}--${match[2]}`;
                                            find = true;
                                            break;
                                        }
                                    }
                                }
                                if (find) {
                                    break;
                                }
                            }
                        }
                    }
                    result.push(str);
                }
                return result;
            }
            function createRegExp(pattern) {
                if (!pattern) return null;
                // å¦‚æœå·²ç»æ˜¯RegExpå¯¹è±¡ï¼Œç›´æ¥è¿”å›
                if (pattern instanceof RegExp) return pattern;
                try {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ /pattern/flags æ ¼å¼
                    const regexMatch = pattern.match(/^\/(.+)\/([gimuy]*)$/);
                    if (regexMatch) {
                        // æå–æ­£åˆ™è¡¨è¾¾å¼çš„æ¨¡å¼å’Œæ ‡å¿—
                        const [_, regexPattern, flags] = regexMatch;
                        return new RegExp(regexPattern, flags);
                    } else {
                        // ä¸å¸¦/çš„çº¯å­—ç¬¦ä¸²æ ¼å¼ï¼Œé»˜è®¤ä¸åŠ ä»»ä½•æ ‡å¿—
                        return new RegExp(pattern);
                    }
                } catch (error) {
                    console.error("åˆ›å»ºæ­£åˆ™è¡¨è¾¾å¼å¤±è´¥:", error);
                    return null;
                }
            }
            
            /**
             * *** æ–°å¢ï¼šç§èŠè®¿é—®æƒé™éªŒè¯ ***
             * ç¡®ä¿ç§èŠæ¶ˆæ¯ä¸ä¼šæ³„éœ²ç»™éå‚ä¸è€…
             * @param {string} participant1 - å‚ä¸è€…1
             * @param {string} participant2 - å‚ä¸è€…2
             * @param {string} accessType - è®¿é—®ç±»å‹ï¼ˆ'user', 'character', 'system'ï¼‰
             * @returns {boolean} æ˜¯å¦å…è®¸è®¿é—®
             */
            function QQ_ValidatePrivateChatAccess(participant1, participant2, accessType) {
                // åŸºæœ¬éªŒè¯ï¼šå‚ä¸è€…ä¸èƒ½ä¸ºç©º
                if (!participant1 || !participant2) {
                    console.warn('âŒ ç§èŠè®¿é—®éªŒè¯å¤±è´¥ï¼šå‚ä¸è€…ä¿¡æ¯ä¸å®Œæ•´');
                    return false;
                }
                
                // ç”¨æˆ·å‚ä¸çš„ç§èŠå¿…é¡»åŒ…å«ç”¨æˆ·
                if (accessType === 'user' && 
                    participant1 !== UserName && participant2 !== UserName) {
                    console.warn('âŒ ç”¨æˆ·ç§èŠè®¿é—®éªŒè¯å¤±è´¥ï¼šç”¨æˆ·ä¸åœ¨å‚ä¸è€…åˆ—è¡¨ä¸­');
                    return false;
                }
                
                // è§’è‰²é—´ç§èŠä¸åº”åŒ…å«ç”¨æˆ·
                if (accessType === 'character' && 
                    (participant1 === UserName || participant2 === UserName)) {
                    console.warn('âŒ è§’è‰²ç§èŠè®¿é—®éªŒè¯å¤±è´¥ï¼šåŒ…å«ç”¨æˆ·å‚ä¸è€…');
                    return false;
                }
                
                // é˜²æ­¢è‡ªæˆ‘å¯¹è¯
                if (participant1 === participant2) {
                    console.warn('âŒ ç§èŠè®¿é—®éªŒè¯å¤±è´¥ï¼šä¸å…è®¸è‡ªæˆ‘å¯¹è¯');
                    return false;
                }
                
                console.log(`âœ… ç§èŠè®¿é—®éªŒè¯é€šè¿‡: ${participant1} <-> ${participant2} (${accessType})`);
                return true;
            }
            
            /**
             * *** æ–°å¢ï¼šç”Ÿæˆå®‰å…¨çš„èŠå¤©ID ***
             * é˜²æ­¢èŠå¤©IDå†²çªå’Œæœªæˆæƒè®¿é—®
             * @param {string} participant1 - å‚ä¸è€…1
             * @param {string} participant2 - å‚ä¸è€…2
             * @returns {string} å®‰å…¨çš„èŠå¤©ID
             */
            function QQ_GenerateSecureChatId(participant1, participant2) {
                // æ ‡å‡†åŒ–å‚ä¸è€…é¡ºåºï¼ˆå­—æ¯åºï¼‰
                const sortedParticipants = [participant1, participant2].sort();
                const baseId = sortedParticipants.join('_');
                
                // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢å†²çª
                const timestamp = Date.now();
                
                // ç”Ÿæˆç®€å•å“ˆå¸Œï¼ˆç”¨äºéšç§ä¿æŠ¤ï¼‰
                let hash = 0;
                for (let i = 0; i < baseId.length; i++) {
                    const char = baseId.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // è½¬æ¢ä¸º32ä½æ•´æ•°
                }
                
                return `${Math.abs(hash)}_${timestamp % 100000}`;
            }
            
            /**
             * *** æ–°å¢ï¼šæ£€æŸ¥ç§èŠæ¶ˆæ¯æ˜¯å¦åŒ…å«åˆ†äº«æ„å›¾ ***
             * æ£€æµ‹è§’è‰²æ˜¯å¦ä¸»åŠ¨å°†ç§èŠå†…å®¹åˆ†äº«åˆ°ç¾¤èŠæˆ–åŠ¨æ€
             * @param {string} message - æ¶ˆæ¯å†…å®¹
             * @returns {Object} åˆ†äº«æ£€æµ‹ç»“æœ
             */
            function QQ_DetectPrivateChatSharingIntent(message) {
                const sharingKeywords = [
                    'å‘Šè¯‰å¤§å®¶', 'è·Ÿå¤§å®¶è¯´', 'åˆ†äº«ç»™å¤§å®¶', 'ç»™å¤§å®¶çœ‹',
                    'å‘åˆ°ç¾¤é‡Œ', 'å‘åˆ°ç©ºé—´', 'å‘åŠ¨æ€', 'è½¬å‘ç»™',
                    'æˆªå›¾åˆ†äº«', 'å‘Šè¯‰æ‰€æœ‰äºº', 'å…¬å¼€è¿™ä¸ªæ¶ˆæ¯'
                ];
                
                const hasShareIntent = sharingKeywords.some(keyword => 
                    message.includes(keyword)
                );
                
                return {
                    hasShareIntent,
                    detectedKeywords: sharingKeywords.filter(keyword => 
                        message.includes(keyword)
                    )
                };
            }
            
            /**
             * *** æ–°å¢ï¼šç”Ÿæˆå¼ºå¥çš„æ¶ˆæ¯å“ˆå¸Œå€¼ ***
             * ä½¿ç”¨æ”¹è¿›çš„ç®—æ³•å‡å°‘å“ˆå¸Œå†²çªï¼Œæé«˜æ¶ˆæ¯å»é‡çš„å‡†ç¡®æ€§
             * @param {string} content - æ¶ˆæ¯å†…å®¹
             * @returns {string} å¼ºå¥çš„å“ˆå¸Œå€¼
             */
            function QQ_GenerateRobustMessageHash(content) {
                if (!content || typeof content !== 'string') {
                    return `empty_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
                }
                
                // *** é¢„å¤„ç†ï¼šæ ‡å‡†åŒ–å†…å®¹ ***
                const normalizedContent = content
                    .trim()
                    .replace(/\s+/g, ' ')  // æ ‡å‡†åŒ–ç©ºç™½å­—ç¬¦
                    .replace(/[\r\n]+/g, '\n');  // æ ‡å‡†åŒ–æ¢è¡Œç¬¦
                
                // *** ä½¿ç”¨æ›´å¼ºçš„å“ˆå¸Œç®—æ³•ï¼ˆFNV-1açš„ç®€åŒ–ç‰ˆæœ¬ï¼‰ ***
                let hash = 2166136261; // FNV offset basis
                const fnvPrime = 16777619;
                
                for (let i = 0; i < normalizedContent.length; i++) {
                    hash ^= normalizedContent.charCodeAt(i);
                    hash = (hash * fnvPrime) >>> 0; // ä¿æŒ32ä½æ— ç¬¦å·æ•´æ•°
                }
                
                // *** æ·»åŠ å†…å®¹é•¿åº¦å’Œæ—¶é—´æˆ³ä»¥è¿›ä¸€æ­¥å‡å°‘å†²çª ***
                const lengthFactor = normalizedContent.length;
                const timeFactor = Date.now() % 1000000; // å–æ—¶é—´æˆ³å6ä½
                
                // åˆ›å»ºå¤åˆå“ˆå¸Œ
                const compositeHash = `${hash.toString(36)}_${lengthFactor}_${timeFactor}`;
                
                // *** é¢å¤–å®‰å…¨æªæ–½ï¼šæ£€æŸ¥æ˜¯å¦æ˜¯å·²çŸ¥çš„é«˜å†²çªå†…å®¹ ***
                const contentSignature = QQ_GenerateContentSignature(normalizedContent);
                
                return `${compositeHash}_${contentSignature}`;
            }
            
            /**
             * *** æ–°å¢ï¼šç”Ÿæˆå†…å®¹ç‰¹å¾ç­¾å ***
             * ç”¨äºè¿›ä¸€æ­¥åŒºåˆ†ç›¸ä¼¼ä½†ä¸åŒçš„æ¶ˆæ¯å†…å®¹
             * @param {string} content - æ ‡å‡†åŒ–åçš„å†…å®¹
             * @returns {string} å†…å®¹ç‰¹å¾ç­¾å
             */
            function QQ_GenerateContentSignature(content) {
                // æå–å…³é”®ç‰¹å¾
                const features = {
                    firstChar: content.charCodeAt(0) || 0,
                    lastChar: content.charCodeAt(content.length - 1) || 0,
                    length: content.length,
                    wordCount: content.split(/\s+/).length,
                    uniqueChars: new Set(content).size
                };
                
                // ç”Ÿæˆç‰¹å¾ç­¾å
                const signature = `${features.firstChar}${features.lastChar}${features.length}${features.wordCount}${features.uniqueChars}`;
                
                // è¿›ä¸€æ­¥å¤„ç†ä¸ºè¾ƒçŸ­çš„æ ‡è¯†ç¬¦
                let compactSignature = 0;
                for (let i = 0; i < signature.length; i++) {
                    compactSignature = (compactSignature * 31 + parseInt(signature[i]) || 0) >>> 0;
                }
                
                return compactSignature.toString(36);
            }
            
            /**
             * *** æ–°å¢ï¼šæ‹†åˆ†é•¿æ¶ˆæ¯å¤„ç†å‡½æ•° ***
             * æ ¹æ®æç¤ºè¯è§„åˆ™ï¼Œè¯†åˆ«å¹¶æ‹†åˆ†åŒ…å«\\nçš„é•¿æ¶ˆæ¯
             * @param {string} messageContent - åŸå§‹æ¶ˆæ¯å†…å®¹
             * @returns {string[]} æ‹†åˆ†åçš„æ¶ˆæ¯æ•°ç»„
             */
            function QQ_SplitLongMessage(messageContent) {
                if (!messageContent || typeof messageContent !== 'string') {
                    return [messageContent || ''];
                }
                
                // *** æ£€æŸ¥æ˜¯å¦åŒ…å«æµå¼åˆ†å‰²æ ‡è®° ***
                const hasRealNewline = messageContent.includes('\n');
                const hasLiteralNewline = messageContent.includes('\\n');
                const hasPause = messageContent.includes('[PAUSE]');
                
                if (!hasRealNewline && !hasLiteralNewline && !hasPause) {
                    return [messageContent];
                }
                
                console.log(`ğŸ” æ£€æµ‹åˆ°æµå¼æ¶ˆæ¯åˆ†å‰²æ ‡è®° - æ¢è¡Œç¬¦: ${hasRealNewline}, \\n: ${hasLiteralNewline}, [PAUSE]: ${hasPause}`);
                
                // *** æŒ‰å¤šç§åˆ†å‰²ç¬¦æ‹†åˆ†æ¶ˆæ¯ ***
                let parts = [messageContent];
                
                // æ”¯æŒçœŸæ­£çš„æ¢è¡Œç¬¦ \n
                if (hasRealNewline) {
                    parts = parts.flatMap(part => part.split('\n'));
                }
                
                // æ”¯æŒå­—é¢é‡ \\nï¼ˆå‘åå…¼å®¹ï¼‰
                if (hasLiteralNewline) {
                    parts = parts.flatMap(part => part.split('\\n'));
                }
                
                // æ”¯æŒ [PAUSE] æ ‡è®°
                if (hasPause) {
                    parts = parts.flatMap(part => part.split('[PAUSE]'));
                }
                
                // æ¸…ç†å’Œè¿‡æ»¤
                parts = parts
                    .map(part => part.trim())
                    .filter(part => part.length > 0);
                
                if (parts.length <= 1) {
                    return [messageContent];
                }
                
                console.log(`âœ… æµå¼æ¶ˆæ¯æ‹†åˆ†æˆåŠŸ: ${parts.length}æ¡å­æ¶ˆæ¯`, parts);
                
                // *** æ™ºèƒ½æ‹†åˆ†ä¼˜åŒ– ***
                const optimizedParts = QQ_OptimizeSplitMessages(parts);
                
                return optimizedParts;
            }
            
            /**
             * *** æ–°å¢ï¼šä¼˜åŒ–æ‹†åˆ†çš„æ¶ˆæ¯ ***
             * æ™ºèƒ½åˆå¹¶è¿‡çŸ­çš„æ¶ˆæ¯ç‰‡æ®µï¼Œç¡®ä¿æ¯æ¡æ¶ˆæ¯éƒ½æœ‰åˆç†çš„é•¿åº¦
             * @param {string[]} parts - åŸå§‹æ‹†åˆ†çš„æ¶ˆæ¯ç‰‡æ®µ
             * @returns {string[]} ä¼˜åŒ–åçš„æ¶ˆæ¯æ•°ç»„
             */
            function QQ_OptimizeSplitMessages(parts) {
                if (!parts || parts.length <= 1) {
                    return parts;
                }
                
                const optimized = [];
                let currentPart = '';
                const MIN_PART_LENGTH = 8;  // æœ€å°æ¶ˆæ¯é•¿åº¦
                const MAX_PART_LENGTH = 100; // æœ€å¤§å•æ¡æ¶ˆæ¯é•¿åº¦
                
                for (let i = 0; i < parts.length; i++) {
                    const part = parts[i];
                    
                    // å¦‚æœå½“å‰éƒ¨åˆ†å¤ªçŸ­ï¼Œå°è¯•ä¸ä¸‹ä¸€éƒ¨åˆ†åˆå¹¶
                    if (part.length < MIN_PART_LENGTH && i < parts.length - 1) {
                        const nextPart = parts[i + 1];
                        const combined = `${part} ${nextPart}`;
                        
                        if (combined.length <= MAX_PART_LENGTH) {
                            // åˆå¹¶å½“å‰éƒ¨åˆ†å’Œä¸‹ä¸€éƒ¨åˆ†
                            parts[i + 1] = combined;
                            continue; // è·³è¿‡å½“å‰éƒ¨åˆ†ï¼Œåœ¨ä¸‹ä¸€æ¬¡è¿­ä»£å¤„ç†åˆå¹¶ç»“æœ
                        }
                    }
                    
                    // å¦‚æœå½“å‰éƒ¨åˆ†å¤ªé•¿ï¼Œè¿›ä¸€æ­¥æ‹†åˆ†
                    if (part.length > MAX_PART_LENGTH) {
                        const subParts = QQ_SplitOverlongMessage(part, MAX_PART_LENGTH);
                        optimized.push(...subParts);
                    } else {
                        optimized.push(part);
                    }
                }
                
                console.log(`ğŸ”§ æ¶ˆæ¯æ‹†åˆ†ä¼˜åŒ–å®Œæˆ: ${parts.length} -> ${optimized.length}æ¡`, optimized);
                return optimized;
            }
            
            /**
             * *** é˜¶æ®µä¸€æ ¸å¿ƒï¼šæµå¼æ¶ˆæ¯æ˜¾ç¤ºç³»ç»Ÿ ***
             * å®ç°ä¼ªå®æ—¶æµå¼èŠå¤©ï¼Œæ‰“ç ´ä¸€é—®ä¸€ç­”å¾ªç¯çš„å…³é”®ç»„ä»¶
             */
            
            /**
             * ç”Ÿæˆéšæœºå»¶è¿Ÿæ—¶é—´ï¼ˆæ¨¡æ‹ŸçœŸäººæ‰“å­—èŠ‚å¥ï¼‰
             * @param {number} baseDelay - åŸºç¡€å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
             * @param {number} variance - å˜åŒ–èŒƒå›´ï¼ˆ0-1ï¼‰
             * @returns {number} éšæœºå»¶è¿Ÿæ—¶é—´
             */
            function QQ_GenerateRandomDelay(baseDelay = 1200, variance = 0.6) {
                const min = baseDelay * (1 - variance);
                const max = baseDelay * (1 + variance);
                return Math.floor(Math.random() * (max - min) + min);
            }
            
            /**
             * æ˜¾ç¤º"æ­£åœ¨è¾“å…¥..."åŠ¨ç”»
             * @param {Element} chatContainer - èŠå¤©å®¹å™¨
             * @param {string} senderName - å‘é€è€…åç§°
             * @returns {Element} è¾“å…¥æŒ‡ç¤ºå™¨å…ƒç´ 
             */
            function QQ_ShowTypingIndicator(chatContainer, senderName) {
                // ç§»é™¤å·²å­˜åœ¨çš„è¾“å…¥æŒ‡ç¤ºå™¨ï¼ˆä»æ‰€æœ‰å¯èƒ½ä½ç½®ç§»é™¤ï¼‰
                const existingIndicators = document.querySelectorAll('.typing-indicator');
                existingIndicators.forEach(indicator => {
                    // æ¸…ç†å®šæ—¶å™¨
                    if (indicator.avatarInterval) {
                        clearInterval(indicator.avatarInterval);
                    }
                    indicator.remove();
                });
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºç¾¤èŠ
                const currentChatPage = chatContainer.closest('.QQ_chat_page');
                const chatName = currentChatPage ? currentChatPage.dataset.name : '';
                const isGroupChat = QQ_Groups.includes(chatName);
                
                // åˆ›å»ºè¾“å…¥æŒ‡ç¤ºå™¨ - æ‚¬æµ®åœ¨è¾“å…¥æ¡†æ­£ä¸Šæ–¹
                const typingIndicator = document.createElement('div');
                typingIndicator.className = 'typing-indicator';
                
                // *** ä¿®å¤ï¼šæ›´ç¨³å®šçš„è¾“å…¥å®¹å™¨æŸ¥æ‰¾æ–¹æ³• ***
                // æ–¹æ³•1ï¼šä»å½“å‰èŠå¤©é¡µé¢æŸ¥æ‰¾
                let inputContainer = null;
                if (currentChatPage) {
                    inputContainer = currentChatPage.querySelector('.input-container');
                }
                
                // æ–¹æ³•2ï¼šæŸ¥æ‰¾å½“å‰æ˜¾ç¤ºçš„èŠå¤©é¡µé¢ï¼ˆdisplayä¸ä¸ºnoneï¼‰
                if (!inputContainer) {
                    const visibleChatPages = document.querySelectorAll('.QQ_chat_page');
                    for (const page of visibleChatPages) {
                        const style = window.getComputedStyle(page);
                        if (style.display !== 'none') {
                            inputContainer = page.querySelector('.input-container');
                            if (inputContainer) break;
                        }
                    }
                }
                
                // æ–¹æ³•3ï¼šç›´æ¥æŸ¥æ‰¾ç¬¬ä¸€ä¸ªå¯è§çš„è¾“å…¥å®¹å™¨
                if (!inputContainer) {
                    const allInputContainers = document.querySelectorAll('.input-container');
                    for (const container of allInputContainers) {
                        const style = window.getComputedStyle(container);
                        if (style.display !== 'none' && style.visibility !== 'hidden') {
                            inputContainer = container;
                            break;
                        }
                    }
                }
                
                if (!inputContainer) {
                    console.warn('âŒ æœªæ‰¾åˆ°è¾“å…¥å®¹å™¨ï¼Œæ— æ³•æ˜¾ç¤ºè¾“å…¥æŒ‡ç¤ºå™¨');
                    return null;
                }
                
                typingIndicator.style.cssText = `
                    position: absolute;
                    top: 50%;
                    left: 55px;
                    transform: translateY(-50%);
                    display: flex;
                    align-items: center;
                    padding: 4px 8px;
                    background: transparent;
                    border-radius: 0;
                    animation: fadeIn 0.3s ease-out;
                    z-index: 10;
                    pointer-events: none;
                    min-width: 140px;
                    max-width: calc(100% - 40px);
                    font-size: 12px;
                    height: 50px;
                `;
                
                // å°†è¾“å…¥æŒ‡ç¤ºå™¨æ·»åŠ åˆ°è¾“å…¥å®¹å™¨å†…
                if (inputContainer) {
                    // ä¸è¦ä¿®æ”¹input-containerçš„positionï¼Œå› ä¸ºå®ƒå·²ç»æ˜¯absoluteå®šä½
                    // åªæ˜¯ç¡®ä¿å®ƒå¯ä»¥åŒ…å«ç»å¯¹å®šä½çš„å­å…ƒç´ 
                    inputContainer.appendChild(typingIndicator);
                    console.log('âœ… è¾“å…¥æŒ‡ç¤ºå™¨å·²æ·»åŠ åˆ°è¾“å…¥å®¹å™¨');
                }
                
                // åˆ›å»ºå¤´åƒ - ç§èŠå›ºå®šå¤´åƒï¼Œç¾¤èŠéšæœºå˜åŒ–
                const avatar = document.createElement('div');
                avatar.className = 'head'; // ä½¿ç”¨è§’è‰²å¤´åƒç³»ç»Ÿçš„CSSç±»
                avatar.style.cssText = `
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    margin-right: 8px;
                    flex-shrink: 0;
                    background-size: cover;
                    background-position: center;
                    background-repeat: no-repeat;
                    overflow: hidden;
                `;
                
                if (isGroupChat) {
                    // ç¾¤èŠï¼šä½¿ç”¨ç¾¤æˆå‘˜å¤´åƒéšæœºå˜åŒ–
                    const groupMembers = QQ_msgjson.ç¾¤èŠ && QQ_msgjson.ç¾¤èŠ[chatName] && QQ_msgjson.ç¾¤èŠ[chatName].members 
                        ? QQ_msgjson.ç¾¤èŠ[chatName].members 
                        : [];
                    
                    if (groupMembers.length > 0) {
                        // è®¾ç½®åˆå§‹å¤´åƒ
                        let currentMember = groupMembers[Math.floor(Math.random() * groupMembers.length)];
                        avatar.setAttribute('data-name', currentMember);
                        
                        // å®šæ—¶åˆ‡æ¢å¤´åƒï¼ˆåªåœ¨éç”ŸæˆæœŸé—´è¿è¡Œï¼‰
                        const avatarInterval = setInterval(() => {
                            // æ£€æŸ¥æ˜¯å¦æ­£åœ¨ç”ŸæˆAIå›å¤ï¼Œé¿å…åœ¨ç­‰å¾…æœŸé—´åˆ‡æ¢çŠ¶æ€
                            if (typeof gening !== 'undefined' && gening) {
                                console.log('ğŸ”„ AIç”Ÿæˆä¸­ï¼Œæš‚åœå¤´åƒåˆ‡æ¢');
                                return;
                            }
                            currentMember = groupMembers[Math.floor(Math.random() * groupMembers.length)];
                            avatar.setAttribute('data-name', currentMember);
                        }, Math.random() * 2500 + 500); // 0.5-3ç§’éšæœºé—´éš”
                        
                        // å­˜å‚¨å®šæ—¶å™¨IDä»¥ä¾¿æ¸…ç†
                        typingIndicator.avatarInterval = avatarInterval;
                    } else {
                        // å¦‚æœæ²¡æœ‰ç¾¤æˆå‘˜ä¿¡æ¯ï¼Œä½¿ç”¨å½“å‰èŠå¤©åç§°ä½œä¸ºé»˜è®¤
                        avatar.setAttribute('data-name', chatName);
                    }
                } else {
                    // ç§èŠï¼šä½¿ç”¨å›ºå®šè”ç³»äººå¤´åƒ
                    avatar.setAttribute('data-name', chatName);
                }
                
                // åˆ›å»ºåŠ¨ç”»ç‚¹ç‚¹
                const dots = document.createElement('div');
                dots.style.cssText = `
                    display: flex;
                    gap: 2px;
                    align-items: center;
                `;
                
                for (let i = 0; i < 3; i++) {
                    const dot = document.createElement('div');
                    dot.className = `liquid-dot dot-${i}`;
                    dot.style.cssText = `
                        width: 6px;
                        height: 6px;
                        background: radial-gradient(circle at 30% 30%, #999, #666, #555);
                        border-radius: 50%;
                        position: relative;
                        animation: liquidFlowMerge 3s infinite ease-in-out;
                        animation-delay: ${i * 0.4}s;
                        filter: blur(0.3px);
                        transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                        box-shadow: inset 0 1px 2px rgba(255,255,255,0.3), 
                                    0 2px 4px rgba(0,0,0,0.1);
                    `;
                    dots.appendChild(dot);
                }
                
                // æ·»åŠ CSSåŠ¨ç”»ï¼ˆåªæ·»åŠ ä¸€æ¬¡ï¼‰
                if (!document.querySelector('#typing-animation-styles')) {
                    const styles = document.createElement('style');
                    styles.id = 'typing-animation-styles';
                    styles.textContent = `
                        @keyframes liquidFlowMerge {
                            0% { 
                                transform: translateY(0) scale(1, 1) translateX(0);
                                opacity: 0.7;
                                border-radius: 50%;
                                filter: blur(0.3px);
                            }
                            15% { 
                                transform: translateY(-6px) scale(0.9, 1.3) translateX(-2px);
                                opacity: 0.85;
                                border-radius: 65% 35% 70% 30%;
                                filter: blur(0.2px);
                            }
                            30% { 
                                transform: translateY(-8px) scale(1.4, 0.6) translateX(3px);
                                opacity: 1;
                                border-radius: 30% 70% 25% 75%;
                                filter: blur(0.1px);
                            }
                            45% { 
                                transform: translateY(-3px) scale(0.7, 1.4) translateX(-1px);
                                opacity: 0.9;
                                border-radius: 75% 25% 80% 20%;
                                filter: blur(0.4px);
                            }
                            60% { 
                                transform: translateY(4px) scale(1.3, 0.8) translateX(2px);
                                opacity: 0.8;
                                border-radius: 40% 60% 35% 65%;
                                filter: blur(0.3px);
                            }
                            75% { 
                                transform: translateY(2px) scale(0.8, 1.2) translateX(-3px);
                                opacity: 0.85;
                                border-radius: 60% 40% 65% 35%;
                                filter: blur(0.5px);
                            }
                            100% { 
                                transform: translateY(0) scale(1, 1) translateX(0);
                                opacity: 0.7;
                                border-radius: 50%;
                                filter: blur(0.3px);
                            }
                        }
                        
                        @keyframes liquidMergeEffect {
                            0%, 100% { 
                                transform: scaleX(1) scaleY(1) skew(0deg);
                                border-radius: 50%;
                                margin: 0 1.5px;
                            }
                            33% { 
                                transform: scaleX(1.8) scaleY(0.6) skew(-5deg);
                                border-radius: 80% 20% 75% 25%;
                                margin: 0 -2px;
                            }
                            66% { 
                                transform: scaleX(0.6) scaleY(1.8) skew(5deg);
                                border-radius: 25% 75% 20% 80%;
                                margin: 0 1px;
                            }
                        }
                        
                        @keyframes typingTextFade {
                            0%, 100% { 
                                opacity: 0.6;
                                transform: scale(1);
                            }
                            50% { 
                                opacity: 0.9;
                                transform: scale(1.02);
                            }
                        }
                        
                        /* å¢å¼ºçš„æ°´æ»´èåˆæ•ˆæœ */
                        .liquid-dot.dot-0 {
                            animation: liquidFlowMerge 3s infinite ease-in-out;
                            z-index: 3;
                        }
                        .liquid-dot.dot-1 {
                            animation: liquidFlowMerge 3.2s infinite ease-in-out,
                                     liquidMergeEffect 4s infinite ease-in-out;
                            z-index: 2;
                        }
                        .liquid-dot.dot-2 {
                            animation: liquidFlowMerge 2.8s infinite ease-in-out;
                            z-index: 1;
                        }
                        
                        /* é¼ æ ‡æ‚¬åœæ—¶çš„èåˆæ•ˆæœ */
                        .typing-indicator:hover .liquid-dot {
                            animation: liquidMergeEffect 0.8s ease-in-out infinite,
                                     liquidFlowMerge 1.5s ease-in-out infinite;
                            filter: blur(0.2px) brightness(1.1);
                        }
                        
                        /* ä¼˜åŒ–çš„æ·¡å…¥æ·¡å‡º */
                        @keyframes fadeIn {
                            from { 
                                opacity: 0; 
                                transform: translateY(15px) scale(0.9); 
                                filter: blur(3px);
                            }
                            to { 
                                opacity: 0.9; 
                                transform: translateY(0) scale(1); 
                                filter: blur(0);
                            }
                        }
                        
                        @keyframes fadeOut {
                            from { 
                                opacity: 0.9; 
                                transform: translateY(0) scale(1); 
                                filter: blur(0);
                            }
                            to { 
                                opacity: 0; 
                                transform: translateY(-15px) scale(0.9); 
                                filter: blur(3px);
                            }
                        }
                    `;
                    document.head.appendChild(styles);
                }
                
                // åˆ›å»ºæ–‡å­—æç¤º
                const typingText = document.createElement('span');
                const displayText = isGroupChat ? 'å¤šäººæ­£åœ¨è¾“å…¥' : `${senderName}æ­£åœ¨è¾“å…¥`;
                typingText.textContent = displayText;
                typingText.style.cssText = `
                    font-size: 12px;
                    color: #666;
                    margin-left: 6px;
                    opacity: 0.8;
                    animation: typingTextFade 2s infinite ease-in-out;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                `;
                
                typingIndicator.appendChild(avatar);
                typingIndicator.appendChild(dots);
                typingIndicator.appendChild(typingText);
                
                return typingIndicator;
            }
            
            /**
             * *** åŸºäºæœ¬ç¦ç‰¹å®šå¾‹çš„å»¶è¿Ÿåˆ†å¸ƒç”Ÿæˆå™¨ ***
             * ç”Ÿæˆç¬¦åˆæœ¬ç¦ç‰¹å®šå¾‹åˆ†å¸ƒçš„å»¶è¿Ÿæ—¶é—´
             * @param {boolean} isGroupChat - æ˜¯å¦ä¸ºç¾¤èŠ
             * @returns {number} å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
             */
            function QQ_GenerateBenfordDelay(isGroupChat = false) {
                const random = Math.random();
                
                if (isGroupChat) {
                    // ç¾¤èŠï¼š15%æ¦‚ç‡0.2ç§’ï¼Œ20%æ¦‚ç‡0.5ç§’ï¼Œå…¶ä½™æŒ‰æœ¬ç¦ç‰¹å®šå¾‹1-10ç§’
                    if (random < 0.15) {
                        console.log('ğŸš€ ç¾¤èŠå¿«é€Ÿå“åº”: 0.2ç§’');
                        return 200; // 0.2ç§’
                    } else if (random < 0.35) { // 15% + 20% = 35%
                        console.log('ğŸš€ ç¾¤èŠå¿«é€Ÿå“åº”: 0.5ç§’');
                        return 500; // 0.5ç§’
                    } else {
                        // å‰©ä½™65%æŒ‰æœ¬ç¦ç‰¹å®šå¾‹åˆ†å¸ƒ1-10ç§’
                        return QQ_BenfordDistribution(1, 10, 0.65, 'ç¾¤èŠ');
                    }
                } else {
                    // ç§èŠï¼šå®Œå…¨æŒ‰æœ¬ç¦ç‰¹å®šå¾‹1-10ç§’åˆ†å¸ƒ
                    return QQ_BenfordDistribution(1, 10, 1.0, 'ç§èŠ');
                }
            }
            
            /**
             * *** æœ¬ç¦ç‰¹å®šå¾‹åˆ†å¸ƒå®ç° ***
             * @param {number} minSeconds - æœ€å°ç§’æ•°
             * @param {number} maxSeconds - æœ€å¤§ç§’æ•°
             * @param {number} scaleFactor - ç¼©æ”¾å› å­ï¼ˆç”¨äºç¾¤èŠçš„65%æ¦‚ç‡ï¼‰
             * @param {string} chatType - èŠå¤©ç±»å‹ï¼ˆç”¨äºæ—¥å¿—ï¼‰
             * @returns {number} å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
             */
            function QQ_BenfordDistribution(minSeconds, maxSeconds, scaleFactor, chatType) {
                const random = Math.random() * scaleFactor;
                
                // æœ¬ç¦ç‰¹å®šå¾‹ï¼šP(d) = log10(1 + 1/d)
                // å¯¹äº1-10ç§’çš„åˆ†å¸ƒï¼Œæˆ‘ä»¬è®¡ç®—ç´¯ç§¯æ¦‚ç‡
                const benfordProbs = [
                    0.30103, // 1ç§’: log10(1 + 1/1) â‰ˆ 30.1%
                    0.17609, // 2ç§’: log10(1 + 1/2) â‰ˆ 17.6%
                    0.12494, // 3ç§’: log10(1 + 1/3) â‰ˆ 12.5%
                    0.09691, // 4ç§’: log10(1 + 1/4) â‰ˆ 9.7%
                    0.07918, // 5ç§’: log10(1 + 1/5) â‰ˆ 7.9%
                    0.06695, // 6ç§’: log10(1 + 1/6) â‰ˆ 6.7%
                    0.05799, // 7ç§’: log10(1 + 1/7) â‰ˆ 5.8%
                    0.05115, // 8ç§’: log10(1 + 1/8) â‰ˆ 5.1%
                    0.04576  // 9ç§’: log10(1 + 1/9) â‰ˆ 4.6%
                    // 10ç§’çš„æ¦‚ç‡å¾ˆå°ï¼Œä½œä¸ºå‰©ä½™æ¦‚ç‡å¤„ç†
                ];
                
                // è®¡ç®—ç´¯ç§¯æ¦‚ç‡
                let cumulative = 0;
                for (let i = 0; i < benfordProbs.length; i++) {
                    cumulative += benfordProbs[i];
                    if (random <= cumulative) {
                        const delaySeconds = minSeconds + i;
                        const delayMs = delaySeconds * 1000;
                        console.log(`ğŸ“Š ${chatType}æœ¬ç¦ç‰¹å»¶è¿Ÿ: ${delaySeconds}ç§’ (${delayMs}ms) - æ¦‚ç‡åŒºé—´: ${(benfordProbs[i] * 100).toFixed(1)}%`);
                        return delayMs;
                    }
                }
                
                // å¤„ç†10ç§’çš„æƒ…å†µï¼ˆå‰©ä½™æ¦‚ç‡ï¼‰
                const delayMs = 10000;
                console.log(`ğŸ“Š ${chatType}æœ¬ç¦ç‰¹å»¶è¿Ÿ: 10ç§’ (${delayMs}ms) - å‰©ä½™æ¦‚ç‡`);
                return delayMs;
            }
            
            /**
             * ç§»é™¤"æ­£åœ¨è¾“å…¥..."æŒ‡ç¤ºå™¨
             * @param {Element} typingIndicator - è¾“å…¥æŒ‡ç¤ºå™¨å…ƒç´ 
             */
            function QQ_HideTypingIndicator(typingIndicator) {
                if (typingIndicator) {
                    // æ¸…ç†å¤´åƒåˆ‡æ¢å®šæ—¶å™¨
                    if (typingIndicator.avatarInterval) {
                        clearInterval(typingIndicator.avatarInterval);
                    }
                    
                    // æ¢å¤èŠå¤©å†…å®¹åŒºåŸŸçš„é»˜è®¤è¾¹è·
                    const msgContent = document.querySelector('.QQ_chat_page:not([style*="display: none"]) .msgcontent');
                    if (msgContent) {
                        msgContent.style.marginBottom = '50px'; // æ¢å¤é»˜è®¤è¾¹è·
                    }
                    
                    typingIndicator.style.animation = 'fadeOut 0.3s ease-out';
                    setTimeout(() => {
                        if (typingIndicator.parentNode) {
                            typingIndicator.parentNode.removeChild(typingIndicator);
                        }
                    }, 300);
                }
            }
            
            /**
             * æµå¼æ¶ˆæ¯æ˜¾ç¤ºä¸»å‡½æ•°
             * @param {Element} chatContainer - èŠå¤©å®¹å™¨DOM
             * @param {Array} messageParts - åˆ†å‰²åçš„æ¶ˆæ¯æ•°ç»„
             * @param {string} sender - å‘é€è€…
             * @param {string} chatName - èŠå¤©åç§°
             * @param {boolean} isNew - æ˜¯å¦ä¸ºæ–°æ¶ˆæ¯
             * @param {boolean} skipScrollAndCount - æ˜¯å¦è·³è¿‡æ»šåŠ¨å’Œè®¡æ•°
             */
            function QQ_DisplayStreamingMessages(chatContainer, messageParts, sender, chatName, isNew, skipScrollAndCount) {
                console.log(`ğŸŒŠ å¼€å§‹æµå¼æ˜¾ç¤º ${messageParts.length} æ¡æ¶ˆæ¯ - å‘é€è€…: ${sender}`);
                
                let currentIndex = 0;
                
                async function displayNextMessage() {
                    // ç§»é™¤å½“å‰çš„è¾“å…¥æŒ‡ç¤ºå™¨ï¼ˆä½¿ç”¨æ”¹è¿›çš„ç®¡ç†å‡½æ•°ï¼‰
                    QQ_HideTypingIndicatorForChat(chatName);
                    
                    if (currentIndex >= messageParts.length) {
                        console.log(`âœ… æµå¼æ˜¾ç¤ºå®Œæˆ - å…±æ˜¾ç¤º ${messageParts.length} æ¡æ¶ˆæ¯`);
                        
                        // *** æ–°å¢ï¼šåœ¨AIå›å¤å®Œæˆåæ·»åŠ æ—¶é—´é—´éš”ç³»ç»Ÿæ¶ˆæ¯ ***
                        setTimeout(() => {
                            const now = new Date();
                            const timeText = now.toLocaleString('zh-CN', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit', 
                                hour: '2-digit',
                                minute: '2-digit',
                                hour12: false
                            });
                            const timeMessage = `ğŸ“… ${timeText}`;
                            
                            // ä½¿ç”¨æ­£ç¡®çš„ç³»ç»Ÿæ¶ˆæ¯æ˜¾ç¤ºå‡½æ•°
                            if (typeof displaySystemMessage === 'function') {
                                displaySystemMessage(timeMessage);
                            }
                        }, 1000); // 1ç§’å»¶è¿Ÿæ˜¾ç¤ºæ—¶é—´æ¶ˆæ¯
                        
                        // *** ä¿®å¤ï¼šåœ¨AIå›å¤å®Œæˆåæ¸…ç©ºç¼“å­˜ï¼Œç¡®ä¿æ‰€æœ‰æ¶ˆæ¯éƒ½å·²å¤„ç† ***
                        setTimeout(() => {
                            QQ_CacheSendMsg = "";
                        }, 1500);
                        
                        return;
                    }
                    
                    const part = messageParts[currentIndex];
                    const timestamp = new Date().toLocaleTimeString('zh-CN', { 
                        hour12: false, 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    const partContent = `${sender}--${part}--${timestamp}`;
                    
                    // æ˜¾ç¤ºå½“å‰æ¶ˆæ¯ï¼ˆè·³è¿‡æµå¼æ£€æŸ¥ï¼Œé¿å…é‡å¤æµå¼å¤„ç†ï¼‰
                    // *** ä¿®å¤ï¼šæµå¼è¾“å‡ºæ—¶æ¯æ¡æ¶ˆæ¯éƒ½åº”è¯¥è¢«è§†ä¸ºæ–°æ¶ˆæ¯ï¼Œç¡®ä¿æ»šåŠ¨å’Œæ˜¾ç¤º ***
                    await QQ_Chat_AddMsg(chatContainer, partContent, chatName, true, false, true);
                    
                    currentIndex++;
                    
                    // å¦‚æœè¿˜æœ‰æ›´å¤šæ¶ˆæ¯ï¼Œæ˜¾ç¤ºè¾“å…¥æŒ‡ç¤ºå™¨å¹¶è®¾ç½®ä¸‹ä¸€æ¬¡æ˜¾ç¤º
                    if (currentIndex < messageParts.length) {
                        // çŸ­æš‚å»¶è¿Ÿåæ˜¾ç¤ºè¾“å…¥æŒ‡ç¤ºå™¨ï¼ˆä½¿ç”¨æ”¹è¿›çš„ç®¡ç†å‡½æ•°ï¼‰
                        const chatState = getStreamingState(chatName);
                        chatState.typingTimeout = setTimeout(() => {
                            QQ_ShowTypingIndicatorForChat(chatName, chatContainer, sender);
                        }, 200);
                        
                        // ä½¿ç”¨æœ¬ç¦ç‰¹å®šå¾‹ç”Ÿæˆå»¶è¿Ÿæ—¶é—´
                        const isGroupChat = QQ_Groups.includes(chatName);
                        const delay = QQ_GenerateBenfordDelay(isGroupChat);
                        
                        console.log(`â±ï¸ ä¸‹ä¸€æ¡æ¶ˆæ¯å°†åœ¨ ${delay}ms åæ˜¾ç¤ºï¼ˆ${isGroupChat ? 'ç¾¤èŠ' : 'ç§èŠ'}æ¨¡å¼ï¼‰`);
                        setTimeout(async () => await displayNextMessage(), delay + 500); // é¢å¤–500msç”¨äºè¾“å…¥åŠ¨ç”»
                    }
                }
                
                // å¼€å§‹æ˜¾ç¤ºç¬¬ä¸€æ¡æ¶ˆæ¯
                displayNextMessage().catch(error => console.error('æµå¼æ˜¾ç¤ºé”™è¯¯:', error));
            }
            
            /**
             * *** é˜¶æ®µä¸€ï¼šæµå¼æ˜¾ç¤ºå·²æ ¼å¼åŒ–çš„å®Œæ•´æ¶ˆæ¯ ***
             * ä¸“é—¨ç”¨äºå¤„ç†æ ¼å¼ä¸º"å‘é€è€…--å†…å®¹--æ—¶é—´"çš„å®Œæ•´æ¶ˆæ¯
             * @param {HTMLElement} chatContainer - èŠå¤©å®¹å™¨
             * @param {Array} fullMessages - å®Œæ•´æ¶ˆæ¯æ•°ç»„
             * @param {string} chatName - èŠå¤©åç§°
             * @param {boolean} isNew - æ˜¯å¦ä¸ºæ–°æ¶ˆæ¯
             * @param {boolean} skipScrollAndCount - æ˜¯å¦è·³è¿‡æ»šåŠ¨å’Œè®¡æ•°
             */
            async function QQ_DisplayStreamingMessagesDirectly(chatContainer, fullMessages, chatName, isNew, skipScrollAndCount) {
                console.log(`ğŸŒŠ å¼€å§‹æµå¼æ˜¾ç¤º ${fullMessages.length} æ¡å®Œæ•´æ¶ˆæ¯ - èŠå¤©: ${chatName}`);
                
                // æ£€æŸ¥å®¹å™¨æ˜¯å¦å­˜åœ¨ï¼ˆä¿®å¤ï¼šæ”¯æŒåœ¨éšè—çš„èŠå¤©é¡µé¢ä¸­æŸ¥æ‰¾å®¹å™¨ï¼‰
                if (!chatContainer || !chatContainer.parentElement) {
                    console.error('âŒ èŠå¤©å®¹å™¨ä¸å­˜åœ¨æˆ–å·²è¢«ç§»é™¤ï¼Œæ— æ³•æ˜¾ç¤ºæ¶ˆæ¯');
                    console.log('ğŸ” å°è¯•æŸ¥æ‰¾èŠå¤©å®¹å™¨...');
                    
                    // å°è¯•é‡æ–°è·å–å®¹å™¨ï¼ˆä¿®å¤ï¼šå³ä½¿åœ¨éšè—çš„èŠå¤©é¡µé¢ä¸­ä¹Ÿè¦èƒ½æ‰¾åˆ°å®¹å™¨ï¼‰
                    const selector = QQ_Groups.includes(chatName) 
                        ? `#QQ_chat_${chatName.replace(/[\s:]/g, '_')} .msgcontent`
                        : `#QQ_chat_${chatName} .msgcontent`;
                    chatContainer = document.querySelector(selector);
                    
                    // *** ä¿®å¤ï¼šå¦‚æœç›´æ¥é€‰æ‹©å™¨æ‰¾ä¸åˆ°ï¼Œå°è¯•åœ¨æ‰€æœ‰èŠå¤©é¡µé¢ä¸­æŸ¥æ‰¾ï¼ˆåŒ…æ‹¬éšè—çš„ï¼‰ ***
                    if (!chatContainer) {
                        console.log('ğŸ” ç›´æ¥é€‰æ‹©å™¨æœªæ‰¾åˆ°å®¹å™¨ï¼Œå°è¯•åœ¨æ‰€æœ‰èŠå¤©é¡µé¢ä¸­æŸ¥æ‰¾...');
                        const allChatPages = document.querySelectorAll('.QQ_chat_page');
                        for (const page of allChatPages) {
                            const pageName = page.getAttribute('data-name');
                            if (pageName === chatName) {
                                chatContainer = page.querySelector('.msgcontent');
                                if (chatContainer) {
                                    console.log('âœ… åœ¨éšè—çš„èŠå¤©é¡µé¢ä¸­æ‰¾åˆ°å®¹å™¨:', pageName);
                                    break;
                                }
                            }
                        }
                    }
                    
                    if (!chatContainer) {
                        console.error('âŒ æ— æ³•æ‰¾åˆ°èŠå¤©å®¹å™¨:', selector);
                        return Promise.reject(new Error('èŠå¤©å®¹å™¨ä¸å­˜åœ¨'));
                    }
                    console.log('âœ… æˆåŠŸé‡æ–°è·å–èŠå¤©å®¹å™¨');
                }
                
                // *** ä¿®å¤ï¼šå¯¹äºå¤šç§èŠåœºæ™¯ï¼Œå¦‚æœå®¹å™¨æ‰€åœ¨é¡µé¢æ˜¯éšè—çš„ï¼Œæˆ‘ä»¬ä»ç„¶è¦æ˜¾ç¤ºæ¶ˆæ¯ ***
                const chatPage = chatContainer.closest('.QQ_chat_page');
                const isHiddenPage = chatPage && (chatPage.style.display === 'none' || chatPage.getAttribute('style')?.includes('display: none'));
                if (isHiddenPage) {
                    console.log(`ğŸ” æ£€æµ‹åˆ°éšè—çš„èŠå¤©é¡µé¢ï¼Œä»å°†ç»§ç»­æµå¼æ˜¾ç¤ºæ¶ˆæ¯: ${chatName}`);
                }
                
                return new Promise((resolve, reject) => {
                    let currentIndex = 0;
                    async function displayNextMessage() {
                        try {
                            // ç§»é™¤å½“å‰çš„è¾“å…¥æŒ‡ç¤ºå™¨ï¼ˆä½¿ç”¨æ”¹è¿›çš„ç®¡ç†å‡½æ•°ï¼‰
                            QQ_HideTypingIndicatorForChat(chatName);
                            
                            if (currentIndex >= fullMessages.length) {
                                console.log(`âœ… æµå¼æ˜¾ç¤ºå®Œæˆ - å…±æ˜¾ç¤º ${fullMessages.length} æ¡æ¶ˆæ¯`);
                                
                                // *** æ–°å¢ï¼šåœ¨AIå›å¤å®Œæˆåæ·»åŠ æ—¶é—´é—´éš”ç³»ç»Ÿæ¶ˆæ¯ ***
                                setTimeout(() => {
                                    const now = new Date();
                                    const timeText = now.toLocaleString('zh-CN', {
                                        year: 'numeric',
                                        month: '2-digit',
                                        day: '2-digit', 
                                        hour: '2-digit',
                                        minute: '2-digit',
                                        hour12: false
                                    });
                                    const timeMessage = `ğŸ“… ${timeText}`;
                                    
                                    // ä½¿ç”¨æ­£ç¡®çš„ç³»ç»Ÿæ¶ˆæ¯æ˜¾ç¤ºå‡½æ•°
                                    if (typeof displaySystemMessage === 'function') {
                                        displaySystemMessage(timeMessage);
                                    }
                                }, 1000); // 1ç§’å»¶è¿Ÿæ˜¾ç¤ºæ—¶é—´æ¶ˆæ¯
                                
                                // *** ä¿®å¤ï¼šåœ¨AIå›å¤å®Œæˆåæ¸…ç©ºç¼“å­˜ï¼Œç¡®ä¿æ‰€æœ‰æ¶ˆæ¯éƒ½å·²å¤„ç† ***
                                setTimeout(() => {
                                    QQ_CacheSendMsg = "";
                                    // Promise resolve åœ¨æœ€åæ‰§è¡Œ
                                    resolve();
                                }, 1500);
                                
                                return;
                            }
                            
                            const fullMessage = fullMessages[currentIndex];
                            
                            // è§£ææ¶ˆæ¯æ ¼å¼ï¼šå‘é€è€…--å†…å®¹--æ—¶é—´
                            const messageParts = fullMessage.split('--');
                            const sender = messageParts.length >= 1 ? messageParts[0] : 'Unknown';
                            
                            // æ˜¾ç¤ºå½“å‰æ¶ˆæ¯ï¼ˆè·³è¿‡æµå¼æ£€æŸ¥ï¼Œé¿å…é‡å¤æµå¼å¤„ç†ï¼‰
                            // *** ä¿®å¤ï¼šæµå¼è¾“å‡ºæ—¶æ¯æ¡æ¶ˆæ¯éƒ½åº”è¯¥è¢«è§†ä¸ºæ–°æ¶ˆæ¯ï¼Œç¡®ä¿æ»šåŠ¨å’Œæ˜¾ç¤º ***
                            await QQ_Chat_AddMsg(chatContainer, fullMessage, chatName, true, false, true);
                            console.log(`ğŸ“¤ æµå¼æ˜¾ç¤ºæ¶ˆæ¯ ${currentIndex + 1}/${fullMessages.length}: ${sender}`);
                            
                            currentIndex++;
                            
                            // å¦‚æœè¿˜æœ‰æ›´å¤šæ¶ˆæ¯ï¼Œæ˜¾ç¤ºè¾“å…¥æŒ‡ç¤ºå™¨å¹¶è®¾ç½®ä¸‹ä¸€æ¬¡æ˜¾ç¤º
                            if (currentIndex < fullMessages.length) {
                                // è·å–ä¸‹ä¸€æ¡æ¶ˆæ¯çš„å‘é€è€…
                                const nextMessage = fullMessages[currentIndex];
                                const nextMessageParts = nextMessage.split('--');
                                const nextSender = nextMessageParts.length >= 1 ? nextMessageParts[0] : 'Unknown';
                                
                                // çŸ­æš‚å»¶è¿Ÿåæ˜¾ç¤ºè¾“å…¥æŒ‡ç¤ºå™¨ï¼ˆä½¿ç”¨æ”¹è¿›çš„ç®¡ç†å‡½æ•°ï¼‰
                                const chatState = getStreamingState(chatName);
                                chatState.typingTimeout = setTimeout(() => {
                                    QQ_ShowTypingIndicatorForChat(chatName, chatContainer, nextSender);
                                }, 200);
                                
                                // ä½¿ç”¨æœ¬ç¦ç‰¹å®šå¾‹ç”Ÿæˆå»¶è¿Ÿæ—¶é—´
                                const isGroupChat = QQ_Groups.includes(chatName);
                                const delay = QQ_GenerateBenfordDelay(isGroupChat);
                                
                                console.log(`â±ï¸ ä¸‹ä¸€æ¡æ¶ˆæ¯ï¼ˆ${nextSender}ï¼‰å°†åœ¨ ${delay}ms åæ˜¾ç¤ºï¼ˆ${isGroupChat ? 'ç¾¤èŠ' : 'ç§èŠ'}æ¨¡å¼ï¼‰`);
                                
                                // ä½¿ç”¨æ¯ä¸ªèŠå¤©çš„ç‹¬ç«‹æµå¼ä¼ è¾“è¿›ç¨‹ï¼Œæ”¯æŒå¹¶è¡Œå¤„ç†
                                if (chatState.currentProcess) {
                                    clearTimeout(chatState.currentProcess);
                                }
                                chatState.currentProcess = setTimeout(async () => await displayNextMessage(), delay + 500); // é¢å¤–500msç”¨äºè¾“å…¥åŠ¨ç”»
                            }
                        } catch (error) {
                            console.error('ğŸš« æµå¼æ˜¾ç¤ºè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
                            reject(error);
                        }
                    }
                    
                    // å¼€å§‹æ˜¾ç¤ºç¬¬ä¸€æ¡æ¶ˆæ¯
                    try {
                        displayNextMessage().catch(error => {
                            console.error('ğŸš« æµå¼æ˜¾ç¤ºå¤±è´¥:', error);
                            reject(error);
                        });
                    } catch (error) {
                        console.error('ğŸš« æµå¼æ˜¾ç¤ºå¯åŠ¨å¤±è´¥:', error);
                        reject(error);
                    }
                });
            }
            
            /**
             * *** æ–°å¢ï¼šæ‹†åˆ†è¿‡é•¿çš„å•æ¡æ¶ˆæ¯ ***
             * æ™ºèƒ½æ‹†åˆ†è¶…é•¿æ¶ˆæ¯ï¼Œå°½é‡åœ¨åˆé€‚çš„ä½ç½®æ–­å¼€
             * @param {string} message - è¿‡é•¿çš„æ¶ˆæ¯
             * @param {number} maxLength - æœ€å¤§é•¿åº¦
             * @returns {string[]} æ‹†åˆ†åçš„æ¶ˆæ¯æ•°ç»„
             */
            function QQ_SplitOverlongMessage(message, maxLength) {
                if (message.length <= maxLength) {
                    return [message];
                }
                
                const parts = [];
                let currentPos = 0;
                
                while (currentPos < message.length) {
                    let endPos = Math.min(currentPos + maxLength, message.length);
                    
                    // å¦‚æœä¸æ˜¯æœ€åä¸€æ®µï¼Œå°è¯•åœ¨æ ‡ç‚¹ç¬¦å·å¤„æ–­å¼€
                    if (endPos < message.length) {
                        const punctuation = ['ã€‚', 'ï¼', 'ï¼Ÿ', 'ï¼Œ', 'ï¼›', 'â€¦', '.', '!', '?', ',', ';'];
                        let bestBreakPoint = endPos;
                        
                        // å‘å‰æœç´¢æœ€è¿‘çš„æ ‡ç‚¹ç¬¦å·
                        for (let i = endPos - 1; i > currentPos + maxLength * 0.7; i--) {
                            if (punctuation.includes(message[i])) {
                                bestBreakPoint = i + 1;
                                break;
                            }
                        }
                        
                        endPos = bestBreakPoint;
                    }
                    
                    const part = message.substring(currentPos, endPos).trim();
                    if (part.length > 0) {
                        parts.push(part);
                    }
                    
                    currentPos = endPos;
                }
                
                return parts;
            }
            
            /**
             * *** æ–°å¢ï¼šå¤„ç†è§’è‰²ä¹‹é—´çš„ç§èŠï¼ˆä¸åŒ…å«ç”¨æˆ·çš„è§’è‰²é—´äº’åŠ¨ï¼‰ ***
             * @param {string} chatKey - èŠå¤©æ ‡è¯†ï¼Œå¦‚"è§’è‰²Aå’Œè§’è‰²Bçš„èŠå¤©"
             * @param {Array} messages - æ¶ˆæ¯åˆ—è¡¨
             * @param {string} char1 - è§’è‰²1åç§°
             * @param {string} char2 - è§’è‰²2åç§°
             */
            async function QQ_HandleCharacterChat(chatKey, messages, char1, char2) {
                console.log(`å¤„ç†è§’è‰²é—´ç§èŠ: ${char1} å’Œ ${char2}`);
                
                // *** å¢å¼ºçš„ç§èŠç‹¬ç«‹æ€§æ£€æŸ¥ ***
                if (!QQ_ValidatePrivateChatAccess(char1, char2, 'character')) {
                    console.warn(`âŒ ç§èŠè®¿é—®è¢«æ‹’ç»: ${char1} å’Œ ${char2} ä¹‹é—´çš„ç§èŠä¸åº”è¢«å¤„ç†`);
                    return;
                }
                
                if (!messages || messages.length === 0) {
                    console.log('è§’è‰²é—´ç§èŠæ¶ˆæ¯ä¸ºç©ºï¼Œè·³è¿‡å¤„ç†');
                    return;
                }
                
                // åˆ›å»ºè§’è‰²é—´ç§èŠçš„æ ‡è¯†ï¼ˆåŠ å¯†å¤„ç†ï¼‰
                const chatId = `char_chat_${QQ_GenerateSecureChatId(char1, char2)}`;
                const chatTitle = `${char1}å’Œ${char2}çš„ç§èŠ`;
                
                // å­˜å‚¨åˆ°ä¸“é—¨çš„è§’è‰²é—´ç§èŠæ•°æ®ç»“æ„ï¼ˆéš”ç¦»å­˜å‚¨ï¼‰
                if (!window.QQ_CharacterChats) {
                    window.QQ_CharacterChats = {};
                }
                
                if (!window.QQ_CharacterChats[chatKey]) {
                    window.QQ_CharacterChats[chatKey] = {
                        id: chatId,
                        title: chatTitle,
                        char1: char1,
                        char2: char2,
                        messages: [],
                        lastTime: '',
                        lastMessage: '',
                        isPrivate: true,  // æ ‡è®°ä¸ºç§èŠ
                        accessLevel: 'character_only'  // ä»…è§’è‰²å¯è®¿é—®
                    };
                }
                
                // å¤„ç†æ¶ˆæ¯
                let lastTime = '';
                let lastMessage = '';
                for (let msg of messages) {
                    // æ¸…ç†æ¶ˆæ¯å†…å®¹
                    const parts = msg.split("--");
                    if (parts.length >= 2) {
                        parts[1] = QQ_CleanNestedTags(parts[1]);
                        msg = parts.join("--");
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸ºæ–°æ¶ˆæ¯
                    if (!window.QQ_CharacterChats[chatKey].messages.includes(msg)) {
                        window.QQ_CharacterChats[chatKey].messages.push(msg);
                        console.log(`è§’è‰²é—´ç§èŠæ–°å¢æ¶ˆæ¯: ${msg}`);
                    }
                    
                    // æ›´æ–°æœ€åæ¶ˆæ¯ä¿¡æ¯
                    const sp = msg.split("--");
                    if (sp.length >= 2) {
                        lastMessage = sp[1];
                    }
                    if (sp.length >= 3) {
                        lastTime = sp[2];
                    }
                }
                
                window.QQ_CharacterChats[chatKey].lastTime = lastTime;
                window.QQ_CharacterChats[chatKey].lastMessage = lastMessage;
                
                // åœ¨è”ç³»äººåˆ—è¡¨ä¸­æ˜¾ç¤ºè§’è‰²é—´ç§èŠ
                QQ_CreateCharacterChatInterface(window.QQ_CharacterChats[chatKey]);
                
                // ä¿å­˜åˆ°ä¸–ç•Œä¹¦
                await QQ_SaveCharacterChatToWorldbook(window.QQ_CharacterChats[chatKey]);
            }
            
            /**
             * *** æ–°å¢ï¼šåˆ›å»ºè§’è‰²é—´ç§èŠçš„è”ç³»äººç•Œé¢ï¼ˆåªè¯»ï¼‰ ***
             * @param {Object} chatData - è§’è‰²é—´ç§èŠæ•°æ®
             */
            function QQ_CreateCharacterChatInterface(chatData) {
                const contactsContainer = $('#QQ_home_chars');
                if (!contactsContainer.length) {
                    console.error('æ‰¾ä¸åˆ°è”ç³»äººå®¹å™¨');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                const existingElement = contactsContainer.find(`[data-char-chat-id="${chatData.id}"]`);
                if (existingElement.length > 0) {
                    // æ›´æ–°ç°æœ‰å…ƒç´ 
                    existingElement.find('.QQ_home_lastmsg').text(chatData.lastMessage);
                    existingElement.find('.QQ_home_lasttime').text(chatData.lastTime);
                    return;
                }
                
                // åˆ›å»ºæ–°çš„è§’è‰²é—´ç§èŠå…ƒç´ 
                const chatElement = $(`
                    <div class="QQ_home_char" data-char-chat-id="${chatData.id}" data-char-chat="true">
                        <div class="QQ_home_head">
                            <div class="QQ_home_avatar" style="background: linear-gradient(135deg, #9C27B0, #673AB7); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">
                                ğŸ’¬
                            </div>
                        </div>
                        <div class="QQ_home_info">
                            <div class="QQ_home_name" style="color: #9C27B0; font-weight: bold;">${chatData.title}</div>
                            <div class="QQ_home_lastmsg">${chatData.lastMessage}</div>
                        </div>
                        <div class="QQ_home_time">
                            <div class="QQ_home_lasttime">${chatData.lastTime}</div>
                            <div class="QQ_readonly_badge" style="background: #9C27B0; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-top: 5px;">åªè¯»</div>
                        </div>
                    </div>
                `);
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆåªè¯»æŸ¥çœ‹ï¼‰
                chatElement.on('click', function() {
                    QQ_ShowCharacterChatDialog(chatData);
                });
                
                // æ·»åŠ åˆ°è”ç³»äººåˆ—è¡¨
                contactsContainer.append(chatElement);
                console.log(`è§’è‰²é—´ç§èŠç•Œé¢å·²åˆ›å»º: ${chatData.title}`);
            }
            
            /**
             * *** æ–°å¢ï¼šæ˜¾ç¤ºè§’è‰²é—´ç§èŠçš„åªè¯»å¯¹è¯æ¡† ***
             * @param {Object} chatData - è§’è‰²é—´ç§èŠæ•°æ®
             */
            function QQ_ShowCharacterChatDialog(chatData) {
                // åˆ›å»ºåªè¯»å¯¹è¯æ¡†
                const dialogHtml = `
                    <div id="char-chat-dialog" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                        <div style="background: white; border-radius: 15px; width: 90%; max-width: 400px; max-height: 80%; display: flex; flex-direction: column; overflow: hidden;">
                            <div style="padding: 15px; background: linear-gradient(135deg, #9C27B0, #673AB7); color: white; display: flex; align-items: center; justify-content: space-between;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 30px; height: 30px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">ğŸ’¬</div>
                                    <div>
                                        <div style="font-weight: bold; font-size: 16px;">${chatData.title}</div>
                                        <div style="font-size: 12px; opacity: 0.8;">è§’è‰²é—´ç§èŠï¼ˆåªè¯»ï¼‰</div>
                                    </div>
                                </div>
                                <button id="close-char-chat" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer; padding: 5px;">Ã—</button>
                            </div>
                            <div style="flex: 1; overflow-y: auto; padding: 15px; background: #f5f5f5;">
                                <div id="char-chat-messages"></div>
                            </div>
                            <div style="padding: 10px; background: #e0e0e0; text-align: center; color: #666; font-size: 12px;">
                                ğŸ“– è¿™æ˜¯è§’è‰²ä¹‹é—´çš„ç§èŠï¼Œæ‚¨åªèƒ½æŸ¥çœ‹ä¸èƒ½å›å¤
                            </div>
                        </div>
                    </div>
                `;
                
                // ç§»é™¤ç°æœ‰å¯¹è¯æ¡†
                $('#char-chat-dialog').remove();
                
                // æ·»åŠ æ–°å¯¹è¯æ¡†
                $('body').append(dialogHtml);
                
                // æ¸²æŸ“æ¶ˆæ¯
                const messagesContainer = $('#char-chat-messages');
                chatData.messages.forEach(msg => {
                    const parts = msg.split('--');
                    if (parts.length >= 2) {
                        const sender = parts[0];
                        const content = parts[1];
                        const time = parts.length >= 3 ? parts[2] : '';
                        
                        const messageHtml = `
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                    <div style="font-weight: bold; color: #9C27B0;">${sender}</div>
                                    <div style="font-size: 11px; color: #999;">${time}</div>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                    ${content}
                                </div>
                            </div>
                        `;
                        messagesContainer.append(messageHtml);
                    }
                });
                
                // æ»šåŠ¨åˆ°åº•éƒ¨
                messagesContainer.scrollTop(messagesContainer[0].scrollHeight);
                
                // ç»‘å®šå…³é—­äº‹ä»¶
                $('#close-char-chat, #char-chat-dialog').on('click', function(e) {
                    if (e.target === this) {
                        $('#char-chat-dialog').remove();
                    }
                });
            }
            
            /**
             * *** æ–°å¢ï¼šä¿å­˜è§’è‰²é—´ç§èŠåˆ°ä¸–ç•Œä¹¦ ***
             * @param {Object} chatData - è§’è‰²é—´ç§èŠæ•°æ®
             */
            async function QQ_SaveCharacterChatToWorldbook(chatData) {
                try {
                    // ä½¿ç”¨ç®€å•çš„ä¸–ç•Œä¹¦æ£€æŸ¥
                    if (!worldbook || !entries) {
                        console.warn('ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨ï¼Œæ— æ³•ä¿å­˜è§’è‰²é—´ç§èŠ');
                        return false;
                    }
                    
                    const entryKey = `QQ_è§’è‰²é—´ç§èŠ_${chatData.char1}_${chatData.char2}`;
                    const uniqueComment = `æ‰‹æœº-è§’è‰²é—´ç§èŠ-${chatData.char1}å’Œ${chatData.char2}`;
                    
                    // æŸ¥æ‰¾ç°æœ‰æ¡ç›®
                    let existingEntry = entries.find(e => e.comment === uniqueComment);
                    
                    // æ„å»ºä¿å­˜å†…å®¹
                    const saveContent = JSON.stringify({
                        id: chatData.id,
                        title: chatData.title,
                        char1: chatData.char1,
                        char2: chatData.char2,
                        messages: chatData.messages,
                        lastTime: chatData.lastTime,
                        lastMessage: chatData.lastMessage,
                        timestamp: new Date().toISOString()
                    });
                    
                    if (existingEntry) {
                        // æ›´æ–°ç°æœ‰æ¡ç›®
                        await setLorebookEntries(worldbook, [{
                            uid: existingEntry.uid,
                            content: saveContent
                        }]);
                        console.log(`è§’è‰²é—´ç§èŠå·²æ›´æ–°åˆ°ä¸–ç•Œä¹¦: ${chatData.title}`);
                    } else {
                        // åˆ›å»ºæ–°æ¡ç›®
                        await createLorebookEntry(worldbook, {
                            comment: uniqueComment,
                            key: [entryKey],
                            content: saveContent,
                            position: 0,
                            disable: false,
                            addMemo: false,
                            order: 1000,
                            depth: 4,
                            selectiveLogic: 0,
                            excludeRecursion: false,
                            delayUntilRecursion: false,
                            probability: 100,
                            useProbability: false
                        });
                        console.log(`è§’è‰²é—´ç§èŠå·²ä¿å­˜åˆ°ä¸–ç•Œä¹¦: ${chatData.title}`);
                    }
                    
                    return true;
                } catch (error) {
                    console.error('ä¿å­˜è§’è‰²é—´ç§èŠåˆ°ä¸–ç•Œä¹¦å¤±è´¥:', error);
                    return false;
                }
            }

            /**
             * è¿‡æ»¤æ‰ç”¨æˆ·æ¶ˆæ¯ä»¥é¿å…é‡å¤æ˜¾ç¤º
             * @param {Array} messages - æ¶ˆæ¯æ•°ç»„
             * @returns {Array} è¿‡æ»¤åçš„æ¶ˆæ¯æ•°ç»„
             */
            function QQ_FilterUserMessages(messages) {
                if (!Array.isArray(messages)) {
                    return messages;
                }
                
                return messages.filter(msg => {
                    if (typeof msg !== 'string') {
                        return true; // ä¿ç•™éå­—ç¬¦ä¸²æ¶ˆæ¯
                    }
                    
                    const parts = msg.split('--');
                    if (parts.length >= 2) {
                        const senderName = parts[0].trim();
                        // è¿‡æ»¤æ‰ç”¨æˆ·å‘é€çš„æ¶ˆæ¯ï¼Œä½†ä¿ç•™å…¶ä»–è§’è‰²çš„æ¶ˆæ¯
                        if (senderName === '{{user}}' || senderName === UserName) {
                            console.log(`è¿‡æ»¤ç”¨æˆ·é‡å¤æ¶ˆæ¯: ${msg}`);
                            return false;
                        }
                    }
                    return true;
                });
            }

            /**
             * *** çŸ­æœŸè®°å¿†ç³»ç»Ÿ - ä¸–ç•Œä¹¦è®°å¿†åˆ†å±‚æ¶æ„ç¬¬1å±‚ ***
             * æ›´æ–°çŸ­æœŸè®°å¿†ä¸–ç•Œä¹¦ï¼Œä¿å­˜æœ€è¿‘1000æ¡é‡è¦å¯¹è¯è®°å½•ï¼ˆçœŸæ­£çš„æ»šåŠ¨å¼å­˜å‚¨ï¼‰
             */
            async function QQ_UpdateShortTermMemory() {
                try {
                    console.log('ğŸ§  å¼€å§‹å¢é‡æ›´æ–°çŸ­æœŸè®°å¿†ä¸–ç•Œä¹¦...');
                    
                    if (!worldbook || !entries) {
                        console.warn('âš ï¸ ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨ï¼Œè·³è¿‡çŸ­æœŸè®°å¿†æ›´æ–°');
                        return;
                    }
                    
                    if (!QQ_msgjson) {
                        console.warn('âš ï¸ QQ_msgjsonä¸ºç©ºï¼Œè·³è¿‡çŸ­æœŸè®°å¿†æ›´æ–°');
                        return;
                    }
                    
                    // *** æ–°å¢ï¼šè·å–å½“å‰æœ€å¤§åºåˆ—å·ï¼Œç”¨äºè¯†åˆ«æ–°æ¶ˆæ¯ ***
                    const currentMaxSequenceId = QQ_MessageSequence.current() - 1;
                    console.log(`ğŸ”„ ä¸Šæ¬¡å¤„ç†åˆ°åºåˆ—å·: ${QQ_LastProcessedSequenceId}, å½“å‰æœ€å¤§åºåˆ—å·: ${currentMaxSequenceId}`);
                    
                    // *** è°ƒè¯•ï¼šæ£€æŸ¥QQ_msgjsonä¸­çš„æ¶ˆæ¯ ***
                    let totalMsgCount = 0;
                    let messagesWithSequence = 0;
                    for (const chatKey in QQ_msgjson.ç§èŠ) {
                        const msgs = QQ_msgjson.ç§èŠ[chatKey];
                        if (Array.isArray(msgs)) {
                            totalMsgCount += msgs.length;
                            msgs.forEach(msg => {
                                if (msg.includes('##seq_')) messagesWithSequence++;
                            });
                        }
                    }
                    console.log(`ğŸ“Š å½“å‰ç§èŠæ¶ˆæ¯æ€»æ•°: ${totalMsgCount}, å¸¦åºåˆ—å·çš„: ${messagesWithSequence}`);
                    
                    // *** ä¿®æ”¹ï¼šæ€»æ˜¯æ‰§è¡Œæ›´æ–°ï¼Œç¡®ä¿AIæ–°å›å¤è¢«ä¿å­˜ ***
                    console.log('ğŸ”„ å¼€å§‹æ”¶é›†æ‰€æœ‰æ¶ˆæ¯ï¼Œä¼˜å…ˆä¿å­˜æœ€æ–°å›å¤...');
                    
                    // *** æ–°ç­–ç•¥ï¼šå¢é‡æ›´æ–° + æ»šåŠ¨å¼å­˜å‚¨ ***
                    
                    // ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥æ˜¯å¦å­˜åœ¨ç°æœ‰è®°å¿†ï¼ˆä¸è§£æå†…å®¹ï¼Œåªæ£€æŸ¥å­˜åœ¨æ€§ï¼‰
                    const memoryKeys = ['çŸ­æœŸè®°å¿†-æœ€è¿‘å¯¹è¯', 'æœ€è¿‘å¯¹è¯', 'çŸ­æœŸè®°å¿†', 'å¯¹è¯å†å²', 'èŠå¤©è®°å½•'];
                    const memoryEntry = entries.find(entry => 
                        entry.keys && Array.isArray(entry.keys) && entry.keys.some(key => memoryKeys.includes(key))
                    );
                    
                    if (memoryEntry && memoryEntry.content) {
                        console.log('ğŸ“š æ‰¾åˆ°ç°æœ‰çŸ­æœŸè®°å¿†æ¡ç›®ï¼Œå°†ç›´æ¥åœ¨ç°æœ‰å†…å®¹åŸºç¡€ä¸Šè¿½åŠ æ–°æ¶ˆæ¯');
                    } else {
                        console.log('ğŸ†• æœªæ‰¾åˆ°ç°æœ‰è®°å¿†ï¼Œå°†åˆ›å»ºæ–°è®°å¿†');
                    }
                    
                    // ç¬¬äºŒæ­¥ï¼šæ”¶é›†æ–°æ¶ˆæ¯ï¼ˆåªæ”¶é›†åºåˆ—å·å¤§äºä¸Šæ¬¡å¤„ç†çš„ï¼‰
                    const newMessages = [];
                    const now = new Date();
                    let messageIndex = 0;
                    
                    // *** æ–°é€»è¾‘ï¼šåªæ”¶é›†æ–°çš„ç§èŠæ¶ˆæ¯ ***
                    console.log(`ğŸ” å¼€å§‹æ”¶é›†æ–°ç§èŠæ¶ˆæ¯ï¼ˆåºåˆ—å· > ${QQ_LastProcessedSequenceId}ï¼‰`);
                    for (const chatKey in QQ_msgjson.ç§èŠ) {
                        const messages = QQ_msgjson.ç§èŠ[chatKey];
                        if (Array.isArray(messages)) {
                            for (let i = 0; i < messages.length; i++) {
                                const msg = messages[i];
                                
                                // *** æ£€æŸ¥è¿™æ¡æ¶ˆæ¯çš„åºåˆ—å· - ä¿®å¤ï¼šä¸ç”Ÿæˆæ–°åºåˆ—å· ***
                                const sequenceInfo = QQ_ExtractOrGenerateSequenceId(msg, false); // false = ä¸ç”Ÿæˆæ–°åºåˆ—å·
                                let sequenceId = sequenceInfo.sequenceId;
                                
                                // *** ä¿®å¤ï¼šåªæ”¶é›†æœ‰åºåˆ—å·çš„æ–°æ¶ˆæ¯ï¼Œä¸é‡æ–°åˆ†é…åºå· ***
                                // è·³è¿‡æ²¡æœ‰åºåˆ—å·çš„å†å²æ¶ˆæ¯
                                if (sequenceId === 0) {
                                    continue; // è·³è¿‡æ²¡æœ‰åºåˆ—å·çš„å†å²æ¶ˆæ¯
                                }
                                
                                // åªæ”¶é›†åºåˆ—å·å¤§äºä¸Šæ¬¡å¤„ç†çš„æ¶ˆæ¯
                                if (sequenceId <= QQ_LastProcessedSequenceId) {
                                    console.log(`â­ï¸ è·³è¿‡å·²å¤„ç†æ¶ˆæ¯ [seq:${sequenceId}] (ä¸Šæ¬¡å¤„ç†: ${QQ_LastProcessedSequenceId}): ${sequenceInfo.cleanMessage.substring(0, 30)}...`);
                                    continue; // è·³è¿‡å·²å¤„ç†çš„æ¶ˆæ¯
                                }
                                
                                console.log(`ğŸ†• å‘ç°æ–°æ¶ˆæ¯ [seq:${sequenceId}] (ä¸Šæ¬¡å¤„ç†: ${QQ_LastProcessedSequenceId}): ${sequenceInfo.cleanMessage.substring(0, 30)}...`);
                                
                                const parts = sequenceInfo.cleanMessage.split('--');
                                if (parts.length >= 2) {
                                    const senderName = parts[0];
                                    const content = parts[1];
                                    const timeStr = parts[2] || QQ_GetTime();
                                    
                                    // ç¡®å®šèŠå¤©å¯¹è±¡ï¼ˆä¿®å¤ï¼šæ ¹æ®å‘é€è€…ç¡®å®šæ¥æ”¶è€…ï¼‰
                                    const match = chatKey.match(/(.+?)å’Œ(.+?)çš„èŠå¤©/);
                                    let chatPartner = '';
                                    if (match) {
                                        const person1 = match[1];
                                        const person2 = match[2];
                                        
                                        // æ ¹æ®å‘é€è€…ç¡®å®šæ¥æ”¶è€…
                                        if (senderName === person1) {
                                            chatPartner = person2;
                                        } else if (senderName === person2) {
                                            chatPartner = person1;
                                        } else {
                                            // å‘é€è€…ä¸åœ¨èŠå¤©é”®åä¸­ï¼Œå¯èƒ½æ˜¯ç”¨æˆ·çš„æ˜µç§°é—®é¢˜ï¼Œä½¿ç”¨UserName
                                            chatPartner = senderName === UserName ? 
                                                (person1 === UserName ? person2 : person1) : 
                                                UserName;
                                        }
                                    }
                                    
                                    // *** ä¿®å¤ï¼šç¡®ä¿æ—¶é—´æˆ³åæ˜ åºåˆ—å·é¡ºåº ***
                                    // ä½¿ç”¨åºåˆ—å·ä½œä¸ºåŸºç¡€æ—¶é—´æˆ³ï¼Œç¡®ä¿æ¶ˆæ¯æŒ‰å‘é€é¡ºåºæ’åˆ—
                                    const baseTimestamp = sequenceId > 0 ? sequenceId : QQ_ParseTime(timeStr);
                                    
                                    newMessages.push({
                                        type: 'ç§èŠ',
                                        sender: senderName,
                                        content: content,
                                        time: timeStr,
                                        chatPartner: chatPartner,
                                        chatKey: chatKey,
                                        arrayIndex: i,
                                        globalIndex: messageIndex++,
                                        sequenceId: sequenceId, // *** æ–°å¢ï¼šé€»è¾‘åºåˆ—å· ***
                                        timestamp: baseTimestamp // ä½¿ç”¨åºåˆ—å·ç¡®ä¿æ­£ç¡®æ’åº
                                    });
                                }
                            }
                        }
                    }
                    
                    // æ”¶é›†ç¾¤èŠæ¶ˆæ¯
                    for (const groupName in QQ_msgjson.ç¾¤èŠ) {
                        const groupData = QQ_msgjson.ç¾¤èŠ[groupName];
                        if (groupData && Array.isArray(groupData.msgs)) {
                            for (let i = 0; i < groupData.msgs.length; i++) {
                                const msg = groupData.msgs[i];
                                
                                // *** ä¿®å¤ï¼šå…ˆæå–åºåˆ—å·ï¼Œå†è§£ææ¶ˆæ¯å†…å®¹ ***
                                const sequenceInfo = QQ_ExtractOrGenerateSequenceId(msg, false); // false = ä¸ç”Ÿæˆæ–°åºåˆ—å·
                                let sequenceId = sequenceInfo.sequenceId;
                                
                                // ä½¿ç”¨æ¸…ç†åçš„æ¶ˆæ¯è¿›è¡Œè§£æ
                                const parts = sequenceInfo.cleanMessage.split('--');
                                if (parts.length >= 2) {
                                    const senderName = parts[0];
                                    const content = parts[1];
                                    const timeStr = parts[2] || now.toLocaleTimeString('zh-CN', { hour12: false });
                                    
                                    // è¿‡æ»¤ç¾¤èŠåˆå§‹åŒ–æ¶ˆæ¯ï¼ˆæ›´ç²¾ç¡®çš„åˆ¤æ–­ï¼‰
                                    const isInitMessage = senderName === 'ç³»ç»Ÿæ¶ˆæ¯' && 
                                        (content.includes('åˆ›å»ºäº†ç¾¤èŠ') || 
                                         (content.includes('åŠ å…¥äº†ç¾¤èŠ') && content.includes('æ¬¢è¿')) ||
                                         content === 'ç¾¤èŠå·²åˆ›å»º' ||
                                         content.includes('æ¬¢è¿åŠ å…¥ç¾¤èŠ'));
                                    
                                    if (!isInitMessage) {
                                        
                                        // è·³è¿‡æ²¡æœ‰åºåˆ—å·çš„å†å²æ¶ˆæ¯
                                        if (sequenceId === 0) {
                                            continue; // è·³è¿‡æ²¡æœ‰åºåˆ—å·çš„å†å²æ¶ˆæ¯
                                        }
                                        
                                        // åªæ”¶é›†åºåˆ—å·å¤§äºä¸Šæ¬¡å¤„ç†çš„æ¶ˆæ¯
                                        if (sequenceId <= QQ_LastProcessedSequenceId) {
                                            console.log(`â­ï¸ è·³è¿‡å·²å¤„ç†ç¾¤èŠæ¶ˆæ¯ [seq:${sequenceId}] (ä¸Šæ¬¡å¤„ç†: ${QQ_LastProcessedSequenceId}): ${msg.substring(0, 30)}...`);
                                            continue; // è·³è¿‡å·²å¤„ç†çš„æ¶ˆæ¯
                                        }
                                        
                                        console.log(`ğŸ†• å‘ç°æ–°ç¾¤èŠæ¶ˆæ¯ [seq:${sequenceId}] (ä¸Šæ¬¡å¤„ç†: ${QQ_LastProcessedSequenceId}): ${msg.substring(0, 30)}...`);
                                        
                                        // *** ä¿®å¤ï¼šç¡®ä¿æ—¶é—´æˆ³åæ˜ åºåˆ—å·é¡ºåº ***
                                        const baseTimestamp = sequenceId > 0 ? sequenceId : QQ_ParseTime(timeStr);
                                        
                                        newMessages.push({
                                            type: 'ç¾¤èŠ',
                                            sender: senderName,
                                            content: content,
                                            time: timeStr,
                                            groupName: groupName,
                                            arrayIndex: i,
                                            globalIndex: messageIndex++,
                                            sequenceId: sequenceId, // *** æ–°å¢ï¼šé€»è¾‘åºåˆ—å· ***
                                            timestamp: baseTimestamp // ä½¿ç”¨åºåˆ—å·ç¡®ä¿æ­£ç¡®æ’åº
                                        });
                                    }
                                }
                            }
                        }
                    }
                    
                    // æ”¶é›†åŠ¨æ€è¯„è®ºï¼ˆä»…æ”¶é›†æ–°çš„ï¼Œæœ‰åºåˆ—å·ä¸”æœªå¤„ç†çš„ï¼‰
                    console.log(`ğŸ” å¼€å§‹æ”¶é›†æ–°åŠ¨æ€å’Œè¯„è®ºï¼ˆåºåˆ—å· > ${QQ_LastProcessedSequenceId}ï¼‰`);
                    if (typeof QQ_MomentsData !== 'undefined' && Array.isArray(QQ_MomentsData)) {
                        for (let momentIndex = 0; momentIndex < QQ_MomentsData.length; momentIndex++) {
                            const moment = QQ_MomentsData[momentIndex];
                            
                            // æ£€æŸ¥åŠ¨æ€æœ¬èº«æ˜¯å¦ä¸ºæ–°åŠ¨æ€ï¼ˆæœ‰åºåˆ—å·ä¸”æœªå¤„ç†ï¼‰
                            if (moment.message && moment.sequenceId) {
                                // åªæ”¶é›†åºåˆ—å·å¤§äºä¸Šæ¬¡å¤„ç†çš„åŠ¨æ€
                                if (moment.sequenceId > QQ_LastProcessedSequenceId) {
                                    console.log(`ğŸ†• å‘ç°æ–°åŠ¨æ€ [seq:${moment.sequenceId}] (ä¸Šæ¬¡å¤„ç†: ${QQ_LastProcessedSequenceId}): ${moment.message.substring(0, 30)}...`);
                                    newMessages.push({
                                        type: 'åŠ¨æ€',
                                        sender: moment.userName || moment.name,
                                        content: `å‘å¸ƒåŠ¨æ€: ${moment.message}`,
                                        time: moment.timestamp || now.toLocaleTimeString('zh-CN', { hour12: false }),
                                        momentIndex: momentIndex, // åœ¨åŠ¨æ€æ•°ç»„ä¸­çš„ä½ç½®
                                        globalIndex: messageIndex++, // å…¨å±€æ¶ˆæ¯é¡ºåºç´¢å¼•
                                        sequenceId: moment.sequenceId, // æ·»åŠ åºåˆ—å·
                                        timestamp: moment.timestamp ? new Date(moment.timestamp).getTime() : QQ_ParseTime(moment.timestamp || now.toLocaleTimeString('zh-CN', { hour12: false }))
                                    });
                                } else {
                                    console.log(`â­ï¸ è·³è¿‡å·²å¤„ç†åŠ¨æ€ [seq:${moment.sequenceId}] (ä¸Šæ¬¡å¤„ç†: ${QQ_LastProcessedSequenceId}): ${moment.message.substring(0, 30)}...`);
                                }
                            } else if (moment.message && !moment.sequenceId) {
                                // *** ä¿®å¤ï¼šè·³è¿‡æ²¡æœ‰åºåˆ—å·çš„å†å²åŠ¨æ€ï¼Œé¿å…é‡å¤æ·»åŠ  ***
                                console.log(`ğŸ“œ è·³è¿‡å†å²åŠ¨æ€ï¼ˆæ— åºåˆ—å·ï¼‰: ${moment.message.substring(0, 30)}...`);
                            }
                            
                            // æ£€æŸ¥åŠ¨æ€è¯„è®ºï¼ˆä»…æ”¶é›†æ–°çš„ï¼‰
                            if (moment.comments && Array.isArray(moment.comments)) {
                                for (let commentIndex = 0; commentIndex < moment.comments.length; commentIndex++) {
                                    const comment = moment.comments[commentIndex];
                                    
                                    // åªæ”¶é›†æœ‰åºåˆ—å·ä¸”æœªå¤„ç†çš„è¯„è®º
                                    if (comment.sequenceId && comment.sequenceId > QQ_LastProcessedSequenceId) {
                                        console.log(`ğŸ†• å‘ç°æ–°è¯„è®º [seq:${comment.sequenceId}] (ä¸Šæ¬¡å¤„ç†: ${QQ_LastProcessedSequenceId}): ${comment.content?.substring(0, 30) || ''}...`);
                                        newMessages.push({
                                            type: 'åŠ¨æ€è¯„è®º',
                                            sender: comment.name || comment.userName,
                                            content: comment.content || comment.message,
                                            time: comment.timestamp || QQ_GetTime(),
                                            momentAuthor: moment.userName || moment.name,
                                            momentContent: moment.message,
                                            momentIndex: momentIndex, // æ‰€å±åŠ¨æ€çš„ä½ç½®
                                            commentIndex: commentIndex, // åœ¨è¯„è®ºæ•°ç»„ä¸­çš„ä½ç½®
                                            globalIndex: messageIndex++, // å…¨å±€æ¶ˆæ¯é¡ºåºç´¢å¼•
                                            sequenceId: comment.sequenceId, // æ·»åŠ åºåˆ—å·
                                            timestamp: comment.timestamp ? new Date(comment.timestamp).getTime() : QQ_ParseTime(comment.timestamp || QQ_GetTime())
                                        });
                                    } else if (comment.sequenceId) {
                                        console.log(`â­ï¸ è·³è¿‡å·²å¤„ç†è¯„è®º [seq:${comment.sequenceId}] (ä¸Šæ¬¡å¤„ç†: ${QQ_LastProcessedSequenceId}): ${comment.content?.substring(0, 30) || ''}...`);
                                    } else {
                                        console.log(`â­ï¸ è·³è¿‡æ— åºåˆ—å·çš„å†å²è¯„è®º: ${comment.content?.substring(0, 30) || ''}...`);
                                    }
                                }
                            }
                        }
                    }
                    
                    console.log(`ğŸ“Š æ”¶é›†åˆ° ${newMessages.length} æ¡æ–°æ¶ˆæ¯`);
                    
                    // *** è°ƒè¯•ï¼šæ˜¾ç¤ºæ‰€æœ‰æ–°æ¶ˆæ¯çš„åºåˆ—å· ***
                    if (newMessages.length > 0) {
                        const sequenceIds = newMessages.map(msg => msg.sequenceId).sort((a, b) => a - b);
                        console.log(`ğŸ” æ–°æ¶ˆæ¯åºåˆ—å·åˆ—è¡¨: [${sequenceIds.join(', ')}]`);
                        console.log(`ğŸ” æœ€å°åºåˆ—å·: ${Math.min(...sequenceIds)}, æœ€å¤§åºåˆ—å·: ${Math.max(...sequenceIds)}`);
                        console.log(`ğŸ” å½“å‰QQ_LastProcessedSequenceId: ${QQ_LastProcessedSequenceId}`);
                    }
                    
                    // *** æ»šåŠ¨å¼æ·»åŠ ï¼šå¦‚æœæ²¡æœ‰æ–°æ¶ˆæ¯ï¼Œåˆ™ä¸æ›´æ–°è®°å¿† ***
                    if (newMessages.length === 0) {
                        console.log('ğŸ“ æ²¡æœ‰æ–°æ¶ˆæ¯ï¼Œè·³è¿‡çŸ­æœŸè®°å¿†æ›´æ–°');
                        return;
                    }
                    
                    // *** æ»šåŠ¨å¼æ·»åŠ ï¼šåªå¤„ç†æ–°æ¶ˆæ¯ï¼Œç›´æ¥è¿½åŠ åˆ°ç°æœ‰è®°å¿† ***
                    console.log(`ğŸ¯ æ»šåŠ¨å¼æ·»åŠ  ${newMessages.length} æ¡æ–°æ¶ˆæ¯åˆ°çŸ­æœŸè®°å¿†åº•éƒ¨...`);
                    
                    // æŒ‰åºåˆ—å·æ’åºæ–°æ¶ˆæ¯ï¼ˆç¡®ä¿é¡ºåºæ­£ç¡®ï¼‰
                    const sortedNewMessages = QQ_SortMessagesBySequence(newMessages, true); // å‡åºï¼šå°çš„åœ¨å‰ï¼Œå¤§çš„åœ¨å
                    console.log(`ğŸ“ æ–°æ¶ˆæ¯å·²æŒ‰åºåˆ—å·æ’åºï¼Œæœ€å°åºå·: ${sortedNewMessages[0]?.sequenceId || 0}, æœ€å¤§åºå·: ${sortedNewMessages[sortedNewMessages.length-1]?.sequenceId || 0}`);
                    
                    // *** è·å–ç°æœ‰è®°å¿†å†…å®¹å¹¶è§£æå·²å­˜åœ¨çš„æ¶ˆæ¯ ***
                    let existingMessages = [];
                    const entryComment = 'æ‰‹æœº-çŸ­æœŸè®°å¿†-æœ€è¿‘å¯¹è¯';
                    
                    // *** å¼ºåˆ¶åˆ·æ–°ä¸–ç•Œä¹¦æ¡ç›®ï¼Œç¡®ä¿è·å–æœ€æ–°å†…å®¹ ***
                    console.log(`ğŸ”„ å¼ºåˆ¶åˆ·æ–°ä¸–ç•Œä¹¦æ¡ç›®ä»¥è·å–æœ€æ–°å†…å®¹...`);
                    entries = await getLorebookEntries(worldbook);
                    
                    // *** ä½¿ç”¨ä¸èŠå¤©å¤‡ä»½ç›¸åŒçš„ç®€å•æŸ¥æ‰¾æ–¹å¼ ***
                    const existingEntry = entries.find(entry => entry.comment === entryComment);
                    
                    console.log(`ğŸ” åˆå§‹æŸ¥æ‰¾ç°æœ‰è®°å¿†æ¡ç›®: ${existingEntry ? `æ‰¾åˆ° (UID: ${existingEntry.uid})` : 'æœªæ‰¾åˆ°'}`);
                    
                    if (existingEntry && existingEntry.content) {
                        console.log(`ğŸ“– æ‰¾åˆ°ç°æœ‰è®°å¿†æ¡ç›®ï¼Œé•¿åº¦: ${existingEntry.content.length}ï¼Œä½¿ç”¨ç›´æ¥æ’å…¥æ–¹å¼`);
                    }
                    
                    // *** é‡‡ç”¨ç±»ä¼¼èŠå¤©å¤‡ä»½çš„ç›´æ¥æ’å…¥æ–¹å¼ ***
                    console.log(`ğŸ’¾ çŸ­æœŸè®°å¿†æ»šåŠ¨æ›´æ–°ï¼šå°†æ·»åŠ ${sortedNewMessages.length}æ¡æ–°æ¶ˆæ¯`);
                    
                    // *** æ ¼å¼åŒ–æ–°æ¶ˆæ¯å†…å®¹ ***
                    let newContent = '';
                    
                    // *** å¯¹è¯å›åˆè·Ÿè¸ªå’Œæ—¶é—´åˆ†éš”ç¬¦ ***
                    let lastUserMessageTime = null;
                    let hasAIReplyAfterUser = false;
                    let lastRoundTime = null;
                    
                    for (let i = 0; i < sortedNewMessages.length; i++) {
                        const msg = sortedNewMessages[i];
                        const isUserMessage = msg.sender === UserName;
                        
                        // ä¸ºç”¨æˆ·æ¶ˆæ¯æ ¼å¼åŒ–æ—¶é—´ï¼ˆå»æ‰ç§’æ•°ï¼‰
                        let displayTime = msg.time;
                        if (isUserMessage && msg.time) {
                            displayTime = QQ_FormatTimeToMinutes(msg.time);
                        }
                        
                        // *** ä¿®å¤ï¼šæ£€æµ‹äº’åŠ¨å†…å®¹å ä½ç¬¦å¹¶å­˜å‚¨åˆ°çŸ­æœŸè®°å¿† ***
                        const interactiveMatch = msg.content.match(/\[å‘ç”Ÿäº†ä¸€æ®µäº’åŠ¨ \(ID: (.+?)\)\]/);
                        let contentToStore = msg.content;
                        
                        if (interactiveMatch) {
                            const interactiveId = interactiveMatch[1];
                            console.log(`ğŸ­ çŸ­æœŸè®°å¿†ä¸­æ£€æµ‹åˆ°äº’åŠ¨å†…å®¹å ä½ç¬¦: ${interactiveId}`);
                            
                            // å°†å ä½ç¬¦ä¿å­˜åˆ°çŸ­æœŸè®°å¿†çš„äº’åŠ¨å†…å®¹åˆ—è¡¨ä¸­
                            if (!window.QQ_ShortTermInteractiveContent) {
                                window.QQ_ShortTermInteractiveContent = [];
                            }
                            
                            // ç¡®ä¿ä¸é‡å¤æ·»åŠ 
                            if (!window.QQ_ShortTermInteractiveContent.find(item => item.id === interactiveId)) {
                                window.QQ_ShortTermInteractiveContent.unshift({
                                    id: interactiveId,
                                    timestamp: new Date().toISOString(),
                                    sequenceId: msg.sequenceId,
                                    context: {
                                        type: msg.type,
                                        sender: msg.sender,
                                        time: displayTime,
                                        chatPartner: msg.chatPartner,
                                        groupName: msg.groupName
                                    }
                                });
                                
                                // ä¿æŒæœ€æ–°çš„20ä¸ªäº’åŠ¨å†…å®¹å ä½ç¬¦
                                if (window.QQ_ShortTermInteractiveContent.length > 20) {
                                    window.QQ_ShortTermInteractiveContent = window.QQ_ShortTermInteractiveContent.slice(0, 20);
                                }
                                
                                console.log(`ğŸ“ äº’åŠ¨å†…å®¹å ä½ç¬¦å·²å­˜å‚¨åˆ°çŸ­æœŸè®°å¿†ï¼Œå½“å‰æ•°é‡: ${window.QQ_ShortTermInteractiveContent.length}`);
                            }
                        }
                        
                        // æ·»åŠ æ–°æ¶ˆæ¯å†…å®¹åˆ°newContent
                        if (msg.type === 'ç§èŠ') {
                            newContent += `[${displayTime}] ${msg.sender}å¯¹${msg.chatPartner}è¯´: ${contentToStore}\n`;
                        } else if (msg.type === 'ç¾¤èŠ') {
                            newContent += `[${displayTime}] ${msg.sender}åœ¨ç¾¤èŠ"${msg.groupName}"ä¸­è¯´: ${contentToStore}\n`;
                        } else if (msg.type === 'åŠ¨æ€') {
                            newContent += `[${displayTime}] ${msg.sender}${contentToStore}\n`;
                        } else if (msg.type === 'åŠ¨æ€è¯„è®º') {
                            newContent += `[${displayTime}] ${msg.sender}è¯„è®º${msg.momentAuthor}çš„åŠ¨æ€: ${contentToStore}\n`;
                        }
                        
                        // *** å¯¹è¯å›åˆæ£€æµ‹é€»è¾‘ ***
                        if (isUserMessage) {
                            lastUserMessageTime = msg.time;
                            hasAIReplyAfterUser = false;
                        } else {
                            // AIå›å¤
                            if (lastUserMessageTime && !hasAIReplyAfterUser) {
                                hasAIReplyAfterUser = true;
                            }
                        }
                        
                        // *** åœ¨å¯¹è¯å›åˆç»“æŸåæ·»åŠ æ—¶é—´åˆ†éš”ç¬¦ ***
                        const isLastMessage = i === sortedNewMessages.length - 1;
                        const nextMessage = !isLastMessage ? sortedNewMessages[i + 1] : null;
                        const nextIsUser = nextMessage ? nextMessage.sender === UserName : false;
                        
                        // åœ¨AIå›å¤åï¼Œå¦‚æœä¸‹ä¸€æ¡æ˜¯ç”¨æˆ·æ¶ˆæ¯æˆ–è€…æ˜¯æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œåˆ™æ·»åŠ æ—¶é—´åˆ†éš”ç¬¦
                        const shouldAddTimeSeparator = !isUserMessage && hasAIReplyAfterUser && (nextIsUser || isLastMessage);
                        
                        if (shouldAddTimeSeparator) {
                            const msgTime = msg.time || QQ_GetTime();
                            const now = new Date();
                            
                            // è§£ææ—¶é—´å­—ç¬¦ä¸²ï¼ˆæ ¼å¼ï¼šHH:MM æˆ– HH:MM:SSï¼‰
                            const timeParts = msgTime.match(/(\d{1,2}):(\d{2})/);
                            if (timeParts) {
                                now.setHours(parseInt(timeParts[1], 10));
                                now.setMinutes(parseInt(timeParts[2], 10));
                            }
                            
                            const timeStr = now.toLocaleString('zh-CN', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            
                            // é¿å…é‡å¤æ·»åŠ ç›¸åŒæ—¶é—´çš„åˆ†éš”ç¬¦
                            if (lastRoundTime !== timeStr) {
                                newContent += `\nğŸ“… ${timeStr}\n\n`;
                                lastRoundTime = timeStr;
                                console.log(`ğŸ•’ å·²æ·»åŠ å¯¹è¯å›åˆæ—¶é—´åˆ†éš”ç¬¦: ${timeStr}`);
                            }
                            
                            // é‡ç½®çŠ¶æ€
                            lastUserMessageTime = null;
                            hasAIReplyAfterUser = false;
                        }
                    }
                    
                    // *** ç›´æ¥æ’å…¥æ–¹å¼ï¼šç±»ä¼¼èŠå¤©å¤‡ä»½ ***
                    let memoryContent = '';
                    
                    if (existingEntry && existingEntry.content) {
                        // ç›´æ¥ä½¿ç”¨ç°æœ‰å†…å®¹ï¼Œä½†éœ€è¦æ›´æ–°è®°å½•ä¿¡æ¯
                        memoryContent = existingEntry.content;
                        
                        // æ›´æ–°è®°å½•ä¿¡æ¯ä¸­çš„æ—¶é—´å’Œæ¡æ•°
                        const recordInfoPattern = /(\*\*è®°å½•ä¿¡æ¯ï¼š\*\*\n- æ›´æ–°æ—¶é—´: )[^\n]+(.*?\n- ä¿å­˜æ¡æ•°: )\d+/;
                        const totalMessages = memoryContent.split(/\[.*?##seq_\d+##\]/).length - 1 + sortedNewMessages.length;
                        const updatedRecordInfo = `$1${now.toLocaleString('zh-CN')}$2${totalMessages}`;
                        
                        if (recordInfoPattern.test(memoryContent)) {
                            memoryContent = memoryContent.replace(recordInfoPattern, updatedRecordInfo);
                            console.log(`ğŸ“ å·²æ›´æ–°ç°æœ‰è®°å½•ä¿¡æ¯ - æ—¶é—´: ${now.toLocaleString('zh-CN')}, æ€»æ¡æ•°: ${totalMessages}`);
                        }
                        
                        console.log(`ğŸ“ ä½¿ç”¨ç°æœ‰å†…å®¹ä½œä¸ºåŸºç¡€ï¼Œå‡†å¤‡ç›´æ¥æ’å…¥æ–°æ¶ˆæ¯`);
                    } else {
                        // åˆ›å»ºæ–°çš„å†…å®¹ç»“æ„
                        memoryContent = `# ã€å†å²å¯¹è¯è®°å½• - ä»…ä¾›å‚è€ƒï¼Œè¯·å‹¿é‡å¤ã€‘

**é‡è¦è¯´æ˜ï¼š**
- è¿™æ˜¯æœ€è¿‘çš„å†å²å¯¹è¯è®°å½•ï¼Œä»…ç”¨äºäº†è§£ä¸Šä¸‹æ–‡å’Œè§’è‰²å…³ç³»
- è¯·ä¸è¦åœ¨å›å¤ä¸­é‡å¤æˆ–å¤è¿°è¿™äº›å†å²å†…å®¹
- è¯·åŸºäºè¿™äº›èƒŒæ™¯ä¿¡æ¯è‡ªç„¶åœ°ç»§ç»­å½“å‰å¯¹è¯

---

**è®°å½•ä¿¡æ¯ï¼š**
- æ›´æ–°æ—¶é—´: ${now.toLocaleString('zh-CN')}
- ä¿å­˜æ¡æ•°: ${sortedNewMessages.length}/1000 æ¡å†å²æ¶ˆæ¯ (æ–°å»ºè®°å¿†)

**å†å²å¯¹è¯å†…å®¹ï¼š**

`;
                        console.log(`ğŸ“ åˆ›å»ºæ–°çš„çŸ­æœŸè®°å¿†ç»“æ„`);
                    }
                    
                    // *** å°†æ–°å†…å®¹æ’å…¥åˆ°ç»“æŸæ ‡è¯†å‰é¢ ***
                    if (newContent.trim()) {
                        // ä½¿ç”¨æ›´å¥å£®çš„æ–¹æ³•æŸ¥æ‰¾ç»“æŸæ ‡è¯†
                        const endMarkerPattern = /---\s*\*\*ã€å†å²è®°å½•ç»“æŸã€‘\*\*/;
                        const endMarkerMatch = memoryContent.match(endMarkerPattern);
                        
                        console.log(`ğŸ” æŸ¥æ‰¾ç»“æŸæ ‡è¯†ç»“æœ: ${endMarkerMatch ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°'}`);
                        console.log(`ğŸ“ è®°å¿†å†…å®¹é•¿åº¦: ${memoryContent.length}, æ–°å†…å®¹é•¿åº¦: ${newContent.length}`);
                        
                        // *** è°ƒè¯•ï¼šæ˜¾ç¤ºè®°å¿†å†…å®¹çš„æœ«å°¾éƒ¨åˆ† ***
                        if (memoryContent.length > 200) {
                            console.log(`ğŸ“„ [è°ƒè¯•] è®°å¿†å†…å®¹æœ«å°¾200å­—ç¬¦: "${memoryContent.substring(memoryContent.length - 200)}"`);
                        } else {
                            console.log(`ğŸ“„ [è°ƒè¯•] å®Œæ•´è®°å¿†å†…å®¹: "${memoryContent}"`);
                        }
                        
                        if (endMarkerMatch) {
                            // æ‰¾åˆ°ç»“æŸæ ‡è¯†ï¼Œåœ¨å…¶å‰é¢æ’å…¥æ–°å†…å®¹
                            const endMarkerIndex = endMarkerMatch.index;
                            const contentBeforeEnd = memoryContent.substring(0, endMarkerIndex);
                            const endMarkerContent = memoryContent.substring(endMarkerIndex);
                            
                            // ç¡®ä¿å†…å®¹ä»¥æ¢è¡Œç»“å°¾
                            let finalContent = contentBeforeEnd;
                            if (!finalContent.endsWith('\n')) {
                                finalContent += '\n';
                            }
                            
                            // åœ¨ç»“æŸæ ‡è¯†å‰æ’å…¥æ–°å†…å®¹
                            memoryContent = finalContent + newContent + '\n' + endMarkerContent;
                            console.log(`âœ… å·²å°†${sortedNewMessages.length}æ¡æ–°æ¶ˆæ¯è¿½åŠ åˆ°å†å²è®°å½•æœ«å°¾ï¼ˆä¿ç•™ç°æœ‰å†…å®¹ï¼‰`);
                        } else {
                            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç»“æŸæ ‡è¯†ï¼Œç›´æ¥è¿½åŠ å¹¶æ·»åŠ ç»“æŸæ ‡è¯†
                            console.log(`âš ï¸ æœªæ‰¾åˆ°ç»“æŸæ ‡è¯†ï¼Œå°†åœ¨æœ«å°¾è¿½åŠ æ–°å†…å®¹`);
                            if (memoryContent && !memoryContent.endsWith('\n')) {
                                memoryContent += '\n';
                            }
                            memoryContent += newContent;
                            memoryContent += `\n---\n**ã€å†å²è®°å½•ç»“æŸã€‘** ä»¥ä¸Šä¸ºå†å²å¯¹è¯è®°å½•ï¼Œè¯·åŸºäºæ­¤èƒŒæ™¯è‡ªç„¶åœ°è¿›è¡Œå½“å‰å¯¹è¯ï¼Œä¸è¦é‡å¤ä¸Šè¿°å†…å®¹ã€‚\n`;
                            console.log(`âœ… å·²å°†${sortedNewMessages.length}æ¡æ–°æ¶ˆæ¯è¿½åŠ åˆ°çŸ­æœŸè®°å¿†åº•éƒ¨ï¼ˆé¦–æ¬¡åˆ›å»º/ä¿®å¤ï¼‰`);
                        }
                    }
                    
                    // *** é‡‡ç”¨ä¸èŠå¤©å¤‡ä»½å®Œå…¨ç›¸åŒçš„æˆåŠŸæ¨¡å¼ ***
                    console.log(`ğŸ” æŸ¥æ‰¾ç°æœ‰çŸ­æœŸè®°å¿†æ¡ç›®ï¼Œç›®æ ‡comment: "${entryComment}"`);
                    
                    // ä½¿ç”¨ä¸èŠå¤©å¤‡ä»½ç›¸åŒçš„ç®€å•æŸ¥æ‰¾æ–¹å¼
                    let memoryEntryForSave = entries.find(entry => entry.comment === entryComment);
                    
                    console.log(`ğŸ¯ æŸ¥æ‰¾ç»“æœ: ${memoryEntryForSave ? `æ‰¾åˆ°ç°æœ‰æ¡ç›® (UID: ${memoryEntryForSave.uid})` : 'æœªæ‰¾åˆ°ï¼Œå°†åˆ›å»ºæ–°æ¡ç›®'}`);
                    
                    if (memoryEntryForSave) {
                        // *** ä¿®å¤ï¼šåœ¨ä¿å­˜å‰å¤„ç†äº’åŠ¨å†…å®¹å ä½ç¬¦ ***
                        console.log(`ğŸ­ æ­£åœ¨å¤„ç†çŸ­æœŸè®°å¿†ä¸­çš„äº’åŠ¨å†…å®¹å ä½ç¬¦...`);
                        memoryContent = await QQ_ProcessShortTermMemoryInteractiveContent(memoryContent);
                        
                        // *** ä½¿ç”¨ä¸èŠå¤©å¤‡ä»½ç›¸åŒçš„æ›´æ–°æ–¹å¼ - åªæ›´æ–°content ***
                        console.log(`ğŸ’¾ [è°ƒè¯•] å‡†å¤‡ä¿å­˜å†…å®¹é•¿åº¦: ${memoryContent.length}`);
                        
                        await setLorebookEntries(worldbook, [{
                            uid: memoryEntryForSave.uid,
                            content: memoryContent,
                        }]);
                        console.log('çŸ­æœŸè®°å¿†å·²æ›´æ–°åˆ°ç°æœ‰worldbookæ¡ç›®');
                        
                        // *** ç«‹å³éªŒè¯ä¿å­˜ç»“æœ ***
                        const verifyEntries = await getLorebookEntries(worldbook);
                        const verifyEntry = verifyEntries.find(entry => entry.comment === entryComment);
                        if (verifyEntry) {
                            console.log(`âœ… [éªŒè¯] ä¿å­˜åå†…å®¹é•¿åº¦: ${verifyEntry.content.length}`);
                            if (verifyEntry.content.length !== memoryContent.length) {
                                console.error(`âŒ [éªŒè¯å¤±è´¥] é¢„æœŸé•¿åº¦: ${memoryContent.length}, å®é™…é•¿åº¦: ${verifyEntry.content.length}`);
                            }
                        } else {
                            console.error(`âŒ [éªŒè¯å¤±è´¥] ä¿å­˜åæ— æ³•æ‰¾åˆ°æ¡ç›®`);
                        }
                    } else {
                        // *** ä¿®å¤ï¼šåœ¨åˆ›å»ºæ–°æ¡ç›®å‰å¤„ç†äº’åŠ¨å†…å®¹å ä½ç¬¦ ***
                        console.log(`ğŸ­ æ­£åœ¨å¤„ç†æ–°æ¡ç›®ä¸­çš„äº’åŠ¨å†…å®¹å ä½ç¬¦...`);
                        memoryContent = await QQ_ProcessShortTermMemoryInteractiveContent(memoryContent);
                        
                        // *** ä½¿ç”¨ä¸èŠå¤©å¤‡ä»½å®Œå…¨ç›¸åŒçš„åˆ›å»ºæ–¹å¼ ***
                        await createLorebookEntry(worldbook, {
                            comment: entryComment,
                            key: ["çŸ­æœŸè®°å¿†-æœ€è¿‘å¯¹è¯", "æœ€è¿‘å¯¹è¯", "çŸ­æœŸè®°å¿†", "å¯¹è¯å†å²", "èŠå¤©è®°å½•"],
                            content: memoryContent,
                            position: "before_character_definition", 
                            type: "constant",
                            depth: 0,
                            exclude_recursion: true,
                            order: 1000,
                            enabled: true,
                        });
                        console.log('çŸ­æœŸè®°å¿†å·²ä¿å­˜åˆ°æ–°worldbookæ¡ç›®');
                        
                        // *** å…³é”®ï¼šä½¿ç”¨ä¸èŠå¤©å¤‡ä»½ç›¸åŒçš„entriesåˆ·æ–°æ–¹å¼ ***
                        entries = await getLorebookEntries(worldbook);
                    }
                    
                    // ä¿å­˜ä¸–ç•Œä¹¦ - ä½¿ç”¨ä¸å…¶ä»–åŠŸèƒ½ç›¸åŒçš„æ–¹å¼
                    try {
                        await QQ_SafeSaveWorldInfo('çŸ­æœŸè®°å¿†');
                        console.log('ğŸ§  çŸ­æœŸè®°å¿†å·²ä¿å­˜åˆ°ä¸–ç•Œä¹¦');
                    } catch (saveError) {
                        console.warn('âš ï¸ ä¸–ç•Œä¹¦ä¿å­˜è­¦å‘Š:', saveError.message);
                        console.log('ğŸ“ çŸ­æœŸè®°å¿†æ¡ç›®å·²åˆ›å»ºï¼Œæ•°æ®åº”è¯¥ä¼šè‡ªåŠ¨ä¿å­˜');
                    }
                    
                    // è°ƒè¯•ä¿¡æ¯ï¼šæ˜¾ç¤ºå½“å‰ä¸–ç•Œä¹¦ä¸­çš„æ¡ç›®
                    console.log('ğŸ” è°ƒè¯•ä¿¡æ¯ - å½“å‰ä¸–ç•Œä¹¦æ¡ç›®æ•°é‡:', Object.keys(entries).length);
                    
                    // å»¶è¿ŸéªŒè¯æ¡ç›®æ˜¯å¦çœŸçš„è¢«åˆ›å»ºï¼ˆç»™ä¸–ç•Œä¹¦APIæ—¶é—´æ›´æ–°æœ¬åœ°æ•°æ®ï¼‰
                    setTimeout(() => {
                        const verifyEntry = Object.values(entries).find(entry => 
                            entry && entry.comment === entryComment
                        );
                        
                        if (verifyEntry) {
                            console.log('âœ… çŸ­æœŸè®°å¿†æ¡ç›®éªŒè¯æˆåŠŸ');
                            console.log('ğŸ“ æ¡ç›®å†…å®¹é•¿åº¦:', verifyEntry.content?.length || 0);
                            console.log('ğŸ¯ æ¡ç›®å…³é”®è¯:', verifyEntry.keys || verifyEntry.key);
                            console.log('âš™ï¸ æ¡ç›®è®¾ç½® - type:', verifyEntry.type, 'enabled:', verifyEntry.enabled);
                            console.log('ğŸ†” æ¡ç›®UID:', verifyEntry.uid);
                        } else {
                            console.log('â„¹ï¸ çŸ­æœŸè®°å¿†æ¡ç›®åœ¨æœ¬åœ°ç¼“å­˜ä¸­æš‚æœªåŒæ­¥ï¼Œä½†å·²é€šè¿‡APIæˆåŠŸåˆ›å»º');
                        }
                    }, 1000);
                    
                    // *** ä¿®å¤ï¼šæ›´æ–°å¹¶æŒä¹…åŒ–æœ€åå¤„ç†çš„åºåˆ—ID ***
                    if (newMessages.length > 0) {
                        const maxSequenceId = Math.max(...newMessages.map(msg => msg.sequenceId || 0));
                        QQ_LastProcessedSequenceId = maxSequenceId;
                        console.log(`ğŸ”„ å·²æ›´æ–°æœ€åå¤„ç†çš„åºåˆ—ID: ${QQ_LastProcessedSequenceId}`);
                        
                        // *** ç«‹å³ä¿å­˜åºåˆ—å·çŠ¶æ€åˆ°ä¸–ç•Œä¹¦ ***
                        QQ_SaveLastProcessedSequenceId(maxSequenceId).then(success => {
                            if (success) {
                                console.log(`ğŸ’¾ åºåˆ—å·çŠ¶æ€å·²ä¿å­˜åˆ°ä¸–ç•Œä¹¦: ${maxSequenceId}`);
                            } else {
                                console.warn(`âš ï¸ åºåˆ—å·çŠ¶æ€ä¿å­˜å¤±è´¥: ${maxSequenceId}`);
                            }
                        }).catch(error => {
                            console.error('ä¿å­˜åºåˆ—å·çŠ¶æ€å¼‚å¸¸:', error);
                        });
                    }
                    
                } catch (error) {
                    console.error('âŒ æ›´æ–°çŸ­æœŸè®°å¿†å¤±è´¥:', error);
                }
            }
            
            /**
             * ğŸ” è°ƒè¯•å‡½æ•°ï¼šæŸ¥çœ‹çŸ­æœŸè®°å¿†çŠ¶æ€
             * åœ¨æ§åˆ¶å°ä¸­è°ƒç”¨ï¼šQQ_DebugShortTermMemory()
             */
            function QQ_DebugShortTermMemory() {
                console.log('ğŸ§  === çŸ­æœŸè®°å¿†è°ƒè¯•ä¿¡æ¯ ===');
                
                if (!worldbook || !entries) {
                    console.error('âŒ ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨');
                    return;
                }
                
                const entryComment = 'æ‰‹æœº-çŸ­æœŸè®°å¿†-æœ€è¿‘å¯¹è¯';
                const memoryEntry = Object.values(entries).find(entry => 
                    entry && entry.comment === entryComment
                );
                
                console.log('ğŸ“Š ä¸–ç•Œä¹¦æ€»æ¡ç›®æ•°:', Object.keys(entries).length);
                console.log('ğŸ¯ çŸ­æœŸè®°å¿†æ¡ç›®å­˜åœ¨:', !!memoryEntry);
                
                if (memoryEntry) {
                    console.log('ğŸ“ çŸ­æœŸè®°å¿†æ¡ç›®è¯¦æƒ…:');
                    console.log('   - å†…å®¹é•¿åº¦:', memoryEntry.content.length);
                    console.log('   - å…³é”®è¯:', memoryEntry.key);
                    console.log('   - å¸¸é©»(constant):', memoryEntry.constant);
                    console.log('   - å¯ç”¨(enabled):', memoryEntry.enabled);
                    console.log('   - ä¼˜å…ˆçº§(order):', memoryEntry.order);
                    console.log('   - ä½ç½®(position):', memoryEntry.position);
                    console.log('   - æ³¨é‡Š:', memoryEntry.comment);
                    
                    // æ˜¾ç¤ºå†…å®¹é¢„è§ˆ
                    const preview = memoryEntry.content.substring(0, 300) + '...';
                    console.log('ğŸ“„ å†…å®¹é¢„è§ˆ:\n', preview);
                } else {
                    console.warn('âš ï¸ çŸ­æœŸè®°å¿†æ¡ç›®ä¸å­˜åœ¨ï¼Œå¯èƒ½çš„åŸå› :');
                    console.log('   1. çŸ­æœŸè®°å¿†ç³»ç»Ÿå°šæœªè¿è¡Œ');
                    console.log('   2. ä¸–ç•Œä¹¦ä¿å­˜å¤±è´¥');
                    console.log('   3. æ¡ç›®è¢«æ„å¤–åˆ é™¤');
                    
                    // å°è¯•æ‰‹åŠ¨åˆ›å»º
                    console.log('ğŸ”§ å°è¯•æ‰‹åŠ¨è§¦å‘çŸ­æœŸè®°å¿†æ›´æ–°...');
                    QQ_UpdateShortTermMemory().then(() => {
                        console.log('âœ… æ‰‹åŠ¨æ›´æ–°å®Œæˆï¼Œè¯·é‡æ–°è°ƒç”¨æ­¤å‡½æ•°æŸ¥çœ‹ç»“æœ');
                    }).catch(err => {
                        console.error('âŒ æ‰‹åŠ¨æ›´æ–°å¤±è´¥:', err);
                    });
                }
            }

            /**
             * è§£ææ—¶é—´å­—ç¬¦ä¸²ä¸ºæ—¶é—´æˆ³ï¼ˆç”¨äºæ’åºï¼‰
             */
            function QQ_ParseTime(timeStr) {
                try {
                    if (!timeStr) return Date.now();
                    
                    // å¤„ç†æ—¶é—´æˆ³æ ¼å¼ï¼ˆåŠ¨æ€å¸¸ç”¨ï¼‰
                    if (timeStr instanceof Date) {
                        return timeStr.getTime();
                    }
                    
                    // *** æ–°å¢ï¼šå¤„ç†å®Œæ•´æ—¥æœŸæ—¶é—´æ ¼å¼ (YYYY/MM/DD HH:MM æˆ– YYYY/MM/DD, HH:MM) ***
                    const fullDateTimeRegex = /^(\d{4})\/(\d{1,2})\/(\d{1,2})[,\s]+(\d{1,2}):(\d{2})$/;
                    const fullDateTimeMatch = timeStr.match(fullDateTimeRegex);
                    if (fullDateTimeMatch) {
                        const [, year, month, day, hours, minutes] = fullDateTimeMatch.map(Number);
                        return new Date(year, month - 1, day, hours, minutes, 0).getTime();
                    }
                    
                    // å¤„ç† ISO æ ¼å¼
                    if (timeStr.includes('T') || (timeStr.includes('-') && timeStr.length > 10)) {
                        const parsed = Date.parse(timeStr);
                        if (!isNaN(parsed)) return parsed;
                    }
                    
                    // *** ä¿®æ”¹ï¼šå¯¹äºçº¯æ—¶é—´æ ¼å¼ï¼Œä½¿ç”¨å½“å‰æ—¥æœŸä½†è­¦å‘Šç”¨æˆ· ***
                    const today = new Date();
                    if (/^\d{2}:\d{2}:\d{2}$/.test(timeStr)) {
                        // HH:MM:SS æ ¼å¼
                        // console.log(`ğŸ• ä½¿ç”¨çº¯æ—¶é—´æ ¼å¼ '${timeStr}'ï¼Œé…åˆåºåˆ—å·æ’åº`); // å‡å°‘æ—¥å¿—å™ªéŸ³
                        const [hours, minutes, seconds] = timeStr.split(':').map(Number);
                        return new Date(today.getFullYear(), today.getMonth(), today.getDate(), hours, minutes, seconds).getTime();
                    } else if (/^\d{1,2}:\d{2}$/.test(timeStr)) {
                        // HH:MM æˆ– H:MM æ ¼å¼
                        // console.log(`ğŸ• ä½¿ç”¨çº¯æ—¶é—´æ ¼å¼ '${timeStr}'ï¼Œé…åˆåºåˆ—å·æ’åº`); // å‡å°‘æ—¥å¿—å™ªéŸ³
                        const [hours, minutes] = timeStr.split(':').map(Number);
                        return new Date(today.getFullYear(), today.getMonth(), today.getDate(), hours, minutes, 0).getTime();
                    } else {
                        // å…¶ä»–æ ¼å¼ï¼Œå°è¯•è§£æ
                        const parsed = Date.parse(timeStr);
                        if (!isNaN(parsed)) {
                            return parsed;
                        }
                        console.warn(`âš ï¸ æ— æ³•è§£ææ—¶é—´æ ¼å¼ '${timeStr}'ï¼Œä½¿ç”¨å½“å‰æ—¶é—´`);
                        return Date.now();
                    }
                } catch (e) {
                    console.warn('è§£ææ—¶é—´å¤±è´¥:', timeStr, e);
                    return Date.now();
                }
            }

            /**
             * å°†æ—¶é—´æ ¼å¼åŒ–ä¸ºåªæ˜¾ç¤ºåˆ°åˆ†é’Ÿï¼ˆç”¨äºç”¨æˆ·æ¶ˆæ¯ï¼‰
             * @param {string} timeStr - åŸå§‹æ—¶é—´å­—ç¬¦ä¸²
             * @returns {string} æ ¼å¼åŒ–åçš„æ—¶é—´å­—ç¬¦ä¸²
             */
            function QQ_FormatTimeToMinutes(timeStr) {
                try {
                    if (!timeStr) return '';
                    
                    // å¦‚æœå·²ç»æ˜¯ HH:MM æ ¼å¼ï¼Œç›´æ¥è¿”å›
                    if (/^\d{1,2}:\d{2}$/.test(timeStr)) {
                        return timeStr;
                    }
                    
                    // å¦‚æœæ˜¯ HH:MM:SS æ ¼å¼ï¼Œå»æ‰ç§’æ•°
                    if (/^\d{1,2}:\d{2}:\d{2}$/.test(timeStr)) {
                        return timeStr.substring(0, timeStr.lastIndexOf(':'));
                    }
                    
                    // å¦‚æœæ˜¯å…¶ä»–æ ¼å¼ï¼Œå°è¯•è§£æåé‡æ–°æ ¼å¼åŒ–
                    const parsed = Date.parse(timeStr);
                    if (!isNaN(parsed)) {
                        const date = new Date(parsed);
                        return date.toLocaleTimeString('zh-CN', { 
                            hour12: false, 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                    }
                    
                    // å¦‚æœéƒ½å¤±è´¥äº†ï¼Œè¿”å›åŸå§‹å­—ç¬¦ä¸²
                    return timeStr;
                    
                } catch (e) {
                    console.warn('æ ¼å¼åŒ–æ—¶é—´å¤±è´¥:', timeStr, e);
                    return timeStr;
                }
            }

            /**
             * åˆå§‹åŒ–æ—¶è§£æèŠå¤©æ¶ˆæ¯
             * @param content èŠå¤©æ¶ˆæ¯å†…å®¹
             */
            async function QQ_Msg_Parse(content) {
                //content = QQ_Msg_Repair(content);
                console.log(`å¼€å§‹è§£æèŠå¤©æ¶ˆæ¯:${content}`);
                let hasstr = false;
                if (content.match(/\S/)) {
                    hasstr = true;
                }
                let json = JsonYamlParse(content);
                if (!json) {
                    if (hasstr) {
                        QQ_Error(`è§£æèŠå¤©è®°å½•å¤±è´¥,è¯·æ‰‹åŠ¨è§£å†³`);
                    }
                    // QQ_Error(`yamlè§£æå¤±è´¥`);
                    return;
                }
                console.log(`è§£ææˆåŠŸæ—¶çš„èŠå¤©æ¶ˆæ¯:${JSON.stringify(json)}`);
                const $QQpage = $("#App_QQ");
                if ($QQpage.length === 0) {
                    console.log("è·å–QQpageå¤±è´¥");
                    return;
                }
                for (let str in json.ç§èŠ) {
                    const match = str.match(/(.+?)å’Œ(.+?)çš„èŠå¤©/);
                    if (!match) {
                        continue;
                    }
                    // *** é¦–å…ˆæ£€æŸ¥ï¼šè§’è‰²ä¹‹é—´çš„ç§èŠï¼ˆä¸åŒ…å«ç”¨æˆ·ï¼‰ ***
                    if (match[1] !== `${UserName}` && match[2] !== `${UserName}`) {
                        console.log(`æ£€æµ‹åˆ°è§’è‰²é—´ç§èŠ: ${match[1]} å’Œ ${match[2]}`);
                        await QQ_HandleCharacterChat(str, json.ç§èŠ[str], match[1], match[2]);
                        continue;
                    }
                    
                    // *** å¤„ç†ç”¨æˆ·å‚ä¸çš„ç§èŠ ***
                    let name = "";
                    if (match[1] != `${UserName}`) {
                        name = match[1];
                    } else if (match[2] != `${UserName}`) {
                        name = match[2];
                    } else {
                        // ä¸¤ä¸ªå‚ä¸è€…éƒ½æ˜¯ç”¨æˆ·ï¼Œè·³è¿‡
                        continue;
                    }
                    
                    // *** å¢å¼ºçš„ç”¨æˆ·ç§èŠå®‰å…¨æ£€æŸ¥ ***
                    if (!QQ_ValidatePrivateChatAccess(UserName, name, 'user')) {
                        console.warn(`âŒ ç”¨æˆ·ç§èŠè®¿é—®è¢«æ‹’ç»: ${UserName} å’Œ ${name}`);
                        continue;
                    }
                    try {
                        if (!QQ_msgjson.ç§èŠ[str]) {
                            QQ_msgjson.ç§èŠ[str] = [];
                        }
                        if (!QQ_NewMsg[name]) {
                            QQ_NewMsg[name] = {};
                        }
                        if (
                            !$(`.QQ_home_usermsg[data-name='${name}']`)
                                .length &&
                            name != `${UserName}`
                        ) {
                            console.log(`${name}çš„ä¸»é¡µä¸å­˜åœ¨,å¼€å§‹åˆ›å»º`);
                            AddNewChar(name, "");
                        }
                        let $page = $(`.QQ_chat_page[data-name='${name}']`);
                        let Creat = false;
                        if ($page.length === 0) {
                            Creat = true;
                            console.log(`${name}çš„èŠå¤©é¡µä¸å­˜åœ¨,å¼€å§‹åˆ›å»º123`);
                            $page = $(await QQ_CreatChatPage(`${name}`));
                            $QQpage.append($page);
                        }
                        if (json.ç§èŠ[str].length == 0) {
                            continue;
                        }
                        let $msgContent = $page.find(".msgcontent");
                        let NewMsgCount = 0;
                        let LastTime = "";
                        let LastMsg = "";
                        
                        // *** æ–°å¢ï¼šè¿‡æ»¤ç”¨æˆ·é‡å¤æ¶ˆæ¯ ***
                        json.ç§èŠ[str] = QQ_FilterUserMessages(json.ç§èŠ[str]);
                        
                        // *** é˜¶æ®µä¸€ï¼šæ”¶é›†æ–°æ¶ˆæ¯ç”¨äºæµå¼æ˜¾ç¤º ***
                        const newMessages = [];
                        const existingMessages = [];
                        
                        for (let msg of json.ç§èŠ[str]) {
                            // *** æ–°å¢ï¼šæ¸…ç†ç§èŠæ¶ˆæ¯å†…å®¹ ***
                            const parts = msg.split("--");
                            if (parts.length >= 2) {
                                parts[1] = QQ_CleanNestedTags(parts[1]);
                                msg = parts.join("--");
                                
                                // *** å¢å¼ºçš„åˆ†äº«æ„å›¾æ£€æµ‹ ***
                                const shareCheck = QQ_DetectPrivateChatSharingIntent(parts[1]);
                                if (shareCheck.hasShareIntent) {
                                    console.log(`ğŸ”’ æ£€æµ‹åˆ°ç§èŠåˆ†äº«æ„å›¾: "${parts[1]}" - å…³é”®è¯: ${shareCheck.detectedKeywords.join(', ')}`);
                                    console.log(`ğŸ“¤ è¿™è¡¨æ˜è§’è‰² ${parts[0]} ä¸»åŠ¨è¦å°†ç§èŠå†…å®¹åˆ†äº«åˆ°å…¶ä»–å¹³å°`);
                                    
                                    // è®°å½•åˆ†äº«æ„å›¾ä½†ä¸é˜»æ­¢ï¼ˆè¿™æ˜¯è§’è‰²çš„ä¸»åŠ¨è¡Œä¸ºï¼‰
                                    if (window.QQ_PrivateChatSharingLog) {
                                        window.QQ_PrivateChatSharingLog.push({
                                            timestamp: new Date().toISOString(),
                                            chatParticipants: [UserName, name],
                                            sharingCharacter: parts[0],
                                            message: parts[1],
                                            detectedKeywords: shareCheck.detectedKeywords
                                        });
                                    } else {
                                        window.QQ_PrivateChatSharingLog = [{
                                            timestamp: new Date().toISOString(),
                                            chatParticipants: [UserName, name],
                                            sharingCharacter: parts[0],
                                            message: parts[1],
                                            detectedKeywords: shareCheck.detectedKeywords
                                        }];
                                    }
                                }
                            }
                            
                            // *** ä¿®æ”¹ï¼šä½¿ç”¨é€»è¾‘åºåˆ—å·æ›¿ä»£æ—¶é—´æ’åº ***
                            const sequenceInfo = QQ_ExtractOrGenerateSequenceId(msg, false);
                            const cleanMsg = sequenceInfo.cleanMessage;
                            let sequenceId = sequenceInfo.sequenceId;
                            
                            // æ£€æŸ¥æ˜¯å¦ä¸ºæ–°æ¶ˆæ¯ï¼ˆæ£€æŸ¥æ¸…ç†åçš„æ¶ˆæ¯ï¼‰
                            const isNewMsg = !QQ_msgjson.ç§èŠ[str].some(existingMsg => {
                                const existingClean = QQ_ExtractOrGenerateSequenceId(existingMsg, false).cleanMessage;
                                return existingClean === cleanMsg;
                            });
                            
                            // *** ä¿®å¤ï¼šä¸ºä¼šè¯å¼€å§‹åçš„æ‰€æœ‰æ–°æ¶ˆæ¯åˆ†é…åºåˆ—å· ***
                            if (sequenceId === 0 && isNewMsg && QQ_SessionStarted) {
                                sequenceId = QQ_GetNextMessageId(); // ä¸ºå½“å‰ä¼šè¯çš„æ‰€æœ‰æ–°æ¶ˆæ¯åˆ†é…åºåˆ—å·
                                console.log(`ğŸ¯ ç§èŠæ¶ˆæ¯åˆ†é…åºåˆ—å· [${sequenceId}]: ${cleanMsg.substring(0, 30)}...`);
                            }
                            
                            if (isNewMsg) {
                                // æ‰€æœ‰æ–°æ¶ˆæ¯éƒ½æ·»åŠ åºåˆ—å·
                                const msgToStore = sequenceId > 0 
                                    ? QQ_AddSequenceIdToMessage(cleanMsg, sequenceId)
                                    : cleanMsg;
                                    
                                newMessages.push(cleanMsg); // æµå¼æ˜¾ç¤ºä½¿ç”¨æ¸…ç†åçš„æ¶ˆæ¯
                                NewMsgCount++;
                                QQ_msgjson.ç§èŠ[str].push(msgToStore);
                                
                                // ä¸å†éœ€è¦ä¿æŠ¤åˆ—è¡¨ï¼Œå› ä¸ºæœ‰åºåˆ—å·çš„æ¶ˆæ¯è‡ªç„¶ä¼šè¢«ä¿ç•™
                                console.log(`â• ç§èŠæ–°æ¶ˆæ¯ [seq:${sequenceId}]: ${cleanMsg.substring(0, 50)}...`);
                            } else {
                                existingMessages.push(cleanMsg);
                                console.log(`ğŸ”„ ç§èŠå·²å­˜åœ¨æ¶ˆæ¯: ${cleanMsg.substring(0, 50)}...`);
                            }
                            let sp = msg.split("--");
                            if (sp.length >= 2) {
                                if (sp[0] == `${UserName}`) {
                                    User_LastMsgMap.ç§èŠ[name] =
                                        `${sp[0]}--${sp[1]}`;
                                } else if (sp[0] == name) {
                                    if (sp.length >= 3) {
                                        Char_LastMsgMap.ç§èŠ[name] =
                                            `${sp[0]}--${sp[1]}--${sp[2]}`;
                                    } else {
                                        Char_LastMsgMap.ç§èŠ[name] =
                                            `${sp[0]}--${sp[1]}`;
                                    }
                                }
                            }
                            if (sp.length >= 3) {
                                LastTime = sp[2];
                            }
                            LastMsg = sp[1];
                        }
                        
                        // *** é˜¶æ®µä¸€ï¼šä½¿ç”¨æµå¼æ˜¾ç¤ºå¤„ç†æ–°æ¶ˆæ¯ ***
                        if (newMessages.length > 0) {
                            console.log(`ğŸŒŠ ç§èŠ${name}æ£€æµ‹åˆ°${newMessages.length}æ¡æ–°æ¶ˆæ¯ï¼Œå¯åŠ¨æµå¼æ˜¾ç¤º`);
                            console.log(`ğŸ“‹ æ–°æ¶ˆæ¯åˆ—è¡¨:`, newMessages.map(msg => msg.substring(0, 30) + '...'));
                            
                            // å…ˆæ˜¾ç¤ºå·²æœ‰æ¶ˆæ¯ï¼ˆç«‹å³æ˜¾ç¤ºï¼Œæ— å»¶è¿Ÿï¼‰
                            for (let msg of existingMessages) {
                                await QQ_Chat_AddMsg($msgContent[0], msg, name, false, true); // è·³è¿‡æ»šåŠ¨å’Œè®¡æ•°
                            }
                            
                            // åœ¨æ–°æ¶ˆæ¯å¼€å§‹å‰æ·»åŠ æ—¶é—´åˆ†éš”çº¿ï¼ˆä»…å½“æœ‰æ—§æ¶ˆæ¯æ—¶ï¼‰
                            if (existingMessages.length > 0) {
                                QQ_AddTimeDividerMessage($msgContent[0], name);
                            }
                            
                            // ä½¿ç”¨é˜Ÿåˆ—æœºåˆ¶æµå¼æ˜¾ç¤ºæ–°æ¶ˆæ¯ï¼Œé¿å…ä¸å…¶ä»–æµå¼ä¼ è¾“å†²çª
                            QQ_EnqueueStreamingTask({
                                handler: QQ_DisplayStreamingMessagesDirectly,
                                args: [$msgContent[0], newMessages, name, true, false],
                                description: `ç§èŠ${name}æµå¼æ˜¾ç¤º${newMessages.length}æ¡æ¶ˆæ¯`,
                                priority: QQ_IsGenerating(name) ? 'high' : 'normal', // AIå›å¤æ—¶ä¸ºé«˜ä¼˜å…ˆçº§
                                chatName: name // æ·»åŠ èŠå¤©åç§°ï¼Œæ”¯æŒå¹¶è¡Œå¤„ç†
                            });
                        } else {
                            // æ²¡æœ‰æ–°æ¶ˆæ¯ï¼Œæ­£å¸¸æ˜¾ç¤ºæ‰€æœ‰æ¶ˆæ¯
                            for (let msg of json.ç§èŠ[str]) {
                                const isNewMsg = !QQ_msgjson.ç§èŠ[str].includes(msg);
                                await QQ_Chat_AddMsg($msgContent[0], msg, name, isNewMsg);
                            }
                            
                            // å¦‚æœæ˜¯é¦–æ¬¡åŠ è½½ä¸”æœ‰æ¶ˆæ¯ï¼Œåœ¨æœ€åæ·»åŠ æ—¶é—´åˆ†éš”çº¿
                            if (json.ç§èŠ[str] && json.ç§èŠ[str].length > 0) {
                                // æ€»æ˜¯åœ¨æ¶ˆæ¯æœ«å°¾æ·»åŠ æ—¶é—´åˆ†éš”çº¿ï¼Œæ ‡è®°å½“å‰ä¼šè¯å¼€å§‹
                                QQ_AddTimeDividerMessage($msgContent[0], name);
                            }
                        }
                        
                        // *** æ–°çš„æœªè¯»æ¶ˆæ¯è®¡ç®—é€»è¾‘ï¼šä¼˜å…ˆä½¿ç”¨ä¸»åŠ¨æ¶ˆæ¯è®¡æ•° ***
                        // å¦‚æœæœ‰ä¸»åŠ¨æ¶ˆæ¯è®¡æ•°ï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™è®¡ç®—æ–°æ¶ˆæ¯æ•°é‡
                        const proactiveCount = proactiveMessageUnreadCounts.get(name) || 0;
                        if (proactiveCount > 0) {
                            NewMsgCount = proactiveCount;
                            console.log(`ç§èŠ ${name} ä½¿ç”¨ä¸»åŠ¨æ¶ˆæ¯è®¡æ•°: ${NewMsgCount}`);
                        } else {
                            // åªè®¡ç®—æœ¬æ¬¡æ–°å¢çš„æ¶ˆæ¯æ•°é‡
                            NewMsgCount = newMessages.length;
                            console.log(`ç§èŠ ${name} æ–°æ¶ˆæ¯æ•°é‡: ${NewMsgCount}`);
                        }
                        
                        // å¦‚æœèŠå¤©çª—å£æ‰“å¼€ï¼Œæ¸…é™¤æœªè¯»è®¡æ•°
                        if (
                            $(`.QQ_chat_page[data-name='${name}']`).css(
                                "display",
                            ) != "none" &&
                            !Creat
                        ) {
                            console.log(`displayä¸ä¸ºnone,çº¢ç‚¹ä¸º0  ${name}`);
                            NewMsgCount = 0;
                            QQ_ClearUnreadCount(name);
                        }
                        $(
                            `.QQ_home_usermsg[data-name='${name}'] .QQ_home_lastmsg`,
                        ).text(LastMsg);
                        $(
                            `.QQ_home_usermsg[data-name='${name}'] .QQ_home_lasttime`,
                        ).text(LastTime);
                        QQ_SetHomeTips(name, NewMsgCount);
                        $msgContent.scrollTop($msgContent[0].scrollHeight);
                        
                        // *** æ–°å¢ï¼šæ›´æ–°åˆ†é¡µæŒ‰é’® ***
                        if (NewMsgCount > 0) {
                            QQ_Update_Chat_LoadMore(name, $msgContent[0]);
                        }
                        
                        // æœ‰æ–°æ¶ˆæ¯æ—¶æ›´æ–°æ¶ˆæ¯åˆ—è¡¨
                        QQ_UpdateMessageList();
                    } catch (error) {
                        throw error;
                        assertIsError(error);
                        //QQ_Error(error.message);
                    }
                }
                for (let name in json.ç¾¤èŠ) {
                    try {
                        // *** æ–°å¢ï¼šæ¸…ç†ç¾¤èŠæ¶ˆæ¯å†…å®¹ ***
                        if (json.ç¾¤èŠ[name]["msgs"]) {
                            json.ç¾¤èŠ[name]["msgs"] = json.ç¾¤èŠ[name]["msgs"].map(msg => {
                                const parts = msg.split("--");
                                if (parts.length >= 2) {
                                    // æ¸…ç†æ¶ˆæ¯å†…å®¹éƒ¨åˆ†ï¼ˆç¬¬äºŒéƒ¨åˆ†ï¼‰
                                    parts[1] = QQ_CleanNestedTags(parts[1]);
                                    return parts.join("--");
                                }
                                return msg;
                            });
                        }
                        
                        if (!QQ_msgjson.ç¾¤èŠ[name]) {
                            QQ_msgjson.ç¾¤èŠ[name] = {};
                            QQ_msgjson.ç¾¤èŠ[name]["members"] =
                                json.ç¾¤èŠ[name]["members"];
                            QQ_msgjson.ç¾¤èŠ[name]["msgs"] = [];
                        }
                        // æ£€æŸ¥æ˜¯å¦æ˜¯å·²å­˜åœ¨çš„ç¾¤èŠ
                        let existingGroupElement = $(`.QQ_home_usermsg[data-name='${name}']`);
                        let isExistingGroup = false;
                        
                        // *** ä¿®å¤ï¼šä½¿ç”¨ç¼“å­˜çš„ç¾¤èŠå…ƒæ•°æ®æ£€æŸ¥ç¾¤èŠ ***
                        const storedGroups = window.QQ_Group_Chats_Data || [];
                        const storedGroup = storedGroups.find(g => g.name === name);
                        
                        if (existingGroupElement.length > 0) {
                            // ç¾¤èŠå…ƒç´ å·²å­˜åœ¨
                            isExistingGroup = true;
                            console.log(`ç¾¤èŠ ${name} å·²å­˜åœ¨ï¼Œä½¿ç”¨ç°æœ‰ç¾¤èŠ`);
                        } else if (storedGroup) {
                            // ç¾¤èŠåœ¨å­˜å‚¨ä¸­å­˜åœ¨ï¼Œä½†ç•Œé¢å…ƒç´ ä¸å­˜åœ¨ï¼Œé‡æ–°åˆ›å»º
                            console.log(`ç¾¤èŠ ${name} åœ¨å­˜å‚¨ä¸­å­˜åœ¨ï¼Œé‡æ–°åˆ›å»ºç•Œé¢å…ƒç´ `);
                            AddNewGroup(storedGroup.name, storedGroup.avatar || QQ_GetRandomAvatar() || 'https://files.catbox.moe/skngqq.jpg', storedGroup.members, storedGroup.description);
                            isExistingGroup = true;
                        } else {
                            // è¿™æ˜¯ä¸€ä¸ªå…¨æ–°çš„ç¾¤èŠï¼Œéœ€è¦æ™ºèƒ½å¤„ç†
                            console.log(`æ£€æµ‹åˆ°æ–°ç¾¤èŠ: ${name}ï¼Œå¼€å§‹æ™ºèƒ½è·¯ç”±å¤„ç†`);
                            
                            let redirected = false;
                            
                            // æ™ºèƒ½æ¶ˆæ¯è·¯ç”±ï¼šæ£€æŸ¥æ¶ˆæ¯ä¸­æ˜¯å¦åŒ…å«ç”¨æˆ·å‘é€çš„å†…å®¹
                            const hasUserMessage = json.ç¾¤èŠ[name]["msgs"].some(msg => {
                                const parts = msg.split("--");
                                return parts.length >= 2 && parts[0] === `${UserName}`;
                            });
                            
                            // å¦‚æœåŒ…å«ç”¨æˆ·æ¶ˆæ¯ï¼Œè¯´æ˜è¿™æ˜¯ç”¨æˆ·å‘èµ·çš„å¯¹è¯ï¼Œéœ€è¦æ‰¾åˆ°æ­£ç¡®çš„ç›®æ ‡ç¾¤èŠ
                            if (hasUserMessage) {
                                console.log(`æ£€æµ‹åˆ°ç”¨æˆ·åœ¨ç¾¤èŠ ${name} ä¸­å‘é€äº†æ¶ˆæ¯ï¼Œå¼€å§‹æ™ºèƒ½è·¯ç”±`);
                                
                                // æ£€æŸ¥ç”¨æˆ·æœ€åå‘é€æ¶ˆæ¯çš„ç¾¤èŠ
                                let targetGroupName = null;
                                
                                // æ–¹æ³•1ï¼šæ£€æŸ¥User_LastMsgMapä¸­æœ€è¿‘çš„ç¾¤èŠæ¶ˆæ¯
                                if (User_LastMsgMap.ç¾¤èŠ) {
                                    const recentGroupChats = Object.keys(User_LastMsgMap.ç¾¤èŠ);
                                    if (recentGroupChats.length > 0) {
                                        // æ‰¾åˆ°æœ€è¿‘å‘é€æ¶ˆæ¯çš„ç¾¤èŠ
                                        targetGroupName = recentGroupChats[recentGroupChats.length - 1];
                                        console.log(`ä»User_LastMsgMapæ‰¾åˆ°ç›®æ ‡ç¾¤èŠ: ${targetGroupName}`);
                                    }
                                }
                                
                                // æ–¹æ³•2ï¼šæ£€æŸ¥å½“å‰å¯è§çš„ç¾¤èŠé¡µé¢
                                if (!targetGroupName) {
                                    const currentChatPage = $('.QQ_chat_page:visible, .group-chat-page:visible');
                                    if (currentChatPage.length > 0) {
                                        const currentChatName = currentChatPage.attr('data-name');
                                        const currentGroupId = currentChatPage.attr('data-group-id');
                                        
                                        if (currentGroupId) {
                                            // *** ä¿®å¤ï¼šä½¿ç”¨ç¼“å­˜çš„ç¾¤èŠå…ƒæ•°æ® ***
                                            const groups = window.QQ_Group_Chats_Data || [];
                                            const currentGroup = groups.find(g => g.id === currentGroupId);
                                            if (currentGroup) {
                                                targetGroupName = currentGroup.name;
                                                console.log(`ä»å¯è§ç¾¤èŠé¡µé¢æ‰¾åˆ°ç›®æ ‡ç¾¤èŠ: ${targetGroupName}`);
                                            }
                                        } else if (QQ_Groups.includes(currentChatName)) {
                                            targetGroupName = currentChatName;
                                            console.log(`ä»å¯è§èŠå¤©é¡µé¢æ‰¾åˆ°ç›®æ ‡ç¾¤èŠ: ${targetGroupName}`);
                                        }
                                    }
                                }
                                
                                // æ–¹æ³•3ï¼šæ£€æŸ¥window.currentGroupChat
                                if (!targetGroupName && window.currentGroupChat) {
                                    targetGroupName = window.currentGroupChat.name;
                                    console.log(`ä»window.currentGroupChatæ‰¾åˆ°ç›®æ ‡ç¾¤èŠ: ${targetGroupName}`);
                                }
                                
                                // å¦‚æœæ‰¾åˆ°äº†ç›®æ ‡ç¾¤èŠä¸”ä¸AIå›å¤çš„ç¾¤èŠä¸åŒï¼Œè¿›è¡Œé‡å®šå‘
                                if (targetGroupName && targetGroupName !== name) {
                                    console.log(`æ¶ˆæ¯è·¯ç”±é‡å®šå‘: ${name} -> ${targetGroupName}`);
                                    const originalName = name;
                                    name = targetGroupName;
                                    json.ç¾¤èŠ[name] = json.ç¾¤èŠ[originalName];
                                    delete json.ç¾¤èŠ[originalName];
                                    isExistingGroup = true;
                                    redirected = true;
                                } else if (targetGroupName === name) {
                                    // ç¾¤èŠåç§°åŒ¹é…ï¼Œç›´æ¥ä½¿ç”¨
                                    console.log(`ç¾¤èŠåç§°åŒ¹é…ï¼Œç›´æ¥ä½¿ç”¨: ${name}`);
                                    isExistingGroup = true;
                                    redirected = true;
                                } else {
                                    console.log(`æ— æ³•ç¡®å®šç›®æ ‡ç¾¤èŠï¼Œè·³è¿‡å¤„ç†é¿å…åˆ›å»ºé”™è¯¯ç¾¤èŠ`);
                                    toastr.warning(`æ— æ³•ç¡®å®šæ¶ˆæ¯å‘é€çš„ç›®æ ‡ç¾¤èŠï¼Œè¯·é‡æ–°å‘é€`, 'æ¶ˆæ¯å‘é€å¤±è´¥');
                                    continue;
                                }
                            } else {
                                // æ²¡æœ‰ç”¨æˆ·æ¶ˆæ¯ï¼Œå¯èƒ½æ˜¯AIä¸»åŠ¨åˆ›å»ºçš„ç¾¤èŠ
                                console.log(`AIåˆ›å»ºæ–°ç¾¤èŠ: ${name}ï¼Œæ£€æŸ¥æ˜¯å¦åº”è¯¥é‡å®šå‘åˆ°å½“å‰ç¾¤èŠ`);
                                
                                // æ£€æŸ¥å½“å‰æ´»è·ƒçš„ç¾¤èŠ
                                if (window.currentGroupChat) {
                                    console.log(`ç”¨æˆ·å½“å‰åœ¨ç¾¤èŠ ${window.currentGroupChat.name} ä¸­ï¼Œå°†AIæ¶ˆæ¯é‡å®šå‘åˆ°æ­¤ç¾¤èŠ`);
                                    const originalName = name;
                                    name = window.currentGroupChat.name;
                                    json.ç¾¤èŠ[name] = json.ç¾¤èŠ[originalName];
                                    delete json.ç¾¤èŠ[originalName];
                                    isExistingGroup = true;
                                    redirected = true;
                                } else {
                                    // æ£€æŸ¥å¯è§çš„èŠå¤©é¡µé¢
                                    const currentChatPage = $('.QQ_chat_page:visible, .group-chat-page:visible');
                                    if (currentChatPage.length > 0) {
                                        const currentChatName = currentChatPage.attr('data-name');
                                        const currentGroupId = currentChatPage.attr('data-group-id');
                                        
                                        // å¦‚æœæ˜¯ç¾¤èŠé¡µé¢
                                        if (currentGroupId || QQ_Groups.includes(currentChatName)) {
                                            console.log(`ç”¨æˆ·å½“å‰åœ¨ç¾¤èŠé¡µé¢ ${currentChatName} ä¸­ï¼Œå°†AIæ¶ˆæ¯é‡å®šå‘åˆ°æ­¤ç¾¤èŠ`);
                                            const originalName = name;
                                            name = currentChatName;
                                            json.ç¾¤èŠ[name] = json.ç¾¤èŠ[originalName];
                                            delete json.ç¾¤èŠ[originalName];
                                            isExistingGroup = true;
                                            redirected = true;
                                        }
                                    }
                                }
                            }
                            
                            // å¦‚æœæ²¡æœ‰æˆåŠŸé‡å®šå‘ï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªæ–°çš„AIåˆ›å»ºçš„ç¾¤èŠ
                            if (!redirected) {
                                console.log(`AIåˆ›å»ºæ–°ç¾¤èŠ: ${name}ï¼Œå‚è€ƒç§èŠé€»è¾‘è¿›è¡Œå¤„ç†`);
                                
                                // åˆ›å»ºç¾¤èŠæ•°æ®ç»“æ„
                                const newGroupData = {
                                    id: `group_${Date.now()}`,
                                    name: name,
                                    members: json.ç¾¤èŠ[name]["members"] || [],
                                    avatar: {
                                        type: 'preset',
                                        gradient: {
                                            start: '#199AFF',
                                            end: '#0066CC'
                                        },
                                        text: 'ç¾¤'
                                    },
                                    lastMessage: 'ç¾¤èŠå·²åˆ›å»º',
                                    lastTime: new Date().toLocaleTimeString('zh-CN', { hour12: false }).slice(0, 5),
                                    timestamp: new Date().toLocaleTimeString('zh-CN', { hour12: false }).slice(0, 5)
                                };
                                
                                // è°ƒç”¨AddNewGroupå‡½æ•°ï¼ˆç±»ä¼¼AddNewCharï¼‰
                                AddNewGroup(newGroupData.name, newGroupData.avatar, newGroupData.members, newGroupData.lastMessage);
                                
                                // *** æ–°å¢ï¼šå°†AIåˆ›å»ºçš„æ–°ç¾¤èŠä¿å­˜åˆ°ä¸–ç•Œä¹¦ ***
                                try {
                                    console.log(`ä¿å­˜AIåˆ›å»ºçš„æ–°ç¾¤èŠåˆ°ä¸–ç•Œä¹¦: ${newGroupData.name}`);
                                    await saveGroupToWorldbook(newGroupData);
                                    console.log(`AIåˆ›å»ºçš„ç¾¤èŠ ${newGroupData.name} å·²æˆåŠŸä¿å­˜åˆ°ä¸–ç•Œä¹¦`);
                                    toastr.success(`æ–°ç¾¤èŠ "${newGroupData.name}" å·²åˆ›å»ºå¹¶ä¿å­˜`, 'ç¾¤èŠåˆ›å»ºæˆåŠŸ');
                                } catch (error) {
                                    console.error('ä¿å­˜AIåˆ›å»ºçš„ç¾¤èŠåˆ°ä¸–ç•Œä¹¦å¤±è´¥:', error);
                                    toastr.warning(`ç¾¤èŠ "${newGroupData.name}" å·²åˆ›å»ºï¼Œä½†ä¿å­˜åˆ°ä¸–ç•Œä¹¦å¤±è´¥`, 'éƒ¨åˆ†æˆåŠŸ');
                                }
                                
                                isExistingGroup = true;
                            }
                        }
                        
                        // åªæœ‰ç¡®è®¤æ˜¯ç°æœ‰ç¾¤èŠæ—¶æ‰ç»§ç»­å¤„ç†
                        if (!isExistingGroup) {
                            continue;
                        }
                        if (!QQ_Groups.includes(name)) {
                            QQ_Groups.push(name);
                        }
                        // ä¼˜å…ˆæŸ¥æ‰¾ç¾¤èŠä¸“ç”¨é¡µé¢ï¼Œç„¶åæŸ¥æ‰¾æ™®é€šèŠå¤©é¡µé¢
                        let $page = $(`.QQ_chat_page[data-group-id], .QQ_chat_page[data-name='${name}']`).filter(function() {
                            return $(this).attr('data-name') === name || 
                                   ($(this).attr('data-group-id') && window.currentGroupChat && window.currentGroupChat.name === name);
                        });
                        
                        let Creat = false;
                        if ($page.length === 0) {
                            Creat = true;
                            console.log(`${name}çš„èŠå¤©é¡µä¸å­˜åœ¨,å¼€å§‹åˆ›å»º`);
                            
                            // å¦‚æœæ˜¯ç¾¤èŠä¸”æœ‰currentGroupChatï¼Œä½¿ç”¨ç¾¤èŠä¸“ç”¨é¡µé¢
                            if (window.currentGroupChat && window.currentGroupChat.name === name) {
                                $page = ensureGroupChatPage(window.currentGroupChat);
                            } else {
                            $page = $(await QQ_CreatChatPage(name));
                            $QQpage.append($page);
                            }
                        }
                        let $msgContent = $page.find(".msgcontent");
                        if (json.ç¾¤èŠ[name]["msgs"].length == 0) {
                            console.log(`æ•°ç»„ç©º,è·³å‡º`);
                            continue;
                        }
                        let NewMsgCount = 0;
                        let LastTime = "";
                        let LastMsg = "";
                        
                        // *** æ–°å¢ï¼šè¿‡æ»¤ç”¨æˆ·é‡å¤æ¶ˆæ¯ ***
                        json.ç¾¤èŠ[name]["msgs"] = QQ_FilterUserMessages(json.ç¾¤èŠ[name]["msgs"]);
                        
                        // *** é˜¶æ®µä¸€ï¼šæ”¶é›†æ–°æ¶ˆæ¯ç”¨äºæµå¼æ˜¾ç¤º ***
                        const newMessages = [];
                        const existingMessages = [];
                        
                        for (let msg of json.ç¾¤èŠ[name]["msgs"]) {
                            // *** ä¿®æ”¹ï¼šä½¿ç”¨é€»è¾‘åºåˆ—å·æ›¿ä»£æ—¶é—´æ’åº ***
                            const sequenceInfo = QQ_ExtractOrGenerateSequenceId(msg, false);
                            const cleanMsg = sequenceInfo.cleanMessage;
                            let sequenceId = sequenceInfo.sequenceId;
                            
                            // æ£€æŸ¥æ˜¯å¦ä¸ºæ–°æ¶ˆæ¯ï¼ˆæ£€æŸ¥æ¸…ç†åçš„æ¶ˆæ¯ï¼‰
                            const isNewMsg = !QQ_msgjson.ç¾¤èŠ[name]["msgs"].some(existingMsg => {
                                const existingClean = QQ_ExtractOrGenerateSequenceId(existingMsg, false).cleanMessage;
                                return existingClean === cleanMsg;
                            });
                            
                            // *** ä¿®å¤ï¼šä¸ºä¼šè¯å¼€å§‹åçš„æ‰€æœ‰æ–°æ¶ˆæ¯åˆ†é…åºåˆ—å· ***
                            if (sequenceId === 0 && isNewMsg && QQ_SessionStarted) {
                                sequenceId = QQ_GetNextMessageId(); // ä¸ºå½“å‰ä¼šè¯çš„æ‰€æœ‰æ–°æ¶ˆæ¯åˆ†é…åºåˆ—å·
                                console.log(`ğŸ¯ ç¾¤èŠæ¶ˆæ¯åˆ†é…åºåˆ—å· [${sequenceId}]: ${cleanMsg.substring(0, 30)}...`);
                            }
                            
                            if (isNewMsg) {
                                // æ‰€æœ‰æ–°æ¶ˆæ¯éƒ½æ·»åŠ åºåˆ—å·
                                const msgToStore = sequenceId > 0 
                                    ? QQ_AddSequenceIdToMessage(cleanMsg, sequenceId)
                                    : cleanMsg;
                                    
                                newMessages.push(cleanMsg); // æµå¼æ˜¾ç¤ºä½¿ç”¨æ¸…ç†åçš„æ¶ˆæ¯
                                NewMsgCount++;
                                QQ_msgjson.ç¾¤èŠ[name]["msgs"].push(msgToStore);
                                
                                // ä¸å†éœ€è¦ä¿æŠ¤åˆ—è¡¨ï¼Œå› ä¸ºæœ‰åºåˆ—å·çš„æ¶ˆæ¯è‡ªç„¶ä¼šè¢«ä¿ç•™
                                console.log(`â• ç¾¤èŠ[${name}]æ–°æ¶ˆæ¯ [seq:${sequenceId}]: ${cleanMsg.substring(0, 50)}...`);
                            } else {
                                existingMessages.push(cleanMsg);
                                console.log(`ğŸ”„ ç¾¤èŠ[${name}]å·²å­˜åœ¨æ¶ˆæ¯: ${cleanMsg.substring(0, 50)}...`);
                            }
                            console.log(`åœ¨ç¾¤èŠ:${name}ä¸­æ·»åŠ æ¶ˆæ¯:${msg} (æ–°æ¶ˆæ¯: ${isNewMsg})`);
                            
                            // *** ä¿®å¤ï¼šä½¿ç”¨ç¼“å­˜çš„ç¾¤èŠå…ƒæ•°æ®ä¿å­˜æ¶ˆæ¯ ***
                            const groupsForMessage = window.QQ_Group_Chats_Data || [];
                            const currentGroup = groupsForMessage.find(g => g.name === name);
                            if (currentGroup) {
                                const sp = msg.split("--");
                                if (sp.length >= 2) {
                                    const messageObj = {
                                        sender: sp[0],
                                        content: sp[1],
                                        timestamp: sp.length >= 3 ? sp[2] : new Date().toLocaleTimeString('zh-CN', { hour12: false })
                                    };
                                    saveGroupMessage(currentGroup.id, messageObj);
                                    
                                    // æ›´æ–°ç¾¤èŠçš„æœ€åæ¶ˆæ¯
                                    await updateGroupLastMessage(currentGroup.id, sp[1]);
                                }
                            }
                            
                            let sp = msg.split("--");
                            if (sp.length >= 2) {
                                if (sp[0] == `${UserName}`) {
                                    User_LastMsgMap.ç¾¤èŠ[name] =
                                        `${sp[0]}--${sp[1]}`;
                                } else {
                                    if (sp.length >= 3) {
                                        Char_LastMsgMap.ç¾¤èŠ[name] =
                                            `${sp[0]}--${sp[1]}--${sp[2]}`;
                                    } else {
                                        Char_LastMsgMap.ç¾¤èŠ[name] =
                                            `${sp[0]}--${sp[1]}`;
                                    }
                                }
                            }
                            if (sp.length >= 3) {
                                LastTime = sp[2];
                            }
                            LastMsg = `${sp[0]}:${sp[1]}`;
                        }
                        
                        // *** é˜¶æ®µä¸€ï¼šä½¿ç”¨æµå¼æ˜¾ç¤ºå¤„ç†æ–°æ¶ˆæ¯ ***
                        if (newMessages.length > 0) {
                            console.log(`ğŸŒŠ ç¾¤èŠ${name}æ£€æµ‹åˆ°${newMessages.length}æ¡æ–°æ¶ˆæ¯ï¼Œå¯åŠ¨æµå¼æ˜¾ç¤º`);
                            
                            // å…ˆæ˜¾ç¤ºå·²æœ‰æ¶ˆæ¯ï¼ˆç«‹å³æ˜¾ç¤ºï¼Œæ— å»¶è¿Ÿï¼‰
                            for (let msg of existingMessages) {
                                await QQ_Chat_AddMsg($msgContent[0], msg, name, false, true); // è·³è¿‡æ»šåŠ¨å’Œè®¡æ•°
                            }
                            
                            // åœ¨æ–°æ¶ˆæ¯å¼€å§‹å‰æ·»åŠ æ—¶é—´åˆ†éš”çº¿ï¼ˆä»…å½“æœ‰æ—§æ¶ˆæ¯æ—¶ï¼‰
                            if (existingMessages.length > 0) {
                                QQ_AddTimeDividerMessage($msgContent[0], name);
                            }
                            
                            // ä½¿ç”¨é˜Ÿåˆ—æœºåˆ¶æµå¼æ˜¾ç¤ºæ–°æ¶ˆæ¯ï¼Œé¿å…ä¸å…¶ä»–æµå¼ä¼ è¾“å†²çª
                            QQ_EnqueueStreamingTask({
                                handler: QQ_DisplayStreamingMessagesDirectly,
                                args: [$msgContent[0], newMessages, name, true, false],
                                description: `ç¾¤èŠ${name}æµå¼æ˜¾ç¤º${newMessages.length}æ¡æ¶ˆæ¯`,
                                priority: QQ_IsGenerating(name) ? 'high' : 'normal', // AIå›å¤æ—¶ä¸ºé«˜ä¼˜å…ˆçº§
                                chatName: name // æ·»åŠ èŠå¤©åç§°ï¼Œæ”¯æŒå¹¶è¡Œå¤„ç†
                            });
                        } else {
                            // æ²¡æœ‰æ–°æ¶ˆæ¯ï¼Œæ­£å¸¸æ˜¾ç¤ºæ‰€æœ‰æ¶ˆæ¯
                            for (let msg of json.ç¾¤èŠ[name]["msgs"]) {
                                const isNewMsg = !QQ_msgjson.ç¾¤èŠ[name]["msgs"].includes(msg);
                                await QQ_Chat_AddMsg($msgContent[0], msg, name, isNewMsg);
                            }
                            
                            // å¦‚æœæ˜¯é¦–æ¬¡åŠ è½½ä¸”æœ‰æ¶ˆæ¯ï¼Œåœ¨æœ€åæ·»åŠ æ—¶é—´åˆ†éš”çº¿
                            if (json.ç¾¤èŠ[name]["msgs"] && json.ç¾¤èŠ[name]["msgs"].length > 0) {
                                // æ€»æ˜¯åœ¨æ¶ˆæ¯æœ«å°¾æ·»åŠ æ—¶é—´åˆ†éš”çº¿ï¼Œæ ‡è®°å½“å‰ä¼šè¯å¼€å§‹
                                QQ_AddTimeDividerMessage($msgContent[0], name);
                            }
                        }
                        
                        // *** æ–°çš„æœªè¯»æ¶ˆæ¯è®¡ç®—é€»è¾‘ï¼šä½¿ç”¨QQ_CalculateUnreadCount ***
                        NewMsgCount = QQ_CalculateUnreadCount(name, QQ_msgjson.ç¾¤èŠ[name]["msgs"], 'group');
                        
                        // è®¾ç½®çº¢ç‚¹å’Œé¦–é¡µæ˜¾ç¤ºçš„æ¶ˆæ¯
                        const isCurrentlyVisible = $(`.QQ_chat_page[data-name='${name}']`).css("display") != "none" ||
                                                  $(`.QQ_chat_page[data-group-id]`).filter(function() {
                                                      return $(this).attr('data-name') === name && $(this).css('display') !== 'none';
                                                  }).length > 0;
                        
                        if (isCurrentlyVisible && !Creat) {
                            NewMsgCount = 0;
                        }
                        
                        // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                        $(`.QQ_home_usermsg[data-name='${name}'] .QQ_home_lastmsg`).text(LastMsg);
                        $(`.QQ_home_usermsg[data-name='${name}'] .QQ_home_lasttime`).text(LastTime);
                        
                        // *** ä¿®å¤ï¼šä½¿ç”¨ç¼“å­˜çš„ç¾¤èŠå…ƒæ•°æ®æ›´æ–°ä¸“ç”¨å…ƒç´  ***
                        const groupsForUpdate = window.QQ_Group_Chats_Data || [];
                        const currentGroup = groupsForUpdate.find(g => g.name === name);
                        if (currentGroup) {
                            $(`.QQ_home_usermsg[data-group-id='${currentGroup.id}'] .QQ_home_lastmsg`).text(LastMsg);
                            $(`.QQ_home_usermsg[data-group-id='${currentGroup.id}'] .QQ_home_lasttime`).text(LastTime);
                        }
                        
                        QQ_SetHomeTips(name, NewMsgCount);
                        console.log(`ç¾¤èŠçš„æœªè¯»æ¶ˆæ¯æ•°é‡:${NewMsgCount}`);
                        $msgContent.scrollTop($msgContent[0].scrollHeight);
                        
                        // *** æ–°å¢ï¼šæ›´æ–°åˆ†é¡µæŒ‰é’® ***
                        if (NewMsgCount > 0) {
                            QQ_Update_Chat_LoadMore(name, $msgContent[0]);
                        }
                        
                        let TipsCount = QQ_GetChatShowTipsCount(name);
                        const $Tips = $(`.QQ_chat_page[data-name='${name}']`).find(`.new_tips`);
                        $Tips.text(TipsCount);
                        if (TipsCount > 0) {
                            $Tips.css("display", "flex");
                        } else {
                            $Tips.hide();
                        }
                        
                        // æ³¨é‡Šæ‰å¯èƒ½å¯¼è‡´æ¶ˆæ¯æ¸…ç©ºçš„ç¾¤èŠå†å²åŠ è½½
                        // if (currentGroup && window.currentGroupChat && window.currentGroupChat.name === name) {
                        //     setTimeout(() => {
                        //         loadGroupChatHistory(currentGroup.id);
                        //     }, 100);
                        // }
                        
                        // æ›´æ–°ç¾¤èŠçš„æœ€åæ¶ˆæ¯æ˜¾ç¤º
                        updateGroupLastMessageDisplay(name);
                        
                        // ç¾¤èŠæ¶ˆæ¯æ›´æ–°æ—¶ä¹Ÿæ›´æ–°æ¶ˆæ¯åˆ—è¡¨
                        QQ_UpdateMessageList();
                    } catch (error) {
                        assertIsError(error);
                        QQ_Error(error.message);
                    }
                }
                console.log(
                    `User_LastMsgMap:\n${JSON.stringify(User_LastMsgMap)}\nChar_LastMsgMap:\n${JSON.stringify(Char_LastMsgMap)}`,
                );
                
                // æ›´æ–°çŸ­æœŸè®°å¿†ä¸–ç•Œä¹¦
                await QQ_UpdateShortTermMemory();
                
                return true;
            }
            function QQ_SetHomeTips(name, count) {
                $(
                    `.QQ_home_usermsg[data-name='${name}'] .QQ_home_usermsg_new`,
                ).text(count);
                if (count == 0) {
                    $(
                        `.QQ_home_usermsg[data-name='${name}'] .QQ_home_usermsg_new`,
                    ).hide();
                } else {
                    $(
                        `.QQ_home_usermsg[data-name='${name}'] .QQ_home_usermsg_new`,
                    ).show();
                }
                console.log(`è®¾ç½®${name}çš„é¦–é¡µçº¢ç‚¹:${count}`);
                QQ_NewMsg[name] = count;
            }
            function QQ_GetChatShowTipsCount(name) {
                let count = 0;
                for (const n in QQ_NewMsg) {
                    if (n != name) {
                        count += Number(QQ_NewMsg[n]);
                    }
                }
                return count;
            }
            
            // *** æ–°å¢ï¼šåŠ¨æ€è¯„è®ºç”ŸæˆçŠ¶æ€è·Ÿè¸ª ***
            let QQ_MomentGenerating = false;
            
            /**
             * *** å¢å¼ºç‰ˆåŠ¨æ€è¯„è®ºåŠŸèƒ½ ***
             * æ”¯æŒ8æ¡è¯„è®ºä¸Šé™ã€æ™ºèƒ½æŠ˜å ã€AIå›å¤å¼•å¯¼ã€é˜²é‡å¤å‘é€
             */
            async function QQ_Moment_Comment(event) {
                if (QQ_MomentGenerating) {
                    triggerSlash("/echo ç”Ÿæˆä¸­ï¼Œè¯·å‹¿é‡å¤å‘é€");
                    return;
                }
                QQ_MomentGenerating = true;

                try {
                    // 1. è·å–DOMå…ƒç´ å’Œç”¨æˆ·è¾“å…¥
                    const $closest = $(event.currentTarget).closest('.user_moment');
                    const message = $closest.find(".moment_message").text();
                    const input = $closest.find("input[type='text']");
                    const name = $closest.find(".moment_sender").text();
                    const list = $closest.find(".user_leave_message_list");
                    const value = input.val()?.trim();
                    
                    if (!value || !message) {
                        console.log('è¾“å…¥å†…å®¹ä¸ºç©ºæˆ–æ— æ³•è·å–åŠ¨æ€ä¿¡æ¯');
                        return;
                    }
                    
                    // 2. ã€é‡è¦ä¿®å¤ã€‘ç«‹å³åœ¨UIä¸Šæ˜¾ç¤ºç”¨æˆ·è‡ªå·±çš„è¯„è®º
                    const currentComments = list.find('.user_leave_message').length;
                    if (currentComments >= 8) {
                        // åˆ é™¤æœ€æ—©çš„è¯„è®ºä¸ºæ–°è¯„è®ºè…¾å‡ºç©ºé—´
                        list.find('.user_leave_message').first().remove();
                    }
                    
                    // æ·»åŠ ç”¨æˆ·è¯„è®ºåˆ°ç•Œé¢
                    let messageDiv = $("<div>", { class: "user_leave_message" });
                    messageDiv.html(
                        `<span><strong>${UserName}</strong>ï¼š${value}</span>`,
                    );
                    list.append(messageDiv);
                    input.val("");
                    
                    // å¹³æ»‘æ»šåŠ¨åˆ°æ–°è¯„è®º
                    if (list.length > 0) {
                        list.scrollTop(list[0].scrollHeight);
                    }
                    
                    // 3. ã€é‡è¦ä¿®å¤ã€‘å°†ç”¨æˆ·å›å¤æ·»åŠ åˆ°å¯¹åº”åŠ¨æ€çš„è¯„è®ºæ•°æ®ä¸­å¹¶ä¿å­˜
                    const userComment = {
                        name: UserName,
                        content: value,
                        timestamp: new Date().toISOString()
                    };
                    
                    // æŸ¥æ‰¾å¯¹åº”çš„åŠ¨æ€å¹¶æ·»åŠ è¯„è®º
                    const momentId = $closest.attr('data-moment-id');
                    const targetMoment = QQ_MomentsData.find(moment => moment.id === momentId);
                    
                    if (targetMoment) {
                        targetMoment.comments.push(userComment);
                        
                        // ä¿æŒè¯„è®ºæ•°é‡ä¸Šé™ï¼ˆ50æ¡ï¼‰
                        if (targetMoment.comments.length > 50) {
                            targetMoment.comments = targetMoment.comments.slice(-50);
                        }
                        
                        console.log('ç”¨æˆ·å›å¤å·²æ·»åŠ åˆ°åŠ¨æ€æ•°æ®:', userComment);
                        
                        // ç«‹å³ä¿å­˜æ›´æ–°åçš„åŠ¨æ€æ•°æ®
                        await QQ_Save_Moments();
                    } else {
                        console.warn('æœªæ‰¾åˆ°å¯¹åº”çš„åŠ¨æ€æ•°æ®ï¼Œæ— æ³•æ·»åŠ ç”¨æˆ·å›å¤');
                    }

                    // 4. åˆ†ææœ¬æ¬¡çš„æ‰€æœ‰ä»»åŠ¡
                    let tasks = {
                        momentComment: { author: name, content: value, momentId: momentId },
                        privateChats: [],
                        groupChats: [],
                        interactiveTask: null
                    };
                    
                    // 5. å¤„ç†ç¼“å­˜æ¶ˆæ¯å¹¶æ•´åˆåˆ°ä»»åŠ¡ä¸­
                    if (QQ_CacheSendMsg && QQ_CacheSendMsg.trim()) {
                        const cachedActions = QQ_GetValueName(QQ_CacheSendMsg);
                        if (cachedActions) {
                            for (const action of cachedActions) {
                                if (QQ_Groups.includes(action.name)) {
                                    if (!tasks.groupChats.some(g => g[action.name])) tasks.groupChats.push({ [action.name]: [] });
                                } else {
                                    if (!tasks.privateChats.includes(action.name)) tasks.privateChats.push(action.name);
                                }
                            }
                        }
                        
                        // ä¿å­˜ç¼“å­˜æ¶ˆæ¯åˆ°å¯¹åº”çš„èŠå¤©è®°å½•
                        for (const match of cachedActions || []) {
                            let localname = match.name;
                            let localmsg = match.value;
                            
                            if (QQ_Groups.includes(localname)) {
                                // ç¾¤èŠæ¶ˆæ¯ä¿å­˜
                                QQ_msgjson.ç¾¤èŠ[localname] = QQ_msgjson.ç¾¤èŠ[localname] || {};
                                QQ_msgjson.ç¾¤èŠ[localname].msgs = QQ_msgjson.ç¾¤èŠ[localname].msgs || [];
                                QQ_msgjson.ç¾¤èŠ[localname].msgs.push(`${UserName}--${localmsg}`);
                                console.log(`ç¼“å­˜ç¾¤èŠæ¶ˆæ¯å·²ä¿å­˜: ${UserName}--${localmsg}`);
                                User_LastMsgMap.ç¾¤èŠ[localname] = `${UserName}--${localmsg}`;
                                
                                // åŒæ­¥ä¿å­˜åˆ°ç¾¤èŠä¸“ç”¨å­˜å‚¨
                                const currentTime = new Date().toLocaleTimeString('zh-CN', { hour12: false });
                                const groupsForSync = await loadGroupChatsFromWorldbook();
                                const targetGroup = groupsForSync.find(g => g.name === localname);
                                if (targetGroup) {
                                    const messageObj = {
                                        sender: UserName,
                                        content: localmsg,
                                        timestamp: currentTime
                                    };
                                    saveGroupMessage(targetGroup.id, messageObj);
                                    await updateGroupLastMessage(targetGroup.id, localmsg);
                                    console.log(`ç¼“å­˜ç¾¤èŠæ¶ˆæ¯å·²åŒæ­¥ä¿å­˜åˆ°ä¸“ç”¨å­˜å‚¨: ${localname}`);
                                }
                            } else {
                                // ç§èŠæ¶ˆæ¯ä¿å­˜
                                const key = `${UserName}å’Œ${localname}çš„èŠå¤©`;
                                QQ_msgjson.ç§èŠ[key] = QQ_msgjson.ç§èŠ[key] || [];
                                QQ_msgjson.ç§èŠ[key].push(`${UserName}--${localmsg}`);
                                console.log(`ç¼“å­˜ç§èŠæ¶ˆæ¯å·²ä¿å­˜: ${UserName}--${localmsg}`);
                                User_LastMsgMap.ç§èŠ[localname] = `${UserName}--${localmsg}`;
                            }
                        }
                    }
                    
                    // 6. æ•´åˆäº’åŠ¨æ„å›¾æ£€æµ‹
                    const interactiveResult = QQ_DetectInteractiveIntent(value);
                    if (interactiveResult && interactiveResult.isInteractive) {
                        tasks.interactiveTask = interactiveResult;
                        QQ_UserTriggeredInteractive = true;
                    } else {
                        QQ_UserTriggeredInteractive = false;
                    }
                    
                    // 7. è°ƒç”¨åŠ¨æ€æŒ‡ä»¤ç”Ÿæˆå™¨
                    const finalPrompt = buildDynamicPrompt(tasks);

                    // 8. ç»„åˆæœ€ç»ˆå‘é€å†…å®¹
                    let sendvalue = (QQ_CacheSendMsg ? `${QQ_CacheSendMsg.trim()}\n\n` : '') + `ç”¨æˆ·åœ¨${name}çš„åŠ¨æ€ä¸‹è¯„è®ºï¼š${value}`;
                    const finalPayload = `${sendvalue}\n\n${QQ_GetTimeContext()}\n\n${finalPrompt}`;
                    // *** ä¿®å¤ï¼šå»¶è¿Ÿæ¸…ç©ºç¼“å­˜ï¼Œç¡®ä¿æ‰€æœ‰æ¶ˆæ¯éƒ½å·²å¤„ç† ***
                    setTimeout(() => {
                        QQ_CacheSendMsg = ""; // æ¸…ç©ºç¼“å­˜
                    }, 2000); // 2ç§’å»¶è¿Ÿæ¸…ç©ºï¼Œç»™AIå›å¤å¤„ç†æ—¶é—´

                    // 9. è®¾ç½®è¯·æ±‚ä¸Šä¸‹æ–‡å¹¶å‘é€è¯·æ±‚
                    QQ_LastRequest = finalPayload;
                    QQ_LastRequestName = name;
                    console.log('å‘é€ç»™AIçš„æœ€ç»ˆPayload:\n', finalPayload);
                    const result = await QQ_Gen(finalPayload);
                    await ResultHandle(result);
                    
                } catch (error) {
                    console.error('åŠ¨æ€è¯„è®ºAIç”Ÿæˆè¿‡ç¨‹ä¸­å‡ºé”™:', error);
                    await QQ_Force_Save_All_Data();
                } finally {
                    QQ_MomentGenerating = false;
                }
            }
            
             /**
              * *** é‡æ–°è®¾è®¡ï¼šå¤„ç†AIå›å¤çš„è¯„è®ºï¼Œæ”¯æŒæŠ˜å å’Œç§èŠ ***
              * @param {string} content - AIè¿”å›çš„å†…å®¹
              * @param {jQuery} $momentDiv - ç›®æ ‡åŠ¨æ€çš„jQueryå¯¹è±¡
              */
             async function QQ_Handle_AI_Comments(content, $momentDiv) {
                 try {
                     // æå–moment_startå’Œmoment_endä¹‹é—´çš„å†…å®¹
                     const momentMatch = content.match(/moment_start([\s\S]*?)moment_end/);
                     if (!momentMatch) {
                         console.log('æœªæ‰¾åˆ°æœ‰æ•ˆçš„momentæ ¼å¼');
                         return;
                     }
                     
                     const momentContent = momentMatch[1].trim();
                     const lines = momentContent.split(/\r?\n/g);
                     const commentsList = $momentDiv.find('.user_leave_message_list');
                     const momentId = $momentDiv.attr('data-moment-id');
                     
                     // æŸ¥æ‰¾å¯¹åº”çš„åŠ¨æ€æ•°æ®å¯¹è±¡
                     const targetMoment = QQ_MomentsData.find(moment => moment.id === momentId);
                     
                     // *** è·å–åŸåŠ¨æ€ä¿¡æ¯ç”¨äºè¿‡æ»¤é‡å¤å†…å®¹ ***
                     const originalMessage = $momentDiv.find('.moment_message').text();
                     const originalSender = $momentDiv.find('.moment_sender').text();
                     
                     // *** æ–°å¢AIè¯„è®ºåˆ°æ•°æ®ä¸­ï¼ˆä¸åˆ é™¤æ—§è¯„è®ºï¼‰ï¼ŒåŒæ—¶è¿‡æ»¤é‡å¤åŠ¨æ€å†…å®¹ ***
                     const newComments = [];
                     for (const line of lines) {
                         const trimmedLine = line.trim();
                         if (!trimmedLine) continue;
                         
                         // *** ä¸¥æ ¼æ£€æŸ¥æ˜¯å¦ä¸ºå®Œæ•´åŠ¨æ€æ ¼å¼ï¼Œé˜²æ­¢AIåˆ›å»ºæ–°åŠ¨æ€ ***
                         const fullMomentMatch = trimmedLine.match(/\s*(.+?)--(.+?)--(.+?)--(.+?)--(.+)/);
                         if (fullMomentMatch) {
                             console.log('âš ï¸ AIå°è¯•åˆ›å»ºæ–°åŠ¨æ€è€Œéè¯„è®ºï¼Œå·²é˜»æ­¢:', trimmedLine);
                             continue;
                         }
                         
                         // *** æ£€æŸ¥æ˜¯å¦åŒ…å«åŠ¨æ€ç‰¹å¾ï¼ˆæ—¶é—´æˆ³ã€æµè§ˆæ•°ã€ç‚¹èµæ•°ï¼‰ ***
                         if (trimmedLine.includes('--') && (
                             /\d{2}:\d{2}/.test(trimmedLine) || // æ—¶é—´æ ¼å¼
                             /\d+æœˆ\d+æ—¥/.test(trimmedLine) || // æ—¥æœŸæ ¼å¼
                             /--\d+--\d+/.test(trimmedLine) || // æµè§ˆæ•°--ç‚¹èµæ•°æ ¼å¼
                             trimmedLine.split('--').length >= 4 // è¶…è¿‡4ä¸ªåˆ†æ®µ
                         )) {
                             console.log('âš ï¸ AIå°è¯•åˆ›å»ºåŠ¨æ€æ ¼å¼å†…å®¹ï¼Œå·²é˜»æ­¢:', trimmedLine);
                             continue;
                         }
                         
                         // åŒ¹é…è¯„è®ºæ ¼å¼ï¼šè§’è‰²å--è¯„è®ºå†…å®¹
                         const commentMatch = trimmedLine.match(/^\s*(.+?)(?::|ï¼š|--)(.+)$/);
                         if (commentMatch) {
                             const [, name, commentContent] = commentMatch;
                             
                             // *** ä¸¥æ ¼è¿‡æ»¤é‡å¤çš„åŠ¨æ€å†…å®¹ ***
                             if (commentContent.includes(originalMessage) && commentContent.length > 20) {
                                 console.log('âš ï¸ AIé‡å¤åŸåŠ¨æ€å†…å®¹ï¼Œå·²è¿‡æ»¤:', commentContent);
                                 continue;
                             }
                             
                             // *** è¿‡æ»¤åŒ…å«å®Œæ•´åŠ¨æ€ä¿¡æ¯çš„è¯„è®º ***
                             if (commentContent.includes(originalSender) && commentContent.includes(originalMessage)) {
                                 console.log('âš ï¸ AIåœ¨è¯„è®ºä¸­å¤åˆ¶å®Œæ•´åŠ¨æ€ï¼Œå·²è¿‡æ»¤:', commentContent);
                                 continue;
                             }
                             
                             // *** è¿‡æ»¤å›¾ç‰‡æ ‡ç­¾é‡å¤ ***
                             if (commentContent.includes('[img-') && originalMessage.includes('[img-')) {
                                 const originalImageContent = originalMessage.match(/\[img-([^\]]+)\]/);
                                 const commentImageContent = commentContent.match(/\[img-([^\]]+)\]/);
                                 if (originalImageContent && commentImageContent && 
                                     originalImageContent[1] === commentImageContent[1]) {
                                     console.log('âš ï¸ AIé‡å¤åŠ¨æ€å›¾ç‰‡ï¼Œå·²è¿‡æ»¤:', commentContent);
                                     continue;
                                 }
                             }
                             
                             // *** è¿‡æ»¤è¯„è®ºé•¿åº¦è¿‡é•¿ï¼ˆå¯èƒ½æ˜¯åŠ¨æ€å†…å®¹ï¼‰ ***
                             if (commentContent.length > 200) {
                                 console.log('âš ï¸ è¯„è®ºå†…å®¹è¿‡é•¿ï¼Œå¯èƒ½æ˜¯åŠ¨æ€å†…å®¹ï¼Œå·²è¿‡æ»¤:', commentContent.substring(0, 50) + '...');
                                 continue;
                             }
                             
                             const commentData = {
                                 name: name,
                                 content: commentContent,
                                 timestamp: new Date().toISOString()
                             };
                             
                             newComments.push(commentData);
                             
                             console.log(`å‡†å¤‡æµå¼è¾“å‡ºAIè¯„è®º: ${name} - ${commentContent}`);
                         }
                     }
                     
                     // *** ä½¿ç”¨æµå¼è¾“å‡ºæ˜¾ç¤ºæ–°çš„AIè¯„è®º ***
                     if (targetMoment && newComments.length > 0) {
                         // å…ˆæ·»åŠ è¯„è®ºåˆ°æ•°æ®å¯¹è±¡
                         for (const commentData of newComments) {
                             targetMoment.comments.push(commentData);
                             
                             // *** ä¿æŒè¯„è®ºæ•°é‡ä¸Šé™ï¼ˆ50æ¡ï¼‰ ***
                             if (targetMoment.comments.length > 50) {
                                 targetMoment.comments = targetMoment.comments.slice(-50);
                             }
                         }
                         
                         // ä½¿ç”¨æµå¼è¾“å‡ºæ˜¾ç¤ºè¯„è®º
                         await QQ_StreamingDisplayComments(newComments, commentsList);
                         
                         // *** ç¡®ä¿ç«‹å³ä¿å­˜åŠ¨æ€æ•°æ® ***
                         await QQ_Save_Moments();
                         console.log('AIè¯„è®ºå·²ä¿å­˜åˆ°åŠ¨æ€å¤‡ä»½');
                     }
                     
                     // *** å¤„ç†ç§èŠæ¶ˆæ¯ï¼ˆé¿å…é‡å¤å¤„ç†ï¼‰ ***
                     const processedMessages = new Set(); // è®°å½•å·²å¤„ç†çš„æ¶ˆæ¯
                     await QQ_Handle_Private_Messages(content, processedMessages);
                     
                 } catch (error) {
                     console.error('å¤„ç†AIè¯„è®ºæ—¶å‡ºé”™:', error);
                 }
             }
             
             /**
              * *** æ–°å¢ï¼šæµå¼æ˜¾ç¤ºAIè¯„è®ºå›å¤ ***
              * @param {Array} newComments - æ–°è¯„è®ºæ•°ç»„
              * @param {jQuery} $commentsList - è¯„è®ºåˆ—è¡¨å®¹å™¨
              */
             async function QQ_StreamingDisplayComments(newComments, $commentsList) {
                 if (!newComments || newComments.length === 0) {
                     console.log('æ²¡æœ‰æ–°è¯„è®ºéœ€è¦æµå¼æ˜¾ç¤º');
                     return;
                 }
                 
                 console.log(`ğŸŒŠ å¼€å§‹æµå¼æ˜¾ç¤º ${newComments.length} æ¡AIè¯„è®º`);
                 
                 for (let i = 0; i < newComments.length; i++) {
                     const comment = newComments[i];
                     
                     // ä½¿ç”¨æœ¬ç¦ç‰¹å®šå¾‹å»¶è¿Ÿï¼ˆä¸ç¾¤èŠæ¶ˆæ¯ç›¸åŒçš„é€»è¾‘ï¼‰
                     const delay = QQ_GenerateBenfordDelay(true); // ä½¿ç”¨ç¾¤èŠå»¶è¿Ÿåˆ†å¸ƒ
                     
                     await new Promise(resolve => {
                         setTimeout(() => {
                             console.log(`â±ï¸ å»¶è¿Ÿ ${delay}ms åæ˜¾ç¤ºè¯„è®º: ${comment.name} - ${comment.content}`);
                             
                             // åˆ›å»ºè¯„è®ºå…ƒç´ 
                             const messageDiv = $("<div>", { class: "user_leave_message" });
                             messageDiv.html(`<span><strong>${comment.name}</strong>ï¼š${comment.content}</span>`);
                             
                             // ç›´æ¥æ·»åŠ åˆ°è¯„è®ºåˆ—è¡¨ï¼ˆç§»é™¤æ°”çƒåŠ¨ç”»æ•ˆæœï¼‰
                             $commentsList.append(messageDiv);
                             
                             // æ»šåŠ¨åˆ°æ–°è¯„è®º
                             $commentsList.scrollTop($commentsList[0].scrollHeight);
                             
                             resolve();
                         }, delay);
                     });
                 }
                 
                 console.log('âœ… æ‰€æœ‰AIè¯„è®ºæµå¼æ˜¾ç¤ºå®Œæˆ');
             }
             
             /**
              * *** æ–°å¢ï¼šæ¸²æŸ“è¯„è®ºåŒºåŸŸï¼Œæ”¯æŒæŠ˜å åŠŸèƒ½ ***
              * @param {Object} momentData - åŠ¨æ€æ•°æ®å¯¹è±¡
              * @param {jQuery} $commentsList - è¯„è®ºåˆ—è¡¨å®¹å™¨
              */
             function QQ_Render_Comments(momentData, $commentsList) {
                 $commentsList.empty();
                 
                 const comments = momentData.comments || [];
                 const VISIBLE_COMMENTS = 8;
                 
                 if (comments.length <= VISIBLE_COMMENTS) {
                     // è¯„è®ºæ•°é‡æœªè¶…è¿‡é™åˆ¶ï¼Œç›´æ¥æ˜¾ç¤ºæ‰€æœ‰è¯„è®º
                     for (const comment of comments) {
                         const messageDiv = $("<div>", { class: "user_leave_message" });
                         messageDiv.html(`<span><strong>${comment.name}</strong>ï¼š${comment.content}</span>`);
                         $commentsList.append(messageDiv);
                     }
                 } else {
                     // è¯„è®ºæ•°é‡è¶…è¿‡é™åˆ¶ï¼Œéœ€è¦æŠ˜å 
                     const hiddenCommentsCount = comments.length - VISIBLE_COMMENTS;
                     const visibleComments = comments.slice(-VISIBLE_COMMENTS);
                     
                     // æ·»åŠ å±•å¼€æŒ‰é’®
                     const expandButton = $("<div>", { 
                         class: "comments-expand-btn",
                         style: "text-align: center; color: #999; padding: 5px; cursor: pointer; border-bottom: 1px solid #eee;"
                     });
                     expandButton.html(`<span>å±•å¼€æŸ¥çœ‹æ›´å¤šè¯„è®º (${hiddenCommentsCount}æ¡)</span>`);
                     expandButton.on('click', function() {
                         // å±•å¼€æ‰€æœ‰è¯„è®º
                         $commentsList.empty();
                         for (const comment of comments) {
                             const messageDiv = $("<div>", { class: "user_leave_message" });
                             messageDiv.html(`<span><strong>${comment.name}</strong>ï¼š${comment.content}</span>`);
                             $commentsList.append(messageDiv);
                         }
                         
                         // æ·»åŠ æ”¶èµ·æŒ‰é’®
                         const collapseButton = $("<div>", { 
                             class: "comments-collapse-btn",
                             style: "text-align: center; color: #999; padding: 5px; cursor: pointer; border-top: 1px solid #eee;"
                         });
                         collapseButton.html(`<span>æ”¶èµ·è¯„è®º</span>`);
                         collapseButton.on('click', function() {
                             QQ_Render_Comments(momentData, $commentsList);
                         });
                         $commentsList.append(collapseButton);
                         
                         // æ»šåŠ¨åˆ°æ–°è¯„è®º
                         $commentsList.scrollTop($commentsList[0].scrollHeight);
                     });
                     
                     $commentsList.append(expandButton);
                     
                     // æ˜¾ç¤ºæœ€æ–°çš„8æ¡è¯„è®º
                     for (const comment of visibleComments) {
                         const messageDiv = $("<div>", { class: "user_leave_message" });
                         messageDiv.html(`<span><strong>${comment.name}</strong>ï¼š${comment.content}</span>`);
                         $commentsList.append(messageDiv);
                     }
                 }
                 
                 // æ»šåŠ¨åˆ°æœ€æ–°è¯„è®º
                 if ($commentsList.length > 0) {
                     $commentsList.scrollTop($commentsList[0].scrollHeight);
                 }
             }
             
             /**
              * *** ä¼˜åŒ–ï¼šå¤„ç†AIè¿”å›çš„ç§èŠæ¶ˆæ¯ï¼ˆé˜²æ­¢é‡å¤ï¼‰ ***
              * @param {string} content - AIè¿”å›çš„å®Œæ•´å†…å®¹
              * @param {Set} processedMessages - å·²å¤„ç†çš„æ¶ˆæ¯é›†åˆï¼ˆå¯é€‰ï¼‰
              */
             async function QQ_Handle_Private_Messages(content, processedMessages = new Set()) {
                 try {
                     // æŸ¥æ‰¾æ‰€æœ‰ç§èŠæ¶ˆæ¯æ ¼å¼
                     const allMsgMatches = [...content.matchAll(/msg_start([\s\S]*?)msg_end/g)];
                     
                     if (allMsgMatches.length > 0) {
                         console.log(`æ£€æµ‹åˆ° ${allMsgMatches.length} æ¡ç§èŠæ¶ˆæ¯ï¼Œå¼€å§‹å¤„ç†...`);
                         
                         for (const msgMatch of allMsgMatches) {
                             let msgContent = msgMatch[1].trim();
                             
                             // *** ä¿®å¤ï¼šæ¸…ç†AIå›å¤ä¸­çš„MiPhoneæ ‡ç­¾å’Œå…¶ä»–æ ‡ç­¾ ***
                             msgContent = QQ_CleanNestedTags(msgContent);
                             msgContent = msgContent.replace(/MiPhone_start/g, '').replace(/MiPhone_end/g, '').trim();
                             
                             // *** ä¿®å¤ï¼šæ£€æŸ¥æ¸…ç†åæ˜¯å¦æœ‰æœ‰æ•ˆå†…å®¹ ***
                             if (!msgContent || msgContent.length < 10) {
                                 console.log('âš ï¸ ç§èŠæ¶ˆæ¯å†…å®¹ä¸ºç©ºæˆ–è¿‡çŸ­ï¼Œè·³è¿‡å¤„ç†:', msgContent);
                                 continue;
                             }
                             
                             // *** ä¿®å¤ï¼šæ£€æŸ¥æ˜¯å¦åŒ…å«æœ‰æ•ˆçš„èŠå¤©æ ¼å¼æ ‡ç­¾ ***
                             const hasChatTags = msgContent.includes('ç§èŠ>') || 
                                               msgContent.includes('ç¾¤èŠ>') || 
                                               msgContent.includes('å’Œ') && msgContent.includes('çš„èŠå¤©') ||
                                               msgContent.includes('--') && /\d{2}:\d{2}/.test(msgContent);
                             
                             if (!hasChatTags) {
                                 console.log('âš ï¸ ç§èŠæ¶ˆæ¯ä¸åŒ…å«æœ‰æ•ˆèŠå¤©æ ¼å¼ï¼Œè·³è¿‡å¤„ç†:', msgContent.substring(0, 50));
                                 continue;
                             }
                             
                             // åˆ›å»ºæ¶ˆæ¯å”¯ä¸€æ ‡è¯†ï¼ˆé¿å…é‡å¤å¤„ç†ï¼‰ - å¢å¼ºç‰ˆ
                             let messageHash;
                             try {
                                 // *** æ”¹è¿›çš„å“ˆå¸Œç®—æ³•ï¼Œå‡å°‘å†²çª ***
                                 messageHash = QQ_GenerateRobustMessageHash(msgContent);
                             } catch (error) {
                                 // å¦‚æœå‡ºé”™ï¼Œä½¿ç”¨æ—¶é—´æˆ³+éšæœºæ•°ä½œä¸ºfallback
                                 console.warn('æ¶ˆæ¯å“ˆå¸Œç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨fallbackæ–¹æ³•:', error);
                                 messageHash = `fallback_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                             }
                             
                             if (processedMessages.has(messageHash)) {
                                 console.log('è·³è¿‡é‡å¤æ¶ˆæ¯:', messageHash);
                                 continue;
                             }
                             
                             processedMessages.add(messageHash);
                             console.log('å¤„ç†æ–°æ¶ˆæ¯:', messageHash, msgContent.substring(0, 50) + '...');
                             
                             // å¤„ç†ç§èŠæ¶ˆæ¯
                             await QQ_Msg_Parse(msgContent);
                         }
                         
                         // *** ç¡®ä¿ç§èŠæ¶ˆæ¯å¤„ç†åç«‹å³ä¿å­˜ ***
                         await QQ_Save_Chat_Backup(); // ä¿®å¤ï¼šç›´æ¥è°ƒç”¨å¤‡ä»½å‡½æ•°ï¼Œä¸ä¼ å…¥æ¶ˆæ¯å‚æ•°
                         console.log('ç§èŠæ¶ˆæ¯å¤„ç†å®Œæˆï¼Œå·²ä¿å­˜åˆ°å¤‡ä»½');
                     }
                 } catch (error) {
                     console.error('å¤„ç†ç§èŠæ¶ˆæ¯æ—¶å‡ºé”™:', error);
                 }
             }

             /**
              * *** æ–°å¢ï¼šå¼ºåˆ¶ä¿å­˜æ‰€æœ‰åŠ¨æ€ç›¸å…³æ•°æ® ***
              */
             async function QQ_Force_Save_All_Data() {
                 try {
                     console.log('å¼€å§‹å¼ºåˆ¶ä¿å­˜æ‰€æœ‰æ•°æ®...');
                     
                     // ä¿å­˜åŠ¨æ€æ•°æ®
                     await QQ_Save_Moments();
                     console.log('âœ“ åŠ¨æ€æ•°æ®å·²ä¿å­˜åˆ°ä¸–ç•Œä¹¦');
                     
                     // ä¿å­˜æ¶ˆæ¯æ•°æ®ï¼ˆåŒ…æ‹¬ç§èŠå’Œç¾¤èŠï¼‰
                     await QQ_Save_Chat_Backup(); // ä¿®å¤ï¼šç›´æ¥è°ƒç”¨å¤‡ä»½å‡½æ•°ï¼Œä¸ä¼ å…¥æ¶ˆæ¯å‚æ•°
                     console.log('âœ“ æ¶ˆæ¯æ•°æ®å·²ä¿å­˜åˆ°ä¸–ç•Œä¹¦');
                     
                     // *** æ–°å¢ï¼šé¢å¤–ä¿å­˜ç¾¤èŠæ¶ˆæ¯åˆ°ä¸“ç”¨å­˜å‚¨ ***
                     await QQ_Force_Save_Group_Messages();
                     
                     console.log('æ‰€æœ‰æ•°æ®ä¿å­˜å®Œæˆ');
                     
                     // æ˜¾ç¤ºä¿å­˜ç»Ÿè®¡
                     if (typeof window.QQ_Show_Moments_Stats === 'function') {
                         window.QQ_Show_Moments_Stats();
                     }
                     
                 } catch (error) {
                     console.error('å¼ºåˆ¶ä¿å­˜æ•°æ®æ—¶å‡ºé”™:', error);
                 }
             }

             /**
              * *** æ–°å¢ï¼šå¼ºåˆ¶ä¿å­˜ç¾¤èŠæ¶ˆæ¯åˆ°ä¸“ç”¨å­˜å‚¨ ***
              */
             async function QQ_Force_Save_Group_Messages() {
                 try {
                     console.log('å¼€å§‹å¼ºåˆ¶ä¿å­˜ç¾¤èŠæ¶ˆæ¯åˆ°ä¸“ç”¨å­˜å‚¨...');
                     
                     // æ£€æŸ¥QQ_msgjson.ç¾¤èŠä¸­çš„æ‰€æœ‰ç¾¤èŠ
                     if (QQ_msgjson.ç¾¤èŠ && typeof QQ_msgjson.ç¾¤èŠ === 'object') {
                         // *** ä¿®å¤ï¼šä½¿ç”¨ç¼“å­˜çš„ç¾¤èŠå…ƒæ•°æ® ***
                         const groups = window.QQ_Group_Chats_Data || [];
                         
                         for (const groupName in QQ_msgjson.ç¾¤èŠ) {
                             const groupData = QQ_msgjson.ç¾¤èŠ[groupName];
                             if (groupData && groupData.msgs && Array.isArray(groupData.msgs)) {
                                 // æ‰¾åˆ°å¯¹åº”çš„ç¾¤èŠå­˜å‚¨
                                 const targetGroup = groups.find(g => g.name === groupName);
                                 if (targetGroup) {
                                     // ä¿å­˜æœ€è¿‘çš„æ¶ˆæ¯ï¼ˆé¿å…é‡å¤ä¿å­˜ï¼‰
                                     const recentMessages = groupData.msgs.slice(-10); // åªå¤„ç†æœ€è¿‘10æ¡æ¶ˆæ¯
                                     
                                     for (const msg of recentMessages) {
                                         const parts = msg.split('--');
                                         if (parts.length >= 2) {
                                             const messageObj = {
                                                 sender: parts[0],
                                                 content: parts[1],
                                                 timestamp: parts.length >= 3 ? parts[2] : new Date().toLocaleTimeString('zh-CN', { hour12: false })
                                             };
                                             
                                             // ä½¿ç”¨ç°æœ‰çš„saveGroupMessageå‡½æ•°ï¼ˆå·²ç»æœ‰å»é‡é€»è¾‘ï¼‰
                                             saveGroupMessage(targetGroup.id, messageObj);
                                         }
                                     }
                                     
                                     // æ›´æ–°æœ€åæ¶ˆæ¯
                                     if (groupData.msgs.length > 0) {
                                         const lastMsg = groupData.msgs[groupData.msgs.length - 1];
                                         const lastMsgParts = lastMsg.split('--');
                                         if (lastMsgParts.length >= 2) {
                                             await updateGroupLastMessage(targetGroup.id, lastMsgParts[1]);
                                         }
                                     }
                                     
                                     console.log(`âœ“ ç¾¤èŠ ${groupName} çš„æ¶ˆæ¯å·²å¼ºåˆ¶ä¿å­˜åˆ°ä¸“ç”¨å­˜å‚¨`);
                                 } else {
                                     console.log(`âš  ç¾¤èŠ ${groupName} åœ¨ä¸“ç”¨å­˜å‚¨ä¸­ä¸å­˜åœ¨ï¼Œè·³è¿‡ä¿å­˜`);
                                 }
                             }
                         }
                     }
                     
                     console.log('ç¾¤èŠæ¶ˆæ¯å¼ºåˆ¶ä¿å­˜å®Œæˆ');
                     
                 } catch (error) {
                     console.error('å¼ºåˆ¶ä¿å­˜ç¾¤èŠæ¶ˆæ¯æ—¶å‡ºé”™:', error);
                 }
             }

             // *** æ–°å¢ï¼šæ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸä¾¿äºè°ƒè¯• ***
             window.QQ_Force_Save_All_Data = QQ_Force_Save_All_Data;

             /**
              * *** æ–°å¢ï¼šæ£€æŸ¥åŠ¨æ€è¯„è®ºä¿å­˜çŠ¶æ€çš„è°ƒè¯•å‡½æ•° ***
              */
             function QQ_Check_Comment_Backup_Status() {
                 console.log('=== åŠ¨æ€è¯„è®ºå¤‡ä»½çŠ¶æ€æ£€æŸ¥ ===');
                 
                 if (!QQ_MomentsData || !Array.isArray(QQ_MomentsData)) {
                     console.log('âš ï¸ QQ_MomentsDataä¸å­˜åœ¨æˆ–ä¸æ˜¯æ•°ç»„');
                     return;
                 }
                 
                 // æ£€æŸ¥å†…å­˜ä¸­çš„åŠ¨æ€æ•°æ®
                 console.log(`å†…å­˜ä¸­åŠ¨æ€æ•°é‡: ${QQ_MomentsData.length}`);
                 
                 let totalComments = 0;
                 let momentsWithComments = 0;
                 
                 QQ_MomentsData.forEach((moment, index) => {
                     if (moment.comments && moment.comments.length > 0) {
                         totalComments += moment.comments.length;
                         momentsWithComments++;
                         console.log(`åŠ¨æ€ ${index + 1} (${moment.userName}): ${moment.comments.length}æ¡è¯„è®º`);
                         
                         // æ˜¾ç¤ºæœ€è¿‘çš„å‡ æ¡è¯„è®º
                         const recentComments = moment.comments.slice(-3);
                         recentComments.forEach((comment, commentIndex) => {
                             console.log(`  - ${comment.name}: ${comment.content} (${comment.timestamp})`);
                         });
                     }
                 });
                 
                 console.log(`æ€»è®¡: ${momentsWithComments}ä¸ªåŠ¨æ€æœ‰è¯„è®ºï¼Œå…±${totalComments}æ¡è¯„è®º`);
                 
                 // æ£€æŸ¥ä¸–ç•Œä¹¦ä¸­çš„å¤‡ä»½
                 if (worldbook && entries) {
                     const momentEntry = entries.find(entry => entry.comment === "æ‰‹æœº-åŠ¨æ€å†…å®¹å­˜å‚¨");
                     if (momentEntry) {
                         try {
                             const backupData = JSON.parse(momentEntry.content);
                             let backupComments = 0;
                             let backupMomentsWithComments = 0;
                             
                             backupData.forEach(moment => {
                                 if (moment.comments && moment.comments.length > 0) {
                                     backupComments += moment.comments.length;
                                     backupMomentsWithComments++;
                                 }
                             });
                             
                             console.log(`ä¸–ç•Œä¹¦å¤‡ä»½: ${backupData.length}ä¸ªåŠ¨æ€ï¼Œ${backupMomentsWithComments}ä¸ªæœ‰è¯„è®ºï¼Œå…±${backupComments}æ¡è¯„è®º`);
                             console.log('âœ“ ä¸–ç•Œä¹¦å¤‡ä»½å­˜åœ¨ä¸”æœ‰æ•ˆ');
                         } catch (error) {
                             console.error('ä¸–ç•Œä¹¦å¤‡ä»½æ•°æ®è§£æå¤±è´¥:', error);
                         }
                     } else {
                         console.warn('æœªæ‰¾åˆ°åŠ¨æ€å†…å®¹çš„ä¸–ç•Œä¹¦å¤‡ä»½æ¡ç›®');
                     }
                 } else {
                     console.warn('æ— æ³•è®¿é—®ä¸–ç•Œä¹¦æˆ–entries');
                 }
                 
                 console.log('=== æ£€æŸ¥å®Œæˆ ===');
             }

                         // *** æ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸä¾¿äºè°ƒè¯• ***
            window.QQ_Check_Comment_Backup_Status = QQ_Check_Comment_Backup_Status;
            
            
            // *** æ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸä¾¿äºè°ƒè¯• ***

            /**
             * *** æ–°å¢ï¼šæ£€æŸ¥äº’åŠ¨å†…å®¹ä¿å­˜çŠ¶æ€çš„è°ƒè¯•å‡½æ•° ***
             */
            function QQ_Check_Interactive_Backup_Status() {
                console.log('=== äº’åŠ¨å†…å®¹å¤‡ä»½çŠ¶æ€æ£€æŸ¥ ===');
                
                // æ£€æŸ¥å†…å­˜ä¸­çš„äº’åŠ¨ç©ºé—´æ•°æ®
                const memorySpaces = Object.keys(QQ_InteractiveSpaces || {}).length;
                const memoryCharSpaces = Object.keys(QQ_CharacterSpaces || {}).length;
                console.log(`å†…å­˜ä¸­å…¬å…±äº’åŠ¨ç©ºé—´: ${memorySpaces}ä¸ª`);
                console.log(`å†…å­˜ä¸­è§’è‰²äº’åŠ¨ç©ºé—´: ${memoryCharSpaces}ä¸ª`);
                
                if (worldbook && entries) {
                    // æ£€æŸ¥ä¸–ç•Œä¹¦ä¸­çš„å…¬å…±äº’åŠ¨å¤‡ä»½
                    const publicEntry = entries.find(entry => entry.comment === "è§’è‰²-äº’åŠ¨ç©ºé—´å¤‡ä»½");
                    if (publicEntry) {
                        try {
                            const publicData = JSON.parse(publicEntry.content);
                            console.log(`âœ… ä¸–ç•Œä¹¦å…¬å…±äº’åŠ¨å¤‡ä»½: ${publicData.length}ä¸ªäº’åŠ¨å†…å®¹`);
                            
                            // æ˜¾ç¤ºæœ€è¿‘å‡ ä¸ªå…¬å…±äº’åŠ¨çš„è¯¦æƒ…
                            if (publicData.length > 0) {
                                console.log('æœ€è¿‘çš„å…¬å…±äº’åŠ¨:');
                                publicData.slice(0, 3).forEach((item, index) => {
                                    console.log(`  ${index + 1}. ID: ${item.id}, æ—¶é—´: ${item.timestamp}`);
                                    console.log(`     å†…å®¹: ${item.content.substring(0, 50)}...`);
                                });
                            }
                        } catch (error) {
                            console.error('âŒ è§£æå…¬å…±äº’åŠ¨å¤‡ä»½å¤±è´¥:', error);
                        }
                    } else {
                        console.warn('âš  æœªæ‰¾åˆ°å…¬å…±äº’åŠ¨å¤‡ä»½æ¡ç›®');
                    }
                    
                    // æ£€æŸ¥è§’è‰²ä¸“å±äº’åŠ¨å¤‡ä»½
                    const characterEntries = entries.filter(entry => 
                        entry.comment && entry.comment.startsWith("è§’è‰²-äº’åŠ¨ç©ºé—´å¤‡ä»½-")
                    );
                    
                    console.log(`ğŸ“‹ æ‰¾åˆ°${characterEntries.length}ä¸ªè§’è‰²äº’åŠ¨å¤‡ä»½æ¡ç›®:`);
                    characterEntries.forEach(entry => {
                        const characterName = entry.comment.replace("è§’è‰²-äº’åŠ¨ç©ºé—´å¤‡ä»½-", "");
                        try {
                            const charData = JSON.parse(entry.content);
                            console.log(`  â€¢ ${characterName}: ${charData.length}ä¸ªäº’åŠ¨å†…å®¹`);
                            
                            // æ˜¾ç¤ºè¯¥è§’è‰²æœ€è¿‘çš„äº’åŠ¨
                            if (charData.length > 0) {
                                const latest = charData[0];
                                console.log(`    æœ€æ–°: ${latest.timestamp} - ${latest.content.substring(0, 30)}...`);
                            }
                        } catch (error) {
                            console.error(`âŒ è§£æè§’è‰²${characterName}äº’åŠ¨å¤‡ä»½å¤±è´¥:`, error);
                        }
                    });
                    
                    if (characterEntries.length === 0) {
                        console.warn('âš  æœªæ‰¾åˆ°ä»»ä½•è§’è‰²äº’åŠ¨å¤‡ä»½æ¡ç›®');
                    }
                    
                } else {
                    console.warn('âŒ æ— æ³•è®¿é—®ä¸–ç•Œä¹¦æˆ–entries');
                }
                
                console.log('=== äº’åŠ¨å†…å®¹æ£€æŸ¥å®Œæˆ ===');
            }

            // *** æ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸä¾¿äºè°ƒè¯• ***
            window.QQ_Check_Interactive_Backup_Status = QQ_Check_Interactive_Backup_Status;


             // *** æ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸä¾¿äºè°ƒè¯• ***

             /**
              * *** æ–°å¢ï¼šæŸ¥çœ‹äº’åŠ¨ç©ºé—´ä¸–ç•Œä¹¦å¤‡ä»½ä¿¡æ¯ ***
              */
             function QQ_Show_Interactive_Spaces_Backup() {
                 console.log("ğŸŒŸ äº’åŠ¨ç©ºé—´ä¸–ç•Œä¹¦å¤‡ä»½æŸ¥è¯¢ ğŸŒŸ");
                 
                 try {
                     if (!worldbook || !worldbook.entries) {
                         console.log("âŒ ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨æˆ–æœªåˆå§‹åŒ–");
                         return;
                     }
                     
                     // æŸ¥æ‰¾æ‰€æœ‰äº’åŠ¨ç©ºé—´ç›¸å…³çš„ä¸–ç•Œä¹¦æ¡ç›®
                     const interactiveEntries = worldbook.entries.filter(entry => 
                         entry.comment && (
                             entry.comment.includes('äº’åŠ¨ç©ºé—´') || 
                             entry.comment === 'QQ_äº’åŠ¨ç©ºé—´å¤‡ä»½' ||
                             entry.comment === 'QQ_è§’è‰²äº’åŠ¨ç©ºé—´å¤‡ä»½' ||
                             entry.comment.startsWith('QQ_äº’åŠ¨ç©ºé—´å¤‡ä»½_')
                         )
                     );
                     
                     console.log(`ğŸ“š å…±æ‰¾åˆ° ${interactiveEntries.length} ä¸ªäº’åŠ¨ç©ºé—´ç›¸å…³çš„ä¸–ç•Œä¹¦æ¡ç›®ï¼š`);
                     
                     interactiveEntries.forEach((entry, index) => {
                         console.log(`\nğŸ“– æ¡ç›® ${index + 1}: ${entry.comment}`);
                         console.log(`ğŸ”‘ å…³é”®è¯: ${entry.key ? entry.key.join(', ') : 'æ— '}`);
                         console.log(`ğŸ“„ å¯ç”¨çŠ¶æ€: ${entry.enabled ? 'âœ… å¯ç”¨' : 'âŒ ç¦ç”¨'}`);
                         console.log(`ğŸ“Š å†…å®¹é•¿åº¦: ${entry.content ? entry.content.length : 0} å­—ç¬¦`);
                         
                         if (entry.content) {
                             try {
                                 const data = JSON.parse(entry.content);
                                 if (data.spaces) {
                                     const spaceCount = Object.keys(data.spaces).length;
                                     console.log(`ğŸ  å…¬å…±äº’åŠ¨ç©ºé—´æ•°é‡: ${spaceCount}`);
                                 }
                                 if (data.characterSpaces) {
                                     const characterCount = Object.keys(data.characterSpaces).length;
                                     const totalSpaces = Object.values(data.characterSpaces).reduce((sum, char) => sum + Object.keys(char).length, 0);
                                     console.log(`ğŸ‘¥ è§’è‰²æ•°é‡: ${characterCount}, æ€»ç©ºé—´æ•°: ${totalSpaces}`);
                                 }
                                 if (data.lastUpdated) {
                                     console.log(`â° æœ€åæ›´æ–°: ${data.lastUpdated}`);
                                 }
                                 if (data.version) {
                                     console.log(`ğŸ“Œ ç‰ˆæœ¬: ${data.version}`);
                                 }
                             } catch (parseError) {
                                 console.log(`âš ï¸ å†…å®¹è§£æå¤±è´¥: ${parseError.message}`);
                             }
                         } else {
                             console.log("ğŸ“„ å†…å®¹ä¸ºç©º");
                         }
                     });
                     
                     // æ˜¾ç¤ºå†…å­˜ä¸­çš„äº’åŠ¨ç©ºé—´çŠ¶æ€
                     console.log("\nğŸ’¾ å†…å­˜ä¸­çš„äº’åŠ¨ç©ºé—´çŠ¶æ€:");
                     if (window.QQ_InteractiveSpaces) {
                         const memorySpaceCount = Object.keys(QQ_InteractiveSpaces).length;
                         console.log(`ğŸ  å…¬å…±äº’åŠ¨ç©ºé—´ (å†…å­˜): ${memorySpaceCount} ä¸ª`);
                     }
                     if (window.QQ_CharacterSpaces) {
                         const memoryCharacterCount = Object.keys(QQ_CharacterSpaces).length;
                         const memoryTotalSpaces = Object.values(QQ_CharacterSpaces).reduce((sum, char) => sum + Object.keys(char).length, 0);
                         console.log(`ğŸ‘¥ è§’è‰²äº’åŠ¨ç©ºé—´ (å†…å­˜): ${memoryCharacterCount} ä¸ªè§’è‰², ${memoryTotalSpaces} ä¸ªç©ºé—´`);
                     }
                     
                     console.log("\nğŸ”§ æ‰‹åŠ¨æ“ä½œè¯´æ˜:");
                     console.log("- æ‰§è¡Œ QQ_Show_Interactive_Spaces_Backup() æŸ¥çœ‹æ­¤ä¿¡æ¯");
                     console.log("- åœ¨SillyTavernä¸–ç•Œä¹¦ä¸­æŸ¥æ‰¾ä»¥ä¸‹æ¡ç›®:");
                     console.log("  â€¢ QQ_äº’åŠ¨ç©ºé—´å¤‡ä»½ (å…¬å…±äº’åŠ¨ç©ºé—´)");
                     console.log("  â€¢ QQ_è§’è‰²äº’åŠ¨ç©ºé—´å¤‡ä»½ (è§’è‰²ä¸“å±äº’åŠ¨ç©ºé—´)");
                     console.log("  â€¢ QQ_äº’åŠ¨ç©ºé—´å¤‡ä»½_{è§’è‰²å} (å•è§’è‰²äº’åŠ¨ç©ºé—´)");
                     
                     return {
                         totalEntries: interactiveEntries.length,
                         entries: interactiveEntries.map(e => ({
                             comment: e.comment,
                             enabled: e.enabled,
                             contentLength: e.content ? e.content.length : 0
                         }))
                     };
                     
                 } catch (error) {
                     console.error("æŸ¥è¯¢äº’åŠ¨ç©ºé—´å¤‡ä»½æ—¶å‘ç”Ÿé”™è¯¯:", error);
                     return null;
                 }
             }

             // *** æ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸä¾¿äºè°ƒè¯• ***
             window.QQ_Show_Interactive_Spaces_Backup = QQ_Show_Interactive_Spaces_Backup;

             /**
              * *** æ–°å¢ï¼šæ£€æŸ¥ç¾¤èŠæ¶ˆæ¯ä¿å­˜çŠ¶æ€çš„è°ƒè¯•å‡½æ•° ***
              */
             function QQ_Check_Group_Message_Backup_Status() {
                 console.log('=== ç¾¤èŠæ¶ˆæ¯å¤‡ä»½çŠ¶æ€æ£€æŸ¥ ===');
                 
                 // æ£€æŸ¥QQ_msgjson.ç¾¤èŠä¸­çš„æ•°æ®
                 if (QQ_msgjson.ç¾¤èŠ && typeof QQ_msgjson.ç¾¤èŠ === 'object') {
                     const groupNames = Object.keys(QQ_msgjson.ç¾¤èŠ);
                     console.log(`QQ_msgjson.ç¾¤èŠä¸­æœ‰ ${groupNames.length} ä¸ªç¾¤èŠ:`);
                     
                     let totalMessages = 0;
                     groupNames.forEach(groupName => {
                         const groupData = QQ_msgjson.ç¾¤èŠ[groupName];
                         const msgCount = groupData && groupData.msgs ? groupData.msgs.length : 0;
                         totalMessages += msgCount;
                         console.log(`  - ${groupName}: ${msgCount}æ¡æ¶ˆæ¯`);
                         
                         // æ˜¾ç¤ºæœ€è¿‘å‡ æ¡æ¶ˆæ¯
                         if (msgCount > 0) {
                             const recentMsgs = groupData.msgs.slice(-3);
                             recentMsgs.forEach(msg => {
                                 console.log(`    ${msg}`);
                             });
                         }
                     });
                     
                     console.log(`æ€»è®¡: ${totalMessages}æ¡ç¾¤èŠæ¶ˆæ¯`);
                 } else {
                     console.log('QQ_msgjson.ç¾¤èŠ ä¸ºç©ºæˆ–ä¸å­˜åœ¨');
                 }
                 
                 // æ£€æŸ¥QQ_Groupsæ•°ç»„
                 console.log(`QQ_Groupsæ•°ç»„: [${QQ_Groups.join(', ')}] (${QQ_Groups.length}ä¸ª)`);
                 
                 // æ£€æŸ¥ä¸–ç•Œä¹¦å¤‡ä»½
                 if (worldbook && entries) {
                     const chatEntry = entries.find(entry => entry.comment === "QQèŠå¤©å¤‡ä»½æ•°æ®");
                     if (chatEntry) {
                         try {
                             const backupData = JSON.parse(chatEntry.content);
                             if (backupData.ç¾¤èŠ) {
                                 const backupGroupNames = Object.keys(backupData.ç¾¤èŠ);
                                 let backupTotalMessages = 0;
                                 
                                 backupGroupNames.forEach(groupName => {
                                     const groupData = backupData.ç¾¤èŠ[groupName];
                                     const msgCount = groupData && groupData.msgs ? groupData.msgs.length : 0;
                                     backupTotalMessages += msgCount;
                                 });
                                 
                                 console.log(`ä¸–ç•Œä¹¦å¤‡ä»½: ${backupGroupNames.length}ä¸ªç¾¤èŠï¼Œ${backupTotalMessages}æ¡æ¶ˆæ¯`);
                                 console.log('âœ“ ä¸–ç•Œä¹¦ç¾¤èŠå¤‡ä»½å­˜åœ¨ä¸”æœ‰æ•ˆ');
                             } else {
                                 console.log('ä¸–ç•Œä¹¦å¤‡ä»½ä¸­æ— ç¾¤èŠæ•°æ®');
                             }
                         } catch (error) {
                             console.error('ä¸–ç•Œä¹¦å¤‡ä»½æ•°æ®è§£æå¤±è´¥:', error);
                         }
                     } else {
                         console.warn('æœªæ‰¾åˆ°èŠå¤©å¤‡ä»½çš„ä¸–ç•Œä¹¦æ¡ç›®');
                     }
                 } else {
                     console.warn('æ— æ³•è®¿é—®ä¸–ç•Œä¹¦æˆ–entries');
                 }
                 
                 // *** ä¿®å¤ï¼šä½¿ç”¨ç¼“å­˜çš„ç¾¤èŠå…ƒæ•°æ®æ£€æŸ¥å­˜å‚¨ ***
                 try {
                     const groups = window.QQ_Group_Chats_Data || [];
                     console.log(`ç¾¤èŠä¸“ç”¨å­˜å‚¨: ${groups.length}ä¸ªç¾¤èŠ`);
                     groups.forEach(group => {
                         console.log(`  - ${group.name} (ID: ${group.id})`);
                     });
                 } catch (error) {
                     console.error('æ£€æŸ¥ç¾¤èŠä¸“ç”¨å­˜å‚¨å¤±è´¥:', error);
                 }
                 
                 console.log('=== ç¾¤èŠæ£€æŸ¥å®Œæˆ ===');
             }

             // *** æ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸä¾¿äºè°ƒè¯• ***
             window.QQ_Check_Group_Message_Backup_Status = QQ_Check_Group_Message_Backup_Status;

             
             
             // *** æ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸä¾¿äºè°ƒè¯• ***
            
            /**
             * *** æ–°å¢ï¼šæµ‹è¯•äº’åŠ¨å†…å®¹ä¸¥æ ¼æ£€æµ‹ä¿®å¤ ***
             */


             /**
              * *** æ–°å¢ï¼šæ£€æŸ¥ä¸¤é˜¶æ®µå‘é€æœºåˆ¶çŠ¶æ€çš„è°ƒè¯•å‡½æ•° ***
              */
             function QQ_Check_Two_Stage_Send_Status() {
                 console.log('=== ä¸¤é˜¶æ®µå‘é€æœºåˆ¶çŠ¶æ€æ£€æŸ¥ ===');
                 
                 // æ£€æŸ¥ç¼“å­˜æ¶ˆæ¯çŠ¶æ€
                 console.log(`ç¼“å­˜æ¶ˆæ¯çŠ¶æ€: ${QQ_CacheSendMsg ? 'æœ‰ç¼“å­˜' : 'æ— ç¼“å­˜'}`);
                 if (QQ_CacheSendMsg) {
                     console.log(`ç¼“å­˜å†…å®¹: "${QQ_CacheSendMsg}"`);
                     
                     // è§£æç¼“å­˜æ¶ˆæ¯
                     const namevalue = QQ_GetValueName(QQ_CacheSendMsg);
                     if (namevalue && namevalue.length > 0) {
                         console.log(`è§£æåˆ° ${namevalue.length} æ¡ç¼“å­˜æ¶ˆæ¯:`);
                         namevalue.forEach((match, index) => {
                             const type = QQ_Groups.includes(match.name) ? 'ç¾¤èŠ' : 'ç§èŠ';
                             console.log(`  ${index + 1}. ${type} - ${match.name}: "${match.value}"`);
                         });
                     } else {
                         console.log('ç¼“å­˜æ¶ˆæ¯è§£æå¤±è´¥');
                     }
                 }
                 
                 // æ£€æŸ¥æœ€è¿‘çš„æ¶ˆæ¯ä¿å­˜çŠ¶æ€
                 console.log('\n=== æœ€è¿‘æ¶ˆæ¯ä¿å­˜çŠ¶æ€ ===');
                 
                 // æ£€æŸ¥ç§èŠæ¶ˆæ¯
                 console.log('ç§èŠæ¶ˆæ¯æ•°é‡:', Object.keys(QQ_msgjson.ç§èŠ).length);
                 Object.entries(QQ_msgjson.ç§èŠ).forEach(([chatKey, messages]) => {
                     if (Array.isArray(messages) && messages.length > 0) {
                         const lastMsg = messages[messages.length - 1];
                         console.log(`  ${chatKey}: æœ€åæ¶ˆæ¯ "${lastMsg}"`);
                     }
                 });
                 
                 // æ£€æŸ¥ç¾¤èŠæ¶ˆæ¯
                 console.log('ç¾¤èŠæ¶ˆæ¯æ•°é‡:', Object.keys(QQ_msgjson.ç¾¤èŠ).length);
                 Object.entries(QQ_msgjson.ç¾¤èŠ).forEach(([groupName, groupData]) => {
                     if (groupData && groupData.msgs && Array.isArray(groupData.msgs) && groupData.msgs.length > 0) {
                         const lastMsg = groupData.msgs[groupData.msgs.length - 1];
                         console.log(`  ${groupName}: æœ€åæ¶ˆæ¯ "${lastMsg}"`);
                     }
                 });
                 
                 console.log('\n=== æ£€æŸ¥å®Œæˆ ===');
              }
             
             
             // *** æ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸä¾¿äºè°ƒè¯• ***
             window.QQ_Check_Two_Stage_Send_Status = QQ_Check_Two_Stage_Send_Status;



             /**
              * å¤„ç†AIçš„åŠ¨æ€è¯„è®ºå›å¤ (moment_reply_start/endæ ¼å¼)
              * @param {string} content - moment_replyæ ‡ç­¾å†…çš„å†…å®¹
              */
             async function QQ_ProcessMomentReply(content) {
                console.log('ğŸ”„ å¤„ç†åŠ¨æ€è¯„è®ºå›å¤');
                
                // è§£æmoment_id
                const momentIdMatch = content.match(/moment_id::([^\n]+)/);
                if (!momentIdMatch) {
                    console.error('âŒ æœªæ‰¾åˆ°moment_idï¼Œæ— æ³•å¤„ç†åŠ¨æ€å›å¤');
                    return;
                }
                
                const momentId = momentIdMatch[1].trim();
                console.log(`ğŸ“ ç›®æ ‡åŠ¨æ€ID: ${momentId}`);
                
                // æŸ¥æ‰¾å¯¹åº”çš„åŠ¨æ€æ•°æ®
                const targetMoment = QQ_MomentsData.find(moment => moment.id === momentId);
                if (!targetMoment) {
                    console.error(`âŒ æœªæ‰¾åˆ°IDä¸º ${momentId} çš„åŠ¨æ€`);
                    return;
                }
                
                // æŸ¥æ‰¾å¯¹åº”çš„DOMå…ƒç´ 
                const $momentDiv = $(`#space_contents .user_moment[data-moment-id="${momentId}"]`);
                if (!$momentDiv.length) {
                    console.error(`âŒ æœªæ‰¾åˆ°IDä¸º ${momentId} çš„åŠ¨æ€DOMå…ƒç´ `);
                    return;
                }
                
                const $commentsList = $momentDiv.find('.user_leave_message_list');
                
                // è§£æè¯„è®ºå†…å®¹
                const lines = content.split(/\r?\n/g);
                const newComments = [];
                
                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (!trimmedLine || trimmedLine.includes('moment_id::')) continue;
                    
                    // åŒ¹é…è¯„è®ºæ ¼å¼: è¯„è®ºäºº--è¯„è®ºå†…å®¹
                    const commentMatch = trimmedLine.match(/^\s*(.+?)(?::|ï¼š|--)(.+)$/);
                    if (commentMatch) {
                        const commenterName = commentMatch[1].trim();
                        const commentContent = commentMatch[2].trim();
                        
                        // è¿‡æ»¤é‡å¤çš„ç”¨æˆ·è¯„è®º
                        if (commenterName === '{{user}}' || commenterName === UserName) {
                            console.log(`âš ï¸ è¿‡æ»¤é‡å¤çš„ç”¨æˆ·è¯„è®º: ${commenterName}`);
                            continue;
                        }
                        
                        const commentData = {
                            name: commenterName,
                            content: commentContent,
                            timestamp: new Date().toISOString(),
                            sequenceId: QQ_MessageSequence.next() // ä¸ºæ–°è¯„è®ºåˆ†é…åºåˆ—å·
                        };
                        
                        newComments.push(commentData);
                        targetMoment.comments.push(commentData);
                        
                        console.log(`âœ… æ·»åŠ æ–°è¯„è®º: ${commenterName} - ${commentContent}`);
                    }
                }
                
                // ä¿æŒè¯„è®ºæ•°é‡ä¸Šé™ï¼ˆ50æ¡ï¼‰
                if (targetMoment.comments.length > 50) {
                    targetMoment.comments = targetMoment.comments.slice(-50);
                }
                
                // é‡æ–°æ¸²æŸ“è¯„è®ºåŒºåŸŸ
                QQ_Render_Comments(targetMoment, $commentsList);
                
                // ä¿å­˜åŠ¨æ€æ•°æ®
                setTimeout(async () => {
                    await QQ_Save_Moments();
                    console.log('âœ… åŠ¨æ€è¯„è®ºå›å¤å¤„ç†å®Œæˆï¼Œå·²ä¿å­˜åˆ°ä¸–ç•Œä¹¦');
                }, 500);
                
                console.log(`ğŸ“Š å¤„ç†å®Œæˆ: æ·»åŠ äº† ${newComments.length} æ¡æ–°è¯„è®ºåˆ°åŠ¨æ€ ${momentId}`);
             }

             /**
              * è§£æç§èŠå†…å®¹å¹¶æ·»åŠ åˆ°QQ_msgjson.ç§èŠæ•°æ®ç»“æ„ä¸­
              * @param {string} content - ç§èŠå†…å®¹æ–‡æœ¬
              * @param {string} chatKey - èŠå¤©é”®å€¼ï¼ˆå¦‚"UserNameå’Œè§’è‰²åçš„èŠå¤©"ï¼‰
              */
             function QQ_ParsePrivateChatContent(content, chatKey) {
                console.log(`ğŸ’¬ è§£æç§èŠå†…å®¹: ${chatKey}`);
                
                if (!content || !chatKey) {
                    console.warn('ç§èŠå†…å®¹æˆ–èŠå¤©é”®ä¸ºç©º');
                    return;
                }
                
                // ç¡®ä¿ç§èŠæ•°æ®ç»“æ„å­˜åœ¨
                if (!QQ_msgjson.ç§èŠ[chatKey]) {
                    QQ_msgjson.ç§èŠ[chatKey] = [];
                }
                
                // æŒ‰è¡Œåˆ†å‰²å†…å®¹
                const lines = content.split(/\r?\n/);
                
                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (!trimmedLine) continue;
                    
                    // è§£ææ¶ˆæ¯æ ¼å¼ï¼šå‘é€è€…åç§° + åˆ†éš”ç¬¦ + æ¶ˆæ¯å†…å®¹
                    const messageMatch = trimmedLine.match(/^(.+?)(?:[:ï¼š\-]{1,2})(.+)$/);
                    if (messageMatch) {
                        const senderName = messageMatch[1].trim();
                        const messageContent = messageMatch[2].trim();
                        const timestamp = new Date().toLocaleTimeString('zh-CN', { 
                            hour12: false, 
                            hour: '2-digit', 
                            minute: '2-digit', 
                            second: '2-digit' 
                        });
                        
                        // æ„å»ºæ¶ˆæ¯æ ¼å¼ï¼šå‘é€è€…--å†…å®¹--æ—¶é—´
                        const formattedMessage = `${senderName}--${messageContent}--${timestamp}`;
                        
                        // æ£€æŸ¥æ˜¯å¦ä¸ºé‡å¤æ¶ˆæ¯
                        if (!QQ_msgjson.ç§èŠ[chatKey].includes(formattedMessage)) {
                            // æ·»åŠ åºåˆ—IDå¹¶å­˜å‚¨æ¶ˆæ¯
                            const sequenceId = QQ_GetNextMessageId();
                            const messageWithSequence = QQ_AddSequenceIdToMessage(formattedMessage, sequenceId);
                            QQ_msgjson.ç§èŠ[chatKey].push(messageWithSequence);
                            console.log(`âœ… æ·»åŠ ç§èŠæ¶ˆæ¯: ${senderName} -> ${messageContent}`);
                        }
                    }
                }
             }

             /**
              * è§£æç¾¤èŠå†…å®¹å¹¶æ·»åŠ åˆ°QQ_msgjson.ç¾¤èŠæ•°æ®ç»“æ„ä¸­
              * @param {string} content - ç¾¤èŠå†…å®¹æ–‡æœ¬
              * @param {string} groupName - ç¾¤èŠåç§°
              */
             function QQ_ParseGroupChatContent(content, groupName) {
                console.log(`ğŸ‘¥ è§£æç¾¤èŠå†…å®¹: ${groupName}`);
                
                if (!content || !groupName) {
                    console.warn('ç¾¤èŠå†…å®¹æˆ–ç¾¤åä¸ºç©º');
                    return;
                }
                
                // ç¡®ä¿ç¾¤èŠæ•°æ®ç»“æ„å­˜åœ¨
                if (!QQ_msgjson.ç¾¤èŠ[groupName]) {
                    QQ_msgjson.ç¾¤èŠ[groupName] = { msgs: [] };
                }
                
                if (!QQ_msgjson.ç¾¤èŠ[groupName].msgs) {
                    QQ_msgjson.ç¾¤èŠ[groupName].msgs = [];
                }
                
                // æŒ‰è¡Œåˆ†å‰²å†…å®¹
                const lines = content.split(/\r?\n/);
                
                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (!trimmedLine) continue;
                    
                    // è§£ææ¶ˆæ¯æ ¼å¼ï¼šå‘é€è€…åç§° + åˆ†éš”ç¬¦ + æ¶ˆæ¯å†…å®¹
                    const messageMatch = trimmedLine.match(/^(.+?)(?:[:ï¼š\-]{1,2})(.+)$/);
                    if (messageMatch) {
                        const senderName = messageMatch[1].trim();
                        const messageContent = messageMatch[2].trim();
                        const timestamp = new Date().toLocaleTimeString('zh-CN', { 
                            hour12: false, 
                            hour: '2-digit', 
                            minute: '2-digit', 
                            second: '2-digit' 
                        });
                        
                        // æ„å»ºæ¶ˆæ¯æ ¼å¼ï¼šå‘é€è€…--å†…å®¹--æ—¶é—´
                        const formattedMessage = `${senderName}--${messageContent}--${timestamp}`;
                        
                        // æ£€æŸ¥æ˜¯å¦ä¸ºé‡å¤æ¶ˆæ¯
                        if (!QQ_msgjson.ç¾¤èŠ[groupName].msgs.includes(formattedMessage)) {
                            // æ·»åŠ åºåˆ—IDå¹¶å­˜å‚¨æ¶ˆæ¯
                            const sequenceId = QQ_GetNextMessageId();
                            const messageWithSequence = QQ_AddSequenceIdToMessage(formattedMessage, sequenceId);
                            QQ_msgjson.ç¾¤èŠ[groupName].msgs.push(messageWithSequence);
                            console.log(`âœ… æ·»åŠ ç¾¤èŠæ¶ˆæ¯: ${senderName} -> ${messageContent}`);
                        }
                    }
                }
             }

             function QQ_Moment_Parse(content, isCommentContext = false) {
                // å‚æ•°éªŒè¯
                if (!content || typeof content !== 'string') {
                    console.warn('âš ï¸ QQ_Moment_Parse: contentå‚æ•°æ— æ•ˆ', content);
                    return;
                }
                
                const lines = content.split(/\r?\n/g);
                let momentdiv;
                let list;
                let count = QQ_NewMsg["moment"] || 0;
                let currentMomentData = null; // *** æ–°å¢ï¼šå½“å‰åŠ¨æ€çš„æ•°æ®å¯¹è±¡ ***
                
                // *** æ–°å¢ï¼šåœ¨è¯„è®ºä¸Šä¸‹æ–‡ä¸­ï¼Œç›´æ¥å¤„ç†è¯„è®ºå¹¶æ·»åŠ åˆ°ç°æœ‰åŠ¨æ€ ***
                if (isCommentContext) {
                    console.log('ğŸ¯ è¯„è®ºä¸Šä¸‹æ–‡æ¨¡å¼ï¼šå°†è¯„è®ºæ·»åŠ åˆ°ç°æœ‰åŠ¨æ€');
                    const commentLines = [];
                    
                    for (const line of lines) {
                        const trimmedLine = line.trim();
                        if (!trimmedLine) continue;
                        
                        // è·³è¿‡å®Œæ•´åŠ¨æ€æ ¼å¼
                        const fullMomentMatch = trimmedLine.match(/\s*(.+?)--(.+?)--(.+?)--(.+?)--(.+)/);
                        if (fullMomentMatch) {
                            console.log('âš ï¸ è¯„è®ºä¸Šä¸‹æ–‡ä¸­è·³è¿‡å®Œæ•´åŠ¨æ€æ ¼å¼:', trimmedLine);
                            continue;
                        }
                        
                        // å¤„ç†è¯„è®ºæ ¼å¼
                        const commentMatch = trimmedLine.match(/^\s*(.+?)(?::|ï¼š|--)(.+)$/);
                        if (commentMatch) {
                            const commenterName = commentMatch[1].trim();
                            // *** æ–°å¢ï¼šè¿‡æ»¤ç”¨æˆ·é‡å¤è¯„è®º ***
                            if (commenterName === '{{user}}' || commenterName === UserName) {
                                console.log(`è¿‡æ»¤ç”¨æˆ·é‡å¤è¯„è®º: ${commenterName} - ${commentMatch[2]}`);
                                continue;
                            }
                            
                            commentLines.push({
                                name: commenterName,
                                content: commentMatch[2],
                                timestamp: new Date().toISOString(),
                                sequenceId: QQ_MessageSequence.next() // ä¸ºæ–°è¯„è®ºåˆ†é…åºåˆ—å·
                            });
                        }
                    }
                    
                    // å°†è¯„è®ºæ·»åŠ åˆ°æœ€æ–°çš„åŠ¨æ€ä¸­
                    if (commentLines.length > 0 && QQ_MomentsData.length > 0) {
                        const latestMoment = QQ_MomentsData[0]; // æœ€æ–°çš„åŠ¨æ€
                        const latestMomentDiv = $("#space_contents").find('.user_moment').first();
                        const latestCommentsList = latestMomentDiv.find('.user_leave_message_list');
                        
                        for (const comment of commentLines) {
                            // æ·»åŠ åˆ°æ•°æ®å¯¹è±¡
                            latestMoment.comments.push(comment);
                            
                            // ä¿æŒè¯„è®ºæ•°é‡ä¸Šé™ï¼ˆ50æ¡ï¼‰
                            if (latestMoment.comments.length > 50) {
                                latestMoment.comments = latestMoment.comments.slice(-50);
                            }
                            
                            console.log(`âœ… è¯„è®ºå·²æ·»åŠ åˆ°ç°æœ‰åŠ¨æ€: ${comment.name} - ${comment.content}`);
                        }
                        
                        // é‡æ–°æ¸²æŸ“è¯„è®ºåŒºåŸŸ
                        QQ_Render_Comments(latestMoment, latestCommentsList);
                        
                        // ä¿å­˜åŠ¨æ€æ•°æ®
                        setTimeout(async () => {
                            await QQ_Save_Moments();
                            console.log('è¯„è®ºä¸Šä¸‹æ–‡å¤„ç†å®Œæˆï¼ŒåŠ¨æ€å·²ä¿å­˜');
                        }, 500);
                    }
                    
                    return; // è¯„è®ºä¸Šä¸‹æ–‡å¤„ç†å®Œæˆï¼Œç›´æ¥è¿”å›
                }
                
                for (const line of lines) {
                    //console.log(`line:${line}`);
                    let match = line.match(
                        /\s*(.+?)--(.+?)--(.+?)--(.+?)--(.+)/,
                    );
                    if (match) {
                        
                        // æ˜¯æ–°åŠ¨æ€å†…å®¹
                        console.log(`åŒ¹é…åˆ°åŠ¨æ€å†…å®¹:${match[0]}`);
                        
                        // *** ä¿®å¤ï¼šä¿å­˜ä¸Šä¸€ä¸ªåŠ¨æ€æ•°æ®ï¼Œé¿å…é‡å¤æ·»åŠ ç°æœ‰åŠ¨æ€ ***
                        if (currentMomentData && momentdiv) {
                            const existingIndex = QQ_MomentsData.findIndex(moment => moment.id === currentMomentData.id);
                            if (existingIndex === -1) {
                                // æ–°åŠ¨æ€ï¼Œæ·»åŠ åˆ°æ•°æ®æ•°ç»„å’ŒDOM
                                QQ_MomentsData.unshift(currentMomentData);
                                count += 1;
                                $("#space_contents").prepend(momentdiv);
                                console.log(`âœ… æ·»åŠ æ–°åŠ¨æ€åˆ°ç•Œé¢: ${currentMomentData.message.substring(0, 30)}...`);
                            } else {
                                // ç°æœ‰åŠ¨æ€ï¼Œæ›´æ–°æ•°æ®ä½†ä¸é‡å¤æ·»åŠ DOM
                                QQ_MomentsData[existingIndex] = currentMomentData;
                                console.log(`ğŸ”„ æ›´æ–°ç°æœ‰åŠ¨æ€æ•°æ®: ${currentMomentData.message.substring(0, 30)}...`);
                            }
                        }
                        
                        let fakeimg = "";
                        let message = match[2];
                        const matches = message.matchAll(/\[img-(.+?)\]/g);
                        if (matches) {
                            for (const m of matches) {
                                message = message.replace(m[0], "");
                                fakeimg += `\n<div class="space_fakeimg">${m[1]}</div>`;
                            }
                        }
                        
                        const randomPhone = QQ_CharSettings.readValue(match[1], "æ‰‹æœºå‹å·") 
                            ? QQ_CharSettings.readValue(match[1], "æ‰‹æœºå‹å·")
                            : QQ_GetRandomPhone();
                        
                        // *** ä¿®å¤ï¼šæ£€æŸ¥æ˜¯å¦ä¸ºé‡å¤çš„ç°æœ‰åŠ¨æ€ï¼Œé¿å…é‡æ–°åˆ†é…åºåˆ—å· ***
                        const dynamicContent = `${match[1]}--${match[2]}--${match[3]}`;
                        const existingMoment = QQ_MomentsData.find(moment => 
                            moment.userName === match[1] && 
                            moment.message === message && 
                            moment.timestampText === match[3]
                        );
                        
                        let momentId, sequenceId;
                        if (existingMoment) {
                            // å¦‚æœæ˜¯ç°æœ‰åŠ¨æ€ï¼Œä¿æŒåŸæœ‰IDå’Œåºåˆ—å·
                            momentId = existingMoment.id;
                            sequenceId = existingMoment.sequenceId;
                            console.log(`ğŸ”„ å‘ç°ç°æœ‰åŠ¨æ€ï¼Œä¿æŒåŸåºåˆ—å· [seq:${sequenceId}]: ${message.substring(0, 30)}...`);
                        } else {
                            // å¦‚æœæ˜¯æ–°åŠ¨æ€ï¼Œåˆ†é…æ–°çš„IDå’Œåºåˆ—å·
                            momentId = `${match[1]}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                            sequenceId = QQ_MessageSequence.next();
                            console.log(`âœ¨ å‘ç°æ–°åŠ¨æ€ï¼Œåˆ†é…æ–°åºåˆ—å· [seq:${sequenceId}]: ${message.substring(0, 30)}...`);
                        }
                        
                        currentMomentData = {
                            id: momentId, // ä½¿ç”¨æ›´å¯é çš„å”¯ä¸€ID
                            userName: match[1],
                            message: message,
                            timestampText: match[3],
                            timestamp: new Date().toISOString(), // ä¿å­˜å®Œæ•´æ—¶é—´æˆ³ç”¨äºæ’åº
                            additionalInfo: match[4],
                            randomPhone: randomPhone,
                            extraContent: match[5] || '',
                            imgcontent: fakeimg,
                            comments: existingMoment ? existingMoment.comments : [], // ä¿æŒç°æœ‰è¯„è®ºæˆ–åˆå§‹åŒ–
                            sequenceId: sequenceId, // *** ä¿®å¤ï¼šä½¿ç”¨æ£€æŸ¥åç¡®å®šçš„åºåˆ—å· ***
                            // *** ä¿®å¤ï¼šç‚¹èµç›¸å…³å­—æ®µï¼Œä¿æŒç°æœ‰æ•°æ®æˆ–åˆå§‹åŒ– ***
                            likes: existingMoment ? existingMoment.likes : {
                                count: parseInt(match[5]) || 0, // ç‚¹èµæ€»æ•°
                                userLiked: false, // ç”¨æˆ·æ˜¯å¦å·²ç‚¹èµ
                                likedBy: [], // ç‚¹èµç”¨æˆ·åˆ—è¡¨
                                lastLikeTime: null // æœ€åç‚¹èµæ—¶é—´
                            }
                        };
                        
                        momentdiv = $("<div>", { 
                            class: "user_moment",
                            "data-moment-id": momentId // æ·»åŠ åŠ¨æ€IDå±æ€§
                        });
                        momentdiv.html(
                            _.template(moment_page)({
                                userName: match[1],
                                message: message,
                                timestamp: match[3],
                                additionalInfo: match[4],
                                randomPhone: randomPhone,
                                extraContent: match[5],
                                imgcontent: fakeimg,
                                momentId: momentId, 
                                // ä¿®å¤ï¼šç‚¹èµç›¸å…³æ•°æ®ï¼Œä½¿ç”¨æ¨¡æ¿ä¸­æ­£ç¡®çš„å˜é‡å
                                likeCount: currentMomentData.likes.count,
                                likedByUser: currentMomentData.likes.userLiked
                            }),
                        );
                        list = momentdiv.find(".user_leave_message_list");
                        continue;
                    }
                    match = line.match(/^\s*(.+?)(?::|ï¼š|--)(.+)$/m);
                    if (match && momentdiv && list && currentMomentData) {
                        // *** æ–°å¢ï¼šè¿‡æ»¤ç”¨æˆ·é‡å¤è¯„è®º ***
                        const commenterName = match[1].trim();
                        if (commenterName === '{{user}}' || commenterName === UserName) {
                            console.log(`è¿‡æ»¤ç”¨æˆ·é‡å¤è¯„è®º: ${commenterName} - ${match[2]}`);
                            continue;
                        }
                        
                        // æ˜¯è¯„è®ºå†…å®¹
                        //console.log(`è¯„è®ºäºº:${match[1]}  è¯„è®ºå†…å®¹:${match[2]}`)
                        
                        // *** æ–°å¢ï¼šä¿å­˜è¯„è®ºåˆ°æ•°æ®å¯¹è±¡ ***
                        const commentData = {
                            name: commenterName,
                            content: match[2],
                            timestamp: new Date().toISOString(),
                            sequenceId: QQ_MessageSequence.next() // ä¸ºæ–°è¯„è®ºåˆ†é…åºåˆ—å·
                        };
                        currentMomentData.comments.push(commentData);
                        
                        // *** æ–°å¢ï¼šåº”ç”¨è¯„è®ºæ˜¾ç¤ºä¸Šé™ ***
                        if (list.find('.user_leave_message').length >= 8) {
                            list.find('.user_leave_message').first().remove();
                        }
                        
                        let messageDiv = $("<div>", {
                            class: "user_leave_message",
                        });
                        messageDiv.html(
                            `<span><strong>${commenterName}</strong>ï¼š${match[2]}</span>`,
                        );
                        list.append(messageDiv);
                    }
                }
                
                // *** ä¿®å¤ï¼šä¿å­˜æœ€åä¸€ä¸ªåŠ¨æ€æ•°æ®ï¼Œé¿å…é‡å¤æ·»åŠ ç°æœ‰åŠ¨æ€ ***
                if (currentMomentData && momentdiv) {
                    const existingIndex = QQ_MomentsData.findIndex(moment => moment.id === currentMomentData.id);
                    if (existingIndex === -1) {
                        // æ–°åŠ¨æ€ï¼Œæ·»åŠ åˆ°æ•°æ®æ•°ç»„å’ŒDOM
                        QQ_MomentsData.unshift(currentMomentData);
                        count += 1;
                        $("#space_contents").prepend(momentdiv);
                        console.log(`âœ… æ·»åŠ æ–°åŠ¨æ€åˆ°ç•Œé¢: ${currentMomentData.message.substring(0, 30)}...`);
                    } else {
                        // ç°æœ‰åŠ¨æ€ï¼Œæ›´æ–°æ•°æ®ä½†ä¸é‡å¤æ·»åŠ DOM
                        QQ_MomentsData[existingIndex] = currentMomentData;
                        console.log(`ğŸ”„ æ›´æ–°ç°æœ‰åŠ¨æ€æ•°æ®: ${currentMomentData.message.substring(0, 30)}...`);
                    }
                }
                
                QQ_NewMsg["moment"] = count;
                QQ_SetNewTips(count);
                
                // *** æ–°å¢ï¼šè‡ªåŠ¨ä¿å­˜åŠ¨æ€å†…å®¹ ***
                if (QQ_MomentsData.length > 0) {
                    setTimeout(async () => {
                        await QQ_Save_Moments();
                        console.log('åŠ¨æ€è§£æå®Œæˆï¼Œå·²ä¿å­˜åˆ°ä¸–ç•Œä¹¦å¤‡ä»½');
                    }, 1000); // å»¶è¿Ÿä¿å­˜ï¼Œç¡®ä¿æ‰€æœ‰å¤„ç†å®Œæˆ
                }

                //ç‚¹èµè°ƒç”¨
                //if (typeof QQ_InitMomentLikes === 'function') {
                //    console.log('âœ… (æ¥è‡ª QQ_Moment_Parse) æ–°åŠ¨æ€å·²è§£æï¼Œé‡æ–°åˆå§‹åŒ–ç‚¹èµæŒ‰é’®äº‹ä»¶...');
                //    QQ_InitMomentLikes();
                //}

            }
            function QQ_GetRandomHead() {
                // ä½¿ç”¨æ–°çš„éšæœºå¤´åƒç³»ç»Ÿ
                console.log('QQ_GetRandomHead: é‡å®šå‘åˆ°æ–°çš„éšæœºå¤´åƒç³»ç»Ÿ');
                return QQ_GetRandomAvatar();
            }
            let Phone = [
                "å°ç±³",
                "åä¸º",
                "è‹¹æœ",
                "ä¸‰æ˜Ÿ",
                "é­…æ—",
                "ä¸€åŠ ",
                "oppo",
                "vivo",
                "çœŸæˆ‘",
                "çº¢ç±³",
            ];
            let Phone_lvl = ["pro", "max", "mate", "ultra", "plus"];
            function QQ_GetRandomPhone() {
                let name = Phone[Math.floor(Math.random() * Phone.length)];
                name += random(6, 19);
                let count = random(1, Phone_lvl.length);
                let a = [];
                for (let i = 0; i < count; i++) {
                    let randomresult = Phone_lvl[random(0, Phone_lvl.length)];
                    if (!a.includes(randomresult)) {
                        a.push(randomresult);
                    }
                }
                name += " " + a.join(" ");
                return name;
            }
                        /**
             * æ ¹æ®è§’è‰²åè·å–å¤´åƒURL
             * @param {string} name - è§’è‰²å
             * @returns {string} - å¤´åƒURLï¼Œå¦‚æœæ‰¾ä¸åˆ°åˆ™è¿”å›ç©ºå­—ç¬¦ä¸²
             */
             function GetCharHead(name) {
                // ç¡®ä¿ QQ_Char å¯¹è±¡å­˜åœ¨ï¼Œå¹¶ä¸”åŒ…å«è¯¥è§’è‰²çš„ä¿¡æ¯å’Œå¤´åƒ
                if (typeof QQ_Char !== 'undefined' && QQ_Char[name] && QQ_Char[name].head) {
                    return QQ_Char[name].head;
                }
                // å¦‚æœæ‰¾ä¸åˆ°ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²ï¼Œè®©åç»­é€»è¾‘å¤„ç†é»˜è®¤å¤´åƒ
                return "";
            }
            
            /**
             * è§£æå¹¶è·å–éšæœºå¤´åƒåˆ—è¡¨
             * @returns {Array} - å¤´åƒURLæ•°ç»„
             */
            function QQ_GetRandomAvatarList() {
                if (typeof _raw_namespaceObject === 'undefined') {
                    console.warn('éšæœºå¤´åƒæ•°æ®æœªæ‰¾åˆ°');
                    return [];
                }
                
                // è§£æå¤´åƒåˆ—è¡¨ï¼ŒæŒ‰è¡Œåˆ†å‰²å¹¶è¿‡æ»¤ç©ºè¡Œ
                const avatars = _raw_namespaceObject
                    .split('\r\n')
                    .map(line => line.trim())
                    .filter(line => line && (line.startsWith('http://') || line.startsWith('https://')));
                
                console.log(`æˆåŠŸåŠ è½½ ${avatars.length} ä¸ªéšæœºå¤´åƒ`);
                return avatars;
            }
            
            /**
             * è·å–éšæœºå¤´åƒURL
             * @returns {string} - éšæœºé€‰æ‹©çš„å¤´åƒURL
             */
            function QQ_GetRandomAvatar() {
                const avatars = QQ_GetRandomAvatarList();
                if (avatars.length === 0) {
                    console.warn('æ²¡æœ‰å¯ç”¨çš„éšæœºå¤´åƒï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ');
                    return '';
                }
                
                const randomIndex = Math.floor(Math.random() * avatars.length);
                const selectedAvatar = avatars[randomIndex];
                console.log(`é€‰æ‹©éšæœºå¤´åƒ: ${selectedAvatar}`);
                return selectedAvatar;
            }
            
            /**
             * è·å–å¤´åƒURLï¼Œä¼˜å…ˆä½¿ç”¨è§’è‰²å¤´åƒï¼Œå¦åˆ™ä½¿ç”¨éšæœºå¤´åƒ
             * @param {string} name - è§’è‰²å
             * @returns {string} - å¤´åƒURL
             */
            function QQ_GetAvatarWithFallback(name) {
                // ä¼˜å…ˆå°è¯•è·å–è§’è‰²ä¸“ç”¨å¤´åƒ
                const charHead = GetCharHead(name);
                if (charHead) {
                    return charHead;
                }
                
                // å¦‚æœæ²¡æœ‰ä¸“ç”¨å¤´åƒï¼Œè¿”å›éšæœºå¤´åƒ
                return QQ_GetRandomAvatar();
            }
            
            /**
             * åº”ç”¨éšæœºå¤´åƒåˆ°æ‰€æœ‰ç¼ºå¤±å¤´åƒçš„å…ƒç´ 
             */
            function QQ_ApplyRandomAvatarsToDefaults() {
                console.log('å¼€å§‹åº”ç”¨éšæœºå¤´åƒåˆ°æ‰€æœ‰é»˜è®¤å¤´åƒå…ƒç´ ');
                
                // æŸ¥æ‰¾æ‰€æœ‰éœ€è¦è®¾ç½®å¤´åƒçš„å…ƒç´ ï¼ˆæ’é™¤ç”¨æˆ·å¤´åƒï¼‰
                const selectors = [
                    // '.user_avatar:not([style*="background-image"])', // *** ç§»é™¤ï¼šç”¨æˆ·å¤´åƒä¸åº”è¯¥è¢«éšæœºå¤´åƒç³»ç»Ÿå¤„ç† ***
                    '.QQ_home_head:not([style*="background-image"])',
                    '.head:not([style*="background-image"])'
                ];
                
                selectors.forEach(selector => {
                    const elements = document.querySelectorAll(selector);
                    console.log(`æ‰¾åˆ° ${elements.length} ä¸ªå…ƒç´ åŒ¹é…é€‰æ‹©å™¨: ${selector}`);
                    
                    elements.forEach((element, index) => {
                        // *** ä¼˜å…ˆæ£€æŸ¥æ˜¯å¦æœ‰è§’è‰²ä¸“ç”¨å¤´åƒ ***
                        const characterName = element.getAttribute('data-name');
                        let avatarToUse = null;
                        
                        if (characterName) {
                            const charHead = GetCharHead(characterName);
                            if (charHead && charHead.trim() !== '') {
                                avatarToUse = charHead;
                                console.log(`ä¸ºå…ƒç´  ${index + 1} ä½¿ç”¨è§’è‰²ä¸“ç”¨å¤´åƒ: ${avatarToUse}`);
                            }
                        }
                        
                        // å¦‚æœæ²¡æœ‰ä¸“ç”¨å¤´åƒï¼Œä½¿ç”¨éšæœºå¤´åƒ
                        if (!avatarToUse) {
                            avatarToUse = QQ_GetRandomAvatar();
                            if (avatarToUse) {
                                console.log(`ä¸ºå…ƒç´  ${index + 1} ä½¿ç”¨éšæœºå¤´åƒ: ${avatarToUse}`);
                            }
                        }
                        
                        if (avatarToUse) {
                            element.style.backgroundImage = `url('${avatarToUse}')`;
                            element.style.backgroundSize = 'cover';
                            element.style.backgroundPosition = 'center';
                        }
                    });
                });
            }
            
            /**
             * ä¸ºæŒ‡å®šå…ƒç´ è®¾ç½®éšæœºå¤´åƒï¼ˆå¦‚æœè¿˜æ²¡æœ‰å¤´åƒï¼‰
             * @param {Element} element - è¦è®¾ç½®å¤´åƒçš„å…ƒç´ 
             * @param {string} characterName - è§’è‰²åç§°ï¼ˆå¯é€‰ï¼Œç”¨äºä¼˜å…ˆè·å–ä¸“ç”¨å¤´åƒï¼‰
             */
            function QQ_SetRandomAvatarIfEmpty(element, characterName = null) {
                if (!element) return;
                
                // æ£€æŸ¥å…ƒç´ æ˜¯å¦å·²ç»æœ‰å¤´åƒ
                const hasBackground = element.style.backgroundImage && 
                                    element.style.backgroundImage !== 'none' && 
                                    element.style.backgroundImage !== '';
                
                if (!hasBackground) {
                    const avatarUrl = characterName ? 
                        QQ_GetAvatarWithFallback(characterName) : 
                        QQ_GetRandomAvatar();
                        
                    if (avatarUrl) {
                        element.style.backgroundImage = `url('${avatarUrl}')`;
                        element.style.backgroundSize = 'cover';
                        element.style.backgroundPosition = 'center';
                        console.log(`ä¸ºå…ƒç´ è®¾ç½®${characterName ? 'è§’è‰²ä¸“ç”¨' : 'éšæœº'}å¤´åƒ: ${avatarUrl}`);
                    }
                }
            }
            
            /**
             * ç¡®ä¿è§’è‰²æœ‰å¤´åƒè®¾ç½®ï¼Œç‰¹åˆ«æ˜¯AIè‡ªåˆ›è§’è‰²æˆ–æœªçŸ¥è§’è‰²
             * @param {string} characterName - è§’è‰²åç§°
             */
            function QQ_EnsureCharacterAvatar(characterName) {
                console.log(`ğŸ­ æ£€æŸ¥è§’è‰²å¤´åƒè®¾ç½®: ${characterName}`);
                
                // *** æ›´ä¸¥æ ¼çš„å¤´åƒæ£€æŸ¥ï¼šåŒ…æ‹¬ QQ_Char å’Œå…¶ä»–å¯èƒ½çš„å¤´åƒæ¥æº ***
                
                // 1. æ£€æŸ¥ QQ_Char è§’è‰²æ•°æ®
                if (typeof QQ_Char !== 'undefined' && QQ_Char[characterName] && QQ_Char[characterName].head) {
                    console.log(`âœ… è§’è‰² ${characterName} åœ¨ QQ_Char ä¸­å·²æœ‰å¤´åƒè®¾ç½®`);
                    return;
                }
                
                // 2. æ£€æŸ¥ GetCharHead å‡½æ•°è¿”å›
                const charHead = GetCharHead(characterName);
                if (charHead && charHead.trim() !== '') {
                    console.log(`âœ… è§’è‰² ${characterName} é€šè¿‡ GetCharHead å·²æœ‰å¤´åƒè®¾ç½®: ${charHead}`);
                    return;
                }
                
                // 3. æ£€æŸ¥ Npc_Settings ä¸­æ˜¯å¦æœ‰å¤´åƒ
                if (typeof Npc_Settings !== 'undefined' && 
                    Npc_Settings[characterName] && 
                    Npc_Settings[characterName].head &&
                    Npc_Settings[characterName].head.trim() !== '') {
                    console.log(`âœ… è§’è‰² ${characterName} åœ¨ Npc_Settings ä¸­å·²æœ‰å¤´åƒ`);
                    return;
                }
                
                // 4. æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰CSSè§„åˆ™ä¸ºè¯¥è§’è‰²è®¾ç½®äº†å¤´åƒ
                const existingElements = $(`.head[data-name='${characterName}']`);
                let hasValidAvatar = false;
                existingElements.each(function() {
                    const bgImage = $(this).css('background-image');
                    if (bgImage && bgImage !== 'none' && bgImage !== '' && !bgImage.includes('data:image/svg+xml')) {
                        hasValidAvatar = true;
                        return false; // è·³å‡º each å¾ªç¯
                    }
                });
                
                if (hasValidAvatar) {
                    console.log(`âœ… è§’è‰² ${characterName} çš„å¤´åƒå…ƒç´ å·²æœ‰æœ‰æ•ˆèƒŒæ™¯å›¾ç‰‡`);
                    return;
                }
                
                // *** åªæœ‰åœ¨ç¡®è®¤æ²¡æœ‰ä»»ä½•å¤´åƒè®¾ç½®çš„æƒ…å†µä¸‹ï¼Œæ‰åˆ†é…éšæœºå¤´åƒ ***
                console.log(`ğŸ”§ è§’è‰² ${characterName} ç¡®å®æ²¡æœ‰å¤´åƒï¼Œå¼€å§‹è®¾ç½®éšæœºå¤´åƒ`);
                const randomAvatar = QQ_GetRandomAvatar();
                if (randomAvatar) {
                    // å¦‚æœ Npc_Settings å­˜åœ¨ï¼Œæ·»åŠ åˆ°å…¶ä¸­ï¼ˆä½†ä¸ä½¿ç”¨ !importantï¼‰
                    if (typeof Npc_Settings !== 'undefined') {
                        if (!Npc_Settings[characterName]) {
                            Npc_Settings[characterName] = {};
                        }
                        Npc_Settings[characterName].head = randomAvatar;
                        console.log(`ğŸ­ ä¸ºè§’è‰² ${characterName} åœ¨ Npc_Settings ä¸­è®¾ç½®éšæœºå¤´åƒ: ${randomAvatar}`);
                    }
                    
                    // *** é‡è¦ä¿®æ”¹ï¼šä¸ä½¿ç”¨ !importantï¼Œè®©åŸæœ¬çš„å¤´åƒè®¾ç½®ä¼˜å…ˆ ***
                    const style = document.createElement('style');
                    style.textContent = `.head[data-name='${characterName}'] { background-image: url('${randomAvatar}'); }`;
                    document.head.appendChild(style);
                    console.log(`ğŸ­ ä¸ºè§’è‰² ${characterName} åˆ›å»ºCSSå¤´åƒè§„åˆ™ï¼ˆä½ä¼˜å…ˆçº§ï¼‰: ${randomAvatar}`);
                    
                    // ç«‹å³åº”ç”¨åˆ°ç°æœ‰çš„ç©ºç™½å¤´åƒå…ƒç´ ï¼ˆåªå¯¹ç©ºç™½çš„åº”ç”¨ï¼‰
                    $(`.head[data-name='${characterName}']`).each(function() {
                        const currentBg = $(this).css('background-image');
                        if (!currentBg || currentBg === 'none' || currentBg === '' || currentBg.includes('data:image/svg+xml')) {
                            $(this).css('background-image', `url('${randomAvatar}')`);
                            console.log(`ğŸ­ ä¸ºç©ºç™½å¤´åƒå…ƒç´ åº”ç”¨éšæœºå¤´åƒ: ${randomAvatar}`);
                        } else {
                            console.log(`âœ… å¤´åƒå…ƒç´ å·²æœ‰èƒŒæ™¯å›¾ç‰‡ï¼Œä¿æŒä¸å˜: ${currentBg}`);
                        }
                    });
                } else {
                    console.warn(`âš ï¸ æ— æ³•ä¸ºè§’è‰² ${characterName} è·å–éšæœºå¤´åƒ`);
                }
            }
            
            /**
             * æ‰«æå¹¶ä¿®å¤æ‰€æœ‰å¯èƒ½çš„ç©ºç™½å¤´åƒ
             */
            function QQ_ScanAndFixAllAvatars() {
                console.log('ğŸ” å¼€å§‹æ‰«ææ‰€æœ‰å¤´åƒå…ƒç´ ...');
                
                // æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„å¤´åƒå…ƒç´ é€‰æ‹©å™¨ï¼ˆæ’é™¤ç”¨æˆ·å¤´åƒï¼‰
                const avatarSelectors = [
                    '.head',
                    '.QQ_chat_head',
                    '.QQ_home_head',
                    // '.user_avatar', // *** ç§»é™¤ï¼šç”¨æˆ·å¤´åƒä¸åº”è¯¥è¢«éšæœºå¤´åƒç³»ç»Ÿå¤„ç† ***
                    // '.Chat_MyHead', // *** ç§»é™¤ï¼šç”¨æˆ·èŠå¤©å¤´åƒä¸åº”è¯¥è¢«éšæœºå¤´åƒç³»ç»Ÿå¤„ç† ***
                    '.discord-thread-content-original-author-head'
                ];
                
                let fixedCount = 0;
                
                avatarSelectors.forEach(selector => {
                    $(selector).each(function() {
                        const $element = $(this);
                        const characterName = $element.attr('data-name');
                        
                        // *** ä¸¥æ ¼æ£€æŸ¥ï¼šåªæœ‰çœŸæ­£ç©ºç™½çš„æ‰ä¿®å¤ ***
                        const bgImage = $element.css('background-image');
                        const hasValidBg = bgImage && 
                                         bgImage !== 'none' && 
                                         bgImage !== '' && 
                                         bgImage !== 'initial' &&
                                         !bgImage.includes('data:image/svg+xml'); // æ’é™¤é»˜è®¤SVGå ä½ç¬¦
                        
                        // *** å¦‚æœæœ‰è§’è‰²åï¼Œå…ˆæ£€æŸ¥è¯¥è§’è‰²æ˜¯å¦åº”è¯¥æœ‰ä¸“ç”¨å¤´åƒ ***
                        if (characterName && hasValidBg) {
                            // å¦‚æœå·²ç»æœ‰æœ‰æ•ˆèƒŒæ™¯å›¾ç‰‡ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯éšæœºå¤´åƒè¦†ç›–äº†ä¸“ç”¨å¤´åƒ
                            const charHead = GetCharHead(characterName);
                            if (charHead && charHead.trim() !== '' && !bgImage.includes(charHead)) {
                                // å‘ç°ä¸“ç”¨å¤´åƒè¢«éšæœºå¤´åƒè¦†ç›–ï¼Œæ¢å¤ä¸“ç”¨å¤´åƒ
                                console.log(`ğŸ”„ æ¢å¤è§’è‰² ${characterName} çš„ä¸“ç”¨å¤´åƒ: ${charHead}`);
                                $element.css({
                                    'background-image': `url('${charHead}')`,
                                    'background-size': 'cover',
                                    'background-position': 'center'
                                });
                                return; // è·³è¿‡åç»­å¤„ç†
                            }
                        }
                        
                        // *** åªæœ‰åœ¨ç¡®å®æ²¡æœ‰æœ‰æ•ˆèƒŒæ™¯å›¾ç‰‡çš„æƒ…å†µä¸‹æ‰åº”ç”¨éšæœºå¤´åƒ ***
                        if (!hasValidBg) {
                            console.log(`ğŸ”§ å‘ç°ç©ºç™½å¤´åƒå…ƒç´ : ${selector}${characterName ? ` (è§’è‰²: ${characterName})` : ''}`);
                            
                            // å¦‚æœæœ‰è§’è‰²åï¼Œå…ˆå°è¯•è·å–ä¸“ç”¨å¤´åƒ
                            let avatarToUse = null;
                            if (characterName) {
                                const charHead = GetCharHead(characterName);
                                if (charHead && charHead.trim() !== '') {
                                    avatarToUse = charHead;
                                    console.log(`âœ… ä½¿ç”¨è§’è‰²ä¸“ç”¨å¤´åƒ: ${avatarToUse}`);
                                }
                            }
                            
                            // å¦‚æœæ²¡æœ‰ä¸“ç”¨å¤´åƒï¼Œä½¿ç”¨éšæœºå¤´åƒ
                            if (!avatarToUse) {
                                avatarToUse = QQ_GetRandomAvatar();
                                if (avatarToUse) {
                                    console.log(`ğŸ² ä½¿ç”¨éšæœºå¤´åƒ: ${avatarToUse}`);
                                }
                            }
                            
                            if (avatarToUse) {
                                $element.css({
                                    'background-image': `url('${avatarToUse}')`,
                                    'background-size': 'cover',
                                    'background-position': 'center'
                                });
                                fixedCount++;
                                console.log(`âœ… ä¸ºç©ºç™½å¤´åƒå…ƒç´ è®¾ç½®å¤´åƒ: ${avatarToUse}`);
                            }
                        }
                    });
                });
                
                console.log(`ğŸ­ å¤´åƒæ‰«æå®Œæˆï¼Œå…±ä¿®å¤ ${fixedCount} ä¸ªç©ºç™½å¤´åƒ`);
            }
            
            /**
             * éªŒè¯å¤´åƒä¼˜å…ˆçº§è®¾ç½®æ˜¯å¦æ­£ç¡®
             * @param {string} characterName - è¦éªŒè¯çš„è§’è‰²å
             */
            function QQ_ValidateAvatarPriority(characterName) {
                console.log(`ğŸ” éªŒè¯è§’è‰² ${characterName} çš„å¤´åƒä¼˜å…ˆçº§...`);
                
                // æ£€æŸ¥å„ç§å¤´åƒæ¥æº
                const sources = {
                    'QQ_Char': typeof QQ_Char !== 'undefined' && QQ_Char[characterName] && QQ_Char[characterName].head,
                    'GetCharHead': GetCharHead(characterName),
                    'Npc_Settings': typeof Npc_Settings !== 'undefined' && Npc_Settings[characterName] && Npc_Settings[characterName].head,
                    'DOM_CSS': $(`.head[data-name='${characterName}']`).css('background-image')
                };
                
                console.log(`ğŸ“Š è§’è‰² ${characterName} å¤´åƒæ¥æºçŠ¶æ€:`, sources);
                
                // éªŒè¯ä¼˜å…ˆçº§
                if (sources.QQ_Char) {
                    console.log(`âœ… ä½¿ç”¨ QQ_Char ä¸­çš„ä¸“ç”¨å¤´åƒ: ${sources.QQ_Char}`);
                } else if (sources.GetCharHead) {
                    console.log(`âœ… ä½¿ç”¨ GetCharHead è¿”å›çš„å¤´åƒ: ${sources.GetCharHead}`);
                } else if (sources.Npc_Settings) {
                    console.log(`âœ… ä½¿ç”¨ Npc_Settings ä¸­çš„å¤´åƒ: ${sources.Npc_Settings}`);
                } else {
                    console.log(`âš ï¸ è§’è‰² ${characterName} æ²¡æœ‰ä¸“ç”¨å¤´åƒï¼Œåº”ä½¿ç”¨éšæœºå¤´åƒ`);
                }
                
                return sources;
            }
            
             /**
             * æ ¸å¿ƒæ¶ˆæ¯æ¸²æŸ“å‡½æ•° - ç»Ÿä¸€çš„æ¶ˆæ¯DOMåˆ›å»ºå’Œæ·»åŠ é€»è¾‘
             * @param {*} dom - èŠå¤©å®¹å™¨ DOM
             * @param {*} messageContent - å¤„ç†åçš„æ¶ˆæ¯å†…å®¹
             * @param {*} sender - å‘é€è€…åç§°
             * @param {*} name - èŠå¤©åç§°
             * @param {*} isUser - æ˜¯å¦ä¸ºç”¨æˆ·æ¶ˆæ¯
             */
            function QQ_RenderMessageToDOM(dom, messageContent, sender, name, isUser) {
                let messageHtml;
                
                if (isUser) {
                    // ç”¨æˆ·æ¶ˆæ¯ - ä½¿ç”¨ç”¨æˆ·æ¶ˆæ¯æ¨¡æ¿ï¼ˆå³ä¾§æ°”æ³¡ï¼Œç”¨æˆ·å¤´åƒï¼‰
                    const specialContent = QQ_Chat_SpecialMsg(messageContent, sender, QQ_Groups.includes(name), true);
                    messageHtml = _.template(chat_user_message)({
                        content: specialContent || messageContent
                    });
                    console.log('ä½¿ç”¨ç”¨æˆ·æ¶ˆæ¯æ¨¡æ¿');
                } else {
                    // è§’è‰²æ¶ˆæ¯ - ä½¿ç”¨è§’è‰²æ¶ˆæ¯æ¨¡æ¿ï¼ˆå·¦ä¾§æ°”æ³¡ï¼Œè§’è‰²å¤´åƒï¼‰
                    const specialContent = QQ_Chat_SpecialMsg(messageContent, sender, QQ_Groups.includes(name), false);
                    messageHtml = _.template(chat_char_msg)({
                        content: specialContent || messageContent,
                        name: sender,
                        isgroup: QQ_Groups.includes(name)
                    });
                    console.log('ä½¿ç”¨è§’è‰²æ¶ˆæ¯æ¨¡æ¿ï¼Œè§’è‰²å:', sender);
                }
                
                // æ·»åŠ åˆ°èŠå¤©ç•Œé¢
                $(dom).append(messageHtml);
                console.log(`æ¶ˆæ¯å·²æ·»åŠ åˆ°DOM: ${sender}: ${messageContent}`);
                
                // *** æ–°å¢ï¼šç¡®ä¿è§’è‰²å¤´åƒè®¾ç½® ***
                if (!isUser) {
                    QQ_EnsureCharacterAvatar(sender);
                }
                
                // å¦‚æœæ˜¯ç”¨æˆ·æ¶ˆæ¯ï¼Œå¯åŠ¨çŠ¶æ€æ¨¡æ‹Ÿå’Œé•¿æŒ‰åŠŸèƒ½
                if (isUser) {
                    const lastMessage = $(dom).children().last()[0];
                    if (lastMessage) {
                        QQ_SimulateMessageStatusChange(lastMessage);
                        QQ_AddLongPressHandler(lastMessage, messageContent, name);
                    }
                }
                
                return $(dom).children().last()[0]; // è¿”å›æ·»åŠ çš„æ¶ˆæ¯å…ƒç´ 
            }

            /**
             * èŠå¤©-æ·»åŠ æ–°æ¶ˆæ¯
             * @param {*} dom - æ¶ˆæ¯å†…å®¹å®¹å™¨çš„DOMå…ƒç´ 
             * @param {*} content - æ¶ˆæ¯å†…å®¹å­—ç¬¦ä¸²
             * @param {*} name - è§’è‰²/ç¾¤èŠåç§°
             * @param {*} isNew - æ˜¯å¦ä¸ºæ–°æ¶ˆæ¯
             * @param {*} skipScrollAndCount - æ˜¯å¦è·³è¿‡æ»šåŠ¨å’Œè®¡æ•°
             * @param {*} skipStreamingCheck - æ˜¯å¦è·³è¿‡æµå¼æ£€æŸ¥ï¼ˆé¿å…é‡å¤æµå¼å¤„ç†ï¼‰
             */
            async function QQ_Chat_AddMsg(dom, content, name, isNew, skipScrollAndCount = false, skipStreamingCheck = false) {
                console.log(`QQ_Chat_AddMsg: æ·»åŠ æ¶ˆæ¯ "${content}" åˆ°èŠå¤©é¡µé¢ "${name}", isNew: ${isNew}`);
                
                // *** åˆ†é¡µæ§åˆ¶ï¼šæ£€æŸ¥å½“å‰æ¶ˆæ¯æ•°é‡ ***
                if (!skipScrollAndCount) {
                    const chatKey = name;
                    if (!chatDisplayCounts[chatKey]) {
                        chatDisplayCounts[chatKey] = 0;
                    }
                    
                    // è·å–å½“å‰èŠå¤©å®¹å™¨ä¸­çš„æ¶ˆæ¯æ•°é‡
                    const currentMsgCount = $(dom).children().not('.load-more-messages').length;
                    if (currentMsgCount >= CHAT_DISPLAY_LIMIT && isNew) {
                        // å¦‚æœå·²è¾¾ä¸Šé™ä¸”æ˜¯æ–°æ¶ˆæ¯ï¼Œç§»é™¤æœ€æ—§çš„æ¶ˆæ¯
                        $(dom).children().not('.load-more-messages').first().remove();
                        chatDisplayCounts[chatKey] = CHAT_DISPLAY_LIMIT - 1;
                    }
                }
                
                // *** æ ¸å¿ƒæ”¹é€ ï¼šåˆ¤æ–­æ˜¯å¦ä¸ºç³»ç»Ÿæ¶ˆæ¯ ***
                if (content.startsWith("ç³»ç»Ÿæ¶ˆæ¯--")) {
                    const sysMsgText = content.split("--")[2]; // æå–çœŸå®çš„æ¶ˆæ¯å†…å®¹
                    
                    // *** æ–°å¢ï¼šæ£€æµ‹äº’åŠ¨å†…å®¹å ä½ç¬¦ ***
                    const interactiveMatch = sysMsgText.match(/\[å‘ç”Ÿäº†ä¸€æ®µäº’åŠ¨ \(ID: (.+?)\)\]/);
                    if (interactiveMatch) {
                        const interactiveId = interactiveMatch[1];
                        console.log(`ğŸ­ ç³»ç»Ÿæ¶ˆæ¯ä¸­æ£€æµ‹åˆ°äº’åŠ¨å†…å®¹å ä½ç¬¦: ${interactiveId}`);
                        
                        // *** ä¿®å¤ï¼šé˜²æ­¢é‡å¤åˆ›å»ºï¼Œæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥IDçš„å ä½ç¬¦ ***
                        // åŒæ—¶æ£€æŸ¥å…¨å±€å·²å¤„ç†IDé›†åˆ
                        if ($(dom).find(`[data-id="${interactiveId}"]`).length === 0 && !window.QQ_ProcessedInteractiveIds?.has(interactiveId)) {
                            // æ·»åŠ åˆ°å…¨å±€å·²å¤„ç†é›†åˆ
                            if (!window.QQ_ProcessedInteractiveIds) {
                                window.QQ_ProcessedInteractiveIds = new Set();
                            }
                            window.QQ_ProcessedInteractiveIds.add(interactiveId);
                            // åˆ›å»ºå¯ç‚¹å‡»çš„äº’åŠ¨å†…å®¹å ä½ç¬¦ï¼ˆä¸æ˜¾ç¤ºIDï¼‰
                            const interactiveDiv = $(`
                                <div class="interactive-placeholder" data-id="${interactiveId}" style="
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    color: white;
                                    padding: 8px 12px;
                                    margin: 5px 0;
                                    border-radius: 15px;
                                    text-align: center;
                                    cursor: pointer;
                                    font-size: 13px;
                                    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
                                    transition: all 0.3s ease;
                                ">
                                    âœ¨ [å‘ç”Ÿäº†ä¸€æ®µäº’åŠ¨]
                                    <div style="font-size: 11px; opacity: 0.8; margin-top: 2px;">ç‚¹å‡»å±•å¼€äº’åŠ¨å†…å®¹</div>
                                </div>
                            `);
                            
                            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ä»¥åŠ è½½å’Œæ˜¾ç¤ºäº’åŠ¨å†…å®¹
                            interactiveDiv.on('click', async function() {
                                const id = $(this).data('id');
                                console.log(`ğŸ“– ç”¨æˆ·ç‚¹å‡»äº’åŠ¨å ä½ç¬¦: ${id}`);
                                
                                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                                $(this).html('ğŸ”„ æ­£åœ¨åŠ è½½äº’åŠ¨å†…å®¹...');
                                
                                try {
                                    // ä»ä¸–ç•Œä¹¦åŠ è½½ç‰¹å®šçš„äº’åŠ¨å†…å®¹
                                    const interactiveContent = await QQ_LoadInteractiveContentFromWorldBook(id);
                                    if (interactiveContent && interactiveContent.content) {
                                        // åœ¨å ä½ç¬¦ä¸‹æ–¹å±•å¼€æ˜¾ç¤ºäº’åŠ¨å†…å®¹
                                        const expandedDiv = QQ_CreateExpandedInteractiveDisplay(interactiveContent.content, id);
                                        $(this).after(expandedDiv);
                                        $(this).html('âœ… äº’åŠ¨å†…å®¹å·²å±•å¼€');
                                        $(this).off('click'); // ç§»é™¤ç‚¹å‡»äº‹ä»¶ï¼Œé˜²æ­¢é‡å¤å±•å¼€
                                    } else {
                                        $(this).html('âŒ äº’åŠ¨å†…å®¹åŠ è½½å¤±è´¥');
                                        console.error(`æœªæ‰¾åˆ°äº’åŠ¨å†…å®¹: ${id}`);
                                    }
                                } catch (error) {
                                    $(this).html('âŒ äº’åŠ¨å†…å®¹åŠ è½½å‡ºé”™');
                                    console.error('åŠ è½½äº’åŠ¨å†…å®¹æ—¶å‡ºé”™:', error);
                                }
                            });
                            
                            $(dom).append(interactiveDiv);
                        } else {
                            console.log(`âš ï¸ äº’åŠ¨å†…å®¹å ä½ç¬¦å·²å¤„ç†è¿‡æˆ–å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º: ${interactiveId}`);
                        }
                    } else {
                        // æ™®é€šç³»ç»Ÿæ¶ˆæ¯
                        const msgDiv = $("<div>", { class: "system-message" }).text(sysMsgText);
                        $(dom).append(msgDiv);
                    }
                } else {
                    // --- ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„æ¨¡æ¿ç³»ç»Ÿ ---
                    let sp = content.split("--");
                    
                    if (sp.length < 2) {
                        console.log(`æ¶ˆæ¯æ ¼å¼ä¸æ­£ç¡®: ${content}`);
                        return;
                    }
                    
                    const originalSender = sp[0];
                    const messageContent = sp[1];
                    const timestamp = sp.length >= 3 ? sp[2] : "";
                    
                    // åº”ç”¨åç§°è§„èŒƒåŒ–ï¼ˆé™¤éæ˜¯ç”¨æˆ·æœ¬äººï¼‰
                    const sender = originalSender === UserName ? originalSender : QQ_NormalizeCharacterName(originalSender);
                    
                    console.log(`æ¶ˆæ¯å‘é€è€…: ${sender}, å†…å®¹: ${messageContent}, æ—¶é—´: ${timestamp}`);
                    if (originalSender !== sender) {
                        console.log(`ğŸ”§ å‘é€è€…åç§°å·²è§„èŒƒåŒ–: "${originalSender}" -> "${sender}"`);
                    }
                    
                    // *** ä¿®å¤ï¼šæ£€æµ‹äº’åŠ¨å†…å®¹å ä½ç¬¦ï¼ˆåœ¨æ™®é€šæ¶ˆæ¯ä¸­ï¼‰ ***
                    const interactiveMatch = messageContent.match(/\[å‘ç”Ÿäº†ä¸€æ®µäº’åŠ¨ \(ID: (.+?)\)\]/);
                    if (interactiveMatch) {
                        const interactiveId = interactiveMatch[1];
                        console.log(`ğŸ­ åœ¨æ™®é€šæ¶ˆæ¯ä¸­æ£€æµ‹åˆ°äº’åŠ¨å†…å®¹å ä½ç¬¦: ${interactiveId}`);
                        
                        // *** ä¿®å¤ï¼šé˜²æ­¢é‡å¤åˆ›å»ºï¼Œæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥IDçš„å ä½ç¬¦ ***
                        // åŒæ—¶æ£€æŸ¥å…¨å±€å·²å¤„ç†IDé›†åˆ
                        if ($(dom).find(`[data-id="${interactiveId}"]`).length > 0 || window.QQ_ProcessedInteractiveIds?.has(interactiveId)) {
                            console.log(`âš ï¸ äº’åŠ¨å†…å®¹å ä½ç¬¦å·²å­˜åœ¨æˆ–å·²å¤„ç†ï¼Œè·³è¿‡: ${interactiveId}`);
                            // ç»§ç»­å¤„ç†æ™®é€šæ¶ˆæ¯ä½†è·³è¿‡äº’åŠ¨å†…å®¹åˆ›å»º
                            const msgDiv = QQ_CreateMessageElement(sender, messageContent, timestamp, originalSender);
                            $(dom).append(msgDiv);
                            return;
                        }
                        
                        // æ·»åŠ åˆ°å…¨å±€å·²å¤„ç†é›†åˆ
                        if (!window.QQ_ProcessedInteractiveIds) {
                            window.QQ_ProcessedInteractiveIds = new Set();
                        }
                        window.QQ_ProcessedInteractiveIds.add(interactiveId);
                        
                        // *** ä¿®å¤ï¼šæ ‡è®°è¯¥èŠå¤©å·²è§¦å‘äº’åŠ¨å†…å®¹ï¼Œç¡®ä¿å¼€å…³æ˜¾ç¤º ***
                        console.log(`ğŸ­ æ ‡è®°èŠå¤© ${name} å·²è§¦å‘äº’åŠ¨å†…å®¹ï¼ˆä»æ™®é€šæ¶ˆæ¯æ£€æµ‹ï¼‰`);
                        QQ_InteractiveMode.markChatTriggered(name);
                        
                        // *** ä¿®å¤ï¼šå¼‚æ­¥åŠ è½½äº’åŠ¨å†…å®¹å¹¶æ¸²æŸ“ ***
                        (async () => {
                            try {
                                const interactiveContent = await QQ_LoadInteractiveContentFromWorldBook(interactiveId);
                                if (interactiveContent && interactiveContent.content) {
                                    console.log(`âœ… æˆåŠŸåŠ è½½äº’åŠ¨å†…å®¹ï¼Œåˆ›å»ºå¯å±•å¼€å ä½ç¬¦: ${interactiveId}`);
                                    
                                    // *** ä¿®å¤ï¼šåªåˆ›å»ºå ä½ç¬¦ï¼Œç‚¹å‡»æ—¶æ‰å±•å¼€å…·ä½“å†…å®¹ ***
                                    const interactivePlaceholder = $(`
                                        <div class="interactive-placeholder can-expand" data-id="${interactiveId}" style="
                                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                            color: white;
                                            padding: 8px 12px;
                                            margin: 5px 0;
                                            border-radius: 15px;
                                            text-align: center;
                                            cursor: pointer;
                                            font-size: 13px;
                                            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
                                            transition: all 0.3s ease;
                                        ">
                                            âœ¨ [å‘ç”Ÿäº†ä¸€æ®µäº’åŠ¨]
                                            <div style="font-size: 11px; opacity: 0.8; margin-top: 2px;">ç‚¹å‡»å±•å¼€äº’åŠ¨å†…å®¹</div>
                                        </div>
                                    `);
                                    
                                    $(dom).append(interactivePlaceholder);
                                    
                                    // *** ä¿®å¤ï¼šä¸ºå ä½ç¬¦æ·»åŠ å±•å¼€åŠŸèƒ½ ***
                                    interactivePlaceholder.on('click', async function() {
                                        $(this).html('ğŸ”„ æ­£åœ¨åŠ è½½äº’åŠ¨å†…å®¹...');
                                        try {
                                            const content = await QQ_LoadInteractiveContentFromWorldBook(interactiveId);
                                            if (content && content.content) {
                                                // åˆ›å»ºå±•å¼€çš„äº’åŠ¨å†…å®¹
                                                const expandedDiv = QQ_CreateExpandedInteractiveDisplay(content.content, interactiveId);
                                                
                                                // *** ä¿®å¤ï¼šç¡®ä¿èƒŒæ™¯æ ·å¼æ­£ç¡®åº”ç”¨ ***
                                                expandedDiv.attr('style', expandedDiv.attr('style') + '; background: rgba(102, 126, 234, 0.1) !important; background-color: rgba(102, 126, 234, 0.1) !important;');
                                                setTimeout(() => {
                                                    expandedDiv.css({
                                                        'background': 'rgba(102, 126, 234, 0.1)',
                                                        'background-color': 'rgba(102, 126, 234, 0.1)',
                                                        'border': '1px solid rgba(102, 126, 234, 0.3)'
                                                    });
                                                }, 50);
                                                
                                                $(this).after(expandedDiv);
                                                $(this).html('âœ… äº’åŠ¨å†…å®¹å·²å±•å¼€');
                                                $(this).addClass('expanded');
                                                $(this).off('click');
                                                
                                                // ç»‘å®šæ”¶èµ·äº‹ä»¶
                                                $(this).on('click', function() {
                                                    expandedDiv.slideUp(300, function() {
                                                        expandedDiv.remove();
                                                    });
                                                    $(this).html(`âœ¨ [å‘ç”Ÿäº†ä¸€æ®µäº’åŠ¨]<div style="font-size: 11px; opacity: 0.8; margin-top: 2px;">ç‚¹å‡»å±•å¼€äº’åŠ¨å†…å®¹</div>`);
                                                    $(this).removeClass('expanded');
                                                    
                                                    // é‡æ–°ç»‘å®šå±•å¼€äº‹ä»¶ï¼Œä½¿ç”¨ç›¸åŒçš„é€»è¾‘
                                                    const self = $(this);
                                                    $(this).off('click').on('click', async function() {
                                                        $(this).html('ğŸ”„ æ­£åœ¨åŠ è½½äº’åŠ¨å†…å®¹...');
                                                        try {
                                                            const content = await QQ_LoadInteractiveContentFromWorldBook(interactiveId);
                                                            if (content && content.content) {
                                                                const newExpandedDiv = QQ_CreateExpandedInteractiveDisplay(content.content, interactiveId);
                                                                newExpandedDiv.attr('style', newExpandedDiv.attr('style') + '; background: rgba(102, 126, 234, 0.1) !important; background-color: rgba(102, 126, 234, 0.1) !important;');
                                                                setTimeout(() => {
                                                                    newExpandedDiv.css({
                                                                        'background': 'rgba(102, 126, 234, 0.1)',
                                                                        'background-color': 'rgba(102, 126, 234, 0.1)',
                                                                        'border': '1px solid rgba(102, 126, 234, 0.3)'
                                                                    });
                                                                }, 50);
                                                                $(this).after(newExpandedDiv);
                                                                $(this).html('âœ… äº’åŠ¨å†…å®¹å·²å±•å¼€');
                                                                $(this).addClass('expanded');
                                                                $(this).off('click');
                                                                
                                                                // ç»‘å®šæ”¶èµ·äº‹ä»¶
                                                                $(this).on('click', function() {
                                                                    newExpandedDiv.slideUp(300, function() {
                                                                        newExpandedDiv.remove();
                                                                    });
                                                                    $(this).html(`âœ¨ [å‘ç”Ÿäº†ä¸€æ®µäº’åŠ¨]<div style="font-size: 11px; opacity: 0.8; margin-top: 2px;">ç‚¹å‡»å±•å¼€äº’åŠ¨å†…å®¹</div>`);
                                                                    $(this).removeClass('expanded');
                                                                });
                                                            } else {
                                                                $(this).html('âŒ äº’åŠ¨å†…å®¹åŠ è½½å¤±è´¥');
                                                            }
                                                        } catch (error) {
                                                            console.error('é‡æ–°åŠ è½½äº’åŠ¨å†…å®¹å¤±è´¥:', error);
                                                            $(this).html('âŒ äº’åŠ¨å†…å®¹åŠ è½½å¤±è´¥');
                                                        }
                                                    });
                                                });
                                            } else {
                                                $(this).html('âŒ äº’åŠ¨å†…å®¹åŠ è½½å¤±è´¥');
                                            }
                                        } catch (error) {
                                            console.error('åŠ è½½äº’åŠ¨å†…å®¹å¤±è´¥:', error);
                                            $(this).html('âŒ äº’åŠ¨å†…å®¹åŠ è½½å¤±è´¥');
                                        }
                                    });
                                    
                                    // ç§»é™¤ä¸´æ—¶å ä½ç¬¦
                                    $(dom).find(`.temp-placeholder[data-id="${interactiveId}"]`).remove();
                                    
                                    if (!skipScrollAndCount && isNew) {
                                        chatDisplayCounts[name] = (chatDisplayCounts[name] || 0) + 1;
                                        $(dom).scrollTop(dom.scrollHeight);
                                    }
                                } else {
                                    console.warn(`âš ï¸ äº’åŠ¨å†…å®¹åŠ è½½å¤±è´¥ï¼Œä¿æŒå ä½ç¬¦æ˜¾ç¤º: ${interactiveId}`);
                                    // å°†ä¸´æ—¶å ä½ç¬¦è½¬æ¢ä¸ºå¯ç‚¹å‡»å ä½ç¬¦
                                    const tempPlaceholder = $(dom).find(`.temp-placeholder[data-id="${interactiveId}"]`);
                                    if (tempPlaceholder.length > 0) {
                                        tempPlaceholder.removeClass('temp-placeholder').addClass('interactive-placeholder');
                                        tempPlaceholder.css('cursor', 'pointer');
                                        tempPlaceholder.append('<div style="font-size: 11px; opacity: 0.8; margin-top: 2px;">ç‚¹å‡»å±•å¼€äº’åŠ¨å†…å®¹</div>');
                                        
                                        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                                        tempPlaceholder.on('click', async function() {
                                            $(this).html('ğŸ”„ æ­£åœ¨åŠ è½½äº’åŠ¨å†…å®¹...');
                                            try {
                                                const content = await QQ_LoadInteractiveContentFromWorldBook(interactiveId);
                                                if (content && content.content) {
                                                    const expandedDiv = QQ_CreateExpandedInteractiveDisplay(content.content, interactiveId);
                                                    $(this).after(expandedDiv);
                                                    $(this).html('âœ… äº’åŠ¨å†…å®¹å·²å±•å¼€');
                                                    $(this).off('click');
                                                } else {
                                                    $(this).html('âŒ äº’åŠ¨å†…å®¹åŠ è½½å¤±è´¥');
                                                }
                                            } catch (error) {
                                                $(this).html('âŒ äº’åŠ¨å†…å®¹åŠ è½½å‡ºé”™');
                                                console.error('åŠ è½½äº’åŠ¨å†…å®¹æ—¶å‡ºé”™:', error);
                                            }
                                        });
                                    }
                                }
                            } catch (error) {
                                console.error('åŠ è½½äº’åŠ¨å†…å®¹æ—¶å‡ºé”™ï¼Œä¿æŒå ä½ç¬¦æ˜¾ç¤º:', error);
                            }
                        })();
                        
                        // å¦‚æœåŠ è½½å¤±è´¥ï¼Œåˆ›å»ºå ä½ç¬¦ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
                        const interactiveDiv = $(`
                            <div class="interactive-placeholder" data-id="${interactiveId}" style="
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                color: white;
                                padding: 8px 12px;
                                margin: 5px 0;
                                border-radius: 15px;
                                text-align: center;
                                cursor: pointer;
                                font-size: 13px;
                                box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
                                transition: all 0.3s ease;
                            ">
                                âœ¨ [å‘ç”Ÿäº†ä¸€æ®µäº’åŠ¨]
                                <div style="font-size: 11px; opacity: 0.8; margin-top: 2px;">ç‚¹å‡»å±•å¼€äº’åŠ¨å†…å®¹</div>
                            </div>
                        `);
                        
                        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                        interactiveDiv.on('click', async function() {
                            $(this).html('ğŸ”„ æ­£åœ¨åŠ è½½äº’åŠ¨å†…å®¹...');
                            try {
                                const content = await QQ_LoadInteractiveContentFromWorldBook(interactiveId);
                                if (content && content.content) {
                                    const expandedDiv = QQ_CreateExpandedInteractiveDisplay(content.content, interactiveId);
                                    $(this).after(expandedDiv);
                                    $(this).html('âœ… äº’åŠ¨å†…å®¹å·²å±•å¼€');
                                    $(this).off('click');
                                } else {
                                    $(this).html('âŒ äº’åŠ¨å†…å®¹åŠ è½½å¤±è´¥');
                                }
                            } catch (error) {
                                $(this).html('âŒ äº’åŠ¨å†…å®¹åŠ è½½å‡ºé”™');
                                console.error('åŠ è½½äº’åŠ¨å†…å®¹æ—¶å‡ºé”™:', error);
                            }
                        });
                        
                        $(dom).append(interactiveDiv);
                        
                        // è·³è¿‡åç»­çš„æ™®é€šæ¶ˆæ¯å¤„ç†
                        if (!skipScrollAndCount && isNew) {
                            chatDisplayCounts[name] = (chatDisplayCounts[name] || 0) + 1;
                            $(dom).scrollTop(dom.scrollHeight);
                        }
                        return;
                    }
                    
                    // *** é˜¶æ®µä¸€ï¼šæµå¼æ¶ˆæ¯åˆ†å‰²ä¸æ™ºèƒ½æ˜¾ç¤º ***
                    // åªæœ‰åœ¨æœªè·³è¿‡æµå¼æ£€æŸ¥æ—¶æ‰è¿›è¡Œæ¶ˆæ¯åˆ†å‰²
                    if (!skipStreamingCheck) {
                        const messageParts = QQ_SplitLongMessage(messageContent);
                        if (messageParts.length > 1) {
                            console.log(`ğŸŒŠ æ£€æµ‹åˆ°æµå¼æ¶ˆæ¯åˆ†å‰²ï¼š${messageParts.length}æ¡å­æ¶ˆæ¯ï¼Œå¯åŠ¨æµå¼æ˜¾ç¤º`);
                            
                            // ä½¿ç”¨æ–°çš„æµå¼æ˜¾ç¤ºç³»ç»Ÿï¼Œæ”¯æŒéšæœºå»¶è¿Ÿå’Œ"æ­£åœ¨è¾“å…¥..."åŠ¨ç”»
                            QQ_DisplayStreamingMessages(dom, messageParts, sender, name, isNew, skipScrollAndCount);
                            
                            // æµå¼æ¶ˆæ¯å¤„ç†å®Œæˆï¼Œç›´æ¥è¿”å›
                            return;
                        }
                    }
                    
                    // åˆ¤æ–­æ˜¯å¦ä¸ºç”¨æˆ·æ¶ˆæ¯
                    const isUser = sender == `${UserName}`;
                    
                    // ä½¿ç”¨ç»Ÿä¸€çš„æ¶ˆæ¯æ¸²æŸ“å‡½æ•°
                    const messageElement = QQ_RenderMessageToDOM(dom, messageContent, sender, name, isUser);
                }
                
                // æ›´æ–°æ˜¾ç¤ºè®¡æ•°
                if (!skipScrollAndCount) {
                    const chatKey = name;
                    chatDisplayCounts[chatKey] = $(dom).children().not('.load-more-messages').length;
                }
                             
                // æ™ºèƒ½æ»šåŠ¨ï¼šåªæœ‰ç”¨æˆ·å·²ç»åœ¨åº•éƒ¨æ—¶æ‰æ»šåŠ¨ï¼Œé¿å…æ‰“æ–­ç”¨æˆ·é˜…è¯»
                if (!skipScrollAndCount && dom && dom.scrollHeight) {
                    // *** ä¿®å¤ï¼šä½¿ç”¨æ›´å¯é çš„åº•éƒ¨æ£€æµ‹é€»è¾‘ ***
                    const $dom = $(dom);
                    const scrollTop = $dom.scrollTop();
                    const containerHeight = $dom.height();
                    const scrollHeight = dom.scrollHeight;
                    
                    // æ”¾å®½åº•éƒ¨æ£€æµ‹èŒƒå›´ï¼Œå¹¶å¢åŠ å¼ºåˆ¶æ»šåŠ¨æ¡ä»¶
                    const isNearBottom = scrollTop + containerHeight >= scrollHeight - 100;
                    const shouldScroll = isNearBottom || isNew;
                    
                    if (shouldScroll) {
                        // *** ä½¿ç”¨æ›´å¯é çš„æ»šåŠ¨æ–¹æ³• ***
                        setTimeout(() => {
                            $dom.scrollTop(dom.scrollHeight);
                            console.log(`èŠå¤©åŒºåŸŸå·²æ»šåŠ¨åˆ°åº•éƒ¨ (scrollHeight: ${dom.scrollHeight})`);
                        }, 10); // å°å»¶è¿Ÿç¡®ä¿DOMæ›´æ–°å®Œæˆ
                    } else {
                        console.log(`ç”¨æˆ·æ­£åœ¨æŸ¥çœ‹å†å²æ¶ˆæ¯ï¼Œè·³è¿‡è‡ªåŠ¨æ»šåŠ¨ (scrollTop: ${scrollTop}, near bottom: ${isNearBottom})`);
                    }
                }
            }
            
            /**
             * æ¨¡æ‹Ÿæ¶ˆæ¯çŠ¶æ€å˜åŒ–ï¼šå·²å‘é€(1ç§’) -> å·²é€è¾¾(1-3ç§’) -> å·²è¯»(3-60ç§’ï¼Œæœ¬ç¦ç‰¹å®šå¾‹åˆ†å¸ƒ)
             * @param {Element} messageElement - æ¶ˆæ¯å…ƒç´ 
             */
            function QQ_SimulateMessageStatusChange(messageElement) {
                const statusElement = messageElement.querySelector('.message-status');
                if (!statusElement) {
                    console.log('âŒ æ‰¾ä¸åˆ°çŠ¶æ€å…ƒç´ ');
                    return;
                }
                
                console.log('ğŸ”„ å¼€å§‹æ¨¡æ‹Ÿæ¶ˆæ¯çŠ¶æ€å˜åŒ–');
                
                // ç¬¬ä¸€é˜¶æ®µï¼š1ç§’åæ˜¾ç¤º"å·²é€è¾¾"
                setTimeout(() => {
                    // æ£€æŸ¥æ˜¯å¦æ­£åœ¨ç”ŸæˆAIå›å¤ï¼Œé¿å…åœ¨ç­‰å¾…æœŸé—´æ›´æ–°çŠ¶æ€
                    if (typeof gening !== 'undefined' && gening) {
                        console.log('ğŸ”„ AIç”Ÿæˆä¸­ï¼Œå»¶è¿Ÿå·²é€è¾¾çŠ¶æ€æ›´æ–°');
                        // å»¶è¿Ÿåˆ°AIç”Ÿæˆå®Œæˆåå†æ›´æ–°
                        const checkInterval = setInterval(() => {
                            if (!gening) {
                                clearInterval(checkInterval);
                                QQ_UpdateMessageStatus(statusElement, 'å·²é€è¾¾', 'âœ“', '#87ceeb');
                            }
                        }, 500);
                        return;
                    }
                    QQ_UpdateMessageStatus(statusElement, 'å·²é€è¾¾', 'âœ“', '#87ceeb');
                }, 1000);
                
                // ç¬¬äºŒé˜¶æ®µï¼š1-3ç§’åæ˜¾ç¤º"å·²é€è¾¾"ï¼ˆåŒå‹¾ï¼‰
                const deliveredDelay = Math.random() * 2000 + 1000; // 1-3ç§’
                setTimeout(() => {
                    // æ£€æŸ¥æ˜¯å¦æ­£åœ¨ç”ŸæˆAIå›å¤ï¼Œé¿å…åœ¨ç­‰å¾…æœŸé—´æ›´æ–°çŠ¶æ€
                    if (typeof gening !== 'undefined' && gening) {
                        console.log('ğŸ”„ AIç”Ÿæˆä¸­ï¼Œå»¶è¿Ÿæ¶ˆæ¯çŠ¶æ€æ›´æ–°');
                        // å»¶è¿Ÿåˆ°AIç”Ÿæˆå®Œæˆåå†æ›´æ–°
                        const checkInterval = setInterval(() => {
                            if (!gening) {
                                clearInterval(checkInterval);
                                QQ_UpdateMessageStatus(statusElement, 'å·²é€è¾¾', 'âœ“âœ“', '#87ceeb');
                            }
                        }, 500);
                        return;
                    }
                    QQ_UpdateMessageStatus(statusElement, 'å·²é€è¾¾', 'âœ“âœ“', '#87ceeb');
                }, deliveredDelay + 1000);
                
                // ç¬¬ä¸‰é˜¶æ®µï¼š3-60ç§’åæ˜¾ç¤º"å·²è¯»"ï¼ˆæœ¬ç¦ç‰¹å®šå¾‹åˆ†å¸ƒï¼‰
                const readDelay = QQ_GenerateReadStatusDelay();
                setTimeout(() => {
                    // æ£€æŸ¥æ˜¯å¦æ­£åœ¨ç”ŸæˆAIå›å¤ï¼Œé¿å…åœ¨ç­‰å¾…æœŸé—´æ›´æ–°çŠ¶æ€
                    if (typeof gening !== 'undefined' && gening) {
                        console.log('ğŸ”„ AIç”Ÿæˆä¸­ï¼Œå»¶è¿Ÿå·²è¯»çŠ¶æ€æ›´æ–°');
                        // å»¶è¿Ÿåˆ°AIç”Ÿæˆå®Œæˆåå†æ›´æ–°
                        const checkInterval = setInterval(() => {
                            if (!gening) {
                                clearInterval(checkInterval);
                                QQ_UpdateMessageStatus(statusElement, 'å·²è¯»', 'âœ“âœ“', '#10ac84');
                                console.log('âœ… æ¶ˆæ¯çŠ¶æ€å·²æ›´æ–°ä¸ºå·²è¯»');
                            }
                        }, 500);
                        return;
                    }
                    QQ_UpdateMessageStatus(statusElement, 'å·²è¯»', 'âœ“âœ“', '#10ac84');
                    console.log('âœ… æ¶ˆæ¯çŠ¶æ€å·²æ›´æ–°ä¸ºå·²è¯»');
                }, readDelay);
            }
            
            /**
             * æ›´æ–°æ¶ˆæ¯çŠ¶æ€çš„é€šç”¨å‡½æ•°
             * @param {Element} statusElement - çŠ¶æ€å…ƒç´ 
             * @param {string} statusText - çŠ¶æ€æ–‡æœ¬
             * @param {string} iconText - å›¾æ ‡æ–‡æœ¬
             * @param {string} iconColor - å›¾æ ‡é¢œè‰²
             */
            function QQ_UpdateMessageStatus(statusElement, statusText, iconText, iconColor) {
                statusElement.style.transition = 'all 0.5s ease';
                statusElement.style.opacity = '0';
                
                setTimeout(() => {
                    const textSpan = statusElement.querySelector('.status-text');
                    const iconSpan = statusElement.querySelector('.status-icon');
                    
                    if (textSpan) {
                        textSpan.textContent = statusText;
                        textSpan.style.color = '#1976d2';
                        textSpan.style.fontWeight = '500';
                    }
                    if (iconSpan) {
                        iconSpan.textContent = iconText;
                        iconSpan.style.color = iconColor;
                        iconSpan.style.fontWeight = 'bold';
                    }
                    
                    statusElement.style.opacity = '1';
                    console.log(`âœ… æ¶ˆæ¯çŠ¶æ€å·²æ›´æ–°ä¸º${statusText}`);
                }, 500);
            }
            
            /**
             * æ ¹æ®æœ¬ç¦ç‰¹å®šå¾‹ç”Ÿæˆå·²è¯»çŠ¶æ€å»¶è¿Ÿæ—¶é—´ï¼ˆ3-60ç§’ï¼‰
             * @returns {number} å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
             */
            function QQ_GenerateReadStatusDelay() {
                // 3-60ç§’çš„èŒƒå›´ï¼Œä½¿ç”¨æœ¬ç¦ç‰¹å®šå¾‹åˆ†å¸ƒ
                const baseDelay = 3000; // 3ç§’åŸºç¡€å»¶è¿Ÿ
                const maxRange = 57000; // 57ç§’èŒƒå›´ (60-3=57)
                
                // ä½¿ç”¨æœ¬ç¦ç‰¹å®šå¾‹ï¼šP(d) = log10(1 + 1/d)
                const random = Math.random();
                let accumulator = 0;
                
                for (let digit = 1; digit <= 9; digit++) {
                    const probability = Math.log10(1 + 1/digit);
                    accumulator += probability;
                    
                    if (random <= accumulator) {
                        // å°†æ•°å­—æ˜ å°„åˆ°æ—¶é—´èŒƒå›´
                        const timeMultiplier = digit / 9; // 0.11 åˆ° 1
                        const delay = baseDelay + (maxRange * timeMultiplier);
                        console.log(`ğŸ¯ æœ¬ç¦ç‰¹å®šå¾‹ç”Ÿæˆå·²è¯»å»¶è¿Ÿ: ${Math.round(delay/1000)}ç§’ (æ•°å­—:${digit})`);
                        return delay;
                    }
                }
                
                // å¤‡ç”¨ï¼šå¦‚æœç®—æ³•å¤±è´¥ï¼Œä½¿ç”¨éšæœºå€¼
                return baseDelay + Math.random() * maxRange;
            }
            
            
            /**
             * *** æ–°å¢ï¼šä¸ºç”¨æˆ·æ¶ˆæ¯æ·»åŠ é•¿æŒ‰åŠŸèƒ½ ***
             * @param {Element} messageElement - æ¶ˆæ¯å…ƒç´ 
             * @param {string} messageContent - æ¶ˆæ¯å†…å®¹
             * @param {string} chatName - èŠå¤©åç§°
             */
            /**
             * *** æ–°å¢ï¼šç¨³å®šçš„ç§èŠæ¶ˆæ¯å­˜å‚¨æœºåˆ¶ ***
             * å¤„ç†ç§èŠæ¶ˆæ¯å­˜å‚¨ï¼Œæ”¯æŒå¤šç§é”®æ ¼å¼å…¼å®¹
             * @param {string} characterName - è§’è‰²åç§°
             * @param {string} userMessage - ç”¨æˆ·æ¶ˆæ¯
             */
            function QQ_SaveUserMessageToPrivateChat(characterName, userMessage) {
                // æ”¯æŒçš„ç§èŠé”®æ ¼å¼
                const chatKey1 = `${UserName}å’Œ${characterName}çš„èŠå¤©`;
                const chatKey2 = `${characterName}å’Œ${UserName}çš„èŠå¤©`;
                
                // ç¡®ä¿ç§èŠæ•°æ®ç»“æ„å­˜åœ¨
                if (!QQ_msgjson.ç§èŠ) {
                    QQ_msgjson.ç§èŠ = {};
                }
                
                // æŸ¥æ‰¾ç°æœ‰çš„èŠå¤©è®°å½•
                let existingChatKey = null;
                let existingMessages = null;
                
                if (QQ_msgjson.ç§èŠ[chatKey1]) {
                    existingChatKey = chatKey1;
                    existingMessages = QQ_msgjson.ç§èŠ[chatKey1];
                } else if (QQ_msgjson.ç§èŠ[chatKey2]) {
                    existingChatKey = chatKey2;
                    existingMessages = QQ_msgjson.ç§èŠ[chatKey2];
                }
                
                // å¦‚æœæ‰¾åˆ°ç°æœ‰èŠå¤©ï¼Œä½¿ç”¨ç°æœ‰çš„é”®
                if (existingChatKey && existingMessages) {
                    if (!existingMessages.includes(userMessage)) {
                        existingMessages.push(userMessage);
                        console.log(`âœ… æ¶ˆæ¯å·²æ·»åŠ åˆ°ç°æœ‰èŠå¤©: ${existingChatKey}`);
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰ç°æœ‰èŠå¤©ï¼Œåˆ›å»ºæ–°çš„ï¼ˆä½¿ç”¨ç¬¬ä¸€ç§æ ¼å¼ï¼‰
                    QQ_msgjson.ç§èŠ[chatKey1] = [userMessage];
                    console.log(`âœ… åˆ›å»ºæ–°çš„ç§èŠèŠå¤©: ${chatKey1}`);
                }
            }
            
            /**
             * *** æ–°å¢ï¼šç¨³å®šçš„ç§èŠæ¶ˆæ¯åŠ è½½æœºåˆ¶ ***
             * ä»æ•°æ®ç»“æ„ä¸­åŠ è½½ç§èŠæ¶ˆæ¯ï¼Œæ”¯æŒå¤šç§é”®æ ¼å¼å…¼å®¹
             * @param {string} characterName - è§’è‰²åç§°
             * @returns {Array} ç§èŠæ¶ˆæ¯æ•°ç»„
             */
            /**
             * *** æ–°å¢ï¼šå¼ºåŒ–çš„ç”¨æˆ·æ¶ˆæ¯é‡å¤è¿‡æ»¤æœºåˆ¶ ***
             * æ™ºèƒ½æ£€æµ‹å¹¶ç§»é™¤AIå›å¤ä¸­é‡å¤çš„ç”¨æˆ·æ¶ˆæ¯
             * @param {Array} messages - æ¶ˆæ¯æ•°ç»„
             * @param {string} chatName - èŠå¤©åç§°
             * @returns {Array} è¿‡æ»¤åçš„æ¶ˆæ¯æ•°ç»„
             */
            function QQ_FilterDuplicateUserMessages(messages, chatName) {
                if (!messages || messages.length === 0) return messages;
                
                const filteredMessages = [];
                const userMessageHistory = new Set();
                
                // è·å–æœ€è¿‘çš„ç”¨æˆ·æ¶ˆæ¯ä½œä¸ºå‚è€ƒ
                const lastUserMessage = User_LastMsgMap.ç§èŠ?.[chatName] || User_LastMsgMap.ç¾¤èŠ?.[chatName];
                let lastUserContent = '';
                if (lastUserMessage) {
                    const parts = lastUserMessage.split('--');
                    if (parts.length >= 2) {
                        lastUserContent = parts[1].trim().toLowerCase();
                    }
                }
                
                for (const message of messages) {
                    const parts = message.split('--');
                    if (parts.length < 2) {
                        filteredMessages.push(message);
                        continue;
                    }
                    
                    const sender = parts[0].trim();
                    const content = parts[1].trim();
                    const contentLower = content.toLowerCase();
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸ºç”¨æˆ·æ¶ˆæ¯çš„é‡å¤
                    if (sender === UserName) {
                        // æ£€æŸ¥æ˜¯å¦ä¸å†å²æ¶ˆæ¯é‡å¤
                        const messageKey = `${sender}:${contentLower}`;
                        if (userMessageHistory.has(messageKey)) {
                            continue;
                        }
                        userMessageHistory.add(messageKey);
                        
                        // æ£€æŸ¥æ˜¯å¦ä¸æœ€è¿‘å‘é€çš„æ¶ˆæ¯é‡å¤
                        if (lastUserContent && contentLower === lastUserContent) {
                            continue;
                        }
                    } else {
                        // å¯¹äºéç”¨æˆ·æ¶ˆæ¯ï¼Œæ£€æŸ¥æ˜¯å¦åŒ…å«ç”¨æˆ·æ¶ˆæ¯å†…å®¹
                        if (lastUserContent && lastUserContent.length > 10) {
                            // æ£€æŸ¥AIæ¶ˆæ¯æ˜¯å¦å‡ ä¹å®Œå…¨é‡å¤äº†ç”¨æˆ·æ¶ˆæ¯
                            const similarity = QQ_CalculateTextSimilarity(contentLower, lastUserContent);
                            if (similarity > 0.8) {
                                continue;
                            }
                        }
                    }
                    
                    filteredMessages.push(message);
                }
                
                if (filteredMessages.length !== messages.length) {
                }
                
                return filteredMessages;
            }
            
            /**
             * *** æ–°å¢ï¼šè®¡ç®—æ–‡æœ¬ç›¸ä¼¼åº¦ ***
             * @param {string} text1 - æ–‡æœ¬1
             * @param {string} text2 - æ–‡æœ¬2
             * @returns {number} ç›¸ä¼¼åº¦ (0-1)
             */
            function QQ_CalculateTextSimilarity(text1, text2) {
                if (!text1 || !text2) return 0;
                
                // ç®€å•çš„å­—ç¬¦çº§ç›¸ä¼¼åº¦è®¡ç®—
                const len1 = text1.length;
                const len2 = text2.length;
                const maxLen = Math.max(len1, len2);
                
                if (maxLen === 0) return 1;
                
                // è®¡ç®—ç¼–è¾‘è·ç¦»
                const dp = Array(len1 + 1).fill().map(() => Array(len2 + 1).fill(0));
                
                for (let i = 0; i <= len1; i++) dp[i][0] = i;
                for (let j = 0; j <= len2; j++) dp[0][j] = j;
                
                for (let i = 1; i <= len1; i++) {
                    for (let j = 1; j <= len2; j++) {
                        if (text1[i-1] === text2[j-1]) {
                            dp[i][j] = dp[i-1][j-1];
                        } else {
                            dp[i][j] = Math.min(dp[i-1][j], dp[i][j-1], dp[i-1][j-1]) + 1;
                        }
                    }
                }
                
                return 1 - (dp[len1][len2] / maxLen);
            }
            
            function QQ_LoadPrivateChatMessages(characterName) {
                if (!QQ_msgjson.ç§èŠ) {
                    return [];
                }
                
                // æ”¯æŒçš„ç§èŠé”®æ ¼å¼
                const chatKey1 = `${UserName}å’Œ${characterName}çš„èŠå¤©`;
                const chatKey2 = `${characterName}å’Œ${UserName}çš„èŠå¤©`;
                
                // æŸ¥æ‰¾ç°æœ‰çš„èŠå¤©è®°å½•
                if (QQ_msgjson.ç§èŠ[chatKey1]) {
                    console.log(`âœ… ä»æ ¼å¼1åŠ è½½ç§èŠæ¶ˆæ¯: ${chatKey1}`);
                    return QQ_msgjson.ç§èŠ[chatKey1] || [];
                } else if (QQ_msgjson.ç§èŠ[chatKey2]) {
                    console.log(`âœ… ä»æ ¼å¼2åŠ è½½ç§èŠæ¶ˆæ¯: ${chatKey2}`);
                    return QQ_msgjson.ç§èŠ[chatKey2] || [];
                } else {
                    console.log(`âš ï¸ æœªæ‰¾åˆ°ç§èŠæ¶ˆæ¯: ${characterName}`);
                    console.log(`ç°æœ‰ç§èŠé”®:`, Object.keys(QQ_msgjson.ç§èŠ));
                    return [];
                }
            }
            
            function QQ_AddLongPressHandler(messageElement, messageContent, chatName) {
                if (!messageElement) return;
                
                let longPressTimer = null;
                let startX = 0, startY = 0;
                let isLongPress = false;
                
                // å¼€å§‹é•¿æŒ‰æ£€æµ‹
                function startLongPress(e) {
                    const touch = e.touches ? e.touches[0] : e;
                    startX = touch.clientX;
                    startY = touch.clientY;
                    isLongPress = false;
                    
                    longPressTimer = setTimeout(() => {
                        isLongPress = true;
                        showLongPressMenu(e, messageElement, messageContent, chatName);
                    }, 500); // 500msé•¿æŒ‰è§¦å‘
                }
                
                // æ£€æµ‹ç§»åŠ¨ï¼Œå¦‚æœç§»åŠ¨å¤ªå¤šåˆ™å–æ¶ˆé•¿æŒ‰
                function checkMove(e) {
                    if (!longPressTimer) return;
                    
                    const touch = e.touches ? e.touches[0] : e;
                    const deltaX = Math.abs(touch.clientX - startX);
                    const deltaY = Math.abs(touch.clientY - startY);
                    
                    if (deltaX > 10 || deltaY > 10) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                }
                
                // ç»“æŸé•¿æŒ‰æ£€æµ‹
                function endLongPress(e) {
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                    
                    // å¦‚æœæ˜¯é•¿æŒ‰ï¼Œé˜»æ­¢é»˜è®¤çš„ç‚¹å‡»äº‹ä»¶ï¼Œä½†ä¸é‡ç½®isLongPress
                    // è®©èœå•ä¿æŒæ˜¾ç¤ºçŠ¶æ€
                    if (isLongPress) {
                        e.preventDefault();
                        e.stopPropagation();
                        // æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œé‡ç½® isLongPressï¼Œè®©èœå•ä¿æŒæ˜¾ç¤º
                    }
                }
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                messageElement.addEventListener('touchstart', startLongPress, { passive: false });
                messageElement.addEventListener('mousedown', startLongPress, { passive: false });
                
                messageElement.addEventListener('touchmove', checkMove, { passive: false });
                messageElement.addEventListener('mousemove', checkMove, { passive: false });
                
                messageElement.addEventListener('touchend', endLongPress, { passive: false });
                messageElement.addEventListener('mouseup', endLongPress, { passive: false });
                messageElement.addEventListener('mouseleave', endLongPress, { passive: false });
                
                // é˜»æ­¢å³é”®èœå•ï¼Œä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„é•¿æŒ‰èœå•
                messageElement.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    showLongPressMenu(e, messageElement, messageContent, chatName);
                });
            }
            
            /**
             * *** æ–°å¢ï¼šæ˜¾ç¤ºé•¿æŒ‰èœå• ***
             * @param {Event} e - äº‹ä»¶å¯¹è±¡
             * @param {Element} messageElement - æ¶ˆæ¯å…ƒç´ 
             * @param {string} messageContent - æ¶ˆæ¯å†…å®¹
             * @param {string} chatName - èŠå¤©åç§°
             */
            function showLongPressMenu(e, messageElement, messageContent, chatName) {
                // ç§»é™¤å·²å­˜åœ¨çš„èœå•
                const existingMenu = document.querySelector('.long-press-menu');
                if (existingMenu) {
                    existingMenu.remove();
                }
                
                // åˆ›å»ºèœå•
                const menu = document.createElement('div');
                menu.className = 'long-press-menu';
                
                // ç¼–è¾‘é€‰é¡¹
                const editItem = document.createElement('div');
                editItem.className = 'long-press-menu-item edit';
                editItem.innerHTML = `
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                        <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                    </svg>
                    <span>ç¼–è¾‘</span>
                `;
                
                // åˆ é™¤é€‰é¡¹
                const deleteItem = document.createElement('div');
                deleteItem.className = 'long-press-menu-item delete';
                deleteItem.innerHTML = `
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                    </svg>
                    <span>åˆ é™¤</span>
                `;
                
                menu.appendChild(editItem);
                menu.appendChild(deleteItem);
                
                // æ·»åŠ åˆ°é¡µé¢
                document.body.appendChild(menu);
                
                // å®šä½èœå•
                const touch = e.touches ? e.touches[0] : e;
                const x = touch.clientX;
                const y = touch.clientY;
                
                // ç¡®ä¿èœå•ä¸ä¼šè¶…å‡ºå±å¹•
                const menuRect = menu.getBoundingClientRect();
                const maxX = window.innerWidth - menuRect.width - 10;
                const maxY = window.innerHeight - menuRect.height - 10;
                
                menu.style.left = Math.min(x, maxX) + 'px';
                menu.style.top = Math.min(y, maxY) + 'px';
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ - å¸¦åŠ¨ç”»çš„èœå•å…³é—­
                editItem.addEventListener('click', (e) => {
                    e.stopPropagation();
                    menu.style.animation = 'menuFadeOut 0.2s ease-in forwards';
                    setTimeout(() => {
                        if (menu.parentNode) {
                            menu.remove();
                        }
                        QQ_EditUserMessage(messageElement, messageContent, chatName);
                    }, 200);
                });
                
                deleteItem.addEventListener('click', (e) => {
                    e.stopPropagation();
                    menu.style.animation = 'menuFadeOut 0.2s ease-in forwards';
                    setTimeout(() => {
                        if (menu.parentNode) {
                            menu.remove();
                        }
                        QQ_DeleteUserMessage(messageElement, messageContent, chatName);
                    }, 200);
                });
                
                // é˜»æ­¢èœå•æœ¬èº«çš„ç‚¹å‡»äº‹ä»¶å†’æ³¡
                menu.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
                
                // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå• - å»¶è¿Ÿæ›´é•¿æ—¶é—´ç¡®ä¿èœå•ä¸ä¼šç«‹å³æ¶ˆå¤±
                setTimeout(() => {
                    const closeMenu = (e) => {
                        // æ£€æŸ¥ç‚¹å‡»çš„ç›®æ ‡æ˜¯å¦åœ¨èœå•å†…æˆ–æ˜¯èœå•æœ¬èº«
                        if (!menu.contains(e.target) && e.target !== menu) {
                            menu.style.animation = 'menuFadeOut 0.2s ease-in forwards';
                            setTimeout(() => {
                                if (menu.parentNode) {
                                    menu.remove();
                                }
                            }, 200);
                            document.removeEventListener('click', closeMenu);
                            document.removeEventListener('touchstart', closeMenu);
                        }
                    };
                    document.addEventListener('click', closeMenu);
                    document.addEventListener('touchstart', closeMenu);
                }, 300); // å¢åŠ å»¶è¿Ÿåˆ°300ms
                
                // æ·»åŠ èœå•æ·¡å‡ºåŠ¨ç”»
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes menuFadeOut {
                        0% {
                            opacity: 1;
                            transform: scale(1) translateY(0);
                        }
                        100% {
                            opacity: 0;
                            transform: scale(0.9) translateY(-5px);
                        }
                    }
                `;
                if (!document.querySelector('style[data-menu-animations]')) {
                    style.setAttribute('data-menu-animations', 'true');
                    document.head.appendChild(style);
                }
            }
            
            /**
             * *** æ–°å¢ï¼šç¼–è¾‘ç”¨æˆ·æ¶ˆæ¯ ***
             * @param {Element} messageElement - æ¶ˆæ¯å…ƒç´ 
             * @param {string} messageContent - æ¶ˆæ¯å†…å®¹
             * @param {string} chatName - èŠå¤©åç§°
             */
            function QQ_EditUserMessage(messageElement, messageContent, chatName) {
                // åˆ›å»ºç¼–è¾‘è¾“å…¥æ¡†
                const input = document.createElement('textarea');
                input.value = messageContent;
                input.style.cssText = `
                    width: 100%;
                    min-height: 60px;
                    padding: 8px;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    font-size: 14px;
                    resize: vertical;
                    outline: none;
                    font-family: inherit;
                `;
                
                // åˆ›å»ºæŒ‰é’®å®¹å™¨
                const buttonContainer = document.createElement('div');
                buttonContainer.style.cssText = `
                    display: flex;
                    gap: 8px;
                    margin-top: 8px;
                    justify-content: flex-end;
                `;
                
                // ç¡®è®¤æŒ‰é’®
                const confirmBtn = document.createElement('button');
                confirmBtn.textContent = 'ç¡®è®¤';
                confirmBtn.style.cssText = `
                    padding: 6px 12px;
                    background: #1976d2;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                `;
                
                // å–æ¶ˆæŒ‰é’®
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'å–æ¶ˆ';
                cancelBtn.style.cssText = `
                    padding: 6px 12px;
                    background: #f5f5f5;
                    color: #333;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                `;
                
                buttonContainer.appendChild(cancelBtn);
                buttonContainer.appendChild(confirmBtn);
                
                // ä¿å­˜åŸå§‹å†…å®¹
                const originalContent = messageElement.innerHTML;
                
                // æ›¿æ¢æ¶ˆæ¯å†…å®¹ä¸ºç¼–è¾‘ç•Œé¢
                messageElement.innerHTML = '';
                messageElement.appendChild(input);
                messageElement.appendChild(buttonContainer);
                
                // èšç„¦è¾“å…¥æ¡†
                input.focus();
                input.setSelectionRange(input.value.length, input.value.length);
                
                // ç¡®è®¤ç¼–è¾‘
                confirmBtn.addEventListener('click', () => {
                    const newContent = input.value.trim();
                    if (newContent && newContent !== messageContent) {
                        // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´æ–°æ¶ˆæ¯çš„é€»è¾‘
                        // ç›®å‰åªæ˜¯æ¢å¤æ˜¾ç¤ºå¹¶æ˜¾ç¤ºæ–°å†…å®¹
                        messageElement.innerHTML = originalContent;
                        const contentDiv = messageElement.querySelector('div[style*="width:auto"]');
                        if (contentDiv) {
                            contentDiv.innerHTML = newContent;
                        }
                        console.log(`æ¶ˆæ¯å·²ç¼–è¾‘: "${messageContent}" -> "${newContent}"`);
                        toastr.success('æ¶ˆæ¯å·²ç¼–è¾‘');
                    } else {
                        messageElement.innerHTML = originalContent;
                    }
                });
                
                // å–æ¶ˆç¼–è¾‘
                cancelBtn.addEventListener('click', () => {
                    messageElement.innerHTML = originalContent;
                });
                
                // ESCé”®å–æ¶ˆç¼–è¾‘
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        messageElement.innerHTML = originalContent;
                    }
                });
            }
            
            /**
             * *** æ–°å¢ï¼šåˆ é™¤ç”¨æˆ·æ¶ˆæ¯ ***
             * @param {Element} messageElement - æ¶ˆæ¯å…ƒç´ 
             * @param {string} messageContent - æ¶ˆæ¯å†…å®¹
             * @param {string} chatName - èŠå¤©åç§°
             */
            function QQ_DeleteUserMessage(messageElement, messageContent, chatName) {
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) {
                    // æ·»åŠ åˆ é™¤åŠ¨ç”»
                    messageElement.style.transition = 'all 0.3s ease-out';
                    messageElement.style.opacity = '0';
                    messageElement.style.transform = 'translateX(100%)';
                    
                    setTimeout(() => {
                        messageElement.remove();
                        console.log(`æ¶ˆæ¯å·²åˆ é™¤: "${messageContent}"`);
                        toastr.success('æ¶ˆæ¯å·²åˆ é™¤');
                    }, 300);
                }
            }
            
            function QQ_Chat_AddUserMsg(element, msg) {
                const match = msg.match(/(.+?)--(.+)/);
                if (!match) {
                    return;
                }
                const content = QQ_Chat_SpecialMsg(
                    match[2],
                    `${UserName}`,
                    false,
                    true,
                );
                const html = _.template(chat_user_message)({ content });
                $(element).append(html);
                
                // å¯åŠ¨ç”¨æˆ·æ¶ˆæ¯çŠ¶æ€æ¨¡æ‹Ÿ
                const lastMessage = $(element).children().last()[0];
                if (lastMessage) {
                    QQ_SimulateMessageStatusChange(lastMessage);
                }
            }
            /**
             * å¤„ç†ç‰¹æ®Šæ ¼å¼æ¶ˆæ¯
             * @param msg æ¶ˆæ¯å†…å®¹
             * @param isgroup æ˜¯å¦æ˜¯ç¾¤èŠ
             * @returns å¤„ç†åçš„æ¶ˆæ¯
             */
            function QQ_Chat_SpecialMsg(msg, username, isgroup, mysend) {
                const match = msg.match(/\[(.+?)[\|-](.+?)\]/);
                const xxx = msg.match(/(.+?)\[/);
                const xx = msg.match(/\](.+)/);
                let additionalText = "";
                if (xxx) {
                    additionalText = xxx[1];
                }
                if (xx) {
                    console.log(`å‰åéƒ½æœ‰`);
                    additionalText = additionalText
                        ? additionalText + `<br>${xx[1]}`
                        : xx[1];
                }
                if (!match) {
                    // ä½¿ç”¨æ™®é€šæ¶ˆæ¯æ¨¡æ¿
                    //console.log(`è‡ªå·±çš„æ¶ˆæ¯,ä½¿ç”¨çš„æ™®é€šæ¨¡æ¿`);
                    return _.template(chat_normal_message)({
                        message: msg,
                        isgroup: isgroup || false,
                        username: username,
                    });
                }
                const type = match[1];
                if (type == "bqb") {
                    // ä½¿ç”¨è¡¨æƒ…åŒ…æ¶ˆæ¯æ¨¡æ¿
                    console.log(`è¡¨æƒ…åŒ…é“¾æ¥:${QQ_GetEmoji(match[2])}`);
                    return _.template(chat_emoji_message)({
                        emojiUrl: QQ_GetEmoji(match[2]),
                        additionalText: additionalText,
                        isgroup: isgroup || false,
                        username: username,
                    });
                } else if (type == "è½¬è´¦" || type == "zz") {
                    // ä½¿ç”¨è½¬è´¦æ¶ˆæ¯æ¨¡æ¿
                    return _.template(chat_transfer_message)({
                        amount: match[2],
                    });
                } else if (type == "yy") {
                    let file = chat_char_voice_message;
                    if (mysend) {
                        file = chat_my_voice_message;
                    }
                    return _.template(file)({
                        content: match[2],
                        time: Math.ceil(match[2].length / 4).toString(),
                        isgroup: isgroup || false,
                        username: username,
                    });
                } else if (
                    [
                        "img",
                        "image",
                        "video",
                        "imgs",
                        "images",
                        "file",
                        "files",
                        "å›¾ç‰‡",
                        "è§†é¢‘",
                        "tp",
                    ].includes(type)
                ) {
                    return _.template(chat_fakeimg_message)({
                        isgroup: isgroup || false,
                        username: username,
                        content: match[2],
                        additionalText: additionalText
                            ? `<span style="margin-top: 5px; display: block">${additionalText}</span>`
                            : "",
                    });
                } else if (["music", "éŸ³ä¹"].includes(type)) {
                    let sp = match[2].split("$");
                    let musicname = "";
                    let musicauthor = "";
                    if (sp.length >= 2) {
                        musicname = sp[0];
                        musicauthor = sp[1];
                    }
                    //console.log(`åŠ å…¥éŸ³ä¹:${musicname}----${musicauthor}`);
                    return _.template(chat_music_message)({
                        isgroup: isgroup || false,
                        username: username,
                        musicname: musicname,
                        musicauthor: musicauthor,
                    });
                }
                return "";
            }
            function QQ_MySendSpecial(content) {
                let match = content.match(/\[?(.+?)-(.+?)]?$/m);
                if (match) {
                    let type = match[1];
                    if (["yy", "è¯­éŸ³"].includes(type)) {
                        content = `[yy-${match[2]}]`;
                    } else if (["è¡¨æƒ…åŒ…", "è¡¨æƒ…", "bqb", "bq"].includes(type)) {
                        content = `[bqb-${match[2]}]`;
                    } else if (
                        [
                            "img",
                            "image",
                            "video",
                            "imgs",
                            "images",
                            "file",
                            "files",
                            "å›¾ç‰‡",
                            "è§†é¢‘",
                            "tp",
                        ].includes(type)
                    ) {
                        content = `[img-${match[2]}]`;
                    }
                }
                return content;
            }
            /**
             * è·å–è¡¨æƒ…åŒ…
             * @param name è¡¨æƒ…åŒ…åç§°
             * @returns è¡¨æƒ…åŒ…URL
             */
            function QQ_GetEmoji(name) {
                if (!QQ_emoji.has(name)) {
                    return;
                }
                return QQ_emoji.get(name);
            }
            // å½“å‰æ­£åœ¨è®¾ç½®çš„èŠå¤©å¯¹è±¡
            let currentSettingChatName = "";
            /**
             * è®¾ç½®èŠå¤©é¡µè®¾ç½®
             * @param event äº‹ä»¶å¯¹è±¡
             */
            function QQ_SetChatPageSetting(event) {
                console.log("ç‚¹å‡»äº†è®¾ç½®èŠå¤©é¡µè®¾ç½®");
                let element = event.currentTarget;
                // è·å–å½“å‰èŠå¤©é¡µçš„åç§°
                const chatPageElement = $(element).closest(".QQ_chat_page");
                if (chatPageElement.length === 0) {
                    console.error("æ— æ³•è·å–å½“å‰èŠå¤©é¡µ");
                    return;
                }
                currentSettingChatName =
                    chatPageElement.attr("data-name") ?? "";
                console.log(
                    `æ‰“å¼€èŠå¤©è®¾ç½®é¡µé¢ï¼Œå½“å‰èŠå¤©å¯¹è±¡: ${currentSettingChatName}`,
                );
                // æ·»åŠ é®ç½©å±‚å’Œå¼¹çª—åˆ°é¡µé¢
                if ($(".popup-overlay").length === 0) {
                    $(".card").append('<div class="popup-overlay"></div>');
                }
                if ($(".chat-setting-popup").length === 0) {
                    $(".card").append(
                        chat_page_setting.replace(
                            "${username}",
                            currentSettingChatName,
                        ),
                    );
                    const bubblecolorPicker =
                        document.getElementById("bubble-color");
                    if (bubblecolorPicker) {
                        console.log(`å¼€å§‹ç›‘å¬`);
                        bubblecolorPicker.addEventListener("input", (event) => {
                            const color = event.target.value;
                            $("#bubble-color-input").val(color || "#ffffff");
                            $("#chat-setting-preview").each(function () {
                                this.style.setProperty(
                                    "background-color",
                                    color,
                                    "important",
                                );
                            });
                        });
                    }
                    const TextcolorPicker =
                        document.getElementById("text-color");
                    if (TextcolorPicker) {
                        console.log(`å¼€å§‹ç›‘å¬`);
                        TextcolorPicker.addEventListener("input", (event) => {
                            const color = event.target.value;
                            $("#text-color-input").val(color || "#ffffff");
                            $("#chat-setting-preview").each(function () {
                                const spans = this.querySelectorAll("span");
                                spans.forEach((span) => {
                                    span.style.setProperty(
                                        "color",
                                        color,
                                        "important",
                                    );
                                });
                            });
                        });
                    }
                }
                // å¡«å……å·²æœ‰è®¾ç½®
                loadCurrentSettings(currentSettingChatName);
                // æ˜¾ç¤ºå¼¹çª—å’Œé®ç½©å±‚
                $(".popup-overlay").show();
                $(".chat-setting-popup").show();
            }
            /**
             * åŠ è½½å½“å‰è®¾ç½®åˆ°å¼¹çª—
             * @param chatName èŠå¤©å¯¹è±¡åç§°
             */
            function loadCurrentSettings(chatName) {
                const setting = GetChatCharSettingByName(chatName);
                // å¡«å……è¡¨å•
                let bubbleColor = QQ_CharSettings.readValue(
                    chatName,
                    "æ°”æ³¡é¢œè‰²",
                );
                let TextColor = QQ_CharSettings.readValue(chatName, "å­—ä½“é¢œè‰²");
                let chatBg = QQ_CharSettings.readValue(chatName, "èŠå¤©å£çº¸");
                if (bubbleColor && bubbleColor[0] !== "#") {
                    bubbleColor = "#" + bubbleColor;
                }
                if (TextColor && TextColor[0] !== "#") {
                    TextColor = "#" + TextColor;
                }
                $("#bubble-color").val(bubbleColor || "#ffffff");
                $("#bubble-color-input").val(bubbleColor || "#ffffff");
                $("#text-color").val(TextColor || "#ffffff");
                $("#text-color-input").val(TextColor || "#ffffff");
                $("#chat-bg").val(chatBg || "");
                $("#chat-setting-preview").each(function () {
                    this.style.setProperty(
                        "background-color",
                        bubbleColor,
                        "important",
                    );
                    const spans = this.querySelectorAll("span");
                    spans.forEach((span) => {
                        span.style.setProperty("color", TextColor, "important");
                    });
                });
            }
            function closeSettingPopup() {
                $(".popup-overlay").hide();
                $(".chat-setting-popup").hide();
            }
            /**
             * ä¿å­˜è®¾ç½®å¹¶å…³é—­å¼¹çª—
             */
            async function saveSettingAndClose() {
                if (!currentSettingChatName) {
                    console.error("æœªçŸ¥çš„èŠå¤©å¯¹è±¡");
                    return;
                }
                // è·å–è®¾ç½®å€¼
                const bubbleColor = $("#bubble-color-input").val() || "";
                const TextColor = $("#text-color-input").val() || "";
                const chatBg = $("#chat-bg").val() || "";
                console.log(`ä¿å­˜èŠå¤©è®¾ç½®: ${currentSettingChatName}`, {
                    bubbleColor,
                    TextColor,
                    chatBg,
                });
                QQ_CharSettings.writeValue(
                    currentSettingChatName,
                    "æ°”æ³¡é¢œè‰²",
                    bubbleColor,
                );
                QQ_CharSettings.writeValue(
                    currentSettingChatName,
                    "å­—ä½“é¢œè‰²",
                    TextColor,
                );
                QQ_CharSettings.writeValue(
                    currentSettingChatName,
                    "èŠå¤©å£çº¸",
                    chatBg,
                );
                const result = QQ_CharSettings.getAllText();
                for (let entry of entries) {
                    if (
                        entry.comment == "æ‰‹æœº-è§’è‰²" ||
                        entry.comment == "æ‰‹æœºç•Œé¢-è§’è‰²"
                    ) {
                        await setLorebookEntries(worldbook, [
                            { uid: entry.uid, content: result },
                        ]);
                        break;
                    }
                }
                SetCssVariable(currentSettingChatName, "MsgColor", bubbleColor);
                SetCssVariable(currentSettingChatName, "TextColor", TextColor);
                SetCssVariable(
                    currentSettingChatName,
                    "BackGroundImg",
                    `url('${chatBg}')`,
                );
                // å…³é—­å¼¹çª—
                closeSettingPopup();
            }
            function updateTime() {
                const timeElement = document.getElementById("time");
                if (!timeElement) {
                    return;
                }
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, "0");
                const minutes = String(now.getMinutes()).padStart(2, "0");
                //const seconds = String(now.getSeconds()).padStart(2, '0');
                timeElement.textContent = `${hours}:${minutes}`;
                // const dayElement = document.getElementById("day");
                // dayElement.textContent = `${now.getMonth() + 1}æœˆ${now.getDate()}æ—¥`;
            }
            function App_Load(App_Name) {
                $("#Home_page").hide();
                $("#App_page").show();
                App_HideAll();
                $(`#App_${App_Name}`).show();
            }
            function App_HideAll() {
                const AppNames = ["QQ", "twitter", "discord"];
                for (const name of AppNames) {
                    $(`#App_${name}`).hide();
                }
            }
            // æ¯ç§’æ›´æ–°ä¸€æ¬¡æ—¶é—´ï¼ˆæ·»åŠ æ¸…ç†æ”¯æŒï¼‰
            let timeUpdateInterval = setInterval(updateTime, 1000);
            updateTime();
            
            // æ·»åŠ å…¨å±€æ¸…ç†å‡½æ•°
            window.QQ_CleanupTimers = window.QQ_CleanupTimers || function() {
                if (timeUpdateInterval) {
                    clearInterval(timeUpdateInterval);
                    timeUpdateInterval = null;
                }
            };
            
            // æ·»åŠ å…¨å±€èµ„æºæ¸…ç†å‡½æ•°
            window.QQ_CleanupAllResources = function() {
                console.log('ğŸ§¹ å¼€å§‹æ¸…ç†æ‰€æœ‰èµ„æº');
                
                // æ¸…ç†å®šæ—¶å™¨
                if (window.QQ_CleanupTimers) {
                    window.QQ_CleanupTimers();
                }
                
                // æ¸…ç†æ‰€æœ‰æµå¼ä¼ è¾“ç›¸å…³èµ„æº
                QQ_CancelAllStreaming();
                
                // æ¸…ç†è¾“å…¥æŒ‡ç¤ºå™¨
                QQ_ClearAllTypingIndicators();
                
                // æ¸…ç†å…¨å±€çŠ¶æ€
                if (typeof gening !== 'undefined') {
                    gening = false;
                }
                
                console.log('âœ… æ‰€æœ‰èµ„æºæ¸…ç†å®Œæˆ');
            };
            
            /**
             * åˆå§‹åŒ–è”ç»œäººæœç´¢åŠŸèƒ½
             */
            async function initContactSearch() {
                console.log("åˆå§‹åŒ–è”ç»œäººæœç´¢åŠŸèƒ½");
                
                const searchInput = document.getElementById('contact_search_input');
                const clearBtn = document.getElementById('search_clear_btn');
                const floatingSearchBox = document.getElementById('floating_search_box');
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»åˆå§‹åŒ–è¿‡
                if (searchInput && searchInput.hasAttribute('data-initialized')) {
                    console.log("æœç´¢åŠŸèƒ½å·²ç»åˆå§‹åŒ–è¿‡ï¼Œè·³è¿‡");
                    return;
                }
                
                if (!searchInput) {
                    console.error("æœç´¢è¾“å…¥æ¡†æœªæ‰¾åˆ° (ID: contact_search_input)");
                    return;
                }
                if (!clearBtn) {
                    console.error("æ¸…é™¤æŒ‰é’®æœªæ‰¾åˆ° (ID: search_clear_btn)");
                    return;
                }
                if (!floatingSearchBox) {
                    console.error("æœç´¢æ¡†å®¹å™¨æœªæ‰¾åˆ° (ID: floating_search_box)");
                    return;
                }
                
                // é˜²æŠ–å‡½æ•°ï¼Œé¿å…é¢‘ç¹æœç´¢
                let searchTimeout;
                function debounceSearch(searchTerm) {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        filterContacts(searchTerm);
                    }, 300); // å»¶è¿Ÿ300msæ‰§è¡Œæœç´¢
                }
                
                // è¾“å…¥æ¡†äº‹ä»¶ç›‘å¬
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.trim();
                    console.log(`æœç´¢è¾“å…¥: "${searchTerm}"`);
                    
                    // æ˜¾ç¤º/éšè—æ¸…é™¤æŒ‰é’®å¹¶æ›´æ–°æ ·å¼
                    if (searchTerm.length > 0) {
                        clearBtn.style.display = 'block';
                        floatingSearchBox.style.borderColor = 'rgba(25, 154, 255, 0.6)';
                        floatingSearchBox.style.backgroundColor = 'rgba(239, 243, 255, 0.95)';
                    } else {
                        clearBtn.style.display = 'none';
                        floatingSearchBox.style.borderColor = 'rgba(25, 154, 255, 0.2)';
                        floatingSearchBox.style.backgroundColor = 'rgba(239, 243, 255, 0.9)';
                    }
                    
                    // æ‰§è¡Œé˜²æŠ–æœç´¢
                    debounceSearch(searchTerm);
                });
                
                // æ¸…é™¤æŒ‰é’®äº‹ä»¶ç›‘å¬
                clearBtn.addEventListener('click', function() {
                    searchInput.value = '';
                    clearBtn.style.display = 'none';
                    floatingSearchBox.style.borderColor = 'rgba(25, 154, 255, 0.2)';
                    floatingSearchBox.style.backgroundColor = 'rgba(239, 243, 255, 0.9)';
                    
                    // æ¸…é™¤æœç´¢ï¼Œç«‹å³æ‰§è¡Œ
                    clearTimeout(searchTimeout);
                    filterContacts('');
                    
                    // é‡æ–°è·å¾—ç„¦ç‚¹
                    searchInput.focus();
                });
                
                // æœç´¢æ¡†è·å¾—ç„¦ç‚¹æ—¶çš„æ•ˆæœ
                searchInput.addEventListener('focus', function() {
                    floatingSearchBox.style.boxShadow = '0 2px 8px rgba(25, 154, 255, 0.3)';
                });
                
                // æœç´¢æ¡†å¤±å»ç„¦ç‚¹æ—¶çš„æ•ˆæœ
                searchInput.addEventListener('blur', function() {
                    floatingSearchBox.style.boxShadow = 'none';
                });
                
                // æ”¯æŒé”®ç›˜å¿«æ·é”®ï¼ˆEscape æ¸…é™¤æœç´¢ï¼‰
                searchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        e.preventDefault();
                        this.value = '';
                        clearBtn.style.display = 'none';
                        floatingSearchBox.style.borderColor = 'rgba(25, 154, 255, 0.2)';
                        floatingSearchBox.style.backgroundColor = 'rgba(239, 243, 255, 0.9)';
                        clearTimeout(searchTimeout);
                        filterContacts('');
                    }
                });
                
                // æ ‡è®°æœç´¢åŠŸèƒ½å·²åˆå§‹åŒ–
                searchInput.setAttribute('data-initialized', 'true');
                console.log("è”ç»œäººæœç´¢åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ");
                
                // ç¡®ä¿ç¾¤èŠåŠŸèƒ½ä¹Ÿå·²åˆå§‹åŒ–
                if (typeof reinitGroupChat === 'function') {
                    reinitGroupChat();
                }
                
                // æœç´¢åŠŸèƒ½åˆå§‹åŒ–ä¸éœ€è¦é‡æ–°åŠ è½½ç¾¤èŠæ•°æ®
                console.log('initContactSearch: æœç´¢åŠŸèƒ½å·²åˆå§‹åŒ–');
                
                // åˆå§‹åŒ–è”ç³»äººåˆ†ç»„åŠŸèƒ½
                if (typeof initContactGroups === 'function') {
                    initContactGroups();
                }
                
                // æ£€æŸ¥è”ç»œäººåˆ—è¡¨æ˜¯å¦å­˜åœ¨
                setTimeout(() => {
                    const contactsList = document.querySelector('#QQ_home_chars');
                    const contacts = contactsList ? contactsList.querySelectorAll('.QQ_home_usermsg') : [];
                    console.log(`å½“å‰è”ç»œäººæ•°é‡: ${contacts.length}`);
                    
                    // å¦‚æœæ²¡æœ‰è”ç»œäººï¼Œå¯ä»¥åœ¨æ§åˆ¶å°çœ‹åˆ°ç›¸å…³ä¿¡æ¯
                    if (contacts.length === 0) {
                        console.warn("å½“å‰æ²¡æœ‰è”ç»œäººæ•°æ®ï¼Œæœç´¢åŠŸèƒ½å¯èƒ½æ— æ³•æ˜¾ç¤ºæ•ˆæœ");
                        console.log("è¯·ç¡®ä¿ä¸–ç•Œä¹¦ä¸­æœ‰è”ç»œäººæ•°æ®ï¼Œæˆ–è€…æ‰‹åŠ¨æ·»åŠ ä¸€äº›è”ç»œäººæ¥æµ‹è¯•æœç´¢åŠŸèƒ½");
                    }
                }, 1000);
            }
            
            /**
             * è¿‡æ»¤è”ç»œäººåˆ—è¡¨ï¼ˆæ”¯æŒåˆ†ç»„ï¼‰
             * @param {string} searchTerm æœç´¢å…³é”®è¯
             */
            function filterContacts(searchTerm) {
                const contactsList = document.querySelector('#QQ_home_chars');
                if (!contactsList) {
                    console.error("è”ç»œäººåˆ—è¡¨æœªæ‰¾åˆ°");
                    return;
                }
                
                // é¢„å¤„ç†æœç´¢è¯
                const search = searchTerm.toLowerCase().trim();
                const isEmpty = search === '';
                let totalVisibleCount = 0;
                
                // æ·»åŠ æˆ–ç§»é™¤æœç´¢çŠ¶æ€CSSç±»
                if (isEmpty) {
                    contactsList.classList.remove('searching');
                } else {
                    contactsList.classList.add('searching');
                }
                
                // å¤„ç†åˆ†ç»„ä¸­çš„è”ç³»äºº
                const contactGroups = contactsList.querySelectorAll('.contact-group');
                contactGroups.forEach(groupElement => {
                    const groupContent = groupElement.querySelector('.group-content');
                    const contacts = groupContent ? groupContent.querySelectorAll('.QQ_home_usermsg') : [];
                    let groupVisibleCount = 0;
                    
                    contacts.forEach(contact => {
                        const isVisible = filterSingleContact(contact, search, searchTerm, isEmpty);
                        if (isVisible) {
                            groupVisibleCount++;
                            totalVisibleCount++;
                        }
                    });
                    
                    // æ˜¾ç¤º/éšè—åˆ†ç»„ï¼ˆå¦‚æœåˆ†ç»„å†…æœ‰åŒ¹é…çš„è”ç³»äººå°±æ˜¾ç¤ºåˆ†ç»„ï¼‰
                    if (!isEmpty) {
                        if (groupVisibleCount > 0) {
                            groupElement.style.display = '';
                            // å¦‚æœåˆ†ç»„æ˜¯æŠ˜å çŠ¶æ€ä¸”æœ‰æœç´¢ç»“æœï¼Œå±•å¼€åˆ†ç»„
                            const groupToggle = groupElement.querySelector('.group-toggle');
                            const groupContentDiv = groupElement.querySelector('.group-content');
                            if (groupToggle && groupToggle.classList.contains('collapsed')) {
                                groupToggle.classList.remove('collapsed');
                                groupContentDiv.classList.remove('collapsed');
                                groupContentDiv.classList.add('expanded');
                            }
                        } else {
                            groupElement.style.display = 'none';
                        }
                    } else {
                        // æœç´¢ä¸ºç©ºæ—¶æ˜¾ç¤ºæ‰€æœ‰åˆ†ç»„
                        groupElement.style.display = '';
                    }
                });
                
                // å¤„ç†æœªåˆ†ç»„çš„è”ç³»äºº
                const ungroupedSection = contactsList.querySelector('.ungrouped-contacts');
                if (ungroupedSection) {
                    const ungroupedContacts = ungroupedSection.querySelectorAll('.QQ_home_usermsg');
                    let ungroupedVisibleCount = 0;
                    
                    ungroupedContacts.forEach(contact => {
                        const isVisible = filterSingleContact(contact, search, searchTerm, isEmpty);
                        if (isVisible) {
                            ungroupedVisibleCount++;
                            totalVisibleCount++;
                        }
                    });
                    
                    // æ˜¾ç¤º/éšè—æœªåˆ†ç»„åŒºåŸŸ
                    if (!isEmpty) {
                        ungroupedSection.style.display = ungroupedVisibleCount > 0 ? '' : 'none';
                    } else {
                        ungroupedSection.style.display = '';
                    }
                }
                
                // å¤„ç†ç‹¬ç«‹çš„è”ç³»äººï¼ˆå¦‚æœæ²¡æœ‰åˆ†ç»„ç³»ç»Ÿï¼‰
                const independentContacts = contactsList.querySelectorAll('.QQ_home_usermsg:not(.contact-group .QQ_home_usermsg):not(.ungrouped-contacts .QQ_home_usermsg)');
                independentContacts.forEach(contact => {
                    const isVisible = filterSingleContact(contact, search, searchTerm, isEmpty);
                    if (isVisible) {
                        totalVisibleCount++;
                    }
                });
                
                // åœ¨æ§åˆ¶å°è¾“å‡ºæœç´¢ç»“æœï¼ˆè°ƒè¯•ç”¨ï¼‰
                if (!isEmpty) {
                    console.log(`æœç´¢"${searchTerm}": æ‰¾åˆ° ${totalVisibleCount} ä¸ªè”ç»œäºº`);
                }
                
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä»»ä½•åŒ¹é…é¡¹ï¼Œå¯ä»¥æ˜¾ç¤ºæç¤ºï¼ˆå¯é€‰ï¼‰
                if (!isEmpty && totalVisibleCount === 0) {
                    console.log("æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è”ç»œäºº");
                }
            }
            
            /**
             * è¿‡æ»¤å•ä¸ªè”ç³»äºº
             * @param {Element} contact è”ç³»äººå…ƒç´ 
             * @param {string} search æœç´¢è¯ï¼ˆå°å†™ï¼‰
             * @param {string} searchTerm åŸå§‹æœç´¢è¯
             * @param {boolean} isEmpty æ˜¯å¦ä¸ºç©ºæœç´¢
             * @returns {boolean} æ˜¯å¦æ˜¾ç¤ºè¯¥è”ç³»äºº
             */
            function filterSingleContact(contact, search, searchTerm, isEmpty) {
                const nameElement = contact.querySelector('.QQ_home_name');
                const lastMsgElement = contact.querySelector('.QQ_home_lastmsg');
                
                if (!nameElement) {
                    console.warn("è”ç»œäººé¡¹ç›®ç¼ºå°‘å§“åå…ƒç´ ", contact);
                    return false;
                }
                
                // è·å–åŸå§‹æ–‡æœ¬å†…å®¹
                const originalName = nameElement.getAttribute('data-original-text') || nameElement.textContent;
                const name = originalName.toLowerCase();
                const lastMsg = lastMsgElement ? lastMsgElement.textContent.toLowerCase() : '';
                
                // æ£€æŸ¥æ˜¯å¦åŒ¹é…æœç´¢æ¡ä»¶
                const nameMatches = isEmpty || name.includes(search);
                const msgMatches = isEmpty || lastMsg.includes(search);
                const isMatch = nameMatches || msgMatches;
                
                if (isMatch) {
                    // æ˜¾ç¤ºè”ç»œäºº
                    contact.style.display = '';
                    
                    // å¤„ç†é«˜äº®æ˜¾ç¤º
                    if (!isEmpty && nameMatches) {
                        highlightContactSearchTerm(nameElement, searchTerm, originalName);
                    } else {
                        // æ¢å¤åŸå§‹æ–‡æœ¬ï¼Œç§»é™¤é«˜äº®
                        if (nameElement.getAttribute('data-original-text')) {
                            nameElement.innerHTML = originalName;
                        }
                    }
                    
                    return true;
                } else {
                    // éšè—ä¸åŒ¹é…çš„è”ç»œäºº
                    contact.style.display = 'none';
                    return false;
                }
            }
            
            /**
             * è”ç³»äººæœç´¢é«˜äº®åŠŸèƒ½
             * @param {Element} element è¦é«˜äº®çš„å…ƒç´ 
             * @param {string} searchTerm æœç´¢è¯
             * @param {string} originalText åŸå§‹æ–‡æœ¬
             */
            function highlightContactSearchTerm(element, searchTerm, originalText) {
                if (!searchTerm || searchTerm.trim() === '') {
                    element.innerHTML = originalText;
                    return;
                }
                
                // ä¿å­˜åŸå§‹æ–‡æœ¬
                if (!element.getAttribute('data-original-text')) {
                    element.setAttribute('data-original-text', originalText);
                }
                
                // åˆ›å»ºé«˜äº®HTML
                const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                const highlightedText = originalText.replace(regex, '<span style="background-color: #FFE066; color: #333; font-weight: bold; padding: 1px 2px; border-radius: 2px;">$1</span>');
                
                element.innerHTML = highlightedText;
            }
            
            /**
             * é«˜äº®æœç´¢è¯
             * @param {Element} element è¦é«˜äº®çš„å…ƒç´ 
             * @param {string} searchTerm æœç´¢è¯
             */
            function highlightSearchTerm(element, searchTerm) {
                // ä¿å­˜åŸå§‹æ–‡æœ¬ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ä¿å­˜ï¼‰
                if (!element.getAttribute('data-original-text')) {
                    element.setAttribute('data-original-text', element.textContent);
                }
                
                const originalText = element.getAttribute('data-original-text');
                
                // å¦‚æœæœç´¢è¯ä¸ºç©ºï¼Œæ¢å¤åŸå§‹æ–‡æœ¬
                if (!searchTerm || searchTerm.trim() === '') {
                    element.innerHTML = originalText;
                    return;
                }
                
                // è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ï¼Œé˜²æ­¢æ­£åˆ™è¡¨è¾¾å¼é”™è¯¯
                const escapedSearchTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`(${escapedSearchTerm})`, 'gi');
                const highlightedText = originalText.replace(regex, '<span class="search-highlight">$1</span>');
                
                element.innerHTML = highlightedText;
            }
        </script>

        <!-- ç¾¤èŠç®¡ç†ä¸‹æ‹‰èœå• -->
        <div id="group_management_dropdown" class="group-management-dropdown" style="display: none;">
            <div class="group-management-header">
                <div class="group-management-title">ç¾¤èŠæˆå‘˜</div>
                <svg class="group-settings-icon" onclick="showGroupSettings()" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11.03L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11.03C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                </svg>
            </div>
            <div class="group-members-list" id="group_members_display">
                <!-- ç¾¤æˆå‘˜åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <!-- ç¾¤èŠè®¾ç½®æ¨¡æ€çª—å£ -->
        <div id="group_settings_modal" class="group-settings-modal">
            <div class="group-settings-content">
                <div class="group-settings-header">
                    <h3 class="group-settings-title">ç¾¤èŠè®¾ç½®</h3>
                </div>
                <div class="group-settings-body">
                    <div class="group-settings-section">
                        <div class="group-settings-section-title">ç¾¤èŠåç§°</div>
                        <input type="text" id="group_name_edit" class="group-settings-input" placeholder="è¾“å…¥ç¾¤èŠåç§°">
                    </div>
                    <div class="group-settings-section">
                        <div class="group-settings-section-title">ç¾¤èŠå¤´åƒ</div>
                        <div class="group-settings-avatar-container">
                            <div class="group-settings-avatar-preview" id="group_settings_avatar_preview" onclick="showGroupAvatarSelector()">
                                <div class="group-settings-default-avatar">ç¾¤</div>
                            </div>
                            <div class="group-settings-avatar-text" onclick="showGroupAvatarSelector()">ç‚¹å‡»æ›´æ¢å¤´åƒ</div>
                        </div>
                    </div>
                    <div class="group-settings-section">
                        <div class="group-settings-section-title">ç¾¤æˆå‘˜ç®¡ç†</div>
                        <div class="group-settings-member-list" id="group_members_edit">
                            <!-- ç¾¤æˆå‘˜ç¼–è¾‘åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
                <div class="group-settings-actions">
                    <button class="group-settings-btn group-settings-cancel-btn" onclick="closeGroupSettings()">å–æ¶ˆ</button>
                    <button class="group-settings-btn group-settings-save-btn" onclick="saveGroupSettings()">ä¿å­˜</button>
                    <button class="group-settings-btn group-settings-delete-btn" onclick="deleteCurrentGroup()">åˆ é™¤ç¾¤èŠ</button>
                </div>
            </div>
        </div>

        <!-- ç¾¤èŠåˆ›å»ºå¼¹çª—ç³»ç»Ÿ -->
        <!-- ç¬¬ä¸€å±‚å¼¹çª—ï¼šé€‰æ‹©åˆ›å»ºç±»å‹ -->
        <div id="group_chat_modal" class="group-chat-modal" style="display: none;">
            <div class="group-chat-dialog">
                <div class="group-chat-header">
                    æ–°å»º
                </div>
                <div class="group-chat-content">
                    <div class="group-chat-option" onclick="openGroupCreateModal()">
                        <svg class="group-chat-option-icon" viewBox="0 0 1024 1024">
                            <path d="M320 896c-35.2 0-64-28.8-64-64V288c0-35.2 28.8-64 64-64s64 28.8 64 64v544c0 35.2-28.8 64-64 64zM704 896c-35.2 0-64-28.8-64-64V288c0-35.2 28.8-64 64-64s64 28.8 64 64v544c0 35.2-28.8 64-64 64zM512 1024c-106.039 0-192-85.961-192-192s85.961-192 192-192 192 85.961 192 192-85.961 192-192 192z m0-128c70.692 0 128-57.308 128-128s-57.308-128-128-128-128 57.308-128 128 57.308 128 128 128z"/>
                        </svg>
                        <span class="group-chat-option-text">å‘èµ·ç¾¤èŠ</span>
                    </div>
                    <div class="group-chat-option" onclick="openContactGroupModal()">
                        <svg class="group-chat-option-icon" viewBox="0 0 1024 1024">
                            <path d="M853.333 256H682.667c0-47.147-38.187-85.333-85.333-85.333H426.667c-47.147 0-85.333 38.187-85.333 85.333H170.667C123.52 256 85.333 294.187 85.333 341.333v426.667c0 47.147 38.187 85.333 85.333 85.333h682.667c47.147 0 85.333-38.187 85.333-85.333V341.333c0-47.147-38.187-85.333-85.333-85.333zM426.667 256h170.667v85.333H426.667V256zm426.667 512H170.667V341.333h170.667v42.667c0 23.573 19.093 42.667 42.667 42.667s42.667-19.093 42.667-42.667v-42.667h170.667v42.667c0 23.573 19.093 42.667 42.667 42.667s42.667-19.093 42.667-42.667v-42.667h170.667V768z"/>
                        </svg>
                        <span class="group-chat-option-text">æ–°å»ºåˆ†ç»„</span>
                    </div>
                    <div class="group-chat-option" onclick="closeGroupChatModal()">
                        <svg class="group-chat-option-icon" viewBox="0 0 1024 1024">
                            <path d="M628.64 183.936a64 64 0 0 1 90.368 90.368L557.312 435.84l161.696 161.472a64 64 0 1 1-90.368 90.368L466.944 526.208 305.472 687.68a64 64 0 1 1-90.368-90.368L376.576 435.84 214.88 274.368a64 64 0 0 1 90.368-90.368l161.696 161.472 161.696-161.472z"/>
                        </svg>
                        <span class="group-chat-option-text">æ·»åŠ æœ‹å‹</span>
                    </div>
                    <div class="group-chat-option" onclick="closeGroupChatModal()">
                        <svg class="group-chat-option-icon" viewBox="0 0 1024 1024">
                            <path d="M304 176h416c79.4 0 144 64.6 144 144v384c0 79.4-64.6 144-144 144H304c-79.4 0-144-64.6-144-144V320c0-79.4 64.6-144 144-144z m0 64c-44.2 0-80 35.8-80 80v384c0 44.2 35.8 80 80 80h416c44.2 0 80-35.8 80-80V320c0-44.2-35.8-80-80-80H304z"/>
                        </svg>
                        <span class="group-chat-option-text">æ‰«ä¸€æ‰«</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¬¬äºŒå±‚å¼¹çª—ï¼šåˆ›å»ºç¾¤èŠ -->
        <div id="group_create_modal" class="group-create-modal" style="display: none;">
            <div class="group-create-dialog">
                <div class="group-create-header">
                    <span class="group-create-title">å‘èµ·ç¾¤èŠ</span>
                    <span class="group-create-close" onclick="closeGroupCreateModal()">&times;</span>
                </div>
                <div class="group-create-content">
                    <div class="group-name-section">
                        <label class="group-name-label">ç¾¤èŠåç§°</label>
                        <input 
                            type="text" 
                            id="group_name_input" 
                            class="group-name-input" 
                            placeholder="è¯·è¾“å…¥ç¾¤èŠåç§°"
                            maxlength="20"
                        >
                    </div>
                    <div class="group-avatar-section">
                        <label class="group-avatar-label">ç¾¤èŠå¤´åƒ</label>
                        <div class="group-avatar-selector">
                            <div class="group-avatar-preview" id="group_avatar_preview" onclick="showAvatarSelector()">
                                <div class="default-group-avatar">+</div>
                            </div>
                            <div class="group-avatar-text" onclick="showAvatarSelector()">ç‚¹å‡»è®¾ç½®å¤´åƒ</div>
                        </div>
                    </div>
                    <div class="group-members-section">
                        <div class="group-members-label">é€‰æ‹©ç¾¤æˆå‘˜</div>
                        <div class="group-member-search">
                            <span class="group-search-icon">ğŸ”</span>
                            <input 
                                type="text" 
                                class="group-search-input" 
                                id="group_member_search" 
                                placeholder="æœç´¢è”ç³»äºº..."
                                oninput="filterGroupMembers()"
                                onkeydown="handleGroupSearchKeydown(event)"
                            >
                            <span class="group-search-clear" id="group_search_clear" onclick="clearGroupSearch()">âœ•</span>
                        </div>
                        <div class="contact-list-container">
                            <div id="contact_list_for_group">
                                <!-- è¿™é‡Œå°†åŠ¨æ€åŠ è½½è”ç³»äººåˆ—è¡¨ -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="group-create-actions">
                    <button class="group-action-btn group-cancel-btn" onclick="closeGroupCreateModal()">
                        å–æ¶ˆ
                    </button>
                    <button class="group-action-btn group-confirm-btn" id="group_confirm_btn" onclick="createGroupChat()">
                        åˆ›å»ºç¾¤èŠ
                    </button>
                </div>
            </div>
        </div>

        <!-- å¤´åƒé€‰æ‹©å¼¹çª— -->
        <div id="avatar_selector_modal" class="avatar-selector-modal" style="display: none;">
            <div class="avatar-selector-dialog">
                <div class="avatar-selector-header">
                    <span class="avatar-selector-title">é€‰æ‹©ç¾¤èŠå¤´åƒ</span>
                    <span class="avatar-selector-close" onclick="closeAvatarSelector()">&times;</span>
                </div>
                <div class="avatar-selector-content">
                    <div class="avatar-selector-tabs">
                        <div class="avatar-tab active" onclick="switchAvatarTab('preset')">é¢„è®¾å¤´åƒ</div>
                        <div class="avatar-tab" onclick="switchAvatarTab('upload')">ä¸Šä¼ å¤´åƒ</div>
                        <div class="avatar-tab" onclick="switchAvatarTab('url')">è¾“å…¥é“¾æ¥</div>
                    </div>
                    <div class="avatar-selector-body">
                        <!-- é¢„è®¾å¤´åƒé€‰é¡¹ -->
                        <div id="preset_avatars" class="avatar-options active">
                            <div class="preset-avatar-grid">
                                <!-- è¿™é‡Œä¼šåŠ¨æ€åŠ è½½é¢„è®¾å¤´åƒ -->
                            </div>
                        </div>
                        <!-- ä¸Šä¼ å¤´åƒé€‰é¡¹ -->
                        <div id="upload_avatars" class="avatar-options">
                            <div class="upload-zone" onclick="triggerFileUpload()">
                                <div class="upload-icon">ğŸ“</div>
                                <div class="upload-text">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</div>
                                <div class="upload-hint">æ”¯æŒ JPGã€PNG æ ¼å¼</div>
                            </div>
                            <input type="file" id="avatar_upload_input" accept="image/*" style="display: none;" onchange="handleAvatarUpload(event)">
                        </div>
                        <!-- è¾“å…¥é“¾æ¥é€‰é¡¹ -->
                        <div id="url_avatars" class="avatar-options">
                            <div class="url-input-zone">
                                <div class="url-input-title">è¾“å…¥å›¾ç‰‡é“¾æ¥</div>
                                <input 
                                    type="url" 
                                    id="avatar_url_input" 
                                    class="url-input" 
                                    placeholder="è¯·è¾“å…¥å›¾ç‰‡é“¾æ¥ (å¦‚: https://catbox.moe/...)"
                                    oninput="handleAvatarUrlInput()"
                                >
                                <div class="url-input-hint">
                                    æ¨èä½¿ç”¨ <a href="https://catbox.moe" target="_blank" style="color: #199AFF;">catbox.moe</a> ç­‰å›¾åºŠæœåŠ¡
                                </div>
                                <div id="url_preview_container" class="url-preview-container" style="display: none;">
                                    <div class="url-preview-title">é¢„è§ˆ</div>
                                    <img id="url_preview_image" class="url-preview-image" alt="é¢„è§ˆå›¾ç‰‡">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="avatar-selector-actions">
                    <button class="avatar-action-btn avatar-cancel-btn" onclick="closeAvatarSelector()">
                        å–æ¶ˆ
                    </button>
                    <button class="avatar-action-btn avatar-confirm-btn" id="avatar_confirm_btn" onclick="confirmAvatarSelection()">
                        ç¡®è®¤
                    </button>
                </div>
            </div>
        </div>

        <!-- æ–°å»ºåˆ†ç»„å¼¹çª— -->
        <div id="new_group_modal" class="new-group-modal">
            <div class="new-group-dialog">
                <div class="new-group-title">æ–°å»ºåˆ†ç»„</div>
                <input 
                    type="text" 
                    id="new_group_name_input"
                    class="new-group-input" 
                    placeholder="è¯·è¾“å…¥åˆ†ç»„åç§°"
                    maxlength="15"
                    onkeydown="handleNewGroupKeydown(event)"
                >
                <div class="new-group-actions">
                    <button class="new-group-btn new-group-cancel" onclick="closeNewGroupModal()">
                        å–æ¶ˆ
                    </button>
                                    <button class="new-group-btn new-group-confirm" onclick="createNewContactGroup()">
                    åˆ›å»º
                </button>
                </div>
            </div>
        </div>

        <!-- æ·»åŠ æˆå‘˜å¼¹çª— -->
        <div id="add_member_modal" class="add-member-modal" style="display: none;">
            <div class="add-member-dialog">
                <div class="add-member-header">
                    <h3 class="add-member-title">é€‰æ‹©ç¾¤æˆå‘˜</h3>
                    <span class="add-member-close" onclick="closeAddMemberModal()">&times;</span>
                </div>
                <div class="add-member-content">
                    <div class="add-member-search">
                        <input 
                            type="text" 
                            class="add-member-search-input" 
                            id="add_member_search_input"
                            placeholder="æœç´¢è”ç³»äºº..."
                            oninput="filterAddMemberContacts()"
                        >
                        <span class="add-member-search-icon">ğŸ”</span>
                    </div>
                    <div class="add-member-contact-list" id="add_member_contact_list">
                        <!-- è”ç³»äººåˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                <div class="add-member-actions">
                    <button class="add-member-btn add-member-cancel-btn" onclick="closeAddMemberModal()">
                        å–æ¶ˆ
                    </button>
                    <button class="add-member-btn add-member-confirm-btn" id="add_member_confirm_btn" onclick="confirmAddMembers()" disabled>
                        æ·»åŠ æˆå‘˜
                    </button>
                </div>
            </div>
        </div>

        <script>
            // ç¾¤èŠåˆ›å»ºåŠŸèƒ½JavaScriptä»£ç 
            
            /**
             * æ˜¾ç¤ºç¾¤èŠé€‰é¡¹å¼¹çª—
             */
            function showGroupChatModal() {
                console.log('showGroupChatModal å‡½æ•°è¢«è°ƒç”¨');
                const modal = document.getElementById('group_chat_modal');
                console.log('å¼¹çª—å…ƒç´ :', modal);
                
                if (modal) {
                    console.log('æ˜¾ç¤ºå¼¹çª—...');
                    modal.style.display = 'flex';
                    modal.style.zIndex = '9999';
                    
                    // æ·»åŠ èƒŒæ™¯ç‚¹å‡»å…³é—­åŠŸèƒ½
                    modal.addEventListener('click', function(e) {
                        if (e.target === modal) {
                            closeGroupChatModal();
                        }
                    });
                    
                    console.log('å¼¹çª—å·²æ˜¾ç¤ºï¼Œå½“å‰æ ·å¼:', modal.style.display);
                } else {
                    console.error('æœªæ‰¾åˆ°å¼¹çª—å…ƒç´  (ID: group_chat_modal)');
                    alert('å¼¹çª—å…ƒç´ æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥é¡µé¢ç»“æ„');
                }
            }
            
            /**
             * å…³é—­ç¾¤èŠé€‰é¡¹å¼¹çª—
             */
            function closeGroupChatModal() {
                const modal = document.getElementById('group_chat_modal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }
            
            /**
             * æ‰“å¼€ç¾¤èŠåˆ›å»ºå¼¹çª—
             */
            function openGroupCreateModal() {
                // å…ˆå…³é—­ç¬¬ä¸€å±‚å¼¹çª—
                closeGroupChatModal();
                
                // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´å†æ˜¾ç¤ºç¬¬äºŒå±‚å¼¹çª—ï¼Œè®©åŠ¨ç”»æ›´æµç•…
                setTimeout(() => {
                    const modal = document.getElementById('group_create_modal');
                    if (modal) {
                        modal.style.display = 'flex';
                        
                        // åŠ è½½è”ç³»äººåˆ—è¡¨
                        loadContactsForGroup();
                        
                        // é‡ç½®è¡¨å•å’Œæœç´¢
                        document.getElementById('group_name_input').value = '';
                        const searchInput = document.getElementById('group_member_search');
                        if (searchInput) {
                            searchInput.value = '';
                        }
                        const clearBtn = document.getElementById('group_search_clear');
                        if (clearBtn) {
                            clearBtn.classList.remove('show');
                        }
                        updateConfirmButtonState();
                        
                        // æ·»åŠ èƒŒæ™¯ç‚¹å‡»å…³é—­åŠŸèƒ½
                        modal.addEventListener('click', function(e) {
                            if (e.target === modal) {
                                closeGroupCreateModal();
                            }
                        });
                    }
                }, 150);
            }
            
            /**
             * å…³é—­ç¾¤èŠåˆ›å»ºå¼¹çª—
             */
            function closeGroupCreateModal() {
                const modal = document.getElementById('group_create_modal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }
            
            /**
             * åŠ è½½è”ç³»äººåˆ—è¡¨åˆ°ç¾¤èŠåˆ›å»ºå¼¹çª—
             */
            function loadContactsForGroup() {
                const contactListContainer = document.getElementById('contact_list_for_group');
                const homeChars = document.getElementById('QQ_home_chars');
                
                if (!contactListContainer || !homeChars) return;
                
                // æ¸…ç©ºä¹‹å‰çš„å†…å®¹
                contactListContainer.innerHTML = '';
                
                // è·å–æ‰€æœ‰è”ç³»äºº
                const contacts = homeChars.querySelectorAll('.QQ_home_usermsg');
                
                if (contacts.length === 0) {
                    contactListContainer.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— è”ç³»äºº</div>';
                    return;
                }
                
                // ä¸ºæ¯ä¸ªè”ç³»äººåˆ›å»ºå¤é€‰æ¡†é¡¹ï¼ˆæ’é™¤ç¾¤èŠï¼‰
                contacts.forEach((contact, index) => {
                    const nameElement = contact.querySelector('.QQ_home_name');
                    const headElement = contact.querySelector('.QQ_home_head');
                    
                    if (!nameElement) return;
                    
                    // è·³è¿‡ç¾¤èŠç±»å‹çš„è”ç³»äºº
                    if (contact.hasAttribute('data-group-type')) {
                        return;
                    }
                    
                    const contactName = nameElement.textContent.trim();
                    
                    // è·å–å¤´åƒæ ·å¼ - ç›´æ¥å¤åˆ¶åŸå§‹å…ƒç´ çš„æ‰€æœ‰æ ·å¼
                    let avatarStyle = '';
                    let hasRealAvatar = false;
                    
                    if (headElement) {
                        // ç›´æ¥è·å–å†…è”æ ·å¼
                        const inlineStyle = headElement.getAttribute('style') || '';
                        
                        // è·å–è®¡ç®—æ ·å¼
                        const computedStyle = window.getComputedStyle(headElement);
                        const backgroundImage = computedStyle.backgroundImage;
                        const backgroundColor = computedStyle.backgroundColor;
                        
                        // console.log('å¤´åƒè°ƒè¯•ä¿¡æ¯:', {
                        //     inlineStyle,
                        //     backgroundImage,
                        //     backgroundColor,
                        //     contactName
                        // });
                        
                        if (inlineStyle && inlineStyle.includes('background')) {
                            // ä¼˜å…ˆä½¿ç”¨å†…è”æ ·å¼
                            avatarStyle = inlineStyle;
                            hasRealAvatar = inlineStyle.includes('background-image');
                        } else if (backgroundImage && backgroundImage !== 'none') {
                            avatarStyle = `background-image: ${backgroundImage}; background-size: cover; background-position: center;`;
                            hasRealAvatar = true;
                        } else if (backgroundColor && backgroundColor !== 'rgba(0, 0, 0, 0)' && backgroundColor !== 'transparent') {
                            avatarStyle = `background-color: ${backgroundColor};`;
                        }
                        
                        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„èƒŒæ™¯ï¼Œä½¿ç”¨é»˜è®¤é¢œè‰²
                        if (!avatarStyle || avatarStyle === '') {
                            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F'];
                            const color = colors[index % colors.length];
                            avatarStyle = `background-color: ${color};`;
                        }
                    } else {
                        // é»˜è®¤å¤´åƒé¢œè‰²
                        const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F'];
                        const color = colors[index % colors.length];
                        avatarStyle = `background-color: ${color};`;
                    }
                    
                    const contactItem = document.createElement('div');
                    contactItem.className = 'contact-item';
                    contactItem.setAttribute('data-contact-name', contactName);
                    contactItem.setAttribute('data-contact-index', index);
                    contactItem.onclick = () => toggleContactSelection(contactItem);
                    
                    contactItem.innerHTML = `
                        <input 
                            type="checkbox" 
                            id="contact_${index}" 
                            class="contact-checkbox"
                            data-contact-name="${contactName}"
                        >
                        <div class="contact-avatar" style="${avatarStyle}">
                            ${!hasRealAvatar ? 
                                `<span style="color: white; font-size: 12px; font-weight: bold; display: flex; align-items: center; justify-content: center; height: 100%;">${contactName.charAt(0)}</span>` : 
                                ''
                            }
                        </div>
                        <span class="contact-name">${contactName}</span>
                    `;
                    
                    contactListContainer.appendChild(contactItem);
                });
            }
            
            /**
             * åˆ‡æ¢è”ç³»äººé€‰æ‹©çŠ¶æ€
             */
            function toggleContactSelection(contactItem) {
                const checkbox = contactItem.querySelector('.contact-checkbox');
                
                if (contactItem.classList.contains('selected')) {
                    // å–æ¶ˆé€‰æ‹©
                    contactItem.classList.remove('selected');
                    if (checkbox) checkbox.checked = false;
                } else {
                    // é€‰æ‹©
                    contactItem.classList.add('selected');
                    if (checkbox) checkbox.checked = true;
                }
                
                updateConfirmButtonState();
                
                // æ·»åŠ é€‰æ‹©çŠ¶æ€çš„è°ƒè¯•ä¿¡æ¯
                const contactName = contactItem.getAttribute('data-contact-name');
                const isSelected = contactItem.classList.contains('selected');
                console.log(`è”ç³»äºº "${contactName}" é€‰æ‹©çŠ¶æ€: ${isSelected ? 'å·²é€‰ä¸­' : 'æœªé€‰ä¸­'}`);
            }
            
            /**
             * é«˜äº®æœç´¢å…³é”®å­—
             */
            function highlightSearchTerm(text, searchTerm) {
                if (!searchTerm || searchTerm.trim() === '') {
                    return text;
                }
                
                const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                return text.replace(regex, '<span style="background-color: #FFE066; color: #333; font-weight: bold; padding: 1px 2px; border-radius: 2px;">$1</span>');
            }
            
            /**
             * ç¾¤èŠæˆå‘˜æœç´¢åŠŸèƒ½
             */
            function filterGroupMembers() {
                const searchInput = document.getElementById('group_member_search');
                const clearBtn = document.getElementById('group_search_clear');
                const contactItems = document.querySelectorAll('#contact_list_for_group .contact-item');
                const contactListContainer = document.getElementById('contact_list_for_group');
                
                if (!searchInput || !contactItems.length) return;
                
                const searchTerm = searchInput.value.toLowerCase().trim();
                const originalSearchTerm = searchInput.value.trim(); // ä¿æŒåŸå§‹å¤§å°å†™
                
                // æ˜¾ç¤º/éšè—æ¸…é™¤æŒ‰é’®
                if (searchTerm.length > 0) {
                    clearBtn.classList.add('show');
                } else {
                    clearBtn.classList.remove('show');
                }
                
                let visibleCount = 0;
                
                contactItems.forEach(item => {
                    const originalContactName = item.getAttribute('data-contact-name');
                    const contactName = originalContactName.toLowerCase();
                    const nameElement = item.querySelector('.contact-name');
                    
                    if (contactName.includes(searchTerm)) {
                        item.style.display = 'flex';
                        visibleCount++;
                        
                        // é«˜äº®åŒ¹é…çš„å…³é”®å­—
                        if (searchTerm.length > 0) {
                            nameElement.innerHTML = highlightSearchTerm(originalContactName, originalSearchTerm);
                        } else {
                            nameElement.textContent = originalContactName;
                        }
                    } else {
                        item.style.display = 'none';
                        // é‡ç½®æ–‡æœ¬å†…å®¹
                        nameElement.textContent = originalContactName;
                    }
                });
                
                // æ˜¾ç¤ºæ— æœç´¢ç»“æœæç¤º
                let noResultsDiv = contactListContainer.querySelector('.no-results');
                if (visibleCount === 0 && searchTerm.length > 0) {
                    if (!noResultsDiv) {
                        noResultsDiv = document.createElement('div');
                        noResultsDiv.className = 'no-results';
                        noResultsDiv.textContent = 'æœªæ‰¾åˆ°åŒ¹é…çš„è”ç³»äºº';
                        contactListContainer.appendChild(noResultsDiv);
                    }
                    noResultsDiv.style.display = 'block';
                } else if (noResultsDiv) {
                    noResultsDiv.style.display = 'none';
                }
            }
            
            /**
             * æ¸…é™¤ç¾¤èŠæˆå‘˜æœç´¢
             */
            function clearGroupSearch() {
                const searchInput = document.getElementById('group_member_search');
                const clearBtn = document.getElementById('group_search_clear');
                
                if (searchInput) {
                    searchInput.value = '';
                    searchInput.focus();
                }
                
                if (clearBtn) {
                    clearBtn.classList.remove('show');
                }
                
                // æ¸…é™¤æ‰€æœ‰é«˜äº®å¹¶æ˜¾ç¤ºæ‰€æœ‰è”ç³»äºº
                const contactItems = document.querySelectorAll('#contact_list_for_group .contact-item');
                contactItems.forEach(item => {
                    const nameElement = item.querySelector('.contact-name');
                    const originalName = item.getAttribute('data-contact-name');
                    
                    item.style.display = 'flex';
                    nameElement.textContent = originalName; // æ¸…é™¤é«˜äº®
                });
                
                // éšè—æ— ç»“æœæç¤º
                const noResultsDiv = document.getElementById('contact_list_for_group').querySelector('.no-results');
                if (noResultsDiv) {
                    noResultsDiv.style.display = 'none';
                }
            }
            
            /**
             * å¤„ç†ç¾¤èŠæœç´¢é”®ç›˜äº‹ä»¶
             */
            function handleGroupSearchKeydown(event) {
                if (event.key === 'Escape') {
                    clearGroupSearch();
                } else if (event.key === 'Enter') {
                    // å¦‚æœåªæœ‰ä¸€ä¸ªå¯è§çš„è”ç³»äººï¼Œç›´æ¥é€‰æ‹©å®ƒ
                    const visibleItems = document.querySelectorAll('#contact_list_for_group .contact-item[style*="flex"], #contact_list_for_group .contact-item:not([style*="none"])');
                    if (visibleItems.length === 1) {
                        toggleContactSelection(visibleItems[0]);
                    }
                }
            }
            
            /**
             * æ›´æ–°ç¡®è®¤æŒ‰é’®çŠ¶æ€
             */
            function updateConfirmButtonState() {
                const confirmBtn = document.getElementById('group_confirm_btn');
                const groupNameInput = document.getElementById('group_name_input');
                const selectedItems = document.querySelectorAll('#contact_list_for_group .contact-item.selected');
                
                if (!confirmBtn || !groupNameInput) return;
                
                const hasName = groupNameInput.value.trim().length > 0;
                const hasMembers = selectedItems.length > 0;
                
                confirmBtn.disabled = !(hasName && hasMembers);
                
                console.log('æ›´æ–°ç¾¤èŠç¡®è®¤æŒ‰é’®çŠ¶æ€:', {
                    hasName,
                    hasMembers,
                    disabled: confirmBtn.disabled,
                    nameLength: groupNameInput.value.trim().length,
                    selectedCount: selectedItems.length
                });
            }
            
            // è¿™ä¸ªå‡½æ•°å·²è¢«ä¸‹é¢æ›´å®Œæ•´çš„ç‰ˆæœ¬æ›¿ä»£ï¼Œå·²åˆ é™¤é‡å¤å®šä¹‰
            
            /**
             * ç”Ÿæˆç¾¤èŠå¤´åƒï¼ˆä½¿ç”¨ç¾¤æˆå‘˜å¤´åƒç»„åˆæˆ–é»˜è®¤æ ·å¼ï¼‰
             */
            function generateGroupAvatar(members) {
                // ç®€å•çš„ç¾¤èŠå¤´åƒç”Ÿæˆï¼šä½¿ç”¨æ¸å˜èƒŒæ™¯
                const colors = [
                    'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                    'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                    'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                    'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                    'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)'
                ];
                return colors[Math.floor(Math.random() * colors.length)];
            }
            
            /**
             * è·å–å½“å‰æ—¶é—´å­—ç¬¦ä¸²
             */
            function getCurrentTime() {
                const now = new Date();
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                return `${hours}:${minutes}`;
            }
            
            /**
             * *** é˜¶æ®µä¸€ï¼šå®æ—¶æ—¶é—´æˆ³ç”Ÿæˆ ***
             * ç»Ÿä¸€çš„å®æ—¶æ—¶é—´æˆ³ç”Ÿæˆå‡½æ•°ï¼Œç¡®ä¿æ‰€æœ‰æ—¶é—´æˆ³éƒ½æ˜¯çœŸå®çš„ç³»ç»Ÿæ—¶é—´
             * @returns {string} æ ¼å¼åŒ–çš„æ—¶é—´æˆ³ (HH:MM)
             */
            function QQ_GetTime() {
                // *** ä¿®æ”¹ï¼šä½¿ç”¨å®Œæ•´çš„æ—¥æœŸæ—¶é—´æ ¼å¼ï¼Œè§£å†³è·¨æ—¥æ’åºé—®é¢˜ ***
                const now = new Date();
                return now.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit', 
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                }).replace(/\//g, '/');
            }
            
            /**
             * *** é˜¶æ®µäºŒæ ¸å¿ƒï¼šä¸Šä¸‹æ–‡æ„ŸçŸ¥ç³»ç»Ÿ ***
             * è®©AIèƒ½å¤Ÿ"çœ‹åˆ°"ç¯å¢ƒå˜åŒ–ï¼Œä¸ºä¸»åŠ¨è¡Œä¸ºæ‰“ä¸‹åŸºç¡€
             */
            
            // å…¨å±€ä¸Šä¸‹æ–‡çŠ¶æ€ç®¡ç†
            window.QQ_SystemContext = {
                userOnlineStatus: false,
                lastOnlineTime: null,
                currentChatName: null,
                currentChatType: null, // 'private', 'group', 'moment'
                unreadMessages: new Map(), // èŠå¤©çª—å£ -> æœªè¯»æ¶ˆæ¯æ•°ç»„
                readReceipts: new Map(),   // æ¶ˆæ¯ID -> å·²è¯»çŠ¶æ€
                systemEvents: []           // ç³»ç»Ÿäº‹ä»¶é˜Ÿåˆ—
            };
            
            /**
             * ç³»ç»Ÿäº‹ä»¶ç±»å‹å®šä¹‰
             */
            const QQ_SystemEventTypes = {
                USER_ONLINE: 'user_online',
                USER_OFFLINE: 'user_offline', 
                CHAT_SWITCH: 'chat_switch',
                MESSAGE_READ: 'message_read',
                GROUP_MEMBER_JOIN: 'group_member_join',
                GROUP_MEMBER_LEAVE: 'group_member_leave',
                GROUP_NAME_CHANGE: 'group_name_change'
            };
            
            /**
             * æ·»åŠ ç³»ç»Ÿäº‹ä»¶åˆ°é˜Ÿåˆ—
             * @param {string} eventType - äº‹ä»¶ç±»å‹
             * @param {Object} eventData - äº‹ä»¶æ•°æ®
             */
            function QQ_AddSystemEvent(eventType, eventData) {
                const event = {
                    type: eventType,
                    data: eventData,
                    timestamp: new Date().toISOString(),
                    processed: false
                };
                
                window.QQ_SystemContext.systemEvents.push(event);
                console.log(`ğŸ“ ç³»ç»Ÿäº‹ä»¶è®°å½•: ${eventType}`, eventData);
                
                // ä¿æŒäº‹ä»¶é˜Ÿåˆ—å¤§å°åœ¨åˆç†èŒƒå›´å†…
                if (window.QQ_SystemContext.systemEvents.length > 50) {
                    window.QQ_SystemContext.systemEvents = window.QQ_SystemContext.systemEvents.slice(-30);
                }
            }
            
            /**
             * ç”Ÿæˆç³»ç»Ÿä¸Šä¸‹æ–‡å­—ç¬¦ä¸²ï¼Œæ³¨å…¥åˆ°AIçš„Promptä¸­
             * @returns {string} æ ¼å¼åŒ–çš„ç³»ç»Ÿä¸Šä¸‹æ–‡
             */
            function QQ_GenerateSystemContext() {
                const context = [];
                const ctx = window.QQ_SystemContext;
                
                // ç”¨æˆ·åœ¨çº¿çŠ¶æ€
                if (ctx.userOnlineStatus) {
                    context.push(`[System Context: {{user}}å½“å‰åœ¨çº¿]`);
                } else {
                    context.push(`[System Context: {{user}}å½“å‰ç¦»çº¿]`);
                }
                
                // å½“å‰èŠå¤©ç¯å¢ƒ
                if (ctx.currentChatName && ctx.currentChatType) {
                    if (ctx.currentChatType === 'group') {
                        context.push(`[System Context: ä½ ç°åœ¨åœ¨ç¾¤èŠ"${ctx.currentChatName}"ä¸­]`);
                    } else if (ctx.currentChatType === 'private') {
                        context.push(`[System Context: ä½ ç°åœ¨åœ¨ä¸{{user}}çš„ç§èŠä¸­]`);
                    }
                }
                
                // å¤„ç†æœªå¤„ç†çš„ç³»ç»Ÿäº‹ä»¶
                const unprocessedEvents = ctx.systemEvents.filter(e => !e.processed);
                for (const event of unprocessedEvents.slice(-3)) { // åªå¤„ç†æœ€è¿‘3ä¸ªäº‹ä»¶
                    const eventText = QQ_TranslateSystemEvent(event);
                    if (eventText) {
                        context.push(eventText);
                        event.processed = true;
                    }
                }
                
                return context.length > 0 ? context.join('\n') + '\n' : '';
            }
            
            /**
             * ç¿»è¯‘ç³»ç»Ÿäº‹ä»¶ä¸ºAIå¯ç†è§£çš„ä¸Šä¸‹æ–‡
             * @param {Object} event - ç³»ç»Ÿäº‹ä»¶å¯¹è±¡
             * @returns {string} ç¿»è¯‘åçš„ä¸Šä¸‹æ–‡æ–‡æœ¬
             */
            function QQ_TranslateSystemEvent(event) {
                switch (event.type) {
                    case QQ_SystemEventTypes.USER_ONLINE:
                        return `[System Context: {{user}}åœ¨çº¿]`;
                        
                    case QQ_SystemEventTypes.CHAT_SWITCH:
                        if (event.data.chatType === 'group') {
                            return `[System Context: {{user}}åˆ‡æ¢åˆ°äº†ç¾¤èŠ"${event.data.chatName}"]`;
                        } else if (event.data.chatType === 'private') {
                            return `[System Context: {{user}}æ‰“å¼€äº†ä¸ä½ çš„ç§èŠçª—å£]`;
                        }
                        break;
                        
                    case QQ_SystemEventTypes.MESSAGE_READ:
                        if (event.data.stage2Context && event.data.stage2Context.detailedReadInfo) {
                            // Stage 2å¢å¼ºç‰ˆæœ¬ - æä¾›è¯¦ç»†çš„è¯»å–ä¸Šä¸‹æ–‡
                            let contextText = `[System Context: {{user}}åˆšåˆšå·²è¯»äº†`;
                            
                            if (event.data.chatType === 'private') {
                                contextText += `ä¸ä½ çš„ç§èŠæ¶ˆæ¯`;
                            } else if (event.data.chatType === 'group') {
                                contextText += `ç¾¤èŠ"${event.data.chatName}"ä¸­çš„æ¶ˆæ¯`;
                            } else {
                                contextText += `èŠå¤©"${event.data.chatName}"ä¸­çš„æ¶ˆæ¯`;
                            }
                            
                            if (event.data.unreadCount > 0) {
                                contextText += `ï¼Œå…±${event.data.unreadCount}æ¡æœªè¯»æ¶ˆæ¯`;
                            }
                            
                            // æ·»åŠ æœ€è¿‘æ¶ˆæ¯çš„é¢„è§ˆä¿¡æ¯
                            if (event.data.lastMessages && event.data.lastMessages.length > 0) {
                                const latestMsg = event.data.lastMessages[event.data.lastMessages.length - 1];
                                if (!latestMsg.isUser) { // å¦‚æœæœ€æ–°æ¶ˆæ¯ä¸æ˜¯ç”¨æˆ·å‘é€çš„
                                    contextText += `ï¼Œæœ€æ–°æ¶ˆæ¯æ¥è‡ª"${latestMsg.sender}"`;
                                }
                            }
                            
                            contextText += `]`;
                            return contextText;
                        } else {
                            // ä¼ ç»Ÿç‰ˆæœ¬
                            return `[System Context: {{user}}åˆšåˆšå·²è¯»äº†ä½ å‘é€çš„æ¶ˆæ¯]`;
                        }
                        
                    case QQ_SystemEventTypes.GROUP_MEMBER_JOIN:
                        return `[System Context: ç³»ç»Ÿæç¤º"${event.data.memberName}"åŠ å…¥äº†ç¾¤èŠ"${event.data.groupName}"]`;
                        
                    case QQ_SystemEventTypes.GROUP_MEMBER_LEAVE:
                        return `[System Context: ç³»ç»Ÿæç¤º"${event.data.memberName}"ç¦»å¼€äº†ç¾¤èŠ"${event.data.groupName}"]`;
                        
                    case QQ_SystemEventTypes.GROUP_NAME_CHANGE:
                        return `[System Context: {{user}}å°†ç¾¤èŠåç§°ä»"${event.data.oldName}"ä¿®æ”¹ä¸º"${event.data.newName}"]`;
                        
                    default:
                        return null;
                }
            }
            
            /**
             * *** é˜¶æ®µäºŒï¼šä¸Šçº¿/ä¸‹çº¿çŠ¶æ€ç®¡ç† ***
             */
            
            /**
             * ç”¨æˆ·ä¸Šçº¿å¤„ç†
             */
            function QQ_HandleUserOnline() {
                const ctx = window.QQ_SystemContext;
                
                if (!ctx) {
                    console.error('âš ï¸ QQ_HandleUserOnline: QQ_SystemContext æœªåˆå§‹åŒ–');
                    return;
                }
                
                if (!ctx.userOnlineStatus) {
                    ctx.userOnlineStatus = true;
                    ctx.lastOnlineTime = new Date().toISOString();
                    
                    // è®°å½•ä¸Šçº¿äº‹ä»¶
                    QQ_AddSystemEvent(QQ_SystemEventTypes.USER_ONLINE, {
                        timestamp: ctx.lastOnlineTime
                    });
                    
                    console.log('ğŸŸ¢ ç”¨æˆ·ä¸Šçº¿çŠ¶æ€å·²æ›´æ–°');
                    
                    // è§¦å‘ä¸Šçº¿åçš„å¤„ç†é€»è¾‘ï¼ˆä¸ºé˜¶æ®µä¸‰åšå‡†å¤‡ï¼‰
                    setTimeout(() => {
                        QQ_ProcessOnlineActions();
                    }, 1000);
                }
            }
            
            /**
             * ç”¨æˆ·ä¸‹çº¿å¤„ç†
             */
            function QQ_HandleUserOffline() {
                const ctx = window.QQ_SystemContext;
                
                if (!ctx) {
                    console.error('âš ï¸ QQ_HandleUserOffline: QQ_SystemContext æœªåˆå§‹åŒ–');
                    return;
                }
                
                if (ctx.userOnlineStatus) {
                    ctx.userOnlineStatus = false;
                    
                    // è®°å½•ä¸‹çº¿äº‹ä»¶
                    QQ_AddSystemEvent(QQ_SystemEventTypes.USER_OFFLINE, {
                        timestamp: new Date().toISOString(),
                        duration: ctx.lastOnlineTime ? Date.now() - new Date(ctx.lastOnlineTime).getTime() : 0
                    });
                    
                    console.log('ğŸ”´ ç”¨æˆ·ä¸‹çº¿çŠ¶æ€å·²æ›´æ–°');
                }
            }
            
            /**
             * *** é˜¶æ®µä¸‰æ ¸å¿ƒï¼šä¸»åŠ¨æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿ ***
             * è®©AIèƒ½å¤Ÿ"åœ¨åå°æ€è€ƒ"å¹¶"ä¸»åŠ¨å‘èµ·å¯¹è¯"çš„é©å‘½æ€§åŠŸèƒ½
             */
            
            // å…¨å±€ä¸»åŠ¨æ¶ˆæ¯é˜Ÿåˆ—ç®¡ç†
            window.QQ_ProactiveMessageQueue = {
                queue: new Map(),           // è§’è‰² -> ä¸»åŠ¨æ¶ˆæ¯æ•°ç»„
                scheduledTasks: new Map(),  // å®šæ—¶ä»»åŠ¡ç®¡ç†
                config: {
                    maxMessagesPerCharacter: 5,
                    messageDeliveryDelay: { min: 5000, max: 60000 }, // 5ç§’-1åˆ†é’Ÿ
                    queueProcessInterval: 30000, // 30ç§’æ£€æŸ¥ä¸€æ¬¡é˜Ÿåˆ—
                    enableAutoProcess: true
                },
                statistics: {
                    generated: 0,
                    delivered: 0,
                    failed: 0
                }
            };
            
            /**
             * ä¸Šçº¿åçš„å¤„ç†é€»è¾‘ï¼ˆé˜¶æ®µä¸‰ï¼šè§¦å‘ä¸»åŠ¨æ¶ˆæ¯å¤„ç†ï¼‰
             */
            async function QQ_ProcessOnlineActions() {
                console.log('ğŸ”„ ç”¨æˆ·çŠ¶æ€å˜åŒ–ï¼Œæ£€æŸ¥ä¸»åŠ¨æ¶ˆæ¯é˜Ÿåˆ—...');
                
                // é¦–å…ˆå°è¯•ä»ä¸–ç•Œä¹¦åŠ è½½é˜Ÿåˆ—æ•°æ®
                await QQ_LoadProactiveMessageQueue();
                
                // æ¸…ç†è¿‡æœŸæ¶ˆæ¯
                QQ_CleanupProactiveMessageQueue();
                
                // *** ä¿®æ”¹ï¼šä¸ç«‹å³å¤„ç†é˜Ÿåˆ—ï¼Œåªå¯åŠ¨è°ƒåº¦å™¨ ***
                // é¿å…å› çŠ¶æ€é¢‘ç¹å˜åŒ–å¯¼è‡´æ¶ˆæ¯æ¶Œå‡º
                
                // å¯åŠ¨æˆ–é‡å¯å®šæœŸæ£€æŸ¥ï¼ˆå¦‚æœå°šæœªè¿è¡Œï¼‰
                QQ_StartProactiveMessageScheduler();
            }
            
            /**
             * *** ä¼˜åŒ–ç‰ˆï¼šç®€åŒ–çš„ç”¨æˆ·åœ¨çº¿çŠ¶æ€æ£€æµ‹ ***
             * é¡µé¢åŠ è½½åç›´æ¥ä¸Šçº¿ï¼Œ5åˆ†é’Ÿæ— æ“ä½œåä¸‹çº¿
             * ä»»ä½•ç”¨æˆ·æ“ä½œéƒ½ä¼šé‡ç½®ä¸‹çº¿è®¡æ—¶å™¨
             */
            function QQ_InitializeOnlineStatusDetection() {
                
                // *** ç®€åŒ–çš„ç”¨æˆ·æ´»åŠ¨çŠ¶æ€è·Ÿè¸ª ***
                let lastUserActivity = Date.now();
                let offlineTimer = null;
                
                // *** é…ç½® ***
                const OFFLINE_TIMEOUT = 300000; // 5åˆ†é’Ÿæ— æ´»åŠ¨è§†ä¸ºç¦»çº¿
                
                // *** é‡ç½®ä¸‹çº¿è®¡æ—¶å™¨ ***
                function resetOfflineTimer() {
                    // æ¸…é™¤ç°æœ‰è®¡æ—¶å™¨
                    if (offlineTimer) {
                        clearTimeout(offlineTimer);
                        offlineTimer = null;
                    }
                    
                    // ç¡®ä¿ç”¨æˆ·åœ¨çº¿çŠ¶æ€
                    if (window.QQ_SystemContext && !window.QQ_SystemContext.userOnlineStatus) {
                        QQ_HandleUserOnline();
                    }
                    
                    // è®¾ç½®æ–°çš„ä¸‹çº¿è®¡æ—¶å™¨
                    offlineTimer = setTimeout(() => {
                        QQ_HandleUserOffline();
                        console.log('ğŸ”´ ç”¨æˆ·å› 5åˆ†é’Ÿæ— æ´»åŠ¨è€Œç¦»çº¿');
                    }, OFFLINE_TIMEOUT);
                    
                    lastUserActivity = Date.now();
                }
                
                // *** ç”¨æˆ·æ´»åŠ¨æ£€æµ‹ ***
                function handleUserActivity(source) {
                    console.log(`ğŸŸ¢ ç”¨æˆ·æ´»åŠ¨: ${source} - ${new Date().toLocaleTimeString()}`);
                    resetOfflineTimer();
                }
                
                // *** ç›‘å¬ç”¨æˆ·äº¤äº’äº‹ä»¶ ***
                
                // ç‚¹å‡»äº‹ä»¶
                document.addEventListener('click', () => {
                    handleUserActivity('click');
                });
                
                // é”®ç›˜è¾“å…¥
                document.addEventListener('keydown', () => {
                    handleUserActivity('keyboard');
                });
                
                // é¼ æ ‡ç§»åŠ¨ï¼ˆé™æµï¼‰
                let mouseMoveThrottle = 0;
                document.addEventListener('mousemove', () => {
                    const now = Date.now();
                    if (now - mouseMoveThrottle > 10000) { // 10ç§’é™æµ
                        mouseMoveThrottle = now;
                        handleUserActivity('mouse');
                    }
                });
                
                // æ»šåŠ¨äº‹ä»¶ï¼ˆé™æµï¼‰
                let scrollThrottle = 0;
                document.addEventListener('scroll', () => {
                    const now = Date.now();
                    if (now - scrollThrottle > 10000) { // 10ç§’é™æµ
                        scrollThrottle = now;
                        handleUserActivity('scroll');
                    }
                });
                
                // è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
                document.addEventListener('touchstart', () => {
                    handleUserActivity('touch');
                });
                
                // ç›‘å¬æ¶ˆæ¯å‘é€
                document.addEventListener('QQ_MessageSent', () => {
                    handleUserActivity('message');
                });
                
                // *** é¡µé¢åŠ è½½åç«‹å³ä¸Šçº¿ ***
                // ç¡®ä¿ QQ_SystemContext å·²ç»åˆå§‹åŒ–
                if (window.QQ_SystemContext) {
                    QQ_HandleUserOnline();
                    resetOfflineTimer();
                } else {
                    console.error('âš ï¸ QQ_SystemContext å°šæœªåˆå§‹åŒ–');
                }
                
                console.log('âœ… ç®€åŒ–åœ¨çº¿çŠ¶æ€æ£€æµ‹ç³»ç»Ÿå·²åˆå§‹åŒ– - é»˜è®¤ä¸Šçº¿ï¼Œ5åˆ†é’Ÿæ— æ“ä½œåä¸‹çº¿');
            }
            
            /**
             * *** é˜¶æ®µä¸‰ï¼šä¸»åŠ¨æ¶ˆæ¯ç”ŸæˆPromptç³»ç»Ÿ ***
             */
            
            /**
             * ç”Ÿæˆä¸»åŠ¨æ¶ˆæ¯ç”ŸæˆæŒ‡ä»¤ï¼Œæ³¨å…¥åˆ°AIçš„Promptä¸­
             * @returns {string} ä¸»åŠ¨æ¶ˆæ¯ç”ŸæˆæŒ‡ä»¤
             */
            function QQ_GenerateProactiveMessagePrompt() {
                // æ£€æŸ¥æ˜¯å¦éœ€è¦ç”Ÿæˆä¸»åŠ¨æ¶ˆæ¯
                if (!QQ_ShouldGenerateProactiveMessages()) {
                    return '';
                }
                
                const prompt = `
[Proactive Message Generation - ä¸»åŠ¨æ¶ˆæ¯ç”Ÿæˆ]

é™¤äº†å›å¤å½“å‰å¯¹è¯ï¼Œè¯·ä½ æ ¹æ®è§’è‰²æ€§æ ¼å’Œæœ€è¿‘çš„äº’åŠ¨ï¼Œæ€è€ƒä¸€ä¸‹"åœ¨æ²¡æœ‰å¯¹è¯æ—¶ï¼Œä½ å¯èƒ½ä¼šä¸»åŠ¨æƒ³å¯¹{{user}}è¯´äº›ä»€ä¹ˆï¼Ÿ"

ç”Ÿæˆ0åˆ°2æ¡ä½ å¯èƒ½åœ¨æœªæ¥æŸä¸ªæ—¶åˆ»ï¼ˆå¦‚ä¸‹æ¬¡ç”¨æˆ·ä¸Šçº¿æ—¶ã€ç©ºé—²æ—¶ï¼‰ä¸»åŠ¨å‘é€çš„æ¶ˆæ¯ã€‚

è¯·ä¸¥æ ¼ä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼Œæ¯æ¡æ¶ˆæ¯ç‹¬ç«‹ä¸€è¡Œï¼š
[PM: "è§’è‰²å"--"æ¶ˆæ¯å†…å®¹"]

ç¤ºä¾‹:
[PM: "è§’è‰²A"--"æŒ‡æŒ¥å®˜ï¼Œåœ¨å¿™å—ï¼Ÿæˆ‘å‘ç°äº†ä¸€ä¸ªå¾ˆæœ‰è¶£çš„ä¸œè¥¿æƒ³è·Ÿä½ åˆ†äº«ï¼"]
[PM: "è§’è‰²B"--"å‘œ...è‚šå­é¥¿äº†...{{user}}ä»€ä¹ˆæ—¶å€™å›æ¥å¸¦æˆ‘å»åƒå¥½åƒçš„..."]

å¦‚æœå½“å‰æ²¡æœ‰ä¸»åŠ¨æƒ³è¯´çš„è¯ï¼Œåˆ™ä¸è¦ç”Ÿæˆä»»ä½•[PM: ...]æ ¼å¼çš„å†…å®¹ã€‚

`;
                
                console.log('ğŸ¯ é˜¶æ®µä¸‰ï¼šå·²æ³¨å…¥ä¸»åŠ¨æ¶ˆæ¯ç”ŸæˆæŒ‡ä»¤');
                return prompt;
            }
            
            /**
             * åˆ¤æ–­æ˜¯å¦åº”è¯¥ç”Ÿæˆä¸»åŠ¨æ¶ˆæ¯
             * @returns {boolean} æ˜¯å¦åº”è¯¥ç”Ÿæˆ
             */
            function QQ_ShouldGenerateProactiveMessages() {
                const config = window.QQ_ProactiveMessageQueue.config;
                if (!config.enableAutoProcess) {
                    return false;
                }
                
                // æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦å·²æ»¡
                const queueSize = window.QQ_ProactiveMessageQueue.queue.size;
                const totalMessages = Array.from(window.QQ_ProactiveMessageQueue.queue.values())
                    .reduce((total, messages) => total + messages.length, 0);
                
                if (totalMessages >= config.maxMessagesPerCharacter * 3) {
                    console.log('ğŸ”„ ä¸»åŠ¨æ¶ˆæ¯é˜Ÿåˆ—å·²æ»¡ï¼Œè·³è¿‡ç”Ÿæˆ');
                    return false;
                }
                
                // æ ¹æ®æ—¶é—´é—´éš”åˆ¤æ–­ï¼ˆé¿å…è¿‡äºé¢‘ç¹ç”Ÿæˆï¼‰
                const lastGeneration = localStorage.getItem('QQ_LastProactiveGeneration');
                if (lastGeneration) {
                    const timeSinceLastGeneration = Date.now() - parseInt(lastGeneration);
                    if (timeSinceLastGeneration < 300000) { // 5åˆ†é’Ÿå†…ä¸é‡å¤ç”Ÿæˆ
                        return false;
                    }
                }
                
                return true;
            }
            
            /**
             * *** é˜¶æ®µä¸‰ï¼šè§’è‰²åç§°è§„èŒƒåŒ– ***
             * å°†AIè¾“å‡ºçš„è§’è‰²åå˜ä½“ä¿®æ­£ä¸ºæ ‡å‡†åç§°ï¼Œé¿å…åˆ›å»ºé‡å¤èŠå¤©
             * @param {string} characterName - åŸå§‹è§’è‰²å
             * @returns {string} è§„èŒƒåŒ–åçš„è§’è‰²å
             */
            function QQ_NormalizeCharacterName(characterName) {
                if (!characterName) return characterName;
                
                const normalizedName = characterName.trim();
                
                // å¸¸è§åç§°æ˜ å°„è¡¨ - å°†å˜ä½“åç§°æ˜ å°„åˆ°æ ‡å‡†åç§°
                const nameMapping = {
                    // ç»«æ³¢ç³»åˆ—
                    'ç¶¾æ³¢': 'ç»«æ³¢',
                    'ç¶¾æ³¢é›¶': 'ç»«æ³¢',
                    'ç»«æ³¢é›¶': 'ç»«æ³¢',
                    
                    // è®©å·´å°”ç³»åˆ—  
                    'è®©Â·å·´å°”': 'è®©å·´å°”',
                    'è®©-å·´å°”': 'è®©å·´å°”',
                    'Jean Bart': 'è®©å·´å°”',
                    
                    // èƒ¡æ»•ç³»åˆ—
                    'ä¹Œå°”é‡Œå¸ŒÂ·å†¯Â·èƒ¡æ»•': 'èƒ¡æ»•',
                    'ä¹Œå°”é‡Œå¸ŒÂ·èƒ¡æ»•': 'èƒ¡æ»•',
                    'ä¹Œå°”é‡Œå¸Œå†¯èƒ¡æ»•': 'èƒ¡æ»•',
                    'Ulrich von Hutten': 'èƒ¡æ»•',
                    
                    // ä¼ä¸šç³»åˆ—
                    'Enterprise': 'ä¼ä¸š',
                    'ä¼ä¸šå·': 'ä¼ä¸š',
                    
                    // åŠ è´ºç³»åˆ—  
                    'Kaga': 'åŠ è´º',
                    'åŠ è´ºå·': 'åŠ è´º',
                    
                    // å…¶ä»–å¸¸è§å˜ä½“...
                    'èµ¤åŸå·': 'èµ¤åŸ',
                    'Akagi': 'èµ¤åŸ',
                    'ç¿”é¹¤å·': 'ç¿”é¹¤',
                    'Shoukaku': 'ç¿”é¹¤',
                    'ç‘é¹¤å·': 'ç‘é¹¤',
                    'Zuikaku': 'ç‘é¹¤',
                    'è´å°”æ³•estell':'è´å°”æ³•æ–¯ç‰¹'
                };
                
                // 1. ç›´æ¥æ˜ å°„æŸ¥æ‰¾
                if (nameMapping[normalizedName]) {
                    console.log(`ğŸ”§ åç§°è§„èŒƒåŒ–: "${characterName}" -> "${nameMapping[normalizedName]}"`);
                    return nameMapping[normalizedName];
                }
                
                // 2. æ¨¡ç³ŠåŒ¹é… - æ£€æŸ¥ç°æœ‰è”ç³»äººåˆ—è¡¨
                const existingContacts = QQ_GetAllContactNames();
                
                // ç²¾ç¡®åŒ¹é…ï¼ˆå¿½ç•¥å¤§å°å†™å’Œç©ºæ ¼ï¼‰
                const exactMatch = existingContacts.find(contact => 
                    contact.toLowerCase().replace(/\s+/g, '') === normalizedName.toLowerCase().replace(/\s+/g, '')
                );
                if (exactMatch) {
                    console.log(`ğŸ”§ åç§°è§„èŒƒåŒ–ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰: "${characterName}" -> "${exactMatch}"`);
                    return exactMatch;
                }
                
                // åŒ…å«åŒ¹é…ï¼ˆé•¿åç§°åŒ…å«çŸ­åç§°ï¼‰
                const containsMatch = existingContacts.find(contact => {
                    const contactClean = contact.toLowerCase().replace(/\s+/g, '');
                    const nameClean = normalizedName.toLowerCase().replace(/\s+/g, '');
                    return contactClean.includes(nameClean) || nameClean.includes(contactClean);
                });
                if (containsMatch) {
                    console.log(`ğŸ”§ åç§°è§„èŒƒåŒ–ï¼ˆåŒ…å«åŒ¹é…ï¼‰: "${characterName}" -> "${containsMatch}"`);
                    return containsMatch;
                }
                
                // 3. å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ï¼Œè¿”å›æ¸…ç†åçš„åŸåç§°
                console.log(`âš ï¸ åç§°è§„èŒƒåŒ–ï¼šæœªæ‰¾åˆ° "${characterName}" çš„åŒ¹é…é¡¹ï¼Œä¿æŒåŸå`);
                return normalizedName;
            }
            
            /**
             * *** è·å–æ‰€æœ‰è”ç³»äººåç§°åˆ—è¡¨ ***
             * @returns {Array<string>} è”ç³»äººåç§°æ•°ç»„
             */
            function QQ_GetAllContactNames() {
                const contactNames = [];
                
                // ä»è”ç³»äººé¡µé¢è·å–
                const homeChars = document.getElementById('QQ_home_chars');
                if (homeChars) {
                    const contacts = homeChars.querySelectorAll('.QQ_home_usermsg .QQ_home_name');
                    contacts.forEach(contact => {
                        const name = contact.textContent.trim();
                        if (name && !contactNames.includes(name)) {
                            contactNames.push(name);
                        }
                    });
                }
                
                // ä»èŠå¤©åˆ—è¡¨è·å–
                const chatItems = document.querySelectorAll('.QQ_chat_list_item_name');
                chatItems.forEach(item => {
                    const name = item.textContent.trim();
                    if (name && !contactNames.includes(name)) {
                        contactNames.push(name);
                    }
                });
                
                // ä»ä¸–ç•Œä¹¦è§’è‰²è®¾ç½®è·å–
                if (window.QQ_CharSettings && window.QQ_CharSettings.getAllSections) {
                    const charSections = window.QQ_CharSettings.getAllSections();
                    charSections.forEach(name => {
                        if (name && !contactNames.includes(name)) {
                            contactNames.push(name);
                        }
                    });
                }
                
                console.log(`ğŸ“‹ è·å–åˆ°${contactNames.length}ä¸ªå·²çŸ¥è”ç³»äºº:`, contactNames);
                return contactNames;
            }
            
            /**
             * *** é˜¶æ®µä¸‰ï¼šæå–ä¸»åŠ¨æ¶ˆæ¯ ***
             * ä»AIå›å¤ä¸­æå–[PM: "è§’è‰²å"--"æ¶ˆæ¯å†…å®¹"]æ ¼å¼çš„ä¸»åŠ¨æ¶ˆæ¯
             * @param {string} result - AIå›å¤å†…å®¹
             */
            async function QQ_ExtractProactiveMessages(result) {
                if (!result) return;
                
                // åŒ¹é…[PM: "è§’è‰²å"--"æ¶ˆæ¯å†…å®¹"]æ ¼å¼å’Œç±»ä¼¼æ ¼å¼
                const pmPatterns = [
                    /\[PM:\s*"([^"]+)"\s*--\s*"([^"]+)"\]/g,  // æ ‡å‡†æ ¼å¼: [PM: "è§’è‰²å"--"æ¶ˆæ¯å†…å®¹"]
                    /\[PM--"([^"]+)"--"([^"]+)"\]/g,          // ç®€åŒ–æ ¼å¼: [PM--"è§’è‰²å"--"æ¶ˆæ¯å†…å®¹"]
                    /\[PM\s*--\s*"([^"]+)"\s*--\s*"([^"]+)"\]/g  // å¸¦ç©ºæ ¼æ ¼å¼: [PM -- "è§’è‰²å" -- "æ¶ˆæ¯å†…å®¹"]
                ];
                
                let matches = [];
                for (const pattern of pmPatterns) {
                    const found = [...result.matchAll(pattern)];
                    matches.push(...found);
                }
                
                if (matches.length === 0) {
                    console.log('ğŸ” é˜¶æ®µä¸‰ï¼šæœªæ£€æµ‹åˆ°ä¸»åŠ¨æ¶ˆæ¯æ ¼å¼');
                    return;
                }
                
                console.log(`ğŸ¯ é˜¶æ®µä¸‰ï¼šæ£€æµ‹åˆ°${matches.length}æ¡ä¸»åŠ¨æ¶ˆæ¯`);
                
                for (const match of matches) {
                    const originalCharacterName = match[1].trim();
                    const messageContent = match[2].trim();
                    
                    if (originalCharacterName && messageContent) {
                        // åº”ç”¨åç§°è§„èŒƒåŒ–
                        const normalizedCharacterName = QQ_NormalizeCharacterName(originalCharacterName);
                        
                        console.log(`ğŸ“¥ é˜¶æ®µä¸‰ï¼šæ·»åŠ ä¸»åŠ¨æ¶ˆæ¯ - ${normalizedCharacterName}: ${messageContent}`);
                        if (originalCharacterName !== normalizedCharacterName) {
                            console.log(`ğŸ”§ åç§°å·²è§„èŒƒåŒ–: "${originalCharacterName}" -> "${normalizedCharacterName}"`);
                        }
                        
                        QQ_AddProactiveMessage(normalizedCharacterName, messageContent);
                    }
                }
                
                // æ›´æ–°ç”Ÿæˆæ—¶é—´æˆ³
                localStorage.setItem('QQ_LastProactiveGeneration', Date.now().toString());
                
                // æ›´æ–°ç»Ÿè®¡
                window.QQ_ProactiveMessageQueue.statistics.generated += matches.length;
                
                console.log(`ğŸ“Š é˜¶æ®µä¸‰ï¼šä¸»åŠ¨æ¶ˆæ¯ç»Ÿè®¡æ›´æ–° - å·²ç”Ÿæˆæ€»æ•°: ${window.QQ_ProactiveMessageQueue.statistics.generated}`);
            }
            
            /**
             * *** é˜¶æ®µä¸‰ï¼šæ¸…ç†ä¸»åŠ¨æ¶ˆæ¯æ ¼å¼ ***
             * ä»æ–‡æœ¬ä¸­ç§»é™¤ä¸»åŠ¨æ¶ˆæ¯æ ¼å¼ï¼Œé¿å…è¢«å½“ä½œæ™®é€šæ¶ˆæ¯æ˜¾ç¤º
             * @param {string} text - è¦æ¸…ç†çš„æ–‡æœ¬
             * @returns {string} æ¸…ç†åçš„æ–‡æœ¬
             */
            function QQ_CleanProactiveMessageFormats(text) {
                if (!text) return text;
                
                // å®šä¹‰ä¸»åŠ¨æ¶ˆæ¯æ ¼å¼æ¨¡å¼
                const pmPatterns = [
                    /\[PM:\s*"([^"]+)"\s*--\s*"([^"]+)"\]/g,  // æ ‡å‡†æ ¼å¼: [PM: "è§’è‰²å"--"æ¶ˆæ¯å†…å®¹"]
                    /\[PM--"([^"]+)"--"([^"]+)"\]/g,          // ç®€åŒ–æ ¼å¼: [PM--"è§’è‰²å"--"æ¶ˆæ¯å†…å®¹"]
                    /\[PM\s*--\s*"([^"]+)"\s*--\s*"([^"]+)"\]/g  // å¸¦ç©ºæ ¼æ ¼å¼: [PM -- "è§’è‰²å" -- "æ¶ˆæ¯å†…å®¹"]
                ];
                
                let cleanedText = text;
                let removedCount = 0;
                
                for (const pattern of pmPatterns) {
                    const matches = cleanedText.match(pattern);
                    if (matches) {
                        removedCount += matches.length;
                        cleanedText = cleanedText.replace(pattern, '');
                    }
                }
                
                if (removedCount > 0) {
                    console.log(`ğŸ§¹ é˜¶æ®µä¸‰ï¼šå·²ä»è¾“å‡ºä¸­æ¸…ç†${removedCount}æ¡ä¸»åŠ¨æ¶ˆæ¯æ ¼å¼`);
                    // æ¸…ç†å¤šä½™çš„ç©ºè¡Œå’Œç©ºæ ¼
                    cleanedText = cleanedText.replace(/\n\s*\n/g, '\n').trim();
                }
                
                return cleanedText;
            }
            
            /**
             * *** æ–°å¢ï¼šå¤„ç†tableEditæ ‡ç­¾ ***
             * ç¡®ä¿tableEditæ ‡ç­¾ä¿ç•™åœ¨AIå›å¤ä¸­ï¼Œä¾›SillyTavernåç«¯å¤„ç†
             * @param {string} result - AIå›å¤å†…å®¹
             */
            async function QQ_ExtractAndProcessTableEdit(result) {
                if (!result || typeof result !== 'string') {
                    return;
                }
                
                console.log('ğŸ—‚ï¸ å¼€å§‹æ£€æŸ¥tableEditæ ‡ç­¾...');
                
                // æ£€æŸ¥æ˜¯å¦å­˜åœ¨tableEditæ ‡ç­¾
                const tableEditMatches = [...result.matchAll(/<tableEdit>([\s\S]*?)<\/tableEdit>/gi)];
                
                if (tableEditMatches.length === 0) {
                    console.log('ğŸ” æœªå‘ç°tableEditæ ‡ç­¾');
                    return;
                }
                
                console.log(`ğŸ¯ å‘ç°${tableEditMatches.length}ä¸ªtableEditæ ‡ç­¾ï¼Œå¼€å§‹å¤„ç†`);
                
                // *** æ”¶é›†æ‰€æœ‰tableEditå†…å®¹ ***
                let allTableEditContent = '';
                for (let i = 0; i < tableEditMatches.length; i++) {
                    const match = tableEditMatches[i];
                    const tableContent = match[1].trim();
                    
                    if (tableContent) {
                        console.log(`ğŸ“‹ æ”¶é›†tableEditæ ‡ç­¾${i + 1}å†…å®¹:`, tableContent.substring(0, 100) + '...');
                        allTableEditContent += `<tableEdit>${tableContent}</tableEdit>\n`;
                    } else {
                        console.log(`âš ï¸ tableEditæ ‡ç­¾${i + 1}å†…å®¹ä¸ºç©ºï¼Œè·³è¿‡`);
                    }
                }
                
                if (!allTableEditContent.trim()) {
                    console.log('âš ï¸ æœªæ”¶é›†åˆ°æœ‰æ•ˆçš„tableEditå†…å®¹');
                    return;
                }
                
                // *** ä½¿ç”¨editLastMessage APIä¿®æ”¹æœ€åä¸€æ¡æ¶ˆæ¯ ***
                try {
                    console.log('ğŸ“¤ ä½¿ç”¨editLastMessage APIæ·»åŠ tableEditå†…å®¹');
                    
                    if (typeof editLastMessage !== 'undefined') {
                        // è·å–å½“å‰æœ€åä¸€æ¡æ¶ˆæ¯å†…å®¹
                        // editLastMessageä¼šè‡ªåŠ¨è·å–æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œæˆ‘ä»¬åªéœ€è¦æä¾›ä¿®æ”¹å‡½æ•°
                        const success = await editLastMessage((currentMessage) => {
                            let currentContent = currentMessage || '';
                            
                            // *** å¤„ç†æ‰‹æœºJSONç»“æ„å’Œè¡¨æ ¼æ•°æ®æ›¿æ¢ ***
                            if (currentContent.includes('MiPhone_JSON_END')) {
                                // ç§»é™¤æ—§çš„tableEditå†…å®¹ï¼ˆé¿å…é‡å¤ï¼‰
                                let cleanedContent = currentContent.replace(/<tableEdit>[\s\S]*?<\/tableEdit>/g, '').trim();
                                
                                // åœ¨MiPhone_JSON_ENDåæ·»åŠ æ–°çš„è¡¨æ ¼å†…å®¹
                                const updatedContent = cleanedContent.replace(
                                    'MiPhone_JSON_END', 
                                    `MiPhone_JSON_END\n\n${allTableEditContent.trim()}`
                                );
                                
                                console.log('âœ… tableEditå†…å®¹å·²æ·»åŠ åˆ°æœ€åä¸€æ¡æ¶ˆæ¯');
                                return updatedContent;
                            } else {
                                console.warn('âš ï¸ æœ€åä¸€æ¡æ¶ˆæ¯ä¸­æœªæ‰¾åˆ°MiPhone_JSON_ENDæ ‡è®°');
                                return currentContent;
                            }
                        });
                        
                        if (success) {
                            console.log('ğŸ‰ editLastMessageæ‰§è¡ŒæˆåŠŸ');
                        } else {
                            console.warn('âš ï¸ editLastMessageæ‰§è¡Œå¯èƒ½å¤±è´¥');
                        }
                    } else {
                        console.warn('âš ï¸ editLastMessage APIä¸å¯ç”¨ï¼ŒtableEditå†…å®¹å°†ä¿ç•™åœ¨åŸå§‹å›å¤ä¸­');
                        // å¤‡ç”¨ç­–ç•¥ï¼šè®©tableEditä¿ç•™åœ¨åŸå§‹å›å¤ä¸­ï¼Œç”±åç«¯å¤„ç†
                    }
                } catch (error) {
                    console.error('âŒ ä½¿ç”¨editLastMessageå¤„ç†tableEditæ—¶å‡ºé”™:', error);
                    console.log('ğŸ“ å›é€€åˆ°ä¿ç•™ç­–ç•¥ï¼štableEditå†…å®¹å°†ä¿ç•™åœ¨åŸå§‹å›å¤ä¸­');
                }
                
                console.log(`ğŸ‰ tableEditå¤„ç†å®Œæˆï¼Œå…±å¤„ç†${tableEditMatches.length}ä¸ªæ ‡ç­¾`);
            }
            
            /**
             * *** é˜¶æ®µä¸‰ï¼šæ·»åŠ ä¸»åŠ¨æ¶ˆæ¯åˆ°é˜Ÿåˆ— ***
             * @param {string} characterName - è§’è‰²å
             * @param {string} messageContent - æ¶ˆæ¯å†…å®¹
             */
            function QQ_AddProactiveMessage(characterName, messageContent) {
                const queue = window.QQ_ProactiveMessageQueue.queue;
                const config = window.QQ_ProactiveMessageQueue.config;
                
                if (!queue.has(characterName)) {
                    queue.set(characterName, []);
                }
                
                const characterMessages = queue.get(characterName);
                
                // æ£€æŸ¥æ˜¯å¦è¶…è¿‡å•ä¸ªè§’è‰²çš„æ¶ˆæ¯é™åˆ¶
                if (characterMessages.length >= config.maxMessagesPerCharacter) {
                    console.log(`âš ï¸ è§’è‰²${characterName}çš„ä¸»åŠ¨æ¶ˆæ¯é˜Ÿåˆ—å·²æ»¡ï¼Œç§»é™¤æœ€æ—§çš„æ¶ˆæ¯`);
                    characterMessages.shift(); // ç§»é™¤æœ€æ—§çš„æ¶ˆæ¯
                }
                
                // æ·»åŠ æ–°æ¶ˆæ¯
                const messageData = {
                    id: `pm_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    content: messageContent,
                    timestamp: Date.now(),
                    status: 'pending', // pending, scheduled, delivered, failed
                    deliveryDelay: QQ_GenerateRandomDelay(
                        config.messageDeliveryDelay.min,
                        config.messageDeliveryDelay.max - config.messageDeliveryDelay.min
                    )
                };
                
                characterMessages.push(messageData);
                console.log(`âœ… å·²æ·»åŠ ä¸»åŠ¨æ¶ˆæ¯åˆ°é˜Ÿåˆ—: ${characterName} - ${messageContent}`);
                
                // å¼‚æ­¥ä¿å­˜åˆ°ä¸–ç•Œä¹¦ï¼ˆä¸ç­‰å¾…å®Œæˆä»¥å…å½±å“æ€§èƒ½ï¼‰
                setTimeout(() => {
                    QQ_SaveProactiveMessageQueue().catch(error => {
                        console.error('ä¿å­˜ä¸»åŠ¨æ¶ˆæ¯é˜Ÿåˆ—å¤±è´¥:', error);
                    });
                }, 100);
            }
            
            /**
             * *** é˜¶æ®µä¸‰ï¼šå¤„ç†ä¸»åŠ¨æ¶ˆæ¯é˜Ÿåˆ— ***
             * å½“ç”¨æˆ·ä¸Šçº¿æ—¶è§¦å‘ï¼Œå‘é€æ’é˜Ÿçš„ä¸»åŠ¨æ¶ˆæ¯
             */
            async function QQ_ProcessProactiveMessageQueue() {
                const queue = window.QQ_ProactiveMessageQueue.queue;
                const config = window.QQ_ProactiveMessageQueue.config;
                
                if (queue.size === 0) {
                    return; // é™é»˜è¿”å›ï¼Œå‡å°‘æ—¥å¿—å™ªéŸ³
                }
                
                // *** åªå¤„ç†pendingçŠ¶æ€çš„æ¶ˆæ¯ï¼Œé¿å…é‡å¤è°ƒåº¦ ***
                let totalPendingMessages = 0;
                for (const [characterName, messages] of queue.entries()) {
                    const pendingMessages = messages.filter(msg => msg.status === 'pending');
                    totalPendingMessages += pendingMessages.length;
                }
                
                if (totalPendingMessages === 0) {
                    return; // æ²¡æœ‰å¾…å¤„ç†çš„æ¶ˆæ¯ï¼Œé™é»˜è¿”å›
                }
                
                console.log(`ğŸš€ å‘ç°${totalPendingMessages}æ¡å¾…è°ƒåº¦çš„ä¸»åŠ¨æ¶ˆæ¯`);
                
                // *** å…¨å±€æ—¶é—´ç®¡ç†ï¼Œé¿å…æ¶ˆæ¯å†²çª ***
                let globalDelay = QQ_GenerateRandomDelay(
                    config.messageDeliveryDelay.min,
                    config.messageDeliveryDelay.max - config.messageDeliveryDelay.min
                );
                
                const minIntervalBetweenCharacters = 8000; // ä¸åŒè§’è‰²é—´æœ€å°‘é—´éš”8ç§’
                const minIntervalBetweenMessages = 5000;   // åŒä¸€è§’è‰²å¤šæ¡æ¶ˆæ¯é—´æœ€å°‘é—´éš”5ç§’
                
                let scheduledCount = 0;
                
                for (const [characterName, messages] of queue.entries()) {
                    const pendingMessages = messages.filter(msg => msg.status === 'pending');
                    
                    if (pendingMessages.length === 0) {
                        continue;
                    }
                    
                    console.log(`ğŸ“¨ ä¸ºè§’è‰²${characterName}è°ƒåº¦${pendingMessages.length}æ¡æ¶ˆæ¯`);
                    
                    for (let i = 0; i < pendingMessages.length; i++) {
                        const message = pendingMessages[i];
                        
                        // æ ‡è®°ä¸ºå·²è°ƒåº¦ï¼Œé¿å…é‡å¤å¤„ç†
                        message.status = 'scheduled';
                        
                        // è®¡ç®—å‘é€å»¶è¿Ÿï¼ˆç¡®ä¿æ—¶é—´é—´éš”ï¼‰
                        const finalDelay = globalDelay + (scheduledCount * minIntervalBetweenMessages);
                        message.deliveryDelay = finalDelay;
                        message.scheduledAt = Date.now(); // è®°å½•è°ƒåº¦æ—¶é—´
                        
                        // è®¡åˆ’å‘é€æ¶ˆæ¯
                        setTimeout(async () => {
                            // å†æ¬¡æ£€æŸ¥æ¶ˆæ¯çŠ¶æ€ï¼Œé¿å…é‡å¤å‘é€
                            if (message.status === 'scheduled') {
                                await QQ_DeliverProactiveMessage(characterName, message);
                            }
                        }, finalDelay);
                        
                        console.log(`â° å·²è°ƒåº¦æ¶ˆæ¯: ${characterName} - ${Math.round(finalDelay/1000)}ç§’åå‘é€`);
                        scheduledCount++;
                    }
                    
                    // ä¸ºä¸‹ä¸€ä¸ªè§’è‰²å¢åŠ æ—¶é—´é—´éš”
                    globalDelay += minIntervalBetweenCharacters;
                }
            }
            
            /**
             * *** é˜¶æ®µä¸‰ï¼šå‘é€ä¸»åŠ¨æ¶ˆæ¯ ***
             * @param {string} characterName - è§’è‰²å
             * @param {Object} messageData - æ¶ˆæ¯æ•°æ®
             */
            /**
             * ç¡®ä¿æ¶ˆæ¯è¢«æ·»åŠ åˆ°èŠå¤©ç•Œé¢ï¼ˆç”¨äºä¸»åŠ¨æ¶ˆæ¯ï¼‰
             * @param {string} characterName - è§’è‰²å
             * @param {string} content - æ¶ˆæ¯å†…å®¹
             * @param {string} timestamp - æ—¶é—´æˆ³
             */
            async function QQ_EnsureMessageInChatInterface(characterName, content, timestamp) {
                try {
                    // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•èŠå¤©æ­£åœ¨è¿›è¡Œæµå¼ä¼ è¾“ï¼ˆä½¿ç”¨æ–°çš„å¹¶è¡Œé˜Ÿåˆ—ç³»ç»Ÿï¼‰
                    const hasActiveStreaming = () => {
                        for (const [chatName, chatState] of streamingChatStates) {
                            if (chatState.isActive) {
                                return true;
                            }
                        }
                        return false;
                    };
                    
                    if (hasActiveStreaming()) {
                        console.log('âš ï¸ æ£€æµ‹åˆ°æ­£åœ¨è¿›è¡Œçš„æµå¼ä¼ è¾“ï¼Œç­‰å¾…å®Œæˆåå†å‘é€ä¸»åŠ¨æ¶ˆæ¯');
                        // ç­‰å¾…æµå¼ä¼ è¾“å®Œæˆ
                        await new Promise(resolve => {
                            const checkInterval = setInterval(() => {
                                if (!hasActiveStreaming()) {
                                    clearInterval(checkInterval);
                                    resolve();
                                }
                            }, 100);
                        });
                        // æµå¼ä¼ è¾“å®Œæˆåå†ç­‰å¾…500msç¡®ä¿ç•Œé¢ç¨³å®š
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                    
                    const chatKey = `${QQ_GetUserName()}å’Œ${characterName}çš„èŠå¤©`;
                    
                    // è·å–æˆ–åˆ›å»ºç§èŠé¡µé¢
                    let chatPage = document.querySelector(`.QQ_chat_page[data-name="${characterName}"]`);
                    
                    if (!chatPage) {
                        // å¦‚æœèŠå¤©é¡µé¢ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªï¼ˆä½†ä¸æ˜¾ç¤ºï¼‰
                        const chatPageHtml = `
                            <div class="QQ_chat_page" data-name="${characterName}" style="display: none;">
                                <div class="chat-setting-popup" style="display: none;">
                                    <!-- èŠå¤©è®¾ç½®å†…å®¹ -->
                                </div>
                                <div class="msgcontent"></div>
                                <div class="input-container">
                                    <textarea class="userInput" data-chatname="${characterName}" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
                                    <button id="QQ_chat_send-btn" class="QQ_send_btn">å‘é€</button>
                                </div>
                            </div>
                        `;
                        document.querySelector('.QQ_ChatInterface').insertAdjacentHTML('beforeend', chatPageHtml);
                        chatPage = document.querySelector(`.QQ_chat_page[data-name="${characterName}"]`);
                    }
                    
                    // è·å–æ¶ˆæ¯å®¹å™¨
                    const msgContent = chatPage?.querySelector('.msgcontent');
                    if (!msgContent) {
                        console.error('âŒ æ— æ³•æ‰¾åˆ°æ¶ˆæ¯å®¹å™¨ï¼ŒchatPage:', chatPage);
                        return;
                    }
                    
                    // ä½¿ç”¨ä¸å¸¸è§„æ¶ˆæ¯ç›¸åŒçš„æµå¼æ˜¾ç¤ºæœºåˆ¶
                    const fullMessage = `${characterName}--${content}--${timestamp}`;
                    
                    // ä½¿ç”¨é˜Ÿåˆ—æœºåˆ¶æµå¼æ˜¾ç¤ºä¸»åŠ¨æ¶ˆæ¯ï¼Œç¡®ä¿ä¸å…¶ä»–æ¶ˆæ¯æµå¼æ˜¾ç¤ºä¸€è‡´
                    return new Promise((resolve) => {
                        QQ_EnqueueStreamingTask({
                            handler: async () => {
                                // ä½¿ç”¨ä¸å¸¸è§„æ¶ˆæ¯ç›¸åŒçš„æµå¼æ˜¾ç¤ºå‡½æ•°
                                await QQ_DisplayStreamingMessagesDirectly(msgContent, [fullMessage], characterName, true, true);
                                resolve();
                            },
                            args: [],
                            description: `ä¸»åŠ¨æ¶ˆæ¯æµå¼æ˜¾ç¤º: ${characterName}`,
                            chatName: characterName // æ·»åŠ èŠå¤©åç§°ï¼Œæ”¯æŒå¹¶è¡Œå¤„ç†
                        });
                    });
                    
                } catch (error) {
                    console.error('ç¡®ä¿æ¶ˆæ¯åœ¨èŠå¤©ç•Œé¢ä¸­å¤±è´¥:', error);
                }
            }
            
            async function QQ_DeliverProactiveMessage(characterName, messageData) {
                try {
                    console.log(`ğŸ“¤ å¼€å§‹å‘é€ä¸»åŠ¨æ¶ˆæ¯: ${characterName} - ${messageData.content}`);
                    
                    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä»åœ¨çº¿
                    const ctx = window.QQ_SystemContext;
                    if (!ctx.userOnlineStatus) {
                        console.log('â¸ï¸ ç”¨æˆ·å·²ä¸‹çº¿ï¼Œå»¶è¿Ÿå‘é€ä¸»åŠ¨æ¶ˆæ¯');
                        messageData.status = 'pending';
                        return;
                    }
                    
                    // ç”Ÿæˆæ¶ˆæ¯æ—¶é—´æˆ³
                    const timestamp = QQ_GetTime();
                    
                    // æ„å»ºç§èŠæ¶ˆæ¯æ ¼å¼
                    const messageText = `${characterName}--${messageData.content}--${timestamp}`;
                    const chatKey = `${QQ_GetUserName()}å’Œ${characterName}çš„èŠå¤©`;
                    
                    // æ·»åŠ åˆ°æ¶ˆæ¯è®°å½•
                    if (!QQ_msgjson.ç§èŠ[chatKey]) {
                        QQ_msgjson.ç§èŠ[chatKey] = [];
                    }
                    QQ_msgjson.ç§èŠ[chatKey].push(messageText);
                    
                    // é¦–å…ˆæµå¼æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢ï¼ˆæ— è®ºæ˜¯å¦æ­£åœ¨æŸ¥çœ‹ï¼‰
                    await QQ_EnsureMessageInChatInterface(characterName, messageData.content, timestamp);
                    
                    // æ·»åŠ çŸ­æš‚å»¶è¿Ÿï¼Œç¡®ä¿æ¶ˆæ¯å·²ç»å®Œå…¨æ˜¾ç¤º
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                    // å¦‚æœå½“å‰æ­£åœ¨æŸ¥çœ‹è¯¥è§’è‰²çš„èŠå¤©ï¼Œæ’­æ”¾é€šçŸ¥å£°éŸ³
                    const currentChatPage = document.querySelector('.QQ_chat_page:not([style*="display: none"])');
                    if (currentChatPage && currentChatPage.dataset.name === characterName) {
                        // æ’­æ”¾é€šçŸ¥å£°éŸ³ï¼ˆå¦‚æœæœ‰ï¼‰
                        QQ_PlayNotificationSound();
                        
                        // æ»šåŠ¨åˆ°åº•éƒ¨
                        const msgContent = currentChatPage.querySelector('.msgcontent');
                        if (msgContent) {
                            msgContent.scrollTop = msgContent.scrollHeight;
                        }
                    }
                    
                    // æ›´æ–°è”ç³»äººåˆ—è¡¨çš„çº¢ç‚¹æç¤º
                    QQ_UpdateContactNotification(characterName, true);
                    
                    // ä¿å­˜æ¶ˆæ¯åˆ°ä¸–ç•Œä¹¦
                    await QQ_Save_Msg();
                    
                    // æ ‡è®°ä¸ºå·²å‘é€
                    messageData.status = 'delivered';
                    messageData.deliveredAt = Date.now();
                    
                    // æ›´æ–°ç»Ÿè®¡
                    window.QQ_ProactiveMessageQueue.statistics.delivered++;
                    
                    console.log(`âœ… ä¸»åŠ¨æ¶ˆæ¯å‘é€æˆåŠŸ: ${characterName} - ${messageData.content}`);
                    
                    // æ˜¾ç¤ºç³»ç»Ÿé€šçŸ¥
                    QQ_ShowProactiveMessageNotification(characterName, messageData.content);
                    
                    // ä¿å­˜é˜Ÿåˆ—çŠ¶æ€åˆ°ä¸–ç•Œä¹¦
                    await QQ_SaveProactiveMessageQueue();
                    
                } catch (error) {
                    console.error('âŒ ä¸»åŠ¨æ¶ˆæ¯å‘é€å¤±è´¥:', error);
                    messageData.status = 'failed';
                    messageData.errorMessage = error.message;
                    
                    // æ›´æ–°ç»Ÿè®¡
                    window.QQ_ProactiveMessageQueue.statistics.failed++;
                    
                    // ä¿å­˜å¤±è´¥çŠ¶æ€åˆ°ä¸–ç•Œä¹¦
                    await QQ_SaveProactiveMessageQueue();
                }
            }
            
            /**
             * *** é˜¶æ®µä¸‰ï¼šå¯åŠ¨ä¸»åŠ¨æ¶ˆæ¯è°ƒåº¦å™¨ ***
             * å®šæœŸæ£€æŸ¥å’Œå¤„ç†ä¸»åŠ¨æ¶ˆæ¯é˜Ÿåˆ—
             */
            function QQ_StartProactiveMessageScheduler() {
                const config = window.QQ_ProactiveMessageQueue.config;
                
                if (!config.enableAutoProcess) {
                    console.log('ğŸ”‡ ä¸»åŠ¨æ¶ˆæ¯è‡ªåŠ¨å¤„ç†å·²ç¦ç”¨');
                    return;
                }
                
                // æ¸…é™¤ç°æœ‰è°ƒåº¦å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
                if (window.QQ_ProactiveMessageQueue.scheduler) {
                    clearInterval(window.QQ_ProactiveMessageQueue.scheduler);
                }
                
                // å¯åŠ¨æ–°çš„è°ƒåº¦å™¨
                window.QQ_ProactiveMessageQueue.scheduler = setInterval(() => {
                    // *** ä½¿ç”¨ç®€åŒ–çš„åœ¨çº¿çŠ¶æ€æ£€æµ‹ ***
                    if (!window.QQ_SystemContext || !window.QQ_SystemContext.userOnlineStatus) {
                        console.log('ğŸ”„ ç”¨æˆ·ä¸åœ¨çº¿ï¼Œè·³è¿‡ä¸»åŠ¨æ¶ˆæ¯å¤„ç†');
                        return;
                    }
                    
                    console.log('ğŸ”„ å®šæœŸæ£€æŸ¥ä¸»åŠ¨æ¶ˆæ¯é˜Ÿåˆ—...');
                    QQ_ProcessProactiveMessageQueue();
                }, config.queueProcessInterval);
                
                console.log(`â° ä¸»åŠ¨æ¶ˆæ¯è°ƒåº¦å™¨å·²å¯åŠ¨ï¼Œæ¯${config.queueProcessInterval}msæ£€æŸ¥ä¸€æ¬¡`);
            }
            
            /**
             * *** é˜¶æ®µä¸‰ï¼šæ˜¾ç¤ºä¸»åŠ¨æ¶ˆæ¯é€šçŸ¥ ***
             * @param {string} characterName - è§’è‰²å
             * @param {string} content - æ¶ˆæ¯å†…å®¹
             */
            function QQ_ShowProactiveMessageNotification(characterName, content) {
                // å¢åŠ æœªè¯»è®¡æ•°
                QQ_IncrementUnreadCount(characterName);
                
                // åˆ›å»ºé€šçŸ¥HTML
                const notificationHtml = `
                    <div class="proactive-message-notification" data-character="${characterName}" style="
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        padding: 12px 16px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        z-index: 1000;
                        max-width: 300px;
                        font-size: 14px;
                        animation: slideInRight 0.3s ease-out;
                        cursor: pointer;
                        transition: transform 0.2s ease;
                    ">
                        <div style="font-weight: 600; margin-bottom: 4px;">
                            ğŸ’¬ ${characterName} ä¸»åŠ¨è”ç³»ä½ 
                        </div>
                        <div style="opacity: 0.9; line-height: 1.4;">
                            ${content.length > 60 ? content.substring(0, 60) + '...' : content}
                        </div>
                        <div style="font-size: 11px; opacity: 0.7; margin-top: 6px; text-align: center;">
                            ç‚¹å‡»æŸ¥çœ‹å®Œæ•´æ¶ˆæ¯
                        </div>
                    </div>
                    
                    <style>
                        @keyframes slideInRight {
                            from {
                                transform: translateX(100%);
                                opacity: 0;
                            }
                            to {
                                transform: translateX(0);
                                opacity: 1;
                            }
                        }
                        .proactive-message-notification:hover {
                            transform: scale(1.02);
                        }
                    </style>
                `;
                
                // æ·»åŠ åˆ°é¡µé¢
                $('body').append(notificationHtml);
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†å™¨
                $('.proactive-message-notification').on('click', function() {
                    const characterName = $(this).data('character');
                    console.log(`ğŸ”” ä¸»åŠ¨æ¶ˆæ¯é€šçŸ¥è¢«ç‚¹å‡»: ${characterName}`);
                    
                    // æ¸…é™¤è¯¥è§’è‰²çš„æœªè¯»è®¡æ•°
                    QQ_ClearUnreadCount(characterName);
                    
                    // ç«‹å³è·³è½¬åˆ°å¯¹åº”ç§èŠï¼ˆæ¶ˆæ¯å·²ç»åœ¨èŠå¤©ç•Œé¢ä¸­ï¼‰
                    QQ_OpenPrivateChat(characterName);
                    
                    // ä¸éœ€è¦å†è°ƒç”¨QQ_DisplayProactiveMessageForCharacterï¼Œå› ä¸ºæ¶ˆæ¯å·²ç»é€šè¿‡æµå¼æ–¹å¼æ·»åŠ 
                    
                    // ç§»é™¤é€šçŸ¥
                    $(this).fadeOut(200, function() {
                        $(this).remove();
                    });
                });
                
                // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±ï¼ˆå»¶é•¿æ˜¾ç¤ºæ—¶é—´ï¼‰
                setTimeout(() => {
                    $('.proactive-message-notification').fadeOut(300, function() {
                        $(this).remove();
                    });
                }, 5000);
            }
            
            /**
             * å¤„ç†å¹¶åº”ç”¨ tableEdit æ ‡ç­¾åˆ° SillyTavern è®°å¿†ç³»ç»Ÿ
             * @param {string} content - åŒ…å« tableEdit æ ‡ç­¾çš„å†…å®¹
             */
            function QQ_ProcessTableEdit(content) {
                if (!content || typeof content !== 'string') {
                    return;
                }
                
                // æå–æ‰€æœ‰ tableEdit æ ‡ç­¾
                const tableEditMatches = [...content.matchAll(/<tableEdit>([\s\S]*?)<\/tableEdit>/gi)];
                
                if (tableEditMatches.length === 0) {
                    console.log('ğŸ—‚ï¸ æœªæ‰¾åˆ° tableEdit æ ‡ç­¾');
                    return;
                }
                
                console.log(`ğŸ—‚ï¸ æ‰¾åˆ° ${tableEditMatches.length} ä¸ª tableEdit æ ‡ç­¾ï¼Œå¼€å§‹å¤„ç†`);
                
                tableEditMatches.forEach((match, index) => {
                    try {
                        const tableContent = match[1].trim();
                        console.log(`ğŸ—‚ï¸ å¤„ç† tableEdit ${index + 1}:`, tableContent);
                        
                        // å°è¯•è§£æ JSON æ ¼å¼çš„è¡¨æ ¼æ•°æ®
                        let tableData;
                        try {
                            tableData = JSON.parse(tableContent);
                        } catch (jsonError) {
                            // å¦‚æœä¸æ˜¯ JSON æ ¼å¼ï¼Œå°è¯•è§£æä¸ºç®€å•çš„é”®å€¼å¯¹
                            console.log('ğŸ—‚ï¸ JSON è§£æå¤±è´¥ï¼Œå°è¯•è§£æä¸ºé”®å€¼å¯¹æ ¼å¼');
                            tableData = QQ_ParseTableEditText(tableContent);
                        }
                        
                        if (tableData) {
                            // è°ƒç”¨ SillyTavern çš„è®°å¿†è¡¨æ ¼ API
                            QQ_ApplyToMemoryTable(tableData);
                            console.log(`âœ… tableEdit ${index + 1} å·²åº”ç”¨åˆ°è®°å¿†è¡¨æ ¼`);
                        } else {
                            console.warn(`âš ï¸ æ— æ³•è§£æ tableEdit ${index + 1} çš„å†…å®¹`);
                        }
                        
                    } catch (error) {
                        console.error(`âŒ å¤„ç† tableEdit ${index + 1} æ—¶å‡ºé”™:`, error);
                    }
                });
            }
            
            /**
             * è§£ææ–‡æœ¬æ ¼å¼çš„ tableEdit å†…å®¹
             * @param {string} text - æ–‡æœ¬å†…å®¹
             * @returns {Object|null} è§£æåçš„è¡¨æ ¼æ•°æ®
             */
            function QQ_ParseTableEditText(text) {
                try {
                    const lines = text.split('\n').filter(line => line.trim());
                    const result = {};
                    
                    lines.forEach(line => {
                        // å°è¯•åŒ¹é…å„ç§æ ¼å¼: "key: value", "key = value", "key - value"
                        const match = line.match(/^\s*([^:=\-]+)[:=\-]\s*(.+)$/);
                        if (match) {
                            const key = match[1].trim();
                            const value = match[2].trim();
                            result[key] = value;
                        }
                    });
                    
                    return Object.keys(result).length > 0 ? result : null;
                } catch (error) {
                    console.error('âŒ è§£ææ–‡æœ¬æ ¼å¼è¡¨æ ¼æ•°æ®å¤±è´¥:', error);
                    return null;
                }
            }
            
            /**
             * å°†è¡¨æ ¼æ•°æ®åº”ç”¨åˆ° SillyTavern è®°å¿†è¡¨æ ¼æ’ä»¶
             * @param {Object} tableData - è¡¨æ ¼æ•°æ®
             */
            function QQ_ApplyToMemoryTable(tableData) {
                try {
                    // æ£€æŸ¥æ˜¯å¦å­˜åœ¨è®°å¿†è¡¨æ ¼æ’ä»¶
                    if (typeof window.memoryTableExtension !== 'undefined') {
                        // å¦‚æœæ’ä»¶å­˜åœ¨ï¼Œç›´æ¥è°ƒç”¨å…¶ API
                        window.memoryTableExtension.updateTable(tableData);
                        console.log('ğŸ—‚ï¸ å·²é€šè¿‡è®°å¿†è¡¨æ ¼æ’ä»¶ API æ›´æ–°æ•°æ®');
                    } else if (typeof window.extensions !== 'undefined' && window.extensions['st-memory-enhancement']) {
                        // å°è¯•è°ƒç”¨ st-memory-enhancement æ’ä»¶
                        const memoryExt = window.extensions['st-memory-enhancement'];
                        if (memoryExt && typeof memoryExt.updateMemory === 'function') {
                            memoryExt.updateMemory(tableData);
                            console.log('ğŸ—‚ï¸ å·²é€šè¿‡ st-memory-enhancement æ’ä»¶æ›´æ–°æ•°æ®');
                        } else {
                            QQ_ApplyToMemoryTableFallback(tableData);
                        }
                    } else {
                        // å¦‚æœæ²¡æœ‰æ’ä»¶ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•
                        QQ_ApplyToMemoryTableFallback(tableData);
                    }
                } catch (error) {
                    console.error('âŒ åº”ç”¨è¡¨æ ¼æ•°æ®åˆ°è®°å¿†ç³»ç»Ÿå¤±è´¥:', error);
                    QQ_ApplyToMemoryTableFallback(tableData);
                }
            }
            
            /**
             * å¤‡ç”¨æ–¹æ³•ï¼šç›´æ¥æ“ä½œ SillyTavern çš„å†…å­˜æˆ– DOM
             * @param {Object} tableData - è¡¨æ ¼æ•°æ®
             */
            function QQ_ApplyToMemoryTableFallback(tableData) {
                try {
                    // å°è¯•å°†æ•°æ®å­˜å‚¨åˆ° SillyTavern çš„è§’è‰²è®°å¿†ä¸­
                    if (typeof window.characters !== 'undefined' && window.this_chid !== undefined) {
                        const currentChar = window.characters[window.this_chid];
                        if (currentChar) {
                            // åˆå§‹åŒ– tableMemory å­—æ®µï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
                            if (!currentChar.data.extensions) {
                                currentChar.data.extensions = {};
                            }
                            if (!currentChar.data.extensions.memory_table) {
                                currentChar.data.extensions.memory_table = {};
                            }
                            
                            // åˆå¹¶æ–°çš„è¡¨æ ¼æ•°æ®
                            Object.assign(currentChar.data.extensions.memory_table, tableData);
                            
                            console.log('ğŸ—‚ï¸ å·²å°†è¡¨æ ¼æ•°æ®å­˜å‚¨åˆ°è§’è‰²è®°å¿†ä¸­');
                            
                            // è§¦å‘è§’è‰²æ•°æ®ä¿å­˜ï¼ˆå¦‚æœç›¸å…³å‡½æ•°å­˜åœ¨ï¼‰
                            if (typeof window.saveCharacterDebounced === 'function') {
                                window.saveCharacterDebounced();
                            }
                        }
                    }
                    
                    // å‘é€è‡ªå®šä¹‰äº‹ä»¶ï¼Œé€šçŸ¥å¯èƒ½çš„ç›‘å¬å™¨
                    const event = new CustomEvent('tableEditUpdate', {
                        detail: { tableData: tableData }
                    });
                    document.dispatchEvent(event);
                    
                    console.log('ğŸ—‚ï¸ å·²è§¦å‘ tableEditUpdate äº‹ä»¶');
                    
                } catch (error) {
                    console.error('âŒ å¤‡ç”¨è¡¨æ ¼æ•°æ®å¤„ç†å¤±è´¥:', error);
                }
            }
            
            /**
             * æ·»åŠ æ—¶é—´åˆ†éš”ç³»ç»Ÿæ¶ˆæ¯
             * @param {Element} chatContainer - èŠå¤©å®¹å™¨
             * @param {string} chatName - èŠå¤©åç§°
             * @param {string} timeText - æ—¶é—´æ–‡æœ¬ï¼Œå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨å½“å‰æ—¶é—´
             */
            function QQ_AddTimeDividerMessage(chatContainer, chatName, timeText = null) {
                if (!timeText) {
                    const now = new Date();
                    timeText = now.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    });
                }
                
                // *** ä½¿ç”¨æ ‡å‡†ç³»ç»Ÿæ¶ˆæ¯æ ¼å¼ ***
                const systemMessageContent = `ç³»ç»Ÿæ¶ˆæ¯--${timeText}--ğŸ“… ${timeText}`;
                
                // ä½¿ç”¨æ ‡å‡†çš„ç³»ç»Ÿæ¶ˆæ¯å¤„ç†å‡½æ•°
                const msgDiv = $("<div>", { class: "system-message" }).text(`ğŸ“… ${timeText}`);
                $(chatContainer).append(msgDiv);
                
                console.log(`â° ä¸º ${chatName} æ·»åŠ æ—¶é—´åˆ†éš”æ¶ˆæ¯: ${timeText}`);
                
                // æ»šåŠ¨åˆ°åº•éƒ¨
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
            
            /**
             * æ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ æ—¶é—´åˆ†éš”æ¶ˆæ¯
             * @param {Element} chatContainer - èŠå¤©å®¹å™¨
             * @param {string} chatName - èŠå¤©åç§°
             */
            function QQ_CheckAndAddTimeDivider(chatContainer, chatName) {
                const existingTimeDivider = chatContainer.querySelector('.time-divider');
                if (!existingTimeDivider) {
                    // æ²¡æœ‰æ—¶é—´åˆ†éš”å™¨ï¼Œæ·»åŠ ä¸€ä¸ª
                    QQ_AddTimeDividerMessage(chatContainer, chatName);
                    return true;
                }
                return false;
            }
            
            /**
             * *** é˜¶æ®µä¸‰ï¼šæ›´æ–°è”ç³»äººé€šçŸ¥ ***
             * @param {string} characterName - è§’è‰²å
             * @param {boolean} hasNewMessage - æ˜¯å¦æœ‰æ–°æ¶ˆæ¯
             */
            function QQ_UpdateContactNotification(characterName, hasNewMessage) {
                // æŸ¥æ‰¾è”ç³»äººåˆ—è¡¨ä¸­çš„å¯¹åº”é¡¹
                const contactItems = document.querySelectorAll('.contact-item');
                for (const item of contactItems) {
                    const nameElement = item.querySelector('.contact-name');
                    if (nameElement && nameElement.textContent.trim() === characterName) {
                        let redDot = item.querySelector('.red-dot');
                        
                        if (hasNewMessage) {
                            // æ·»åŠ çº¢ç‚¹æç¤º
                            if (!redDot) {
                                redDot = document.createElement('div');
                                redDot.className = 'red-dot';
                                redDot.style.cssText = `
                                    position: absolute;
                                    top: 5px;
                                    right: 5px;
                                    width: 12px;
                                    height: 12px;
                                    background: #ff4757;
                                    border-radius: 50%;
                                    border: 2px solid white;
                                `;
                                item.style.position = 'relative';
                                item.appendChild(redDot);
                            }
                        } else {
                            // ç§»é™¤çº¢ç‚¹æç¤º
                            if (redDot) {
                                redDot.remove();
                            }
                        }
                        break;
                    }
                }
            }
            
            /**
             * *** é˜¶æ®µä¸‰ï¼šæ‰“å¼€ç§èŠç•Œé¢ ***
             * @param {string} characterName - è§’è‰²å
             */
            function QQ_OpenPrivateChat(characterName) {
                console.log(`ğŸ”— æ‰“å¼€ä¸ ${characterName} çš„ç§èŠ`);
                
                // ä¼˜å…ˆå°è¯•åœ¨è”ç³»äººé¡µé¢æŸ¥æ‰¾å¹¶æ‰“å¼€ç§èŠ
                // ç¬¬ä¸€æ­¥ï¼šåˆ‡æ¢åˆ°è”ç³»äººé¡µé¢
                if (typeof QQ_Nav === 'function') {
                    QQ_Nav('people');
                } else {
                    console.warn('QQ_Navå‡½æ•°ä¸å¯ç”¨ï¼Œå°è¯•æ‰‹åŠ¨åˆ‡æ¢é¡µé¢');
                    // æ‰‹åŠ¨æ˜¾ç¤ºè”ç³»äººé¡µé¢
                    $('.QQ_chat_page').hide();
                    $('#App_QQ').show();
                }
                
                // ç¨ç­‰ä¸€ä¸‹ç¡®ä¿é¡µé¢åˆ‡æ¢å®Œæˆï¼Œç„¶åæŸ¥æ‰¾è”ç³»äºº
                setTimeout(() => {
                    // ç¬¬äºŒæ­¥ï¼šåœ¨è”ç³»äººåˆ—è¡¨ä¸­æŸ¥æ‰¾å¯¹åº”è§’è‰²
                    const contactItems = document.querySelectorAll('.QQ_home_usermsg');
                    for (const item of contactItems) {
                        const nameElement = item.querySelector('.QQ_home_name, .QQ_home_name strong');
                        if (nameElement) {
                            const contactName = nameElement.textContent.trim();
                            if (contactName === characterName) {
                                console.log(`âœ… æ‰¾åˆ°è”ç³»äºº ${characterName}ï¼Œæ¨¡æ‹Ÿç‚¹å‡»`);
                                // æ¨¡æ‹Ÿç‚¹å‡»è”ç³»äººé¡¹
                                item.click();
                                return;
                            }
                        }
                    }
                    
                    // å¦‚æœåœ¨è”ç³»äººé¡µé¢æ²¡æ‰¾åˆ°ï¼Œå°è¯•åœ¨æ¶ˆæ¯é¡µé¢æŸ¥æ‰¾
                    console.log(`âš ï¸ åœ¨è”ç³»äººé¡µé¢æœªæ‰¾åˆ° ${characterName}ï¼Œå°è¯•åœ¨æ¶ˆæ¯é¡µé¢æŸ¥æ‰¾`);
                    
                    // åˆ‡æ¢åˆ°æ¶ˆæ¯é¡µé¢
                    if (typeof QQ_Nav === 'function') {
                        QQ_Nav('message');
                    }
                    
                    setTimeout(() => {
                        // æŸ¥æ‰¾å¯¹åº”çš„ç§èŠé¡¹ç›®å¹¶ç‚¹å‡»
                        const chatItems = document.querySelectorAll('.QQ_chat_list_item');
                        for (const item of chatItems) {
                            const nameElement = item.querySelector('.QQ_chat_list_item_name');
                            if (nameElement && nameElement.textContent.trim() === characterName) {
                                // æ¨¡æ‹Ÿç‚¹å‡»äº‹ä»¶
                                item.click();
                                console.log(`âœ… åœ¨æ¶ˆæ¯é¡µé¢æ‰¾åˆ°å¹¶æ‰“å¼€ä¸ ${characterName} çš„ç§èŠ`);
                                return;
                            }
                        }
                        
                        // æœ€åçš„å¤‡é€‰æ–¹æ¡ˆï¼šåˆ›å»ºæ–°çš„ç§èŠ
                        console.log(`âš ï¸ æœªæ‰¾åˆ°ä¸ ${characterName} çš„ç°æœ‰å¯¹è¯ï¼Œå°è¯•åˆ›å»ºæ–°å¯¹è¯`);
                        QQ_OpenChat(characterName, false);
                    }, 200);
                }, 200);
            }
            
            /**
             * *** é˜¶æ®µä¸‰ï¼šæ˜¾ç¤ºç‰¹å®šè§’è‰²çš„ä¸»åŠ¨æ¶ˆæ¯ ***
             * @param {string} characterName - è§’è‰²å
             */
            function QQ_DisplayProactiveMessageForCharacter(characterName) {
                const queue = window.QQ_ProactiveMessageQueue.queue;
                
                if (!queue.has(characterName)) {
                    console.log(`ğŸ“­ ${characterName} æ²¡æœ‰ä¸»åŠ¨æ¶ˆæ¯`);
                    return;
                }
                
                const messages = queue.get(characterName);
                const pendingMessages = messages.filter(msg => msg.status === 'pending');
                
                if (pendingMessages.length === 0) {
                    console.log(`ğŸ“­ ${characterName} æ²¡æœ‰å¾…å‘é€çš„ä¸»åŠ¨æ¶ˆæ¯`);
                    return;
                }
                
                console.log(`ğŸ’¬ ç«‹å³æ˜¾ç¤º ${characterName} çš„ ${pendingMessages.length} æ¡ä¸»åŠ¨æ¶ˆæ¯`);
                
                // è·å–å½“å‰èŠå¤©å®¹å™¨
                const chatContainer = document.querySelector(`.QQ_chat_page[data-name="${characterName}"] .msgcontent`);
                if (!chatContainer) {
                    console.log(`âŒ æ‰¾ä¸åˆ° ${characterName} çš„èŠå¤©å®¹å™¨`);
                    return;
                }
                
                // ä½¿ç”¨æµå¼é˜Ÿåˆ—æ˜¾ç¤ºæ‰€æœ‰å¾…å‘é€çš„ä¸»åŠ¨æ¶ˆæ¯
                const messagesToDisplay = pendingMessages.map(messageData => {
                    const timestamp = new Date().toLocaleTimeString('zh-CN', {
                        hour12: false,
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    return `${characterName}--${messageData.content}--${timestamp}`;
                });
                
                // ä½¿ç”¨é˜Ÿåˆ—æœºåˆ¶æµå¼æ˜¾ç¤ºä¸»åŠ¨æ¶ˆæ¯
                QQ_EnqueueStreamingTask({
                    handler: async () => {
                        await QQ_DisplayStreamingMessagesDirectly(chatContainer, messagesToDisplay, characterName, true, false);
                        
                        // æ‰€æœ‰æ¶ˆæ¯æ˜¾ç¤ºå®Œæˆåï¼Œæ ‡è®°ä¸ºå·²å‘é€
                        pendingMessages.forEach(messageData => {
                            messageData.status = 'delivered';
                            messageData.deliveredAt = Date.now();
                        });
                        
                        console.log(`âœ… å·²æµå¼æ˜¾ç¤º ${pendingMessages.length} æ¡ä¸»åŠ¨æ¶ˆæ¯`);
                    },
                    args: [],
                    description: `æ‰¹é‡ä¸»åŠ¨æ¶ˆæ¯æµå¼æ˜¾ç¤º: ${characterName} (${pendingMessages.length}æ¡)`,
                    chatName: characterName // æ·»åŠ èŠå¤©åç§°ï¼Œæ”¯æŒå¹¶è¡Œå¤„ç†
                });
                
                // ä¿å­˜æ›´æ–°åçš„é˜Ÿåˆ—çŠ¶æ€
                setTimeout(() => {
                    QQ_SaveProactiveMessageQueue();
                }, (pendingMessages.length + 1) * 1000);
            }
            
            /**
             * *** é˜¶æ®µä¸‰ï¼šæ’­æ”¾é€šçŸ¥å£°éŸ³ ***
             */
            function QQ_PlayNotificationSound() {
                // ç®€å•çš„éŸ³é¢‘é€šçŸ¥ï¼ˆå¯ä»¥æ ¹æ®éœ€è¦æ‰©å±•ï¼‰
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                } catch (error) {
                    console.log('é€šçŸ¥å£°éŸ³æ’­æ”¾å¤±è´¥:', error);
                }
            }
            
            /**
             * *** é˜¶æ®µä¸‰ï¼šä¿å­˜ä¸»åŠ¨æ¶ˆæ¯é˜Ÿåˆ—åˆ°ä¸–ç•Œä¹¦ ***
             */
            async function QQ_SaveProactiveMessageQueue() {
                if (!worldbook || !entries) {
                    console.log('ğŸ”‡ ä¸–ç•Œä¹¦æœªåˆå§‹åŒ–ï¼Œæ— æ³•ä¿å­˜ä¸»åŠ¨æ¶ˆæ¯é˜Ÿåˆ—');
                    return false;
                }
                
                try {
                    const charId = getCurrentCharacterId();
                    const queueKey = `QQ_ä¸»åŠ¨æ¶ˆæ¯é˜Ÿåˆ—_${charId}`;
                    
                    // å°†Mapè½¬æ¢ä¸ºå¯åºåˆ—åŒ–çš„å¯¹è±¡
                    const queueData = {
                        version: '1.0',
                        timestamp: Date.now(),
                        characterId: charId,
                        queue: Object.fromEntries(window.QQ_ProactiveMessageQueue.queue),
                        statistics: window.QQ_ProactiveMessageQueue.statistics,
                        config: window.QQ_ProactiveMessageQueue.config
                    };
                    
                    // æŸ¥æ‰¾ç°æœ‰æ¡ç›®
                    let queueEntry = entries.find(entry => 
                        entry.keys && Array.isArray(entry.keys) && entry.keys.includes(queueKey)
                    );
                    
                    if (queueEntry) {
                        // æ›´æ–°ç°æœ‰æ¡ç›®
                        queueEntry.content = JSON.stringify(queueData);
                    } else {
                        // åˆ›å»ºæ–°æ¡ç›®
                        queueEntry = {
                            uid: Date.now(),
                            keys: [queueKey],
                            keysecondary: [],
                            comment: `è§’è‰²${charId}çš„ä¸»åŠ¨æ¶ˆæ¯é˜Ÿåˆ—æ•°æ®`,
                            content: JSON.stringify(queueData),
                            constant: false,
                            selective: true,
                            vectorized: false,
                            selectiveLogic: 0,
                            addMemo: true,
                            order: entries.length,
                            disable: false,
                            excludeRecursion: false,
                            preventRecursion: false,
                            delayUntilRecursion: false,
                            displayIndex: entries.length + 1,
                            probability: 100,
                            useProbability: true
                        };
                        entries.push(queueEntry);
                    }
                    
                    // ä¿å­˜åˆ°SillyTavernçš„ä¸–ç•Œä¹¦
                    await QQ_SafeSaveWorldInfo("ä¸»åŠ¨æ¶ˆæ¯é˜Ÿåˆ—");
                    
                    console.log(`ğŸ’¾ ä¸»åŠ¨æ¶ˆæ¯é˜Ÿåˆ—å·²ä¿å­˜åˆ°ä¸–ç•Œä¹¦: ${queueKey}`);
                    return true;
                    
                } catch (error) {
                    console.error('âŒ ä¿å­˜ä¸»åŠ¨æ¶ˆæ¯é˜Ÿåˆ—å¤±è´¥:', error);
                    return false;
                }
            }
            
            /**
             * *** é˜¶æ®µä¸‰ï¼šä»ä¸–ç•Œä¹¦åŠ è½½ä¸»åŠ¨æ¶ˆæ¯é˜Ÿåˆ— ***
             */
            async function QQ_LoadProactiveMessageQueue() {
                if (!worldbook || !entries) {
                    console.log('ğŸ”‡ ä¸–ç•Œä¹¦æœªåˆå§‹åŒ–ï¼Œæ— æ³•åŠ è½½ä¸»åŠ¨æ¶ˆæ¯é˜Ÿåˆ—');
                    return false;
                }
                
                try {
                    const charId = getCurrentCharacterId();
                    const queueKey = `QQ_ä¸»åŠ¨æ¶ˆæ¯é˜Ÿåˆ—_${charId}`;
                    
                    // æŸ¥æ‰¾é˜Ÿåˆ—æ•°æ®æ¡ç›®
                    const queueEntry = entries.find(entry => 
                        entry.keys && Array.isArray(entry.keys) && entry.keys.includes(queueKey)
                    );
                    
                    if (!queueEntry || !queueEntry.content) {
                        console.log(`ğŸ“­ è§’è‰²${charId}æ²¡æœ‰ä¿å­˜çš„ä¸»åŠ¨æ¶ˆæ¯é˜Ÿåˆ—æ•°æ®`);
                        return false;
                    }
                    
                    const queueData = JSON.parse(queueEntry.content);
                    
                    // æ¢å¤é˜Ÿåˆ—æ•°æ®
                    window.QQ_ProactiveMessageQueue.queue = new Map(Object.entries(queueData.queue || {}));
                    
                    // æ¢å¤ç»Ÿè®¡æ•°æ®
                    if (queueData.statistics) {
                        Object.assign(window.QQ_ProactiveMessageQueue.statistics, queueData.statistics);
                    }
                    
                    // æ¢å¤é…ç½®ï¼ˆä¿æŒå½“å‰é…ç½®ä¸ºä¸»ï¼Œåªæ¢å¤éƒ¨åˆ†è®¾ç½®ï¼‰
                    if (queueData.config) {
                        window.QQ_ProactiveMessageQueue.config.maxMessagesPerCharacter = 
                            queueData.config.maxMessagesPerCharacter || window.QQ_ProactiveMessageQueue.config.maxMessagesPerCharacter;
                    }
                    
                    console.log(`ğŸ“¥ å·²ä»ä¸–ç•Œä¹¦åŠ è½½ä¸»åŠ¨æ¶ˆæ¯é˜Ÿåˆ—: ${queueKey}`);
                    console.log(`ğŸ“Š é˜Ÿåˆ—ç»Ÿè®¡: å·²ç”Ÿæˆ${queueData.statistics?.generated || 0}æ¡, å·²å‘é€${queueData.statistics?.delivered || 0}æ¡`);
                    
                    return true;
                    
                } catch (error) {
                    console.error('âŒ åŠ è½½ä¸»åŠ¨æ¶ˆæ¯é˜Ÿåˆ—å¤±è´¥:', error);
                    return false;
                }
            }
            
            /**
             * *** é˜¶æ®µä¸‰ï¼šæ¸…ç†è¿‡æœŸä¸»åŠ¨æ¶ˆæ¯ ***
             * æ¸…ç†è¶…è¿‡ä¸€å®šæ—¶é—´çš„å·²å‘é€æ¶ˆæ¯ï¼Œé¿å…é˜Ÿåˆ—æ— é™å¢é•¿
             */
            function QQ_CleanupProactiveMessageQueue() {
                const queue = window.QQ_ProactiveMessageQueue.queue;
                const maxAge = 7 * 24 * 60 * 60 * 1000; // 7å¤©
                const cutoffTime = Date.now() - maxAge;
                
                let cleanedCount = 0;
                
                for (const [characterName, messages] of queue.entries()) {
                    const originalLength = messages.length;
                    
                    // ä¿ç•™æœªå‘é€çš„æ¶ˆæ¯å’Œ7å¤©å†…å‘é€çš„æ¶ˆæ¯
                    const filteredMessages = messages.filter(msg => 
                        msg.status !== 'delivered' || 
                        (msg.deliveredAt && msg.deliveredAt > cutoffTime)
                    );
                    
                    if (filteredMessages.length < originalLength) {
                        queue.set(characterName, filteredMessages);
                        cleanedCount += originalLength - filteredMessages.length;
                        
                        // å¦‚æœè§’è‰²æ²¡æœ‰å‰©ä½™æ¶ˆæ¯ï¼Œç§»é™¤è¯¥è§’è‰²
                        if (filteredMessages.length === 0) {
                            queue.delete(characterName);
                        }
                    }
                }
                
                if (cleanedCount > 0) {
                    console.log(`ğŸ§¹ å·²æ¸…ç†${cleanedCount}æ¡è¿‡æœŸä¸»åŠ¨æ¶ˆæ¯`);
                }
                
                return cleanedCount;
            }
            
            /**
             * *** é˜¶æ®µä¸‰ï¼šè°ƒè¯•å’Œç®¡ç†å·¥å…· ***
             * ä¾¿äºå¼€å‘è€…å’Œç”¨æˆ·ç›‘æ§å’Œç®¡ç†ä¸»åŠ¨æ¶ˆæ¯ç³»ç»Ÿ
             */
            
            // æš´éœ²è°ƒè¯•å‡½æ•°åˆ°å…¨å±€çª—å£å¯¹è±¡
            window.QQ_Stage3_Debug = {
                /**
                 * æŸ¥çœ‹ä¸»åŠ¨æ¶ˆæ¯é˜Ÿåˆ—çŠ¶æ€
                 */
                showQueueStatus: function() {
                    const queue = window.QQ_ProactiveMessageQueue.queue;
                    const stats = window.QQ_ProactiveMessageQueue.statistics;
                    const config = window.QQ_ProactiveMessageQueue.config;
                    
                    console.log('ğŸ¯ === ä¸»åŠ¨æ¶ˆæ¯é˜Ÿåˆ—çŠ¶æ€ ===');
                    console.log(`ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:`);
                    console.log(`  - å·²ç”Ÿæˆ: ${stats.generated}æ¡`);
                    console.log(`  - å·²å‘é€: ${stats.delivered}æ¡`);
                    console.log(`  - å‘é€å¤±è´¥: ${stats.failed}æ¡`);
                    console.log(`  - æˆåŠŸç‡: ${stats.generated > 0 ? ((stats.delivered / stats.generated) * 100).toFixed(1) : 0}%`);
                    
                    console.log(`âš™ï¸ é…ç½®ä¿¡æ¯:`);
                    console.log(`  - æ¯è§’è‰²æœ€å¤§æ¶ˆæ¯æ•°: ${config.maxMessagesPerCharacter}`);
                    console.log(`  - å‘é€å»¶è¿ŸèŒƒå›´: ${config.messageDeliveryDelay.min}-${config.messageDeliveryDelay.max}ms`);
                    console.log(`  - é˜Ÿåˆ—æ£€æŸ¥é—´éš”: ${config.queueProcessInterval}ms`);
                    console.log(`  - è‡ªåŠ¨å¤„ç†: ${config.enableAutoProcess ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
                    
                    console.log(`ğŸ“¨ é˜Ÿåˆ—å†…å®¹:`);
                    if (queue.size === 0) {
                        console.log('  é˜Ÿåˆ—ä¸ºç©º');
                    } else {
                        for (const [characterName, messages] of queue.entries()) {
                            console.log(`  ${characterName}: ${messages.length}æ¡æ¶ˆæ¯`);
                            messages.forEach((msg, index) => {
                                const statusIcon = msg.status === 'pending' ? 'â³' : 
                                                 msg.status === 'scheduled' ? 'â°' : 
                                                 msg.status === 'delivered' ? 'âœ…' : 'âŒ';
                                console.log(`    ${index + 1}. ${statusIcon} ${msg.content.substring(0, 50)}...`);
                            });
                        }
                    }
                    
                    return { queue: Object.fromEntries(queue), stats, config };
                },
                
                /**
                 * æ‰‹åŠ¨æ·»åŠ æµ‹è¯•æ¶ˆæ¯
                 */
                addTestMessage: function(characterName, content) {
                    if (!characterName || !content) {
                        console.error('âŒ è¯·æä¾›è§’è‰²åå’Œæ¶ˆæ¯å†…å®¹');
                        return false;
                    }
                    
                    QQ_AddProactiveMessage(characterName, content);
                    console.log(`âœ… å·²æ·»åŠ æµ‹è¯•æ¶ˆæ¯: ${characterName} -> ${content}`);
                    return true;
                },
                
                /**
                 * æ‰‹åŠ¨è§¦å‘é˜Ÿåˆ—å¤„ç†
                 */
                processQueue: function() {
                    console.log('ğŸš€ æ‰‹åŠ¨è§¦å‘é˜Ÿåˆ—å¤„ç†...');
                    QQ_ProcessProactiveMessageQueue();
                },
                
                /**
                 * æ¸…ç©ºæŒ‡å®šè§’è‰²çš„é˜Ÿåˆ—
                 */
                clearCharacterQueue: function(characterName) {
                    const queue = window.QQ_ProactiveMessageQueue.queue;
                    if (queue.has(characterName)) {
                        queue.delete(characterName);
                        console.log(`ğŸ§¹ å·²æ¸…ç©ºè§’è‰²${characterName}çš„æ¶ˆæ¯é˜Ÿåˆ—`);
                        return true;
                    } else {
                        console.log(`âŒ è§’è‰²${characterName}æ²¡æœ‰æ¶ˆæ¯é˜Ÿåˆ—`);
                        return false;
                    }
                },
                
                /**
                 * æ¸…ç©ºæ‰€æœ‰é˜Ÿåˆ—
                 */
                clearAllQueues: function() {
                    window.QQ_ProactiveMessageQueue.queue.clear();
                    console.log('ğŸ§¹ å·²æ¸…ç©ºæ‰€æœ‰ä¸»åŠ¨æ¶ˆæ¯é˜Ÿåˆ—');
                    return true;
                },
                
                /**
                 * é‡ç½®ç»Ÿè®¡æ•°æ®
                 */
                resetStatistics: function() {
                    const stats = window.QQ_ProactiveMessageQueue.statistics;
                    stats.generated = 0;
                    stats.delivered = 0;
                    stats.failed = 0;
                    console.log('ğŸ“Š å·²é‡ç½®ç»Ÿè®¡æ•°æ®');
                    return true;
                },
                
                /**
                 * æ‰‹åŠ¨ä¿å­˜åˆ°ä¸–ç•Œä¹¦
                 */
                saveToWorldbook: async function() {
                    console.log('ğŸ’¾ æ‰‹åŠ¨ä¿å­˜åˆ°ä¸–ç•Œä¹¦...');
                    const success = await QQ_SaveProactiveMessageQueue();
                    if (success) {
                        console.log('âœ… ä¿å­˜æˆåŠŸ');
                    } else {
                        console.log('âŒ ä¿å­˜å¤±è´¥');
                    }
                    return success;
                },
                
                /**
                 * æ‰‹åŠ¨ä»ä¸–ç•Œä¹¦åŠ è½½
                 */
                loadFromWorldbook: async function() {
                    console.log('ğŸ“¥ æ‰‹åŠ¨ä»ä¸–ç•Œä¹¦åŠ è½½...');
                    const success = await QQ_LoadProactiveMessageQueue();
                    if (success) {
                        console.log('âœ… åŠ è½½æˆåŠŸ');
                    } else {
                        console.log('âŒ åŠ è½½å¤±è´¥æˆ–æ— æ•°æ®');
                    }
                    return success;
                },
                
                /**
                 * æµ‹è¯•ä¸»åŠ¨æ¶ˆæ¯é€šçŸ¥
                 */
                testNotification: function(characterName = 'æµ‹è¯•è§’è‰²', content = 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•ä¸»åŠ¨æ¶ˆæ¯é€šçŸ¥') {
                    QQ_ShowProactiveMessageNotification(characterName, content);
                    console.log('ğŸ”” å·²æ˜¾ç¤ºæµ‹è¯•é€šçŸ¥');
                },
                
                /**
                 * æŸ¥çœ‹ç³»ç»Ÿä¸Šä¸‹æ–‡çŠ¶æ€
                 */
                showSystemContext: function() {
                    const ctx = window.QQ_SystemContext;
                    console.log('ğŸ” === ç³»ç»Ÿä¸Šä¸‹æ–‡çŠ¶æ€ ===');
                    console.log(`åœ¨çº¿çŠ¶æ€: ${ctx.userOnlineStatus ? 'ğŸŸ¢ åœ¨çº¿' : 'ğŸ”´ ç¦»çº¿'}`);
                    console.log(`æœ€åä¸Šçº¿æ—¶é—´: ${ctx.lastOnlineTime || 'æœªçŸ¥'}`);
                    console.log(`å½“å‰èŠå¤©: ${ctx.currentChatName || 'æ— '}`);
                    console.log(`èŠå¤©ç±»å‹: ${ctx.currentChatType || 'æ— '}`);
                    console.log(`æœªè¯»æ¶ˆæ¯æ•°: ${ctx.unreadMessages.size}`);
                    console.log(`ç³»ç»Ÿäº‹ä»¶æ•°: ${ctx.systemEvents.length}`);
                    
                    if (ctx.systemEvents.length > 0) {
                        console.log('æœ€è¿‘äº‹ä»¶:');
                        ctx.systemEvents.slice(-5).forEach((event, index) => {
                            console.log(`  ${index + 1}. ${event.type} - ${event.data.timestamp}`);
                        });
                    }
                    
                    return ctx;
                },
                
                /**
                 * æµ‹è¯•æµå¼æ˜¾ç¤ºåŠŸèƒ½
                 */
                testStreamingDisplay: async function(chatName = 'æ¸¯åŒº') {
                    const testMessages = [
                        'æŸ´éƒ¡--æµ‹è¯•æµå¼æ˜¾ç¤ºç¬¬ä¸€æ¡æ¶ˆæ¯--17:10',
                        'è¨æ‹‰æ‰˜åŠ --æµ‹è¯•æµå¼æ˜¾ç¤ºç¬¬äºŒæ¡æ¶ˆæ¯--17:10',
                        'åˆæœˆ--æµ‹è¯•æµå¼æ˜¾ç¤ºç¬¬ä¸‰æ¡æ¶ˆæ¯--17:11'
                    ];
                    
                    const chatContainer = document.querySelector(`.QQ_chat_page[data-name="${chatName}"] .msgcontent`);
                    if (!chatContainer) {
                        console.log(`âŒ æœªæ‰¾åˆ°èŠå¤©å®¹å™¨: ${chatName}`);
                        return false;
                    }
                    
                    console.log('ğŸ§ª å¼€å§‹æµ‹è¯•æµå¼æ˜¾ç¤º...');
                    await QQ_DisplayStreamingMessagesDirectly(chatContainer, testMessages, chatName, true, false);
                    return true;
                }
            };
            
            // æ³¨æ„ï¼šaddGroupToContactListå’ŒaddGroupToMessageListå‡½æ•°å·²åˆ é™¤
            // ç°åœ¨ç»Ÿä¸€ä½¿ç”¨AddNewGroupå‡½æ•°ï¼Œå®ƒä¼šè‡ªåŠ¨å¤„ç†è”ç³»äººåˆ—è¡¨å’Œæ¶ˆæ¯åˆ—è¡¨çš„åŒæ­¥
            
            /**
             * ä¿å­˜ç¾¤èŠæ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
             */
            async function saveGroupToStorage(groupData) {
                // æ–°ç‰ˆæœ¬ï¼šä¿å­˜åˆ°ä¸–ç•Œä¹¦è€Œä¸æ˜¯localStorage
                console.log('saveGroupToStorageè¢«è°ƒç”¨ï¼Œè½¬å‘åˆ°ä¸–ç•Œä¹¦ä¿å­˜');
                console.log('ç¾¤èŠæ•°æ®:', groupData);
                
                const success = await addGroupToWorldbook(groupData);
                if (success) {
                    console.log('ç¾¤èŠå·²æˆåŠŸä¿å­˜åˆ°ä¸–ç•Œä¹¦');
                } else {
                    console.error('ä¿å­˜ç¾¤èŠåˆ°ä¸–ç•Œä¹¦å¤±è´¥');
                }
                return success;
            }
            
            /**
             * ä»æœ¬åœ°å­˜å‚¨åŠ è½½ç¾¤èŠæ•°æ®
             */
             async function loadGroupChatsFromWorldbook() {
                console.log('=== loadGroupChatsFromWorldbookè¢«è°ƒç”¨ï¼ˆä»ç‹¬ç«‹ç¾¤èŠæ¡ç›®ï¼‰ ===');
                console.log('å½“å‰worldbook:', typeof worldbook, worldbook ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
                
                const groups = [];
                
                console.log('ç¾¤èŠåŠ è½½ï¼šé‡‡ç”¨ä¸ç§èŠç›¸åŒçš„æ¨¡å¼ï¼Œä¸æ¸…ç†ç°æœ‰é¡¹ç›®');
                
                try {
                    // ä½¿ç”¨ä¸åŠ¨æ€å†…å®¹å­˜å‚¨ç›¸åŒçš„ç®€å•æ£€æŸ¥
                    if (!worldbook || !entries) {
                        console.warn('ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨ï¼Œæ— æ³•åŠ è½½ç¾¤èŠæ•°æ®');
                            return groups;
                    }
                    
                    console.log('å½“å‰entries:', typeof entries, entries ? entries.length : 'undefined');

                    // æŸ¥æ‰¾æ‰€æœ‰ç¾¤èŠæ¡ç›® - ä½¿ç”¨å”¯ä¸€commentå‰ç¼€æŸ¥æ‰¾
                    const groupEntries = entries.filter(e => e.comment && e.comment.startsWith("æ‰‹æœº-ç¾¤èŠ-"));
                    console.log('æ‰¾åˆ°çš„ç¾¤èŠæ¡ç›®æ•°é‡:', groupEntries.length);
                    
                    if (groupEntries.length === 0) {
                        console.log('æ²¡æœ‰æ‰¾åˆ°ç¾¤èŠæ¡ç›®ï¼Œå‡½æ•°æ‰§è¡Œç»“æŸ');
                        return groups; // æ—¢ç„¶æ²¡æœ‰ç¾¤èŠï¼Œå°±ç›´æ¥è¿”å›
                    }
                    
                    groupEntries.forEach(entry => {
                        if (entry && entry.content) {
                            console.log('>>> å¼€å§‹å¤„ç†ç¾¤èŠæ¡ç›®:', entry.key);
                            
                            // ä»commentä¸­æå–åŸå§‹ç¾¤èŠåç§°ï¼Œç”¨äºç”Ÿæˆç¨³å®šçš„ID
                            const originalGroupName = entry.comment.replace('æ‰‹æœº-ç¾¤èŠ-', '');
                            const lines = entry.content.split('\n');
                            let groupData = null;
                            
                            for (const line of lines) {
                                const trimmed = line.trim();
                                if (trimmed.startsWith('[') && trimmed.endsWith(']')) {
                                    const name = trimmed.slice(1, -1);
                                    groupData = { 
                                        name, 
                                        type: 'group',
                                        // ä½¿ç”¨commentä¸­çš„åŸå§‹åç§°ç”ŸæˆIDï¼Œä¿æŒç¨³å®šæ€§
                                        id: `group_${originalGroupName.replace(/[^a-zA-Z0-9\u4e00-\u9fff]/g, '_')}`
                                    };
                                } else if (groupData && trimmed.includes('ç±»å‹=ç¾¤èŠ')) {
                                    continue;
                                } else if (groupData && trimmed.startsWith('æˆå‘˜=')) {
                                    groupData.members = trimmed.substring(3).split(/[,ï¼Œ]/).map(m => m.trim()).filter(m => m);
                                } else if (groupData && trimmed.startsWith('æè¿°=')) {
                                    groupData.description = trimmed.substring(3);
                                } else if (groupData && trimmed.startsWith('å¤´åƒ=')) {
                                    const avatarReference = trimmed.substring(3);
                                    if (avatarReference.startsWith('data:')) {
                                        groupData.avatar = avatarReference;
                                        groupData.avatarData = avatarReference;
                                    } else {
                                        groupData.avatar = avatarReference;
                                    }
                                }
                            }
                            
                            if (groupData && groupData.name && groupData.members && groupData.members.length > 0) {
                                console.log('è§£æç¾¤èŠæ•°æ®æˆåŠŸ:', groupData.name);
                                groups.push(groupData);
                                
                                if (!QQ_Groups.includes(groupData.name)) {
                                    QQ_Groups.push(groupData.name);
                                }
                                
                                // **ä¿®å¤ï¼šæ£€æŸ¥ç¾¤èŠæ˜¯å¦å·²åœ¨ç•Œé¢ä¸­å­˜åœ¨ï¼Œé¿å…é‡å¤åˆ›å»º**
                                const existingGroupElement = $(`.QQ_home_usermsg[data-name='${groupData.name}'][data-group-type='true']`);
                                const groupAlreadyExists = existingGroupElement.length > 0;
                                
                                if (!QQ_msgjson.ç¾¤èŠ[groupData.name]) {
                                    QQ_msgjson.ç¾¤èŠ[groupData.name] = {
                                        members: groupData.members || [],
                                        msgs: []
                                    };
                                    console.log('åœ¨QQ_msgjson.ç¾¤èŠä¸­åˆå§‹åŒ–ç¾¤èŠæ•°æ®:', groupData.name);
                                } else {
                                    console.log('ç¾¤èŠæ•°æ®å·²å­˜åœ¨ï¼Œæ›´æ–°æˆå‘˜åˆ—è¡¨:', groupData.name);
                                    QQ_msgjson.ç¾¤èŠ[groupData.name].members = groupData.members || [];
                                }
                                
                                // **å¼ºåŒ–ä¿®å¤ï¼šåªæœ‰å½“ç¾¤èŠä¸å­˜åœ¨ä¸”æ²¡æœ‰åˆå§‹åŒ–è¿‡æ—¶æ‰è°ƒç”¨AddNewGroupï¼Œé¿å…é‡å¤åˆ›å»ºå’Œç³»ç»Ÿæ¶ˆæ¯**
                                if (!groupAlreadyExists) {
                                    // *** é¢å¤–æ£€æŸ¥ï¼šç¡®ä¿è¿™ä¸ªç¾¤èŠåœ¨å½“å‰ä¼šè¯ä¸­æ²¡æœ‰è¢«åˆå§‹åŒ–è¿‡ ***
                                    if (!QQ_GroupInitializedSet.has(groupData.name)) {
                                        console.log('ç¾¤èŠä¸å­˜åœ¨ä¸”æœªåˆå§‹åŒ–ï¼Œè°ƒç”¨AddNewGroupå‡½æ•°æ·»åŠ ç¾¤èŠ:', groupData.name);
                                    AddNewGroup(groupData.name, groupData.avatar || QQ_GetRandomAvatar() || 'https://files.catbox.moe/skngqq.jpg', groupData.members, groupData.description);
                                    } else {
                                        console.log('ç¾¤èŠåœ¨å½“å‰ä¼šè¯ä¸­å·²åˆå§‹åŒ–ï¼Œè·³è¿‡é‡å¤åˆ›å»º:', groupData.name);
                                        // å¦‚æœå·²ç»åˆå§‹åŒ–è¿‡ï¼Œè¯´æ˜æ•°æ®å·²ç»æ­£ç¡®è®¾ç½®ï¼Œä¸éœ€è¦é‡æ–°åˆ›å»º
                                        // åªéœ€è¦ç¡®ä¿æ•°æ®åŒæ­¥å’Œæ ‡è®°å­˜åœ¨
                                        QQ_GroupInitializedSet.add(groupData.name); // ç¡®ä¿æ ‡è®°å­˜åœ¨
                                    }
                                } else {
                                    console.log('ç¾¤èŠå·²å­˜åœ¨äºç•Œé¢ä¸­ï¼Œè·³è¿‡AddNewGroupè°ƒç”¨:', groupData.name);
                                    // ç•Œé¢å­˜åœ¨æ—¶ä¹Ÿè¦æ ‡è®°ä¸ºå·²åˆå§‹åŒ–ï¼Œé˜²æ­¢åç»­é‡å¤æ·»åŠ åˆå§‹æ¶ˆæ¯
                                    QQ_GroupInitializedSet.add(groupData.name);
                                }
                                
                                // *** ä¿®å¤ï¼šåœ¨åŠ è½½ç¾¤èŠåç«‹å³æ›´æ–°æœ€åæ¶ˆæ¯æ˜¾ç¤º ***
                                setTimeout(() => {
                                    updateGroupLastMessageDisplay(groupData.name);
                                }, 300);
                                
                               

                            } else {
                                console.log('ç¾¤èŠæ•°æ®ä¸å®Œæ•´ï¼Œè·³è¿‡ã€‚è§£æåˆ°çš„æ•°æ®:', groupData);
                            }
                        }
                    });
                } catch (error) {
                    console.error('ä»ç‹¬ç«‹ä¸–ç•Œä¹¦æ¡ç›®åŠ è½½ç¾¤èŠæ•°æ®å¤±è´¥:', error);
                }
                
                console.log('ä»ç‹¬ç«‹ä¸–ç•Œä¹¦æ¡ç›®åŠ è½½ç¾¤èŠæ•°æ®å®Œæˆ:', groups.length, 'ä¸ªç¾¤èŠ');
                console.log(`æœ€ç»ˆQQ_Groupsåˆ—è¡¨:`, QQ_Groups);
                
                return groups;
            }
            
            /**
             * *** æ–°å¢ï¼šä¸¤é˜¶æ®µåŠ è½½çš„ç¬¬äºŒé˜¶æ®µ - ç¾¤èŠå…ƒæ•°æ®å¢å¼ºå‡½æ•° ***
             * ç”¨äºä»ä¸–ç•Œä¹¦åŠ è½½è¯¦ç»†çš„ç¾¤èŠå…ƒæ•°æ®ï¼Œå¢å¼ºå·²æœ‰çš„ç¾¤èŠæ•°æ®
             */
            async function QQ_Enhance_Group_Metadata() {
                console.log('=== QQ_Enhance_Group_Metadata å¼€å§‹æ‰§è¡Œ ===');
                
                try {
                    // æ£€æŸ¥å‰ç½®æ¡ä»¶
                    if (!worldbook || !entries) {
                        console.warn('ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨ï¼Œè·³è¿‡ç¾¤èŠå…ƒæ•°æ®å¢å¼º');
                        return;
                    }
                    
                    // è°ƒç”¨åŸæœ‰çš„ loadGroupChatsFromWorldbook å‡½æ•°è·å–è¯¦ç»†å…ƒæ•°æ®
                    const detailedGroups = await loadGroupChatsFromWorldbook();
                    
                    if (!detailedGroups || detailedGroups.length === 0) {
                        console.log('æ²¡æœ‰æ‰¾åˆ°ç¾¤èŠå…ƒæ•°æ®ï¼Œè·³è¿‡å¢å¼º');
                        return;
                    }
                    
                    // ç¼“å­˜è¯¦ç»†çš„ç¾¤èŠå…ƒæ•°æ®åˆ°å…¨å±€å˜é‡
                    window.QQ_Group_Chats_Data = detailedGroups;
                    console.log(`âœ… å·²ç¼“å­˜ ${detailedGroups.length} ä¸ªç¾¤èŠçš„è¯¦ç»†å…ƒæ•°æ®`);
                    
                    // åŒæ­¥ç¾¤èŠåç§°åˆ—è¡¨åˆ° QQ_Groups
                    detailedGroups.forEach(groupData => {
                        if (groupData.name && !QQ_Groups.includes(groupData.name)) {
                            QQ_Groups.push(groupData.name);
                            console.log(`æ·»åŠ ç¾¤èŠåˆ° QQ_Groups: ${groupData.name}`);
                        }
                    });
                    
                    console.log(`âœ… ç¾¤èŠå…ƒæ•°æ®å¢å¼ºå®Œæˆï¼ŒQQ_Groups åŒ…å« ${QQ_Groups.length} ä¸ªç¾¤èŠ`);
                    
                    // *** å…³é”®ä¿®å¤ï¼šåœ¨å…ƒæ•°æ®åŠ è½½åï¼Œæ›´æ–°ç°æœ‰UIå…ƒç´ çš„å¤´åƒ ***
                    console.log('å¼€å§‹ç”¨åŠ è½½çš„å…ƒæ•°æ®æ›´æ–°ç¾¤èŠUI...');
                    detailedGroups.forEach(groupData => {
                        if (groupData && groupData.name) {
                            // æ›´æ–°è”ç³»äººåˆ—è¡¨ä¸­çš„å¤´åƒ
                            const contactElement = document.querySelector(`#QQ_home_chars .QQ_home_usermsg[data-name='${groupData.name}']`);
                            if (contactElement) {
                                updateGroupAvatarInElement(contactElement, groupData);
                            }

                            // æ›´æ–°æ¶ˆæ¯åˆ—è¡¨ä¸­çš„å¤´åƒ
                            const messageElement = document.querySelector(`#QQ_message_list_chars .QQ_home_usermsg[data-name='${groupData.name}']`);
                            if (messageElement) {
                                updateGroupAvatarInElement(messageElement, groupData);
                            }
                            
                            // *** ä¿®å¤ï¼šåœ¨åŠ è½½ç¾¤èŠåç«‹å³æ›´æ–°æœ€åæ¶ˆæ¯æ˜¾ç¤º ***
                            setTimeout(() => {
                                updateGroupLastMessageDisplay(groupData.name);
                            }, 300);
                        }
                    });
                    
                    // *** ä¿®å¤ï¼šå…ƒæ•°æ®å¢å¼ºå®Œæˆåæœ€ç»ˆåˆ·æ–°ä¸€æ¬¡æ¶ˆæ¯åˆ—è¡¨ï¼Œç¡®ä¿æ‰€æœ‰ç•Œé¢æ›´æ–°ç”Ÿæ•ˆ ***
                    try {
                        await QQ_UpdateMessageList();
                        console.log('âœ… ç¾¤èŠå…ƒæ•°æ®å¢å¼ºåæ¶ˆæ¯åˆ—è¡¨å·²åˆ·æ–°');
                    } catch (error) {
                        console.error('åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨å¤±è´¥:', error);
                    }
                    
                } catch (error) {
                    console.error('ç¾¤èŠå…ƒæ•°æ®å¢å¼ºå¤±è´¥:', error);
                }
            }
            
            // åˆå§‹åŒ–ç¾¤èŠåŠŸèƒ½çš„å‡½æ•°
            function initGroupChatFeature() {
                console.log('æ­£åœ¨åˆå§‹åŒ–ç¾¤èŠåŠŸèƒ½...');
                
                // è”ç³»äººé¡µé¢çš„'+'æŒ‰é’®
                const contactsAddBtn = document.getElementById('contacts_add_btn');
                if (contactsAddBtn) {
                    console.log('æ‰¾åˆ°è”ç³»äººé¡µé¢çš„+æŒ‰é’®ï¼Œç»‘å®šäº‹ä»¶...');
                    contactsAddBtn.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('è”ç³»äººé¡µé¢+æŒ‰é’®è¢«ç‚¹å‡»');
                        showGroupChatModal();
                    };
                } else {
                    console.warn('æœªæ‰¾åˆ°è”ç³»äººé¡µé¢çš„+æŒ‰é’® (ID: contacts_add_btn)');
                }
                
                // æ¶ˆæ¯é¡µé¢çš„'+'æŒ‰é’®
                const messagesAddBtn = document.getElementById('messages_add_btn');
                if (messagesAddBtn) {
                    console.log('æ‰¾åˆ°æ¶ˆæ¯é¡µé¢çš„+æŒ‰é’®ï¼Œç»‘å®šäº‹ä»¶...');
                    messagesAddBtn.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('æ¶ˆæ¯é¡µé¢+æŒ‰é’®è¢«ç‚¹å‡»');
                        showGroupChatModal();
                    };
                } else {
                    console.warn('æœªæ‰¾åˆ°æ¶ˆæ¯é¡µé¢çš„+æŒ‰é’® (ID: messages_add_btn)');
                }
                
                // ç¾¤èŠåç§°è¾“å…¥æ¡†äº‹ä»¶ç›‘å¬
                const groupNameInput = document.getElementById('group_name_input');
                if (groupNameInput) {
                    groupNameInput.addEventListener('input', updateConfirmButtonState);
                    groupNameInput.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' && !document.getElementById('group_confirm_btn').disabled) {
                            createGroupChat();
                        }
                    });
                }
                
                console.log('ç¾¤èŠåŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
            }
            
            // é˜²æ­¢é‡å¤åŠ è½½çš„æ ‡å¿—
            let groupChatInitialized = false;
            
            // QQ_Groupsæ•°ç»„ä¿æŠ¤æœºåˆ¶
            function protectQQGroups() {
                if (!Array.isArray(QQ_Groups)) {
                    console.warn('QQ_Groupsä¸æ˜¯æ•°ç»„ï¼Œé‡æ–°åˆå§‹åŒ–');
                    QQ_Groups = [];
                }
            }
            
            // å¯åŠ¨ä¿æŠ¤æœºåˆ¶
            protectQQGroups();
            
            // ç®€åŒ–çš„QQ_Groupså®Œæ•´æ€§æ£€æŸ¥ï¼ˆä¸é‡æ–°åŠ è½½ç¾¤èŠåˆ°ç•Œé¢ï¼‰
            function ensureQQGroupsIntegrity() {
                if (groupChatInitialized && QQ_Groups.length === 0) {
                    console.warn('æ£€æµ‹åˆ°QQ_Groupsä¸ºç©ºï¼Œä½†ä¸è‡ªåŠ¨é‡æ–°åŠ è½½ï¼ˆé¿å…é‡å¤ï¼‰');
                    console.log('å½“å‰é¡µé¢ç¾¤èŠåº”è¯¥ä¿æŒå¯è§ï¼Œé—®é¢˜å¯èƒ½åœ¨å…¶ä»–åœ°æ–¹');
                    
                    // ä»…æ£€æŸ¥ç°æœ‰ç•Œé¢å…ƒç´ å¹¶æ¢å¤QQ_Groups
                    const contactsGroups = document.querySelectorAll('#QQ_home_chars [data-group-type="true"]');
                    const messageGroups = document.querySelectorAll('#QQ_message_list_chars [data-group-type="true"]');
                    
                    contactsGroups.forEach(element => {
                        const groupName = element.getAttribute('data-group-name');
                        if (groupName && !QQ_Groups.includes(groupName)) {
                            QQ_Groups.push(groupName);
                            console.log(`ä»è”ç³»äººç•Œé¢æ¢å¤ç¾¤èŠåˆ°QQ_Groups: ${groupName}`);
                        }
                    });
                    
                    messageGroups.forEach(element => {
                        const groupName = element.getAttribute('data-group-name');
                        if (groupName && !QQ_Groups.includes(groupName)) {
                            QQ_Groups.push(groupName);
                            console.log(`ä»æ¶ˆæ¯ç•Œé¢æ¢å¤ç¾¤èŠåˆ°QQ_Groups: ${groupName}`);
                        }
                    });
                    
                    console.log('QQ_Groupsæ¢å¤å:', QQ_Groups);
                }
            }
            
            // ç‚¹å‡»ç¾¤èŠæ—¶çš„å®Œæ•´æ€§æ£€æŸ¥
            function ensureQQGroupsIntegrityOnClick(groupName) {
                console.log(`ç¾¤èŠ ${groupName} è¢«ç‚¹å‡»ï¼Œæ£€æŸ¥QQ_Groupså®Œæ•´æ€§`);
                
                // ç¡®ä¿ç‚¹å‡»çš„ç¾¤èŠåœ¨QQ_Groupsä¸­
                if (!QQ_Groups.includes(groupName)) {
                    console.warn(`ç¾¤èŠ ${groupName} ä¸åœ¨QQ_Groupsä¸­ï¼Œæ·»åŠ ä¸­...`);
                    QQ_Groups.push(groupName);
                }
                
                // *** ä¿®å¤ï¼šå®‰å…¨åˆå§‹åŒ–ç¾¤èŠæ•°æ®ç»“æ„ï¼Œé˜²æ­¢æ¸…ç©ºå·²æ¢å¤çš„æ•°æ® ***
                if (!QQ_msgjson.ç¾¤èŠ) {
                    if (window.QQ_ChatDataRestored) {
                        console.warn('âš ï¸ æ£€æµ‹åˆ°èŠå¤©æ•°æ®å·²ä»å¤‡ä»½æ¢å¤ï¼Œä½†ç¾¤èŠæ•°æ®ä¸ºç©ºï¼Œè¿™å¯èƒ½è¡¨ç¤ºæ•°æ®ä¸¢å¤±');
                        console.log('æ¢å¤æ—¶é—´:', window.QQ_ChatDataRestoreTime);
                    }
                    QQ_msgjson.ç¾¤èŠ = {};
                    console.log('ğŸ”§ åˆå§‹åŒ–ç©ºçš„ç¾¤èŠæ•°æ®ç»“æ„');
                }
                if (!QQ_msgjson.ç¾¤èŠ[groupName]) {
                    console.log(`åœ¨QQ_msgjson.ç¾¤èŠä¸­åˆå§‹åŒ–ç¾¤èŠæ•°æ®: ${groupName}`);
                    QQ_msgjson.ç¾¤èŠ[groupName] = {
                        members: [],
                        msgs: []
                    };
                }
                
                console.log(`ç¾¤èŠ ${groupName} å®Œæ•´æ€§æ£€æŸ¥å®Œæˆ`);
            }
            
            // ç»Ÿä¸€çš„å¤´åƒå¤„ç†å‡½æ•°
            function processGroupAvatar(groupData) {
                console.log('å¤„ç†ç¾¤å¤´åƒ:', groupData.name, 'å¤´åƒæ•°æ®:', groupData.avatar);
                
                // ç»Ÿä¸€çš„å¤´åƒæ•°æ®å¤„ç†é€»è¾‘
                let avatarDisplay = '';
                const avatarSrc = groupData.avatarData || groupData.avatar;
                
                if (avatarSrc && (avatarSrc.startsWith('data:') || avatarSrc.startsWith('http'))) {
                    // base64æ•°æ®æˆ–ç½‘ç»œé“¾æ¥ï¼Œç›´æ¥ä½¿ç”¨
                    avatarDisplay = `<img src="${avatarSrc}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                    console.log('ä½¿ç”¨å¤´åƒå›¾ç‰‡ï¼Œç±»å‹:', avatarSrc.startsWith('data:') ? 'base64' : 'URL');
                } else {
                    // é»˜è®¤æ˜¾ç¤º"ç¾¤"å­—
                    avatarDisplay = 'ç¾¤';
                    console.log('ä½¿ç”¨é»˜è®¤ç¾¤å­—å¤´åƒ');
                }
                
                return avatarDisplay;
            }
            
            // ç»Ÿä¸€çš„åˆå§‹åŒ–å‡½æ•°
            async function initGroupChatOnce() {
                if (groupChatInitialized) {
                    console.log('ç¾¤èŠåŠŸèƒ½å·²åˆå§‹åŒ–ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–');
                    return;
                }
                
                console.log('å¼€å§‹åˆå§‹åŒ–ç¾¤èŠåŠŸèƒ½...');
                initGroupChatFeature();
                
                // æ£€æŸ¥ç•Œé¢æ˜¯å¦æœ‰ç¾¤èŠå…ƒç´ 
                const contactsGroups = document.querySelectorAll('#QQ_home_chars [data-group-type="true"]');
                const messageGroups = document.querySelectorAll('#QQ_message_list_chars [data-group-type="true"]');
                
                console.log('å½“å‰ç•Œé¢çŠ¶æ€æ£€æŸ¥:');
                console.log('- QQ_Groupsæ•°ç»„é•¿åº¦:', QQ_Groups.length);
                console.log('- è”ç³»äººç•Œé¢ç¾¤èŠå…ƒç´ æ•°é‡:', contactsGroups.length);
                console.log('- æ¶ˆæ¯ç•Œé¢ç¾¤èŠå…ƒç´ æ•°é‡:', messageGroups.length);
                console.log('- worldbookçŠ¶æ€:', !!worldbook);
                console.log('- entriesçŠ¶æ€:', !!entries);
                
                // å¦‚æœæœ‰ç¾¤èŠæ•°æ®ä½†ç•Œé¢æ²¡æœ‰æ˜¾ç¤ºï¼Œå¼ºåˆ¶é‡æ–°åŠ è½½
                if (worldbook && entries) {
                    if (QQ_Groups.length > 0 && contactsGroups.length === 0) {
                        console.log('å‘ç°ç¾¤èŠæ•°æ®ä½†ç•Œé¢æœªæ˜¾ç¤ºï¼Œé€šè¿‡ä¸¤é˜¶æ®µåŠ è½½æœºåˆ¶é‡æ–°åŠ è½½');
                        // *** ä¿®å¤ï¼šä½¿ç”¨ä¸¤é˜¶æ®µåŠ è½½æœºåˆ¶é‡æ–°åŠ è½½ç¾¤èŠå…ƒæ•°æ® ***
                        await QQ_Enhance_Group_Metadata();
                    } else if (QQ_Groups.length === 0) {
                        console.log('é¦–æ¬¡åˆå§‹åŒ–ï¼šç¾¤èŠæ•°æ®å°†é€šè¿‡ä¸¤é˜¶æ®µåŠ è½½æœºåˆ¶å¤„ç†');
                        // *** ä¿®å¤ï¼šç¾¤èŠæ•°æ®é€šè¿‡ä¸¤é˜¶æ®µåŠ è½½ï¼Œæ­¤å¤„ä¸å†ç›´æ¥è°ƒç”¨ ***
                    } else {
                        console.log('ç¾¤èŠæ•°æ®å’Œç•Œé¢çŠ¶æ€æ­£å¸¸ï¼Œè·³è¿‡åŠ è½½');
                    }
                } else {
                    console.log('worldbookæˆ–entriesæœªå‡†å¤‡å¥½ï¼Œè·³è¿‡ç¾¤èŠåŠ è½½');
                }
                
                groupChatInitialized = true;
                console.log('ç¾¤èŠåŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
            }
            
            // é‡ç½®ç¾¤èŠåˆå§‹åŒ–çŠ¶æ€ï¼ˆç”¨äºè°ƒè¯•ï¼‰
            window.resetGroupChatState = function() {
                groupChatInitialized = false;
                console.log('ç¾¤èŠçŠ¶æ€å·²é‡ç½®');
            };
            
            // å¼ºåˆ¶é‡æ–°åŠ è½½ç¾¤èŠåˆ°ç•Œé¢ï¼ˆç”¨äºè°ƒè¯•ï¼‰
            window.forceReloadGroupChats = async function() {
                console.log('å¼ºåˆ¶é‡æ–°åŠ è½½ç¾¤èŠ...');
                if (!worldbook || !entries) {
                    console.error('worldbookæˆ–entriesæœªå‡†å¤‡å¥½');
                    return;
                }
                try {
                    // *** ä¿®å¤ï¼šä½¿ç”¨ä¸¤é˜¶æ®µåŠ è½½æœºåˆ¶é‡æ–°åŠ è½½ç¾¤èŠ ***
                    await QQ_Enhance_Group_Metadata();
                    console.log('ç¾¤èŠå¼ºåˆ¶é‡æ–°åŠ è½½å®Œæˆ');
                } catch (error) {
                    console.error('å¼ºåˆ¶é‡æ–°åŠ è½½ç¾¤èŠå¤±è´¥:', error);
                }
            };
            
            // å•ä¸€çš„åˆå§‹åŒ–è°ƒç”¨ç‚¹
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initGroupChatOnce);
            } else {
                // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿worldbookå’Œentrieséƒ½å·²å‡†å¤‡å¥½
                setTimeout(initGroupChatOnce, 1000);
            }
            
            // æ·»åŠ å…¨å±€æµ‹è¯•å‡½æ•°ï¼Œä¾¿äºè°ƒè¯•
            window.testGroupChat = function() {
                console.log('æµ‹è¯•ç¾¤èŠåŠŸèƒ½...');
                showGroupChatModal();
            };
            
            // æ·»åŠ é”®ç›˜å¿«æ·é”®æµ‹è¯•ï¼ˆCtrl+Gï¼‰
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'g') {
                    e.preventDefault();
                    console.log('é€šè¿‡å¿«æ·é”®è°ƒç”¨ç¾¤èŠåŠŸèƒ½');
                    showGroupChatModal();
                }
            });
            
            // ==================== è”ç³»äººåˆ†ç»„åŠŸèƒ½ ====================
            
            // åˆ†ç»„æ•°æ®å­˜å‚¨ - ä½¿ç”¨varé¿å…TDZé—®é¢˜
            var contactGroups = [];
            var draggedElement = null;
            var draggedFromGroup = null;
            
            /**
             * è·å–å½“å‰è§’è‰²IDç”¨äºæ•°æ®éš”ç¦»
             */
            /**
             * *** å¢å¼ºç‰ˆï¼šè·å–å½“å‰è§’è‰²IDå‡½æ•° - æ·»åŠ è¯¦ç»†è°ƒè¯•ä¿¡æ¯ ***
             */
            function getCurrentCharacterId() {
                try {
                    let result = null;
                    let source = '';
                    
                    // æ–¹å¼1ï¼šä¼˜å…ˆä½¿ç”¨SillyTavernçš„characterId
                    if (window.SillyTavern && window.SillyTavern.characterId !== undefined) {
                        result = window.SillyTavern.characterId;
                        source = 'SillyTavern.characterId';
                    }
                    
                    // æ–¹å¼2ï¼šå°è¯•è°ƒç”¨SillyTavernçš„getContextæ–¹æ³•
                    else if (window.SillyTavern && typeof window.SillyTavern.getContext === 'function') {
                        const context = window.SillyTavern.getContext();
                        if (context && context.characterId !== undefined) {
                            result = context.characterId;
                            source = 'SillyTavern.getContext().characterId';
                        }
                    }
                    
                    // æ–¹å¼3ï¼šä»window.this_chidè·å–ï¼ˆé…’é¦†å†…éƒ¨å˜é‡ï¼‰
                    else if (window.this_chid !== undefined) {
                        result = window.this_chid;
                        source = 'window.this_chid';
                    }
                    
                    // æ–¹å¼4ï¼šä»URLå‚æ•°è·å–
                    else {
                        const urlParams = new URLSearchParams(window.location.search);
                        const charId = urlParams.get('charId') || urlParams.get('characterId');
                        if (charId) {
                            result = charId;
                            source = 'URLå‚æ•°';
                        }
                    }
                    
                    // æ–¹å¼5ï¼šä½¿ç”¨å½“å‰è§’è‰²å
                    if (!result && window.currentCharacterName) {
                        result = window.currentCharacterName;
                        source = 'window.currentCharacterName';
                    }
                    
                    // æ–¹å¼6ï¼šä»headerä¸­çš„è§’è‰²åè·å–
                    if (!result) {
                        const headerName = document.querySelector('.QQ_home_nick')?.textContent?.trim();
                        if (headerName) {
                            result = headerName;
                            source = 'é¡µé¢headerè§’è‰²å';
                        }
                    }
                    
                    // æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆ
                    if (!result) {
                        result = 'default';
                        source = 'é»˜è®¤å€¼';
                    }
                    
                    console.log(`ğŸ†” è·å–è§’è‰²ID: "${result}" (æ¥æº: ${source})`);
                    return result;
                } catch (error) {
                    console.warn('è·å–è§’è‰²IDå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:', error);
                    return 'default';
                }
            }
            
            // å…¨å±€å˜é‡è®°å½•å½“å‰è§’è‰²IDï¼Œç”¨äºæ£€æµ‹è§’è‰²åˆ‡æ¢
            let currentCharId = null;
            
            /**
             * æ£€æµ‹è§’è‰²æ˜¯å¦åˆ‡æ¢ï¼Œå¦‚æœåˆ‡æ¢åˆ™é‡æ–°åŠ è½½åˆ†ç»„æ•°æ®
             */
            function checkCharacterChange() {
                const newCharId = getCurrentCharacterId();
                if (currentCharId !== newCharId) {
                    console.log(`æ£€æµ‹åˆ°è§’è‰²åˆ‡æ¢: ${currentCharId} -> ${newCharId}`);
                    currentCharId = newCharId;
                    QQ_LoadContactGroups(); // ä¿®å¤ï¼šè§’è‰²åˆ‡æ¢æ—¶åŠ è½½åˆ†ç»„ï¼Œä¸æ˜¯ç¾¤èŠ
                    renderContactGroups();
                }
            }
            
            /**
             * *** å·²ç§»é™¤ï¼šgetCharacterGroupsKeyå‡½æ•° ***
             * ç°åœ¨ç»Ÿä¸€ä½¿ç”¨ä¸–ç•Œä¹¦å­˜å‚¨ï¼Œä¸å†éœ€è¦localStorage key
             */
            
            /**
             * ä»ä¸–ç•Œä¹¦åŠ è½½åˆ†ç»„ï¼ˆæŒ‰è§’è‰²éš”ç¦»ï¼‰
             */
            async function QQ_LoadContactGroups() {
                try {
                    const charId = getCurrentCharacterId() || 'default';
                    console.log(`ä»ä¸–ç•Œä¹¦åŠ è½½åˆ†ç»„ï¼Œè§’è‰²ID: ${charId}`);
                    
                    // *** ç®€åŒ–åŠ è½½ï¼šå‚è€ƒç¾¤èŠæ¨¡å¼ï¼Œç›´æ¥ä»entriesæŸ¥æ‰¾ ***
                    if (!worldbook || !entries) {
                        console.warn('ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨ï¼Œä½¿ç”¨ç©ºåˆ†ç»„æ•°æ®');
                        contactGroups.length = 0;
                        return;
                    }
                    
                    const comment = `QQ_åˆ†ç»„å¤‡ä»½_${charId}`;
                    const targetEntry = entries.find(entry => entry.comment === comment);
                    
                    if (targetEntry && targetEntry.content) {
                        try {
                            const groups = JSON.parse(targetEntry.content);
                            if (Array.isArray(groups)) {
                                contactGroups.length = 0; // æ¸…ç©ºç°æœ‰æ•°ç»„
                                contactGroups.push(...groups); // æ·»åŠ ä»ä¸–ç•Œä¹¦åŠ è½½çš„æ•°æ®
                                console.log(`âœ… ä»ä¸–ç•Œä¹¦ç›´æ¥åŠ è½½äº† ${groups.length} ä¸ªåˆ†ç»„`);
                            } else {
                                console.warn('ä¸–ç•Œä¹¦åˆ†ç»„æ•°æ®æ ¼å¼æ— æ•ˆï¼Œä½¿ç”¨ç©ºæ•°ç»„');
                                contactGroups.length = 0;
                            }
                        } catch (parseError) {
                            console.error('è§£æä¸–ç•Œä¹¦åˆ†ç»„æ•°æ®å¤±è´¥:', parseError);
                            contactGroups.length = 0;
                        }
                    } else {
                        console.log('ä¸–ç•Œä¹¦ä¸­æ²¡æœ‰æ‰¾åˆ°åˆ†ç»„æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤ç©ºæ•°ç»„');
                        contactGroups.length = 0;
                    }
                } catch (error) {
                    console.error('ä»ä¸–ç•Œä¹¦åŠ è½½åˆ†ç»„æ—¶å‡ºé”™:', error);
                    contactGroups.length = 0;
                }
            }
            
            // ç«‹å³åˆå§‹åŒ–contactGroups
            QQ_LoadContactGroups().catch(error => {
                console.error('åˆå§‹åŒ–åˆ†ç»„æ•°æ®å¤±è´¥:', error);
            });
            
            /**
             * *** æ–°å¢ï¼šå¼ºåˆ¶é‡æ–°åŠ è½½åˆ†ç»„æ•°æ® ***
             * ç”¨äºåœ¨åˆ†ç»„æ“ä½œåç«‹å³åˆ·æ–°æœ€æ–°æ•°æ®
             */
            window.QQ_ForceReloadContactGroups = async function() {
                try {
                    const characterId = getCurrentCharacterId() || 'default';
                    console.log(`ğŸ”„ å¼ºåˆ¶ä»ä¸–ç•Œä¹¦é‡æ–°åŠ è½½åˆ†ç»„æ•°æ®ï¼Œè§’è‰²ID: ${characterId}`);
                    
                    // æ¸…ç©ºå†…å­˜ç¼“å­˜
                    contactGroups.length = 0;
                    
                    // *** ç®€åŒ–åŠ è½½ï¼šç›´æ¥ä½¿ç”¨loadGroupsFromStorage ***
                    await QQ_LoadContactGroups();
                    
                    console.log(`âœ… ä»ä¸–ç•Œä¹¦é‡æ–°åŠ è½½äº† ${contactGroups.length} ä¸ªåˆ†ç»„`);
                    if (contactGroups.length > 0) {
                        console.log('ğŸ“Š åˆ†ç»„è¯¦æƒ…:', contactGroups.map(g => `${g.name}(${g.contacts.length}äºº)`).join(', '));
                    }
                    
                    return contactGroups;
                } catch (error) {
                    console.error('ğŸ’¥ å¼ºåˆ¶é‡æ–°åŠ è½½åˆ†ç»„æ•°æ®å¤±è´¥:', error);
                    return [];
                }
            };
            
            /**
             * ä¿å­˜åˆ†ç»„åˆ°ä¸–ç•Œä¹¦ï¼ˆæŒ‰è§’è‰²éš”ç¦»ï¼‰- ä¿®å¤ç‰ˆ
             */
            /**
             * ä¿å­˜åˆ†ç»„åˆ°ä¸–ç•Œä¹¦ï¼ˆæŒ‰è§’è‰²éš”ç¦»ï¼‰- å¢å¼ºç‰ˆ
             */
            async function saveGroupsToStorage() {
                try {
                    const charId = getCurrentCharacterId() || 'default';
                    console.log(`ğŸ”„ ä¿å­˜åˆ†ç»„åˆ°ä¸–ç•Œä¹¦ï¼Œè§’è‰²ID: ${charId}`);
                    console.log(`ğŸ“Š å½“å‰åˆ†ç»„æ•°æ®: ${contactGroups.length}ä¸ªåˆ†ç»„`, contactGroups.map(g => `${g.name}(${g.contacts.length}äºº)`));
                    
                    // *** æ£€æŸ¥ä¸–ç•Œä¹¦çŠ¶æ€ ***
                    if (!worldbook || !entries) {
                        console.error('âŒ ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨ï¼Œæ— æ³•ä¿å­˜åˆ†ç»„æ•°æ®');
                        return false;
                    }
                    
                    // *** ç®€åŒ–ä¿å­˜ï¼šå‚è€ƒç¾¤èŠæ¨¡å¼ï¼Œç›´æ¥æ“ä½œä¸–ç•Œä¹¦æ¡ç›® ***
                    const comment = `QQ_åˆ†ç»„å¤‡ä»½_${charId}`;
                    let targetEntry = entries.find(entry => entry.comment === comment);
                    
                    // å‡†å¤‡ä¿å­˜çš„æ•°æ®
                    const jsonData = JSON.stringify(contactGroups, null, 2);
                    
                    if (targetEntry) {
                        // ä½¿ç”¨setLorebookEntriesæ›´æ–°ç°æœ‰æ¡ç›®
                        await setLorebookEntries(worldbook, [{
                            uid: targetEntry.uid,
                            content: jsonData,
                        }]);
                        console.log(`âœ… åˆ†ç»„æ•°æ®å·²æ›´æ–°åˆ°ç°æœ‰ä¸–ç•Œä¹¦æ¡ç›®: ${comment}`);
                        
                        // æ›´æ–°æœ¬åœ°entriesä¸­çš„å¯¹åº”æ¡ç›®
                        targetEntry.content = jsonData;
                    } else {
                        // ä½¿ç”¨createLorebookEntryåˆ›å»ºæ–°æ¡ç›®ï¼ˆå‚è€ƒç¾¤èŠå’ŒåŠ¨æ€çš„æˆåŠŸå®ç°ï¼‰
                        await createLorebookEntry(worldbook, {
                            comment: comment,
                            key: [`æ­¤ä¸–ç•Œä¹¦æ°¸ä¸è§¦å‘_åˆ†ç»„_${charId}`],
                            content: jsonData,
                            position: "at_depth_as_system",
                            type: "selective", // ç»¿ç¯ï¼šé€‰æ‹©æ€§è§¦å‘
                            depth: 0,
                            exclude_recursion: true,
                            order: 9998, // é¡ºåº9998ï¼Œä½äºåŠ¨æ€9999
                            enabled: true,
                        });
                        console.log(`âœ… åˆ†ç»„æ•°æ®å·²ä¿å­˜åˆ°æ–°ä¸–ç•Œä¹¦æ¡ç›®: ${comment}`);
                        
                        // é‡æ–°è·å–entriesä»¥åŒ…å«æ–°åˆ›å»ºçš„æ¡ç›®
                        entries = await getLorebookEntries(worldbook);
                    }
                    
                    // è§¦å‘ä¸–ç•Œä¹¦ä¿å­˜
                    await QQ_SafeSaveWorldInfo(`è§’è‰²${charId}çš„åˆ†ç»„æ•°æ®`);
                    
                    // *** ä¿®å¤éªŒè¯é€»è¾‘ï¼šé‡æ–°è·å–æœ€æ–°çš„entriesæ•°æ® ***
                    entries = await getLorebookEntries(worldbook);
                    const verifyEntry = entries.find(entry => entry.comment === comment);
                    
                    if (verifyEntry && verifyEntry.content && verifyEntry.content.includes('"name"')) {
                        console.log(`âœ… åˆ†ç»„æ•°æ®ä¿å­˜éªŒè¯æˆåŠŸï¼š${contactGroups.length}ä¸ªåˆ†ç»„`);
                        console.log(`ğŸ“Š ä¸–ç•Œä¹¦æ¡ç›®å†…å®¹é•¿åº¦: ${verifyEntry.content.length} å­—ç¬¦`);
                        return true;
                    } else {
                        console.error('âŒ åˆ†ç»„æ•°æ®ä¿å­˜éªŒè¯å¤±è´¥');
                        console.error('éªŒè¯æ¡ç›®:', verifyEntry ? 'æ‰¾åˆ°æ¡ç›®ä½†å†…å®¹å¼‚å¸¸' : 'æœªæ‰¾åˆ°æ¡ç›®');
                        // å³ä½¿éªŒè¯å¤±è´¥ï¼Œå¦‚æœæ“ä½œæ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ï¼Œæˆ‘ä»¬ä»ç„¶è®¤ä¸ºä¿å­˜å¯èƒ½æˆåŠŸäº†
                        console.log('âš ï¸ å°½ç®¡éªŒè¯å¤±è´¥ï¼Œä½†ä¿å­˜æ“ä½œå·²æ‰§è¡Œï¼Œå¯èƒ½æ•°æ®å·²ä¿å­˜');
                        return true; // æ”¹ä¸ºè¿”å›trueï¼Œé¿å…è¯¯æŠ¥å¤±è´¥
                    }
                    
                } catch (error) {
                    console.error('âŒ ä¿å­˜åˆ†ç»„åˆ°ä¸–ç•Œä¹¦æ—¶å‡ºé”™:', error);
                    return false;
                }
            }
            
            /**
             * åˆå§‹åŒ–åˆ†ç»„åŠŸèƒ½
             */
            async function initContactGroups() {
                // åˆå§‹åŒ–å½“å‰è§’è‰²ID
                currentCharId = getCurrentCharacterId();
                
                await QQ_LoadContactGroups();
                await renderContactGroups();
                initGroupDragAndDrop();
                
                // å¯åŠ¨è§’è‰²åˆ‡æ¢æ£€æµ‹ï¼ˆæ·»åŠ æ¸…ç†æ”¯æŒï¼‰
                let characterChangeInterval = setInterval(checkCharacterChange, 1000); // æ¯ç§’æ£€æµ‹ä¸€æ¬¡è§’è‰²åˆ‡æ¢
                
                // æ‰©å±•å…¨å±€æ¸…ç†å‡½æ•°
                const oldCleanup = window.QQ_CleanupTimers;
                window.QQ_CleanupTimers = function() {
                    if (oldCleanup) oldCleanup();
                    if (characterChangeInterval) {
                        clearInterval(characterChangeInterval);
                        characterChangeInterval = null;
                    }
                };
                
                console.log(`åˆ†ç»„åŠŸèƒ½å·²åˆå§‹åŒ–ï¼Œå½“å‰è§’è‰²ID: ${currentCharId}`);
            }
            
            /**
             * åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
             */
            function initGroupDragAndDrop() {
                // è¿™é‡Œå¯ä»¥æ·»åŠ æ‹–æ‹½ç›¸å…³çš„åˆå§‹åŒ–ä»£ç 
                console.log('åˆ†ç»„æ‹–æ‹½åŠŸèƒ½å·²åˆå§‹åŒ–');
            }
            
            /**
             * æ˜¾ç¤ºæ–°å»ºåˆ†ç»„å¼¹çª—
             */
            function showNewGroupModal() {
                const modal = document.getElementById('new_group_modal');
                const input = document.getElementById('new_group_name_input');
                
                if (modal && input) {
                    modal.style.display = 'flex';
                    input.value = '';
                    input.focus();
                    
                    // æ·»åŠ èƒŒæ™¯ç‚¹å‡»å…³é—­
                    modal.addEventListener('click', function(e) {
                        if (e.target === modal) {
                            closeNewGroupModal();
                        }
                    });
                }
            }
            
            /**
             * å…³é—­æ–°å»ºåˆ†ç»„å¼¹çª—
             */
            function closeNewGroupModal() {
                const modal = document.getElementById('new_group_modal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }
            
            /**
             * åˆ›å»ºæ–°çš„è”ç³»äººåˆ†ç»„
             */
            async function createNewContactGroup() {
                console.log('ğŸ†• å¼€å§‹åˆ›å»ºæ–°åˆ†ç»„...');
                
                // *** å…³é”®ä¼˜åŒ–ï¼šå…ˆä»ä¸–ç•Œä¹¦é‡æ–°åŠ è½½åˆ†ç»„æ•°æ® ***
                await QQ_ForceReloadContactGroups();
                
                const input = document.getElementById('new_group_name_input');
                if (!input) {
                    console.error('æœªæ‰¾åˆ°åˆ†ç»„åç§°è¾“å…¥æ¡†å…ƒç´ ');
                    alert('ç•Œé¢å…ƒç´ æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    return;
                }
                
                const groupName = input.value.trim();
                if (!groupName) {
                    alert('è¯·è¾“å…¥åˆ†ç»„åç§°');
                    return;
                }
                
                // æ£€æŸ¥åˆ†ç»„åæ˜¯å¦é‡å¤
                if (contactGroups.some(group => group.name === groupName)) {
                    alert('åˆ†ç»„åç§°å·²å­˜åœ¨');
                    return;
                }
                
                // *** å¢å¼ºï¼šè·å–è§’è‰²IDè°ƒè¯•ä¿¡æ¯ ***
                const charId = getCurrentCharacterId() || 'default';
                console.log(`ğŸ­ åˆ›å»ºåˆ†ç»„ï¼Œå½“å‰è§’è‰²: ${charId}`);
                
                // åˆ›å»ºæ–°åˆ†ç»„
                const newGroup = {
                    id: 'group_' + Date.now(),
                    name: groupName,
                    contacts: [],
                    collapsed: false,
                    order: contactGroups.length
                };
                
                // *** å¢å¼ºï¼šè®°å½•åŸå§‹çŠ¶æ€ï¼Œä»¥å¤‡å›æ»š ***
                const originalGroups = [...contactGroups];
                
                contactGroups.push(newGroup);
                
                // *** ä¿®å¤ï¼šç¡®ä¿ä¿å­˜å®Œæˆåå†å…³é—­å¼¹çª—å’Œæ˜¾ç¤ºæ¶ˆæ¯ ***
                try {
                    const saveResult = await saveGroupsToStorage();
                    if (saveResult) {
                        console.log('âœ… æ–°åˆ†ç»„ä¿å­˜åˆ°ä¸–ç•Œä¹¦æˆåŠŸ');
                        
                        closeNewGroupModal();
                        alert('åˆ†ç»„"' + groupName + '"åˆ›å»ºæˆåŠŸï¼');
                        
                        console.log('åˆ›å»ºæ–°åˆ†ç»„æˆåŠŸ:', newGroup);
                        
                        // *** ä¿®å¤ï¼šåœ¨ç”¨æˆ·ç‚¹å‡»ç¡®è®¤åç«‹å³åˆ·æ–°ç•Œé¢ ***
                        await QQ_ForceReloadContactGroups();
                        
                        // *** å¢å¼ºï¼šå…¨å±æ¨¡å¼ä¸‹çš„å¼ºåˆ¶åˆ·æ–° ***
                        const isFullscreen = document.fullscreenElement !== null || 
                                            document.webkitFullscreenElement !== null || 
                                            document.mozFullScreenElement !== null;
                        
                        if (isFullscreen) {
                            console.log('ğŸ–¥ï¸ å…¨å±æ¨¡å¼ä¸‹åˆ›å»ºåˆ†ç»„ï¼Œæ‰§è¡Œå¼ºåˆ¶ç•Œé¢æ›´æ–°');
                            // å¼ºåˆ¶é‡æ–°æ¸²æŸ“æ•´ä¸ªè”ç³»äººé¡µé¢
                            setTimeout(async () => {
                                try {
                                    // ç¡®ä¿åœ¨è”ç³»äººé¡µé¢
                                    QQ_Nav('people');
                                    await new Promise(resolve => setTimeout(resolve, 200));
                                    
                                    // é‡æ–°åˆå§‹åŒ–åˆ†ç»„åŠŸèƒ½
                                    if (typeof initContactGroups === 'function') {
                                        initContactGroups();
                                    }
                                    
                                    console.log('âœ… å…¨å±æ¨¡å¼ä¸‹åˆ†ç»„ç•Œé¢å¼ºåˆ¶æ›´æ–°å®Œæˆ');
                                } catch (error) {
                                    console.error('å…¨å±æ¨¡å¼ç•Œé¢æ›´æ–°å¤±è´¥:', error);
                                }
                            }, 300);
                        }
                        
                        await renderContactGroups();
                        console.log('åˆ†ç»„åˆ›å»ºç•Œé¢åˆ·æ–°å®Œæˆ');
                    } else {
                        throw new Error('ä¿å­˜å‡½æ•°è¿”å›å¤±è´¥');
                    }
                    
                } catch (error) {
                    console.error('âŒ ä¿å­˜æ–°åˆ†ç»„å¤±è´¥:', error);
                    
                    // *** å¢å¼ºï¼šé”™è¯¯å›æ»šæœºåˆ¶ ***
                    contactGroups.length = 0;
                    contactGroups.push(...originalGroups);
                    console.log('ğŸ”„ å·²å›æ»šåˆ°åˆ›å»ºå‰çŠ¶æ€');
                    
                    alert('åˆ†ç»„åˆ›å»ºå¤±è´¥ï¼Œè¯·é‡è¯•: ' + error.message);
                }
            }
            
            /**
             * å¤„ç†æ–°å»ºåˆ†ç»„è¾“å…¥æ¡†çš„æŒ‰é”®äº‹ä»¶
             */
            function handleNewGroupKeydown(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    createNewContactGroup();
                } else if (event.key === 'Escape') {
                    event.preventDefault();
                    closeNewGroupModal();
                }
            }
            
            
            // ç¡®ä¿å‡½æ•°å…¨å±€å¯ç”¨
            window.createNewContactGroup = createNewContactGroup;
            window.closeNewGroupModal = closeNewGroupModal;
            window.showNewGroupModal = showNewGroupModal;
            window.handleNewGroupKeydown = handleNewGroupKeydown;
            window.openContactGroupModal = openContactGroupModal;
            
            /**
             * æ¸²æŸ“åˆ†ç»„ç•Œé¢
             */
            async function renderContactGroups() {
                const contactsContainer = document.getElementById('QQ_home_chars');
                if (!contactsContainer) {
                    console.error('âŒ æ— æ³•æ‰¾åˆ°è”ç³»äººå®¹å™¨ QQ_home_chars');
                    return;
                }
                
                // *** ä¿®å¤ï¼šæ£€æŸ¥å…¨å±æ¨¡å¼ä¸‹çš„å¯è§æ€§ ***
                const isFullscreen = document.fullscreenElement !== null || 
                                    document.webkitFullscreenElement !== null || 
                                    document.mozFullScreenElement !== null;
                
                if (isFullscreen) {
                    console.log('ğŸ–¥ï¸ æ£€æµ‹åˆ°å…¨å±æ¨¡å¼ï¼Œç¡®ä¿å®¹å™¨å¯è§æ€§');
                    // ç¡®ä¿åœ¨å…¨å±æ¨¡å¼ä¸‹å®¹å™¨ä»ç„¶å¯è§
                    const homePageVisible = QQ_IsElementVisible(document.getElementById('QQ_home_page'));
                    if (!homePageVisible) {
                        console.warn('âš ï¸ å…¨å±æ¨¡å¼ä¸‹è”ç³»äººé¡µé¢ä¸å¯è§ï¼Œå°è¯•æ˜¾ç¤º');
                        // å¯èƒ½éœ€è¦åˆ‡æ¢åˆ°è”ç³»äººé¡µé¢
                        QQ_Nav('people');
                        // çŸ­æš‚å»¶è¿Ÿç¡®ä¿é¡µé¢åˆ‡æ¢å®Œæˆ
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }
                
                // *** ç§»é™¤é‡å¤çš„é‡æ–°åŠ è½½ï¼Œå› ä¸ºè°ƒç”¨è€…å·²ç»è´Ÿè´£åŠ è½½æ•°æ® ***
                console.log(`ğŸ¨ å¼€å§‹æ¸²æŸ“åˆ†ç»„ç•Œé¢ï¼Œå½“å‰æœ‰ ${contactGroups.length} ä¸ªåˆ†ç»„`);

                // ä½¿ç”¨jQueryæ¥ä¿å­˜ç¾¤èŠå’Œç§èŠè”ç³»äººï¼Œç¡®ä¿äº‹ä»¶ç»‘å®šä¸ä¸¢å¤±
                const $originalGroupChats = $(contactsContainer).find('.QQ_home_usermsg[data-group-type="true"]');
                const $originalContacts = $(contactsContainer).find('.QQ_home_usermsg:not([data-group-type="true"])');

                // æ¸…ç©ºå®¹å™¨ï¼Œä½†ç”¨jQueryçš„æ–¹å¼
                $(contactsContainer).empty();

                // æ­¥éª¤1: åŸºäºæœ€æ–°çš„QQ_Groupsæ•°æ®è¿‡æ»¤å¹¶æ·»åŠ ç¾¤èŠï¼Œç¡®ä¿å®ƒä»¬æ€»åœ¨æœ€ä¸Šæ–¹
                if ($originalGroupChats.length > 0) {
                    const $groupChatSection = $('<div></div>');
                    $originalGroupChats.each(function() {
                        const groupName = $(this).attr('data-name');
                        // *** å…³é”®ä¿®å¤ï¼šåªæ·»åŠ ä»åœ¨QQ_Groupsä¸­çš„ç¾¤èŠ ***
                        if (groupName && QQ_Groups.includes(groupName)) {
                            console.log('âœ… ä¿ç•™ç¾¤èŠåœ¨è”ç³»äººç•Œé¢:', groupName);
                            $(this).appendTo($groupChatSection);
                        } else {
                            console.log('âŒ è·³è¿‡å·²åˆ é™¤çš„ç¾¤èŠ:', groupName);
                        }
                    });
                    
                    // åªæœ‰å½“æœ‰æœ‰æ•ˆç¾¤èŠæ—¶æ‰æ·»åŠ åˆ°ç•Œé¢
                    if ($groupChatSection.children().length > 0) {
                        $groupChatSection.appendTo($(contactsContainer));
                    }
                }

                // æ­¥éª¤2: æ¸²æŸ“ç§èŠçš„è‡ªå®šä¹‰åˆ†ç»„
                contactGroups.sort((a, b) => a.order - b.order).forEach(group => {
                    const groupElement = createGroupElement(group);
                    contactsContainer.appendChild(groupElement);
                });

                // æ­¥éª¤3: æ¸²æŸ“æœªåˆ†ç»„çš„ç§èŠè”ç³»äºº
                const $ungroupedContacts = $originalContacts.filter(function() {
                    const contactName = $(this).find('.QQ_home_name').text().trim();
                    return !isContactInAnyGroup(contactName);
                });

                if ($ungroupedContacts.length > 0) {
                    const $ungroupedSection = $(`
                        <div class="ungrouped-contacts">
                            <div class="ungrouped-header">æœªåˆ†ç»„è”ç³»äºº</div>
                        </div>
                    `);
                    
                    const $dropZone = $('<div class="drop-zone ungrouped-drop-zone" data-group-id="ungrouped"></div>');

                    $ungroupedContacts.each(function() {
                        $(this).attr('draggable', 'true');
                        $(this).appendTo($ungroupedSection);
                    });

                    $dropZone.appendTo($ungroupedSection);
                    $ungroupedSection.appendTo($(contactsContainer));
                }
            }
            
            /**
             * åˆ›å»ºåˆ†ç»„å…ƒç´ 
             */
            function createGroupElement(group) {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'contact-group';
                groupDiv.setAttribute('data-group-id', group.id);
                
                const isCollapsed = group.collapsed;
                const contactCount = group.contacts.length;
                
                groupDiv.innerHTML = `
                    <div class="group-header" onclick="toggleGroup('${group.id}')">
                        <span class="group-drag-handle" onmousedown="startGroupDrag(event, '${group.id}')">â‹®â‹®</span>
                        <span class="group-toggle ${isCollapsed ? 'collapsed' : ''}">â–¼</span>
                        <span class="group-name" onclick="editGroupName(event, '${group.id}')" data-group-id="${group.id}">${group.name}</span>
                        <span class="group-count">${contactCount}</span>
                        <span class="group-delete-btn" onclick="deleteContactGroup(event, '${group.id}')">Ã—</span>
                    </div>
                    <div class="group-content ${isCollapsed ? 'collapsed' : 'expanded'}">
                        ${group.contacts.map(contact => {
                            // ç¡®ä¿è”ç³»äººå¯ä»¥æ‹–æ‹½
                            const contactHtml = contact.html.replace(
                                'class="QQ_home_usermsg"',
                                'class="QQ_home_usermsg" draggable="true"'
                            );
                            return contactHtml;
                        }).join('')}
                    </div>
                    <div class="drop-zone" data-group-id="${group.id}"></div>
                `;
                
                return groupDiv;
            }
            
            /**
             * æ£€æŸ¥è”ç³»äººæ˜¯å¦åœ¨ä»»ä½•åˆ†ç»„ä¸­
             */
            function isContactInAnyGroup(contactName) {
                return contactGroups.some(group => 
                    group.contacts.some(contact => contact.name === contactName)
                );
            }
            
            /**
             * åˆ‡æ¢åˆ†ç»„æŠ˜å çŠ¶æ€
             */
            async function toggleGroup(groupId) {
                // *** å…³é”®ä¼˜åŒ–ï¼šå…ˆä»ä¸–ç•Œä¹¦é‡æ–°åŠ è½½åˆ†ç»„æ•°æ® ***
                await QQ_ForceReloadContactGroups();
                
                const group = contactGroups.find(g => g.id === groupId);
                if (!group) return;
                
                group.collapsed = !group.collapsed;
                await saveGroupsToStorage();
                
                const groupElement = document.querySelector(`[data-group-id="${groupId}"]`);
                const toggle = groupElement.querySelector('.group-toggle');
                const content = groupElement.querySelector('.group-content');
                
                if (group.collapsed) {
                    toggle.classList.add('collapsed');
                    content.classList.remove('expanded');
                    content.classList.add('collapsed');
                } else {
                    toggle.classList.remove('collapsed');
                    content.classList.remove('collapsed');
                    content.classList.add('expanded');
                }
            }
            
            /**
             * ç¼–è¾‘åˆ†ç»„åç§°
             */
            function editGroupName(event, groupId) {
                event.stopPropagation();
                
                const groupNameElement = event.target;
                const currentName = groupNameElement.textContent;
                
                // åˆ›å»ºè¾“å…¥æ¡†
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentName;
                input.className = 'group-name editing';
                input.maxLength = 15;
                
                // æ›¿æ¢å…ƒç´ 
                groupNameElement.replaceWith(input);
                input.focus();
                input.select();
                
                // å¤„ç†ä¿å­˜
                const saveEdit = async () => {
                    const newName = input.value.trim();
                    if (newName && newName !== currentName) {
                        // *** å…³é”®ä¼˜åŒ–ï¼šå…ˆä»ä¸–ç•Œä¹¦é‡æ–°åŠ è½½åˆ†ç»„æ•°æ® ***
                        await QQ_ForceReloadContactGroups();
                        
                        // æ£€æŸ¥é‡å
                        if (contactGroups.some(g => g.id !== groupId && g.name === newName)) {
                            alert('åˆ†ç»„åç§°å·²å­˜åœ¨');
                            input.focus();
                            return;
                        }
                        
                        // æ›´æ–°åˆ†ç»„å
                        const group = contactGroups.find(g => g.id === groupId);
                        if (group) {
                            group.name = newName;
                            console.log(`ğŸ·ï¸ åˆ†ç»„é‡å‘½å: ${currentName} â†’ ${newName}`);
                            await saveGroupsToStorage();
                        }
                    }
                    
                    // æ¢å¤æ˜¾ç¤º
                    const newSpan = document.createElement('span');
                    newSpan.className = 'group-name';
                    newSpan.setAttribute('data-group-id', groupId);
                    newSpan.textContent = newName || currentName;
                    newSpan.onclick = (e) => editGroupName(e, groupId);
                    input.replaceWith(newSpan);
                };
                
                // ç»‘å®šäº‹ä»¶
                input.addEventListener('blur', saveEdit);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        saveEdit();
                    } else if (e.key === 'Escape') {
                        const newSpan = document.createElement('span');
                        newSpan.className = 'group-name';
                        newSpan.setAttribute('data-group-id', groupId);
                        newSpan.textContent = currentName;
                        newSpan.onclick = (e) => editGroupName(e, groupId);
                        input.replaceWith(newSpan);
                    }
                });
            }
            
            /**
             * åˆ é™¤è”ç³»äººåˆ†ç»„
             */
            async function deleteContactGroup(event, groupId) {
                event.stopPropagation();
                
                // *** å…³é”®ä¼˜åŒ–ï¼šå…ˆä»ä¸–ç•Œä¹¦é‡æ–°åŠ è½½åˆ†ç»„æ•°æ® ***
                await QQ_ForceReloadContactGroups();
                
                const group = contactGroups.find(g => g.id === groupId);
                if (!group) return;
                
                if (confirm(`ç¡®å®šè¦åˆ é™¤åˆ†ç»„"${group.name}"å—ï¼Ÿ\nåˆ†ç»„ä¸­çš„è”ç³»äººå°†ç§»åŠ¨åˆ°æœªåˆ†ç»„åŒºåŸŸã€‚`)) {
                    console.log(`ğŸ—‘ï¸ åˆ é™¤åˆ†ç»„: ${group.name} (${group.contacts.length}äºº)`);
                    
                    // *** å¢å¼ºï¼šè·å–è§’è‰²IDè°ƒè¯•ä¿¡æ¯ ***
                    const charId = getCurrentCharacterId() || 'default';
                    console.log(`ğŸ­ åˆ é™¤åˆ†ç»„ï¼Œå½“å‰è§’è‰²: ${charId}`);
                    
                    // *** å¢å¼ºï¼šè®°å½•åŸå§‹çŠ¶æ€ï¼Œä»¥å¤‡å›æ»š ***
                    const originalGroups = [...contactGroups];
                    
                    // *** ä¿®å¤ï¼šç¡®ä¿åˆ é™¤å’Œä¿å­˜æ“ä½œæ­£ç¡®å®Œæˆ ***
                    try {
                        // ç§»é™¤åˆ†ç»„
                        contactGroups = contactGroups.filter(g => g.id !== groupId);
                        const saveResult = await saveGroupsToStorage();
                        
                        if (saveResult) {
                            console.log('âœ… åˆ†ç»„åˆ é™¤å¹¶ä¿å­˜åˆ°ä¸–ç•Œä¹¦æˆåŠŸ');
                            
                            // *** ä¿®å¤ï¼šç«‹å³åˆ·æ–°ç•Œé¢æ˜¾ç¤ºæœ€æ–°çŠ¶æ€ ***
                            await QQ_ForceReloadContactGroups();
                            await renderContactGroups();
                            console.log('åˆ†ç»„åˆ é™¤ç•Œé¢åˆ·æ–°å®Œæˆ');
                        } else {
                            throw new Error('ä¿å­˜å‡½æ•°è¿”å›å¤±è´¥');
                        }
                        
                    } catch (error) {
                        console.error('âŒ åˆ é™¤åˆ†ç»„å¤±è´¥:', error);
                        
                        // *** å¢å¼ºï¼šé”™è¯¯å›æ»šæœºåˆ¶ ***
                        contactGroups.length = 0;
                        contactGroups.push(...originalGroups);
                        console.log('ğŸ”„ å·²å›æ»šåˆ°åˆ é™¤å‰çŠ¶æ€');
                        
                        alert('åˆ é™¤åˆ†ç»„å¤±è´¥ï¼Œè¯·é‡è¯•: ' + error.message);
                    }
                }
            }
            
            /**
             * åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
             */
            function initGroupDragAndDrop() {
                // æ·»åŠ è”ç³»äººæ‹–æ‹½æ”¯æŒ
                document.addEventListener('dragstart', handleContactDragStart);
                document.addEventListener('dragover', handleDragOver);
                document.addEventListener('drop', handleContactDrop);
                document.addEventListener('dragend', handleDragEnd);
                
                // ä¸ºç°æœ‰è”ç³»äººæ·»åŠ æ‹–æ‹½å±æ€§
                setTimeout(() => {
                    const contacts = document.querySelectorAll('.QQ_home_usermsg:not([data-group-type])');
                    contacts.forEach(contact => {
                        contact.draggable = true;
                        contact.addEventListener('dragstart', handleContactDragStart);
                    });
                }, 200);
                
                console.log('æ‹–æ‹½åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
            }
            
            /**
             * è”ç³»äººæ‹–æ‹½å¼€å§‹
             */
            function handleContactDragStart(event) {
                const contact = event.target.closest('.QQ_home_usermsg');
                if (!contact) return;
                
                draggedElement = contact;
                contact.classList.add('dragging');
                
                // æŸ¥æ‰¾è”ç³»äººå½“å‰æ‰€åœ¨çš„åˆ†ç»„
                const groupContent = contact.closest('.group-content');
                if (groupContent) {
                    const groupElement = groupContent.closest('.contact-group');
                    draggedFromGroup = groupElement ? groupElement.getAttribute('data-group-id') : null;
                } else {
                    draggedFromGroup = null; // æ¥è‡ªæœªåˆ†ç»„åŒºåŸŸ
                }
                
                // æ˜¾ç¤ºæ‰€æœ‰æ‹–æ‹½ç›®æ ‡åŒºåŸŸ
                document.querySelectorAll('.drop-zone').forEach(zone => {
                    zone.classList.add('active');
                });
                
                event.dataTransfer.effectAllowed = 'move';
            }
            
            /**
             * æ‹–æ‹½æ‚¬åœå¤„ç†
             */
            function handleDragOver(event) {
                event.preventDefault();
                event.dataTransfer.dropEffect = 'move';
                
                const dropZone = event.target.closest('.drop-zone');
                if (dropZone) {
                    dropZone.style.borderColor = '#199AFF';
                    dropZone.style.backgroundColor = 'rgba(25, 154, 255, 0.2)';
                }
            }
            
            /**
             * è”ç³»äººæ‹–æ‹½æ”¾ç½®
             */
            async function handleContactDrop(event) {
                event.preventDefault();
                
                const dropZone = event.target.closest('.drop-zone');
                if (!dropZone || !draggedElement) return;
                
                // *** å…³é”®ä¼˜åŒ–ï¼šå…ˆä»ä¸–ç•Œä¹¦é‡æ–°åŠ è½½åˆ†ç»„æ•°æ® ***
                await QQ_ForceReloadContactGroups();
                
                const targetGroupId = dropZone.getAttribute('data-group-id');
                const contactName = draggedElement.querySelector('.QQ_home_name')?.textContent?.trim();
                
                if (!contactName) return;
                
                console.log(`ğŸ”„ æ‹–æ‹½è”ç³»äºº: ${contactName} â†’ ${targetGroupId === 'ungrouped' ? 'æœªåˆ†ç»„' : 'åˆ†ç»„'}`);
                
                // ä»åŸåˆ†ç»„ä¸­ç§»é™¤è”ç³»äºº
                if (draggedFromGroup) {
                    const fromGroup = contactGroups.find(g => g.id === draggedFromGroup);
                    if (fromGroup) {
                        fromGroup.contacts = fromGroup.contacts.filter(c => c.name !== contactName);
                        console.log(`ğŸ“¤ ä»åˆ†ç»„ "${fromGroup.name}" ç§»é™¤ "${contactName}"`);
                    }
                }
                
                // å¤„ç†ç›®æ ‡ä½ç½®
                if (targetGroupId === 'ungrouped') {
                    // æ‹–æ‹½åˆ°æœªåˆ†ç»„åŒºåŸŸï¼Œä¸éœ€è¦æ·»åŠ åˆ°ä»»ä½•åˆ†ç»„
                    console.log(`ğŸ“ è”ç³»äºº "${contactName}" å·²ç§»åŠ¨åˆ°æœªåˆ†ç»„åŒºåŸŸ`);
                } else {
                    // æ·»åŠ åˆ°ç›®æ ‡åˆ†ç»„
                    const targetGroup = contactGroups.find(g => g.id === targetGroupId);
                    if (targetGroup) {
                        // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨
                        if (!targetGroup.contacts.some(c => c.name === contactName)) {
                            targetGroup.contacts.push({
                                name: contactName,
                                html: draggedElement.outerHTML
                            });
                            console.log(`ğŸ“¥ æ·»åŠ  "${contactName}" åˆ°åˆ†ç»„ "${targetGroup.name}"`);
                        }
                    }
                }
                
                // ä¿å­˜å¹¶é‡æ–°æ¸²æŸ“
                await saveGroupsToStorage();
                renderContactGroups();
                
                // é‡æ–°åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
                setTimeout(() => {
                    initGroupDragAndDrop();
                }, 100);
            }
            
            /**
             * æ‹–æ‹½ç»“æŸå¤„ç†
             */
            function handleDragEnd(event) {
                // æ¸…ç†æ‹–æ‹½çŠ¶æ€
                if (draggedElement) {
                    draggedElement.classList.remove('dragging');
                    draggedElement = null;
                }
                draggedFromGroup = null;
                
                // éšè—æ‰€æœ‰æ‹–æ‹½ç›®æ ‡åŒºåŸŸ
                document.querySelectorAll('.drop-zone').forEach(zone => {
                    zone.classList.remove('active');
                    zone.style.borderColor = '';
                    zone.style.backgroundColor = '';
                });
            }
            
            /**
             * å¼€å§‹åˆ†ç»„æ‹–æ‹½
             */
            function startGroupDrag(event, groupId) {
                event.stopPropagation();
                // åˆ†ç»„æ‹–æ‹½åŠŸèƒ½å°†åœ¨åç»­å®ç°
                console.log('å¼€å§‹æ‹–æ‹½åˆ†ç»„:', groupId);
            }
            
            /**
             * *** å·²ç§»é™¤ï¼šæ—§çš„localStorageå­˜å‚¨å‡½æ•° ***
             * ç°åœ¨ç»Ÿä¸€ä½¿ç”¨ä¸–ç•Œä¹¦å­˜å‚¨æœºåˆ¶
             */
            
            /**
             * å¤„ç†æ–°å»ºåˆ†ç»„çš„é”®ç›˜äº‹ä»¶
             */
            function handleNewGroupKeydown(event) {
                if (event.key === 'Enter') {
                    createNewContactGroup();
                } else if (event.key === 'Escape') {
                    closeNewGroupModal();
                }
            }

            // ==================== åˆ†ç»„å¼¹çª—ç®¡ç†åŠŸèƒ½ ====================
            
            /**
             * æ‰“å¼€åˆ†ç»„ç®¡ç†å¼¹çª—
             */
            function openContactGroupModal() {
                closeGroupChatModal();
                setTimeout(() => {
                    showNewGroupModal();
                }, 150);
            }

            // ==================== ç¾¤èŠå¤´åƒè®¾ç½®åŠŸèƒ½ ====================
            
            let selectedAvatarData = null; // å­˜å‚¨é€‰ä¸­çš„å¤´åƒæ•°æ®
            
            // ==================== ç¾¤èŠåŠŸèƒ½å¢å¼º ====================
            
            /**
             * å¤„ç†èŠå¤©æ ‡é¢˜ç‚¹å‡» - æ˜¾ç¤ºç¾¤æˆå‘˜åˆ—è¡¨
             */
            function handleChatTitleClick(element) {
                console.log('=== handleChatTitleClick è¢«è°ƒç”¨ ===');
                
                // *** è°ƒè¯•ï¼šæ£€æŸ¥DOMå…ƒç´ çš„ç›¸å…³å±æ€§ ***
                console.log('ç‚¹å‡»çš„èŠå¤©æ ‡é¢˜:', element.textContent.trim());
                console.log('å…ƒç´ æ•°æ®å±æ€§:', {
                    'data-name': element.getAttribute('data-name'),
                    'data-group-id': element.getAttribute('data-group-id')
                });
                
                const chatPageContainer = element.closest('.QQ_chat_page');
                if (!chatPageContainer) {
                    console.log('æœªæ‰¾åˆ°èŠå¤©é¡µé¢å®¹å™¨');
                    return;
                }
                
                console.log('èŠå¤©é¡µé¢å®¹å™¨:', chatPageContainer);
                console.log('èŠå¤©é¡µé¢å®¹å™¨çš„data-name:', chatPageContainer.getAttribute('data-name'));
                console.log('èŠå¤©é¡µé¢å®¹å™¨çš„data-group-id:', chatPageContainer.getAttribute('data-group-id'));
                
                // *** è°ƒè¯•æ—¥å¿—ï¼šæ£€æŸ¥å¤šç§è·å–èŠå¤©åç§°çš„æ–¹å¼ ***
                const chatName = element.textContent.trim();
                const dataName = element.getAttribute('data-name') || chatPageContainer.getAttribute('data-name');
                const groupId = element.getAttribute('data-group-id') || chatPageContainer.getAttribute('data-group-id');
                
                console.log('=== èŠå¤©åç§°è·å–è°ƒè¯• ===');
                console.log('ä»textContentè·å–çš„åç§°:', chatName);
                console.log('ä»data-nameå±æ€§è·å–çš„åç§°:', dataName);
                console.log('ä»data-group-idå±æ€§è·å–çš„ID:', groupId);
                
                // *** è°ƒè¯•æ—¥å¿—ï¼šæ£€æŸ¥å…¨å±€ç¾¤èŠæ•°æ® ***
                console.log('=== å…¨å±€æ•°æ®è°ƒè¯• ===');
                console.log('QQ_Groupsæ•°ç»„:', window.QQ_Groups);
                if (window.QQ_Groups && Array.isArray(window.QQ_Groups)) {
                    const matchingGroups = window.QQ_Groups.filter(g => 
                        g.name === chatName || 
                        g.name === dataName || 
                        g.id === groupId ||
                        chatName.includes(g.name) ||
                        (dataName && dataName.includes(g.name))
                    );
                    console.log('åŒ¹é…çš„ç¾¤èŠæ•°æ®:', matchingGroups);
                }
                
                console.log('æœ€ç»ˆä½¿ç”¨çš„èŠå¤©åç§°:', chatName);
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯ç¾¤èŠ
                const isGroupChat = checkIfGroupChat(chatName);
                if (isGroupChat) {
                    // ç¾¤èŠé€»è¾‘
                const cleanGroupName = chatName.replace(/\s*\(\d+äºº\)\s*$/, '').trim();
                
                // ä»QQ_msgjson.ç¾¤èŠä¸­è·å–ç¾¤èŠæ•°æ®
                let groupData = null;
                if (QQ_msgjson && QQ_msgjson.ç¾¤èŠ && QQ_msgjson.ç¾¤èŠ[cleanGroupName]) {
                    const msgGroupData = QQ_msgjson.ç¾¤èŠ[cleanGroupName];
                    groupData = {
                        name: cleanGroupName,
                        members: msgGroupData.members || [],
                        avatar: QQ_GetRandomAvatar() || 'https://files.catbox.moe/skngqq.jpg' // éšæœºå¤´åƒ
                    };
                }
                
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç¾¤èŠæ•°æ®ï¼Œåˆ›å»ºä¸€ä¸ªåŸºæœ¬çš„æ•°æ®ç»“æ„
                if (!groupData) {
                    groupData = {
                        name: cleanGroupName,
                        members: ['æˆå‘˜1', 'æˆå‘˜2', 'æˆå‘˜3'], // ç¤ºä¾‹æˆå‘˜
                        avatar: QQ_GetRandomAvatar() || 'https://files.catbox.moe/skngqq.jpg'
                    };
                    console.warn(`ç¾¤èŠ ${cleanGroupName} æ•°æ®æœªæ‰¾åˆ°ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®`);
                }
                
                // è°ƒç”¨ç¾¤èŠç®¡ç†èœå•
                console.log('æ˜¾ç¤ºç¾¤èŠç®¡ç†èœå•:', groupData);
                showGroupManagementMenu(groupData, element);
                } else {
                    // ç§èŠé€»è¾‘ - å…ˆæ˜¾ç¤ºè§’è‰²ç²¾çµ
                    console.log('è¿™æ˜¯ç§èŠï¼Œæ˜¾ç¤ºè§’è‰²ç²¾çµ');
                    QQ_ShowCharacterSpirit(chatName);
                }
            }
            
            /**
             * æ£€æŸ¥æ˜¯å¦ä¸ºç¾¤èŠï¼ˆç»Ÿä¸€ä½¿ç”¨QQ_Groupsæ•°ç»„ï¼‰
             */
            function checkIfGroupChat(chatName) {
                // ç§»é™¤æ ‡é¢˜ä¸­çš„äººæ•°ä¿¡æ¯ï¼Œåªä¿ç•™ç¾¤å
                const cleanChatName = chatName.replace(/\s*\(\d+äºº\)\s*$/, '').trim();
                
                // ä½¿ç”¨QQ_Groupsæ•°ç»„æ£€æŸ¥ï¼Œç¡®ä¿ä¸å…¶ä»–åœ°æ–¹çš„é€»è¾‘ä¸€è‡´
                return QQ_Groups.includes(cleanChatName);
            }
            
            /**
             * åŠ è½½ç¾¤æˆå‘˜åˆ—è¡¨
             */
            function loadGroupMembers(groupName, memberListContainer) {
                // è·å–ç¾¤æˆå‘˜æ•°æ®ï¼ˆè¿™é‡Œå¯ä»¥ä»localStorageæˆ–å…¶ä»–æ•°æ®æºè·å–ï¼‰
                const groupMembers = getGroupMembers(groupName);
                
                // æ¸…ç©ºå®¹å™¨
                memberListContainer.innerHTML = '';
                
                if (groupMembers.length === 0) {
                    memberListContainer.innerHTML = '<div class="no-members">æš‚æ— ç¾¤æˆå‘˜</div>';
                    return;
                }
                
                // æ¸²æŸ“æˆå‘˜åˆ—è¡¨
                groupMembers.forEach(member => {
                    const memberItem = document.createElement('div');
                    memberItem.className = 'group-member-item';
                    memberItem.innerHTML = `
                        <div class="member-avatar" style="background-image: url('${member.avatar}')"></div>
                        <div class="member-name">${member.name}</div>
                    `;
                    memberListContainer.appendChild(memberItem);
                });
            }
            
            /**
             * è·å–ç¾¤æˆå‘˜æ•°æ®ï¼ˆä»QQ_msgjson.ç¾¤èŠä¸­è·å–ï¼‰
             */
            function getGroupMembers(groupName) {
                // ç§»é™¤å¯èƒ½çš„äººæ•°æ ‡è¯†
                const cleanGroupName = groupName.replace(/\s*\(\d+äºº\)\s*$/, '').trim();
                
                try {
                    // ç›´æ¥ä»QQ_msgjson.ç¾¤èŠä¸­è·å–ç¾¤èŠæ•°æ®
                    if (QQ_msgjson && QQ_msgjson.ç¾¤èŠ && QQ_msgjson.ç¾¤èŠ[cleanGroupName]) {
                        const groupData = QQ_msgjson.ç¾¤èŠ[cleanGroupName];
                        
                        if (groupData.members && Array.isArray(groupData.members)) {
                            console.log(`ä»QQ_msgjsonè·å–ç¾¤æˆå‘˜: ${cleanGroupName}`, groupData.members);
                            
                            // è·å–éšæœºå¤´åƒåˆ—è¡¨
                            const avatarList = QQ_RandomHeadList || [
                                'http://sharkpan.xyz/f/EJeUD/Image_1737026320652.jpg',
                                'http://sharkpan.xyz/f/Y8pt1/Image_1737026296736.jpg',
                                'http://sharkpan.xyz/f/QWWc6/Image_1737026308451.jpg',
                                'http://sharkpan.xyz/f/Z8LIW/Image_1737026306601.jpg',
                                'http://sharkpan.xyz/f/W8lhW/Image_1737026313246.jpg'
                            ];
                            
                            return groupData.members.map((memberName, index) => ({
                                name: memberName,
                                avatar: avatarList[index % avatarList.length]
                            }));
                        }
                    }
                    
                    console.warn(`ç¾¤èŠ ${cleanGroupName} çš„æˆå‘˜ä¿¡æ¯æœªæ‰¾åˆ°ï¼Œä½¿ç”¨ç¤ºä¾‹æˆå‘˜`);
                } catch (error) {
                    console.error('ä»QQ_msgjsonè·å–ç¾¤æˆå‘˜å¤±è´¥:', error);
                }
                
                // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œç”Ÿæˆä¸€äº›ç¤ºä¾‹æˆå‘˜
                return generateSampleMembers(cleanGroupName);
            }
            
            /**
             * ç”Ÿæˆç¤ºä¾‹ç¾¤æˆå‘˜
             */
            function generateSampleMembers(groupName) {
                const sampleMembers = [
                    { name: 'ç¾¤ä¸»', avatar: 'http://sharkpan.xyz/f/EJeUD/Image_1737026320652.jpg' },
                    { name: 'ç®¡ç†å‘˜', avatar: 'http://sharkpan.xyz/f/Y8pt1/Image_1737026296736.jpg' },
                    { name: 'æˆå‘˜A', avatar: 'http://sharkpan.xyz/f/QWWc6/Image_1737026308451.jpg' },
                    { name: 'æˆå‘˜B', avatar: 'http://sharkpan.xyz/f/Z8LIW/Image_1737026306601.jpg' },
                    { name: 'æˆå‘˜C', avatar: 'http://sharkpan.xyz/f/W8lhW/Image_1737026313246.jpg' }
                ];
                
                // æ–°ç‰ˆæœ¬ï¼šä¸å†ä½¿ç”¨localStorageä¿å­˜ç¾¤æˆå‘˜æ•°æ®
                console.log('ç”Ÿæˆç¤ºä¾‹ç¾¤æˆå‘˜ï¼ˆä»…å†…å­˜ï¼‰:', sampleMembers);
                
                return sampleMembers;
            }
            
            /**
             * ç¡®ä¿æ¶ˆæ¯éš”ç¦» - åªå‘é€ç»™å½“å‰ç¾¤ç»„
             */
            function sendGroupMessage(groupName, message) {
                const timestamp = new Date().toLocaleTimeString('zh-CN', { 
                    hour12: false, 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                // è·å–å½“å‰ç¾¤æˆå‘˜
                const members = getGroupMembers(groupName);
                
                // æ¨¡æ‹Ÿç¾¤æˆå‘˜å›å¤ï¼ˆéšæœºé€‰æ‹©1-2ä¸ªæˆå‘˜å›å¤ï¼‰
                setTimeout(() => {
                    // æ£€æŸ¥æ˜¯å¦æ­£åœ¨ç”ŸæˆAIå›å¤ï¼Œé¿å…åœ¨ç­‰å¾…æœŸé—´äº§ç”Ÿæ¶ˆæ¯æ´ªæ°´
                    if (typeof gening !== 'undefined' && gening) {
                        console.log('ğŸ”„ AIç”Ÿæˆä¸­ï¼Œæš‚åœç¾¤æˆå‘˜å›å¤æ¨¡æ‹Ÿï¼Œé¿å…æ¶ˆæ¯æ´ªæ°´');
                        return;
                    }
                    
                    const replyCount = Math.floor(Math.random() * 2) + 1;
                    const repliedMembers = [];
                    
                    for (let i = 0; i < replyCount; i++) {
                        const randomMember = members[Math.floor(Math.random() * members.length)];
                        if (!repliedMembers.includes(randomMember.name)) {
                            repliedMembers.push(randomMember.name);
                            
                            // ç”Ÿæˆå›å¤æ¶ˆæ¯
                            const replyMessage = generateGroupReply(message);
                            
                            // æ·»åŠ åˆ°èŠå¤©ç•Œé¢ï¼ˆè¿™é‡Œéœ€è¦æ ¹æ®å®é™…çš„æ¶ˆæ¯æ¸²æŸ“å‡½æ•°è°ƒç”¨ï¼‰
                            console.log(`${randomMember.name}åœ¨ç¾¤"${groupName}"ä¸­å›å¤: ${replyMessage}`);
                        }
                    }
                }, Math.random() * 3000 + 1000); // 1-4ç§’åå›å¤
            }
            
            /**
             * ç”Ÿæˆç¾¤èŠå›å¤å†…å®¹
             */
            function generateGroupReply(originalMessage) {
                const replies = [
                    'åŒæ„ï¼',
                    'å“ˆå“ˆå“ˆ',
                    'å¥½çš„',
                    'æ”¶åˆ°',
                    'ç¡®å®å¦‚æ­¤',
                    'æˆ‘ä¹Ÿè§‰å¾—',
                    'è¯´å¾—å¯¹',
                    '+1',
                    'æ”¯æŒ',
                    'èµåŒ'
                ];
                
                return replies[Math.floor(Math.random() * replies.length)];
            }
            
            // å…¨å±€æ³¨å†Œå‡½æ•°
            window.handleChatTitleClick = handleChatTitleClick;
            window.sendGroupMessage = sendGroupMessage;
            
            /**
             * æ˜¾ç¤ºå¤´åƒé€‰æ‹©å™¨
             */
            function showAvatarSelector() {
                console.log('æ˜¾ç¤ºå¤´åƒé€‰æ‹©å™¨');
                const modal = document.getElementById('avatar_selector_modal');
                if (modal) {
                    modal.style.display = 'flex';
                    
                    // åˆå§‹åŒ–é¢„è®¾å¤´åƒ
                    loadPresetAvatars();
                    
                    // é‡ç½®é€‰æ‹©çŠ¶æ€ - æš‚æ—¶æ³¨é‡Šæ‰ï¼Œè®©ç”¨æˆ·å¯ä»¥é€‰æ‹©
                    // selectedAvatarData = null;
                    
                    // åˆå§‹çŠ¶æ€ä¸‹å¯ç”¨ç¡®è®¤æŒ‰é’®
                    const confirmBtn = document.getElementById('avatar_confirm_btn');
                    if (confirmBtn) {
                        confirmBtn.disabled = false;
                    }
                    
                    updateAvatarConfirmButton();
                    
                    // æ·»åŠ èƒŒæ™¯ç‚¹å‡»å…³é—­åŠŸèƒ½
                    modal.addEventListener('click', function(e) {
                        if (e.target === modal) {
                            closeAvatarSelector();
                        }
                    });
                    
                    console.log('å¤´åƒé€‰æ‹©å™¨å·²æ˜¾ç¤º');
                }
            }
            
            /**
             * å…³é—­å¤´åƒé€‰æ‹©å™¨
             */
            function closeAvatarSelector() {
                console.log('å…³é—­å¤´åƒé€‰æ‹©å™¨');
                const modal = document.getElementById('avatar_selector_modal');
                if (modal) {
                    modal.style.display = 'none';
                }
                
                // æ¸…ç†ç¾¤èŠå¤´åƒé€‰æ‹©çŠ¶æ€
                if (window.isSelectingGroupAvatar) {
                    window.isSelectingGroupAvatar = false;
                    window.currentAvatarGroup = null;
                }
                
                // ä¸è¦é‡ç½®å¤´åƒæ•°æ®ï¼Œè®©ç”¨æˆ·çš„é€‰æ‹©ä¿æŒ
                // selectedAvatarData = null;
            }
            
            /**
             * åˆ‡æ¢å¤´åƒé€‰æ‹©æ ‡ç­¾é¡µ
             */
            function switchAvatarTab(tabType) {
                console.log('åˆ‡æ¢åˆ°æ ‡ç­¾é¡µ:', tabType);
                
                // æ›´æ–°æ ‡ç­¾çŠ¶æ€
                document.querySelectorAll('.avatar-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`.avatar-tab[onclick*="${tabType}"]`).classList.add('active');
                
                // æ˜¾ç¤ºå¯¹åº”å†…å®¹
                document.querySelectorAll('.avatar-options').forEach(option => {
                    option.classList.remove('active');
                });
                document.getElementById(tabType + '_avatars').classList.add('active');
                
                // å¦‚æœåˆ‡æ¢åˆ°URLæ ‡ç­¾é¡µï¼Œæ¸…ç©ºä¹‹å‰çš„é¢„è§ˆ
                if (tabType === 'url') {
                    const urlInput = document.getElementById('avatar_url_input');
                    const previewContainer = document.getElementById('url_preview_container');
                    if (urlInput) urlInput.value = '';
                    if (previewContainer) previewContainer.style.display = 'none';
                }
            }
            
            /**
             * å¤„ç†å¤´åƒURLè¾“å…¥
             */
            function handleAvatarUrlInput() {
                const urlInput = document.getElementById('avatar_url_input');
                const previewContainer = document.getElementById('url_preview_container');
                const previewImage = document.getElementById('url_preview_image');
                
                if (!urlInput || !previewContainer || !previewImage) return;
                
                const url = urlInput.value.trim();
                
                if (!url) {
                    previewContainer.style.display = 'none';
                    window.selectedAvatarData = null;
                    updateAvatarConfirmButton();
                    return;
                }
                
                // ç®€å•çš„URLéªŒè¯
                try {
                    new URL(url);
                } catch (e) {
                    previewContainer.style.display = 'none';
                    window.selectedAvatarData = null;
                    updateAvatarConfirmButton();
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯å›¾ç‰‡URL
                const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp'];
                const isImageUrl = imageExtensions.some(ext => 
                    url.toLowerCase().includes(ext) || 
                    url.toLowerCase().includes('image') ||
                    url.includes('catbox.moe') ||
                    url.includes('imgur.com') ||
                    url.includes('i.imgur.com')
                );
                
                if (!isImageUrl && !url.startsWith('data:image/')) {
                    console.warn('å¯èƒ½ä¸æ˜¯å›¾ç‰‡URL:', url);
                }
                
                // æ˜¾ç¤ºé¢„è§ˆ
                previewImage.onload = function() {
                    console.log('å›¾ç‰‡åŠ è½½æˆåŠŸ:', url);
                    previewContainer.style.display = 'block';
                    
                    // ä¿å­˜é€‰ä¸­çš„å¤´åƒæ•°æ®
                    window.selectedAvatarData = {
                        type: 'url',
                        url: url
                    };
                    
                    console.log('URLå¤´åƒæ•°æ®å·²ä¿å­˜:', window.selectedAvatarData);
                    updateAvatarConfirmButton();
                };
                
                previewImage.onerror = function() {
                    console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', url);
                    previewContainer.style.display = 'none';
                    window.selectedAvatarData = null;
                    updateAvatarConfirmButton();
                    
                    // å¯ä»¥æ˜¾ç¤ºé”™è¯¯æç¤º
                    const urlInput = document.getElementById('avatar_url_input');
                    if (urlInput) {
                        urlInput.style.borderColor = '#ff6b6b';
                        setTimeout(() => {
                            urlInput.style.borderColor = '';
                        }, 2000);
                    }
                };
                
                previewImage.src = url;
            }
            
            /**
             * åŠ è½½é¢„è®¾å¤´åƒ
             */
            function loadPresetAvatars() {
                const gridContainer = document.querySelector('.preset-avatar-grid');
                if (!gridContainer) return;
                
                // é¢„è®¾å¤´åƒçš„æ¸å˜è‰²é…ç½®
                const avatarGradients = [
                    { start: '#FF6B6B', end: '#EE5A24', text: 'ç¾¤' },
                    { start: '#4ECDC4', end: '#44A08D', text: 'èŠ' },
                    { start: '#45B7D1', end: '#96CEB4', text: 'ç»„' },
                    { start: '#FFA07A', end: '#FA8072', text: 'å›¢' },
                    { start: '#98D8C8', end: '#F7DC6F', text: 'é˜Ÿ' },
                    { start: '#BB8FCE', end: '#D2B4DE', text: 'åœˆ' },
                    { start: '#F8C471', end: '#F39C12', text: 'ç¤¾' },
                    { start: '#85C1E9', end: '#5DADE2', text: 'ä¼š' },
                    { start: '#F1948A', end: '#EC7063', text: 'å‹' },
                    { start: '#82E0AA', end: '#58D68D', text: 'ä¼´' },
                    { start: '#AED6F1', end: '#7FB3D3', text: 'ä¼™' },
                    { start: '#E8DAEF', end: '#D7BDE2', text: 'é›†' }
                ];
                
                gridContainer.innerHTML = '';
                
                avatarGradients.forEach((gradient, index) => {
                    const avatarItem = document.createElement('div');
                    avatarItem.className = 'preset-avatar-item';
                    avatarItem.style.setProperty('--gradient-start', gradient.start);
                    avatarItem.style.setProperty('--gradient-end', gradient.end);
                    avatarItem.textContent = gradient.text;
                    
                    avatarItem.addEventListener('click', () => {
                        console.log('ç‚¹å‡»é¢„è®¾å¤´åƒ:', gradient);
                        
                        // ç§»é™¤å…¶ä»–é€‰ä¸­çŠ¶æ€
                        document.querySelectorAll('.preset-avatar-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        
                        // æ·»åŠ é€‰ä¸­çŠ¶æ€
                        avatarItem.classList.add('selected');
                        
                        // ä¿å­˜é€‰ä¸­çš„å¤´åƒæ•°æ®
                        window.selectedAvatarData = {
                            type: 'preset',
                            gradient: gradient,
                            text: gradient.text
                        };
                        
                        console.log('å¤´åƒæ•°æ®å·²ä¿å­˜:', window.selectedAvatarData);
                        updateAvatarConfirmButton();
                    });
                    
                    gridContainer.appendChild(avatarItem);
                });
            }
            
            /**
             * è§¦å‘æ–‡ä»¶ä¸Šä¼ 
             */
            function triggerFileUpload() {
                document.getElementById('avatar_upload_input').click();
            }
            
            /**
             * å¤„ç†å¤´åƒä¸Šä¼ 
             */
            function handleAvatarUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                if (!file.type.startsWith('image/')) {
                    alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                    return;
                }
                
                // æ£€æŸ¥æ–‡ä»¶å¤§å° (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('å›¾ç‰‡æ–‡ä»¶ä¸èƒ½è¶…è¿‡5MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    console.log('åŸå§‹å›¾ç‰‡å¤§å°:', e.target.result.length);
                    
                    // å‹ç¼©å›¾ç‰‡ä»¥é¿å…localStorageé…é¢é—®é¢˜
                    let imageData;
                    try {
                        imageData = await compressImage(file, 512, 0.8);
                        console.log('å›¾ç‰‡å‹ç¼©å®Œæˆï¼Œå‹ç¼©åå¤§å°:', imageData.length);
                    } catch (error) {
                        console.warn('å›¾ç‰‡å‹ç¼©å¤±è´¥ï¼Œä½¿ç”¨åŸå›¾:', error);
                        imageData = e.target.result;
                    }
                    
                    // ç›´æ¥ä½¿ç”¨å‹ç¼©åçš„base64æ•°æ®ï¼Œé¿å…localStorageå­˜å‚¨
                    console.log('ä½¿ç”¨å‹ç¼©åçš„base64æ•°æ®ï¼Œè·³è¿‡localStorageå­˜å‚¨');
                    
                    // *** ä¿®å¤ï¼šç»Ÿä¸€çš„å¤´åƒä¸Šä¼ é€»è¾‘ ***
                    // æ— è®ºæ˜¯åˆ›å»ºç¾¤èŠè¿˜æ˜¯ç¾¤èŠè®¾ç½®ï¼Œéƒ½ä½¿ç”¨ç›¸åŒçš„é€»è¾‘ï¼šå…ˆä¿å­˜åˆ°selectedAvatarDataï¼Œç„¶åé€šè¿‡ç¡®è®¤æŒ‰é’®ç»Ÿä¸€å¤„ç†
                    
                    // ç¾¤èŠåˆ›å»ºä¸­çš„å¤´åƒä¸Šä¼ 
                    const uploadZone = document.querySelector('.upload-zone');
                    if (uploadZone) {
                        uploadZone.innerHTML = `
                            <div class="uploaded-preview">
                                <img src="${imageData}" alt="é¢„è§ˆ" style="width: 120px; height: 120px; border-radius: 12px; object-fit: cover;">
                                <div class="upload-text" style="margin-top: 10px; color: #28a745;">âœ… å›¾ç‰‡å·²ä¸Šä¼ æˆåŠŸï¼ˆå·²å‹ç¼©ï¼‰</div>
                                <button class="change-image-btn" onclick="triggerFileUpload()" style="margin-top: 8px; padding: 6px 12px; border: 1px solid #ddd; border-radius: 6px; background: white; cursor: pointer;">æ›´æ¢å›¾ç‰‡</button>
                                <div style="margin-top: 8px; font-size: 12px; color: #666; text-align: center;">
                                    å›¾ç‰‡å·²å‹ç¼©å¹¶å°†ç›´æ¥ä¿å­˜åˆ°ä¸–ç•Œä¹¦ä¸­
                                </div>
                            </div>
                        `;
                    }
                    
                    // ä¿å­˜é€‰ä¸­çš„å¤´åƒæ•°æ®ï¼ˆä½¿ç”¨å‹ç¼©åçš„æ•°æ®ï¼‰
                    window.selectedAvatarData = {
                        type: 'upload',
                        imageData: imageData  // ç›´æ¥ä¿å­˜å‹ç¼©åçš„å®Œæ•´æ•°æ®
                    };
                    
                    console.log('ä¸Šä¼ å¤´åƒæ•°æ®å·²ä¿å­˜:', {
                        type: window.selectedAvatarData.type,
                        hasImageData: !!window.selectedAvatarData.imageData,
                        dataSize: window.selectedAvatarData.imageData.length
                    });
                    
                    updateAvatarConfirmButton();
                };
                
                reader.readAsDataURL(file);
            }
            
            /**
             * æ›´æ–°ç¡®è®¤æŒ‰é’®çŠ¶æ€
             */
            function updateAvatarConfirmButton() {
                const confirmBtn = document.getElementById('avatar_confirm_btn');
                if (confirmBtn) {
                    // æ€»æ˜¯å¯ç”¨ç¡®è®¤æŒ‰é’®ï¼Œå› ä¸ºå¯ä»¥ä½¿ç”¨é»˜è®¤å¤´åƒ
                    confirmBtn.disabled = false;
                    console.log('æ›´æ–°å¤´åƒç¡®è®¤æŒ‰é’®çŠ¶æ€:', {
                        hasData: !!window.selectedAvatarData,
                        disabled: confirmBtn.disabled,
                        selectedData: window.selectedAvatarData
                    });
                }
            }
            
            /**
             * ç¡®è®¤å¤´åƒé€‰æ‹©ï¼ˆå¢å¼ºç‰ˆï¼šæ”¯æŒåˆ›å»ºç¾¤èŠå’Œç¾¤èŠè®¾ç½®ï¼‰
             */
            function confirmAvatarSelection() {
                console.log('ç¡®è®¤å¤´åƒé€‰æ‹©ï¼Œå½“å‰é€‰ä¸­çš„å¤´åƒæ•°æ®:', window.selectedAvatarData);
                console.log('æ˜¯å¦åœ¨ç¾¤èŠè®¾ç½®ä¸­é€‰æ‹©å¤´åƒ:', window.isSelectingGroupAvatar);
                
                // å¦‚æœæ²¡æœ‰é€‰æ‹©å¤´åƒï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ
                if (!window.selectedAvatarData) {
                    window.selectedAvatarData = {
                        type: 'preset',
                        gradient: { start: '#199AFF', end: '#0066CC' },
                        text: 'ç¾¤'
                    };
                    console.log('ä½¿ç”¨é»˜è®¤å¤´åƒ:', window.selectedAvatarData);
                }
                
                // *** ä¿®å¤ï¼šæ”¯æŒç¾¤èŠè®¾ç½®ä¸­çš„å¤´åƒé€‰æ‹© ***
                if (window.isSelectingGroupAvatar) {
                    // ç¾¤èŠè®¾ç½®ä¸­çš„å¤´åƒé€‰æ‹©
                    const settingsPreviewElement = document.getElementById('group_settings_avatar_preview');
                    const settingsTextElement = document.querySelector('.group-settings-avatar-text');
                    
                    if (settingsPreviewElement && settingsTextElement) {
                        if (window.selectedAvatarData.type === 'preset') {
                            // é¢„è®¾å¤´åƒ
                            const gradient = window.selectedAvatarData.gradient;
                            settingsPreviewElement.style.background = `linear-gradient(135deg, ${gradient.start}, ${gradient.end})`;
                            settingsPreviewElement.style.backgroundImage = 'none';
                            settingsPreviewElement.innerHTML = `<div class="default-group-avatar">${window.selectedAvatarData.text}</div>`;
                            settingsTextElement.textContent = 'å·²é€‰æ‹©é¢„è®¾å¤´åƒ';
                        } else if (window.selectedAvatarData.type === 'upload') {
                            // ä¸Šä¼ çš„å¤´åƒ
                            settingsPreviewElement.style.background = 'none';
                            settingsPreviewElement.style.backgroundImage = `url('${window.selectedAvatarData.imageData}')`;
                            settingsPreviewElement.style.backgroundSize = 'cover';
                            settingsPreviewElement.style.backgroundPosition = 'center';
                            settingsPreviewElement.style.backgroundRepeat = 'no-repeat';
                            settingsPreviewElement.innerHTML = '';
                            settingsTextElement.textContent = 'å·²é€‰æ‹©è‡ªå®šä¹‰å¤´åƒ';
                        }
                        
                        console.log('ç¾¤èŠè®¾ç½®å¤´åƒé¢„è§ˆå·²æ›´æ–°');
                    } else {
                        console.error('æ‰¾ä¸åˆ°ç¾¤èŠè®¾ç½®å¤´åƒé¢„è§ˆå…ƒç´ ');
                    }
                    
                    // æ¸…ç†ç¾¤èŠè®¾ç½®ç›¸å…³çš„æ ‡å¿—
                    window.isSelectingGroupAvatar = false;
                    window.currentAvatarGroup = null;
                } else {
                    // åˆ›å»ºç¾¤èŠæ—¶çš„å¤´åƒé€‰æ‹©ï¼ˆåŸé€»è¾‘ï¼‰
                    const previewElement = document.getElementById('group_avatar_preview');
                    const textElement = document.querySelector('.group-avatar-text');
                    
                    if (!previewElement || !textElement) {
                        console.error('æ‰¾ä¸åˆ°åˆ›å»ºç¾¤èŠå¤´åƒé¢„è§ˆå…ƒç´ ');
                        closeAvatarSelector();
                        return;
                    }
                    
                    if (window.selectedAvatarData.type === 'preset') {
                        // é¢„è®¾å¤´åƒ
                        const gradient = window.selectedAvatarData.gradient;
                        previewElement.style.background = `linear-gradient(135deg, ${gradient.start}, ${gradient.end})`;
                        previewElement.style.backgroundImage = 'none';
                        previewElement.innerHTML = `<div class="default-group-avatar">${window.selectedAvatarData.text}</div>`;
                        textElement.textContent = 'å·²è®¾ç½®é¢„è®¾å¤´åƒ';
                    } else if (window.selectedAvatarData.type === 'upload') {
                        // ä¸Šä¼ çš„å¤´åƒ
                        previewElement.style.background = 'none';
                        previewElement.style.backgroundImage = `url('${window.selectedAvatarData.imageData}')`;
                        previewElement.style.backgroundSize = 'cover';
                        previewElement.style.backgroundPosition = 'center';
                        previewElement.innerHTML = '';
                        textElement.textContent = 'å·²è®¾ç½®è‡ªå®šä¹‰å¤´åƒ';
                    }
                    
                    console.log('åˆ›å»ºç¾¤èŠå¤´åƒé¢„è§ˆå·²æ›´æ–°');
                }
                
                console.log('å¤´åƒè®¾ç½®æˆåŠŸï¼Œå…³é—­é€‰æ‹©å™¨');
                closeAvatarSelector();
            }

            // ==================== ç¾¤èŠåŠŸèƒ½å¢å¼º ====================
            
            /**
             * æ”¹è¿›çš„ç¾¤èŠåˆ›å»ºåŠŸèƒ½ï¼ˆå¸¦å¤´åƒæ”¯æŒï¼‰
             */
            // æ—§çš„createGroupChatå‡½æ•°å·²ç§»é™¤ï¼Œç°åœ¨ä½¿ç”¨window.createGroupChatï¼ˆä¸–ç•Œä¹¦é€»è¾‘ï¼‰
            
            /**
             * æ£€æŸ¥ä¸–ç•Œä¹¦ä¸­çš„ç¾¤èŠå†…å®¹
             */
            function checkWorldbookGroups() {
                console.log('=== æ£€æŸ¥ä¸–ç•Œä¹¦ä¸­çš„ç‹¬ç«‹ç¾¤èŠæ¡ç›® ===');
                
                if (!entries) {
                    console.log('entriesæœªå®šä¹‰ï¼Œæ— æ³•æ£€æŸ¥ç¾¤èŠ');
                    return;
                }
                
                // æŸ¥æ‰¾æ‰€æœ‰ç¾¤èŠæ¡ç›®
                const groupEntries = entries.filter(e => e.comment === "æ‰‹æœº-ç¾¤èŠ" || (e.key && typeof e.key === 'string' && e.key.startsWith("æ‰‹æœº-ç¾¤èŠ-")));
                console.log(`æ‰¾åˆ° ${groupEntries.length} ä¸ªç‹¬ç«‹ç¾¤èŠæ¡ç›®:`);
                
                groupEntries.forEach((entry, index) => {
                    console.log(`ç¾¤èŠæ¡ç›® ${index + 1}:`);
                    console.log('  - Key:', entry.key);
                    console.log('  - Comment:', entry.comment);
                    console.log('  - Content:', entry.content);
                    
                    // è§£æç¾¤èŠä¿¡æ¯
                    const lines = entry.content.split('\n');
                    let groupName = '';
                    let members = [];
                    let avatar = '';
                    
                    for (const line of lines) {
                        const trimmed = line.trim();
                        if (trimmed.startsWith('[') && trimmed.endsWith(']')) {
                            groupName = trimmed.slice(1, -1);
                        } else if (trimmed.startsWith('æˆå‘˜=')) {
                            members = trimmed.substring(3).split(',').map(m => m.trim());
                        } else if (trimmed.startsWith('å¤´åƒ=')) {
                            avatar = trimmed.substring(3);
                        }
                    }
                    
                    console.log(`  - ç¾¤èŠåç§°: ${groupName}`);
                    console.log(`  - æˆå‘˜: ${members.join(', ')}`);
                    console.log(`  - å¤´åƒ: ${avatar}`);
                });
            }

            /**
             * æ¸…ç†é‡å¤çš„ç¾¤èŠï¼ˆå·²ç¦ç”¨ï¼Œå…è®¸åŒåç¾¤èŠå­˜åœ¨ï¼‰
             */
            async function cleanupDuplicateGroups() {
                console.log('ç¾¤èŠé‡å¤æ¸…ç†åŠŸèƒ½å·²ç¦ç”¨ï¼Œå…è®¸åŒåç¾¤èŠå­˜åœ¨');
                return; // ç¦ç”¨æ­¤å‡½æ•°ï¼Œå…è®¸åŒåç¾¤èŠ
                
                console.log('å¼€å§‹æ¸…ç†é‡å¤ç¾¤èŠ');
                
                // *** ä¿®å¤ï¼šä½¿ç”¨ç¼“å­˜çš„ç¾¤èŠå…ƒæ•°æ®è¿›è¡Œæ¸…ç† ***
                const groups = window.QQ_Group_Chats_Data || [];
                const uniqueGroups = [];
                const seenNames = new Set();
                
                for (const group of groups) {
                    if (!seenNames.has(group.name)) {
                        seenNames.add(group.name);
                        uniqueGroups.push(group);
                    } else {
                        console.log(`åˆ é™¤é‡å¤ç¾¤èŠ: ${group.name} (ID: ${group.id})`);
                    }
                }
                
                if (uniqueGroups.length !== groups.length) {
                    // æ–°ç‰ˆæœ¬ï¼šä¸å†ä½¿ç”¨localStorageï¼Œç¾¤èŠæ•°æ®åœ¨ä¸–ç•Œä¹¦ä¸­ç®¡ç†
                    console.log(`æ¸…ç†å®Œæˆï¼Œä» ${groups.length} ä¸ªç¾¤èŠå‡å°‘åˆ° ${uniqueGroups.length} ä¸ª`);
                }
                
                // æ¸…ç†ç•Œé¢ä¸­çš„é‡å¤ç¾¤èŠå…ƒç´ 
                const contactsContainer = document.getElementById('QQ_home_chars');
                if (contactsContainer) {
                    const groupElements = contactsContainer.querySelectorAll('[data-group-type="true"]');
                    const seenGroupNames = new Set();
                    
                    groupElements.forEach(element => {
                        const nameElement = element.querySelector('.QQ_home_name');
                        if (nameElement) {
                            const groupName = nameElement.textContent.trim();
                            if (seenGroupNames.has(groupName)) {
                                console.log(`åˆ é™¤é‡å¤çš„ç¾¤èŠç•Œé¢å…ƒç´ : ${groupName}`);
                                element.remove();
                            } else {
                                seenGroupNames.add(groupName);
                            }
                        }
                    });
                }
                
                // æ¸…ç†æ¶ˆæ¯åˆ—è¡¨ä¸­çš„é‡å¤ç¾¤èŠå…ƒç´ 
                const messagesContainer = document.getElementById('QQ_message_list_chars');
                if (messagesContainer) {
                    const groupElements = messagesContainer.querySelectorAll('[data-group-type="true"]');
                    const seenGroupNames = new Set();
                    
                    groupElements.forEach(element => {
                        const nameElement = element.querySelector('.QQ_home_name');
                        if (nameElement) {
                            const groupName = nameElement.textContent.trim();
                            if (seenGroupNames.has(groupName)) {
                                console.log(`åˆ é™¤é‡å¤çš„ç¾¤èŠæ¶ˆæ¯å…ƒç´ : ${groupName}`);
                                element.remove();
                            } else {
                                seenGroupNames.add(groupName);
                            }
                        }
                    });
                }
            }

            /**
             * å°†ç¾¤èŠæ·»åŠ åˆ°ä¸–ç•Œä¹¦
             */
            async function addGroupToWorldbook(groupData) {
                try {
                    console.log('=== å¼€å§‹å°†ç¾¤èŠæ·»åŠ åˆ°ç‹¬ç«‹çš„ä¸–ç•Œä¹¦æ¡ç›® ===');
                    console.log('ç¾¤èŠæ•°æ®:', groupData);
                    
                    // ä½¿ç”¨ä¸åŠ¨æ€å†…å®¹å­˜å‚¨ç›¸åŒçš„ç®€å•æ£€æŸ¥
                    if (!worldbook || !entries) {
                        console.warn('ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨ï¼Œæ— æ³•æ·»åŠ ç¾¤èŠåˆ°ä¸–ç•Œä¹¦');
                            return false;
                    }
                    
                    // å®šä¹‰uniqueCommentå˜é‡åœ¨å‡½æ•°å¼€å¤´ï¼Œç¡®ä¿åœ¨æ‰€æœ‰åˆ†æ”¯ä¸­éƒ½å¯ç”¨
                    const uniqueComment = `æ‰‹æœº-ç¾¤èŠ-${groupData.name}`;
                    
                    // æŸ¥æ‰¾ç°æœ‰çš„ç¾¤èŠæ¡ç›®
                    let groupEntry = null;
                    const groupEntryKey = `æ‰‹æœº-ç¾¤èŠ-${groupData.name}`;
                    
                    groupEntry = entries.find(e => 
                        e.comment === "æ‰‹æœº-ç¾¤èŠ" && e.content && e.content.includes(`[${groupData.name}]`)
                    );
                    
                    // æ„å»ºç¾¤èŠæ¡ç›®å†…å®¹ - æ™ºèƒ½å¤´åƒæ··åˆå­˜å‚¨æ–¹æ¡ˆ
                    let avatarReference = 'http://sharkpan.xyz/f/z0WU5/mmexport1736971020657.gif';
                    
                    if (groupData.avatar) {
                        console.log('å¼€å§‹å¤„ç†å¤´åƒæ•°æ®ï¼Œç±»å‹:', typeof groupData.avatar);
                        
                        if (typeof groupData.avatar === 'string') {
                            // ç›´æ¥çš„å­—ç¬¦ä¸²æ ¼å¼ï¼ˆå¯èƒ½æ˜¯base64æˆ–URLï¼‰
                            if (groupData.avatar.startsWith('data:')) {
                                // Base64å›¾åƒæ•°æ®ï¼Œä½¿ç”¨IndexedDBæˆ–ç›´æ¥å­˜å‚¨åœ¨ä¸–ç•Œä¹¦ä¸­
                                try {
                                    // å°†base64ç›´æ¥å­˜å‚¨åœ¨ä¸–ç•Œä¹¦ä¸­ï¼Œé¿å…localStorageé™åˆ¶
                                    avatarReference = groupData.avatar; // ç›´æ¥ä½¿ç”¨base64
                                    console.log('Base64å¤´åƒç›´æ¥å­˜å‚¨åœ¨ä¸–ç•Œä¹¦ä¸­ï¼Œé•¿åº¦:', groupData.avatar.length);
                                } catch (e) {
                                    console.warn('å¤´åƒå¤„ç†å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ:', e);
                                    avatarReference = 'http://sharkpan.xyz/f/z0WU5/mmexport1736971020657.gif';
                                }
                            } else if (groupData.avatar.startsWith('http://') || groupData.avatar.startsWith('https://')) {
                                // ç½‘ç»œURLï¼Œç›´æ¥ä½¿ç”¨
                                avatarReference = groupData.avatar;
                                console.log('ä½¿ç”¨ç½‘ç»œé“¾æ¥å¤´åƒ:', avatarReference);
                            } else if (groupData.avatar.startsWith('avatar_')) {
                                // å·²ç»æ˜¯å¤´åƒIDå¼•ç”¨ï¼Œç›´æ¥ä½¿ç”¨
                                avatarReference = groupData.avatar;
                                console.log('ä½¿ç”¨å·²æœ‰çš„å¤´åƒIDå¼•ç”¨:', avatarReference);
                            } else {
                                console.log('æœªè¯†åˆ«çš„å¤´åƒæ ¼å¼ï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ');
                                avatarReference = 'http://sharkpan.xyz/f/z0WU5/mmexport1736971020657.gif';
                            }
                        } else if (typeof groupData.avatar === 'object') {
                            // å¯¹è±¡æ ¼å¼çš„å¤´åƒæ•°æ®
                            if (groupData.avatar.type === 'url' && groupData.avatar.url) {
                                // ç½‘ç»œé“¾æ¥
                                avatarReference = groupData.avatar.url;
                                console.log('ä½¿ç”¨ç½‘ç»œé“¾æ¥å¤´åƒ:', avatarReference);
                            } else if (groupData.avatar.type === 'upload') {
                                if (groupData.avatar.avatarId) {
                                    // å·²æœ‰çš„å¤´åƒIDå¼•ç”¨
                                    avatarReference = groupData.avatar.avatarId;
                                    console.log('ä½¿ç”¨å¤´åƒIDå¼•ç”¨:', avatarReference);
                                } else if (groupData.avatar.imageData) {
                                    if (groupData.avatar.imageData.startsWith('data:')) {
                                        // Base64æ•°æ®ï¼Œç›´æ¥å­˜å‚¨
                                        try {
                                            avatarReference = groupData.avatar.imageData; // ç›´æ¥ä½¿ç”¨base64
                                            console.log('Base64å¤´åƒç›´æ¥å­˜å‚¨ï¼Œé•¿åº¦:', groupData.avatar.imageData.length);
                                        } catch (e) {
                                            console.warn('å¤´åƒå¤„ç†å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ:', e);
                                            avatarReference = 'http://sharkpan.xyz/f/z0WU5/mmexport1736971020657.gif';
                                        }
                                    } else if (groupData.avatar.imageData.startsWith('http://') || groupData.avatar.imageData.startsWith('https://')) {
                                        // ç½‘ç»œé“¾æ¥
                                        avatarReference = groupData.avatar.imageData;
                                        console.log('ä½¿ç”¨ç½‘ç»œé“¾æ¥å¤´åƒ:', avatarReference);
                                    } else {
                                        console.log('æœªè¯†åˆ«çš„imageDataæ ¼å¼ï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ');
                                        avatarReference = 'http://sharkpan.xyz/f/z0WU5/mmexport1736971020657.gif';
                                    }
                                } else {
                                    console.log('uploadç±»å‹ä½†æ— æœ‰æ•ˆæ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ');
                                    avatarReference = 'http://sharkpan.xyz/f/z0WU5/mmexport1736971020657.gif';
                                }
                            } else {
                                console.log('æœªè¯†åˆ«çš„å¤´åƒå¯¹è±¡ç±»å‹ï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ');
                                avatarReference = 'http://sharkpan.xyz/f/z0WU5/mmexport1736971020657.gif';
                            }
                        } else {
                            console.log('æœªè¯†åˆ«çš„å¤´åƒæ•°æ®ç±»å‹ï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ');
                            avatarReference = 'http://sharkpan.xyz/f/z0WU5/mmexport1736971020657.gif';
                        }
                    } else {
                        console.log('æ— å¤´åƒæ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ');
                    }
                    
                    console.log('æœ€ç»ˆå¤´åƒå¼•ç”¨:', avatarReference);
                    
                    const groupContent = `[${groupData.name}]
ç±»å‹=ç¾¤èŠ
æˆå‘˜=${groupData.members.join(',')}
å¤´åƒ=${avatarReference}`;
                    
                    if (groupEntry) {
                        // æ›´æ–°ç°æœ‰æ¡ç›®
                        console.log('æ›´æ–°ç°æœ‰ç¾¤èŠæ¡ç›®:', groupEntry.uid);
                        await setLorebookEntries(worldbook, [
                            {
                                uid: groupEntry.uid,
                                content: groupContent,
                            }
                        ]);
                    } else {
                        // åˆ›å»ºæ–°çš„ç‹¬ç«‹ç¾¤èŠæ¡ç›®
                        console.log('åˆ›å»ºæ–°çš„ç‹¬ç«‹ç¾¤èŠæ¡ç›®');
                        
                        // ä½¿ç”¨æ­£ç¡®çš„createLorebookEntryå‡½æ•°ï¼Œéµå¾ªé¡¹ç›®æ ‡å‡†è®¾å®š
                        console.log('å‡†å¤‡è°ƒç”¨createLorebookEntryï¼Œå‚æ•°:', { worldbook, uniqueComment, groupContent });
                        const createResult = await createLorebookEntry(worldbook, {
                            comment: uniqueComment, // ä½¿ç”¨å”¯ä¸€çš„commentæ ‡è¯†ç¾¤èŠ
                            key: ["æ­¤ä¸–ç•Œä¹¦æ°¸ä¸è§¦å‘"], // ä½¿ç”¨æ ‡å‡†çš„æ°¸ä¸è§¦å‘å…³é”®è¯ï¼Œä¸æ‰‹æœº-è§’è‰²ä¿æŒä¸€è‡´
                            content: groupContent,
                            position: "at_depth_as_system",
                            type: "selective", // ç»¿ç¯ï¼šé€‰æ‹©æ€§è§¦å‘
                            depth: 4, // æ·±åº¦4ï¼Œä¸å…¶ä»–æ‰‹æœºæ ¼å¼ä¿æŒä¸€è‡´
                            exclude_recursion: true, // æ’é™¤é€’å½’ï¼Œéµå¾ªé¡¹ç›®æ ‡å‡†
                            order: 6000, // é¡ºåº6000ï¼Œé«˜äºæ ¼å¼æ¡ç›®ï¼ˆ5560-5564ï¼‰
                            enabled: true,
                        });
                        console.log('createLorebookEntryè°ƒç”¨ç»“æœ:', createResult);
                        
                        // è§¦å‘ä¸–ç•Œä¹¦ä¿å­˜
                        await QQ_SafeSaveWorldInfo("ç¾¤èŠåˆ›å»ºæ•°æ®");
                    }
                    
                    console.log('ç¾¤èŠå·²æˆåŠŸæ·»åŠ åˆ°ç‹¬ç«‹çš„ä¸–ç•Œä¹¦æ¡ç›®');
                    
                    return true;
                } catch (error) {
                    console.error('æ·»åŠ ç¾¤èŠåˆ°ä¸–ç•Œä¹¦å¤±è´¥:', error);
                    return false;
                }
            }
            
            /**
             * æ›´æ–°ç¾¤èŠæˆå‘˜åˆ°ä¸–ç•Œä¹¦
             */
            async function updateGroupMembersInWorldbook(groupName, members) {
                try {
                    console.log('æ›´æ–°ç¾¤èŠæˆå‘˜åˆ°ç‹¬ç«‹ä¸–ç•Œä¹¦æ¡ç›®:', groupName, members);
                    
                    // æŸ¥æ‰¾å¯¹åº”çš„ç¾¤èŠæ¡ç›® - ä½¿ç”¨å”¯ä¸€commentæŸ¥æ‰¾
                    let groupEntry = null;
                    const uniqueComment = `æ‰‹æœº-ç¾¤èŠ-${groupName}`;
                    
                    if (entries) {
                        groupEntry = entries.find(e => 
                            e.comment === uniqueComment
                        );
                    }
                    
                    if (!groupEntry) {
                        console.error('åœ¨ä¸–ç•Œä¹¦ä¸­æœªæ‰¾åˆ°ç¾¤èŠæ¡ç›®:', groupName);
                        return false;
                    }
                    
                    // è§£æç°æœ‰å†…å®¹
                    let content = groupEntry.content;
                    const lines = content.split('\n');
                    let updatedContent = '';
                    
                    // ä¿ç•™å…¶ä»–å±æ€§ï¼Œæ›´æ–°æˆå‘˜åˆ—è¡¨
                    let hasMembersLine = false;
                    for (const line of lines) {
                        if (line.startsWith('æˆå‘˜=')) {
                            updatedContent += `æˆå‘˜=${members.join(',')}\n`;
                            hasMembersLine = true;
                        } else if (line.trim()) {
                            updatedContent += line + '\n';
                        }
                    }
                    
                    // å¦‚æœæ²¡æœ‰æˆå‘˜è¡Œï¼Œæ·»åŠ ä¸€ä¸ª
                    if (!hasMembersLine) {
                        updatedContent += `æˆå‘˜=${members.join(',')}\n`;
                    }
                    
                    // æ›´æ–°ä¸–ç•Œä¹¦
                    await setLorebookEntries(worldbook, [
                        {
                            uid: groupEntry.uid,
                            content: updatedContent.trim(),
                        }
                    ]);
                    
                    // é‡æ–°åŠ è½½entriesä»¥æ›´æ–°æœ¬åœ°æ•°æ®
                    entries = await getLorebookEntries(worldbook);
                    
                    // åŒæ­¥æ›´æ–°æœ¬åœ°æ•°æ®ç»“æ„
                    if (QQ_msgjson.ç¾¤èŠ[groupName]) {
                        QQ_msgjson.ç¾¤èŠ[groupName].members = members;
                        console.log('å·²åŒæ­¥æ›´æ–° QQ_msgjson.ç¾¤èŠ ä¸­çš„æˆå‘˜åˆ—è¡¨');
                    }
                    
                    console.log('ç¾¤èŠæˆå‘˜å·²æ›´æ–°åˆ°ç‹¬ç«‹ä¸–ç•Œä¹¦æ¡ç›®å¹¶åŒæ­¥æœ¬åœ°æ•°æ®');
                    return true;
                } catch (error) {
                    console.error('æ›´æ–°ç¾¤èŠæˆå‘˜åˆ°ä¸–ç•Œä¹¦å¤±è´¥:', error);
                    return false;
                }
            }

            /**
             * æ›´æ–°ç¾¤èŠåç§°åˆ°ä¸–ç•Œä¹¦ï¼ˆè¶…å®‰å…¨æ¨¡å¼ï¼šå…ˆåˆ›å»ºæ–°æ¡ç›®ï¼Œç¡®è®¤æˆåŠŸåå†åˆ é™¤æ—§æ¡ç›®ï¼‰
             */
            async function updateGroupNameInWorldbook(oldName, newName) {
                try {
                    console.log('æ›´æ–°ç¾¤èŠåç§°åˆ°ä¸–ç•Œä¹¦ï¼ˆç®€åŒ–ç‰ˆï¼‰:', oldName, '->', newName);
                    
                    // ä½¿ç”¨ä¸åŠ¨æ€å†…å®¹å­˜å‚¨ç›¸åŒçš„ç®€å•æ£€æŸ¥
                    if (!worldbook || !entries) {
                        console.warn('ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨ï¼Œæ— æ³•æ›´æ–°ç¾¤èŠåç§°');
                            return false;
                    }
                    
                    // 1. æŸ¥æ‰¾æ—§ç¾¤èŠæ¡ç›® - ä½¿ç”¨å”¯ä¸€commentæŸ¥æ‰¾
                    let oldGroupEntry = null;
                    const oldUniqueComment = `æ‰‹æœº-ç¾¤èŠ-${oldName}`;
                    
                    if (entries) {
                        oldGroupEntry = entries.find(e => 
                            e.comment === oldUniqueComment
                        );
                    }
                    
                    if (!oldGroupEntry) {
                        console.error('åœ¨ä¸–ç•Œä¹¦ä¸­æœªæ‰¾åˆ°ç¾¤èŠæ¡ç›®:', oldName);
                        console.error('å½“å‰æ‰€æœ‰ç¾¤èŠç›¸å…³æ¡ç›®:');
                        if (entries) {
                            entries.filter(e => e.comment.startsWith("æ‰‹æœº-ç¾¤èŠ")).forEach((e, i) => {
                                console.error(`ç¾¤èŠæ¡ç›® ${i}:`, {
                                    uid: e.uid,
                                    key: e.key,
                                    comment: e.comment,
                                    content: e.content?.substring(0, 100) + '...'
                                });
                            });
                        }
                        throw new Error(`æ‰¾ä¸åˆ°è¦æ›´æ–°çš„ç¾¤èŠæ¡ç›®: ${oldName}`);
                    }
                    
                    // 2. å¤‡ä»½æ—§æ¡ç›®çš„æ‰€æœ‰ä¿¡æ¯
                    const backupContent = oldGroupEntry.content;
                    const backupMembers = extractMembersFromContent(backupContent);
                    const backupAvatar = extractAvatarFromContent(backupContent);
                    
                    console.log('å¤‡ä»½çš„ç¾¤èŠä¿¡æ¯:', { backupMembers, backupAvatar });
                    
                    // 3. åˆ›å»ºæ–°å†…å®¹ï¼Œåªæ›¿æ¢ç¾¤èŠåç§°
                    const newContent = `[${newName}]
ç±»å‹=ç¾¤èŠ
æˆå‘˜=${backupMembers}
å¤´åƒ=${backupAvatar}`;
                    
                    // 4. ç›´æ¥åœ¨åŸæ¡ç›®ä¸Šæ›´æ–°å†…å®¹ã€commentå’Œkeyï¼ˆé¿å…åˆ›å»ºæ–°æ¡ç›®çš„å¤æ‚æ€§ï¼‰
                    const newUniqueComment = `æ‰‹æœº-ç¾¤èŠ-${newName}`;
                    const newGroupEntryKey = `æ‰‹æœº-ç¾¤èŠ-${newName}`;
                    
                    console.log('ç›´æ¥æ›´æ–°ç°æœ‰æ¡ç›®:', oldGroupEntry.uid);
                    console.log('æ–°comment:', newUniqueComment);
                    console.log('æ–°key:', [newGroupEntryKey]);
                    console.log('æ–°å†…å®¹:', newContent.substring(0, 100) + '...');
                    
                    // ä½¿ç”¨setLorebookEntriesæ›´æ–°ç°æœ‰æ¡ç›®çš„commentã€keyå’Œcontent
                    await setLorebookEntries(worldbook, [
                        {
                            uid: oldGroupEntry.uid,
                            comment: newUniqueComment,
                            key: [newGroupEntryKey],
                            content: newContent
                        }
                    ]);
                    
                    console.log('ç¾¤èŠæ¡ç›®æ›´æ–°æˆåŠŸ');
                    
                    // 5. é‡æ–°åŠ è½½entriesä»¥æ›´æ–°æœ¬åœ°æ•°æ®
                    entries = await getLorebookEntries(worldbook);
                    
                    // 6. åŒæ­¥æ›´æ–°æ‰€æœ‰ç›¸å…³çš„æ•°æ®ç»“æ„
                    console.log('å¼€å§‹åŒæ­¥æ›´æ–°ç›¸å…³æ•°æ®ç»“æ„...');
                    
                    // æ›´æ–° QQ_Groups æ•°ç»„
                    const oldNameIndex = QQ_Groups.indexOf(oldName);
                    if (oldNameIndex !== -1) {
                        QQ_Groups[oldNameIndex] = newName;
                        console.log('å·²æ›´æ–° QQ_Groups æ•°ç»„:', QQ_Groups);
                    }
                    
                    // æ›´æ–° QQ_msgjson.ç¾¤èŠ ä¸­çš„æ¶ˆæ¯è®°å½•
                    if (QQ_msgjson.ç¾¤èŠ[oldName]) {
                        QQ_msgjson.ç¾¤èŠ[newName] = QQ_msgjson.ç¾¤èŠ[oldName];
                        delete QQ_msgjson.ç¾¤èŠ[oldName];
                        console.log('å·²è¿ç§»ç¾¤èŠæ¶ˆæ¯è®°å½•:', oldName, '->', newName);
                    }
                    
                    // é‡è¦ï¼šç¡®ä¿QQ_msgjson.ç¾¤èŠ[newName]ç»“æ„æ­£ç¡®
                    if (!QQ_msgjson.ç¾¤èŠ[newName]) {
                        QQ_msgjson.ç¾¤èŠ[newName] = {
                            members: backupMembers.split(',').map(m => m.trim()),
                            msgs: []
                        };
                        console.log('é‡æ–°åˆå§‹åŒ–QQ_msgjson.ç¾¤èŠæ•°æ®:', newName);
                    }
                    
                    // *** ä¿®å¤ï¼šç”Ÿæˆç¨³å®šçš„ç¾¤èŠIDï¼ŒåŸºäºåŸå§‹åç§° ***
                    const originalGroupName = oldUniqueComment.replace('æ‰‹æœº-ç¾¤èŠ-', '');
                    const stableGroupId = `group_${originalGroupName.replace(/[^a-zA-Z0-9\u4e00-\u9fff]/g, '_')}`;
                    console.log('ä¸ºç¾¤èŠç”Ÿæˆç¨³å®šID:', stableGroupId, '(åŸºäºåŸå§‹åç§°:', originalGroupName, ')');
                    
                    // æ›´æ–°ç•Œé¢å…ƒç´ çš„ data å±æ€§ï¼ˆåç§°æ›´æ–°ï¼Œä½†IDä¿æŒç¨³å®šï¼‰
                    document.querySelectorAll(`[data-group-name="${oldName}"]`).forEach(element => {
                        element.setAttribute('data-group-name', newName);
                        // ç¡®ä¿ä½¿ç”¨ç¨³å®šçš„ç¾¤èŠID
                        if (element.hasAttribute('data-group-id')) {
                            element.setAttribute('data-group-id', stableGroupId);
                        }
                        console.log('å·²æ›´æ–°ç•Œé¢å…ƒç´  data-group-name å’Œ data-group-id å±æ€§');
                    });
                    
                    // æ›´æ–°ç¾¤èŠé¡µé¢çš„ data å±æ€§
                    document.querySelectorAll(`[data-name="${oldName}"]`).forEach(element => {
                        element.setAttribute('data-name', newName);
                        // ç¡®ä¿ä½¿ç”¨ç¨³å®šçš„ç¾¤èŠID
                        if (element.hasAttribute('data-group-id')) {
                            element.setAttribute('data-group-id', stableGroupId);
                        }
                        console.log('å·²æ›´æ–°ç¾¤èŠé¡µé¢ data-name å’Œ data-group-id å±æ€§');
                    });
                    
                    console.log('ç¾¤èŠåç§°å·²æˆåŠŸæ›´æ–°åˆ°ä¸–ç•Œä¹¦å¹¶åŒæ­¥æ‰€æœ‰ç›¸å…³æ•°æ® (å®Œæ•´ç‰ˆ)');
                    return true;
                    
                } catch (error) {
                    console.error('æ›´æ–°ç¾¤èŠåç§°åˆ°ä¸–ç•Œä¹¦å¤±è´¥:', error);
                    return false;
                }
            }
            
            /**
             * ä»æ¡ç›®å†…å®¹ä¸­æå–æˆå‘˜åˆ—è¡¨
             */
            function extractMembersFromContent(content) {
                const memberMatch = content.match(/æˆå‘˜=(.+)/);
                return memberMatch ? memberMatch[1] : '';
            }
            
            /**
             * ä»æ¡ç›®å†…å®¹ä¸­æå–å¤´åƒä¿¡æ¯
             */
            function extractAvatarFromContent(content) {
                const avatarMatch = content.match(/å¤´åƒ=(.+)/);
                return avatarMatch ? avatarMatch[1] : 'http://sharkpan.xyz/f/z0WU5/mmexport1736971020657.gif';
            }

            /**
             * ä»ä¸–ç•Œä¹¦ä¸­åˆ é™¤ç¾¤èŠ
             */
            async function removeGroupFromWorldbook(groupName) {
                try {
                    console.log('å¼€å§‹ä»ç‹¬ç«‹ä¸–ç•Œä¹¦æ¡ç›®ä¸­åˆ é™¤ç¾¤èŠ:', groupName);
                    
                    // æŸ¥æ‰¾å¯¹åº”çš„ç¾¤èŠæ¡ç›® - ä½¿ç”¨å”¯ä¸€commentæŸ¥æ‰¾
                    let groupEntry = null;
                    let groupIndex = -1;
                    const uniqueComment = `æ‰‹æœº-ç¾¤èŠ-${groupName}`;
                    
                    if (entries) {
                        groupIndex = entries.findIndex(e => e.comment === uniqueComment);
                        if (groupIndex >= 0) {
                            groupEntry = entries[groupIndex];
                        }
                    }
                    
                    if (!groupEntry) {
                        console.error('åœ¨ä¸–ç•Œä¹¦ä¸­æœªæ‰¾åˆ°ç¾¤èŠæ¡ç›®:', groupName);
                        return false;
                    }
                    
                    // åˆ é™¤ä¸–ç•Œä¹¦æ¡ç›®
                    await deleteLorebookEntry(worldbook, groupEntry.uid);
                    
                    // ä»æœ¬åœ°entriesæ•°ç»„ä¸­ç§»é™¤
                    if (groupIndex >= 0 && entries) {
                        entries.splice(groupIndex, 1);
                    }
                    
                    console.log('ç¾¤èŠå·²ä»ç‹¬ç«‹ä¸–ç•Œä¹¦æ¡ç›®ä¸­åˆ é™¤');
                    return true;
                } catch (error) {
                    console.error('ä»ä¸–ç•Œä¹¦ä¸­åˆ é™¤ç¾¤èŠå¤±è´¥:', error);
                    return false;
                }
            }


            
            /**
             * åˆ‡æ¢åˆ°ç¾¤èŠç•Œé¢
             */
            function switchToGroupChat(groupData) {
                console.log('åˆ‡æ¢åˆ°ç¾¤èŠ:', groupData.name);
                console.log('ç¾¤èŠæˆå‘˜:', groupData.members);
                
                // è®¾ç½®å½“å‰æ´»è·ƒçš„ç¾¤èŠ
                window.currentGroupChat = groupData;
                
                // åˆ‡æ¢åˆ°èŠå¤©ç•Œé¢
                QQ_Nav('chat');
                
                // å»¶è¿Ÿæ›´æ–°ï¼Œç¡®ä¿é¡µé¢å·²ç»åˆ‡æ¢
                setTimeout(() => {
                    // ç¡®ä¿ç¾¤èŠé¡µé¢å­˜åœ¨ä¸”æ˜¯ç‹¬ç«‹çš„
                    ensureGroupChatPage(groupData);
                    
                    // æ›´æ–°èŠå¤©ç•Œé¢çš„å¤´éƒ¨ä¿¡æ¯
                    updateChatHeader(groupData);
                    
                    // åŠ è½½ç¾¤èŠæ¶ˆæ¯å†å²
                    loadGroupChatHistory(groupData.id);
                    
                    // æ›´æ–°èŠå¤©åŒºåŸŸçš„æ ‡é¢˜
                    const chatUsername = document.getElementById('QQ_chat_username');
                    if (chatUsername) {
                        chatUsername.textContent = groupData.name;
                    }
                }, 100);
            }
            
            /**
             * ç¡®ä¿ç¾¤èŠé¡µé¢å­˜åœ¨ä¸”ç‹¬ç«‹
             */
            function ensureGroupChatPage(groupData) {
                console.log('ç¡®ä¿ç¾¤èŠé¡µé¢å­˜åœ¨:', groupData.name, 'ID:', groupData.id);
                
                // éšè—æ‰€æœ‰ç°æœ‰çš„èŠå¤©é¡µé¢
                $('.QQ_chat_page').hide();
                
                // æŸ¥æ‰¾ç°æœ‰çš„ç¾¤èŠé¡µé¢
                let groupChatPage = $(`.QQ_chat_page[data-group-id="${groupData.id}"]`);
                
                if (groupChatPage.length === 0) {
                    console.log('åˆ›å»ºæ–°çš„ç¾¤èŠé¡µé¢:', groupData.name);
                    // åˆ›å»ºæ–°çš„ç¾¤èŠé¡µé¢
                    groupChatPage = createGroupChatPage(groupData);
                    $('#App_QQ').append(groupChatPage);
                } else {
                    console.log('ä½¿ç”¨ç°æœ‰ç¾¤èŠé¡µé¢:', groupData.name);
                }
                
                // æ˜¾ç¤ºå½“å‰ç¾¤èŠé¡µé¢
                groupChatPage.show();
                
                return groupChatPage;
            }
            
            /**
             * åˆ›å»ºç¾¤èŠä¸“ç”¨é¡µé¢
             */
            function createGroupChatPage(groupData) {
                console.log('åˆ›å»ºç¾¤èŠä¸“ç”¨é¡µé¢:', groupData.name);
                
                const pageHTML = `
                    <div class="QQ_chat_page group-chat-page" data-group-id="${groupData.id}" data-name="${groupData.name}" style="display: none;">
                        <div class="QQ_chat_head" style="display: flex; align-items: center; padding: 10px; background: white; border-bottom: 1px solid #eee;">
                            <div class="QQ_chat_head_back" style="margin-right: 15px; cursor: pointer;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                    <path d="M15 18L9 12L15 6" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="QQ_chat_head_avatar" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; background: linear-gradient(135deg, #199AFF, #0066CC); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">ç¾¤</div>
                            <div style="flex: 1;">
                                <span id="QQ_chat_username" class="group-chat-clickable-name" style="font-size: 16px; font-weight: bold; cursor: pointer;">${groupData.name}</span>
                                <div style="font-size: 12px; color: #999; margin-top: 2px;">ç¾¤èŠ Â· ${groupData.members.length}äºº</div>
                            </div>
                        </div>
                        <div class="msgcontent" style="flex: 1; overflow-y: auto; padding: 10px; background: #f5f5f5;">
                            <!-- ç¾¤èŠæ¶ˆæ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                        <div class="QQ_chat_input_area" style="padding: 10px; background: white; border-top: 1px solid #eee;">
                            <div style="display: flex; align-items: center;">
                                <input type="text" class="group-chat-input userInput" placeholder="è¾“å…¥æ¶ˆæ¯..." style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 20px; outline: none;">
                                <button class="group-chat-send-btn" style="margin-left: 10px; padding: 8px 16px; background: #007AFF; color: white; border: none; border-radius: 20px; cursor: pointer;">å‘é€</button>
                            </div>
                        </div>
                    </div>
                `;
                
                const $page = $(pageHTML);
                
                // ç»‘å®šè¿”å›æŒ‰é’®äº‹ä»¶
                $page.find('.QQ_chat_head_back').on('click', function() {
                    // é‡æ–°æ˜¾ç¤ºåº•éƒ¨å¯¼èˆªæ 
                    $('.QQ_bottom_nav').show();
                    
                    console.log('ç¾¤èŠè¿”å›æŒ‰é’®è¢«ç‚¹å‡»');
                    // æ ¹æ®æ¥æºé¡µé¢è¿”å›
                    const sourcePage = window.groupChatSourcePage || 'contacts';
                    if (sourcePage === 'messages') {
                        QQ_Nav('message');
                    } else {
                        QQ_Nav('people');
                    }
                    // æ¸…é™¤ç¾¤èŠçŠ¶æ€
                    window.currentGroupChat = null;
                });
                
                // ç»‘å®šç¾¤èŠåç§°ç‚¹å‡»äº‹ä»¶
                $page.find('.group-chat-clickable-name').on('click', function() {
                    console.log('ç¾¤èŠåç§°è¢«ç‚¹å‡»:', groupData.name);
                    showGroupManagementMenu(groupData, this);
                });
                
                // ç»‘å®šå‘é€æ¶ˆæ¯äº‹ä»¶
                const $input = $page.find('.group-chat-input');
                const $sendBtn = $page.find('.group-chat-send-btn');
                

                
                // ä¿®æ”¹ä¸ºä¸¤é˜¶æ®µå‘é€æœºåˆ¶ï¼šEnteré”®ç¼“å­˜æ¶ˆæ¯ï¼Œç‚¹å‡»å‘é€æŒ‰é’®æ‰çœŸæ­£å‘é€
                $sendBtn.on('click', function() {
                    // ç‚¹å‡»å‘é€æŒ‰é’®æ—¶ï¼Œä½¿ç”¨QQ_SendMsgå‘é€ç¼“å­˜çš„æ¶ˆæ¯
                    const fakeEvent = { target: $page[0] };
                    QQ_SendMsg(fakeEvent);
                });
                
                // ä½¿ç”¨ç»Ÿä¸€çš„Enteré”®å¤„ç†æœºåˆ¶
                $input.on('keydown', function(e) {
                    QQ_EnterPress(e, this);
                });
                

                
                return $page;
            }
            
            /**
             * æ·»åŠ æ–°ç¾¤èŠï¼ˆç±»ä¼¼AddNewCharï¼‰
             */
            /**
             * åˆ›å»ºæ–°ç¾¤èŠï¼ˆåŸºäºä¸–ç•Œä¹¦ï¼Œç±»ä¼¼ç§èŠé€»è¾‘ï¼‰
             */
            async function createNewGroup(groupName, members, avatarUrl) {
                console.log('=== åˆ›å»ºæ–°ç¾¤èŠå¼€å§‹ ===');
                console.log('ç¾¤èŠåç§°:', groupName);
                console.log('æˆå‘˜åˆ—è¡¨:', members);
                console.log('å¤´åƒURL:', avatarUrl);
                
                try {
                    // 1. æ·»åŠ åˆ°ä¸–ç•Œä¹¦
                    const groupData = {
                        name: groupName,
                        members: members,
                        avatar: {
                            type: 'upload',
                            imageData: avatarUrl || 'http://sharkpan.xyz/f/z0WU5/mmexport1736971020657.gif'
                        }
                    };
                    
                    console.log('å‡†å¤‡è°ƒç”¨addGroupToWorldbookï¼Œæ•°æ®:', groupData);
                    const success = await addGroupToWorldbook(groupData);
                    console.log('addGroupToWorldbookè¿”å›ç»“æœ:', success);
                    
                    if (!success) {
                        throw new Error('æ·»åŠ åˆ°ä¸–ç•Œä¹¦å¤±è´¥');
                    }
                    
                    // ç«‹å³åˆ·æ–°entriesï¼Œç¡®ä¿æ–°åˆ›å»ºçš„ç¾¤èŠèƒ½è¢«åŠ è½½
                    console.log('åˆ·æ–°entriesä»¥åŒ…å«æ–°åˆ›å»ºçš„ç¾¤èŠ');
                    try {
                        entries = await getLorebookEntries(worldbook);
                        console.log('entriesåˆ·æ–°æˆåŠŸï¼Œæ–°çš„æ¡ç›®æ•°é‡:', entries ? entries.length : 'failed');
                    } catch (e) {
                        console.warn('åˆ·æ–°entrieså¤±è´¥ï¼Œä½†ç¾¤èŠå·²åˆ›å»º:', e);
                    }
                    
                    // 2. ç¡®ä¿ç¾¤èŠç«‹å³åŠ å…¥QQ_Groupsæ•°ç»„
                    if (!QQ_Groups.includes(groupName)) {
                        QQ_Groups.push(groupName);
                        console.log(`ç¾¤èŠ "${groupName}" å·²ç«‹å³åŠ å…¥QQ_Groupsæ•°ç»„`);
                    }
                    
                    // 3. ç¡®ä¿QQ_msgjsonä¸­æœ‰è¯¥ç¾¤èŠçš„æ•°æ®ç»“æ„
                    if (!QQ_msgjson.ç¾¤èŠ[groupName]) {
                        QQ_msgjson.ç¾¤èŠ[groupName] = {
                            members: members || [],
                            msgs: []
                        };
                        console.log('åœ¨QQ_msgjson.ç¾¤èŠä¸­åˆå§‹åŒ–ç¾¤èŠæ•°æ®:', groupName);
                    }
                    
                    // *** ä¿®å¤ï¼šå…ˆåˆ›å»ºç•Œé¢ï¼Œå†å¢å¼ºå…ƒæ•°æ® ***
                    console.log('ç«‹å³åˆ›å»ºç¾¤èŠç•Œé¢å¹¶åŠ è½½å…ƒæ•°æ®');
                    
                    // *** å…³é”®ä¿®å¤ï¼šå¯¹äºæ–°åˆ›å»ºçš„ç¾¤èŠï¼Œç¡®ä¿ä¸è¢«è¯¯è®¤ä¸ºå·²åˆå§‹åŒ– ***
                    // ä¸´æ—¶ç§»é™¤åˆå§‹åŒ–æ ‡è®°ï¼Œç¡®ä¿æ–°ç¾¤èŠèƒ½æ­£ç¡®æ·»åŠ åˆå§‹æ¶ˆæ¯
                    if (QQ_GroupInitializedSet.has(groupName)) {
                        console.log(`æ–°åˆ›å»ºç¾¤èŠ ${groupName} è¢«è¯¯æ ‡è®°ä¸ºå·²åˆå§‹åŒ–ï¼Œä¸´æ—¶ç§»é™¤æ ‡è®°`);
                        QQ_GroupInitializedSet.delete(groupName);
                    }
                    
                    // é¦–å…ˆè°ƒç”¨AddNewGroupåˆ›å»ºç•Œé¢å…ƒç´ å’Œåˆå§‹æ¶ˆæ¯
                    const avatarData = groupData.avatar;
                    let finalAvatarUrl = '';
                    if (avatarData && avatarData.imageData) {
                        finalAvatarUrl = avatarData.imageData;
                    } else if (avatarData && typeof avatarData === 'string') {
                        finalAvatarUrl = avatarData;
                    } else {
                        finalAvatarUrl = avatarUrl || QQ_GetRandomAvatar() || 'https://files.catbox.moe/skngqq.jpg';
                    }
                    
                    // *** ä¿®å¤ï¼šç¡®ä¿AddNewGroupå®Œæˆåå†åˆ·æ–°ç•Œé¢ ***
                    AddNewGroup(groupName, finalAvatarUrl, members || [], '');
                    
                    // ç­‰å¾…ç•Œé¢å…ƒç´ åˆ›å»ºå®Œæˆ
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    // ç„¶åè°ƒç”¨å…ƒæ•°æ®å¢å¼ºæ¥æ›´æ–°å¤´åƒç­‰è¯¦ç»†ä¿¡æ¯
                    await QQ_Enhance_Group_Metadata();
                    
                    // *** ä¿®å¤ï¼šç¡®ä¿æ–°åˆ›å»ºçš„ç¾¤èŠç«‹å³æ˜¾ç¤ºåœ¨æ¶ˆæ¯åˆ—è¡¨ä¸­ ***
                    // ä¸ä½¿ç”¨QQ_UpdateMessageListï¼Œè€Œæ˜¯ç›´æ¥å¤åˆ¶æ–°åˆ›å»ºçš„å…ƒç´ åˆ°æ¶ˆæ¯åˆ—è¡¨
                    const newGroupElement = $(`.QQ_home_usermsg[data-name='${groupName}'][data-group-type='true']`);
                    if (newGroupElement.length > 0) {
                        const $messageChars = $("#QQ_message_list_chars");
                        // æ£€æŸ¥æ¶ˆæ¯åˆ—è¡¨ä¸­æ˜¯å¦å·²æœ‰è¯¥ç¾¤èŠ
                        const existingInMessageList = $messageChars.find(`.QQ_home_usermsg[data-name='${groupName}'][data-group-type='true']`);
                        if (existingInMessageList.length === 0) {
                            $messageChars.append(newGroupElement.clone(true));
                            console.log('âœ… æ–°ç¾¤èŠå·²ç«‹å³æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨');
                        }
                    }
                    
                    console.log('ç¾¤èŠåˆ›å»ºæˆåŠŸ:', groupName);
                    console.log('å½“å‰QQ_Groupsæ•°ç»„:', QQ_Groups);
                    return true;
                } catch (error) {
                    console.error('åˆ›å»ºç¾¤èŠå¤±è´¥:', error);
                    toastr.error('åˆ›å»ºç¾¤èŠå¤±è´¥: ' + error.message);
                    return false;
                }
            }
            
            /**
             * åˆ é™¤ç¾¤èŠï¼ˆåŸºäºä¸–ç•Œä¹¦ï¼Œç±»ä¼¼ç§èŠé€»è¾‘ï¼‰
             */
            async function deleteGroupChat(groupName) {
                console.log('åˆ é™¤ç¾¤èŠ:', groupName);
                
                try {
                    // 1. ä»ä¸–ç•Œä¹¦åˆ é™¤
                    const success = await removeGroupFromWorldbook(groupName);
                    if (!success) {
                        throw new Error('ä»ä¸–ç•Œä¹¦åˆ é™¤å¤±è´¥');
                    }
                    
                    // 2. ä»ç•Œé¢åˆ é™¤
                    $(`.QQ_home_usermsg[data-name='${groupName}']`).remove();
                    
                    // 3. ä»æ•°æ®ç»“æ„åˆ é™¤
                    delete QQ_msgjson.ç¾¤èŠ[groupName];
                    const index = QQ_Groups.indexOf(groupName);
                    if (index > -1) {
                        QQ_Groups.splice(index, 1);
                    }
                    const pageIndex = QQ_pages.indexOf(groupName);
                    if (pageIndex > -1) {
                        QQ_pages.splice(pageIndex, 1);
                    }
                    
                    // 4. åˆ é™¤èŠå¤©é¡µé¢
                    $(`.QQ_chat_page[data-name='${groupName}']`).remove();
                    
                    // 5. ç«‹å³åˆ·æ–°entriesï¼Œç¡®ä¿åˆ é™¤çš„ç¾¤èŠä»ç•Œé¢æ¶ˆå¤±
                    console.log('åˆ·æ–°entriesä»¥ç§»é™¤å·²åˆ é™¤çš„ç¾¤èŠ');
                    try {
                        entries = await getLorebookEntries(worldbook);
                        console.log('entriesåˆ·æ–°æˆåŠŸï¼Œæ–°çš„æ¡ç›®æ•°é‡:', entries ? entries.length : 'failed');
                    } catch (e) {
                        console.warn('åˆ·æ–°entrieså¤±è´¥ï¼Œä½†ç¾¤èŠå·²åˆ é™¤:', e);
                    }
                    
                    // *** ä¿®å¤ï¼šä½¿ç”¨ä¸¤é˜¶æ®µåŠ è½½æœºåˆ¶é‡æ–°åŠ è½½ç¾¤èŠå…ƒæ•°æ® ***
                    console.log('ç«‹å³é‡æ–°åŠ è½½ç¾¤èŠå…ƒæ•°æ®ä»¥ç§»é™¤å·²åˆ é™¤çš„ç¾¤èŠ');
                    await QQ_Enhance_Group_Metadata();
                    
                    // 7. æ›´æ–°æ¶ˆæ¯åˆ—è¡¨
                    setTimeout(async () => {
                        await QQ_UpdateMessageList();
                    }, 100);
                    
                    console.log('ç¾¤èŠåˆ é™¤æˆåŠŸ:', groupName);
                    console.log('å½“å‰QQ_Groupsæ•°ç»„:', QQ_Groups);
                    return true;
                } catch (error) {
                    console.error('åˆ é™¤ç¾¤èŠå¤±è´¥:', error);
                    toastr.error('åˆ é™¤ç¾¤èŠå¤±è´¥: ' + error.message);
                    return false;
                }
            }
            
            /**
             * ä¿å­˜ç¾¤èŠæ¶ˆæ¯åˆ°æœ¬åœ°å­˜å‚¨å’ŒQQ_msgjson
             */
            function saveGroupMessage(groupId, message) {
                try {
                    // *** ä¿®å¤ï¼šå®é™…ä¿å­˜ç¾¤èŠæ¶ˆæ¯åˆ°QQ_msgjson.ç¾¤èŠ ***
                    
                    // *** ä¿®å¤ï¼šå®‰å…¨åˆå§‹åŒ–ç¾¤èŠæ•°æ®ç»“æ„ï¼Œé˜²æ­¢æ¸…ç©ºå·²æ¢å¤çš„æ•°æ® ***
                    if (!QQ_msgjson.ç¾¤èŠ) {
                        if (window.QQ_ChatDataRestored) {
                            console.warn('âš ï¸ åœ¨saveGroupMessageä¸­æ£€æµ‹åˆ°ç¾¤èŠæ•°æ®ä¸ºç©ºï¼Œä½†èŠå¤©æ•°æ®å·²ä»å¤‡ä»½æ¢å¤');
                            console.log('è¿™å¯èƒ½è¡¨ç¤ºæ•°æ®åœ¨æŸå¤„è¢«æ„å¤–æ¸…ç©ºï¼Œæ¢å¤æ—¶é—´:', window.QQ_ChatDataRestoreTime);
                        }
                        QQ_msgjson.ç¾¤èŠ = {};
                        console.log('ğŸ”§ åœ¨saveGroupMessageä¸­åˆå§‹åŒ–ç©ºçš„ç¾¤èŠæ•°æ®ç»“æ„');
                    }
                    
                    // æ ¹æ®groupIdæ‰¾åˆ°å¯¹åº”çš„ç¾¤èŠåç§°
                    let groupName = null;
                    
                    // å°è¯•ä»QQ_Groupsæ•°ç»„ä¸­åŒ¹é…
                    for (const name of QQ_Groups) {
                        if (name.includes(groupId) || groupId.includes(name)) {
                            groupName = name;
                            break;
                        }
                    }
                    
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå°è¯•é€šè¿‡ç•Œé¢å…ƒç´ æŸ¥æ‰¾
                    if (!groupName) {
                        const groupElement = document.querySelector(`[data-group-id="${groupId}"]`);
                        if (groupElement) {
                            groupName = groupElement.getAttribute('data-name') || 
                                       groupElement.textContent.trim() ||
                                       groupId; // æœ€åä½¿ç”¨groupIdä½œä¸ºåç§°
                        } else {
                            groupName = groupId; // ç›´æ¥ä½¿ç”¨groupId
                        }
                    }
                    
                    console.log(`ä¿å­˜ç¾¤èŠæ¶ˆæ¯ - groupId: ${groupId}, groupName: ${groupName}`, message);
                    
                    // ç¡®ä¿è¯¥ç¾¤èŠåœ¨QQ_msgjson.ç¾¤èŠä¸­å­˜åœ¨
                    if (!QQ_msgjson.ç¾¤èŠ[groupName]) {
                        QQ_msgjson.ç¾¤èŠ[groupName] = {
                            msgs: [],
                            members: []
                        };
                        console.log(`åˆå§‹åŒ–ç¾¤èŠæ•°æ®ç»“æ„: ${groupName}`);
                    }
                    
                    // æ„é€ æ¶ˆæ¯æ ¼å¼ï¼šå‘é€è€…--æ¶ˆæ¯å†…å®¹
                    const msgString = `${message.sender}--${message.content}`;
                    
                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ¶ˆæ¯ï¼ˆé¿å…é‡å¤ï¼‰
                    const isDuplicate = QQ_msgjson.ç¾¤èŠ[groupName].msgs.some(msg => 
                        msg === msgString || msg.includes(message.content)
                    );
                    
                    if (!isDuplicate) {
                        // æ·»åŠ æ¶ˆæ¯åˆ°ç¾¤èŠè®°å½•ä¸­
                        QQ_msgjson.ç¾¤èŠ[groupName].msgs.push(msgString);
                        console.log(`âœ“ ç¾¤èŠæ¶ˆæ¯å·²ä¿å­˜åˆ°QQ_msgjson.ç¾¤èŠ[${groupName}], å½“å‰æ¶ˆæ¯æ•°: ${QQ_msgjson.ç¾¤èŠ[groupName].msgs.length}`);
                        
                        // *** æ–°å¢ï¼šç«‹å³ä¿å­˜åˆ°ä¸–ç•Œä¹¦ ***
                        setTimeout(async () => {
                            await QQ_Save_Msg();
                            console.log('âœ“ ç¾¤èŠæ¶ˆæ¯å·²åŒæ­¥ä¿å­˜åˆ°ä¸–ç•Œä¹¦å¤‡ä»½');
                        }, 100);
                    } else {
                        console.log('è·³è¿‡é‡å¤çš„ç¾¤èŠæ¶ˆæ¯:', msgString);
                    }
                    
                } catch (error) {
                    console.error('ä¿å­˜ç¾¤èŠæ¶ˆæ¯å¤±è´¥:', error);
                }
            }
            
            /**
             * æ¢å¤ç¾¤èŠæ•°æ®åˆ°QQ_msgjsonï¼ˆç±»ä¼¼ç§èŠçš„æ¢å¤æœºåˆ¶ï¼‰
             */
            async function restoreGroupDataToMsgjson() {
                console.log('å¼€å§‹æ¢å¤ç¾¤èŠæ•°æ®åˆ°QQ_msgjson');
                
                // *** ä¿®å¤ï¼šä½¿ç”¨å†…å­˜ä¸­å·²æœ‰çš„ç¾¤èŠåˆ—è¡¨ï¼Œè€Œä¸æ˜¯é‡æ–°åŠ è½½ ***
                if (!QQ_Groups || QQ_Groups.length === 0) {
                    console.log('å†…å­˜ä¸­æ— ç¾¤èŠæ•°æ®ï¼Œè·³è¿‡æ¢å¤ã€‚');
                    return;
                }
                QQ_Groups.forEach(groupName => {
                    // ç¡®ä¿QQ_msgjsonä¸­æœ‰è¯¥ç¾¤èŠçš„æ•°æ®ç»“æ„
                    if (!QQ_msgjson.ç¾¤èŠ[groupName]) {
                        QQ_msgjson.ç¾¤èŠ[groupName] = {
                            members: [], // æˆå‘˜ä¿¡æ¯å°†åœ¨å…ƒæ•°æ®å¢å¼ºé˜¶æ®µå¡«å……
                            msgs: []
                        };
                    }
                    
                    // *** ä¿®å¤ï¼šä¿æŒç°æœ‰æ¶ˆæ¯ï¼Œä¸è¦æ¸…ç©º ***
                    // å¦‚æœQQ_msgjsonä¸­å·²ç»æœ‰æ¶ˆæ¯ï¼Œä¿æŒå®ƒä»¬
                    console.log(`ç¾¤èŠ ${groupName} å½“å‰æœ‰ ${QQ_msgjson.ç¾¤èŠ[groupName].msgs.length} æ¡æ¶ˆæ¯`);
                    
                    // *** æ–°å¢ï¼šé‡æ–°åŠ è½½åç«‹å³æ›´æ–°ç¾¤èŠæœ€åæ¶ˆæ¯æ˜¾ç¤º ***
                    if (QQ_msgjson.ç¾¤èŠ[groupName].msgs.length > 0) {
                        setTimeout(() => {
                            updateGroupLastMessageDisplay(groupName);
                        }, 200);
                    }
                    
                    console.log(`æ¢å¤ç¾¤èŠæ•°æ®: ${groupName}, æ¶ˆæ¯æ•°é‡: ${QQ_msgjson.ç¾¤èŠ[groupName].msgs.length}`);
                });
            }
            
            /**
             * æ›´æ–°ç¾¤èŠçš„æœ€åæ¶ˆæ¯å’Œæ—¶é—´
             */
            async function updateGroupLastMessage(groupId, message) {
                try {
                    // *** ä¿®å¤ï¼šä½¿ç”¨ç¼“å­˜çš„ç¾¤èŠå…ƒæ•°æ®ï¼Œé¿å…é‡æ–°åŠ è½½ ***
                    const groups = window.QQ_Group_Chats_Data || [];
                    
                    if (!groups || groups.length === 0) {
                        console.warn('ç¾¤èŠå…ƒæ•°æ®ç¼“å­˜ä¸ºç©ºï¼Œè·³è¿‡æ›´æ–°ç¾¤èŠæœ€åæ¶ˆæ¯:', groupId);
                        return;
                    }
                    
                    const groupIndex = groups.findIndex(g => g && g.id === groupId);
                    
                    if (groupIndex !== -1) {
                        const currentTime = new Date();
                        groups[groupIndex].lastMessage = message;
                        groups[groupIndex].lastTime = currentTime.toLocaleTimeString('zh-CN', { hour12: false }).slice(0, 5);
                        groups[groupIndex].timestamp = groups[groupIndex].lastTime;
                        
                        // æ–°ç‰ˆæœ¬ï¼šä¸å†ä½¿ç”¨localStorageä¿å­˜ç¾¤èŠæ•°æ®
                        console.log('ç¾¤èŠæœ€åæ¶ˆæ¯å·²æ›´æ–°ï¼ˆä»…å†…å­˜ï¼‰');
                        
                        // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                        const messageElement = $(`.QQ_home_usermsg[data-group-id="${groupId}"]`)[0];
                        const contactElement = $(`.QQ_home_usermsg[data-group-id="${groupId}"]`)[0];
                        
                        if (messageElement) {
                            updateGroupInMessageList(messageElement, groups[groupIndex]);
                        }
                        if (contactElement) {
                            updateGroupInContactList(contactElement, groups[groupIndex]);
                        }
                        
                        console.log('ç¾¤èŠæœ€åæ¶ˆæ¯å·²æ›´æ–°:', groups[groupIndex]);
                    }
                } catch (error) {
                    console.error('æ›´æ–°ç¾¤èŠæœ€åæ¶ˆæ¯å¤±è´¥:', error);
                }
            }
            
            /**
             * åŠ è½½ç¾¤èŠæ¶ˆæ¯å†å²
             */
            function loadGroupChatHistory(groupId) {
                console.log('åŠ è½½ç¾¤èŠæ¶ˆæ¯å†å²:', groupId);
                
                try {
                    // æ–°ç‰ˆæœ¬ï¼šç¾¤èŠæ¶ˆæ¯å†å²æš‚æ—¶ä¸æŒä¹…åŒ–ï¼Œæ¯æ¬¡é‡æ–°å¼€å§‹
                    const messages = [];
                    console.log('ç¾¤èŠæ¶ˆæ¯å†å²ï¼ˆæ–°ä¼šè¯ï¼‰:', messages.length, 'æ¡');
                    
                    // æŸ¥æ‰¾ç¾¤èŠä¸“ç”¨é¡µé¢çš„æ¶ˆæ¯å®¹å™¨
                    const groupChatPage = $(`.QQ_chat_page[data-group-id="${groupId}"]`);
                    const msgContent = groupChatPage.find('.msgcontent')[0] || document.querySelector('.group-chat-page .msgcontent');
                    
                    if (msgContent) {
                        msgContent.innerHTML = '';
                        
                        // å¦‚æœæœ‰å†å²æ¶ˆæ¯ï¼Œæ˜¾ç¤ºå®ƒä»¬
                        messages.forEach(message => {
                            displayGroupMessage(message, msgContent);
                        });
                        
                        // æ»šåŠ¨åˆ°åº•éƒ¨
                        msgContent.scrollTop = msgContent.scrollHeight;
                    } else {
                        console.error('æœªæ‰¾åˆ°ç¾¤èŠæ¶ˆæ¯å®¹å™¨');
                    }
                    
                    if (messages.length === 0) {
                        // å¦‚æœæ²¡æœ‰å†å²æ¶ˆæ¯ï¼Œæ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
                        if (msgContent && window.currentGroupChat) {
                            const welcomeMsg = document.createElement('div');
                            welcomeMsg.style.cssText = 'text-align: center; color: #999; padding: 20px; font-size: 14px;';
                            welcomeMsg.innerHTML = `
                                <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">${window.currentGroupChat.name}</div>
                                <div style="font-size: 14px; margin-bottom: 10px;">ç¾¤æˆå‘˜: ${window.currentGroupChat.members.join(', ')}</div>
                                <div style="font-size: 12px; color: #999;">ç¾¤èŠå·²åˆ›å»ºï¼Œå¼€å§‹èŠå¤©å§ï¼</div>
                            `;
                            msgContent.appendChild(welcomeMsg);
                        }
                    }
                } catch (error) {
                    console.error('åŠ è½½ç¾¤èŠæ¶ˆæ¯å†å²å¤±è´¥:', error);
                }
            }
            
            /**
             * æ˜¾ç¤ºç¾¤èŠæ¶ˆæ¯
             */
            function displayGroupMessage(message, msgContent = null) {
                if (!msgContent) {
                    msgContent = document.querySelector('.group-chat-page .msgcontent') || document.querySelector('.msgcontent');
                }
                if (!msgContent) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'QQ_chat_msgdiv group-message';
                messageDiv.setAttribute('data-name', message.sender);
                messageDiv.style.cssText = 'margin: 10px 0; padding: 10px; background: white; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);';
                
                const senderSpan = document.createElement('span');
                senderSpan.style.cssText = 'font-weight: bold; color: #007AFF; margin-right: 8px; font-size: 14px;';
                senderSpan.textContent = message.sender + ':';
                
                const contentSpan = document.createElement('span');
                contentSpan.style.cssText = 'color: #333; font-size: 14px; line-height: 1.4;';
                contentSpan.textContent = message.content;
                
                const timeSpan = document.createElement('span');
                timeSpan.style.cssText = 'font-size: 12px; color: #999; margin-left: 8px; float: right;';
                timeSpan.textContent = message.timestamp || new Date().toLocaleTimeString();
                
                messageDiv.appendChild(senderSpan);
                messageDiv.appendChild(contentSpan);
                messageDiv.appendChild(timeSpan);
                
                msgContent.appendChild(messageDiv);
            }
            
            /**
             * åˆ‡æ¢åˆ°ç§èŠæ—¶æ¸…é™¤ç¾¤èŠçŠ¶æ€
             */
            function clearGroupChatState() {
                if (window.currentGroupChat) {
                    console.log('ç¦»å¼€ç¾¤èŠ:', window.currentGroupChat.name);
                    window.currentGroupChat = null;
                }
            }
            
            // ç›‘å¬ç§èŠåˆ‡æ¢ï¼Œæ¸…é™¤ç¾¤èŠçŠ¶æ€
            const originalQQNav = window.QQ_Nav;
            // QQ_Navå‡½æ•°å·²åœ¨å‰é¢æ­£ç¡®å®šä¹‰ï¼Œæ— éœ€é‡å¤å®šä¹‰
            
            /**
             * ç¡®ä¿ç¾¤èŠåœ¨è”ç³»äººåˆ—è¡¨ä¸­å­˜åœ¨
             */
            async function ensureGroupsInContactList() {
                // *** ä¿®å¤ï¼šä½¿ç”¨ç¼“å­˜çš„ç¾¤èŠå…ƒæ•°æ®ï¼Œé¿å…é‡æ–°åŠ è½½ ***
                const groups = window.QQ_Group_Chats_Data || [];
                const contactsContainer = document.getElementById('QQ_home_chars');
                
                if (!contactsContainer) {
                    console.log('è”ç³»äººå®¹å™¨ä¸å­˜åœ¨ï¼Œè·³è¿‡ç¾¤èŠUIåŒæ­¥');
                    return;
                }
                
                if (groups.length === 0) {
                    console.log('æ²¡æœ‰ç¾¤èŠæ•°æ®éœ€è¦åŒæ­¥åˆ°UI');
                    return;
                }
                
                console.log('æ£€æŸ¥è”ç³»äººåˆ—è¡¨ä¸­çš„ç¾¤èŠï¼Œå…±', groups.length, 'ä¸ªç¾¤èŠéœ€è¦æ¢å¤');
                console.log('ç¾¤èŠæ•°æ®:', groups.map(g => ({name: g.name, id: g.id, avatar: g.avatar})));
                
                // å…ˆæ¸…ç†é‡å¤çš„ç¾¤èŠå…ƒç´ ï¼Œä½†ä¿ç•™ä¸€ä¸ª
                const existingGroups = contactsContainer.querySelectorAll('[data-group-type="true"]');
                const groupMap = new Map();
                const groupNameMap = new Map(); // æŒ‰åç§°ç´¢å¼•
                
                console.log('ç°æœ‰ç¾¤èŠå…ƒç´ æ•°é‡:', existingGroups.length);
                
                existingGroups.forEach(element => {
                    const groupId = element.getAttribute('data-group-id');
                    const groupName = element.getAttribute('data-name');
                    
                    console.log('æ£€æŸ¥ç°æœ‰ç¾¤èŠå…ƒç´ :', {groupId, groupName});
                    
                    if (groupId) {
                        if (groupMap.has(groupId)) {
                            console.log('ç§»é™¤é‡å¤çš„ç¾¤èŠå…ƒç´ (æŒ‰ID):', groupId);
                            element.remove();
                        } else {
                            groupMap.set(groupId, element);
                            if (groupName) {
                                groupNameMap.set(groupName, element);
                            }
                        }
                    } else if (groupName) {
                        // å¦‚æœæ²¡æœ‰IDä½†æœ‰åç§°ï¼Œä¹Ÿè®°å½•ä¸‹æ¥
                        if (groupNameMap.has(groupName)) {
                            console.log('ç§»é™¤é‡å¤çš„ç¾¤èŠå…ƒç´ (æŒ‰åç§°):', groupName);
                            element.remove();
                        } else {
                            groupNameMap.set(groupName, element);
                        }
                    }
                });
                
                // ç„¶åæ·»åŠ ç¼ºå¤±çš„ç¾¤èŠ
                groups.forEach(groupData => {
                    const existsByID = groupMap.has(groupData.id);
                    const existsByName = groupNameMap.has(groupData.name);
                    
                    if (!existsByID && !existsByName) {
                        console.log('æ¢å¤ç¾¤èŠåˆ°è”ç³»äººåˆ—è¡¨:', groupData.name, 'ID:', groupData.id);
                        AddNewGroup(groupData.name, groupData.avatar || QQ_GetRandomAvatar() || 'https://files.catbox.moe/skngqq.jpg', groupData.members, groupData.description);
                    } else {
                        console.log('ç¾¤èŠå·²å­˜åœ¨äºè”ç³»äººåˆ—è¡¨:', groupData.name);
                        // ç¡®ä¿ç°æœ‰ç¾¤èŠçš„å¤´åƒæ­£ç¡®æ˜¾ç¤º
                        const existingElement = existsByID ? groupMap.get(groupData.id) : groupNameMap.get(groupData.name);
                        if (existingElement) {
                            updateGroupAvatarInElement(existingElement, groupData);
                        }
                    }
                });
                
                console.log('è”ç³»äººåˆ—è¡¨ç¾¤èŠæ¢å¤å®Œæˆ');
            }
            
            /**
             * æ›´æ–°ç¾¤èŠå…ƒç´ ä¸­çš„å¤´åƒæ˜¾ç¤º
             */
            function updateGroupAvatarInElement(element, groupData) {
                console.log('æ›´æ–°ç¾¤èŠå…ƒç´ å¤´åƒ:', groupData?.name);
                
                const avatarElement = element.querySelector('.QQ_home_head');
                if (!avatarElement) {
                    console.log('æœªæ‰¾åˆ°å¤´åƒå…ƒç´ ');
                    return;
                }
                
                // é‡ç½®å¤´åƒæ ·å¼
                avatarElement.style.backgroundImage = '';
                avatarElement.style.background = '';
                avatarElement.textContent = '';
                avatarElement.innerHTML = '';
                
                // *** ä¿®å¤ï¼šä¼ é€’å®Œæ•´çš„ç¾¤èŠæ•°æ®å¯¹è±¡è€Œä¸ä»…ä»…æ˜¯avatarå­—æ®µ ***
                applyGroupAvatar(avatarElement, groupData);
                console.log('ç¾¤èŠå¤´åƒå·²æ›´æ–°:', groupData?.name);
            }
            
            /**
             * ä»ä¸–ç•Œä¹¦è·å–è§’è‰²å¤´åƒæ•°æ®
             */
            function getCharacterAvatarFromWorldbook(characterName) {
                console.log(`ä»ä¸–ç•Œä¹¦è·å–è§’è‰²å¤´åƒ: ${characterName}`);
                
                // ä»ä¸–ç•Œä¹¦ "æ‰‹æœº-è§’è‰²" æ¡ç›®è·å–å¤´åƒ
                let entry = GetWorldEntry(["æ‰‹æœº-è§’è‰²", "æ‰‹æœºç•Œé¢-è§’è‰²"], true);
                if (!entry || !entry.content) {
                    console.log('æœªæ‰¾åˆ°æ‰‹æœº-è§’è‰²ä¸–ç•Œä¹¦æ¡ç›®');
                    return null;
                }
                
                const content = entry.content;
                const lines = content.split('\n');
                let currentSection = null;
                
                for (let line of lines) {
                    line = line.trim();
                    if (line.startsWith('[') && line.endsWith(']')) {
                        currentSection = line.slice(1, -1);
                        console.log(`å½“å‰å¤„ç†ç« èŠ‚: ${currentSection}`);
                    } else if (currentSection === characterName && line.startsWith('å¤´åƒ=')) {
                        const avatarUrl = line.substring(3);
                        console.log(`æ‰¾åˆ°è§’è‰² ${characterName} çš„å¤´åƒ: ${avatarUrl}`);
                        return {
                            backgroundImage: `url("${avatarUrl}")`,
                            background: '',
                            textContent: '',
                            avatarUrl: avatarUrl
                        };
                    }
                }
                
                console.log(`æœªåœ¨ä¸–ç•Œä¹¦ä¸­æ‰¾åˆ°è§’è‰² ${characterName} çš„å¤´åƒï¼Œå½“å‰æ‰€æœ‰ç« èŠ‚:`, lines.filter(l => l.startsWith('[') && l.endsWith(']')));
                return null;
            }
            
            /**
             * ä»ä¸–ç•Œä¹¦è·å–ç¾¤èŠå¤´åƒæ•°æ®
             */
            function getGroupAvatarFromWorldbook(groupName) {
                console.log(`ä»ä¸–ç•Œä¹¦è·å–ç¾¤èŠå¤´åƒ: ${groupName}`);
                
                // ä»ä¸–ç•Œä¹¦ "æ‰‹æœº-ç¾¤èŠ" æ¡ç›®è·å–å¤´åƒ
                if (!entries) {
                    console.log('entriesæœªå®šä¹‰ï¼Œæ— æ³•è·å–ç¾¤èŠå¤´åƒ');
                    return null;
                }
                
                const uniqueComment = `æ‰‹æœº-ç¾¤èŠ-${groupName}`;
                const groupEntry = entries.find(e => 
                    e.comment === uniqueComment
                );
                
                if (!groupEntry) {
                    console.log(`æœªæ‰¾åˆ°ç¾¤èŠ ${groupName} çš„ä¸–ç•Œä¹¦æ¡ç›®`);
                    return null;
                }
                
                const content = groupEntry.content;
                const lines = content.split('\n');
                let currentSection = null;
                
                for (let line of lines) {
                    line = line.trim();
                    if (line.startsWith('[') && line.endsWith(']')) {
                        currentSection = line.slice(1, -1);
                    } else if (currentSection === groupName && line.startsWith('å¤´åƒ=')) {
                        const avatarUrl = line.substring(3);
                        console.log(`æ‰¾åˆ°ç¾¤èŠ ${groupName} çš„å¤´åƒ: ${avatarUrl}`);
                        return {
                            backgroundImage: `url("${avatarUrl}")`,
                            background: '',
                            textContent: '',
                            avatarUrl: avatarUrl
                        };
                    }
                }
                
                console.log(`æœªåœ¨ä¸–ç•Œä¹¦ä¸­æ‰¾åˆ°ç¾¤èŠ ${groupName} çš„å¤´åƒ`);
                return null;
            }
            
            /**
             * è·å–è§’è‰²å¤´åƒæ•°æ®ï¼ˆä¼˜å…ˆä»ä¸–ç•Œä¹¦ï¼Œå¤‡é€‰ä»è”ç³»äººåˆ—è¡¨ï¼‰
             */
            function getCharacterAvatar(characterName) {
                console.log(`è·å–è§’è‰²å¤´åƒ: ${characterName}`);
                
                // é¦–å…ˆå°è¯•ä»ä¸–ç•Œä¹¦è·å–
                const worldbookAvatar = getCharacterAvatarFromWorldbook(characterName);
                if (worldbookAvatar) {
                    return worldbookAvatar;
                }
                
                // å¤‡é€‰æ–¹æ¡ˆï¼šä»è”ç³»äººåˆ—è¡¨ä¸­æŸ¥æ‰¾è§’è‰²å¤´åƒ
                const contactsContainer = document.getElementById('QQ_home_chars');
                if (!contactsContainer) {
                    console.log('è”ç³»äººå®¹å™¨æœªæ‰¾åˆ°');
                    return null;
                }
                
                // æŸ¥æ‰¾å¯¹åº”çš„è”ç³»äººå…ƒç´  - ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„é€‰æ‹©å™¨
                const contactElements = contactsContainer.querySelectorAll('.QQ_home_usermsg');
                for (let element of contactElements) {
                    const nameElement = element.querySelector('.QQ_home_name');
                    if (nameElement && nameElement.textContent.trim() === characterName) {
                        const avatarElement = element.querySelector('.QQ_home_head');
                        if (avatarElement) {
                            // æå–å¤´åƒä¿¡æ¯
                            const backgroundImage = avatarElement.style.backgroundImage;
                            const background = avatarElement.style.background;
                            const textContent = avatarElement.textContent;
                            
                            console.log(`ä»è”ç³»äººåˆ—è¡¨è·å–è§’è‰² ${characterName} çš„å¤´åƒ`);
                            return {
                                backgroundImage,
                                background,
                                textContent
                            };
                        }
                    }
                }
                
                console.log(`æœªæ‰¾åˆ°è§’è‰² ${characterName} çš„å¤´åƒ`);
                return null;
            }
            
            /**
             * åº”ç”¨è§’è‰²å¤´åƒåˆ°å…ƒç´ 
             */
            function applyCharacterAvatar(element, avatarData, characterName) {
                // *** ä¿®å¤ï¼šä¸è¦å¼ºåˆ¶è®¾ç½®å°ºå¯¸ï¼Œä¿æŒCSSä¸­çš„æ ·å¼ ***
                // åªè®¾ç½®å¿…è¦çš„åŸºç¡€æ ·å¼ï¼Œè®©CSSæ§åˆ¶å°ºå¯¸
                element.style.borderRadius = '50%';
                element.style.display = 'flex';
                element.style.alignItems = 'center';
                element.style.justifyContent = 'center';
                element.style.fontWeight = 'bold';
                element.style.fontSize = '12px';
                element.style.color = 'white';
                element.style.backgroundSize = 'cover';
                element.style.backgroundPosition = 'center';
                element.style.backgroundRepeat = 'no-repeat';
                element.style.flexShrink = '0';
                
                if (avatarData && (avatarData.backgroundImage || avatarData.background)) {
                    // ä½¿ç”¨çœŸå®å¤´åƒ
                    if (avatarData.backgroundImage && avatarData.backgroundImage !== 'none') {
                        element.style.backgroundImage = avatarData.backgroundImage;
                        element.style.background = '';
                        element.textContent = '';
                    } else if (avatarData.background && avatarData.background !== 'none') {
                        element.style.background = avatarData.background;
                        element.style.backgroundImage = '';
                        element.textContent = avatarData.textContent || characterName.charAt(0);
                    } else {
                        // ä½¿ç”¨é»˜è®¤å¤´åƒ
                        element.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                        element.style.backgroundImage = '';
                        element.textContent = characterName.charAt(0);
                    }
                } else {
                    // ä½¿ç”¨é»˜è®¤å¤´åƒ
                    element.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                    element.style.backgroundImage = '';
                    element.textContent = characterName.charAt(0);
                }
            }
            
            /**
             * *** ä¿®å¤ï¼šåº”ç”¨ç¾¤èŠå¤´åƒåˆ°å…ƒç´  - æ”¯æŒå¤šç§å¤´åƒæ ¼å¼ï¼ˆbase64ã€URLã€é¢„è®¾ï¼‰***
             */
            function applyGroupAvatar(element, groupData) {
                console.log('åº”ç”¨ç¾¤èŠå¤´åƒ:', groupData?.name, 'å¤´åƒæ•°æ®ç±»å‹:', typeof groupData?.avatar, 'å¤´åƒå€¼:', groupData?.avatar?.substring?.(0, 50) + '...');
                
                // è®¾ç½®åŸºç¡€æ ·å¼
                element.style.borderRadius = '50%';
                element.style.display = 'flex';
                element.style.alignItems = 'center';
                element.style.justifyContent = 'center';
                element.style.fontWeight = 'bold';
                element.style.fontSize = '12px';
                element.style.color = 'white';
                element.style.backgroundSize = 'cover';
                element.style.backgroundPosition = 'center';
                element.style.backgroundRepeat = 'no-repeat';
                element.style.flexShrink = '0';
                
                // é‡ç½®èƒŒæ™¯æ ·å¼
                element.style.backgroundImage = '';
                element.style.background = '';
                element.innerHTML = '';
                
                if (!groupData) {
                    console.log('ç¾¤èŠæ•°æ®ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ');
                    element.style.background = 'linear-gradient(135deg, #ff7b7b, #667eea)';
                    element.textContent = 'ç¾¤';
                    return;
                }
                
                // è·å–å¤´åƒæ•°æ®ï¼Œä¼˜å…ˆä½¿ç”¨avatarDataï¼Œå¤‡é€‰avatar
                const avatarSrc = groupData.avatarData || groupData.avatar;
                
                if (avatarSrc && avatarSrc.trim() !== '') {
                    // æ£€æŸ¥å¤´åƒç±»å‹
                    if (avatarSrc.startsWith('data:image/')) {
                        // base64å›¾ç‰‡æ•°æ® - ä½¿ç”¨imgå…ƒç´ 
                        console.log('ä½¿ç”¨base64å¤´åƒæ•°æ®');
                        element.innerHTML = `<img src="${avatarSrc}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                    } else if (avatarSrc.startsWith('http://') || avatarSrc.startsWith('https://')) {
                        // URLé“¾æ¥ - ä½¿ç”¨imgå…ƒç´ 
                        console.log('ä½¿ç”¨URLå¤´åƒ:', avatarSrc);
                        element.innerHTML = `<img src="${avatarSrc}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                    } else if (avatarSrc.length === 1 || avatarSrc.length === 2) {
                        // é¢„è®¾æ–‡å­—å¤´åƒï¼ˆå•ä¸ªå­—ç¬¦æˆ–emojiï¼‰
                        console.log('ä½¿ç”¨é¢„è®¾æ–‡å­—å¤´åƒ:', avatarSrc);
                        element.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                        element.textContent = avatarSrc;
                    } else if (avatarSrc.startsWith('#') && avatarSrc.length === 7) {
                        // é¢œè‰²ä»£ç 
                        console.log('ä½¿ç”¨é¢œè‰²å¤´åƒ:', avatarSrc);
                        element.style.background = avatarSrc;
                        element.textContent = groupData.name ? groupData.name.charAt(0) : 'ç¾¤';
                    } else {
                        // å…¶ä»–æƒ…å†µå½“ä½œå›¾ç‰‡URLå¤„ç†
                        console.log('å½“ä½œå›¾ç‰‡URLå¤„ç†:', avatarSrc);
                        element.innerHTML = `<img src="${avatarSrc}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" onerror="this.style.display='none'; this.parentElement.style.background='linear-gradient(135deg, #ff7b7b, #667eea)'; this.parentElement.textContent='ç¾¤';">`;
                    }
                } else {
                    // ä½¿ç”¨é»˜è®¤ç¾¤èŠå¤´åƒ
                    console.log('ä½¿ç”¨é»˜è®¤ç¾¤èŠå¤´åƒ');
                    element.style.background = 'linear-gradient(135deg, #ff7b7b, #667eea)';
                    element.textContent = 'ç¾¤';
                }
            }
            
            // æ³¨æ„ï¼šensureGroupsInMessageListå‡½æ•°å·²åˆ é™¤
            // æ¶ˆæ¯åˆ—è¡¨ç°åœ¨ç”±QQ_UpdateMessageList()è‡ªåŠ¨ä»è”ç³»äººåˆ—è¡¨åŒæ­¥
            
            /**
             * æ›´æ–°èŠå¤©ç•Œé¢å¤´éƒ¨ä¿¡æ¯
             */
            function updateChatHeader(groupData) {
                console.log('æ›´æ–°èŠå¤©ç•Œé¢å¤´éƒ¨ä¿¡æ¯:', groupData);
                
                // æŸ¥æ‰¾èŠå¤©ç•Œé¢çš„å¤´éƒ¨å…ƒç´ 
                const chatHeader = document.querySelector('#QQ_chat_username')?.closest('div') || 
                                  document.querySelector('.QQ_chat_head') || 
                                  document.querySelector('#QQ_chat_head');
                console.log('èŠå¤©å¤´éƒ¨å…ƒç´ :', chatHeader);
                
                if (!chatHeader) {
                    console.error('æœªæ‰¾åˆ°èŠå¤©å¤´éƒ¨å…ƒç´ ï¼Œå°è¯•åˆ›å»ºå¤´éƒ¨');
                    // å¦‚æœæ‰¾ä¸åˆ°å¤´éƒ¨ï¼Œå°è¯•åœ¨é¡µé¢é¡¶éƒ¨åˆ›å»ºä¸€ä¸ª
                    const chatPage = document.querySelector('.QQ_chat_page[style*="display:block"], .QQ_chat_page:not([style*="display:none"])');
                    if (chatPage) {
                        const headerDiv = document.createElement('div');
                        headerDiv.className = 'QQ_chat_head group-chat-header';
                        headerDiv.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; height: 60px; background: #fff; z-index: 1000; display: flex; align-items: center; padding: 0 15px; border-bottom: 1px solid #eee;';
                        
                        // åˆ›å»ºå¤´åƒ
                        const avatar = document.createElement('div');
                        avatar.className = 'QQ_home_head';
                        avatar.style.cssText = 'width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;';
                        
                        // åˆ›å»ºåç§°å’Œä¿¡æ¯å®¹å™¨
                        const infoDiv = document.createElement('div');
                        infoDiv.style.cssText = 'flex: 1;';
                        
                        const nameDiv = document.createElement('div');
                        nameDiv.className = 'QQ_home_name group-chat-clickable-name';
                        nameDiv.style.cssText = 'font-size: 16px; font-weight: bold; color: #333; cursor: pointer; user-select: none;';
                        nameDiv.textContent = groupData.name;
                        
                        // æ·»åŠ ç‚¹å‡»äº‹ä»¶æ˜¾ç¤ºç¾¤èŠç®¡ç†èœå•
                        nameDiv.addEventListener('click', function(e) {
                            e.stopPropagation();
                            showGroupManagementMenu(groupData, nameDiv);
                        });
                        
                        const msgDiv = document.createElement('div');
                        msgDiv.className = 'QQ_home_lastmsg group-member-count';
                        msgDiv.style.cssText = 'font-size: 12px; color: #666; margin-top: 2px;';
                        msgDiv.textContent = `ç¾¤èŠ Â· ${groupData.members.length}äºº`;
                        
                        infoDiv.appendChild(nameDiv);
                        infoDiv.appendChild(msgDiv);
                        
                        headerDiv.appendChild(avatar);
                        headerDiv.appendChild(infoDiv);
                        
                        chatPage.insertBefore(headerDiv, chatPage.firstChild);
                        
                        // æ›´æ–°èŠå¤©åŒºåŸŸçš„ä¸Šè¾¹è·ï¼Œé¿å…è¢«å›ºå®šå¤´éƒ¨é®æŒ¡
                        const msgContent = chatPage.querySelector('.msgcontent');
                        if (msgContent) {
                            msgContent.style.paddingTop = '70px';
                        }
                        
                        // é‡æ–°è®¾ç½®chatHeader
                        const updatedHeader = headerDiv;
                        updateHeaderContent(updatedHeader, groupData);
                        return;
                    } else {
                        console.error('ä¹Ÿæœªæ‰¾åˆ°èŠå¤©é¡µé¢');
                        return;
                    }
                }
                
                updateHeaderContent(chatHeader, groupData);
            }
            
            /**
             * æ›´æ–°å¤´éƒ¨å†…å®¹çš„é€šç”¨å‡½æ•°
             */
            function updateHeaderContent(chatHeader, groupData) {
                // *** å¼ºåˆ¶æ›´æ–°å¤´åƒæ˜¾ç¤º ***
                const headerAvatar = chatHeader.querySelector('.QQ_home_head');
                console.log('*** èŠå¤©ç•Œé¢å¤´åƒæ›´æ–° ***');
                console.log('å¤´åƒå…ƒç´ :', headerAvatar);
                console.log('ç¾¤èŠå¤´åƒæ•°æ®:', groupData.avatar);
                
                if (headerAvatar) {
                    // å¼ºåˆ¶æ¸…ç©ºæ‰€æœ‰æ ·å¼
                    headerAvatar.innerHTML = '';
                    headerAvatar.style.cssText = '';
                    
                    // é‡æ–°è®¾ç½®åŸºç¡€æ ·å¼
                    headerAvatar.style.display = 'block';
                    headerAvatar.style.width = '40px';
                    headerAvatar.style.height = '40px';
                    headerAvatar.style.borderRadius = '50%';
                    headerAvatar.style.marginRight = '10px';
                    headerAvatar.style.flexShrink = '0';
                    headerAvatar.style.position = 'relative';
                    headerAvatar.style.overflow = 'hidden';
                    
                    // *** å¼ºåˆ¶æ›´æ–°å¤´åƒå†…å®¹ ***
                    if (groupData.avatar) {
                        console.log('å¼ºåˆ¶æ›´æ–°ç¾¤èŠå¤´åƒ:', groupData.avatar.type);
                        
                        // ç¡®ä¿ç«‹å³æ›´æ–°å¤´åƒ
                        updateAvatarElement(headerAvatar, groupData.avatar);
                        
                        // å»¶è¿Ÿå†æ¬¡ç¡®ä¿å¤´åƒæ­£ç¡®æ˜¾ç¤º
                        setTimeout(() => {
                            console.log('å»¶è¿Ÿå†æ¬¡æ›´æ–°å¤´åƒ');
                            updateAvatarElement(headerAvatar, groupData.avatar);
                        }, 50);
                        
                        console.log('èŠå¤©ç•Œé¢å¤´åƒå·²å¼ºåˆ¶æ›´æ–°');
                    } else {
                        // ä½¿ç”¨é»˜è®¤ç¾¤èŠå¤´åƒ
                        headerAvatar.style.background = 'linear-gradient(135deg, #199AFF, #0066CC)';
                        headerAvatar.style.backgroundImage = 'none';
                        headerAvatar.style.color = 'white';
                        headerAvatar.style.display = 'flex';
                        headerAvatar.style.alignItems = 'center';
                        headerAvatar.style.justifyContent = 'center';
                        headerAvatar.style.fontWeight = 'bold';
                        headerAvatar.textContent = 'ç¾¤';
                        console.log('ä½¿ç”¨é»˜è®¤ç¾¤èŠå¤´åƒ');
                    }
                } else {
                    console.warn('æœªæ‰¾åˆ°èŠå¤©ç•Œé¢å¤´åƒå…ƒç´ ');
                }
                
                // *** ä¿®å¤ï¼šæ›´å…¨é¢çš„åç§°å…ƒç´ æŸ¥æ‰¾å’Œæ›´æ–° ***
                console.log('=== å¼€å§‹æ›´æ–°èŠå¤©å¤´éƒ¨åç§°æ˜¾ç¤º ===');
                console.log('ç›®æ ‡ç¾¤èŠåç§°:', groupData.name);
                console.log('ç¾¤èŠæˆå‘˜æ•°é‡:', groupData.members.length);
                
                // æŸ¥æ‰¾å¤šä¸ªå¯èƒ½çš„é€‰æ‹©å™¨ï¼ŒæŒ‰é‡è¦æ€§æ’åº
                const nameSelectors = [
                    '#QQ_chat_username',        // æœ€å¸¸ç”¨çš„èŠå¤©ç”¨æˆ·åå…ƒç´ 
                    '.QQ_home_name',           // è”ç³»äººåç§°å…ƒç´ 
                    '.chat-title',             // èŠå¤©æ ‡é¢˜å…ƒç´ 
                    '.group-chat-title',       // ç¾¤èŠæ ‡é¢˜å…ƒç´ 
                    'h2',                      // é€šç”¨æ ‡é¢˜å…ƒç´ 
                    '.name',                   // é€šç”¨åç§°å…ƒç´ 
                    'span',                    // é€šç”¨spanå…ƒç´ 
                    'div'                      // æœ€åçš„å¤‡é€‰
                ];
                
                let headerName = null;
                let selectorUsed = '';
                
                // æŒ‰ä¼˜å…ˆçº§æŸ¥æ‰¾åç§°å…ƒç´ 
                for (const selector of nameSelectors) {
                    headerName = chatHeader.querySelector(selector);
                    if (headerName) {
                        selectorUsed = selector;
                        console.log(`æ‰¾åˆ°åç§°å…ƒç´ ï¼Œä½¿ç”¨é€‰æ‹©å™¨: ${selector}`);
                        break;
                    }
                }
                
                console.log('æŸ¥æ‰¾åˆ°çš„åç§°å…ƒç´ :', headerName);
                console.log('èŠå¤©å¤´éƒ¨çš„æ‰€æœ‰å­å…ƒç´ :', Array.from(chatHeader.children).map(el => ({
                    tag: el.tagName,
                    class: el.className,
                    id: el.id,
                    text: el.textContent.trim().substring(0, 50)
                })));
                
                if (headerName) {
                    console.log('æ‰¾åˆ°åç§°å…ƒç´ ï¼Œå¼€å§‹æ›´æ–°...');
                    console.log('  - å½“å‰å†…å®¹:', headerName.textContent.trim());
                    console.log('  - ç›®æ ‡åç§°:', groupData.name);
                    console.log('  - æˆå‘˜æ•°é‡:', groupData.members.length);
                    
                    // *** ä¿®å¤ï¼šæ­£ç¡®è®¾ç½®ç¾¤èŠæ ‡é¢˜æ ¼å¼ ***
                    if (groupData.members && groupData.members.length >= 1) {
                        // ç¾¤èŠæ ¼å¼ï¼šåªæ˜¾ç¤ºåç§°ï¼Œäººæ•°åœ¨å‰¯æ ‡é¢˜ä¸­æ˜¾ç¤º
                        headerName.textContent = groupData.name;
                        console.log('å·²è®¾ç½®ç¾¤èŠæ ‡é¢˜:', groupData.name);
                        
                        // *** é‡è¦ä¿®å¤ï¼šæ›´æ–°äººæ•°æ˜¾ç¤º ***
                        const memberCountElement = chatHeader.querySelector('.QQ_home_lastmsg, .group-member-count');
                        if (memberCountElement) {
                            const memberCount = groupData.members.length;
                            const countText = `ç¾¤èŠ Â· ${memberCount}äºº`;
                            memberCountElement.textContent = countText;
                            console.log('âœ… ç¾¤èŠäººæ•°å·²æ›´æ–°:', countText);
                        } else {
                            console.log('æœªæ‰¾åˆ°äººæ•°æ˜¾ç¤ºå…ƒç´ ï¼Œå°è¯•åˆ›å»º...');
                            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°äººæ•°æ˜¾ç¤ºå…ƒç´ ï¼Œåˆ›å»ºä¸€ä¸ª
                            const nameContainer = headerName.parentElement;
                            if (nameContainer) {
                                const memberCountDiv = document.createElement('div');
                                memberCountDiv.className = 'QQ_home_lastmsg group-member-count';
                                memberCountDiv.style.cssText = 'font-size: 12px; color: #666; margin-top: 2px;';
                                memberCountDiv.textContent = `ç¾¤èŠ Â· ${groupData.members.length}äºº`;
                                nameContainer.appendChild(memberCountDiv);
                                console.log('âœ… å·²åˆ›å»ºç¾¤èŠäººæ•°æ˜¾ç¤ºå…ƒç´ ');
                            }
                        }
                    } else {
                        // ç§èŠæˆ–æ— æˆå‘˜ä¿¡æ¯æ—¶ï¼Œåªæ˜¾ç¤ºåç§°
                        headerName.textContent = groupData.name;
                        console.log('å·²è®¾ç½®ç§èŠæ ‡é¢˜:', groupData.name);
                    }
                    
                    // *** æ ¸å¿ƒä¿®å¤ï¼šç¡®ä¿å…ƒç´ æ­£ç¡®çš„å¯ç‚¹å‡»æ€§ ***
                    // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§ç±»å
                    headerName.classList.remove('group-chat-clickable-name');
                    
                    // æ·»åŠ æ–°çš„ç±»åå’Œæ ·å¼
                    headerName.classList.add('group-chat-clickable-name');
                    headerName.style.cursor = 'pointer';
                    headerName.style.userSelect = 'none';
                    headerName.style.color = '#333';
                    headerName.style.fontWeight = 'bold';
                    
                    // è®¾ç½®é‡è¦çš„æ•°æ®å±æ€§
                    headerName.setAttribute('data-group-name', groupData.name);
                    headerName.setAttribute('data-group-id', groupData.id);
                    
                    // ç§»é™¤æ—§çš„ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
                    if (headerName._groupClickHandler) {
                        headerName.removeEventListener('click', headerName._groupClickHandler);
                        console.log('å·²ç§»é™¤æ—§çš„ç‚¹å‡»äº‹ä»¶');
                    }
                    
                    // æ·»åŠ æ–°çš„ç‚¹å‡»äº‹ä»¶
                    headerName._groupClickHandler = function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        console.log('ç¾¤èŠåç§°è¢«ç‚¹å‡» - æœ€æ–°æ•°æ®:', {
                            name: groupData.name,
                            id: groupData.id,
                            members: groupData.members.length
                        });
                        showGroupManagementMenu(groupData, headerName);
                    };
                    headerName.addEventListener('click', headerName._groupClickHandler);
                    
                    console.log('ç¾¤èŠåç§°ç‚¹å‡»äº‹ä»¶å·²é‡æ–°ç»‘å®š');
                    console.log('  - æœ€ç»ˆæ˜¾ç¤ºå†…å®¹:', headerName.textContent.trim());
                    
                } else {
                    console.error('*** æœªæ‰¾åˆ°ç¾¤åç§°å…ƒç´ ï¼Œç¾¤åç§°æ›´æ–°å¤±è´¥ ***');
                    console.error('èŠå¤©å¤´éƒ¨ç»“æ„:', chatHeader.outerHTML);
                    
                    // åˆ›å»ºæ–°çš„åç§°å…ƒç´ ä½œä¸ºæœ€åæ‰‹æ®µ
                    const nameElement = document.createElement('span');
                    nameElement.id = 'QQ_chat_username';
                    nameElement.className = 'QQ_home_name group-chat-clickable-name';
                    
                    // è®¾ç½®ç¾¤èŠæ ‡é¢˜
                    if (groupData.members && groupData.members.length > 1) {
                        nameElement.textContent = `${groupData.name} (${groupData.members.length}äºº)`;
                    } else {
                    nameElement.textContent = groupData.name;
                    }
                    
                    nameElement.style.cssText = 'font-size: 16px; font-weight: bold; color: #333; margin-left: 10px; cursor: pointer; user-select: none;';
                    nameElement.setAttribute('data-group-name', groupData.name);
                    nameElement.setAttribute('data-group-id', groupData.id);
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    nameElement.addEventListener('click', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        console.log('æ–°åˆ›å»ºçš„ç¾¤èŠåç§°è¢«ç‚¹å‡»:', groupData.name);
                        showGroupManagementMenu(groupData, nameElement);
                    });
                    
                    chatHeader.appendChild(nameElement);
                    headerName = nameElement;
                    console.log('å·²åˆ›å»ºæ–°çš„ç¾¤èŠåç§°å…ƒç´ ');
                }
                
                console.log('=== èŠå¤©å¤´éƒ¨åç§°æ›´æ–°å®Œæˆ ===');
                
                // æ·»åŠ ç¾¤èŠæˆå‘˜æ•°æ˜¾ç¤º
                const headerMsg = chatHeader.querySelector('.QQ_home_lastmsg') || 
                                 chatHeader.querySelector('.chat-subtitle');
                
                if (headerMsg) {
                    headerMsg.textContent = `ç¾¤èŠ Â· ${groupData.members.length}äºº`;
                } else {
                    // å¦‚æœæ‰¾ä¸åˆ°å‰¯æ ‡é¢˜å…ƒç´ ï¼Œåˆ›å»ºä¸€ä¸ª
                    const subtitleElement = document.createElement('div');
                    subtitleElement.className = 'QQ_home_lastmsg';
                    subtitleElement.textContent = `ç¾¤èŠ Â· ${groupData.members.length}äºº`;
                    subtitleElement.style.cssText = 'font-size: 12px; color: #666; margin-left: 10px;';
                    chatHeader.appendChild(subtitleElement);
                }
            }
            
            /**
             * åŠ è½½ç¾¤èŠæ¶ˆæ¯å†å²ï¼ˆå¢å¼ºç‰ˆï¼šæ”¯æŒç³»ç»Ÿæ¶ˆæ¯ï¼‰
             */
            function loadGroupChatHistory(groupId) {
                console.log('åŠ è½½ç¾¤èŠæ¶ˆæ¯å†å²:', groupId);
                
                const chatContainer = document.querySelector('#QQ_chat_msgs');
                if (!chatContainer) {
                    console.error('æ‰¾ä¸åˆ°èŠå¤©æ¶ˆæ¯å®¹å™¨');
                    return;
                }
                
                // æ¸…ç©ºç°æœ‰æ¶ˆæ¯
                chatContainer.innerHTML = '';
                
                // *** ä¿®å¤ï¼šåŒæ—¶åŠ è½½å†…å­˜å’ŒæŒä¹…åŒ–çš„ç¾¤èŠæ¶ˆæ¯ ***
                let hasMessages = false;
                // *** æ–°å¢ï¼šè·Ÿè¸ªå·²å¤„ç†çš„äº’åŠ¨å†…å®¹IDï¼Œé˜²æ­¢é‡å¤å¤„ç† ***
                // ä½¿ç”¨å…¨å±€å˜é‡ç¡®ä¿è·¨é¡µé¢åŠ è½½æ—¶ä¿æŒçŠ¶æ€
                if (!window.QQ_ProcessedInteractiveIds) {
                    window.QQ_ProcessedInteractiveIds = new Set();
                }
                const processedInteractiveIds = window.QQ_ProcessedInteractiveIds;
                
                // 1. å…ˆåŠ è½½æŒä¹…åŒ–çš„ç¾¤èŠæ¶ˆæ¯ï¼ˆQQ_msgjson.ç¾¤èŠï¼‰
                const groupName = groupId; // å‡è®¾ groupId å°±æ˜¯ç¾¤èŠåç§°
                if (QQ_msgjson && QQ_msgjson.ç¾¤èŠ && QQ_msgjson.ç¾¤èŠ[groupName] && QQ_msgjson.ç¾¤èŠ[groupName].msgs) {
                    const persistedMessages = QQ_msgjson.ç¾¤èŠ[groupName].msgs;
                    console.log(`ä» QQ_msgjson.ç¾¤èŠ åŠ è½½ç¾¤èŠ ${groupName} çš„ ${persistedMessages.length} æ¡æ¶ˆæ¯`);
                    
                    // ä½¿ç”¨ç°æœ‰çš„ QQ_Chat_AddMsg å‡½æ•°æ˜¾ç¤ºæŒä¹…åŒ–æ¶ˆæ¯
                    persistedMessages.forEach(msgString => {
                        if (typeof msgString === 'string' && msgString.includes('--')) {
                            // *** ä¿®å¤ï¼šæ£€æŸ¥æ˜¯å¦åŒ…å«äº’åŠ¨å†…å®¹å ä½ç¬¦ï¼Œè®°å½•IDé˜²æ­¢é‡å¤å¤„ç† ***
                            const interactiveMatch = msgString.match(/\[å‘ç”Ÿäº†ä¸€æ®µäº’åŠ¨ \(ID: (.+?)\)\]/);
                            if (interactiveMatch) {
                                const interactiveId = interactiveMatch[1];
                                if (processedInteractiveIds.has(interactiveId)) {
                                    console.log(`âš ï¸ è·³è¿‡é‡å¤çš„äº’åŠ¨å†…å®¹: ${interactiveId}`);
                                    return; // è·³è¿‡å·²å¤„ç†çš„äº’åŠ¨å†…å®¹
                                }
                                processedInteractiveIds.add(interactiveId);
                                console.log(`ğŸ“ è®°å½•äº’åŠ¨å†…å®¹ID: ${interactiveId}`);
                            }
                            
                            QQ_Chat_AddMsg(chatContainer, msgString, groupName, false); // ä¿®å¤å‚æ•°é¡ºåºï¼šdom, content, name, isNew
                        }
                    });
                    hasMessages = true;
                }
                
                // 2. å†åŠ è½½å†…å­˜ä¸­çš„ç¾¤èŠæ¶ˆæ¯ï¼ˆwindow.groupChatMessagesï¼‰
                if (window.groupChatMessages && window.groupChatMessages[groupId]) {
                    const memoryMessages = window.groupChatMessages[groupId];
                    console.log(`ä» window.groupChatMessages åŠ è½½ç¾¤èŠ ${groupId} çš„ ${memoryMessages.length} æ¡æ¶ˆæ¯`);
                    
                    // æ˜¾ç¤ºå†…å­˜ä¸­çš„æ¶ˆæ¯ï¼ˆåŒ…æ‹¬ç³»ç»Ÿæ¶ˆæ¯ï¼‰
                    memoryMessages.forEach(message => {
                        if (message.type === 'system') {
                            // *** ä¿®å¤ï¼šæ£€æŸ¥ç³»ç»Ÿæ¶ˆæ¯æ˜¯å¦åŒ…å«äº’åŠ¨å†…å®¹å ä½ç¬¦ ***
                            const interactiveMatch = message.content.match(/\[å‘ç”Ÿäº†ä¸€æ®µäº’åŠ¨ \(ID: (.+?)\)\]/);
                            if (interactiveMatch) {
                                const interactiveId = interactiveMatch[1];
                                if (processedInteractiveIds.has(interactiveId)) {
                                    console.log(`âš ï¸ è·³è¿‡é‡å¤çš„å†…å­˜äº’åŠ¨å†…å®¹: ${interactiveId}`);
                                    return; // è·³è¿‡å·²å¤„ç†çš„äº’åŠ¨å†…å®¹
                                }
                                processedInteractiveIds.add(interactiveId);
                                console.log(`ğŸ“ è®°å½•å†…å­˜äº’åŠ¨å†…å®¹ID: ${interactiveId}`);
                            }
                            
                            // æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯
                            const systemMsgDiv = document.createElement('div');
                            systemMsgDiv.className = 'system-message';
                            systemMsgDiv.style.cssText = `
                                text-align: center;
                                color: #999;
                                font-size: 12px;
                                margin: 10px 0;
                                padding: 5px;
                                line-height: 1.4;
                            `;
                            systemMsgDiv.textContent = message.content;
                            chatContainer.appendChild(systemMsgDiv);
                        } else {
                            // æ˜¾ç¤ºæ™®é€šæ¶ˆæ¯ï¼ˆè¿™é‡Œå¯ä»¥æ‰©å±•æ›´å¤šæ¶ˆæ¯ç±»å‹ï¼‰
                            console.log('æ˜¾ç¤ºæ™®é€šæ¶ˆæ¯:', message);
                            // TODO: æ·»åŠ æ™®é€šæ¶ˆæ¯æ˜¾ç¤ºé€»è¾‘
                        }
                    });
                    hasMessages = true;
                }
                
                // å¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œæ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
                if (!hasMessages && chatContainer.children.length === 0) {
                    const welcomeDiv = document.createElement('div');
                    welcomeDiv.className = 'system-message';
                    welcomeDiv.style.cssText = `
                        text-align: center;
                        color: #999;
                        margin: 20px 0;
                        font-size: 14px;
                    `;
                    welcomeDiv.textContent = 'æ¬¢è¿æ¥åˆ°ç¾¤èŠï¼å¼€å§‹èŠå¤©å§ï½';
                    chatContainer.appendChild(welcomeDiv);
                }
                
                // æ»šåŠ¨åˆ°åº•éƒ¨
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            // ==================== ç¾¤èŠéš”ç¦»åŠŸèƒ½ ====================
            
            /**
             * è·å–å½“å‰ç¾¤èŠçš„æˆå‘˜åˆ—è¡¨
             */
            function getCurrentGroupMembers() {
                if (!window.currentGroupChat) {
                    return [];
                }
                return window.currentGroupChat.members || [];
            }
            
            /**
             * æ£€æŸ¥è§’è‰²æ˜¯å¦åœ¨å½“å‰ç¾¤èŠä¸­
             */
            function isCharacterInCurrentGroup(characterName) {
                if (!window.currentGroupChat) {
                    return true; // å¦‚æœä¸åœ¨ç¾¤èŠä¸­ï¼Œå…è®¸æ‰€æœ‰è§’è‰²å›å¤
                }
                
                const members = getCurrentGroupMembers();
                return members.includes(characterName);
            }
            
            /**
             * ç¾¤èŠæ¶ˆæ¯è¿‡æ»¤å™¨ - åªå…è®¸ç¾¤èŠæˆå‘˜çœ‹åˆ°æ¶ˆæ¯
             */
            function filterGroupChatResponse(response) {
                if (!window.currentGroupChat) {
                    return response; // ä¸åœ¨ç¾¤èŠä¸­ï¼Œä¸éœ€è¦è¿‡æ»¤
                }
                
                const groupName = window.currentGroupChat.name;
                const members = getCurrentGroupMembers();
                
                console.log(`å½“å‰ç¾¤èŠ: ${groupName}, æˆå‘˜: [${members.join(', ')}]`);
                
                // åœ¨å“åº”ä¸­æ·»åŠ ç¾¤èŠä¸Šä¸‹æ–‡ä¿¡æ¯
                let contextInfo = `\n[ç¾¤èŠä¸Šä¸‹æ–‡]\n`;
                contextInfo += `- å½“å‰ç¾¤èŠ: ${groupName}\n`;
                contextInfo += `- ç¾¤èŠæˆå‘˜: ${members.join('ã€')}\n`;
                contextInfo += `- æ³¨æ„: åªæœ‰ä»¥ä¸Šæˆå‘˜èƒ½å¤Ÿçœ‹åˆ°å’Œå›å¤æ­¤ç¾¤èŠä¸­çš„æ¶ˆæ¯\n`;
                contextInfo += `- å…¶ä»–è§’è‰²æ— æ³•çœ‹åˆ°æ­¤ç¾¤èŠçš„å†…å®¹\n`;
                
                return contextInfo + response;
            }
            
            /**
             * é‡å†™QQ_Genå‡½æ•°ä»¥æ”¯æŒç¾¤èŠéš”ç¦»
             */
            const originalQQGen = window.QQ_Gen;
            if (originalQQGen) {
                            window.QQ_Gen = async function(prompt, callback) {
                try {
                    // å¦‚æœåœ¨ç¾¤èŠä¸­ï¼Œæ·»åŠ éš”ç¦»ä¿¡æ¯
                    if (window.currentGroupChat) {
                        const groupName = window.currentGroupChat.name;
                        const members = getCurrentGroupMembers();
                        
                        // åœ¨promptå‰æ·»åŠ ç¾¤èŠé™åˆ¶ä¿¡æ¯
                        const groupContext = `[é‡è¦: å½“å‰åœ¨ç¾¤èŠ"${groupName}"ä¸­ï¼Œåªæœ‰ä»¥ä¸‹æˆå‘˜å¯ä»¥å‚ä¸å¯¹è¯: ${members.join('ã€')}ã€‚å…¶ä»–è§’è‰²æ— æ³•çœ‹åˆ°æ­¤ç¾¤èŠæ¶ˆæ¯ï¼Œä¸åº”å›å¤ã€‚]\n\n`;
                        prompt = groupContext + prompt;
                        
                        console.log('ç¾¤èŠæ¶ˆæ¯å‘é€ï¼Œé™åˆ¶æˆå‘˜:', members);
                    }
                    
                    // è°ƒç”¨åŸå§‹ç”Ÿæˆå‡½æ•°
                    const result = await originalQQGen(prompt);
                    
                    // å¯¹ç»“æœè¿›è¡Œç¾¤èŠè¿‡æ»¤
                    const filteredResult = filterGroupChatResponse(result);
                    
                    // å¦‚æœæä¾›äº†å›è°ƒå‡½æ•°ï¼Œè°ƒç”¨å®ƒ
                    if (typeof callback === 'function') {
                        await callback(filteredResult);
                    }
                    
                    return filteredResult;
                } catch (error) {
                    console.error('QQ_Genæ‰§è¡Œé”™è¯¯:', error);
                    
                    // å¦‚æœæä¾›äº†å›è°ƒå‡½æ•°ï¼Œä¹Ÿè¦é€šçŸ¥é”™è¯¯
                    if (typeof callback === 'function') {
                        try {
                            await callback(null, error);
                        } catch (callbackError) {
                            console.error('å›è°ƒå‡½æ•°æ‰§è¡Œé”™è¯¯:', callbackError);
                        }
                    }
                    
                    throw error;
                }
                };
            }
            
            // ==================== é¡µé¢åˆå§‹åŒ–å¢å¼º ====================
            
            /**
             * å¢å¼ºçš„é¡µé¢åˆå§‹åŒ–ï¼ŒåŒ…å«ç¾¤èŠåŠŸèƒ½
             */
            async function initializeEnhancedFeatures() {
                // *** ä¿®å¤ï¼šç¾¤èŠæ•°æ®é€šè¿‡ä¸¤é˜¶æ®µåŠ è½½æœºåˆ¶å¤„ç† ***
                if (worldbook) {
                    console.log('initializeEnhancedFeatures: ç¾¤èŠæ•°æ®å°†é€šè¿‡ä¸¤é˜¶æ®µåŠ è½½æœºåˆ¶å¤„ç†');
                } else {
                    console.log('initializeEnhancedFeatures: worldbookæœªåˆå§‹åŒ–ï¼Œè·³è¿‡ç¾¤èŠåŠ è½½');
                }
                
                // åˆå§‹åŒ–åˆ†ç»„åŠŸèƒ½
                if (typeof QQ_LoadContactGroups === 'function' && worldbook) {
                    await QQ_LoadContactGroups();
                } else if (!worldbook) {
                    console.log('initializeEnhancedFeatures: worldbookæœªåˆå§‹åŒ–ï¼Œè·³è¿‡åˆ†ç»„åŠ è½½');
                }
                
                if (typeof initContactGroups === 'function') {
                    initContactGroups();
                }
                
                // *** ä¿®å¤ï¼šåœ¨åˆå§‹åŒ–å®Œæˆåæ›´æ–°æ‰€æœ‰ç¾¤èŠçš„æœ€åæ¶ˆæ¯æ˜¾ç¤º ***
                setTimeout(async () => {
                    console.log('å¼€å§‹æ›´æ–°æ‰€æœ‰ç¾¤èŠçš„æœ€åæ¶ˆæ¯æ˜¾ç¤º...');
                    try {
                        // *** ä¿®å¤ï¼šä½¿ç”¨ç¼“å­˜çš„ç¾¤èŠå…ƒæ•°æ® ***
                        const groups = window.QQ_Group_Chats_Data || [];
                        if (groups && Array.isArray(groups)) {
                        groups.forEach(groupData => {
                                if (groupData && groupData.name) {
                            updateGroupLastMessageDisplay(groupData.name);
                                }
                        });
                        console.log('æ‰€æœ‰ç¾¤èŠæœ€åæ¶ˆæ¯æ˜¾ç¤ºæ›´æ–°å®Œæˆ');
                        } else {
                            console.warn('ç¾¤èŠæ•°æ®æ— æ•ˆï¼Œè·³è¿‡æœ€åæ¶ˆæ¯æ˜¾ç¤ºæ›´æ–°');
                        }

                        // *** æ–°å¢ï¼šåŒæ—¶æ›´æ–°æ•´ä¸ªæ¶ˆæ¯åˆ—è¡¨ï¼Œç¡®ä¿ç§èŠä¿¡æ¯ä¹Ÿæ˜¾ç¤º ***
                        console.log('åˆ·æ–°æ•´ä¸ªæ¶ˆæ¯åˆ—è¡¨ä»¥æ˜¾ç¤ºç§èŠå’Œç¾¤èŠçš„æœ€åæ¶ˆæ¯...');
                        await QQ_UpdateMessageList();

                    } catch (error) {
                        console.error('æ›´æ–°ç¾¤èŠæœ€åæ¶ˆæ¯æ˜¾ç¤ºæ—¶å‡ºé”™:', error);
                    }
                }, 500);
                
                // åˆå§‹åŒ–åŠ¨æ€ç‚¹èµåŠŸèƒ½
                if (typeof QQ_InitMomentLikes === 'function') {
                    QQ_InitMomentLikes();
                    console.log('- åŠ¨æ€ç‚¹èµåŠŸèƒ½å·²å¯ç”¨');
                }
                
                // åŠ è½½åŠ¨æ€ç‚¹èµçŠ¶æ€
                if (typeof QQ_LoadMomentLikes === 'function') {
                    await QQ_LoadMomentLikes();
                }
                
                console.log('å¢å¼ºåŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
                console.log('- ç¾¤èŠåŠŸèƒ½å·²å¯ç”¨');
                console.log('- åˆ†ç»„åŠŸèƒ½å·²å¯ç”¨');
                console.log('- å¤´åƒè®¾ç½®å·²å¯ç”¨');
                console.log('- æ‹–æ‹½åŠŸèƒ½å·²å¯ç”¨');
            }
            
            // åœ¨é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–å¢å¼ºåŠŸèƒ½
            if (document.readyState === 'complete' || document.readyState === 'interactive') {
                setTimeout(initializeEnhancedFeatures, 1000);
                // *** é˜¶æ®µäºŒï¼šåˆå§‹åŒ–ä¸Šä¸‹æ–‡æ„ŸçŸ¥ç³»ç»Ÿ ***
                // å»¶è¿Ÿ100msç¡®ä¿æ‰€æœ‰å…¨å±€å˜é‡å·²åˆå§‹åŒ–
                setTimeout(() => {
                    QQ_InitializeOnlineStatusDetection();
                }, 100);
            } else {
                document.addEventListener('DOMContentLoaded', () => {
                    setTimeout(initializeEnhancedFeatures, 1000);
                    // *** é˜¶æ®µäºŒï¼šåˆå§‹åŒ–ä¸Šä¸‹æ–‡æ„ŸçŸ¥ç³»ç»Ÿ ***
                    // å»¶è¿Ÿ100msç¡®ä¿æ‰€æœ‰å…¨å±€å˜é‡å·²åˆå§‹åŒ–
                    setTimeout(() => {
                        QQ_InitializeOnlineStatusDetection();
                    }, 100);
                });
            }
            
        </script>
        
        <!-- ä¿®å¤æŒ‰é’®ç‚¹å‡»é—®é¢˜ï¼šå°†å…³é”®å‡½æ•°æ”¾åœ¨å•ç‹¬çš„scriptæ ‡ç­¾ä¸­ -->
        <script>
            // ç¡®ä¿å…¨å±€å˜é‡å¯ç”¨
            window.selectedAvatarData = null;
            
            // ç¡®ä¿è¿™äº›å‡½æ•°åœ¨å…¨å±€ä½œç”¨åŸŸä¸­å¯ç”¨
            window.confirmAvatarSelection = function() {
                console.log('ğŸ”µ confirmAvatarSelection è¢«è°ƒç”¨ï¼');
                console.log('å½“å‰é€‰ä¸­çš„å¤´åƒæ•°æ®:', window.selectedAvatarData);
                
                // å¦‚æœæ²¡æœ‰é€‰æ‹©å¤´åƒï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ
                if (!window.selectedAvatarData) {
                    window.selectedAvatarData = {
                        type: 'preset',
                        gradient: { start: '#199AFF', end: '#0066CC' },
                        text: 'ç¾¤'
                    };
                    console.log('ä½¿ç”¨é»˜è®¤å¤´åƒ:', window.selectedAvatarData);
                }
                
                const previewElement = document.getElementById('group_avatar_preview');
                const textElement = document.querySelector('.group-avatar-text');
                
                if (!previewElement || !textElement) {
                    console.error('æ‰¾ä¸åˆ°å¤´åƒé¢„è§ˆå…ƒç´ ');
                    alert('æ‰¾ä¸åˆ°å¤´åƒé¢„è§ˆå…ƒç´ ï¼Œè¯·æ£€æŸ¥é¡µé¢ç»“æ„');
                    return;
                }
                
                try {
                    if (window.selectedAvatarData.type === 'preset') {
                        // é¢„è®¾å¤´åƒ
                        const gradient = window.selectedAvatarData.gradient;
                        previewElement.style.background = `linear-gradient(135deg, ${gradient.start}, ${gradient.end})`;
                        previewElement.style.backgroundImage = 'none';
                        previewElement.innerHTML = `<div class="default-group-avatar">${window.selectedAvatarData.text}</div>`;
                        textElement.textContent = 'å·²è®¾ç½®é¢„è®¾å¤´åƒ';
                    } else if (window.selectedAvatarData.type === 'upload') {
                        // ä¸Šä¼ çš„å¤´åƒ
                        previewElement.style.background = 'none';
                        previewElement.style.backgroundImage = `url('${window.selectedAvatarData.imageData}')`;
                        previewElement.style.backgroundSize = 'cover';
                        previewElement.style.backgroundPosition = 'center';
                        previewElement.innerHTML = '';
                        textElement.textContent = 'å·²è®¾ç½®è‡ªå®šä¹‰å¤´åƒ';
                    }
                    
                    console.log('å¤´åƒè®¾ç½®æˆåŠŸï¼Œå…³é—­é€‰æ‹©å™¨');
                    
                    // å…³é—­å¤´åƒé€‰æ‹©å™¨
                    const modal = document.getElementById('avatar_selector_modal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                    
                    alert('å¤´åƒè®¾ç½®æˆåŠŸï¼');
                    
                } catch (error) {
                    console.error('å¤´åƒè®¾ç½®æ—¶å‡ºé”™:', error);
                    alert('å¤´åƒè®¾ç½®å¤±è´¥ï¼š' + error.message);
                }
            };
            
            // æ·»åŠ å…¨å±€æ¸…ç†å‡½æ•°
            window.cleanupDuplicateGroups = cleanupDuplicateGroups;
            window.checkWorldbookGroups = checkWorldbookGroups;
            
            window.createGroupChat = async function() {
                console.log('ğŸ”µ createGroupChat è¢«è°ƒç”¨ï¼ï¼ˆä½¿ç”¨æ–°çš„ä¸–ç•Œä¹¦é€»è¾‘ï¼‰');
                
                try {
                    const nameInput = document.getElementById('group_name_input');
                    if (!nameInput) {
                        console.error('æ‰¾ä¸åˆ°ç¾¤èŠåç§°è¾“å…¥æ¡†');
                        alert('ç³»ç»Ÿé”™è¯¯ï¼šæ‰¾ä¸åˆ°ç¾¤èŠåç§°è¾“å…¥æ¡†');
                        return;
                    }
                    
                    const groupName = nameInput.value.trim();
                    console.log('ç¾¤èŠåç§°:', groupName);
                    
                    if (!groupName) {
                        alert('è¯·è¾“å…¥ç¾¤èŠåç§°');
                        return;
                    }
                    
                    // è·å–é€‰ä¸­çš„æˆå‘˜
                    const selectedContacts = Array.from(document.querySelectorAll('#contact_list_for_group .contact-item.selected'));
                    
                    console.log('=== ç¾¤èŠåˆ›å»ºè°ƒè¯•ä¿¡æ¯ ===');
                    console.log('æ‰€æœ‰è”ç³»äººé¡¹ç›®:', document.querySelectorAll('#contact_list_for_group .contact-item'));
                    console.log('é€‰ä¸­çš„è”ç³»äººé¡¹ç›®:', selectedContacts);
                    console.log('é€‰ä¸­çš„è”ç³»äººæ•°é‡:', selectedContacts.length);
                    
                    if (selectedContacts.length === 0) {
                        alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç¾¤æˆå‘˜');
                        return;
                    }
                    
                    // ç¦ç”¨åˆ›å»ºæŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
                    const confirmBtn = document.getElementById('group_confirm_btn');
                    if (confirmBtn) {
                        confirmBtn.disabled = true;
                        confirmBtn.textContent = 'åˆ›å»ºä¸­...';
                    }
                    
                    // è·å–æˆå‘˜åˆ—è¡¨
                    const members = selectedContacts.map(contact => {
                        const nameElement = contact.querySelector('.contact-name');
                        return nameElement ? nameElement.textContent.trim() : '';
                    }).filter(name => name);
                    
                    // è·å–å¤´åƒURL
                    let avatarUrl = 'http://sharkpan.xyz/f/z0WU5/mmexport1736971020657.gif';
                    if (window.selectedAvatarData && window.selectedAvatarData.type === 'upload' && window.selectedAvatarData.imageData) {
                        avatarUrl = window.selectedAvatarData.imageData;
                    }
                    
                    console.log('å‡†å¤‡è°ƒç”¨createNewGroupï¼Œå‚æ•°:', { groupName, members, avatarUrl });
                    
                    // ä½¿ç”¨æ–°çš„createNewGroupå‡½æ•°ï¼ˆä¸–ç•Œä¹¦é€»è¾‘ï¼‰
                    const success = await createNewGroup(groupName, members, avatarUrl);
                    if (!success) {
                        // æ¢å¤åˆ›å»ºæŒ‰é’®çŠ¶æ€
                        if (confirmBtn) {
                            confirmBtn.disabled = false;
                            confirmBtn.textContent = 'åˆ›å»ºç¾¤èŠ';
                        }
                        return;
                    }
                    
                    // å…³é—­å¼¹çª—
                    const modal = document.getElementById('group_create_modal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                    
                    // é‡ç½®è¡¨å•
                    nameInput.value = '';
                    window.selectedAvatarData = null;
                    const preview = document.getElementById('group_avatar_preview');
                    const text = document.querySelector('.group-avatar-text');
                    if (preview && text) {
                        preview.style.background = 'linear-gradient(135deg, #199AFF, #0066CC)';
                        preview.innerHTML = '<div class="default-group-avatar">+</div>';
                        text.textContent = 'ç‚¹å‡»è®¾ç½®å¤´åƒ';
                    }
                    
                    console.log('ç¾¤èŠåˆ›å»ºæˆåŠŸ:', groupName);
                    alert(`ç¾¤èŠ"${groupName}"åˆ›å»ºæˆåŠŸï¼`);
                    
                    // *** å…³é”®ä¿®å¤ï¼šç”¨æˆ·ç‚¹å‡»ç¡®è®¤åï¼Œç«‹å³é‡æ–°æ¸²æŸ“è”ç³»äººç•Œé¢ ***
                    console.log('ç”¨æˆ·ç¡®è®¤ç¾¤èŠåˆ›å»ºå®Œæˆï¼Œç°åœ¨é‡æ–°æ¸²æŸ“è”ç³»äººç•Œé¢');
                    if (typeof renderContactGroups === 'function') {
                        await renderContactGroups();
                        console.log('è”ç³»äººç•Œé¢é‡æ–°æ¸²æŸ“å®Œæˆï¼Œæ–°ç¾¤èŠå·²æ˜¾ç¤º');
                    }
                    
                    // æ¢å¤åˆ›å»ºæŒ‰é’®çŠ¶æ€
                    if (confirmBtn) {
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = 'åˆ›å»ºç¾¤èŠ';
                    }
                    
                } catch (error) {
                    console.error('åˆ›å»ºç¾¤èŠæ—¶å‡ºé”™:', error);
                    alert('åˆ›å»ºç¾¤èŠå¤±è´¥ï¼š' + error.message);
                    
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    const confirmBtn = document.getElementById('group_confirm_btn');
                    if (confirmBtn) {
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = 'åˆ›å»ºç¾¤èŠ';
                    }
                }
            };
            
            // saveGroupToStorageå‡½æ•°å·²ç§»é™¤ï¼Œç°åœ¨ä½¿ç”¨ä¸–ç•Œä¹¦å­˜å‚¨
            
            /**
             * ä»æœ¬åœ°å­˜å‚¨åŠ è½½ç¾¤èŠæ•°æ®
             */
            // æ­¤å‡½æ•°å·²è¢«loadGroupChatsFromWorldbookæ›¿ä»£ï¼Œä¸ºäº†å…¼å®¹æ€§ä¿ç•™åˆ«å
            /**
             * *** å·²ç§»é™¤ï¼šé‡å¤çš„loadGroupsFromStorageå‡½æ•° ***
             * ç°åœ¨ç»Ÿä¸€ä½¿ç”¨ä¸–ç•Œä¹¦åŠ è½½æœºåˆ¶
             */
            
            
            /**
             * æ›´æ–°è”ç³»äººåˆ—è¡¨ä¸­çš„ç¾¤èŠä¿¡æ¯
             */
            function updateGroupInContactList(element, groupData) {
                const nameDiv = element.querySelector('.QQ_home_name');
                const msgDiv = element.querySelector('.QQ_home_lastmsg');
                
                if (nameDiv) nameDiv.textContent = groupData.name;
                if (msgDiv) msgDiv.textContent = `ç¾¤èŠ Â· ${groupData.members.length}äºº`;
            }
            
            /**
             * æ›´æ–°æ¶ˆæ¯åˆ—è¡¨ä¸­çš„ç¾¤èŠä¿¡æ¯
             */
            function updateGroupInMessageList(element, groupData) {
                const nameDiv = element.querySelector('.QQ_home_name');
                const msgDiv = element.querySelector('.QQ_home_lastmsg');
                const timeDiv = element.querySelector('.QQ_home_lasttime');
                const avatarDiv = element.querySelector('.QQ_home_head');
                
                if (nameDiv) nameDiv.textContent = groupData.name;
                if (msgDiv) msgDiv.textContent = groupData.lastMessage || 'ç¾¤èŠå·²åˆ›å»º';
                if (timeDiv) {
                    const currentTime = new Date();
                    const timeString = groupData.timestamp || groupData.lastTime || currentTime.toLocaleTimeString('zh-CN', { hour12: false }).slice(0, 5);
                    timeDiv.textContent = timeString;
                }
                
                // æ›´æ–°å¤´åƒ
                if (avatarDiv) {
                    if (groupData.avatar && groupData.avatar.type === 'preset' && groupData.avatar.gradient) {
                        const gradient = groupData.avatar.gradient;
                        avatarDiv.style.background = `linear-gradient(135deg, ${gradient.start}, ${gradient.end})`;
                        avatarDiv.style.color = 'white';
                        avatarDiv.style.display = 'flex';
                        avatarDiv.style.alignItems = 'center';
                        avatarDiv.style.justifyContent = 'center';
                        avatarDiv.style.fontWeight = 'bold';
                        avatarDiv.style.fontSize = '18px';
                        avatarDiv.textContent = groupData.avatar.text || 'ç¾¤';
                    } else if (groupData.avatar && groupData.avatar.type === 'upload' && groupData.avatar.imageData) {
                        // æ¸…é™¤æ‰€æœ‰å¯èƒ½å†²çªçš„æ ·å¼
                        avatarDiv.style.background = '';
                        avatarDiv.style.backgroundColor = '';
                        avatarDiv.style.color = '';
                        avatarDiv.style.display = 'block'; // ç¡®ä¿å…ƒç´ å¯è§
                        avatarDiv.style.alignItems = '';
                        avatarDiv.style.justifyContent = '';
                        avatarDiv.style.fontWeight = '';
                        avatarDiv.style.fontSize = '';
                        avatarDiv.textContent = '';
                        
                        // ç¡®ä¿åŸºç¡€å°ºå¯¸æ ·å¼æ­£ç¡®
                        avatarDiv.style.width = '40px';
                        avatarDiv.style.height = '40px';
                        avatarDiv.style.borderRadius = '50%';
                        avatarDiv.style.minWidth = '40px';
                        
                        // è®¾ç½®èƒŒæ™¯å›¾ç‰‡
                        avatarDiv.style.backgroundImage = `url('${groupData.avatar.imageData}')`;
                        avatarDiv.style.backgroundSize = 'cover';
                        avatarDiv.style.backgroundPosition = 'center';
                        avatarDiv.style.backgroundRepeat = 'no-repeat';
                    } else {
                        // é»˜è®¤å¤´åƒ
                        avatarDiv.style.background = 'linear-gradient(135deg, #199AFF, #0066CC)';
                        avatarDiv.style.color = 'white';
                        avatarDiv.style.display = 'flex';
                        avatarDiv.style.alignItems = 'center';
                        avatarDiv.style.justifyContent = 'center';
                        avatarDiv.style.fontWeight = 'bold';
                        avatarDiv.style.fontSize = '18px';
                        avatarDiv.textContent = 'ç¾¤';
                        avatarDiv.style.backgroundImage = '';
                    }
                }
            }
            
            /**
             * é¡µé¢åŠ è½½æ—¶æ¢å¤ç¾¤èŠæ•°æ®
             */
            async function restoreGroupChats() {
                console.log('æ¢å¤ç¾¤èŠæ•°æ®...');
                if (!worldbook) {
                    console.log('restoreGroupChats: worldbookæœªåˆå§‹åŒ–ï¼Œè·³è¿‡ç¾¤èŠæ¢å¤');
                    return;
                }
                // *** ä¿®å¤ï¼šä½¿ç”¨ç¼“å­˜çš„ç¾¤èŠå…ƒæ•°æ®ï¼Œé¿å…é‡æ–°åŠ è½½ ***
                const groups = window.QQ_Group_Chats_Data || [];
                
                groups.forEach(groupData => {
                    console.log('æ¢å¤ç¾¤èŠ:', groupData.name);
                    AddNewGroup(groupData.name, groupData.avatar || QQ_GetRandomAvatar() || 'https://files.catbox.moe/skngqq.jpg', groupData.members, groupData.description);
                });
                
                console.log('ç¾¤èŠæ•°æ®æ¢å¤å®Œæˆï¼Œå…±', groups.length, 'ä¸ªç¾¤èŠ');
            }
            
            // é¡µé¢åŠ è½½å®Œæˆåæ¢å¤ç¾¤èŠæ•°æ®ï¼ˆæš‚æ—¶ç¦ç”¨ï¼Œé¿å…ä¸ç»Ÿä¸€åˆå§‹åŒ–å†²çªï¼‰
            // document.addEventListener('DOMContentLoaded', function() {
            //     setTimeout(restoreGroupChats, 500);
            // });
            
            // å¦‚æœé¡µé¢å·²ç»åŠ è½½å®Œæˆï¼Œç«‹å³æ¢å¤ï¼ˆæš‚æ—¶ç¦ç”¨ï¼Œé¿å…ä¸ç»Ÿä¸€åˆå§‹åŒ–å†²çªï¼‰
            // if (document.readyState === 'complete' || document.readyState === 'interactive') {
            //     setTimeout(restoreGroupChats, 500);
            // }
            
            // ==================== ç¾¤èŠç®¡ç†åŠŸèƒ½ ====================
            
            let currentManagingGroup = null;
            
            /**
             * æ˜¾ç¤ºç¾¤èŠç®¡ç†ä¸‹æ‹‰èœå•
             */
            function showGroupManagementMenu(groupData, triggerElement) {
                console.log('=== showGroupManagementMenu è¢«è°ƒç”¨ ===');
                console.log('æ˜¾ç¤ºç¾¤èŠç®¡ç†èœå•:', groupData.name);
                
                // *** å…³é”®ä¿®å¤ï¼šç›´æ¥ä»ä¸–ç•Œä¹¦è·å–æœ€æ–°çš„å¤´åƒæ•°æ® ***
                console.log('åŸå§‹groupData:', JSON.stringify(groupData, null, 2));
                
                currentManagingGroup = Object.assign({}, groupData); // åˆ›å»ºå‰¯æœ¬
                
                // ä»ä¸–ç•Œä¹¦è·å–æœ€æ–°çš„å¤´åƒæ•°æ®
                try {
                    const worldbookAvatar = getGroupAvatarFromWorldbook(groupData.name);
                    if (worldbookAvatar && worldbookAvatar.avatarUrl) {
                        console.log('ä»ä¸–ç•Œä¹¦è·å–åˆ°æœ€æ–°å¤´åƒæ•°æ®:', worldbookAvatar.avatarUrl);
                        
                        // æ ¹æ®å¤´åƒæ•°æ®ç±»å‹æ„å»ºæ­£ç¡®çš„æ ¼å¼
                        if (worldbookAvatar.avatarUrl.startsWith('data:')) {
                            // Base64æ•°æ®ï¼Œæ„å»ºä¸ºä¸Šä¼ æ ¼å¼
                            currentManagingGroup.avatar = {
                                type: 'upload',
                                imageData: worldbookAvatar.avatarUrl,
                                dataSize: Math.round(worldbookAvatar.avatarUrl.length * 0.75)
                            };
                            console.log('ä¸–ç•Œä¹¦å¤´åƒä¸ºBase64æ ¼å¼ï¼Œå·²è½¬æ¢ä¸ºå¯¹è±¡æ ¼å¼');
                        } else {
                            // URLæ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨
                            currentManagingGroup.avatar = worldbookAvatar.avatarUrl;
                            console.log('ä¸–ç•Œä¹¦å¤´åƒä¸ºURLæ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨');
                        }
                    } else {
                        console.log('ä¸–ç•Œä¹¦ä¸­æœªæ‰¾åˆ°å¤´åƒæ•°æ®ï¼Œä¿æŒåŸå§‹å¤´åƒ');
                    }
                } catch (error) {
                    console.error('ä»ä¸–ç•Œä¹¦è·å–å¤´åƒå¤±è´¥:', error);
                }
                
                console.log('currentManagingGroup å·²è®¾ç½®ä¸º:', currentManagingGroup);
                console.log('currentManagingGroup å¤´åƒæ•°æ®:', currentManagingGroup.avatar);
                
                const dropdown = document.getElementById('group_management_dropdown');
                if (!dropdown) {
                    console.error('æœªæ‰¾åˆ°ç¾¤èŠç®¡ç†ä¸‹æ‹‰èœå•å…ƒç´ ');
                    return;
                }
                
                // è®¾ç½®ä¸‹æ‹‰èœå•ä½ç½®
                const rect = triggerElement.getBoundingClientRect();
                dropdown.style.position = 'fixed';
                dropdown.style.top = (rect.bottom + 5) + 'px';
                dropdown.style.left = rect.left + 'px';
                dropdown.style.width = Math.max(200, rect.width) + 'px';
                
                // ç”Ÿæˆç¾¤æˆå‘˜åˆ—è¡¨
                const membersList = document.getElementById('group_members_display');
                membersList.innerHTML = '';
                
                groupData.members.forEach((memberName, index) => {
                    const memberItem = document.createElement('div');
                    memberItem.className = 'group-member-item';
                    
                    const memberAvatar = document.createElement('div');
                    memberAvatar.className = 'group-member-avatar';
                    
                    // *** ä¿®å¤ï¼šä¼˜å…ˆä»ä¸–ç•Œä¹¦è·å–æˆå‘˜å¤´åƒ ***
                    console.log(`ç¾¤èŠä¸‹æ‹‰èœå•ï¼šè·å–æˆå‘˜ ${memberName} å¤´åƒ`);
                    const worldbookAvatar = getCharacterAvatarFromWorldbook(memberName);
                    if (worldbookAvatar) {
                        memberAvatar.style.backgroundImage = worldbookAvatar.backgroundImage;
                        memberAvatar.style.backgroundSize = 'cover';
                        memberAvatar.style.backgroundPosition = 'center';
                        memberAvatar.style.backgroundRepeat = 'no-repeat';
                        memberAvatar.style.borderRadius = '50%';
                        memberAvatar.style.width = '32px';
                        memberAvatar.style.height = '32px';
                        memberAvatar.style.flexShrink = '0';
                        memberAvatar.textContent = '';
                        console.log(`ç¾¤èŠä¸‹æ‹‰èœå•ï¼šæˆåŠŸåº”ç”¨ ${memberName} çš„ä¸–ç•Œä¹¦å¤´åƒ`);
                    } else {
                        // å¤‡é€‰æ–¹æ¡ˆ
                        const memberAvatarData = getCharacterAvatar(memberName);
                        applyCharacterAvatar(memberAvatar, memberAvatarData, memberName);
                        memberAvatar.style.width = '32px';
                        memberAvatar.style.height = '32px';
                        console.log(`ç¾¤èŠä¸‹æ‹‰èœå•ï¼šä½¿ç”¨å¤‡é€‰æ–¹æ¡ˆä¸º ${memberName} åº”ç”¨å¤´åƒ`);
                    }
                    
                    const memberNameDiv = document.createElement('div');
                    memberNameDiv.className = 'group-member-name';
                    memberNameDiv.textContent = memberName;
                    
                    memberItem.appendChild(memberAvatar);
                    memberItem.appendChild(memberNameDiv);
                    membersList.appendChild(memberItem);
                });
                
                // æ˜¾ç¤ºä¸‹æ‹‰èœå•
                dropdown.style.display = 'block';
                
                // æ·»åŠ ç‚¹å‡»å¤–éƒ¨å…³é—­åŠŸèƒ½
                setTimeout(() => {
                    document.addEventListener('click', closeGroupManagementMenu);
                }, 100);
            }
            
            /**
             * å…³é—­ç¾¤èŠç®¡ç†ä¸‹æ‹‰èœå•
             */
            function closeGroupManagementMenu(event) {
                const dropdown = document.getElementById('group_management_dropdown');
                if (!dropdown) return;
                
                // å¦‚æœç‚¹å‡»çš„æ˜¯ä¸‹æ‹‰èœå•å†…éƒ¨ï¼Œä¸å…³é—­
                if (event && dropdown.contains(event.target)) {
                    return;
                }
                
                dropdown.style.display = 'none';
                document.removeEventListener('click', closeGroupManagementMenu);
            }
            
            /**
             * æ˜¾ç¤ºç¾¤èŠè®¾ç½®æ¨¡æ€çª—å£
             */
            function showGroupSettings() {
                console.log('=== showGroupSettings è¢«è°ƒç”¨ ===');
                if (!currentManagingGroup) {
                    console.error('æ²¡æœ‰å½“å‰ç®¡ç†çš„ç¾¤èŠ');
                    return;
                }
                
                console.log('æ˜¾ç¤ºç¾¤èŠè®¾ç½®:', currentManagingGroup.name);
                
                // å…³é—­ä¸‹æ‹‰èœå•
                closeGroupManagementMenu();
                
                const modal = document.getElementById('group_settings_modal');
                if (!modal) {
                    console.error('æœªæ‰¾åˆ°ç¾¤èŠè®¾ç½®æ¨¡æ€çª—å£');
                    return;
                }
                
                // å¡«å……å½“å‰ç¾¤èŠä¿¡æ¯
                const nameInput = document.getElementById('group_name_edit');
                if (nameInput) {
                    nameInput.value = currentManagingGroup.name;
                }
                
                // *** ä¿®å¤ï¼šä¼˜å…ˆä»ä¸–ç•Œä¹¦è·å–ç¾¤èŠå¤´åƒ ***
                const avatarPreview = document.getElementById('group_settings_avatar_preview');
                if (avatarPreview) {
                    avatarPreview.innerHTML = '';
                    
                    console.log(`ç¾¤èŠè®¾ç½®ï¼šè·å–ç¾¤èŠ ${currentManagingGroup.name} å¤´åƒ`);
                    
                    // é¦–å…ˆå°è¯•ä»ä¸–ç•Œä¹¦è·å–ç¾¤èŠå¤´åƒ
                    const worldbookGroupAvatar = getGroupAvatarFromWorldbook(currentManagingGroup.name);
                    let realAvatarFound = false;
                    
                    if (worldbookGroupAvatar) {
                        console.log(`ä»ä¸–ç•Œä¹¦è·å–åˆ°ç¾¤èŠ ${currentManagingGroup.name} å¤´åƒ:`, worldbookGroupAvatar);
                        const avatarImg = document.createElement('div');
                        avatarImg.style.backgroundImage = worldbookGroupAvatar.backgroundImage;
                        avatarImg.style.backgroundSize = 'cover';
                        avatarImg.style.backgroundPosition = 'center';
                        avatarImg.style.backgroundRepeat = 'no-repeat';
                        avatarImg.style.borderRadius = '12px';
                        avatarImg.style.width = '100%';
                        avatarImg.style.height = '100%';
                        avatarPreview.appendChild(avatarImg);
                        realAvatarFound = true;
                    } else {
                        // å¤‡é€‰æ–¹æ¡ˆï¼šä»ç¾¤èŠåˆ—è¡¨ä¸­è·å–çœŸå®çš„å¤´åƒæ•°æ®
                        const contactsContainer = document.getElementById('QQ_home_chars');
                        
                        if (contactsContainer) {
                            const groupElements = contactsContainer.querySelectorAll('.QQ_home_char[data-group-type="true"]');
                            for (let element of groupElements) {
                                const nameElement = element.querySelector('.QQ_home_name');
                                if (nameElement && nameElement.textContent.trim() === currentManagingGroup.name) {
                                    const avatarElement = element.querySelector('.QQ_home_head');
                                    if (avatarElement) {
                                        // åˆ›å»ºä¸€ä¸ªå’Œè”ç³»äººåˆ—è¡¨ä¸­ç›¸åŒçš„å¤´åƒ
                                        const avatarClone = document.createElement('div');
                                        avatarClone.style.cssText = avatarElement.style.cssText;
                                        avatarClone.style.width = '60px';
                                        avatarClone.style.height = '60px';
                                        avatarClone.style.fontSize = '20px';
                                        avatarClone.textContent = avatarElement.textContent;
                                        avatarPreview.appendChild(avatarClone);
                                        realAvatarFound = true;
                                        break;
                                    }
                                }
                            }
                        }
                        
                        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°çœŸå®å¤´åƒï¼Œå°è¯•ä½¿ç”¨å­˜å‚¨çš„å¤´åƒæ•°æ®
                        if (!realAvatarFound && currentManagingGroup.avatar) {
                            if (currentManagingGroup.avatar.startsWith('avatar_')) {
                                const avatarData = localStorage.getItem(`avatarData_${currentManagingGroup.avatar.replace('avatar_', '')}`);
                                if (avatarData) {
                                    const img = document.createElement('img');
                                    img.src = avatarData;
                                    img.alt = 'ç¾¤èŠå¤´åƒ';
                                    img.style.width = '100%';
                                    img.style.height = '100%';
                                    img.style.objectFit = 'cover';
                                    avatarPreview.appendChild(img);
                                    realAvatarFound = true;
                                }
                            } else if (currentManagingGroup.avatar.startsWith('http')) {
                                // ç›´æ¥æ˜¯URL
                                const img = document.createElement('img');
                                img.src = currentManagingGroup.avatar;
                                img.alt = 'ç¾¤èŠå¤´åƒ';
                                img.style.width = '100%';
                                img.style.height = '100%';
                                img.style.objectFit = 'cover';
                                avatarPreview.appendChild(img);
                                realAvatarFound = true;
                            }
                        }
                    }
                    
                    // å¦‚æœä»ç„¶æ²¡æœ‰å¤´åƒï¼Œæ˜¾ç¤ºé»˜è®¤å¤´åƒ
                    if (!realAvatarFound) {
                        const defaultAvatar = document.createElement('div');
                        defaultAvatar.className = 'group-settings-default-avatar';
                        defaultAvatar.textContent = currentManagingGroup.name.charAt(0);
                        defaultAvatar.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                        defaultAvatar.style.color = 'white';
                        defaultAvatar.style.width = '100%';
                        defaultAvatar.style.height = '100%';
                        defaultAvatar.style.display = 'flex';
                        defaultAvatar.style.alignItems = 'center';
                        defaultAvatar.style.justifyContent = 'center';
                        avatarPreview.appendChild(defaultAvatar);
                        console.log(`ç¾¤èŠè®¾ç½®ï¼šä½¿ç”¨é»˜è®¤å¤´åƒæ˜¾ç¤º ${currentManagingGroup.name}`);
                    }
                }
                
                // ç”Ÿæˆç¾¤æˆå‘˜ç¼–è¾‘åˆ—è¡¨
                const membersEdit = document.getElementById('group_members_edit');
                if (membersEdit) {
                    membersEdit.innerHTML = '';
                    
                    // æ·»åŠ ç°æœ‰æˆå‘˜
                    currentManagingGroup.members.forEach((memberName, index) => {
                        const memberItem = document.createElement('div');
                        memberItem.className = 'group-settings-member-item';
                        
                        const memberInfo = document.createElement('div');
                        memberInfo.className = 'group-settings-member-info';
                        
                        const memberAvatar = document.createElement('div');
                        memberAvatar.className = 'group-member-avatar';
                        
                        // *** ä¿®å¤ï¼šä¼˜å…ˆä»ä¸–ç•Œä¹¦è·å–æˆå‘˜å¤´åƒ ***
                        console.log(`ç¾¤èŠè®¾ç½®ï¼šè·å–æˆå‘˜ ${memberName} å¤´åƒ`);
                        const worldbookAvatar = getCharacterAvatarFromWorldbook(memberName);
                        if (worldbookAvatar) {
                            memberAvatar.style.backgroundImage = worldbookAvatar.backgroundImage;
                            memberAvatar.style.backgroundSize = 'cover';
                            memberAvatar.style.backgroundPosition = 'center';
                            memberAvatar.style.backgroundRepeat = 'no-repeat';
                            memberAvatar.style.borderRadius = '50%';
                            memberAvatar.style.width = '32px';
                            memberAvatar.style.height = '32px';
                            memberAvatar.style.flexShrink = '0';
                            memberAvatar.textContent = '';
                            console.log(`ç¾¤èŠè®¾ç½®ï¼šæˆåŠŸåº”ç”¨ ${memberName} çš„ä¸–ç•Œä¹¦å¤´åƒ`);
                        } else {
                            // å¤‡é€‰æ–¹æ¡ˆ
                            const memberAvatarData = getCharacterAvatar(memberName);
                            applyCharacterAvatar(memberAvatar, memberAvatarData, memberName);
                            memberAvatar.style.width = '32px';
                            memberAvatar.style.height = '32px';
                            console.log(`ç¾¤èŠè®¾ç½®ï¼šä½¿ç”¨å¤‡é€‰æ–¹æ¡ˆä¸º ${memberName} åº”ç”¨å¤´åƒ`);
                        }
                        
                        const memberNameDiv = document.createElement('div');
                        memberNameDiv.className = 'group-member-name';
                        memberNameDiv.textContent = memberName;
                        
                        memberInfo.appendChild(memberAvatar);
                        memberInfo.appendChild(memberNameDiv);
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'group-settings-remove-btn';
                        removeBtn.textContent = 'ç§»é™¤';
                        removeBtn.onclick = () => removeMemberFromGroup(memberName);
                        
                        memberItem.appendChild(memberInfo);
                        memberItem.appendChild(removeBtn);
                        membersEdit.appendChild(memberItem);
                    });
                    
                    // æ·»åŠ "æ·»åŠ æˆå‘˜"æŒ‰é’®
                    const addMemberItem = document.createElement('div');
                    addMemberItem.className = 'group-settings-add-member-item';
                    
                    const addMemberBtn = document.createElement('button');
                    addMemberBtn.className = 'group-settings-add-member-btn';
                    addMemberBtn.innerHTML = '<span class="add-member-icon">+</span><span class="add-member-text">æ·»åŠ æˆå‘˜</span>';
                    addMemberBtn.onclick = () => showAddMemberModal();
                    
                    addMemberItem.appendChild(addMemberBtn);
                    membersEdit.appendChild(addMemberItem);
                }
                
                // æ˜¾ç¤ºæ¨¡æ€çª—å£
                modal.style.display = 'flex';
            }
            
            /**
             * å…³é—­ç¾¤èŠè®¾ç½®æ¨¡æ€çª—å£
             */
            function closeGroupSettings() {
                const modal = document.getElementById('group_settings_modal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }
            
            /**
             * ä»ç¾¤èŠä¸­ç§»é™¤æˆå‘˜
             */
            async function removeMemberFromGroup(memberName) {
                if (!currentManagingGroup) return;
                
                if (confirm(`ç¡®å®šè¦å°† ${memberName} ç§»å‡ºç¾¤èŠå—ï¼Ÿ`)) {
                    const index = currentManagingGroup.members.indexOf(memberName);
                    if (index > -1) {
                        currentManagingGroup.members.splice(index, 1);
                        console.log(`å·²ä»ç¾¤èŠä¸­ç§»é™¤æˆå‘˜: ${memberName}`);
                        
                        // *** ç«‹å³æ›´æ–°å½“å‰èŠå¤©ç•Œé¢ï¼ˆå¦‚æœæ­£åœ¨ç¾¤èŠä¸­ï¼‰ ***
                        if (window.currentGroupChat && window.currentGroupChat.id === currentManagingGroup.id) {
                            console.log('ç«‹å³æ›´æ–°å½“å‰ç¾¤èŠç•Œé¢ï¼ˆç§»é™¤æˆå‘˜åï¼‰');
                            
                            // æ›´æ–°å½“å‰ç¾¤èŠå¯¹è±¡
                            window.currentGroupChat.members = currentManagingGroup.members;
                            
                            // ç«‹å³æ›´æ–°èŠå¤©ç•Œé¢å¤´éƒ¨æ˜¾ç¤ºï¼ˆåŒ…æ‹¬äººæ•°ï¼‰
                            updateChatHeader(currentManagingGroup);
                            
                            console.log('ç¾¤èŠç•Œé¢å¤´éƒ¨å·²ç«‹å³æ›´æ–°ï¼Œäººæ•°:', currentManagingGroup.members.length);
                        }
                        
                        // *** ä¿®å¤ï¼šæ·»åŠ ç³»ç»Ÿæ¶ˆæ¯å¹¶ç«‹å³æ˜¾ç¤º ***
                        const systemMessage = `ç¾¤ä¸»å°†${memberName}ç§»å‡ºäº†ç¾¤èŠ`;
                        
                        // *** ä¿®å¤ï¼šæ€»æ˜¯æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯ï¼Œä¸ä¾èµ–ç•Œé¢çŠ¶æ€æ£€æŸ¥ ***
                        console.log('æ˜¾ç¤ºç§»é™¤æˆå‘˜ç³»ç»Ÿæ¶ˆæ¯:', systemMessage);
                        await addSystemMessageToGroup(currentManagingGroup.id, systemMessage);
                        
                        // *** ä¿®å¤ï¼šå¼ºåˆ¶ç«‹å³æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯ ***
                        console.log('å¼ºåˆ¶ç«‹å³æ˜¾ç¤ºç§»é™¤æˆå‘˜ç³»ç»Ÿæ¶ˆæ¯:', systemMessage);
                        displaySystemMessage(systemMessage, currentManagingGroup.id);
                        
                                // *** ç«‹å³æ›´æ–°æ‰€æœ‰ç•Œé¢ä¸­çš„ç¾¤èŠæ˜¾ç¤º ***
        console.log('ç«‹å³æ›´æ–°è”ç³»äººåˆ—è¡¨ä¸­çš„ç¾¤èŠæ˜¾ç¤ºï¼ˆç§»é™¤æˆå‘˜åï¼‰...');
        
        // *** å…³é”®ä¿®å¤ï¼šç¡®ä¿ä¼ é€’å®Œæ•´çš„ç¾¤èŠæ•°æ®ï¼ŒåŒ…æ‹¬å¤´åƒä¿¡æ¯ ***
        console.log('ä¼ é€’ç»™protectedContactListUpdateçš„æ•°æ®:', {
            name: currentManagingGroup.name,
            id: currentManagingGroup.id,
            avatar: currentManagingGroup.avatar,
            members: currentManagingGroup.members
        });
        await protectedContactListUpdate(currentManagingGroup, 'remove_member');
        
        // æ›´æ–°åˆ°ä¸–ç•Œä¹¦
        await updateGroupMembersInWorldbook(currentManagingGroup.name, currentManagingGroup.members);
        
        // *** è½»é‡çº§ç•Œé¢æ›´æ–°ï¼Œé¿å…æ¶ˆæ¯ä¸¢å¤± ***
        console.log('æ‰§è¡Œè½»é‡çº§ç•Œé¢æ›´æ–°ï¼ˆç§»é™¤æˆå‘˜åï¼‰...');
        await refreshGroupChatsDisplay();
                        
                        // é‡æ–°ç”Ÿæˆæˆå‘˜åˆ—è¡¨
                        showGroupSettings();
                    }
                }
            }
            
            /**
             * æ˜¾ç¤ºç¾¤èŠå¤´åƒé€‰æ‹©å™¨
             */
            function showGroupAvatarSelector() {
                if (!currentManagingGroup) {
                    console.error('æ²¡æœ‰å½“å‰ç®¡ç†çš„ç¾¤èŠ');
                    return;
                }
                
                // è®¾ç½®å…¨å±€å˜é‡ï¼Œæ ‡è¯†å½“å‰æ˜¯åœ¨ç¾¤èŠè®¾ç½®ä¸­é€‰æ‹©å¤´åƒ
                window.isSelectingGroupAvatar = true;
                window.currentAvatarGroup = currentManagingGroup;
                
                // æ˜¾ç¤ºå¤´åƒé€‰æ‹©å™¨æ¨¡æ€çª—å£
                const avatarModal = document.getElementById('avatar_selector_modal');
                if (avatarModal) {
                    avatarModal.style.display = 'flex';
                    
                    // åˆ‡æ¢åˆ°ä¸Šä¼ æ ‡ç­¾é¡µ
                    switchAvatarTab('upload');
                } else {
                    console.error('æœªæ‰¾åˆ°å¤´åƒé€‰æ‹©å™¨æ¨¡æ€çª—å£');
                }
            }
            
            // *** æ—§çš„ç¾¤èŠå¤´åƒä¸Šä¼ å‡½æ•°å·²ç§»é™¤ï¼Œç°åœ¨ä½¿ç”¨ç»Ÿä¸€çš„ handleAvatarUpload å’Œ confirmAvatarSelection é€»è¾‘ ***

            /**
             * ä¿å­˜ç¾¤èŠè®¾ç½®ï¼ˆå¢å¼ºä¿®å¤ç‰ˆï¼šç«‹å³ç”Ÿæ•ˆï¼Œä¿æŒæ¶ˆæ¯ä¸ä¸¢å¤±ï¼‰
             */
            async function saveGroupSettings() {
                if (!currentManagingGroup) return;
                
                const nameInput = document.getElementById('group_name_edit');
                const newName = nameInput ? nameInput.value.trim() : '';
                
                if (!newName) {
                    alert('ç¾¤èŠåç§°ä¸èƒ½ä¸ºç©º');
                    return;
                }
                
                console.log('=== ä¿å­˜ç¾¤èŠè®¾ç½®ï¼ˆå¢å¼ºä¿®å¤ç‰ˆï¼‰ ===');
                console.log('åŸç¾¤èŠåç§°:', currentManagingGroup.name);
                console.log('æ–°ç¾¤èŠåç§°:', newName);
                console.log('é€‰ä¸­çš„å¤´åƒæ•°æ®:', window.selectedAvatarData);
                
                // *** é‡è¦ä¿®å¤ï¼šç¡®ä¿ä¸–ç•Œä¹¦å˜é‡å·²æ­£ç¡®åˆå§‹åŒ– ***
                try {
                    if (!worldbook) {
                        console.log('ä¸–ç•Œä¹¦å˜é‡æœªåˆå§‹åŒ–ï¼Œé‡æ–°è·å–...');
                        worldbook = await GetWorldBookName();
                        if (!worldbook) {
                            console.error('æ— æ³•è·å–ä¸–ç•Œä¹¦ï¼Œä¿å­˜æ“ä½œç»ˆæ­¢');
                            alert('æ— æ³•è¿æ¥åˆ°ä¸–ç•Œä¹¦ï¼Œè¯·ç¨åé‡è¯•');
                            return;
                        }
                    }
                    
                    if (!entries) {
                        console.log('entrieså˜é‡æœªåˆå§‹åŒ–ï¼Œé‡æ–°è·å–...');
                        entries = await getLorebookEntries(worldbook);
                        if (!entries) {
                            console.error('æ— æ³•è·å–ä¸–ç•Œä¹¦æ¡ç›®ï¼Œä¿å­˜æ“ä½œç»ˆæ­¢');
                            alert('æ— æ³•è¯»å–ä¸–ç•Œä¹¦æ•°æ®ï¼Œè¯·ç¨åé‡è¯•');
                            return;
                        }
                    }
                    
                    console.log('ä¸–ç•Œä¹¦åˆå§‹åŒ–æ£€æŸ¥å®Œæˆï¼Œworldbook:', worldbook, 'entriesæ•°é‡:', entries.length);
                } catch (error) {
                    console.error('ä¸–ç•Œä¹¦åˆå§‹åŒ–å¤±è´¥:', error);
                    alert('ä¸–ç•Œä¹¦åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    return;
                }
                
                // ä¿å­˜æ—§çš„ä¿¡æ¯
                const oldName = currentManagingGroup.name;
                const oldId = currentManagingGroup.id;
                const oldAvatar = currentManagingGroup.avatar;
                
                // *** é‡è¦ä¿®å¤ï¼šç¡®ä¿å¤´åƒæ•°æ®å®Œæ•´æ€§ ***
                console.log('æ£€æŸ¥å¤´åƒæ•°æ®å®Œæ•´æ€§:');
                console.log('- currentManagingGroup.avatar:', currentManagingGroup.avatar);
                console.log('- window.selectedAvatarData:', window.selectedAvatarData);
                
                // *** å…³é”®ä¿®å¤ï¼šä»ä¸–ç•Œä¹¦commentä¸­è·å–åŸå§‹ç¾¤èŠåç§°ï¼Œç¡®ä¿IDç¨³å®š ***
                let originalGroupName = oldName; // é»˜è®¤ä½¿ç”¨å½“å‰åç§°
                try {
                    if (entries) {
                        const groupEntry = entries.find(e => 
                            e.comment === `æ‰‹æœº-ç¾¤èŠ-${oldName}` || 
                            e.comment.startsWith('æ‰‹æœº-ç¾¤èŠ-') && 
                            e.content.includes(`[${oldName}]`)
                        );
                        
                        if (groupEntry && groupEntry.comment.startsWith('æ‰‹æœº-ç¾¤èŠ-')) {
                            originalGroupName = groupEntry.comment.replace('æ‰‹æœº-ç¾¤èŠ-', '');
                            console.log('ä»ä¸–ç•Œä¹¦commentä¸­è·å–åˆ°åŸå§‹ç¾¤èŠåç§°:', originalGroupName);
                        }
                    }
                } catch (error) {
                    console.warn('è·å–åŸå§‹ç¾¤èŠåç§°æ—¶å‡ºé”™ï¼Œä½¿ç”¨å½“å‰åç§°:', error);
                }
                
                // *** ä¿®å¤ï¼šç¡®ä¿IDä¿æŒç¨³å®šï¼ŒåŸºäºåŸå§‹åç§°ç”Ÿæˆ ***
                const stableGroupId = `group_${originalGroupName.replace(/[^a-zA-Z0-9\u4e00-\u9fff]/g, '_')}`;
                console.log('ä½¿ç”¨ç¨³å®šçš„ç¾¤èŠID:', stableGroupId, '(åŸºäºåŸå§‹åç§°:', originalGroupName, ')');
                
                // è®°å½•å˜æ›´ç±»å‹
                const changes = [];
                
                // æ›´æ–°ç¾¤èŠåç§°ï¼ˆä¿æŒIDä¸å˜ï¼‰
                if (newName !== oldName) {
                    // *** æ ¸å¿ƒä¿®å¤ï¼šå®Œæ•´çš„æ•°æ®ç»‘å®šè¿ç§» ***
                    console.log('=== æ‰§è¡Œå®Œæ•´æ•°æ®ç»‘å®šè¿ç§» ===');
                    const migratedCount = await migrateGroupDataBindings(oldName, newName, currentManagingGroup);
                    console.log(`æ•°æ®ç»‘å®šè¿ç§»å®Œæˆï¼Œå…±è¿ç§» ${migratedCount} é¡¹`);
                    
                    currentManagingGroup.name = newName;
                    currentManagingGroup.id = stableGroupId;
                    changes.push({
                        type: 'name',
                        oldValue: oldName,
                        newValue: newName
                    });
                }
                
                // *** ä¿®å¤ï¼šæ›´æ–°å¤´åƒä¿¡æ¯ ***
                if (window.selectedAvatarData) {
                    console.log('æ£€æµ‹åˆ°æ–°çš„å¤´åƒæ•°æ®ï¼Œæ›´æ–°ç¾¤èŠå¤´åƒ:', window.selectedAvatarData);
                    currentManagingGroup.avatar = window.selectedAvatarData;
                    
                    // å¦‚æœæ˜¯ä¸Šä¼ çš„å¤´åƒï¼Œç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®
                    if (window.selectedAvatarData.type === 'upload' && window.selectedAvatarData.imageData) {
                        currentManagingGroup.avatarUrl = window.selectedAvatarData.imageData;
                    }
                    
                    changes.push({
                        type: 'avatar',
                        oldValue: oldAvatar,
                        newValue: window.selectedAvatarData
                    });
                } else {
                    // *** å…³é”®ä¿®å¤ï¼šå¦‚æœæ²¡æœ‰æ–°å¤´åƒæ•°æ®ï¼Œç¡®ä¿ä¿æŒåŸæœ‰å¤´åƒ ***
                    console.log('æ²¡æœ‰æ–°å¤´åƒæ•°æ®ï¼Œä¿æŒåŸæœ‰å¤´åƒ:', currentManagingGroup.avatar);
                    console.log('åŸæœ‰å¤´åƒæ•°æ®ç±»å‹:', typeof currentManagingGroup.avatar);
                    console.log('åŸæœ‰å¤´åƒæ•°æ®è¯¦æƒ…:', currentManagingGroup.avatar);
                    
                    // *** å…³é”®ä¿®å¤ï¼šå¤„ç†ä¸åŒæ ¼å¼çš„å¤´åƒæ•°æ® ***
                    if (currentManagingGroup.avatar) {
                        // æƒ…å†µ1ï¼šå¤´åƒæ˜¯å­—ç¬¦ä¸²URLï¼ˆéœ€è¦ä¿æŒä¸å˜ï¼‰
                        if (typeof currentManagingGroup.avatar === 'string') {
                            console.log('æ£€æµ‹åˆ°å­—ç¬¦ä¸²ç±»å‹å¤´åƒï¼Œä¿æŒä¸å˜:', currentManagingGroup.avatar);
                            // ä¿æŒå­—ç¬¦ä¸²æ ¼å¼çš„å¤´åƒä¸å˜
                            // ä¸éœ€è¦é¢å¤–å¤„ç†ï¼Œå­—ç¬¦ä¸²å¤´åƒä¼šè¢«updateAvatarElementæ­£ç¡®å¤„ç†
                        }
                        // æƒ…å†µ2ï¼šå¤´åƒæ˜¯å¯¹è±¡ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦è¡¥å……æ•°æ®
                        else if (typeof currentManagingGroup.avatar === 'object' && currentManagingGroup.avatar.type) {
                            console.log('æ£€æµ‹åˆ°å¯¹è±¡ç±»å‹å¤´åƒï¼Œæ£€æŸ¥æ•°æ®å®Œæ•´æ€§');
                            // å¦‚æœæœ‰avatarUrlä½†æ²¡æœ‰åœ¨avatarå¯¹è±¡ä¸­ï¼Œéœ€è¦è¡¥å……
                            if (currentManagingGroup.avatarUrl && 
                                currentManagingGroup.avatar.type === 'upload' && 
                                !currentManagingGroup.avatar.imageData) {
                                currentManagingGroup.avatar.imageData = currentManagingGroup.avatarUrl;
                                console.log('ä¿®å¤å¤´åƒæ•°æ®æ ¼å¼ï¼Œæ·»åŠ imageData');
                            }
                        }
                        // æƒ…å†µ3ï¼šå¤´åƒæ•°æ®æ ¼å¼å¼‚å¸¸ï¼Œå°è¯•ä»avatarUrlæ¢å¤
                        else {
                            console.log('å¤´åƒæ•°æ®æ ¼å¼å¼‚å¸¸ï¼Œå°è¯•ä»avatarUrlæ¢å¤');
                            if (currentManagingGroup.avatarUrl) {
                                console.log('ä½¿ç”¨avatarUrlä½œä¸ºå¤´åƒ:', currentManagingGroup.avatarUrl);
                                currentManagingGroup.avatar = currentManagingGroup.avatarUrl;
                            } else {
                                console.log('æ— æ³•æ¢å¤å¤´åƒæ•°æ®ï¼Œè®¾ç½®é»˜è®¤å¤´åƒ');
                                currentManagingGroup.avatar = {
                                    type: 'preset',
                                    text: 'ç¾¤',
                                    gradient: {
                                        start: '#199AFF',
                                        end: '#0066CC'
                                    }
                                };
                            }
                        }
                    } else {
                        // æƒ…å†µ4ï¼šå®Œå…¨æ²¡æœ‰å¤´åƒæ•°æ®ï¼Œå°è¯•ä»avatarUrlæ¢å¤æˆ–è®¾ç½®é»˜è®¤
                        console.log('æ²¡æœ‰å¤´åƒæ•°æ®ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰avatarUrl...');
                        if (currentManagingGroup.avatarUrl) {
                            console.log('ä½¿ç”¨avatarUrlä½œä¸ºå¤´åƒ:', currentManagingGroup.avatarUrl);
                            currentManagingGroup.avatar = currentManagingGroup.avatarUrl;
                        } else {
                            console.log('è®¾ç½®é»˜è®¤å¤´åƒ');
                            currentManagingGroup.avatar = {
                                type: 'preset',
                                text: 'ç¾¤',
                                gradient: {
                                    start: '#199AFF',
                                    end: '#0066CC'
                                }
                            };
                        }
                    }
                    
                    console.log('å¤´åƒæ•°æ®å¤„ç†å®Œæˆ:', currentManagingGroup.avatar);
                }
                
                // *** æ ¸å¿ƒä¿®å¤1ï¼šåœ¨ä¿å­˜åˆ°ä¸–ç•Œä¹¦ä¹‹å‰ï¼Œå…ˆç«‹å³æ›´æ–°ç•Œé¢ ***
                console.log('=== ç«‹å³æ›´æ–°ç•Œé¢æ˜¾ç¤ºï¼ˆä¿å­˜å‰ï¼‰ ===');
                
                // ç®€åŒ–ï¼šåŸºæœ¬DOMæ›´æ–°ï¼ˆäº¤ç»™æ•°æ®è¿ç§»å‡½æ•°å¤„ç†ï¼‰
                console.log('åŸºæœ¬DOMå±æ€§æ›´æ–°å·²ç”±migrateGroupDataBindingså¤„ç†');
                
                // *** ç®€åŒ–çš„ç•Œé¢æ›´æ–°æµç¨‹ ***
                console.log('=== ç®€åŒ–ç•Œé¢æ›´æ–°æµç¨‹ ===');
                
                // æ›´æ–°å½“å‰ç¾¤èŠå¯¹è±¡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    if (window.currentGroupChat && window.currentGroupChat.id === stableGroupId) {
                        window.currentGroupChat.name = currentManagingGroup.name;
                        window.currentGroupChat.avatar = currentManagingGroup.avatar;
                        window.currentGroupChat.avatarUrl = currentManagingGroup.avatarUrl;
                        window.currentGroupChat.members = currentManagingGroup.members;
                }
                
                // 1. ç«‹å³æ›´æ–°æ ‡é¢˜
                console.log('å¼€å§‹å¯»æ‰¾èŠå¤©å¤´éƒ¨è¿›è¡Œæ›´æ–°...');
                
                // æŸ¥æ‰¾å½“å‰å¯è§çš„èŠå¤©é¡µé¢å¤´éƒ¨
                let chatHeader = null;
                const visibleChatPage = document.querySelector('.QQ_chat_page[style*="display:block"], .QQ_chat_page:not([style*="display:none"])');
                if (visibleChatPage) {
                    chatHeader = visibleChatPage.querySelector('.QQ_chat_header, .QQ_home');
                }
                
                            if (chatHeader) {
                    console.log('æ‰¾åˆ°èŠå¤©å¤´éƒ¨ï¼Œå¼€å§‹æ›´æ–°æ ‡é¢˜...');
                                updateHeaderContent(chatHeader, currentManagingGroup);
                } else {
                    console.log('æœªæ‰¾åˆ°å¯è§çš„èŠå¤©å¤´éƒ¨ï¼Œè·³è¿‡æ ‡é¢˜æ›´æ–°');
                }
                
                // 2. å»¶è¿Ÿæ¢å¤èƒŒæ™¯å’Œæ›´æ–°è”ç³»äººï¼ˆé¿å…å†²çªï¼‰
                setTimeout(async () => {
                    // é‡æ–°åº”ç”¨ç¾¤èŠèƒŒæ™¯
                    reapplyGroupChatBackground(currentManagingGroup);
                    
                    // ä¿æŠ¤æ€§è”ç³»äººæ›´æ–°
                    await protectedContactListUpdate(currentManagingGroup, oldName);
                    
                    console.log('ç•Œé¢æ›´æ–°æµç¨‹å®Œæˆ');
                }, 150);
                
                // ç¡®ä¿ä½¿ç”¨ç¨³å®šID
                currentManagingGroup.id = stableGroupId;
                
                // ç°åœ¨æ‰ä¿å­˜åˆ°ä¸–ç•Œä¹¦
                if (oldName !== newName) {
                    await updateGroupNameInWorldbook(oldName, newName);
                } else {
                    // å³ä½¿åç§°æ²¡å˜ï¼Œä¹Ÿè¦ä¿å­˜å¤´åƒç­‰å…¶ä»–ä¿¡æ¯
                    await saveGroupToWorldbook(currentManagingGroup);
                }
                
                // *** æ ¸å¿ƒä¿®å¤4ï¼šæ·»åŠ ç³»ç»Ÿæ¶ˆæ¯å¹¶ç«‹å³æ˜¾ç¤º ***
                if (changes.length > 0) {
                    console.log('æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯ï¼Œå˜æ›´åˆ—è¡¨:', changes);
                    
                    // ä¸ºæ¯ä¸ªå˜æ›´ç”Ÿæˆç³»ç»Ÿæ¶ˆæ¯
                    for (const change of changes) {
                        let systemMessage = '';
                        switch (change.type) {
                            case 'name':
                                systemMessage = `ç¾¤èŠåç§°å·²æ›´æ”¹ä¸º"${change.newValue}"`;
                                break;
                            case 'avatar':
                                systemMessage = `ç¾¤ä¸»å·²æ›´æ”¹ç¾¤å¤´åƒ`;
                                break;
                        }
                        
                        if (systemMessage) {
                            console.log('å¤„ç†ç³»ç»Ÿæ¶ˆæ¯:', systemMessage);
                            
                            // ä¿å­˜åˆ°ç¾¤èŠæ¶ˆæ¯å†å²ä¸­
                            await addSystemMessageToGroup(stableGroupId, systemMessage);
                            
                            // *** å¼ºåˆ¶åœ¨å½“å‰èŠå¤©ç•Œé¢æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯ï¼ˆè¶…å¼ºåˆ¶ç‰ˆï¼‰ ***
                            console.log('æ£€æŸ¥å½“å‰èŠå¤©çŠ¶æ€:', {
                                currentGroupChat: window.currentGroupChat ? window.currentGroupChat.id : 'null',
                                targetGroupId: stableGroupId,
                                isMatching: window.currentGroupChat && window.currentGroupChat.id === stableGroupId
                            });
                            
                            // ç®€åŒ–ï¼šå¦‚æœèƒ½æ“ä½œç¾¤èŠè®¾ç½®ï¼Œå°±ç›´æ¥æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯
                            console.log('*** æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯ ***:', systemMessage);
                            console.log('å½“å‰èŠå¤©é¡µé¢çŠ¶æ€æ£€æŸ¥...');
                            
                            // æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯åˆ°æ­£ç¡®çš„ç¾¤èŠ
                            console.log('æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯åˆ°å½“å‰æ“ä½œçš„ç¾¤èŠ:', currentManagingGroup.id);
                            displaySystemMessage(systemMessage, currentManagingGroup.id);
                        }
                    }
                }
                
                // *** ä¿®å¤ï¼šæ›´æ–°æ¶ˆæ¯JSONä¸­çš„ç¾¤èŠä¿¡æ¯ï¼Œä¿æŒèŠå¤©è®°å½• ***
                if (oldName !== newName) {
                    await updateGroupChatMessagesInMsgjson(stableGroupId, oldName, newName);
                }
                
                // æ¸…ç©ºé€‰ä¸­çš„å¤´åƒæ•°æ®
                window.selectedAvatarData = null;
                
                console.log(`ç¾¤èŠè®¾ç½®å·²ä¿å­˜å¹¶ç«‹å³ç”Ÿæ•ˆ: ${oldName} -> ${newName}`);
                alert('ç¾¤èŠè®¾ç½®å·²ä¿å­˜');
                closeGroupSettings();
            }
            
            /**
             * åˆ é™¤å½“å‰ç¾¤èŠ
             */
            async function deleteCurrentGroup() {
                if (!currentManagingGroup) return;
                
                if (confirm(`ç¡®å®šè¦åˆ é™¤ç¾¤èŠ "${currentManagingGroup.name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                    console.log('åˆ é™¤ç¾¤èŠ:', currentManagingGroup.name);
                    
                    const deletedGroupId = currentManagingGroup.id;
                    const deletedGroupName = currentManagingGroup.name;
                    
                    // **å…³é”®ä¿®å¤ï¼šå…ˆå…³é—­æ¨¡æ€çª—å£å¹¶ç«‹å³è·³è½¬ï¼Œé¿å…ç•Œé¢å¡æ­»**
                    closeGroupSettings();
                    
                    // è®°å½•è·³è½¬ç›®æ ‡å’Œå½“å‰çŠ¶æ€
                    let shouldJumpToPage = null;
                    let wasInGroupChat = false;
                    
                    if (window.currentGroupChat && window.currentGroupChat.id === deletedGroupId) {
                        shouldJumpToPage = window.groupChatSourcePage || 'people';
                        wasInGroupChat = true;
                        console.log('åˆ é™¤ç¾¤èŠåéœ€è¦è·³è½¬åˆ°é¡µé¢:', shouldJumpToPage);
                        console.log('å½“å‰åœ¨ç¾¤èŠç•Œé¢ï¼Œéœ€è¦è·³è½¬');
                    } else {
                        // å³ä½¿ä¸åœ¨ç¾¤èŠç•Œé¢ï¼Œä¹Ÿè¦ç¡®ä¿åˆ é™¤ååˆ·æ–°å½“å‰é¡µé¢
                        shouldJumpToPage = 'people'; // é»˜è®¤è·³è½¬åˆ°è”ç³»äººé¡µé¢
                        console.log('ä¸åœ¨ç¾¤èŠç•Œé¢ï¼Œä½†ä»éœ€è¦åˆ·æ–°ç•Œé¢');
                    }
                    
                    // ç­‰å¾…æ¨¡æ€çª—å£å…³é—­åå†æ‰§è¡Œåˆ é™¤æ“ä½œ
                    setTimeout(async () => {
                        try {
                            // ä»ä¸–ç•Œä¹¦ä¸­åˆ é™¤
                            await removeGroupFromWorldbook(deletedGroupName);
                            console.log('ç¾¤èŠå·²ä»ä¸–ç•Œä¹¦ä¸­åˆ é™¤');
                            
                            // ç«‹å³åˆ·æ–°entries
                            console.log('åˆ·æ–°entriesä»¥ç§»é™¤å·²åˆ é™¤çš„ç¾¤èŠ');
                            entries = await getLorebookEntries(worldbook);
                            console.log('entriesåˆ·æ–°æˆåŠŸï¼Œæ–°çš„æ¡ç›®æ•°é‡:', entries ? entries.length : 'failed');
                            

                            
                            // ä»æ•°æ®ç»“æ„ä¸­åˆ é™¤ç¾¤èŠï¼ˆå†…å­˜æ¸…ç†ï¼‰
                            delete QQ_msgjson.ç¾¤èŠ[deletedGroupName];
                            console.log('ç¾¤èŠå·²ä»QQ_msgjsonä¸­åˆ é™¤');
                            
                            // **å…ˆæ¸…é™¤ç¾¤èŠçŠ¶æ€ï¼Œé¿å…è·³è½¬æ—¶çš„çŠ¶æ€å†²çª**
                            if (wasInGroupChat) {
                                window.currentGroupChat = null;
                                window.groupChatSourcePage = null;
                                console.log('å·²æ¸…é™¤ç¾¤èŠçŠ¶æ€');
                            }
                            
                            // **ç«‹å³è·³è½¬åˆ°ç›®æ ‡é¡µé¢**
                            console.log('æ‰§è¡Œé¡µé¢è·³è½¬åˆ°:', shouldJumpToPage);
                            if (typeof QQ_Nav === 'function') {
                                if (shouldJumpToPage === 'messages') {
                                    QQ_Nav('message');
                                } else {
                                    QQ_Nav('people');
                                }
                                console.log('è·³è½¬å®Œæˆ');
                            } else {
                                console.warn('QQ_Navå‡½æ•°ä¸å¯ç”¨ï¼Œæ‰‹åŠ¨æ˜¾ç¤ºè”ç³»äººé¡µé¢');
                                // æ‰‹åŠ¨æ˜¾ç¤ºè”ç³»äººé¡µé¢
                                $('.QQ_chat_page').hide();
                                $('.group-chat-page').hide();
                                $('#QQ_home_page').show();
                                $('.QQ_bottom_nav').show();
                            }
                            
                            console.log('ç¾¤èŠåˆ é™¤å®Œæˆ:', deletedGroupName);
                            
                            // *** ä¿®å¤ï¼šå…ˆåˆ é™¤ä¸–ç•Œä¹¦æ•°æ®å’Œæ›´æ–°å†…å­˜ï¼Œä½†ä¸ç«‹å³é‡æ–°æ¸²æŸ“ç•Œé¢ ***
                            console.log('åˆ é™¤ç•Œé¢å…ƒç´ å’Œé‡æ–°åŠ è½½ç¾¤èŠæ•°æ®');
                            
                            // åˆ é™¤ç‰¹å®šçš„ç¾¤èŠå…ƒç´ 
                            safeRemoveGroupFromInterface(deletedGroupId, deletedGroupName);
                            
                            // *** ä¿®å¤ï¼šä½¿ç”¨ä¸¤é˜¶æ®µåŠ è½½æœºåˆ¶é‡æ–°åŠ è½½ç¾¤èŠæ•°æ® ***
                            console.log('é‡æ–°åŠ è½½ç¾¤èŠæ•°æ®');
                            await QQ_Enhance_Group_Metadata();
                            
                            // æ›´æ–°æ¶ˆæ¯åˆ—è¡¨
                            console.log('æ›´æ–°æ¶ˆæ¯åˆ—è¡¨');
                            await QQ_UpdateMessageList();
                            
                            console.log('ç¾¤èŠåˆ é™¤æ•°æ®æ›´æ–°å®Œæˆ');
                            
                            // å…ˆæ˜¾ç¤ºç¡®è®¤æ¶ˆæ¯
                            alert('ç¾¤èŠå·²åˆ é™¤');
                            
                            // *** å…³é”®ä¿®å¤ï¼šç”¨æˆ·ç‚¹å‡»ç¡®è®¤åï¼Œç¡®ä¿QQ_GroupsåŸºäºæœ€æ–°æ•°æ®ï¼Œç„¶åé‡æ–°æ¸²æŸ“ ***
                            console.log('ç”¨æˆ·ç¡®è®¤åˆ é™¤å®Œæˆï¼Œç°åœ¨ç¡®ä¿QQ_Groupsæ•°æ®æœ€æ–°å¹¶é‡æ–°æ¸²æŸ“è”ç³»äººç•Œé¢');
                            
                            // å…³é”®æ­¥éª¤ï¼šæ¸…ç©ºQQ_Groupså¹¶åŸºäºæœ€æ–°çš„ä¸–ç•Œä¹¦æ•°æ®é‡å»º
                            console.log('åˆ é™¤å‰QQ_Groups:', QQ_Groups.length, 'ä¸ªç¾¤èŠ');
                            QQ_Groups.length = 0; // æ¸…ç©ºæ•°ç»„
                            
                            // é‡æ–°ä»æœ€æ–°çš„ä¸–ç•Œä¹¦æ•°æ®æ„å»ºQQ_Groupsï¼ˆä¸åŒ…å«å·²åˆ é™¤çš„ç¾¤èŠï¼‰
                            if (entries) {
                                const remainingGroupEntries = entries.filter(e => e.comment && e.comment.startsWith("æ‰‹æœº-ç¾¤èŠ-"));
                                remainingGroupEntries.forEach(entry => {
                                    const groupName = entry.comment.replace('æ‰‹æœº-ç¾¤èŠ-', '');
                                    if (groupName && !QQ_Groups.includes(groupName)) {
                                        QQ_Groups.push(groupName);
                                    }
                                });
                                console.log('åˆ é™¤åQQ_Groups:', QQ_Groups.length, 'ä¸ªç¾¤èŠ');
                            }
                            
                            // *** ç¡®ä¿QQ_Groupsé‡å»ºå®Œæˆåæ‰å¼€å§‹é‡æ–°æ¸²æŸ“ ***
                            console.log('ğŸ¯ QQ_Groupsæ•°æ®é‡å»ºå®Œæˆï¼Œå¼€å§‹é‡æ–°æ¸²æŸ“è”ç³»äººç•Œé¢');
                            if (typeof renderContactGroups === 'function') {
                                await renderContactGroups();
                                console.log('âœ… è”ç³»äººç•Œé¢é‡æ–°æ¸²æŸ“å®Œæˆï¼Œç¾¤èŠå·²ä»ç•Œé¢æ¶ˆå¤±');
                            } else {
                                console.error('âŒ renderContactGroupså‡½æ•°ä¸å¯ç”¨');
                            }
                            
                        } catch (error) {
                            console.error('åˆ é™¤ç¾¤èŠæ—¶å‡ºé”™:', error);
                            alert('åˆ é™¤ç¾¤èŠæ—¶å‡ºç°é—®é¢˜ï¼Œè¯·åˆ·æ–°é¡µé¢');
                            
                            // å‡ºé”™æ—¶ç¡®ä¿ç•Œé¢æ¢å¤æ­£å¸¸
                            console.log('å‡ºé”™åæ¢å¤ç•Œé¢æ˜¾ç¤º');
                            
                            // æ¸…é™¤ç¾¤èŠçŠ¶æ€
                            if (wasInGroupChat) {
                                window.currentGroupChat = null;
                                window.groupChatSourcePage = null;
                            }
                            
                            // å¼ºåˆ¶æ˜¾ç¤ºè”ç³»äººé¡µé¢
                            $('.QQ_chat_page').hide();
                            $('.group-chat-page').hide();
                            $('#QQ_home_page').show();
                            $('.QQ_bottom_nav').show();
                            
                            // å°è¯•é€šè¿‡QQ_Navæ¢å¤æ­£å¸¸çŠ¶æ€
                            if (typeof QQ_Nav === 'function') {
                                QQ_Nav('people');
                            }
                        }
                        
                        currentManagingGroup = null;
                    }, 100); // ç¼©çŸ­ç­‰å¾…æ—¶é—´
                }
            }
            
            /**
             * æ›´æ–°æ‰€æœ‰åˆ—è¡¨ä¸­çš„ç¾¤èŠä¿¡æ¯ï¼ˆå¢å¼ºç‰ˆï¼šåŒ…å«å¤´åƒæ›´æ–°ï¼‰
             */
            async function updateGroupInAllListsWithAvatar(groupData) {
                console.log('æ›´æ–°æ‰€æœ‰åˆ—è¡¨ä¸­çš„ç¾¤èŠä¿¡æ¯ï¼ŒåŒ…æ‹¬å¤´åƒ:', groupData);
                
                // æ›´æ–°è”ç³»äººåˆ—è¡¨
                const contactsContainer = document.getElementById('QQ_home_chars');
                if (contactsContainer) {
                    const existingGroup = contactsContainer.querySelector(`[data-group-id="${groupData.id}"]`);
                    if (existingGroup) {
                        const nameElement = existingGroup.querySelector('.QQ_home_name');
                        const avatarElement = existingGroup.querySelector('.QQ_home_head');
                        
                        if (nameElement) {
                            nameElement.textContent = groupData.name;
                        }
                        
                        // æ›´æ–°å¤´åƒ
                        if (avatarElement && groupData.avatar) {
                            updateAvatarElement(avatarElement, groupData.avatar);
                        }
                    }
                }
                
                // æ›´æ–°æ¶ˆæ¯åˆ—è¡¨
                const messagesContainer = document.getElementById('QQ_message_list_chars');
                if (messagesContainer) {
                    const existingGroup = messagesContainer.querySelector(`[data-group-id="${groupData.id}"]`);
                    if (existingGroup) {
                        const nameElement = existingGroup.querySelector('.QQ_home_name');
                        const avatarElement = existingGroup.querySelector('.QQ_home_head');
                        
                        if (nameElement) {
                            nameElement.textContent = groupData.name;
                        }
                        
                        // æ›´æ–°å¤´åƒ
                        if (avatarElement && groupData.avatar) {
                            updateAvatarElement(avatarElement, groupData.avatar);
                        }
                    }
                }
            }
            
            /**
             * æ›´æ–°æ‰€æœ‰åˆ—è¡¨ä¸­çš„ç¾¤èŠä¿¡æ¯ï¼ˆåŸç‰ˆï¼šä»…åç§°ï¼‰
             */
            function updateGroupInAllLists(groupData) {
                // æ›´æ–°è”ç³»äººåˆ—è¡¨
                const contactsContainer = document.getElementById('QQ_home_chars');
                if (contactsContainer) {
                    const existingGroup = contactsContainer.querySelector(`[data-group-id="${groupData.id}"]`);
                    if (existingGroup) {
                        const nameElement = existingGroup.querySelector('.QQ_home_name');
                        if (nameElement) {
                            nameElement.textContent = groupData.name;
                        }
                    }
                }
                
                // æ›´æ–°æ¶ˆæ¯åˆ—è¡¨
                const messagesContainer = document.getElementById('QQ_message_list_chars');
                if (messagesContainer) {
                    const existingGroup = messagesContainer.querySelector(`[data-group-id="${groupData.id}"]`);
                    if (existingGroup) {
                        const nameElement = existingGroup.querySelector('.QQ_home_name');
                        if (nameElement) {
                            nameElement.textContent = groupData.name;
                        }
                    }
                }
            }
            
            /**
             * ç¾¤èŠè®¾ç½®æ›´æ–°åè½»é‡çº§ç•Œé¢æ›´æ–°ï¼ˆä¸é‡æ–°åŠ è½½ï¼Œé¿å…æ¶ˆæ¯ä¸¢å¤±ï¼‰
             */
            async function autoReloadInterfaceAfterGroupUpdate(updatedGroupData) {
                console.log('=== å¼€å§‹è½»é‡çº§ç•Œé¢æ›´æ–°ï¼ˆé¿å…æ¶ˆæ¯ä¸¢å¤±ï¼‰ ===');
                console.log('æ›´æ–°çš„ç¾¤èŠæ•°æ®:', updatedGroupData);
                
                try {
                    // *** é‡è¦ï¼šä¸é‡æ–°ä»ä¸–ç•Œä¹¦åŠ è½½ï¼Œè€Œæ˜¯ç›´æ¥æ›´æ–°ç°æœ‰æ•°æ® ***
                    
                    // 1. æ›´æ–°å…¨å±€ç¾¤èŠæ•°æ®ï¼ˆä¿æŒæ¶ˆæ¯ä¸å˜ï¼‰
                    if (window.QQ_Groups && Array.isArray(window.QQ_Groups)) {
                        const groupIndex = window.QQ_Groups.findIndex(g => g.id === updatedGroupData.id);
                        if (groupIndex !== -1) {
                            // åªæ›´æ–°åç§°å’Œå¤´åƒï¼Œä¿æŒå…¶ä»–æ•°æ®ä¸å˜
                            window.QQ_Groups[groupIndex].name = updatedGroupData.name;
                            window.QQ_Groups[groupIndex].avatar = updatedGroupData.avatar;
                            window.QQ_Groups[groupIndex].avatarUrl = updatedGroupData.avatarUrl;
                            console.log('å·²è½»é‡æ›´æ–°å…¨å±€ç¾¤èŠæ•°æ®');
                        }
                    }
                    
                    // 2. å¦‚æœå½“å‰åœ¨ç¾¤èŠç•Œé¢ï¼Œåªæ›´æ–°å¤´éƒ¨æ˜¾ç¤ºï¼Œä¸é‡æ–°åŠ è½½æ¶ˆæ¯
                    if (window.currentGroupChat && window.currentGroupChat.id === updatedGroupData.id) {
                        console.log('è½»é‡æ›´æ–°å½“å‰ç¾¤èŠç•Œé¢å¤´éƒ¨...');
                        
                        // æ›´æ–°å½“å‰ç¾¤èŠå¯¹è±¡ï¼ˆä¿æŒæ¶ˆæ¯æ•°æ®ä¸å˜ï¼‰
                        window.currentGroupChat.name = updatedGroupData.name;
                        window.currentGroupChat.avatar = updatedGroupData.avatar;
                        window.currentGroupChat.avatarUrl = updatedGroupData.avatarUrl;
                        
                        // åªæ›´æ–°èŠå¤©å¤´éƒ¨ï¼Œä¸é‡æ–°åŠ è½½æ¶ˆæ¯å†å²
                        updateChatHeader(updatedGroupData);
                        
                        console.log('èŠå¤©ç•Œé¢å¤´éƒ¨å·²è½»é‡æ›´æ–°ï¼Œæ¶ˆæ¯å†å²ä¿æŒä¸å˜');
                    }
                    
                        // 3. è½»é‡æ›´æ–°ç¾¤èŠåˆ—è¡¨æ˜¾ç¤º
    console.log('è½»é‡æ›´æ–°ç¾¤èŠåˆ—è¡¨æ˜¾ç¤º...');
    await protectedContactListUpdate(updatedGroupData, 'group_update');
                    
                    console.log('=== è½»é‡çº§ç•Œé¢æ›´æ–°å®Œæˆï¼Œæ¶ˆæ¯æ•°æ®ä¿æŒå®Œæ•´ ===');
                    
                } catch (error) {
                    console.error('è½»é‡çº§ç•Œé¢æ›´æ–°æ—¶å‡ºé”™:', error);
                    // ä¸æ˜¾ç¤ºè­¦å‘Šæ¡†ï¼Œé¿å…æ‰“æ–­ç”¨æˆ·æ“ä½œ
                    console.warn('ç•Œé¢æ›´æ–°æ—¶å‡ºç°é—®é¢˜ï¼Œä½†ç¾¤èŠè®¾ç½®å·²ä¿å­˜ï¼Œæ¶ˆæ¯æ•°æ®å®Œæ•´');
                }
            }
            
            /**
             * åˆ·æ–°ç¾¤èŠæ˜¾ç¤ºï¼ˆä¿®å¤ç‰ˆï¼šé˜²æ­¢é‡å¤ç¾¤èŠï¼Œæ­£ç¡®åº”ç”¨å¤´åƒï¼‰
             */
            async function refreshGroupChatsDisplay() {
                console.log('åˆ·æ–°ç¾¤èŠæ˜¾ç¤ºï¼ˆä¿®å¤ç‰ˆï¼‰...');
                
                try {
                    // ä¸è¦é‡æ–°ä»ä¸–ç•Œä¹¦åŠ è½½ï¼Œç›´æ¥ä½¿ç”¨å½“å‰çš„QQ_Groupsæ•°æ®
                    // æ¸…ç†å’Œé‡æ–°æ˜¾ç¤ºç°æœ‰çš„ç¾¤èŠå…ƒç´ 
                    await updateExistingGroupElements();
                    
                    console.log('ç¾¤èŠæ˜¾ç¤ºåˆ·æ–°å®Œæˆ');
                    
                } catch (error) {
                    console.error('åˆ·æ–°ç¾¤èŠæ˜¾ç¤ºæ—¶å‡ºé”™:', error);
                    alert('ç•Œé¢æ›´æ–°æ—¶å‡ºç°é—®é¢˜ï¼Œå»ºè®®æ‰‹åŠ¨åˆ·æ–°é¡µé¢ã€‚');
                }
            }
            
            /**
             * æ›´æ–°ç°æœ‰ç¾¤èŠå…ƒç´ è€Œä¸é‡æ–°åˆ›å»º
             */
            async function updateExistingGroupElements() {
                console.log('æ›´æ–°ç°æœ‰ç¾¤èŠå…ƒç´ ...');
                
                try {
                    // *** å…³é”®ä¿®å¤ï¼šä½¿ç”¨å½“å‰å†…å­˜ä¸­çš„QQ_Groupsæ•°æ®ï¼Œä¸é‡æ–°åŠ è½½ ***
                    const latestGroups = window.QQ_Groups || [];
                    console.log('updateExistingGroupElements: ä½¿ç”¨çš„ç¾¤èŠæ•°æ®:', latestGroups.length, 'ä¸ªç¾¤èŠ');
                    console.log('ä½¿ç”¨å½“å‰å†…å­˜ä¸­çš„ç¾¤èŠæ•°æ®:', latestGroups.length, 'ä¸ª');
                    
                    if (latestGroups.length === 0) {
                        console.warn('å†…å­˜ä¸­æ²¡æœ‰ç¾¤èŠæ•°æ®ï¼Œè·³è¿‡æ›´æ–°');
                        return;
                    }
                    
                    const contactsContainer = document.getElementById('QQ_home_chars');
                    const messagesContainer = document.getElementById('QQ_message_list_chars');
                    
                    // æ›´æ–°è”ç³»äººåˆ—è¡¨ä¸­çš„ç¾¤èŠ
                    if (contactsContainer && latestGroups) {
                        for (const groupData of latestGroups) {
                            if (groupData && groupData.name) {
                                const existingElement = contactsContainer.querySelector(`[data-group-id="${groupData.id}"]`);
                                if (existingElement) {
                                    console.log('æ›´æ–°ç°æœ‰ç¾¤èŠå…ƒç´ :', groupData.name);
                                    updateGroupElement(existingElement, groupData);
                                } else {
                                    console.log('ç¾¤èŠå…ƒç´ ä¸å­˜åœ¨ï¼Œä¿æŒç°çŠ¶:', groupData.name);
                                }
                            }
                        }
                    }
                    
                    // æ›´æ–°æ¶ˆæ¯åˆ—è¡¨ä¸­çš„ç¾¤èŠ
                    if (messagesContainer && latestGroups) {
                        console.log('=== å¼€å§‹æ›´æ–°æ¶ˆæ¯åˆ—è¡¨ä¸­çš„ç¾¤èŠ ===');
                        console.log('æ¶ˆæ¯å®¹å™¨å­˜åœ¨:', !!messagesContainer);
                        console.log('ç¾¤èŠæ•°æ®:', latestGroups.map(g => ({ name: g.name, id: g.id })));
                        
                        // å…ˆæ£€æŸ¥æ¶ˆæ¯åˆ—è¡¨ä¸­ç°æœ‰çš„ç¾¤èŠå…ƒç´ 
                        const existingElements = messagesContainer.querySelectorAll('[data-group-id]');
                        console.log('æ¶ˆæ¯åˆ—è¡¨ä¸­ç°æœ‰çš„ç¾¤èŠå…ƒç´ :', Array.from(existingElements).map(el => ({
                            name: el.querySelector('.QQ_home_name')?.textContent,
                            dataGroupId: el.getAttribute('data-group-id')
                        })));
                        
                        for (const groupData of latestGroups) {
                            if (groupData && groupData.name) {
                                console.log(`\n--- å¤„ç†ç¾¤èŠ: ${groupData.name} (ID: ${groupData.id}) ---`);
                                
                                const existingElement = messagesContainer.querySelector(`[data-group-id="${groupData.id}"]`);
                                console.log('æ ¹æ®data-group-idæŸ¥æ‰¾åˆ°çš„å…ƒç´ :', !!existingElement);
                                
                                if (!existingElement) {
                                    // å°è¯•ç”¨å…¶ä»–æ–¹å¼æŸ¥æ‰¾ï¼Œæ¯”å¦‚åç§°åŒ¹é…
                                    const nameElements = messagesContainer.querySelectorAll('.QQ_home_name');
                                    let foundByName = null;
                                    for (const nameEl of nameElements) {
                                        if (nameEl.textContent.trim() === groupData.name) {
                                            foundByName = nameEl.closest('[data-group-id]');
                                            break;
                                        }
                                    }
                                    
                                    if (foundByName) {
                                        console.log('é€šè¿‡åç§°åŒ¹é…æ‰¾åˆ°ç¾¤èŠå…ƒç´ ï¼Œæ›´æ–°data-group-id');
                                        foundByName.setAttribute('data-group-id', groupData.id);
                                        updateGroupElement(foundByName, groupData);
                                    } else {
                                        console.warn(`âŒ ç¾¤èŠ "${groupData.name}" åœ¨æ¶ˆæ¯åˆ—è¡¨ä¸­å®Œå…¨æ‰¾ä¸åˆ°ï¼Œå¯èƒ½å·²è¢«åˆ é™¤æˆ–éšè—`);
                                        
                                                                // ç‰¹æ®Šæ£€æŸ¥'æ¸¯åŒº'ç¾¤èŠ
                        if (groupData.name === 'æ¸¯åŒº') {
                            console.error('ğŸš¨ ç‰¹åˆ«å…³æ³¨ï¼šæ¸¯åŒºç¾¤èŠåœ¨æ¶ˆæ¯åˆ—è¡¨ä¸­æ‰¾ä¸åˆ°ï¼');
                            console.log('æ¸¯åŒºç¾¤èŠå®Œæ•´æ•°æ®:', JSON.stringify(groupData, null, 2));
                            console.log('æ‰€æœ‰ç°æœ‰å…ƒç´ çš„è¯¦ç»†ä¿¡æ¯:');
                            existingElements.forEach(el => {
                                console.log('å…ƒç´ :', {
                                    innerHTML: el.innerHTML.substring(0, 200),
                                    dataGroupId: el.getAttribute('data-group-id'),
                                    nameText: el.querySelector('.QQ_home_name')?.textContent
                                });
                            });
                            
                            // *** æ¸¯åŒºç¾¤èŠç´§æ€¥æ¢å¤æœºåˆ¶ ***
                            console.log('å¯åŠ¨æ¸¯åŒºç¾¤èŠç´§æ€¥æ¢å¤æœºåˆ¶...');
                            const messagesContainer = document.querySelector('#QQ_messages_list');
                            if (messagesContainer) {
                                // æ£€æŸ¥æ˜¯å¦æœ‰æ¸¯åŒºç¾¤èŠçš„æ®‹ç•™å…ƒç´ ï¼ˆæ²¡æœ‰æ­£ç¡®çš„data-group-idï¼‰
                                const allGroupElements = messagesContainer.querySelectorAll('.QQ_home_lxr');
                                console.log('æ‰¾åˆ°çš„æ‰€æœ‰ç¾¤èŠå…ƒç´ :', allGroupElements.length);
                                
                                for (const element of allGroupElements) {
                                    const nameEl = element.querySelector('.QQ_home_name');
                                    if (nameEl && nameEl.textContent.trim() === 'æ¸¯åŒº') {
                                        console.log('ğŸ”§ æ‰¾åˆ°æ¸¯åŒºç¾¤èŠå…ƒç´ ï¼Œä¿®å¤å…¶data-group-id');
                                        element.setAttribute('data-group-id', groupData.id || 'group_gangqu');
                                        updateGroupElement(element, groupData);
                                        console.log('âœ… æ¸¯åŒºç¾¤èŠå·²ä¿®å¤');
                                        return; // ä¿®å¤å®Œæˆï¼Œé€€å‡º
                                    }
                                }
                                
                                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå°è¯•é‡æ–°æ·»åŠ æ¸¯åŒºç¾¤èŠ
                                console.log('ğŸ†˜ æ¸¯åŒºç¾¤èŠå®Œå…¨ä¸¢å¤±ï¼Œå°è¯•é‡æ–°åˆ›å»º...');
                                const groupElement = createGroupElementForDisplay({
                                    ...groupData,
                                    id: groupData.id || 'group_gangqu',
                                    name: 'æ¸¯åŒº'
                                });
                                
                                if (groupElement) {
                                    messagesContainer.insertBefore(groupElement, messagesContainer.firstChild);
                                    console.log('âœ… æ¸¯åŒºç¾¤èŠå·²é‡æ–°åˆ›å»ºå¹¶æ·»åŠ åˆ°åˆ—è¡¨é¡¶éƒ¨');
                                }
                            }
                        }
                                    }
                                } else {
                                    console.log('âœ… æ‰¾åˆ°ç¾¤èŠå…ƒç´ ï¼Œæ­£åœ¨æ›´æ–°:', groupData.name);
                                    updateGroupElement(existingElement, groupData);
                                }
                            }
                        }
                        
                        console.log('=== æ¶ˆæ¯åˆ—è¡¨ç¾¤èŠæ›´æ–°å®Œæˆ ===');
                    }
                } catch (error) {
                    console.error('æ›´æ–°ç°æœ‰ç¾¤èŠå…ƒç´ æ—¶å‡ºé”™:', error);
                }
            }
            
            /**
             * æ›´æ–°ç¾¤èŠå…ƒç´ çš„åç§°å’Œå¤´åƒï¼ˆå¢å¼ºç‰ˆï¼šé˜²æ­¢å¤´åƒä¸¢å¤±ï¼‰
             */
            function updateGroupElement(element, groupData) {
                try {
                    console.log('=== updateGroupElement å¼€å§‹ ===');
                    console.log('ç¾¤èŠæ•°æ®:', {
                        name: groupData.name,
                        id: groupData.id,
                        avatar: groupData.avatar,
                        avatarUrl: groupData.avatarUrl
                    });
                    
                    // æ›´æ–°ç¾¤èŠåç§°
                    const nameElement = element.querySelector('.QQ_home_name');
                    if (nameElement) {
                        nameElement.textContent = groupData.name;
                    }
                    
                    // *** å…³é”®ä¿®å¤ï¼šæ›´å¼ºçš„å¤´åƒæ•°æ®æ£€æŸ¥å’Œä¿æŠ¤ ***
                    const avatarElement = element.querySelector('.QQ_home_head');
                    if (avatarElement) {
                        console.log('æ‰¾åˆ°å¤´åƒå…ƒç´ ï¼Œæ£€æŸ¥å¤´åƒæ•°æ®...');
                        
                        // ä¼˜å…ˆçº§1ï¼šæ£€æŸ¥å®Œæ•´çš„avatarå¯¹è±¡
                        if (groupData.avatar && typeof groupData.avatar === 'object' && groupData.avatar.type) {
                            console.log('å‘ç°å®Œæ•´çš„å¤´åƒå¯¹è±¡ï¼Œåº”ç”¨å¤´åƒ:', groupData.avatar);
                            updateAvatarElement(avatarElement, groupData.avatar);
                        }
                        // ä¼˜å…ˆçº§2ï¼šæ£€æŸ¥avatarUrlå­—ç¬¦ä¸²
                        else if (groupData.avatarUrl && typeof groupData.avatarUrl === 'string') {
                            console.log('å‘ç°avatarUrlï¼Œåº”ç”¨å­—ç¬¦ä¸²å¤´åƒ:', groupData.avatarUrl);
                            updateAvatarElement(avatarElement, groupData.avatarUrl);
                        }
                        // ä¼˜å…ˆçº§3ï¼šæ£€æŸ¥avatarå­—ç¬¦ä¸²
                        else if (groupData.avatar && typeof groupData.avatar === 'string') {
                            console.log('å‘ç°avatarå­—ç¬¦ä¸²ï¼Œåº”ç”¨å¤´åƒ:', groupData.avatar);
                            updateAvatarElement(avatarElement, groupData.avatar);
                        }
                        // ä¼˜å…ˆçº§4ï¼šä»å†…å­˜ä¸­çš„QQ_GroupsæŸ¥æ‰¾å®Œæ•´æ•°æ®
                        else if (window.QQ_Groups && groupData.id) {
                            console.log('å¤´åƒæ•°æ®ä¸å®Œæ•´ï¼Œä»QQ_Groupsä¸­æŸ¥æ‰¾...');
                            const fullGroupData = window.QQ_Groups.find(g => g.id === groupData.id || g.name === groupData.name);
                            if (fullGroupData && fullGroupData.avatar) {
                                console.log('ä»QQ_Groupsä¸­æ‰¾åˆ°å®Œæ•´å¤´åƒæ•°æ®:', fullGroupData.avatar);
                                updateAvatarElement(avatarElement, fullGroupData.avatar);
                            } else {
                                console.warn('ä»QQ_Groupsä¸­ä¹Ÿæœªæ‰¾åˆ°å¤´åƒæ•°æ®ï¼Œä¿æŒç°æœ‰å¤´åƒ');
                                // ä¸åº”ç”¨é»˜è®¤å¤´åƒï¼Œä¿æŒç°æœ‰å¤´åƒä¸å˜
                            }
                        }
                                                 else {
                             console.warn('æ²¡æœ‰æœ‰æ•ˆçš„å¤´åƒæ•°æ®ï¼Œä¿æŒç°æœ‰å¤´åƒ');
                             // ä¸åº”ç”¨é»˜è®¤å¤´åƒï¼Œä¿æŒç°æœ‰å¤´åƒä¸å˜
                         }
                     } else {
                         console.warn('æœªæ‰¾åˆ°å¤´åƒå…ƒç´ ');
                     }
                    
                    console.log('ç¾¤èŠå…ƒç´ æ›´æ–°å®Œæˆ:', groupData.name);
                } catch (error) {
                    console.error('æ›´æ–°ç¾¤èŠå…ƒç´ æ—¶å‡ºé”™:', error);
                }
            }
            
            /**
             * æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯åˆ°ç¾¤èŠï¼ˆç°è‰²å°å­—ï¼‰
             */
            async function addSystemMessageToGroup(groupId, systemMessage) {
                console.log('æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯åˆ°ç¾¤èŠ:', { groupId, systemMessage });
                
                try {
                    // ç¡®ä¿ç¾¤èŠæ¶ˆæ¯æ•°ç»„å­˜åœ¨
                    if (!window.groupChatMessages) {
                        window.groupChatMessages = {};
                    }
                    if (!window.groupChatMessages[groupId]) {
                        window.groupChatMessages[groupId] = [];
                    }
                    
                    // åˆ›å»ºç³»ç»Ÿæ¶ˆæ¯å¯¹è±¡
                    const systemMessageObj = {
                        id: 'system_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        type: 'system',
                        content: systemMessage,
                        timestamp: new Date().toISOString(),
                        sender: 'system'
                    };
                    
                    // æ·»åŠ åˆ°ç¾¤èŠæ¶ˆæ¯æ•°ç»„
                    window.groupChatMessages[groupId].push(systemMessageObj);
                    
                    // å¦‚æœå½“å‰æ­£åœ¨æŸ¥çœ‹è¿™ä¸ªç¾¤èŠï¼Œç«‹å³æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯
                    if (window.currentGroupChat && window.currentGroupChat.id === groupId) {
                        displaySystemMessage(systemMessage, groupId);
                    }
                    
                    console.log('ç³»ç»Ÿæ¶ˆæ¯å·²æ·»åŠ åˆ°ç¾¤èŠ');
                    
                } catch (error) {
                    console.error('æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯æ—¶å‡ºé”™:', error);
                }
            }
            
            /**
             * åœ¨èŠå¤©ç•Œé¢æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯ï¼ˆç°è‰²å°å­—ï¼‰- ä¿®å¤ç‰ˆ
             */
            function displaySystemMessage(message, targetGroupId = null) {
                try {
                    console.log('=== å°è¯•æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯ ===');
                    console.log('æ¶ˆæ¯å†…å®¹:', message);
                    console.log('ç›®æ ‡ç¾¤èŠID:', targetGroupId);
                    console.log('å½“å‰ç¾¤èŠ:', window.currentGroupChat);
                    
                    let msgContent = null;
                    
                    // *** ä¿®å¤ï¼šæ›´å‡†ç¡®çš„æ¶ˆæ¯å®¹å™¨æŸ¥æ‰¾ç­–ç•¥ ***
                    const containerSelectors = [
                        '.QQ_chat_page[style*="display:block"] .msgcontent',
                        '.QQ_chat_page:not([style*="display:none"]) .msgcontent',
                        '.msgcontent:not([style*="display:none"])',
                        '.msgcontent',
                        '#QQ_chat_msgs'
                    ];
                    
                    // æŒ‰ä¼˜å…ˆçº§æŸ¥æ‰¾å¯è§çš„æ¶ˆæ¯å®¹å™¨
                    for (const selector of containerSelectors) {
                        const elements = document.querySelectorAll(selector);
                        for (const element of elements) {
                            if (element && element.offsetParent !== null && 
                                element.offsetWidth > 0 && element.offsetHeight > 0) {
                                msgContent = element;
                                console.log('âœ… æ‰¾åˆ°å¯è§çš„æ¶ˆæ¯å®¹å™¨ï¼Œä½¿ç”¨é€‰æ‹©å™¨:', selector);
                                break;
                            }
                        }
                        if (msgContent) break;
                    }
                    
                    // *** ä¿®å¤ï¼šå¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œå¼ºåˆ¶æŸ¥æ‰¾å½“å‰æ´»è·ƒçš„èŠå¤©é¡µé¢ ***
                    if (!msgContent) {
                        console.log('å°è¯•åœ¨å½“å‰æ´»è·ƒçš„èŠå¤©é¡µé¢ä¸­æŸ¥æ‰¾æ¶ˆæ¯å®¹å™¨...');
                        
                        // æŸ¥æ‰¾å½“å‰æ˜¾ç¤ºçš„èŠå¤©é¡µé¢
                        const activeChatPage = document.querySelector('.QQ_chat_page[style*="display:block"]') ||
                                              document.querySelector('.QQ_chat_page:not([style*="display:none"])');
                        
                        if (activeChatPage) {
                            console.log('æ‰¾åˆ°æ´»è·ƒçš„èŠå¤©é¡µé¢ï¼Œåˆ›å»ºä¸´æ—¶æ¶ˆæ¯å®¹å™¨');
                            
                            // åœ¨æ´»è·ƒèŠå¤©é¡µé¢ä¸­åˆ›å»ºæˆ–æŸ¥æ‰¾æ¶ˆæ¯å®¹å™¨
                            msgContent = activeChatPage.querySelector('.msgcontent');
                            if (!msgContent) {
                                msgContent = document.createElement('div');
                                msgContent.className = 'msgcontent';
                                msgContent.style.cssText = `
                                    flex: 1;
                                    overflow-y: auto;
                                    box-sizing: border-box;
                                    margin-bottom: 50px;
                                    padding-left: 8px;
                                    padding-right: 8px;
                                    scrollbar-width: none;
                                    -ms-overflow-style: none;
                                    height: calc(100% - 120px);
                                    position: relative;
                                `;
                                activeChatPage.appendChild(msgContent);
                            }
                        }
                    }
                    
                    if (!msgContent) {
                        console.error('æ— æ³•æ‰¾åˆ°ä»»ä½•æ¶ˆæ¯å®¹å™¨æ¥æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯');
                        // ä½œä¸ºæœ€åçš„å…œåº•æ–¹æ¡ˆï¼Œç›´æ¥åœ¨é¡µé¢ä¸­æ˜¾ç¤º
                        const fallbackMsg = document.createElement('div');
                        fallbackMsg.style.cssText = `
                            position: fixed;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            background: rgba(0,0,0,0.8);
                            color: white;
                            padding: 10px 20px;
                            border-radius: 5px;
                            z-index: 999999;
                            font-size: 14px;
                        `;
                        fallbackMsg.textContent = message;
                        document.body.appendChild(fallbackMsg);
                        setTimeout(() => fallbackMsg.remove(), 3000);
                        return;
                    }
                    
                    console.log('å‡†å¤‡æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯åˆ°å®¹å™¨:', msgContent.tagName, msgContent.className || msgContent.id);
                    
                    // *** ä¿®å¤ï¼šåˆ›å»ºæ›´å¯é çš„ç³»ç»Ÿæ¶ˆæ¯å…ƒç´  ***
                    const systemMsgDiv = document.createElement('div');
                    systemMsgDiv.className = 'system-message-chat';
                    systemMsgDiv.setAttribute('data-message-type', 'system');
                    systemMsgDiv.setAttribute('data-timestamp', Date.now());
                    
                    // *** ä¿®å¤ï¼šä½¿ç”¨æ›´å¼ºåˆ¶çš„æ ·å¼ï¼Œç¡®ä¿æ˜¾ç¤º ***
                    systemMsgDiv.style.cssText = `
                        text-align: center !important;
                        color: #999999 !important;
                        font-size: 12px !important;
                        margin: 10px auto !important;
                        padding: 5px 10px !important;
                        line-height: 1.4 !important;
                        background: transparent !important;
                        border: none !important;
                        max-width: 90% !important;
                        position: relative !important;
                        z-index: 10 !important;
                        word-wrap: break-word !important;
                        white-space: normal !important;
                        display: block !important;
                        clear: both !important;
                        font-weight: normal !important;
                        opacity: 1 !important;
                        visibility: visible !important;
                        box-sizing: border-box !important;
                        width: auto !important;
                        min-height: 20px !important;
                        font-family: inherit !important;
                    `;
                    systemMsgDiv.textContent = message;
                    
                    console.log('*** ç³»ç»Ÿæ¶ˆæ¯å…ƒç´ å·²åˆ›å»º ***:', {
                        message: message,
                        element: systemMsgDiv,
                        parent: msgContent.tagName,
                        parentVisible: msgContent.offsetParent !== null
                    });
                    
                    // *** ä¿®å¤ï¼šç«‹å³æ·»åŠ å¹¶å¼ºåˆ¶æ˜¾ç¤º ***
                    msgContent.appendChild(systemMsgDiv);
                    
                    // å¼ºåˆ¶åˆ·æ–°å¸ƒå±€
                    systemMsgDiv.offsetHeight;
                    
                    // ç«‹å³æ»šåŠ¨åˆ°åº•éƒ¨
                    setTimeout(() => {
                        msgContent.scrollTop = msgContent.scrollHeight;
                        console.log('ç³»ç»Ÿæ¶ˆæ¯å·²æ˜¾ç¤ºï¼Œå®¹å™¨é«˜åº¦:', msgContent.scrollHeight);
                    }, 50);
                    
                    // *** ä¿®å¤ï¼šæ·»åŠ éªŒè¯æ£€æŸ¥ ***
                    setTimeout(() => {
                        if (document.contains(systemMsgDiv)) {
                            const computedStyle = window.getComputedStyle(systemMsgDiv);
                            console.log('âœ… ç³»ç»Ÿæ¶ˆæ¯æ˜¾ç¤ºæˆåŠŸ:', {
                                inDOM: true,
                                visible: systemMsgDiv.offsetParent !== null,
                                display: computedStyle.display,
                                visibility: computedStyle.visibility,
                                opacity: computedStyle.opacity,
                                height: systemMsgDiv.offsetHeight
                            });
                        } else {
                            console.error('âŒ ç³»ç»Ÿæ¶ˆæ¯æœªèƒ½æ·»åŠ åˆ°DOMä¸­');
                        }
                    }, 200);
                    
                } catch (error) {
                    console.error('æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯æ—¶å‡ºé”™:', error);
                    console.error('é”™è¯¯è¯¦æƒ…:', error.stack);
                }
            }
            

            
            /**
             * ä¸ºç¾¤èŠå˜æ›´æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
             */
            async function addSystemMessagesForChanges(groupId, changes) {
                if (!changes || changes.length === 0) {
                    return;
                }
                
                console.log('ä¸ºç¾¤èŠå˜æ›´æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯:', { groupId, changes });
                
                for (const change of changes) {
                    let systemMessage = '';
                    
                    switch (change.type) {
                        case 'name':
                            systemMessage = `ç¾¤èŠåç§°å·²æ›´æ”¹ä¸º"${change.newValue}"`;
                            break;
                        case 'avatar':
                            systemMessage = `ç¾¤ä¸»å·²æ›´æ”¹ç¾¤å¤´åƒ`;
                            break;
                        case 'add_member':
                            systemMessage = `${change.operator}é‚€è¯·${change.newValue}åŠ å…¥ç¾¤èŠ`;
                            break;
                        case 'remove_member':
                            systemMessage = `${change.operator}å°†${change.oldValue}ç§»å‡ºç¾¤èŠ`;
                            break;
                        default:
                            systemMessage = `ç¾¤èŠè®¾ç½®å·²æ›´æ–°`;
                            break;
                    }
                    
                    if (systemMessage) {
                        await addSystemMessageToGroup(groupId, systemMessage);
                    }
                }
            }
            
            /**
             * æ›´æ–°ç¾¤èŠæ¶ˆæ¯JSONä¸­çš„ç¾¤èŠä¿¡æ¯ï¼ˆä¿æŒèŠå¤©è®°å½•ï¼‰
             */
            async function updateGroupChatMessagesInMsgjson(groupId, oldName, newName) {
                console.log('æ›´æ–°æ¶ˆæ¯JSONä¸­çš„ç¾¤èŠä¿¡æ¯:', { groupId, oldName, newName });
                
                try {
                    // æ›´æ–°ç¾¤èŠæ¶ˆæ¯è®°å½•ä¸­çš„ç¾¤èŠåç§°
                    if (window.groupChatMessages && window.groupChatMessages[groupId]) {
                        const messages = window.groupChatMessages[groupId];
                        console.log(`ç¾¤èŠ ${groupId} æœ‰ ${messages.length} æ¡æ¶ˆæ¯éœ€è¦æ›´æ–°`);
                        
                        // è¿™é‡Œå¯ä»¥æ›´æ–°æ¶ˆæ¯ä¸­çš„ç¾¤èŠç›¸å…³ä¿¡æ¯ï¼Œä½†ä¿æŒæ¶ˆæ¯å†…å®¹ä¸å˜
                        // ç›®å‰ä¸»è¦æ˜¯ç¡®ä¿groupIdå’Œæ¶ˆæ¯è®°å½•çš„å…³è”ä¿æŒæ­£ç¡®
                    }
                    
                    // æ›´æ–°msgjsonä¸­çš„ç¾¤èŠç›¸å…³ä¿¡æ¯
                    if (window.msgjson && window.msgjson.data) {
                        // éå†æ‰€æœ‰ç”¨æˆ·çš„æ¶ˆæ¯ï¼Œæ›´æ–°æ¶‰åŠè¯¥ç¾¤èŠçš„æ¶ˆæ¯
                        Object.keys(window.msgjson.data).forEach(userId => {
                            const userMessages = window.msgjson.data[userId];
                            if (Array.isArray(userMessages)) {
                                userMessages.forEach(message => {
                                    // å¦‚æœæ¶ˆæ¯ä¸­æåˆ°äº†æ—§çš„ç¾¤èŠåç§°ï¼Œå¯ä»¥é€‰æ‹©æ€§æ›´æ–°
                                    // ä½†è¦ä¿æŒæ¶ˆæ¯å†…å®¹çš„å®Œæ•´æ€§
                                    if (message.mes && typeof message.mes === 'string' && message.mes.includes(oldName)) {
                                        console.log(`åœ¨ç”¨æˆ· ${userId} çš„æ¶ˆæ¯ä¸­å‘ç°ç¾¤èŠå¼•ç”¨ï¼Œä¿æŒä¸å˜`);
                                        // è¿™é‡Œå¯ä»¥é€‰æ‹©æ˜¯å¦æ›´æ–°æ¶ˆæ¯ä¸­çš„ç¾¤èŠåç§°å¼•ç”¨
                                        // ä¸ºäº†å®‰å…¨èµ·è§ï¼Œæš‚æ—¶ä¿æŒæ¶ˆæ¯å†…å®¹ä¸å˜
                                    }
                                });
                            }
                        });
                    }
                    
                    console.log('ç¾¤èŠæ¶ˆæ¯ä¿¡æ¯æ›´æ–°å®Œæˆ');
                } catch (error) {
                    console.error('æ›´æ–°ç¾¤èŠæ¶ˆæ¯ä¿¡æ¯æ—¶å‡ºé”™:', error);
                }
            }
            
            /**
             * é‡æ–°åº”ç”¨ç¾¤èŠèƒŒæ™¯ï¼ˆä½¿ç”¨åŸæœ‰çš„getRandomChatBackgroundé€»è¾‘ï¼‰
             */
            function reapplyGroupChatBackground(groupData) {
                console.log('*** é‡æ–°åº”ç”¨ç¾¤èŠèƒŒæ™¯ ***');
                console.log('ç¾¤èŠæ•°æ®:', groupData);
                
                try {
                    if (!groupData || !groupData.name) {
                        console.warn('ç¾¤èŠæ•°æ®æ— æ•ˆï¼Œè·³è¿‡èƒŒæ™¯åº”ç”¨');
                        return;
                    }
                    
                    // è·å–éšæœºèŠå¤©èƒŒæ™¯ï¼ˆä½¿ç”¨åŸæœ‰é€»è¾‘ï¼‰
                    const randomBackground = getRandomChatBackground();
                    console.log('è·å–åˆ°çš„éšæœºèƒŒæ™¯:', randomBackground);
                    
                    if (!randomBackground) {
                        console.warn('æœªè·å–åˆ°æœ‰æ•ˆèƒŒæ™¯ï¼Œè·³è¿‡åº”ç”¨');
                        return;
                    }
                    
                    // æŸ¥æ‰¾æˆ–åˆ›å»ºç¾¤èŠçš„CSSæ ·å¼ï¼ˆæ¨¡ä»¿AddNewGroupçš„é€»è¾‘ï¼‰
                    const groupName = groupData.name;
                    
                    // ç§»é™¤æ—§çš„èƒŒæ™¯æ ·å¼ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    $(`style[data-group-bg="${groupName}"]`).remove();
                    
                    // åˆ›å»ºæ–°çš„èƒŒæ™¯CSSæ ·å¼ï¼ˆåŒ…å«å®Œæ•´çš„èƒŒæ™¯å±æ€§ï¼‰
                    const backgroundCSS = `
.QQ_chat_page[data-name='${groupName}'] {
    --BackGroundImg: url('${randomBackground}');
    background-image: var(--BackGroundImg) !important;
    background-size: cover !important;
    background-position: center !important;
    background-repeat: no-repeat !important;
    background-color: transparent !important;
}`;
                    
                    // åˆ›å»ºæ–°çš„styleå…ƒç´ å¹¶æ·»åŠ åˆ°é¡µé¢
                    const style = $("<style></style>").prop("type", "text/css");
                    style.attr('data-group-bg', groupName);
                    style.text(backgroundCSS);
                    $("head").append(style);
                    
                    console.log(`ç¾¤èŠ ${groupName} çš„èƒŒæ™¯CSSå·²é‡æ–°åº”ç”¨:`, randomBackground);
                    
                    // å»¶è¿ŸéªŒè¯èƒŒæ™¯æ˜¯å¦æ­£ç¡®åº”ç”¨ï¼ˆæ›´å®½æ¾çš„éªŒè¯ï¼‰
                    setTimeout(() => {
                        const chatPage = document.querySelector(`.QQ_chat_page[data-name="${groupName}"]`);
                        if (chatPage) {
                            const finalBg = window.getComputedStyle(chatPage).backgroundImage;
                            console.log('èƒŒæ™¯åº”ç”¨éªŒè¯ - æœ€ç»ˆèƒŒæ™¯:', finalBg);
                            
                            // æ›´å®½æ¾çš„éªŒè¯ï¼šåªè¦ä¸æ˜¯'none'å°±è®¤ä¸ºæˆåŠŸ
                            if (finalBg === 'none') {
                                console.warn('èƒŒæ™¯åº”ç”¨å¤±è´¥ï¼šæœ€ç»ˆèƒŒæ™¯ä¸ºnone');
                            } else if (finalBg.includes('url(')) {
                                console.log('*** ç¾¤èŠèƒŒæ™¯é‡æ–°åº”ç”¨æˆåŠŸ ***');
                                console.log('éªŒè¯é€šè¿‡ï¼šæ£€æµ‹åˆ°èƒŒæ™¯å›¾ç‰‡URL');
                            } else {
                                // å³ä½¿URLä¸å®Œå…¨åŒ¹é…ï¼Œåªè¦æœ‰èƒŒæ™¯å°±ç®—æˆåŠŸ
                                console.log('*** ç¾¤èŠèƒŒæ™¯é‡æ–°åº”ç”¨æˆåŠŸ ***'); 
                                console.log('éªŒè¯é€šè¿‡ï¼šæ£€æµ‹åˆ°èƒŒæ™¯æ ·å¼ï¼ˆå¯èƒ½ä¸ºCSSå˜é‡å±•å¼€åçš„å€¼ï¼‰');
                            }
                        }
                    }, 200);
                    
                } catch (error) {
                    console.error('é‡æ–°åº”ç”¨ç¾¤èŠèƒŒæ™¯æ—¶å‡ºé”™:', error);
                }
            }
            
            /**
             * ç¾¤èŠæ”¹åæ—¶çš„å®Œæ•´æ•°æ®è¿ç§»ï¼ˆä¿®å¤ç»‘å®šå…³ç³»ï¼‰
             */
            async function migrateGroupDataBindings(oldName, newName, groupData) {
                console.log('*** å¼€å§‹ç¾¤èŠæ”¹åæ•°æ®è¿ç§» ***');
                console.log(`è¿ç§»: "${oldName}" -> "${newName}"`);
                
                try {
                    let migratedCount = 0;
                    
                    // *** 1. è¿ç§»å£çº¸ç»‘å®šæ•°æ®ï¼ˆå¦‚æœå­˜åœ¨ä»¥ç¾¤èŠåç§°ä¸ºkeyçš„ç»‘å®šï¼‰***
                    if (window.wallpaperurl) {
                        // æ£€æŸ¥æ˜¯å¦æœ‰ä»¥æ—§ç¾¤èŠåç§°ä¸ºkeyçš„å£çº¸è®¾ç½®
                        if (window.wallpaperurl[oldName]) {
                            console.log(`å‘ç°ä»¥ç¾¤èŠåç§°ä¸ºkeyçš„å£çº¸è®¾ç½®: ${oldName}`);
                            window.wallpaperurl[newName] = window.wallpaperurl[oldName];
                            delete window.wallpaperurl[oldName];
                            console.log(`å£çº¸ç»‘å®šå·²è¿ç§»: ${oldName} -> ${newName}`);
                            migratedCount++;
                        }
                        
                        // ç¡®ä¿ç¾¤èŠæˆå‘˜çš„å£çº¸ç»‘å®šå®Œæ•´
                    if (groupData.members && groupData.members.length > 0) {
                        const firstMember = groupData.members[0];
                            if (window.wallpaperurl[firstMember]) {
                                console.log(`ç¡®è®¤æˆå‘˜å£çº¸ç»‘å®šå­˜åœ¨: ${firstMember} -> ${window.wallpaperurl[firstMember]}`);
                            } else {
                                // å¦‚æœæˆå‘˜æ²¡æœ‰å£çº¸è®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤çš„ç¾¤èŠå£çº¸
                                window.wallpaperurl[firstMember] = 'https://files.catbox.moe/9fdwty.jpg';
                                console.log(`ä¸ºæˆå‘˜è®¾ç½®é»˜è®¤ç¾¤èŠå£çº¸: ${firstMember}`);
                                migratedCount++;
                            }
                        }
                    }
                    
                    // *** 2. ç¡®ä¿å…¨å±€QQ_Groupsæ•°ç»„æ­£ç¡®æ›´æ–° ***
                    console.log('æ£€æŸ¥å’Œæ›´æ–°å…¨å±€QQ_Groupsæ•°ç»„...');
                    
                    // ç¡®ä¿QQ_Groupsæ•°ç»„å­˜åœ¨
                    if (!window.QQ_Groups) {
                        console.warn('QQ_Groupsæ•°ç»„ä¸å­˜åœ¨ï¼Œé‡æ–°åˆå§‹åŒ–');
                        window.QQ_Groups = [];
                    }
                    
                    // æŸ¥æ‰¾å¹¶æ›´æ–°QQ_Groupsä¸­çš„ç¾¤èŠæ•°æ®
                    const groupIndex = window.QQ_Groups.findIndex(g => 
                        g && (g.id === groupData.id || g.name === oldName || g.name === newName)
                    );
                    
                    if (groupIndex > -1) {
                        console.log(`æ›´æ–°QQ_Groupsæ•°ç»„ä¸­çš„ç¾¤èŠ [${groupIndex}]:`, oldName, '->', newName);
                        console.log(`å¤´åƒæ•°æ®è¿ç§»: ${groupData.avatar ? JSON.stringify(groupData.avatar) : 'null'}`);
                        window.QQ_Groups[groupIndex] = {
                            ...window.QQ_Groups[groupIndex],
                            name: groupData.name,
                            id: groupData.id,
                            avatar: groupData.avatar,
                            avatarUrl: groupData.avatarUrl,
                            members: groupData.members
                        };
                        console.log('QQ_Groupsæ•°ç»„ä¸­çš„å¤´åƒå·²æ›´æ–°:', window.QQ_Groups[groupIndex].avatar);
                        migratedCount++;
                    } else {
                        // å¦‚æœåœ¨QQ_Groupsä¸­æ‰¾ä¸åˆ°ï¼Œç¡®ä¿ç¾¤èŠæ•°æ®å­˜åœ¨
                        console.log('åœ¨QQ_Groupsä¸­æœªæ‰¾åˆ°ç¾¤èŠï¼Œæ·»åŠ æ–°æ•°æ®');
                        console.log('æ–°æ•°æ®å¤´åƒ:', groupData.avatar);
                        window.QQ_Groups.push(groupData);
                        migratedCount++;
                    }
                    
                    console.log('QQ_Groupsæ•°ç»„æ›´æ–°å®Œæˆï¼Œå½“å‰æ•°é‡:', window.QQ_Groups.length);
                    console.log('QQ_Groupsæ•°ç»„å†…å®¹:', window.QQ_Groups.map(g => ({ name: g.name, id: g.id })));
                    
                    // *** 3. è¿ç§»å…¶ä»–å¯èƒ½çš„åç§°ç»‘å®šæ•°æ® ***
                    
                    // è¿ç§»localStorageä¸­å¯èƒ½çš„ç¾¤èŠç›¸å…³æ•°æ®
                    try {
                        const storageKeys = Object.keys(localStorage);
                        for (const key of storageKeys) {
                            if (key.includes(oldName)) {
                                const value = localStorage.getItem(key);
                                const newKey = key.replace(oldName, newName);
                                localStorage.setItem(newKey, value);
                                localStorage.removeItem(key);
                                console.log(`localStorageæ•°æ®è¿ç§»: ${key} -> ${newKey}`);
                                migratedCount++;
                            }
                        }
                    } catch (storageError) {
                        console.warn('localStorageæ•°æ®è¿ç§»æ—¶å‡ºé”™:', storageError);
                    }
                    
                    // *** 3. è¿ç§»windowå…¨å±€å¯¹è±¡ä¸­çš„ç¾¤èŠç›¸å…³æ•°æ® ***
                    if (window.groups && Array.isArray(window.groups)) {
                        const groupIndex = window.groups.findIndex(g => g && g.name === oldName || g.name === newName);
                        if (groupIndex !== -1) {
                            window.groups[groupIndex].name = newName;
                            console.log(`window.groupsæ•°æ®å·²æ›´æ–°`);
                            migratedCount++;
                        }
                    }
                    
                    // *** 4. ç¡®ä¿CSSç±»åå’Œæ ·å¼çš„æ•°æ®ç»‘å®š ***
                    // æ›´æ–°æ‰€æœ‰å¯èƒ½åŒ…å«æ—§åç§°çš„dataå±æ€§
                    const elementsWithOldName = document.querySelectorAll(`[data-name="${oldName}"]`);
                    elementsWithOldName.forEach(el => {
                        el.setAttribute('data-name', newName);
                        console.log('å·²æ›´æ–°å…ƒç´ data-nameå±æ€§');
                        migratedCount++;
                    });
                    
                    // *** 5. è¿ç§»å¯èƒ½çš„èŠå¤©å†å²ç»‘å®š ***
                    if (window.groupChats && window.groupChats[oldName]) {
                        window.groupChats[newName] = window.groupChats[oldName];
                        delete window.groupChats[oldName];
                        console.log(`ç¾¤èŠå†å²æ•°æ®å·²è¿ç§»: ${oldName} -> ${newName}`);
                        migratedCount++;
                    }
                    
                    console.log(`*** æ•°æ®è¿ç§»å®Œæˆï¼Œå…±è¿ç§» ${migratedCount} é¡¹æ•°æ®ç»‘å®š ***`);
                    
                    // *** 6. ç«‹å³æ›´æ–°å½“å‰èŠå¤©é¡µé¢ï¼ˆå¦‚æœæ­£åœ¨èŠå¤©ä¸­ï¼‰ ***
                    console.log('æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°å½“å‰èŠå¤©é¡µé¢...');
                    
                    // æŸ¥æ‰¾å½“å‰æ˜¾ç¤ºçš„èŠå¤©é¡µé¢
                    const currentChatPage = document.querySelector('.QQ_chat_page:not([style*="display: none"]):not([style*="display:none"])');
                    if (currentChatPage) {
                        console.log('æ‰¾åˆ°å½“å‰èŠå¤©é¡µé¢ï¼Œæ£€æŸ¥æ˜¯å¦ä¸ºç›®æ ‡ç¾¤èŠ...');
                        
                        // æ£€æŸ¥æ˜¯å¦ä¸ºå½“å‰ç¾¤èŠçš„èŠå¤©é¡µé¢
                        const pageGroupId = currentChatPage.getAttribute('data-group-id');
                        const pageDataName = currentChatPage.getAttribute('data-name');
                        
                        console.log('èŠå¤©é¡µé¢æ•°æ®:', {
                            pageGroupId,
                            pageDataName,
                            targetGroupId: groupData.id,
                            oldName,
                            newName
                        });
                        
                        // åˆ¤æ–­æ˜¯å¦ä¸ºç›®æ ‡ç¾¤èŠé¡µé¢ï¼ˆé€šè¿‡IDæˆ–åç§°åŒ¹é…ï¼‰
                        const isTargetChatPage = (pageGroupId === groupData.id) || 
                                                (pageDataName === oldName) || 
                                                (pageDataName === newName);
                        
                        if (isTargetChatPage) {
                            console.log('*** å½“å‰èŠå¤©é¡µé¢æ˜¯ç›®æ ‡ç¾¤èŠï¼Œç«‹å³æ›´æ–°ï¼***');
                            
                            // *** æ ¸å¿ƒä¿®å¤1ï¼šç«‹å³æ›´æ–°èŠå¤©é¡µé¢çš„æ•°æ®å±æ€§ ***
                            currentChatPage.setAttribute('data-group-id', groupData.id);
                            currentChatPage.setAttribute('data-name', groupData.name);
                            console.log('å·²æ›´æ–°èŠå¤©é¡µé¢çš„data-group-idå’Œdata-name');
                            
                            // *** æ ¸å¿ƒä¿®å¤2ï¼šç«‹å³æ›´æ–°window.currentGroupChat ***
                            if (window.currentGroupChat && 
                                (window.currentGroupChat.id === groupData.id || 
                                 window.currentGroupChat.name === oldName)) {
                                console.log('æ›´æ–°window.currentGroupChatæ•°æ®...');
                                window.currentGroupChat.name = groupData.name;
                                window.currentGroupChat.avatar = groupData.avatar;
                                window.currentGroupChat.avatarUrl = groupData.avatarUrl;
                                window.currentGroupChat.members = groupData.members;
                                console.log('window.currentGroupChatå·²æ›´æ–°:', window.currentGroupChat);
                            }
                            
                            // *** æ ¸å¿ƒä¿®å¤3ï¼šç«‹å³æ›´æ–°èŠå¤©é¡µé¢å¤´éƒ¨ï¼ˆå¤šé‡ç­–ç•¥ï¼‰ ***
                            console.log('å¼€å§‹ç«‹å³æ›´æ–°èŠå¤©é¡µé¢æ ‡é¢˜...');
                            
                            // ç­–ç•¥1ï¼šç›´æ¥æ›´æ–°èŠå¤©ç”¨æˆ·åå…ƒç´ 
                            const chatUsernameElement = currentChatPage.querySelector('#QQ_chat_username');
                            if (chatUsernameElement) {
                                console.log('æ‰¾åˆ°èŠå¤©ç”¨æˆ·åå…ƒç´ ï¼Œç«‹å³æ›´æ–°...');
                                const displayName = groupData.members && groupData.members.length > 1 
                                    ? `${groupData.name} (${groupData.members.length}äºº)` 
                                    : groupData.name;
                                chatUsernameElement.textContent = displayName;
                                chatUsernameElement.setAttribute('data-group-name', groupData.name);
                                chatUsernameElement.setAttribute('data-group-id', groupData.id);
                                console.log(`èŠå¤©æ ‡é¢˜å·²ç«‹å³æ›´æ–°ä¸º: ${displayName}`);
                            } else {
                                console.warn('æœªæ‰¾åˆ°#QQ_chat_usernameå…ƒç´ ');
                            }
                            
                            // ç­–ç•¥2ï¼šæŸ¥æ‰¾å¹¶æ›´æ–°å®Œæ•´çš„èŠå¤©å¤´éƒ¨
                            const chatHeader = currentChatPage.querySelector('.QQ_chat_header') || 
                                             currentChatPage.querySelector('.QQ_home') ||
                                             currentChatPage.querySelector('[class*="header"]');
                            
                            if (chatHeader) {
                                console.log('æ‰¾åˆ°èŠå¤©å¤´éƒ¨ï¼Œå®Œæ•´æ›´æ–°...');
                                updateHeaderContent(chatHeader, groupData);
                                console.log('èŠå¤©å¤´éƒ¨å®Œæ•´æ›´æ–°å®Œæˆ');
                            } else {
                                console.warn('æœªæ‰¾åˆ°èŠå¤©å¤´éƒ¨å…ƒç´ ');
                                console.log('èŠå¤©é¡µé¢ç»“æ„:', currentChatPage.outerHTML.substring(0, 500));
                            }
                            
                            // *** ç­–ç•¥3ï¼šå¼ºåˆ¶DOMåˆ·æ–°åå†æ¬¡æ›´æ–°ï¼ˆç¡®ä¿æ˜¾ç¤ºæ›´æ–°ï¼‰ ***
                        setTimeout(() => {
                                console.log('å»¶è¿Ÿå¼ºåˆ¶æ›´æ–°èŠå¤©æ ‡é¢˜...');
                                
                                // å†æ¬¡æŸ¥æ‰¾å¹¶æ›´æ–°ç”¨æˆ·åå…ƒç´ 
                                const delayedUsernameElement = currentChatPage.querySelector('#QQ_chat_username');
                                if (delayedUsernameElement) {
                                    const delayedDisplayName = groupData.members && groupData.members.length > 1 
                                        ? `${groupData.name} (${groupData.members.length}äºº)` 
                                        : groupData.name;
                                    delayedUsernameElement.textContent = delayedDisplayName;
                                    console.log(`å»¶è¿Ÿæ›´æ–°æ ‡é¢˜æˆåŠŸ: ${delayedDisplayName}`);
                                }
                                
                                // å†æ¬¡æ›´æ–°å¤´éƒ¨
                                const delayedChatHeader = currentChatPage.querySelector('.QQ_chat_header') || 
                                                         currentChatPage.querySelector('.QQ_home') ||
                                                         currentChatPage.querySelector('[class*="header"]');
                                if (delayedChatHeader) {
                                    updateHeaderContent(delayedChatHeader, groupData);
                                    console.log('å»¶è¿Ÿå¤´éƒ¨æ›´æ–°å®Œæˆ');
                                }
                                
                            }, 50);
                            
                                                         // *** æ ¸å¿ƒä¿®å¤4ï¼šé‡æ–°åº”ç”¨ç¾¤èŠèƒŒæ™¯ï¼ˆç«‹å³æ‰§è¡Œï¼‰ ***
                             reapplyGroupChatBackground(groupData);
                            
                            console.log('*** å½“å‰èŠå¤©é¡µé¢å®æ—¶æ›´æ–°å®Œæˆ ***');
                        } else {
                            console.log('å½“å‰èŠå¤©é¡µé¢ä¸æ˜¯ç›®æ ‡ç¾¤èŠï¼Œè·³è¿‡å®æ—¶æ›´æ–°');
                        }
                    } else {
                        console.log('å½“å‰æ²¡æœ‰æ‰“å¼€çš„èŠå¤©é¡µé¢');
                    }
                    
                    // *** 7. å»¶è¿Ÿåˆ·æ–°å…¶ä»–ç»„ä»¶ä»¥åº”ç”¨æ–°çš„ç»‘å®šå…³ç³» ***
                    setTimeout(() => {
                        console.log('å»¶è¿Ÿåˆ·æ–°å…¶ä»–ç»„ä»¶...');
                        
                        // è§¦å‘ç•Œé¢é‡æ–°æ¸²æŸ“äº‹ä»¶
                        const event = new CustomEvent('groupDataMigrated', {
                            detail: { oldName, newName, groupData }
                        });
                        window.dispatchEvent(event);
                        
                                                 // å†æ¬¡ç¡®ä¿å£çº¸æ­£ç¡®
                         reapplyGroupChatBackground(groupData);
                        
                    }, 100);
                    
                    return migratedCount;
                    
                } catch (error) {
                    console.error('ç¾¤èŠæ•°æ®è¿ç§»æ—¶å‡ºé”™:', error);
                    return 0;
                }
            }
            
            /**
             * ä¿æŠ¤æ€§è”ç³»äººåˆ—è¡¨æ›´æ–°ï¼ˆé˜²æ­¢æ ¼å¼ç ´åï¼‰
             */
            async function protectedContactListUpdate(groupData, operation = 'group_update') {
                console.log('*** å¼€å§‹ä¿æŠ¤æ€§è”ç³»äººåˆ—è¡¨æ›´æ–° ***');
                console.log('ç¾¤èŠæ•°æ®:', groupData);
                console.log('æ“ä½œç±»å‹:', operation);
                
                try {
                    const contactsContainer = document.getElementById('QQ_home_chars');
                    if (!contactsContainer) {
                        console.warn('è”ç³»äººå®¹å™¨æœªæ‰¾åˆ°');
                        return;
                    }
                    
                    // *** å…³é”®ç­–ç•¥ï¼šæåº¦ä¿å®ˆçš„æ›´æ–°æ–¹å¼ ***
                    
                    // 1. ç²¾ç¡®æŸ¥æ‰¾ç›®æ ‡ç¾¤èŠå…ƒç´ ï¼ˆä½¿ç”¨å¤šç§æ–¹æ³•ç¡®ä¿ç²¾ç¡®åŒ¹é…ï¼‰
                    let targetElements = [];
                    
                    // æ–¹æ³•1ï¼šä½¿ç”¨data-group-idæŸ¥æ‰¾
                    if (groupData.id) {
                        const byGroupId = contactsContainer.querySelectorAll(`[data-group-id="${groupData.id}"]`);
                        targetElements.push(...byGroupId);
                        console.log(`æ–¹æ³•1(data-group-id)æ‰¾åˆ° ${byGroupId.length} ä¸ªå…ƒç´ `);
                    }
                    
                    // æ–¹æ³•2ï¼šå¦‚æœoperationåŒ…å«æ—§åç§°ä¿¡æ¯ï¼Œä½¿ç”¨å®ƒæŸ¥æ‰¾
                    if (operation && operation !== 'group_update' && targetElements.length === 0) {
                        const byOldName = contactsContainer.querySelectorAll(`[data-name="${operation}"]`);
                        targetElements.push(...byOldName);
                        console.log(`æ–¹æ³•2(data-nameæ“ä½œå‚æ•°)æ‰¾åˆ° ${byOldName.length} ä¸ªå…ƒç´ `);
                    }
                    
                    // æ–¹æ³•3ï¼šä½¿ç”¨æ–°åç§°çš„data-nameæŸ¥æ‰¾
                    if (groupData.name && targetElements.length === 0) {
                        const byNewName = contactsContainer.querySelectorAll(`[data-name="${groupData.name}"]`);
                        targetElements.push(...byNewName);
                        console.log(`æ–¹æ³•3(data-nameæ–°åç§°)æ‰¾åˆ° ${byNewName.length} ä¸ªå…ƒç´ `);
                    }
                    
                    // å»é‡
                    targetElements = [...new Set(targetElements)];
                    console.log(`æ€»å…±æ‰¾åˆ° ${targetElements.length} ä¸ªç›®æ ‡å…ƒç´ éœ€è¦æ›´æ–°`);
                    
                    if (targetElements.length === 0) {
                        console.warn('æœªæ‰¾åˆ°éœ€è¦æ›´æ–°çš„è”ç³»äººå…ƒç´ ï¼Œè·³è¿‡æ›´æ–°');
                        return;
                    }
                    
                    // 2. å¯¹æ¯ä¸ªç›®æ ‡å…ƒç´ è¿›è¡Œå®‰å…¨æ›´æ–°
                    let successCount = 0;
                    let errorCount = 0;
                    
                    targetElements.forEach((element, index) => {
                        try {
                            console.log(`æ›´æ–°ç›®æ ‡å…ƒç´  ${index + 1}/${targetElements.length}`);
                            
                            // *** æåº¦å®‰å…¨çš„æ›´æ–°ç­–ç•¥ï¼šåªæ›´æ–°ç¡®ä¿å­˜åœ¨çš„å…ƒç´  ***
                            
                            // éªŒè¯è¿™æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„è”ç³»äººå…ƒç´ 
                            if (!element.classList.contains('QQ_home_usermsg')) {
                                console.warn(`å…ƒç´ ${index + 1}ä¸æ˜¯æœ‰æ•ˆçš„è”ç³»äººå…ƒç´ ï¼Œè·³è¿‡`);
                                return;
                            }
                            
                            // åªæ›´æ–°æ•°æ®å±æ€§ï¼ˆæœ€å®‰å…¨ï¼‰
                            element.setAttribute('data-group-id', groupData.id);
                            element.setAttribute('data-name', groupData.name);
                            
                            // åªæœ‰åœ¨æ‰¾åˆ°åç§°å…ƒç´ æ—¶æ‰æ›´æ–°æ–‡æœ¬
                            const nameElement = element.querySelector('.QQ_home_name');
                            if (nameElement && nameElement.textContent.trim() !== groupData.name) {
                                const oldText = nameElement.textContent.trim();
                                nameElement.textContent = groupData.name;
                                console.log(`å…ƒç´ ${index + 1}åç§°æ›´æ–°: "${oldText}" -> "${groupData.name}"`);
                            }
                            
                            // *** é‡è¦ä¿®å¤ï¼šæ›´æ–°å¤´åƒï¼ˆå¦‚æœæœ‰å¤´åƒæ•°æ®ï¼‰ ***
                            const avatarElement = element.querySelector('.QQ_home_head');
                            if (avatarElement && groupData.avatar) {
                                console.log(`æ›´æ–°å…ƒç´ ${index + 1}çš„å¤´åƒ`);
                                try {
                                    // ä¿å­˜åŸæœ‰çš„ç±»åï¼Œé¿å…ç ´åæ ·å¼
                                    const originalClasses = avatarElement.className;
                                    const originalId = avatarElement.id;
                                    
                                    // æ›´æ–°å¤´åƒ
                                    updateAvatarElement(avatarElement, groupData.avatar);
                                    
                                    // ç¡®ä¿åŸæœ‰ç±»åæ²¡æœ‰è¢«ç ´å
                                    if (originalClasses && !avatarElement.className.includes('QQ_home_head')) {
                                        avatarElement.className = originalClasses;
                                    }
                                    if (originalId) {
                                        avatarElement.id = originalId;
                                    }
                                    
                                    console.log(`å…ƒç´ ${index + 1}å¤´åƒæ›´æ–°æˆåŠŸ`);
                                } catch (avatarError) {
                                    console.error(`æ›´æ–°å…ƒç´ ${index + 1}å¤´åƒæ—¶å‡ºé”™:`, avatarError);
                                }
                            } else if (!avatarElement) {
                                console.log(`å…ƒç´ ${index + 1}æ²¡æœ‰æ‰¾åˆ°å¤´åƒå…ƒç´ `);
                            } else if (!groupData.avatar) {
                                console.log(`å…ƒç´ ${index + 1}æ²¡æœ‰å¤´åƒæ•°æ®`);
                            }
                            
                            // ä¿æŠ¤ç°æœ‰æ ¼å¼ï¼Œä¸æ›´æ–°å…¶ä»–DOMç»“æ„
                            
                            successCount++;
                            console.log(`å…ƒç´ ${index + 1}æ›´æ–°æˆåŠŸ`);
                            
                        } catch (elementError) {
                            console.error(`æ›´æ–°å…ƒç´ ${index + 1}æ—¶å‡ºé”™:`, elementError);
                            errorCount++;
                        }
                    });
                    
                    console.log(`*** ä¿æŠ¤æ€§è”ç³»äººæ›´æ–°å®Œæˆ: æˆåŠŸ${successCount}ä¸ª, é”™è¯¯${errorCount}ä¸ª ***`);
                    
                    // 3. éªŒè¯æ›´æ–°ç»“æœ
                    setTimeout(() => {
                        console.log('=== è”ç³»äººæ›´æ–°ç»“æœéªŒè¯ ===');
                        const updatedElements = contactsContainer.querySelectorAll(`[data-name="${groupData.name}"]`);
                        console.log(`éªŒè¯ï¼šç°åœ¨æœ‰ ${updatedElements.length} ä¸ªå…ƒç´ ä½¿ç”¨æ–°åç§°`);
                        
                        updatedElements.forEach((el, i) => {
                            const nameEl = el.querySelector('.QQ_home_name');
                            if (nameEl) {
                                console.log(`éªŒè¯å…ƒç´ ${i + 1}: "${nameEl.textContent.trim()}"`);
                            }
                        });
                    }, 500);
                    
                } catch (error) {
                    console.error('ä¿æŠ¤æ€§è”ç³»äººåˆ—è¡¨æ›´æ–°æ—¶å‡ºé”™:', error);
                }
            }
            
            // [å·²åˆ é™¤] updateChatPageBackground - åŠŸèƒ½å·²ç”±reapplyGroupChatBackgroundæ›¿ä»£
            
            // [å·²åˆ é™¤] ensureContactListFormat - åŠŸèƒ½å·²ç”±protectedContactListUpdateæ›¿ä»£
            
            // [å·²åˆ é™¤] immediateUpdateGroupInAllLists - åŠŸèƒ½å·²ç”±protectedContactListUpdateæ›¿ä»£
            
            /**
             * å®‰å…¨æ›´æ–°ç¾¤èŠå…ƒç´ ï¼ˆä¿æŠ¤åŸæœ‰æ ¼å¼ç‰ˆï¼‰
             */
            function safeUpdateGroupElement(element, groupData) {
                try {
                    if (!element || !groupData) return;
                    
                    console.log('å¼€å§‹å®‰å…¨æ›´æ–°ç¾¤èŠå…ƒç´ :', groupData.name);
                    console.log('å…ƒç´ å½“å‰çŠ¶æ€:', {
                        tagName: element.tagName,
                        className: element.className,
                        dataName: element.getAttribute('data-name'),
                        dataGroupId: element.getAttribute('data-group-id')
                    });
                    
                    // *** å®‰å…¨ç­–ç•¥1ï¼šåªæ›´æ–°æ•°æ®å±æ€§ï¼Œä¸ç ´åDOMç»“æ„ ***
                    element.setAttribute('data-group-id', groupData.id);
                    element.setAttribute('data-name', groupData.name);
                    
                    // *** å®‰å…¨ç­–ç•¥2ï¼šå°å¿ƒæ›´æ–°ç¾¤èŠåç§°ï¼Œä¿æŒåŸæœ‰HTMLç»“æ„ ***
                    const nameElement = element.querySelector('.QQ_home_name');
                    if (nameElement) {
                        const oldName = nameElement.textContent.trim();
                        if (oldName !== groupData.name) {
                            console.log(`å®‰å…¨æ›´æ–°åç§°: "${oldName}" -> "${groupData.name}"`);
                        nameElement.textContent = groupData.name;
                        }
                    } else {
                        console.warn('æœªæ‰¾åˆ°ç¾¤èŠåç§°å…ƒç´ ï¼Œè·³è¿‡åç§°æ›´æ–°');
                    }
                    
                    // *** å®‰å…¨ç­–ç•¥3ï¼šè°¨æ…æ›´æ–°ç¾¤èŠå¤´åƒï¼Œé¿å…ç ´åæ ·å¼ ***
                    const avatarElement = element.querySelector('.QQ_home_head');
                    if (avatarElement && groupData.avatar) {
                        console.log('å®‰å…¨æ›´æ–°ç¾¤èŠå¤´åƒ');
                        
                        // ä¿å­˜åŸæœ‰çš„åŸºç¡€æ ·å¼
                        const originalClasses = avatarElement.className;
                        const originalId = avatarElement.id;
                        
                        try {
                        updateAvatarElement(avatarElement, groupData.avatar);
                            
                            // ç¡®ä¿åŸæœ‰ç±»åå’ŒIDæ²¡æœ‰è¢«ç ´å
                            if (originalClasses && !avatarElement.className.includes('QQ_home_head')) {
                                avatarElement.className = originalClasses;
                            }
                            if (originalId) {
                                avatarElement.id = originalId;
                            }
                            
                        } catch (avatarError) {
                            console.error('æ›´æ–°å¤´åƒæ—¶å‡ºé”™ï¼Œä¿æŒåŸçŠ¶:', avatarError);
                        }
                    }
                    
                    console.log('ç¾¤èŠå…ƒç´ å®‰å…¨æ›´æ–°å®Œæˆ:', groupData.name);
                    
                } catch (error) {
                    console.error('å®‰å…¨æ›´æ–°ç¾¤èŠå…ƒç´ æ—¶å‡ºé”™:', error);
                    // å³ä½¿å‡ºé”™ä¹Ÿè¦ç¡®ä¿åŸºæœ¬æ•°æ®å±æ€§æ­£ç¡®
                    try {
                        element.setAttribute('data-group-id', groupData.id);
                        element.setAttribute('data-name', groupData.name);
                        console.log('å·²è®¾ç½®åŸºæœ¬æ•°æ®å±æ€§ä½œä¸ºå¤‡ç”¨');
                    } catch (backupError) {
                        console.error('è®¾ç½®å¤‡ç”¨æ•°æ®å±æ€§ä¹Ÿå¤±è´¥:', backupError);
                    }
                }
            }
            
            // [å·²åˆ é™¤] immediateUpdateGroupElement - å·²æ•´åˆåˆ°safeUpdateGroupElement
            
            /**
             * æ›´æ–°å¤´åƒå…ƒç´ çš„é€šç”¨å‡½æ•°
             */
            function updateAvatarElement(avatarElement, avatarData) {
                if (!avatarElement) {
                    console.warn('updateAvatarElement: å¤´åƒå…ƒç´ ä¸å­˜åœ¨');
                    return;
                }
                
                if (!avatarData) {
                    console.warn('updateAvatarElement: å¤´åƒæ•°æ®ä¸å­˜åœ¨ï¼Œä¿æŒç°æœ‰å¤´åƒ');
                    return;
                }
                
                console.log('æ›´æ–°å¤´åƒå…ƒç´ :', avatarData);
                
                if (avatarData.type === 'preset') {
                    // é¢„è®¾å¤´åƒ
                    avatarElement.style.background = `linear-gradient(135deg, ${avatarData.gradient.start}, ${avatarData.gradient.end})`;
                    avatarElement.style.backgroundImage = 'none';
                    avatarElement.style.color = 'white';
                    avatarElement.style.display = 'flex';
                    avatarElement.style.alignItems = 'center';
                    avatarElement.style.justifyContent = 'center';
                    avatarElement.style.fontWeight = 'bold';
                    avatarElement.textContent = avatarData.text || 'ç¾¤';
                } else if (avatarData.type === 'upload' && avatarData.imageData) {
                    // ä¸Šä¼ çš„å¤´åƒ
                    avatarElement.style.background = 'none';
                    avatarElement.style.backgroundImage = `url('${avatarData.imageData}')`;
                    avatarElement.style.backgroundSize = 'cover';
                    avatarElement.style.backgroundPosition = 'center';
                    avatarElement.style.backgroundRepeat = 'no-repeat';
                    avatarElement.textContent = '';
                } else if (typeof avatarData === 'string' && avatarData.startsWith('data:')) {
                    // ç›´æ¥çš„base64å­—ç¬¦ä¸²
                    avatarElement.style.background = 'none';
                    avatarElement.style.backgroundImage = `url('${avatarData}')`;
                    avatarElement.style.backgroundSize = 'cover';
                    avatarElement.style.backgroundPosition = 'center';
                    avatarElement.style.backgroundRepeat = 'no-repeat';
                    avatarElement.textContent = '';
                } else if (typeof avatarData === 'string' && (avatarData.startsWith('http://') || avatarData.startsWith('https://'))) {
                    // ç½‘ç»œå›¾ç‰‡URL
                    avatarElement.style.background = 'none';
                    avatarElement.style.backgroundImage = `url('${avatarData}')`;
                    avatarElement.style.backgroundSize = 'cover';
                    avatarElement.style.backgroundPosition = 'center';
                    avatarElement.style.backgroundRepeat = 'no-repeat';
                    avatarElement.textContent = '';
                } else {
                    // é»˜è®¤å¤´åƒ
                    avatarElement.style.background = 'linear-gradient(135deg, #199AFF, #0066CC)';
                    avatarElement.style.backgroundImage = 'none';
                    avatarElement.style.color = 'white';
                    avatarElement.style.display = 'flex';
                    avatarElement.style.alignItems = 'center';
                    avatarElement.style.justifyContent = 'center';
                    avatarElement.style.fontWeight = 'bold';
                    avatarElement.textContent = 'ç¾¤';
                }
            }
            

            
            /**
             * ä¿å­˜ç¾¤èŠåˆ°ä¸–ç•Œä¹¦çš„é€šç”¨å‡½æ•°ï¼ˆä¿®å¤ç‰ˆï¼‰
             */
            async function saveGroupToWorldbook(groupData) {
                console.log('ä¿å­˜ç¾¤èŠåˆ°ä¸–ç•Œä¹¦:', groupData);
                
                try {
                    // ä½¿ç”¨ä¸åŠ¨æ€å†…å®¹å­˜å‚¨ç›¸åŒçš„ç®€å•æ£€æŸ¥
                    if (!worldbook || !entries) {
                        console.warn('ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨ï¼Œæ— æ³•ä¿å­˜ç¾¤èŠåˆ°ä¸–ç•Œä¹¦');
                            return false;
                    }
                    
                    // æŸ¥æ‰¾ç°æœ‰çš„ç¾¤èŠæ¡ç›® - ä½¿ç”¨å”¯ä¸€commentæŸ¥æ‰¾
                    const uniqueComment = `æ‰‹æœº-ç¾¤èŠ-${groupData.name}`;
                    let groupEntry = entries.find(e => 
                        e.comment === uniqueComment
                    );
                    
                    // å¤„ç†å¤´åƒå¼•ç”¨
                    let avatarReference = 'http://sharkpan.xyz/f/z0WU5/mmexport1736971020657.gif';
                    if (groupData.avatar) {
                        if (groupData.avatar.type === 'upload' && groupData.avatar.imageData) {
                            avatarReference = groupData.avatar.imageData;
                        } else if (groupData.avatar.type === 'preset') {
                            avatarReference = `é¢„è®¾:${groupData.avatar.text || 'ç¾¤'}`;
                        } else if (groupData.avatar.type === 'url' && groupData.avatar.url) {
                            avatarReference = groupData.avatar.url;
                        }
                    } else if (groupData.avatarUrl) {
                        avatarReference = groupData.avatarUrl;
                    }
                    
                    // æ„å»ºç¾¤èŠå†…å®¹
                    const groupContent = `[${groupData.name}]
ç±»å‹=ç¾¤èŠ
æˆå‘˜=${groupData.members.join(',')}
å¤´åƒ=${avatarReference}`;
                    
                    if (groupEntry) {
                        // æ›´æ–°ç°æœ‰æ¡ç›®
                        console.log('æ›´æ–°ç°æœ‰ç¾¤èŠæ¡ç›®:', groupEntry.uid);
                        await setLorebookEntries(worldbook, [
                            {
                                uid: groupEntry.uid,
                                content: groupContent,
                            }
                        ]);
                        console.log('ç¾¤èŠå·²ä¿å­˜åˆ°ä¸–ç•Œä¹¦');
                    } else {
                        console.error('æœªæ‰¾åˆ°ç¾¤èŠæ¡ç›®ï¼Œæ— æ³•ä¿å­˜');
                        return false;
                    }
                    
                    return true;
                } catch (error) {
                    console.error('ä¿å­˜ç¾¤èŠåˆ°ä¸–ç•Œä¹¦å¤±è´¥:', error);
                    throw error;
                }
            }
            
            /**
             * ä»æ‰€æœ‰åˆ—è¡¨ä¸­ç§»é™¤ç¾¤èŠ
             */
            function removeGroupFromAllLists(groupId) {
                // ä»è”ç³»äººåˆ—è¡¨ç§»é™¤
                const contactsContainer = document.getElementById('QQ_home_chars');
                if (contactsContainer) {
                    const existingGroup = contactsContainer.querySelector(`[data-group-id="${groupId}"]`);
                    if (existingGroup) {
                        existingGroup.remove();
                    }
                }
                
                // ä»æ¶ˆæ¯åˆ—è¡¨ç§»é™¤
                const messagesContainer = document.getElementById('QQ_message_list_chars');
                if (messagesContainer) {
                    const existingGroup = messagesContainer.querySelector(`[data-group-id="${groupId}"]`);
                    if (existingGroup) {
                        existingGroup.remove();
                    }
                }
            }
            
            /**
             * å¼ºåˆ¶åˆ é™¤ç¾¤èŠç•Œé¢å…ƒç´ ï¼ˆå¢å¼ºç‰ˆåˆ é™¤ï¼Œç¡®ä¿å®Œå…¨æ¸…é™¤ï¼‰
             */
            function forceRemoveGroupFromInterface(groupId, groupName) {
                console.log('å¼ºåˆ¶åˆ é™¤ç¾¤èŠç•Œé¢å…ƒç´ :', groupId, groupName);
                
                // æ–¹æ³•1ï¼šé€šè¿‡data-group-idåˆ é™¤
                const elementsById = document.querySelectorAll(`[data-group-id="${groupId}"]`);
                elementsById.forEach((element, index) => {
                    console.log(`é€šè¿‡IDåˆ é™¤å…ƒç´  ${index + 1}:`, element);
                    element.remove();
                });
                
                // æ–¹æ³•2ï¼šé€šè¿‡ç¾¤èŠåç§°åˆ é™¤
                const contactsContainer = document.getElementById('QQ_home_chars');
                if (contactsContainer) {
                    const groupElements = contactsContainer.querySelectorAll('.QQ_home_char[data-group-type="true"]');
                    groupElements.forEach(element => {
                        const nameElement = element.querySelector('.QQ_home_name');
                        if (nameElement && nameElement.textContent.trim() === groupName) {
                            console.log('é€šè¿‡åç§°åˆ é™¤è”ç³»äººåˆ—è¡¨ä¸­çš„ç¾¤èŠ:', groupName);
                            element.remove();
                        }
                    });
                }
                
                // æ–¹æ³•3ï¼šé€šè¿‡ç¾¤èŠåç§°åˆ é™¤æ¶ˆæ¯åˆ—è¡¨ä¸­çš„ç¾¤èŠ
                const messagesContainer = document.getElementById('QQ_message_list_chars');
                if (messagesContainer) {
                    const groupElements = messagesContainer.querySelectorAll('.QQ_home_char[data-group-type="true"]');
                    groupElements.forEach(element => {
                        const nameElement = element.querySelector('.QQ_home_name');
                        if (nameElement && nameElement.textContent.trim() === groupName) {
                            console.log('é€šè¿‡åç§°åˆ é™¤æ¶ˆæ¯åˆ—è¡¨ä¸­çš„ç¾¤èŠ:', groupName);
                            element.remove();
                        }
                    });
                }
                
                // æ–¹æ³•4ï¼šåˆ é™¤å¯¹åº”çš„èŠå¤©é¡µé¢
                const chatPages = document.querySelectorAll(`.QQ_chat_page[data-name='${groupName}']`);
                chatPages.forEach((page, index) => {
                    console.log(`åˆ é™¤èŠå¤©é¡µé¢ ${index + 1}:`, groupName);
                    page.remove();
                });
                
                // æ–¹æ³•5ï¼šåˆ é™¤ç¾¤èŠä¸“ç”¨é¡µé¢
                const groupChatPages = document.querySelectorAll(`.group-chat-page[data-group-id="${groupId}"]`);
                groupChatPages.forEach((page, index) => {
                    console.log(`åˆ é™¤ç¾¤èŠä¸“ç”¨é¡µé¢ ${index + 1}:`, groupId);
                    page.remove();
                });
                
                console.log('å¼ºåˆ¶åˆ é™¤ç¾¤èŠç•Œé¢å…ƒç´ å®Œæˆ');
            }
            
            /**
             * å®‰å…¨åˆ é™¤ç¾¤èŠç•Œé¢å…ƒç´ ï¼ˆé¿å…è¿‡åº¦åˆ é™¤å¯¼è‡´ç©ºç™½é¡µé¢ï¼‰
             */
            function safeRemoveGroupFromInterface(groupId, groupName) {
                console.log('å®‰å…¨åˆ é™¤ç¾¤èŠç•Œé¢å…ƒç´ :', groupId, groupName);
                
                // åªåˆ é™¤ç‰¹å®šçš„ç¾¤èŠå…ƒç´ ï¼Œä¿æŠ¤ä¸»è¦çš„ç•Œé¢ç»“æ„
                try {
                    // åˆ é™¤è”ç³»äººåˆ—è¡¨ä¸­çš„ç¾¤èŠ
                    const contactsContainer = document.getElementById('QQ_home_chars');
                    if (contactsContainer) {
                        const groupElements = contactsContainer.querySelectorAll('.QQ_home_char[data-group-type="true"]');
                        groupElements.forEach(element => {
                            const nameElement = element.querySelector('.QQ_home_name');
                            if (nameElement && nameElement.textContent.trim() === groupName) {
                                console.log('å®‰å…¨åˆ é™¤è”ç³»äººåˆ—è¡¨ä¸­çš„ç¾¤èŠ:', groupName);
                                element.remove();
                            }
                        });
                    }
                    
                    // åˆ é™¤æ¶ˆæ¯åˆ—è¡¨ä¸­çš„ç¾¤èŠ
                    const messagesContainer = document.getElementById('QQ_message_list_chars');
                    if (messagesContainer) {
                        const groupElements = messagesContainer.querySelectorAll('.QQ_home_char[data-group-type="true"]');
                        groupElements.forEach(element => {
                            const nameElement = element.querySelector('.QQ_home_name');
                            if (nameElement && nameElement.textContent.trim() === groupName) {
                                console.log('å®‰å…¨åˆ é™¤æ¶ˆæ¯åˆ—è¡¨ä¸­çš„ç¾¤èŠ:', groupName);
                                element.remove();
                            }
                        });
                    }
                    
                    // åªåˆ é™¤å½“å‰ç¾¤èŠçš„ä¸“ç”¨é¡µé¢
                    const groupChatPages = document.querySelectorAll(`.group-chat-page[data-group-id="${groupId}"]`);
                    groupChatPages.forEach((page, index) => {
                        console.log(`å®‰å…¨åˆ é™¤ç¾¤èŠä¸“ç”¨é¡µé¢ ${index + 1}:`, groupId);
                        page.remove();
                    });
                    
                    console.log('å®‰å…¨åˆ é™¤ç¾¤èŠç•Œé¢å…ƒç´ å®Œæˆ');
                    
                } catch (error) {
                    console.error('å®‰å…¨åˆ é™¤ç¾¤èŠç•Œé¢å…ƒç´ æ—¶å‡ºé”™:', error);
                }
            }
            
            /**
             * è°ƒè¯•å‡½æ•°ï¼šæµ‹è¯•ç¾¤èŠåç§°ç‚¹å‡»
             */

            

            
            /**
             * æ˜¾ç¤ºæ·»åŠ æˆå‘˜æ¨¡æ€çª—å£
             */
            function showAddMemberModal() {
                if (!currentManagingGroup) {
                    console.error('æ²¡æœ‰å½“å‰ç®¡ç†çš„ç¾¤èŠ');
                    return;
                }
                
                console.log('æ˜¾ç¤ºæ·»åŠ æˆå‘˜æ¨¡æ€çª—å£');
                
                const modal = document.getElementById('add_member_modal');
                if (!modal) {
                    console.error('æœªæ‰¾åˆ°æ·»åŠ æˆå‘˜æ¨¡æ€çª—å£');
                    return;
                }
                
                // æ¸…ç©ºæœç´¢æ¡†
                const searchInput = document.getElementById('add_member_search_input');
                if (searchInput) {
                    searchInput.value = '';
                }
                
                // é‡ç½®é€‰ä¸­çŠ¶æ€
                window.selectedMembersToAdd = [];
                updateAddMemberConfirmButton();
                
                // åŠ è½½è”ç³»äººåˆ—è¡¨
                loadContactsForAddMember();
                
                // æ˜¾ç¤ºæ¨¡æ€çª—å£
                modal.style.display = 'flex';
            }
            
            /**
             * å…³é—­æ·»åŠ æˆå‘˜æ¨¡æ€çª—å£
             */
            function closeAddMemberModal() {
                const modal = document.getElementById('add_member_modal');
                if (modal) {
                    modal.style.display = 'none';
                }
                
                // æ¸…ç©ºé€‰ä¸­çŠ¶æ€
                window.selectedMembersToAdd = [];
            }
            
            /**
             * åŠ è½½è”ç³»äººåˆ—è¡¨ç”¨äºæ·»åŠ æˆå‘˜
             */
            function loadContactsForAddMember() {
                const contactList = document.getElementById('add_member_contact_list');
                if (!contactList) {
                    console.error('æ·»åŠ æˆå‘˜è”ç³»äººåˆ—è¡¨å®¹å™¨æœªæ‰¾åˆ°');
                    return;
                }
                
                contactList.innerHTML = '';
                
                // è·å–æ‰€æœ‰è”ç³»äºº
                const contactsContainer = document.getElementById('QQ_home_chars');
                if (!contactsContainer) {
                    console.error('è”ç³»äººå®¹å™¨æœªæ‰¾åˆ°');
                    return;
                }
                
                // *** ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„é€‰æ‹©å™¨ .QQ_home_usermsgï¼Œä¸è”ç³»äººç•Œé¢æœç´¢ä¿æŒä¸€è‡´ ***
                const contactElements = contactsContainer.querySelectorAll('.QQ_home_usermsg');
                const currentMembers = new Set(currentManagingGroup.members);
                
                console.log(`æ‰¾åˆ° ${contactElements.length} ä¸ªè”ç³»äººï¼Œå½“å‰ç¾¤èŠæˆå‘˜:`, currentMembers);
                
                let addedCount = 0;
                contactElements.forEach(element => {
                    // è·³è¿‡ç¾¤èŠç±»å‹çš„è”ç³»äººï¼Œåªå¤„ç†ä¸ªäººè”ç³»äºº
                    if (element.hasAttribute('data-group-type')) {
                        return;
                    }
                    
                    const nameElement = element.querySelector('.QQ_home_name');
                    if (!nameElement) return;
                    
                    const contactName = nameElement.textContent.trim();
                    
                    // è·³è¿‡å·²ç»åœ¨ç¾¤èŠä¸­çš„æˆå‘˜
                    if (currentMembers.has(contactName)) {
                        console.log(`è·³è¿‡å·²å­˜åœ¨æˆå‘˜: ${contactName}`);
                        return;
                    }
                    
                    const contactItem = document.createElement('div');
                    contactItem.className = 'add-member-contact-item';
                    contactItem.setAttribute('data-contact-name', contactName);
                    
                    const contactAvatar = document.createElement('div');
                    contactAvatar.className = 'add-member-contact-avatar';
                    
                    // *** ä¿®å¤ï¼šä¼˜å…ˆä»ä¸–ç•Œä¹¦è·å–å¤´åƒï¼Œç¡®ä¿æ˜¾ç¤ºæ­£ç¡®çš„è§’è‰²å¤´åƒ ***
                    console.log(`ä¸ºè”ç³»äºº ${contactName} è·å–å¤´åƒ`);
                    
                    // é¦–å…ˆå°è¯•ä»ä¸–ç•Œä¹¦è·å–å¤´åƒ
                    const worldbookAvatar = getCharacterAvatarFromWorldbook(contactName);
                    if (worldbookAvatar) {
                        console.log(`ä»ä¸–ç•Œä¹¦è·å–åˆ° ${contactName} çš„å¤´åƒ:`, worldbookAvatar);
                        
                        // åº”ç”¨ä¸–ç•Œä¹¦ä¸­çš„å¤´åƒ
                        contactAvatar.style.backgroundImage = worldbookAvatar.backgroundImage;
                        contactAvatar.style.backgroundSize = 'cover';
                        contactAvatar.style.backgroundPosition = 'center';
                        contactAvatar.style.backgroundRepeat = 'no-repeat';
                        contactAvatar.style.borderRadius = '50%';
                        contactAvatar.style.width = '40px';
                        contactAvatar.style.height = '40px';
                        contactAvatar.style.marginRight = '12px';
                        contactAvatar.style.flexShrink = '0';
                        contactAvatar.textContent = '';
                    } else {
                        // å¤‡é€‰æ–¹æ¡ˆï¼šä»è”ç³»äººåˆ—è¡¨å¤åˆ¶å¤´åƒ
                        const avatarElement = element.querySelector('.QQ_home_head');
                        if (avatarElement) {
                            console.log(`ä»è”ç³»äººåˆ—è¡¨å¤åˆ¶ ${contactName} çš„å¤´åƒ`);
                            
                            // ç›´æ¥å¤åˆ¶åŸå§‹å¤´åƒçš„æ‰€æœ‰æ ·å¼å’Œå†…å®¹
                            contactAvatar.style.cssText = avatarElement.style.cssText;
                            contactAvatar.style.width = '40px';
                            contactAvatar.style.height = '40px';
                            contactAvatar.style.marginRight = '12px';
                            contactAvatar.style.flexShrink = '0';
                            contactAvatar.textContent = avatarElement.textContent;
                            
                            // ç¡®ä¿èƒŒæ™¯å›¾åƒå’ŒèƒŒæ™¯æ ·å¼éƒ½å¤åˆ¶è¿‡æ¥
                            const computedStyle = window.getComputedStyle(avatarElement);
                            if (computedStyle.backgroundImage && computedStyle.backgroundImage !== 'none') {
                                contactAvatar.style.backgroundImage = computedStyle.backgroundImage;
                            }
                            if (computedStyle.backgroundColor && computedStyle.backgroundColor !== 'rgba(0, 0, 0, 0)') {
                                contactAvatar.style.backgroundColor = computedStyle.backgroundColor;
                            }
                        } else {
                            // æœ€åçš„å¤‡é€‰æ–¹æ¡ˆï¼šä½¿ç”¨é»˜è®¤å¤´åƒ
                            console.log(`ä¸º ${contactName} ä½¿ç”¨é»˜è®¤å¤´åƒ`);
                            contactAvatar.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                            contactAvatar.style.backgroundImage = '';
                            contactAvatar.style.color = 'white';
                            contactAvatar.style.display = 'flex';
                            contactAvatar.style.alignItems = 'center';
                            contactAvatar.style.justifyContent = 'center';
                            contactAvatar.style.fontWeight = 'bold';
                            contactAvatar.style.borderRadius = '50%';
                            contactAvatar.style.width = '40px';
                            contactAvatar.style.height = '40px';
                            contactAvatar.style.marginRight = '12px';
                            contactAvatar.style.flexShrink = '0';
                            contactAvatar.textContent = contactName.charAt(0);
                        }
                    }
                    
                    const contactNameDiv = document.createElement('div');
                    contactNameDiv.className = 'add-member-contact-name';
                    contactNameDiv.textContent = contactName;
                    
                    const contactStatus = document.createElement('div');
                    contactStatus.className = 'add-member-contact-status';
                    contactStatus.textContent = 'ç‚¹å‡»æ·»åŠ ';
                    
                    contactItem.appendChild(contactAvatar);
                    contactItem.appendChild(contactNameDiv);
                    contactItem.appendChild(contactStatus);
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    contactItem.addEventListener('click', function() {
                        toggleMemberSelection(contactName, contactItem);
                    });
                    
                    contactList.appendChild(contactItem);
                    addedCount++;
                });
                
                console.log(`å·²åŠ è½½ ${addedCount} ä¸ªå¯æ·»åŠ çš„è”ç³»äºº`);
                
                // å¦‚æœæ²¡æœ‰å¯æ·»åŠ çš„è”ç³»äººï¼Œæ˜¾ç¤ºæç¤º
                if (addedCount === 0) {
                    const noContactDiv = document.createElement('div');
                    noContactDiv.style.cssText = 'text-align: center; color: #999; padding: 20px; font-size: 14px;';
                    noContactDiv.textContent = 'æš‚æ— å¯æ·»åŠ çš„è”ç³»äºº';
                    contactList.appendChild(noContactDiv);
                }
            }
            
            /**
             * åˆ‡æ¢æˆå‘˜é€‰ä¸­çŠ¶æ€
             */
            function toggleMemberSelection(contactName, contactItem) {
                if (!window.selectedMembersToAdd) {
                    window.selectedMembersToAdd = [];
                }
                
                const index = window.selectedMembersToAdd.indexOf(contactName);
                const statusElement = contactItem.querySelector('.add-member-contact-status');
                
                if (index > -1) {
                    // å–æ¶ˆé€‰ä¸­
                    window.selectedMembersToAdd.splice(index, 1);
                    contactItem.classList.remove('selected');
                    statusElement.textContent = 'ç‚¹å‡»æ·»åŠ ';
                } else {
                    // é€‰ä¸­
                    window.selectedMembersToAdd.push(contactName);
                    contactItem.classList.add('selected');
                    statusElement.textContent = 'å·²é€‰ä¸­';
                }
                
                updateAddMemberConfirmButton();
            }
            
            /**
             * æ›´æ–°æ·»åŠ æˆå‘˜ç¡®è®¤æŒ‰é’®çŠ¶æ€
             */
            function updateAddMemberConfirmButton() {
                const confirmBtn = document.getElementById('add_member_confirm_btn');
                if (!confirmBtn) return;
                
                const selectedCount = window.selectedMembersToAdd ? window.selectedMembersToAdd.length : 0;
                
                if (selectedCount > 0) {
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = `æ·»åŠ æˆå‘˜ (${selectedCount})`;
                } else {
                    confirmBtn.disabled = true;
                    confirmBtn.textContent = 'æ·»åŠ æˆå‘˜';
                }
            }
            
            /**
             * è¿‡æ»¤æ·»åŠ æˆå‘˜è”ç³»äººåˆ—è¡¨ï¼ˆå‚è€ƒè”ç³»äººç•Œé¢æœç´¢é€»è¾‘ï¼‰
             */
            function filterAddMemberContacts() {
                const searchInput = document.getElementById('add_member_search_input');
                const contactList = document.getElementById('add_member_contact_list');
                
                if (!searchInput || !contactList) {
                    console.log('æœç´¢è¾“å…¥æ¡†æˆ–è”ç³»äººåˆ—è¡¨æœªæ‰¾åˆ°');
                    return;
                }
                
                const searchTerm = searchInput.value.trim();
                const search = searchTerm.toLowerCase();
                const isEmpty = search === '';
                const contactItems = contactList.querySelectorAll('.add-member-contact-item');
                
                console.log(`=== æ·»åŠ æˆå‘˜æœç´¢è°ƒè¯• ===`);
                console.log(`æœç´¢è¯: "${searchTerm}"`);
                console.log(`è”ç³»äººæ€»æ•°: ${contactItems.length}`);
                
                let visibleCount = 0;
                
                // ç§»é™¤ä¹‹å‰çš„æ— ç»“æœæç¤º
                const existingNoResult = contactList.querySelector('.no-search-result');
                if (existingNoResult) {
                    existingNoResult.remove();
                }
                
                contactItems.forEach((item, index) => {
                    const nameElement = item.querySelector('.add-member-contact-name');
                    if (!nameElement) {
                        console.warn("è”ç³»äººé¡¹ç›®ç¼ºå°‘å§“åå…ƒç´ ", item);
                        item.style.display = 'none';
                        return;
                    }
                    
                    // è·å–åŸå§‹æ–‡æœ¬å†…å®¹ï¼ˆå‚è€ƒè”ç³»äººæœç´¢é€»è¾‘ï¼‰
                    const originalName = nameElement.getAttribute('data-original-text') || nameElement.textContent;
                    const name = originalName.toLowerCase();
                    
                    // æ£€æŸ¥æ˜¯å¦åŒ¹é…æœç´¢æ¡ä»¶
                    const nameMatches = isEmpty || name.includes(search);
                    const isMatch = nameMatches;
                    
                    if (isMatch) {
                        // æ˜¾ç¤ºè”ç³»äºº
                        item.style.display = 'flex';
                        visibleCount++;
                        
                        // å¤„ç†é«˜äº®æ˜¾ç¤ºï¼ˆå‚è€ƒè”ç³»äººæœç´¢çš„é«˜äº®é€»è¾‘ï¼‰
                        if (!isEmpty && nameMatches) {
                            highlightAddMemberSearchTerm(nameElement, searchTerm, originalName);
                        } else {
                            // æ¢å¤åŸå§‹æ–‡æœ¬ï¼Œç§»é™¤é«˜äº®
                            if (nameElement.getAttribute('data-original-text')) {
                                nameElement.innerHTML = originalName;
                            }
                        }
                    } else {
                        // éšè—ä¸åŒ¹é…çš„è”ç³»äºº
                        item.style.display = 'none';
                    }
                });
                
                console.log(`æœç´¢"${searchTerm}": æ‰¾åˆ° ${visibleCount} ä¸ªè”ç³»äºº`);
                
                // å¦‚æœæœç´¢æœ‰å†…å®¹ä½†æ— ç»“æœï¼Œæ˜¾ç¤ºæç¤º
                if (!isEmpty && visibleCount === 0) {
                    const noResultDiv = document.createElement('div');
                    noResultDiv.className = 'no-search-result';
                    noResultDiv.style.cssText = 'text-align: center; color: #999; padding: 20px; font-size: 14px; border: 1px dashed #ddd; border-radius: 8px; margin: 10px 0;';
                    noResultDiv.innerHTML = `
                        <div style="font-size: 16px; margin-bottom: 8px;">ğŸ”</div>
                        <div>æœªæ‰¾åˆ°åŒ…å« "<strong>${searchTerm}</strong>" çš„è”ç³»äºº</div>
                        <div style="font-size: 12px; color: #666; margin-top: 4px;">è¯·å°è¯•è¾“å…¥å…¶ä»–å…³é”®è¯</div>
                    `;
                    contactList.appendChild(noResultDiv);
                    console.log("æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è”ç³»äºº");
                }
            }
            
            /**
             * æ·»åŠ æˆå‘˜æœç´¢é«˜äº®åŠŸèƒ½ï¼ˆå‚è€ƒè”ç³»äººæœç´¢é«˜äº®é€»è¾‘ï¼‰
             */
            function highlightAddMemberSearchTerm(element, searchTerm, originalText) {
                if (!searchTerm || searchTerm.trim() === '') {
                    element.innerHTML = originalText;
                    return;
                }
                
                // ä¿å­˜åŸå§‹æ–‡æœ¬
                if (!element.getAttribute('data-original-text')) {
                    element.setAttribute('data-original-text', originalText);
                }
                
                // åˆ›å»ºé«˜äº®HTML
                const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                const highlightedText = originalText.replace(regex, '<span style="background-color: #FFE066; color: #333; font-weight: bold; padding: 1px 2px; border-radius: 2px;">$1</span>');
                
                element.innerHTML = highlightedText;
            }
            
            /**
             * ç¡®è®¤æ·»åŠ æˆå‘˜
             */
            async function confirmAddMembers() {
                if (!currentManagingGroup || !window.selectedMembersToAdd || window.selectedMembersToAdd.length === 0) {
                    return;
                }
                
                console.log('æ·»åŠ æˆå‘˜åˆ°ç¾¤èŠ:', window.selectedMembersToAdd);
                
                // è®°å½•è¦æ·»åŠ çš„æ–°æˆå‘˜ï¼ˆç”¨äºç³»ç»Ÿæ¶ˆæ¯ï¼‰
                const newMembers = [];
                
                // å°†é€‰ä¸­çš„æˆå‘˜æ·»åŠ åˆ°ç¾¤èŠ
                window.selectedMembersToAdd.forEach(memberName => {
                    if (!currentManagingGroup.members.includes(memberName)) {
                        currentManagingGroup.members.push(memberName);
                        newMembers.push(memberName);
                    }
                });
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                saveGroupToStorage(currentManagingGroup);
                
                // *** æ–°å¢ï¼šæ›´æ–°åˆ°ä¸–ç•Œä¹¦ ***
                await updateGroupMembersInWorldbook(currentManagingGroup.name, currentManagingGroup.members);
                
                // *** ç«‹å³æ›´æ–°å½“å‰èŠå¤©ç•Œé¢ï¼ˆå¦‚æœæ­£åœ¨ç¾¤èŠä¸­ï¼‰ ***
                if (window.currentGroupChat && window.currentGroupChat.id === currentManagingGroup.id) {
                    console.log('ç«‹å³æ›´æ–°å½“å‰ç¾¤èŠç•Œé¢ï¼ˆæ·»åŠ æˆå‘˜åï¼‰');
                    
                    // æ›´æ–°å½“å‰ç¾¤èŠå¯¹è±¡
                    window.currentGroupChat.members = currentManagingGroup.members;
                    
                    // ç«‹å³æ›´æ–°èŠå¤©ç•Œé¢å¤´éƒ¨æ˜¾ç¤ºï¼ˆåŒ…æ‹¬äººæ•°ï¼‰
                    updateChatHeader(currentManagingGroup);
                    
                    console.log('ç¾¤èŠç•Œé¢å¤´éƒ¨å·²ç«‹å³æ›´æ–°ï¼Œäººæ•°:', currentManagingGroup.members.length);
                }
                
                // *** ä¿®å¤ï¼šä¸ºæ¯ä¸ªæ–°æˆå‘˜æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯å¹¶ç«‹å³æ˜¾ç¤º ***
                if (newMembers.length > 0) {
                    console.log('æ·»åŠ æˆå‘˜ç³»ç»Ÿæ¶ˆæ¯:', newMembers);
                    
                    for (const memberName of newMembers) {
                        const systemMessage = `ç¾¤ä¸»é‚€è¯·${memberName}åŠ å…¥ç¾¤èŠ`;
                        
                        // *** ä¿®å¤ï¼šæ€»æ˜¯ä¿å­˜ç³»ç»Ÿæ¶ˆæ¯ï¼Œä¸ä¾èµ–ç•Œé¢çŠ¶æ€æ£€æŸ¥ ***
                        console.log('ä¿å­˜æ·»åŠ æˆå‘˜ç³»ç»Ÿæ¶ˆæ¯:', systemMessage);
                        await addSystemMessageToGroup(currentManagingGroup.id, systemMessage);
                        
                        // *** ä¿®å¤ï¼šå¼ºåˆ¶ç«‹å³æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯ ***
                        console.log('å¼ºåˆ¶ç«‹å³æ˜¾ç¤ºæ·»åŠ æˆå‘˜ç³»ç»Ÿæ¶ˆæ¯:', systemMessage);
                        displaySystemMessage(systemMessage, currentManagingGroup.id);
                    }
                }
                
                        // *** ç«‹å³æ›´æ–°æ‰€æœ‰ç•Œé¢ä¸­çš„ç¾¤èŠæ˜¾ç¤º ***
        console.log('ç«‹å³æ›´æ–°è”ç³»äººåˆ—è¡¨ä¸­çš„ç¾¤èŠæ˜¾ç¤ºï¼ˆæ·»åŠ æˆå‘˜åï¼‰...');
        
        // *** å…³é”®ä¿®å¤ï¼šç¡®ä¿ä¼ é€’å®Œæ•´çš„ç¾¤èŠæ•°æ®ï¼ŒåŒ…æ‹¬å¤´åƒä¿¡æ¯ ***
        console.log('ä¼ é€’ç»™protectedContactListUpdateçš„æ•°æ®:', {
            name: currentManagingGroup.name,
            id: currentManagingGroup.id,
            avatar: currentManagingGroup.avatar,
            members: currentManagingGroup.members
        });
        await protectedContactListUpdate(currentManagingGroup, 'add_member');
        
        // *** è½»é‡çº§ç•Œé¢æ›´æ–°ï¼Œé¿å…æ¶ˆæ¯ä¸¢å¤± ***
        console.log('æ‰§è¡Œè½»é‡çº§ç•Œé¢æ›´æ–°ï¼ˆæ·»åŠ æˆå‘˜åï¼‰...');
        await refreshGroupChatsDisplay();
                
                console.log(`å·²æ·»åŠ  ${newMembers.length} ä¸ªæ–°æˆå‘˜åˆ°ç¾¤èŠ`);
                alert(`å·²æ·»åŠ  ${newMembers.length} ä¸ªæˆå‘˜åˆ°ç¾¤èŠ`);
                
                // å…³é—­æ¨¡æ€çª—å£
                closeAddMemberModal();
                
                // åˆ·æ–°ç¾¤èŠè®¾ç½®ç•Œé¢
                showGroupSettings();
            }

            /**
             * æ¸…ç†localStorageä¸­çš„è¿‡æœŸå¤´åƒæ•°æ®
             */
            function cleanupAvatarData() {
                try {
                    // è·å–æ‰€æœ‰localStorageä¸­çš„å¤´åƒæ•°æ®
                    const avatarKeys = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('avatarData_')) {
                            avatarKeys.push(key);
                        }
                    }
                    
                    console.log('æ‰¾åˆ°å¤´åƒæ•°æ®:', avatarKeys.length, 'ä¸ª');
                    
                    // è·å–ä¸–ç•Œä¹¦ä¸­æ­£åœ¨ä½¿ç”¨çš„å¤´åƒID
                    const usedAvatarIds = new Set();
                    if (entries && worldbook) {
                        const entry = entries.find(e => e.key === "æ‰‹æœº-è§’è‰²");
                        if (entry && entry.content) {
                            const lines = entry.content.split('\n');
                            lines.forEach(line => {
                                if (line.startsWith('å¤´åƒ=avatar_')) {
                                    const avatarId = line.substring(3);
                                    usedAvatarIds.add('avatarData_' + avatarId);
                                }
                            });
                        }
                    } else {
                        console.log('cleanupAvatarData: entriesæˆ–worldbookæœªåˆå§‹åŒ–ï¼Œè·³è¿‡ä¸–ç•Œä¹¦æ£€æŸ¥');
                    }
                    
                    console.log('æ­£åœ¨ä½¿ç”¨çš„å¤´åƒID:', usedAvatarIds.size, 'ä¸ª');
                    
                    // åˆ é™¤æœªä½¿ç”¨çš„å¤´åƒæ•°æ®
                    let deletedCount = 0;
                    avatarKeys.forEach(key => {
                        if (!usedAvatarIds.has(key)) {
                            localStorage.removeItem(key);
                            deletedCount++;
                            console.log('åˆ é™¤æœªä½¿ç”¨çš„å¤´åƒæ•°æ®:', key);
                        }
                    });
                    
                    console.log('æ¸…ç†å®Œæˆï¼Œåˆ é™¤äº†', deletedCount, 'ä¸ªæœªä½¿ç”¨çš„å¤´åƒæ•°æ®');
                } catch (error) {
                    console.error('æ¸…ç†å¤´åƒæ•°æ®å¤±è´¥:', error);
                }
            }
            
            /**
             * è·å–localStorageä½¿ç”¨æƒ…å†µ
             */
            function getStorageUsage() {
                try {
                    let totalSize = 0;
                    let avatarSize = 0;
                    let avatarCount = 0;
                    
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        const value = localStorage.getItem(key);
                        const size = (key.length + value.length) * 2; // ä¼°ç®—å­—èŠ‚æ•°
                        totalSize += size;
                        
                        if (key.startsWith('avatarData_')) {
                            avatarSize += size;
                            avatarCount++;
                        }
                    }
                    
                    console.log('localStorageä½¿ç”¨æƒ…å†µ:');
                    console.log('- æ€»å¤§å°:', (totalSize / 1024 / 1024).toFixed(2), 'MB');
                    console.log('- å¤´åƒæ•°æ®å¤§å°:', (avatarSize / 1024 / 1024).toFixed(2), 'MB');
                    console.log('- å¤´åƒæ•°é‡:', avatarCount, 'ä¸ª');
                    
                    return {
                        totalSize,
                        avatarSize,
                        avatarCount
                    };
                } catch (error) {
                    console.error('è·å–å­˜å‚¨ä½¿ç”¨æƒ…å†µå¤±è´¥:', error);
                    return null;
                }
            }

            // å°†å‡½æ•°æ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸ
            window.showGroupManagementMenu = showGroupManagementMenu;
            window.closeGroupManagementMenu = closeGroupManagementMenu;
            window.showGroupSettings = showGroupSettings;
            window.closeGroupSettings = closeGroupSettings;
            window.saveGroupSettings = saveGroupSettings;
            window.deleteContactGroup = deleteContactGroup;
            window.deleteGroupChat = deleteGroupChat;
            window.deleteCurrentGroup = deleteCurrentGroup;
            window.showAddMemberModal = showAddMemberModal;
            window.closeAddMemberModal = closeAddMemberModal;
            window.filterAddMemberContacts = filterAddMemberContacts;
            window.confirmAddMembers = confirmAddMembers;
            window.testGroupNameClick = testGroupNameClick;
            window.debugGroupData = debugGroupData;
            window.cleanupAvatarData = cleanupAvatarData;
            window.getStorageUsage = getStorageUsage;
            
            // è°ƒè¯•ï¼šæ£€æŸ¥å‡½æ•°æ˜¯å¦æ­£ç¡®å®šä¹‰
            console.log('ğŸ”§ å…¨å±€å‡½æ•°æ£€æŸ¥:');
            console.log('- confirmAvatarSelection:', typeof window.confirmAvatarSelection);
            console.log('- createGroupChat:', typeof window.createGroupChat);
            console.log('- showGroupManagementMenu:', typeof window.showGroupManagementMenu);
            console.log('- saveGroupToStorage:', typeof saveGroupToStorage);
            console.log('- addGroupToContactList:', typeof addGroupToContactList);
            console.log('- addGroupToMessageList:', typeof addGroupToMessageList);
            
            // è°ƒè¯•ï¼šæ£€æŸ¥æŒ‰é’®æ˜¯å¦å­˜åœ¨
            setTimeout(() => {
                const avatarBtn = document.getElementById('avatar_confirm_btn');
                const groupBtn = document.getElementById('group_confirm_btn');
                console.log('ğŸ”§ æŒ‰é’®æ£€æŸ¥:');
                console.log('- avatar_confirm_btn:', avatarBtn ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
                console.log('- group_confirm_btn:', groupBtn ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
                
                if (avatarBtn) {
                    console.log('- avataræŒ‰é’®onclick:', avatarBtn.getAttribute('onclick'));
                }
                if (groupBtn) {
                    console.log('- groupæŒ‰é’®onclick:', groupBtn.getAttribute('onclick'));
                }
            }, 1000);
            
            /**
             * ===== å¢å¼ºçš„ä¸–ç•Œä¹¦æ•°æ®ç®¡ç†ç³»ç»Ÿ =====
             */
            
            /**
             * å®‰å…¨åœ°ä¿å­˜æ•°æ®åˆ°ä¸–ç•Œä¹¦
             */
            async function QQ_SafeSaveToWorldBook(operation, data, key) {
                try {
                    if (!worldbook || !entries) {
                        console.warn(`ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨ï¼Œæ— æ³•ä¿å­˜${operation}`);
                        return false;
                    }
                    
                    // åˆ›å»ºä¸–ç•Œä¹¦æ¡ç›®æ•°æ®
                    const entryData = {
                        data: data,
                        operation: operation,
                        timestamp: new Date().toISOString(),
                        version: "1.0"
                    };
                    
                    // æŸ¥æ‰¾æˆ–åˆ›å»ºä¸–ç•Œä¹¦æ¡ç›®
                    let entry = entries.find(e => e.comment === key);
                    
                    if (!entry) {
                        // åˆ›å»ºæ–°æ¡ç›®
                        entry = {
                            comment: key,
                            content: JSON.stringify(entryData),
                            key: [`æ­¤ä¸–ç•Œä¹¦æ°¸ä¸è§¦å‘_${key}`],
                            keysecondary: [],
                            order: 1000 + entries.length,
                            enabled: true,
                            uid: Date.now() + Math.random()
                        };
                        
                        // *** ä¿®å¤ï¼šåŒæ­¥æ›´æ–°ä¸¤ä¸ªæ•°ç»„ä»¥é˜²æ­¢ä¸ä¸€è‡´ ***
                        // æ·»åŠ åˆ°worldbook.entriesï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                        if (worldbook.entries) {
                            worldbook.entries.push(entry);
                        }
                        // åŒæ—¶æ·»åŠ åˆ°æœ¬åœ°entriesæ•°ç»„ï¼Œä¿æŒåŒæ­¥
                        entries.push(entry);
                        
                        console.log(`åˆ›å»ºæ–°ä¸–ç•Œä¹¦æ¡ç›®: ${key} (å·²åŒæ­¥åˆ°æœ¬åœ°æ•°ç»„)`);
                    } else {
                        // æ›´æ–°ç°æœ‰æ¡ç›®
                        entry.content = JSON.stringify(entryData);
                        console.log(`æ›´æ–°ä¸–ç•Œä¹¦æ¡ç›®: ${key}`);
                    }
                    
                    // è§¦å‘ä¿å­˜
                    await QQ_SafeSaveWorldInfo(operation);
                    
                    console.log(`${operation}å·²æˆåŠŸä¿å­˜åˆ°ä¸–ç•Œä¹¦ (${key})`);
                    return true;
                } catch (error) {
                    console.error(`ä¿å­˜${operation}åˆ°ä¸–ç•Œä¹¦å¤±è´¥:`, error);
                    return false;
                }
            }
            
            /**
             * ä»ä¸–ç•Œä¹¦è·å–æ•°æ®
             */
            async function QQ_GetFromWorldBook(key) {
                try {
                    if (!worldbook || !entries) {
                        console.warn('ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨ï¼Œè¿”å›é»˜è®¤å€¼');
                        return null;
                    }
                    
                    const entry = entries.find(e => e.comment === key);
                    if (entry && entry.content) {
                        const entryData = JSON.parse(entry.content);
                        return entryData.data;
                    }
                    
                    return null;
                } catch (error) {
                    console.error(`ä»ä¸–ç•Œä¹¦è¯»å–æ•°æ®å¤±è´¥ (${key}):`, error);
                    return null;
                }
            }
            
            /**
             * ===== å„ç±»æ•°æ®ä¿å­˜åˆ°ä¸–ç•Œä¹¦çš„åŠŸèƒ½ =====
             */
            
            /**
             * ä¿å­˜æ‰€æœ‰è”ç³»äººåˆ°ä¸–ç•Œä¹¦
             */
            function QQ_SaveAllContactsToWorldBook() {
                const contacts = window.QQ_Contacts || {};
                return QQ_SafeSaveToWorldBook('è”ç³»äººæ•°æ®', contacts, 'QQ_è”ç³»äººæ•°æ®');
            }
            
            /**
             * ä¿å­˜æ‰€æœ‰ç¾¤èŠåˆ°ä¸–ç•Œä¹¦
             */
            function QQ_SaveAllGroupsToWorldBook() {
                const groups = window.QQ_Groups || {};
                return QQ_SafeSaveToWorldBook('ç¾¤èŠæ•°æ®', groups, 'QQ_ç¾¤èŠæ•°æ®');
            }
            
            /**
             * ä¿å­˜æ‰€æœ‰æ¶ˆæ¯åˆ°ä¸–ç•Œä¹¦
             */
            function QQ_SaveAllMessagesToWorldBook() {
                const messages = window.QQ_MessageHistory || {};
                return QQ_SafeSaveToWorldBook('æ¶ˆæ¯è®°å½•', messages, 'QQ_æ¶ˆæ¯è®°å½•');
            }
            
            /**
             * ä¿å­˜æ‰€æœ‰åŠ¨æ€åˆ°ä¸–ç•Œä¹¦
             */
            function QQ_SaveAllMomentsToWorldBook() {
                const moments = window.QQ_MomentData || {};
                return QQ_SafeSaveToWorldBook('åŠ¨æ€æ•°æ®', moments, 'QQ_åŠ¨æ€æ•°æ®');
            }
            
            /**
             * ä¿å­˜æ‰€æœ‰äº’åŠ¨ç©ºé—´åˆ°ä¸–ç•Œä¹¦
             */
            function QQ_SaveAllInteractiveSpacesToWorldBook() {
                const spaces = window.QQ_InteractiveSpaces || {};
                const characterSpaces = window.QQ_CharacterSpaces || {};
                
                const allSpaces = {
                    publicSpaces: spaces,
                    characterSpaces: characterSpaces
                };
                
                return QQ_SafeSaveToWorldBook('äº’åŠ¨ç©ºé—´æ•°æ®', allSpaces, 'QQ_äº’åŠ¨ç©ºé—´æ•°æ®');
            }
            
            /**
             * *** å·²åºŸå¼ƒï¼šåˆ†ç»„æ•°æ®ä¿å­˜å‡½æ•° ***
             * è¿™äº›å‡½æ•°å·²è¢«ç®€åŒ–ç‰ˆç›´æ¥æ“ä½œå–ä»£ï¼Œå‚è€ƒç¾¤èŠæ¨¡å¼
             */
            /*
            async function QQ_SaveContactGroupsToWorldBook(characterId, groups) {
                // æ­¤å‡½æ•°å·²åºŸå¼ƒï¼Œç°åœ¨ä½¿ç”¨ç®€åŒ–çš„ç›´æ¥æ“ä½œæ¨¡å¼
            }
            
            async function QQ_LoadContactGroupsFromWorldBook(characterId) {
                // æ­¤å‡½æ•°å·²åºŸå¼ƒï¼Œç°åœ¨ä½¿ç”¨ç®€åŒ–çš„ç›´æ¥æ“ä½œæ¨¡å¼
            }
            */
            
            /**
             * ===== ç»Ÿä¸€çš„ä¸–ç•Œä¹¦æ•°æ®ç®¡ç†ç³»ç»Ÿ =====
             * å‚è€ƒåŠ¨æ€å†…å®¹å­˜å‚¨çš„æˆåŠŸæœºåˆ¶ï¼Œç¡®ä¿äº’åŠ¨å†…å®¹å’Œåˆ†ç»„å†…å®¹ä¹Ÿèƒ½æ­£ç¡®ä¿å­˜å’ŒåŠ è½½
             */
            
            /**
             * *** ç®€åŒ–ç‰ˆï¼šç»Ÿä¸€çš„ä¸–ç•Œä¹¦ä¿å­˜å‡½æ•° - ä½¿ç”¨ä¸åŠ¨æ€å†…å®¹ç›¸åŒçš„ç®€å•æœºåˆ¶ ***
             * å‚è€ƒQQ_Save_Momentsçš„æˆåŠŸå®ç°ï¼Œä¸ºæ‰€æœ‰ç±»å‹æ•°æ®æä¾›ç»Ÿä¸€çš„ä¿å­˜æœºåˆ¶
             */
            async function QQ_UnifiedSaveToWorldBook(dataType, dataContent, comment, keyPrefix = 'QQ') {
                try {
                    if (!worldbook || !entries) {
                        console.warn(`ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨ï¼Œæ— æ³•ä¿å­˜${dataType}æ•°æ®`);
                        return false;
                    }
                    
                    // *** ä½¿ç”¨ä¸åŠ¨æ€å†…å®¹ç›¸åŒçš„ç®€å•ä¿å­˜æ–¹å¼ ***
                    // æŸ¥æ‰¾ç°æœ‰æ¡ç›®
                    let targetEntry = entries.find(entry => entry.comment === comment);
                    
                    // å‡†å¤‡ä¿å­˜çš„æ•°æ®ï¼ˆç®€åŒ–æ ¼å¼ï¼‰
                    const jsonData = JSON.stringify(dataContent, null, 2);
                    console.log(`å‡†å¤‡ä¿å­˜${dataType}æ•°æ®: ${comment}`);
                    
                    if (targetEntry) {
                        // ç›´æ¥æ›´æ–°ç°æœ‰æ¡ç›®çš„å†…å®¹
                        targetEntry.content = jsonData;
                        console.log(`âœ… ${dataType}æ•°æ®å·²æ›´æ–°åˆ°ç°æœ‰ä¸–ç•Œä¹¦æ¡ç›®: ${comment}`);
                    } else {
                        // *** ç®€åŒ–ç‰ˆï¼šç›´æ¥åˆ›å»ºæ–°æ¡ç›®åˆ°entriesæ•°ç»„ ***
                        const newEntry = {
                            uid: Date.now(),
                            comment: comment,
                            key: [`æ­¤ä¸–ç•Œä¹¦æ°¸ä¸è§¦å‘_${keyPrefix}_${dataType}`],
                            content: jsonData,
                            enabled: true,
                            order: 9998,
                            depth: 0
                        };
                        entries.push(newEntry);
                        console.log(`âœ… ${dataType}æ•°æ®å·²ä¿å­˜åˆ°æ–°ä¸–ç•Œä¹¦æ¡ç›®: ${comment}`);
                    }
                    
                    // *** ä¿®å¤ï¼šä½¿ç”¨ç»Ÿä¸€çš„å®‰å…¨ä¿å­˜æœºåˆ¶ ***
                    const saveSuccess = await QQ_SafeSaveWorldInfo(`${dataType}æ•°æ®`);
                    if (!saveSuccess) {
                        console.warn(`âš ï¸ ${dataType}æ•°æ®ä¿å­˜å¯èƒ½æœªå®Œå…¨åŒæ­¥`);
                    }
                    
                    // *** æ–°å¢ï¼šéªŒè¯ä¿å­˜æ˜¯å¦æˆåŠŸ ***
                    const verifyEntry = entries.find(entry => entry.comment === comment);
                    if (verifyEntry && verifyEntry.content === jsonData) {
                        console.log(`âœ… éªŒè¯æˆåŠŸï¼š${dataType}æ•°æ®å·²æ­£ç¡®ä¿å­˜åˆ°ä¸–ç•Œä¹¦`);
                        return true;
                    } else {
                        console.error(`âŒ éªŒè¯å¤±è´¥ï¼š${dataType}æ•°æ®ä¿å­˜å¯èƒ½æœ‰é—®é¢˜`);
                        return false;
                    }
                    
                } catch (error) {
                    console.error(`ä¿å­˜${dataType}æ•°æ®åˆ°ä¸–ç•Œä¹¦å¤±è´¥:`, error);
                    return false;
                }
            }
            
            /**
             * *** ç®€åŒ–ç‰ˆï¼šç»Ÿä¸€çš„ä¸–ç•Œä¹¦åŠ è½½å‡½æ•° - ä½¿ç”¨ä¸åŠ¨æ€å†…å®¹ç›¸åŒçš„ç®€å•æœºåˆ¶ ***
             */
            async function QQ_UnifiedLoadFromWorldBook(comment, defaultValue = null) {
                try {
                    if (!worldbook || !entries) {
                        console.warn(`ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨ï¼Œè¿”å›é»˜è®¤å€¼`);
                        return defaultValue;
                    }
                    
                    // æŸ¥æ‰¾ç›®æ ‡æ¡ç›®
                    const targetEntry = entries.find(entry => entry.comment === comment);
                    
                    if (targetEntry && targetEntry.content) {
                        try {
                            // *** ç®€åŒ–ç‰ˆï¼šç›´æ¥è§£æJSONå†…å®¹ï¼Œä¸éœ€è¦åŒ…è£…æ ¼å¼ ***
                            const data = JSON.parse(targetEntry.content);
                            console.log(`âœ… ä»ä¸–ç•Œä¹¦åŠ è½½æ•°æ®æˆåŠŸ: ${comment}`, data);
                            
                            // *** å…¼å®¹æ€§å¤„ç†ï¼šæ”¯æŒæ–°æ—§æ•°æ®æ ¼å¼ ***
                            if (data && typeof data === 'object' && data.content !== undefined) {
                                // æ—§æ ¼å¼ï¼šå¸¦æœ‰wrapperçš„æ•°æ®
                                console.log(`æ£€æµ‹åˆ°æ—§æ ¼å¼æ•°æ®ï¼Œæå–contentéƒ¨åˆ†`);
                                return data.content || defaultValue;
                            } else {
                                // æ–°æ ¼å¼ï¼šç›´æ¥çš„æ•°æ®
                                console.log(`æ£€æµ‹åˆ°æ–°æ ¼å¼æ•°æ®ï¼Œç›´æ¥è¿”å›`);
                                return data || defaultValue;
                            }
                        } catch (parseError) {
                            console.error(`è§£æä¸–ç•Œä¹¦æ•°æ®å¤±è´¥ (${comment}):`, parseError);
                            return defaultValue;
                        }
                    } else {
                        console.log(`ä¸–ç•Œä¹¦ä¸­æ²¡æœ‰æ‰¾åˆ°æ¡ç›®: ${comment}`);
                        return defaultValue;
                    }
                } catch (error) {
                    console.error(`ä»ä¸–ç•Œä¹¦åŠ è½½æ•°æ®å¤±è´¥ (${comment}):`, error);
                    return defaultValue;
                }
            }
            
            /**
             * *** ä¿®å¤ï¼šäº’åŠ¨å†…å®¹ä¿å­˜å‡½æ•° ***
             * ä½¿ç”¨é¡¹ç›®ç»Ÿä¸€çš„QQ_SafeSaveToWorldBookæœºåˆ¶ï¼Œä¿æŒä¸å…¶ä»–åŠŸèƒ½ä¸€è‡´æ€§
             */
            async function QQ_SaveInteractiveContentToWorldBook(content, characterName = null, locationInfo = null) {
                if (!worldbook || !entries) {
                    console.log('äº’åŠ¨å†…å®¹ä¿å­˜è·³è¿‡ï¼šç¼ºå°‘worldbookæˆ–entries');
                    return null;
                }
                
                try {
                    const interactiveData = {
                        content: content,
                        characterName: characterName,
                        timestamp: new Date().toISOString(),
                        id: `interactive_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        type: characterName ? 'character_specific' : 'public',
                        // *** æ–°å¢ï¼šå­˜å‚¨ä½ç½®ä¿¡æ¯ç”¨äºé‡æ–°åŠ è½½æ—¶æ¢å¤ ***
                        location: locationInfo || {
                            type: characterName ? 'privateChat' : 'publicChat',
                            target: characterName || 'public'
                        }
                    };
                    
                    // *** ä¿®å¤ï¼šä½¿ç”¨ä¸åŠ¨æ€å†…å®¹å®Œå…¨ç›¸åŒçš„ä¸–ç•Œä¹¦æ“ä½œæ–¹å¼ ***
                    const worldbookComment = 'æ‰‹æœº-äº’åŠ¨å†…å®¹å­˜å‚¨';
                    
                    // æŸ¥æ‰¾ç°æœ‰æ¡ç›®ï¼ˆä¸åŠ¨æ€ä¿å­˜æ–¹å¼ç›¸åŒï¼‰
                    let interactiveEntry = entries.find(entry => entry.comment === worldbookComment);
                    
                    // åŠ è½½ç°æœ‰æ•°æ®
                    let dataArray = [];
                    if (interactiveEntry && interactiveEntry.content) {
                        try {
                            const existingData = JSON.parse(interactiveEntry.content);
                            if (Array.isArray(existingData)) {
                                dataArray = existingData;
                            } else if (existingData && typeof existingData === 'object') {
                                dataArray = Object.values(existingData);
                            }
                        } catch (parseError) {
                            console.warn('è§£æç°æœ‰äº’åŠ¨æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨ç©ºæ•°ç»„:', parseError);
                            dataArray = [];
                        }
                    }
                    
                    // æ·»åŠ æ–°æ•°æ®åˆ°æ•°ç»„å¼€å¤´
                    dataArray.unshift(interactiveData);
                    
                    // *** é™åˆ¶æ•°é‡ä¸º20ä¸ªï¼ˆæ»šåŠ¨å¼å­˜å‚¨ï¼‰ ***
                    if (dataArray.length > 20) {
                        console.log(`ğŸ”„ äº’åŠ¨å†…å®¹å­˜å‚¨è¾¾åˆ°ä¸Šé™ï¼Œç§»é™¤æœ€æ—§çš„ ${dataArray.length - 20} ä¸ª`);
                        dataArray = dataArray.slice(0, 20);
                    }
                    
                    const interactiveJson = JSON.stringify(dataArray, null, 2);
                    console.log(`å‡†å¤‡ä¿å­˜äº’åŠ¨å†…å®¹: ${dataArray.length}ä¸ªé¡¹ç›®, æ–°å¢ID: ${interactiveData.id}`);
                    
                    if (interactiveEntry) {
                        // *** æ›´æ–°ç°æœ‰æ¡ç›®ï¼ˆä¸åŠ¨æ€ä¿å­˜æ–¹å¼ç›¸åŒï¼‰ ***
                        await setLorebookEntries(worldbook, [{
                            uid: interactiveEntry.uid,
                            content: interactiveJson,
                        }]);
                        console.log('äº’åŠ¨å†…å®¹å·²æ›´æ–°åˆ°ç°æœ‰worldbookæ¡ç›®');
                    } else {
                        // *** åˆ›å»ºæ–°æ¡ç›®ï¼ˆä½¿ç”¨ä¸åŠ¨æ€ä¿å­˜ç›¸åŒçš„å‚æ•°ï¼‰ ***
                        await createLorebookEntry(worldbook, {
                            comment: worldbookComment,
                            key: ["æ­¤ä¸–ç•Œä¹¦æ°¸ä¸è§¦å‘_äº’åŠ¨å†…å®¹å­˜å‚¨"],
                            content: interactiveJson,
                            position: "at_depth_as_system",
                            type: "selective",
                            depth: 0,
                            exclude_recursion: true,
                            order: 9999,
                            enabled: true,
                        });
                        console.log('äº’åŠ¨å†…å®¹å·²ä¿å­˜åˆ°æ–°worldbookæ¡ç›®');
                        
                        // *** é‡æ–°è·å–entriesä»¥åŒ…å«æ–°åˆ›å»ºçš„æ¡ç›® ***
                        entries = await getLorebookEntries(worldbook);
                    }
                    
                    console.log(`ğŸ¯ äº’åŠ¨å†…å®¹ä¿å­˜æˆåŠŸ: ${characterName || 'å…¬å…±'}, ID: ${interactiveData.id}`);
                    return interactiveData.id;
                    
                } catch (error) {
                    console.error('ä¿å­˜äº’åŠ¨å†…å®¹åˆ°ä¸–ç•Œä¹¦å¤±è´¥:', error);
                    return null;
                }
            }
            
            /**
             * *** ä¿®å¤ï¼šäº’åŠ¨å†…å®¹åŠ è½½å‡½æ•° ***
             * ä½¿ç”¨é¡¹ç›®ç»Ÿä¸€çš„QQ_GetFromWorldBookæœºåˆ¶ï¼Œä¿æŒä¸å…¶ä»–åŠŸèƒ½ä¸€è‡´æ€§
             */
            async function QQ_LoadInteractiveContentFromWorldBook(interactiveId = null) {
                try {
                    // *** ä¿®å¤ï¼šç›´æ¥ä»ä¸–ç•Œä¹¦æ¡ç›®è¯»å–å†…å®¹ï¼Œé¿å…æ ¼å¼é—®é¢˜ ***
                    const worldbookKey = 'æ‰‹æœº-äº’åŠ¨å†…å®¹å­˜å‚¨';
                    
                    if (!worldbook || !entries) {
                        console.warn('ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨');
                        return interactiveId ? null : [];
                    }
                    
                    // ç›´æ¥æŸ¥æ‰¾ä¸–ç•Œä¹¦æ¡ç›®
                    const entry = entries.find(e => e.comment === worldbookKey);
                    if (!entry || !entry.content) {
                        console.log(`ğŸ“‹ æ²¡æœ‰ä¿å­˜çš„äº’åŠ¨å†…å®¹`);
                        return interactiveId ? null : [];
                    }
                    
                    // ç›´æ¥è§£æJSONå†…å®¹
                    const data = JSON.parse(entry.content);
                    
                    if (data) {
                        let dataArray = [];
                        
                        // *** ä¿®å¤ï¼šå…¼å®¹ä¸åŒçš„æ•°æ®æ ¼å¼ ***
                        if (Array.isArray(data)) {
                            dataArray = data;
                        } else if (typeof data === 'object') {
                            // å¦‚æœæ˜¯å¯¹è±¡ï¼Œè½¬æ¢ä¸ºæ•°ç»„
                            if (data.id && data.content) {
                                // å•ä¸ªäº’åŠ¨å†…å®¹å¯¹è±¡
                                dataArray = [data];
                            } else {
                                // å¤šä¸ªäº’åŠ¨å†…å®¹çš„å¯¹è±¡
                                dataArray = Object.values(data).filter(item => item && item.id);
                            }
                        }
                        
                        console.log(`ğŸ” è§£æåˆ° ${dataArray.length} ä¸ªäº’åŠ¨å†…å®¹é¡¹ç›®`);
                        
                        // å¦‚æœæä¾›äº†IDï¼Œè¿”å›ç‰¹å®šçš„äº’åŠ¨å†…å®¹
                        if (interactiveId) {
                            const specificContent = dataArray.find(item => item.id === interactiveId);
                            if (specificContent) {
                                console.log(`âœ… æ‰¾åˆ°äº’åŠ¨å†…å®¹: ID=${interactiveId}`);
                                return specificContent;
                            } else {
                                console.log(`âŒ æœªæ‰¾åˆ°äº’åŠ¨å†…å®¹: ID=${interactiveId}ï¼Œç°æœ‰ID: ${dataArray.map(item => item.id).join(', ')}`);
                                return null;
                            }
                        }
                        // å¦åˆ™è¿”å›æ‰€æœ‰å†…å®¹
                        console.log(`âœ… åŠ è½½æ‰€æœ‰äº’åŠ¨å†…å®¹: ${dataArray.length}ä¸ªé¡¹ç›®`);
                        return dataArray;
                    } else {
                        console.log(`ğŸ“‹ æ²¡æœ‰ä¿å­˜çš„äº’åŠ¨å†…å®¹`);
                        return interactiveId ? null : [];
                    }
                } catch (error) {
                    console.error('ä»ä¸–ç•Œä¹¦åŠ è½½äº’åŠ¨å†…å®¹å¤±è´¥:', error);
                    return interactiveId ? null : [];
                }
            }
            
            /**
             * *** æ–°å¢ï¼šå¤„ç†çŸ­æœŸè®°å¿†ä¸­çš„äº’åŠ¨å†…å®¹å ä½ç¬¦ ***
             * åœ¨å‘é€çŸ­æœŸè®°å¿†ç»™AIæ—¶ï¼Œè‡ªåŠ¨æ›¿æ¢æœ€æ–°ä¸‰ä¸ªå ä½ç¬¦ä¸ºå®Œæ•´çš„äº’åŠ¨å†…å®¹
             */
            async function QQ_ProcessShortTermMemoryInteractiveContent(memoryContent) {
                try {
                    console.log('ğŸ­ å¼€å§‹å¤„ç†çŸ­æœŸè®°å¿†ä¸­çš„äº’åŠ¨å†…å®¹å ä½ç¬¦...');
                    
                    if (!window.QQ_ShortTermInteractiveContent || window.QQ_ShortTermInteractiveContent.length === 0) {
                        console.log('ğŸ“ çŸ­æœŸè®°å¿†ä¸­æ²¡æœ‰äº’åŠ¨å†…å®¹å ä½ç¬¦');
                        return memoryContent;
                    }
                    
                    console.log(`ğŸ” æ‰¾åˆ° ${window.QQ_ShortTermInteractiveContent.length} ä¸ªäº’åŠ¨å†…å®¹å ä½ç¬¦`);
                    
                    // è·å–æœ€æ–°çš„ä¸‰ä¸ªäº’åŠ¨å†…å®¹å ä½ç¬¦
                    const latestInteractiveItems = window.QQ_ShortTermInteractiveContent.slice(0, 3);
                    console.log(`ğŸ¯ å°†å¤„ç†æœ€æ–°çš„ ${latestInteractiveItems.length} ä¸ªäº’åŠ¨å†…å®¹å ä½ç¬¦`);
                    
                    let processedContent = memoryContent;
                    let replacementCount = 0;
                    
                    for (const item of latestInteractiveItems) {
                        const placeholderPattern = new RegExp(`\\[å‘ç”Ÿäº†ä¸€æ®µäº’åŠ¨ \\(ID: ${item.id.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\)\\]`, 'g');
                        
                        // æ£€æŸ¥å†…å®¹ä¸­æ˜¯å¦åŒ…å«æ­¤å ä½ç¬¦
                        if (placeholderPattern.test(processedContent)) {
                            console.log(`ğŸ”„ æ­£åœ¨æ›¿æ¢å ä½ç¬¦: ${item.id}`);
                            
                            // ä»ä¸–ç•Œä¹¦åŠ è½½äº’åŠ¨å†…å®¹
                            const interactiveContent = await QQ_LoadInteractiveContentFromWorldBook(item.id);
                            
                            if (interactiveContent && interactiveContent.content) {
                                // å‡†å¤‡æ›¿æ¢æ–‡æœ¬ï¼ŒåŒ…å«ä¸Šä¸‹æ–‡ä¿¡æ¯
                                const contextInfo = item.context.type === 'ç§èŠ' 
                                    ? `${item.context.sender}å¯¹${item.context.chatPartner}çš„ç§èŠä¸­` 
                                    : item.context.type === 'ç¾¤èŠ' 
                                    ? `${item.context.sender}åœ¨ç¾¤èŠ"${item.context.groupName}"ä¸­` 
                                    : `${item.context.sender}`;
                                    
                                const replacementText = `ã€äº’åŠ¨å†…å®¹ã€‘${contextInfo}å‘ç”Ÿäº†ä»¥ä¸‹äº’åŠ¨ï¼š\n${interactiveContent.content}`;
                                
                                // æ›¿æ¢å ä½ç¬¦
                                processedContent = processedContent.replace(placeholderPattern, replacementText);
                                replacementCount++;
                                
                                console.log(`âœ… æˆåŠŸæ›¿æ¢å ä½ç¬¦ ${item.id}ï¼Œé•¿åº¦: ${interactiveContent.content.length}`);
                            } else {
                                console.warn(`âš ï¸ æ— æ³•åŠ è½½äº’åŠ¨å†…å®¹: ${item.id}`);
                            }
                        }
                    }
                    
                    console.log(`ğŸ‰ çŸ­æœŸè®°å¿†äº’åŠ¨å†…å®¹å¤„ç†å®Œæˆï¼Œå…±æ›¿æ¢ ${replacementCount} ä¸ªå ä½ç¬¦`);
                    return processedContent;
                    
                } catch (error) {
                    console.error('å¤„ç†çŸ­æœŸè®°å¿†äº’åŠ¨å†…å®¹æ—¶å‡ºé”™:', error);
                    return memoryContent; // å‡ºé”™æ—¶è¿”å›åŸå§‹å†…å®¹
                }
            }


            /**
             * *** æ–°å¢ï¼šç»¼åˆæ•°æ®ç®¡ç†å’Œè°ƒè¯•å·¥å…· ***
             * æ›¿ä»£è¿‡æœŸçš„æµ‹è¯•å‡½æ•°ï¼Œæä¾›ç®€æ´çš„æ•°æ®ç®¡ç†åŠŸèƒ½
             */
            window.QQ_DataManager = {
                /**
                 * *** æ–°å¢ï¼šæµ‹è¯•åˆ†ç»„åŠ è½½ä¿®å¤ ***
                 */
                async testGroupLoading() {
                    console.log('=== ğŸ§ª æµ‹è¯•åˆ†ç»„åŠ è½½ä¿®å¤ ===');
                    
                    try {
                        const characterId = getCurrentCharacterId() || 'default';
                        console.log(`\nğŸ­ æµ‹è¯•è§’è‰²ID: ${characterId}`);
                        
                        // 1. æ£€æŸ¥ä¸–ç•Œä¹¦åŸºæœ¬å¯ç”¨æ€§
                        console.log('\n1ï¸âƒ£ æ£€æŸ¥ä¸–ç•Œä¹¦åŸºæœ¬çŠ¶æ€...');
                        if (!worldbook || !entries) {
                            console.error('âŒ ä¸–ç•Œä¹¦æˆ–entriesä¸å¯ç”¨');
                            return false;
                        }
                        console.log(`âœ… ä¸–ç•Œä¹¦å¯ç”¨, entriesæ•°é‡: ${entries.length}`);
                        
                        // 2. æŸ¥æ‰¾åˆ†ç»„æ¡ç›®
                        console.log('\n2ï¸âƒ£ æŸ¥æ‰¾åˆ†ç»„æ¡ç›®...');
                        const comment = `QQ_åˆ†ç»„å¤‡ä»½_${characterId}`;
                        const targetEntry = entries.find(entry => entry.comment === comment);
                        
                        if (targetEntry) {
                            console.log(`âœ… æ‰¾åˆ°åˆ†ç»„æ¡ç›®: ${comment}`);
                            console.log(`ğŸ“„ æ¡ç›®å†…å®¹é•¿åº¦: ${targetEntry.content?.length || 0}`);
                            console.log(`ğŸ“„ æ¡ç›®å†…å®¹é¢„è§ˆ:`, targetEntry.content?.substring(0, 200) + '...');
                            
                            // 3. å°è¯•è§£ææ•°æ®
                            console.log('\n3ï¸âƒ£ å°è¯•è§£æåˆ†ç»„æ•°æ®...');
                            try {
                                const data = JSON.parse(targetEntry.content);
                                console.log(`âœ… JSONè§£ææˆåŠŸ:`, data);
                                
                                // 4. æ£€æŸ¥æ•°æ®æ ¼å¼
                                console.log('\n4ï¸âƒ£ æ£€æŸ¥æ•°æ®æ ¼å¼...');
                                let groupsData = null;
                                if (data && typeof data === 'object' && data.content !== undefined) {
                                    console.log(`ğŸ“‹ æ£€æµ‹åˆ°æ—§æ ¼å¼æ•°æ®ï¼Œæå–contentéƒ¨åˆ†`);
                                    groupsData = data.content;
                    } else {
                                    console.log(`ğŸ“‹ æ£€æµ‹åˆ°æ–°æ ¼å¼æ•°æ®ï¼Œç›´æ¥ä½¿ç”¨`);
                                    groupsData = data;
                                }
                                
                                if (Array.isArray(groupsData)) {
                                    console.log(`âœ… æˆåŠŸè·å–åˆ†ç»„æ•°æ®: ${groupsData.length}ä¸ªåˆ†ç»„`);
                                    groupsData.forEach((group, index) => {
                                        console.log(`ğŸ“‚ åˆ†ç»„${index + 1}: ${group.name} (${group.contacts?.length || 0}ä¸ªè”ç³»äºº)`);
                                    });
                                    return true;
                                } else {
                                    console.error(`âŒ åˆ†ç»„æ•°æ®æ ¼å¼é”™è¯¯ï¼Œä¸æ˜¯æ•°ç»„:`, typeof groupsData);
                                    return false;
                                }
                            } catch (parseError) {
                                console.error(`âŒ JSONè§£æå¤±è´¥:`, parseError);
                                return false;
                            }
                        } else {
                            console.log(`âŒ æ²¡æœ‰æ‰¾åˆ°åˆ†ç»„æ¡ç›®: ${comment}`);
                            console.log(`ğŸ“‹ å¯ç”¨çš„æ¡ç›®åˆ—è¡¨:`);
                            entries.forEach((entry, index) => {
                                if (entry.comment && entry.comment.includes('åˆ†ç»„')) {
                                    console.log(`  ${index}: ${entry.comment}`);
                                }
                            });
                            return false;
                        }
                        
                    } catch (error) {
                        console.error('âŒ æµ‹è¯•åˆ†ç»„åŠ è½½å¤±è´¥:', error);
                        return false;
                    }
                },
                
                /**
                 * æ˜¾ç¤ºæ‰€æœ‰ä¸–ç•Œä¹¦æ•°æ®ç»Ÿè®¡
                 */
                async showStats() {
                    console.log('=== ğŸ“Š SillyTavernæ‰‹æœºå‰ç«¯æ•°æ®ç»Ÿè®¡ ===');
                    
                    try {
                        if (!QQ_IsWorldBookAvailable()) {
                            console.log('âŒ ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨');
                            return;
                        }
                        
                        const characterId = getCurrentCharacterId() || 'default';
                        console.log(`\nğŸ­ å½“å‰è§’è‰²ID: ${characterId}`);
                        
                        // åŠ¨æ€æ•°æ®ç»Ÿè®¡
                        if (QQ_MomentsData && Array.isArray(QQ_MomentsData)) {
                            const totalComments = QQ_MomentsData.reduce((sum, moment) => sum + (moment.comments?.length || 0), 0);
                            console.log(`\nğŸ“± åŠ¨æ€æ•°æ®: ${QQ_MomentsData.length}æ¡åŠ¨æ€, ${totalComments}æ¡è¯„è®º`);
                        }
                        
                        // åˆ†ç»„æ•°æ®ç»Ÿè®¡
                        const groups = await QQ_LoadContactGroupsFromWorldBook(characterId);
                        const totalContacts = groups.reduce((sum, group) => sum + (group.contacts?.length || 0), 0);
                        console.log(`\nğŸ‘¥ åˆ†ç»„æ•°æ®: ${groups.length}ä¸ªåˆ†ç»„, ${totalContacts}ä¸ªè”ç³»äºº`);
                        
                        // äº’åŠ¨ç©ºé—´æ•°æ®ç»Ÿè®¡
                        const publicInteractive = await QQ_LoadInteractiveContentFromWorldBook();
                        const characterInteractive = await QQ_LoadInteractiveContentFromWorldBook(characterId);
                        console.log(`\nğŸ¯ äº’åŠ¨ç©ºé—´: å…¬å…±${publicInteractive.length}ä¸ª, è§’è‰²ä¸“å±${characterInteractive.length}ä¸ª`);
                        
                        console.log('\n=== æ•°æ®ç»Ÿè®¡å®Œæˆ ===');
                    
                } catch (error) {
                        console.error('è·å–æ•°æ®ç»Ÿè®¡å¤±è´¥:', error);
                    }
                },
                
                /**
                 * æ¸…ç†å’Œä¼˜åŒ–æ•°æ®
                 */
                async optimizeData() {
                    console.log('=== ğŸ§¹ æ•°æ®æ¸…ç†å’Œä¼˜åŒ– ===');
                    
                    try {
                        // æ¸…ç†åŠ¨æ€æ•°æ®
                        if (typeof QQ_CleanOldMoments === 'function') {
                            QQ_CleanOldMoments();
                            console.log('âœ… åŠ¨æ€æ•°æ®æ¸…ç†å®Œæˆ');
                        }
                        
                        // ä¼˜åŒ–è¯„è®ºå­˜å‚¨
                        if (typeof QQ_OptimizeCommentsStorage === 'function') {
                            QQ_OptimizeCommentsStorage();
                            console.log('âœ… è¯„è®ºå­˜å‚¨ä¼˜åŒ–å®Œæˆ');
                        }
                        
                        // ä¿å­˜æ¸…ç†åçš„æ•°æ®
                        if (typeof QQ_Save_Moments === 'function') {
                            await QQ_Save_Moments();
                            console.log('âœ… ä¼˜åŒ–åçš„åŠ¨æ€æ•°æ®å·²ä¿å­˜');
                        }
                        
                        console.log('\n=== æ•°æ®ä¼˜åŒ–å®Œæˆ ===');
                        
                    } catch (error) {
                        console.error('æ•°æ®ä¼˜åŒ–å¤±è´¥:', error);
                    }
                },
                
                /**
                 * *** æ–°å¢ï¼šæµ‹è¯•äº’åŠ¨å†…å®¹ä¿å­˜å’ŒåŠ è½½ ***
                 */
                async testInteractiveContent() {
                    console.log('=== ğŸ¯ æµ‹è¯•äº’åŠ¨å†…å®¹ä¿å­˜å’ŒåŠ è½½ ===');
                    
                    try {
                        const characterId = getCurrentCharacterId() || 'default';
                        console.log(`\nğŸ­ æµ‹è¯•è§’è‰²ID: ${characterId}`);
                        
                        // 1. æ£€æŸ¥ä¸–ç•Œä¹¦å¯ç”¨æ€§
                        console.log('\n1ï¸âƒ£ æ£€æŸ¥ä¸–ç•Œä¹¦çŠ¶æ€...');
                        if (!worldbook || !entries) {
                            console.error('âŒ ä¸–ç•Œä¹¦æˆ–entriesä¸å¯ç”¨');
                            return false;
                        }
                        console.log(`âœ… ä¸–ç•Œä¹¦å¯ç”¨, entriesæ•°é‡: ${entries.length}`);
                        
                        // 2. æµ‹è¯•ä¿å­˜äº’åŠ¨å†…å®¹
                        console.log('\n2ï¸âƒ£ æµ‹è¯•ä¿å­˜äº’åŠ¨å†…å®¹...');
                        const testContent = `æµ‹è¯•äº’åŠ¨å†…å®¹ - ${new Date().toLocaleString()}\n\nè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•çš„äº’åŠ¨åœºæ™¯ï¼ŒåŒ…å«ä»¥ä¸‹å…ƒç´ ï¼š\n1. è¯¦ç»†çš„åœºæ™¯æè¿°\n2. è§’è‰²çš„åŠ¨ä½œå’Œè¡¨æƒ…\n3. ç¯å¢ƒçš„æ¸²æŸ“\n4. æƒ…æ„Ÿçš„è¡¨è¾¾`;
                        
                        const interactiveId = await QQ_SaveInteractiveContentToWorldBook(testContent, characterId);
                        
                        if (interactiveId) {
                            console.log(`âœ… äº’åŠ¨å†…å®¹ä¿å­˜æˆåŠŸï¼ŒID: ${interactiveId}`);
                        } else {
                            console.error('âŒ äº’åŠ¨å†…å®¹ä¿å­˜å¤±è´¥');
                            return false;
                        }
                        
                        // 3. æµ‹è¯•åŠ è½½äº’åŠ¨å†…å®¹
                        console.log('\n3ï¸âƒ£ æµ‹è¯•åŠ è½½äº’åŠ¨å†…å®¹...');
                        const loadedContent = await QQ_LoadInteractiveContentFromWorldBook(characterId);
                        
                        if (Array.isArray(loadedContent) && loadedContent.length > 0) {
                            console.log(`âœ… äº’åŠ¨å†…å®¹åŠ è½½æˆåŠŸ: ${loadedContent.length}ä¸ªé¡¹ç›®`);
                            console.log(`ğŸ“„ æœ€æ–°å†…å®¹é¢„è§ˆ:`, loadedContent[0].content.substring(0, 100) + '...');
                            console.log(`ğŸ•’ åˆ›å»ºæ—¶é—´:`, loadedContent[0].timestamp);
                            console.log(`ğŸ­ å…³è”è§’è‰²:`, loadedContent[0].characterName);
                        } else {
                            console.error('âŒ äº’åŠ¨å†…å®¹åŠ è½½å¤±è´¥æˆ–ä¸ºç©º');
                            return false;
                        }
                        
                        // 4. éªŒè¯ä¸–ç•Œä¹¦æ¡ç›®
                        console.log('\n4ï¸âƒ£ éªŒè¯ä¸–ç•Œä¹¦æ¡ç›®...');
                        const worldbookKey = `QQ_äº’åŠ¨å†…å®¹å¤‡ä»½_${characterId}`;
                        
                        // ä½¿ç”¨ç»Ÿä¸€çš„QQ_GetFromWorldBookéªŒè¯
                        const verifyData = await QQ_GetFromWorldBook(worldbookKey);
                        
                        if (verifyData && Array.isArray(verifyData)) {
                            console.log(`âœ… ä¸–ç•Œä¹¦æ¡ç›®éªŒè¯æˆåŠŸ: ${worldbookKey}`);
                            console.log(`ğŸ“„ æ¡ç›®æ•°æ®åŒ…å«: ${verifyData.length}ä¸ªé¡¹ç›®`);
                            
                            // æ£€æŸ¥æœ€æ–°é¡¹ç›®æ˜¯å¦åŒ¹é…
                            if (verifyData.length > 0 && verifyData[0].id === interactiveId) {
                                console.log(`âœ… æœ€æ–°é¡¹ç›®IDåŒ¹é…: ${interactiveId}`);
                                console.log(`ğŸ“ é¡¹ç›®å†…å®¹é¢„è§ˆ: ${verifyData[0].content.substring(0, 50)}...`);
                                return true;
                            } else {
                                console.error(`âŒ æœ€æ–°é¡¹ç›®IDä¸åŒ¹é…: æœŸæœ›${interactiveId}, å®é™…${verifyData[0]?.id}`);
                                return false;
                            }
                        } else {
                            console.error(`âŒ ä¸–ç•Œä¹¦æ¡ç›®éªŒè¯å¤±è´¥: ${worldbookKey}`);
                            console.log(`ğŸ’¡ æç¤º: æ£€æŸ¥QQ_SafeSaveToWorldBookæ˜¯å¦æ­£å¸¸å·¥ä½œ`);
                            return false;
                        }
                        
                    } catch (error) {
                        console.error('âŒ æµ‹è¯•äº’åŠ¨å†…å®¹å¤±è´¥:', error);
                        return false;
                    }
                },
                
                /**
                 * *** æ–°å¢ï¼šæµ‹è¯•äº’åŠ¨ç©ºé—´ä¿å­˜å’ŒåŠ è½½ ***
                 */
                async testInteractiveSpaces() {
                    console.log('=== ğŸ¯ æµ‹è¯•äº’åŠ¨ç©ºé—´ä¿å­˜å’ŒåŠ è½½ ===');
                   
                    try {
                        // 1. æ£€æŸ¥ä¸–ç•Œä¹¦åŸºæœ¬çŠ¶æ€
                        console.log('\n1ï¸âƒ£ æ£€æŸ¥ä¸–ç•Œä¹¦åŸºæœ¬çŠ¶æ€...');
                        if (!worldbook || !entries) {
                            console.error('âŒ ä¸–ç•Œä¹¦æˆ–entriesä¸å¯ç”¨');
                            return false;
                        }
                        console.log(`âœ… ä¸–ç•Œä¹¦å¯ç”¨, entriesæ•°é‡: ${entries.length}`);
                        
                        // 2. æ£€æŸ¥å½“å‰äº’åŠ¨ç©ºé—´æ•°æ®
                        console.log('\n2ï¸âƒ£ æ£€æŸ¥å½“å‰äº’åŠ¨ç©ºé—´æ•°æ®...');
                        const currentSpaceCount = Object.keys(QQ_InteractiveSpaces || {}).length;
                        console.log(`ğŸ“Š å½“å‰å†…å­˜ä¸­çš„äº’åŠ¨ç©ºé—´æ•°é‡: ${currentSpaceCount}`);
                        
                        if (currentSpaceCount > 0) {
                            console.log('ğŸ“‹ å½“å‰äº’åŠ¨ç©ºé—´åˆ—è¡¨:');
                            Object.keys(QQ_InteractiveSpaces).forEach(spaceId => {
                                const space = QQ_InteractiveSpaces[spaceId];
                                console.log(`  - ${spaceId}: ${space.name} (${space.characterName})`);
                            });
                        }
                        
                        // 3. æµ‹è¯•ä¿å­˜åŠŸèƒ½
                        console.log('\n3ï¸âƒ£ æµ‹è¯•ä¿å­˜åŠŸèƒ½...');
                        const saveResult = await QQ_SaveInteractiveSpaces();
                        if (saveResult) {
                            console.log('âœ… äº’åŠ¨ç©ºé—´ä¿å­˜æˆåŠŸ');
                        } else {
                            console.error('âŒ äº’åŠ¨ç©ºé—´ä¿å­˜å¤±è´¥');
                            return false;
                        }
                        
                        // 4. éªŒè¯ä¸–ç•Œä¹¦æ¡ç›®
                        console.log('\n4ï¸âƒ£ éªŒè¯ä¸–ç•Œä¹¦æ¡ç›®...');
                        const targetEntry = entries.find(entry => entry.comment === QQ_INTERACTIVE_BACKUP_KEY);
                        
                        if (targetEntry) {
                            console.log(`âœ… ä¸–ç•Œä¹¦æ¡ç›®å­˜åœ¨: ${QQ_INTERACTIVE_BACKUP_KEY}`);
                            console.log(`ğŸ“„ æ¡ç›®å†…å®¹é•¿åº¦: ${targetEntry.content?.length || 0}`);
                            
                            try {
                                const entryData = JSON.parse(targetEntry.content);
                                if (entryData.spaces && typeof entryData.spaces === 'object') {
                                    const savedSpaceCount = Object.keys(entryData.spaces).length;
                                    console.log(`âœ… æ¡ç›®æ•°æ®æ ¼å¼æ­£ç¡®: ${savedSpaceCount}ä¸ªç©ºé—´`);
                                    
                                    if (savedSpaceCount === currentSpaceCount) {
                                        console.log('âœ… ä¿å­˜çš„ç©ºé—´æ•°é‡ä¸å†…å­˜æ•°é‡ä¸€è‡´');
                                    } else {
                                        console.warn(`âš ï¸ æ•°é‡ä¸ä¸€è‡´: å†…å­˜${currentSpaceCount} vs ä¿å­˜${savedSpaceCount}`);
                                    }
                                } else {
                                    console.error('âŒ æ¡ç›®æ•°æ®æ ¼å¼é”™è¯¯ï¼Œæ²¡æœ‰spaceså¯¹è±¡');
                                    return false;
                                }
                            } catch (parseError) {
                                console.error('âŒ æ¡ç›®å†…å®¹JSONè§£æå¤±è´¥:', parseError);
                                return false;
                            }
                        } else {
                            console.error(`âŒ ä¸–ç•Œä¹¦æ¡ç›®ä¸å­˜åœ¨: ${QQ_INTERACTIVE_BACKUP_KEY}`);
                            return false;
                        }
                        
                        // 5. æµ‹è¯•åŠ è½½åŠŸèƒ½
                        console.log('\n5ï¸âƒ£ æµ‹è¯•åŠ è½½åŠŸèƒ½...');
                        const originalSpaces = { ...QQ_InteractiveSpaces };
                        QQ_InteractiveSpaces = {}; // æ¸…ç©ºå†…å­˜
                        
                        await QQ_LoadInteractiveSpaces();
                        const loadedSpaceCount = Object.keys(QQ_InteractiveSpaces).length;
                        
                        if (loadedSpaceCount === currentSpaceCount) {
                            console.log('âœ… åŠ è½½æµ‹è¯•æˆåŠŸï¼Œæ•°æ®å®Œæ•´æ¢å¤');
                            QQ_InteractiveSpaces = originalSpaces; // æ¢å¤åŸæ•°æ®
                        } else {
                            console.error(`âŒ åŠ è½½æµ‹è¯•å¤±è´¥: æœŸæœ›${currentSpaceCount}ä¸ªï¼Œå®é™…${loadedSpaceCount}ä¸ª`);
                            QQ_InteractiveSpaces = originalSpaces; // æ¢å¤åŸæ•°æ®
                            return false;
                        }
                        
                        console.log('\nâœ… äº’åŠ¨ç©ºé—´ä¿å­˜åŠ è½½æµ‹è¯•å®Œæˆ');
                        console.log('ğŸ¯ äº’åŠ¨ç©ºé—´åŠŸèƒ½æ­£å¸¸ï¼Œæ•°æ®èƒ½æ­£ç¡®ä¿å­˜åˆ°ä¸–ç•Œä¹¦å¹¶é‡æ–°åŠ è½½');
                        
                        toastr.success('äº’åŠ¨ç©ºé—´ä¿å­˜åŠ è½½æµ‹è¯•é€šè¿‡', 'æµ‹è¯•æˆåŠŸ');
                        return true;
                        
                    } catch (error) {
                        console.error('âŒ æµ‹è¯•äº’åŠ¨ç©ºé—´æ—¶å‡ºé”™:', error);
                        toastr.error('æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°', 'æµ‹è¯•å¤±è´¥');
                        return false;
                    }
                },
                
                /**
                 * *** æ–°å¢ï¼šæµ‹è¯•äº’åŠ¨ç©ºé—´æ•°æ®ä¸€è‡´æ€§ ***
                 * éªŒè¯ç•Œé¢æ˜¾ç¤ºæ•°æ®ä¸ä¸–ç•Œä¹¦å­˜å‚¨æ•°æ®æ˜¯å¦å®Œå…¨åŒæ­¥
                 */
                async testInteractiveSpacesConsistency() {
                    console.log('=== ğŸ” æµ‹è¯•äº’åŠ¨ç©ºé—´æ•°æ®ä¸€è‡´æ€§ ===');
                    
                    try {
                        // 1. æ£€æŸ¥åŸºæœ¬çŠ¶æ€
                        if (!worldbook || !entries) {
                            console.error('âŒ ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨');
                            return false;
                        }
                        
                        // 2. è·å–ç•Œé¢æ˜¾ç¤ºæ•°æ®
                        const interfaceSpaces = QQ_InteractiveSpaces || {};
                        const interfaceSpaceIds = Object.keys(interfaceSpaces);
                        console.log(`ğŸ–¥ï¸ ç•Œé¢æ•°æ®: ${interfaceSpaceIds.length}ä¸ªç©ºé—´`);
                        
                        // 3. è·å–ä¸–ç•Œä¹¦å­˜å‚¨æ•°æ®
                        const entry = entries.find(e => e.comment === QQ_INTERACTIVE_BACKUP_KEY);
                        let worldbookSpaces = {};
                        let worldbookSpaceIds = [];
                        
                        if (entry && entry.content) {
                            try {
                                const data = JSON.parse(entry.content);
                                worldbookSpaces = data.spaces || {};
                                worldbookSpaceIds = Object.keys(worldbookSpaces);
                                console.log(`ğŸ“š ä¸–ç•Œä¹¦æ•°æ®: ${worldbookSpaceIds.length}ä¸ªç©ºé—´`);
                            } catch (parseError) {
                                console.error('âŒ ä¸–ç•Œä¹¦æ•°æ®è§£æå¤±è´¥:', parseError);
                                return false;
                            }
                        } else {
                            console.log('ğŸ“š ä¸–ç•Œä¹¦ä¸­æ²¡æœ‰äº’åŠ¨ç©ºé—´æ•°æ®');
                        }
                        
                        // 4. å¯¹æ¯”æ•°æ®ä¸€è‡´æ€§
                        if (interfaceSpaceIds.length === worldbookSpaceIds.length) {
                            console.log('âœ… ç©ºé—´æ•°é‡ä¸€è‡´');
                            
                            // æ£€æŸ¥æ¯ä¸ªç©ºé—´IDæ˜¯å¦åŒ¹é…
                            const missingInWorldbook = interfaceSpaceIds.filter(id => !worldbookSpaceIds.includes(id));
                            const missingInInterface = worldbookSpaceIds.filter(id => !interfaceSpaceIds.includes(id));
                            
                            if (missingInWorldbook.length === 0 && missingInInterface.length === 0) {
                                console.log('âœ… æ‰€æœ‰ç©ºé—´IDå®Œå…¨åŒ¹é…');
                                
                                // æ£€æŸ¥ç©ºé—´å†…å®¹æ˜¯å¦ä¸€è‡´
                                let contentMismatches = 0;
                                interfaceSpaceIds.forEach(spaceId => {
                                    const interfaceSpace = interfaceSpaces[spaceId];
                                    const worldbookSpace = worldbookSpaces[spaceId];
                                    
                                    if (interfaceSpace.content !== worldbookSpace.content) {
                                        contentMismatches++;
                                        console.warn(`âš ï¸ ç©ºé—´${spaceId}å†…å®¹ä¸ä¸€è‡´`);
                                    }
                                });
                                
                                if (contentMismatches === 0) {
                                    console.log('âœ… æ‰€æœ‰ç©ºé—´å†…å®¹å®Œå…¨ä¸€è‡´');
                                    console.log('ğŸ¯ æ•°æ®ä¸€è‡´æ€§æµ‹è¯•é€šè¿‡ï¼šç•Œé¢æ•°æ®ä¸ä¸–ç•Œä¹¦æ•°æ®å®Œå…¨åŒæ­¥');
                                    return true;
                                } else {
                                    console.error(`âŒ æœ‰${contentMismatches}ä¸ªç©ºé—´å†…å®¹ä¸ä¸€è‡´`);
                                    return false;
                                }
                            } else {
                                console.error('âŒ ç©ºé—´IDä¸åŒ¹é…:');
                                if (missingInWorldbook.length > 0) {
                                    console.error('  ç•Œé¢æœ‰ä½†ä¸–ç•Œä¹¦æ²¡æœ‰:', missingInWorldbook);
                                }
                                if (missingInInterface.length > 0) {
                                    console.error('  ä¸–ç•Œä¹¦æœ‰ä½†ç•Œé¢æ²¡æœ‰:', missingInInterface);
                                }
                                return false;
                            }
                        } else {
                            console.error(`âŒ ç©ºé—´æ•°é‡ä¸ä¸€è‡´: ç•Œé¢${interfaceSpaceIds.length} vs ä¸–ç•Œä¹¦${worldbookSpaceIds.length}`);
                            return false;
                        }
                        
                    } catch (error) {
                        console.error('âŒ æµ‹è¯•æ•°æ®ä¸€è‡´æ€§æ—¶å‡ºé”™:', error);
                        return false;
                    }
                },

                /**
                 * æ‰‹åŠ¨ä¿å­˜æ‰€æœ‰æ•°æ®
                 */
                async saveAll() {
                    console.log('=== ğŸ’¾ æ‰‹åŠ¨ä¿å­˜æ‰€æœ‰æ•°æ® ===');
                    
                    try {
                        // ä¿å­˜åŠ¨æ€æ•°æ®
                        if (typeof QQ_Save_Moments === 'function') {
                            await QQ_Save_Moments();
                            console.log('âœ… åŠ¨æ€æ•°æ®å·²ä¿å­˜');
                        }
                        
                        // ä¿å­˜åˆ†ç»„æ•°æ®
                        if (typeof saveGroupsToStorage === 'function') {
                            await saveGroupsToStorage();
                            console.log('âœ… åˆ†ç»„æ•°æ®å·²ä¿å­˜');
                        }
                        
                        // ä¿å­˜äº’åŠ¨ç©ºé—´æ•°æ®
                        if (typeof QQ_SaveInteractiveSpaces === 'function') {
                            await QQ_SaveInteractiveSpaces();
                            console.log('âœ… äº’åŠ¨ç©ºé—´æ•°æ®å·²ä¿å­˜');
                        }
                        
                        console.log('\n=== æ‰€æœ‰æ•°æ®ä¿å­˜å®Œæˆ ===');
                        
                } catch (error) {
                        console.error('ä¿å­˜æ•°æ®å¤±è´¥:', error);
                    }
                },
                
                /**
                 * æµ‹è¯•ä¸–ç•Œä¹¦åŠŸèƒ½
                 */
                async testWorldBook() {
                    console.log('=== ğŸ§ª ä¸–ç•Œä¹¦åŠŸèƒ½æµ‹è¯• ===');
                    
                    try {
                        const testData = { test: true, timestamp: new Date().toISOString() };
                        const testComment = 'QQ_æµ‹è¯•æ•°æ®_ä¸´æ—¶';
                        
                        // æµ‹è¯•ä¿å­˜
                        const saveSuccess = await QQ_UnifiedSaveToWorldBook('æµ‹è¯•', testData, testComment, 'æµ‹è¯•');
                        console.log('ä¿å­˜æµ‹è¯•:', saveSuccess ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥');
                        
                        // æµ‹è¯•åŠ è½½
                        const loadedData = await QQ_UnifiedLoadFromWorldBook(testComment, null);
                        const loadSuccess = loadedData && loadedData.test === true;
                        console.log('åŠ è½½æµ‹è¯•:', loadSuccess ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥');
                        
                        console.log('\n=== ä¸–ç•Œä¹¦åŠŸèƒ½æµ‹è¯•å®Œæˆ ===');
                        return saveSuccess && loadSuccess;
                        
                    } catch (error) {
                        console.error('ä¸–ç•Œä¹¦åŠŸèƒ½æµ‹è¯•å¤±è´¥:', error);
                        return false;
                    }
                }
            };
            
            /**
             * ===== ä¿®å¤åˆ†ç»„ä¿å­˜åŠŸèƒ½ =====
             */
            
            /**
             * *** å·²ç§»é™¤ï¼šé‡å¤çš„window.saveGroupsToStorageå®šä¹‰ ***
             * ç°åœ¨ç»Ÿä¸€ä½¿ç”¨ä¸»saveGroupsToStorageå‡½æ•°
             */
            

            
            /**
             * *** å·²ç§»é™¤ï¼šé‡å¤çš„window.loadGroupsFromStorageå®šä¹‰ ***
             * ç°åœ¨ç»Ÿä¸€ä½¿ç”¨ä¸»loadGroupsFromStorageå‡½æ•°
             */
            
            /**
             * ===== æ•°æ®ç®¡ç†å’Œè°ƒè¯•å·¥å…· =====
             */
            
            /**
             * *** æ–°å¢ï¼šè°ƒè¯•åˆ†ç»„æ•°æ®åŒæ­¥çŠ¶æ€ ***
             */
            window.QQ_Debug_Group_Data_Sync = function() {
                console.log('=== ğŸ” åˆ†ç»„æ•°æ®åŒæ­¥çŠ¶æ€æ£€æŸ¥ ===');
                
                try {
                    const charId = getCurrentCharacterId() || 'default';
                    const comment = `QQ_åˆ†ç»„å¤‡ä»½_${charId}`;
                    
                    console.log(`ğŸ“ å½“å‰è§’è‰²ID: ${charId}`);
                    console.log(`ğŸ“ æŸ¥æ‰¾ä¸–ç•Œä¹¦æ¡ç›®: ${comment}`);
                    
                    // æ£€æŸ¥å†…å­˜ä¸­çš„åˆ†ç»„æ•°æ®
                    console.log(`ğŸ“Š å†…å­˜ä¸­çš„åˆ†ç»„æ•°æ® (contactGroups):`);
                    console.log(`  - åˆ†ç»„æ•°é‡: ${contactGroups.length}`);
                    if (contactGroups.length > 0) {
                        contactGroups.forEach((group, index) => {
                            console.log(`  - [${index}] ${group.name} (${group.contacts.length}äºº) ID:${group.id}`);
                        });
                    } else {
                        console.log(`  - æ— åˆ†ç»„æ•°æ®`);
                    }
                    
                    // æ£€æŸ¥ä¸–ç•Œä¹¦ä¸­çš„æ¡ç›®
                    if (!worldbook || !entries) {
                        console.error('âŒ ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨');
                        return;
                    }
                    
                    const targetEntry = entries.find(entry => entry.comment === comment);
                    console.log(`ğŸ“– ä¸–ç•Œä¹¦æ¡ç›®çŠ¶æ€:`);
                    if (targetEntry) {
                        console.log(`  âœ… æ‰¾åˆ°ä¸–ç•Œä¹¦æ¡ç›®: ${comment}`);
                        console.log(`  - UID: ${targetEntry.uid}`);
                        console.log(`  - å†…å®¹é•¿åº¦: ${targetEntry.content.length} å­—ç¬¦`);
                        
                        try {
                            const worldbookGroups = JSON.parse(targetEntry.content);
                            console.log(`  - è§£ææˆåŠŸ: ${Array.isArray(worldbookGroups) ? worldbookGroups.length : 0} ä¸ªåˆ†ç»„`);
                            
                            if (Array.isArray(worldbookGroups) && worldbookGroups.length > 0) {
                                worldbookGroups.forEach((group, index) => {
                                    console.log(`    - [${index}] ${group.name} (${group.contacts ? group.contacts.length : 0}äºº) ID:${group.id}`);
                                });
                            }
                            
                            // æ¯”è¾ƒå†…å­˜å’Œä¸–ç•Œä¹¦æ•°æ®æ˜¯å¦ä¸€è‡´
                            console.log(`ğŸ“Š æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥:`);
                            if (contactGroups.length === worldbookGroups.length) {
                                console.log(`  âœ… åˆ†ç»„æ•°é‡ä¸€è‡´: ${contactGroups.length}`);
                            } else {
                                console.warn(`  âš ï¸ åˆ†ç»„æ•°é‡ä¸ä¸€è‡´: å†…å­˜${contactGroups.length} vs ä¸–ç•Œä¹¦${worldbookGroups.length}`);
                            }
                            
                        } catch (parseError) {
                            console.error(`  âŒ è§£æä¸–ç•Œä¹¦æ¡ç›®å¤±è´¥:`, parseError);
                        }
                    } else {
                        console.warn(`  âš ï¸ æœªæ‰¾åˆ°ä¸–ç•Œä¹¦æ¡ç›®: ${comment}`);
                    }
                    
                    // æ˜¾ç¤ºæ€»ç»“
                    const summary = `
ğŸ” åˆ†ç»„æ•°æ®åŒæ­¥çŠ¶æ€:
- è§’è‰²ID: ${charId}  
- å†…å­˜åˆ†ç»„æ•°: ${contactGroups.length}ä¸ª
- ä¸–ç•Œä¹¦æ¡ç›®: ${targetEntry ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}
- æ•°æ®åŒæ­¥: ${targetEntry ? 'éœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥è¯¦ç»†æ—¥å¿—' : 'âŒ ä¸–ç•Œä¹¦æ¡ç›®ç¼ºå¤±'}

è¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—`;
                    
                    alert(summary);
                    
                } catch (error) {
                    console.error('åˆ†ç»„æ•°æ®åŒæ­¥æ£€æŸ¥å¤±è´¥:', error);
                }
            };
            
            /**
             * *** æ–°å¢ï¼šæµ‹è¯•åˆ†ç»„åŠŸèƒ½çš„å®Œæ•´æ€§ ***
             */
            window.QQ_Test_Group_Functions = async function() {
                console.log('=== ğŸ§ª æµ‹è¯•åˆ†ç»„åŠŸèƒ½å¼€å§‹ ===');
                
                try {
                    const characterId = getCurrentCharacterId() || 'default';
                    console.log(`æµ‹è¯•è§’è‰²ID: ${characterId}`);
                    
                    // 1. æµ‹è¯•åŠ è½½åŠŸèƒ½
                    console.log('1ï¸âƒ£ æµ‹è¯•åˆ†ç»„åŠ è½½åŠŸèƒ½...');
                    await QQ_LoadContactGroups(); // ä¿®å¤ï¼šæµ‹è¯•åˆ†ç»„åŠŸèƒ½åº”è¯¥è°ƒç”¨åˆ†ç»„åŠ è½½å‡½æ•°
                    console.log(`âœ… åŠ è½½æµ‹è¯•å®Œæˆï¼Œå½“å‰åˆ†ç»„æ•°é‡: ${contactGroups.length}`);
                    
                    // 2. æµ‹è¯•ä¸–ç•Œä¹¦æŸ¥æ‰¾åŠŸèƒ½
                    console.log('2ï¸âƒ£ æµ‹è¯•ä¸–ç•Œä¹¦æŸ¥æ‰¾åŠŸèƒ½...');
                    const expectedComment = `QQ_åˆ†ç»„å¤‡ä»½_${characterId}`;
                    const existingEntry = entries ? entries.find(entry => entry.comment === expectedComment) : null;
                    if (existingEntry) {
                        console.log(`âœ… æ‰¾åˆ°ä¸–ç•Œä¹¦æ¡ç›®: ${expectedComment}`);
                        console.log('æ¡ç›®å†…å®¹é¢„è§ˆ:', existingEntry.content.substring(0, 100) + '...');
                    } else {
                        console.log(`âš ï¸ æœªæ‰¾åˆ°ä¸–ç•Œä¹¦æ¡ç›®: ${expectedComment}`);
                    }
                    
                    // 3. æµ‹è¯•ä¿å­˜åŠŸèƒ½
                    console.log('3ï¸âƒ£ æµ‹è¯•åˆ†ç»„ä¿å­˜åŠŸèƒ½...');
                    const originalLength = contactGroups.length;
                    const testGroup = {
                        id: 'test_group_' + Date.now(),
                        name: 'æµ‹è¯•åˆ†ç»„_' + Date.now(),
                        contacts: [],
                        collapsed: false,
                        order: 999
                    };
                    
                    contactGroups.push(testGroup);
                    const saveResult = await saveGroupsToStorage();
                    console.log(`ä¿å­˜æµ‹è¯•ç»“æœ: ${saveResult ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}`);
                    
                    // 4. æµ‹è¯•åˆ é™¤åŠŸèƒ½ï¼ˆç§»é™¤æµ‹è¯•åˆ†ç»„ï¼‰
                    console.log('4ï¸âƒ£ æµ‹è¯•åˆ†ç»„åˆ é™¤åŠŸèƒ½...');
                    contactGroups.splice(-1, 1); // ç§»é™¤æœ€åä¸€ä¸ªï¼ˆæµ‹è¯•åˆ†ç»„ï¼‰
                    const deleteResult = await saveGroupsToStorage();
                    console.log(`åˆ é™¤æµ‹è¯•ç»“æœ: ${deleteResult ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}`);
                    
                    // 5. éªŒè¯æœ€ç»ˆçŠ¶æ€
                    console.log('5ï¸âƒ£ éªŒè¯æœ€ç»ˆçŠ¶æ€...');
                    await QQ_LoadContactGroups(); // ä¿®å¤ï¼šéªŒè¯åˆ†ç»„çŠ¶æ€åº”è¯¥è°ƒç”¨åˆ†ç»„åŠ è½½å‡½æ•°
                    console.log(`âœ… æœ€ç»ˆåˆ†ç»„æ•°é‡: ${contactGroups.length}`);
                    
                    const summary = `
ğŸ“Š åˆ†ç»„åŠŸèƒ½æµ‹è¯•æ€»ç»“:
- è§’è‰²ID: ${characterId}
- åŠ è½½åŠŸèƒ½: ${contactGroups.length >= 0 ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'}
- ä¸–ç•Œä¹¦æ¡ç›®: ${existingEntry ? 'âœ… å­˜åœ¨' : 'âš ï¸ ä¸å­˜åœ¨'}
- ä¿å­˜åŠŸèƒ½: ${saveResult ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'}
- åˆ é™¤åŠŸèƒ½: ${deleteResult ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'}
- å½“å‰åˆ†ç»„æ•°: ${contactGroups.length}ä¸ª

${contactGroups.length > 0 ? 
'åˆ†ç»„è¯¦æƒ…: ' + contactGroups.map(g => `${g.name}(${g.contacts.length}äºº)`).join(', ') : 
'å½“å‰æ— åˆ†ç»„'}`;
                    
                    console.log(summary);
                    alert(summary);
                    
                } catch (error) {
                    console.error('åˆ†ç»„åŠŸèƒ½æµ‹è¯•å¤±è´¥:', error);
                    alert('åˆ†ç»„åŠŸèƒ½æµ‹è¯•å¤±è´¥: ' + error.message);
                }
                
                console.log('=== ğŸ§ª æµ‹è¯•åˆ†ç»„åŠŸèƒ½ç»“æŸ ===');
            };
            
            /**
             * æ˜¾ç¤ºä¸–ç•Œä¹¦æ•°æ®ç»Ÿè®¡
             */
            window.QQ_Show_WorldBook_Stats = function() {
                try {
                    if (!QQ_IsWorldBookAvailable()) {
                        console.log('âŒ ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨');
                        return;
                    }
                    
                    console.log('=== ä¸–ç•Œä¹¦æ•°æ®ç»Ÿè®¡ ===');
                    
                    const stats = {
                        æ€»æ¡ç›®æ•°: 0,
                        QQç›¸å…³æ¡ç›®: 0,
                        æ•°æ®ç±»å‹: {}
                    };
                    
                    if (worldbook && worldbook.entries) {
                        stats.æ€»æ¡ç›®æ•° = worldbook.entries.length;
                        
                        worldbook.entries.forEach(entry => {
                            if (entry.comment && entry.comment.includes('QQ_')) {
                                stats.QQç›¸å…³æ¡ç›®++;
                                
                                // ç»Ÿè®¡æ•°æ®ç±»å‹
                                if (entry.comment.includes('è”ç³»äºº')) {
                                    stats.æ•°æ®ç±»å‹.è”ç³»äºº = (stats.æ•°æ®ç±»å‹.è”ç³»äºº || 0) + 1;
                                } else if (entry.comment.includes('ç¾¤èŠ')) {
                                    stats.æ•°æ®ç±»å‹.ç¾¤èŠ = (stats.æ•°æ®ç±»å‹.ç¾¤èŠ || 0) + 1;
                                } else if (entry.comment.includes('æ¶ˆæ¯')) {
                                    stats.æ•°æ®ç±»å‹.æ¶ˆæ¯ = (stats.æ•°æ®ç±»å‹.æ¶ˆæ¯ || 0) + 1;
                                } else if (entry.comment.includes('åŠ¨æ€')) {
                                    stats.æ•°æ®ç±»å‹.åŠ¨æ€ = (stats.æ•°æ®ç±»å‹.åŠ¨æ€ || 0) + 1;
                                } else if (entry.comment.includes('äº’åŠ¨')) {
                                    stats.æ•°æ®ç±»å‹.äº’åŠ¨ç©ºé—´ = (stats.æ•°æ®ç±»å‹.äº’åŠ¨ç©ºé—´ || 0) + 1;
                                } else if (entry.comment.includes('åˆ†ç»„')) {
                                    stats.æ•°æ®ç±»å‹.åˆ†ç»„ = (stats.æ•°æ®ç±»å‹.åˆ†ç»„ || 0) + 1;
                                } else {
                                    stats.æ•°æ®ç±»å‹.å…¶ä»– = (stats.æ•°æ®ç±»å‹.å…¶ä»– || 0) + 1;
                                }
                            }
                        });
                    }
                    
                    console.log(stats);
                    
                    const message = `ğŸ“Š ä¸–ç•Œä¹¦æ•°æ®ç»Ÿè®¡
æ€»æ¡ç›®æ•°: ${stats.æ€»æ¡ç›®æ•°}
QQç›¸å…³æ¡ç›®: ${stats.QQç›¸å…³æ¡ç›®}

æ•°æ®ç±»å‹åˆ†å¸ƒ:
${Object.entries(stats.æ•°æ®ç±»å‹).map(([type, count]) => `â€¢ ${type}: ${count}ä¸ª`).join('\n')}`;
                    
                    alert(message);
                    
                } catch (error) {
                    console.error('æ˜¾ç¤ºä¸–ç•Œä¹¦ç»Ÿè®¡å¤±è´¥:', error);
                }
            };
            
            /**
             * æ‰‹åŠ¨è§¦å‘æ•°æ®åŒæ­¥
             */
            window.QQ_Manual_Sync_All_Data = function() {
                console.log('ğŸ”„ å¼€å§‹æ‰‹åŠ¨åŒæ­¥æ‰€æœ‰æ•°æ®åˆ°ä¸–ç•Œä¹¦...');
                QQ_SyncAllData();
            };
            
            // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æŸ¥ä¸–ç•Œä¹¦çŠ¶æ€
            $(document).ready(function() {
                setTimeout(() => {
                    console.log('ğŸ” æ£€æŸ¥ä¸–ç•Œä¹¦çŠ¶æ€...');
                    if (QQ_IsWorldBookAvailable()) {
                        console.log('âœ… ä¸–ç•Œä¹¦åŠŸèƒ½æ­£å¸¸');
                        // å¯é€‰ï¼šè‡ªåŠ¨åŠ è½½åˆ†ç»„æ•°æ®
                        if (typeof QQ_LoadContactGroups === 'function') {
                            QQ_LoadContactGroups().catch(error => {
                                console.error('è‡ªåŠ¨åŠ è½½åˆ†ç»„æ•°æ®å¤±è´¥:', error);
                            });
                        }
                    } else {
                        console.warn('âš ï¸ ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨ï¼Œæ•°æ®ä¿å­˜å¯èƒ½å—å½±å“');
                    }
                }, 2000);
            });
            
            // ===== ç”¨æˆ·æ¶ˆæ¯é•¿æŒ‰åŠŸèƒ½å®ç° =====
            
            /**
             * é•¿æŒ‰åŠŸèƒ½å…¨å±€å˜é‡
             */
            let longPressTimer = null;
            let isLongPressing = false;
            let batchDeleteMode = false;
            let selectedMessages = new Set();
            
            /**
             * ä¸»åŠ¨æ¶ˆæ¯æœªè¯»çŠ¶æ€ç®¡ç†
             * (å…¨å±€å˜é‡å·²åœ¨æ–‡ä»¶å¼€å¤´å£°æ˜)
             */
            
            /**
             * å¢åŠ è§’è‰²çš„æœªè¯»æ¶ˆæ¯è®¡æ•°
             * @param {string} characterName - è§’è‰²å
             */
            function QQ_IncrementUnreadCount(characterName) {
                const currentCount = proactiveMessageUnreadCounts.get(characterName) || 0;
                proactiveMessageUnreadCounts.set(characterName, currentCount + 1);
                console.log(`ğŸ“ˆ ${characterName} æœªè¯»æ¶ˆæ¯è®¡æ•°: ${currentCount + 1}`);
                
                // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                QQ_UpdateUnreadBadge(characterName);
            }
            
            /**
             * æ¸…é™¤è§’è‰²çš„æœªè¯»æ¶ˆæ¯è®¡æ•°
             * @param {string} characterName - è§’è‰²å
             */
            function QQ_ClearUnreadCount(characterName) {
                proactiveMessageUnreadCounts.delete(characterName);
                console.log(`ğŸ”„ å·²æ¸…é™¤ ${characterName} çš„æœªè¯»æ¶ˆæ¯è®¡æ•°`);
                
                // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                QQ_UpdateUnreadBadge(characterName);
            }
            
            /**
             * æ›´æ–°èŠå¤©åˆ—è¡¨ä¸­çš„æœªè¯»çº¢ç‚¹æ˜¾ç¤º
             * @param {string} characterName - è§’è‰²å
             */
            function QQ_UpdateUnreadBadge(characterName) {
                const unreadCount = proactiveMessageUnreadCounts.get(characterName) || 0;
                
                // æŸ¥æ‰¾å¯¹åº”çš„èŠå¤©åˆ—è¡¨é¡¹
                const $chatItem = $(`.QQ_home_usermsg[data-name="${characterName}"]`);
                if ($chatItem.length === 0) {
                    console.log(`âš ï¸ æœªæ‰¾åˆ° ${characterName} çš„èŠå¤©åˆ—è¡¨é¡¹`);
                    return;
                }
                
                const $badge = $chatItem.find('.QQ_home_usermsg_new');
                
                if (unreadCount > 0) {
                    // æ˜¾ç¤ºçº¢ç‚¹å’Œæ•°é‡
                    $badge.text(unreadCount).show();
                    console.log(`ğŸ”´ æ˜¾ç¤º ${characterName} çš„æœªè¯»çº¢ç‚¹: ${unreadCount}`);
                } else {
                    // éšè—çº¢ç‚¹
                    $badge.hide();
                    console.log(`âšª éšè— ${characterName} çš„æœªè¯»çº¢ç‚¹`);
                }
            }
            
            /**
             * å½“ç”¨æˆ·åˆ‡æ¢åˆ°èŠå¤©ç•Œé¢æ—¶ï¼Œæ¸…é™¤å½“å‰èŠå¤©çš„æœªè¯»è®¡æ•°
             * @param {string} characterName - è§’è‰²å
             */
            function QQ_MarkMessagesAsRead(characterName) {
                const hadUnread = proactiveMessageUnreadCounts.has(characterName);
                if (hadUnread) {
                    QQ_ClearUnreadCount(characterName);
                    console.log(`âœ… å·²æ ‡è®° ${characterName} çš„æ¶ˆæ¯ä¸ºå·²è¯»`);
                }
            }
            
            /**
             * åˆå§‹åŒ–ç”¨æˆ·æ¶ˆæ¯é•¿æŒ‰åŠŸèƒ½
             */
            function QQ_InitMessageLongPress() {
                console.log('ğŸ”§ åˆå§‹åŒ–ç”¨æˆ·æ¶ˆæ¯é•¿æŒ‰åŠŸèƒ½');
                
                // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç›‘å¬æ‰€æœ‰ç”¨æˆ·æ¶ˆæ¯çš„é•¿æŒ‰äº‹ä»¶
                $(document).on('touchstart mousedown', '.QQ_chat_mymsg', function(e) {
                    const $messageElement = $(this);
                    console.log('ğŸ”¥ ç”¨æˆ·æ¶ˆæ¯è¢«æŒ‰ä¸‹:', $messageElement[0]);
                    
                    // é˜»æ­¢å…¶ä»–äº‹ä»¶
                    e.preventDefault();
                    
                    isLongPressing = false;
                    
                    // è®¾ç½®é•¿æŒ‰è®¡æ—¶å™¨ï¼ˆ800msï¼‰
                    longPressTimer = setTimeout(() => {
                        isLongPressing = true;
                        console.log('â° é•¿æŒ‰æ—¶é—´åˆ°ï¼Œæ˜¾ç¤ºèœå•');
                        QQ_ShowMessageLongPressMenu($messageElement, e);
                    }, 800);
                });
                
                // æ¸…é™¤é•¿æŒ‰è®¡æ—¶å™¨
                $(document).on('touchend mouseup touchmove mousemove', '.QQ_chat_mymsg', function(e) {
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                });
                
                // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
                $(document).on('click', function(e) {
                    if (!$(e.target).closest('.long-press-menu, .QQ_chat_mymsg').length) {
                        QQ_HideMessageLongPressMenu();
                    }
                });
            }
            
            /**
             * æ˜¾ç¤ºé•¿æŒ‰èœå•
             */
            function QQ_ShowMessageLongPressMenu($messageElement, event) {
                console.log('ğŸ“± æ˜¾ç¤ºé•¿æŒ‰èœå•');
                
                // ç§»é™¤å·²å­˜åœ¨çš„èœå•
                QQ_HideMessageLongPressMenu();
                
                // è·å–è§¦æ‘¸/é¼ æ ‡ä½ç½®
                const clientX = event.type === 'touchstart' ? event.originalEvent.touches[0].clientX : event.clientX;
                const clientY = event.type === 'touchstart' ? event.originalEvent.touches[0].clientY : event.clientY;
                
                // åˆ›å»ºèœå•
                const menuHtml = `
                    <div class="long-press-menu" id="messageLongPressMenu">
                        <div class="long-press-menu-item edit" data-action="edit">
                            <span>âœï¸</span>
                            <span>ç¼–è¾‘</span>
                        </div>
                        <div class="long-press-menu-item delete" data-action="delete">
                            <span>ğŸ—‘ï¸</span>
                            <span>åˆ é™¤</span>
                        </div>
                    </div>
                `;
                
                $('body').append(menuHtml);
                
                const $menu = $('#messageLongPressMenu');
                
                // è°ƒæ•´èœå•ä½ç½®ï¼Œç¡®ä¿ä¸è¶…å‡ºå±å¹•
                let menuX = clientX;
                let menuY = clientY;
                
                const menuWidth = $menu.outerWidth();
                const menuHeight = $menu.outerHeight();
                const windowWidth = $(window).width();
                const windowHeight = $(window).height();
                
                if (menuX + menuWidth > windowWidth) {
                    menuX = windowWidth - menuWidth - 10;
                }
                if (menuY + menuHeight > windowHeight) {
                    menuY = menuY - menuHeight - 10;
                }
                
                $menu.css({
                    left: menuX + 'px',
                    top: menuY + 'px'
                });
                
                // ç»‘å®šèœå•é¡¹ç‚¹å‡»äº‹ä»¶
                $menu.find('.long-press-menu-item').on('click', function() {
                    const action = $(this).data('action');
                    QQ_HandleMessageAction(action, $messageElement);
                    QQ_HideMessageLongPressMenu();
                });
                
                // æ·»åŠ è½»å¾®çš„å¼¹å‡ºåŠ¨ç”»
                $menu.css({
                    opacity: 0,
                    transform: 'scale(0.8)'
                }).animate({
                    opacity: 1
                }, 200).css('transform', 'scale(1)');
            }
            
            /**
             * éšè—é•¿æŒ‰èœå•
             */
            function QQ_HideMessageLongPressMenu() {
                $('#messageLongPressMenu').remove();
            }
            
            /**
             * å¤„ç†æ¶ˆæ¯æ“ä½œ
             */
            function QQ_HandleMessageAction(action, $messageElement) {
                console.log(`ğŸ¯ å¤„ç†æ¶ˆæ¯æ“ä½œ: ${action}`);
                
                switch (action) {
                    case 'edit':
                        QQ_EditMessage($messageElement);
                        break;
                    case 'delete':
                        QQ_EnterBatchDeleteMode($messageElement);
                        break;
                }
            }
            
            /**
             * ç¼–è¾‘æ¶ˆæ¯åŠŸèƒ½
             */
            function QQ_EditMessage($messageElement) {
                console.log('âœï¸ ç¼–è¾‘æ¶ˆæ¯');
                
                // æå–å½“å‰æ¶ˆæ¯å†…å®¹
                const messageContent = $messageElement.find('div[style*="grid-column:2"]').text().trim();
                
                // åˆ›å»ºç¼–è¾‘å¯¹è¯æ¡†
                const editDialogHtml = `
                    <div class="message-edit-overlay" id="messageEditOverlay">
                        <div class="message-edit-dialog">
                            <h3>ç¼–è¾‘æ¶ˆæ¯</h3>
                            <textarea id="messageEditTextarea" placeholder="è¾“å…¥æ–°çš„æ¶ˆæ¯å†…å®¹...">${messageContent}</textarea>
                            <div class="button-group">
                                <button class="cancel-btn" onclick="QQ_CancelEditMessage()">å–æ¶ˆ</button>
                                <button class="save-btn" onclick="QQ_SaveEditedMessage()">ä¿å­˜</button>
                            </div>
                        </div>
                    </div>
                `;
                
                $('body').append(editDialogHtml);
                
                // å­˜å‚¨å½“å‰ç¼–è¾‘çš„æ¶ˆæ¯å…ƒç´ 
                window.currentEditingMessage = $messageElement;
                
                // èšç„¦åˆ°æ–‡æœ¬æ¡†
                setTimeout(() => {
                    $('#messageEditTextarea').focus();
                }, 100);
                
                // ç‚¹å‡»é®ç½©å…³é—­
                $('#messageEditOverlay').on('click', function(e) {
                    if (e.target === this) {
                        QQ_CancelEditMessage();
                    }
                });
            }
            
            /**
             * å–æ¶ˆç¼–è¾‘æ¶ˆæ¯
             */
            function QQ_CancelEditMessage() {
                $('#messageEditOverlay').remove();
                window.currentEditingMessage = null;
            }
            
            /**
             * ä¿å­˜ç¼–è¾‘çš„æ¶ˆæ¯
             */
            async function QQ_SaveEditedMessage() {
                const newContent = $('#messageEditTextarea').val().trim();
                
                if (!newContent) {
                    alert('æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º');
                    return;
                }
                
                const $messageElement = window.currentEditingMessage;
                
                if ($messageElement) {
                    // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                    $messageElement.find('div[style*="grid-column:2"]').html(newContent);
                    
                    // åŒæ­¥æ›´æ–°åˆ°ä¸–ç•Œä¹¦
                    await QQ_UpdateMessageInWorldBook($messageElement, newContent);
                    
                    console.log('âœ… æ¶ˆæ¯ç¼–è¾‘å®Œæˆ');
                }
                
                QQ_CancelEditMessage();
            }
            
            /**
             * è¿›å…¥æ‰¹é‡åˆ é™¤æ¨¡å¼
             */
            function QQ_EnterBatchDeleteMode($triggerElement) {
                console.log('ğŸ—‘ï¸ è¿›å…¥æ‰¹é‡åˆ é™¤æ¨¡å¼');
                
                batchDeleteMode = true;
                selectedMessages.clear();
                
                // æ·»åŠ æ‰¹é‡åˆ é™¤æ ·å¼
                $('.QQ_chat_page').addClass('batch-delete-mode');
                
                // ä¸ºæ‰€æœ‰ç”¨æˆ·æ¶ˆæ¯æ·»åŠ å¤é€‰æ¡†
                $('.QQ_chat_mymsg').each(function() {
                    const $message = $(this);
                    const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    $message.attr('data-message-id', messageId);
                    
                    const checkbox = $('<input type="checkbox" class="batch-delete-checkbox">');
                    checkbox.attr('data-message-id', messageId);
                    $message.prepend(checkbox);
                });
                
                // é»˜è®¤é€‰ä¸­è§¦å‘çš„æ¶ˆæ¯
                const triggerMessageId = $triggerElement.attr('data-message-id');
                if (triggerMessageId) {
                    $(`input[data-message-id="${triggerMessageId}"]`).prop('checked', true);
                    selectedMessages.add(triggerMessageId);
                }
                
                // æ˜¾ç¤ºæ‰¹é‡åˆ é™¤å·¥å…·æ 
                QQ_ShowBatchDeleteToolbar();
                
                // ç»‘å®šå¤é€‰æ¡†äº‹ä»¶
                $('.batch-delete-checkbox').on('change', function() {
                    const messageId = $(this).data('message-id');
                    if ($(this).is(':checked')) {
                        selectedMessages.add(messageId);
                    } else {
                        selectedMessages.delete(messageId);
                    }
                    QQ_UpdateBatchDeleteToolbar();
                });
            }
            
            /**
             * æ˜¾ç¤ºæ‰¹é‡åˆ é™¤å·¥å…·æ 
             */
            function QQ_ShowBatchDeleteToolbar() {
                const toolbarHtml = `
                    <div class="batch-delete-toolbar" id="batchDeleteToolbar">
                        <span id="selectedCount">å·²é€‰æ‹© ${selectedMessages.size} æ¡æ¶ˆæ¯</span>
                        <button class="cancel-btn" onclick="QQ_ExitBatchDeleteMode()">å–æ¶ˆ</button>
                        <button class="delete-btn" onclick="QQ_DeleteSelectedMessages()">åˆ é™¤</button>
                    </div>
                `;
                
                $('body').append(toolbarHtml);
            }
            
            /**
             * æ›´æ–°æ‰¹é‡åˆ é™¤å·¥å…·æ 
             */
            function QQ_UpdateBatchDeleteToolbar() {
                $('#selectedCount').text(`å·²é€‰æ‹© ${selectedMessages.size} æ¡æ¶ˆæ¯`);
            }
            
            /**
             * é€€å‡ºæ‰¹é‡åˆ é™¤æ¨¡å¼
             */
            function QQ_ExitBatchDeleteMode() {
                console.log('âŒ é€€å‡ºæ‰¹é‡åˆ é™¤æ¨¡å¼');
                
                batchDeleteMode = false;
                selectedMessages.clear();
                
                // ç§»é™¤æ ·å¼å’Œå¤é€‰æ¡†
                $('.QQ_chat_page').removeClass('batch-delete-mode');
                $('.batch-delete-checkbox').remove();
                $('#batchDeleteToolbar').remove();
            }
            
            /**
             * åˆ é™¤é€‰ä¸­çš„æ¶ˆæ¯
             */
            async function QQ_DeleteSelectedMessages() {
                if (selectedMessages.size === 0) {
                    alert('è¯·é€‰æ‹©è¦åˆ é™¤çš„æ¶ˆæ¯');
                    return;
                }
                
                const confirmMessage = `ç¡®å®šè¦åˆ é™¤ ${selectedMessages.size} æ¡æ¶ˆæ¯å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`;
                if (!confirm(confirmMessage)) {
                    return;
                }
                
                console.log(`ğŸ—‘ï¸ åˆ é™¤ ${selectedMessages.size} æ¡é€‰ä¸­æ¶ˆæ¯`);
                
                // åˆ é™¤ç•Œé¢ä¸­çš„æ¶ˆæ¯
                for (const messageId of selectedMessages) {
                    $(`.QQ_chat_mymsg[data-message-id="${messageId}"]`).remove();
                }
                
                // åŒæ­¥æ›´æ–°åˆ°ä¸–ç•Œä¹¦
                await QQ_DeleteMessagesFromWorldBook(selectedMessages);
                
                console.log('âœ… æ¶ˆæ¯åˆ é™¤å®Œæˆ');
                
                // é€€å‡ºæ‰¹é‡åˆ é™¤æ¨¡å¼
                QQ_ExitBatchDeleteMode();
            }
            
            /**
             * æ›´æ–°ä¸–ç•Œä¹¦ä¸­çš„æ¶ˆæ¯
             */
            async function QQ_UpdateMessageInWorldBook($messageElement, newContent) {
                // è¿™é‡Œéœ€è¦æ ¹æ®å®é™…çš„ä¸–ç•Œä¹¦APIå®ç°
                console.log('ğŸ”„ æ›´æ–°ä¸–ç•Œä¹¦ä¸­çš„æ¶ˆæ¯:', newContent);
                // TODO: å®ç°å…·ä½“çš„ä¸–ç•Œä¹¦æ›´æ–°é€»è¾‘
            }
            
            /**
             * ä»ä¸–ç•Œä¹¦ä¸­åˆ é™¤æ¶ˆæ¯
             */
            async function QQ_DeleteMessagesFromWorldBook(messageIds) {
                // è¿™é‡Œéœ€è¦æ ¹æ®å®é™…çš„ä¸–ç•Œä¹¦APIå®ç°
                console.log('ğŸ—‘ï¸ ä»ä¸–ç•Œä¹¦ä¸­åˆ é™¤æ¶ˆæ¯:', messageIds);
                // TODO: å®ç°å…·ä½“çš„ä¸–ç•Œä¹¦åˆ é™¤é€»è¾‘
            }
            
            // ===== ç”¨æˆ·æ¶ˆæ¯é•¿æŒ‰åŠŸèƒ½åˆå§‹åŒ– =====
            $(document).ready(function() {
                QQ_InitMessageLongPress();
            });
            
            /**
             * ===== ä¿®å¤ç”¨æˆ·åä¸‹æ‹‰èœå•åŠŸèƒ½ =====
             */
            
            /**
             * *** ä¿®æ”¹ï¼šç‚¹å‡»ç”¨æˆ·åæ˜¾ç¤ºç²¾çµ ***
             */
            function QQ_ToggleUserMenu() {
                console.log('ç‚¹å‡»ç”¨æˆ·åï¼Œæ˜¾ç¤ºç”¨æˆ·ç²¾çµ');
                
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç²¾çµ
                let existingSpirit = document.getElementById('QQ_user_spirit');
                if (existingSpirit) {
                    existingSpirit.remove();
                    return;
                }
                
                QQ_ShowUserSpirit();
            }
            
            /**
             * *** æ–°å¢ï¼šæ˜¾ç¤ºç”¨æˆ·ç²¾çµ ***
             */
            function QQ_ShowUserSpirit() {
                // ç§»é™¤ç°æœ‰ç²¾çµ
                const existingSpirit = document.getElementById('QQ_user_spirit');
                if (existingSpirit) {
                    existingSpirit.remove();
                }
                
                // è·å–ç”¨æˆ·åå’Œå¤´åƒ
                const userName = QQ_GetUserName() || 'User';
                const userAvatar = QQ_GetUserAvatar() || 'default_avatar.png';
                
                // åˆ›å»ºç²¾çµæŒ‰é’®
                const spirit = document.createElement('div');
                spirit.id = 'QQ_user_spirit';
                spirit.style.cssText = `
                    position: fixed;
                    top: 120px;
                    right: 30px;
                    width: 60px;
                    height: 60px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    border-radius: 50%;
                    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
                    cursor: pointer;
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    animation: userSpiritPulse 2s infinite ease-in-out;
                    border: 3px solid white;
                    transition: all 0.3s ease;
                `;
                
                // ç²¾çµå†…å®¹ï¼ˆç”¨æˆ·å¤´åƒæˆ–å›¾æ ‡ï¼‰
                spirit.innerHTML = `
                    <img src="${userAvatar}" alt="${userName}" style="
                        width: 45px;
                        height: 45px;
                        border-radius: 50%;
                        object-fit: cover;
                    " onerror="this.outerHTML='<div style=&quot;color: white; font-size: 24px;&quot;>ğŸ‘¤</div>';">
                `;
                
                // ç²¾çµæ‚¬åœæ•ˆæœ
                spirit.addEventListener('mouseenter', () => {
                    spirit.style.transform = 'scale(1.1)';
                    spirit.style.boxShadow = '0 8px 25px rgba(102, 126, 234, 0.6)';
                });
                
                spirit.addEventListener('mouseleave', () => {
                    spirit.style.transform = 'scale(1)';
                    spirit.style.boxShadow = '0 6px 20px rgba(102, 126, 234, 0.4)';
                });
                
                // ç‚¹å‡»ç²¾çµæ˜¾ç¤ºç”¨æˆ·é¢æ¿
                spirit.addEventListener('click', (e) => {
                    e.stopPropagation();
                    QQ_ShowUserSpiritPanel();
                    spirit.remove();
                });
                
                // æ·»åŠ ç²¾çµåŠ¨ç”»æ ·å¼
                if (!document.getElementById('user_spirit_styles')) {
                    const style = document.createElement('style');
                    style.id = 'user_spirit_styles';
                    style.textContent = `
                        @keyframes userSpiritPulse {
                            0%, 100% {
                                transform: scale(1);
                            }
                            50% {
                                transform: scale(1.05);
                            }
                        }
                        
                        @keyframes userSpiritSlideIn {
                            from {
                                opacity: 0;
                                transform: translateX(100px);
                            }
                            to {
                                opacity: 1;
                                transform: translateX(0);
                            }
                        }
                        
                        #QQ_user_spirit {
                            animation: userSpiritSlideIn 0.3s ease, userSpiritPulse 2s infinite ease-in-out 0.3s;
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                // æ·»åŠ åˆ°é¡µé¢
                document.body.appendChild(spirit);
                
                // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
                setTimeout(() => {
                    if (spirit && spirit.parentNode) {
                        spirit.style.opacity = '0';
                        spirit.style.transform = 'translateX(100px)';
                        setTimeout(() => {
                            if (spirit.parentNode) {
                                spirit.remove();
                            }
                        }, 300);
                    }
                }, 5000);
                
                console.log('ç”¨æˆ·ç²¾çµå·²æ˜¾ç¤º');
            }
            
            /**
             * *** æ–°å¢ï¼šè·å–ç”¨æˆ·å ***
             */
            function QQ_GetUserName() {
                // å°è¯•å¤šç§æ–¹å¼è·å–ç”¨æˆ·å
                const methods = [
                    () => UserName, // å…¨å±€å˜é‡
                    () => document.getElementById('QQ_home_UserName')?.textContent?.replace(/\*\*/g, '').trim(),
                    () => document.getElementById('QQ_message_list_UserName')?.textContent?.replace(/\*\*/g, '').trim(),
                    () => window.name || window.user || 'User'
                ];
                
                for (const method of methods) {
                    try {
                        const result = method();
                        if (result && typeof result === 'string' && result.length > 0) {
                            return result;
                        }
                    } catch (error) {
                        // å¿½ç•¥é”™è¯¯ï¼Œå°è¯•ä¸‹ä¸€ä¸ªæ–¹æ³•
                    }
                }
                
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç”¨æˆ·åï¼Œè¿”å›é»˜è®¤å€¼
                return 'User';
            }
            
            /**
             * *** æ–°å¢ï¼šè·å–ç”¨æˆ·å¤´åƒ ***
             */
            function QQ_GetUserAvatar() {
                // å°è¯•å¤šç§æ–¹å¼è·å–ç”¨æˆ·å¤´åƒ
                const methods = [
                    () => window.userAvatarPath,
                    () => window.selectedAvatarData,
                    () => document.querySelector('#QQ_home_UserAvatar img')?.src,
                    () => document.querySelector('.user-avatar img')?.src,
                    () => document.querySelector('[data-user-avatar]')?.src
                ];
                
                for (const method of methods) {
                    try {
                        const result = method();
                        if (result && typeof result === 'string' && result !== 'default_avatar.png') {
                            return result;
                        }
                    } catch (error) {
                        // å¿½ç•¥é”™è¯¯ï¼Œå°è¯•ä¸‹ä¸€ä¸ªæ–¹æ³•
                    }
                }
                
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¤´åƒï¼Œè¿”å›é»˜è®¤å€¼
                return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiM2NjdlZWEiLz4KPHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4PSI4IiB5PSI4Ij4KPHBhdGggZD0iTTEyIDEyQzE0LjIwOTEgMTIgMTYgMTAuMjA5MSAxNiA4QzE2IDUuNzkwODYgMTQuMjA5MSA0IDEyIDRDOS43OTA4NiA0IDggNS43OTA4NiA4IDhDOCAxMC4yMDkxIDkuNzkwODYgMTIgMTIgMTJaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTIgMTRDOC4xMzQwMSAxNCA1IDE3LjEzNDAxIDUgMjFIMTlDMTkgMTcuMTM0MDEgMTUuODY2IDE0IDEyIDE0WiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+Cgo8L3N2Zz4K';
            }
            
            /**
             * *** æ–°å¢ï¼šæ˜¾ç¤ºç”¨æˆ·ç²¾çµé¢æ¿ ***
             */
            function QQ_ShowUserSpiritPanel() {
                console.log('æ˜¾ç¤ºç”¨æˆ·ç²¾çµé¢æ¿');
                
                // ç§»é™¤ç°æœ‰é¢æ¿
                $('.QQ_user_spirit_panel').remove();
                
                const userName = QQ_GetUserName() || 'User';
                const userAvatar = QQ_GetUserAvatar();
                
                // åˆ›å»ºé¢æ¿HTML
                const panelHtml = `
                    <div class="QQ_user_spirit_panel" style="
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: white;
                        border-radius: 15px;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                        z-index: 99999999;
                        overflow: hidden;
                        animation: userPanelSlideIn 0.3s ease;
                        max-width: 90%;
                        max-height: 80%;
                        width: 350px;
                    ">
                        <div class="panel-header" style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 20px;
                            text-align: center;
                            font-weight: 600;
                        ">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                                <img src="${userAvatar}" alt="${userName}" style="
                                    width: 40px;
                                    height: 40px;
                                    border-radius: 50%;
                                    border: 2px solid white;
                                " onerror="this.outerHTML='<div style=&quot;width: 40px; height: 40px; border-radius: 50%; border: 2px solid white; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 20px;&quot;>ğŸ‘¤</div>';">
                                <span style="font-size: 16px;">ğŸ‘‘ ${userName} çš„æ§åˆ¶é¢æ¿</span>
                            </div>
                        </div>
                        
                        <div class="panel-content" style="padding: 20px;">
                            <!-- ä¸»è¦åŠŸèƒ½åŒº -->
                            <div style="
                                display: grid;
                                grid-template-columns: 1fr 1fr;
                                gap: 10px;
                                margin-bottom: 15px;
                            ">
                                <button class="panel-btn" data-action="interactive_guide" style="
                                    background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
                                    border: none;
                                    color: white;
                                    padding: 12px 8px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 12px;
                                    font-weight: 500;
                                    transition: all 0.2s ease;
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                    gap: 4px;
                                ">
                                    <span style="font-size: 16px;">ğŸ’«</span>
                                    <span>äº’åŠ¨æŒ‡å—</span>
                                </button>
                                
                                <button class="panel-btn" data-action="phone_status" style="
                                    background: linear-gradient(135deg, #4FACFE 0%, #00F2FE 100%);
                                    border: none;
                                    color: white;
                                    padding: 12px 8px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 12px;
                                    font-weight: 500;
                                    transition: all 0.2s ease;
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                    gap: 4px;
                                ">
                                    <span style="font-size: 16px;">ğŸ“±</span>
                                    <span>æ‰‹æœºçŠ¶æ€</span>
                                </button>
                                
                                <button class="panel-btn" data-action="sync_data" style="
                                    background: linear-gradient(135deg, #43E97B 0%, #38F9D7 100%);
                                    border: none;
                                    color: white;
                                    padding: 12px 8px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 12px;
                                    font-weight: 500;
                                    transition: all 0.2s ease;
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                    gap: 4px;
                                ">
                                    <span style="font-size: 16px;">ğŸ”„</span>
                                    <span>åŒæ­¥æ•°æ®</span>
                                </button>
                                
                                <button class="panel-btn" data-action="settings" style="
                                    background: linear-gradient(135deg, #FA709A 0%, #FEE140 100%);
                                    border: none;
                                    color: white;
                                    padding: 12px 8px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 12px;
                                    font-weight: 500;
                                    transition: all 0.2s ease;
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                    gap: 4px;
                                ">
                                    <span style="font-size: 16px;">âš™ï¸</span>
                                    <span>è®¾å®š</span>
                                </button>
                            </div>
                            
                            <!-- æ–°å¢ï¼šå…¬å…±äº’åŠ¨ç©ºé—´ç®¡ç†åŒº -->
                            <div style="
                                border-top: 1px solid #e9ecef;
                                padding-top: 15px;
                                margin-bottom: 15px;
                            ">
                                <div style="
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    margin-bottom: 10px;
                                    font-size: 13px;
                                    font-weight: 600;
                                    color: #666;
                                ">
                                    <span style="
                                        display: inline-block;
                                        width: 16px;
                                        height: 16px;
                                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                        border-radius: 50%;
                                        color: white;
                                        text-align: center;
                                        line-height: 16px;
                                        font-size: 10px;
                                    ">ğŸ </span>
                                    <span>å…¬å…±äº’åŠ¨ç©ºé—´</span>
                                    <span style="
                                        background: #e9ecef;
                                        color: #666;
                                        padding: 2px 6px;
                                        border-radius: 8px;
                                        font-size: 10px;
                                        font-weight: 500;
                                        margin-left: auto;
                                    ">${Object.keys(QQ_InteractiveSpaces || {}).length}ä¸ª</span>
                                </div>
                                
                                <div style="
                                    display: grid;
                                    grid-template-columns: 1fr 1fr;
                                    gap: 8px;
                                ">
                                    <button class="panel-btn" data-action="view_public_spaces" style="
                                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                        border: none;
                                        color: white;
                                        padding: 10px 8px;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 11px;
                                        font-weight: 500;
                                        transition: all 0.2s ease;
                                        display: flex;
                                        flex-direction: column;
                                        align-items: center;
                                        gap: 3px;
                                    ">
                                        <span style="font-size: 14px;">ğŸ“‚</span>
                                        <span>äº’åŠ¨è®°å½•</span>
                                    </button>
                                    
                                    <button class="panel-btn" data-action="create_public_space" style="
                                        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                                        border: none;
                                        color: white;
                                        padding: 10px 8px;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 11px;
                                        font-weight: 500;
                                        transition: all 0.2s ease;
                                        display: flex;
                                        flex-direction: column;
                                        align-items: center;
                                        gap: 3px;
                                    ">
                                        <span style="font-size: 14px;">âœ¨</span>
                                        <span>åˆ›å»ºäº’åŠ¨</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ–°å¢ï¼šäº’åŠ¨ç¬¦å·æç¤º -->
                        <div class="interactive-tip" style="
                            padding: 12px 20px;
                            background: linear-gradient(135deg, #E8F5E8 0%, #F0F8FF 100%);
                            border-top: 1px solid #e9ecef;
                            font-size: 12px;
                            color: #666;
                            line-height: 1.4;
                        ">
                            <div style="
                                display: flex;
                                align-items: center;
                                gap: 8px;
                                margin-bottom: 6px;
                                font-weight: 500;
                            ">
                                <span style="
                                    display: inline-block;
                                    width: 16px;
                                    height: 16px;
                                    background: #4CAF50;
                                    border-radius: 50%;
                                    color: white;
                                    text-align: center;
                                    line-height: 16px;
                                    font-size: 10px;
                                ">ğŸ’¡</span>
                                <span style="color: #4CAF50;">å¿«é€Ÿäº’åŠ¨å°è´´å£«</span>
                            </div>
                            <div style="margin-left: 24px;">
                                åœ¨èŠå¤©ä¸­ä½¿ç”¨ <span style="
                                    background: #4CAF50;
                                    color: white;
                                    padding: 2px 6px;
                                    border-radius: 3px;
                                    font-family: monospace;
                                    font-weight: 600;
                                ">&&</span> ç¬¦å·å¯ä»¥ç›´æ¥è§¦å‘äº’åŠ¨å†…å®¹
                            </div>
                            <div style="margin-left: 24px; margin-top: 4px; color: #888;">
                                ä¾‹å¦‚ï¼š<code style="background: #f8f9fa; padding: 1px 4px; border-radius: 2px;">&&æƒ³è¦æ‹¥æŠ±ä½ </code>
                            </div>
                        </div>
                        
                        <div class="panel-actions" style="
                            padding: 20px;
                            background: #fafafa;
                            display: flex;
                            gap: 10px;
                        ">
                            <button class="close-panel-btn" style="
                                flex: 1;
                                background: #e9ecef;
                                border: none;
                                color: #666;
                                padding: 12px 16px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 13px;
                                font-weight: 500;
                                transition: all 0.2s ease;
                            ">
                                å…³é—­
                            </button>
                        </div>
                    </div>
                    
                    <style>
                        @keyframes userPanelSlideIn {
                            from {
                                opacity: 0;
                                transform: translate(-50%, -60%);
                            }
                            to {
                                opacity: 1;
                                transform: translate(-50%, -50%);
                            }
                        }
                        
                        .QQ_user_spirit_panel .panel-btn:hover {
                            transform: translateY(-2px);
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                        }
                    </style>
                `;
                
                // æ·»åŠ åˆ°é¡µé¢
                $('body').append(panelHtml);
                
                // ç»‘å®šäº‹ä»¶
                $('.QQ_user_spirit_panel').on('click', function(e) {
                    e.stopPropagation();
                    
                    const panelBtn = e.target.closest('.panel-btn');
                    const closePanelBtn = e.target.closest('.close-panel-btn');
                    
                    if (panelBtn) {
                        const action = panelBtn.getAttribute('data-action');
                        console.log(`ç‚¹å‡»ç”¨æˆ·é¢æ¿æŒ‰é’®: ${action}`);
                        
                        $('.QQ_user_spirit_panel').remove();
                        
                        switch (action) {
                            case 'interactive_guide':
                                QQ_ShowInteractiveGuide();
                                break;
                            case 'phone_status':
                                QQ_ShowPhoneStatus();
                                break;
                            case 'sync_data':
                                QQ_SyncAllData();
                                break;
                            case 'settings':
                                QQ_ShowInteractiveSettings();
                                break;
                            case 'view_public_spaces':
                                QQ_ShowPublicInteractiveSpaces();
                                break;
                            case 'create_public_space':
                                QQ_CreatePublicInteractiveSpace();
                                break;
                        }
                    } else if (closePanelBtn) {
                        $('.QQ_user_spirit_panel').remove();
                    }
                });
                
                // ç‚¹å‡»å¤–éƒ¨å…³é—­é¢æ¿
                $(document).one('click', function() {
                    $('.QQ_user_spirit_panel').remove();
                });
            }
            
            /**
             * *** æ–°å¢ï¼šæ›´æ–°ç²¾çµé¢æ¿ä¸­çš„äº’åŠ¨çŠ¶æ€æ˜¾ç¤º ***
             */
            function QQ_UpdateInteractiveStatus() {
                const statusContainer = $('#interactive-status-content');
                if (statusContainer.length === 0) return;
                
                try {
                    const settings = QQ_GetInteractiveSettings();
                    const symbolStatus = 'ğŸŸ¢ ç‰¹æ®Šç¬¦å· (&&)ï¼šæ°¸ä¹…å¯ç”¨';
                    const keywordStatus = settings.enableKeywordTrigger ? 
                        'ğŸŸ¢ å…³é”®è¯è§¦å‘ï¼šå·²å¯ç”¨' : 
                        'ğŸ”´ å…³é”®è¯è§¦å‘ï¼šå·²ç¦ç”¨';
                    const customCount = settings.customKeywords.length;
                    const customStatus = customCount > 0 ? 
                        `ğŸŸ¢ è‡ªå®šä¹‰å…³é”®è¯ï¼š${customCount}ä¸ª` : 
                        'âšª è‡ªå®šä¹‰å…³é”®è¯ï¼šæš‚æ— ';
                    
                    const statusHtml = `
                        <div>${symbolStatus}</div>
                        <div>${keywordStatus}</div>
                        <div>${customStatus}</div>
                        <div style="margin-top: 4px; color: #888;">
                            ç‚¹å‡»"è®¾å®š"æŒ‰é’®å¯ä¿®æ”¹å…³é”®è¯è§¦å‘è®¾ç½®
                        </div>
                    `;
                    
                    statusContainer.html(statusHtml);
                } catch (error) {
                    console.error('æ›´æ–°äº’åŠ¨çŠ¶æ€æ˜¾ç¤ºå¤±è´¥:', error);
                    statusContainer.html(`
                        <div>ğŸŸ¢ ç‰¹æ®Šç¬¦å· (&&)ï¼šæ°¸ä¹…å¯ç”¨</div>
                        <div>âšª å…³é”®è¯è§¦å‘ï¼šè·å–çŠ¶æ€å¤±è´¥</div>
                        <div style="margin-top: 4px; color: #888;">
                            ç‚¹å‡»"è®¾å®š"æŒ‰é’®é…ç½®äº’åŠ¨è§¦å‘
                        </div>
                    `);
                }
            }

            /**
             * *** æ–°å¢ï¼šæ˜¾ç¤ºç”¨æˆ·è®¾å®šèœå•ï¼ˆåŸä¸‹æ‹‰èœå•åŠŸèƒ½ï¼‰ ***
             */
            function QQ_ShowUserSettingsMenu() {
                console.log('æ˜¾ç¤ºç”¨æˆ·è®¾å®šèœå•');
                
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨èœå•
                let existingMenu = document.getElementById('QQ_user_dropdown_menu');
                if (existingMenu) {
                    existingMenu.remove();
                    return;
                }
                
                // åˆ›å»ºä¸‹æ‹‰èœå•
                const menu = document.createElement('div');
                menu.id = 'QQ_user_dropdown_menu';
                menu.style.cssText = `
                    position: fixed;
                    top: 70px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: white;
                    border-radius: 12px;
                    padding: 12px 0;
                    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
                    z-index: 9999;
                    min-width: 200px;
                    animation: fadeInDown 0.2s ease;
                    border: 1px solid #e0e0e0;
                `;
                
                // èœå•é¡¹æ•°æ®
                const menuItems = [
                    {
                        icon: 'ğŸ“Š',
                        text: 'ä¸–ç•Œä¹¦ç»Ÿè®¡',
                        action: () => {
                            QQ_Show_WorldBook_Stats();
                            menu.remove();
                        }
                    },
                    {
                        icon: 'ğŸ”„',
                        text: 'åŒæ­¥æ•°æ®',
                        action: () => {
                            QQ_Manual_Sync_All_Data();
                            menu.remove();
                        }
                    },
                    {
                        icon: 'ğŸ§ª',
                        text: 'æµ‹è¯•äº’åŠ¨æ£€æµ‹',
                        action: () => {
                            const testText = prompt('è¯·è¾“å…¥è¦æµ‹è¯•çš„æ–‡æœ¬:', 'æˆ‘æƒ³å’Œå¤§å®¶ä¸€èµ·æ‹¥æŠ±');
                            if (testText) {
                                QQ_Test_Interactive_Detection(testText);
                            }
                            menu.remove();
                        }
                    },
                    {
                        icon: 'âš™ï¸',
                        text: 'æ‰‹æœºç•Œé¢è®¾ç½®',
                        action: () => {
                            alert('è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...');
                            menu.remove();
                        }
                    },
                    {
                        icon: 'ğŸ“±',
                        text: 'ç•Œé¢ä¿¡æ¯',
                        action: () => {
                            const info = `æ‰‹æœºç•Œé¢çŠ¶æ€:
- å½“å‰ç”¨æˆ·: ${QQ_GetUserName()}
- å½“å‰è§’è‰²: ${getCurrentCharacterId() || 'æœªçŸ¥'}
- ä¸–ç•Œä¹¦çŠ¶æ€: ${QQ_IsWorldBookAvailable() ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}
- è”ç³»äººåˆ†ç»„: ${contactGroups ? contactGroups.length : 0} ä¸ª
- äº’åŠ¨ç©ºé—´: ${Object.keys(QQ_InteractiveSpaces || {}).length} ä¸ªå…¬å…± + ${Object.keys(QQ_CharacterSpaces || {}).reduce((sum, char) => sum + Object.keys(QQ_CharacterSpaces[char]).length, 0)} ä¸ªç§äºº`;
                            alert(info);
                            menu.remove();
                        }
                    }
                ];
                
                // åˆ›å»ºèœå•é¡¹
                menuItems.forEach((item, index) => {
                    const menuItem = document.createElement('div');
                    menuItem.style.cssText = `
                        padding: 12px 20px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        font-size: 14px;
                        color: #333;
                        transition: background-color 0.2s ease;
                        ${index > 0 ? 'border-top: 1px solid #f0f0f0;' : ''}
                    `;
                    
                    menuItem.innerHTML = `
                        <span style="margin-right: 12px; font-size: 16px;">${item.icon}</span>
                        <span>${item.text}</span>
                    `;
                    
                    // æ‚¬åœæ•ˆæœ
                    menuItem.addEventListener('mouseenter', () => {
                        menuItem.style.backgroundColor = '#f5f5f5';
                    });
                    
                    menuItem.addEventListener('mouseleave', () => {
                        menuItem.style.backgroundColor = 'transparent';
                    });
                    
                    // ç‚¹å‡»äº‹ä»¶
                    menuItem.addEventListener('click', item.action);
                    
                    menu.appendChild(menuItem);
                });
                
                // æ·»åŠ åŠ¨ç”»æ ·å¼
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes fadeInDown {
                        from {
                            opacity: 0;
                            transform: translateX(-50%) translateY(-10px);
                        }
                        to {
                            opacity: 1;
                            transform: translateX(-50%) translateY(0);
                        }
                    }
                `;
                document.head.appendChild(style);
                
                // æ·»åŠ èœå•åˆ°é¡µé¢
                document.body.appendChild(menu);
                
                // ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•
                const closeMenu = (e) => {
                    if (!menu.contains(e.target) && !document.getElementById('QQ_message_list_UserName').contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                };
                
                setTimeout(() => {
                    document.addEventListener('click', closeMenu);
                }, 100);
            }
            
            /**
             * *** æ–°å¢ï¼šæ˜¾ç¤ºæ‰‹æœºçŠ¶æ€ ***
             */
            function QQ_ShowPhoneStatus() {
                console.log('æ˜¾ç¤ºæ‰‹æœºçŠ¶æ€');
                
                const info = `ğŸ“± æ‰‹æœºç•Œé¢çŠ¶æ€ä¿¡æ¯

ğŸ‘¤ å½“å‰ç”¨æˆ·: ${QQ_GetUserName()}
ğŸ­ å½“å‰è§’è‰²: ${getCurrentCharacterId() || 'æœªçŸ¥'}
ğŸ“š ä¸–ç•Œä¹¦çŠ¶æ€: ${QQ_IsWorldBookAvailable() ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}

ğŸ“‹ æ•°æ®ç»Ÿè®¡:
â€¢ è”ç³»äººåˆ†ç»„: ${contactGroups ? contactGroups.length : 0} ä¸ª
â€¢ å…¬å…±äº’åŠ¨ç©ºé—´: ${Object.keys(QQ_InteractiveSpaces || {}).length} ä¸ª
â€¢ ç§äººäº’åŠ¨ç©ºé—´: ${Object.keys(QQ_CharacterSpaces || {}).reduce((sum, char) => sum + Object.keys(QQ_CharacterSpaces[char]).length, 0)} ä¸ª
â€¢ åŠ¨æ€æ•°é‡: ${QQ_MomentsData ? QQ_MomentsData.length : 0} ä¸ª

âš™ï¸ åŠŸèƒ½çŠ¶æ€:
â€¢ æ¶ˆæ¯å‘é€: ${typeof QQ_SendMsg === 'function' ? 'âœ…' : 'âŒ'}
â€¢ åŠ¨æ€è¯„è®º: ${typeof QQ_Moment_Comment === 'function' ? 'âœ…' : 'âŒ'}
â€¢ äº’åŠ¨æ£€æµ‹: ${typeof QQ_DetectInteractiveIntent === 'function' ? 'âœ…' : 'âŒ'}
â€¢ è§’è‰²ç²¾çµ: ${typeof QQ_ShowCharacterSpirit === 'function' ? 'âœ…' : 'âŒ'}

ğŸ•’ ç³»ç»Ÿæ—¶é—´: ${new Date().toLocaleString('zh-CN')}`;
                
                alert(info);
            }
            
            /**
             * *** æ–°å¢ï¼šåŒæ­¥æ‰€æœ‰æ•°æ®åˆ°ä¸–ç•Œä¹¦ ***
             */
            function QQ_SyncAllData() {
                console.log('ğŸ”„ å¼€å§‹åŒæ­¥æ‰€æœ‰æ•°æ®åˆ°ä¸–ç•Œä¹¦...');
                
                if (!QQ_IsWorldBookAvailable()) {
                    alert('âŒ ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨ï¼Œæ— æ³•åŒæ­¥æ•°æ®');
                    return;
                }
                
                let syncCount = 0;
                let totalCount = 0;
                
                try {
                    // åŒæ­¥åˆ†ç»„æ•°æ®
                    if (typeof saveGroupsToStorage === 'function') {
                        console.log('ğŸ”„ åŒæ­¥åˆ†ç»„æ•°æ®...');
                        saveGroupsToStorage();
                        syncCount++;
                    }
                    totalCount++;
                    
                    // åŒæ­¥åŠ¨æ€æ•°æ®
                    if (typeof QQ_Save_Moments === 'function' && QQ_MomentsData) {
                        console.log('ğŸ”„ åŒæ­¥åŠ¨æ€æ•°æ®...');
                        QQ_Save_Moments();
                        syncCount++;
                    }
                    totalCount++;
                    
                    // åŒæ­¥äº’åŠ¨ç©ºé—´æ•°æ®
                    if (typeof QQ_Save_Interactive_Spaces === 'function') {
                        console.log('ğŸ”„ åŒæ­¥äº’åŠ¨ç©ºé—´æ•°æ®...');
                        QQ_Save_Interactive_Spaces();
                        syncCount++;
                    }
                    totalCount++;
                    
                    // åŒæ­¥å·²è¯»çŠ¶æ€
                    if (typeof QQ_SaveReadStatus === 'function') {
                        console.log('ğŸ”„ åŒæ­¥å·²è¯»çŠ¶æ€...');
                        QQ_SaveReadStatus();
                        syncCount++;
                    }
                    totalCount++;
                    
                    console.log(`âœ… æ•°æ®åŒæ­¥å®Œæˆ: ${syncCount}/${totalCount} é¡¹æˆåŠŸ`);
                    alert(`âœ… æ•°æ®åŒæ­¥å®Œæˆ\næˆåŠŸåŒæ­¥: ${syncCount}/${totalCount} é¡¹æ•°æ®`);
                    
                } catch (error) {
                    console.error('âŒ æ•°æ®åŒæ­¥å¤±è´¥:', error);
                    alert(`âŒ æ•°æ®åŒæ­¥å¤±è´¥: ${error.message}`);
                }
            }
            
            /**
             * *** å¼ºåˆ¶ä»ä¸–ç•Œä¹¦é‡æ–°åŠ è½½æ‰€æœ‰äº’åŠ¨ç©ºé—´æ•°æ® ***
             */
            async function QQ_ForceReloadInteractiveSpaces() {
                console.log('ğŸ”„ å¼ºåˆ¶ä»ä¸–ç•Œä¹¦é‡æ–°åŠ è½½äº’åŠ¨ç©ºé—´æ•°æ®...');
                
                try {
                    // æ¸…ç©ºå†…å­˜ç¼“å­˜
                    QQ_InteractiveSpaces = {};
                    QQ_CharacterSpaces = {};
                    
                    // ä»ä¸–ç•Œä¹¦é‡æ–°åŠ è½½
                    await QQ_LoadInteractiveSpaces();
                    await QQ_LoadCharacterSpaces();
                    
                    console.log('âœ… äº’åŠ¨ç©ºé—´æ•°æ®é‡æ–°åŠ è½½å®Œæˆ');
                    console.log(`ğŸ“Š å…¬å…±ç©ºé—´: ${Object.keys(QQ_InteractiveSpaces).length} ä¸ª`);
                    console.log(`ğŸ‘¥ è§’è‰²ç©ºé—´: ${Object.keys(QQ_CharacterSpaces).length} ä¸ªè§’è‰²`);
                    
                    return true;
                } catch (error) {
                    console.error('âŒ å¼ºåˆ¶é‡æ–°åŠ è½½äº’åŠ¨ç©ºé—´æ•°æ®å¤±è´¥:', error);
                    return false;
                }
            }
            
            /**
             * *** ä¼˜åŒ–ï¼šæ˜¾ç¤ºå…¬å…±äº’åŠ¨ç©ºé—´åˆ—è¡¨ - å¢å¼ºåŠ è½½ä½“éªŒ ***
             */
            async function QQ_ShowPublicInteractiveSpaces() {
                console.log('ğŸŒ æ˜¾ç¤ºå…¬å…±äº’åŠ¨ç©ºé—´åˆ—è¡¨ï¼Œç«‹å³ä»ä¸–ç•Œä¹¦åŠ è½½æ•°æ®...');
                
                // ç§»é™¤ç°æœ‰é¢æ¿
                $('.QQ_user_spirit_panel').remove();
                
                // *** 1. ç«‹å³æ˜¾ç¤ºåŠ è½½çŠ¶æ€ ***
                QQ_ShowPublicSpacesLoadingUI();
                
                try {
                    // *** 2. å…³é”®ä¼˜åŒ–ï¼šå¼ºåˆ¶ä»ä¸–ç•Œä¹¦é‡æ–°åŠ è½½æ•°æ® ***
                    console.log('ğŸ”„ å¼€å§‹ä»ä¸–ç•Œä¹¦åŠ è½½å…¬å…±äº’åŠ¨ç©ºé—´æ•°æ®...');
                    const loadSuccess = await QQ_ForceReloadInteractiveSpaces();
                    
                    if (!loadSuccess) {
                        throw new Error('ä»ä¸–ç•Œä¹¦åŠ è½½æ•°æ®å¤±è´¥');
                    }
                    
                    // *** 3. åŠ è½½å®Œæˆï¼Œæ˜¾ç¤ºæ•°æ® ***
                    QQ_ShowPublicSpacesContent();
                    
                } catch (error) {
                    console.error('âŒ æ˜¾ç¤ºå…¬å…±äº’åŠ¨ç©ºé—´å¤±è´¥:', error);
                    QQ_ShowPublicSpacesError(error.message);
                }
            }
            
            /**
             * *** æ–°å¢ï¼šæ˜¾ç¤ºå…¬å…±äº’åŠ¨ç©ºé—´åŠ è½½çŠ¶æ€ ***
             */
            function QQ_ShowPublicSpacesLoadingUI() {
                // ç§»é™¤ç°æœ‰åŠ è½½ç•Œé¢
                $('.QQ_public_spaces_panel').remove();
                
                const loadingPanel = $(`
                    <div class="QQ_public_spaces_panel" style="
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: white;
                        border-radius: 16px;
                        width: 85%;
                        max-width: 400px;
                        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                        z-index: 10000;
                        overflow: hidden;
                        animation: slideIn 0.3s ease;
                    ">
                        <div class="panel-header" style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 16px 20px;
                            text-align: center;
                        ">
                            <div style="
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                gap: 8px;
                                font-size: 16px;
                                font-weight: 600;
                            ">
                                <span style="font-size: 18px;">ğŸ </span>
                                <span>å…¬å…±äº’åŠ¨ç©ºé—´</span>
                            </div>
                        </div>
                        
                        <div style="
                            padding: 40px 20px;
                            text-align: center;
                        ">
                            <div style="
                                width: 50px;
                                height: 50px;
                                border: 4px solid #f3f3f3;
                                border-top: 4px solid #667eea;
                                border-radius: 50%;
                                animation: spin 1s linear infinite;
                                margin: 0 auto 20px auto;
                            "></div>
                            <div style="
                                font-size: 16px;
                                color: #333;
                                margin-bottom: 8px;
                                font-weight: 500;
                            ">æ­£åœ¨åŠ è½½äº’åŠ¨è®°å½•...</div>
                            <div style="
                                font-size: 12px;
                                color: #999;
                                line-height: 1.4;
                            ">ä»ä¸–ç•Œä¹¦è·å–æœ€æ–°æ•°æ®<br/>
                            <small style="opacity: 0.7;">é¦–æ¬¡åŠ è½½å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ</small></div>
                        </div>
                    </div>
                    
                    <style>
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    </style>
                `);
                
                $('body').append(loadingPanel);
                
                // ç‚¹å‡»èƒŒæ™¯å¯ä»¥å…³é—­ï¼ˆå¯é€‰ï¼‰
                loadingPanel.on('click', function(e) {
                    if (e.target === this) {
                        $(this).remove();
                    }
                });
            }
            
            /**
             * *** æ–°å¢ï¼šæ˜¾ç¤ºå…¬å…±äº’åŠ¨ç©ºé—´å†…å®¹ ***
             */
            function QQ_ShowPublicSpacesContent() {
                // ç§»é™¤åŠ è½½ç•Œé¢
                $('.QQ_public_spaces_panel').remove();
                
                const spaces = Object.values(QQ_InteractiveSpaces || {});
                const spacesCount = spaces.length;
                
                // åˆ›å»ºäº’åŠ¨ç©ºé—´åˆ—è¡¨é¢æ¿
                const panel = $(`
                    <div class="QQ_public_spaces_panel" style="
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: white;
                        border-radius: 16px;
                        width: 85%;
                        max-width: 400px;
                        max-height: 70vh;
                        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                        z-index: 10000;
                        overflow: hidden;
                        animation: slideIn 0.3s ease;
                    ">
                        <div class="panel-header" style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 16px 20px;
                            text-align: center;
                            position: relative;
                        ">
                            <div style="
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                gap: 8px;
                                font-size: 16px;
                                font-weight: 600;
                            ">
                                <span style="font-size: 18px;">ğŸ </span>
                                <span>å…¬å…±äº’åŠ¨ç©ºé—´</span>
                                <span style="
                                    background: rgba(255, 255, 255, 0.2);
                                    padding: 2px 8px;
                                    border-radius: 8px;
                                    font-size: 12px;
                                    font-weight: 500;
                                ">${spacesCount}ä¸ª</span>
                            </div>
                        </div>
                        
                        <div class="panel-content" style="
                            padding: 0;
                            max-height: 50vh;
                            overflow-y: auto;
                        ">
                            ${spacesCount === 0 ? `
                                <div style="
                                    text-align: center;
                                    padding: 40px 20px;
                                    color: #999;
                                ">
                                    <div style="font-size: 48px; margin-bottom: 16px;">ğŸŒŸ</div>
                                    <div style="font-size: 16px; margin-bottom: 8px; color: #666;">è¿˜æ²¡æœ‰äº’åŠ¨è®°å½•</div>
                                    <div style="font-size: 12px;">å¼€å§‹ä¸€æ®µç°å®äº’åŠ¨å§ï½</div>
                                </div>
                            ` : spaces.map((space, index) => `
                                <div class="space-item" data-space-id="${space.id}" style="
                                    padding: 16px 20px;
                                    border-bottom: 1px solid #f0f0f0;
                                    cursor: pointer;
                                    transition: background-color 0.2s ease;
                                    ${index === spaces.length - 1 ? 'border-bottom: none;' : ''}
                                ">
                                    <div style="
                                        display: flex;
                                        align-items: flex-start;
                                        gap: 12px;
                                    ">
                                        <div style="
                                            width: 36px;
                                            height: 36px;
                                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                            border-radius: 8px;
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                            color: white;
                                            font-size: 16px;
                                            flex-shrink: 0;
                                        ">ğŸŒŸ</div>
                                        
                                        <div style="flex: 1; min-width: 0;">
                                            <div style="
                                                font-size: 14px;
                                                font-weight: 600;
                                                color: #333;
                                                margin-bottom: 4px;
                                                overflow: hidden;
                                                text-overflow: ellipsis;
                                                white-space: nowrap;
                                            ">${space.title || `äº’åŠ¨ç©ºé—´ #${index + 1}`}</div>
                                            
                                            <div style="
                                                font-size: 12px;
                                                color: #666;
                                                line-height: 1.4;
                                                display: -webkit-box;
                                                -webkit-line-clamp: 2;
                                                -webkit-box-orient: vertical;
                                                overflow: hidden;
                                            ">${(space.content || '').replace(/<[^>]*>/g, '').substring(0, 60)}${(space.content || '').length > 60 ? '...' : ''}</div>
                                            
                                            <div style="
                                                font-size: 10px;
                                                color: #999;
                                                margin-top: 6px;
                                                display: flex;
                                                align-items: center;
                                                gap: 8px;
                                            ">
                                                <span>ğŸ“… ${space.timestamp ? new Date(space.timestamp).toLocaleDateString('zh-CN') : 'æœªçŸ¥æ—¶é—´'}</span>
                                                <span>ğŸ’¬ ${space.replies ? space.replies.length : 0}æ¡å›å¤</span>
                                            </div>
                                        </div>
                                        
                                        <div style="
                                            width: 24px;
                                            height: 24px;
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                            color: #ccc;
                                            font-size: 14px;
                                        ">â†’</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="panel-footer" style="
                            padding: 16px 20px;
                            border-top: 1px solid #f0f0f0;
                            background: #fafafa;
                        ">
                            <div style="
                                display: grid;
                                grid-template-columns: 1fr 1fr;
                                gap: 10px;
                            ">
                                <button class="close-btn" style="
                                    background: #e9ecef;
                                    border: none;
                                    color: #666;
                                    padding: 10px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.2s ease;
                                ">å…³é—­</button>
                                
                                <button class="create-new-btn" style="
                                    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                                    border: none;
                                    color: white;
                                    padding: 10px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.2s ease;
                                ">âœ¨ åˆ›å»ºæ–°äº’åŠ¨</button>
                            </div>
                        </div>
                    </div>
                `);
                
                // æ·»åŠ æ‚¬åœæ•ˆæœ
                panel.find('.space-item').hover(
                    function() { $(this).css('background-color', '#f8f9fa'); },
                    function() { $(this).css('background-color', 'transparent'); }
                );
                
                // ç»‘å®šäº‹ä»¶
                panel.on('click', '.space-item', function() {
                    const spaceId = $(this).data('space-id');
                    const space = QQ_InteractiveSpaces[spaceId];
                    if (space) {
                        panel.remove();
                        setTimeout(() => {
                            QQ_DisplayInteractiveSpace(spaceId, 'å…¬å…±äº’åŠ¨ç©ºé—´');
                        }, 100);
                    }
                });
                
                panel.on('click', '.close-btn', function() {
                    panel.remove();
                });
                
                panel.on('click', '.create-new-btn', function() {
                    panel.remove();
                    setTimeout(() => {
                        QQ_CreatePublicInteractiveSpace();
                    }, 100);
                });
                
                // ç‚¹å‡»å¤–éƒ¨å…³é—­
                $(document).one('click', function() {
                    panel.remove();
                });
                
                panel.on('click', function(e) {
                    e.stopPropagation();
                });
                
                $('body').append(panel);
            }
            
            /**
             * *** æ–°å¢ï¼šåˆ›å»ºå…¬å…±äº’åŠ¨ç©ºé—´ ***
             */
            async function QQ_CreatePublicInteractiveSpace() {
                console.log('åˆ›å»ºå…¬å…±äº’åŠ¨ç©ºé—´');
                
                // *** å…³é”®ä¼˜åŒ–ï¼šå…ˆä»ä¸–ç•Œä¹¦é‡æ–°åŠ è½½æ•°æ® ***
                await QQ_ForceReloadInteractiveSpaces();
                
                // ç§»é™¤ç°æœ‰é¢æ¿
                $('.QQ_public_spaces_panel').remove();
                
                // åˆ›å»ºè¾“å…¥é¢æ¿
                const panel = $(`
                    <div class="QQ_create_space_panel" style="
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: white;
                        border-radius: 16px;
                        width: 85%;
                        max-width: 400px;
                        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                        z-index: 10000;
                        overflow: hidden;
                        animation: slideIn 0.3s ease;
                    ">
                        <div class="panel-header" style="
                            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                            color: white;
                            padding: 16px 20px;
                            text-align: center;
                        ">
                            <div style="
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                gap: 8px;
                                font-size: 16px;
                                font-weight: 600;
                            ">
                                <span style="font-size: 18px;">âœ¨</span>
                                <span>åˆ›å»ºæ–°äº’åŠ¨ç©ºé—´</span>
                            </div>
                        </div>
                        
                        <div class="panel-content" style="padding: 20px;">
                            <div style="margin-bottom: 16px;">
                                <label style="
                                    display: block;
                                    font-size: 13px;
                                    font-weight: 600;
                                    color: #333;
                                    margin-bottom: 6px;
                                ">äº’åŠ¨æ ‡é¢˜</label>
                                <input type="text" class="space-title" placeholder="ä¸ºè¿™æ¬¡äº’åŠ¨èµ·ä¸ªåå­—..." style="
                                    width: 100%;
                                    padding: 10px 12px;
                                    border: 1px solid #ddd;
                                    border-radius: 8px;
                                    font-size: 14px;
                                    outline: none;
                                    transition: border-color 0.2s ease;
                                    box-sizing: border-box;
                                ">
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="
                                    display: block;
                                    font-size: 13px;
                                    font-weight: 600;
                                    color: #333;
                                    margin-bottom: 6px;
                                ">äº’åŠ¨å†…å®¹</label>
                                <textarea class="space-content" placeholder="æè¿°ä½ æƒ³è¦çš„äº’åŠ¨åœºæ™¯..." style="
                                    width: 100%;
                                    height: 100px;
                                    padding: 10px 12px;
                                    border: 1px solid #ddd;
                                    border-radius: 8px;
                                    font-size: 14px;
                                    outline: none;
                                    transition: border-color 0.2s ease;
                                    resize: vertical;
                                    box-sizing: border-box;
                                "></textarea>
                            </div>
                            
                            <div style="
                                background: #f8f9fa;
                                padding: 12px;
                                border-radius: 8px;
                                margin-bottom: 20px;
                            ">
                                <div style="
                                    display: flex;
                                    align-items: center;
                                    gap: 6px;
                                    margin-bottom: 6px;
                                    font-size: 12px;
                                    font-weight: 600;
                                    color: #28a745;
                                ">
                                    <span>ğŸ’¡</span>
                                    <span>å¿«é€Ÿäº’åŠ¨å°è´´å£«</span>
                                </div>
                                <div style="
                                    font-size: 11px;
                                    color: #666;
                                    line-height: 1.4;
                                ">
                                    åœ¨èŠå¤©ä¸­ä½¿ç”¨ <code style="
                                        background: #e9ecef;
                                        padding: 2px 4px;
                                        border-radius: 3px;
                                        font-family: monospace;
                                    ">&amp;&amp;</code> ç¬¦å·å¯ä»¥ç›´æ¥è§¦å‘äº’åŠ¨å†…å®¹<br>
                                    ä¾‹å¦‚ï¼š<em>&amp;&amp;æƒ³è¦æ‹¥æŠ±ä½ </em>
                                </div>
                            </div>
                        </div>
                        
                        <div class="panel-footer" style="
                            padding: 16px 20px;
                            border-top: 1px solid #f0f0f0;
                            background: #fafafa;
                        ">
                            <div style="
                                display: grid;
                                grid-template-columns: 1fr 1fr;
                                gap: 10px;
                            ">
                                <button class="cancel-btn" style="
                                    background: #e9ecef;
                                    border: none;
                                    color: #666;
                                    padding: 10px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.2s ease;
                                ">å–æ¶ˆ</button>
                                
                                <button class="create-btn" style="
                                    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                                    border: none;
                                    color: white;
                                    padding: 10px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.2s ease;
                                ">âœ¨ åˆ›å»ºäº’åŠ¨</button>
                            </div>
                        </div>
                    </div>
                `);
                
                // è¾“å…¥æ¡†ç„¦ç‚¹æ•ˆæœ
                panel.find('input, textarea').on('focus', function() {
                    $(this).css('border-color', '#f093fb');
                }).on('blur', function() {
                    $(this).css('border-color', '#ddd');
                });
                
                // ç»‘å®šäº‹ä»¶
                panel.on('click', '.cancel-btn', function() {
                    panel.remove();
                });
                
                panel.on('click', '.create-btn', function() {
                    const title = panel.find('.space-title').val().trim();
                    const content = panel.find('.space-content').val().trim();
                    
                    if (!content) {
                        alert('è¯·è¾“å…¥äº’åŠ¨å†…å®¹');
                        return;
                    }
                    
                    // åˆ›å»ºäº’åŠ¨ç©ºé—´
                    const spaceId = 'space_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    const timestamp = Date.now();
                    
                    QQ_InteractiveSpaces[spaceId] = {
                        id: spaceId,
                        title: title || `äº’åŠ¨ç©ºé—´ #${Object.keys(QQ_InteractiveSpaces).length + 1}`,
                        content: content,
                        timestamp: timestamp,
                        characterName: '',
                        isMultiCharacter: true,
                        replies: []
                    };
                    
                    // *** ç«‹å³ä¿å­˜äº’åŠ¨å†…å®¹åˆ°ä¸–ç•Œä¹¦ ***
                    QQ_SaveInteractiveContentToWorldBook(content, null).then(interactiveId => {
                        console.log(`ğŸ¯ å…¬å…±äº’åŠ¨ç©ºé—´å·²ç«‹å³ä¿å­˜åˆ°ä¸–ç•Œä¹¦ï¼ŒID: ${interactiveId}`);
                    }).catch(error => {
                        console.error('ä¿å­˜å…¬å…±äº’åŠ¨ç©ºé—´å¤±è´¥:', error);
                    });
                    
                    // åŒæ—¶ä¿å­˜åˆ°æ—§çš„äº’åŠ¨ç©ºé—´å­˜å‚¨ï¼ˆå…¼å®¹æ€§ï¼‰
                    if (typeof QQ_Save_Interactive_Spaces === 'function') {
                        QQ_Save_Interactive_Spaces();
                    }
                    
                    console.log('âœ… å…¬å…±äº’åŠ¨ç©ºé—´åˆ›å»ºæˆåŠŸ:', spaceId);
                    
                    panel.remove();
                    
                    // æ˜¾ç¤ºåˆ›å»ºçš„äº’åŠ¨ç©ºé—´
                    setTimeout(() => {
                        QQ_DisplayInteractiveSpace(spaceId, 'å…¬å…±äº’åŠ¨ç©ºé—´');
                    }, 100);
                });
                
                // å›è½¦å¿«æ·é”®
                panel.find('.space-content').on('keydown', function(e) {
                    if (e.ctrlKey && e.key === 'Enter') {
                        panel.find('.create-btn').click();
                    }
                });
                
                // ç‚¹å‡»å¤–éƒ¨å…³é—­
                $(document).one('click', function() {
                    panel.remove();
                });
                
                panel.on('click', function(e) {
                    e.stopPropagation();
                });
                
                $('body').append(panel);
                
                // è‡ªåŠ¨èšç„¦åˆ°æ ‡é¢˜è¾“å…¥æ¡†
                setTimeout(() => {
                    panel.find('.space-title').focus();
                }, 100);
            }
            
            /**
             * *** æ–°å¢ï¼šæ˜¾ç¤ºå…¬å…±äº’åŠ¨ç©ºé—´åŠ è½½é”™è¯¯ ***
             * @param {string} errorMessage - é”™è¯¯ä¿¡æ¯
             */
            function QQ_ShowPublicSpacesError(errorMessage) {
                // ç§»é™¤åŠ è½½ç•Œé¢
                $('.QQ_public_spaces_panel').remove();
                
                const errorPanel = $(`
                    <div class="QQ_public_spaces_panel" style="
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: white;
                        border-radius: 16px;
                        width: 85%;
                        max-width: 400px;
                        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                        z-index: 10000;
                        overflow: hidden;
                        animation: slideIn 0.3s ease;
                    ">
                        <div class="panel-header" style="
                            background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%);
                            color: white;
                            padding: 16px 20px;
                            text-align: center;
                        ">
                            <div style="
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                gap: 8px;
                                font-size: 16px;
                                font-weight: 600;
                            ">
                                <span style="font-size: 18px;">âš ï¸</span>
                                <span>åŠ è½½å¤±è´¥</span>
                            </div>
                        </div>
                        
                        <div style="
                            padding: 30px 20px;
                            text-align: center;
                        ">
                            <div style="
                                font-size: 48px;
                                margin-bottom: 16px;
                                opacity: 0.6;
                            ">ğŸ˜µ</div>
                            <div style="
                                font-size: 16px;
                                color: #333;
                                margin-bottom: 8px;
                                font-weight: 500;
                            ">äº’åŠ¨è®°å½•åŠ è½½å¤±è´¥</div>
                            <div style="
                                font-size: 12px;
                                color: #666;
                                line-height: 1.4;
                                margin-bottom: 20px;
                            ">${errorMessage || 'æœªçŸ¥é”™è¯¯'}<br/>
                            <small style="opacity: 0.7;">è¯·æ£€æŸ¥ä¸–ç•Œä¹¦åŠŸèƒ½æ˜¯å¦æ­£å¸¸</small></div>
                            
                            <div style="
                                display: grid;
                                grid-template-columns: 1fr 1fr;
                                gap: 10px;
                            ">
                                <button class="retry-btn" style="
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    border: none;
                                    color: white;
                                    padding: 12px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.2s ease;
                                ">ğŸ”„ é‡è¯•</button>
                                
                                <button class="close-error-btn" style="
                                    background: #e9ecef;
                                    border: none;
                                    color: #666;
                                    padding: 12px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    transition: all 0.2s ease;
                                ">å…³é—­</button>
                            </div>
                        </div>
                    </div>
                `);
                
                // ç»‘å®šäº‹ä»¶
                errorPanel.on('click', '.retry-btn', function() {
                    errorPanel.remove();
                    // é‡æ–°å°è¯•åŠ è½½
                    setTimeout(() => {
                        QQ_ShowPublicInteractiveSpaces();
                    }, 100);
                });
                
                errorPanel.on('click', '.close-error-btn', function() {
                    errorPanel.remove();
                });
                
                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                errorPanel.on('click', function(e) {
                    if (e.target === this) {
                        $(this).remove();
                    }
                });
                
                // æ·»åŠ åˆ°é¡µé¢
                $('body').append(errorPanel);
                
                // æ˜¾ç¤ºé”™è¯¯æç¤º
                toastr.error('åŠ è½½å…¬å…±äº’åŠ¨ç©ºé—´å¤±è´¥', 'é”™è¯¯');
            }
            
            // ç¡®ä¿å‡½æ•°å…¨å±€å¯ç”¨
            window.QQ_ToggleUserMenu = QQ_ToggleUserMenu;
            window.QQ_GetUserName = QQ_GetUserName;
            window.QQ_ShowUserSpirit = QQ_ShowUserSpirit;
            window.QQ_ShowUserSpiritPanel = QQ_ShowUserSpiritPanel;
            window.QQ_ShowUserSettingsMenu = QQ_ShowUserSettingsMenu;
            window.QQ_ShowPhoneStatus = QQ_ShowPhoneStatus;
            window.QQ_SyncAllData = QQ_SyncAllData;
            window.QQ_ShowPublicInteractiveSpaces = QQ_ShowPublicInteractiveSpaces;
            window.QQ_CreatePublicInteractiveSpace = QQ_CreatePublicInteractiveSpace;
            window.QQ_ForceReloadInteractiveSpaces = QQ_ForceReloadInteractiveSpaces;
            window.QQ_ForceReloadContactGroups = QQ_ForceReloadContactGroups;
            window.QQ_ShowPublicSpacesError = QQ_ShowPublicSpacesError;
            
            // *** ä¿ç•™æ ¸å¿ƒåŠŸèƒ½å‡½æ•°ï¼Œç§»é™¤è¿‡æœŸæµ‹è¯•å‡½æ•° ***
            window.QQ_ProcessSurpriseMechanism = QQ_ProcessSurpriseMechanism;
            window.QQ_ValidateInteractiveContent = QQ_ValidateInteractiveContent;
            window.QQ_CleanNestedTags = QQ_CleanNestedTags;
            window.QQ_CleanContentTags = QQ_CleanContentTags;
            window.QQ_HandleCharacterChat = QQ_HandleCharacterChat;
            window.QQ_SaveCharacterChatToWorldbook = QQ_SaveCharacterChatToWorldbook;

            
            /**
             * ===== é”™è¯¯ä¿®å¤éªŒè¯å·¥å…· =====
             */
            

            


            /**
             * ===== åŠ¨æ€ç‚¹èµåŠŸèƒ½ =====
             */

            /**
             * ç‚¹èµåŠ¨æ€
             * @param {string} momentId - åŠ¨æ€ID
             */
            window.QQ_LikeMoment = async function(momentId) {
                try {
                    console.log(`ç‚¹èµåŠ¨æ€: ${momentId}`);
                    
                    // è·å–ç”¨æˆ·å
                    const userName = QQ_GetUserName();
                    if (!userName) {
                        console.warn('æ— æ³•è·å–ç”¨æˆ·åï¼Œæ— æ³•æ‰§è¡Œç‚¹èµæ“ä½œ');
                        return false;
                    }
                    
                    // æŸ¥æ‰¾åŠ¨æ€æ•°æ®
                    const momentData = QQ_MomentsData.find(m => m.id === momentId);
                    if (!momentData) {
                        console.warn(`æœªæ‰¾åˆ°åŠ¨æ€æ•°æ®: ${momentId}`);
                        return false;
                    }
                    
                    // ç¡®ä¿likeså¯¹è±¡å­˜åœ¨
                    if (!momentData.likes) {
                        momentData.likes = {
                            count: 0,
                            userLiked: false,
                            likedBy: [],
                            lastLikeTime: null
                        };
                    }
                    
                    // åˆ‡æ¢ç‚¹èµçŠ¶æ€
                    const wasLiked = momentData.likes.userLiked;
                    if (wasLiked) {
                        // å–æ¶ˆç‚¹èµ
                        momentData.likes.userLiked = false;
                        momentData.likes.count = Math.max(0, momentData.likes.count - 1);
                        momentData.likes.likedBy = momentData.likes.likedBy.filter(name => name !== userName);
                        momentData.likes.lastLikeTime = new Date().toISOString();
                        
                        console.log(`âœ… å·²å–æ¶ˆç‚¹èµåŠ¨æ€: ${momentId}`);
                    } else {
                        // æ·»åŠ ç‚¹èµ
                        momentData.likes.userLiked = true;
                        momentData.likes.count += 1;
                        if (!momentData.likes.likedBy.includes(userName)) {
                            momentData.likes.likedBy.push(userName);
                        }
                        momentData.likes.lastLikeTime = new Date().toISOString();
                        
                        console.log(`âœ… å·²ç‚¹èµåŠ¨æ€: ${momentId}`);
                    }
                    
                    // æ›´æ–°UI
                    QQ_UpdateLikeUI(momentId, momentData.likes);
                    
                    // æ˜¾ç¤ºç‚¹èµæç¤º
                    QQ_ShowLikePopup(momentId, !wasLiked, userName);
                    
                    // ä¿å­˜åˆ°ä¸–ç•Œä¹¦
                    await QQ_Save_Moments();
                    console.log('ç‚¹èµçŠ¶æ€å·²ä¿å­˜åˆ°ä¸–ç•Œä¹¦');
                    
                    // å¦‚æœæ˜¯ç‚¹èµï¼ˆéå–æ¶ˆï¼‰ï¼Œè®°å½•ç”¨äºAIååº”
                    if (!wasLiked) {
                        await QQ_RecordLikeForAI(momentData, userName);
                    }
                    
                    return true;
                } catch (error) {
                    console.error('ç‚¹èµæ“ä½œå¤±è´¥:', error);
                    return false;
                }
            };

            /**
             * æ›´æ–°ç‚¹èµUI
             * @param {string} momentId - åŠ¨æ€ID
             * @param {Object} likes - ç‚¹èµæ•°æ®
             */
            window.QQ_UpdateLikeUI = function(momentId, likes) {
                try {
                    const momentElement = $(`.user_moment[data-moment-id="${momentId}"]`);
                    if (momentElement.length === 0) {
                        console.warn(`æœªæ‰¾åˆ°åŠ¨æ€å…ƒç´ : ${momentId}`);
                        return;
                    }
                    
                    // æ”¯æŒä¸¤ç§ç±»å‹çš„ç‚¹èµæŒ‰é’®
                    
                    // ç±»å‹1ï¼šDiscordå¡ç‰‡ä¸­çš„.moment-like-button
                    const discordLikeButton = momentElement.find(`.moment-like-button[data-moment-id="${momentId}"]`);
                    const discordLikeCount = momentElement.find(`.moment-like-count`);
                    
                    if (discordLikeButton.length > 0) {
                        // Discordå¡ç‰‡æ ·å¼æ›´æ–°
                        if (likes.userLiked) {
                            discordLikeButton.css('color', '#1677ff');
                            discordLikeButton.addClass('liked');
                        } else {
                            discordLikeButton.css('color', '#000000');
                            discordLikeButton.removeClass('liked');
                        }
                        discordLikeCount.text(likes.count);
                    }
                    
                    // ç±»å‹2ï¼šåŠ¨æ€æ¨¡æ¿ä¸­çš„ç‚¹èµç»“æ„ï¼ˆå«ğŸ‘çš„SVGéƒ¨åˆ†ï¼‰
                    const momentLikeSection = momentElement.find('span:contains("äººå·²èµ")').parent();
                    const momentLikeText = momentElement.find('span:contains("äººå·²èµ")');
                    
                    if (momentLikeText.length > 0) {
                        // æ›´æ–°åŠ¨æ€æ¨¡æ¿ä¸­çš„ç‚¹èµæ–‡æœ¬
                        momentLikeText.text(`${likes.count}äººå·²èµ`);
                        
                        // æŸ¥æ‰¾åŒ…å«ğŸ‘çš„SVGï¼ˆé€šè¿‡pathç‰¹å¾è¯†åˆ«ï¼‰
                        const thumbsUpSvg = momentElement.find('.moment_button svg').filter(function() {
                            const pathContent = $(this).find('path').attr('d');
                            return pathContent && pathContent.includes('471.411583');
                        });
                        
                        if (thumbsUpSvg.length > 0) {
                            const thumbPath = thumbsUpSvg.find('path');
                            if (likes.userLiked) {
                                // ç‚¹èµçŠ¶æ€ï¼šè“è‰² + å‘å…‰æ•ˆæœ
                                thumbPath.attr('fill', '#1677ff');
                                thumbsUpSvg.css({
                                    'filter': 'drop-shadow(0 0 8px #1677ff)',
                                    'transform': 'scale(1.2)',
                                    'transition': 'all 0.3s ease',
                                    'cursor': 'pointer'
                                }).addClass('liked-thumb');
                                
                                // æ·»åŠ è„‰å†²åŠ¨ç”»
                                if (!thumbsUpSvg.hasClass('pulse-animation')) {
                                    thumbsUpSvg.addClass('pulse-animation');
                                    setTimeout(() => thumbsUpSvg.removeClass('pulse-animation'), 800);
                                }
                            } else {
                                // æœªç‚¹èµçŠ¶æ€ï¼šæ¢å¤åŸè‰²
                                thumbPath.attr('fill', '#000000');
                                thumbsUpSvg.css({
                                    'filter': 'none',
                                    'transform': 'scale(1)',
                                    'transition': 'all 0.3s ease',
                                    'cursor': 'pointer'
                                }).removeClass('liked-thumb pulse-animation');
                            }
                        }
                        
                        // å¤„ç†ç”¨æˆ·å·²ç‚¹èµæç¤º
                        const userLikedTip = momentLikeText.next('.user-liked-tip');
                        if (likes.userLiked) {
                            if (userLikedTip.length === 0) {
                                // æ·»åŠ ç”¨æˆ·å·²ç‚¹èµæç¤º
                                momentLikeText.after('<div class="user-liked-tip" style="color:#1677ff;font-size:11px;margin-top:2px;font-weight:500;">âœ“ ä½ å·²ç‚¹èµ</div>');
                            }
                        } else {
                            // ç§»é™¤ç”¨æˆ·å·²ç‚¹èµæç¤º
                            userLikedTip.remove();
                        }
                    }
                    
                    console.log(`âœ… å·²æ›´æ–°åŠ¨æ€ ${momentId} çš„ç‚¹èµUI: ${likes.count}äººå·²èµ, ç”¨æˆ·å·²ç‚¹èµ: ${likes.userLiked}`);
                } catch (error) {
                    console.error('æ›´æ–°ç‚¹èµUIå¤±è´¥:', error);
                }
            };

            /**
             * æ˜¾ç¤ºç‚¹èµå¼¹çª—æç¤º
             * @param {string} momentId - åŠ¨æ€ID
             * @param {boolean} isLike - æ˜¯å¦ä¸ºç‚¹èµï¼ˆtrueï¼‰è¿˜æ˜¯å–æ¶ˆç‚¹èµï¼ˆfalseï¼‰
             * @param {string} userName - ç”¨æˆ·å
             */
            window.QQ_ShowLikePopup = function(momentId, isLike, userName) {
                try {
                    const momentElement = $(`.user_moment[data-moment-id="${momentId}"]`);
                    const popup = momentElement.find('.moment-like-popup');
                    
                    if (isLike) {
                        popup.text(`${userName}å·²ç‚¹èµ`).show();
                    } else {
                        popup.text(`${userName}å·²å–æ¶ˆç‚¹èµ`).show();
                    }
                    
                    // 2ç§’åè‡ªåŠ¨éšè—
                    setTimeout(() => {
                        popup.fadeOut(300);
                    }, 2000);
                } catch (error) {
                    console.error('æ˜¾ç¤ºç‚¹èµå¼¹çª—å¤±è´¥:', error);
                }
            };

            /**
             * è®°å½•ç‚¹èµä¿¡æ¯ä¾›AIååº”ä½¿ç”¨
             * @param {Object} momentData - åŠ¨æ€æ•°æ®
             * @param {string} userName - ç”¨æˆ·å
             */
            window.QQ_RecordLikeForAI = async function(momentData, userName) {
                try {
                    // åˆ›å»ºç‚¹èµè®°å½•
                    const likeRecord = {
                        type: 'moment_like',
                        momentId: momentData.id,
                        momentAuthor: momentData.userName,
                        momentContent: momentData.message.substring(0, 100), // æˆªå–å‰100å­—ç¬¦
                        likedBy: userName,
                        likeTime: new Date().toISOString(),
                        totalLikes: momentData.likes.count,
                        context: `ç”¨æˆ·"${userName}"å¯¹"${momentData.userName}"å‘å¸ƒçš„åŠ¨æ€è¿›è¡Œäº†ç‚¹èµã€‚åŠ¨æ€å†…å®¹ï¼š"${momentData.message.substring(0, 50)}${momentData.message.length > 50 ? '...' : ''}"ã€‚å½“å‰è¯¥åŠ¨æ€å…±æœ‰${momentData.likes.count}äººç‚¹èµã€‚`
                    };
                    
                    // ä¿å­˜åˆ°ä¸–ç•Œä¹¦ç”¨äºAIååº”
                    const result = await QQ_SafeSaveToWorldBook('ç‚¹èµè®°å½•', likeRecord, 'QQ_ç‚¹èµè®°å½•å¤‡ä»½');
                    if (result) {
                        console.log('âœ… ç‚¹èµè®°å½•å·²ä¿å­˜ï¼ŒAIå¯åœ¨ä¸‹æ¬¡å¯¹è¯ä¸­è·å–æ­¤ä¿¡æ¯');
                    }
                } catch (error) {
                    console.error('è®°å½•ç‚¹èµä¿¡æ¯å¤±è´¥:', error);
                }
            };

            /**
             * ğŸš‘ ç‚¹èµæŒ‰é’®ç»ˆæä¿®å¤æ–¹æ¡ˆ ğŸš‘
             * ä¸“é—¨é’ˆå¯¹æ–°ç‰ˆæœ¬ä¼˜å…ˆçº§é€»è¾‘å¯¼è‡´çš„ç‚¹èµæ— å“åº”é—®é¢˜
             */
             window.QQ_InitMomentLikes = function() {
                try {
                    // ç±»å‹1ï¼šç»‘å®šDiscordå¡ç‰‡ä¸­çš„ç‚¹èµæŒ‰é’®
                    $(document).off('click', '.moment-like-button').on('click', '.moment-like-button', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const momentId = $(this).data('moment-id');
                        if (momentId) {
                            QQ_LikeMoment(momentId);
                        }
                    });
                    
                    // ç±»å‹2ï¼šç»‘å®šåŠ¨æ€æ¨¡æ¿ä¸­çš„ğŸ‘ç‚¹èµåŒºåŸŸ
                    $(document).off('click', '.moment_button svg').on('click', '.moment_button svg', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // æŸ¥æ‰¾åŠ¨æ€ID - å‘ä¸ŠæŸ¥æ‰¾åŒ…å«data-moment-idçš„å…ƒç´ 
                        const momentElement = $(this).closest('.user_moment[data-moment-id]');
                        const momentId = momentElement.data('moment-id');
                        
                        if (momentId) {
                            // åˆ¤æ–­è¿™æ˜¯å¦æ˜¯ç‚¹èµæŒ‰é’®ï¼ˆé€šè¿‡è·¯å¾„å†…å®¹æˆ–çˆ¶å…ƒç´ åˆ¤æ–­ï¼‰
                            const svgPath = $(this).find('path').attr('d');
                            // æ£€æŸ¥æ˜¯å¦æ˜¯ğŸ‘æŒ‰é’®ï¼ˆæ ¹æ®SVG pathç‰¹å¾åˆ¤æ–­ï¼‰
                            if (svgPath && svgPath.includes('471.411583')) { // è¿™æ˜¯ğŸ‘æŒ‰é’®çš„pathç‰¹å¾
                                QQ_LikeMoment(momentId);
                            }
                        }
                    });
                    
                    // ç±»å‹3ï¼šç›´æ¥ç»‘å®šåŒ…å«"äººå·²èµ"æ–‡æœ¬çš„åŒºåŸŸ
                    $(document).off('click', 'span:contains("äººå·²èµ")').on('click', 'span:contains("äººå·²èµ")', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const momentElement = $(this).closest('.user_moment[data-moment-id]');
                        const momentId = momentElement.data('moment-id');
                        
                        if (momentId) {
                            QQ_LikeMoment(momentId);
                        }
                    });
                    
                    console.log('âœ… åŠ¨æ€ç‚¹èµåŠŸèƒ½å·²åˆå§‹åŒ–ï¼ˆæ”¯æŒå¤šç§ç‚¹èµæŒ‰é’®ç±»å‹ï¼‰');
                } catch (error) {
                    console.error('åˆå§‹åŒ–åŠ¨æ€ç‚¹èµåŠŸèƒ½å¤±è´¥:', error);
                }
            };

            /**
             * åŠ è½½å·²æœ‰åŠ¨æ€çš„ç‚¹èµçŠ¶æ€
             */
            window.QQ_LoadMomentLikes = async function() {
                try {
                    if (!QQ_MomentsData || QQ_MomentsData.length === 0) {
                        return;
                    }
                    
                    const userName = QQ_GetUserName();
                    if (!userName) {
                        return;
                    }
                    
                    // æ›´æ–°æ‰€æœ‰åŠ¨æ€çš„ç‚¹èµUI
                    for (const momentData of QQ_MomentsData) {
                        if (momentData.likes) {
                            QQ_UpdateLikeUI(momentData.id, momentData.likes);
                        }
                    }
                    
                    console.log('âœ… å·²åŠ è½½åŠ¨æ€ç‚¹èµçŠ¶æ€');
                } catch (error) {
                    console.error('åŠ è½½åŠ¨æ€ç‚¹èµçŠ¶æ€å¤±è´¥:', error);
                }
            };


            

            /**
             * *** æ–°å¢ï¼šæ™ºèƒ½æå–å†…å®¹è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼å‡½æ•° ***
             */
            window.QQ_ConvertExtractedToStandard = function(extractedInfo) {
                console.log('ğŸ”„ å¼€å§‹è½¬æ¢æ™ºèƒ½æå–å†…å®¹ä¸ºæ ‡å‡†æ ¼å¼...');
                
                if (!extractedInfo || !extractedInfo.hasValidInfo) {
                    console.log('âŒ æå–ä¿¡æ¯æ— æ•ˆï¼Œæ— æ³•è½¬æ¢');
                    return null;
                }
                
                try {
                    const result = {};
                    
                    // å¤„ç†èŠå¤©æ¶ˆæ¯
                    if (extractedInfo.messages && extractedInfo.messages.length > 0) {
                        console.log(`ğŸ“ å¤„ç† ${extractedInfo.messages.length} æ¡èŠå¤©æ¶ˆæ¯`);
                        
                        // åˆ†æèŠå¤©ç±»å‹
                        let chatType = 'private'; // é»˜è®¤ç§èŠ
                        let chatName = '';
                        
                        // æ£€æŸ¥æ˜¯å¦ä¸ºç¾¤èŠï¼ˆæ”¯æŒä¸­æ–‡å’Œè‹±æ–‡å†’å·ï¼‰
                        if (extractedInfo.chatInfo && extractedInfo.chatInfo.includes('ç¾¤èŠ')) {
                            chatType = 'group';
                            const groupMatch = extractedInfo.chatInfo.match(/ç¾¤èŠ[ï¼š:]\s*(.+)/);
                            chatName = groupMatch ? groupMatch[1].trim() : 'æœªçŸ¥ç¾¤èŠ';
                        } else if (extractedInfo.chatType === 'group') {
                            // ç›´æ¥ä»chatTypeåˆ¤æ–­
                            chatType = 'group';
                            chatName = extractedInfo.chatName || 'æœªçŸ¥ç¾¤èŠ';
                        } else if (extractedInfo.chatType === 'private') {
                            // ç›´æ¥ä»chatTypeåˆ¤æ–­
                            chatType = 'private';
                            chatName = extractedInfo.chatName || 'æœªçŸ¥è§’è‰²';
                        } else if (extractedInfo.chatInfo) {
                            // ç§èŠæ ¼å¼: "ç”¨æˆ·åå’Œè§’è‰²åçš„ç§èŠ/èŠå¤©"
                            const privateMatch = extractedInfo.chatInfo.match(/(.+?)å’Œ(.+?)çš„?(?:èŠå¤©|ç§èŠ)/);
                            if (privateMatch) {
                                // åˆ¤æ–­å“ªä¸ªæ˜¯ç”¨æˆ·åï¼Œå“ªä¸ªæ˜¯è§’è‰²å
                                const user1 = privateMatch[1].trim();
                                const user2 = privateMatch[2].trim();
                                
                                // å‡è®¾ç”¨æˆ·ååŒ…å«åœ¨ç¬¬ä¸€ä¸ªä½ç½®ï¼Œè§’è‰²ååœ¨ç¬¬äºŒä¸ªä½ç½®
                                // æˆ–è€…æ ¹æ®å½“å‰ç”¨æˆ·ååˆ¤æ–­
                                if (window.UserName && user1 === window.UserName) {
                                    chatName = user2; // å¯¹æ–¹è§’è‰²å
                                } else if (window.UserName && user2 === window.UserName) {
                                    chatName = user1; // å¯¹æ–¹è§’è‰²å
                                } else {
                                    chatName = user2; // é»˜è®¤å–ç¬¬äºŒä¸ªä¸ºè§’è‰²å
                                }
                            } else {
                                // å°è¯•æ›´ç®€å•çš„æ ¼å¼åŒ¹é… "ç”¨æˆ·åå’Œè§’è‰²åç§èŠ"
                                const simpleMatch = extractedInfo.chatInfo.match(/(.+?)å’Œ(.+?)ç§èŠ/);
                                if (simpleMatch) {
                                    const user1 = simpleMatch[1].trim();
                                    const user2 = simpleMatch[2].trim();
                                    if (window.UserName && user1 === window.UserName) {
                                        chatName = user2;
                                    } else if (window.UserName && user2 === window.UserName) {
                                        chatName = user1;
                                    } else {
                                        chatName = user2;
                                    }
                                }
                            }
                        }
                        
                        console.log(`ğŸ’¬ èŠå¤©ç±»å‹: ${chatType}, èŠå¤©å¯¹è±¡: ${chatName}`);
                        
                        // æ„å»ºæ ‡å‡†æ ¼å¼
                        if (chatType === 'group') {
                            result.type = 'group';
                            result.groupName = chatName;
                            result.messages = extractedInfo.messages.map(msg => {
                                // å¦‚æœæ¶ˆæ¯å·²ç»æ˜¯å¯¹è±¡æ ¼å¼ï¼ˆä»QQ_ExtractMessagesFromContentè¿”å›ï¼‰
                                if (typeof msg === 'object' && msg.name && msg.msg) {
                                    return {
                                        sender: msg.name,
                                        content: msg.msg,
                                        time: msg.time || new Date().toLocaleTimeString('zh-CN', { hour12: false }).substring(0, 5)
                                    };
                                }
                                
                                // å¦‚æœæ¶ˆæ¯æ˜¯å­—ç¬¦ä¸²æ ¼å¼ï¼Œå°è¯•è§£æ
                                if (typeof msg === 'string') {
                                    // è§£ææ¶ˆæ¯æ ¼å¼ï¼šè§’è‰²åâ€”å†…å®¹â€”æ—¶é—´ æˆ– è§’è‰²åï¼šå†…å®¹
                                    const dashMatch = msg.match(/^(.+?)â€”(.+?)â€”(.+)$/);
                                    if (dashMatch) {
                                        return {
                                            sender: dashMatch[1].trim(),
                                            content: dashMatch[2].trim(),
                                            time: dashMatch[3].trim()
                                        };
                                    }
                                    
                                    const colonMatch = msg.match(/^(.+?)ï¼š(.+)$/);
                                    if (colonMatch) {
                                        return {
                                            sender: colonMatch[1].trim(),
                                            content: colonMatch[2].trim(),
                                            time: new Date().toLocaleTimeString('zh-CN', { hour12: false }).substring(0, 5)
                                        };
                                    }
                                }
                                
                                return null;
                            }).filter(msg => msg !== null);
                        } else {
                            result.type = 'private';
                            result.chatWith = chatName;
                            result.messages = extractedInfo.messages.map(msg => {
                                // å¦‚æœæ¶ˆæ¯å·²ç»æ˜¯å¯¹è±¡æ ¼å¼ï¼ˆä»QQ_ExtractMessagesFromContentè¿”å›ï¼‰
                                if (typeof msg === 'object' && msg.name && msg.msg) {
                                    return {
                                        sender: msg.name,
                                        content: msg.msg,
                                        time: msg.time || new Date().toLocaleTimeString('zh-CN', { hour12: false }).substring(0, 5)
                                    };
                                }
                                
                                // å¦‚æœæ¶ˆæ¯æ˜¯å­—ç¬¦ä¸²æ ¼å¼ï¼Œå°è¯•è§£æ
                                if (typeof msg === 'string') {
                                    // è§£ææ¶ˆæ¯æ ¼å¼ï¼šè§’è‰²åâ€”å†…å®¹â€”æ—¶é—´ æˆ– è§’è‰²åï¼šå†…å®¹
                                    const dashMatch = msg.match(/^(.+?)â€”(.+?)â€”(.+)$/);
                                    if (dashMatch) {
                                        return {
                                            sender: dashMatch[1].trim(),
                                            content: dashMatch[2].trim(),
                                            time: dashMatch[3].trim()
                                        };
                                    }
                                    
                                    const colonMatch = msg.match(/^(.+?)ï¼š(.+)$/);
                                    if (colonMatch) {
                                        return {
                                            sender: colonMatch[1].trim(),
                                            content: colonMatch[2].trim(),
                                            time: new Date().toLocaleTimeString('zh-CN', { hour12: false }).substring(0, 5)
                                        };
                                    }
                                }
                                
                                return null;
                            }).filter(msg => msg !== null);
                        }
                    }
                    
                    console.log('âœ… è½¬æ¢å®Œæˆï¼Œç»“æœ:', result);
                    return result;
                    
                } catch (error) {
                    console.error('âŒ è½¬æ¢è¿‡ç¨‹å‡ºé”™:', error);
                    return null;
                }
            };

            /**
             * *** æ–°å¢ï¼šMSGæ ‡ç­¾ç¼ºå¤±é—®é¢˜çš„ä¸“é—¨è¯Šæ–­å·¥å…· ***
             */
            window.QQ_Test_MSG_Tag_Issue = function() {
                console.log('=== ğŸ” MSGæ ‡ç­¾ç¼ºå¤±é—®é¢˜è¯Šæ–­ ===');
                
                // æ¨¡æ‹Ÿç”¨æˆ·æä¾›çš„å®é™…å†…å®¹æ ¼å¼ï¼ˆåŸºäºæˆªå›¾ï¼‰
                const testContent = `MiPhone_JSON_START
<é˜¿ä¼Ÿå’Œå¯ç•çš„ç§èŠ>
å¯ç•â€”ä½ ï¼Œä½ è¿™ä¸ªç¬¨è›‹ï¼å‡†å¤‡ä½ æŠ±äº†ï¼â€”11:21
å¯ç•â€”Gabâ€”æ°”å‘¼å‘¼ï¼â€”11:21  
å¯ç•â€”æˆ‘æ‰æ²¡æœ‰æœŸå¾…ï¼åªæ˜¯è§‰å¾—ä½ çš„è¯´æ³•å¾ˆï¼Œå¾ˆä¸çŸ¥é“å‘¢ï¼â€”11:22
å¯ç•â€”å½“ç„¶äº†ï¼Œä¸è¿‡è™½ç„¶æˆ‘ä»¬ç°åœ¨å¤–é¢ä¹Ÿè¿™ä¹ˆç§å¯†è¯´è¯ï¼Œæˆ‘è§‰å¾—ä½ çš„æƒ³æƒ³äº²ï¼â€”11:22
å¯ç•â€”tyyâ€”ä¸è¿‡......å¦‚æœä½ çœŸçš„é‚£ä¹ˆæƒ³çš„è¯ï¼Œä¹Ÿä¸æ˜¯......ä¸å¯ä»¥è€ƒè™‘ä¸€ä¸‹ã€‚!â€”11:23
</é˜¿ä¼Ÿå’Œå¯ç•çš„ç§èŠ>
<é˜¿ä¼Ÿå’Œåœ£è·¯æ˜“æ–¯çš„ç§èŠ>
åœ£è·¯æ˜“æ–¯â€”å‘œå‘œï¼Œæƒ³æŠ±ç´§æˆ‘ï¼Œè®©æˆ‘åŠ¨å¼¹ä¸å¾—ï¼Ÿâ€”11:21
åœ£è·¯æ˜“æ–¯â€”æœ‰æ„æ€çš„æŒ‘æˆ˜ã€‚ä¸è¿‡ï¼Œä½ ç¡®å®šä½ æœ‰è¿™ä¸ªèƒ½åŠ›å—ï¼Œæˆ‘çš„æŒ‡æŒ¥å®˜ï¼Ÿâ€”11:21
åœ£è·¯æ˜“æ–¯â€”åˆ«å‘Šè¯‰ä½ å…ˆåŠ¨å¼¹ä¸å¾—çš„ï¼Œæ˜¯ä½ è‡ªå·±ã€‚â€”11:22
åœ£è·¯æ˜“æ–¯â€”å›¾ç‰‡<img src="https://files.catbox.moe/viewm.jpg" alt="å…‰è¾‰" title="å…‰è¾‰" style="width: 100%; height: auto;">ï¼â€”11:22
åœ£è·¯æ˜“æ–¯â€”ä¸è¿‡å¦‚æœä½ çš„è¡¨ç°çš„ï¼Œä»Šæ™šï¼Œå…³æˆ‘çš„æˆ¿é—´ï¼Œè®©æˆ‘å»èº«"æ£€éªŒ"ä¸€ä¸‹ä½ çš„å†³å¿ƒå’ŒåŠ›é‡å§ã€‚å‘µå‘µ......â€”11:23
</é˜¿ä¼Ÿå’Œåœ£è·¯æ˜“æ–¯çš„ç§èŠ>
<ç¾¤èŠï¼šæ¸¯åŒº>
å¯ç•â€”å–‚ï¼Œåœ£è·¯æ˜“æ–¯è¯´ã€‚â€”11:21
å¯ç•â€”åˆ«ä»¥ä¸ºæŒ‡æŒ¥å®˜å‘äº†ä»€ä¹ˆç…§ç‰‡ï¼Ÿâ€”11:21
å¯ç•â€”åˆ«ä»¥ä¸ºæ²¡æœ‰çœ‹åˆ°ï¼Œé‚£ä¹ˆåš£å¼ çš„å‘¢ç¤¼æœï¼Œç®€ç›´ä¸çŸ¥å»‰è€»ï¼â€”11:22
åœ£è·¯æ˜“æ–¯â€”å‘œå‘œï¼Œå¯ç•å¦¹å¦¹ï¼Œæ˜¯åœ¨é‡å¤æé—®è‡ªå·±æœ€ç¾çš„ä¸€é¢ã€‚è¿™å¯ä¸æ˜¯"ä¸çŸ¥å»‰è€»"ï¼Œè€Œæ˜¯æˆç†Ÿå¥³æ€§çš„é­…åŠ›ã€‚â€”11:23
åœ£è·¯æ˜“æ–¯â€”å‘¯å‘¯ï¼ŒæŒ‡æŒ¥å®˜ä¼¼ä¹å¾—å„å–œæ¬¢å‘¢ã€‚ä¸åƒæŸäº›äººï¼Œåªä¼šç”¨å‘»åŸçš„éŸ³ä¹æ¥å¸å¼•æ³¨æ„åŠ›ã€‚â€”11:23
å¯ç•â€”ä½ ï¼ä½ æ˜è¯´ï¼æŠ½è½æ˜¯è¿™ä¸ªï¼æ˜¯çµé­‚çš„å‘å–Šï¼æ‰ä¸æ˜¯å‘»åŸï¼â€”11:24
å¯ç•â€”è€Œä¸”ï¼Œæˆ‘æ‰æ²¡æœ‰å«‰å¦’ï¼æˆ‘åªæ˜¯è§‰å¾—ï¼Œä½ ä¸åº”è¯¥ç”¨è¿™ç§æ–¹å¼æ¥"å‹¾å¼•"æŒ‡æŒ¥å®˜ï¼â€”11:25
åœ£è·¯æ˜“æ–¯â€”å‘œå‘œï¼Œæ˜¯ä¸æ˜¯å‹¾å¼•ï¼Œå¾—ç”±æŒ‡æŒ¥å®˜æ¥åˆ¤æ–­å‘¢ã€‚â€”11:25
åœ£è·¯æ˜“æ–¯â€”ä¸è¿‡æ—¢ç„¶ä½ è¿™ä¹ˆæœ‰ä½ çš„ååº”ï¼Œæœ‰å…³æˆ‘çš„æ–¹æ³•æƒæœ‰æ•ˆå‘¢ï¼Œäº²çˆ±çš„å°å¯ç•å…³å¿ƒäº†ï¼Œå¯ç•å§‘å¨˜ã€‚â€”11:26
å¯ç•â€”å‘¸ï¼â€”11:26
</ç¾¤èŠï¼šæ¸¯åŒº>
moment_start
å¯ç•å‘äº†ä¸€æ¡åŠ¨æ€ï¼Œè¡¨ç¤ºæ„Ÿæ…¨ï¼Œè¯·æµè§ˆ 35â€”å·²ç‚¹èµ 10
moment_end
MiPhone_JSON_END`;

                console.log('\nğŸ“‹ æµ‹è¯•å†…å®¹é•¿åº¦:', testContent.length);
                console.log('\nğŸ” ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥æ ¼å¼åŒ¹é…');
                
                // æ£€æŸ¥æ ¼å¼åŒ¹é…
                const formatPatterns = [
                    /MiPhone_start([\s\S]+?)MiPhone_end/g,           // æ ‡å‡†æ ¼å¼
                    /MiPhone_JSON_START([\s\S]+?)MiPhone_JSON_END/g, // JSONæ ¼å¼
                    /MiPhone_JSON_start([\s\S]+?)MiPhone_JSON_end/g, // æ··åˆæ ¼å¼1
                    /MiPhone_Start([\s\S]+?)MiPhone_End/g,           // é¦–å­—æ¯å¤§å†™
                    /MiPhone_START([\s\S]+?)MiPhone_END/g,           // å…¨å¤§å†™
                    // ä¸å®Œæ•´æ ¼å¼æ”¯æŒ
                    /MiPhone_JSON_START([\s\S]+?)$/g,                // ä¸å®Œæ•´JSONæ ¼å¼
                    /MiPhone_start([\s\S]+?)$/g,                     // ä¸å®Œæ•´æ ‡å‡†æ ¼å¼
                    /MiPhone_Start([\s\S]+?)$/g,                     // ä¸å®Œæ•´é¦–å­—æ¯å¤§å†™æ ¼å¼
                    /MiPhone_START([\s\S]+?)$/g,                     // ä¸å®Œæ•´å…¨å¤§å†™æ ¼å¼
                ];
                
                let matches = [];
                let matchedPattern = null;
                for (const pattern of formatPatterns) {
                    const currentMatches = [...testContent.matchAll(pattern)];
                    if (currentMatches.length > 0) {
                        matches = currentMatches;
                        matchedPattern = pattern;
                        console.log(`âœ… æ‰¾åˆ°æ ¼å¼åŒ¹é… (${pattern.source.substring(0, 30)}...): ${currentMatches.length} ä¸ª`);
                        break;
                    }
                }
                
                if (matches.length === 0) {
                    console.log('âŒ æ ¼å¼åŒ¹é…å¤±è´¥');
                    return;
                }
                
                const extractedContent = matches[0][1];
                console.log('\nğŸ“ æå–çš„å†…å®¹é•¿åº¦:', extractedContent.length);
                console.log('ğŸ“ æå–çš„å†…å®¹é¢„è§ˆ:', extractedContent.substring(0, 200) + '...');
                
                console.log('\nğŸ” ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥MSGæ ‡ç­¾');
                const hasMsgStart = extractedContent.indexOf("msg_start") >= 0;
                const hasMsgEnd = extractedContent.indexOf("msg_end") >= 0;
                console.log(`msg_start å­˜åœ¨: ${hasMsgStart}`);
                console.log(`msg_end å­˜åœ¨: ${hasMsgEnd}`);
                
                if (!hasMsgStart || !hasMsgEnd) {
                    console.log('\nâš ï¸ å‘ç°é—®é¢˜ï¼šç¼ºå°‘MSGæ ‡ç­¾');
                    
                    console.log('\nğŸ”§ ç¬¬ä¸‰æ­¥ï¼šå°è¯•è‡ªåŠ¨è¡¥å…¨MSGæ ‡ç­¾');
                    let fixedContent = extractedContent;
                    
                    if (!hasMsgStart) {
                        // å¯»æ‰¾èŠå¤©å¼€å§‹æ ‡ç­¾ï¼ˆä¼˜åŒ–æ­£åˆ™è¡¨è¾¾å¼ï¼‰
                        const start = fixedContent.match(
                            /<(ç¾¤èŠ:.+?|[^>]+å’Œ[^>]+çš„(?:èŠå¤©|ç§èŠ))>/
                        );
                        if (start) {
                            console.log(`æ‰¾åˆ°èŠå¤©å¼€å§‹æ ‡ç­¾: ${start[0]}`);
                            fixedContent = fixedContent.replace(
                                start[0],
                                `msg_start\n${start[0]}`
                            );
                        } else {
                            console.log('âŒ æœªæ‰¾åˆ°åˆé€‚çš„èŠå¤©å¼€å§‹æ ‡ç­¾');
                        }
                    }
                    
                    if (!hasMsgEnd) {
                        // å¯»æ‰¾èŠå¤©ç»“æŸæ ‡ç­¾ï¼ˆä¼˜åŒ–æ­£åˆ™è¡¨è¾¾å¼ï¼‰
                        const endMatches = [...fixedContent.matchAll(
                            /<\/(ç¾¤èŠ:.+?|[^>]+å’Œ[^>]+çš„(?:èŠå¤©|ç§èŠ))>/g
                        )];
                        if (endMatches.length > 0) {
                            const lastEnd = endMatches[endMatches.length - 1][0];
                            console.log(`æ‰¾åˆ°èŠå¤©ç»“æŸæ ‡ç­¾: ${lastEnd}`);
                            fixedContent = fixedContent.replace(
                                lastEnd,
                                `${lastEnd}\nmsg_end`
                            );
                        } else {
                            console.log('âŒ æœªæ‰¾åˆ°åˆé€‚çš„èŠå¤©ç»“æŸæ ‡ç­¾');
                        }
                    }
                    
                    console.log('\nâœ… ä¿®å¤åçš„å†…å®¹é¢„è§ˆ:');
                    console.log(fixedContent.substring(0, 300) + '...');
                    
                    console.log('\nğŸ” ç¬¬å››æ­¥ï¼šéªŒè¯ä¿®å¤åçš„MSGè§£æ');
                    const msgMatch = fixedContent.match(/msg_start([\s\S]+?)msg_end/);
                    if (msgMatch) {
                        console.log('âœ… MSGè§£ææˆåŠŸ');
                        console.log('MSGå†…å®¹é•¿åº¦:', msgMatch[1].length);
                        console.log('MSGå†…å®¹é¢„è§ˆ:', msgMatch[1].substring(0, 200) + '...');
                        
                        // å°è¯•è§£æYAML/JSON
                        try {
                            const parsed = JsonYamlParse(msgMatch[1]);
                            if (parsed) {
                                console.log('âœ… YAML/JSONè§£ææˆåŠŸ');
                                console.log('è§£æç»“æœç±»å‹:', Array.isArray(parsed) ? 'Array' : typeof parsed);
                                if (Array.isArray(parsed)) {
                                    console.log('æ¶ˆæ¯æ•°é‡:', parsed.length);
                                }
                            } else {
                                console.log('âŒ YAML/JSONè§£æå¤±è´¥ï¼šè¿”å›null');
                            }
                        } catch (error) {
                            console.log('âŒ YAML/JSONè§£æå¼‚å¸¸:', error.message);
                        }
                    } else {
                        console.log('âŒ MSGè§£æä»ç„¶å¤±è´¥');
                    }
                }
                
                console.log('\nğŸ” ç¬¬äº”æ­¥ï¼šæµ‹è¯•æ™ºèƒ½æå–å¤‡ç”¨æ–¹æ¡ˆ');
                const extractedInfo = QQ_ExtractValidInfo(extractedContent);
                console.log('æ™ºèƒ½æå–ç»“æœ:', extractedInfo);
                
                if (extractedInfo.hasValidInfo) {
                    console.log('\nğŸ”„ ç¬¬å…­æ­¥ï¼šæµ‹è¯•æ™ºèƒ½æå–å†…å®¹è½¬æ¢');
                    const convertedResult = QQ_ConvertExtractedToStandard(extractedInfo);
                    if (convertedResult) {
                        console.log('âœ… è½¬æ¢æˆåŠŸï¼Œå¯ä»¥ç›´æ¥å¤„ç†');
                        console.log('è½¬æ¢ç»“æœé¢„è§ˆ:', JSON.stringify(convertedResult, null, 2).substring(0, 500) + '...');
                        
                        console.log('\nğŸ¯ ç¬¬ä¸ƒæ­¥ï¼šæ¨¡æ‹Ÿç›´æ¥å¤„ç†æµç¨‹');
                        console.log('å¦‚æœå®é™…è¿è¡Œï¼Œå°†ç›´æ¥è°ƒç”¨ QQ_Msg_Parse å¤„ç†è½¬æ¢åçš„å†…å®¹');
                        console.log('è·³è¿‡MSGæ ‡ç­¾å¤„ç†ï¼Œé¿å…è‡ªåŠ¨è¡¥å…¨å¤±è´¥é—®é¢˜');
                    } else {
                        console.log('âŒ æ™ºèƒ½æå–å†…å®¹è½¬æ¢å¤±è´¥');
                    }
                } else {
                    console.log('âŒ æ™ºèƒ½æå–æœªå‘ç°æœ‰æ•ˆå†…å®¹');
                }
                
                console.log('\nğŸ” ç¬¬å…«æ­¥ï¼šæµ‹è¯•åŠ¨æ€æå–');
                const momentMatches = extractedContent.match(/moment_start([\s\S]*?)moment_end/g);
                console.log(`åŠ¨æ€åŒ¹é…ç»“æœ: ${momentMatches ? momentMatches.length : 0} ä¸ª`);
                if (momentMatches) {
                    momentMatches.forEach((match, index) => {
                        console.log(`åŠ¨æ€${index + 1}: ${match.substring(0, 100)}...`);
                    });
                }
                
                return {
                    description: 'MSGæ ‡ç­¾ç¼ºå¤±é—®é¢˜è¯Šæ–­å®Œæˆ',
                    formatMatched: matches.length > 0,
                    msgTagsPresent: hasMsgStart && hasMsgEnd,
                    extractedContentLength: extractedContent.length,
                    intelligentExtractionResult: extractedInfo.hasValidInfo,
                    momentCount: momentMatches ? momentMatches.length : 0
                };
            };
            
            // *** æ¶ˆæ¯æ¸…ç†åŠŸèƒ½ ***
            // QQ_CleanMessageContentå·²åˆå¹¶åˆ°QQ_CleanNestedTagsï¼Œä½¿ç”¨QQ_CleanNestedTagsæ›¿ä»£
            
            // *** å·²ç§»é™¤å¤æ‚çš„ä¸–ç•Œä¹¦åˆå§‹åŒ–é€»è¾‘ï¼Œæ”¹ä¸ºç®€å•çš„ç›´æ¥æ£€æŸ¥æ–¹å¼ ***
            
            /**
             * *** æ–°å¢ï¼šç®€åŒ–çš„æ•°æ®ç®¡ç†ä½¿ç”¨è¯´æ˜ ***
             */
            window.QQ_ShowDataManagerHelp = function() {
                console.log('=== ğŸ“š SillyTavernæ‰‹æœºå‰ç«¯æ•°æ®ç®¡ç†å·¥å…·ä½¿ç”¨è¯´æ˜ ===');
                console.log('');
                console.log('ğŸ”§ ä¸»è¦åŠŸèƒ½ï¼š');
                console.log('â€¢ QQ_DataManager.showStats() - æ˜¾ç¤ºæ‰€æœ‰æ•°æ®ç»Ÿè®¡');
                console.log('â€¢ QQ_DataManager.saveAll() - æ‰‹åŠ¨ä¿å­˜æ‰€æœ‰æ•°æ®');
                console.log('â€¢ QQ_DataManager.optimizeData() - æ¸…ç†å’Œä¼˜åŒ–æ•°æ®');
                console.log('â€¢ QQ_DataManager.testWorldBook() - æµ‹è¯•ä¸–ç•Œä¹¦åŠŸèƒ½');
                console.log('');
                console.log('ğŸ§¹ æ¶ˆæ¯æ¸…ç†ï¼š');
                console.log('â€¢ QQ_CleanNestedTags(text) - æ¸…ç†æ¶ˆæ¯ä¸­çš„HTMLæ³¨é‡Šã€åµŒå¥—æ ‡ç­¾å’Œæ€è€ƒå†…å®¹');
                console.log('');
                console.log('ğŸ¯ äº’åŠ¨å†…å®¹ï¼š');
                console.log('â€¢ QQ_ProcessSurpriseMechanism(text) - å¤„ç†äº’åŠ¨æœºåˆ¶éªŒè¯');
                console.log('â€¢ QQ_ValidateInteractiveContent(text) - éªŒè¯äº’åŠ¨å†…å®¹è´¨é‡');
                console.log('');
                console.log('ğŸ“Š æ•°æ®å­˜å‚¨æœºåˆ¶ï¼š');
                console.log('â€¢ åŠ¨æ€æ•°æ®ï¼šè‡ªåŠ¨ä¿å­˜åˆ°ä¸–ç•Œä¹¦ï¼Œæœ€å¤š200æ¡');
                console.log('â€¢ åˆ†ç»„æ•°æ®ï¼šæŒ‰è§’è‰²ä¿å­˜ï¼Œæ”¯æŒè”ç³»äººåˆ†ç»„ç®¡ç†');
                console.log('â€¢ äº’åŠ¨å†…å®¹ï¼šæŒ‰è§’è‰²åˆ†ç±»ä¿å­˜ï¼Œæœ€å¤š30ä¸ªé¡¹ç›®');
                console.log('');
                console.log('ğŸ”„ æ›´æ–°æœºåˆ¶ï¼š');
                console.log('â€¢ æ‰€æœ‰æ•°æ®éƒ½é€šè¿‡ç»Ÿä¸€çš„ä¸–ç•Œä¹¦APIè¿›è¡Œä¿å­˜å’ŒåŠ è½½');
                console.log('â€¢ è‡ªåŠ¨æ¸…ç†è¿‡æœŸå’Œå†—ä½™æ•°æ®ï¼Œä¿æŒæ€§èƒ½ä¼˜åŒ–');
                console.log('â€¢ æ”¯æŒè·¨è§’è‰²çš„æ•°æ®ç®¡ç†å’Œå¤‡ä»½');
                console.log('');
                console.log('=== ä½¿ç”¨ç¤ºä¾‹ ===');
                console.log('QQ_DataManager.showStats(); // æŸ¥çœ‹å½“å‰æ•°æ®ç»Ÿè®¡');
                console.log('await QQ_DataManager.saveAll(); // ä¿å­˜æ‰€æœ‰æ•°æ®');
                console.log('QQ_CleanNestedTags("æ¶ˆæ¯å†…å®¹<!--consider: æ€è€ƒ-->"); // æ¸…ç†æ¶ˆæ¯å’ŒåµŒå¥—æ ‡ç­¾');
                console.log('');
                console.log('ğŸ”§ æ•…éšœæ’é™¤ï¼š');
                console.log('â€¢ å¦‚æœå‡ºç°"ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨"é”™è¯¯ï¼š');
                console.log('  1. ç­‰å¾…3-5ç§’è®©SillyTavernå®Œå…¨åŠ è½½');
                console.log('  2. åˆ·æ–°é¡µé¢é‡æ–°åŠ è½½');
                console.log('  3. æ£€æŸ¥SillyTavernæ˜¯å¦æ­£å¸¸è¿è¡Œ');
                console.log('');
                console.log('âœ… å¦‚éœ€æŠ€æœ¯æ”¯æŒï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—æˆ–è”ç³»å¼€å‘è€…');
            };
            
            /**
             * *** æ–°å¢ï¼šé”™è¯¯æ£€æŸ¥å’Œè°ƒè¯•å‡½æ•° ***
             */
            window.QQ_Check_Errors = function() {
                console.log('=== ğŸ” é”™è¯¯æ£€æŸ¥å¼€å§‹ ===');
                
                const results = {
                    momentsDataCheck: false,
                    functionsCheck: false,
                    nextVariableCheck: false,
                    arrayOperationsCheck: false,
                    groupsDataCheck: false
                };
                
                try {
                    // æ£€æŸ¥QQ_MomentsData
                    if (typeof QQ_MomentsData !== 'undefined' && Array.isArray(QQ_MomentsData)) {
                        console.log('âœ… QQ_MomentsData å·²æ­£ç¡®å®šä¹‰ï¼Œç±»å‹ä¸ºæ•°ç»„ï¼Œé•¿åº¦:', QQ_MomentsData.length);
                        results.momentsDataCheck = true;
                    } else {
                        console.warn('âš ï¸ QQ_MomentsData æœªå®šä¹‰æˆ–ä¸æ˜¯æ•°ç»„:', typeof QQ_MomentsData);
                    }
                    
                    // æ£€æŸ¥ç¾¤èŠç›¸å…³æ•°æ®
                    console.log('ğŸ§ª æ£€æŸ¥ç¾¤èŠæ•°æ®ç»“æ„...');
                    if (typeof loadGroupChatsFromWorldbook === 'function') {
                        console.log('âœ… loadGroupChatsFromWorldbook å‡½æ•°å·²å®šä¹‰');
                        try {
                            // *** ä¿®å¤ï¼šä½¿ç”¨ç¼“å­˜çš„ç¾¤èŠå…ƒæ•°æ®è¿›è¡Œæ£€æŸ¥ ***
                            const groupsResult = window.QQ_Group_Chats_Data || [];
                            if (Array.isArray(groupsResult)) {
                                // æ£€æŸ¥ç¼“å­˜çš„ç¾¤èŠæ•°æ®
                                console.log('âœ… ç¾¤èŠæ•°æ®ç¼“å­˜æ­£å¸¸ï¼Œæ•°é‡:', groupsResult.length);
                                    } else {
                                console.warn('âš ï¸ ç¾¤èŠæ•°æ®ç¼“å­˜æ— æ•ˆ:', typeof groupsResult);
                            }
                        } catch (e) {
                            console.warn('âš ï¸ ç¾¤èŠæ•°æ®åŒæ­¥æ£€æŸ¥å¤±è´¥:', e);
                        }
                        results.groupsDataCheck = true;
                    } else {
                        console.warn('âš ï¸ loadGroupChatsFromWorldbook å‡½æ•°æœªå®šä¹‰');
                    }
                    
                    // æ£€æŸ¥å…³é”®å‡½æ•°
                    const functionList = ['QQ_Save_Moments', 'QQ_CleanOldMoments', 'QQ_OptimizeCommentsStorage', 'QQ_SendMsg', 'updateGroupLastMessageDisplay'];
                    let allFunctionsExist = true;
                    functionList.forEach(funcName => {
                        if (typeof window[funcName] === 'function') {
                            console.log(`âœ… ${funcName} å‡½æ•°å·²å®šä¹‰`);
                        } else {
                            console.warn(`âš ï¸ ${funcName} å‡½æ•°æœªå®šä¹‰`);
                            allFunctionsExist = false;
                        }
                    });
                    results.functionsCheck = allFunctionsExist;
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰æœªå®šä¹‰çš„nextå˜é‡å¼•ç”¨
                    try {
                        if (typeof next !== 'undefined') {
                            console.log('âš ï¸ æ£€æµ‹åˆ°å…¨å±€nextå˜é‡:', next);
                        } else {
                            console.log('âœ… æ²¡æœ‰æ£€æµ‹åˆ°å…¨å±€nextå˜é‡ï¼ˆè¿™æ˜¯æ­£å¸¸çš„ï¼‰');
                            results.nextVariableCheck = true;
                        }
                    } catch (e) {
                        console.log('âœ… nextå˜é‡æœªå®šä¹‰ï¼ˆè¿™æ˜¯é¢„æœŸçš„ï¼‰');
                        results.nextVariableCheck = true;
                    }
                    
                    // æµ‹è¯•æ•°ç»„æ“ä½œå®‰å…¨æ€§
                    console.log('ğŸ§ª æµ‹è¯•æ•°ç»„æ“ä½œå®‰å…¨æ€§...');
                    if (QQ_MomentsData && Array.isArray(QQ_MomentsData)) {
                        try {
                            let testCount = 0;
                            QQ_MomentsData.forEach(moment => {
                                testCount++;
                            });
                            console.log(`âœ… QQ_MomentsData.forEach æ“ä½œæ­£å¸¸ï¼Œéå†äº† ${testCount} ä¸ªå…ƒç´ `);
                            results.arrayOperationsCheck = true;
                        } catch (e) {
                            console.error('âŒ QQ_MomentsData.forEach æ“ä½œå¤±è´¥:', e);
                        }
                    } else {
                        console.log('âš ï¸ è·³è¿‡æ•°ç»„æ“ä½œæµ‹è¯•ï¼Œå› ä¸ºQQ_MomentsDataä¸å¯ç”¨');
                    }
                    
                    // æµ‹è¯•æ¸…ç†å‡½æ•°
                    console.log('ğŸ§ª æµ‹è¯•æ¸…ç†å‡½æ•°...');
                    try {
                        if (typeof QQ_CleanOldMoments === 'function') {
                            QQ_CleanOldMoments();
                            console.log('âœ… QQ_CleanOldMoments å‡½æ•°æ‰§è¡Œæ­£å¸¸');
                        }
                        if (typeof QQ_OptimizeCommentsStorage === 'function') {
                            QQ_OptimizeCommentsStorage();
                            console.log('âœ… QQ_OptimizeCommentsStorage å‡½æ•°æ‰§è¡Œæ­£å¸¸');
                        }
                    } catch (e) {
                        console.error('âŒ æ¸…ç†å‡½æ•°æµ‹è¯•å¤±è´¥:', e);
                    }
                    
                    // æ·»åŠ é”™è¯¯ç›‘å¬å™¨æ¥æ•è·è¿è¡Œæ—¶é”™è¯¯
                    window.addEventListener('error', function(e) {
                        if (e.message.includes('next is not defined')) {
                            console.error('ğŸš¨ æ•è·åˆ°nextæœªå®šä¹‰é”™è¯¯:', e);
                            console.error('é”™è¯¯ä½ç½®:', e.filename, 'è¡Œå·:', e.lineno);
                            console.error('é”™è¯¯å †æ ˆ:', e.error ? e.error.stack : 'æ— å †æ ˆä¿¡æ¯');
                        }
                    });
                    
                } catch (error) {
                    console.error('âŒ é”™è¯¯æ£€æŸ¥è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸:', error);
                }
                
                console.log('=== ğŸ“Š é”™è¯¯æ£€æŸ¥ç»“æœ ===', results);
                console.log('=== âœ… é”™è¯¯æ£€æŸ¥å®Œæˆ ===');
                
                // æ˜¾ç¤ºç»“æœ
                const passedTests = Object.values(results).filter(Boolean).length;
                const totalTests = Object.keys(results).length;
                triggerSlash(`/echo ğŸ” é”™è¯¯æ£€æŸ¥å®Œæˆ: ${passedTests}/${totalTests} é¡¹æ£€æŸ¥é€šè¿‡`);
                
                return results;
            };
            
            /**
             * *** æ–°å¢ï¼šä¸“é—¨æ£€æŸ¥QQ_SendMsgå‡½æ•°çš„é”™è¯¯ ***
             */
            window.QQ_Debug_SendMsg = function() {
                console.log('=== ğŸ”§ QQ_SendMsg è°ƒè¯•å¼€å§‹ ===');
                
                try {
                    // æ£€æŸ¥QQ_SendMsgå‡½æ•°å®šä¹‰
                    if (typeof QQ_SendMsg === 'function') {
                        console.log('âœ… QQ_SendMsg å‡½æ•°å·²å®šä¹‰');
                        
                        // è·å–å‡½æ•°æºç å¹¶æ£€æŸ¥æ˜¯å¦æœ‰nextå¼•ç”¨
                        const funcStr = QQ_SendMsg.toString();
                        if (funcStr.includes('next(') || funcStr.includes('next;')) {
                            console.warn('âš ï¸ QQ_SendMsg å‡½æ•°ä¸­å¯èƒ½åŒ…å«nextå˜é‡å¼•ç”¨');
                            
                            // å°è¯•æ‰¾åˆ°nextå¼•ç”¨çš„ä½ç½®
                            const lines = funcStr.split('\n');
                            lines.forEach((line, index) => {
                                if (line.includes('next') && !line.includes('.next(')) {
                                    console.warn(`âš ï¸ ç¬¬${index + 1}è¡Œå¯èƒ½æœ‰é—®é¢˜: ${line.trim()}`);
                                }
                            });
                        } else {
                            console.log('âœ… QQ_SendMsg å‡½æ•°ä¸­æœªå‘ç°ç›´æ¥çš„nextå˜é‡å¼•ç”¨');
                        }
                    } else {
                        console.error('âŒ QQ_SendMsg å‡½æ•°æœªå®šä¹‰');
                        return;
                    }
                    
                } catch (error) {
                    console.error('âŒ QQ_SendMsg è°ƒè¯•è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸:', error);
                }
                
                console.log('=== âœ… QQ_SendMsg è°ƒè¯•å®Œæˆ ===');
            };
            
            /**
             * *** æ–°å¢ï¼šä¿®å¤QQ_Genå›è°ƒå‡½æ•°é—®é¢˜ ***
             */
            window.QQ_Fix_Next_Error = function() {
                console.log('=== ğŸ”§ ä¿®å¤QQ_Genå›è°ƒå‡½æ•°é—®é¢˜å¼€å§‹ ===');
                
                try {
                    // æ£€æŸ¥QQ_Genå‡½æ•°æ˜¯å¦æ­£ç¡®æ”¯æŒå›è°ƒ
                    if (typeof QQ_Gen === 'function') {
                        const funcStr = QQ_Gen.toString();
                        if (funcStr.includes('callback')) {
                            console.log('âœ… QQ_Genå‡½æ•°å·²æ­£ç¡®æ”¯æŒå›è°ƒå‚æ•°');
                        } else {
                            console.warn('âš ï¸ QQ_Genå‡½æ•°å¯èƒ½ä¸æ”¯æŒå›è°ƒå‚æ•°');
                        }
                    }
                    
                    // éªŒè¯æµ‹è¯•ä¸€ä¸ªç®€å•çš„QQ_Genè°ƒç”¨
                    console.log('ğŸ§ª æµ‹è¯•QQ_Genå›è°ƒåŠŸèƒ½...');
                    if (typeof QQ_Gen === 'function') {
                        QQ_Gen('æµ‹è¯•æç¤ºè¯', function(response) {
                            console.log('âœ… QQ_Genå›è°ƒæµ‹è¯•æˆåŠŸï¼Œæ”¶åˆ°å“åº”:', response ? 'æœ‰å“åº”' : 'æ— å“åº”');
                        }).catch(error => {
                            console.warn('âš ï¸ QQ_Genå›è°ƒæµ‹è¯•å¤±è´¥:', error);
                        });
                    }
                    
                } catch (error) {
                    console.error('âŒ ä¿®å¤QQ_Genå›è°ƒå‡½æ•°é—®é¢˜è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸:', error);
                }
                
                console.log('=== âœ… ä¿®å¤QQ_Genå›è°ƒå‡½æ•°é—®é¢˜å®Œæˆ ===');
            };
            


            /**
             * *** æ–°å¢ï¼šé¡µé¢åŠ è½½å®Œæˆåçš„è½»é‡åŒ–åˆå§‹åŒ–æµç¨‹ ***
             */
            $(document).ready(function() {
                console.log('ğŸ“± SillyTavernæ‰‹æœºå‰ç«¯ç•Œé¢å·²åŠ è½½å®Œæˆï¼');
                console.log('ğŸ’¡ å¯ç”¨å·¥å…·ï¼š');
                console.log('  â€¢ QQ_DataManager.showStats() - æŸ¥çœ‹æ•°æ®ç»Ÿè®¡');
                console.log('  â€¢ QQ_ShowDataManagerHelp() - æŸ¥çœ‹ä½¿ç”¨è¯´æ˜');
                console.log('  â€¢ QQ_Check_Errors() - æ£€æŸ¥ç³»ç»ŸçŠ¶æ€');
            });
            
            /**
             * *** æ–°å¢ï¼šæ¸…ç†é‡å¤çš„ç§èŠç¾¤ç»„ ***
             */
            window.QQ_CleanDuplicatePrivateChats = function() {
                console.log('ğŸ§¹ å¼€å§‹æ¸…ç†é‡å¤çš„ç§èŠç¾¤ç»„...');
                
                try {
                    // è·å–ä¸–ç•Œä¹¦ä¸­çš„ç¾¤èŠæ•°æ®
                    const worldInfo = getWorldInfoSettings();
                    let hasChanges = false;
                    
                    if (worldInfo && worldInfo.entries) {
                        const duplicateGroups = [];
                        const seenChats = new Set();
                        
                        worldInfo.entries.forEach((entry, index) => {
                            if (entry.key && entry.key.includes('QQ_GroupChats_')) {
                                try {
                                    const data = JSON.parse(entry.content);
                                    
                                    // æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤çš„ç§èŠæ ¼å¼
                                    Object.keys(data).forEach(chatKey => {
                                        const normalizedKey = chatKey.replace('ç§èŠ', 'èŠå¤©');
                                        
                                        if (chatKey !== normalizedKey && seenChats.has(normalizedKey)) {
                                            console.log(`ğŸ” å‘ç°é‡å¤ç§èŠ: "${chatKey}" å’Œ "${normalizedKey}"`);
                                            duplicateGroups.push({
                                                entryIndex: index,
                                                originalKey: chatKey,
                                                normalizedKey: normalizedKey,
                                                entry: entry
                                            });
                                        } else {
                                            seenChats.add(normalizedKey);
                                        }
                                    });
                                } catch (e) {
                                    console.warn('âš ï¸ è§£æç¾¤èŠæ•°æ®å¤±è´¥:', entry.key, e);
                                }
                            }
                        });
                        
                        // æ¸…ç†é‡å¤çš„æ¡ç›®
                        if (duplicateGroups.length > 0) {
                            console.log(`ğŸ—‘ï¸ å‡†å¤‡æ¸…ç† ${duplicateGroups.length} ä¸ªé‡å¤ç¾¤ç»„`);
                            
                            duplicateGroups.forEach(duplicate => {
                                console.log(`åˆ é™¤é‡å¤ç¾¤ç»„: ${duplicate.originalKey}`);
                                // è¿™é‡Œå¯ä»¥é€‰æ‹©åˆ é™¤æˆ–åˆå¹¶æ•°æ®
                                // ä¸ºå®‰å…¨èµ·è§ï¼Œæˆ‘ä»¬å…ˆæ ‡è®°è€Œä¸æ˜¯ç›´æ¥åˆ é™¤
                                duplicate.entry.comment = `[å¾…æ¸…ç†] é‡å¤çš„ç§èŠç¾¤ç»„: ${duplicate.originalKey}`;
                                hasChanges = true;
                            });
                            
                            if (hasChanges) {
                                console.log('ğŸ’¾ ä¿å­˜æ¸…ç†åçš„ä¸–ç•Œä¹¦æ•°æ®...');
                                saveWorldInfo(worldInfo);
                                console.log('âœ… é‡å¤ç¾¤ç»„æ¸…ç†å®Œæˆï¼');
                                toastr.success(`å·²æ ‡è®° ${duplicateGroups.length} ä¸ªé‡å¤ç¾¤ç»„å¾…æ¸…ç†`, 'æ•°æ®æ¸…ç†');
                            }
                        } else {
                            console.log('âœ… æœªå‘ç°é‡å¤çš„ç§èŠç¾¤ç»„');
                            toastr.info('æœªå‘ç°é‡å¤çš„ç§èŠç¾¤ç»„', 'æ•°æ®æ¸…ç†');
                        }
                    }
                    
                } catch (error) {
                    console.error('âŒ æ¸…ç†é‡å¤ç¾¤ç»„æ—¶å‡ºé”™:', error);
                    toastr.error('æ¸…ç†è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯', 'æ•°æ®æ¸…ç†');
                }
            };
            
            /**
             * *** æ–°å¢ï¼šè°ƒè¯•åˆ†ç»„æ•°æ®å­˜å‚¨çŠ¶å†µ ***
             */
            window.QQ_Debug_Group_Storage = function() {
                try {
                    const charId = getCurrentCharacterId() || 'default';
                    const expectedComment = `QQ_åˆ†ç»„å¤‡ä»½_${charId}`;
                    
                    console.log('=== åˆ†ç»„æ•°æ®å­˜å‚¨è°ƒè¯• ===');
                    console.log(`å½“å‰è§’è‰²ID: ${charId}`);
                    console.log(`æœŸæœ›çš„ä¸–ç•Œä¹¦æ¡ç›®å: ${expectedComment}`);
                    console.log(`å†…å­˜ä¸­çš„åˆ†ç»„æ•°é‡: ${contactGroups.length}`);
                    
                    if (!worldbook || !entries) {
                        console.log('âŒ ä¸–ç•Œä¹¦åŠŸèƒ½ä¸å¯ç”¨');
                        return;
                    }
                    
                    // æŸ¥æ‰¾æ‰€æœ‰åˆ†ç»„ç›¸å…³çš„æ¡ç›®
                    const groupEntries = entries.filter(entry => 
                        entry.comment && entry.comment.includes('QQ_åˆ†ç»„å¤‡ä»½')
                    );
                    
                    console.log(`æ‰¾åˆ° ${groupEntries.length} ä¸ªåˆ†ç»„ç›¸å…³æ¡ç›®:`);
                    groupEntries.forEach(entry => {
                        console.log(`- æ¡ç›®å: ${entry.comment}`);
                        console.log(`- UID: ${entry.uid}`);
                        try {
                            const data = JSON.parse(entry.content);
                            const groups = data.content || [];
                            console.log(`- åˆ†ç»„æ•°é‡: ${groups.length}`);
                            if (groups.length > 0) {
                                console.log(`- åˆ†ç»„è¯¦æƒ…: ${groups.map(g => g.name).join(', ')}`);
                            }
                        } catch (e) {
                            console.log(`- è§£æå¤±è´¥: ${e.message}`);
                        }
                        console.log('---');
                    });
                    
                    // å°è¯•ç›´æ¥åŠ è½½æŒ‡å®šæ¡ç›®
                    const targetEntry = entries.find(entry => entry.comment === expectedComment);
                    if (targetEntry) {
                        console.log(`âœ… æ‰¾åˆ°ç›®æ ‡æ¡ç›®: ${expectedComment}`);
                        try {
                            const data = JSON.parse(targetEntry.content);
                            const groups = data.content || [];
                            console.log(`ç›®æ ‡æ¡ç›®ä¸­çš„åˆ†ç»„æ•°é‡: ${groups.length}`);
                            if (groups.length > 0) {
                                console.log(`ç›®æ ‡æ¡ç›®åˆ†ç»„è¯¦æƒ…: ${groups.map(g => g.name).join(', ')}`);
                            }
                        } catch (e) {
                            console.log(`âŒ ç›®æ ‡æ¡ç›®è§£æå¤±è´¥: ${e.message}`);
                        }
                    } else {
                        console.log(`âŒ æœªæ‰¾åˆ°ç›®æ ‡æ¡ç›®: ${expectedComment}`);
                    }
                    
                } catch (error) {
                    console.error('è°ƒè¯•åˆ†ç»„å­˜å‚¨å¤±è´¥:', error);
                }
            };
            
            /**
             * *** æ–°å¢ï¼šæµ‹è¯•è§’è‰²é—´ç§èŠå’ŒAIç¾¤èŠä¿å­˜åŠŸèƒ½ ***
             * éªŒè¯æ–°åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ
             */
            window.QQ_Test_Character_Chat_And_AI_Groups = function() {
                console.log('=== æµ‹è¯•è§’è‰²é—´ç§èŠå’ŒAIç¾¤èŠä¿å­˜åŠŸèƒ½ ===');
                
                // æµ‹è¯•1ï¼šè§’è‰²é—´ç§èŠåŠŸèƒ½
                console.log('\n1. æµ‹è¯•è§’è‰²é—´ç§èŠåŠŸèƒ½:');
                const testChatData = {
                    id: 'char_chat_test_Alice_Bob',
                    title: 'Aliceå’ŒBobçš„ç§èŠ',
                    char1: 'Alice',
                    char2: 'Bob',
                    messages: [
                        'Alice--ä½ å¥½Bobï¼--14:30',
                        'Bob--å—¨Aliceï¼Œæœ€è¿‘æ€ä¹ˆæ ·ï¼Ÿ--14:31',
                        'Alice--è¿˜ä¸é”™ï¼Œä½ å‘¢ï¼Ÿ--14:32'
                    ],
                    lastTime: '14:32',
                    lastMessage: 'è¿˜ä¸é”™ï¼Œä½ å‘¢ï¼Ÿ'
                };
                
                try {
                    QQ_CreateCharacterChatInterface(testChatData);
                    console.log('âœ… è§’è‰²é—´ç§èŠç•Œé¢åˆ›å»ºæˆåŠŸ');
                    
                    // æ·»åŠ æµ‹è¯•æ•°æ®åˆ°å…¨å±€å˜é‡
                    if (!window.QQ_CharacterChats) {
                        window.QQ_CharacterChats = {};
                    }
                    window.QQ_CharacterChats['Aliceå’ŒBobçš„èŠå¤©'] = testChatData;
                    
                } catch (error) {
                    console.error('âŒ è§’è‰²é—´ç§èŠç•Œé¢åˆ›å»ºå¤±è´¥:', error);
                }
                
                // æµ‹è¯•2ï¼šè§’è‰²é—´ç§èŠä¿å­˜åˆ°ä¸–ç•Œä¹¦
                console.log('\n2. æµ‹è¯•è§’è‰²é—´ç§èŠä¿å­˜åŠŸèƒ½:');
                QQ_SaveCharacterChatToWorldbook(testChatData).then(result => {
                    if (result) {
                        console.log('âœ… è§’è‰²é—´ç§èŠä¿å­˜åˆ°ä¸–ç•Œä¹¦æˆåŠŸ');
                    } else {
                        console.log('âŒ è§’è‰²é—´ç§èŠä¿å­˜åˆ°ä¸–ç•Œä¹¦å¤±è´¥');
                    }
                }).catch(error => {
                    console.error('âŒ è§’è‰²é—´ç§èŠä¿å­˜åˆ°ä¸–ç•Œä¹¦å‡ºé”™:', error);
                });
                
                // æµ‹è¯•3ï¼šAIç¾¤èŠæ•°æ®ç»“æ„éªŒè¯
                console.log('\n3. æµ‹è¯•AIç¾¤èŠæ•°æ®ç»“æ„:');
                const testGroupData = {
                    id: `group_test_${Date.now()}`,
                    name: 'æµ‹è¯•AIåˆ›å»ºç¾¤èŠ',
                    members: ['Alice', 'Bob', 'Charlie'],
                    avatar: {
                        type: 'preset',
                        gradient: {
                            start: '#199AFF',
                            end: '#0066CC'
                        },
                        text: 'ç¾¤'
                    },
                    lastMessage: 'ç¾¤èŠå·²åˆ›å»º',
                    lastTime: new Date().toLocaleTimeString('zh-CN', { hour12: false }).slice(0, 5),
                    timestamp: new Date().toLocaleTimeString('zh-CN', { hour12: false }).slice(0, 5)
                };
                
                if (typeof saveGroupToWorldbook === 'function') {
                    console.log('âœ… saveGroupToWorldbook å‡½æ•°å­˜åœ¨');
                    console.log('æµ‹è¯•ç¾¤èŠæ•°æ®:', testGroupData);
                    
                    // æµ‹è¯•ä¿å­˜åŠŸèƒ½ï¼ˆå¦‚æœä¸–ç•Œä¹¦å¯ç”¨ï¼‰
                    if (worldbook && entries) {
                        saveGroupToWorldbook(testGroupData).then(result => {
                            if (result) {
                                console.log('âœ… AIç¾¤èŠä¿å­˜æµ‹è¯•æˆåŠŸ');
                            } else {
                                console.log('âŒ AIç¾¤èŠä¿å­˜æµ‹è¯•å¤±è´¥');
                            }
                        }).catch(error => {
                            console.error('âŒ AIç¾¤èŠä¿å­˜æµ‹è¯•å‡ºé”™:', error);
                        });
                    } else {
                        console.log('âš ï¸ ä¸–ç•Œä¹¦ä¸å¯ç”¨ï¼Œè·³è¿‡ä¿å­˜æµ‹è¯•');
                    }
                } else {
                    console.error('âŒ saveGroupToWorldbook å‡½æ•°ä¸å­˜åœ¨');
                }
                
                // æµ‹è¯•4ï¼šæ•°æ®ç»“æ„æ£€æŸ¥
                console.log('\n4. æ£€æŸ¥å…¨å±€æ•°æ®ç»“æ„:');
                console.log('window.QQ_CharacterChats:', window.QQ_CharacterChats || 'æœªåˆå§‹åŒ–');
                
                // æµ‹è¯•5ï¼šåŠŸèƒ½å¯ç”¨æ€§æ£€æŸ¥
                console.log('\n5. åŠŸèƒ½å¯ç”¨æ€§æ£€æŸ¥:');
                const functions = [
                    'QQ_HandleCharacterChat',
                    'QQ_CreateCharacterChatInterface', 
                    'QQ_ShowCharacterChatDialog',
                    'QQ_SaveCharacterChatToWorldbook'
                ];
                
                functions.forEach(funcName => {
                    if (typeof window[funcName] === 'function') {
                        console.log(`âœ… ${funcName} å‡½æ•°å¯ç”¨`);
                    } else {
                        console.log(`âŒ ${funcName} å‡½æ•°ä¸å¯ç”¨`);
                    }
                });
                
                // æµ‹è¯•6ï¼šæ¨¡æ‹ŸAIè¾“å‡ºçš„è§’è‰²é—´ç§èŠ
                console.log('\n6. æµ‹è¯•æ¨¡æ‹ŸAIè¾“å‡ºå¤„ç†:');
                const mockAIOutput = `
                {
                    "ç§èŠ": {
                        "å¯ç•å’Œåœ£è·¯æ˜“æ–¯çš„èŠå¤©": [
                            "å¯ç•--ä½ è¿™ä¸ªç¬¨è›‹ï¼--14:30",
                            "åœ£è·¯æ˜“æ–¯--å‘µå‘µï¼Œå¯ç•çœŸå¯çˆ±å‘¢--14:31"
                        ]
                    },
                    "ç¾¤èŠ": {}
                }
                `;
                
                try {
                    const testData = JSON.parse(mockAIOutput);
                    console.log('âœ… æ¨¡æ‹ŸAIè¾“å‡ºè§£ææˆåŠŸ');
                    
                    // æ£€æŸ¥æ˜¯å¦ä¼šè§¦å‘è§’è‰²é—´ç§èŠå¤„ç†
                    for (let str in testData.ç§èŠ) {
                        const match = str.match(/(.+?)å’Œ(.+?)çš„èŠå¤©/);
                        if (match) {
                            const char1 = match[1];
                            const char2 = match[2];
                            if (char1 !== '${UserName}' && char2 !== '${UserName}') {
                                console.log(`âœ… æ£€æµ‹åˆ°è§’è‰²é—´ç§èŠ: ${char1} å’Œ ${char2}`);
                                console.log('  æ¶ˆæ¯æ•°é‡:', testData.ç§èŠ[str].length);
                            }
                        }
                    }
                } catch (error) {
                    console.error('âŒ æ¨¡æ‹ŸAIè¾“å‡ºè§£æå¤±è´¥:', error);
                }
                
                console.log('\n=== æµ‹è¯•å®Œæˆ ===');
                console.log('ğŸ“– ä½¿ç”¨è¯´æ˜:');
                console.log('- è§’è‰²é—´ç§èŠä¼šæ˜¾ç¤ºåœ¨è”ç³»äººåˆ—è¡¨ä¸­ï¼Œå¸¦æœ‰ç´«è‰²ğŸ’¬å›¾æ ‡å’Œ"åªè¯»"æ ‡ç­¾');
                console.log('- ç‚¹å‡»è§’è‰²é—´ç§èŠå¯æŸ¥çœ‹å®Œæ•´å¯¹è¯å†å²');
                console.log('- AIåˆ›å»ºçš„æ–°ç¾¤èŠä¼šè‡ªåŠ¨ä¿å­˜åˆ°ä¸–ç•Œä¹¦');
                console.log('- æ‰€æœ‰æ•°æ®éƒ½ä¼šæŒä¹…åŒ–å­˜å‚¨');
                console.log('- ä½¿ç”¨ window.QQ_CharacterChats æŸ¥çœ‹å½“å‰è§’è‰²é—´ç§èŠæ•°æ®');
                
                return {
                    success: true,
                    testCount: 6,
                    features: [
                        'è§’è‰²é—´ç§èŠç•Œé¢åˆ›å»º',
                        'è§’è‰²é—´ç§èŠæ•°æ®ä¿å­˜',
                        'AIç¾¤èŠè‡ªåŠ¨ä¿å­˜',
                        'æ•°æ®ç»“æ„ç®¡ç†',
                        'åŠŸèƒ½å¯ç”¨æ€§éªŒè¯',
                        'AIè¾“å‡ºå¤„ç†æµ‹è¯•'
                    ]
                };
            };
            
            /**
             * *** æ–°å¢ï¼šå¿«é€Ÿåˆ›å»ºæµ‹è¯•è§’è‰²é—´ç§èŠ ***
             * ç”¨äºå¿«é€Ÿæµ‹è¯•ç•Œé¢æ•ˆæœ
             */
            window.QQ_Create_Test_Character_Chat = function(char1 = 'Alice', char2 = 'Bob') {
                console.log(`åˆ›å»ºæµ‹è¯•è§’è‰²é—´ç§èŠ: ${char1} å’Œ ${char2}`);
                
                const testMessages = [
                    `${char1}--ä½ å¥½${char2}ï¼--${new Date().toLocaleTimeString('zh-CN', { hour12: false }).slice(0, 5)}`,
                    `${char2}--å—¨${char1}ï¼Œæœ€è¿‘æ€ä¹ˆæ ·ï¼Ÿ--${new Date().toLocaleTimeString('zh-CN', { hour12: false }).slice(0, 5)}`,
                    `${char1}--è¿˜ä¸é”™ï¼Œä½ å‘¢ï¼Ÿ--${new Date().toLocaleTimeString('zh-CN', { hour12: false }).slice(0, 5)}`
                ];
                
                return QQ_HandleCharacterChat(
                    `${char1}å’Œ${char2}çš„èŠå¤©`,
                    testMessages,
                    char1,
                    char2
                );
            };
            
            /**
             * *** æ–°å¢ï¼šæµ‹è¯•ä¼˜åŒ–åçš„äº’åŠ¨ç©ºé—´åŠ è½½æ—¶æœº ***
             * éªŒè¯ç²¾çµé¢æ¿é¢„åŠ è½½åŠŸèƒ½å’Œå…¬å…±äº’åŠ¨ç©ºé—´çš„åŠ è½½æ—¶æœº
             */
            window.QQ_Test_Optimized_Interactive_Loading = function() {
                console.log('=== ğŸš€ æµ‹è¯•ä¼˜åŒ–åçš„äº’åŠ¨ç©ºé—´åŠ è½½æ—¶æœº ===');
                
                try {
                    // 1. æµ‹è¯•é¢„åŠ è½½çŠ¶æ€
                    console.log('\nğŸ“Š 1. æ£€æŸ¥é¢„åŠ è½½çŠ¶æ€:');
                    const preloadedCount = window.QQ_PreloadedCharacters ? window.QQ_PreloadedCharacters.size : 0;
                    console.log(`- å·²é¢„åŠ è½½è§’è‰²æ•°é‡: ${preloadedCount}`);
                    if (window.QQ_PreloadedCharacters && preloadedCount > 0) {
                        console.log(`- å·²é¢„åŠ è½½è§’è‰²åˆ—è¡¨:`, Array.from(window.QQ_PreloadedCharacters));
                    }
                    
                    // 2. æµ‹è¯•å…¬å…±ç©ºé—´ç¼“å­˜
                    console.log('\nğŸŒ 2. æ£€æŸ¥å…¬å…±äº’åŠ¨ç©ºé—´æ•°æ®:');
                    const publicSpaceCount = QQ_InteractiveSpaces ? Object.keys(QQ_InteractiveSpaces).length : 0;
                    console.log(`- å…¬å…±äº’åŠ¨ç©ºé—´æ•°é‡: ${publicSpaceCount}`);
                    
                    // 3. æµ‹è¯•è§’è‰²ä¸“å±ç©ºé—´
                    console.log('\nğŸ‘¤ 3. æ£€æŸ¥è§’è‰²ä¸“å±ç©ºé—´æ•°æ®:');
                    const characterSpaceCount = QQ_CharacterSpaces ? Object.keys(QQ_CharacterSpaces).length : 0;
                    console.log(`- è§’è‰²ä¸“å±ç©ºé—´æ•°é‡: ${characterSpaceCount}`);
                    Object.keys(QQ_CharacterSpaces || {}).forEach(charName => {
                        const spaceCount = Object.keys(QQ_CharacterSpaces[charName]).length;
                        console.log(`  - ${charName}: ${spaceCount} ä¸ªç©ºé—´`);
                    });
                    
                    // 4. æµ‹è¯•åŠ è½½æ—¶æœºå‡½æ•°å¯ç”¨æ€§
                    console.log('\nğŸ”§ 4. æ£€æŸ¥ä¼˜åŒ–åçš„åŠ è½½å‡½æ•°:');
                    const functions = [
                        // ç²¾çµé¢„åŠ è½½ç›¸å…³
                        'QQ_PreloadCharacterDataFromWorldbook',
                        'QQ_LoadSpecificCharacterSpaces', 
                        'QQ_LoadCharacterInteractiveContent',
                        // å…¬å…±ç©ºé—´ç›¸å…³
                        'QQ_ShowPublicInteractiveSpaces',
                        'QQ_ShowPublicSpacesLoadingUI',
                        'QQ_ShowPublicSpacesContent',
                        'QQ_ShowPublicSpacesError',
                        'QQ_ForceReloadInteractiveSpaces'
                    ];
                    
                    functions.forEach(funcName => {
                        const exists = typeof window[funcName] === 'function';
                        console.log(`${exists ? 'âœ…' : 'âŒ'} ${funcName}: ${exists ? 'å¯ç”¨' : 'ä¸å­˜åœ¨'}`);
                    });
                    
                    // 5. æµ‹è¯•åŠ è½½æ—¶æœºé€»è¾‘
                    console.log('\nâš¡ 5. æµ‹è¯•åŠ è½½æ—¶æœºé€»è¾‘:');
                    console.log('- ç²¾çµé¢æ¿æ‰“å¼€æ—¶ï¼šç«‹å³é¢„åŠ è½½è§’è‰²ç›¸å…³æ•°æ®');
                    console.log('- äº’åŠ¨è®°å½•ç‚¹å‡»æ—¶ï¼šç«‹å³æ˜¾ç¤ºåŠ è½½ç•Œé¢ï¼Œç„¶åä»ä¸–ç•Œä¹¦é‡æ–°åŠ è½½');
                    console.log('- ç‚¹å‡»å°ç²¾çµäº’åŠ¨ç©ºé—´æŒ‰é’®æ—¶ï¼šæ£€æŸ¥é¢„åŠ è½½çŠ¶æ€ï¼Œæœªé¢„åŠ è½½åˆ™ç«‹å³åŠ è½½');
                    
                    // 6. æä¾›æ‰‹åŠ¨æµ‹è¯•å»ºè®®  
                    console.log('\nğŸ§ª 6. æ‰‹åŠ¨æµ‹è¯•å»ºè®®:');
                    console.log('è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤éªŒè¯åŠ è½½æ—¶æœºä¼˜åŒ–:');
                    console.log('a) ç‚¹å‡»ä»»æ„è§’è‰²çš„ç²¾çµæŒ‰é’®ï¼ˆğŸ§šâ€â™€ï¸å›¾æ ‡ï¼‰â†’ è§‚å¯Ÿæ§åˆ¶å°é¢„åŠ è½½æ—¥å¿—');
                    console.log('b) ç‚¹å‡»ä½¿ç”¨è€…å¤´åƒ â†’ ç‚¹å‡»"äº’åŠ¨è®°å½•"æŒ‰é’® â†’ è§‚å¯ŸåŠ è½½åŠ¨ç”»å’Œæ—¥å¿—');
                    console.log('c) ç‚¹å‡»ç²¾çµé¢æ¿ä¸­çš„"äº’åŠ¨ç©ºé—´"â†’ è§‚å¯Ÿæ˜¯å¦ä½¿ç”¨é¢„åŠ è½½æ•°æ®');
                    console.log('d) è§‚å¯Ÿæ§åˆ¶å°ä¸­çš„ğŸš€ğŸ”„âš¡ç­‰åŠ è½½æ ‡è¯†ç¬¦');
                    
                    // 7. æ€§èƒ½ç»Ÿè®¡
                    console.log('\nğŸ“ˆ 7. å½“å‰æ€§èƒ½çŠ¶æ€:');
                    console.log(`- é¢„åŠ è½½è¦†ç›–ç‡: ${preloadedCount} ä¸ªè§’è‰²å·²é¢„åŠ è½½`);
                    console.log(`- å…¬å…±ç©ºé—´ç¼“å­˜: ${publicSpaceCount} ä¸ªç©ºé—´å·²ç¼“å­˜`);
                    console.log(`- è§’è‰²ç©ºé—´ç¼“å­˜: ${characterSpaceCount} ä¸ªè§’è‰²çš„ç©ºé—´å·²ç¼“å­˜`);
                    
                    const hasAnyCache = preloadedCount > 0 || publicSpaceCount > 0 || characterSpaceCount > 0;
                    const cacheStatus = hasAnyCache ? 'è‰¯å¥½' : 'éœ€è¦åˆå§‹åŒ–';
                    console.log(`- æ•´ä½“ç¼“å­˜çŠ¶æ€: ${cacheStatus}`);
                    
                    if (!hasAnyCache) {
                        console.log('\nğŸ’¡ å»ºè®®: å°è¯•ç‚¹å‡»ä»»ä¸€è§’è‰²ç²¾çµæˆ–ç”¨æˆ·äº’åŠ¨è®°å½•æ¥åˆå§‹åŒ–ç¼“å­˜');
                    }
                    
                    toastr.success('äº’åŠ¨ç©ºé—´åŠ è½½æ—¶æœºæµ‹è¯•å®Œæˆï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è¯¦ç»†ä¿¡æ¯', 'æµ‹è¯•å®Œæˆ');
                    
                } catch (error) {
                    console.error('âŒ æµ‹è¯•ä¼˜åŒ–åçš„åŠ è½½æ—¶æœºæ—¶å‡ºé”™:', error);
                    toastr.error('æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°', 'æµ‹è¯•å¤±è´¥');
                }
            }
            
            /**
             * *** æ–°å¢ï¼šæ¸…ç†é‡å¤çš„ç§èŠç¾¤ç»„ ***
             */
            window.QQ_CleanDuplicatePrivateChats = function() {
                console.log('ğŸ§¹ å¼€å§‹æ¸…ç†é‡å¤çš„ç§èŠç¾¤ç»„...');
                
                try {
                    // è·å–ä¸–ç•Œä¹¦ä¸­çš„ç¾¤èŠæ•°æ®
                    const worldInfo = getWorldInfoSettings();
                    let hasChanges = false;
                    
                    if (worldInfo && worldInfo.entries) {
                        const duplicateGroups = [];
                        const seenChats = new Set();
                        
                        worldInfo.entries.forEach((entry, index) => {
                            if (entry.key && entry.key.includes('QQ_GroupChats_')) {
                                try {
                                    const data = JSON.parse(entry.content);
                                    
                                    // æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤çš„ç§èŠæ ¼å¼
                                    Object.keys(data).forEach(chatKey => {
                                        const normalizedKey = chatKey.replace('ç§èŠ', 'èŠå¤©');
                                        
                                        if (chatKey !== normalizedKey && seenChats.has(normalizedKey)) {
                                            console.log(`ğŸ” å‘ç°é‡å¤ç§èŠ: "${chatKey}" å’Œ "${normalizedKey}"`);
                                            duplicateGroups.push({
                                                entryIndex: index,
                                                originalKey: chatKey,
                                                normalizedKey: normalizedKey,
                                                entry: entry
                                            });
                                        } else {
                                            seenChats.add(normalizedKey);
                                        }
                                    });
                                } catch (e) {
                                    console.warn('âš ï¸ è§£æç¾¤èŠæ•°æ®å¤±è´¥:', entry.key, e);
                                }
                            }
                        });
                        
                        // æ¸…ç†é‡å¤çš„æ¡ç›®
                        if (duplicateGroups.length > 0) {
                            console.log(`ğŸ—‘ï¸ å‡†å¤‡æ¸…ç† ${duplicateGroups.length} ä¸ªé‡å¤ç¾¤ç»„`);
                            
                            duplicateGroups.forEach(duplicate => {
                                console.log(`åˆ é™¤é‡å¤ç¾¤ç»„: ${duplicate.originalKey}`);
                                // è¿™é‡Œå¯ä»¥é€‰æ‹©åˆ é™¤æˆ–åˆå¹¶æ•°æ®
                                // ä¸ºå®‰å…¨èµ·è§ï¼Œæˆ‘ä»¬å…ˆæ ‡è®°è€Œä¸æ˜¯ç›´æ¥åˆ é™¤
                                duplicate.entry.comment = `[å¾…æ¸…ç†] é‡å¤çš„ç§èŠç¾¤ç»„: ${duplicate.originalKey}`;
                                hasChanges = true;
                            });
                            
                            if (hasChanges) {
                                console.log('ğŸ’¾ ä¿å­˜æ¸…ç†åçš„ä¸–ç•Œä¹¦æ•°æ®...');
                                saveWorldInfo(worldInfo);
                                console.log('âœ… é‡å¤ç¾¤ç»„æ¸…ç†å®Œæˆï¼');
                                toastr.success(`å·²æ ‡è®° ${duplicateGroups.length} ä¸ªé‡å¤ç¾¤ç»„å¾…æ¸…ç†`, 'æ•°æ®æ¸…ç†');
                            }
                        } else {
                            console.log('âœ… æœªå‘ç°é‡å¤çš„ç§èŠç¾¤ç»„');
                            toastr.info('æœªå‘ç°é‡å¤çš„ç§èŠç¾¤ç»„', 'æ•°æ®æ¸…ç†');
                        }
                    }
                    
                } catch (error) {
                    console.error('âŒ æ¸…ç†é‡å¤ç¾¤ç»„æ—¶å‡ºé”™:', error);
                    toastr.error('æ¸…ç†è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯', 'æ•°æ®æ¸…ç†');
                }
            };
            

            
        </script>
    </body>
</html>