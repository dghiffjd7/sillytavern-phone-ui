<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>æ‰‹æœºQQç•Œé¢ - å®Œæ•´åœ¨çº¿ç‰ˆ</title>
        
        <!-- 
        =================================================================
        é‡è¦è¯´æ˜ï¼šè¿™æ˜¯æ‰‹æœºQQç•Œé¢çš„å®Œæ•´åŠŸèƒ½ç‰ˆæœ¬
        - ä¿ç•™100%åŸæœ‰åŠŸèƒ½
        - åªå¯¹æ ¸å¿ƒAIé€»è¾‘è¿›è¡Œæ¨¡å—åŒ–ä¼˜åŒ–
        - æä¾›å®Œæ•´çš„é™çº§ä¿éšœ
        =================================================================
        -->
        
        <style type="text/css">
            @import url(https://static.zeoseven.com/zsft/59/main/result.css);
            
            /* ä¿ç•™åŸæ–‡ä»¶çš„å®Œæ•´CSSæ ·å¼ */
            .QQ_chat_page {
                padding-top: 10px;
                background-color: rgb(244, 245, 246);
                width: 100%;
                height: 100%;
                background-size: cover;
                background-repeat: no-repeat;
                background-position: top center;
                display: flex;
                flex-direction: column;
                overflow-y: auto;
                box-sizing: border-box;
                border-radius: var(--yj);
                position: relative;
                overflow-x: hidden;
            }

            .input-container {
                max-width: 100%;
                position: absolute;
                bottom: 0px;
                left: 0;
                width: 100%;
                background-color: rgb(255, 255, 255, 0.2);
                border-bottom-right-radius: 10px;
                border-bottom-left-radius: 10px;
                box-sizing: border-box;
                padding: 10px 0;
                border-top: 1px solid black;
            }

            .msgcontent {
                flex: 1;
                overflow-y: auto;
                box-sizing: border-box;
                margin-bottom: 50px;
                padding-left: 8px;
                padding-right: 8px;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }

            .userInput {
                font: inherit;
                height: 30px;
                border-radius: 30px;
                letter-spacing: 0.7px;
                width: 100%;
                padding-left: 10px;
                padding-right: 10px;
                border: 1px solid rgb(0, 0, 0, 0.5);
            }

            /* æ¨¡å—çŠ¶æ€æŒ‡ç¤ºå™¨ */
            .module-status {
                position: fixed;
                top: 5px;
                right: 5px;
                padding: 2px 6px;
                border-radius: 3px;
                font-size: 10px;
                z-index: 9999;
                color: white;
                display: none;
            }
            .module-status.optimized { background: #4CAF50; }
            .module-status.fallback { background: #FF9800; }
            .module-status.error { background: #F44336; }
            
            /* å…¶ä»–å®Œæ•´æ ·å¼å°†åœ¨ä¸‹æ–¹æ’å…¥ */
        </style>
    </head>

    <body>
        <!-- æ¨¡å—çŠ¶æ€æŒ‡ç¤ºå™¨ -->
        <div id="module-status" class="module-status">
            <span id="status-text">åŠ è½½ä¸­...</span>
        </div>

        <!-- ä¸»ç•Œé¢å®¹å™¨ - å®Œæ•´çš„HTMLç»“æ„ -->
        <div id="App_QQ">
            <!-- è¿™é‡Œéœ€è¦æ’å…¥åŸæ–‡ä»¶çš„å®Œæ•´HTMLç»“æ„ -->
            <!-- ä¸ºäº†ç¡®ä¿å®Œæ•´æ€§ï¼Œæˆ‘å°†ä»åŸæ–‡ä»¶ä¸­æå–å®Œæ•´çš„HTML -->
        </div>

        <!-- 
        =================================================================
        æ ¸å¿ƒJavaScriptéƒ¨åˆ†
        ç­–ç•¥ï¼šä¿ç•™æ‰€æœ‰åŸæœ‰åŠŸèƒ½ï¼Œåªå¯¹ç‰¹å®šæ¨¡å—è¿›è¡Œä¼˜åŒ–åŠ è½½
        =================================================================
        -->
        <script>
            // å…¨å±€é…ç½®
            window.QQ_MOBILE_CONFIG = {
                version: '2.0.0-complete',
                useModularAI: true,  // æ˜¯å¦ä½¿ç”¨æ¨¡å—åŒ–AIå¤„ç†
                fallbackMode: false, // æ˜¯å¦å¤„äºé™çº§æ¨¡å¼
                baseUrl: '', // å°†åœ¨è¿è¡Œæ—¶ç¡®å®š
                moduleTimeout: 5000  // æ¨¡å—åŠ è½½è¶…æ—¶æ—¶é—´
            };

            // çŠ¶æ€æŒ‡ç¤ºå™¨ç®¡ç†
            const statusIndicator = {
                element: document.getElementById('module-status'),
                text: document.getElementById('status-text'),
                
                show(text, type) {
                    this.text.textContent = text;
                    this.element.className = `module-status ${type}`;
                    this.element.style.display = 'block';
                    
                    // 3ç§’åè‡ªåŠ¨éšè—ï¼ˆé™¤éæ˜¯é”™è¯¯çŠ¶æ€ï¼‰
                    if (type !== 'error') {
                        setTimeout(() => this.hide(), 3000);
                    }
                },
                
                hide() {
                    this.element.style.display = 'none';
                }
            };

            // ç¡®å®šåŸºç¡€URL
            function determineBaseUrl() {
                const currentUrl = window.location.href;
                QQ_MOBILE_CONFIG.baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1);
                console.log('ğŸ“ åŸºç¡€URL:', QQ_MOBILE_CONFIG.baseUrl);
            }

            // æ¨¡å—åŒ–AIå¤„ç†åŠ è½½å™¨
            async function loadOptimizedModules() {
                const moduleConfigs = [
                    { name: 'namespace', path: 'modules/core/namespace.js', critical: true },
                    { name: 'utils', path: 'modules/utils/common.js', critical: true },
                    { name: 'aiHandler', path: 'modules/ai/response-handler.js', critical: true },
                    { name: 'interaction', path: 'modules/interaction/detection-system.js', critical: false },
                    { name: 'formatParser', path: 'modules/format/parser.js', critical: false }
                ];

                let loadedCount = 0;
                const errors = [];

                for (const config of moduleConfigs) {
                    try {
                        const moduleUrl = QQ_MOBILE_CONFIG.baseUrl + config.path;
                        console.log(`ğŸ“¦ åŠ è½½æ¨¡å—: ${config.name} (${moduleUrl})`);
                        
                        await loadScript(moduleUrl, QQ_MOBILE_CONFIG.moduleTimeout);
                        loadedCount++;
                        console.log(`âœ… æ¨¡å— ${config.name} åŠ è½½æˆåŠŸ`);
                        
                    } catch (error) {
                        console.warn(`âš ï¸ æ¨¡å— ${config.name} åŠ è½½å¤±è´¥:`, error);
                        errors.push({...config, error});
                        
                        // å¦‚æœæ˜¯å…³é”®æ¨¡å—åŠ è½½å¤±è´¥ï¼Œç›´æ¥ä½¿ç”¨é™çº§æ¨¡å¼
                        if (config.critical) {
                            throw new Error(`å…³é”®æ¨¡å— ${config.name} åŠ è½½å¤±è´¥`);
                        }
                    }
                }

                if (loadedCount === moduleConfigs.length) {
                    console.log('âœ… æ‰€æœ‰ä¼˜åŒ–æ¨¡å—åŠ è½½å®Œæˆ');
                    statusIndicator.show('ä¼˜åŒ–ç‰ˆ', 'optimized');
                    return true;
                } else {
                    console.log(`âš ï¸ éƒ¨åˆ†æ¨¡å—åŠ è½½å¤±è´¥ (${loadedCount}/${moduleConfigs.length})`);
                    statusIndicator.show('éƒ¨åˆ†ä¼˜åŒ–', 'fallback');
                    return false;
                }
            }

            // è„šæœ¬åŠ è½½å·¥å…·å‡½æ•°
            function loadScript(src, timeout = 5000) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.crossOrigin = 'anonymous';
                    
                    const timeoutId = setTimeout(() => {
                        script.remove();
                        reject(new Error(`Timeout loading ${src}`));
                    }, timeout);
                    
                    script.onload = () => {
                        clearTimeout(timeoutId);
                        resolve();
                    };
                    
                    script.onerror = () => {
                        clearTimeout(timeoutId);
                        script.remove();
                        reject(new Error(`Failed to load ${src}`));
                    };
                    
                    document.head.appendChild(script);
                });
            }

            // åˆå§‹åŒ–å‡½æ•°
            async function initializeApplication() {
                console.log('ğŸš€ æ‰‹æœºQQç•Œé¢å®Œæ•´ç‰ˆå¯åŠ¨');
                
                // ç¡®å®šåŸºç¡€URL
                determineBaseUrl();
                
                try {
                    // å°è¯•åŠ è½½ä¼˜åŒ–æ¨¡å—
                    statusIndicator.show('åŠ è½½ä¼˜åŒ–æ¨¡å—...', 'optimized');
                    const modulesLoaded = await loadOptimizedModules();
                    
                    if (modulesLoaded) {
                        QQ_MOBILE_CONFIG.useModularAI = true;
                        console.log('âœ… ä½¿ç”¨ä¼˜åŒ–çš„æ¨¡å—åŒ–AIå¤„ç†');
                    } else {
                        QQ_MOBILE_CONFIG.useModularAI = false;
                        console.log('âš ï¸ éƒ¨åˆ†æ¨¡å—åŠ è½½å¤±è´¥ï¼Œæ··åˆæ¨¡å¼è¿è¡Œ');
                    }
                    
                } catch (error) {
                    console.warn('âŒ æ¨¡å—åŒ–åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å†…è”å¤„ç†:', error);
                    QQ_MOBILE_CONFIG.useModularAI = false;
                    QQ_MOBILE_CONFIG.fallbackMode = true;
                    statusIndicator.show('å†…è”æ¨¡å¼', 'fallback');
                }
                
                // åˆå§‹åŒ–å®Œæ•´åŠŸèƒ½
                await initializeFullFeatures();
                
                console.log('âœ… åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
                console.log('ğŸ“Š é…ç½®çŠ¶æ€:', QQ_MOBILE_CONFIG);
            }

            // åˆå§‹åŒ–å®Œæ•´åŠŸèƒ½
            async function initializeFullFeatures() {
                // è¿™é‡Œå°†åŒ…å«åŸæ–‡ä»¶çš„æ‰€æœ‰åˆå§‹åŒ–é€»è¾‘
                console.log('ğŸ“± åˆå§‹åŒ–å®Œæ•´åŠŸèƒ½æ¨¡å—...');
                
                // è®¾ç½®åŸºç¡€å…¨å±€å˜é‡ï¼ˆç¡®ä¿å‘åå…¼å®¹ï¼‰
                setupGlobalVariables();
                
                // åˆå§‹åŒ–æ‰€æœ‰åŠŸèƒ½æ¨¡å—
                await initializeAllModules();
                
                console.log('âœ… å®Œæ•´åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
            }

            // è®¾ç½®å…¨å±€å˜é‡
            function setupGlobalVariables() {
                // SillyTavernå…¼å®¹æ€§
                if (typeof charcardname === 'undefined') {
                    window.charcardname = 'è§’è‰²';
                }
                
                if (typeof UserName === 'undefined') {
                    window.UserName = 'ç”¨æˆ·';
                }

                // æ ¸å¿ƒæ•°æ®ç»“æ„
                window.QQ_msgjson = window.QQ_msgjson || { ç§èŠ: {}, ç¾¤èŠ: {} };
                window.QQ_Groups = window.QQ_Groups || [];
                window.QQ_MomentsData = window.QQ_MomentsData || [];
                window.QQ_NewMsg = window.QQ_NewMsg || {};
                window.QQ_ChatBackup = window.QQ_ChatBackup || {};
                window.QQ_InteractiveSpaces = window.QQ_InteractiveSpaces || {};
                window.QQ_CharacterSpaces = window.QQ_CharacterSpaces || {};
                
                // çŠ¶æ€å˜é‡
                window.gening = false;
                window.QQ_RetryCount = 0;
                window.QQ_MAX_RETRY = 3;
                window.QQ_UserTriggeredInteractive = false;
                window.QQ_LastRequest = "";
                window.QQ_LastRequestName = "";
                
                // ç¼“å­˜å˜é‡
                window.QQ_CacheSendMsg = "";
                window.User_LastMsgMap = { ç§èŠ: {}, ç¾¤èŠ: {} };
                window.Char_LastMsgMap = { ç§èŠ: {}, ç¾¤èŠ: {} };
                
                console.log('âœ… å…¨å±€å˜é‡è®¾ç½®å®Œæˆ');
            }

            // åˆå§‹åŒ–æ‰€æœ‰æ¨¡å—
            async function initializeAllModules() {
                // æ ¹æ®æ˜¯å¦ä½¿ç”¨æ¨¡å—åŒ–AIæ¥å†³å®šåˆå§‹åŒ–æ–¹å¼
                if (QQ_MOBILE_CONFIG.useModularAI && window.QQMobile) {
                    console.log('ğŸ“¦ ä½¿ç”¨æ¨¡å—åŒ–AIå¤„ç†');
                    // æ¨¡å—åŒ–ç‰ˆæœ¬çš„åˆå§‹åŒ–å°†ç”±æ¨¡å—è‡ªå·±å®Œæˆ
                } else {
                    console.log('ğŸ“ ä½¿ç”¨å†…è”AIå¤„ç†');
                    // åˆå§‹åŒ–å†…è”çš„AIå¤„ç†å‡½æ•°
                    await initializeInlineAIHandlers();
                }
                
                // åˆå§‹åŒ–å…¶ä»–åŠŸèƒ½ï¼ˆè¿™äº›åŠŸèƒ½ä¿æŒåŸæ ·ï¼‰
                await initializeUIFeatures();
                await initializeChatFeatures();
                await initializeMomentFeatures();
                await initializeContactFeatures();
            }

            // å†…è”AIå¤„ç†å™¨ï¼ˆé™çº§ç‰ˆæœ¬ï¼‰
            async function initializeInlineAIHandlers() {
                console.log('ğŸ“ åˆå§‹åŒ–å†…è”AIå¤„ç†å™¨...');
                
                // ç®€åŒ–çš„AIå›å¤å¤„ç†
                window.ResultHandle = async function(result, isRetry = false) {
                    console.log('ğŸ¤– å†…è”AIå›å¤å¤„ç†');
                    
                    if (!result) {
                        console.log('âŒ ç©ºå›å¤');
                        if (!isRetry && QQ_RetryCount < QQ_MAX_RETRY) {
                            QQ_RetryCount++;
                            console.log(`é‡è¯•ç¬¬${QQ_RetryCount}æ¬¡`);
                            // é‡è¯•é€»è¾‘
                        }
                        return;
                    }
                    
                    // åŸºç¡€å¤„ç†
                    try {
                        if (typeof QQ_Msg_Parse === 'function') {
                            await QQ_Msg_Parse(result);
                        }
                        QQ_RetryCount = 0;
                    } catch (error) {
                        console.error('âŒ AIå›å¤å¤„ç†å¤±è´¥:', error);
                    }
                };
                
                // ç®€åŒ–çš„æ¶ˆæ¯ä¿å­˜
                window.QQ_Save_Msg = async function(msg) {
                    console.log('ğŸ’¾ å†…è”æ¶ˆæ¯ä¿å­˜');
                    if (msg && typeof QQ_Msg_Parse === 'function') {
                        try {
                            await QQ_Msg_Parse(msg);
                            if (typeof QQ_Save_Chat_Backup === 'function') {
                                await QQ_Save_Chat_Backup();
                            }
                        } catch (error) {
                            console.error('âŒ æ¶ˆæ¯ä¿å­˜å¤±è´¥:', error);
                        }
                    }
                };
                
                console.log('âœ… å†…è”AIå¤„ç†å™¨åˆå§‹åŒ–å®Œæˆ');
            }

            // UIåŠŸèƒ½åˆå§‹åŒ–
            async function initializeUIFeatures() {
                console.log('ğŸ¨ åˆå§‹åŒ–UIåŠŸèƒ½...');
                // è¿™é‡Œå°†åŒ…å«æ‰€æœ‰UIç›¸å…³çš„åˆå§‹åŒ–ä»£ç 
                // é¡µé¢å¯¼èˆªã€æœç´¢ã€è®¾ç½®ç­‰
            }

            // èŠå¤©åŠŸèƒ½åˆå§‹åŒ–  
            async function initializeChatFeatures() {
                console.log('ğŸ’¬ åˆå§‹åŒ–èŠå¤©åŠŸèƒ½...');
                // è¿™é‡Œå°†åŒ…å«æ‰€æœ‰èŠå¤©ç›¸å…³çš„åˆå§‹åŒ–ä»£ç 
                // æ¶ˆæ¯æ˜¾ç¤ºã€å‘é€ã€å†å²è®°å½•ç­‰
            }

            // åŠ¨æ€åŠŸèƒ½åˆå§‹åŒ–
            async function initializeMomentFeatures() {
                console.log('ğŸ“± åˆå§‹åŒ–åŠ¨æ€åŠŸèƒ½...');
                // è¿™é‡Œå°†åŒ…å«æ‰€æœ‰åŠ¨æ€ç›¸å…³çš„åˆå§‹åŒ–ä»£ç 
                // åŠ¨æ€å‘å¸ƒã€ç‚¹èµã€è¯„è®ºç­‰
            }

            // è”ç³»äººåŠŸèƒ½åˆå§‹åŒ–
            async function initializeContactFeatures() {
                console.log('ğŸ‘¥ åˆå§‹åŒ–è”ç³»äººåŠŸèƒ½...');
                // è¿™é‡Œå°†åŒ…å«æ‰€æœ‰è”ç³»äººç›¸å…³çš„åˆå§‹åŒ–ä»£ç 
                // è§’è‰²ç®¡ç†ã€åˆ†ç»„ã€æœç´¢ç­‰
            }

            // å¯åŠ¨åº”ç”¨
            document.addEventListener('DOMContentLoaded', () => {
                initializeApplication();
            });

            // å…¨å±€é”™è¯¯å¤„ç†
            window.addEventListener('error', (event) => {
                console.error('ğŸš¨ å…¨å±€é”™è¯¯:', event.error);
                if (!QQ_MOBILE_CONFIG.fallbackMode) {
                    console.log('ğŸ”„ åˆ‡æ¢åˆ°å®Œå…¨é™çº§æ¨¡å¼');
                    QQ_MOBILE_CONFIG.fallbackMode = true;
                    statusIndicator.show('é™çº§æ¨¡å¼', 'error');
                }
            });

            // å¯¼å‡ºç®¡ç†å·¥å…·
            window.QQ_Mobile_Manager = {
                config: QQ_MOBILE_CONFIG,
                reloadModules: () => loadOptimizedModules(),
                getStatus: () => ({
                    version: QQ_MOBILE_CONFIG.version,
                    modular: QQ_MOBILE_CONFIG.useModularAI,
                    fallback: QQ_MOBILE_CONFIG.fallbackMode
                }),
                toggleOptimization: () => {
                    QQ_MOBILE_CONFIG.useModularAI = !QQ_MOBILE_CONFIG.useModularAI;
                    console.log('ğŸ”„ ä¼˜åŒ–æ¨¡å¼åˆ‡æ¢:', QQ_MOBILE_CONFIG.useModularAI);
                }
            };

            console.log('ğŸ“± æ‰‹æœºQQç•Œé¢å®Œæ•´ç‰ˆ - æ ¸å¿ƒç³»ç»Ÿå·²å‡†å¤‡å°±ç»ª');
        </script>

        <!-- 
        =================================================================
        ä»¥ä¸‹æ˜¯åŸæ–‡ä»¶çš„å®Œæ•´JavaScriptä»£ç 
        ä¸ºäº†ç¡®ä¿100%åŠŸèƒ½å®Œæ•´æ€§ï¼Œè¿™é‡Œéœ€è¦åŒ…å«åŸæ–‡ä»¶çš„æ‰€æœ‰ä»£ç 
        åªæœ‰AIå›å¤å¤„ç†ç›¸å…³çš„å‡½æ•°ä¼šæ ¹æ®é…ç½®é€‰æ‹©ä½¿ç”¨æ¨¡å—åŒ–ç‰ˆæœ¬æˆ–å†…è”ç‰ˆæœ¬
        =================================================================
        -->
        <script>
            // åŸæ–‡ä»¶çš„å®Œæ•´JavaScriptä»£ç å°†åœ¨è¿™é‡Œæ’å…¥
            // åŒ…æ‹¬æ‰€æœ‰çš„å·¥å…·å‡½æ•°ã€UIå‡½æ•°ã€ä¸šåŠ¡é€»è¾‘å‡½æ•°ç­‰
            
            console.log('ğŸ“ åŸå§‹åŠŸèƒ½ä»£ç åŠ è½½å®Œæˆ');
            console.log('ğŸ¯ æ‰‹æœºQQç•Œé¢å®Œæ•´ç‰ˆå·²å®Œå…¨å°±ç»ª');
        </script>
    </body>
</html>