<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>手机QQ界面 - 优化版</title>
    
    <!-- 导入外部CSS样式 -->
    <style type="text/css">
        @import url(https://static.zeoseven.com/zsft/59/main/result.css);
        
        /* 保留原有的核心样式定义 */
        .QQ_chat_page {
            padding-top: 10px;
            background-color: rgb(244, 245, 246);
            width: 100%;
            height: 100%;
            background-size: cover;
            background-repeat: no-repeat;
            background-position: top center;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            box-sizing: border-box;
            border-radius: var(--yj);
            position: relative;
            overflow-x: hidden;
        }

        .input-container {
            max-width: 100%;
            position: absolute;
            bottom: 0px;
            left: 0;
            width: 100%;
            background-color: rgb(255, 255, 255, 0.2);
            border-bottom-right-radius: 10px;
            border-bottom-left-radius: 10px;
            box-sizing: border-box;
            padding: 10px 0;
            border-top: 1px solid black;
        }

        .msgcontent {
            flex: 1;
            overflow-y: auto;
            box-sizing: border-box;
            margin-bottom: 50px;
            padding-left: 8px;
            padding-right: 8px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .userInput {
            font: inherit;
            height: 30px;
            border-radius: 30px;
            letter-spacing: 0.7px;
            width: 100%;
            padding-left: 10px;
            padding-right: 10px;
            border: 1px solid rgb(0, 0, 0, 0.5);
        }

        /* 聊天设置弹窗样式 */
        .chat-setting-popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 350px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
        }

        .chat-setting-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-setting-header span {
            font-weight: bold;
            font-size: 16px;
        }

        /* 模块加载状态指示器 */
        .module-loader {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 9999;
            display: none;
        }

        .module-loader.show {
            display: block;
        }

        .module-loader.success {
            background: rgba(0, 128, 0, 0.8);
        }

        .module-loader.error {
            background: rgba(255, 0, 0, 0.8);
        }
    </style>
</head>

<body>
    <!-- 模块加载状态指示器 -->
    <div id="module-loader" class="module-loader">
        <span id="loader-text">正在加载模块...</span>
    </div>

    <!-- 主界面容器（将从原文件中提取的HTML结构放在这里） -->
    <div id="App_QQ">
        <!-- 这里将包含所有原有的HTML结构 -->
        <!-- 为了保持简洁，HTML结构将在运行时从原文件加载或通过JavaScript生成 -->
    </div>

    <!-- 模块化加载系统 -->
    <script>
        // 模块加载器配置
        const MODULE_BASE_PATH = './modules/';
        
        // 模块加载顺序（按依赖关系排序）
        const MODULE_CONFIG = [
            {
                name: 'namespace',
                path: 'core/namespace.js',
                description: '全局命名空间管理器'
            },
            {
                name: 'utils',
                path: 'utils/common.js',
                description: '通用工具函数'
            },
            {
                name: 'formatParser',
                path: 'format/parser.js',
                description: '格式解析器'
            },
            {
                name: 'interactionSystem',
                path: 'interaction/detection-system.js',
                description: '互动检测系统'
            },
            {
                name: 'aiResponseHandler',
                path: 'ai/response-handler.js',
                description: 'AI回复处理器'
            }
        ];

        // 加载状态管理
        const loaderElement = document.getElementById('module-loader');
        const loaderText = document.getElementById('loader-text');

        function showLoader(text, type = '') {
            loaderText.textContent = text;
            loaderElement.className = `module-loader show ${type}`;
        }

        function hideLoader() {
            loaderElement.className = 'module-loader';
        }

        // 动态加载脚本
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // 主加载函数
        async function loadModules() {
            try {
                showLoader('正在初始化模块系统...');
                
                console.log('🚀 开始加载手机QQ界面模块化系统');
                
                for (const module of MODULE_CONFIG) {
                    showLoader(`正在加载 ${module.description}...`);
                    console.log(`📦 加载模块: ${module.name} (${module.description})`);
                    
                    try {
                        await loadScript(`${MODULE_BASE_PATH}${module.path}`);
                        console.log(`✅ 模块 ${module.name} 加载成功`);
                    } catch (error) {
                        console.error(`❌ 模块 ${module.name} 加载失败:`, error);
                        showLoader(`模块 ${module.name} 加载失败`, 'error');
                        throw new Error(`Failed to load module: ${module.name}`);
                    }
                }

                showLoader('所有模块加载完成', 'success');
                console.log('✅ 所有模块加载完成');
                
                // 等待一秒后隐藏加载器
                setTimeout(() => {
                    hideLoader();
                    initializeApplication();
                }, 1000);

            } catch (error) {
                console.error('❌ 模块加载过程中发生错误:', error);
                showLoader('模块加载失败', 'error');
                
                // 3秒后隐藏错误信息
                setTimeout(hideLoader, 3000);
            }
        }

        // 应用初始化
        async function initializeApplication() {
            try {
                console.log('🎯 开始初始化应用...');
                
                // 检查是否所有必要的模块都已加载
                const requiredModules = ['namespace', 'utils', 'formatParser', 'interactionSystem', 'aiResponseHandler'];
                const missingModules = requiredModules.filter(name => 
                    !QQMobile.loadedModules.has(name)
                );
                
                if (missingModules.length > 0) {
                    throw new Error(`缺少必要模块: ${missingModules.join(', ')}`);
                }
                
                // 注册全局事件监听器
                setupGlobalEventListeners();
                
                // 加载原有的HTML结构和功能
                await loadLegacyContent();
                
                // 初始化各个模块
                await initializeModules();
                
                console.log('✅ 应用初始化完成');
                
                // 触发应用就绪事件
                QQMobile.events.emit('app:ready');
                
            } catch (error) {
                console.error('❌ 应用初始化失败:', error);
                showLoader('应用初始化失败', 'error');
            }
        }

        // 设置全局事件监听器
        function setupGlobalEventListeners() {
            // 监听模块事件
            QQMobile.events.on('module:loaded', (moduleName) => {
                console.log(`📦 模块事件: ${moduleName} 已加载`);
            });

            QQMobile.events.on('ai:response:success', () => {
                console.log('🤖 AI回复处理成功');
            });

            QQMobile.events.on('interactive:content:added', (data) => {
                console.log('🎭 互动内容已添加:', data.characterName);
            });

            // 监听错误事件
            window.addEventListener('error', (event) => {
                console.error('🚨 全局错误:', event.error);
                QQMobile.events.emit('app:error', event.error);
            });

            // 监听未处理的Promise拒绝
            window.addEventListener('unhandledrejection', (event) => {
                console.error('🚨 未处理的Promise拒绝:', event.reason);
                QQMobile.events.emit('app:error', event.reason);
            });
        }

        // 加载原有内容
        async function loadLegacyContent() {
            console.log('📜 加载原有HTML结构和功能...');
            
            // 这里可以通过fetch加载原有文件的HTML结构
            // 或者直接在这里定义HTML结构
            // 为了演示，我们先创建一个基本的结构
            
            const appContainer = document.getElementById('App_QQ');
            if (appContainer) {
                // 可以在这里加载原有的复杂HTML结构
                // 或者通过AJAX从原文件加载
                console.log('✅ HTML结构加载完成');
            }
        }

        // 初始化各个模块
        async function initializeModules() {
            console.log('⚙️ 初始化各个模块...');
            
            // 初始化命名空间（已经在模块加载时自动初始化）
            
            // 初始化工具函数
            if (QQMobile.modules.utils) {
                console.log('✅ 工具函数模块已就绪');
            }
            
            // 初始化格式解析器
            if (QQMobile.modules.formatParser) {
                console.log('✅ 格式解析器已就绪');
            }
            
            // 初始化互动检测系统
            if (QQMobile.modules.interactionSystem) {
                console.log('✅ 互动检测系统已就绪');
            }
            
            // 初始化AI回复处理器
            if (QQMobile.modules.aiResponseHandler) {
                console.log('✅ AI回复处理器已就绪');
            }
        }

        // 开始加载
        document.addEventListener('DOMContentLoaded', () => {
            loadModules();
        });

        // 全局错误处理
        window.onerror = function(message, source, lineno, colno, error) {
            console.error('🚨 JavaScript错误:', {
                message,
                source,
                lineno,
                colno,
                error
            });
            return false;
        };

        // 导出到全局作用域的工具函数
        window.QQ_ModuleLoader = {
            reload: loadModules,
            getLoadedModules: () => Array.from(QQMobile.loadedModules),
            getModuleStatus: () => {
                const status = {};
                MODULE_CONFIG.forEach(module => {
                    status[module.name] = QQMobile.loadedModules.has(module.name);
                });
                return status;
            }
        };
    </script>

    <!-- 
    注意：以下是从原文件中需要保留的核心JavaScript功能
    这些将被逐步重构到模块中，但为了确保兼容性，先保留在这里
    -->
    <script>
        // 保留必要的全局变量和函数（向后兼容）
        
        // SillyTavern相关变量（如果存在）
        if (typeof charcardname === 'undefined') {
            window.charcardname = '角色';
        }
        
        if (typeof UserName === 'undefined') {
            window.UserName = '用户';
        }

        // 基本的模板和工具函数
        window.chat_user_message = `
            <div class="QQ_chat_mymsg">
                <div class="QQ_chat_msgdiv">
                    <span><%= content %></span>
                </div>
            </div>
        `;

        // 基本的工具函数（将被模块替换）
        window.JsonYamlParse = function(content) {
            try {
                return JSON.parse(content);
            } catch (e) {
                try {
                    return YAML.parse(content);
                } catch (e2) {
                    return null;
                }
            }
        };

        window.System_TagCompletion = function(data) {
            return data;
        };

        // 基本的API函数（需要与SillyTavern集成）
        window.QQ_Gen = async function(message) {
            // 这里需要集成SillyTavern的API
            console.log('🤖 调用AI生成:', message);
            return "模拟AI回复";
        };

        window.triggerSlash = function(command) {
            console.log('⚡ 执行斜杠命令:', command);
        };

        // 消息列表更新函数
        window.QQ_UpdateMessageList = function() {
            console.log('📱 更新消息列表');
        };

        window.QQ_UpdateNewTips = function() {
            console.log('🔔 更新提示');
        };

        window.QQ_Save_Chat_Backup = async function() {
            console.log('💾 保存聊天备份');
        };

        // 基础DOM操作函数
        window.$ = window.$ || function(selector) {
            return document.querySelector(selector);
        };

        // 简单的模板引擎
        window._ = window._ || {
            template: function(templateStr) {
                return function(data) {
                    return templateStr.replace(/<%=\s*(\w+)\s*%>/g, (match, key) => {
                        return data[key] || '';
                    });
                };
            }
        };

        console.log('📱 手机QQ界面优化版 - 基础环境已准备就绪');
    </script>
</body>
</html>