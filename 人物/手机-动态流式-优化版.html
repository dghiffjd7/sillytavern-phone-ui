<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>æ‰‹æœºQQç•Œé¢ - ä¼˜åŒ–ç‰ˆ</title>
    
    <!-- å¯¼å…¥å¤–éƒ¨CSSæ ·å¼ -->
    <style type="text/css">
        @import url(https://static.zeoseven.com/zsft/59/main/result.css);
        
        /* ä¿ç•™åŸæœ‰çš„æ ¸å¿ƒæ ·å¼å®šä¹‰ */
        .QQ_chat_page {
            padding-top: 10px;
            background-color: rgb(244, 245, 246);
            width: 100%;
            height: 100%;
            background-size: cover;
            background-repeat: no-repeat;
            background-position: top center;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            box-sizing: border-box;
            border-radius: var(--yj);
            position: relative;
            overflow-x: hidden;
        }

        .input-container {
            max-width: 100%;
            position: absolute;
            bottom: 0px;
            left: 0;
            width: 100%;
            background-color: rgb(255, 255, 255, 0.2);
            border-bottom-right-radius: 10px;
            border-bottom-left-radius: 10px;
            box-sizing: border-box;
            padding: 10px 0;
            border-top: 1px solid black;
        }

        .msgcontent {
            flex: 1;
            overflow-y: auto;
            box-sizing: border-box;
            margin-bottom: 50px;
            padding-left: 8px;
            padding-right: 8px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .userInput {
            font: inherit;
            height: 30px;
            border-radius: 30px;
            letter-spacing: 0.7px;
            width: 100%;
            padding-left: 10px;
            padding-right: 10px;
            border: 1px solid rgb(0, 0, 0, 0.5);
        }

        /* èŠå¤©è®¾ç½®å¼¹çª—æ ·å¼ */
        .chat-setting-popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 350px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
        }

        .chat-setting-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-setting-header span {
            font-weight: bold;
            font-size: 16px;
        }

        /* æ¨¡å—åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .module-loader {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 9999;
            display: none;
        }

        .module-loader.show {
            display: block;
        }

        .module-loader.success {
            background: rgba(0, 128, 0, 0.8);
        }

        .module-loader.error {
            background: rgba(255, 0, 0, 0.8);
        }
    </style>
</head>

<body>
    <!-- æ¨¡å—åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div id="module-loader" class="module-loader">
        <span id="loader-text">æ­£åœ¨åŠ è½½æ¨¡å—...</span>
    </div>

    <!-- ä¸»ç•Œé¢å®¹å™¨ï¼ˆå°†ä»åŸæ–‡ä»¶ä¸­æå–çš„HTMLç»“æ„æ”¾åœ¨è¿™é‡Œï¼‰ -->
    <div id="App_QQ">
        <!-- è¿™é‡Œå°†åŒ…å«æ‰€æœ‰åŸæœ‰çš„HTMLç»“æ„ -->
        <!-- ä¸ºäº†ä¿æŒç®€æ´ï¼ŒHTMLç»“æ„å°†åœ¨è¿è¡Œæ—¶ä»åŸæ–‡ä»¶åŠ è½½æˆ–é€šè¿‡JavaScriptç”Ÿæˆ -->
    </div>

    <!-- æ¨¡å—åŒ–åŠ è½½ç³»ç»Ÿ -->
    <script>
        // æ¨¡å—åŠ è½½å™¨é…ç½®
        const MODULE_BASE_PATH = './modules/';
        
        // æ¨¡å—åŠ è½½é¡ºåºï¼ˆæŒ‰ä¾èµ–å…³ç³»æ’åºï¼‰
        const MODULE_CONFIG = [
            {
                name: 'namespace',
                path: 'core/namespace.js',
                description: 'å…¨å±€å‘½åç©ºé—´ç®¡ç†å™¨'
            },
            {
                name: 'utils',
                path: 'utils/common.js',
                description: 'é€šç”¨å·¥å…·å‡½æ•°'
            },
            {
                name: 'formatParser',
                path: 'format/parser.js',
                description: 'æ ¼å¼è§£æå™¨'
            },
            {
                name: 'interactionSystem',
                path: 'interaction/detection-system.js',
                description: 'äº’åŠ¨æ£€æµ‹ç³»ç»Ÿ'
            },
            {
                name: 'aiResponseHandler',
                path: 'ai/response-handler.js',
                description: 'AIå›å¤å¤„ç†å™¨'
            }
        ];

        // åŠ è½½çŠ¶æ€ç®¡ç†
        const loaderElement = document.getElementById('module-loader');
        const loaderText = document.getElementById('loader-text');

        function showLoader(text, type = '') {
            loaderText.textContent = text;
            loaderElement.className = `module-loader show ${type}`;
        }

        function hideLoader() {
            loaderElement.className = 'module-loader';
        }

        // åŠ¨æ€åŠ è½½è„šæœ¬
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // ä¸»åŠ è½½å‡½æ•°
        async function loadModules() {
            try {
                showLoader('æ­£åœ¨åˆå§‹åŒ–æ¨¡å—ç³»ç»Ÿ...');
                
                console.log('ğŸš€ å¼€å§‹åŠ è½½æ‰‹æœºQQç•Œé¢æ¨¡å—åŒ–ç³»ç»Ÿ');
                
                for (const module of MODULE_CONFIG) {
                    showLoader(`æ­£åœ¨åŠ è½½ ${module.description}...`);
                    console.log(`ğŸ“¦ åŠ è½½æ¨¡å—: ${module.name} (${module.description})`);
                    
                    try {
                        await loadScript(`${MODULE_BASE_PATH}${module.path}`);
                        console.log(`âœ… æ¨¡å— ${module.name} åŠ è½½æˆåŠŸ`);
                    } catch (error) {
                        console.error(`âŒ æ¨¡å— ${module.name} åŠ è½½å¤±è´¥:`, error);
                        showLoader(`æ¨¡å— ${module.name} åŠ è½½å¤±è´¥`, 'error');
                        throw new Error(`Failed to load module: ${module.name}`);
                    }
                }

                showLoader('æ‰€æœ‰æ¨¡å—åŠ è½½å®Œæˆ', 'success');
                console.log('âœ… æ‰€æœ‰æ¨¡å—åŠ è½½å®Œæˆ');
                
                // ç­‰å¾…ä¸€ç§’åéšè—åŠ è½½å™¨
                setTimeout(() => {
                    hideLoader();
                    initializeApplication();
                }, 1000);

            } catch (error) {
                console.error('âŒ æ¨¡å—åŠ è½½è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
                showLoader('æ¨¡å—åŠ è½½å¤±è´¥', 'error');
                
                // 3ç§’åéšè—é”™è¯¯ä¿¡æ¯
                setTimeout(hideLoader, 3000);
            }
        }

        // åº”ç”¨åˆå§‹åŒ–
        async function initializeApplication() {
            try {
                console.log('ğŸ¯ å¼€å§‹åˆå§‹åŒ–åº”ç”¨...');
                
                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å¿…è¦çš„æ¨¡å—éƒ½å·²åŠ è½½
                const requiredModules = ['namespace', 'utils', 'formatParser', 'interactionSystem', 'aiResponseHandler'];
                const missingModules = requiredModules.filter(name => 
                    !QQMobile.loadedModules.has(name)
                );
                
                if (missingModules.length > 0) {
                    throw new Error(`ç¼ºå°‘å¿…è¦æ¨¡å—: ${missingModules.join(', ')}`);
                }
                
                // æ³¨å†Œå…¨å±€äº‹ä»¶ç›‘å¬å™¨
                setupGlobalEventListeners();
                
                // åŠ è½½åŸæœ‰çš„HTMLç»“æ„å’ŒåŠŸèƒ½
                await loadLegacyContent();
                
                // åˆå§‹åŒ–å„ä¸ªæ¨¡å—
                await initializeModules();
                
                console.log('âœ… åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
                
                // è§¦å‘åº”ç”¨å°±ç»ªäº‹ä»¶
                QQMobile.events.emit('app:ready');
                
            } catch (error) {
                console.error('âŒ åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
                showLoader('åº”ç”¨åˆå§‹åŒ–å¤±è´¥', 'error');
            }
        }

        // è®¾ç½®å…¨å±€äº‹ä»¶ç›‘å¬å™¨
        function setupGlobalEventListeners() {
            // ç›‘å¬æ¨¡å—äº‹ä»¶
            QQMobile.events.on('module:loaded', (moduleName) => {
                console.log(`ğŸ“¦ æ¨¡å—äº‹ä»¶: ${moduleName} å·²åŠ è½½`);
            });

            QQMobile.events.on('ai:response:success', () => {
                console.log('ğŸ¤– AIå›å¤å¤„ç†æˆåŠŸ');
            });

            QQMobile.events.on('interactive:content:added', (data) => {
                console.log('ğŸ­ äº’åŠ¨å†…å®¹å·²æ·»åŠ :', data.characterName);
            });

            // ç›‘å¬é”™è¯¯äº‹ä»¶
            window.addEventListener('error', (event) => {
                console.error('ğŸš¨ å…¨å±€é”™è¯¯:', event.error);
                QQMobile.events.emit('app:error', event.error);
            });

            // ç›‘å¬æœªå¤„ç†çš„Promiseæ‹’ç»
            window.addEventListener('unhandledrejection', (event) => {
                console.error('ğŸš¨ æœªå¤„ç†çš„Promiseæ‹’ç»:', event.reason);
                QQMobile.events.emit('app:error', event.reason);
            });
        }

        // åŠ è½½åŸæœ‰å†…å®¹
        async function loadLegacyContent() {
            console.log('ğŸ“œ åŠ è½½åŸæœ‰HTMLç»“æ„å’ŒåŠŸèƒ½...');
            
            // è¿™é‡Œå¯ä»¥é€šè¿‡fetchåŠ è½½åŸæœ‰æ–‡ä»¶çš„HTMLç»“æ„
            // æˆ–è€…ç›´æ¥åœ¨è¿™é‡Œå®šä¹‰HTMLç»“æ„
            // ä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ªåŸºæœ¬çš„ç»“æ„
            
            const appContainer = document.getElementById('App_QQ');
            if (appContainer) {
                // å¯ä»¥åœ¨è¿™é‡ŒåŠ è½½åŸæœ‰çš„å¤æ‚HTMLç»“æ„
                // æˆ–è€…é€šè¿‡AJAXä»åŸæ–‡ä»¶åŠ è½½
                console.log('âœ… HTMLç»“æ„åŠ è½½å®Œæˆ');
            }
        }

        // åˆå§‹åŒ–å„ä¸ªæ¨¡å—
        async function initializeModules() {
            console.log('âš™ï¸ åˆå§‹åŒ–å„ä¸ªæ¨¡å—...');
            
            // åˆå§‹åŒ–å‘½åç©ºé—´ï¼ˆå·²ç»åœ¨æ¨¡å—åŠ è½½æ—¶è‡ªåŠ¨åˆå§‹åŒ–ï¼‰
            
            // åˆå§‹åŒ–å·¥å…·å‡½æ•°
            if (QQMobile.modules.utils) {
                console.log('âœ… å·¥å…·å‡½æ•°æ¨¡å—å·²å°±ç»ª');
            }
            
            // åˆå§‹åŒ–æ ¼å¼è§£æå™¨
            if (QQMobile.modules.formatParser) {
                console.log('âœ… æ ¼å¼è§£æå™¨å·²å°±ç»ª');
            }
            
            // åˆå§‹åŒ–äº’åŠ¨æ£€æµ‹ç³»ç»Ÿ
            if (QQMobile.modules.interactionSystem) {
                console.log('âœ… äº’åŠ¨æ£€æµ‹ç³»ç»Ÿå·²å°±ç»ª');
            }
            
            // åˆå§‹åŒ–AIå›å¤å¤„ç†å™¨
            if (QQMobile.modules.aiResponseHandler) {
                console.log('âœ… AIå›å¤å¤„ç†å™¨å·²å°±ç»ª');
            }
        }

        // å¼€å§‹åŠ è½½
        document.addEventListener('DOMContentLoaded', () => {
            loadModules();
        });

        // å…¨å±€é”™è¯¯å¤„ç†
        window.onerror = function(message, source, lineno, colno, error) {
            console.error('ğŸš¨ JavaScripté”™è¯¯:', {
                message,
                source,
                lineno,
                colno,
                error
            });
            return false;
        };

        // å¯¼å‡ºåˆ°å…¨å±€ä½œç”¨åŸŸçš„å·¥å…·å‡½æ•°
        window.QQ_ModuleLoader = {
            reload: loadModules,
            getLoadedModules: () => Array.from(QQMobile.loadedModules),
            getModuleStatus: () => {
                const status = {};
                MODULE_CONFIG.forEach(module => {
                    status[module.name] = QQMobile.loadedModules.has(module.name);
                });
                return status;
            }
        };
    </script>

    <!-- 
    æ³¨æ„ï¼šä»¥ä¸‹æ˜¯ä»åŸæ–‡ä»¶ä¸­éœ€è¦ä¿ç•™çš„æ ¸å¿ƒJavaScriptåŠŸèƒ½
    è¿™äº›å°†è¢«é€æ­¥é‡æ„åˆ°æ¨¡å—ä¸­ï¼Œä½†ä¸ºäº†ç¡®ä¿å…¼å®¹æ€§ï¼Œå…ˆä¿ç•™åœ¨è¿™é‡Œ
    -->
    <script>
        // ä¿ç•™å¿…è¦çš„å…¨å±€å˜é‡å’Œå‡½æ•°ï¼ˆå‘åå…¼å®¹ï¼‰
        
        // SillyTavernç›¸å…³å˜é‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if (typeof charcardname === 'undefined') {
            window.charcardname = 'è§’è‰²';
        }
        
        if (typeof UserName === 'undefined') {
            window.UserName = 'ç”¨æˆ·';
        }

        // åŸºæœ¬çš„æ¨¡æ¿å’Œå·¥å…·å‡½æ•°
        window.chat_user_message = `
            <div class="QQ_chat_mymsg">
                <div class="QQ_chat_msgdiv">
                    <span><%= content %></span>
                </div>
            </div>
        `;

        // åŸºæœ¬çš„å·¥å…·å‡½æ•°ï¼ˆå°†è¢«æ¨¡å—æ›¿æ¢ï¼‰
        window.JsonYamlParse = function(content) {
            try {
                return JSON.parse(content);
            } catch (e) {
                try {
                    return YAML.parse(content);
                } catch (e2) {
                    return null;
                }
            }
        };

        window.System_TagCompletion = function(data) {
            return data;
        };

        // åŸºæœ¬çš„APIå‡½æ•°ï¼ˆéœ€è¦ä¸SillyTaverné›†æˆï¼‰
        window.QQ_Gen = async function(message) {
            // è¿™é‡Œéœ€è¦é›†æˆSillyTavernçš„API
            console.log('ğŸ¤– è°ƒç”¨AIç”Ÿæˆ:', message);
            return "æ¨¡æ‹ŸAIå›å¤";
        };

        window.triggerSlash = function(command) {
            console.log('âš¡ æ‰§è¡Œæ–œæ å‘½ä»¤:', command);
        };

        // æ¶ˆæ¯åˆ—è¡¨æ›´æ–°å‡½æ•°
        window.QQ_UpdateMessageList = function() {
            console.log('ğŸ“± æ›´æ–°æ¶ˆæ¯åˆ—è¡¨');
        };

        window.QQ_UpdateNewTips = function() {
            console.log('ğŸ”” æ›´æ–°æç¤º');
        };

        window.QQ_Save_Chat_Backup = async function() {
            console.log('ğŸ’¾ ä¿å­˜èŠå¤©å¤‡ä»½');
        };

        // åŸºç¡€DOMæ“ä½œå‡½æ•°
        window.$ = window.$ || function(selector) {
            return document.querySelector(selector);
        };

        // ç®€å•çš„æ¨¡æ¿å¼•æ“
        window._ = window._ || {
            template: function(templateStr) {
                return function(data) {
                    return templateStr.replace(/<%=\s*(\w+)\s*%>/g, (match, key) => {
                        return data[key] || '';
                    });
                };
            }
        };

        console.log('ğŸ“± æ‰‹æœºQQç•Œé¢ä¼˜åŒ–ç‰ˆ - åŸºç¡€ç¯å¢ƒå·²å‡†å¤‡å°±ç»ª');
    </script>
</body>
</html>