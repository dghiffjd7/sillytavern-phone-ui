这个项目是在完成一个通过Silly Tavern加载的手机前端页面，而现在的任务为给这个前端页面debug、增加功能以及优化。

请留意酒馆之间自带的特殊机制，如预设、世界书、表格插件扩展等等。这个项目是在Silly Tavern当中通过正规表达式加载的手机前端，对Silly Tavern的机制理解可参考@types文件夹，对Silly Tavern世界书机制的参考可通过lorebook_script文件夹。

在开发的过程中请牢记，在每次进行更改前，请详细检查整个文件，找出问题的源头并进行解决，而不是添加可能出现更多问题的临时补丁，并且请注意以下核心逻辑*非常重要！*。

请牢记我们处理AI回复等状况的逻辑：

1. 使用者发送讯息状况：

在使用者没有发送特殊符号&&以及没有开启互动内容检测关键词设定或开启了但没有发送包含关键词的讯息时：

    a. 发送私聊--请求私聊回复以及一定概率群聊及动态回复

    b. 发送群聊--请求群聊回复以及一定概率私聊及动态回复

    c. 发送动态评论--请求动态评论回复及私聊或群聊深入讨论

请确保私聊的独立性，在使用者向角色发送私聊时，如果角色没有将该讯息分享出去（群聊或动态），则其他角色是不会知道也看不到这些讯息的。

使用者发送&&或开启互动关键词检测并发送包含关键词的讯息--先请求当下页面的简短回复（如使用者在私聊中发送互动请求，则该角色会先通过私聊发送简短讯息回复。动态则是在动态评论中简短回复。）然后直接请求回复互动内容

2. 非互动内容AI回复消息后我们的处理方式：

    A. 先判断是否符合线上格式

        a. 符合：直接提取并清理多余标签（consider、thinking等等）后输出所有有效内容，分别放入各界面。（有效内容包含：使用者和角色的私聊、群聊、动态/评论、角色和角色的私聊、AI新创建的群组等等）

        b. 不符合：先尝试模糊匹配，若匹配不成功再尝试提取有效内容（依据线上格式标签，标签不完全则调用修补函数），清理多余标签后放入各界面

            一. 不符合线上格式且没有任何线上格式的标签（找不到任何私聊、群聊、动态、评论等信息），但是有content标签包裹，且里面有大量内容--清理多余标签后输出到互动空间

            二. 不符合线上格式且无任何线上格式标签，且找不到content标签，则重新发送请求**重传成本高，最后手段**

3. 互动内容AI回复消息后我们的处理方式：

    A. 寻找content标签--清理包含的多余标签--输出到互动空间（输出互动内容前要先输出当下页面的简短回复）

    B. content标签不完全--修补content标签--清理多余标签后输出到互动空间

    C. 完全没有content标签--检测是否有大量文本--有大量文本则清理多余标签后输出

    D. 以上皆失败--重新发送请求**最后手段**

**以及请注意以上处理逻辑备选方案的优先级，及主要逻辑成功后就不用再执行备选方案，只有主要逻辑失败后才会执行备选方案**

如：判断是否符合线上格式失败后--模糊匹配，如果匹配成功则不需要再执行模糊匹配机制。



在进行任何更动时，都请将我们的核心逻辑纳入考量，并且采取向后兼容形式进行更改，确保尽量不要影响到现有的功能。
**重要**：每次增加新函数前，请留意当前代码当中是否已有功能重复的、可能会造成冲突的、名称相似容易混肴的函数。

*重点*
实现世界书记忆分层架构来优化我们的程式，首先简要说明一下这个分层架构：
1.短期记忆-当前窗口或最近（1000条）聊天记录（已完成，debug中）
2.中期记忆-上一个对话/场景的摘要，小总结
3.关系记忆-记忆增强表格，简易版本，角色与使用者的关系信息，这里也可以加进AI分析出来的角色打字速度、回复速度、错字概率等等。
4.长期记忆-记忆编年史，即大总结，到小总结一定数量时，总结中期记忆的所有摘要。内容： 一段叙事性的文本，描述了使用者和角色之间关系发展的关键节点和故事。

美化互动内容的输出以及优化相关显示逻辑，我们已实现的想法：1. 将互动内容放进当天聊天界面的容器当中，角色A的就放进角色A的私聊界面容器当中，公共的就放进发起的群聊或是新的公共空间入口当中（如创建一个标题为该互动内容标题的群聊，然后在该群聊的容器中添加互动内容）2. 互动内容依然存储到各自的小精灵当中（角色对应角色小精灵，公共对应公共小精灵），用户可从小精灵当中管理、编辑并查看历史互动记录。3. 互动内容以类似系统消息的小字通过流式逐字显示在容器当中，用一个淡色但透明度低的背景让文字好阅读。4. 互动内容的顺序应与AI的回复相符，如AI的回复当中格式为此：a. <私聊A>角色A的私聊讯息</私聊A>角色A的互动内容<私聊B>角色B的私聊讯息</私聊B>，那么输出就该如下：同时流式输出角色A和B的私聊讯息，在角色A的流式输出结束后，再在新消息后面流式输出角色A的互动内容。b. <私聊A>上半部分角色A的私聊讯息</私聊A>与角色A的互动内容<私聊A>下半部分角色A的私聊讯息</私聊A>，那么输出流程就该如此：流式输出角色A的上半部分讯息，然后输出互动内容，互动内容结束后再继续流式输出角色A的下半部分讯息，以此类推。5. 用户可直接通过输入框，与发送正常对话消息一样的方式回复接续互动内容，在输入框的左上方添加一个决定向AI发送互动内容回复还是正常聊天消息的请求开关，这个开关平时不可见，只有在当前聊天页面触发了第一次互动内容后才会显现并可点击。开关开启的时候，用户在输入框中发送的内容将被视为互动内容回复请求，即向AI发送的提示词为互动内容提示词，开关关闭的时候，向AI发送的提示词则为原本的聊天对话请求，并强调AI遵守线上格式不要输出互动内容。