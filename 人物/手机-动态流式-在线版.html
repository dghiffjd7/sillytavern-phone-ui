<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>手机QQ界面 - 在线优化版</title>
    
    <!-- 导入外部CSS样式 -->
    <style type="text/css">
        @import url(https://static.zeoseven.com/zsft/59/main/result.css);
        
        /* 保留原有的核心样式定义 */
        .QQ_chat_page {
            padding-top: 10px;
            background-color: rgb(244, 245, 246);
            width: 100%;
            height: 100%;
            background-size: cover;
            background-repeat: no-repeat;
            background-position: top center;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            box-sizing: border-box;
            border-radius: var(--yj);
            position: relative;
            overflow-x: hidden;
        }

        .input-container {
            max-width: 100%;
            position: absolute;
            bottom: 0px;
            left: 0;
            width: 100%;
            background-color: rgb(255, 255, 255, 0.2);
            border-bottom-right-radius: 10px;
            border-bottom-left-radius: 10px;
            box-sizing: border-box;
            padding: 10px 0;
            border-top: 1px solid black;
        }

        .msgcontent {
            flex: 1;
            overflow-y: auto;
            box-sizing: border-box;
            margin-bottom: 50px;
            padding-left: 8px;
            padding-right: 8px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .userInput {
            font: inherit;
            height: 30px;
            border-radius: 30px;
            letter-spacing: 0.7px;
            width: 100%;
            padding-left: 10px;
            padding-right: 10px;
            border: 1px solid rgb(0, 0, 0, 0.5);
        }

        /* 模块加载状态指示器 */
        .module-loader {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 9999;
            display: none;
        }

        .module-loader.show { display: block; }
        .module-loader.success { background: rgba(0, 128, 0, 0.8); }
        .module-loader.error { background: rgba(255, 0, 0, 0.8); }
    </style>
</head>

<body>
    <!-- 模块加载状态指示器 -->
    <div id="module-loader" class="module-loader">
        <span id="loader-text">正在加载模块...</span>
    </div>

    <!-- 主界面容器 -->
    <div id="App_QQ">
        <!-- HTML结构将在运行时加载 -->
    </div>

    <script>
        // 确定当前页面的基础URL
        const getCurrentBaseUrl = () => {
            const currentUrl = window.location.href;
            const basePath = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1);
            return basePath;
        };

        // 动态确定模块基础路径
        const MODULE_BASE_URL = getCurrentBaseUrl() + 'modules/';
        
        console.log('🌐 当前基础URL:', getCurrentBaseUrl());
        console.log('📦 模块基础URL:', MODULE_BASE_URL);

        // 模块配置（在线版本）
        const MODULE_CONFIG = [
            {
                name: 'namespace',
                path: 'core/namespace.js',
                description: '全局命名空间管理器'
            },
            {
                name: 'utils',
                path: 'utils/common.js',
                description: '通用工具函数'
            },
            {
                name: 'formatParser',
                path: 'format/parser.js',
                description: '格式解析器'
            },
            {
                name: 'interactionSystem',
                path: 'interaction/detection-system.js',
                description: '互动检测系统'
            },
            {
                name: 'aiResponseHandler',
                path: 'ai/response-handler.js',
                description: 'AI回复处理器'
            }
        ];

        // 加载状态管理
        const loaderElement = document.getElementById('module-loader');
        const loaderText = document.getElementById('loader-text');

        function showLoader(text, type = '') {
            loaderText.textContent = text;
            loaderElement.className = `module-loader show ${type}`;
        }

        function hideLoader() {
            loaderElement.className = 'module-loader';
        }

        // 动态加载脚本（支持在线加载）
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                console.log(`📥 正在加载: ${src}`);
                
                const script = document.createElement('script');
                script.src = src;
                script.crossOrigin = 'anonymous'; // 支持跨域
                
                script.onload = () => {
                    console.log(`✅ 加载成功: ${src}`);
                    resolve();
                };
                
                script.onerror = (error) => {
                    console.error(`❌ 加载失败: ${src}`, error);
                    reject(new Error(`Failed to load: ${src}`));
                };
                
                document.head.appendChild(script);
            });
        }

        // 主加载函数
        async function loadModules() {
            try {
                showLoader('正在初始化在线模块系统...');
                console.log('🚀 开始加载手机QQ界面在线模块系统');
                
                // 先尝试加载第一个模块来测试连接
                const firstModule = MODULE_CONFIG[0];
                const testUrl = `${MODULE_BASE_URL}${firstModule.path}`;
                
                console.log(`🔍 测试连接: ${testUrl}`);
                
                for (const module of MODULE_CONFIG) {
                    showLoader(`正在加载 ${module.description}...`);
                    console.log(`📦 加载模块: ${module.name} (${module.description})`);
                    
                    try {
                        const moduleUrl = `${MODULE_BASE_URL}${module.path}`;
                        await loadScript(moduleUrl);
                        console.log(`✅ 模块 ${module.name} 加载成功`);
                    } catch (error) {
                        console.error(`❌ 模块 ${module.name} 加载失败:`, error);
                        
                        // 如果是在线加载失败，尝试降级方案
                        if (module.name === 'namespace') {
                            console.log('🔄 在线模块加载失败，启用降级方案...');
                            await initializeFallbackMode();
                            showLoader('使用降级模式，功能有限', 'warning');
                            setTimeout(hideLoader, 3000);
                            return;
                        }
                        
                        throw error;
                    }
                }

                showLoader('所有模块加载完成', 'success');
                console.log('✅ 所有在线模块加载完成');
                
                setTimeout(() => {
                    hideLoader();
                    initializeApplication();
                }, 1000);

            } catch (error) {
                console.error('❌ 在线模块加载失败:', error);
                console.log('🔄 启用降级模式...');
                
                await initializeFallbackMode();
                showLoader('使用降级模式', 'error');
                setTimeout(hideLoader, 3000);
            }
        }

        // 降级模式：内联基础功能
        async function initializeFallbackMode() {
            console.log('🛡️ 初始化降级模式...');
            
            // 创建基础的命名空间
            window.QQMobile = {
                version: '2.0.0-fallback',
                data: {
                    msgjson: { 私聊: {}, 群聊: {} },
                    groups: [],
                    momentsData: [],
                    chatBackup: {}
                },
                state: {
                    isGenerating: false,
                    retryCount: 0,
                    maxRetry: 3,
                    userTriggeredInteractive: false,
                    lastRequest: "",
                    lastRequestName: ""
                },
                events: {
                    listeners: {},
                    on: function(event, callback) {
                        if (!this.listeners[event]) this.listeners[event] = [];
                        this.listeners[event].push(callback);
                    },
                    emit: function(event, ...args) {
                        if (!this.listeners[event]) return;
                        this.listeners[event].forEach(cb => cb(...args));
                    }
                }
            };
            
            // 设置向后兼容的全局变量
            window.QQ_msgjson = QQMobile.data.msgjson;
            window.QQ_Groups = QQMobile.data.groups;
            window.QQ_MomentsData = QQMobile.data.momentsData;
            window.gening = QQMobile.state.isGenerating;
            
            // 基础函数
            window.QQ_CleanNestedTags = function(content) {
                if (!content) return '';
                return content.replace(/<(consider|thinking|reflection|analysis|internal|meta|system)[\s\S]*?<\/\1>/gi, '').trim();
            };
            
            // 简化的AI回复处理
            window.ResultHandle = async function(result, isRetry = false) {
                console.log('🤖 降级模式AI回复处理:', result ? result.substring(0, 100) + '...' : 'empty');
                
                if (!result) {
                    console.log('❌ 空回复');
                    return;
                }
                
                // 基础处理逻辑
                if (typeof QQ_Msg_Parse === 'function') {
                    try {
                        await QQ_Msg_Parse(result);
                        console.log('✅ 基础解析完成');
                    } catch (error) {
                        console.error('❌ 基础解析失败:', error);
                    }
                }
            };
            
            // 基础消息解析
            window.QQ_Msg_Parse = async function(content) {
                console.log('📝 降级模式消息解析');
                // 基础实现，主要确保不报错
                return true;
            };
            
            console.log('✅ 降级模式初始化完成');
        }

        // 应用初始化
        async function initializeApplication() {
            console.log('🎯 初始化应用...');
            
            try {
                // 检查模块状态
                if (window.QQMobile && window.QQMobile.version && !window.QQMobile.version.includes('fallback')) {
                    console.log('✅ 完整模块模式');
                    
                    // 设置全局事件监听器
                    setupGlobalEventListeners();
                    
                    // 触发应用就绪事件
                    QQMobile.events.emit('app:ready');
                } else {
                    console.log('⚠️ 降级模式，功能有限');
                }
                
                console.log('✅ 应用初始化完成');
                
            } catch (error) {
                console.error('❌ 应用初始化失败:', error);
            }
        }

        // 设置全局事件监听器
        function setupGlobalEventListeners() {
            if (!window.QQMobile || !window.QQMobile.events) return;
            
            QQMobile.events.on('module:loaded', (moduleName) => {
                console.log(`📦 模块事件: ${moduleName} 已加载`);
            });

            window.addEventListener('error', (event) => {
                console.error('🚨 全局错误:', event.error);
            });
        }

        // SillyTavern兼容性设置
        if (typeof charcardname === 'undefined') {
            window.charcardname = '角色';
        }
        
        if (typeof UserName === 'undefined') {
            window.UserName = '用户';
        }

        // 基本的API函数
        window.QQ_Gen = window.QQ_Gen || async function(message) {
            console.log('🤖 调用AI生成:', message?.substring(0, 100) + '...');
            // 这里需要与SillyTavern的实际API集成
            return message; // 临时返回
        };

        window.triggerSlash = window.triggerSlash || function(command) {
            console.log('⚡ 执行斜杠命令:', command);
        };

        // 其他必要的全局函数
        window.QQ_UpdateMessageList = window.QQ_UpdateMessageList || function() {
            console.log('📱 更新消息列表');
        };

        window.QQ_UpdateNewTips = window.QQ_UpdateNewTips || function() {
            console.log('🔔 更新提示');
        };

        window.QQ_Save_Chat_Backup = window.QQ_Save_Chat_Backup || async function() {
            console.log('💾 保存聊天备份');
        };

        // 开始加载
        document.addEventListener('DOMContentLoaded', () => {
            console.log('📱 手机QQ界面在线版启动');
            loadModules();
        });

        // 导出模块管理工具
        window.QQ_ModuleLoader = {
            reload: loadModules,
            getBaseUrl: getCurrentBaseUrl,
            getModuleUrl: (modulePath) => MODULE_BASE_URL + modulePath,
            testConnection: async () => {
                try {
                    const testUrl = MODULE_BASE_URL + 'core/namespace.js';
                    await fetch(testUrl, { method: 'HEAD' });
                    return true;
                } catch (error) {
                    return false;
                }
            }
        };

        console.log('📱 手机QQ界面在线版 - 基础环境已准备就绪');
    </script>
</body>
</html>