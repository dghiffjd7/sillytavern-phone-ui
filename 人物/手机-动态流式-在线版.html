<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>æ‰‹æœºQQç•Œé¢ - åœ¨çº¿ä¼˜åŒ–ç‰ˆ</title>
    
    <!-- å¯¼å…¥å¤–éƒ¨CSSæ ·å¼ -->
    <style type="text/css">
        @import url(https://static.zeoseven.com/zsft/59/main/result.css);
        
        /* ä¿ç•™åŸæœ‰çš„æ ¸å¿ƒæ ·å¼å®šä¹‰ */
        .QQ_chat_page {
            padding-top: 10px;
            background-color: rgb(244, 245, 246);
            width: 100%;
            height: 100%;
            background-size: cover;
            background-repeat: no-repeat;
            background-position: top center;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            box-sizing: border-box;
            border-radius: var(--yj);
            position: relative;
            overflow-x: hidden;
        }

        .input-container {
            max-width: 100%;
            position: absolute;
            bottom: 0px;
            left: 0;
            width: 100%;
            background-color: rgb(255, 255, 255, 0.2);
            border-bottom-right-radius: 10px;
            border-bottom-left-radius: 10px;
            box-sizing: border-box;
            padding: 10px 0;
            border-top: 1px solid black;
        }

        .msgcontent {
            flex: 1;
            overflow-y: auto;
            box-sizing: border-box;
            margin-bottom: 50px;
            padding-left: 8px;
            padding-right: 8px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .userInput {
            font: inherit;
            height: 30px;
            border-radius: 30px;
            letter-spacing: 0.7px;
            width: 100%;
            padding-left: 10px;
            padding-right: 10px;
            border: 1px solid rgb(0, 0, 0, 0.5);
        }

        /* æ¨¡å—åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .module-loader {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 9999;
            display: none;
        }

        .module-loader.show { display: block; }
        .module-loader.success { background: rgba(0, 128, 0, 0.8); }
        .module-loader.error { background: rgba(255, 0, 0, 0.8); }
    </style>
</head>

<body>
    <!-- æ¨¡å—åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div id="module-loader" class="module-loader">
        <span id="loader-text">æ­£åœ¨åŠ è½½æ¨¡å—...</span>
    </div>

    <!-- ä¸»ç•Œé¢å®¹å™¨ -->
    <div id="App_QQ">
        <!-- HTMLç»“æ„å°†åœ¨è¿è¡Œæ—¶åŠ è½½ -->
    </div>

    <script>
        // ç¡®å®šå½“å‰é¡µé¢çš„åŸºç¡€URL
        const getCurrentBaseUrl = () => {
            const currentUrl = window.location.href;
            const basePath = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1);
            return basePath;
        };

        // åŠ¨æ€ç¡®å®šæ¨¡å—åŸºç¡€è·¯å¾„
        const MODULE_BASE_URL = getCurrentBaseUrl() + 'modules/';
        
        console.log('ğŸŒ å½“å‰åŸºç¡€URL:', getCurrentBaseUrl());
        console.log('ğŸ“¦ æ¨¡å—åŸºç¡€URL:', MODULE_BASE_URL);

        // æ¨¡å—é…ç½®ï¼ˆåœ¨çº¿ç‰ˆæœ¬ï¼‰
        const MODULE_CONFIG = [
            {
                name: 'namespace',
                path: 'core/namespace.js',
                description: 'å…¨å±€å‘½åç©ºé—´ç®¡ç†å™¨'
            },
            {
                name: 'utils',
                path: 'utils/common.js',
                description: 'é€šç”¨å·¥å…·å‡½æ•°'
            },
            {
                name: 'formatParser',
                path: 'format/parser.js',
                description: 'æ ¼å¼è§£æå™¨'
            },
            {
                name: 'interactionSystem',
                path: 'interaction/detection-system.js',
                description: 'äº’åŠ¨æ£€æµ‹ç³»ç»Ÿ'
            },
            {
                name: 'aiResponseHandler',
                path: 'ai/response-handler.js',
                description: 'AIå›å¤å¤„ç†å™¨'
            }
        ];

        // åŠ è½½çŠ¶æ€ç®¡ç†
        const loaderElement = document.getElementById('module-loader');
        const loaderText = document.getElementById('loader-text');

        function showLoader(text, type = '') {
            loaderText.textContent = text;
            loaderElement.className = `module-loader show ${type}`;
        }

        function hideLoader() {
            loaderElement.className = 'module-loader';
        }

        // åŠ¨æ€åŠ è½½è„šæœ¬ï¼ˆæ”¯æŒåœ¨çº¿åŠ è½½ï¼‰
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                console.log(`ğŸ“¥ æ­£åœ¨åŠ è½½: ${src}`);
                
                const script = document.createElement('script');
                script.src = src;
                script.crossOrigin = 'anonymous'; // æ”¯æŒè·¨åŸŸ
                
                script.onload = () => {
                    console.log(`âœ… åŠ è½½æˆåŠŸ: ${src}`);
                    resolve();
                };
                
                script.onerror = (error) => {
                    console.error(`âŒ åŠ è½½å¤±è´¥: ${src}`, error);
                    reject(new Error(`Failed to load: ${src}`));
                };
                
                document.head.appendChild(script);
            });
        }

        // ä¸»åŠ è½½å‡½æ•°
        async function loadModules() {
            try {
                showLoader('æ­£åœ¨åˆå§‹åŒ–åœ¨çº¿æ¨¡å—ç³»ç»Ÿ...');
                console.log('ğŸš€ å¼€å§‹åŠ è½½æ‰‹æœºQQç•Œé¢åœ¨çº¿æ¨¡å—ç³»ç»Ÿ');
                
                // å…ˆå°è¯•åŠ è½½ç¬¬ä¸€ä¸ªæ¨¡å—æ¥æµ‹è¯•è¿æ¥
                const firstModule = MODULE_CONFIG[0];
                const testUrl = `${MODULE_BASE_URL}${firstModule.path}`;
                
                console.log(`ğŸ” æµ‹è¯•è¿æ¥: ${testUrl}`);
                
                for (const module of MODULE_CONFIG) {
                    showLoader(`æ­£åœ¨åŠ è½½ ${module.description}...`);
                    console.log(`ğŸ“¦ åŠ è½½æ¨¡å—: ${module.name} (${module.description})`);
                    
                    try {
                        const moduleUrl = `${MODULE_BASE_URL}${module.path}`;
                        await loadScript(moduleUrl);
                        console.log(`âœ… æ¨¡å— ${module.name} åŠ è½½æˆåŠŸ`);
                    } catch (error) {
                        console.error(`âŒ æ¨¡å— ${module.name} åŠ è½½å¤±è´¥:`, error);
                        
                        // å¦‚æœæ˜¯åœ¨çº¿åŠ è½½å¤±è´¥ï¼Œå°è¯•é™çº§æ–¹æ¡ˆ
                        if (module.name === 'namespace') {
                            console.log('ğŸ”„ åœ¨çº¿æ¨¡å—åŠ è½½å¤±è´¥ï¼Œå¯ç”¨é™çº§æ–¹æ¡ˆ...');
                            await initializeFallbackMode();
                            showLoader('ä½¿ç”¨é™çº§æ¨¡å¼ï¼ŒåŠŸèƒ½æœ‰é™', 'warning');
                            setTimeout(hideLoader, 3000);
                            return;
                        }
                        
                        throw error;
                    }
                }

                showLoader('æ‰€æœ‰æ¨¡å—åŠ è½½å®Œæˆ', 'success');
                console.log('âœ… æ‰€æœ‰åœ¨çº¿æ¨¡å—åŠ è½½å®Œæˆ');
                
                setTimeout(() => {
                    hideLoader();
                    initializeApplication();
                }, 1000);

            } catch (error) {
                console.error('âŒ åœ¨çº¿æ¨¡å—åŠ è½½å¤±è´¥:', error);
                console.log('ğŸ”„ å¯ç”¨é™çº§æ¨¡å¼...');
                
                await initializeFallbackMode();
                showLoader('ä½¿ç”¨é™çº§æ¨¡å¼', 'error');
                setTimeout(hideLoader, 3000);
            }
        }

        // é™çº§æ¨¡å¼ï¼šå†…è”åŸºç¡€åŠŸèƒ½
        async function initializeFallbackMode() {
            console.log('ğŸ›¡ï¸ åˆå§‹åŒ–é™çº§æ¨¡å¼...');
            
            // åˆ›å»ºåŸºç¡€çš„å‘½åç©ºé—´
            window.QQMobile = {
                version: '2.0.0-fallback',
                data: {
                    msgjson: { ç§èŠ: {}, ç¾¤èŠ: {} },
                    groups: [],
                    momentsData: [],
                    chatBackup: {}
                },
                state: {
                    isGenerating: false,
                    retryCount: 0,
                    maxRetry: 3,
                    userTriggeredInteractive: false,
                    lastRequest: "",
                    lastRequestName: ""
                },
                events: {
                    listeners: {},
                    on: function(event, callback) {
                        if (!this.listeners[event]) this.listeners[event] = [];
                        this.listeners[event].push(callback);
                    },
                    emit: function(event, ...args) {
                        if (!this.listeners[event]) return;
                        this.listeners[event].forEach(cb => cb(...args));
                    }
                }
            };
            
            // è®¾ç½®å‘åå…¼å®¹çš„å…¨å±€å˜é‡
            window.QQ_msgjson = QQMobile.data.msgjson;
            window.QQ_Groups = QQMobile.data.groups;
            window.QQ_MomentsData = QQMobile.data.momentsData;
            window.gening = QQMobile.state.isGenerating;
            
            // åŸºç¡€å‡½æ•°
            window.QQ_CleanNestedTags = function(content) {
                if (!content) return '';
                return content.replace(/<(consider|thinking|reflection|analysis|internal|meta|system)[\s\S]*?<\/\1>/gi, '').trim();
            };
            
            // ç®€åŒ–çš„AIå›å¤å¤„ç†
            window.ResultHandle = async function(result, isRetry = false) {
                console.log('ğŸ¤– é™çº§æ¨¡å¼AIå›å¤å¤„ç†:', result ? result.substring(0, 100) + '...' : 'empty');
                
                if (!result) {
                    console.log('âŒ ç©ºå›å¤');
                    return;
                }
                
                // åŸºç¡€å¤„ç†é€»è¾‘
                if (typeof QQ_Msg_Parse === 'function') {
                    try {
                        await QQ_Msg_Parse(result);
                        console.log('âœ… åŸºç¡€è§£æå®Œæˆ');
                    } catch (error) {
                        console.error('âŒ åŸºç¡€è§£æå¤±è´¥:', error);
                    }
                }
            };
            
            // åŸºç¡€æ¶ˆæ¯è§£æ
            window.QQ_Msg_Parse = async function(content) {
                console.log('ğŸ“ é™çº§æ¨¡å¼æ¶ˆæ¯è§£æ');
                // åŸºç¡€å®ç°ï¼Œä¸»è¦ç¡®ä¿ä¸æŠ¥é”™
                return true;
            };
            
            console.log('âœ… é™çº§æ¨¡å¼åˆå§‹åŒ–å®Œæˆ');
        }

        // åº”ç”¨åˆå§‹åŒ–
        async function initializeApplication() {
            console.log('ğŸ¯ åˆå§‹åŒ–åº”ç”¨...');
            
            try {
                // æ£€æŸ¥æ¨¡å—çŠ¶æ€
                if (window.QQMobile && window.QQMobile.version && !window.QQMobile.version.includes('fallback')) {
                    console.log('âœ… å®Œæ•´æ¨¡å—æ¨¡å¼');
                    
                    // è®¾ç½®å…¨å±€äº‹ä»¶ç›‘å¬å™¨
                    setupGlobalEventListeners();
                    
                    // è§¦å‘åº”ç”¨å°±ç»ªäº‹ä»¶
                    QQMobile.events.emit('app:ready');
                } else {
                    console.log('âš ï¸ é™çº§æ¨¡å¼ï¼ŒåŠŸèƒ½æœ‰é™');
                }
                
                console.log('âœ… åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
                
            } catch (error) {
                console.error('âŒ åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }

        // è®¾ç½®å…¨å±€äº‹ä»¶ç›‘å¬å™¨
        function setupGlobalEventListeners() {
            if (!window.QQMobile || !window.QQMobile.events) return;
            
            QQMobile.events.on('module:loaded', (moduleName) => {
                console.log(`ğŸ“¦ æ¨¡å—äº‹ä»¶: ${moduleName} å·²åŠ è½½`);
            });

            window.addEventListener('error', (event) => {
                console.error('ğŸš¨ å…¨å±€é”™è¯¯:', event.error);
            });
        }

        // SillyTavernå…¼å®¹æ€§è®¾ç½®
        if (typeof charcardname === 'undefined') {
            window.charcardname = 'è§’è‰²';
        }
        
        if (typeof UserName === 'undefined') {
            window.UserName = 'ç”¨æˆ·';
        }

        // åŸºæœ¬çš„APIå‡½æ•°
        window.QQ_Gen = window.QQ_Gen || async function(message) {
            console.log('ğŸ¤– è°ƒç”¨AIç”Ÿæˆ:', message?.substring(0, 100) + '...');
            // è¿™é‡Œéœ€è¦ä¸SillyTavernçš„å®é™…APIé›†æˆ
            return message; // ä¸´æ—¶è¿”å›
        };

        window.triggerSlash = window.triggerSlash || function(command) {
            console.log('âš¡ æ‰§è¡Œæ–œæ å‘½ä»¤:', command);
        };

        // å…¶ä»–å¿…è¦çš„å…¨å±€å‡½æ•°
        window.QQ_UpdateMessageList = window.QQ_UpdateMessageList || function() {
            console.log('ğŸ“± æ›´æ–°æ¶ˆæ¯åˆ—è¡¨');
        };

        window.QQ_UpdateNewTips = window.QQ_UpdateNewTips || function() {
            console.log('ğŸ”” æ›´æ–°æç¤º');
        };

        window.QQ_Save_Chat_Backup = window.QQ_Save_Chat_Backup || async function() {
            console.log('ğŸ’¾ ä¿å­˜èŠå¤©å¤‡ä»½');
        };

        // å¼€å§‹åŠ è½½
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ“± æ‰‹æœºQQç•Œé¢åœ¨çº¿ç‰ˆå¯åŠ¨');
            loadModules();
        });

        // å¯¼å‡ºæ¨¡å—ç®¡ç†å·¥å…·
        window.QQ_ModuleLoader = {
            reload: loadModules,
            getBaseUrl: getCurrentBaseUrl,
            getModuleUrl: (modulePath) => MODULE_BASE_URL + modulePath,
            testConnection: async () => {
                try {
                    const testUrl = MODULE_BASE_URL + 'core/namespace.js';
                    await fetch(testUrl, { method: 'HEAD' });
                    return true;
                } catch (error) {
                    return false;
                }
            }
        };

        console.log('ğŸ“± æ‰‹æœºQQç•Œé¢åœ¨çº¿ç‰ˆ - åŸºç¡€ç¯å¢ƒå·²å‡†å¤‡å°±ç»ª');
    </script>
</body>
</html>