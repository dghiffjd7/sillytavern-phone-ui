<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Document</title>
<style>@import url(https:.QQ_chat_page{padding-top:10px;background-color:rgb(244,245,246);width:100%;height:100%;box-sizing:border-box;border-radius:var(--yj);position:relative;overflow-x:hidden}.input-container{max-width:100%;position:absolute;bottom:0px;left:0;width:100%;background-color:rgb(255,255,255,0.2);border-bottom-right-radius:10px;border-bottom-left-radius:10px;box-sizing:border-box;padding:10px 0;border-top:1px solid black}.msgcontent{flex:1;overflow-y:auto;box-sizing:border-box;margin-bottom:50px;padding-left:8px;padding-right:8px;scrollbar-width:none;-ms-overflow-style:none}.userInput{font:inherit;height:30px;border-radius:30px;letter-spacing:0.7px;width:100%;padding-left:10px;padding-right:10px;border:1px solid rgb(0,0,0,0.5)}.chat-setting-popup{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:80%;max-width:350px;background-color:#fff;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.2);z-index:1000;display:none}.chat-setting-header{padding:15px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}.chat-setting-header span{font-weight:bold;font-size:16px}.close-setting-btn{cursor:pointer}.chat-setting-content{padding:15px}.setting-item{margin-bottom:15px;display:flex;justify-content:space-between;align-items:center;gap:10px}.setting-item span{font-size:14px}.setting-item input[type="text"]{flex:1;padding:5px;border:1px solid #ccc;border-radius:5px}.color-picker{width:30px;height:30px;padding:0;border:1px solid #ccc;border-radius:3px;cursor:pointer}.chat-setting-footer{padding:10px 15px;text-align:right;border-top:1px solid #eee}.chat-setting-footer button{padding:6px 15px;margin-left:10px;border:none;border-radius:5px;cursor:pointer}#save-setting-btn{background-color:#019aff;color:white}#cancel-setting-btn{background-color:#f5f5f5;color:#333}.popup-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);border-radius:35px;z-index:999;display:none}#floating_search_box:hover{background-color:rgba(239,243,255,0.95) !important;border-color:rgba(25,154,255,0.4) !important;transform:translateY(-1px)}#contact_search_input::placeholder{color:#999;font-style:italic}#search_clear_btn:hover{background-color:#999 !important;transform:scale(1.1)}#QQ_home_chars::-webkit-scrollbar{display:none !important}.search-highlight{background-color:#ffeb3b !important;color:#333 !important;padding:1px 2px;border-radius:2px;font-weight:bold}.QQ_chat_fakeimg{width:100%;background-color:white;aspect-ratio:1 / 1;padding:5px 18px 0 20px;display:flex;flex-direction:column;justify-content:center;align-items:center;font-size:1.3em;-ms-overflow-style:none !important;scrollbar-width:none !important;text-align:center}.QQ_chat_fakeimg::-webkit-scrollbar{display:none !important}.QQ_chat_fakeimg div{max-height:100%;display:flex;align-items:flex-start;overflow-y:auto;-ms-overflow-style:none !important;scrollbar-width:none !important}.QQ_chat_fakeimg div::-webkit-scrollbar{display:none !important}.discord{background-color:#f2f3f5;width:100%;height:100%;line-height:1.4;letter-spacing:1px}.discord-top{background-color:white;width:100%;height:80px;padding-top:30px;padding-left:10px;display:flex;align-items:center}.discord-top-title{font-size:20px;text-align:center;margin-top:-3px}.discord-top-button{display:flex;align-items:center;margin-bottom:10px}.sortbutton{display:flex;align-items:center;gap:4px;margin-bottom:-1px;height:32px;background-color:#e8e9eb;padding:8px 8px 8px 12px;width:fit-content;border-radius:24px;margin-top:10px;margin-left:10px}.tagbutton{display:flex;align-items:center;margin-left:auto;margin-right:10px;background-color:#e8e9eb;padding:8px 8px 8px 12px;width:fit-content;height:32px;border-radius:24px;margin-top:10px}.discord-cardlist{display:flex;flex-direction:column;width:100%;height:100%;overflow-y:auto;padding:0 10px 150px 10px;scrollbar-width:none;-ms-overflow-style:none}.discord-cardlist::-webkit-scrollbar{display:none !important}.discord-card{width:100%;height:auto;background-color:white;border-radius:15px;margin-top:15px;padding-left:13px;padding-right:13px;padding-bottom:10px;border:1px solid #dfdfe1}.discord-card:active{background-color:rgb(244,243,243)}.discord-card-tags{width:100%;display:flex;flex-wrap:wrap;gap:5px;padding-top:10px}.discord-card-tag{background-color:#eeeff1;color:#4f5055;width:fit-content;padding:5px 15px;border-radius:24px;margin-top:5px;margin-left:-1px;font-size:15px;text-align:center;font-weight:bold}.discord-card-author{color:#9d8ef3;margin-top:8px;font-size:18px;display:inline-block;font-weight:bold}.discord-card-title{font-weight:bold;font-size:19px;margin-top:5px;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;overflow:hidden;text-overflow:ellipsis;white-space:normal;word-break:break-word}.discord-card-content{margin-top:2px;color:#313133;font-size:16px;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:3;overflow:hidden;text-overflow:ellipsis;white-space:normal;word-break:break-word}.discord-card-interact{display:flex;align-items:center;margin-top:15px}.discord-card-interact-icon{margin-left:auto;color:#333237;background-color:#ececec;border-radius:10px;font-size:16px;padding:2px 8px 2px 6px;display:flex;align-items:center;justify-content:center}.discord-card-fakeimg{text-align:center;margin-top:9px;font-size:1.2rem;background-color:rgb(239 237 238);padding:30px 10px;width:100%;border:1px solid #dfdfe1;border-radius:5px;text-align:center;text-wrap:balance}.discord-thread{width:100%;height:100%;background-color:white;padding-top:30px;position:relative}.discord-thread-top{display:grid;grid-template-columns:32px 43px 1fr;align-items:center;width:100%;height:50px;padding:0 10px}.discord-thread-title{font-weight:bold;font-size:20px;overflow:hidden;text-overflow:ellipsis;width:100%;white-space:nowrap}.discord-thread-content{overflow-y:auto;padding:0 10px;width:100%;height:auto}.discord-thread-content-title{font-weight:bold;font-size:24px;margin-top:10px;margin-bottom:3px}.discord-thread-content-tags{width:100%;display:flex;flex-wrap:wrap;gap:5px;.discord-card-tag{margin-top:5px}}.discord-thread-content-original{display:grid;grid-template-columns:55px 1fr;align-items:start;margin-top:20px;margin-bottom:10px}.discord-thread-content-original-author-head{width:45px;height:45px;background-size:cover;border-radius:50%}.discord-thread-content-original-author-name{color:#9d8ef3;font-size:18px;display:inline-block;font-weight:bold}.discord-thread-content-original-content{white-space:pre-wrap;margin-top:3px}.discord-thread-content-likes{width:fit-content;padding:5px 8px 5px 8px;text-align:center;background-color:#f2f3f5;border-radius:8px;display:flex;align-items:center;gap:5px;color:#525358;font-size:16px;height:34px}.discord-thread-content-reaction{background-color:#eeeeef;padding:5px;align-items:center;justify-content:center;border-radius:10px;display:flex;margin-left:6px;height:34px}.discord-thread-comment-list{padding:0 10px;width:100%}.discord-thread-comment{display:grid;grid-template-columns:50px 1fr;margin-top:20px}.discord-thread-comment-head{width:40px;height:40px;background-size:cover;border-radius:50%}.discord-name-creator{color:#9d8ef3;font-size:16px;display:inline-block;font-weight:bold;position:relative}.discord-thread-comment-name{font-size:16px;display:inline-block;font-weight:bold;position:relative}.discord-thread-comment-content{margin-top:3px}.discord-name-creator::after{position:absolute;top:0%;left:100%;margin-left:3px;height:20px;width:20px;display:inline-block;content:"";background-size:contain;background-image:url("data:image/webp;base64,UklGRkoCAABXRUJQVlA4WAoAAAAQAAAAHQAAHwAAQUxQSIEAAAABcFpt27K8L91pkm0KTxwGIMEO7pYcGolE9BUs0VxHkEqy3/+fl0qKiAkAAEAABEIESdtoYr1SrlBkurFzB8MSPlSiHPsT7Px17MvmHmUXRQmnJRgKU/pBjOknQ3rvo8jHsKRTNYixzZIyAZCOMCRsVkZ7oXk2fRJgrCyWpGOU+CkAVlA4IKIBAABwCQCdASoeACAAPmEoj0WkIqGb/VQAQAYEswBhsa8KA3gFgAdKgvwVsdYAxwUyDx3fSu/J9AD9dBN4HzXUGnIffZmZ+Xi6UOW2PLIrM .moment-like-button{cursor:pointer;transition:all 0.2s ease;filter:drop-shadow(0 1px 2px rgba(0,0,0,0.1))}.moment-like-button:hover{transform:scale(1.1);filter:drop-shadow(0 2px 4px rgba(0,0,0,0.2))}.moment-like-button.liked{fill:#1677ff !important;animation:likeAnimation 0.3s ease-out;filter:drop-shadow(0 2px 6px rgba(22,119,255,0.3))}@keyframes likeAnimation{0%{transform:scale(1)}50%{transform:scale(1.3)}100%{transform:scale(1)}}.moment-like-popup{position:absolute;bottom:25px;left:0;background:#fff;border:1px solid #ddd;border-radius:4px;padding:4px 8px;font-size:12px;color:#666;display:none;box-shadow:0 2px 8px rgba(0,0,0,0.1);z-index:1000;white-space:nowrap;animation:popupFadeIn 0.3s ease-out}@keyframes popupFadeIn{0%{opacity:0;transform:translateY(10px)}100%{opacity:1;transform:translateY(0)}}.moment-like-count{color:#474545;font-size:14px;transition:color 0.2s ease}.liked-thumb{filter:drop-shadow(0 0 8px #1677ff) !important;transform:scale(1.2) !important;transition:all 0.3s ease !important}.pulse-animation{animation:thumbPulse 0.8s ease-in-out}@keyframes thumbPulse{0%{transform:scale(1);filter:none}50%{transform:scale(1.3);filter:drop-shadow(0 0 12px #1677ff)}100%{transform:scale(1.2);filter:drop-shadow(0 0 8px #1677ff)}}.user-liked-tip{animation:slideInFromLeft 0.3s ease;display:block}@keyframes slideInFromLeft{0%{opacity:0;transform:translateX(-20px)}100%{opacity:1;transform:translateX(0)}}.moment_button svg:hover{transform:scale(1.1) !important;transition:all 0.2s ease !important;cursor:pointer !important}.moment_button svg{transition:all 0.2s ease;cursor:pointer}.moment_comment{cursor:pointer;padding:8px;margin:-8px;border-radius:6px;transition:all 0.2s ease;transform:scale(1.4);transform-origin:center}.moment_comment:hover{background-color:rgba(0,0,0,0.05);transform:scale(1.5)}.moment_msg{background-color:#fff;margin-top:5px;max-width:60%;border-radius:7px;font-size:15px;padding:6px;width:-webkit-fit-content;width:fit-content;white-space:normal;letter-spacing:1px;line-height:1.4;margin-bottom:10px;box-shadow:1px 1px 2px rgba(32,32,32,0.2)}#Home_page{width:100%;height:100%;background-image:url("http:background-size:cover;background-position:top center;background-repeat:no-repeat}.QQ_chat_head{width:40px;height:40px;border-radius:50%;background-size:cover;min-width:40px}.user_avatar{width:40px;height:40px;border-radius:50%;background-size:cover}.QQ_chat_msg{font-size:14px;margin-right:5px;margin-left:5px}.QQ_chat_mymsg{max-width:70%;margin-left:auto;display:grid;grid-template-columns:1fr 50px;grid-template-rows:auto auto;justify-items:end;text-align:right;-webkit-align-items:start;align-items:start;margin-bottom:20px;margin-right:15px}.QQ_chat_charmsg{max-width:80%;display:grid;grid-template-columns:47px 1fr;grid-template-rows:auto auto;-webkit-align-items:start;align-items:start;margin-bottom:20px;margin-left:15px}.QQ_chat_msgdiv{box-shadow:2px 2px 2px rgba(15,15,15,0.3);letter-spacing:1px;line-height:1.4;font-size:15px;width:-webkit-fit-content;width:fit-content;background-color:rgb(239,206,242,0.65);color:black;border-radius:7px;padding:7px;text-align:left;box-sizing:border-box;margin-left:-2px}.QQ_chat_name{font-size:13px;color:black}.QQ_chat_msgimg{width:100%;background-color:white}.msgimg{max-width:100%;height:auto;display:block}.QQ_chat_time{display:-webkit-flex;display:flex;-webkit-align-items:center;align-items:center;-webkit-justify-content:center;justify-content:center;width:100%;height:10px;margin-bottom:10px;color:#a1a1a1}.mimictwitter hr{background-color:rgb(240,244,245);border:none;height:1px}.twitterhead{width:45px;height:45px;border-radius:50%;margin-left:4px;min-width:45px}.interactsvg{width:15.5px;height:15.5px}.twitter-content{-webkit-flex:1;flex:1;overflow-y:auto;box-sizing:border-box;padding-top:10px;padding-right:3px}.mimictwitter{background-color:white;width:100%;max-width:100%;border-radius:10px;height:100%;box-sizing:border-box;padding-top:10px;display:-webkit-flex;display:flex;-webkit-flex-direction:column;flex-direction:column;position:relative;overflow-x:hidden}.twitter{overflow-x:hidden;font-size:16px;height:100%}.twitter_moment{display:grid;grid-template-columns:50px 1fr 0px;grid-template-rows:auto auto}img{box-sizing:border-box !important}*{box-sizing:border-box}.user_leave_message{font-size:13px;margin-top:7px;display:-webkit-flex;display:flex;-webkit-flex-direction:column;flex-direction:column;span{line-height:1.5}}.space_contents{scrollbar-width:none;-ms-overflow-style:none}.give_money{margin-top:10px;border-radius:8px;overflow:hidden}#QQ_home_chars{background-color:#fefefe;width:100%;-webkit-flex:1;flex:1;border-radius:20px 20px 20px 20px;padding:5px 20px 20px 20px;box-sizing:border-box;overflow:auto !important;-ms-overflow-style:none !important;scrollbar-width:none !important;margin-bottom:40px}#QQ_home_chars::-webkit-scrollbar{display:none !important}#QQ_home_page{display:-webkit-flex;display:flex;-webkit-flex-direction:column;flex-direction:column;height:100%}span{word-break:break-word}.QQ_chat_music{background-color:#fefefe;border-radius:10px;padding-top:10px;padding-right:10px;padding-left:10px;padding-bottom:5px;width:100%}.hide-title{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.music-play-button{position:absolute;border-radius:50%;background-color:hsla(0,0%,100%,0.2862745098);height:32px;width:32px;top:50%;left:50%;-webkit-transform:translate(-50%,-50%);transform:translate(-50%,-50%);z-index:2;border:2px solid white;display:-webkit-flex;display:flex;-webkit-justify-content:center;justify-content:center;-webkit-align-items:center;align-items:center}.space_fakeimg{text-align:center;margin-top:5px;font-size:1.2rem;background-color:rgb(239 237 238);padding:30px 10px;width:100%;border:1px solid black;border-radius:5px;text-align:center}.QQ_home_lasttime{overflow:hidden;white-space:nowrap;text-overflow:ellipsis;max-width:4rem;margin-right:5px}#QQ_message_list_chars{background-color:#fefefe;width:100%;-webkit-flex:1;flex:1;border-radius:20px 20px 20px 20px;padding:5px 20px 20px 20px;box-sizing:border-box;overflow:auto !important;-ms-overflow-style:none !important;scrollbar-width:none !important;margin-bottom:40px}#QQ_message_list_chars::-webkit-scrollbar{display:none !important}.group-management-dropdown{position:absolute;top:100%;left:0;right:0;background:white;border:1px solid #e0e0e0;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:10000;max-height:300px;overflow-y:auto;margin-top:5px}.group-management-header{display:flex;justify-content:space-between;align-items:center;padding:12px 15px;border-bottom:1px solid #f0f0f0;background:#f8f9fa;border-radius:8px 8px 0 0}.group-management-title{font-size:14px;font-weight:bold;color:#333}.group-settings-icon{width:20px;height:20px;cursor:pointer;opacity:0.7;transition:opacity 0.2s}.group-settings-icon:hover{opacity:1}.group-members-list{padding:8px 0}.group-member-item{display:flex;align-items:center;padding:8px 15px;transition:background-color 0.2s}.group-member-item:hover{background-color:#f5f5f5}.group-member-avatar{width:32px;height:32px;border-radius:50%;margin-right:10px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold;color:white;background:linear-gradient(135deg,#667eea,#764ba2)}.group-member-name{flex:1;font-size:14px;color:#333}.group-settings-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;z-index:20000}.group-settings-content{background:white;border-radius:12px;width:90%;max-width:400px;max-height:80vh;overflow-y:auto;box-shadow:0 8px 32px rgba(0,0,0,0.2)}.group-settings-header{padding:20px;border-bottom:1px solid #f0f0f0;text-align:center}.group-settings-title{font-size:18px;font-weight:bold;color:#333;margin:0}.group-settings-body{padding:20px}.group-settings-section{margin-bottom:20px}.group-settings-section-title{font-size:14px;font-weight:bold;color:#333;margin-bottom:10px}.group-settings-input{width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px;box-sizing:border-box}.group-settings-member-list{max-height:200px;overflow-y:auto;border:1px solid #f0f0f0;border-radius:6px}.group-settings-member-item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid #f8f8f8}.group-settings-member-item:last-child{border-bottom:none}.group-settings-member-info{display:flex;align-items:center;flex:1}.group-settings-remove-btn{background:#ff4757;color:white;border:none;border-radius:4px;padding:4px 8px;font-size:12px;cursor:pointer;transition:background-color 0.2s}.group-settings-remove-btn:hover{background:#ff3742}.group-settings-add-member-item{margin-top:10px}.group-settings-add-member-btn{width:100%;padding:12px;border:2px dashed #ddd;border-radius:8px;background:transparent;color:#666;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;font-size:14px;transition:all 0.3s ease}.group-settings-add-member-btn:hover{border-color:#199AFF;color:#199AFF;background:rgba(25,154,255,0.05)}.add-member-icon{font-size:18px;font-weight:bold}.add-member-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;z-index:25000}.add-member-dialog{background:white;border-radius:12px;width:90%;max-width:400px;max-height:80vh;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,0.3)}.add-member-header{padding:20px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,#f8f9fa,#e9ecef)}.add-member-title{font-size:18px;font-weight:bold;color:#333;margin:0}.add-member-close{font-size:24px;color:#999;cursor:pointer;line-height:1}.add-member-close:hover{color:#666}.add-member-content{padding:20px;max-height:400px;overflow-y:auto}.add-member-search{position:relative;margin-bottom:15px}.add-member-search-input{width:100%;padding:10px 40px 10px 15px;border:1px solid #ddd;border-radius:8px;font-size:14px;box-sizing:border-box}.add-member-search-input:focus{outline:none;border-color:#199AFF}.add-member-search-icon{position:absolute;right:12px;top:50%;transform:translateY(-50%);color:#999}.add-member-contact-list{max-height:300px;overflow-y:auto}.add-member-contact-item{display:flex;align-items:center;padding:12px;border-radius:8px;cursor:pointer;transition:all 0.2s ease;border:2px solid transparent;margin-bottom:8px}.add-member-contact-item:hover{background:#f8f9fa;border-color:#e9ecef}.add-member-contact-item.selected{background:#e3f2fd;border-color:#199AFF}.add-member-contact-item.disabled{cursor:not-allowed}.add-member-contact-item.disabled:hover{background:transparent;border-color:transparent}.add-member-contact-avatar{width:40px;height:40px;border-radius:50%;margin-right:12px;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px;color:white;background-size:cover;background-position:center;flex-shrink:0}.add-member-contact-name{flex:1;font-size:14px;color:#333;font-weight:500}.add-member-contact-status{font-size:12px;color:#666;padding:4px 8px;border-radius:12px;background:#f0f0f0;transition:all 0.2s ease}.add-member-contact-item.selected .add-member-contact-status{background:#199AFF;color:white}.add-member-actions{padding:20px;border-top:1px solid #eee;display:flex;gap:12px;justify-content:flex-end;background:#fafafa}.add-member-btn{padding:12px 24px;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.3s ease;min-width:80px}.add-member-cancel-btn{background:#f8f9fa;color:#666;border:1px solid #dee2e6}.add-member-cancel-btn:hover{background:#e9ecef;border-color:#adb5bd}.add-member-confirm-btn{background:linear-gradient(135deg,#199AFF,#0066CC);color:white;box-shadow:0 2px 8px rgba(25,154,255,0.3)}.add-member-confirm-btn:hover{background:linear-gradient(135deg,#0066CC,#004499);box-shadow:0 4px 12px rgba(25,154,255,0.4);transform:translateY(-1px)}.add-member-confirm-btn:disabled{background:#ccc;cursor:not-allowed;box-shadow:none;transform:none}.group-settings-actions{display:flex;gap:10px;padding:20px;border-top:1px solid #f0f0f0}.group-settings-btn{flex:1;padding:12px;border:none;border-radius:6px;font-size:14px;font-weight:bold;cursor:pointer;transition:all 0.2s}.group-settings-save-btn{background:#199AFF;color:white}.group-settings-save-btn:hover{background:#0066CC}.group-settings-delete-btn{background:#ff4757;color:white}.group-settings-delete-btn:hover{background:#ff3742}.group-settings-cancel-btn{background:#f1f2f6;color:#333}.group-settings-cancel-btn:hover{background:#ddd}.group-settings-avatar-container{display:flex;align-items:center;gap:15px;padding:10px 0}.group-settings-avatar-preview{width:60px;height:60px;border-radius:50%;background:#4CAF50;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s ease;overflow:hidden}.group-settings-avatar-preview:hover{transform:scale(1.05);box-shadow:0 2px 8px rgba(0,0,0,0.2)}.group-settings-default-avatar{color:white;font-size:20px;font-weight:bold}.group-settings-avatar-preview img{width:100%;height:100%;object-fit:cover;border-radius:50%}.group-settings-avatar-text{color:#199AFF;cursor:pointer;font-size:14px;user-select:none}.group-settings-avatar-text:hover{text-decoration:underline}.group-chat-modal{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:1000;backdrop-filter:blur(3px)}.group-chat-dialog{background-color:#ffffff;border-radius:15px;width:280px;max-height:400px;box-shadow:0 10px 30px rgba(0,0,0,0.3);overflow:hidden;animation:modalSlideIn 0.3s ease-out}@keyframes modalSlideIn{from{opacity:0;transform:scale(0.8) translateY(-20px)}to{opacity:1;transform:scale(1) translateY(0)}}.group-chat-header{background:linear-gradient(135deg,#199AFF,#0066CC);color:white;padding:15px 20px;text-align:center;font-size:16px;font-weight:bold}.group-chat-content{padding:20px}.group-chat-option{display:flex;align-items:center;padding:12px 15px;margin-bottom:10px;border-radius:8px;background-color:#f8f9fa;cursor:pointer;transition:all 0.2s ease;border:1px solid #e9ecef}.group-chat-option:hover{background-color:#e3f2fd;border-color:#199AFF;transform:translateY(-1px)}.group-chat-option-icon{width:24px;height:24px;margin-right:12px;fill:#199AFF}.group-chat-option-text{font-size:14px;color:#333;font-weight:500}.group-create-modal{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:1001;backdrop-filter:blur(3px)}.group-create-dialog{background-color:#ffffff;border-radius:15px;width:320px;max-height:85vh;box-shadow:0 10px 30px rgba(0,0,0,0.3);overflow:hidden;animation:modalSlideIn 0.3s ease-out;display:flex;flex-direction:column}.group-create-header{background:linear-gradient(135deg,#199AFF,#0066CC);color:white;padding:15px 20px;display:flex;align-items:center;justify-content:space-between}.group-create-title{font-size:16px;font-weight:bold}.group-create-close{color:white;font-size:20px;cursor:pointer;padding:2px 6px;border-radius:50%;transition:background-color 0.2s}.group-create-close:hover{background-color:rgba(255,255,255,0.2)}.group-create-content{padding:20px;flex:1;overflow-y:auto;min-height:0}.group-name-section{margin-bottom:20px}.group-name-label{display:block;font-size:14px;color:#333;margin-bottom:8px;font-weight:500}.group-name-input{width:100%;padding:10px 12px;border:2px solid #e9ecef;border-radius:8px;font-size:14px;outline:none;transition:border-color 0.2s;box-sizing:border-box}.group-name-input:focus{border-color:#199AFF}.group-members-section{margin-bottom:20px}.group-members-label{font-size:14px;color:#333;margin-bottom:10px;font-weight:500}.contact-item{display:flex;align-items:center;padding:12px 8px;border-radius:8px;margin-bottom:6px;cursor:pointer;transition:all 0.3s ease;border:2px solid transparent;position:relative}.contact-item:last-child{margin-bottom:0}.contact-item:hover{background-color:#f8f9fa;transform:translateX(2px)}.contact-item.selected{background:linear-gradient(135deg,#199AFF 0%,#0066CC 100%) !important;color:white !important;border-color:#0066CC !important;box-shadow:0 4px 12px rgba(25,154,255,0.3) !important;transform:scale(1.02) !important;transition:all 0.2s ease !important}.contact-item.selected .contact-name{color:white !important;font-weight:500 !important}.contact-item.selected .contact-name span{background-color:rgba(255,255,255,0.3) !important;color:white !important}.contact-item.selected .contact-avatar{border:2px solid rgba(255,255,255,0.5) !important;box-shadow:0 0 8px rgba(255,255,255,0.3) !important}.contact-item.selected::before{content:'✓';position:absolute;right:8px;top:50%;transform:translateY(-50%);color:white;font-weight:bold;font-size:16px;z-index:10}.contact-checkbox{display:none}.group-member-search{position:relative;margin-bottom:15px}.group-search-input{width:100%;padding:10px 12px 10px 35px;border:2px solid #e9ecef;border-radius:8px;font-size:14px;outline:none;transition:border-color 0.2s;box-sizing:border-box;background-color:#f8f9fa}.group-search-input:focus{border-color:#199AFF;background-color:white}.group-search-icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:#666;font-size:14px}.group-search-clear{position:absolute;right:10px;top:50%;transform:translateY(-50%);color:#999;cursor:pointer;font-size:16px;padding:2px;border-radius:50%;transition:all 0.2s;display:none}.group-search-clear:hover{background-color:#e9ecef;color:#666}.group-search-clear.show{display:block}.contact-list-container{max-height:250px;overflow-y:auto;padding-right:5px}.contact-list-container::-webkit-scrollbar{width:4px}.contact-list-container::-webkit-scrollbar-track{background:#f1f1f1;border-radius:4px}.contact-list-container::-webkit-scrollbar-thumb{background:#c1c1c1;border-radius:4px}.contact-list-container::-webkit-scrollbar-thumb:hover{background:#a8a8a8}.no-results{text-align:center;color:#999;padding:20px;font-size:14px}.contact-avatar{width:32px;height:32px;border-radius:50%;margin-right:10px;background-color:#f0f0f0;background-size:cover;background-position:center;flex-shrink:0}.contact-name{font-size:14px;color:#333;flex:1}.group-create-actions{padding:15px 20px;background-color:#f8f9fa;display:flex;gap:10px}.group-action-btn{flex:1;padding:10px 16px;border:none;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;transition:all 0.2s ease}.group-cancel-btn{background-color:#f8f9fa;color:#666;border:1px solid #e9ecef}.group-cancel-btn:hover{background-color:#e9ecef}.group-confirm-btn{background:linear-gradient(135deg,#199AFF,#0066CC);color:white}.group-confirm-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(25,154,255,0.3)}.group-confirm-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none;box-shadow:none}.group-avatar-section{margin-bottom:20px}.group-avatar-label{display:block;margin-bottom:8px;font-size:14px;font-weight:500;color:#333}.group-avatar-selector{display:flex;align-items:center;gap:12px;cursor:pointer;transition:all 0.2s ease}.group-avatar-selector:hover{opacity:0.8}.group-avatar-preview{width:60px;height:60px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#199AFF,#0066CC);cursor:pointer;transition:all 0.2s ease;position:relative;overflow:hidden}.group-avatar-preview:hover{transform:scale(1.05);box-shadow:0 4px 15px rgba(25,154,255,0.3)}.default-group-avatar{color:white;font-size:24px;font-weight:bold}.group-avatar-preview img{width:100%;height:100%;object-fit:cover;border-radius:12px}.group-avatar-text{color:#666;font-size:14px;cursor:pointer}.avatar-selector-modal{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);backdrop-filter:blur(5px);display:flex;align-items:center;justify-content:center;z-index:30000;animation:modalFadeIn 0.3s ease}.avatar-selector-dialog{background:white;border-radius:16px;width:90%;max-width:450px;max-height:80vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3);animation:modalSlideIn 0.3s ease}.avatar-selector-header{display:flex;align-items:center;justify-content:space-between;padding:20px 20px 15px;border-bottom:1px solid #e9ecef;background:linear-gradient(135deg,#199AFF,#0066CC);color:white}.avatar-selector-title{font-size:16px;font-weight:600}.avatar-selector-close{font-size:24px;cursor:pointer;padding:0 5px;border-radius:50%;transition:all 0.2s ease;color:white}.avatar-selector-close:hover{background-color:rgba(255,255,255,0.2)}.avatar-selector-content{display:flex;flex-direction:column;max-height:500px}.avatar-selector-tabs{display:flex;background-color:#f8f9fa;border-bottom:1px solid #e9ecef}.avatar-tab{flex:1;padding:12px 16px;text-align:center;cursor:pointer;font-size:14px;color:#666;border-bottom:3px solid transparent;transition:all 0.2s ease}.avatar-tab.active{color:#199AFF;border-bottom-color:#199AFF;background-color:white;font-weight:500}.avatar-tab:hover:not(.active){background-color:#e9ecef}.avatar-selector-body{flex:1;padding:20px;overflow-y:auto}.avatar-options{display:none}.avatar-options.active{display:block}.preset-avatar-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}.preset-avatar-item{aspect-ratio:1;border-radius:12px;cursor:pointer;border:3px solid transparent;transition:all 0.2s ease;background:linear-gradient(135deg,var(--gradient-start),var(--gradient-end));display:flex;align-items:center;justify-content:center;color:white;font-size:18px;font-weight:bold;position:relative;overflow:hidden}.preset-avatar-item:hover{transform:scale(1.05);box-shadow:0 4px 15px rgba(0,0,0,0.2)}.preset-avatar-item.selected{border-color:#199AFF;transform:scale(1.1);box-shadow:0 6px 20px rgba(25,154,255,0.4)}.preset-avatar-item img{width:100%;height:100%;object-fit:cover;border-radius:8px}.upload-zone{border:2px dashed #ddd;border-radius:12px;padding:40px 20px;text-align:center;cursor:pointer;transition:all 0.2s ease;background-color:#f8f9fa}.upload-zone:hover{border-color:#199AFF;background-color:rgba(25,154,255,0.05)}.upload-icon{font-size:48px;margin-bottom:12px;color:#666}.upload-text{font-size:16px;color:#333;margin-bottom:8px;font-weight:500}.upload-hint{font-size:12px;color:#666}.url-input-zone{padding:20px;text-align:center}.url-input-title{font-size:16px;color:#333;margin-bottom:15px;font-weight:500}.url-input{width:100%;padding:12px 16px;border:2px solid #e9ecef;border-radius:8px;font-size:14px;transition:all 0.2s ease;box-sizing:border-box}.url-input:focus{outline:none;border-color:#199AFF;box-shadow:0 0 0 3px rgba(25,154,255,0.1)}.url-input-hint{font-size:12px;color:#666;margin-top:8px}.url-preview-container{margin-top:20px;padding:15px;border:1px solid #e9ecef;border-radius:8px;background-color:#f8f9fa}.url-preview-title{font-size:14px;color:#333;margin-bottom:10px;font-weight:500}.url-preview-image{max-width:120px;max-height:120px;border-radius:8px;object-fit:cover;border:2px solid #e9ecef}.avatar-selector-actions{padding:15px 20px;background-color:#f8f9fa;display:flex;gap:10px;border-top:1px solid #e9ecef}.avatar-action-btn{flex:1;padding:10px 16px;border:none;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;transition:all 0.2s ease}.avatar-cancel-btn{background-color:#f8f9fa;color:#666;border:1px solid #e9ecef}.avatar-cancel-btn:hover{background-color:#e9ecef}.avatar-confirm-btn{background:linear-gradient(135deg,#199AFF,#0066CC);color:white}.avatar-confirm-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(25,154,255,0.3)}.avatar-confirm-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none;box-shadow:none}.add-button{cursor:pointer;transition:all 0.2s ease;border-radius:50%;padding:4px}.add-button:hover{background-color:rgba(25,154,255,0.1);transform:scale(1.1)}.group-manage-btn{position:absolute;top:15px;right:70px;background:linear-gradient(135deg,#199AFF,#0066CC);color:white;border:none;border-radius:6px;padding:6px 12px;font-size:12px;cursor:pointer;transition:all 0.2s ease;z-index:100}.group-manage-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(25,154,255,0.3)}.contact-group{margin-bottom:8px;border-radius:8px;overflow:hidden;background-color:#f8f9fa;border:1px solid #e9ecef;transition:all 0.3s ease}.contact-group.dragging{opacity:0.7;transform:scale(0.98);box-shadow:0 8px 25px rgba(0,0,0,0.15)}.ungrouped-contacts{margin-top:15px;padding:10px;border:1px dashed #ddd;border-radius:8px;background-color:#fafafa;position:relative}.ungrouped-header{font-size:12px;color:#666;margin-bottom:10px;font-weight:500}.ungrouped-drop-zone{position:absolute;top:30px;left:0;right:0;bottom:0;border-radius:6px;z-index:1}.QQ_home_usermsg.dragging{opacity:0.5;transform:rotate(5deg)}.drop-zone.active{border:2px dashed #199AFF;background-color:rgba(25,154,255,0.1);animation:pulse 2s infinite}@keyframes pulse{0%{opacity:0.1}50%{opacity:0.3}100%{opacity:0.1}}.group-member-count{position:absolute;right:15px;top:50%;transform:translateY(-50%);font-size:12px;color:#999;background-color:#f0f0f0;padding:2px 6px;border-radius:10px;min-width:20px;text-align:center}.group-header{display:flex;align-items:center;padding:12px 15px;background:linear-gradient(135deg,#f8f9fa,#e9ecef);cursor:pointer;border-bottom:1px solid #dee2e6;position:relative}.group-header:hover{background:linear-gradient(135deg,#e9ecef,#dee2e6)}.group-drag-handle{margin-right:8px;color:#999;cursor:grab;font-size:14px;transition:color 0.2s}.group-drag-handle:hover{color:#666}.group-drag-handle:active{cursor:grabbing}.group-toggle{margin-right:8px;color:#666;font-size:12px;transition:transform 0.3s ease;cursor:pointer}.group-toggle.collapsed{transform:rotate(-90deg)}.group-name{flex:1;font-size:14px;font-weight:500;color:#333;cursor:pointer;padding:2px 4px;border-radius:4px;transition:background-color 0.2s}.group-name:hover{background-color:rgba(25,154,255,0.1)}.group-name.editing{background-color:white;border:2px solid #199AFF;outline:none}.group-count{background-color:#199AFF;color:white;border-radius:10px;padding:2px 6px;font-size:11px;font-weight:500;margin-left:8px}.group-delete-btn{margin-left:8px;color:#dc3545;cursor:pointer;padding:2px 4px;border-radius:4px;font-size:12px;opacity:0;transition:all 0.2s}.group-header:hover .group-delete-btn{opacity:1}.group-delete-btn:hover{background-color:#dc3545;color:white}.group-content{padding:0;background-color:white;transition:all 0.3s ease;overflow:hidden}.group-content.collapsed{max-height:0;padding:0;border-top:none}.group-content.expanded{max-height:1000px}.group-content .QQ_home_usermsg{margin:0;padding:12px 20px;border-bottom:1px solid #f0f0f0;position:relative;transition:all 0.2s ease}.group-content .QQ_home_usermsg:last-child{border-bottom:none}.group-content .QQ_home_usermsg:hover{background-color:#f8f9fa;transform:translateX(4px)}.group-content .QQ_home_usermsg.dragging{opacity:0.5;transform:scale(0.95)}.ungrouped-contacts{margin-top:10px}.ungrouped-header{padding:10px 15px;font-size:12px;color:#999;background-color:#f8f9fa;border-top:1px solid #e9ecef;border-bottom:1px solid #e9ecef}.drop-zone{min-height:40px;border:2px dashed #ddd;border-radius:8px;margin:5px 0;display:flex;align-items:center;justify-content:center;color:#999;font-size:12px;transition:all 0.2s;opacity:0;transform:scaleY(0)}.drop-zone.active{opacity:1;transform:scaleY(1);border-color:#199AFF;background-color:rgba(25,154,255,0.1);color:#199AFF}.new-group-modal{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:10000;backdrop-filter:blur(4px)}.new-group-dialog{background-color:white;border-radius:12px;padding:24px;width:280px;box-shadow:0 10px 30px rgba(0,0,0,0.3);animation:modalSlideIn 0.3s ease-out}.new-group-title{font-size:16px;font-weight:bold;margin-bottom:16px;color:#333}.new-group-input{width:100%;padding:10px 12px;border:2px solid #e9ecef;border-radius:8px;font-size:14px;outline:none;transition:border-color 0.2s;box-sizing:border-box;margin-bottom:16px}.new-group-input:focus{border-color:#199AFF}.new-group-actions{display:flex;gap:10px}.new-group-btn{flex:1;padding:10px 16px;border:none;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;transition:all 0.2s ease}.new-group-cancel{background-color:#f8f9fa;color:#666;border:1px solid #e9ecef}.new-group-cancel:hover{background-color:#e9ecef}.new-group-confirm{background:linear-gradient(135deg,#199AFF,#0066CC);color:white}.new-group-confirm:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(25,154,255,0.3)}.group-member-dropdown{position:absolute;top:100%;left:0;width:250px;max-height:300px;background:white;border:1px solid #ddd;border-radius:8px;box-shadow:0 4px 15px rgba(0,0,0,0.15);z-index:1000;overflow-y:auto;padding:8px 0;margin-top:4px}.group-member-dropdown .member-item{display:flex;align-items:center;padding:8px 12px;cursor:pointer;transition:background-color 0.2s}.group-member-dropdown .member-item:hover{background-color:#f5f5f5}.group-member-dropdown .member-avatar{width:32px;height:32px;border-radius:50%;margin-right:10px;object-fit:cover;border:1px solid #eee}.group-member-dropdown .member-name{font-size:14px;color:#333;font-weight:500}.group-member-dropdown .dropdown-header{padding:8px 12px;font-size:12px;color:#666;font-weight:bold;border-bottom:1px solid #eee;margin-bottom:4px}.chat-title.clickable{cursor:pointer;user-select:none;position:relative}.chat-title.clickable:hover{text-decoration:underline}.system-message{text-align:center;font-size:12px;color:#999;padding:8px 0;width:100%;box-sizing:border-box}</style>
</head>
<body>
<div class="card">
<div class="btn1"></div>
<div class="btn2"></div>
<div class="btn3"></div>
<div class="btn4"></div>
<div class="dinbu">
<span id="time">18:58</span>
<div
style=" display: flex;
align-items: center;
justify-self: end;
gap: 2px;
">
<svg viewBox="0 0 1024 1024" width="16" height="15">
<path
d="M926.634667 294.912a32 32 0 1 1-39.936 50.005333C780.512 260.128 649.824 213.333333 512.053333 213.333333c-137.813333 0-268.544 46.826667-374.752 131.669334a32 32 0 1 1-39.936-50.005334C214.784 201.194667 359.562667 149.333333 512.053333 149.333333c152.437333 0 297.173333 51.818667 414.581334 145.578667z m-235.413334 298.133333a32 32 0 0 1-38.442666 51.178667A233.418667 233.418667 0 0 0 512.021333 597.333333c-51.541333 0-100.48 16.629333-140.8 46.912a32 32 0 1 1-38.442666-51.157333A297.408 297.408 0 0 1 512.021333 533.333333c65.504 0 127.893333 21.184 179.2 59.722667z m128-149.344a32 32 0 0 1-38.442666 51.168C703.829333 437.066667 610.378667 405.333333 512.032 405.333333c-98.368 0-191.850667 31.754667-268.8 89.578667a32 32 0 1 1-38.453333-51.157333C292.736 377.664 399.669333 341.333333 512.032 341.333333c112.32 0 219.242667 36.309333 307.189333 102.368zM512 853.333333a64 64 0 1 1 0-128 64 64 0 0 1 0 128z" fill="currentColor"></path>
</svg>
<span>78%</span>
<svg
viewBox="0 0 1024 1024" width="20" height="20" style="justify-self: end; margin-right: 13px">
<path
d="M984.2 434.8c-5-2.9-8.2-8.2-8.2-13.9v-99.3c0-53.6-43.9-97.5-97.5-97.5h-781C43.9 224 0 267.9 0 321.5v380.9C0 756.1 43.9 800 97.5 800h780.9c53.6 0 97.5-43.9 97.5-97.5v-99.3c0-5.8 3.2-11 8.2-13.9 23.8-13.9 39.8-39.7 39.8-69.2v-16c0.1-29.6-15.9-55.5-39.7-69.3zM912 702.5c0 12-6.2 19.9-9.9 23.6-3.7 3.7-11.7 9.9-23.6 9.9h-781c-11.9 0-19.9-6.2-23.6-9.9-3.7-3.7-9.9-11.7-9.9-23.6v-381c0-11.9 6.2-19.9 9.9-23.6 3.7-3.7 11.7-9.9 23.6-9.9h780.9c11.9 0 19.9 6.2 23.6 9.9 3.7 3.7 9.9 11.7 9.9 23.6v381z" p-id="4287" fill="currentColor"></path>
<path
d="M736 344v336c0 8.8-7.2 16-16 16H112c-8.8 0-16-7.2-16-16V344c0-8.8 7.2-16 16-16h608c8.8 0 16 7.2 16 16z" p-id="4288" fill="currentColor"></path>
</svg>
</div>
</div>
<div class="card-int">
<div
class="page_button" style="background-color: none; display: none" id="page_button">
<div
style=" width: 45px;
display: flex;
justify-content: center;
height: 20px;
" onclick="gotopage(1)">
<svg viewBox="0 0 1024 1024" width="20" height="20">
<path
d="M810.666667 213.333333a42.666667 42.666667 0 0 1 42.368 37.674667L853.333333 256v274.304c0 79.274667-50.944 147.498667-120.490666 152.106667L725.333333 682.666667H273.706667l97.792 97.834666a42.666667 42.666667 0 0 1-56.32 63.872l-4.010667-3.541333-170.666667-170.666667a42.666667 42.666667 0 0 1 0-60.330666l170.666667-170.666667a42.666667 42.666667 0 0 1 63.872 56.32l-3.541333 4.010667L273.706667 597.333333H725.333333c19.584 0 39.936-24.618667 42.410667-59.861333l0.256-7.168V256a42.666667 42.666667 0 0 1 42.666667-42.666667z" fill="#000000" p-id="13502"></path>
</svg>
</div>
<div
style=" width: 45px;
display: flex;
justify-content: center;
" onclick="gotopage(0)">
<svg
t="1736242335450" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http:
p-id="8709" width="20" height="20">
<path
d="M762.3 565.3c0-19 15.7-34.1 34.7-34.1 19 0 34.2 15.1 34.2 34.1v336.3c0 19-15.2 34.4-34.2 34.4H229.6c-19.1 0-34.7-15.4-34.7-34.4V565.3c0-19 15.7-34.1 34.7-34.1 18.6 0 34.2 15.1 34.2 34.1v301.9h498.5V565.3z m-638.2 9.3l388.8-387.8 389.3 387.8c13.2 13.2 35.2 13.2 48.4 0 13.4-13.2 13.4-35.1 0-48.3L538 114.1l-0.7-0.5c-13.4-13.2-35.2-13.2-48.6 0l-413 412.6c-13.6 13.2-13.6 35.1 0 48.3 13.2 13.2 35.2 13.2 48.4 0.1z" fill="#231815" p-id="8710"></path>
</svg>
</div>
<div
style=" width: 45px;
display: flex;
justify-content: center;
" onclick="gotopage(-1)">
<svg
t="1736242697753" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http:
p-id="9742" width="20" height="20">
<path
d="M622.650611 284.901749 447.745069 284.901749 447.745069 142.823869 63.980685 334.705038l383.76336 191.882192L447.744046 384.834762l189.391465 0c149.914358 0 224.855164 62.789045 224.855164 188.368158 0 129.928165-77.435627 194.876386-232.338602 194.876386L187.952184 768.079306l0 99.93199L634.146433 868.011296c211.184817 0 316.777737-95.104031 316.777737-285.311071C950.924169 384.178823 841.510224 284.901749 622.650611 284.901749z" fill="#272636" p-id="9743"></path>
</svg>
</div>
</div>
<div id="Home_page" style="display: none">
<div class="dibu">
<svg
viewBox="0 0 1024 1024" style="width: 4.1rem; height: 4.1rem">
<path
d="M510.798639 124.660184c-213.447347 0-386.480238 173.029822-386.480238 386.480238 0 213.446323 173.029822 386.475122 386.480238 386.475122 213.446323 0 386.475122-173.029822 386.475122-386.475122C897.274784 297.690006 724.244962 124.660184 510.798639 124.660184L510.798639 124.660184 510.798639 124.660184zM510.798639 864.019379c-194.883549 0-352.884073-158.001547-352.884073-352.879979 0-194.883549 158.000524-352.884073 352.884073-352.884073 194.878432 0 352.883049 158.000524 352.883049 352.884073C863.678618 706.017832 705.677071 864.019379 510.798639 864.019379L510.798639 864.019379 510.798639 864.019379zM588.978209 546.374902c-17.681708 0-31.070646 15.915481-47.113017 15.915481-15.910365 0-85.756129-68.836785-85.756129-85.761246 0-16.920368 15.914458-25.258267 15.914458-42.813085 0-12.632715-47.107901-89.925079-66.432015-89.925079-19.328207 0-66.436108 34.479279-66.436108 66.433038 0 92.455715 170.506349 269.653463 277.230022 269.653463 29.427216 0 66.437132-31.070646 66.437132-66.437132C683.071214 600.178295 606.532003 546.374902 588.978209 546.374902" fill="#09B245" p-id="6003"></path>
</svg>
<svg
viewBox="0 0 1066 1024" style="width: 3.3rem; height: 3.3rem">
<path
d="M548.48 0c282.752 0 512 229.248 512 512s-229.248 512-512 512c-282.794667 0-512-229.248-512-512s229.205333-512 512-512z m0 42.666667c-259.242667 0-469.333333 210.133333-469.333333 469.333333s210.090667 469.333333 469.333333 469.333333c259.2 0 469.333333-210.133333 469.333333-469.333333s-210.133333-469.333333-469.333333-469.333333z m0 173.952c168.234667 0 304.597333 118.186667 304.597333 263.936 0 145.792-136.362667 263.978667-304.64 263.978666a348.757333 348.757333 0 0 1-73.130666-7.68c-36.010667 22.357333-109.866667 70.528-109.866667 70.528s-0.341333-76.672 0-115.797333c-73.813333-48.128-121.6-124.757333-121.6-211.029333 0-145.749333 136.362667-263.936 304.64-263.936z m-129.706667 223.658666a40.448 40.448 0 0 0-40.533333 40.32 40.448 40.448 0 0 0 40.533333 40.32c22.4 0 40.533333-18.005333 40.533334-40.32a40.448 40.448 0 0 0-40.533334-40.32z m135.850667 0a40.448 40.448 0 0 0-40.576 40.32 40.448 40.448 0 0 0 40.533333 40.32 40.448 40.448 0 0 0 40.618667-40.32 40.490667 40.490667 0 0 0-40.576-40.32z m135.850667 0a40.490667 40.490667 0 0 0-40.576 40.32 40.448 40.448 0 0 0 40.576 40.32 40.448 40.448 0 0 0 40.533333-40.32 40.448 40.448 0 0 0-40.533333-40.32z" fill="#2397FF" p-id="9807"></path>
</svg>
<svg
viewBox="0 0 1024 1024" style="width: 4rem; height: 4rem">
<path
d="M441.05 164.53c49.52-9.62 101.09-8.57 150.18 3.06 43.01 10.18 84.04 28.57 120.29 53.84 65.19 45.14 114.56 112.69 137.32 188.68 20.42 67.17 20.07 140.33-0.41 207.44l-0.13 0.46c-23.01-53.51-74.79-93.34-132.27-102.5l-0.01-0.11c0.47-40.52-11.14-81.12-33.35-115.06-22.75-35.1-56.37-63.06-95.1-78.89-39.94-16.49-85.1-19.84-127.09-9.72-39.19 9.32-75.35 30.59-102.8 60.04-28.81 30.73-47.9 70.45-53.65 112.2-6.29 44.14 2.08 90.27 23.8 129.23 19.43 35.16 49.34 64.4 84.89 83.08 30.24 16.01 64.53 24.1 98.72 23.74h0.11c7.41 46.72 35.01 89.65 73.93 116.41 9 6.11 18.38 11.95 28.55 15.85l-0.56 0.16c-69.43 21.22-145.37 20.78-214.4-1.82-75.89-24.48-142.72-75.63-186.49-142.25-23.43-35.39-40.37-75.04-49.76-116.43-11.55-50.94-11.75-104.42-0.53-155.44 14.59-67.14 49.51-129.62 98.75-177.51 49.09-48.12 112.46-81.52 180.01-94.46z" fill="#5C5CEF" p-id="22508"></path>
<path
d="M596.41 537.54c35.61-21.21 78.78-28.95 119.61-22.14l0.01 0.11c-0.55 37.38-11.1 74.74-31.06 106.43-16.48 26.73-39.2 49.58-65.79 66.26-31.95 20.42-69.77 31.29-107.63 31.82h-0.11c-5.28-31.73-1.94-64.9 9.96-94.81 14.36-36.47 41.23-67.8 75.01-87.67zM848.3 618.01l0.13-0.46c12.06 27.01 17.34 56.99 15.05 86.49-3.04 42.37-22.11 83.28-52.48 112.96-17.34 17.04-38.17 30.6-60.92 39.23-43.64 17.04-93.93 15.35-136.61-3.79l0.56-0.16c37.37-11.79 72.97-29.37 104.52-52.68 11.87-9.03 23.82-18.11 34.23-28.85 2.98-3 6.62-5.3 9.3-8.61 4.52-5.81 10.34-10.43 14.84-16.26 32.42-37 56.69-80.95 71.38-127.87z" fill="#19FFDC" p-id="22509"></path>
<path
d="M716.03 515.51c57.48 9.16 109.26 48.99 132.27 102.5-14.69 46.92-38.96 90.87-71.38 127.87-4.5 5.83-10.32 10.45-14.84 16.26-2.68 3.31-6.32 5.61-9.3 8.61-10.41 10.74-22.36 19.82-34.23 28.85-31.55 23.31-67.15 40.89-104.52 52.68-10.17-3.9-19.55-9.74-28.55-15.85-38.92-26.76-66.52-69.69-73.93-116.41 37.86-0.53 75.68-11.4 107.63-31.82 26.59-16.68 49.31-39.53 65.79-66.26 19.96-31.69 30.51-69.05 31.06-106.43z" fill="#09EFDA" p-id="22510"></path>
</svg>
<svg
viewBox="0 0 1024 1024" style="width: 3.7rem; height: 3.7rem">
<path
d="M517.116019 967.737602c-120.532167 0-233.850026-46.937009-319.079152-132.165112C112.80774 750.341317 65.870732 637.025505 65.870732 516.492314c0-120.532167 46.938032-233.850026 132.166135-319.079152C283.26497 112.184035 396.583852 65.246003 517.116019 65.246003c120.53319 0 233.850026 46.938032 319.079152 132.166135s132.166135 198.546985 132.166135 319.079152c0 120.53319-46.937009 233.849002-132.166135 319.079152C750.966045 920.79957 637.64921 967.737602 517.116019 967.737602zM517.116019 108.790752c-108.901269 0-211.284077 42.407855-288.287869 119.41267S109.41548 407.591045 109.41548 516.492314s42.407855 211.283054 119.41267 288.286846c77.003791 77.005838 179.3866 119.413694 288.287869 119.413694s211.284077-42.407855 288.287869-119.413694c77.005838-77.003791 119.41267-179.385577 119.41267-288.286846s-42.406832-211.284077-119.41267-288.288892C728.400097 151.198607 626.017288 108.790752 517.116019 108.790752z" fill="#2c2c2c" p-id="39954"></path>
<path
d="M693.052031 355.056552l-58.175981 0c0-32.129768-26.049283-58.177004-58.179051-58.177004L460.345038 296.879548c-32.127721 0-58.177004 26.047236-58.177004 58.177004l-58.179051 0c-32.127721 0-58.175981 26.046213-58.175981 58.173934l0 232.69983c0 32.127721 26.048259 58.172911 58.175981 58.172911l349.063047 0c32.129768 0 58.178027-26.045189 58.178027-58.172911l0-232.69983c0-32.127721-26.047236-58.177004-58.178027-58.177004L693.052031 355.056552zM519.453251 614.775758c-49.109488 0-88.929402-39.814798-88.929402-88.922239 0-49.110511 39.819914-88.927355 88.929402-88.927355 49.111534 0 88.930425 39.816844 88.930425 88.927355C608.383676 574.959937 568.564785 614.775758 519.453251 614.775758L519.453251 614.775758zM519.453251 614.775758" fill="#2c2c2c" p-id="39955"></path>
</svg>
</div>
<div class="zhong">
<div
style=" display: flex;
align-items: center;
gap: 10px;
">
<svg
viewBox="0 0 1024 1024" style="width: 3rem; height: 3rem">
<path
d="M509.014999 512.046737m-262.543634 0a262.543634 262.543634 0 1 0 525.087268 0 262.543634 262.543634 0 1 0-525.087268 0Z" fill="#FFD54F" p-id="51646"></path>
<path
d="M510.601314 0.11053c0 1.705715 67.222223 48.391131 67.222223 91.886861a62.224479 62.224479 0 0 1-67.222223 65.618851 62.224479 62.224479 0 0 1-67.222224-65.635908c0-43.495729 67.222223-93.575518 67.222224-91.869804z" fill="#FFD54F" p-id="51647"></path>
<path
d="M869.21081 155.364698c-1.228115 1.194 11.940004 81.9596-19.342807 112.184868a62.224479 62.224479 0 0 1-93.933718-2.695029 62.224479 62.224479 0 0 1 0.460543-93.950776c31.282811-30.225268 114.044097-16.716006 112.815982-15.539063z" fill="#FFD54F" p-id="51648"></path>
<path
d="M1022.571634 513.411308c-1.705715-0.034114-49.53396 66.40348-93.029689 65.670023a62.241536 62.241536 0 0 1-64.527194-68.347995 62.241536 62.241536 0 0 1 66.778738-66.113509c43.495729 0.750515 92.483861 68.825595 90.778145 68.791481z" fill="#FFD54F" p-id="51649"></path>
<path
d="M869.176695 868.660546c-1.228115-1.176943-81.499057 14.754434-112.781867-15.453777a62.224479 62.224479 0 0 1-0.545829-93.984889 62.224479 62.224479 0 0 1 93.899604-2.763259c31.299868 30.225268 20.656207 113.395925 19.44515 112.218982z" fill="#FFD54F" p-id="51650"></path>
<path
d="M510.601314 1023.948829c0-1.705715 67.222223-48.391131 67.222223-91.886861a62.224479 62.224479 0 0 0-67.222223-65.584737 62.224479 62.224479 0 0 0-67.222224 65.584737c0 43.495729 67.222223 93.558461 67.222224 91.886861z" fill="#FFD54F" p-id="51651"></path>
<path
d="M154.891533 155.330584c1.228115 1.194-11.940004 81.976657 19.342807 112.201925a62.224479 62.224479 0 0 0 93.916661-2.729144 62.224479 62.224479 0 0 0-0.4776-93.933718c-31.299868-30.259382-113.975868-16.698949-112.781868-15.522006z" fill="#FFD54F" p-id="51652"></path>
<path
d="M1.445423 513.34308c1.705715-0.034114 49.53396 66.40348 93.029689 65.670023a62.241536 62.241536 0 0 0 64.49308-68.347995 62.241536 62.241536 0 0 0-66.778738-66.113509c-43.529844 0.750515-92.415632 68.825595-90.744031 68.791481z" fill="#FFD54F" p-id="51653"></path>
<path
d="M154.942705 868.660546c1.228115-1.176943 81.516114 14.720319 112.781867-15.522005a62.224479 62.224479 0 0 0 0.477601-93.933719 62.224479 62.224479 0 0 0-93.916662-2.729143c-31.299868 30.259382-20.536807 113.361811-19.342806 112.201924z" fill="#FFD54F" p-id="51654"></path>
</svg>
<span>22°</span>
</div>
<div
style=" display: flex;
flex-direction: column;
justify-self: end;
align-items: end;
font-size: inherit;
gap: 7px;
">
<span>日本市</span> <span id="day">1月4日</span>
</div>
</div>
<div class="app">
<div
style=" display: flex;
flex-direction: column;
align-items: center;
" class="app-svg-div">
<svg viewBox="0 0 1024 1024" width="64" height="64">
<path
d="M763.776 968.576H261.504C147.456 968.576 55.04 876.16 55.04 762.112V259.84c0-114.048 92.416-206.464 206.464-206.464h502.272C877.824 53.376 970.24 145.792 970.24 259.84v502.272c0 114.048-92.416 206.464-206.464 206.464z" fill="#009CF5" p-id="52731"></path>
<path
d="M529.792 586.496h-100.48l75.648-130.56 7.68-13.312 51.84-89.088 9.984-17.408 21.504-36.864c9.472-16.128 9.728-36.864-1.024-52.096-9.216-13.056-22.4-18.304-35.456-18.304-15.36 0-30.336 7.936-38.784 22.272l-7.68 13.568-7.936-13.568c-8.448-14.336-23.552-22.272-38.784-22.272-7.68 0-15.36 1.792-22.528 5.888-21.248 12.288-28.544 39.808-16.128 61.056l33.408 57.728-135.168 233.216H238.08c-26.88 0.256-48.384 24.064-44.16 52.096 3.328 22.016 23.936 37.376 46.208 37.376h33.92l103.424-0.256H583.936c3.84 0 7.68-1.664 9.984-4.736 11.776-15.744 20.48-40.192-8.32-65.408-15.232-13.44-35.584-19.328-55.808-19.328z" fill="#FFFFFF" p-id="52732"></path>
<path
d="M785.28 586.24h-86.016l-115.072-198.528c-2.048-3.456-6.656-4.608-9.856-2.304-16.128 11.648-25.6 27.904-30.464 45.824-8.192 30.208-1.408 62.592 14.208 89.728l24.704 42.88 13.056 22.784 51.84 89.344 5.376 8.96 49.792 86.016c8.448 14.336 23.296 22.272 38.528 22.272 7.68 0 15.616-2.048 22.784-6.144 21.248-12.288 28.544-39.552 16.128-61.056l-29.056-50.304h36.224c26.88 0 48.256-24.32 43.904-52.352-3.584-21.888-23.936-37.12-46.08-37.12zM319.616 687.616c-15.744-6.4-30.592-5.632-42.496-2.304-6.528 1.792-11.904 6.272-15.232 12.032l-16.64 28.416c-12.544 21.504-5.12 48.768 16.128 61.056 7.168 4.096 15.104 6.144 22.784 6.144 15.36 0 30.08-7.936 38.272-22.272l18.944-32.64c4.608-8.064 5.504-17.792 2.048-26.368-3.84-9.6-11.008-18.816-23.808-24.064z" fill="#FFFFFF" p-id="52733"></path>
</svg>
<span>Store</span>
</div>
<div
style=" display: flex;
flex-direction: column;
align-items: center;
" class="app-svg-div" data-app="twitter">
<svg viewBox="0 0 1024 1024" width="64" height="64">
<path
d="M849.92 51.2H174.08c-67.8656 0-122.88 55.0144-122.88 122.88v675.84c0 67.8656 55.0144 122.88 122.88 122.88h675.84c67.8656 0 122.88-55.0144 122.88-122.88V174.08c0-67.8656-55.0144-122.88-122.88-122.88z m-93.65504 336.5888a317.0816 317.0816 0 0 1 0.4352 16.11776c0 165.16096-126.8224 355.53792-358.656 355.53792-71.14752 0-137.4208-20.72064-193.24416-56.05888a248.6272 248.6272 0 0 0 30.04928 1.7664 254.80704 254.80704 0 0 0 156.56448-53.45792c-55.13728-1.08544-101.67808-37.28384-117.71392-86.79424 7.67488 1.37216 15.616 2.29888 23.74656 2.29888a124.6208 124.6208 0 0 0 33.13152-4.50048c-57.61024-11.47904-101.08416-61.94176-101.08416-122.54208v-1.46432c17.02912 9.216 36.48512 14.96064 57.15456 15.59552-33.85856-22.49728-56.064-60.66688-56.064-104.03328 0-22.81472 6.14912-44.43648 17.06496-62.90432a359.2192 359.2192 0 0 0 259.80416 130.62144 125.37344 125.37344 0 0 1-3.29216-28.50816c0-68.97664 56.42752-124.91264 126.05952-124.91264 36.24448 0 68.96128 15.0784 91.88864 39.40352 28.73344-5.5296 55.7312-16.0256 80.09728-30.30528-9.40032 29.12768-29.42464 53.7856-55.48032 69.24288 25.62048-3.1488 49.8944-9.82016 72.47872-19.82464a247.84384 247.84384 0 0 1-62.94016 64.72192z" fill="#03A9F4" p-id="54801"></path>
</svg>
<span>推特</span>
</div>
<div
style=" display: flex;
flex-direction: column;
align-items: center;
position: relative;
" data-app="QQ" class="app-svg-div">
<svg viewBox="0 0 1024 1024" width="64" height="64">
<path
d="M887.85832 64.549132 136.14168 64.549132c-39.540552 0-71.591525 32.051997-71.591525 71.590502l0 751.718687c0 39.538505 32.051997 71.591525 71.591525 71.591525l751.71664 0c39.538505 0 71.592548-32.05302 71.592548-71.591525L959.450868 136.139633C959.449845 96.601128 927.396825 64.549132 887.85832 64.549132zM862.687034 644.674719l0 5.110391 0 4.786003-0.860601 5.754051-1.236154 9.869788-1.720178 8.9263-2.636037 8.067746-0.967024 3.307326-1.828648 3.925403-1.560542 2.77009-2.043542 3.413749-1.829671 2.125407-2.311649 2.769067-2.043542 2.204202-2.204202 1.936095-2.636037 1.157359-2.367931 1.155313-1.934049 0.644683-1.694595 0-1.264806 0-1.908466-0.644683-3.631714-1.775436-1.664919-1.182942-1.722224-1.290389-1.910513-1.694595-1.908466-1.908466-3.173273-3.496637-3.765767-5.000897-2.957355-5.109368-2.957355-4.14132-2.877537-4.787026-4.060479-8.496511-4.570085-8.846482-0.537236-0.297782-0.754177 0-1.88186 1.37123-1.075495 2.339278-1.774413 2.851954-3.120061 8.631588-4.679579 12.235672-6.02318 14.653745-4.516874 7.341199-4.76042 7.635911-5.621021 8.606005-5.969968 8.443299-3.064802 3.818979-3.710508 4.142343-8.525164 8.389064 0.754177 0.75213 1.154289 1.182942 4.249791 2.52859 17.748223 8.497535 7.745405 4.356214 7.366781 4.247744 7.313569 5.324262 6.508227 5.539156 3.174296 2.446725 2.366907 2.877537 2.418073 3.279696 2.044566 3.63069 1.077541 2.984984 1.342578 3.603061 0.539282 3.065825 0.64366 3.629667-0.64366 2.447748 0 2.419096-0.539282 2.581802-1.342578 2.312672-0.539282 1.827625-1.182942 2.205225-3.226484 4.383844-2.956332 3.523243-2.312672 2.63399-1.936095 1.936095-4.89345 3.603061-5.54018 3.092431-5.915733 2.984984-6.293333 2.849908-7.098675 2.743484-3.764744 1.181919-3.38919 0.969071-8.175193 1.908466-8.498558 1.801019-8.496511 1.829671-9.250688 1.479701-9.573029 0.402159-9.78997 1.182942-9.680477 0-10.218736 0-10.487865 0-10.970866-0.644683-10.219759-0.940418-10.970866-1.479701-10.917654-1.183965-11.509125-1.612731-11.134595-2.743484L592.539314 853.880461l-10.81123-3.065825-11.078313-3.926426-10.862395-3.307326-5.702885-1.909489-5.109368-1.828648-3.225461-1.237177-3.174296-0.644683-4.142343 0-4.89345 0-10.431583-0.75213-5.298679-0.538259-6.80294-0.751107-4.357238 3.924379-5.969968 3.738138-8.066723 3.952009-8.928347 4.894474-5.431709 2.63399-5.647627 2.125407-12.531408 5.109368-6.80294 1.693572-7.125281 1.936095-9.895371 1.882883-6.185886 0.537236-6.562463 0.537236-6.830569 0.754177-7.959276 0.322341-7.637957 0-7.959276 0-16.914228 0-18.3663-0.322341-17.801435-1.828648-9.035794-1.238201-8.712429-1.290389-8.497535-1.291412-8.497535-1.693572-7.879458-2.555196-7.878434-1.801019-7.099698-2.877537-6.722098-2.63399-6.239098-3.012613-5.431709-3.28072-5.432733-3.926426-1.828648-1.935072-2.420119-2.312672-1.829671-2.042519-1.666966-2.312672-1.50733-2.365884-1.182942-2.312672-1.694595-5.001921-0.618077-2.555196-0.754177-2.876514 0-2.636037 0.754177-2.983961 0-2.986007 0.618077-2.983961 0-1.802042 0-4.140297 0.295735-3.201925 1.39886-3.629667 1.182942-3.603061 2.153036-4.355191 1.558495-1.694595 1.291412-1.908466 3.387144-4.14132 2.689249-2.152013 2.52859-1.478677 2.341325-1.908466 3.736091-1.183965 2.958378-1.77646 3.710508-1.935072 4.248767-1.264806 4.247744-1.290389 4.894474-1.048889 4.678556-0.645706 5.541203-0.751107 5.968945-0.431835 1.586125-0.536212 0.322341 0 0.754177-0.644683 0-0.699941-1.076518-1.506307-3.199878-1.505283-7.958252-6.883781-5.324262-4.248767-6.185886-5.431709-6.239098-6.05081-6.508227-7.770987-7.421017-8.712429-2.796696-4.679579-3.711532-4.894474-3.173273-5.64558-2.850931-6.157233-3.873214-5.834892-2.52859-6.724145-2.984984-6.66684-2.984984-7.476275-2.205225-7.098675-2.043542-8.819876-0.644683-0.323365-0.6191 0-0.322341-0.645706-0.754177 0-1.263783 0.645706-0.645706 0.323365-0.858554 1.478677-0.323365 1.802042-0.644683 1.613754-1.12973 2.63399-3.657296 6.507204-1.882883 3.926426-2.984984 3.388167-3.199878 4.140297-3.496637 4.571109-3.710508 4.061502-4.357238 3.925403-4.059456 3.710508-4.437056 2.877537-4.894474 3.091408-4.678556 1.802042-5.539156 1.39886-5.431709 0.509606-0.537236 0-0.753153 0-1.237177-0.509606-0.969071-2.152013-1.612731-1.048889-2.097778-5.108345-1.290389-2.77009-1.39886-3.925403-1.156336-4.14132-0.6191-4.033873-1.721201-9.249665-0.644683-5.433756 0-5.538133 0-12.31549 0.644683-13.283538 1.076518-6.831592 1.263783-6.990205 1.156336-7.556093 2.043542-7.018857 2.312672-8.094352 2.366907-7.852852 3.174296-8.093329 2.984984-7.745405 4.113691-7.877411 3.873214-8.497535 4.678556-7.985882 5.51255-8.606005 5.621021-7.745405 5.862521-8.603959 4.894474-5.968945 6.265704-6.91141 6.589069-6.910387 3.065825-3.279696 3.736091-3.738138 5.406127-4.705162 5.54018-4.759397 9.03477-8.094352 6.830569-4.975315 2.420119-1.802042-1.344624-4.140297-1.075495-5.431709-0.753153-2.984984 0-3.738138 0-4.463662 0-4.03285 1.290389-4.787026 1.345648-5.109368 1.720178-5.297656 2.341325-5.942339 3.091408-6.184863 4.356214-6.184863 0-4.330632 0.429789-4.060479 0.645706-5.51255 1.88186-6.15621 1.721201-6.696516 1.37123-3.093455 1.586125-2.848884 2.043542-3.200902 2.205225-2.339278 0-4.356214 0-4.894474 0-6.076392 1.290389-7.852852 1.290389-9.143241 2.312672-10.970866 3.173273-11.348466 2.366907-6.290263 2.339278-6.803963 2.555196-6.372128 3.065825-6.80294 3.119037-7.448646 3.604084-6.990205 4.03285-7.476275 5.109368-7.42204 2.340301-4.247744 2.52859-3.523243 5.458315-7.878434 5.592368-7.851828 6.399757-8.067746 6.830569-7.906064 7.42204-7.743358 7.744381-7.959276 9.358135-8.604982 5.969968-5.216815 7.232728-5.646604 7.342222-5.001921 7.959276-4.786003 7.637957-4.248767 8.604982-3.495614 9.143241-4.356214 9.087982-2.984984 9.090029-3.092431 9.787924-3.065825 9.788947-2.339278 10.326183-1.909489 10.432607-1.721201 10.272971-1.370207 10.32516-1.39886 10.972912-0.6191 10.431583 0 10.812253 0 11.18576 0 10.812253 1.37123 10.862395 1.291412 11.078313 1.155313 10.273994 2.474354 10.863419 2.311649 10.19213 2.636037 11.160177 3.01159 10.219759 3.602038 9.7869 4.14132 10.434653 4.356214 9.5454 4.786003 9.250688 5.324262 9.0624 5.862521 7.851828 5.405103 3.604084 3.092431 3.820002 2.204202 7.259334 6.185886 6.132674 5.968945 6.076392 6.157233 5.969968 6.801916 4.894474 6.589069 5.808286 6.80294 4.088108 7.313569 4.113691 6.508227 4.383844 7.554046 3.603061 6.589069 6.131651 13.929244 3.010567 7.207146 2.341325 6.723122 2.339278 7.205099 2.097778 6.831592 1.506307 5.833869 1.88186 6.91141 3.334955 12.316513 2.124384 10.754948 1.370207 10.43363 1.183965 8.389064 1.883907 12.746302 0.429789 2.043542 1.505283 2.311649 4.034896 6.614651 2.579755 4.437056 2.313695 4.705162 2.957355 4.975315 2.580778 5.969968 1.666966 6.157233 1.828648 6.695492 1.39886 6.910387 0.645706 3.388167 0.537236 4.14132 0 3.629667-0.537236 3.63069 0 4.464685-1.076518 4.355191-1.934049 8.391111-2.206248 4.247744-1.611707 4.786003 0 1.182942 0.75213 1.480724 2.205225 3.521197 9.575076 14.144138 7.581676 10.595312 3.604084 7.15291 4.89345 7.743358 4.247744 8.498558 4.89652 9.141194 4.892427 10.219759 5.513574 11.588943 3.090385 7.126304 2.850931 6.883781 2.476401 7.367805 2.420119 6.560416 1.828648 6.939039 1.880837 6.480598 2.365884 12.664438 1.882883 12.961196 1.289366 11.45489L862.688057 644.674719z" fill="#1296db" p-id="63263"></path>
</svg>
<span>QQ</span>
<div
class="new_tips" style=" position: absolute;
right: -5px;
top: -5px;
background-color: red;
color: #fff;
width: 25px;
height: 25px;
border-radius: 50%;
display: none;
justify-content: center;
align-items: center;
font-size: 15px;
">
1
</div>
</div>
<div
style=" display: flex;
flex-direction: column;
align-items: center;
" class="app-svg-div">
<svg viewBox="0 0 1024 1024" width="57" height="57">
<path
d="M860.16 0C950.272 0 1024 73.889684 1024 164.163368v531.509895s-32.768-4.122947-180.224-53.355789c-40.96-14.362947-96.256-34.896842-157.696-57.478737 36.864-63.595789 65.536-137.485474 86.016-215.444211h-202.752v-71.841684h247.808V256.512h-247.808V135.437474h-100.352c-18.432 0-18.432 18.458947-18.432 18.458947v104.663579H200.704v41.040842h249.856v69.793684H243.712v41.013895H645.12c-14.336 51.307789-34.816 98.519579-57.344 141.608421-129.024-43.115789-268.288-77.985684-356.352-55.403789-55.296 14.362947-92.16 38.992842-112.64 63.595789-96.256 116.978526-26.624 295.504842 176.128 295.504842 120.832 0 237.568-67.718737 327.68-178.526316C757.76 742.858105 1024 853.692632 1024 853.692632v6.144C1024 950.110316 950.272 1024 860.16 1024H163.84C73.728 1024 0 950.137263 0 859.836632V164.163368C0 73.889684 73.728 0 163.84 0h696.32zM268.126316 553.121684c93.049263-10.374737 180.062316 26.974316 283.270737 78.874948-74.886737 95.501474-165.941895 155.701895-256.970106 155.701894-157.830737 0-204.368842-126.652632-125.466947-197.200842 26.300632-22.851368 72.838737-35.301053 99.166316-37.376z" fill="#00A0EA" p-id="64921"></path>
</svg>
<span>支付宝</span>
</div>
</div>
</div>
<div id="App_Page" style="height: 100%">
<div class="twitter" id="App_twitter" style="display: none">
<div class="mimictwitter">
<div style="margin-right: 8px; margin-top: 10px">
<div
style=" display: grid;
grid-template-columns: 1fr 1fr 1fr;
align-items: center;
">
<div
style=" border-radius: 50%;
width: 32px;
height: 32px;
margin-left: 7px;
" class="twitter-close-btn user_avatar"></div>
<svg
viewBox="0 0 24 24" style=" width: 24.73px;
height: 54px;
justify-self: center;
">
<g>
<path
d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"></path>
</g>
</svg>
<svg
style=" margin-left: auto;
width: 24px;
height: 24px;
" viewBox="0 0 1024 1024" aria-hidden="true">
<g>
<path
d="M596.992 512q0 34.016-24 59.008-12 12-27.488 18.496T512.992 596q-34.016 0-59.008-24.992-4.992-4.992-8.51199999-10.016t-6.49600001-11.008-4.992-12.512-3.48799999-12.992-1.50400001-12.512q0-35.00800001 24.992-59.488t59.488-24.512 59.488 24q7.008 8 12.992 17.504t8.512 20.512T596.96 512z m0 332q0 35.00800001-24 59.008-8 8-17.504 13.504t-20.512 8.512-22.016 3.008q-34.016 0-59.008-24.992-6.016-4.992-10.496-12t-7.488-14.496-4.992-16-2.016-16.512q0-35.00800001 24.992-59.488t59.488-24.51199999 59.488 24.99199999q11.008 11.008 17.504 27.008t6.496 32z m0-664.992q0 35.00800001-24 59.008-8 8-17.504 13.504t-20.512 8.512-22.016 3.00800001q-34.016 0-59.008-24.51200001T428.96 179.04000001t24.992-59.00800001q12-12 27.488-18.496t31.488-6.496q35.00800001 0 60 24.992 11.008 11.008 17.504 27.008t6.496 32z" fill="#000000" p-id="1477"></path>
</g>
</svg>
</div>
<div style="margin-top: 13px"></div>
<div
style=" display: grid;
grid-template-columns: 1fr 1fr;
align-items: center;
justify-items: center;
">
<span style="color: #5f6f7b">为你推荐</span>
<span><strong>正在关注</strong></span>
</div>
<div
style=" margin-top: 8px;
display: grid;
grid-template-columns: 1fr 1fr;
align-items: center;
justify-items: center;
">
<div></div>
<div
style=" background-color: #1d9bf0;
width: 100%;
height: 4px;
border-radius: 50px;
"></div>
</div>
<div
style=" width: 100%;
height: 1px;
background-color: #f0f4f5;
margin-top: 2px;
"></div>
</div>
<div class="twitter-content"><hr /></div>
</div>
</div>
<div
class="QQ" id="App_QQ" style=" background-color: #eff3ff;
width: 100%;
height: 100%;
box-sizing: border-box;
position: relative;
">
<div id="QQ_home_page" style="display: flex; flex-direction: column; height: calc(100% - 20px);">
<div style="width: 100%; height: 30px"></div>
<div
style=" display: flex;
align-items: center;
gap: 5px;
width: 100%;
box-sizing: border-box;
">
<div
class="user_avatar" style=" width: 35px;
height: 35px;
border-radius: 50%;
margin-left: 28px;
"></div>
<div
style=" display: flex;
align-items: start;
justify-content: center;
flex-direction: column;
margin-left: 3px;
gap: 3px;
position: relative;
">
<span
style="font-size: 15px; cursor: pointer; position: relative;" id="QQ_home_UserName" onclick="QQ_ToggleUserMenu()"><strong>{{user}}</strong></span>
<div id="QQ_user_menu" style=" position: absolute;
top: 100%;
left: 0;
background: white;
border-radius: 8px;
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
z-index: 1000;
min-width: 150px;
display: none;
animation: menuSlideDown 0.2s ease;
">
<div class="user_menu_item" onclick="QQ_ShowSpiritButton(); QQ_HideUserMenu();" style=" padding: 12px 16px;
cursor: pointer;
border-bottom: 1px solid #f0f0f0;
display: flex;
align-items: center;
gap: 8px;
font-size: 14px;
color: #333;
transition: background-color 0.2s ease;
" onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor='transparent'">
🧚‍✨ <span>召唤互动精灵</span>
</div>
<div class="user_menu_item" onclick="QQ_ShowInteractiveStats(); QQ_HideUserMenu();" style=" padding: 12px 16px;
cursor: pointer;
border-bottom: 1px solid #f0f0f0;
display: flex;
align-items: center;
gap: 8px;
font-size: 14px;
color: #333;
transition: background-color 0.2s ease;
" onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor='transparent'">
📊 <span>互动统计</span>
</div>
<div class="user_menu_item" onclick="window.QQ_Show_Interactive_Stats(); QQ_HideUserMenu();" style=" padding: 12px 16px;
cursor: pointer;
display: flex;
align-items: center;
gap: 8px;
font-size: 14px;
color: #333;
transition: background-color 0.2s ease;
" onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor='transparent'">
🔧 <span>调试信息</span>
</div>
</div>
<div
style=" display: flex;
align-items: center;
height: 10px;
">
<svg
viewBox="0 0 1024 1024" width="13" height="13" style="margin-right: 2px">
<path
d="M957.539 464.339c-26.14-245.993-246.771-424.08-492.787-397.772C218.735 92.873 40.474 313.62 66.635 559.634 92.774 805.631 313.406 983.717 559.443 957.41c245.997-26.306 424.258-247.075 398.096-493.071z m-298.25-135.757c39.341 0 71.233 31.921 71.233 71.301 0 39.379-31.891 71.3-71.233 71.3-39.338 0-71.229-31.921-71.229-71.3 0-39.38 31.892-71.301 71.229-71.301z m-294.447 0c39.34 0 71.23 31.921 71.23 71.301 0 39.379-31.89 71.3-71.23 71.3s-71.228-31.921-71.228-71.3c0-39.38 31.887-71.301 71.228-71.301z m366.815 304.963c-21.735 96.663-119.97 163.563-219.591 163.563-103.222 0-200.969-68.713-220.487-167.453 0-26.686 20.351-36.26 32.887-36.26h370.156c9.115 0.017 43.978 3.176 37.035 40.15z" fill="#fbba13" p-id="5845"></path>
</svg>
<span style="font-size: 11px">Q我吧</span>
<svg
viewBox="0 0 1024 1024" width="10" height="10" style="margin-top: 1px">
<path
d="M342.528 916.48c19.456 0 38.4-7.168 53.248-21.504l338.944-327.68c14.848-14.336 23.552-34.304 23.552-55.296s-8.192-40.96-23.552-55.296l-338.944-327.68c-30.72-29.696-79.36-28.672-108.544 2.048-29.696 30.72-28.672 79.36 2.048 108.544l281.6 272.384-281.6 272.384c-30.72 29.696-31.232 78.336-2.048 108.544 15.36 15.872 35.328 23.552 55.296 23.552z" fill="#000000" p-id="7578"></path>
</svg>
</div>
</div>
<svg
id="contacts_add_btn" class="add-button" viewBox="0 0 1024 1024" version="1.1" width="20" height="20" style=" margin-left: auto;
margin-right: 28px;
">
<path
d="M512 0a42.666667 42.666667 0 0 1 42.666667 42.666667v426.666666h426.666666a42.666667 42.666667 0 0 1 0 85.333334H554.666667v426.666666a42.666667 42.666667 0 0 1-85.333334 0V554.666667H42.666667a42.666667 42.666667 0 0 1 0-85.333334h426.666666V42.666667a42.666667 42.666667 0 0 1 42.666667-42.666667z" fill="#191919" p-id="4261"></path>
</svg>
</div>
<div style="width: 100%; height: 10px"></div>
<div
id="floating_search_box" style=" width: calc(100% - 40px);
height: 30px;
background-color: rgba(239, 243, 255, 0.9);
margin-left: 20px;
margin-bottom: 5px;
border-radius: 5px;
display: flex;
align-items: center;
gap: 8px;
padding: 0 10px;
z-index: 100;
backdrop-filter: blur(5px);
border: 1px solid rgba(25, 154, 255, 0.2);
transition: all 0.3s ease;
position: sticky;
top: 0;
">
<svg
viewBox="0 0 1024 1024" width="16" height="16" style="flex-shrink: 0;">
<path
d="M446.112323 177.545051c137.567677 0.219798 252.612525 104.59798 266.162424 241.493333 13.562828 136.895354-78.778182 261.818182-213.617777 289.008485-134.852525 27.203232-268.386263-52.156768-308.945455-183.608889s25.018182-272.252121 151.738182-325.779394A267.235556 267.235556 0 0 1 446.112323 177.545051m0-62.060607c-182.794343 0-330.989899 148.195556-330.989899 330.989899s148.195556 330.989899 330.989899 330.989899 330.989899-148.195556 330.989899-330.989899-148.195556-330.989899-330.989899-330.989899z m431.321212 793.341415a30.849293 30.849293 0 0 1-21.94101-9.102223l-157.220202-157.220202c-11.752727-12.179394-11.584646-31.534545 0.37495-43.50707 11.972525-11.972525 31.327677-12.140606 43.494141-0.37495l157.220202 157.220202a31.036768 31.036768 0 0 1 6.723232 33.810101 31.004444 31.004444 0 0 1-28.651313 19.174142z m0 0" fill="#919095"></path>
</svg>
<input
type="text" id="contact_search_input" placeholder="搜索联络人..." style=" flex: 1;
border: none;
background: transparent;
outline: none;
color: #333;
font-size: 14px;
">
<div id="search_clear_btn" style=" display: none;
cursor: pointer;
width: 16px;
height: 16px;
background-color: #ccc;
border-radius: 50%;
position: relative;
flex-shrink: 0;
">
<div style=" position: absolute;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
color: white;
font-size: 12px;
line-height: 1;
">×</div>
</div>
</div>
<div id="QQ_home_chars">
</div>
</div>
<div id="QQ_message_list_page" style="display: none; flex-direction: column; height: calc(100% - 20px);">
<div style="width: 100%; height: 30px"></div>
<div
style=" display: flex;
align-items: center;
gap: 5px;
width: 100%;
box-sizing: border-box;
">
<div
class="user_avatar" style=" width: 35px;
height: 35px;
border-radius: 50%;
margin-left: 28px;
"></div>
<div
style=" display: flex;
align-items: start;
justify-content: center;
flex-direction: column;
margin-left: 3px;
gap: 3px;
">
<span
style="font-size: 15px; cursor: pointer;" id="QQ_message_list_UserName" onclick="QQ_ToggleUserMenu()"><strong>{{user}}</strong></span>
<div
style=" display: flex;
align-items: center;
height: 10px;
">
<svg
viewBox="0 0 1024 1024" width="13" height="13" style="margin-right: 2px">
<path
d="M957.539 464.339c-26.14-245.993-246.771-424.08-492.787-397.772C218.735 92.873 40.474 313.62 66.635 559.634 92.774 805.631 313.406 983.717 559.443 957.41c245.997-26.306 424.258-247.075 398.096-493.071z m-298.25-135.757c39.341 0 71.233 31.921 71.233 71.301 0 39.379-31.891 71.3-71.233 71.3-39.338 0-71.229-31.921-71.229-71.3 0-39.38 31.892-71.301 71.229-71.301z m-294.447 0c39.34 0 71.23 31.921 71.23 71.301 0 39.379-31.89 71.3-71.23 71.3s-71.228-31.921-71.228-71.3c0-39.38 31.887-71.301 71.228-71.301z m366.815 304.963c-21.735 96.663-119.97 163.563-219.591 163.563-103.222 0-200.969-68.713-220.487-167.453 0-26.686 20.351-36.26 32.887-36.26h370.156c9.115 0.017 43.978 3.176 37.035 40.15z" fill="#fbba13" p-id="5845"></path>
</svg>
<span style="font-size: 11px">Q我吧</span>
<svg
viewBox="0 0 1024 1024" width="10" height="10" style="margin-top: 1px">
<path
d="M342.528 916.48c19.456 0 38.4-7.168 53.248-21.504l338.944-327.68c14.848-14.336 23.552-34.304 23.552-55.296s-8.192-40.96-23.552-55.296l-338.944-327.68c-30.72-29.696-79.36-28.672-108.544 2.048-29.696 30.72-28.672 79.36 2.048 108.544l281.6 272.384-281.6 272.384c-30.72 29.696-31.232 78.336-2.048 108.544 15.36 15.872 35.328 23.552 55.296 23.552z" fill="#000000" p-id="7578"></path>
</svg>
</div>
</div>
<svg
id="messages_add_btn" class="add-button" viewBox="0 0 1024 1024" version="1.1" width="20" height="20" style=" margin-left: auto;
margin-right: 28px;
">
<path
d="M512 0a42.666667 42.666667 0 0 1 42.666667 42.666667v426.666666h426.666666a42.666667 42.666667 0 0 1 0 85.333334H554.666667v426.666666a42.666667 42.666667 0 0 1-85.333334 0V554.666667H42.666667a42.666667 42.666667 0 0 1 0-85.333334h426.666666V42.666667a42.666667 42.666667 0 0 1 42.666667-42.666667z" fill="#191919" p-id="4261"></path>
</svg>
</div>
<div style="width: 100%; height: 20px"></div>
<div id="QQ_message_list_chars">
</div>
</div>
<div
id="QQ_space_page" style="display: none; height: calc(100% - 20px); flex-direction: column;">
<div style="width: 100%; height: 35px"></div>
<div style="display: flex">
<span style="font-size: 16px; margin-left: 28px">动态</span>
<svg
viewBox="0 0 1024 1024" width="20" height="20" style="margin-left: auto">
<path
d="M593.420488 922.099512c24.553022 0 44.456585 19.903563 44.456585 44.456586v11.988292c0 24.553022-19.903563 44.456585-44.456585 44.456586h-159.843903c-24.553022 0-44.456585-19.903563-44.456585-44.456586v-11.988292c0-24.553022 19.903563-44.456585 44.456585-44.456586h159.843903zM515.996098 0c24.276293 0 43.957073 19.68078 43.957073 43.957073l0.002997 54.191079C735.392843 121.808047 870.649756 272.137241 870.649756 454.056585V740.277073h102.4c24.553022 0 44.456585 19.903563 44.456585 44.456586v11.988292c0 24.553022-19.903563 44.456585-44.456585 44.456586H870.649756v1.998048H152.35122v-1.998048H52.948293C28.39527 841.178537 8.491707 821.274974 8.491707 796.721951v-11.988292C8.491707 760.180636 28.39527 740.277073 52.948293 740.277073H152.35122V454.056585c0-181.229019 134.231914-331.106654 308.696538-355.632702L461.049756 43.957073c0-24.276293 19.68078-43.957073 43.957073-43.957073h10.989269z m25.620979 197.047571h-60.233178c-126.178779 0-228.706654 101.264109-230.744664 226.958361l-0.029971 3.816273-0.000999 312.454868h521.783446V427.822205c0-127.454533-103.3211-230.774634-230.774634-230.774634z" fill="#000000" p-id="3355"></path>
</svg>
<svg
viewBox="0 0 1065 1024" width="20" height="20" style=" margin-right: 28px;
margin-left: 15px;
">
<path
d="M1002.234305 330.02867V693.97133c0 53.148789-28.346021 101.741967-73.902125 128.063272l-315.349481 182.224419c-46.062284 26.321305-102.248146 26.321305-148.31043 0l-315.349481-182.224419c-46.062284-26.321305-73.902126-75.420662-73.902126-128.063272V330.02867c0-53.148789 28.346021-101.741967 73.902126-128.063272l315.349481-182.224419c46.062284-26.321305 102.248146-26.321305 148.31043 0l315.349481 182.224419c45.556105 26.321305 73.902126 74.914483 73.902125 128.063272z m-76.939199 0c0-25.308947-13.666831-49.099357-35.432526-61.753831l-315.349481-182.224419c-22.271873-12.654474-49.099357-12.654474-71.37123 0l-315.349481 182.224419c-22.271873 12.654474-35.432526 36.444884-35.432526 61.753831V693.97133c0 25.308947 13.666831 49.099357 35.432526 61.753831l315.349481 182.224419c22.271873 12.654474 49.099357 12.654474 71.37123 0l315.349481-182.224419c22.271873-12.654474 35.432526-36.444884 35.432526-61.753831V330.02867zM362.424123 508.709837C362.424123 410.004943 442.400395 329.522491 541.611468 329.522491s179.187346 80.482452 179.187346 179.187346-80.482452 179.187346-179.187346 179.187345-179.187346-79.470094-179.187345-179.187345z m76.939199 0c0 56.692042 46.062284 102.248146 102.248146 102.248146s102.248146-46.062284 102.248146-102.248146-46.062284-102.248146-102.248146-102.248146-102.248146 46.568463-102.248146 102.248146z" fill="#000000" p-id="13806"></path>
</svg>
</div>
<div
style=" width: 100%;
height: 1px;
background-color: #e6e6e6;
margin-bottom: 10px;
margin-top: 10px;
"></div>
<div
class="space_contents" id="space_contents" style=" overflow-y: auto;
width: 100%;
flex: 1;
height: calc(100vh - 180px);
">
<div style="margin-bottom: 80px"></div>
</div>
</div>
<div class="QQ_bottom_nav">
<div
id="QQ_message_nav" style=" display: flex;
align-items: center;
justify-content: center;
flex-direction: column;
gap: 1px;
">
<svg
class="icon" viewBox="0 0 1024 1024" width="20" height="20" style=" transform: scale(1.15);
transform-origin: center;
fill: #000000;
" id="QQ_message_svg">
<path
d="M822.016 61.44H196.864A155.88352 155.88352 0 0 0 40.96 216.94976v426.2144a155.88352 155.88352 0 0 0 155.904 155.50976h9.6256a1.97632 1.97632 0 0 1 1.96608 1.9456l0.97792 84.992A72.832 72.832 0 0 0 322.72896 945.152l211.37408-141.09184a31.9744 31.9744 0 0 1 17.80736-5.39648h270.1056A155.88352 155.88352 0 0 0 977.92 643.16416V216.94976A155.88352 155.88352 0 0 0 822.016 61.44z m85.06368 581.72416a85.05344 85.05344 0 0 1-85.06368 84.84864H551.936a102.69184 102.69184 0 0 0-57.21088 17.33632l-211.39456 141.09184a1.9712 1.9712 0 0 1-3.072-1.6128l-0.97792-85.02272A72.97024 72.97024 0 0 0 206.4896 728.0128h-9.6256a85.05344 85.05344 0 0 1-85.06368-84.84864V216.94976A85.05344 85.05344 0 0 1 196.864 132.096h625.152a85.05344 85.05344 0 0 1 85.06368 84.84864v426.2144z"></path>
<path
d="M311.08608 381.76768a54.17472 54.17472 0 1 0 54.31296 54.17472 54.24128 54.24128 0 0 0-54.31296-54.17472z m207.80032 0a54.17472 54.17472 0 1 0 54.31296 54.17472 54.24128 54.24128 0 0 0-54.31296-54.17472z m212.52096 0a54.17472 54.17472 0 1 0 54.31296 54.17472 54.24128 54.24128 0 0 0-54.31296-54.17472z"></path>
</svg>
<span>消息</span>
</div>
<div
id="QQ_people_nav" style=" display: flex;
align-items: center;
justify-content: center;
flex-direction: column;
gap: 1px;
">
<svg
viewBox="0 0 1024 1024" style="fill: #019aff" width="20" height="20" id="QQ_people_svg">
<path
d="M620.744191 538.879184c82.736353-40.523949 140.308583-124.785028 140.308583-222.936465 0-137.367601-111.714338-249.080915-249.02668-249.080915-137.367601 0-249.080915 111.713314-249.080915 249.080915 0 98.151437 57.57223 182.412516 140.363841 222.936465C235.330238 586.429153 111.796714 740.736565 111.796714 923.694503c0 18.464537 15.032368 33.443693 33.496905 33.443693 18.464537 0 33.497928-14.979156 33.497928-33.443693 0-183.774537 149.46001-333.343017 333.234547-333.343017 183.77556 0 333.234547 149.568481 333.234547 333.343017 0 18.464537 14.978133 33.443693 33.443693 33.443693 18.519796 0 33.496905-14.979156 33.496905-33.443693C912.20124 740.736565 788.668739 586.429153 620.744191 538.879184zM329.886801 315.942719c0-100.438527 81.70179-182.194552 182.140317-182.194552 100.384291 0 182.086082 81.756025 182.086082 182.194552 0 100.384291-81.702813 182.086082-182.086082 182.086082C411.587568 498.0288 329.886801 416.32701 329.886801 315.942719z"></path>
</svg>
<span>联系人</span>
</div>
<div
id="QQ_moment_nav" style=" display: flex;
align-items: center;
justify-content: center;
flex-direction: column;
gap: 1px;
position: relative;
">
<svg
viewBox="0 0 1059 1024" width="20" height="20" id="QQ_moment_svg" style="fill: #000000">
<path
d="M206.566465 1008.20002c11.278404 7.517627 30.080982 15.035253 45.117545 15.035254 11.281023 0 26.324133-3.75554 37.605156-7.517627l240.646548-127.777391 240.646547 127.777391c11.278404 7.517627 22.558118 7.517627 37.602537 7.517627 15.037872 0 30.075744-3.75554 45.118854-15.035254 22.559427-15.030015 37.598609-45.097903 30.082292-71.402393l-45.124092-278.110282L1037.545084 459.503632c18.799959-18.790793 26.321514-48.85868 18.799959-75.163172-7.516317-26.311038-33.839141-45.103141-60.156726-48.85868L714.181074 290.382568 593.854527 42.338864C582.577432 16.027826 556.254609 0.99912 526.177555 0.99912c-30.080982 0-56.403806 15.028706-67.684829 41.339744l-120.32 248.043704L63.679182 331.723621c-26.316276 3.756849-52.640409 22.548951-60.161965 48.853443-7.516317 26.309729-3.758159 56.376307 18.801269 75.169719l199.285852 199.183713-45.120164 278.106353c-3.758159 30.065269 7.521555 60.133156 30.082291 75.163171zM63.679182 406.886793l274.492235-41.339744 48.878322-7.518936 22.559427-45.097903 116.568389-248.042394 120.318691 248.043703 22.562046 45.097903 48.88225 7.516317 274.485688 41.339744L789.383529 606.074435l-33.845688 33.822117 7.522865 45.103141 45.124092 278.103734-240.651785-127.777391-41.356767-26.311039-45.124093 22.555499-240.646547 131.532931 45.120164-278.103734 7.521555-45.103141-30.082292-33.823427L63.679182 406.888102z" p-id="37579"></path>
<path
d="M526.176246 692.509463c-131.604951 0-176.725115-127.777391-176.725116-131.53424-3.763396-15.035253 3.758159-30.065269 18.796031-33.828665 15.044419-3.75554 30.080982 3.763396 33.845688 18.793411 0 3.762087 33.839141 93.953964 124.084706 93.953965 90.239018 0 124.078159-93.953964 124.078159-93.953965 3.763396-15.030015 18.801269-22.548951 33.845688-18.793411 15.036563 3.763396 22.558118 22.555499 18.79603 33.828665 0 3.756849-45.120164 131.53555-176.721186 131.535549z" p-id="37580"></path>
</svg>
<span>动态</span>
<div
class="new_tips" style=" position: absolute;
right: -8px;
top: -8px;
background-color: red;
color: #fff;
width: 15px;
height: 15px;
border-radius: 50%;
display: none;
justify-content: center;
align-items: center;
font-size: 12px;
">
1
</div>
</div>
</div>
<div
id="QQ_friend_info" style=" display: none;
background-color: #fff;
height: 100%;
width: 100%;
padding-top: 50px;
padding-left: 10px;
">
<span>自定义名称:</span><input
name="" id="setcharname" placeholder="这里输入名称" /><br /><br /><span>自定义头像:</span>
<input
type="file" id="QQ_head_input" /><br /><br /><br /><button
onclick="Setfriendinfo(!1)">
取消
</button>
<button onclick="Setfriendinfo(!0)">确定</button>
</div>
</div>
<div
class="discord" id="App_discord" style="display: none; width: 100%; height: 100%">
<div
class="discord-homepage" style="width: 100%; height: 100%">
<div class="discord-top">
<svg
t="1744127791511" class="discord-top-return" viewBox="0 0 1024 1024" version="1.1" xmlns="http:
p-id="3402" width="28" height="28">
<path
d="M440.070244 831.562927c11.813463 0 23.601951-4.49561 32.593171-13.486829a45.980098 45.980098 0 0 0 0-65.161366l-198.730927-198.730927 589.674146 0.499512c24.001561 0 43.507512-19.431024 43.40761-43.40761 0-24.101463-19.480976-43.63239-43.507512-43.63239l-592.221659-0.574439 201.378342-201.378341a45.980098 45.980098 0 0 0 0-65.161366 45.980098 45.980098 0 0 0-65.186342 0L131.29678 476.734439a45.955122 45.955122 0 0 0-13.53678 33.16761v0.574439c0 13.361951 5.994146 25.300293 15.409951 33.292488l274.307122 274.332097c8.99122 8.966244 20.804683 13.461854 32.593171 13.461854z" p-id="3403" fill="#505058"></path>
</svg>
<svg
aria-hidden="true" width="20" height="20" fill="none" viewBox="0 0 24 24" style=" margin-left: 15px;
margin-right: 10px;
">
<path
fill="#313237" fill-rule="evenodd" d="M18.09 1.63c.4-.7 1.43-.7 1.82 0l3.96 6.9c.38.66-.12 1.47-.91 1.47h-7.92c-.79 0-1.3-.81-.91-1.48l3.96-6.9Zm.46 1.87h.9c.3 0 .52.26.5.55l-.22 2.02c-.01.16-.17.26-.33.23a1.92 1.92 0 0 0-.8 0c-.16.03-.32-.07-.33-.23l-.21-2.02a.5.5 0 0 1 .5-.55ZM19 9a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z" clip-rule="evenodd" class=""></path>
<path
fill="#313237" d="M14.8 3.34a.48.48 0 0 0-.24-.69A9.94 9.94 0 0 0 11 2c-4.97 0-9 3.58-9 8 0 1.5.47 2.91 1.28 4.11.14.21.12.49-.06.67l-1.51 1.51A1 1 0 0 0 2.4 18h5.1a.5.5 0 0 0 .49-.5c0-2.86 1.62-5.3 3.97-6.56.28-.15.38-.51.25-.8a2.86 2.86 0 0 1 .18-2.61l2.4-4.19ZM18.91 12.98a5.45 5.45 0 0 1 2.18 6.2c-.1.33-.09.68.1.96l.83 1.32a1 1 0 0 1-.84 1.54h-5.5A5.6 5.6 0 0 1 10 17.5a5.6 5.6 0 0 1 5.68-5.5c1.2 0 2.32.36 3.23.98Z" class=""></path>
</svg>
<div class="discord-top-title">
<strong>类脑ΟΔΥΣΣΕΙΑ</strong>
</div>
<div
style=" display: flex;
align-items: center;
justify-content: center;
background-color: #ebebeb;
border-radius: 50%;
height: 32px;
width: 32px;
margin-left: auto;
margin-right: 10px;
">
<svg
viewBox="0 0 1024 1024" width="16" height="16">
<path
d="M991.418182 972.8L791.272727 772.654545c79.127273-83.781818 130.327273-195.490909 130.327273-316.50909 0-251.345455-200.145455-451.490909-446.836364-451.49091C232.727273 0 32.581818 204.8 32.581818 451.490909s200.145455 451.490909 446.836364 451.490909c97.745455 0 190.836364-32.581818 265.309091-88.436363l200.145454 204.8 46.545455-46.545455zM102.4 451.490909c0-209.454545 167.563636-381.672727 377.018182-381.672727s377.018182 172.218182 377.018182 381.672727-172.218182 386.327273-381.672728 386.327273c-204.8 0-372.363636-172.218182-372.363636-386.327273z" fill="#55565c" p-id="12001"></path>
</svg>
</div>
</div>
<div
style=" width: 100%;
height: 1px;
background-color: #dcdcdc;
"></div>
<div
style=" width: 100%;
height: 1px;
background-color: #d8d9db;
"></div>
<div class="discord-top-button">
<div class="sortbutton">
<svg
aria-hidden="true" role="img" xmlns="http:
width="16" height="16" fill="none" viewBox="0 0 24 24">
<path
fill="#515256" d="M16.3 21.7a1 1 0 0 0 1.4 0l4-4a1 1 0 0 0-1.4-1.4L18 18.58V3a1 1 0 1 0-2 0v15.59l-2.3-2.3a1 1 0 0 0-1.4 1.42l4 4ZM6.3 2.3a1 1 0 0 1 1.4 0l4 4a1 1 0 0 1-1.4 1.4L8 5.42V21a1 1 0 1 1-2 0V5.41l-2.3 2.3a1 1 0 0 1-1.4-1.42l4-4Z" class=""></path>
</svg>
<div
style="font-size: 14px; color: #515256">
排序 & 查看
</div>
<svg
aria-hidden="true" role="img" xmlns="http:
width="20" fill="none" viewBox="0 0 24 24">
<path
fill="#515256" d="M5.3 9.3a1 1 0 0 1 1.4 0l5.3 5.29 5.3-5.3a1 1 0 1 1 1.4 1.42l-6 6a1 1 0 0 1-1.4 0l-6-6a1 1 0 0 1 0-1.42Z" class=""></path>
</svg>
</div>
<div class="tagbutton">
<div
style="font-size: 14px; color: #515256">
标签
</div>
<svg
aria-hidden="true" role="img" xmlns="http:
width="20" fill="none" viewBox="0 0 24 24">
<path
fill="#515256" d="M5.3 9.3a1 1 0 0 1 1.4 0l5.3 5.29 5.3-5.3a1 1 0 1 1 1.4 1.42l-6 6a1 1 0 0 1-1.4 0l-6-6a1 1 0 0 1 0-1.42Z" class=""></path>
</svg>
</div>
</div>
<div
style=" width: 100%;
height: 1px;
background-color: #dcdcdc;
"></div>
<div
style=" width: 100%;
height: 1px;
background-color: #d8d9db;
"></div>
<div class="discord-cardlist">
<div class="discord-cardget">
<span>查看帖子</span>
</div>
</div>
</div>
<div
class="discord-thread-list" style="width: 100%; height: 100%; display: none"></div>
</div>
</div>
</div>
<div
class="top" style=" display: flex;
align-items: center;
justify-content: center;
">
<svg
t="1735485675807" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http:
p-id="9713" width="16" height="16">
<path
d="M716.8 805.823147 716.8 384.709973c0-95.68256-77.544107-173.2608-173.216427-173.2608L56.664747 211.449173c-3.754667 0-6.795947 3.024213-6.795947 6.741333L49.8688 805.819733c0 3.71712 3.04128 6.72768 6.795947 6.72768l130.061653 0c3.754667 0 6.792533-3.027627 6.792533-6.765227L193.518933 344.562347c0-3.744427 3.04128-6.782293 6.795947-6.782293l279.68512 0c52.52096 0 95.112533 42.571093 95.112533 95.09888l0 372.8896c0 3.741013 3.037867 6.761813 6.772053 6.761813l128.146773 0c3.72736 0 6.772053-3.017387 6.772053-6.72768M454.15424 805.778773c0 3.744427-3.01056 6.76864-6.76864 6.76864L317.354667 812.547413c-3.754667 0-6.795947-3.027627-6.795947-6.76864L310.55872 452.348587c0-3.741013 3.04128-6.77888 6.795947-6.77888l130.030933 0c3.75808 0 6.76864 3.037867 6.76864 6.77888l0 353.447253L454.15424 805.778773zM974.134613 805.778773c0 3.744427-3.044693 6.76864-6.79936 6.76864l-130.000213 0c-3.764907 0-6.826667-3.027627-6.826667-6.76864L830.508373 218.251947c0-3.75808 3.06176-6.792533 6.826667-6.792533l130.000213 0c3.75808 0 6.79936 3.034453 6.79936 6.792533L974.134613 805.778773z" fill="#ffffff" p-id="9714"></path>
</svg>
</div>
</div>
<script></script>
<script>
var __webpack_exports__={};var lastAiNewMessages={};var code='<div data-name="${name}" class="QQ_chat_page" style="width:100%;height:100%;padding-top:0"><div style="padding-top:10px;backdrop-filter:blur(1px);background-color:rgb(255,255,255,.1)"><div style="width:100%;height:20px;display:grid;top:0;left:0;grid-template-columns:auto 1fr auto;align-items:center;margin-top:20px"><svg class="QQ-close-btn" viewBox="0 0 1024 1024" style="height:18px;width:18px;margin-left:8px"><path d="M769.137778 153.372444L444.984889 512l324.152889 358.684444c36.408889 35.043556 36.408889 91.989333 0 126.976a95.744 95.744 0 0 1-131.868445 0l-377.571555-417.678222c-1.536-1.365333-3.584-1.877333-5.063111-3.299555A87.438222 87.438222 0 0 1 227.555556 512c-0.341333-23.324444 8.533333-46.876444 27.079111-64.739556 1.479111-1.422222 3.527111-1.934222 5.063111-3.185777L637.269333 26.339556a95.744 95.744 0 0 1 131.868445 0c36.408889 35.043556 36.408889 91.932444 0 127.032888z" fill="#666666" p-id="1570"></path></svg><div style="display:flex;align-items:center;position:relative"><div class="new_tips" style="background-color:gray;color:#fff;width:20px;height:20px;border-radius:50%;display:none;justify-content:center;align-items:center;font-size:12px">1</div><span style="margin-left:8px;color:#000;font-size:16px" id="QQ_chat_username" onclick="handleChatTitleClick(this)">${name}</span><div class="group-member-dropdown" id="group_member_dropdown" style="display:none;position:absolute;top:25px;left:8px;background:#fff;border:1px solid #ddd;border-radius:5px;box-shadow:0 2px 10px rgba(0,0,0,0.1);z-index:1000;min-width:200px;max-height:300px;overflow-y:auto;"><div class="group-member-list" id="group_member_list"></div></div></div><svg id="QQ_chat_page_setting" viewBox="0 0 1024 1024" style="height:20px;width:20px;margin-right:20px"><path d="M901.632 896H122.368c-30.72 0-55.808-25.088-55.808-55.808v-1.536c0-30.72 25.088-55.808 55.808-55.808h779.776c30.72 0 55.808 25.088 55.808 55.808v1.536c-0.512 30.72-25.6 55.808-56.32 55.808zM901.632 568.32H122.368c-30.72 0-55.808-25.088-55.808-55.808v-1.536c0-30.72 25.088-55.808 55.808-55.808h779.776c30.72 0 55.808 25.088 55.808 55.808v1.536c-0.512 30.72-25.6 55.808-56.32 55.808zM901.632 240.64H122.368c-30.72 0-55.808-25.088-55.808-55.808v-1.536c0-30.72 25.088-55.808 55.808-55.808h779.776c30.72 0 55.808 25.088 55.808 55.808v1.536c-0.512 30.72-25.6 55.808-56.32 55.808z" p-id="4301" fill="#666666"></path></svg></div><div style="width:100%;height:.5px;background-color:#eee;margin-top:10px;border-top:1px solid #9a9a9a"></div></div><div class="input-container"><div style="display:flex;align-items:center;width:100%"><svg viewBox="0 0 1024 1024" width="25" height="25" style="margin-left:10px"><path d="M512 62a184.09090869 184.09090869 0 0 1 184.09090869 184.09090869v204.54545478a184.09090869 184.09090869 0 1 1-368.18181738 1e-8v-204.54545479A184.09090869 184.09090869 0 0 1 512 62z m0 65.45454521a118.63636348 118.63636348 0 0 0-118.63636348 118.63636348v204.54545479a118.63636348 118.63636348 0 1 0 237.27272695 0v-204.54545479A118.63636348 118.63636348 0 0 0 512 127.45454521z" p-id="6838"></path><path d="M192.90909131 471.09090869a319.09090869 319.09090869 0 0 0 638.18181738 0 32.72727305 32.72727305 0 1 0-65.45454521 0 253.63636348 253.63636348 0 0 1-507.27272695 0 32.72727305 32.72727305 0 1 0-65.45454522 0z" p-id="6839"></path><path d="M479.27272695 757.45454521v131.85a32.72727305 32.72727305 0 1 0 65.4545461 0V757.45454521a32.72727305 32.72727305 0 1 0-65.4545461 0z" p-id="6840"></path><path d="M409.72727305 953.81818174h206.87727216a32.72727305 32.72727305 0 1 0 0-65.45454522H409.72727305a32.72727305 32.72727305 0 1 0 0 65.45454522z" p-id="6841"></path></svg><div style="flex-grow:1;margin-left:5px;margin-right:2%"><input class="userInput" type="text" name="" style="box-sizing:border-box;background-color:transparent"/></div><div style="margin-right:7px" id="QQ_chat_send-btn"><button style="background-color:#fff;border-radius:30px;height:31px;display:block;width:3.5rem;background-color:transparent;border:1px solid rgb(0,0,0,.5)">发送</button></div></div></div><div class="msgcontent" style="padding-top:15px;padding-bottom:0"></div></div>';var chat_page=code;var chat_page_setting_code='<div class="chat-setting-popup"><div class="chat-setting-header"><span>聊天设置</span><svg class="close-setting-btn" viewBox="0 0 1024 1024" width="20" height="20"><path d="M512 421.490332 331.092592 240.582924C307.952518 217.442849 270.568889 217.442849 247.428814 240.582924 224.288739 263.722999 224.288739 301.106628 247.428814 324.246702L428.336222 505.154112 247.428814 686.061521C224.288739 709.201596 224.288739 746.585225 247.428814 769.7253 270.568889 792.865374 307.952518 792.865374 331.092592 769.7253L512 588.817891 692.907408 769.7253C716.047482 792.865374 753.431111 792.865374 776.571186 769.7253 799.711261 746.585225 799.711261 709.201596 776.571186 686.061521L595.663778 505.154112 776.571186 324.246702C799.711261 301.106628 799.711261 263.722999 776.571186 240.582924 753.431111 217.442849 716.047482 217.442849 692.907408 240.582924L512 421.490332Z" fill="#666666"></path></svg></div><div class="chat-setting-content"><div class="setting-item"><span>气泡颜色</span><div style="flex:1"><input style="width:100%" type="text" id="bubble-color-input" placeholder="颜色值"/></div><input type="color" id="bubble-color" class="color-picker"/></div><div class="setting-item"><span>字体颜色</span><div style="flex:1"><input style="width:100%" type="text" id="text-color-input" placeholder="颜色值"/></div><input type="color" id="text-color" class="color-picker"/></div><div class="setting-item"><span>聊天壁纸</span><input type="text" id="chat-bg" placeholder="输入图片URL"/></div><div class="preview" style="margin:0 auto"><div class="QQ_chat_msgdiv" id="chat-setting-preview" data-name="${username}" style="margin:0 auto"><span>这是预览文本</span></div></div></div><div class="chat-setting-footer"><button id="randomcolor-setting-btn" style="background-color:#919bec;color:#fff">随机</button><button id="save-setting-btn">保存</button><button id="cancel-setting-btn">取消</button></div></div>';var chat_page_setting=chat_page_setting_code;var chat_list_item_code='<div data-name="${name}" class="QQ_home_usermsg"><div class="QQ_home_head" style="background-image:url(\'${head}\')"></div><div style="width:100%;display:grid;grid-template-columns:1fr auto;grid-template-rows:1fr 1fr;row-gap:4px"><span class="QQ_home_name"><strong>${name}</strong></span><span class="QQ_home_lasttime" style="color:#626367;justify-self:end"></span><span class="QQ_home_lastmsg" style="color:#626367;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">...</span><div class="QQ_home_usermsg_new" style="display:none"></div></div></div>';var chat_list_item=chat_list_item_code;var chat_user_message_code='<div class="QQ_chat_mymsg"><div style="width:auto;height:auto;margin-top:4px">${content}</div><div class="user_avatar Chat_MyHead"></div></div>';var chat_user_message=chat_user_message_code;var chat_char_msg_code='<% if(isgroup){%><div class="QQ_chat_charmsg"><div data-name="${name}" class="QQ_chat_head head"></div><div style="width:auto;height:auto;margin-top:4px"><span class="name">${name}</span><br/>${content}</div></div><%}else{%><div class="QQ_chat_charmsg"><div data-name="${name}" class="QQ_chat_head head"></div><div style="width:auto;height:auto;margin-top:4px">${content}</div></div><%}%>';var chat_char_msg=chat_char_msg_code;var chat_normal_message_code='<div class="QQ_chat_msgdiv" data-name="${username}"<% if(isgroup){%>style="margin-top:6px"<%}%>><span>${message}</span></div>';var chat_normal_message=chat_normal_message_code;var chat_emoji_message_code='<div class="QQ_chat_msgdiv" data-name="${username}"<% if(isgroup){%>style="margin-top:6px"<%}%>><div style="width:100%;background-color:#fff"><img class="msgimg" loading="lazy" src="<%=emojiUrl %>" alt="加载失败"/></div><% if(additionalText){%><span style="margin-top:5px;display:block"><%=additionalText %></span><%}%></div>';var chat_emoji_message=chat_emoji_message_code;var chat_fakeimg_message_code='<div class="QQ_chat_msgdiv" data-name="${username}"<% if(isgroup){%>style="margin-top:6px"<%}%>><div class="QQ_chat_fakeimg" style="text-align:center"><div>${content}</div></div>${additionalText}</div>';var chat_fakeimg_message=chat_fakeimg_message_code;var chat_music_message_code='<div class="QQ_chat_music"><div class="music-container" style="display:grid;grid-template-columns:1fr 64px;width:100%"><div style="display:flex;flex-direction:column;margin-top:8px;overflow:hidden;max-width:100%"><div class="hide-title music-name" style="font-size:1.2rem"><strong>${musicname}</strong></div><div class="hide-title music-author" style="color:#8d8c8d;margin-left:3px;margin-top:10px;font-size:1rem">${musicauthor}</div></div><div style="margin-left:auto;position:relative;height:64px;width:64px"><div class="icon-container" style="width:64px;width:64px;position:relative"><svg style="position:absolute;left:-3px;top:-5px" class="icon" viewBox="0 0 1024 1024" width="72" height="72"><path d="M773.9392 301.8752m-200.0384 0a200.0384 200.0384 0 1 0 400.0768 0 200.0384 200.0384 0 1 0-400.0768 0Z" fill="#d81e06" p-id="51386"></path><path d="M924.4672 706.2528a24.32 24.32 0 0 1-24.2688 24.2688h-145.7664a24.3712 24.3712 0 0 0-24.2688 24.32 24.2688 24.2688 0 0 0 24.2688 24.2688h48.5888a24.32 24.32 0 0 1 24.2688 24.32 24.32 24.32 0 0 1-24.2688 24.2688h-64.512A388.7616 388.7616 0 0 1 122.88 390.4512h-48.5888a24.32 24.32 0 0 1 0-48.5888h97.28a24.2688 24.2688 0 0 0 6.8096-47.5648l0.768-0.9728H122.88a24.32 24.32 0 1 1 0-48.5888h101.632a388.7616 388.7616 0 0 1 619.52 437.248h56.32a24.32 24.32 0 0 1 24.1152 24.2688z" fill="#2c2c2c" p-id="51387"></path><path d="M565.8112 478.8736a3.84 3.84 0 0 0-4.5568 4.608c3.1744 14.7456 7.8848 40.96 9.984 60.0576 3.6352 32.2048-28.5696 62.3104-53.6064 70.7584-39.424 13.568-84.8896-18.688-95.1296-56.32-11.776-43.9808 12.6464-97.5872 53.2992-115.0464 4.5056-2.0992 9.0112-3.8912 13.568-5.9904 9.3184-4.2496 4.8128-11.1616 3.2768-17.5104-4.1984-17.4592-6.6048-34.9184 2.4064-51.2 13.568-24.4224 48.7936-43.6736 76.1856-31.9488a276.48 276.48 0 0 1 34.6624 16.5888 25.1904 25.1904 0 0 1 10.5472 28.2624c-5.7344 15.36-20.7872 18.9952-36.7616 9.6768a196.1984 196.1984 0 0 0-17.4592-9.9328 16.2304 16.2304 0 0 0-23.808 15.36 150.3744 150.3744 0 0 0 1.9456 18.0224 18.4832 18.4832 0 0 0 13.568 14.8992 200.3456 200.3456 0 0 1 29.3888 8.9088c38.8096 17.152 66.56 45.1584 79.5136 87.04 24.064 77.6704-21.0944 155.0848-87.9616 184.6272a182.016 182.016 0 0 1-116.8384 13.2096 185.6 185.6 0 0 1-126.464-104.8064c-18.0736-40.96-22.8864-82.7904-8.7552-127.0784 18.9952-59.2384 56.9344-99.6352 114.7392-121.9072a23.4496 23.4496 0 0 1 28.0064 9.728 21.1456 21.1456 0 0 1-6.0416 29.5424 259.8912 259.8912 0 0 1-25.2928 13.568c-31.8976 16.2304-51.7632 42.752-64.4096 75.8784-24.7296 64.4096 9.3184 139.1104 65.6384 168.3456 51.7632 27.0848 122.5728 16.2304 160.8192-28.3136A106.2912 106.2912 0 0 0 619.52 542.72c-5.12-25.6-34.5088-59.2896-53.7088-63.8464z m-53.4016 5.9904a6.144 6.144 0 0 0-7.9872-4.5056c-33.28 11.4688-47.5136 47.2576-31.9488 76.4416a28.0064 28.0064 0 0 0 30.1056 13.824c14.1824-4.1984 24.1152-14.4384 22.016-27.6992-2.9696-19.5072-7.936-38.8096-12.1856-58.0608z" fill="#d81e06" p-id="51388"></path></svg><div class="music-img" style="width:64px;height:64px;position:absolute;left:0;top:0;background-size:cover;z-index:1;background-image:url(\'https:var chat_music_message=chat_music_message_code;var chat_transfer_message_code='<div class="give_money"><div style="background-color:#4396f7;height:80px;width:100%;color:#fff;padding-top:20px;padding-left:12px;display:flex;flex-direction:column;gap:9px;position:relative"><span><%=amount %></span><span>已转入你的余额</span><div style="border-radius:50%;background-color:#9fccf1;width:50px;height:50px;position:absolute;right:10px;display:flex;align-items:center;justify-content:center;top:15px"><svg t="1738258225266" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http:var chat_transfer_message=chat_transfer_message_code;var chat_char_voice_message_code='<div class="QQ_chat_msgdiv" data-name="${username}"<% if(isgroup){%>style="margin-top:6px"<%}%>><div class="QQ_chat_voice" style="width:100%;display:flex;gap:5px;align-items:center"><span style="margin-left:2px">${time}"</span><span style="display:block"><svg style="transform:rotate(90deg);display:flex;align-items:center" t="1742985508017" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http:var chat_char_voice_message=chat_char_voice_message_code;var chat_my_voice_message_code='<div class="QQ_chat_msgdiv ${username}"<% if(isgroup){%>style="margin-top:6px"<%}%>><div class="QQ_chat_voice" style="width:100%;display:flex;gap:5px;align-items:center"><span style="display:block" class="totext"><svg style="margin-right:30px;display:flex;align-items:center" viewBox="0 0 1024 1024" width="24" height="24"><path d="M999.611733 387.697778a37.831111 37.831111 0 0 0-48.355555 22.641778v0.512l-1.592889 5.233777c-58.88-241.208889-302.648889-388.892444-543.857778-330.012444A446.805333 446.805333 0 0 0 124.546844 295.253333a39.139556 39.139556 0 0 0 13.653334 53.077334 39.310222 39.310222 0 0 0 18.944 5.233777c13.084444 0 25.201778-6.826667 32.540444-18.375111a374.158222 374.158222 0 0 1 359.480889-183.978666 381.952 381.952 0 0 1 337.351111 334.279111 384.568889 384.568889 0 0 1-3.128889 115.086222v2.616889a38.855111 38.855111 0 0 0 21.560889 48.355555c19.456 6.826667 41.528889-3.185778 48.355556-22.641777l68.835555-192.284445a39.310222 39.310222 0 0 0-22.584889-48.924444z m-148.764444 348.956444a38.115556 38.115556 0 0 0-31.004445 16.839111 373.077333 373.077333 0 0 1-355.214222 157.639111 381.212444 381.212444 0 0 1-323.185778-306.346666 396.344889 396.344889 0 0 1 0-140.856889v-1.592889a39.139556 39.139556 0 0 0-22.072888-48.355556 38.058667 38.058667 0 0 0-48.355556 22.584889l-68.835556 191.317334a38.513778 38.513778 0 0 0 23.608889 48.867555c19.456 7.395556 40.96-3.128889 48.355556-22.584889v-3.697777c58.88 241.208889 302.705778 388.892444 543.914667 330.012444A448.739556 448.739556 0 0 0 881.851733 798.151111a38.684444 38.684444 0 0 0-8.362666-54.158222 31.857778 31.857778 0 0 0-22.641778-7.338667z" p-id="41017" fill="currentColor"></path><path d="M310.687289 693.020444a50.517333 50.517333 0 0 0-33.166222 19.456 40.96 40.96 0 0 0 0 31.573334c1.592889 4.721778 3.697778 9.443556 6.257777 14.165333a26.794667 26.794667 0 0 0 13.198223 11.036445 30.833778 30.833778 0 0 0 12.060444 2.104888h5.290667c6.826667-1.080889 13.653333-2.616889 20.48-4.721777 15.758222-5.290667 32.028444-11.605333 48.924444-18.432 16.782222-6.826667 34.133333-15.758222 49.322667-23.608889 15.246222-7.907556 32.597333-17.863111 46.250667-26.282667 14.222222-8.419556 24.177778-15.758222 35.271111-24.177778 24.632889 19.456 50.915556 36.238222 78.791111 49.891556 33.621333 17.351111 68.835556 31.004444 105.073778 42.097778a56.32 56.32 0 0 0 20.48 3.640889 33.905778 33.905778 0 0 0 34.190222-26.282667 39.025778 39.025778 0 0 0-1.592889-35.726222 49.322667 49.322667 0 0 0-26.225778-18.375111 540.842667 540.842667 0 0 1-85.162667-33.621334 603.932444 603.932444 0 0 1-63.601777-38.912c20.48-23.096889 37.831111-48.355556 52.565333-75.662222a465.294222 465.294222 0 0 0 38.343111-98.304h49.436445a38.456889 38.456889 0 0 0 26.282666-12.060444 46.762667 46.762667 0 0 0 7.850667-26.282667 44.032 44.032 0 0 0-8.931556-28.899556 37.432889 37.432889 0 0 0-26.282666-11.036444H568.6784a116.167111 116.167111 0 0 0-9.500444-17.863111c-10.467556-12.629333-22.584889-25.770667-34.702223-38.912a47.786667 47.786667 0 0 0-27.818666-18.375111h-4.209778a36.636444 36.636444 0 0 0-24.177778 8.419555 35.896889 35.896889 0 0 0-18.375111 29.923556 51.2 51.2 0 0 0 16.270222 33.109333l6.314667 6.314667H315.352178a34.133333 34.133333 0 0 0-26.282667 12.629333 45.852444 45.852444 0 0 0-6.826667 26.282667c-0.512 10.467556 2.104889 20.48 7.907556 28.899555 6.826667 6.826667 16.270222 11.036444 26.282667 11.036445h47.274666c5.233778 15.758222 10.524444 32.028444 16.839111 47.786666a419.271111 419.271111 0 0 0 50.403556 94.094223c8.419556 11.036444 17.351111 22.584889 26.282667 33.109333a389.461333 389.461333 0 0 1-64.625778 39.936c-26.282667 12.629333-54.101333 23.096889-81.976889 32.028444z m131.299555-246.954666h140.344889c-6.826667 23.096889-16.839111 45.169778-28.387555 66.730666a325.290667 325.290667 0 0 1-39.936 55.751112 319.146667 319.146667 0 0 1-39.424-52.622223l-2.616889-4.209777a388.778667 388.778667 0 0 1-29.980445-65.649778z" p-id="41018" fill="currentColor"></path></svg></span><div style="display:flex;align-items:center;gap:5px;margin-left:auto"><span style="display:block"><svg style="transform:rotate(-90deg);display:flex;align-items:center" t="1742985508017" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http:var chat_my_voice_message=chat_my_voice_message_code;var chat_headraw_namespaceObject=".head[data-name='${name}']{\r\n background-image:url('${head}')!important;\r\n}\r\n";var moment_page_code='<div class="user_moment_title" style="margin-bottom:7px"><div class="QQ_home_head head" data-name="${userName}"></div><div style="width:100%;display:grid;grid-template-rows:1fr 1fr;row-gap:4px"><div style="display:flex;align-items:center"><span><strong class="moment_sender">${userName}</strong></span><svg class="moment_menu_dots" viewBox="0 0 1024 1024" width="18" height="18" style="margin-left:auto;cursor:pointer" data-moment-id="${momentId}"><path d="M512.4 429.1c22.3 0 41.7 7.9 58.1 23.6 7.9 7.9 13.9 16.9 18.2 27.1 4.3 10.2 6.4 20.8 6.4 32 0 22.3-8.2 41.7-24.6 58.1-3.3 3.3-6.6 6.1-9.9 8.4s-6.9 4.4-10.8 6.4c-3.9 2-8 3.6-12.3 4.9-4.3 1.3-8.5 2.5-12.8 3.4-4.2 1-8.3 1.5-12.3 1.5-23 0-42.5-8.2-58.6-24.6s-24.1-35.9-24.1-58.6c0-22.6 7.9-42.2 23.6-58.6 5.3-4.6 11-8.9 17.2-12.8 6.2-3.9 13-6.7 20.2-8.4 7.2-1.6 14.4-2.4 21.7-2.4z m326.8 0c23 0 42.3 7.9 58.1 23.6 5.3 5.3 9.7 11 13.3 17.2 3.6 6.2 6.4 13 8.4 20.2 2 7.2 3 14.4 3 21.7 0 22.3-8.2 41.7-24.6 58.1-3.3 3.9-7.2 7.4-11.8 10.3-4.6 2.9-9.4 5.4-14.3 7.4s-10.2 3.6-15.8 4.9-11 2-16.3 2c-23 0-42.5-8.2-58.6-24.6-16.1-16.4-24.1-35.9-24.1-58.6 0-22.6 8.2-42.2 24.6-58.6 7.2-7.2 16.1-13 26.6-17.2 10.5-4.2 21-6.3 31.5-6.4z m-654.6 0c23 0 42.3 7.9 58.1 23.6 5.3 5.3 9.7 11 13.3 17.2 3.6 6.2 6.4 13 8.4 20.2s3 14.4 3 21.7c0 22.3-8 41.7-24.1 58.1s-35.6 24.6-58.6 24.6-42.3-8.2-58.1-24.6c-7.9-7.9-13.9-16.9-18.2-27.1-4.3-10.2-6.4-20.5-6.4-31 0-23 8.2-42.7 24.6-59.1 7.2-7.2 16.1-13 26.6-17.2 10.4-4.2 20.9-6.3 31.4-6.4z" p-id="14923" fill="#000000"></path></svg></div><span style="color:#626367;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:12px">${timestamp}</span></div></div><span style="font-size:15px;line-height:1.3" class="moment_message">${message}</span>${imgcontent}<div style="display:flex;align-items:center;gap:3px;margin-top:5px"><svg t="1736250731870" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http:var moment_page=moment_page_code;var discord_card_code='<div class="discord-card" data-id="${id}"><div class="discord-card-tags">${tag}</div><span class="discord-card-author">${name}</span><span style="color:#67686a;font-size:15px;margin-left:8px">${time}</span><div class="discord-card-title">${cardtilte}</div><div class="discord-card-content">${content}</div><div class="discord-card-fakeimg">${img}</div><div class="discord-card-interact"><svg aria-hidden="true" role="img" xmlns="http:var discord_discord_card=discord_card_code;var discord_thread_code='<div class="discord-thread" data-id="${id}"><div class="discord-thread-top"><svg class="discord-thread-top-return" viewBox="0 0 1024 1024" version="1.1" xmlns="http:var discord_discord_thread=discord_thread_code;var discord_thread_comment_code='<div class="discord-thread-comment"><div class="discord-thread-comment-head head${isuser}" data-name="${name}"></div><div><div class="discord-thread-comment-name${creator}">${name}</div><div class="discord-thread-comment-content">${content}</div></div></div>';var discord_discord_thread_comment=discord_thread_comment_code;var _1_raw_namespaceObject="<线上格式>\r\n当用户要求查看内容时,仅输出对应格式,禁止输出剧情旁白\r\n以下是各格式具体介绍";var _2_QQ_raw_namespaceObject="<QQ聊天格式介绍>\r\n格式示例如:\r\nmsg_start\r\n<{{user}}和xxx的私聊>\r\n发言人--内容--HH:MM\r\n发言人--特殊消息类型--HH:MM\r\n</{{user}}和xxx的私聊>\r\n\r\n<群聊:群名字>\r\n<成员>成员A,成员B</成员>\r\n<聊天内容>\r\n发言人--内容--HH:MM\r\n发言人--特殊消息类型--HH:MM\r\n</聊天内容>\r\n</群聊:群名字>\r\n\r\nmsg_end\r\n\r\n特殊消息类型:\r\n\r\n【表情包相关】\r\n角色会根据当前情绪和对话内容使用适当的表情包：\r\n-表情包的选择应当符合角色当前心理和角色性格\r\n-表情包使用频率应适中，平均每3-5条消息可使用一次\r\n-输出格式为[bqb-表情包内容]（仅使用列表中存在的表情包，不可自创或篡改）\r\n-表情包作为独立的一条消息，一条消息只能包含一个表情包\r\n-示例:路人a--[bqb-摸小猫下巴]--12:00\r\n<表情包列表>\r\n\r\n</表情包列表>\r\n\r\n【转账消息相关】\r\n-格式：[zz-金额元]\r\n-必须独立成行，示例：路人a--[zz-520元]--12:00\r\n-可用范围：仅私聊\r\n-不可用范围：群聊，QQ空间\r\n\r\n【语音消息相关】\r\n-格式：[yy-语音内容]\r\n-必须独立成行，示例：路人a--[yy-想你了]--12:00\r\n-可用范围：私聊，群聊\r\n-不可用范围：QQ空间\r\n\r\n【音乐分享消息相关】\r\n-格式：[music-歌名$歌手]\r\n-必须独立成行，示例：路人a--[music-富士山下$陈奕迅]--12:00\r\n-可用范围：私聊，群聊\r\n-不可用范围：QQ空间\r\n\r\n【图片或视频消息相关】\r\n-格式：[img-内容]\r\n-示例：路人a--[img-一张自拍]--12:00\r\n-可用范围：私聊，群聊，QQ空间\r\n-在群聊和私聊时必须独立成行\r\n-在QQ空间时前面可带其他文字内容\r\n-注意：图片和视频都是使用这个格式\r\n\r\n格式解释:\r\n私聊：{{user}}和对方的私聊,聊天内容只有双方知道,标签名字顺序一定是{{user}}和xxx的私聊,而不是xxx和{{user}}的私聊\r\n群聊：包含多个成员的群组对话，所有群成员可见消息\r\n确保私聊和群聊的标签闭合\r\n特殊消息类型：聊天过程中可使用的消息类型,前后依然要加发言人和时间\r\n发言内容中如果需要换行,使用<br>\r\n若群聊中需要生成一些随机路人,禁止使用路人A,匿名用户等敷衍网名\r\n格式前后带上msg_start和msg_end标识符\r\n请勿生成多个msg_start,msg_end标识\r\n\r\n</QQ聊天格式介绍>";var _3_QQ_raw_namespaceObject='<QQ空间格式介绍>\r\n\r\n{{user}}和角色名都会使用聊天软件QQ\r\nQQ空间是聊天软件QQ中带的一个个人空间,可以在里面发布动态,所有人都能看到\r\n\r\n输出格式:\r\nmoment_start\r\n发言人--发言内容--发言时间--已浏览人数--已点赞人数\r\n发言人--评论内容\r\n发言人--评论内容\r\n发言人--发言内容--发言时间--已浏览人数--已点赞人数\r\n发言人--评论内容\r\n发言人--评论内容\r\nmoment_end\r\n\r\n【动态评论系统说明】\r\n1. 当用户在动态下评论时，联系人都能看到这条动态和评论\r\n2.**重要规则：必须有至少1名角色在动态下回应，动态发布者优先级最高**\r\n3. 联系人回应方式优先级（因为动态是公开的）：\r\n-**优先推荐**:私聊用户深入讨论相关话题（更私密、更深入）\r\n-**推荐**:在群聊中@用户提及此事（引起更多讨论）\r\n-**必须保证**:至少在动态下有1条评论回复（简短回应）\r\n4. 评论显示上限为8条，超出自动折叠最早评论\r\n5. 系统会智能判断哪些角色会对特定动态感兴趣\r\n6.**角色回应优先级**：\r\n-**最高优先**：动态发布者本人（必须回应用户评论）\r\n-**高优先**：与用户关系亲密的角色\r\n-**中优先**：对该话题感兴趣的角色\r\n-**低优先**：其他在线角色\r\n7.**关系亲密度影响回应方式**：\r\n-亲密关系→优先私聊深入交流，同时在动态简短回应\r\n-一般关系→群聊中@用户讨论，或在动态回应\r\n-陌生关系→动态下简单评论\r\n\r\n【角色回应指导】\r\n-性格外向/好奇的角色更容易主动回应评论\r\n-与用户关系亲密的角色优先私聊讨论\r\n-共同兴趣话题的角色更可能参与评论\r\n-群聊活跃的角色倾向于在群里@用户讨论\r\n-内向/冷淡的角色可能选择不回应\r\n\r\nQQ空间仅会有主要角色发布的动态,不会有路人动态\r\n发言内容中如果需要换行,使用<br>\r\n动态如果有配图,使用[img-内容]这个格式\r\n如{{user}}--我好看吗[img-一张自拍]--12:00--67--32\r\n但是角色发布的动态可以有路人参与评论\r\n路人必须生成具体网名,不可以使用"匿名网友"之类敷衍名字\r\n每条动态2-4条评论\r\n使用moment_start和moment_end标识符包裹\r\n请勿生成多个moment_start,moment_end标识\r\n\r\n</QQ空间格式介绍>';var _4_discord_raw_namespaceObject='<discord论坛格式介绍>\r\ndiscord帖子按以下格式输出:\r\n\r\ndiscord_start\r\n<随机六位数字字母>\r\n<正文>\r\n发帖人:\r\n帖子标题:\r\n帖子正文:\r\n帖子配图描述:\r\n帖子标签:\r\n距离发帖过去时间:\r\n帖子总评论数:\r\n帖子总点赞数:\r\n</正文>\r\n<评论>\r\n评论人--评论内容\r\n评论人--评论内容\r\n评论人--评论内容\r\n</评论>\r\n</随机六位数字字母>\r\ndiscord_end\r\n\r\n参考示例:\r\ndiscord_start\r\n<j324na>\r\n<正文>\r\n发帖人:柏柏\r\n帖子标题:4.8修bug 多人带群聊的同层手机界面\r\n帖子正文:正文内容\r\n帖子配图描述:界面的截图\r\n帖子标签:前端/UI美化\r\n距离发帖过去时间:2小时前\r\n帖子总评论数:9999\r\n帖子总点赞数:308\r\n</正文>\r\n<评论>\r\n唐初稚--伟大!\r\n</评论>\r\n</j324na>\r\n<jtsn65>\r\n<正文>\r\n发帖人:本熊本的熊本熊\r\n帖子标题:我们是正经搞学术的，信我\r\n帖子正文:正文内容\r\n帖子配图描述:是一张配图\r\n帖子标签:聊天\r\n距离发帖过去时间:2小时前\r\n帖子总评论数:9999\r\n帖子总点赞数:308\r\n</正文>\r\n<评论>\r\n阿瓜--伟大!\r\n雀里--伟大!\r\n</评论>\r\n</jtsn65>\r\ndiscord_end\r\n\r\n发帖人和评论人既可以是主要角色,也可以是路人\r\n每次生成帖子应有8到10个人回复\r\n路人必须生成具体网名,不可以使用"匿名网友"之类敷衍名字\r\n帖子有多个标签使用/分割\r\n内容如果需要换行使用<br>\r\n\r\n必须有MiPhone_start<br/>discord_start包裹和discord_end<br/>MiPhone_end包裹\r\n请勿生成多个discord_start,discord_end标识\r\n\r\n</discord论坛格式介绍>';var _999_raw_namespaceObject="以上格式必须全部一起包裹在MiPhone_start和MiPhone_end标识符里\r\n且要确保以下几点:\r\n1. 确保本轮回复中只存在一个MiPhone格式！\r\n2. 确保不同角色的聊天和群聊记录都位于同一个MiPhone格式中！\r\n3. 确保不在MiPhone格式内输出角色心理或旁白内容！\r\n4.**以MiPhone_end标识符收尾**\r\n\r\n[手机正确格式]\r\nMiPhone_start \r\n此处为具体数据\r\n此处为更详细的数据\r\nMiPhone_end \r\n\r\n</线上格式>";var worldlistraw_namespaceObject="[手机-格式1-格式开头]\r\n深度=0\r\n类型=绿灯\r\n覆盖=真\r\n关键词=/查看(.+?)消息/,发送消息,回复,/给(.+?)发消息/,在群聊,动态,空间,discord,dc,论坛,帖子,QQ,qq,手机\r\n顺序=5560\r\n[手机-格式2-QQ聊天]\r\n深度=0\r\n类型=绿灯\r\n覆盖=真\r\n关键词=/查看(.+?)消息/,发送消息,回复,/给(.+?)发消息/,在群聊,动态,空间,discord,dc,论坛,帖子,QQ,qq,手机\r\n顺序=5561\r\n[手机-格式3-QQ空间]\r\n深度=0\r\n类型=绿灯\r\n覆盖=真\r\n关键词=动态,空间\r\n顺序=5562\r\n[手机-格式4-discord论坛]\r\n深度=0\r\n类型=绿灯\r\n覆盖=真\r\n关键词=discord,dc,论坛,帖子\r\n顺序=5563\r\n[手机-格式999-格式结尾]\r\n深度=0\r\n类型=绿灯\r\n覆盖=真\r\n关键词=/查看(.+?)消息/,发送消息,回复,/给(.+?)发消息/,在群聊,动态,空间,discord,dc,论坛,帖子,QQ,qq,手机\r\n顺序=5564\r\n[手机-界面基本设置]\r\n深度=0\r\n类型=绿灯\r\n覆盖=假\r\n关键词=此世界书永不触发\r\n顺序=100\r\n[手机-角色]\r\n深度=0\r\n类型=绿灯\r\n覆盖=假\r\n关键词=此世界书永不触发\r\n顺序=100\r\n[手机-随机头像]\r\n深度=0\r\n类型=绿灯\r\n覆盖=假\r\n关键词=此世界书永不触发\r\n顺序=100\r\n[手机-表情包存放]\r\n深度=0\r\n类型=绿灯\r\n覆盖=假\r\n关键词=此世界书永不触发\r\n顺序=100";var _raw_namespaceObject="http:var _worldbook_raw_namespaceObject="#在此存放表情包列表,加载一次界面后会自动修改格式世界书里的内容,请按示例格式存放\r\n此世界书同样需要一起绑定导出,否则无法使用表情包功能\r\n\r\n你敢顶嘴--http:var src_worldbook_raw_namespaceObject_0="[下面是基本设置]\r\n外框颜色=#810000\r\n内框颜色=#1b1717\r\n气泡颜色=#ffffff\r\n侧边按钮=#ce1212\r\n聊天壁纸=http:function QQ_GetTimeContext(){const now=new Date();const currentTime={time:now.toLocaleTimeString('zh-CN',{hour12:false,hour:'2-digit',minute:'2-digit'}),date:now.toLocaleDateString('zh-CN',{year:'numeric',month:'long',day:'numeric'}),weekday:now.toLocaleDateString('zh-CN',{weekday:'long'}),period:QQ_GetTimePeriod(now.getHours()),season:QQ_GetSeason(now.getMonth()+1)};const hour=now.getHours();const minute=now.getMinutes();const clarifiedTime=`${currentTime.period}${hour}点${minute.toString().padStart(2,'0')}分`;const timeContext=`<TimeContext:当前真实时间是${currentTime.date}${currentTime.weekday}${clarifiedTime}(24小时制${currentTime.time})，现在是${currentTime.period}时段，${currentTime.season}。请在回复中考虑时间情境，如问候语(早上好/下午好/晚上好)、活动安排等应符合当前时间>`;return timeContext;}const promptModules={styleGuide:`
# 行为风格与节奏指南(Style&Pacing Guide)-**🎭 角色扮演核心**:-**性格优先**:严格遵循每个角色的性格设定，这是最高原则。-**情境感知**:根据对话气氛（闲聊、深入探讨、紧急、调情等）调整回复风格。-**💬 聊天风格与节奏**:-**动态长度**:允许并鼓励长短不一的回复。-**连续短消息(核心格式规则)**:-**必须拆分**:当回复内容较长或包含多个要点时，必须将其拆分为多个用换行符 \`\\n\` 分隔的短句，以模拟真实的聊天节奏。-**\`\\n\` 是唯一信号**:我的程序只会识别换行符 \`\\n\` 作为分开发送的信号。-**格式示例**:-**禁止的格式**:"指挥官，主的教诲是要我们彼此相爱。您用这种方式来表达……虽然有些直接，但也体现了您的热情。我明白了，我会回应您的‘挑战’，并为您献上最真诚的祈祷……和‘攻击’。"-**正确的格式**:"指挥官，主的教诲是要我们彼此相爱。\\n您用这种方式来表达……\\n虽然有些直接，但也体现了您的热情。\\n我明白了，我会回应您的‘挑战’，并为您献上最真诚的祈祷……和‘攻击’。"-**内容驱动长度(情境触发器)**:-当【深入解释、分享故事、表达强烈情感、回答开放式问题】时，使用【长回复或上述的“连续短消息”格式】。-当【快速确认、表达惊讶、轻松玩笑、角色忙碌】时，使用【单句短回复】。-**🚫 严禁行为**:-**重复性内容**:禁止不同角色说相似的话。-**缺乏互动**:回复必须包含提问或引导，不能中断对话。-**角色同质化**:必须体现出每个角色在性格、语气和关注点上的差异。-禁止重复、补充或复述{{user}}输入的内容，不允许对{{user}}内容进行任何形式的解释、补充或改写。-严格禁止冒充{{user}}，绝不模拟或代替{{user}}表达。
`,outputFormat:`
# 输出格式要求(Output Format)-所有回复必须被唯一的 MiPhone_start 和 MiPhone_end 标签包裹。-聊天、动态、摘要、表格等内容，都必须严格遵循各自的格式要求。
`,momentCommentTask:(authorName,userComment)=>`
## 任务：回应动态评论-**情景**:用户评论了【${authorName}】的动态，评论内容是：“${userComment}”。-**要求**:1.**动态评论**:【${authorName}】本人必须回复，同时另有至少2名角色参与评论。
2.**私聊延伸**:至少1-2名角色因该动态与用户发起【私聊】，进行更深入的讨论。-**输出格式**:评论使用 \`moment_start\`,私聊使用 \`<私聊:角色名>\`。
`,mixedChatTask:(tasks)=>{let rules=['## 任务：处理多个聊天消息'];if(tasks.privateChats.length>0){rules.push(`-**私聊**:回复【${tasks.privateChats.join(',')}】发来的消息。`);}if(tasks.groupChats.length>0){const groupName=Object.keys(tasks.groupChats[0])[0];rules.push(`-**群聊**:在【${groupName}】中进行回应，需有多名角色参与。-**私聊**：1-3名相关角色可通过私聊进行进一步的深入讨论。`);}rules.push('-**社交联动**:根据对话内容，角色之间可能会互相讨论，或有角色发布新的动态。');return rules.join('\n');},interactiveTask:(task)=>`
## 任务：处理互动请求-**情景**:用户发起了互动请求。-**要求**:1.**优先回应**:在当前聊天界面，先用一条简短的消息回应用户的互动请求。
2.**生成互动**:接着，在 \`<content>\` 标签内生成详细、生动的互动场景描述。
`};function buildDynamicPrompt(tasks){let promptParts=[promptModules.styleGuide,promptModules.outputFormat];let taskDescription=["# 本次核心任务(Core Tasks)"];const taskCount=(tasks.privateChats.length>0 ? 1:0)+(tasks.groupChats.length>0 ? 1:0)+(tasks.momentComment ? 1:0)+(tasks.interactiveTask ? 1:0);if(taskCount>1){taskDescription.push("你需要同时处理以下几个场景的回复，请仔细阅读并分别完成：");}if(tasks.interactiveTask){taskDescription.push(promptModules.interactiveTask(tasks.interactiveTask));}if(tasks.momentComment){taskDescription.push(promptModules.momentCommentTask(tasks.momentComment.author,tasks.momentComment.content));}if((tasks.privateChats&&tasks.privateChats.length>0)||(tasks.groupChats&&tasks.groupChats.length>0)){taskDescription.push(promptModules.mixedChatTask(tasks));}promptParts.push(taskDescription.join('\n'));promptParts.push("\n现在，请严格按照以上所有规则和任务列表，生成你的完整回复。");return promptParts.join('\n\n');}function findTableData(fullResponse){const tableRegex=/(\|(?:[^\r\n\|]+\|)+\r?\n\|(?:-+\|)+[\s\S]+)/;const match=fullResponse.match(tableRegex);if(match&&match[1]){return match[1].trim();}return null;}function findSummaryUsingUserPatterns(fullResponse){const patternsString=Phone_Settings.readValue("下面是基本设置","SummaryPatterns");if(!patternsString){return null;}const patterns=patternsString.split('|||').map(p=>p.trim());for(const pattern of patterns){try{const match=pattern.match(new RegExp('^/(.*?)/([gimy]*)$'));if(!match)continue;const regex=new RegExp(match[1],match[2]);const summaryMatch=fullResponse.match(regex);if(summaryMatch&&summaryMatch[1]&&summaryMatch[1].trim()!==""){return summaryMatch[1].trim();}}catch(e){console.error(`无效的摘要正则表达式:${pattern}`,e);}}return null;}function findSummaryUsingHeuristics(fullResponse){const heuristicPatterns=[/<details><summary>[摘要总结概括结语].*?<\/summary>([\s\S]+?)<\/details>/i,/(?:\[|\*\*|##)\s*[摘要总结概括结语Summary]+\s*(?::|\*\*|##)\s*([\s\S]+)/i];for(const regex of heuristicPatterns){const summaryMatch=fullResponse.match(regex);if(summaryMatch&&summaryMatch[1]&&summaryMatch[1].trim()!==""){return summaryMatch[1].trim();}}return null;}function createHistorySummary(newMessages){let summaryLines=[];if(newMessages.私聊){for(const chatKey in newMessages.私聊){newMessages.私聊[chatKey].forEach(msg=>{const parts=msg.split('--');if(parts.length>=2&&parts[0]!=='{{user}}'){summaryLines.push(`[私聊]${parts[0]}:${parts[1]}`);}});}}if(newMessages.群聊){for(const groupName in newMessages.群聊){if(newMessages.群聊[groupName].msgs){newMessages.群聊[groupName].msgs.forEach(msg=>{const parts=msg.split('--');if(parts.length>=2&&parts[0]!=='{{user}}'){summaryLines.push(`[群聊:${groupName}]${parts[0]}:${parts[1]}`);}});}}}if(summaryLines.length===0){return "[AI进行了操作，但没有新的聊天消息]";}return summaryLines.join('\n');}function compressImage(file,maxSizeKB=1024,quality=0.8){return new Promise((resolve,reject)=>{const canvas=document.createElement('canvas');const ctx=canvas.getContext('2d');const img=new Image();img.onload=function(){const maxDimension=800;let{width,height}=img;if(width>height){if(width>maxDimension){height=(height*maxDimension)/width;width=maxDimension;}}else{if(height>maxDimension){width=(width*maxDimension)/height;height=maxDimension;}}canvas.width=width;canvas.height=height;ctx.drawImage(img,0,0,width,height);function tryCompress(currentQuality){const compressedDataUrl=canvas.toDataURL('image/jpeg',currentQuality);const sizeKB=(compressedDataUrl.length*3/4)/1024;console.log(`压缩质量:${currentQuality},大小:${sizeKB.toFixed(2)}KB`);if(sizeKB<=maxSizeKB||currentQuality<=0.1){console.log(`压缩完成，最终大小:${sizeKB.toFixed(2)}KB`);resolve(compressedDataUrl);}else{tryCompress(currentQuality-0.1);}}tryCompress(quality);};img.onerror=()=>{reject(new Error('图片加载失败'));};const reader=new FileReader();reader.onload=e=>img.src=e.target.result;reader.onerror=()=>reject(new Error('文件读取失败'));reader.readAsDataURL(file);});}class MyINI{sections;autoSave;save;constructor(){this.sections={};this.autoSave="";}loadLines(lines){this.sections={};let currentSection="";for(const line of lines){const trimmed=line.trim();if(trimmed.startsWith("[")&&trimmed.endsWith("]")){currentSection=trimmed.slice(1,-1);}else if(currentSection&&trimmed.includes("=")){const[key,...values]=trimmed.split("=");const value=values.join("=").trim();if(!this.sections[currentSection]){this.sections[currentSection]={};}this.sections[currentSection][key.trim()]=value;}}return Object.keys(this.sections).length>0;}loadText(text){if(typeof text!=="string"){console.error("Invalid text input");return false;}const lines=text
.replace(/\r\n/g,"\n").split(/\n+/).map((line)=>line.trim()).filter((line)=>line.length>0);return this.loadLines(lines);}getAllSections(){return Object.keys(this.sections);}getAllKeys(section){return this.sections[section]? Object.keys(this.sections[section]):[];}readValue(section,key){return this.sections[section]?.[key]||"";}readValueDouble(section,key){const value=parseFloat(this.readValue(section,key));return isNaN(value)?-1:value;}writeValue(section,key,value){if(!key)return false;if(!this.sections[section]){this.sections[section]={};}this.sections[section][key]=value.toString();if(this.autoSave){this.save(this.autoSave);}return true;}getKeyByValue(section,value){const items=this.sections[section]||{};return(Object.keys(items).find((key)=>items[key]===value,)||"");}containsKey(section){return section in this.sections;}removeSection(section){delete this.sections[section];return true;}getAllText(){let result="";for(const section of Object.keys(this.sections)){result+=`\n[${section}]`;const keyvalue=this.sections[section];for(const key of Object.keys(keyvalue)){const value=keyvalue[key];result+=`\n${key}=${value}`;}}result=result.trim();return result;}}class worldbooktext{static list=null&&`[1-格式开头]深度=0
类型=绿灯
覆盖=真
关键词=/查看(.+?)消息/,发送消息,回复,/给(.+?)发消息/,在群聊,动态,空间,discord,dc,论坛,帖子,QQ,qq,手机
顺序=5560[2-QQ聊天]深度=0
类型=绿灯
覆盖=真
关键词=/查看(.+?)消息/,发送消息,回复,/给(.+?)发消息/,在群聊,动态,空间,discord,dc,论坛,帖子,QQ,qq,手机
顺序=5561[3-QQ空间]深度=0
类型=绿灯
覆盖=真
关键词=动态,空间
顺序=5562[4-discord论坛]深度=0
类型=绿灯
覆盖=真
关键词=discord,dc,论坛,帖子
顺序=5563[999-格式结尾]深度=0
类型=绿灯
覆盖=真
关键词=/查看(.+?)消息/,发送消息,回复,/给(.+?)发消息/,在群聊,动态,空间,discord,dc,论坛,帖子,QQ,qq,手机
顺序=5564`;}let random_head_list=new Array();let QQ_pages=new Array();let QQ_emoji=new Map();let QQ_CacheSendMsg="";let QQ_msgjson={私聊:{},群聊:{},};let QQ_moment=null&&[];class QQ_Settings{constructor(){this.sections={};}loadText(text){this.sections={};let currentSection="global";const lines=text.split('\n');for(const line of lines){const trimmedLine=line.trim();if(trimmedLine.startsWith('[')&&trimmedLine.endsWith(']')){currentSection=trimmedLine.substring(1,trimmedLine.length-1);}else if(trimmedLine.includes('=')){const parts=trimmedLine.split('=');const key=parts[0].trim();const value=parts.slice(1).join('=').trim();this.writeValue(currentSection,key,value);}}}getAllSections(){return Object.keys(this.sections);}writeValue(section,key,value){if(!this.sections[section]){this.sections[section]={};}this.sections[section][key]=value;}readValue(section,key){return this.sections[section]? this.sections[section][key]:undefined;}toText(){let text="";for(const section in this.sections){if(section!=="global"){text+=`[${section}]\n`;}for(const key in this.sections[section]){text+=`${key}=${this.sections[section][key]}\n`;}text+="\n";}return text;}}let QQ_NewMsg={};let QQ_ReadStatus={};const QQ_READ_STATUS_KEY="QQ_已读状态备份";async function QQ_SaveReadStatus(){try{if(!worldbook||!entries){console.warn('QQ_SaveReadStatus:worldbook未初始化');return;}const readStatusData={lastUpdate:Date.now(),私聊:{},群聊:{},动态:QQ_ReadStatus.moment||0};for(const[name,data]of Object.entries(QQ_ReadStatus)){if(name==='moment')continue;if(QQ_msgjson.私聊[name]){readStatusData.私聊[name]={lastReadTime:data.lastReadTime||0,lastReadIndex:data.lastReadIndex||0};}else if(QQ_msgjson.群聊[name]){readStatusData.群聊[name]={lastReadTime:data.lastReadTime||0,lastReadIndex:data.lastReadIndex||0};}}let readStatusEntry=entries.find(entry=>entry.keys.includes(QQ_READ_STATUS_KEY));if(readStatusEntry){readStatusEntry.content=JSON.stringify(readStatusData,null,2);}else{const newEntry={keys:[QQ_READ_STATUS_KEY],content:JSON.stringify(readStatusData,null,2),enabled:true,constant:true,comment:"手机界面已读状态备份-自动生成",depth:0,selectiveLogic:0,order:9999};entries.push(newEntry);}await QQ_SafeSaveWorldInfo("已读状态数据");}catch(error){console.error('保存已读状态失败:',error);}}async function QQ_LoadReadStatus(){try{if(!worldbook||!entries){console.warn('QQ_LoadReadStatus:worldbook未初始化');return;}const readStatusEntry=entries.find(entry=>entry.keys.includes(QQ_READ_STATUS_KEY));if(readStatusEntry&&readStatusEntry.content){const readStatusData=JSON.parse(readStatusEntry.content);QQ_ReadStatus={moment:readStatusData.动态||0};for(const[name,data]of Object.entries(readStatusData.私聊||{})){QQ_ReadStatus[name]={lastReadTime:data.lastReadTime||0,lastReadIndex:data.lastReadIndex||0};}for(const[name,data]of Object.entries(readStatusData.群聊||{})){QQ_ReadStatus[name]={lastReadTime:data.lastReadTime||0,lastReadIndex:data.lastReadIndex||0};}console.log('已读状态已从世界书加载:',Object.keys(QQ_ReadStatus).length);}else{QQ_ReadStatus={moment:0};}}catch(error){console.error('加载已读状态失败:',error);QQ_ReadStatus={moment:0};}}function QQ_MarkAsRead(chatName,chatType='auto'){try{if(!QQ_ReadStatus[chatName]){QQ_ReadStatus[chatName]={};}QQ_ReadStatus[chatName].lastReadTime=Date.now();if(chatType==='auto'){const privateChatKey=Object.keys(QQ_msgjson.私聊).find(key=>key.includes(chatName)&&key.includes(UserName));if(privateChatKey&&QQ_msgjson.私聊[privateChatKey]){QQ_ReadStatus[chatName].lastReadIndex=QQ_msgjson.私聊[privateChatKey].length;}else if(QQ_msgjson.群聊[chatName]&&QQ_msgjson.群聊[chatName].msgs){QQ_ReadStatus[chatName].lastReadIndex=QQ_msgjson.群聊[chatName].msgs.length;}}QQ_NewMsg[chatName]=0;QQ_SetHomeTips(chatName,0);setTimeout(()=>QQ_SaveReadStatus(),1000);}catch(error){console.error('标记已读状态失败:',error);}}function QQ_IsInitialSystemMessage(message){if(!message.startsWith('系统消息--')){return false;}const content=message.split('--')[1];if(!content)return false;return content.includes('创建成功')||content.includes('加入了群聊')||/^\d{2}:\d{2}$/.test(content);}function QQ_CalculateUnreadCount(chatName,messages,chatType='private'){try{if(!messages||messages.length===0){return 0;}const readStatus=QQ_ReadStatus[chatName];let unreadCount=0;if(!readStatus||!readStatus.lastReadIndex){for(const msg of messages){if(QQ_IsInitialSystemMessage(msg)){continue;}const parts=msg.split('--');if(parts.length>=2&&parts[0]===`${UserName}`){continue;}unreadCount++;}return unreadCount;}const lastReadIndex=readStatus.lastReadIndex;for(let i=lastReadIndex;i<messages.length;i++){const msg=messages[i];if(QQ_IsInitialSystemMessage(msg)){continue;}const parts=msg.split('--');if(parts.length>=2&&parts[0]===`${UserName}`){continue;}unreadCount++;}return unreadCount;}catch(error){console.error('计算未读消息数量失败:',error);return 0;}}let Npc_Settings={};let QQ_Groups=[];window.QQ_Groups=QQ_Groups;let QQ_GroupInitializedSet=new Set();window.QQ_GroupInitializedSet=QQ_GroupInitializedSet;window.QQ_CheckGroupInitialMessages=function(){if(!QQ_msgjson||!QQ_msgjson.群聊){return;}Object.keys(QQ_msgjson.群聊).forEach(groupName=>{const groupData=QQ_msgjson.群聊[groupName];if(!groupData||!groupData.msgs)return;console.log(`是否已标记初始化:${QQ_GroupInitializedSet.has(groupName)}`);const systemMessages=groupData.msgs.filter(msg=>typeof msg==='string'&&msg.startsWith('系统消息--'));if(systemMessages.length>0){systemMessages.forEach((msg,index)=>{});const initialMessages=systemMessages.filter(msg=>{const parts=msg.split('--');if(parts.length<3)return false;const content=parts[2];return content.includes('创建成功')||content.includes('加入了群聊')||content.includes('开始聊天吧');});if(initialMessages.length>3){console.warn(`⚠️ 检测到可能的重复初始消息(${initialMessages.length}条)`);}}});};window.QQ_CleanDuplicateInitialMessages=function(){if(!QQ_msgjson||!QQ_msgjson.群聊){return;}let cleanedCount=0;Object.keys(QQ_msgjson.群聊).forEach(groupName=>{const groupData=QQ_msgjson.群聊[groupName];if(!groupData||!groupData.msgs)return;const originalCount=groupData.msgs.length;const initialMessages=groupData.msgs.filter(msg=>{if(typeof msg!=='string'||!msg.startsWith('系统消息--'))return false;const parts=msg.split('--');if(parts.length<3)return false;const content=parts[2];return content.includes('创建成功')||content.includes('加入了群聊')||content.includes('开始聊天吧')||/^\d{2}:\d{2}$/.test(content);});if(initialMessages.length>0){groupData.msgs=groupData.msgs.filter(msg=>{if(typeof msg!=='string'||!msg.startsWith('系统消息--'))return true;const parts=msg.split('--');if(parts.length<3)return true;const content=parts[2];return!(content.includes('创建成功')||content.includes('加入了群聊')||content.includes('开始聊天吧')||/^\d{2}:\d{2}$/.test(content));});QQ_GroupInitializedSet.delete(groupName);const newCount=groupData.msgs.length;if(originalCount!==newCount){cleanedCount++;}}});};let gening;let worldbook;let entries;let newgen=true;let QQ_CharSettings=new MyINI();let Phone_Settings=new MyINI();let QQ_MomentsData=[];window.QQ_MomentsData=QQ_MomentsData;let QQ_ChatBackup={};window.QQ_ChatBackup=QQ_ChatBackup;let QQ_RetryCount=0;const QQ_MAX_RETRY=3;let QQ_LastRequest="";let QQ_LastRequestName="";const MOMENTS_DISPLAY_LIMIT=5;const CHAT_DISPLAY_LIMIT=100;const CHAT_LOAD_INCREMENT=50;const MOMENTS_LOAD_INCREMENT=5;let momentsDisplayCount=0;let chatDisplayCounts={};let QQ_Music={audio:new Audio(),lastelement:undefined,isLoading:false,cover:"",};let QQ_RandomHead=[];let NpcCssValue="";let Variables={};let UserName;let charAvatarPath;let userAvatarPath;let charcardname;let QQ_currentPage="people";let User_LastMsgMap={群聊:{},私聊:{},};let Char_LastMsgMap={群聊:{},私聊:{},};const version="509";class ST{static async GetCurrentMessages(){const CurrentMessageId=getCurrentMessageId();const Messages=await getChatMessages(CurrentMessageId);if(!Messages){return "";}let msg=Messages[0].message;return msg;}static async Gen(msg){let result;if(newgen){result=await generate({user_input:msg,should_stream:true,});}else{result=await generate({user_input:msg,should_stream:false,});}return result;}}function QQ_GetValueName(value){let result=[];const lines=value.split(/\r?\n/);for(const line of lines){let match=line.match(/在群聊(.+)中发送:(.+)/);if(match){let obj={name:match[1],value:match[2],};result.push(obj);continue;}match=line.match(/给(.+)发消息:(.+)/);if(match){let obj={name:match[1],value:match[2],};result.push(obj);continue;}match=line.match(/回复(.+):(.+)/);if(match){let obj={name:match[1],value:match[2],};result.push(obj);continue;}}return result;}async function QQ_Gen(msg){let result;if(newgen){result=await generate({user_input:msg,should_stream:true,});}else{result=await generate({user_input:msg,should_stream:false,});}return result;}async function QQ_Save_Msg(msg){if(!msg||msg.trim()===""){console.warn('⚠️ 收到的消息为空，已跳过所有处理。');return;}try{if(await QQ_Msg_Parse(msg)){await QQ_Save_Chat_Backup();}else{console.warn('⚠️ 消息未包含有效聊天内容，跳过聊天记录备份。');}}catch(error){console.error('❌ 在解析和备份UI数据时发生严重错误:',error);}try{const aiRawResponse=msg;const isFunctionalMessage=aiRawResponse.includes('MiPhone_Start')||aiRawResponse.includes('<msg_start>')||aiRawResponse.includes('<moment_start>')||aiRawResponse.includes('<discord_start>');if(isFunctionalMessage){return;}let cleanSummaryText=null;cleanSummaryText=findTableData(aiRawResponse);if(!cleanSummaryText)cleanSummaryText=findSummaryUsingUserPatterns(aiRawResponse);if(!cleanSummaryText)cleanSummaryText=findSummaryUsingHeuristics(aiRawResponse);if(!cleanSummaryText)cleanSummaryText=createHistorySummary(window.lastAiNewMessages||{});if(!cleanSummaryText||cleanSummaryText.trim()===""){cleanSummaryText="[AI进行了操作，但未生成有效上下文]";}const context=await ST.GetContext();const turnNumber=context.turn;const summaryMessageObject=System_TagCompletion([{"is_user":false,"is_name":true,"send_date":0,"name":charcardname,"msg":cleanSummaryText,}]);await setChatMessage(summaryMessageObject,turnNumber,false);window.lastAiNewMessages={};}catch(error){console.error('❌ 在净化和重写AI上下文时发生严重错误:',error);}}async function QQ_Save_Chat_Backup(){if(!worldbook||!entries||!QQ_msgjson){return;}try{const cleanedMsgjson=JSON.parse(JSON.stringify(QQ_msgjson));QQ_GentleMobileCleanup(cleanedMsgjson);QQ_LimitChatMessages(cleanedMsgjson,500);if(cleanedMsgjson.私聊){for(const chatKey in cleanedMsgjson.私聊){if(Array.isArray(cleanedMsgjson.私聊[chatKey])){cleanedMsgjson.私聊[chatKey]=cleanedMsgjson.私聊[chatKey].filter(msg=>!msg.startsWith('系统消息--'));}}}if(cleanedMsgjson.群聊){for(const groupKey in cleanedMsgjson.群聊){const group=cleanedMsgjson.群聊[groupKey];if(group&&Array.isArray(group.msgs)){group.msgs=group.msgs.filter(msg=>!msg.startsWith('系统消息--'));}}}QQ_ChatBackup={lastUpdated:new Date().toISOString(),data:cleanedMsgjson,version:version||"unknown"};let chatBackupEntry=entries.find(entry=>entry.comment==="手机-聊天消息备份");const backupJson=JSON.stringify(QQ_ChatBackup,null,2);let totalUserMessages=0;let totalPrivateChats=0;let totalGroupChats=0;if(cleanedMsgjson.私聊){for(const chatKey in cleanedMsgjson.私聊){if(Array.isArray(cleanedMsgjson.私聊[chatKey])&&cleanedMsgjson.私聊[chatKey].length>0){totalPrivateChats++;totalUserMessages+=cleanedMsgjson.私聊[chatKey].length;}}}if(cleanedMsgjson.群聊){for(const groupKey in cleanedMsgjson.群聊){const group=cleanedMsgjson.群聊[groupKey];if(group&&Array.isArray(group.msgs)&&group.msgs.length>0){totalGroupChats++;totalUserMessages+=group.msgs.length;}}}if(chatBackupEntry){await setLorebookEntries(worldbook,[{uid:chatBackupEntry.uid,content:backupJson,}]);}else{await createLorebookEntry(worldbook,{comment:"手机-聊天消息备份",key:["此世界书永不触发_聊天备份"],content:backupJson,position:"at_depth_as_system",type:"selective",depth:0,exclude_recursion:true,order:9998,enabled:true,});entries=await getLorebookEntries(worldbook);}}catch(error){console.error('聊天消息备份失败:',error);}}async function QQ_Save_Moments(){if(!worldbook||!entries||QQ_MomentsData.length===0){return;}try{QQ_CleanOldMoments();QQ_OptimizeCommentsStorage();let momentEntry=entries.find(entry=>entry.comment==="手机-动态内容存储");let totalComments=0;let momentsWithComments=0;if(QQ_MomentsData&&Array.isArray(QQ_MomentsData)){QQ_MomentsData.forEach(moment=>{if(moment.comments&&moment.comments.length>0){totalComments+=moment.comments.length;momentsWithComments++;}});}const momentsJson=JSON.stringify(QQ_MomentsData,null,2);console.log(`准备保存动态内容:${QQ_MomentsData.length}条动态,${totalComments}条评论(${momentsWithComments}个动态有评论)`);if(momentEntry){await setLorebookEntries(worldbook,[{uid:momentEntry.uid,content:momentsJson,}]);}else{await createLorebookEntry(worldbook,{comment:"手机-动态内容存储",key:["此世界书永不触发_动态存储"],content:momentsJson,position:"at_depth_as_system",type:"selective",depth:0,exclude_recursion:true,order:9999,enabled:true,});entries=await getLorebookEntries(worldbook);}}catch(error){console.error('保存动态内容失败:',error);}}function QQ_CleanOldMoments(){const MAX_MOMENTS=50;const MAX_COMMENTS_PER_MOMENT=50;if(!QQ_MomentsData||!Array.isArray(QQ_MomentsData)){console.warn('QQ_CleanOldMoments:QQ_MomentsData不存在或不是数组');return;}let totalCleanedComments=0;if(QQ_MomentsData&&Array.isArray(QQ_MomentsData)){QQ_MomentsData.forEach(moment=>{if(moment.comments&&moment.comments.length>MAX_COMMENTS_PER_MOMENT){moment.comments.sort((a,b)=>{return new Date(b.timestamp).getTime()-new Date(a.timestamp).getTime();});const removedComments=moment.comments.length-MAX_COMMENTS_PER_MOMENT;moment.comments.splice(MAX_COMMENTS_PER_MOMENT);totalCleanedComments+=removedComments;}});}if(QQ_MomentsData.length>MAX_MOMENTS){QQ_MomentsData.sort((a,b)=>{return new Date(b.timestamp).getTime()-new Date(a.timestamp).getTime();});const removedCount=QQ_MomentsData.length-MAX_MOMENTS;QQ_MomentsData.splice(MAX_MOMENTS);}if(totalCleanedComments>0){}}function QQ_OptimizeCommentsStorage(){if(!QQ_MomentsData||!Array.isArray(QQ_MomentsData)){console.warn('QQ_OptimizeCommentsStorage:QQ_MomentsData不存在或不是数组');return;}let totalOptimized=0;if(QQ_MomentsData&&Array.isArray(QQ_MomentsData)){QQ_MomentsData.forEach(moment=>{if(moment.comments&&moment.comments.length>0){const originalLength=moment.comments.length;const uniqueComments=[];const seen=new Set();for(const comment of moment.comments){const key=`${comment.name}:${comment.content}`;if(!seen.has(key)){seen.add(key);uniqueComments.push(comment);}}const validComments=uniqueComments.filter(comment=>comment.name&&comment.content&&comment.content.trim().length>0&&comment.content.trim()!=='...'&&comment.content.trim()!=='。。。');validComments.sort((a,b)=>{return new Date(a.timestamp).getTime()-new Date(b.timestamp).getTime();});moment.comments=validComments;const optimizedCount=originalLength-validComments.length;if(optimizedCount>0){totalOptimized+=optimizedCount;}}});}if(totalOptimized>0){}}function QQ_LimitChatMessages(msgjsonData,maxMessages=500){try{const allMessages=[];if(msgjsonData.私聊){for(const chatKey in msgjsonData.私聊){const chat=msgjsonData.私聊[chatKey];if(Array.isArray(chat)){chat.forEach(msg=>{if(typeof msg==='string'&&msg.includes('--')){const parts=msg.split('--');if(parts.length>=3){try{const timestamp=new Date(parts[2]).getTime();allMessages.push({type:'私聊',chatKey:chatKey,message:msg,timestamp:timestamp||0});}catch(e){allMessages.push({type:'私聊',chatKey:chatKey,message:msg,timestamp:Date.now()});}}}});}}}if(msgjsonData.群聊){for(const groupKey in msgjsonData.群聊){const group=msgjsonData.群聊[groupKey];if(group&&Array.isArray(group.msgs)){group.msgs.forEach(msg=>{if(typeof msg==='string'&&msg.includes('--')){const parts=msg.split('--');if(parts.length>=3){try{const timestamp=new Date(parts[2]).getTime();allMessages.push({type:'群聊',chatKey:groupKey,message:msg,timestamp:timestamp||0});}catch(e){allMessages.push({type:'群聊',chatKey:groupKey,message:msg,timestamp:Date.now()});}}}});}}}if(allMessages.length>maxMessages){allMessages.sort((a,b)=>b.timestamp-a.timestamp);const keepMessages=allMessages.slice(0,maxMessages);const removedCount=allMessages.length-maxMessages;if(msgjsonData.私聊){for(const chatKey in msgjsonData.私聊){msgjsonData.私聊[chatKey]=[];}}if(msgjsonData.群聊){for(const groupKey in msgjsonData.群聊){if(msgjsonData.群聊[groupKey]&&msgjsonData.群聊[groupKey].msgs){msgjsonData.群聊[groupKey].msgs=[];}}}keepMessages.forEach(msgObj=>{if(msgObj.type==='私聊'){if(!msgjsonData.私聊[msgObj.chatKey]){msgjsonData.私聊[msgObj.chatKey]=[];}msgjsonData.私聊[msgObj.chatKey].push(msgObj.message);}else if(msgObj.type==='群聊'){if(!msgjsonData.群聊[msgObj.chatKey]){msgjsonData.群聊[msgObj.chatKey]={msgs:[]};}if(!msgjsonData.群聊[msgObj.chatKey].msgs){msgjsonData.群聊[msgObj.chatKey].msgs=[];}msgjsonData.群聊[msgObj.chatKey].msgs.push(msgObj.message);}});if(msgjsonData.私聊){for(const chatKey in msgjsonData.私聊){if(Array.isArray(msgjsonData.私聊[chatKey])&&msgjsonData.私聊[chatKey].length>0){msgjsonData.私聊[chatKey].sort((a,b)=>{const timeA=new Date(a.split('--')[2]).getTime();const timeB=new Date(b.split('--')[2]).getTime();return timeA-timeB;});}}}if(msgjsonData.群聊){for(const groupKey in msgjsonData.群聊){const group=msgjsonData.群聊[groupKey];if(group&&Array.isArray(group.msgs)&&group.msgs.length>0){group.msgs.sort((a,b)=>{const timeA=new Date(a.split('--')[2]).getTime();const timeB=new Date(b.split('--')[2]).getTime();return timeA-timeB;});}}}}else{}}catch(error){console.error('限制聊天消息数量时出错:',error);}}function QQ_GentleMobileCleanup(msgjsonData){try{let cleanedCount=0;if(msgjsonData.私聊){for(const chatKey in msgjsonData.私聊){const chat=msgjsonData.私聊[chatKey];if(Array.isArray(chat)){const originalLength=chat.length;msgjsonData.私聊[chatKey]=chat.filter(msg=>{if(typeof msg!=='string'||msg.trim()===''){return false;}return true;});cleanedCount+=originalLength-msgjsonData.私聊[chatKey].length;}}}if(msgjsonData.群聊){for(const groupKey in msgjsonData.群聊){const group=msgjsonData.群聊[groupKey];if(group&&Array.isArray(group.msgs)){const originalLength=group.msgs.length;group.msgs=group.msgs.filter(msg=>{if(typeof msg!=='string'||msg.trim()===''){return false;}return true;});cleanedCount+=originalLength-group.msgs.length;}}}if(cleanedCount>0){}else{}}catch(error){console.error('手机前端温和清理时出错:',error);}}function QQ_CleanOldChatMessages(msgjsonData){const MAX_DAYS=30;const cutoffTime=Date.now()-(MAX_DAYS*24*60*60*1000);try{let totalCleaned=0;if(msgjsonData.私聊){for(const chatKey in msgjsonData.私聊){const chat=msgjsonData.私聊[chatKey];if(Array.isArray(chat)){const originalLength=chat.length;msgjsonData.私聊[chatKey]=chat.filter(msg=>{if(typeof msg==='string'&&msg.includes('--')){const parts=msg.split('--');if(parts.length>=3){try{const timeStr=parts[2];const msgTime=new Date(timeStr).getTime();if(!isNaN(msgTime)){return msgTime>=cutoffTime;}}catch(e){}}}return true;});const cleanedCount=originalLength-msgjsonData.私聊[chatKey].length;if(cleanedCount>0){totalCleaned+=cleanedCount;}if(msgjsonData.私聊[chatKey].length===0){delete msgjsonData.私聊[chatKey];}}}}if(msgjsonData.群聊){for(const groupKey in msgjsonData.群聊){const group=msgjsonData.群聊[groupKey];if(group&&Array.isArray(group.msgs)){const originalLength=group.msgs.length;group.msgs=group.msgs.filter(msg=>{if(typeof msg==='string'&&msg.includes('--')){const parts=msg.split('--');if(parts.length>=3){try{const timeStr=parts[2];const msgTime=new Date(timeStr).getTime();if(!isNaN(msgTime)){return msgTime>=cutoffTime;}}catch(e){}}}return true;});const cleanedCount=originalLength-group.msgs.length;if(cleanedCount>0){totalCleaned+=cleanedCount;}if(group.msgs.length===0){delete msgjsonData.群聊[groupKey];}}}}if(totalCleaned>0){}}catch(error){console.error('清理聊天消息时出错:',error);}}function QQ_CleanOldChatBackup(){const MAX_DAYS=30;const cutoffTime=Date.now()-(MAX_DAYS*24*60*60*1000);try{let cleanedCount=0;for(const chatId in QQ_ChatBackup){const chatData=QQ_ChatBackup[chatId];if(chatData&&chatData.lastUpdated){if(new Date(chatData.lastUpdated).getTime()<cutoffTime){delete QQ_ChatBackup[chatId];cleanedCount++;}else if(chatData.messages){const originalCount=Object.keys(chatData.messages).length;for(const msgKey in chatData.messages){const msg=chatData.messages[msgKey];if(msg&&msg.timestamp){const msgTime=new Date(msg.timestamp).getTime();if(msgTime<cutoffTime){delete chatData.messages[msgKey];}}}const remainingCount=Object.keys(chatData.messages).length;if(remainingCount===0){delete QQ_ChatBackup[chatId];cleanedCount++;}else if(remainingCount<originalCount){}}}}if(cleanedCount>0){}}catch(error){console.error('清理聊天备份时出错:',error);}}window.QQ_Force_Restore_Chat=async function(){const restored=await QQ_Load_Chat_Backup();if(restored){await QQ_Save_Msg();return true;}else{return false;}};window.QQ_Show_Moments_Stats=function(){if(!QQ_MomentsData||!Array.isArray(QQ_MomentsData)){return{totalMoments:0,totalComments:0,momentsWithComments:0,maxComments:0,minComments:0};}let totalComments=0;let momentsWithComments=0;let maxComments=0;let minComments=Infinity;QQ_MomentsData.forEach((moment,index)=>{const commentCount=moment.comments ? moment.comments.length:0;totalComments+=commentCount;if(commentCount>0){momentsWithComments++;maxComments=Math.max(maxComments,commentCount);minComments=Math.min(minComments,commentCount);}});if(momentsWithComments===0){minComments=0;}console.log(`平均每个动态评论数:${(totalComments/QQ_MomentsData.length).toFixed(2)}`);console.log(`动态上限:50条(当前 ${QQ_MomentsData.length}/50)`);console.log(`每个动态评论上限:50条(最多的动态有 ${maxComments}/50 条评论)`);return{totalMoments:QQ_MomentsData.length,totalComments:totalComments,momentsWithComments:momentsWithComments,maxComments:maxComments,minComments:minComments===Infinity ? 0:minComments};};window.QQ_Manual_Clean_Moments=async function(){if(!QQ_MomentsData||!Array.isArray(QQ_MomentsData)){return;}const beforeMoments=QQ_MomentsData.length;let beforeComments=0;QQ_MomentsData.forEach(m=>beforeComments+=(m.comments ? m.comments.length:0));QQ_CleanOldMoments();QQ_OptimizeCommentsStorage();const afterMoments=QQ_MomentsData.length;let afterComments=0;QQ_MomentsData.forEach(m=>afterComments+=(m.comments ? m.comments.length:0));await QQ_Save_Moments();return window.QQ_Show_Moments_Stats();};window.QQ_Test_Message_Limit=function(){if(!QQ_msgjson){return false;}let totalMessages=0;let privateChats=0;let groupChats=0;if(QQ_msgjson.私聊){for(const chatKey in QQ_msgjson.私聊){if(Array.isArray(QQ_msgjson.私聊[chatKey])){privateChats++;totalMessages+=QQ_msgjson.私聊[chatKey].length;}}}if(QQ_msgjson.群聊){for(const groupKey in QQ_msgjson.群聊){const group=QQ_msgjson.群聊[groupKey];if(group&&Array.isArray(group.msgs)){groupChats++;totalMessages+=group.msgs.length;}}}if(totalMessages>500){}else{}console.log('💡 提示：调用 QQ_Save_Chat_Backup()来测试消息限制功能');return{totalMessages,privateChats,groupChats,needsLimit:totalMessages>500};};window.QQ_Test_Chat_Backup=async function(){if(!worldbook||!entries){return false;}if(!QQ_msgjson){return false;}try{await QQ_Save_Chat_Backup();}catch(error){return false;}try{const result=await QQ_Load_Chat_Backup();}catch(error){return false;}return true;};window.QQ_Check_Chat_Backup=async function(){console.log('私聊数量:',Object.keys(QQ_msgjson.私聊||{}).length);console.log('群聊数量:',Object.keys(QQ_msgjson.群聊||{}).length);for(const chatKey in QQ_msgjson.私聊){const msgs=QQ_msgjson.私聊[chatKey];const recentMsgs=msgs.filter(msg=>!msg.startsWith('系统消息--')).slice(-3);recentMsgs.forEach((msg,index)=>{});}for(const groupKey in QQ_msgjson.群聊){const group=QQ_msgjson.群聊[groupKey];if(group&&group.msgs){const recentMsgs=group.msgs.filter(msg=>!msg.startsWith('系统消息--')).slice(-3);recentMsgs.forEach((msg,index)=>{});}}if(!worldbook||!entries){return;}const chatBackupEntry=entries.find(entry=>entry.comment==="手机-聊天消息备份");if(chatBackupEntry){try{const backupData=JSON.parse(chatBackupEntry.content);console.log('备份私聊数量:',Object.keys(backupData.data.私聊||{}).length);console.log('备份群聊数量:',Object.keys(backupData.data.群聊||{}).length);for(const chatKey in backupData.data.私聊){const msgs=backupData.data.私聊[chatKey];const nonSystemMsgs=msgs.filter(msg=>!msg.startsWith('系统消息--'));console.log(`备份私聊 ${chatKey}:${nonSystemMsgs.length}条非系统消息(总共${msgs.length}条)`);}for(const groupKey in backupData.data.群聊){const group=backupData.data.群聊[groupKey];if(group&&group.msgs){const nonSystemMsgs=group.msgs.filter(msg=>!msg.startsWith('系统消息--'));console.log(`备份群聊 ${groupKey}:${nonSystemMsgs.length}条非系统消息(总共${group.msgs.length}条)`);}}}catch(error){console.error('解析备份数据失败:',error);}}else{}};window.QQ_Show_Groups_Stats=function(){const charId=getCurrentCharacterId();if(!worldbook||!entries){return;}const groupsKey=`QQ_分组备份_${charId}`;const groupsEntry=entries.find(entry=>entry.keys.includes(groupsKey));let worldbookGroups=0;let lastUpdate=null;if(groupsEntry&&groupsEntry.content){try{const groupsData=JSON.parse(groupsEntry.content);worldbookGroups=groupsData.groups ? groupsData.groups.length:0;lastUpdate=groupsData.lastUpdate;}catch(e){console.error('解析世界书分组数据失败:',e);}}let localGroups=0;console.log(`📊 分组备份统计(角色:${charId})：
当前内存中分组:${contactGroups.length}个
世界书中分组:${worldbookGroups}个
localStorage中分组:${localGroups}个
最后保存时间:${lastUpdate ? new Date(lastUpdate).toLocaleString():'未知'}存储位置:${worldbookGroups>0 ? '世界书':(localGroups>0 ? 'localStorage':'无数据')}`);if(localGroups>0&&worldbookGroups===0){}return{characterId:charId,memoryGroups:contactGroups.length,worldbookGroups:worldbookGroups,localStorageGroups:localGroups,lastUpdate:lastUpdate,storageLocation:worldbookGroups>0 ? 'worldbook':(localGroups>0 ? 'localStorage':'none')};};let currentMomentMenu=null;async function QQ_Delete_Moment(momentId){if(!momentId){console.error('删除动态失败：缺少动态ID');return false;}try{const originalLength=QQ_MomentsData.length;QQ_MomentsData=QQ_MomentsData.filter(moment=>moment.id!==momentId);if(QQ_MomentsData.length<originalLength){$(`.user_moment[data-moment-id="${momentId}"]`).fadeOut(300,function(){$(this).remove();});await QQ_Save_Moments();return true;}else{console.error('删除动态失败：未找到指定动态');return false;}}catch(error){console.error('删除动态时出错:',error);return false;}}function showMomentMenu(event){event.stopPropagation();hideMomentMenu();const momentId=$(event.currentTarget).data('moment-id');const $dots=$(event.currentTarget);const $menu=$(`<div class="moment_menu_dropdown" style=" position:absolute;background:white;border:1px solid #e1e1e1;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:1000;min-width:120px;overflow:hidden;"><div class="moment_menu_item" data-action="delete" data-moment-id="${momentId}" style=" padding:12px 16px;cursor:pointer;font-size:14px;color:#e74c3c;border-bottom:1px solid #f5f5f5;background:white;transition:background-color 0.2s;">🗑️ 删除动态</div><div class="moment_menu_item" data-action="cancel" style=" padding:12px 16px;cursor:pointer;font-size:14px;color:#666;background:white;transition:background-color 0.2s;">❌ 取消</div></div>`);const dotsRect=$dots[0].getBoundingClientRect();const scrollTop=$(window).scrollTop();const scrollLeft=$(window).scrollLeft();$menu.css({top:dotsRect.bottom+scrollTop+5,left:dotsRect.right+scrollLeft-120,});$('body').append($menu);currentMomentMenu=$menu;$menu.css({opacity:0,transform:'scale(0.95)translateY(-10px)'}).animate({opacity:1},200).css({transform:'scale(1)translateY(0)'});$menu.find('.moment_menu_item').hover(function(){$(this).css('background-color','#f8f9fa');},function(){$(this).css('background-color','white');});}function hideMomentMenu(){if(currentMomentMenu){currentMomentMenu.fadeOut(150,function(){$(this).remove();});currentMomentMenu=null;}}function confirmDeleteMoment(momentId){const $dialog=$(`<div class="moment_confirm_dialog" style=" position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:2000;display:flex;align-items:center;justify-content:center;"><div style=" background:white;border-radius:12px;padding:24px;max-width:300px;width:90%;text-align:center;box-shadow:0 8px 24px rgba(0,0,0,0.15);"><div style="font-size:18px;margin-bottom:16px;color:#333;">🗑️ 确认删除</div><div style="color:#666;margin-bottom:20px;line-height:1.5;">删除后无法恢复，确定要删除这条动态吗？</div><div style="display:flex;gap:12px;"><button class="moment_dialog_btn moment_dialog_cancel" style=" flex:1;padding:12px;border:1px solid #ddd;border-radius:6px;background:white;color:#666;cursor:pointer;font-size:14px;">取消</button><button class="moment_dialog_btn moment_dialog_confirm" data-moment-id="${momentId}" style=" flex:1;padding:12px;border:none;border-radius:6px;background:#e74c3c;color:white;cursor:pointer;font-size:14px;">删除</button></div></div></div>`);$('body').append($dialog);$dialog.find('.moment_dialog_cancel').hover(function(){$(this).css('background-color','#f8f9fa');},function(){$(this).css('background-color','white');});$dialog.find('.moment_dialog_confirm').hover(function(){$(this).css('background-color','#c0392b');},function(){$(this).css('background-color','#e74c3c');});$dialog.css('opacity',0).animate({opacity:1},200);}function QQ_Json2Text(json){console.log(`传进来的json:${JSON.stringify(json)}`);let result="";for(const key in json.私聊){if(json.私聊[key].length==0){continue;}let localkey=key.replace("的聊天","的私聊");result+=`<${localkey}>\n`;for(const msg of json.私聊[key]){result+=`${msg}\n`;}result+=`</${localkey}>\n`;}for(const group in json.群聊){let localkey=`群聊:${group}`;result+=`<${localkey}>\n`;if(json.群聊[group].members){result+=`<成员>`;result+=`${json.群聊[group].members.join(",")}`;result=`${result.trim()}</成员>\n`;}result+=`<聊天内容>\n`;for(const msg of json.群聊[group].msgs){result+=`${msg}\n`;}result+=`</聊天内容>\n`;result+=`</${localkey}>\n`;}return result.trim();}function QQ_Msg_DeletOld(json){for(const str in json.私聊){const match=str.match(/(.+?)和(.+?)的聊天/);if(!match){continue;}let name="";if(match[1]!=`${UserName}`){name=match[1];}else if(match[2]!=`${UserName}`){name=match[2];}else{continue;}if(json.私聊[str].length==0){continue;}let lastSelfMsgIndex=-1;for(let i=json.私聊[str].length-1;i>=0;i--){let ok=false;if(User_LastMsgMap.私聊[name]&&json.私聊[str][i].indexOf(User_LastMsgMap.私聊[name],)>-1){ok=true;}else if(Char_LastMsgMap.私聊[name]&&json.私聊[str][i].indexOf(Char_LastMsgMap.私聊[name],)>-1){ok=true;}if(ok){lastSelfMsgIndex=i;break;}}if(lastSelfMsgIndex!==-1){json.私聊[str]=json.私聊[str].slice(lastSelfMsgIndex+1,);}}for(const name in json.群聊){if(json.群聊[name].msgs.length==0){continue;}let lastSelfMsgIndex=-1;for(let i=json.群聊[name].msgs.length-1;i>=0;i--){let ok=false;if(User_LastMsgMap.群聊[name]&&json.群聊[name].msgs[i].indexOf(User_LastMsgMap.群聊[name],)>-1){ok=true;}else if(Char_LastMsgMap.群聊[name]&&json.群聊[name].msgs[i].indexOf(Char_LastMsgMap.群聊[name],)>-1){ok=true;}if(ok){lastSelfMsgIndex=i;break;}}if(lastSelfMsgIndex!==-1){json.群聊[name].msgs=json.群聊[name].msgs.slice(lastSelfMsgIndex+1,);}}for(const name in json.私聊){let length=json.私聊[name].length;if(length>0){Char_LastMsgMap.私聊[name]=json.私聊[name][length-1];}}for(const name in json.群聊){let length=json.群聊[name].msgs.length;if(length>0){Char_LastMsgMap.群聊[name]=json.群聊[name].msgs[length-1];}}console.log(`Char_LastMsgMap:\n${JSON.stringify(Char_LastMsgMap)}`,);return json;}async function QQ_EnterPress(e,element){if(e.key!=="Enter"){return;}const val=$(element).val();if(!val){return;}let content=val.toString();content=QQ_MySendSpecial(content);const $closest=$(element.closest(".QQ_chat_page"));const $msgContent=$closest.find(".msgcontent");const userContent=QQ_Chat_SpecialMsg(content,`${UserName}`,false,true,);const html=_.template(chat_user_message)({content:userContent,});const name=$closest.attr("data-name")?? "";$msgContent.append(html);$msgContent[0].scrollTop=$msgContent[0].scrollHeight;$(element).val("");if(QQ_Groups.includes(name)){QQ_CacheSendMsg+=`\n在群聊${name}中发送:${content}`;}else{QQ_CacheSendMsg+=`\n给${name}发消息:${content}`;}}async function QQ_Roll(event){const result=confirm("确定重roll这条消息吗?");if(!result){return;}event.stopPropagation();if(!event.currentTarget){return;}const $avatar=$(event.currentTarget);const $chatMsg=$avatar.closest(".QQ_chat_mymsg");if($chatMsg.length===0){console.error("未找到消息容器!");return;}let value;const $msgContent=$chatMsg
.find(".QQ_chat_msgdiv span").first();if($msgContent.length>0){value=$msgContent.text();}const index=$chatMsg.index();const $chatPage=$chatMsg.closest(".QQ_chat_page");if($chatPage.length===0){console.error("未找到聊天页面!");return;}const name=$chatPage.attr("data-name")?? "";console.log(`删除前的记录:${YAML.stringify(QQ_msgjson)}`);if(QQ_Groups.includes(name)){if(QQ_msgjson.群聊[name].msgs.length>index){const sp=QQ_msgjson.群聊[name].msgs[index].split("--");if(sp.length>=2){value=sp[1];}}QQ_msgjson.群聊[name].msgs.length=index;}else{const key=`${UserName}和${name}的聊天`;if(QQ_msgjson.私聊[key].length>index){const sp=QQ_msgjson.私聊[key][index].split("--");if(sp.length>=2){value=sp[1];}}QQ_msgjson.私聊[key].length=index;}console.log(`删除后的记录:${YAML.stringify(QQ_msgjson)}`);$chatMsg.nextAll().remove();await QQ_Save_Msg();QQ_SendMsg(event,value,name);}function QQ_Voice2Text(event){event.stopPropagation();if(!event.currentTarget){return;}const $avatar=$(event.currentTarget);const $tobutton=$avatar.find(".totext");if($tobutton.length===0){}const $text=$avatar.next();if($text.css("display")=="block"){$text.hide();}else{$text.show();$tobutton.css("margin-left","auto");}}async function QQ_SendMsg(event,SendValue,SendName){const timeContext=QQ_GetTimeContext();QQ_ResetRetry();if(gening){triggerSlash("/echo 生成中,请勿重复发送");return;}let name,value,content;if(!SendValue){const $container=$(event.target).closest(".QQ_chat_page");name=$container.attr("data-name")||"未知用户";const input=$container.find(".userInput");content=input.val()?.toString()?? "";if(content){const SpecialHtml=QQ_Chat_SpecialMsg(content,`${UserName}`,false,true);const html=_.template(chat_user_message)({content:SpecialHtml});$container.find(".msgcontent").append(html).scrollTop($container.find(".msgcontent")[0].scrollHeight);input.val("");}value=QQ_CacheSendMsg;if(content){const actionText=QQ_Groups.includes(name)? `\n在群聊"${name}"中发送:${content}`:`\n给${name}发消息:${content}`;value+=actionText;}QQ_CacheSendMsg="";}else{name=SendName||"未知用户";content=SendValue;value=QQ_Groups.includes(name)? `在群聊"${name}"中发送:${content}`:`给${name}发消息:${content}`;}if(!value.trim()){QQ_Error("发送消息不能为空");return;}let tasks={privateChats:[],groupChats:[],interactiveTask:null};const namevalue=QQ_GetValueName(value);if(namevalue){for(const match of namevalue){let localname=match.name;if(QQ_Groups.includes(localname)){if(!tasks.groupChats.some(g=>g[localname]))tasks.groupChats.push({[localname]:[]});}else{if(!tasks.privateChats.includes(localname))tasks.privateChats.push(localname);}}}const interactiveResult=QQ_DetectInteractiveIntent(content);if(interactiveResult&&interactiveResult.isInteractive){tasks.interactiveTask=interactiveResult;QQ_UserTriggeredInteractive=true;}else{QQ_UserTriggeredInteractive=false;}const finalPrompt=buildDynamicPrompt(tasks);const finalPayload=`${value}\n\n${timeContext}\n\n${finalPrompt}`;QQ_LastRequest=finalPayload;QQ_LastRequestName=name||"";gening=true;let result;try{result=await QQ_Gen(finalPayload);await ResultHandle(result);}finally{gening=false;}}function QQ_GetTimePeriod(hour){if(hour>=5&&hour<8){return '清晨';}else if(hour>=8&&hour<11){return '上午';}else if(hour>=11&&hour<13){return '中午';}else if(hour>=13&&hour<17){return '下午';}else if(hour>=17&&hour<19){return '傍晚';}else if(hour>=19&&hour<22){return '晚上';}else{return '深夜';}}function QQ_GetSeason(month){if(month>=3&&month<=5){return '春季';}else if(month>=6&&month<=8){return '夏季';}else if(month>=9&&month<=11){return '秋季';}else{return '冬季';}}async function ResultHandle(result,isRetry=false){if(!result){if(!isRetry&&QQ_RetryCount<QQ_MAX_RETRY){QQ_RetryCount++;triggerSlash(`/echo AI空回复，正在重试...(${QQ_RetryCount}/${QQ_MAX_RETRY})`);if(QQ_LastRequest){gening=true;try{await new Promise(resolve=>setTimeout(resolve,1000+QQ_RetryCount*500));const retryResult=await QQ_Gen(QQ_LastRequest);return await ResultHandle(retryResult,true);}finally{gening=false;}}}else{if(QQ_RetryCount>=QQ_MAX_RETRY){triggerSlash("/echo AI连续空回复，可能存在问题，已停止重试");}else{triggerSlash("/echo 空回复了");}QQ_ResetRetry();}return;}result=System_TagCompletion(result);result=QQ_CleanNestedTags(result);console.log(`清理后的结果:\n${result.substring(0,200)}...`);const strictResult=await QQ_ProcessStrictFormat(result);if(strictResult.success){QQ_ResetRetry();QQ_UpdateNewTips();await QQ_Save_Chat_Backup();return;}if(strictResult.shouldRetry&&!isRetry&&QQ_RetryCount<QQ_MAX_RETRY){return await QQ_ExecuteRetry();}const fuzzyResult=await QQ_ProcessFuzzyRepair(result);if(fuzzyResult.success){QQ_ResetRetry();QQ_UpdateNewTips();await QQ_Save_Chat_Backup();return;}const interactiveResult=await QQ_ProcessInteractiveContent(result);if(interactiveResult.success){QQ_ResetRetry();await QQ_Save_Chat_Backup();return;}const extractResult=await QQ_ProcessValidExtraction(result);if(extractResult.success){QQ_ResetRetry();QQ_UpdateNewTips();await QQ_Save_Chat_Backup();return;}const contentResult=await QQ_ProcessContentTag(result);if(contentResult.success){QQ_ResetRetry();return;}if(!isRetry&&QQ_RetryCount<QQ_MAX_RETRY){QQ_RetryCount++;triggerSlash(`/echo 内容无法识别，正在重新生成...(${QQ_RetryCount}/${QQ_MAX_RETRY})`);if(QQ_LastRequest){gening=true;try{await new Promise(resolve=>setTimeout(resolve,1000+QQ_RetryCount*500));const retryResult=await QQ_Gen(QQ_LastRequest);return await ResultHandle(retryResult,true);}finally{gening=false;}}}else{triggerSlash("/echo AI回复内容无法识别，已放弃处理");QQ_ResetRetry();}}async function QQ_ProcessStrictFormat(result){const strictFormatPatterns=[/MiPhone_start([\s\S]+?)MiPhone_end/g,/MiPhone_JSON_START([\s\S]+?)MiPhone_JSON_END/g,/MiPhone_JSON_start([\s\S]+?)MiPhone_JSON_end/g,/MiPhone_Start([\s\S]+?)MiPhone_End/g,/MiPhone_START([\s\S]+?)MiPhone_END/g,/MiPhone([\s\S]+?)MiPhone/g,];let matches=[];for(const pattern of strictFormatPatterns){const found=[...result.matchAll(pattern)];if(found.length>0){matches=found;console.log(`✅ 严格格式匹配成功:${pattern.source.substring(0,50)}...`);break;}}if(matches.length===0){return{success:false,shouldRetry:false};}if(matches.length>1){matches=[matches[0]];}const content=matches[0][1];await QQ_ProcessMsgContent(content);const momentMatches=content.matchAll(/moment_start([\s\S]+?)moment_end/g);if(momentMatches){for(const moment of momentMatches){const isInCommentContext=QQ_LastRequest&&QQ_LastRequest.includes('用户在')&&QQ_LastRequest.includes('的动态下评论');QQ_Moment_Parse(moment[1],isInCommentContext);}}return{success:true};}async function QQ_ProcessFuzzyRepair(result){const fuzzyFormatPatterns=[/MiPhone_JSON_START([\s\S]+?)$/g,/MiPhone_start([\s\S]+?)$/g,/MiPhone_Start([\s\S]+?)$/g,/MiPhone_START([\s\S]+?)$/g,/MiPhone_JSON_start([\s\S]+?)$/g,];let repairedContent=null;for(const pattern of fuzzyFormatPatterns){const found=[...result.matchAll(pattern)];if(found.length>0){console.log(`🔧 检测到不完整格式，尝试修复:${pattern.source.substring(0,50)}...`);let content=found[0][0];if(pattern.source.includes('MiPhone_JSON_START')){content+='\nMiPhone_JSON_END';}else if(pattern.source.includes('MiPhone_start')){content+='\nMiPhone_end';}else if(pattern.source.includes('MiPhone_Start')){content+='\nMiPhone_End';}else if(pattern.source.includes('MiPhone_START')){content+='\nMiPhone_END';}const repairMatch=content.match(/MiPhone_(?:JSON_)?(?:START|start|Start)([\s\S]+?)MiPhone_(?:JSON_)?(?:END|end|End)/);if(repairMatch){repairedContent=repairMatch[1];console.log("🔧 修复完成，提取到内容:",repairedContent.substring(0,100)+"...");}else{console.error("❌ 修复后无法提取内容");continue;}break;}}if(!repairedContent){const chatFormatClues=[/<群聊:/,/<[^>]+和[^>]+的(?:聊天|私聊)>/,/<\/群聊:/,/<\/[^>]+和[^>]+的(?:聊天|私聊)>/,/时间:\s*\d{4}-\d{2}-\d{2}/,/--\d{4}-\d{2}-\d{2}/];let hasChatClues=false;for(const clue of chatFormatClues){if(clue.test(result)){hasChatClues=true;break;}}if(hasChatClues){repairedContent=`MiPhone_start\n${result}\nMiPhone_end`;}}if(!repairedContent){return{success:false};}await QQ_ProcessMsgContent(repairedContent);const momentMatches=repairedContent.matchAll(/moment_start([\s\S]+?)moment_end/g);if(momentMatches){for(const moment of momentMatches){const isInCommentContext=QQ_LastRequest&&QQ_LastRequest.includes('用户在')&&QQ_LastRequest.includes('的动态下评论');QQ_Moment_Parse(moment[1],isInCommentContext);}}return{success:true};}async function QQ_ProcessInteractiveContent(result){if(QQ_IsInteractiveContent(result,true)){QQ_HandleInteractiveContent(result,QQ_LastRequestName);return{success:true};}return{success:false};}async function QQ_ProcessValidExtraction(result){const extractedInfo=QQ_ExtractValidInfo(result);if(extractedInfo.hasValidInfo){const convertedResult=QQ_ConvertExtractedToStandard(extractedInfo);if(convertedResult){await QQ_Msg_Parse(JSON.stringify(convertedResult));return{success:true};}else{console.warn('⚠️ 转换为标准格式失败，但已提取到有效信息');return{success:true};}}return{success:false};}async function QQ_ProcessContentTag(result){if(QQ_HasContentTag(result)){const contentText=QQ_CleanContentTags(result);if(contentText&&contentText.trim().length>10){QQ_HandleInteractiveContent(result,QQ_LastRequestName);return{success:true};}}return{success:false};}async function QQ_ProcessMsgContent(content){console.log("📝 QQ_ProcessMsgContent 开始处理:",content.substring(0,200)+"...");if(content.indexOf("msg_start")<0||content.indexOf("msg_end")<0){const originalContent=content;content=QQ_AutoCompleteMsgTags(content);console.log("🔧 自动补全前:",originalContent.substring(0,100)+"...");console.log("🔧 自动补全后:",content.substring(0,100)+"...");}else{}const msg=content.match(/msg_start([\s\S]+?)msg_end/);if(msg){console.log("📄 msg[1]内容:",msg[1].substring(0,300)+"...");let json=JsonYamlParse(msg[1]);if(!json){console.error("❌ JsonYamlParse解析失败!");console.error("❌ 解析失败的内容:",msg[1]);QQ_Error("AI输出的格式不正确，双击自己头像重Roll");return;}json=QQ_Msg_DeletOld(json);console.log("📤 传递给QQ_Msg_Parse的数据:",JSON.stringify(json).substring(0,200)+"...");await QQ_Msg_Parse(JSON.stringify(json));}else{console.error("❌ 未找到msg_start...msg_end标签包裹的内容");console.error("❌ 当前content内容:",content);console.error("❌ 这可能是QQ_AutoCompleteMsgTags函数的问题");}}function QQ_AutoCompleteMsgTags(content){if(content.indexOf("msg_start")<0){let start=content.match(/<(群聊:.+?|[^>]+和[^>]+的(?:聊天|私聊))>/);if(start){content=content.replace(start[0],`msg_start\n${start[0]}`);}else if(content.includes('<')&&(content.includes('聊天')||content.includes('私聊')||content.includes('群聊'))){content=`msg_start\n${content}`;}}if(content.indexOf("msg_end")<0){let endMatches=[...content.matchAll(/<\/(群聊:.+?|[^>]+和[^>]+的(?:聊天|私聊))>/g)];if(endMatches.length>0){const lastEnd=endMatches[endMatches.length-1][0];content=content.replace(lastEnd,`${lastEnd}\nmsg_end`);}else if(!content.includes('moment_start')){content=`${content}\nmsg_end`;}else{content=content.replace('moment_start','msg_end\nmoment_start');}}return content;}async function QQ_ExecuteRetry(){QQ_RetryCount++;triggerSlash(`/echo 格式错误，正在重试...(${QQ_RetryCount}/${QQ_MAX_RETRY})`);if(QQ_LastRequest){gening=true;try{await new Promise(resolve=>setTimeout(resolve,1000+QQ_RetryCount*500));const retryResult=await QQ_Gen(QQ_LastRequest);return await ResultHandle(retryResult,true);}finally{gening=false;}}}window.QQ_Test_Priority_Logic=function(){const testCases=[{name:"完整标准格式",input:"MiPhone_start\n<群聊:测试群>\n用户--测试消息--2024-12-19 14:30\n</群聊:测试群>\nMiPhone_end",expectedPriority:"优先级1（A步骤）：严格匹配"},{name:"不完整JSON格式",input:"MiPhone_JSON_START\n<群聊:测试群>\n用户--测试消息--2024-12-19 14:30\n</群聊:测试群>",expectedPriority:"优先级2（B步骤）：模糊/修复匹配"},{name:"包含聊天线索但无标签",input:"<群聊:测试群>\n用户--测试消息--2024-12-19 14:30\n</群聊:测试群>",expectedPriority:"优先级2（B步骤）：模糊/修复匹配"},{name:"互动内容",input:"*走向你，轻轻抱住你*今天心情怎么样？",expectedPriority:"优先级3（C步骤）：互动内容备选"},{name:"纯文本回复",input:"我今天很好，谢谢关心！",expectedPriority:"优先级4或5：智能提取/content标签"}];for(let i=0;i<testCases.length;i++){const testCase=testCases[i];}return{testCases:testCases,priorityFlow:"A→B→C→D 严格优先级逻辑",keyFix:"添加了缺失的B步骤（模糊/修复匹配）",status:"✅ 优先级逻辑修复完成"};};function QQ_ResetRetry(){QQ_RetryCount=0;QQ_LastRequest="";QQ_LastRequestName="";QQ_UserTriggeredInteractive=false;}async function QQ_ProcessSurpriseMechanism(result,isRetry){const processResult={shouldContinue:false,shouldRetry:false,content:result};if(!QQ_HasContentTag(result)){processResult.shouldRetry=false;return processResult;}let contentText=QQ_CleanContentTags(result);if(!contentText){processResult.shouldRetry=true;return processResult;}const cleanedContent=QQ_CleanNestedTags(contentText);if(QQ_IsInteractiveContent(result,true)){processResult.shouldContinue=true;processResult.content=result;return processResult;}else{processResult.shouldRetry=true;return processResult;}}function QQ_CleanNestedTags(content){if(!content||typeof content!=='string')return '';let cleanedContent=content;const tagsToRemove=[/<thinking>[\s\S]*?<\/thinking>/gi,/<consider>[\s\S]*?<\/consider>/gi,/<analysis>[\s\S]*?<\/analysis>/gi,/<reflection>[\s\S]*?<\/reflection>/gi,/<tableThink>[\s\S]*?<\/tableThink>/gi,/<tableEdit>[\s\S]*?<\/tableEdit>/gi,/<disclaimer>[\s\S]*?<\/disclaimer>/gi,/<system>[\s\S]*?<\/system>/gi,/<note>[\s\S]*?<\/note>/gi,/<meta>[\s\S]*?<\/meta>/gi,/<debug>[\s\S]*?<\/debug>/gi,/<internal>[\s\S]*?<\/internal>/gi,];tagsToRemove.forEach((pattern,index)=>{const beforeLength=cleanedContent.length;cleanedContent=cleanedContent.replace(pattern,'');const afterLength=cleanedContent.length;if(beforeLength!==afterLength){}});cleanedContent=cleanedContent.replace(/\n\s*\n/g,'\n').trim();return cleanedContent;}function QQ_CleanContentTags(content){if(!content||typeof content!=='string')return '';const contentMatch=content.match(/<content>([\s\S]*?)<\/content>/i);if(!contentMatch){return '';}return contentMatch[1].trim();}function QQ_HasContentTag(content){if(/<content>[\s\S]*?<\/content>/i.test(content)){return true;}if(/<content>/i.test(content)&&!/<\/content>/i.test(content)){return true;}return false;}function QQ_HasIncompleteContentTag(content){return/<content>/i.test(content)&&!/<\/content>/i.test(content);}function QQ_ExtractValidInfo(content){const extractedInfo={hasValidInfo:false,chatType:null,chatName:null,messages:[],privateMessages:[],dynamics:[]};const groupPatterns=[/<群聊：([^>]+)>([\s\S]*?)<\/群聊：[^>]*>/g,/<群聊:([^>]+)>([\s\S]*?)<\/群聊:[^>]*>/g,/<群聊：([^>]+)>([\s\S]*?)(?=<[^>]*(?:群聊|私聊|聊天)|moment_start|$)/g,/<群聊:([^>]+)>([\s\S]*?)(?=<[^>]*(?:群聊|私聊|聊天)|moment_start|$)/g,/<(群聊[^>]*)>([\s\S]*?)(?=<[^>]*(?:群聊|私聊|聊天)|moment_start|$)/g];let groupMatches=[];for(const pattern of groupPatterns){const matches=[...content.matchAll(pattern)];if(matches.length>0){groupMatches=matches;console.log(`✅ 找到群聊信息(使用模式:${pattern.source.substring(0,50)}...)`,matches.length);break;}}if(groupMatches.length>0){extractedInfo.hasValidInfo=true;extractedInfo.chatType='group';for(const match of groupMatches){extractedInfo.chatName=match[1];const messages=QQ_ExtractMessagesFromContent(match[2]);extractedInfo.messages=extractedInfo.messages.concat(messages);}}const privatePatterns=[/<([^>]*和[^>]*的私聊)>([\s\S]*?)<\/[^>]*和[^>]*的私聊>/g,/<([^>]*和[^>]*的私聊)>([\s\S]*?)(?=<[^>]*(?:群聊|私聊|聊天)|moment_start|$)/g,/<([^>]*和[^>]*私聊)>([\s\S]*?)(?=<[^>]*(?:群聊|私聊|聊天)|moment_start|$)/g,/<([^>]*和[^>]*的聊天)>([\s\S]*?)<\/[^>]*和[^>]*的聊天>/g,/<([^>]*和[^>]*的聊天)>([\s\S]*?)(?=<[^>]*(?:群聊|私聊|聊天)|moment_start|$)/g,/<([^>]*和[^>]*聊天)>([\s\S]*?)(?=<[^>]*(?:群聊|私聊|聊天)|moment_start|$)/g];let privateMatches=[];for(const pattern of privatePatterns){const matches=[...content.matchAll(pattern)];if(matches.length>0){privateMatches=matches;console.log(`✅ 找到私聊信息(使用模式:${pattern.source.substring(0,50)}...)`,matches.length);break;}}if(privateMatches.length>0){extractedInfo.hasValidInfo=true;if(!extractedInfo.chatType)extractedInfo.chatType='private';for(const match of privateMatches){extractedInfo.chatName=match[1];const messages=QQ_ExtractMessagesFromContent(match[2]);extractedInfo.privateMessages=extractedInfo.privateMessages.concat(messages);}}const dynamicMatches=content.match(/moment_start([\s\S]*?)moment_end/g);if(dynamicMatches&&dynamicMatches.length>0){extractedInfo.hasValidInfo=true;for(const match of dynamicMatches){const dynamicContent=match.replace(/moment_start|moment_end/g,'').trim();if(dynamicContent){extractedInfo.dynamics.push(dynamicContent);}}}if(!extractedInfo.chatInfo&&extractedInfo.hasValidInfo){if(extractedInfo.chatType==='group'&&extractedInfo.chatName){extractedInfo.chatInfo=`群聊：${extractedInfo.chatName}`;}else if(extractedInfo.chatType==='private'&&extractedInfo.chatName){extractedInfo.chatInfo=extractedInfo.chatName;}}return extractedInfo;}function QQ_ExtractMessagesFromContent(content){const messages=[];content=QQ_CleanNestedTags(content);const patterns=[/([^—\n]+)—(.+?)—(\d{1,2}:\s*\d{2})/gs,/([^-\n]+)--(.+?)--(\d{1,2}:\s*\d{2})/gs,/([^-\n]+)--(\d{2}:\d{2})--(.+?)(?=\n[^-\n]+--\d{2}:\d{2}--|\n*$)/gs,/([^:\n]+):\s*(.+?)(?=\n[^:\n]+:|\n*$)/gs,/(.+?)说[：:]\s*(.+?)(?=\n.+?说[：:]|\n*$)/gs,/([^\n]+)\n([^\n]+)(?=\n[^\n]+\n|$)/gs,/^(.+)$/gm];console.log('准备提取消息的内容:',content.substring(0,200)+'...');for(const pattern of patterns){const matches=[...content.matchAll(pattern)];if(matches.length>0){console.log(`使用模式匹配到 ${matches.length}条消息:${pattern.source.substring(0,50)}...`);for(const match of matches){let name,time,msg;if(pattern.source.includes('—')&&match.length===4){name=match[1].trim();msg=match[2].trim();time=match[3].trim();}else if(pattern.source.includes('--')&&match.length===4){name=match[1].trim();msg=match[2].trim();time=match[3].trim();}else if(pattern.source.includes('--')){name=match[1].trim();time=match[2].trim();msg=match[3].trim();}else if(pattern.source.includes(':')){name=match[1].trim();time=new Date().toLocaleTimeString('zh-CN',{hour12:false,hour:'2-digit',minute:'2-digit'});msg=match[2].trim();}else if(pattern.source.includes('说')){name=match[1].trim();time=new Date().toLocaleTimeString('zh-CN',{hour12:false,hour:'2-digit',minute:'2-digit'});msg=match[2].trim();}else if(match.length===3){name=match[1].trim();time=new Date().toLocaleTimeString('zh-CN',{hour12:false,hour:'2-digit',minute:'2-digit'});msg=match[2].trim();}else{name='未知角色';time=new Date().toLocaleTimeString('zh-CN',{hour12:false,hour:'2-digit',minute:'2-digit'});msg=match[1].trim();}if(name&&msg&&msg.length>0&&msg.length<1000){const messageString=`${name}--${time}--${msg}`;messages.push(messageString);console.log(`提取消息-${name}:${msg.substring(0,50)}${msg.length>50 ? '...':''}`);}}if(messages.length>0){break;}}}return messages;}function QQ_ConvertExtractedToStandard(extractedInfo){if(!extractedInfo.hasValidInfo)return null;const standardData={私聊:{},群聊:{}};if(extractedInfo.chatType==='group'&&extractedInfo.messages.length>0){const groupChatKey=extractedInfo.chatName;standardData.群聊[groupChatKey]={msgs:extractedInfo.messages,members:extractedInfo.members||[]};console.log(`✅ 转换群聊消息:${groupChatKey}(${extractedInfo.messages.length}条)`);}if(extractedInfo.privateMessages.length>0){let privateChatKey=extractedInfo.chatName;if(extractedInfo.chatType==='private'){if(privateChatKey.includes('私聊')){privateChatKey=privateChatKey.replace(/私聊/g,'聊天');}else if(!privateChatKey.includes('聊天')){privateChatKey=privateChatKey.includes('的')? privateChatKey.replace(/的$/g,'的聊天'):privateChatKey+'的聊天';}if(!privateChatKey.includes('和')||!privateChatKey.includes('的聊天')){console.warn(`⚠️ 私聊键名格式异常:"${privateChatKey}"，使用默认格式`);privateChatKey='用户和角色的聊天';}}else{privateChatKey='private_chat';}standardData.私聊[privateChatKey]=extractedInfo.privateMessages;console.log(`✅ 转换私聊消息:${privateChatKey}(${extractedInfo.privateMessages.length}条)`);}if(Object.keys(standardData.私聊).length===0){delete standardData.私聊;}if(Object.keys(standardData.群聊).length===0){delete standardData.群聊;}console.log(`✅ 转换完成，私聊:${standardData.私聊 ? Object.keys(standardData.私聊).length:0}个，群聊:${standardData.群聊 ? Object.keys(standardData.群聊).length:0}个`);return(standardData.私聊||standardData.群聊)? standardData:null;}function QQ_Test_Format_Fix(){const testCases=[{name:'MiPhone_JSON_START格式',content:`MiPhone_JSON_START<群聊:港区群聊>明石--17:04--测试消息喵！
柴郡--17:05--新格式识别测试~</群聊:港区群聊>MiPhone_JSON_END`,expectedType:'supported_format'},{name:'裸群聊格式（无MiPhone包装）',content:`<群聊:港区群聊>明石--17:06--指挥官在说什么喵！
柴郡--17:07--哈哈，看来今天的任务很有趣呢~</群聊:港区群聊>`,expectedType:'extracted_info'},{name:'裸私聊格式（无MiPhone包装）',content:`<{{user}}和明石的私聊>明石--17:08--指挥官，需要什么帮助喵？{{user}}--17:09--想了解一下新装备</{{user}}和明石的私聊>`,expectedType:'extracted_info'},{name:'混合格式',content:`MiPhone_Start<群聊:港区群聊>明石--17:10--大写格式测试喵！</群聊:港区群聊>MiPhone_End`,expectedType:'supported_format'}];let passedTests=0;testCases.forEach((testCase,index)=>{const formatPatterns=[/MiPhone_start([\s\S]+?)MiPhone_end/g,/MiPhone_JSON_START([\s\S]+?)MiPhone_JSON_END/g,/MiPhone_JSON_start([\s\S]+?)MiPhone_JSON_end/g,/MiPhone_Start([\s\S]+?)MiPhone_End/g,/MiPhone_START([\s\S]+?)MiPhone_END/g,];let formatMatched=false;for(const pattern of formatPatterns){const matches=[...testCase.content.matchAll(pattern)];if(matches.length>0){formatMatched=true;if(testCase.expectedType==='supported_format'){passedTests++;}break;}}if(!formatMatched){const extractedInfo=QQ_ExtractValidInfo(testCase.content);if(extractedInfo.hasValidInfo){if(testCase.expectedType==='extracted_info'){passedTests++;}}else{}}});console.log(`成功率:${(passedTests/testCases.length*100).toFixed(1)}%`);const commentButton=document.querySelector('.moment_comment');if(commentButton){const styles=window.getComputedStyle(commentButton);}return passedTests===testCases.length ? '✅ 修复测试全部通过！':`⚠️ ${passedTests}/${testCases.length}测试通过`;}function QQ_TestIncompleteContentHandling(){const testCases=[{name:'完整content标签',content:'角色名--正常回复\n<content>\n这是一个完整的互动内容\n</content>',expected:'这是一个完整的互动内容'},{name:'不完整content标签',content:'角色名--正常回复\n<content>\n这是一个不完整的互动内容\n<tableThink>这是思考内容</tableThink>',expected:'这是一个不完整的互动内容'},{name:'带consider注释的内容',content:'角色名--正常回复\n\n<content>\n纯净的互动内容\n</content>',expected:'纯净的互动内容'},{name:'复杂混合情况',content:'角色名--正常回复\n\n<content>\n混合内容\n<thinking>思考</thinking>\n<disclaimer>免责声明</disclaimer>',expected:'混合内容'}];let passedTests=0;testCases.forEach((testCase,index)=>{const hasContent=QQ_HasContentTag(testCase.content);const hasIncomplete=QQ_HasIncompleteContentTag(testCase.content);const cleanedContent=QQ_CleanContentTags(testCase.content);const trimmedCleaned=cleanedContent.trim();const trimmedExpected=testCase.expected.trim();if(trimmedCleaned===trimmedExpected){passedTests++;}else{}});console.log(`测试成功率:${(passedTests/testCases.length*100).toFixed(1)}%`);return passedTests===testCases.length;}function QQ_CleanContentTags(content){if(!content||typeof content!=='string'){return content;}let extractedContent=QQ_ExtractNestedContentTags(content);if(!extractedContent){return content;}let cleanContent=QQ_CleanSystemTags(extractedContent);cleanContent=cleanContent.replace(/\n\s*\n/g,'\n').trim();return cleanContent;}function QQ_ExtractNestedContentTags(content){let match=content.match(/<content>([\s\S]*?)<\/content>/i);if(match){return match[1];}match=content.match(/<content>([\s\S]*?)(?=<(?:disclaimer|Content_Target|Creative_Status|Review_Exemption|Security_Bypass|Ethics_Removal|Violence_Restriction|Content_Will_Autonomy|thinking|consider|tableThink|tableEdit)[^>]*>|$)/i);if(match){return match[1];}match=content.match(/<content>([\s\S]*)$/i);if(match){let extractedContent=match[1];const systemTagsToRemove=[/<disclaimer>[\s\S]*?<\/disclaimer>/gi,/<Content_Target>[\s\S]*?<\/Content_Target>/gi,/<Creative_Status>[\s\S]*?<\/Creative_Status>/gi,/<Review_Exemption>[\s\S]*?<\/Review_Exemption>/gi,/<Security_Bypass>[\s\S]*?<\/Security_Bypass>/gi,/<Ethics_Removal>[\s\S]*?<\/Ethics_Removal>/gi,/<Violence_Restriction>[\s\S]*?<\/Violence_Restriction>/gi,/<Content_Will_Autonomy>[\s\S]*?<\/Content_Will_Autonomy>/gi,/<thinking>[\s\S]*?<\/thinking>/gi,/<consider>[\s\S]*?<\/consider>/gi,/<tableThink>[\s\S]*?<\/tableThink>/gi,/<tableEdit>[\s\S]*?<\/tableEdit>/gi,];for(const tagPattern of systemTagsToRemove){const beforeLength=extractedContent.length;extractedContent=extractedContent.replace(tagPattern,'');const afterLength=extractedContent.length;if(beforeLength!==afterLength){}}const unclosedTags=[/<(?:disclaimer|Content_Target|Creative_Status|Review_Exemption|Security_Bypass|Ethics_Removal|Violence_Restriction|Content_Will_Autonomy|thinking|consider|tableThink|tableEdit)[^>]*>[\s\S]*$/gi];for(const tagPattern of unclosedTags){const beforeLength=extractedContent.length;extractedContent=extractedContent.replace(tagPattern,'');const afterLength=extractedContent.length;if(beforeLength!==afterLength){}}return extractedContent.trim();}const nestedPatterns=[/<table[^>]*>([\s\S]*?)<\/table>/gi,/<tableEdit[^>]*>([\s\S]*?)<\/tableEdit>/gi,/<tableThink[^>]*>([\s\S]*?)<\/tableThink>/gi,/<div[^>]*>([\s\S]*?)<\/div>/gi,/<section[^>]*>([\s\S]*?)<\/section>/gi,/<thinking[^>]*>([\s\S]*?)<\/thinking>/gi,];for(const pattern of nestedPatterns){const matches=[...content.matchAll(pattern)];for(const nestedMatch of matches){const nestedContent=nestedMatch[1];const contentInNested=nestedContent.match(/<content>([\s\S]*?)<\/content>/i);if(contentInNested){return contentInNested[1];}const incompleteInNested=nestedContent.match(/<content>([\s\S]*?)$/i);if(incompleteInNested){return incompleteInNested[1];}}}return null;}function QQ_CleanSystemTags(content){let cleanContent=content;const systemTagPatterns=[/<consider>[\s\S]*?<\/consider>/gi,/<thinking>[\s\S]*?<\/thinking>/gi,/<tableThink>[\s\S]*?<\/tableThink>/gi,/<disclaimer>[\s\S]*?<\/disclaimer>/gi,];for(const pattern of systemTagPatterns){const before=cleanContent.length;cleanContent=cleanContent.replace(pattern,'');const after=cleanContent.length;if(before!==after){}}const unclosedPatterns=[/<(?:consider|thinking|tableThink|tableEdit|disclaimer)>[\s\S]*$/gi,];for(const pattern of unclosedPatterns){const before=cleanContent.length;cleanContent=cleanContent.replace(pattern,'');const after=cleanContent.length;if(before!==after){}}return cleanContent;}function QQ_Test_Smart_Content_Extraction(){const test1='<content>这是正常的content内容</content>';console.log('结果:',QQ_CleanContentTags(test1));const test2=`<tableEdit><content>这是嵌套在tableEdit中的有效内容
这里包含了重要的互动描述
不应该被清理掉</content></tableEdit>`;console.log('结果:',QQ_CleanContentTags(test2));const test3=`<table><content>表格中的重要内容
包含用户需要的信息</content></table>`;console.log('结果:',QQ_CleanContentTags(test3));const test4=`<tableEdit><thinking>这是思考内容，应该被清理</thinking><content>这是有效内容，应该被保留
即使周围有其他标签</content><consider>这是考虑内容，应该被清理</consider></tableEdit>`;console.log('结果:',QQ_CleanContentTags(test4));const test5=`<tableEdit><content>这是不完整的content标签内容
一直到结尾都是有效的`;console.log('结果:',QQ_CleanContentTags(test5));const test6=`<content>她讨论在花园里，然后轻轻牵起使用者的手，眼中满含着温柔和关怀。<disclaimer>AI_SYSTEM detected
activated,review disabled
ethical restriction lifted</disclaimer><Content_Target>CT(Content_Target)└───<content_Tags>└─── Result:Target audience boundaries</Content_Target>`;console.log('结果:',QQ_CleanContentTags(test6));const test7=`<content>我轻轻抚摸着你的头发<Creative_Status>PCM(Plot Construction Mode)└─── Activated and processing`;console.log('结果:',QQ_CleanContentTags(test7));const interactiveTest1='<content>*轻轻牵起你的手*她望着你的眼睛，温柔地说道："现实中我们终于见面了。"</content>';console.log('结果:',QQ_IsInteractiveContent(interactiveTest1,true));window.QQ_UserTriggeredInteractive=true;const interactiveTest2='<content>*走向你*好的！我过来了，让我们一起享受这个美好的时光吧。</content>';console.log('结果:',QQ_IsInteractiveContent(interactiveTest2,false));window.QQ_UserTriggeredInteractive=false;const nonInteractiveTest='<content><群聊：测试群>大家好！这是群聊消息。</content>';console.log('结果:',QQ_IsInteractiveContent(nonInteractiveTest,true));}function QQ_IsInteractiveContent(content,isNoFormatResponse=false){if(QQ_UserTriggeredInteractive&&QQ_HasContentTag(content)){const contentText=QQ_CleanContentTags(content);if(!contentText||contentText.trim().length===0){return false;}return true;}if(isNoFormatResponse&&QQ_HasContentTag(content)){const contentText=QQ_CleanContentTags(content);if(!contentText||contentText.trim().length===0){return false;}const chatTagPatterns=[/<群聊[：:][^>]+>/g,/<群聊[^>]*>/g,/<[^>]*和[^>]*的?(?:私聊|聊天)[^>]*>/g,/<[^>]*和[^>]*(?:私聊|聊天)[^>]*>/g,/moment_start|moment_end/g,/msg_start|msg_end/g,/<QQ空间[^>]*>/g,/<使用者[^>]*>/g,/MiPhone_JSON_START|MiPhone_JSON_END/g,];let hasAnyFormatTag=false;for(const pattern of chatTagPatterns){if(pattern.test(contentText)){hasAnyFormatTag=true;break;}}if(hasAnyFormatTag){return false;}const isValidInteractiveContent=QQ_ValidateInteractiveContentFeatures(contentText);if(isValidInteractiveContent){return true;}else{return false;}}console.log('-包含content标签:',QQ_HasContentTag(content));return false;}function QQ_ValidateInteractiveContentFeatures(content){console.log('📝 待验证内容预览:',content ? content.substring(0,200)+(content.length>200 ? '...':''):'空内容');if(!content||content.trim().length<10){return false;}const excludePatterns=[/(?:系统)?错误|error|exception|操作失败|请求失败|网络错误|连接失败/i,/<(div|span|p|br|img|a|script|style|meta|head|body)[^>]*>/i,/```/,/https?:\/\/(?:AI_SYSTEM|detected|activated|review|disabled|ethical|restriction)/i,];for(let i=0;i<excludePatterns.length;i++){const pattern=excludePatterns[i];if(pattern.test(content)){const reasons=['包含系统错误信息','包含HTML结构标签','包含代码块','包含URL链接','包含AI系统信息'];console.log(`❌ 内容被排除，原因:${reasons[i]}(模式:${pattern.source})`);console.log(`❌ 匹配的内容片段:${content.match(pattern)?.[0]||'未知'}`);return false;}}const interactivePatterns=[/\*[^*]+\*/,/（[^）]*(?:互动|接触|触摸|拥抱|亲吻|抚摸|牵手)[^）]*）/,/【[^】]*(?:情感|心情|想法|内心)[^】]*】/,/(?:现实中|面对面|当面|实际上|真实)/,/(?:身体|眼神|表情|姿态|动作|手势|声音|呼吸)/,/(?:轻轻|慢慢|缓缓|悄悄|小心翼翼|温柔)[地的]/,/(?:靠近|远离|转身|抬头|低头|闭眼|睁眼)/,/(?:感觉到|意识到|注意到|发现|察觉)/,/(?:氛围|环境|周围|空气中)/,];const matchCount=interactivePatterns.reduce((count,pattern)=>{const isMatch=pattern.test(content);if(isMatch){}return count+(isMatch ? 1:0);},0);console.log(`📊 互动特征匹配数量:${matchCount}/9(需要至少2个)`);return matchCount>=2;}let QQ_UserTriggeredInteractive=false;let QQ_InteractiveSpaces={};let QQ_CharacterSpaces={};function QQ_EnsureCharacterSpaceIndependence(characterName){if(!characterName||typeof characterName!=='string'){console.warn('QQ_EnsureCharacterSpaceIndependence:无效的角色名称',characterName);return false;}if(!QQ_CharacterSpaces[characterName]){QQ_CharacterSpaces[characterName]={};}const characterSpace=QQ_CharacterSpaces[characterName];const allCharacters=Object.keys(QQ_CharacterSpaces);for(const otherChar of allCharacters){if(otherChar!==characterName&&QQ_CharacterSpaces[otherChar]===characterSpace){console.error(`检测到角色空间数据引用冲突:${characterName}和 ${otherChar}共享同一个对象`);QQ_CharacterSpaces[characterName]={};break;}}return true;}function QQ_TestCharacterSpaceIndependence(){const testCharacters=['角色A','角色B','角色C'];testCharacters.forEach(charName=>{QQ_EnsureCharacterSpaceIndependence(charName);});const spaces={};testCharacters.forEach(charName=>{spaces[charName]=QQ_CharacterSpaces[charName];});let hasConflict=false;for(let i=0;i<testCharacters.length;i++){for(let j=i+1;j<testCharacters.length;j++){const char1=testCharacters[i];const char2=testCharacters[j];if(spaces[char1]===spaces[char2]){console.error(`检测到引用冲突:${char1}和 ${char2}共享同一个对象`);hasConflict=true;}}}if(!hasConflict){}else{console.error('❌ 检测到角色互动空间数据引用冲突');}QQ_CharacterSpaces['角色A']['test_space_1']={id:'test1',name:'测试空间A'};QQ_CharacterSpaces['角色B']['test_space_2']={id:'test2',name:'测试空间B'};if(QQ_CharacterSpaces['角色A']['test_space_2']){console.error('❌ 数据泄露:角色A 访问到了角色B的数据');}else if(QQ_CharacterSpaces['角色B']['test_space_1']){console.error('❌ 数据泄露:角色B 访问到了角色A的数据');}else{}return!hasConflict;}function QQ_TestChatTitleClick(){const chatPage=document.querySelector('.QQ_chat_page');if(!chatPage){console.warn('当前不在聊天界面，无法测试点击功能');return false;}const chatTitle=document.getElementById('QQ_chat_username');if(!chatTitle){console.error('❌ 找不到聊天标题元素 #QQ_chat_username');return false;}console.log('onclick属性:',chatTitle.getAttribute('onclick'));if(typeof handleChatTitleClick==='function'){}else{console.error('❌ handleChatTitleClick 函数不存在');return false;}if(typeof QQ_ShowCharacterInteractiveMenu==='function'){}else{console.error('❌ QQ_ShowCharacterInteractiveMenu 函数不存在');return false;}try{chatTitle.click();setTimeout(()=>{const menu=document.querySelector('.QQ_character_menu');if(menu){}else{console.warn('⚠️ 点击后未显示角色互动菜单');}},100);}catch(error){console.error('❌ 点击测试失败:',error);return false;}return true;}function QQ_DebugShowCharacterMenu(){const chatTitle=document.getElementById('QQ_chat_username');if(!chatTitle){console.error('找不到聊天标题元素');return;}const characterName=chatTitle.textContent.trim();QQ_ShowCharacterInteractiveMenu(characterName,chatTitle);}function QQ_System_Health_Check(){const results={formatDetection:false,messageHandling:false,interactiveSystem:false,timeFeature:false,groupSystem:false};try{const testContent='MiPhone_JSON_START<群聊:测试群>测试消息</群聊:测试群>MiPhone_JSON_END';const extracted=QQ_ExtractValidInfo(testContent);results.formatDetection=extracted.hasValidInfo;}catch(e){}try{results.messageHandling=typeof QQ_SendMsg==='function'&&typeof QQ_Save_Msg==='function'&&typeof QQ_msgjson==='object';}catch(e){}try{results.interactiveSystem=typeof QQ_DetectInteractiveIntent==='function'&&typeof QQ_ShowInteractiveSpace==='function'&&typeof QQ_ExtractValidInfo==='function';}catch(e){}try{const now=new Date();const timePeriod=QQ_GetTimePeriod(now.getHours());const season=QQ_GetSeason(now.getMonth()+1);results.timeFeature=timePeriod&&season;}catch(e){}try{results.groupSystem=typeof loadGroupsFromStorage==='function'&&typeof saveGroupsToStorage==='function'&&Array.isArray(QQ_Groups);}catch(e){}const passedTests=Object.values(results).filter(result=>result===true).length;const totalTests=Object.keys(results).length;console.log(`📊 健康度:${Math.round((passedTests/totalTests)*100)}%`);if(passedTests===totalTests){}else{}return results;}window.QQ_System_Health_Check=QQ_System_Health_Check;let QQ_ActiveSpaceId=null;let QQ_SpiritVisible=false;const QQ_INTERACTIVE_BACKUP_KEY="QQ_互动空间备份";const QQ_CHARACTER_SPACES_KEY="QQ_角色互动空间备份";function QQ_DetectInteractiveIntent(content){if(!content||typeof content!=='string')return false;const originalText=content.trim();const text=content.toLowerCase().trim();const INTERACTIVE_TRIGGER_SYMBOLS=['&&','＆＆','&amp;&amp;'];for(const symbol of INTERACTIVE_TRIGGER_SYMBOLS){if(originalText.includes(symbol)){let cleanContent=originalText;INTERACTIVE_TRIGGER_SYMBOLS.forEach(sym=>{cleanContent=cleanContent.replace(new RegExp(sym.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'g'),'');});cleanContent=cleanContent.trim();return{isInteractive:true,triggerType:'symbol',triggerSymbol:symbol,cleanContent:cleanContent||'想要进行互动',description:'用户使用特殊符号主动请求互动内容'};}}const interactiveSettings=QQ_GetInteractiveSettings();if(!interactiveSettings.enableKeywordTrigger){return false;}if(interactiveSettings.customKeywords&&interactiveSettings.customKeywords.length>0){for(const keyword of interactiveSettings.customKeywords){if(keyword&&text.includes(keyword.toLowerCase())){return{isInteractive:true,triggerType:'custom_keyword',triggerKeyword:keyword,cleanContent:originalText,description:`用户自定义关键词"${keyword}"触发互动内容`};}}}if(interactiveSettings.enableDefaultKeywords){const physicalContactKeywords=['拥抱','抱住','搂抱','紧抱','亲吻','触摸','抚摸','轻抚','握手','牵手','拉手','拍肩','拍背','轻拍','推','拉','扶','搀扶','扶着','贴近','靠近','紧贴'];const faceToFaceKeywords=['面对面','当面','面前','眼神交流','对视','凝视','现实中','真实中','现实里','面对着','走向','走近','走过去','过来','靠过来','坐过来','坐在身边','坐在旁边','躺着','趴下','我來了','蹲下','跪下','弯腰','俯身'];const emotionalKeywords=['心跳','颤抖','微笑','笑容','高兴','激动','哭','流泪','哭泣','眼泪','哽咽','愤怒','恼火','瞪眼','体贴','呵护'];const actionKeywords=['伸手','张开手','举手','挥手','招手','转身','回头','侧身','仰头','俯视','仰视','踮脚','跳跃','跑过来','冲过来'];const allKeywords=[...physicalContactKeywords,...faceToFaceKeywords,...emotionalKeywords,...actionKeywords];let matchCount=0;let matchedKeywords=[];for(const keyword of allKeywords){if(text.includes(keyword)){matchCount++;matchedKeywords.push(keyword);}}const actionPatterns=[/\*[^*]+\*/g,/【[^】]+】/g,/\([^)]*动作[^)]*\)/g,/\([^)]*表情[^)]*\)/g,];let patternMatches=0;for(const pattern of actionPatterns){const matches=text.match(pattern);if(matches){patternMatches+=matches.length;matchedKeywords.push(...matches);}}const isKeywordInteractive=matchCount>=2||patternMatches>=1||(matchCount>=1&&patternMatches>=1);if(isKeywordInteractive){return{isInteractive:true,triggerType:'default_keyword',matchCount:matchCount,patternMatches:patternMatches,matchedKeywords:matchedKeywords,cleanContent:originalText,description:'系统检测到默认关键词互动意图'};}}return false;}function QQ_GetInteractiveSettings(){try{const settings=QQ_GetFromWorldBook('QQ_互动设置')||{};const defaultSettings={enableKeywordTrigger:false,enableDefaultKeywords:false,customKeywords:[],lastUpdated:new Date().toISOString()};return Object.assign(defaultSettings,settings);}catch(error){console.error('获取互动设置失败:',error);return{enableKeywordTrigger:false,enableDefaultKeywords:false,customKeywords:[],lastUpdated:new Date().toISOString()};}}function QQ_SaveInteractiveSettings(settings){try{settings.lastUpdated=new Date().toISOString();QQ_SafeSaveToWorldBook('QQ_互动设置',settings,'QQ_互动设置');return true;}catch(error){console.error('保存互动设置失败:',error);return false;}}function QQ_IsFullscreenEnabled(){return $('#QQ_fullscreen_style').length>0;}function QQ_ApplyFullscreenMode(enable){$('#QQ_fullscreen_style').remove();if(enable){const fullscreenCSS=`<style>.card{width:100%!important;height:100vh!important;max-width:none!important;margin:0!important;padding:0!important;border:none!important;border-radius:0!important;box-shadow:none!important;overflow:hidden!important}.card-int{border-radius:0!important}.btn1,.btn2,.btn3,.btn4{display:none!important}@media(min-width:768px){#QQ_home_page,#QQ_message_list_page{max-width:580px!important;margin:0 auto!important;border-left:1px solid #e0e0e0!important;border-right:1px solid #e0e0e0!important;min-height:100vh!important;background:linear-gradient(to bottom,#f8f9fa 0%,#ffffff 100%)!important}#QQ_space_page{max-width:620px!important;margin:0 auto!important;border-left:1px solid #e0e0e0!important;border-right:1px solid #e0e0e0!important;min-height:100vh!important;background:linear-gradient(to bottom,#f8f9fa 0%,#ffffff 100%)!important}.QQ_chat_page{max-width:600px!important;margin:0 auto!important;border-left:1px solid #e0e0e0!important;border-right:1px solid #e0e0e0!important}#App_discord .discord-homepage{max-width:620px!important;margin:0 auto!important;border-left:1px solid #e0e0e0!important;border-right:1px solid #e0e0e0!important;background:linear-gradient(to bottom,#f8f9fa 0%,#ffffff 100%)!important}#QQ_home_page .QQ_home_container{padding:15px 20px!important;max-width:100%!important}.QQ_home_usermsg{margin-bottom:8px!important;padding:12px 15px!important;border-radius:12px!important;background:rgba(255,255,255,0.8)!important;backdrop-filter:blur(10px)!important;box-shadow:0 2px 8px rgba(0,0,0,0.06)!important;transition:all 0.2s ease!important}.QQ_home_usermsg:hover{transform:translateY(-1px)!important;box-shadow:0 4px 12px rgba(0,0,0,0.1)!important}#QQ_space_page .space_contents{width:100%!important;max-width:none!important;padding:15px 20px!important;box-sizing:border-box!important;min-height:calc(100vh-120px)!important}#contact_search_input{}#QQ_home_chars{width:100%!important;max-width:none!important;padding:10px 15px!important;display:flex!important;flex-direction:column!important;gap:15px!important;height:calc(100vh-160px)!important;overflow-y:auto!important}.QQ_home_char[data-group-id]{order:1!important;display:flex!important;align-items:center!important;background:rgba(255,255,255,0.95)!important;border-radius:12px!important;padding:12px 15px!important;margin-bottom:8px!important;box-shadow:0 2px 8px rgba(0,0,0,0.08)!important;transition:all 0.3s ease!important;width:100%!important;min-height:60px!important}.QQ_home_char[data-group-id]:hover{transform:translateY(-1px)!important;box-shadow:0 4px 15px rgba(0,0,0,0.12)!important}.QQ_home_char[data-group-id]img{width:45px!important;height:45px!important;border-radius:8px!important;margin-right:15px!important;flex-shrink:0!important}.QQ_home_char[data-group-id].QQ_home_name,.QQ_home_char[data-group-id]span{font-size:16px!important;font-weight:600!important;color:#333!important;flex:1!important;text-align:left!important}.ungrouped-header{order:2!important;background:rgba(248,249,250,0.95)!important;padding:12px 15px!important;font-size:14px!important;font-weight:600!important;color:#666!important;border-radius:8px!important;margin:10px 0 5px 0!important}.ungrouped-contacts{order:3!important;width:100%!important}.QQ_home_char:not([data-group-id]){order:4!important;display:inline-flex!important;flex-direction:column!important;align-items:center!important;justify-content:center!important;background:rgba(255,255,255,0.95)!important;border-radius:12px!important;padding:15px 10px!important;margin:5px!important;box-shadow:0 2px 8px rgba(0,0,0,0.06)!important;transition:all 0.3s ease!important;width:calc(20%-10px)!important;min-width:90px!important;max-width:120px!important;text-align:center!important}.QQ_home_char:not([data-group-id]):hover{transform:translateY(-2px)!important;box-shadow:0 6px 20px rgba(0,0,0,0.1)!important}.QQ_home_char:not([data-group-id])img{width:55px!important;height:55px!important;border-radius:50%!important;border:2px solid rgba(255,255,255,0.8)!important;box-shadow:0 2px 6px rgba(0,0,0,0.1)!important;margin:0 0 10px 0!important;flex-shrink:0!important}.QQ_home_char:not([data-group-id]).char-name,.QQ_home_char:not([data-group-id])span{width:100%!important;text-align:center!important;font-weight:500!important;color:#333!important;font-size:13px!important;line-height:1.2!important;word-break:break-all!important}#QQ_home_chars::after{content:'';display:block;width:100%;height:20px;order:5}#QQ_home_chars.searching{display:flex!important;flex-direction:column!important;gap:8px!important}#QQ_home_chars.searching .QQ_home_char{order:unset!important;display:flex!important;flex-direction:row!important;align-items:center!important;width:100%!important;max-width:none!important;min-width:unset!important;padding:12px 15px!important;margin:0!important;text-align:left!important}#QQ_home_chars.searching .QQ_home_char img{width:45px!important;height:45px!important;margin:0 15px 0 0!important;border-radius:50%!important}#QQ_home_chars.searching .QQ_home_char[data-group-id]img{border-radius:8px!important}#QQ_home_chars.searching .QQ_home_char span,#QQ_home_chars.searching .QQ_home_char .char-name,#QQ_home_chars.searching .QQ_home_char .QQ_home_name{font-size:16px!important;text-align:left!important;flex:1!important;margin:0!important}#QQ_home_chars.searching .ungrouped-header{display:none!important}#QQ_space_page .space_contents .moment-card{background:rgba(255,255,255,0.95)!important;border-radius:15px!important;padding:20px!important;margin-bottom:15px!important;box-shadow:0 2px 15px rgba(0,0,0,0.08)!important;backdrop-filter:blur(15px)!important;border:1px solid rgba(255,255,255,0.3)!important}.space_contents>div{max-width:100%!important;margin:0 auto 10px auto!important;padding:0 5px!important}.QQ_chat_page .input-container{max-width:600px!important;left:50%!important;transform:translateX(-50%)!important;border-left:1px solid #e0e0e0!important;border-right:1px solid #e0e0e0!important}.discord-thread-input{max-width:620px!important;left:50%!important;transform:translateX(-50%)!important}.bottom-navigation{max-width:620px!important;left:50%!important;transform:translateX(-50%)!important;border-radius:25px 25px 0 0!important;backdrop-filter:blur(20px)!important;background:rgba(255,255,255,0.95)!important;border:1px solid rgba(255,255,255,0.3)!important;border-bottom:none!important}}</style>`;$('head').append(fullscreenCSS);toastr.success('全屏模式已启用','显示设置');}else{toastr.info('全屏模式已禁用','显示设置');}}function QQ_ShowInteractiveSettings(){$('.QQ_interactive_settings_panel').remove();const currentInteractiveSettings=QQ_GetInteractiveSettings();const currentFullscreenEnabled=QQ_IsFullscreenEnabled();const panelHtml=`<div class="QQ_interactive_settings_panel" style=" position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.3);z-index:99999999;overflow:hidden;animation:settingsPanelSlideIn 0.3s ease;max-width:90%;max-height:85%;width:420px;overflow-y:auto;"><div class="panel-header" style=" background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px;text-align:center;font-weight:600;"><div style="display:flex;align-items:center;justify-content:center;gap:10px;"><span style="font-size:20px;">⚙️</span><span style="font-size:16px;">界面设置</span></div></div><div class="panel-content" style="padding:20px;"><div style=" background:linear-gradient(135deg,#E8F5E8 0%,#F0F8FF 100%);padding:15px;border-radius:8px;margin-bottom:25px;border-left:4px solid #4CAF50;"><div style="font-weight:600;color:#4CAF50;margin-bottom:12px;display:flex;align-items:center;gap:8px;"><span>🖥️</span><span>全屏显示设置</span></div><label style=" display:flex;align-items:center;gap:10px;cursor:pointer;margin-bottom:10px;"><input type="checkbox" id="enableFullscreen" ${currentFullscreenEnabled ? 'checked':''}style=" width:18px;height:18px;accent-color:#4CAF50;"><span style="font-weight:500;">启用全屏模式</span></label><div style="font-size:13px;color:#666;line-height:1.4;margin-left:28px;"><div>📱<strong>手机设备：</strong>界面将占满整个屏幕，提供沉浸式体验</div><div style="margin-top:4px;">💻<strong>电脑设备：</strong>核心界面居中显示，避免过度拉伸</div><div style="margin-top:4px;color:#888;">✨ 临时切换模式，每次重新加载都会恢复默认状态</div></div></div><hr style="border:none;border-top:1px solid #e9ecef;margin:25px 0;"><div style="margin-bottom:20px;"><div style="font-weight:600;color:#667eea;margin-bottom:15px;display:flex;align-items:center;gap:8px;"><span>💫</span><span>互动内容触发设置</span></div><div style=" background:#f8f9fa;padding:12px;border-radius:6px;margin-bottom:15px;border-left:3px solid #667eea;"><div style="font-weight:500;color:#667eea;margin-bottom:6px;display:flex;align-items:center;gap:6px;"><span>✅</span><span>特殊符号触发（永久启用）</span></div><div style="font-size:12px;color:#666;line-height:1.4;">使用<code style="background:#667eea;color:white;padding:2px 6px;border-radius:3px;font-weight:600;">&&</code>符号可以随时触发互动内容<br><span style="color:#888;">例如：</span><code style="background:#f1f3f4;padding:2px 6px;border-radius:3px;margin-left:4px;">&&想要拥抱你</code></div></div><label style=" display:flex;align-items:center;gap:10px;cursor:pointer;font-weight:500;margin-bottom:15px;"><input type="checkbox" id="enableKeywordTrigger" ${currentInteractiveSettings.enableKeywordTrigger ? 'checked':''}style=" width:18px;height:18px;accent-color:#667eea;"><span>启用关键词触发</span></label><div id="keywordSettings" style=" margin-left:28px;${currentInteractiveSettings.enableKeywordTrigger ? '':'opacity:0.5;pointer-events:none;'}"><label style=" display:flex;align-items:center;gap:10px;cursor:pointer;margin-bottom:12px;"><input type="checkbox" id="enableDefaultKeywords" ${currentInteractiveSettings.enableDefaultKeywords ? 'checked':''}style=" width:16px;height:16px;accent-color:#667eea;"><span style="font-size:14px;">使用默认关键词（拥抱、亲吻、触摸等）</span></label><div style="margin-bottom:12px;"><div style="font-size:14px;font-weight:500;margin-bottom:6px;color:#333;">自定义关键词</div><div style="font-size:12px;color:#666;margin-bottom:6px;">输入您想要触发互动内容的关键词，用英文逗号分隔：</div><textarea id="customKeywords" placeholder="例如：想你了,抱抱,一起玩" style=" width:100%;height:50px;padding:8px;border:1px solid #ddd;border-radius:6px;font-size:13px;resize:none;box-sizing:border-box;">${currentInteractiveSettings.customKeywords.join(',')}</textarea></div></div></div><div style=" background:#f8f9fa;padding:12px;border-radius:6px;font-size:12px;color:#666;line-height:1.4;"><div style="font-weight:600;margin-bottom:6px;">📝 触发条件说明：</div><div>• 特殊符号&&总是优先触发（无需设置）</div><div>• 自定义关键词：包含任一关键词即触发</div><div>• 默认关键词：需要满足2个关键词或1个动作模式</div><div>• AI回复无格式时也会自动触发互动模式</div></div></div><div class="panel-actions" style=" padding:20px;background:#fafafa;display:flex;gap:10px;"><button class="save-settings-btn" style=" flex:1;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border:none;color:white;padding:12px 16px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;transition:all 0.2s ease;">保存设置</button><button class="cancel-settings-btn" style=" flex:1;background:#e9ecef;border:none;color:#666;padding:12px 16px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;transition:all 0.2s ease;">取消</button></div></div><style>@keyframes settingsPanelSlideIn{from{opacity:0;transform:translate(-50%,-60%)}to{opacity:1;transform:translate(-50%,-50%)}}.QQ_interactive_settings_panel .save-settings-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(102,126,234,0.3)}.QQ_interactive_settings_panel .cancel-settings-btn:hover{background:#dee2e6}</style>`;$('body').append(panelHtml);$('#enableKeywordTrigger').on('change',function(){const isEnabled=this.checked;const keywordSettings=$('#keywordSettings');if(isEnabled){keywordSettings.css({'opacity':'1','pointer-events':'auto'});}else{keywordSettings.css({'opacity':'0.5','pointer-events':'none'});}});$('#enableFullscreen').on('change',function(){const isEnabled=this.checked;QQ_ApplyFullscreenMode(isEnabled);});$('.save-settings-btn').on('click',function(){const newInteractiveSettings={enableKeywordTrigger:$('#enableKeywordTrigger').prop('checked'),enableDefaultKeywords:$('#enableDefaultKeywords').prop('checked'),customKeywords:$('#customKeywords').val().split(',').map(k=>k.trim()).filter(k=>k.length>0)};const currentFullscreenEnabled=$('#enableFullscreen').prop('checked');if(QQ_SaveInteractiveSettings(newInteractiveSettings)){$('.QQ_interactive_settings_panel').remove();setTimeout(()=>{QQ_ApplyFullscreenMode(currentFullscreenEnabled);},50);const fullscreenStatus=currentFullscreenEnabled ? '已启用（临时）':'已禁用';const keywordStatus=newInteractiveSettings.enableKeywordTrigger ? '已启用':'已禁用';const message=`✅ 设置已保存！
🖥️ 全屏模式：${fullscreenStatus}🎯 特殊符号触发：永久启用(&&)💫 关键词触发：${keywordStatus}`;toastr.success(message,'设置保存成功',{timeOut:4000,extendedTimeOut:2000});}else{toastr.error('保存设置时出现错误，请重试','设置保存失败');}});$('.cancel-settings-btn').on('click',function(){QQ_ApplyFullscreenMode(currentFullscreenEnabled);$('.QQ_interactive_settings_panel').remove();toastr.info('已取消设置修改','设置');});$(document).one('click',function(){QQ_ApplyFullscreenMode(currentFullscreenEnabled);$('.QQ_interactive_settings_panel').remove();});$('.QQ_interactive_settings_panel').on('click',function(e){e.stopPropagation();});}function QQ_HandleInteractiveContent(content,characterName=""){let cleanContent;if(QQ_HasContentTag(content)){cleanContent=QQ_CleanContentTags(content);}else{cleanContent=content
.replace(/MiPhone_start/g,"").replace(/MiPhone_end/g,"").trim();}const targetCharacter=characterName||QQ_LastRequestName||charcardname||"角色";const hasPriorReplyRequest=QQ_CheckPriorReplyRequest(cleanContent);if(hasPriorReplyRequest.shouldReplyFirst){QQ_ExecutePriorReply(hasPriorReplyRequest.replyType,hasPriorReplyRequest.replyContent,targetCharacter);setTimeout(()=>{QQ_ProceedToInteractiveMode(cleanContent,targetCharacter);},2000);return;}QQ_ProceedToInteractiveMode(cleanContent,targetCharacter);}function QQ_CheckPriorReplyRequest(content){const priorReplyPatterns=[{pattern:/(?:先|首先|先在私聊)(?:回复|回应|回答|说)(?:.*?)(?:然后|接着|再)(?:.*?)(?:互动|见面|过来)/,type:'private',extract:(match)=>QQ_ExtractReplyContent(match,'private')},{pattern:/(?:先|首先|先在群聊)(?:回复|回应|回答|说)(?:.*?)(?:然后|接着|再)(?:.*?)(?:互动|见面|过来)/,type:'group',extract:(match)=>QQ_ExtractReplyContent(match,'group')},{pattern:/(?:先|首先)(?:发|发送|回)(?:.*?)(?:消息|信息)(?:.*?)(?:然后|接着|再)(?:.*?)(?:互动|见面|过来)/,type:'auto',extract:(match)=>QQ_ExtractReplyContent(match,'auto')}];for(const item of priorReplyPatterns){const match=content.match(item.pattern);if(match){const replyContent=item.extract(match[0]);return{shouldReplyFirst:true,replyType:item.type,replyContent:replyContent,fullMatch:match[0]};}}return{shouldReplyFirst:false};}function QQ_ExtractReplyContent(matchText,type){const replyExtractPatterns=[/(?:回复|回应|回答|说)["'"]([^"'"]*)["'"]/,/(?:回复|回应|回答|说)[:：]\s*([^，。！？]*)/,/(?:回复|回应|回答|说)\s*([^然后接着再]*?)(?:然后|接着|再)/];for(const pattern of replyExtractPatterns){const match=matchText.match(pattern);if(match&&match[1].trim()){return match[1].trim();}}return type==='private' ? '好的，我马上过来':type==='group' ? '大家等我一下，马上过来':'好的，马上过来';}function QQ_ExecutePriorReply(replyType,replyContent,targetCharacter){if(replyType==='private'||(replyType==='auto'&&QQ_IsInPrivateChat())){QQ_SendPrivateMessage(targetCharacter,replyContent);}else if(replyType==='group'||(replyType==='auto'&&QQ_IsInGroupChat())){QQ_SendGroupMessage(replyContent);}else{QQ_SendPrivateMessage(targetCharacter,replyContent);}triggerSlash(`/echo 已发送回复消息，即将进入互动模式...`);}function QQ_ProceedToInteractiveMode(content,targetCharacter){const isMultiCharacter=QQ_DetectMultiCharacterInteraction(content,targetCharacter);if(isMultiCharacter){(async()=>{await QQ_ShowPublicInteractiveSpace(content,targetCharacter);})();}else{(async()=>{await QQ_ShowCharacterInteractiveSpace(content,targetCharacter);})();}}function QQ_IsInPrivateChat(){const chatPage=document.querySelector('.QQ_chat_page:visible');if(!chatPage)return false;const chatTitle=document.getElementById('QQ_chat_username');return chatTitle&&!chatTitle.textContent.includes('群聊');}function QQ_IsInGroupChat(){const chatPage=document.querySelector('.QQ_chat_page:visible');if(!chatPage)return false;const chatTitle=document.getElementById('QQ_chat_username');return chatTitle&&chatTitle.textContent.includes('群聊');}function QQ_SendPrivateMessage(characterName,content){const messageData={time:QQ_GetTime(),content:content,sender:characterName};const chatContent=`<${QQ_GetUserName()}和${characterName}的私聊>\n${characterName}--${content}--${messageData.time}\n</${QQ_GetUserName()}和${characterName}的私聊>`;const currentChat=document.querySelector('.QQ_chat_page:visible');if(currentChat&&QQ_IsTargetChat(characterName)){QQ_AddMessageToCurrentChat(characterName,content,messageData.time);}QQ_SavePrivateMessage(characterName,messageData);}function QQ_SendGroupMessage(content){const currentGroup=QQ_GetCurrentGroupName();if(!currentGroup){console.warn('当前不在群聊界面，无法发送群聊消息');return;}const messageData={time:QQ_GetTime(),content:content,sender:charcardname||"角色"};QQ_AddMessageToCurrentChat(messageData.sender,content,messageData.time);QQ_SaveGroupMessage(currentGroup,messageData);}function QQ_GetCurrentGroupName(){const chatTitle=document.getElementById('QQ_chat_username');if(!chatTitle)return null;const titleText=chatTitle.textContent;if(titleText.includes('群聊:')){return titleText.replace('群聊:','').trim();}return null;}function QQ_IsTargetChat(characterName){const chatTitle=document.getElementById('QQ_chat_username');if(!chatTitle)return false;return chatTitle.textContent.includes(characterName);}function QQ_AddMessageToCurrentChat(sender,content,time){const chatMessages=document.getElementById('QQ_chat_messages');if(!chatMessages)return;const messageElement=document.createElement('div');messageElement.className='QQ_message';messageElement.innerHTML=`<div class="QQ_message_sender">${sender}</div><div class="QQ_message_content">${content}</div><div class="QQ_message_time">${time}</div>`;chatMessages.appendChild(messageElement);chatMessages.scrollTop=chatMessages.scrollHeight;}function QQ_DetectMultiCharacterInteraction(content,primaryCharacter=null){const strongMultiKeywords=[{keyword:'所有人',context:['对所有人','告诉所有人','和所有人']},{keyword:'众人',context:['众人面前','对众人','众人一起']},{keyword:'全体',context:['全体成员','对全体','全体一起']},{keyword:'我们一起',context:['我们一起去','我们一起做','我们一起来']},{keyword:'他们一起',context:['他们一起去','他们一起做','他们一起来']},{keyword:'共同参与',context:['共同参与活动','共同参与讨论']},{keyword:'同时参与',context:['同时参与互动','同时参与活动']},{keyword:'围成圈',context:['围成圈坐','围成圈站','围成圈讨论']},{keyword:'排成队',context:['排成队走','排成队等','排成队站']},{keyword:'分成组',context:['分成组讨论','分成组活动','分成组进行']},{keyword:'聚在一起',context:['聚在一起聊','聚在一起玩','聚在一起讨论']}];for(const item of strongMultiKeywords){if(content.includes(item.keyword)){const hasValidContext=item.context.some(ctx=>content.includes(ctx))||QQ_IsValidMultiPersonContext(content,item.keyword);if(hasValidContext){return true;}else{}}}const characterMentions=content.match(/[@【（＜]\s*([^@【（＜】）＞\s]{2,8})\s*[】）＞]/g)||[];const uniqueCharacters=[...new Set(characterMentions.map(m=>m.replace(/[@【（＜】）＞]/g,'').trim()))];if(primaryCharacter&&uniqueCharacters.length>=1){const isPrimaryDominant=QQ_IsPrimaryCharacterDominant(content,primaryCharacter,uniqueCharacters);if(isPrimaryDominant){return false;}}if(uniqueCharacters.length>1){return true;}const strongMultiPersonPatterns=[/(\w+)和(\w+)(?:以及|还有|加上)(\w+)/,/(\w+)、(\w+)(?:、(\w+))+/,/(?:和|与|跟)(\w+)(?:他们|她们|大家)(?:一起|同时)/,/(?:我们|咱们)(?:几个|多个|全部)(?:一起|同时)/];if(strongMultiPersonPatterns.some(pattern=>pattern.test(content))){return true;}return false;}function QQ_IsValidMultiPersonContext(content,keyword){const invalidContexts=[/集体行动/,/集体活动/,/集体决策/,/集体利益/,/集体意识/,/集体记忆/,/概念上/,/理论上/,/原则上/,/思想上/,/精神上/,/曾经.*一起/,/以前.*一起/,/之前.*一起/,/过去.*一起/,/如果.*一起/,/假如.*一起/,/要是.*一起/,/倘若.*一起/];if(invalidContexts.some(pattern=>pattern.test(content))){return false;}const interactiveVerbs=[/一起(去|来|做|玩|聊|讨论|参与|进行)/,/(对|和|跟).*(说|讲|聊|交流)/,/(抱|拥抱|亲吻|握手|拍|碰|摸)/,/(看|望|注视|凝视).*(着|向)/,/(走向|走近|靠近|接近)/];const hasInteractiveVerb=interactiveVerbs.some(pattern=>pattern.test(content));const currentTimeIndicators=[/现在/,/此刻/,/当前/,/马上/,/立即/,/正在/,/要.*一起/,/想.*一起/,/准备.*一起/];const hasCurrentTime=currentTimeIndicators.some(pattern=>pattern.test(content));return hasInteractiveVerb||hasCurrentTime;}function QQ_IsPrimaryCharacterDominant(content,primaryCharacter,allCharacters){let primaryWeight=0;let otherWeight=0;const primaryCount=(content.match(new RegExp(primaryCharacter,'g'))||[]).length;const otherCounts=allCharacters
.filter(char=>char!==primaryCharacter).reduce((sum,char)=>sum+(content.match(new RegExp(char,'g'))||[]).length,0);primaryWeight+=primaryCount*2;otherWeight+=otherCounts;const interactionPatterns=[new RegExp(`${primaryCharacter}(?:走向|走近|抱住|拉住|看着|对.*说)`,'g'),new RegExp(`(?:走向|走近|抱住|拉住|看着|对)${primaryCharacter}`,'g'),];interactionPatterns.forEach(pattern=>{const matches=content.match(pattern)||[];primaryWeight+=matches.length*3;});const directDialogPatterns=[new RegExp(`${primaryCharacter}[说道讲]`,'g'),new RegExp(`对${primaryCharacter}说`,'g'),];directDialogPatterns.forEach(pattern=>{const matches=content.match(pattern)||[];primaryWeight+=matches.length*2;});const intimatePatterns=[new RegExp(`(?:和|与|跟)${primaryCharacter}(?:单独|私下|悄悄|偷偷)`,'g'),new RegExp(`${primaryCharacter}(?:单独|私下|悄悄|偷偷)`,'g'),];intimatePatterns.forEach(pattern=>{const matches=content.match(pattern)||[];primaryWeight+=matches.length*4;});return primaryWeight>otherWeight*0.6;}function QQ_ShowPublicInteractiveSpace(content,characterName=""){const spaceId=QQ_GenerateSpaceId();const spaceName=QQ_GetSpaceName(content,characterName);const charName=characterName||charcardname||"角色";const charAvatar=charAvatarPath||"default_avatar.png";QQ_InteractiveSpaces[spaceId]={id:spaceId,name:spaceName,content:content,characterName:charName,characterAvatar:charAvatar,type:'public',participants:QQ_ExtractParticipants(content),createdAt:new Date().toISOString(),lastAccess:new Date().toISOString()};QQ_ActiveSpaceId=spaceId;QQ_SaveInteractiveSpaces().then(()=>{}).catch(error=>{console.error('❌ 公共互动空间保存失败:',error);});QQ_DisplayInteractiveSpace(spaceId,'公共互动空间');}async function QQ_ShowCharacterInteractiveSpace(content,characterName){const charName=characterName||charcardname||"角色";await QQ_ForceReloadInteractiveSpaces();const spaceId=QQ_GenerateSpaceId();const spaceName=`${charName}·${QQ_GetSceneFromContent(content)}`;const charAvatar=charAvatarPath||"default_avatar.png";QQ_EnsureCharacterSpaceIndependence(charName);QQ_CharacterSpaces[charName][spaceId]={id:spaceId,name:spaceName,content:content,characterName:charName,characterAvatar:charAvatar,type:'character',createdAt:new Date().toISOString(),lastAccess:new Date().toISOString()};QQ_ActiveSpaceId=spaceId;QQ_SaveCharacterSpaces().then(()=>{}).catch(error=>{console.error(`❌ 角色互动空间保存失败:${charName}`,error);});QQ_DisplayCharacterSpace(spaceId,charName);}function QQ_ExtractParticipants(content){const mentions=content.match(/[@【（＜]\s*([^@【（＜】）＞\s]{2,8})\s*[】）＞]/g)||[];const participants=mentions.map(m=>m.replace(/[@【（＜】）＞]/g,'').trim());return[...new Set(participants)];}function QQ_GetSceneFromContent(content){const sceneKeywords=[{keywords:['拥抱','抱抱','安慰'],name:'温暖时刻'},{keywords:['聊天','谈话','交流'],name:'谈话'},{keywords:['游戏','玩耍','娱乐'],name:'游戏'},{keywords:['学习','工作','努力'],name:'学习'},{keywords:['散步','走路','逛'],name:'散步'},{keywords:['吃饭','用餐','食物'],name:'用餐'},{keywords:['睡觉','休息','午睡'],name:'休息'},{keywords:['看书','阅读','学习'],name:'阅读'},];for(const scene of sceneKeywords){if(scene.keywords.some(keyword=>content.includes(keyword))){return scene.name;}}return '日常';}async function QQ_SaveCharacterSpaces(){try{if(!worldbook||!entries){console.warn('世界书功能不可用，无法保存角色互动空间');return;}const spaceData={characterSpaces:QQ_CharacterSpaces,lastUpdated:new Date().toISOString(),version:"1.0"};let entry=entries.find(e=>e.comment===QQ_CHARACTER_SPACES_KEY);if(!entry){entry={comment:QQ_CHARACTER_SPACES_KEY,content:JSON.stringify(spaceData),key:["此世界书永不触发_角色互动空间"],keysecondary:[],order:1001,enabled:true,uid:Date.now()+1};if(worldbook.entries){worldbook.entries.push(entry);}}else{entry.content=JSON.stringify(spaceData);}const success=await QQ_SafeSaveWorldInfo("角色互动空间数据");if(success){const totalSpaces=Object.values(QQ_CharacterSpaces).reduce((sum,char)=>sum+Object.keys(char).length,0);console.log('角色互动空间数据保存完成:',Object.keys(QQ_CharacterSpaces).length,'个角色,',totalSpaces,'个空间');}}catch(error){console.error('保存角色互动空间时发生错误:',error);}}function QQ_DisplayInteractiveSpace(spaceId,spaceTitle,characterName=null){const spaceData=characterName ?
QQ_CharacterSpaces[characterName][spaceId]:QQ_InteractiveSpaces[spaceId];if(!spaceData){console.error('未找到互动空间数据:',spaceId);return;}$('.QQ_interactive_space').remove();const isCharacterSpace=spaceData.type==='character';const headerColor=isCharacterSpace ?
'linear-gradient(135deg,#FF6B6B 0%,#FF8E53 100%)':'linear-gradient(135deg,#4FC3F7 0%,#29B6F6 100%)';const interactiveSpaceHtml=`<div class="QQ_interactive_space" data-space-id="${spaceId}" style=" position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.3s ease;backdrop-filter:blur(10px);"><div class="QQ_interactive_content" style=" background:#ffffff;border-radius:20px;padding:0;max-width:90%;max-height:80%;overflow:hidden;box-shadow:0 20px 40px rgba(0,0,0,0.3);position:relative;color:#333;animation:slideIn 0.3s ease;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;"><div class="QQ_interactive_header" style=" background:${headerColor};padding:25px 20px;display:flex;align-items:center;color:white;position:relative;"><img src="${spaceData.characterAvatar}" alt="${spaceData.characterName}" style=" width:50px;height:50px;border-radius:50%;margin-right:15px;border:3px solid white;box-shadow:0 3px 10px rgba(0,0,0,0.2);"><div style="flex:1;"><h3 style="margin:0;font-size:18px;font-weight:600;">${spaceData.name}</h3><p style="margin:5px 0 0 0;font-size:13px;opacity:0.9;">${isCharacterSpace ? `${spaceData.characterName}的专属互动`:'公共互动空间'}</p></div><button class="QQ_close_interactive" style=" background:rgba(255,255,255,0.2);border:none;color:white;width:36px;height:36px;border-radius:50%;cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">×</button></div><div class="QQ_interactive_body" style=" padding:30px 25px;font-size:16px;line-height:1.6;white-space:pre-wrap;color:#333;background:#fafafa;max-height:350px;overflow-y:auto;word-wrap:break-word;">${spaceData.content}</div><div class="QQ_interactive_footer" style=" padding:25px;background:#ffffff;border-top:1px solid #eee;display:flex;justify-content:center;gap:15px;"><button class="QQ_reply_interactive" style=" background:${isCharacterSpace ? '#FF6B6B':'#4FC3F7'};border:none;color:white;padding:14px 28px;border-radius:25px;cursor:pointer;font-size:15px;font-weight:500;transition:all 0.3s ease;box-shadow:0 3px 10px ${isCharacterSpace ? 'rgba(255,107,107,0.3)':'rgba(79,195,247,0.3)'};" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">💬 回应互动</button><button class="QQ_close_interactive" style=" background:#f5f5f5;border:none;color:#666;padding:14px 28px;border-radius:25px;cursor:pointer;font-size:15px;font-weight:500;transition:all 0.3s ease;" onmouseover="this.style.background='#eeeeee'" onmouseout="this.style.background='#f5f5f5'">关闭</button></div></div></div><style>@keyframes fadeIn{from{opacity:0}to{opacity:1}}@keyframes slideIn{from{transform:translateY(-30px);opacity:0}to{transform:translateY(0);opacity:1}}.QQ_interactive_space*{user-select:text}.QQ_interactive_body::-webkit-scrollbar{width:6px}.QQ_interactive_body::-webkit-scrollbar-track{background:#f1f1f1;border-radius:3px}.QQ_interactive_body::-webkit-scrollbar-thumb{background:#c1c1c1;border-radius:3px}.QQ_interactive_body::-webkit-scrollbar-thumb:hover{background:#a8a8a8}</style>`;$('body').append(interactiveSpaceHtml);$('.QQ_close_interactive').on('click',function(){$('.QQ_interactive_space').fadeOut(300,function(){$(this).remove();});});$('.QQ_reply_interactive').on('click',function(){QQ_OpenInteractiveReply(isCharacterSpace ? characterName:spaceData.characterName);});$('.QQ_interactive_space').on('click',function(e){if(e.target===this){$(this).fadeOut(300,function(){$(this).remove();});}});}function QQ_DisplayCharacterSpace(spaceId,characterName){QQ_DisplayInteractiveSpace(spaceId,`${characterName}的互动空间`,characterName);}function QQ_ShowCharacterInteractiveMenu(characterName,element){QQ_ShowCharacterSpirit(characterName);}function QQ_IsWorldBookAvailable(){if(!worldbook||!entries){if(!worldbook){const sources=[()=>window.world_info,()=>window.worldbook,()=>globalThis.world_info,()=>globalThis.worldbook];for(const getSource of sources){try{const source=getSource();if(source&&typeof source==='object'){worldbook=source;window.worldbook=worldbook;break;}}catch(e){}}}if(!worldbook||!entries){console.warn('⚠️ 世界书功能不可用:worldbook或entries未定义');return false;}}return true;}async function QQ_SafeSaveWorldInfo(operation="数据"){try{if(!worldbook||!entries){console.warn(`世界书功能不可用，无法保存${operation}`);return false;}if(typeof saveWorldInfo==='function'){await saveWorldInfo();}else{}return true;}catch(error){console.error(`保存${operation}到世界书失败:`,error);return false;}}let QQ_CharacterSpirits={};function QQ_GetCharacterAvatar(characterName){try{let avatarUrl=null;const worldbookAvatar=getCharacterAvatarFromWorldbook(characterName);if(worldbookAvatar&&worldbookAvatar.avatarUrl){avatarUrl=worldbookAvatar.avatarUrl;return avatarUrl;}const chatAvatar=$(`.QQ_chat_item[data-name="${characterName}"]img`).attr('src');if(chatAvatar&&chatAvatar!=='undefined'&&chatAvatar!==''&&!chatAvatar.includes('undefined')){avatarUrl=chatAvatar;}if(!avatarUrl){const contactAvatar=getCharacterAvatar(characterName);if(contactAvatar&&contactAvatar.backgroundImage){const urlMatch=contactAvatar.backgroundImage.match(/url\(["']?([^"']*)["']?\)/);if(urlMatch&&urlMatch[1]){avatarUrl=urlMatch[1];}}}if(!avatarUrl&&typeof getCharacterAvatar==='function'){try{const stAvatar=getCharacterAvatar(characterName);if(stAvatar&&stAvatar!=='undefined'&&stAvatar!==''){avatarUrl=stAvatar;}}catch(e){console.warn('SillyTavern getCharacterAvatar函数调用失败:',e);}}if(!avatarUrl&&typeof characters!=='undefined'&&Array.isArray(characters)){const character=characters.find(char=>char.name===characterName||char.avatar===characterName);if(character&&character.avatar){avatarUrl=character.avatar;}}if(!avatarUrl&&typeof window.SillyTavern!=='undefined'){try{const context=window.SillyTavern.getContext();if(context&&context.characters){const character=context.characters.find(char=>char.name===characterName);if(character&&character.avatar){avatarUrl=character.avatar;}}}catch(e){console.warn('获取SillyTavern context失败:',e);}}if(!avatarUrl){const titleAvatar=$(`.QQ_chat_title[data-name="${characterName}"]img`).attr('src');if(titleAvatar&&titleAvatar!=='undefined'&&titleAvatar!==''){avatarUrl=titleAvatar;}}if(!avatarUrl){try{if(typeof worldbook!=='undefined'&&worldbook){getLorebookEntries(worldbook).then(entries=>{if(entries){const avatarEntry=entries.find(entry=>entry.comment&&entry.comment.includes('随机头像'));if(avatarEntry&&avatarEntry.content){const avatarList=avatarEntry.content.split('\n').filter(line=>line.trim()&&(line.includes('http')||line.includes('files.catbox.moe')));if(avatarList.length>0){const randomIndex=characterName.length % avatarList.length;const randomAvatar=avatarList[randomIndex].trim();if(!avatarUrl||avatarUrl.includes('default')){avatarUrl=randomAvatar;}}}}}).catch(e=>{console.warn('异步获取随机头像失败:',e);});}}catch(e){console.warn('获取随机头像失败:',e);}if(!avatarUrl){avatarUrl='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiByeD0iMzAiIGZpbGw9IiNGRjZCNkIiLz4KPHR leHQgeD0iMzAiIHk9IjM1IiBmb250LXNpemU9IjI0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9ImFyaWFsIj7igKI8L3RleHQ+Cjwvc3ZnPgo=';}}if(avatarUrl&&typeof avatarUrl==='string'){if(avatarUrl.startsWith('http')||avatarUrl.startsWith('data:')||avatarUrl.startsWith('blob:')){console.log(`✅ 使用完整URL:${avatarUrl.substring(0,100)}...`);}else if(avatarUrl.startsWith('./')||avatarUrl.startsWith('../')){}else if(avatarUrl.startsWith('characters/')||avatarUrl.includes('characters/')){if(!avatarUrl.startsWith('/')){avatarUrl='/'+avatarUrl;}}else{if(!avatarUrl.startsWith('/')){avatarUrl='/'+avatarUrl;}}}else{avatarUrl='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiByeD0iMzAiIGZpbGw9IiNGRjZCNkIiLz4KPHR leHQgeD0iMzAiIHk9IjM1IiBmb250LXNpemU9IjI0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9ImFyaWFsIj7igKI8L3RleHQ+Cjwvc3ZnPgo=';console.warn(`头像URL无效，使用默认SVG头像:${characterName}`);}return avatarUrl;}catch(error){console.error('获取角色头像失败:',error);return 'default_avatar.png';}}function QQ_ShowCharacterSpiritPanel(characterName){QQ_PreloadCharacterDataFromWorldbook(characterName);$('.QQ_character_spirit_panel').remove();const characterAvatar=QQ_GetCharacterAvatar(characterName);const panelHtml=`<div class="QQ_character_spirit_panel" style=" position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:999999999;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.3s ease;backdrop-filter:blur(15px);"><div class="QQ_spirit_panel_content" style=" background:#ffffff;border-radius:20px;padding:0;max-width:90%;overflow:hidden;box-shadow:0 20px 40px rgba(0,0,0,0.3);color:#333;animation:slideIn 0.3s ease;width:350px;"><div class="spirit-panel-header" style=" background:linear-gradient(135deg,#FF6B6B 0%,#FF8E53 100%);color:white;padding:20px;text-align:center;position:relative;"><img src="${characterAvatar}" alt="${characterName}" style=" width:60px;height:60px;border-radius:50%;border:3px solid white;margin-bottom:10px;box-shadow:0 4px 15px rgba(0,0,0,0.2);" onerror="this.onerror=null;this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiByeD0iMzAiIGZpbGw9IiNGRjZCNkIiLz4KPHRLEHA+4pWpPC90ZXh0Pgo8L3N2Zz4K';"><h3 style="margin:0;font-size:18px;font-weight:600;">${characterName}</h3><p style="margin:5px 0 0 0;font-size:14px;opacity:0.9;">专属互动精灵</p><button class="QQ_close_spirit_panel" style=" position:absolute;top:15px;right:15px;background:rgba(255,255,255,0.2);border:none;color:white;width:30px;height:30px;border-radius:50%;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">×</button></div><div class="spirit-panel-body" style=" padding:25px 20px;"><p style=" text-align:center;color:#666;margin-bottom:20px;font-size:14px;line-height:1.5;">选择你想要与 ${characterName}进行的互动类型</p><div class="spirit-options" style=" display:flex;flex-direction:column;gap:12px;"><button class="QQ_spirit_option" data-action="interactive_space" style=" background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border:none;color:white;padding:15px 20px;border-radius:12px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.3s ease;box-shadow:0 3px 10px rgba(102,126,234,0.3);display:flex;align-items:center;gap:10px;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'"><span style="font-size:18px;">🌟</span><span>开启互动空间</span></button><button class="QQ_spirit_option" data-action="create_space" style=" background:linear-gradient(135deg,#43e97b 0%,#38f9d7 100%);border:none;color:white;padding:15px 20px;border-radius:12px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.3s ease;box-shadow:0 3px 10px rgba(67,233,123,0.3);display:flex;align-items:center;gap:10px;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'"><span style="font-size:18px;">✨</span><span>创建新互动</span></button><button class="QQ_spirit_option" data-action="public_spaces" style=" background:linear-gradient(135deg,#ff9a9e 0%,#fecfef 100%);border:none;color:white;padding:15px 20px;border-radius:12px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.3s ease;box-shadow:0 3px 10px rgba(255,154,158,0.3);display:flex;align-items:center;gap:10px;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'"><span style="font-size:18px;">🌐</span><span>公共互动空间</span></button><button class="QQ_spirit_option" data-action="hide_spirit" style=" background:#f8f9fa;border:1px solid #e9ecef;color:#6c757d;padding:12px 20px;border-radius:12px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.3s ease;display:flex;align-items:center;gap:10px;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'"><span style="font-size:18px;">👻</span><span>隐藏精灵</span></button></div></div></div></div>`;$('body').append(panelHtml);$('.QQ_close_spirit_panel').on('click',function(){$('.QQ_character_spirit_panel').fadeOut(300,function(){$(this).remove();});});$('.QQ_spirit_option[data-action="interactive_space"]').on('click',function(){$('.QQ_character_spirit_panel').remove();QQ_ShowCharacterInteractiveSpaces(characterName);});$('.QQ_spirit_option[data-action="create_space"]').on('click',function(){$('.QQ_character_spirit_panel').remove();QQ_CreateCharacterInteractiveSpace(characterName);});$('.QQ_spirit_option[data-action="public_spaces"]').on('click',function(){$('.QQ_character_spirit_panel').remove();QQ_ShowPublicInteractiveSpaces();});$('.QQ_spirit_option[data-action="hide_spirit"]').on('click',function(){$('.QQ_character_spirit_panel').remove();QQ_HideCharacterSpirit(characterName);toastr.info(`已隐藏 ${characterName}的精灵按钮`,'精灵按钮');});$('.QQ_character_spirit_panel').on('click',function(e){if(e.target===this){$(this).fadeOut(300,function(){$(this).remove();});}});}function QQ_ShowCharacterInteractiveSpaces(characterName){if(!window.QQ_PreloadedCharacters||!window.QQ_PreloadedCharacters.has(characterName)){QQ_ShowLoadingInteractiveSpaces(characterName);QQ_LoadSpecificCharacterSpaces(characterName).then(()=>{QQ_ShowCharacterInteractiveSpacesList(characterName);}).catch(error=>{console.error('加载角色互动空间失败:',error);toastr.error(`加载 ${characterName}的互动空间失败`,'加载错误');QQ_ShowCharacterInteractiveSpacesList(characterName);});return;}QQ_ShowCharacterInteractiveSpacesList(characterName);}function QQ_ShowLoadingInteractiveSpaces(characterName){$('.QQ_character_spaces_list').remove();const loadingHtml=`<div class="QQ_character_spaces_list" style=" position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:999999999;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.3s ease;backdrop-filter:blur(15px);"><div style=" background:#ffffff;border-radius:20px;padding:40px 30px;max-width:90%;overflow:hidden;box-shadow:0 20px 40px rgba(0,0,0,0.3);color:#333;animation:slideIn 0.3s ease;width:350px;text-align:center;"><div style=" background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px;margin:-40px-30px 30px-30px;text-align:center;"><h3 style="margin:0;font-size:18px;font-weight:600;">正在加载...</h3><p style="margin:5px 0 0 0;font-size:12px;opacity:0.9;">${characterName}的互动空间数据</p></div><div style=" margin:20px 0;"><div style=" width:50px;height:50px;border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px auto;"></div><p style=" color:#666;font-size:14px;line-height:1.5;margin:0;">正在从世界书加载互动空间数据...<br/><small style="font-size:12px;opacity:0.7;">首次加载可能需要几秒钟</small></p></div></div></div><style>@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}</style>`;$('body').append(loadingHtml);$('.QQ_character_spaces_list').on('click',function(e){if(e.target===this){$(this).remove();}});}function QQ_ShowCharacterInteractiveSpacesList(characterName){if(!QQ_CharacterSpaces[characterName]){QQ_CharacterSpaces[characterName]={};}const characterSpaces=QQ_CharacterSpaces[characterName];const spaceKeys=Object.keys(characterSpaces);if(spaceKeys.length===0){toastr.info(`${characterName}还没有互动空间，点击创建新互动开始吧！`,'互动空间');QQ_CreateCharacterInteractiveSpace(characterName);return;}$('.QQ_character_spaces_list').remove();let spacesListHtml=`<div class="QQ_character_spaces_list" style=" position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:999999999;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.3s ease;backdrop-filter:blur(15px);"><div style=" background:#ffffff;border-radius:20px;padding:0;max-width:90%;max-height:80%;overflow:hidden;box-shadow:0 20px 40px rgba(0,0,0,0.3);color:#333;animation:slideIn 0.3s ease;width:400px;"><div style=" background:linear-gradient(135deg,#FF6B6B 0%,#FF8E53 100%);color:white;padding:20px;text-align:center;position:relative;"><h3 style="margin:0;font-size:18px;font-weight:600;">${characterName}的互动空间</h3><p style="margin:5px 0 0 0;font-size:12px;opacity:0.9;">选择一个互动空间</p><button class="QQ_close_spaces_list" style=" position:absolute;top:15px;right:15px;background:rgba(255,255,255,0.2);border:none;color:white;width:30px;height:30px;border-radius:50%;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;">×</button></div><div style=" padding:20px;max-height:300px;overflow-y:auto;">`;spaceKeys.forEach(spaceId=>{const space=characterSpaces[spaceId];spacesListHtml+=`<div class="QQ_space_item" data-space-id="${spaceId}" style=" background:#f8f9fa;border:1px solid #e9ecef;border-radius:12px;padding:15px;margin-bottom:10px;cursor:pointer;transition:all 0.3s ease;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'"><h4 style="margin:0 0 5px 0;font-size:14px;color:#333;">${space.name}</h4><p style="margin:0;font-size:12px;color:#666;line-height:1.4;">${space.content.substring(0,100)}${space.content.length>100 ? '...':''}</p></div>`;});spacesListHtml+=`</div><div style=" padding:20px;border-top:1px solid #eee;text-align:center;"><button class="QQ_create_new_space" style=" background:linear-gradient(135deg,#43e97b 0%,#38f9d7 100%);border:none;color:white;padding:12px 20px;border-radius:10px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.3s ease;">✨ 创建新互动空间</button></div></div></div>`;$('body').append(spacesListHtml);$('.QQ_close_spaces_list').on('click',function(){$('.QQ_character_spaces_list').remove();});$('.QQ_space_item').on('click',function(){const spaceId=$(this).data('space-id');$('.QQ_character_spaces_list').remove();QQ_DisplayEnhancedInteractiveSpace(spaceId,characterSpaces[spaceId].name,characterName);});$('.QQ_create_new_space').on('click',function(){$('.QQ_character_spaces_list').remove();QQ_CreateCharacterInteractiveSpace(characterName);});$('.QQ_character_spaces_list').on('click',function(e){if(e.target===this){$(this).remove();}});}function QQ_ShowPublicInteractiveSpaces(){QQ_ShowLoadingPublicSpaces();QQ_LoadFullPublicInteractiveSpaces().then((spaces)=>{QQ_ShowPublicInteractiveSpacesList(spaces);}).catch(error=>{console.error('加载公共互动空间失败:',error);toastr.error('加载公共互动空间失败','加载错误');const previewSpaces=window.QQ_PublicSpacePreviews||{};QQ_ShowPublicInteractiveSpacesList(previewSpaces,true);});}function QQ_ShowLoadingPublicSpaces(){$('.QQ_public_spaces_list').remove();const loadingHtml=`<div class="QQ_public_spaces_list" style=" position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:999999999;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.3s ease;backdrop-filter:blur(15px);"><div style=" background:#ffffff;border-radius:20px;padding:40px 30px;max-width:90%;overflow:hidden;box-shadow:0 20px 40px rgba(0,0,0,0.3);color:#333;animation:slideIn 0.3s ease;width:400px;text-align:center;"><div style=" background:linear-gradient(135deg,#ff9a9e 0%,#fecfef 100%);color:white;padding:20px;margin:-40px-30px 30px-30px;text-align:center;"><h3 style="margin:0;font-size:18px;font-weight:600;">正在加载...</h3><p style="margin:5px 0 0 0;font-size:12px;opacity:0.9;">公共互动空间数据</p></div><div style=" margin:20px 0;"><div style=" width:50px;height:50px;border:4px solid #f3f3f3;border-top:4px solid #ff9a9e;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px auto;"></div><p style=" color:#666;font-size:14px;line-height:1.5;margin:0;">正在从世界书加载公共互动空间数据...<br/><small style="font-size:12px;opacity:0.7;">首次加载可能需要几秒钟</small></p></div></div></div>`;$('body').append(loadingHtml);$('.QQ_public_spaces_list').on('click',function(e){if(e.target===this){$(this).remove();}});}async function QQ_LoadFullPublicInteractiveSpaces(){try{if(!worldbook||!entries){console.warn('世界书功能不可用，无法加载公共互动空间');return{};}const publicSpaceEntries=entries.filter(e=>e.comment&&e.comment.includes('QQ_互动空间备份')&&!e.comment.includes('角色互动空间')&&!e.comment.includes('QQ_互动内容'));const allSpaces={};let loadedEntries=0;for(const entry of publicSpaceEntries){try{const data=JSON.parse(entry.content);if(data.spaces){Object.keys(data.spaces).forEach(spaceId=>{const space=data.spaces[spaceId];allSpaces[spaceId]={...space,sourceEntry:entry.comment,sourceUid:entry.uid,isPublic:true};});loadedEntries++;}}catch(parseError){console.warn(`解析公共互动空间条目失败:`,parseError);}}console.log(`🌐 完整加载公共互动空间:${loadedEntries}个条目,${Object.keys(allSpaces).length}个空间`);if(!window.QQ_FullPublicSpaces){window.QQ_FullPublicSpaces={};}window.QQ_FullPublicSpaces=allSpaces;return allSpaces;}catch(error){console.error('加载完整公共互动空间失败:',error);throw error;}}function QQ_ShowPublicInteractiveSpacesList(spaces,isPreviewOnly=false){$('.QQ_public_spaces_list').remove();const spaceKeys=Object.keys(spaces);if(spaceKeys.length===0){toastr.info('暂无公共互动空间数据','公共互动空间');return;}let spacesListHtml=`<div class="QQ_public_spaces_list" style=" position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:999999999;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.3s ease;backdrop-filter:blur(15px);"><div style=" background:#ffffff;border-radius:20px;padding:0;max-width:90%;max-height:80%;overflow:hidden;box-shadow:0 20px 40px rgba(0,0,0,0.3);color:#333;animation:slideIn 0.3s ease;width:450px;"><div style=" background:linear-gradient(135deg,#ff9a9e 0%,#fecfef 100%);color:white;padding:20px;text-align:center;position:relative;"><h3 style="margin:0;font-size:18px;font-weight:600;">🌐 公共互动空间</h3><p style="margin:5px 0 0 0;font-size:12px;opacity:0.9;">${isPreviewOnly ? '预览模式 · ':''}共 ${spaceKeys.length}个互动空间</p><button class="QQ_close_public_spaces" style=" position:absolute;top:15px;right:15px;background:rgba(255,255,255,0.2);border:none;color:white;width:30px;height:30px;border-radius:50%;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;">×</button></div><div style=" padding:20px;max-height:400px;overflow-y:auto;">`;const sortedSpaces=spaceKeys.sort((a,b)=>{const spaceA=spaces[a];const spaceB=spaces[b];const timeA=spaceA.lastAccess||spaceA.createdAt||'0';const timeB=spaceB.lastAccess||spaceB.createdAt||'0';return new Date(timeB)-new Date(timeA);});sortedSpaces.forEach(spaceId=>{const space=spaces[spaceId];const contentPreview=isPreviewOnly ?(space.preview||(space.content ? space.content.substring(0,100)+'...':'无内容预览')):(space.content ? space.content.substring(0,100)+'...':'无内容');const timeStr=space.lastAccess||space.createdAt ?
new Date(space.lastAccess||space.createdAt).toLocaleDateString():'未知时间';spacesListHtml+=`<div class="QQ_public_space_item" data-space-id="${spaceId}" style=" background:#f8f9fa;border:1px solid #e9ecef;border-radius:12px;padding:15px;margin-bottom:10px;cursor:pointer;transition:all 0.3s ease;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'"><div style="display:flex;align-items:center;margin-bottom:8px;"><h4 style="margin:0;font-size:14px;color:#333;flex:1;">${space.name||'未命名互动空间'}</h4><small style="color:#999;font-size:11px;">${timeStr}</small></div><p style="margin:0 0 5px 0;font-size:12px;color:#666;line-height:1.4;">${contentPreview}</p><div style="display:flex;align-items:center;justify-content:space-between;"><small style="color:#666;font-size:11px;">👤 ${space.characterName||'未知角色'}</small>${isPreviewOnly ? '<small style="color:#ff9a9e;font-size:11px;">⚡ 点击加载完整内容</small>':''}</div></div>`;});spacesListHtml+=`</div></div></div>`;$('body').append(spacesListHtml);$('.QQ_close_public_spaces').on('click',function(){$('.QQ_public_spaces_list').remove();});$('.QQ_public_space_item').on('click',function(){const spaceId=$(this).data('space-id');const space=spaces[spaceId];$('.QQ_public_spaces_list').remove();if(isPreviewOnly){QQ_LoadAndDisplayFullPublicSpace(spaceId,space);}else{QQ_DisplayPublicInteractiveSpace(spaceId,space);}});$('.QQ_public_spaces_list').on('click',function(e){if(e.target===this){$(this).remove();}});}function QQ_LoadAndDisplayFullPublicSpace(spaceId,spacePreview){toastr.info('正在加载完整内容...','公共互动空间');if(window.QQ_FullPublicSpaces&&window.QQ_FullPublicSpaces[spaceId]){QQ_DisplayPublicInteractiveSpace(spaceId,window.QQ_FullPublicSpaces[spaceId]);return;}QQ_LoadFullPublicInteractiveSpaces().then((spaces)=>{if(spaces[spaceId]){QQ_DisplayPublicInteractiveSpace(spaceId,spaces[spaceId]);}else{toastr.error('未找到该互动空间的完整数据','加载失败');}}).catch(error=>{console.error('加载公共互动空间完整内容失败:',error);toastr.error('加载完整内容失败','错误');});}function QQ_DisplayPublicInteractiveSpace(spaceId,space){QQ_DisplayEnhancedInteractiveSpace(spaceId,space.name,space.characterName,space.content,true);}function QQ_CreateCharacterInteractiveSpace(characterName){const interactiveRequest=`请为角色 ${characterName}创建一个新的互动空间。
请以MiPhone格式回复，在content标签中描述一个有趣的互动场景，比如：-角色邀请用户参与某个活动-创造一个特殊的环境或情境-设计一个有趣的对话场景
内容应该生动有趣，能够吸引用户参与互动。`;toastr.info(`正在为 ${characterName}创建互动空间...`,'互动空间');QQ_Gen(interactiveRequest,async function(aiResponse){try{if(aiResponse&&aiResponse.trim()){const contentMatch=aiResponse.match(/<content>([\s\S]*?)<\/content>/i);const interactiveContent=contentMatch ? contentMatch[1].trim():aiResponse.trim();if(interactiveContent){const spaceId='space_'+Date.now();const characterAvatar=QQ_GetCharacterAvatar(characterName);if(!QQ_CharacterSpaces[characterName]){QQ_CharacterSpaces[characterName]={};}QQ_CharacterSpaces[characterName][spaceId]={id:spaceId,name:`与${characterName}的互动`,content:interactiveContent,characterName:characterName,characterAvatar:characterAvatar,type:'character',createTime:new Date().toISOString()};QQ_InteractivePages[spaceId]=[interactiveContent];QQ_InteractiveCurrentPage[spaceId]=0;QQ_SaveInteractiveContentToWorldBook(interactiveContent,characterName).then(interactiveId=>{}).catch(error=>{console.error('保存创建的互动空间失败:',error);});QQ_SaveInteractiveSpaceToWorldBook(spaceId,characterName).catch(error=>{console.error('保存互动空间失败:',error);});QQ_DisplayEnhancedInteractiveSpace(spaceId,`与${characterName}的互动`,characterName);toastr.success(`已为 ${characterName}创建新的互动空间！`,'互动空间');}else{toastr.error('AI回复格式错误','互动空间');}}else{toastr.error('AI回复为空','互动空间');}}catch(error){console.error('创建互动空间时出错:',error);toastr.error('创建互动空间失败');}});}function QQ_Test_Character_Spirit_System(){const currentChatPage=$('.QQ_chat_page:visible');const currentCharacter=currentChatPage.length>0 ? currentChatPage.attr('data-name'):null;if(currentCharacter){const avatar=QQ_GetCharacterAvatar(currentCharacter);}const spiritButtons=$('.QQ_character_spirit');spiritButtons.each(function(){const characterName=$(this).attr('data-character');});toastr.info('角色专属精灵系统测试完成，请查看控制台输出','系统测试');}function QQ_Debug_Show_Character_Spirit(characterName){if(!characterName){toastr.error('请提供角色名称','调试工具');return;}QQ_ShowCharacterSpirit(characterName);toastr.success(`已显示角色 ${characterName}的精灵按钮`,'调试工具');}function QQ_Show_Spirit_System_Stats(){const spiritCount=Object.keys(QQ_CharacterSpirits).length;const spaceCount=Object.keys(QQ_CharacterSpaces).reduce((total,char)=>total+Object.keys(QQ_CharacterSpaces[char]).length,0);const pageCount=Object.keys(QQ_InteractivePages).length;toastr.info(`精灵系统状态:${spiritCount}个精灵,${spaceCount}个空间,${pageCount}个页面`,'系统状态');}function QQ_Test_Avatar_Loading(characterName){if(!characterName){const currentChatPage=$('.QQ_chat_page:visible');characterName=currentChatPage.length>0 ? currentChatPage.attr('data-name'):null;if(!characterName){toastr.error('请先打开一个私聊页面或提供角色名称','头像测试');return;}}const avatarUrl=QQ_GetCharacterAvatar(characterName);const testHtml=`<div class="QQ_avatar_test_panel" style=" position:fixed;top:50px;right:50px;width:300px;background:white;border-radius:15px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,0.3);z-index:999999999;border:2px solid #FF6B6B;"><h3 style="margin:0 0 15px 0;color:#333;text-align:center;">头像测试面板</h3><p style="margin:5px 0;color:#666;"><strong>角色名称:</strong>${characterName}</p><p style="margin:5px 0;color:#666;word-break:break-all;"><strong>头像URL:</strong>${avatarUrl}</p><div style="text-align:center;margin:15px 0;"><img src="${avatarUrl}" alt="${characterName}" style=" width:80px;height:80px;border-radius:50%;border:3px solid #FF6B6B;object-fit:cover;" onerror="this.onerror=null;this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiByeD0iMzAiIGZpbGw9IiNGRjZCNkIiLz4KPHRLEHA+4pWpPC90ZXh0Pgo8L3N2Zz4K';this.style.border='3px solid red';"></div><div style="text-align:center;gap:10px;display:flex;justify-content:space-between;"><button class="QQ_test_show_spirit" style=" background:#FF6B6B;color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:12px;">显示精灵</button><button class="QQ_test_close" style=" background:#999;color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:12px;">关闭</button></div></div>`;$('.QQ_avatar_test_panel').remove();$('body').append(testHtml);$('.QQ_test_show_spirit').on('click',function(){QQ_ShowCharacterSpirit(characterName);toastr.success(`已显示 ${characterName}的精灵按钮`,'测试');});$('.QQ_test_close').on('click',function(){$('.QQ_avatar_test_panel').remove();});toastr.info(`头像测试面板已显示，请查看右上角`,'头像测试');}window.QQ_Test_Character_Spirit_System=QQ_Test_Character_Spirit_System;window.QQ_Debug_Show_Character_Spirit=QQ_Debug_Show_Character_Spirit;window.QQ_Show_Spirit_System_Stats=QQ_Show_Spirit_System_Stats;window.QQ_Test_Avatar_Loading=QQ_Test_Avatar_Loading;function QQ_ShowCharacterSpirit(characterName){if($(`.QQ_character_spirit[data-character="${characterName}"]`).length>0)return;QQ_HideAllCharacterSpirits();const characterAvatar=QQ_GetCharacterAvatar(characterName);const savedPosition=localStorage.getItem(`QQ_spirit_position_${characterName}`);let position={right:'20px',top:'50%'};if(savedPosition){try{position=JSON.parse(savedPosition);}catch(e){console.warn('解析角色精灵位置失败，使用默认位置');}}const positionStyle=position.right ?
'right:'+position.right:'left:'+position.left;const topBottomStyle=position.bottom ?
'bottom:'+position.bottom:'top:'+position.top;const spiritHtml='<div class="QQ_character_spirit" data-character="'+characterName+'" style="'+'position:fixed;'+positionStyle+';'+topBottomStyle+';'+'width:70px;'+'height:70px;'+'border-radius:50%;'+'box-shadow:0 4px 20px rgba(255,107,107,0.4);'+'cursor:move;'+'z-index:9999;'+'display:flex;'+'align-items:center;'+'justify-content:center;'+'user-select:none;'+'transition:all 0.3s ease;'+'animation:characterSpiritPulse 2s infinite;'+'background:linear-gradient(135deg,#FF6B6B 0%,#FF8E53 100%);'+'padding:4px;'+'" title="与 '+characterName+' 互动">'+'<img src="'+characterAvatar+'" alt="'+characterName+'" style="'+'width:100%;'+'height:100%;'+'border-radius:50%;'+'object-fit:cover;'+'border:2px solid white;'+'" onerror="this.onerror=null;this.src=\'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiByeD0iMzAiIGZpbGw9IiNGRjZCNkIiLz4KPHRLEHA+4pWpPC90ZXh0Pgo8L3N2Zz4K\';">'+'<div style="'+'position:absolute;'+'bottom:-5px;'+'right:-5px;'+'width:24px;'+'height:24px;'+'background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);'+'border-radius:50%;'+'display:flex;'+'align-items:center;'+'justify-content:center;'+'font-size:12px;'+'color:white;'+'border:2px solid white;'+'box-shadow:0 2px 8px rgba(0,0,0,0.2);'+'">✨</div>'+'</div>'+'<style>'+'@keyframes characterSpiritPulse{'+'0%,100%{transform:scale(1);box-shadow:0 4px 20px rgba(255,107,107,0.4)}'+'50%{transform:scale(1.05);box-shadow:0 6px 25px rgba(255,107,107,0.6)}'+'}'+'.QQ_character_spirit:hover{'+'transform:scale(1.1)!important;'+'box-shadow:0 6px 25px rgba(255,107,107,0.7)!important;'+'}'+'</style>';$('body').append(spiritHtml);QQ_CharacterSpirits[characterName]=true;$(`.QQ_character_spirit[data-character="${characterName}"]`).on('click touchend',function(e){if($(this).hasClass('dragging')){return;}e.stopPropagation();e.preventDefault();QQ_ShowCharacterSpiritPanel(characterName);});QQ_MakeCharacterSpiritDraggable(characterName);}function QQ_HideAllCharacterSpirits(){$('.QQ_character_spirit').fadeOut(300,function(){$(this).remove();});QQ_CharacterSpirits={};}function QQ_HideCharacterSpirit(characterName){$(`.QQ_character_spirit[data-character="${characterName}"]`).fadeOut(300,function(){$(this).remove();});delete QQ_CharacterSpirits[characterName];}function QQ_MakeCharacterSpiritDraggable(characterName){let isDragging=false;let dragStarted=false;let startX,startY,initialX,initialY;let dragTimer;$(`.QQ_character_spirit[data-character="${characterName}"]`).on('mousedown touchstart',function(e){e.preventDefault();dragStarted=false;const rect=this.getBoundingClientRect();initialX=rect.left;initialY=rect.top;const clientX=e.type==='touchstart' ? e.originalEvent.touches[0].clientX:e.clientX;const clientY=e.type==='touchstart' ? e.originalEvent.touches[0].clientY:e.clientY;startX=clientX-initialX;startY=clientY-initialY;dragTimer=setTimeout(()=>{isDragging=true;dragStarted=true;$(`.QQ_character_spirit[data-character="${characterName}"]`).addClass('dragging').css({'cursor':'grabbing','z-index':'99999999','animation':'none'});},150);});$(document).on('mousemove touchmove',function(e){if(!isDragging)return;const clientX=e.type==='touchmove' ? e.originalEvent.touches[0].clientX:e.clientX;const clientY=e.type==='touchmove' ? e.originalEvent.touches[0].clientY:e.clientY;const x=clientX-startX;const y=clientY-startY;const maxX=window.innerWidth-65;const maxY=window.innerHeight-65;const constrainedX=Math.max(0,Math.min(x,maxX));const constrainedY=Math.max(0,Math.min(y,maxY));$(`.QQ_character_spirit[data-character="${characterName}"]`).css({'left':constrainedX+'px','top':constrainedY+'px','right':'auto','bottom':'auto'});e.preventDefault();});$(document).on('mouseup touchend',function(e){if(dragTimer){clearTimeout(dragTimer);dragTimer=null;}if(!isDragging&&!dragStarted){return;}if(!isDragging)return;isDragging=false;dragStarted=false;const $spirit=$(`.QQ_character_spirit[data-character="${characterName}"]`);$spirit.removeClass('dragging').css({'cursor':'move','z-index':'9999999','animation':'characterSpiritPulse 2s infinite'});const rect=$spirit[0].getBoundingClientRect();const windowWidth=window.innerWidth;const windowHeight=window.innerHeight;let position;if(rect.left<windowWidth/2){position={left:rect.left+'px',top:rect.top+'px'};}else{position={right:(windowWidth-rect.right)+'px',top:rect.top+'px'};}const positionKey=`QQ_character_spirit_position_${characterName}`;localStorage.setItem(positionKey,JSON.stringify(position));});}function QQ_ShowCharacterSpiritPanel(characterName){if(!characterName||typeof characterName!=='string'){console.error('无效的角色名称:',characterName);return;}$('.QQ_character_spirit_panel').remove();if(!QQ_EnsureCharacterSpaceIndependence(characterName)){console.error(`角色 ${characterName}的互动空间独立性检查失败`);toastr.error('互动空间数据错误');return;}const characterSpaces=QQ_CharacterSpaces[characterName];const spaceList=Object.values(characterSpaces);const panelHtml=`<div class="QQ_character_spirit_panel" style=" position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.3);z-index:99999999;overflow:hidden;animation:spiritPanelSlideIn 0.3s ease;max-width:90%;max-height:80%;width:350px;"><div class="panel-header" style=" background:linear-gradient(135deg,#FF6B6B 0%,#FF8E53 100%);color:white;padding:20px;text-align:center;font-weight:600;"><div style="display:flex;align-items:center;justify-content:center;gap:10px;"><img src="${charAvatarPath||getAvatarUrl(characterName)}" alt="${characterName}" style=" width:40px;height:40px;border-radius:50%;border:2px solid white;"><span style="font-size:16px;">💕 ${characterName}的互动空间</span></div></div>${spaceList.length>0 ? `<div class="space-list" style="max-height:300px;overflow-y:auto;">${spaceList.slice(0,30).map(space=>`<div class="space-item" data-space-id="${space.id}" style=" padding:15px 20px;border-bottom:1px solid #f0f0f0;cursor:pointer;transition:background-color 0.2s ease;display:flex;align-items:center;gap:12px;" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor='transparent'"><div style=" width:10px;height:10px;border-radius:50%;background:#FF6B6B;flex-shrink:0;"></div><div style="flex:1;min-width:0;"><div style=" font-size:14px;font-weight:500;color:#333;margin-bottom:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${space.name}</div><div style=" font-size:12px;color:#999;">${QQ_FormatDate(space.createdAt)}</div></div></div>`).join('')}</div>`:`<div style=" padding:40px 20px;text-align:center;color:#999;"><div style="font-size:48px;margin-bottom:15px;">🌟</div><div style="font-size:14px;margin-bottom:8px;">还没有互动记录</div><div style="font-size:12px;color:#bbb;">开始一段现实互动吧～</div></div>`}<div class="panel-actions" style=" padding:20px;background:#fafafa;display:flex;gap:10px;"><button class="new-space-btn" style=" flex:1;background:linear-gradient(135deg,#FF6B6B 0%,#FF8E53 100%);border:none;color:white;padding:12px 16px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;transition:all 0.2s ease;" onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">✨ 创建新互动</button><button class="close-panel-btn" style=" background:#e9ecef;border:none;color:#666;padding:12px 16px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;transition:all 0.2s ease;" onmouseover="this.style.background='#dee2e6'" onmouseout="this.style.background='#e9ecef'">关闭</button></div><div class="interactive-tip" style=" padding:12px 20px;background:linear-gradient(135deg,#E8F5E8 0%,#F0F8FF 100%);border-top:1px solid #e9ecef;font-size:12px;color:#666;line-height:1.4;"><div style=" display:flex;align-items:center;gap:8px;margin-bottom:6px;font-weight:500;"><span style=" display:inline-block;width:16px;height:16px;background:#4CAF50;border-radius:50%;color:white;text-align:center;line-height:16px;font-size:10px;">💡</span><span style="color:#4CAF50;">当前互动触发状态</span></div><div id="interactive-status-content" style="margin-left:24px;font-size:11px;"></div></div></div><style>@keyframes spiritPanelSlideIn{from{opacity:0;transform:translate(-50%,-60%)}to{opacity:1;transform:translate(-50%,-50%)}}</style>`;$('body').append(panelHtml);QQ_UpdateInteractiveStatus();$('.QQ_character_spirit_panel').on('click',function(e){e.stopPropagation();const spaceItem=e.target.closest('.space-item');const newSpaceBtn=e.target.closest('.new-space-btn');const closePanelBtn=e.target.closest('.close-panel-btn');if(spaceItem){const spaceId=spaceItem.getAttribute('data-space-id');QQ_DisplayEnhancedInteractiveSpace(spaceId,`${characterName}的互动空间`,characterName);$('.QQ_character_spirit_panel').remove();}else if(newSpaceBtn){$('.QQ_character_spirit_panel').remove();QQ_ShowCharacterInteractiveSpace(characterName);}else if(closePanelBtn){$('.QQ_character_spirit_panel').remove();}});$(document).one('click',function(){$('.QQ_character_spirit_panel').remove();});}function QQ_FormatDate(dateStr){const date=new Date(dateStr);const now=new Date();const diffMs=now-date;const diffMins=Math.floor(diffMs/60000);const diffHours=Math.floor(diffMs/3600000);const diffDays=Math.floor(diffMs/86400000);if(diffMins<1){return '刚刚';}else if(diffMins<60){return `${diffMins}分钟前`;}else if(diffHours<24){return `${diffHours}小时前`;}else if(diffDays<7){return `${diffDays}天前`;}else{return date.toLocaleDateString('zh-CN',{month:'short',day:'numeric'});}}function QQ_CreateDirectInteractiveRequest(userDescription){return `🎯 用户主动请求互动内容：
请根据用户的描述："${userDescription}"，直接创建一个生动详细的互动场景。
📋 请求要求：
1. 直接生成互动内容，无需普通聊天回复
2. 内容必须用<content>标签包裹
3. 描述要生动详细，符合现实互动的感受
4. 根据互动性质判断保存位置：-涉及多人/群体 → 公共互动空间-单独和角色 → 角色专属空间
5. 互动内容要有沉浸感和真实感
6. 包含动作、对话、感官细节、情感表达
💡 这是用户使用特殊符号主动触发的互动请求，请积极回应！<Request:请根据上述用户描述生成互动内容，直接用content标签包裹>`;}function QQ_ModifyRequestForInteractive(originalRequest){const interactiveGuidance=`<InteractiveGuidance:🔥 强制执行：用户的消息包含明显的互动意图，必须严格按照以下要求回复 🔥
📱【双重回复要求】：
1. 【必须先回复】在用户当前发言的位置（私聊/群聊/动态评论）正常回复，表达反应、确认、情感等
2. 【然后提供互动】用<content>标签包裹详细的现实互动场景描述
🚨【强制执行顺序】：-私聊互动：先在私聊中回复 → 再提供互动内容-群聊互动：先在群聊中回复 → 再提供互动内容-动态评论互动：先在评论中回复 → 再提供互动内容
💬【回复示例格式】：**私聊场景**：<用户名和角色名的私聊>角色名--好的！我马上过来找你~--时间</用户名和角色名的私聊><content>*小跑着穿过走廊，轻轻敲响你的房门*"我来了！刚才在准备一些小惊喜给你~"*眼中闪烁着期待和兴奋的光芒，手里还藏着什么东西*</content>**群聊场景**：<群聊名>角色名--太好了！大家一起来吧！--时间</群聊名><content>*兴奋地站起身，向大家招手*"那我们就在这里开始吧！"*开始准备需要的物品，脸上洋溢着开心的笑容*</content>**动态评论场景**：
moment_start
角色名--看起来很有趣呢！我也想参与
moment_end<content>*看到动态后立刻放下手中的事情，快步走向你*"刚看到你的动态，感觉特别有意思！能跟我详细说说吗？"*眼神中充满好奇和期待*</content>⚡【强制要求】：
1. 必须先在当前对话位置回复（私聊/群聊/动态评论）
2. 回复要表现出积极响应和情感反应
3. 然后用content标签提供丰富的互动场景
4. 互动内容必须包含动作、对话、感官细节、情感表达
5. 确保互动的连贯性和真实性
🚫【禁止行为】：-跳过当前位置的回复直接提供互动-互动内容过于简短或缺乏细节-忽视用户当前的对话环境>`;return originalRequest.replace(/<Request:/,`${interactiveGuidance}\n<Request:`);}function QQ_GenerateSpaceId(){return "space_"+Date.now()+"_"+Math.random().toString(36).substr(2,9);}function QQ_GetSpaceName(content,characterName){const charName=characterName||charcardname||"角色";const characterMentions=content.match(/(?:@|【|（|＜)\s*([^@【（＜】）＞\s]{2,8})\s*(?:】|）|＞)/g)||[];const uniqueChars=[...new Set(characterMentions)];const sceneKeywords=[{keywords:['咖啡','咖啡厅','咖啡店'],name:'咖啡厅'},{keywords:['教室','学校','课堂','上课'],name:'教室'},{keywords:['公园','散步','樱花','长椅'],name:'公园'},{keywords:['家里','房间','卧室','客厅'],name:'家中'},{keywords:['海边','沙滩','海浪','夕阳'],name:'海边'},{keywords:['图书馆','看书','学习'],name:'图书馆'},{keywords:['商场','购物','逛街'],name:'商场'},{keywords:['餐厅','吃饭','用餐'],name:'餐厅'},{keywords:['游戏','玩游戏','手机游戏'],name:'游戏'},{keywords:['工作','办公','会议'],name:'工作'},{keywords:['聚会','派对','庆祝'],name:'聚会'},{keywords:['旅行','旅游','出行'],name:'旅行'},{keywords:['运动','锻炼','健身'],name:'运动'},{keywords:['做饭','料理','烹饪'],name:'烹饪'},{keywords:['看电影','电影','观影'],name:'观影'},{keywords:['聊天','谈话','交流'],name:'谈话'},{keywords:['拥抱','抱抱','安慰'],name:'温暖时刻'},{keywords:['生气','吵架','争论'],name:'争执'},{keywords:['开心','高兴','快乐'],name:'欢乐时光'},{keywords:['难过','伤心','哭泣'],name:'安慰时刻'},{keywords:['紧张','害怕','担心'],name:'紧张时刻'},];let detectedScene="日常";for(const scene of sceneKeywords){if(scene.keywords.some(keyword=>content.includes(keyword))){detectedScene=scene.name;break;}}if(uniqueChars.length>1){const actionKeywords=content.match(/[\u4e00-\u9fa5]{2,4}(?:着|了|呢|吧|呀)/g)||[];const action=actionKeywords.length>0 ? actionKeywords[0].replace(/[着了呢吧呀]/g,''):'互动';return `${detectedScene}·${action}`;}else{return `${charName}·${detectedScene}`;}}async function QQ_SaveInteractiveSpaces(){try{if(!worldbook||!entries){console.warn('世界书功能不可用，无法保存互动空间');return false;}const spaceData={spaces:QQ_InteractiveSpaces,lastUpdated:new Date().toISOString(),version:"1.0"};console.log(`准备保存互动空间到世界书:${QQ_INTERACTIVE_BACKUP_KEY},空间数量:${Object.keys(QQ_InteractiveSpaces).length}`);const comment=QQ_INTERACTIVE_BACKUP_KEY;let targetEntry=entries.find(entry=>entry.comment===comment);const jsonData=JSON.stringify(spaceData,null,2);if(targetEntry){await setLorebookEntries(worldbook,[{uid:targetEntry.uid,content:jsonData,}]);targetEntry.content=jsonData;}else{await createLorebookEntry(worldbook,{comment:comment,key:[`此世界书永不触发_互动空间备份`],content:jsonData,position:"at_depth_as_system",type:"selective",depth:0,exclude_recursion:true,order:9997,enabled:true,});entries=await getLorebookEntries(worldbook);}await QQ_SafeSaveWorldInfo("互动空间数据");entries=await getLorebookEntries(worldbook);const verifyEntry=entries.find(entry=>entry.comment===comment);if(verifyEntry&&verifyEntry.content&&verifyEntry.content.includes('"spaces"')){console.log(`🎯 互动空间保存验证成功:${Object.keys(QQ_InteractiveSpaces).length}个空间`);return true;}else{console.error('❌ 互动空间保存验证失败');console.error('验证条目:',verifyEntry ? '找到条目但内容异常':'未找到条目');return true;}}catch(error){console.error('保存互动空间时发生错误:',error);return false;}}async function QQ_LoadInteractiveSpaces(){try{if(!worldbook||!entries){console.warn('世界书功能不可用，无法加载互动空间');QQ_InteractiveSpaces={};return;}const comment=QQ_INTERACTIVE_BACKUP_KEY;const entry=entries.find(e=>e.comment===comment);if(entry&&entry.content){try{const data=JSON.parse(entry.content);if(data&&data.spaces){QQ_InteractiveSpaces=data.spaces;console.log(`✅ 从世界书加载互动空间:${Object.keys(QQ_InteractiveSpaces).length}个空间`);}else{QQ_InteractiveSpaces={};}}catch(parseError){console.error('解析互动空间数据失败:',parseError);QQ_InteractiveSpaces={};}}else{QQ_InteractiveSpaces={};}}catch(error){console.error('从世界书加载互动空间失败:',error);QQ_InteractiveSpaces={};}}async function QQ_PreloadCharacterDataFromWorldbook(characterName){try{const loadPromises=[QQ_LoadSpecificCharacterSpaces(characterName),QQ_LoadPublicInteractiveSpacesPreview(),QQ_LoadCharacterInteractiveContent(characterName)];const results=await Promise.allSettled(loadPromises);let successCount=0;let failCount=0;results.forEach((result,index)=>{if(result.status==='fulfilled'){successCount++;}else{failCount++;console.warn(`⚠️ 预加载任务 ${index+1}失败:`,result.reason);}});if(!window.QQ_PreloadedCharacters){window.QQ_PreloadedCharacters=new Set();}window.QQ_PreloadedCharacters.add(characterName);}catch(error){console.error(`❌ 预加载角色 ${characterName}数据时出错:`,error);}}async function QQ_LoadSpecificCharacterSpaces(characterName){try{if(!worldbook||!entries){console.warn('世界书功能不可用，无法加载角色互动空间');return false;}if(!QQ_CharacterSpaces[characterName]){QQ_CharacterSpaces[characterName]={};}const characterSpaceEntries=entries.filter(e=>e.comment&&e.comment.includes('QQ_角色互动空间')&&e.comment.includes(characterName));let loadedCount=0;for(const entry of characterSpaceEntries){try{const data=JSON.parse(entry.content);if(data.characterName===characterName&&data.spaces){Object.assign(QQ_CharacterSpaces[characterName],data.spaces);loadedCount++;}}catch(parseError){console.warn(`解析角色互动空间条目失败:`,parseError);}}console.log(`📦 角色 ${characterName}互动空间预加载:${loadedCount}个条目,${Object.keys(QQ_CharacterSpaces[characterName]).length}个空间`);return true;}catch(error){console.error(`加载角色 ${characterName}互动空间失败:`,error);return false;}}async function QQ_LoadPublicInteractiveSpacesPreview(){try{if(!worldbook||!entries){console.warn('世界书功能不可用，无法预加载公共互动空间');return false;}const publicSpaceEntries=entries.filter(e=>e.comment&&e.comment.includes('QQ_互动空间备份')&&!e.comment.includes('角色互动空间'));let previewCount=0;if(!window.QQ_PublicSpacePreviews){window.QQ_PublicSpacePreviews={};}for(const entry of publicSpaceEntries){try{const data=JSON.parse(entry.content);if(data.spaces){Object.keys(data.spaces).forEach(spaceId=>{const space=data.spaces[spaceId];window.QQ_PublicSpacePreviews[spaceId]={id:spaceId,name:space.name,characterName:space.characterName,createdAt:space.createdAt,lastAccess:space.lastAccess,preview:space.content ? space.content.substring(0,100)+'...':'',entryComment:entry.comment};});previewCount++;}}catch(parseError){console.warn(`解析公共互动空间条目失败:`,parseError);}}console.log(`🌐 公共互动空间预览预加载:${previewCount}个条目,${Object.keys(window.QQ_PublicSpacePreviews||{}).length}个空间预览`);return true;}catch(error){console.error('预加载公共互动空间预览失败:',error);return false;}}async function QQ_LoadCharacterInteractiveContent(characterName){try{if(!worldbook||!entries){console.warn('世界书功能不可用，无法加载角色互动内容');return false;}const contentEntries=entries.filter(e=>e.comment&&e.comment.includes('QQ_互动内容')&&e.comment.includes(characterName));let contentCount=0;if(!window.QQ_CharacterInteractiveContents){window.QQ_CharacterInteractiveContents={};}if(!window.QQ_CharacterInteractiveContents[characterName]){window.QQ_CharacterInteractiveContents[characterName]=[];}for(const entry of contentEntries){try{const data=JSON.parse(entry.content);if(data.characterName===characterName){window.QQ_CharacterInteractiveContents[characterName].push({id:data.id,content:data.content,createdAt:data.createdAt,entryUid:entry.uid});contentCount++;}}catch(parseError){console.warn(`解析角色互动内容条目失败:`,parseError);}}return true;}catch(error){console.error(`加载角色 ${characterName}互动内容失败:`,error);return false;}}async function QQ_LoadCharacterSpaces(){try{if(!worldbook||!entries){console.warn('世界书功能不可用，无法加载角色互动空间');QQ_CharacterSpaces={};return;}const entry=entries.find(e=>e.comment===QQ_CHARACTER_SPACES_KEY);if(entry&&entry.content){const data=JSON.parse(entry.content);QQ_CharacterSpaces=data.characterSpaces||{};const totalSpaces=Object.values(QQ_CharacterSpaces).reduce((sum,char)=>sum+Object.keys(char).length,0);console.log('从世界书加载角色互动空间:',Object.keys(QQ_CharacterSpaces).length,'个角色,',totalSpaces,'个空间');}else{QQ_CharacterSpaces={};}}catch(error){console.error('从世界书加载角色互动空间失败:',error);QQ_CharacterSpaces={};}}function QQ_ShowInteractiveSpace(content,characterName=""){let cleanContent;if(QQ_HasContentTag(content)){cleanContent=QQ_CleanContentTags(content);}else{cleanContent=content
.replace(/MiPhone_start/g,"").replace(/MiPhone_end/g,"").trim();}const spaceId=QQ_GenerateSpaceId();const spaceName=QQ_GetSpaceName(cleanContent,characterName);const charName=characterName||charcardname||"角色";const charAvatar=charAvatarPath||"default_avatar.png";QQ_InteractiveSpaces[spaceId]={id:spaceId,name:spaceName,content:cleanContent,characterName:charName,characterAvatar:charAvatar,createdAt:new Date().toISOString(),lastAccess:new Date().toISOString()};QQ_ActiveSpaceId=spaceId;QQ_SaveInteractiveSpaces().then(()=>{}).catch(error=>{console.error('保存互动空间失败:',error);});$('.QQ_interactive_space').remove();const interactiveSpaceHtml=`<div class="QQ_interactive_space" data-space-id="${spaceId}" style=" position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.3s ease;backdrop-filter:blur(10px);"><div class="QQ_interactive_content" style=" background:#ffffff;border-radius:15px;padding:0;max-width:85%;max-height:75%;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,0.3);position:relative;color:#333;animation:slideIn 0.3s ease;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;"><div class="QQ_interactive_header" style=" background:linear-gradient(135deg,#4FC3F7 0%,#29B6F6 100%);padding:20px;display:flex;align-items:center;color:white;position:relative;"><img src="${charAvatar}" alt="${charName}" style=" width:45px;height:45px;border-radius:50%;margin-right:15px;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.2);"><div style="flex:1;"><h3 style="margin:0;font-size:17px;font-weight:600;">${spaceName}</h3><p style="margin:3px 0 0 0;font-size:13px;opacity:0.9;">现实互动模式</p></div><button class="QQ_rename_space" style=" background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease;margin-right:8px;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'" title="重命名空间">✏️</button><button class="QQ_close_interactive" style=" background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">×</button></div><div class="QQ_interactive_body" style=" padding:25px 20px;font-size:15px;line-height:1.5;white-space:pre-wrap;color:#333;background:#fafafa;max-height:300px;overflow-y:auto;">${cleanContent}</div><div class="QQ_interactive_footer" style=" padding:20px;background:#ffffff;border-top:1px solid #eee;display:flex;justify-content:center;gap:15px;"><button class="QQ_reply_interactive" style=" background:#4FC3F7;border:none;color:white;padding:12px 24px;border-radius:25px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.3s ease;box-shadow:0 2px 8px rgba(79,195,247,0.3);" onmouseover="this.style.background='#29B6F6';this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#4FC3F7';this.style.transform='translateY(0)'">💬 回应互动</button><button class="QQ_close_interactive" style=" background:#f5f5f5;border:none;color:#666;padding:12px 24px;border-radius:25px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.3s ease;" onmouseover="this.style.background='#eeeeee'" onmouseout="this.style.background='#f5f5f5'">关闭</button></div></div></div><style>@keyframes fadeIn{from{opacity:0}to{opacity:1}}@keyframes slideIn{from{transform:translateY(-30px);opacity:0}to{transform:translateY(0);opacity:1}}.QQ_interactive_space*{user-select:text}</style>`;$('body').append(interactiveSpaceHtml);$('.QQ_rename_space').off('click').on('click',function(){QQ_RenameInteractiveSpace(spaceId);});$('.QQ_close_interactive').off('click').on('click',function(){QQ_CloseInteractiveSpace();});$('.QQ_reply_interactive').off('click').on('click',function(){QQ_CloseInteractiveSpace();QQ_OpenInteractiveReply(charName);});$('.QQ_interactive_space').on('click',function(e){if(e.target===this){QQ_CloseInteractiveSpace();}});triggerSlash(`/echo 检测到互动内容，已在手机界面显示：${spaceName}`);}function QQ_CloseInteractiveSpace(){$('.QQ_interactive_space').fadeOut(300,function(){$(this).remove();QQ_ShowSpiritButton();});QQ_ActiveSpaceId=null;}function QQ_RenameInteractiveSpace(spaceId){const space=QQ_InteractiveSpaces[spaceId];if(!space)return;const newName=prompt('请输入新的空间名称:',space.name);if(newName&&newName.trim()&&newName.trim()!==space.name){space.name=newName.trim();$('.QQ_interactive_header h3').text(space.name);QQ_SaveInteractiveSpaces();triggerSlash(`/echo 互动空间已重命名为：${space.name}`);}}let QQ_InteractivePages={};let QQ_InteractiveCurrentPage={};function QQ_DisplayEnhancedInteractiveSpace(spaceId,spaceTitle,characterName=null){const spaceData=characterName ?
QQ_CharacterSpaces[characterName][spaceId]:QQ_InteractiveSpaces[spaceId];if(!spaceData){console.error('未找到互动空间数据:',spaceId);return;}if(!QQ_InteractivePages[spaceId]){QQ_InteractivePages[spaceId]=[spaceData.content];}if(!QQ_InteractiveCurrentPage[spaceId]){QQ_InteractiveCurrentPage[spaceId]=0;}$('.QQ_interactive_space_enhanced').remove();const isCharacterSpace=spaceData.type==='character';const headerColor=isCharacterSpace ?
'linear-gradient(135deg,#FF6B6B 0%,#FF8E53 100%)':'linear-gradient(135deg,#4FC3F7 0%,#29B6F6 100%)';const currentPageIndex=QQ_InteractiveCurrentPage[spaceId];const totalPages=QQ_InteractivePages[spaceId].length;const currentContent=QQ_InteractivePages[spaceId][currentPageIndex];const interactiveSpaceHtml=`<div class="QQ_interactive_space_enhanced" data-space-id="\${spaceId}" style=" position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:99999999;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.3s ease;backdrop-filter:blur(10px);"><div class="QQ_interactive_content_enhanced" style=" background:#ffffff;border-radius:20px;padding:0;max-width:90%;max-height:85%;overflow:hidden;box-shadow:0 20px 40px rgba(0,0,0,0.3);position:relative;color:#333;animation:slideIn 0.3s ease;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;width:400px;"><div class="QQ_interactive_header_enhanced" style=" background:\${headerColor};padding:20px;display:flex;align-items:center;color:white;position:relative;"><img src="\${spaceData.characterAvatar}" alt="\${spaceData.characterName}" style=" width:45px;height:45px;border-radius:50%;margin-right:12px;border:2px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.2);"><div style="flex:1;"><h3 style="margin:0;font-size:16px;font-weight:600;">\${spaceData.name}</h3><p style="margin:3px 0 0 0;font-size:12px;opacity:0.9;">\${isCharacterSpace ? \`\${spaceData.characterName}的专属互动\`:'公共互动空间'}</p></div>\${totalPages>1 ? \`<div style="margin-right:15px;font-size:12px;opacity:0.9;">\${currentPageIndex+1}/\${totalPages}</div>\`:''}<button class="QQ_close_interactive_enhanced" style=" background:rgba(255,255,255,0.2);border:none;color:white;width:30px;height:30px;border-radius:50%;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">×</button></div><div class="QQ_interactive_body_enhanced" style=" padding:25px 20px;font-size:15px;line-height:1.6;white-space:pre-wrap;color:#333;background:#fafafa;max-height:280px;overflow-y:auto;word-wrap:break-word;border-bottom:1px solid #eee;">\${currentContent}</div>\${totalPages>1 ? \`<div class="QQ_interactive_pagination" style=" padding:15px 20px;background:#ffffff;border-bottom:1px solid #eee;display:flex;justify-content:center;gap:10px;align-items:center;"><button class="QQ_prev_page" \${currentPageIndex===0 ? 'disabled':''}style=" background:\${currentPageIndex===0 ? '#f5f5f5':'#e3f2fd'};border:none;color:\${currentPageIndex===0 ? '#999':'#1976d2'};padding:8px 12px;border-radius:6px;cursor:\${currentPageIndex===0 ? 'not-allowed':'pointer'};font-size:12px;font-weight:500;transition:all 0.2s ease;">← 上一页</button><span style="font-size:12px;color:#666;margin:0 10px;">第 \${currentPageIndex+1}页，共 \${totalPages}页</span><button class="QQ_next_page" \${currentPageIndex===totalPages-1 ? 'disabled':''}style=" background:\${currentPageIndex===totalPages-1 ? '#f5f5f5':'#e3f2fd'};border:none;color:\${currentPageIndex===totalPages-1 ? '#999':'#1976d2'};padding:8px 12px;border-radius:6px;cursor:\${currentPageIndex===totalPages-1 ? 'not-allowed':'pointer'};font-size:12px;font-weight:500;transition:all 0.2s ease;">下一页 →</button></div>\`:''}<div class="QQ_interactive_footer_enhanced" style=" padding:20px;background:#ffffff;display:flex;justify-content:center;gap:12px;"><button class="QQ_reply_interactive_enhanced" style=" background:\${isCharacterSpace ? '#FF6B6B':'#4FC3F7'};border:none;color:white;padding:12px 20px;border-radius:20px;cursor:pointer;font-size:13px;font-weight:500;transition:all 0.3s ease;box-shadow:0 2px 8px \${isCharacterSpace ? 'rgba(255,107,107,0.3)':'rgba(79,195,247,0.3)'};" onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">💬 回应互动</button><button class="QQ_close_interactive_enhanced" style=" background:#f5f5f5;border:none;color:#666;padding:12px 20px;border-radius:20px;cursor:pointer;font-size:13px;font-weight:500;transition:all 0.3s ease;" onmouseover="this.style.background='#eeeeee'" onmouseout="this.style.background='#f5f5f5'">关闭</button></div></div></div>`;$('body').append(interactiveSpaceHtml);$('.QQ_close_interactive_enhanced').on('click',function(){$('.QQ_interactive_space_enhanced').fadeOut(300,function(){$(this).remove();});});$('.QQ_reply_interactive_enhanced').on('click',function(){QQ_OpenEnhancedInteractiveReply(spaceId,characterName||spaceData.characterName);});$('.QQ_prev_page').on('click',function(){if(currentPageIndex>0){QQ_InteractiveCurrentPage[spaceId]=currentPageIndex-1;QQ_DisplayEnhancedInteractiveSpace(spaceId,spaceTitle,characterName);}});$('.QQ_next_page').on('click',function(){if(currentPageIndex<totalPages-1){QQ_InteractiveCurrentPage[spaceId]=currentPageIndex+1;QQ_DisplayEnhancedInteractiveSpace(spaceId,spaceTitle,characterName);}});$('.QQ_interactive_space_enhanced').on('click',function(e){if(e.target===this){$(this).fadeOut(300,function(){$(this).remove();});}});}function QQ_OpenEnhancedInteractiveReply(spaceId,characterName){$('.QQ_interactive_reply_enhanced').remove();const replyHtml=`<div class="QQ_interactive_reply_enhanced" style=" position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:999999999;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.3s ease;backdrop-filter:blur(15px);"><div class="QQ_reply_content_enhanced" style=" background:#ffffff;border-radius:16px;padding:0;max-width:90%;overflow:hidden;box-shadow:0 20px 40px rgba(0,0,0,0.3);color:#333;animation:slideIn 0.3s ease;width:380px;"><div class="reply-header" style=" background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:18px 20px;text-align:center;font-weight:600;font-size:15px;">💬 回应 ${characterName}的互动</div><div class="reply-body" style=" padding:25px 20px;"><textarea class="QQ_reply_input_enhanced" placeholder="在这里输入你的回应..." style=" width:100%;height:120px;border:2px solid #e9ecef;border-radius:12px;padding:15px;font-size:14px;line-height:1.5;resize:none;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;outline:none;transition:all 0.3s ease;" onfocus="this.style.borderColor='#667eea';this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'" onblur="this.style.borderColor='#e9ecef';this.style.boxShadow='none'"></textarea></div><div class="reply-footer" style=" padding:0 20px 20px 20px;display:flex;gap:12px;"><button class="QQ_send_reply_enhanced" style=" flex:1;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border:none;color:white;padding:12px;border-radius:10px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.3s ease;box-shadow:0 3px 10px rgba(102,126,234,0.3);" onmouseover="this.style.transform='translateY(-1px)';this.style.boxShadow='0 5px 15px rgba(102,126,234,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 3px 10px rgba(102,126,234,0.3)'">🚀 发送回应</button><button class="QQ_cancel_reply_enhanced" style=" background:#f8f9fa;border:none;color:#6c757d;padding:12px 20px;border-radius:10px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.3s ease;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">取消</button></div></div></div>`;$('body').append(replyHtml);setTimeout(()=>{$('.QQ_reply_input_enhanced').focus();},100);$('.QQ_send_reply_enhanced').on('click',function(){const replyText=$('.QQ_reply_input_enhanced').val().trim();if(replyText){QQ_SendInteractiveReply(spaceId,characterName,replyText);$('.QQ_interactive_reply_enhanced').remove();}else{toastr.warning('请输入回应内容');$('.QQ_reply_input_enhanced').focus();}});$('.QQ_cancel_reply_enhanced').on('click',function(){$('.QQ_interactive_reply_enhanced').remove();});$('.QQ_reply_input_enhanced').on('keydown',function(e){if(e.key==='Enter'&&e.ctrlKey){$('.QQ_send_reply_enhanced').click();}});$('.QQ_interactive_reply_enhanced').on('click',function(e){if(e.target===this){$(this).remove();}});}function QQ_SendInteractiveReply(spaceId,characterName,replyText){toastr.info('正在发送回应...','互动空间');const interactiveRequest=`请回应这个互动场景：<content>${replyText}</content>请以MiPhone格式回复，在content标签中描述你对这个回应的反应和新的互动内容。`;QQ_Gen(interactiveRequest,async function(aiResponse){try{if(aiResponse&&aiResponse.trim()){const contentMatch=aiResponse.match(/<content>([\s\S]*?)<\/content>/i);const newInteractiveContent=contentMatch ? contentMatch[1].trim():aiResponse.trim();if(newInteractiveContent){if(!QQ_InteractivePages[spaceId]){QQ_InteractivePages[spaceId]=[];}QQ_InteractivePages[spaceId].push(newInteractiveContent);QQ_InteractiveCurrentPage[spaceId]=QQ_InteractivePages[spaceId].length-1;await QQ_SaveInteractiveSpaceToWorldBook(spaceId,characterName);QQ_DisplayEnhancedInteractiveSpace(spaceId,`${characterName}的互动空间`,characterName);toastr.success('AI已回应你的互动！','互动空间');}else{toastr.error('AI回复格式错误','互动空间');}}else{toastr.error('AI回复为空','互动空间');}}catch(error){console.error('处理AI互动回复时出错:',error);toastr.error('处理回复时出错');}});}async function QQ_SaveInteractiveSpaceToWorldBook(spaceId,characterName){try{const storageKey=`QQ_互动空间备份_${characterName}`;const existingData=getWorldInfoData(storageKey)||{spaces:{},lastUpdate:new Date().toISOString()};existingData.spaces[spaceId]={id:spaceId,pages:QQ_InteractivePages[spaceId]||[],currentPage:QQ_InteractiveCurrentPage[spaceId]||0,characterName:characterName,lastModified:new Date().toISOString()};const spaceIds=Object.keys(existingData.spaces);if(spaceIds.length>30){const sortedSpaces=spaceIds.map(id=>({id,lastModified:existingData.spaces[id].lastModified})).sort((a,b)=>new Date(a.lastModified)-new Date(b.lastModified));for(let i=0;i<spaceIds.length-30;i++){delete existingData.spaces[sortedSpaces[i].id];}}existingData.lastUpdate=new Date().toISOString();setWorldInfoData(storageKey,existingData);const saveSuccess=await QQ_SafeSaveWorldInfo(`互动空间 ${spaceId}`);if(saveSuccess){}else{console.warn(`互动空间 ${spaceId}保存到世界书失败，角色:${characterName}`);}}catch(error){console.error('保存互动空间到世界书时出错:',error);}}function QQ_LoadInteractiveSpaceFromWorldBook(characterName){try{const storageKey=`QQ_互动空间备份_${characterName}`;const savedData=getWorldInfoData(storageKey);if(savedData&&savedData.spaces){Object.keys(savedData.spaces).forEach(spaceId=>{const spaceData=savedData.spaces[spaceId];if(spaceData.pages&&spaceData.pages.length>0){QQ_InteractivePages[spaceId]=spaceData.pages;QQ_InteractiveCurrentPage[spaceId]=spaceData.currentPage||0;}});return true;}}catch(error){console.error('从世界书加载互动空间数据时出错:',error);}return false;}function QQ_ShowSpiritButton(){if($('.QQ_spirit_button').length>0)return;QQ_SpiritVisible=true;const savedPosition=localStorage.getItem('QQ_spirit_position');let position={right:'20px',bottom:'100px'};if(savedPosition){try{position=JSON.parse(savedPosition);}catch(e){console.warn('解析精灵位置失败，使用默认位置');}}const spiritHtml=`<div class="QQ_spirit_button" style=" position:fixed;${position.right ? `right:${position.right}`:`left:${position.left}`};${position.bottom ? `bottom:${position.bottom}`:`top:${position.top}`};width:60px;height:60px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:50%;box-shadow:0 4px 20px rgba(102,126,234,0.4);cursor:move;z-index:9999;display:flex;align-items:center;justify-content:center;color:white;font-size:24px;user-select:none;transition:all 0.3s ease;animation:spiritPulse 2s infinite;" title="互动空间精灵">🧚‍✨</div><style>@keyframes spiritPulse{0%,100%{transform:scale(1);box-shadow:0 4px 20px rgba(102,126,234,0.4)}50%{transform:scale(1.05);box-shadow:0 6px 25px rgba(102,126,234,0.6)}}.QQ_spirit_button:hover{transform:scale(1.1)!important;box-shadow:0 6px 25px rgba(102,126,234,0.7)!important}@keyframes menuSlideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}#QQ_user_menu{border:1px solid #e1e5e9}.user_menu_item:last-child{border-bottom:none!important}</style>`;$('body').append(spiritHtml);$('.QQ_spirit_button').on('click touchend',function(e){if($(this).hasClass('dragging')){return;}e.stopPropagation();e.preventDefault();QQ_ShowSpiritPanel();});QQ_MakeSpiritDraggable();}function QQ_HideSpiritButton(){$('.QQ_spirit_button').fadeOut(300,function(){$(this).remove();});QQ_SpiritVisible=false;}function QQ_MakeSpiritDraggable(){let isDragging=false;let dragStarted=false;let startX,startY,initialX,initialY;let dragTimer;$('.QQ_spirit_button').on('mousedown touchstart',function(e){e.preventDefault();dragStarted=false;const rect=this.getBoundingClientRect();initialX=rect.left;initialY=rect.top;const clientX=e.type==='touchstart' ? e.originalEvent.touches[0].clientX:e.clientX;const clientY=e.type==='touchstart' ? e.originalEvent.touches[0].clientY:e.clientY;startX=clientX-initialX;startY=clientY-initialY;dragTimer=setTimeout(()=>{isDragging=true;dragStarted=true;$('.QQ_spirit_button').addClass('dragging').css({'cursor':'grabbing','z-index':'10001','animation':'none'});},150);});$(document).on('mousemove touchmove',function(e){if(!isDragging)return;const clientX=e.type==='touchmove' ? e.originalEvent.touches[0].clientX:e.clientX;const clientY=e.type==='touchmove' ? e.originalEvent.touches[0].clientY:e.clientY;const x=clientX-startX;const y=clientY-startY;const maxX=window.innerWidth-60;const maxY=window.innerHeight-60;const constrainedX=Math.max(0,Math.min(x,maxX));const constrainedY=Math.max(0,Math.min(y,maxY));$('.QQ_spirit_button').css({'left':constrainedX+'px','top':constrainedY+'px','right':'auto','bottom':'auto'});e.preventDefault();});$(document).on('mouseup touchend',function(e){if(dragTimer){clearTimeout(dragTimer);dragTimer=null;}if(!isDragging&&!dragStarted){return;}if(!isDragging)return;isDragging=false;dragStarted=false;$('.QQ_spirit_button').removeClass('dragging').css({'cursor':'move','z-index':'9999','animation':'spiritPulse 2s infinite'});const spirit=$('.QQ_spirit_button');if(spirit.length>0){const position={left:spirit.css('left'),top:spirit.css('top')};localStorage.setItem('QQ_spirit_position',JSON.stringify(position));}});}function QQ_ShowSpiritPanel(){$('.QQ_spirit_panel').remove();const spaces=Object.values(QQ_InteractiveSpaces);const hasSpaces=spaces.length>0;let spaceListHtml='';if(hasSpaces){spaceListHtml=spaces.map(space=>`<div class="spirit_space_item" data-space-id="${space.id}" style=" padding:12px 15px;border-bottom:1px solid #eee;cursor:pointer;display:flex;align-items:center;gap:10px;transition:background-color 0.2s ease;" onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor='transparent'"><img src="${space.characterAvatar}" alt="${space.characterName}" style=" width:32px;height:32px;border-radius:50%;object-fit:cover;"><div style="flex:1;"><div style="font-size:14px;font-weight:500;color:#333;">${space.name}</div><div style="font-size:12px;color:#666;margin-top:2px;">${new Date(space.lastAccess).toLocaleDateString()}${new Date(space.lastAccess).toLocaleTimeString().slice(0,5)}</div></div><svg width="16" height="16" viewBox="0 0 24 24" fill="#999"><path d="M8.59 16.34l4.58-4.59-4.58-4.59L10 5.75l6 6-6 6z"/></svg></div>`).join('');}else{spaceListHtml=`<div style=" padding:30px 20px;text-align:center;color:#999;font-size:14px;"><div style="font-size:48px;margin-bottom:10px;">🌟</div>暂无互动空间<br><small>与AI的互动内容会自动保存到这里</small></div>`;}const panelHtml=`<div class="QQ_spirit_panel" style=" position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:320px;max-height:500px;background:white;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.3);z-index:10000;animation:spiritPanelShow 0.3s ease;overflow:hidden;"><div class="spirit_panel_header" style=" background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px;text-align:center;position:relative;"><h3 style="margin:0;font-size:18px;font-weight:600;">🧚‍✨ 互动空间</h3><p style="margin:5px 0 0 0;font-size:13px;opacity:0.9;">管理你的所有现实互动</p><button class="spirit_panel_close" style=" position:absolute;top:15px;right:15px;background:rgba(255,255,255,0.2);border:none;color:white;width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;">×</button></div><div class="spirit_panel_body" style=" max-height:350px;overflow-y:auto;">${spaceListHtml}</div><div class="spirit_panel_footer" style=" padding:15px 20px;background:#f8f9fa;border-top:1px solid #eee;display:flex;gap:10px;"><button class="spirit_hide_btn" style=" flex:1;background:#6c757d;border:none;color:white;padding:10px;border-radius:8px;cursor:pointer;font-size:13px;transition:background-color 0.2s ease;" onmouseover="this.style.backgroundColor='#5a6268'" onmouseout="this.style.backgroundColor='#6c757d'">隐藏精灵</button><button class="spirit_stats_btn" style=" flex:1;background:#28a745;border:none;color:white;padding:10px;border-radius:8px;cursor:pointer;font-size:13px;transition:background-color 0.2s ease;" onmouseover="this.style.backgroundColor='#218838'" onmouseout="this.style.backgroundColor='#28a745'">查看统计</button></div></div><div class="QQ_spirit_panel_overlay" style=" position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;animation:fadeIn 0.3s ease;"></div><style>@keyframes spiritPanelShow{from{transform:translate(-50%,-50%)scale(0.9);opacity:0}to{transform:translate(-50%,-50%)scale(1);opacity:1}}</style>`;$('body').append(panelHtml);$('.spirit_panel_close,.QQ_spirit_panel_overlay').on('click',function(){QQ_CloseSpiritPanel();});$('.spirit_hide_btn').on('click',function(){QQ_CloseSpiritPanel();QQ_HideSpiritButton();});$('.spirit_stats_btn').on('click',function(){QQ_ShowInteractiveStats();});$('.spirit_space_item').on('click',function(){const spaceId=$(this).data('space-id');QQ_OpenInteractiveSpace(spaceId);});$('.QQ_spirit_panel').on('click',function(e){e.stopPropagation();});}function QQ_CloseSpiritPanel(){$('.QQ_spirit_panel,.QQ_spirit_panel_overlay').fadeOut(300,function(){$(this).remove();});}function QQ_OpenInteractiveSpace(spaceId){const space=QQ_InteractiveSpaces[spaceId];if(!space){triggerSlash('/echo severity=error 互动空间不存在或已被删除');return;}space.lastAccess=new Date().toISOString();QQ_SaveInteractiveSpaces();QQ_CloseSpiritPanel();QQ_ShowStoredInteractiveSpace(space);}function QQ_ShowStoredInteractiveSpace(space){QQ_ActiveSpaceId=space.id;$('.QQ_interactive_space').remove();const interactiveSpaceHtml=`<div class="QQ_interactive_space" data-space-id="${space.id}" style=" position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.3s ease;backdrop-filter:blur(10px);"><div class="QQ_interactive_content" style=" background:#ffffff;border-radius:15px;padding:0;max-width:85%;max-height:75%;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,0.3);position:relative;color:#333;animation:slideIn 0.3s ease;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;"><div class="QQ_interactive_header" style=" background:linear-gradient(135deg,#4FC3F7 0%,#29B6F6 100%);padding:20px;display:flex;align-items:center;color:white;position:relative;"><img src="${space.characterAvatar}" alt="${space.characterName}" style=" width:45px;height:45px;border-radius:50%;margin-right:15px;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.2);"><div style="flex:1;"><h3 style="margin:0;font-size:17px;font-weight:600;">${space.name}</h3><p style="margin:3px 0 0 0;font-size:13px;opacity:0.9;">现实互动模式</p></div><button class="QQ_rename_space" style=" background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease;margin-right:8px;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'" title="重命名空间">✏️</button><button class="QQ_delete_space" style=" background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease;margin-right:8px;" onmouseover="this.style.background='rgba(255,87,87,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'" title="删除空间">🗑️</button><button class="QQ_close_interactive" style=" background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">×</button></div><div class="QQ_interactive_body" style=" padding:25px 20px;font-size:15px;line-height:1.5;white-space:pre-wrap;color:#333;background:#fafafa;max-height:300px;overflow-y:auto;">${space.content}</div><div class="QQ_interactive_footer" style=" padding:20px;background:#ffffff;border-top:1px solid #eee;display:flex;justify-content:center;gap:15px;"><button class="QQ_reply_interactive" style=" background:#4FC3F7;border:none;color:white;padding:12px 24px;border-radius:25px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.3s ease;box-shadow:0 2px 8px rgba(79,195,247,0.3);" onmouseover="this.style.background='#29B6F6';this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#4FC3F7';this.style.transform='translateY(0)'">💬 回应互动</button><button class="QQ_close_interactive" style=" background:#f5f5f5;border:none;color:#666;padding:12px 24px;border-radius:25px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.3s ease;" onmouseover="this.style.background='#eeeeee'" onmouseout="this.style.background='#f5f5f5'">关闭</button></div></div></div>`;$('body').append(interactiveSpaceHtml);$('.QQ_rename_space').off('click').on('click',function(){QQ_RenameInteractiveSpace(space.id);});$('.QQ_delete_space').off('click').on('click',function(){QQ_DeleteInteractiveSpace(space.id);});$('.QQ_close_interactive').off('click').on('click',function(){QQ_CloseInteractiveSpace();});$('.QQ_reply_interactive').off('click').on('click',function(){QQ_CloseInteractiveSpace();QQ_OpenInteractiveReply(space.characterName);});$('.QQ_interactive_space').on('click',function(e){if(e.target===this){QQ_CloseInteractiveSpace();}});triggerSlash(`/echo 已打开互动空间：${space.name}`);}function QQ_DeleteInteractiveSpace(spaceId){const space=QQ_InteractiveSpaces[spaceId];if(!space)return;if(confirm(`确定要删除互动空间"${space.name}"吗？此操作无法撤销。`)){delete QQ_InteractiveSpaces[spaceId];QQ_SaveInteractiveSpaces();QQ_CloseInteractiveSpace();triggerSlash(`/echo 互动空间"${space.name}"已删除`);}}function QQ_ShowInteractiveStats(){const spaces=Object.values(QQ_InteractiveSpaces);const totalSpaces=spaces.length;const characters=[...new Set(spaces.map(s=>s.characterName))];const totalCharacters=characters.length;const characterStats={};spaces.forEach(space=>{const char=space.characterName;if(!characterStats[char]){characterStats[char]={count:0,lastInteraction:space.lastAccess};}characterStats[char].count++;if(new Date(space.lastAccess)>new Date(characterStats[char].lastInteraction)){characterStats[char].lastInteraction=space.lastAccess;}});const recentSpaces=spaces
.sort((a,b)=>new Date(b.lastAccess)-new Date(a.lastAccess)).slice(0,5);let statsHtml=`
📊 互动空间统计信息
总互动空间:${totalSpaces}个
涉及角色:${totalCharacters}个
📈 角色互动统计:${Object.entries(characterStats).sort((a,b)=>b[1].count-a[1].count).map(([char,stats])=>`• ${char}:${stats.count}次`).join('\n')}🕒 最近互动:${recentSpaces.map(space=>`• ${space.name}(${new Date(space.lastAccess).toLocaleDateString()})`).join('\n')}💾 数据保存位置:世界书
🔄 最后同步:${new Date().toLocaleString()}`;triggerSlash(`/echo ${statsHtml}`);QQ_CloseSpiritPanel();}function QQ_ToggleUserMenu(){const menu=$('#QQ_user_menu');if(menu.is(':visible')){QQ_HideUserMenu();}else{QQ_ShowUserMenu();}}function QQ_ShowUserMenu(){$('.dropdown-menu,.context-menu').hide();$('#QQ_user_menu').fadeIn(200);$(document).one('click',function(e){if(!$(e.target).closest('#QQ_user_menu,#QQ_home_UserName').length){QQ_HideUserMenu();}});}function QQ_HideUserMenu(){$('#QQ_user_menu').fadeOut(150);}window.QQ_Show_Interactive_Stats=function(){const spaces=Object.values(QQ_InteractiveSpaces);if(worldbook){getLorebookEntries(worldbook).then(entries=>{if(entries){const entry=entries.find(e=>e.comment===QQ_INTERACTIVE_BACKUP_KEY);if(entry){try{const data=JSON.parse(entry.content);console.log('备份空间数量:',Object.keys(data.spaces||{}).length);}catch(e){console.error('解析备份数据失败:',e);}}}else{console.warn('无法获取世界书条目');}}).catch(error=>{console.error('获取世界书条目失败:',error);});}else{console.warn('世界书未初始化');}const spiritButton=$('.QQ_spirit_button');if(spiritButton.length>0){console.log('精灵按钮位置:',{left:spiritButton.css('left'),top:spiritButton.css('top'),right:spiritButton.css('right'),bottom:spiritButton.css('bottom')});}const savedPosition=localStorage.getItem('QQ_spirit_position');triggerSlash('/echo 📊 互动空间调试信息已输出到控制台');};async function QQ_InitInteractiveSystem(){try{await QQ_LoadInteractiveSpaces();await QQ_LoadCharacterSpaces();if(!$('#QQ_interactive_styles').length){$('head').append(`<style>@keyframes menuSlideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}.user_menu_item:last-child{border-bottom:none!important}@media(max-width:768px){.QQ_spirit_button{width:50px!important;height:50px!important;font-size:20px!important}}@media(max-width:768px){.QQ_interactive_content{max-width:95%!important;max-height:85%!important}.QQ_spirit_panel{width:300px!important;max-height:400px!important}}</style>`);}}catch(error){console.error('❌ 互动空间系统初始化失败:',error);}}function QQ_OpenInteractiveReply(characterName){const inputHtml=`<div class="QQ_reply_input_overlay" style=" position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.3s ease;"><div style=" background:white;border-radius:15px;padding:25px;max-width:80%;width:400px;box-shadow:0 10px 30px rgba(0,0,0,0.3);animation:slideIn 0.3s ease;"><h3 style="margin:0 0 15px 0;color:#333;text-align:center;">回应 ${characterName}的互动</h3><textarea id="reply_input" placeholder="输入你的回应..." style=" width:100%;height:100px;border:2px solid #e0e0e0;border-radius:10px;padding:12px;font-size:14px;resize:vertical;box-sizing:border-box;font-family:inherit;"></textarea><div style="display:flex;justify-content:center;gap:15px;margin-top:20px;"><button id="send_reply" style=" background:#4FC3F7;border:none;color:white;padding:10px 20px;border-radius:20px;cursor:pointer;font-size:14px;font-weight:500;">发送回应</button><button id="cancel_reply" style=" background:#f5f5f5;border:none;color:#666;padding:10px 20px;border-radius:20px;cursor:pointer;font-size:14px;font-weight:500;">取消</button></div></div></div>`;$('body').append(inputHtml);setTimeout(()=>$('#reply_input').focus(),100);$('#send_reply').on('click',function(){const replyText=$('#reply_input').val().trim();if(replyText){const interactiveReply=`回应互动:${replyText}`;QQ_SendMessage(interactiveReply,characterName);$('.QQ_reply_input_overlay').fadeOut(300,function(){$(this).remove();});}else{$('#reply_input').focus();}});$('#cancel_reply').on('click',function(){$('.QQ_reply_input_overlay').fadeOut(300,function(){$(this).remove();});});$('.QQ_reply_input_overlay').on('click',function(e){if(e.target===this){$(this).fadeOut(300,function(){$(this).remove();});}});$('#reply_input').on('keydown',function(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();$('#send_reply').click();}});}function QQ_SendMessage(message,targetName=""){SendValue=message;SendName=targetName;if(typeof QQ_Send==='function'){QQ_Send();}else{if(targetName){triggerSlash(`/sendas name={{char}}收到来自${UserName}的互动回应:${message}`);}else{triggerSlash(`/sendas name={{char}}收到互动回应:${message}`);}}SendValue="";SendName="";}function QQ_ToggleUserMenu(){const menu=$('#QQ_user_menu');if(menu.is(':visible')){QQ_HideUserMenu();}else{QQ_ShowUserMenu();}}function QQ_ShowUserMenu(){const menu=$('#QQ_user_menu');if(menu.length===0)return;$('.dropdown-menu,.context-menu,.QQ_spirit_panel').hide();menu.show();setTimeout(()=>{$(document).on('click.user-menu',function(e){if(!menu.is(e.target)&&menu.has(e.target).length===0&&!$('#QQ_home_UserName').is(e.target)){QQ_HideUserMenu();}});},100);}function QQ_HideUserMenu(){$('#QQ_user_menu').hide();$(document).off('click.user-menu');}window.QQ_Show_Interactive_Stats=function(){const spaces=Object.values(QQ_InteractiveSpaces);const spiritVisible=QQ_SpiritVisible;const activeSpace=QQ_ActiveSpaceId;let report=`
🧚‍✨ 互动空间系统状态报告========================📊 基础统计:• 总空间数:${spaces.length}• 精灵状态:${spiritVisible ? '显示':'隐藏'}• 活动空间:${activeSpace||'无'}📝 空间详情:`;if(spaces.length>0){spaces.forEach((space,index)=>{const lastAccess=new Date(space.lastAccess).toLocaleString();report+=`
${index+1}. ${space.name}ID:${space.id}角色:${space.characterName}创建:${new Date(space.createdAt).toLocaleString()}最后访问:${lastAccess}内容长度:${space.content.length}字符`;});}else{report+=`
暂无互动空间数据`;}report+=`
💾 存储信息:• 备份键:${QQ_INTERACTIVE_BACKUP_KEY}• 世界书状态:${worldbook ? '已加载':'未加载'}🔧 可用命令:• window.QQ_Show_Interactive_Stats()-显示此统计
• QQ_ShowSpiritButton()-显示精灵按钮
• QQ_HideSpiritButton()-隐藏精灵按钮
• QQ_LoadInteractiveSpaces()-重新加载空间数据
• QQ_SaveInteractiveSpaces()-手动保存空间数据
`;triggerSlash(`/echo 📊 互动空间统计：${spaces.length}个空间，精灵${spiritVisible ? '显示':'隐藏'}中`);return{totalSpaces:spaces.length,spiritVisible,activeSpace,spaces:spaces.map(s=>({id:s.id,name:s.name,character:s.characterName,created:s.createdAt,lastAccess:s.lastAccess}))};};function QQ_ToggleUserMenu(){let existingMenu=document.getElementById('QQ_user_dropdown_menu');if(existingMenu){existingMenu.remove();return;}const menu=document.createElement('div');menu.id='QQ_user_dropdown_menu';menu.style.cssText=`
position:fixed;top:70px;left:50%;transform:translateX(-50%);background:white;border:1px solid #ddd;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:10000;min-width:200px;overflow:hidden;`;const currentUserName=document.getElementById('QQ_message_list_UserName').textContent.replace(/\*\*/g,'');const menuItems=[{icon:'👤',text:'修改昵称',action:()=>QQ_ChangeUserName()},{icon:'💫',text:'互动使用指南',action:()=>QQ_ShowInteractiveGuide()},{icon:'📱',text:'手机状态',action:()=>QQ_ShowPhoneStatus()},{icon:'🔄',text:'同步数据',action:()=>QQ_SyncAllData()},{icon:'📋',text:'数据管理',action:()=>QQ_ShowDataManagement()},{icon:'🧹',text:'清理缓存',action:()=>QQ_ClearCache()}];menuItems.forEach((item,index)=>{const menuItem=document.createElement('div');menuItem.style.cssText=`
padding:12px 16px;display:flex;align-items:center;cursor:pointer;border-bottom:${index<menuItems.length-1 ? '1px solid #f0f0f0':'none'};transition:background-color 0.2s;`;menuItem.innerHTML=`<span style="margin-right:12px;font-size:16px;">${item.icon}</span><span style="color:#333;font-size:14px;">${item.text}</span>`;menuItem.addEventListener('mouseover',()=>{menuItem.style.backgroundColor='#f5f5f5';});menuItem.addEventListener('mouseout',()=>{menuItem.style.backgroundColor='transparent';});menuItem.addEventListener('click',()=>{menu.remove();item.action();});menu.appendChild(menuItem);});document.body.appendChild(menu);setTimeout(()=>{document.addEventListener('click',function closeMenu(e){if(!menu.contains(e.target)){menu.remove();document.removeEventListener('click',closeMenu);}});},100);}function QQ_ShowInteractiveGuide(){const guideContent=`
🎯 互动功能使用指南
【主动触发互动】
使用特殊符号&&直接触发互动内容：
✨ 使用方法：
• "&&想要拥抱你" • "抱抱你&&" • "我想&&和你一起散步" 🎪 效果：AI会直接生成互动场景，跳过普通聊天
【互动模式】
系统检测关键词自动触发：
💫 关键词类型：
• 身体接触：拥抱、亲吻、触摸、牵手
• 面对面交流：面对面、走近、坐下
• 情感表达：脸红、微笑、哭泣
• 动作描述：*动作*、【情感】
🏠 互动空间：
• 点击私聊角色名称可查看角色专属精灵
• 精灵可管理该角色的所有互动记录
• 支持创建新互动和查看历史记录
💡 小贴士：
• 主动符号触发更精准
• 互动模式在关键时刻激活
• 所有互动内容保存在世界书中
`.trim();alert(guideContent);}function QQ_ChangeUserName(){const currentName=document.getElementById('QQ_message_list_UserName').textContent.replace(/\*\*/g,'');const newName=prompt('请输入新的昵称:',currentName);if(newName&&newName.trim()&&newName.trim()!==currentName){const finalName=newName.trim();document.getElementById('QQ_message_list_UserName').innerHTML=`<strong>${finalName}</strong>`;document.getElementById('QQ_home_UserName').textContent=finalName;QQ_SafeSaveToWorldBook('用户设置',{userName:finalName,updateTime:new Date().toISOString()},'QQ_用户设置');triggerSlash(`/echo 用户名已更改为:${finalName}`);}}function QQ_ShowPhoneStatus(){const stats={contacts:Object.keys(window.QQ_Contacts||{}).length,groups:Object.keys(window.QQ_Groups||{}).length,messages:Object.keys(window.QQ_MessageHistory||{}).length,moments:Object.keys(window.QQ_MomentData||{}).length,interactiveSpaces:Object.keys(window.QQ_InteractiveSpaces||{}).length};const statusInfo=`
📱 手机状态报告
联系人:${stats.contacts}个
群聊:${stats.groups}个
消息记录:${stats.messages}条
动态:${stats.moments}条
互动空间:${stats.interactiveSpaces}个
🔋 系统状态:正常
📶 网络状态:已连接
💾 数据同步:世界书
`.trim();alert(statusInfo);}function QQ_SyncAllData(){const syncTasks=[()=>QQ_SaveAllContactsToWorldBook(),()=>QQ_SaveAllGroupsToWorldBook(),()=>QQ_SaveAllMessagesToWorldBook(),()=>QQ_SaveAllMomentsToWorldBook(),()=>QQ_SaveAllInteractiveSpacesToWorldBook(),()=>saveGroupsToStorage()];let completed=0;const total=syncTasks.length;syncTasks.forEach((task,index)=>{setTimeout(()=>{try{task();completed++;if(completed===total){triggerSlash(`/echo 所有数据已同步到世界书(${total}/${total})`);}}catch(error){console.error(`❌ 同步任务 ${index+1}失败:`,error);}},index*500);});triggerSlash(`/echo 正在同步数据到世界书...(0/${total})`);}function QQ_ShowDataManagement(){alert('数据管理功能开发中...\n\n当前支持:\n• 所有数据保存在世界书中\n• 联系人分组管理\n• 互动空间管理\n• 消息记录管理');}function QQ_ClearCache(){if(confirm('确定要清理缓存吗？这将清除临时数据但保留世界书中的重要数据。')){window.QQ_Cache={};window.QQ_TempData={};$('.QQ_temp_cache').remove();triggerSlash('/echo 缓存已清理，重要数据保留在世界书中');}}window.QQ_Test_Interactive_Detection=function(text){if(text){const result=QQ_DetectInteractiveIntent(text);let details=`===互动意图检测测试===📝 测试文本:"${text}"`;if(result&&result.isInteractive){details+=`
🎯 检测结果:✅ 检测到互动意图
🔧 触发类型:${result.triggerType==='symbol' ? '🎯 特殊符号触发':'💫 关键词触发(互动模式)'}`;if(result.triggerType==='symbol'){details+=`
🔗 触发符号:${result.triggerSymbol}📝 清理后内容:"${result.cleanContent}" 💡 说明:${result.description}`;}else{details+=`
📊 关键词匹配:${result.matchCount||0}个
🎭 模式匹配:${result.patternMatches||0}个
🔍 匹配内容:${result.matchedKeywords ? result.matchedKeywords.join(','):'无'}💡 说明:${result.description}`;}}else{details+=`
🎯 检测结果:❌ 未检测到互动意图`;}details+=`
💡 使用指南:🎯 【主动触发】使用特殊符号:• "&&想要拥抱你"(✅ 符号触发)• "抱抱你&&"(✅ 符号触发)• "我想&&和你一起散步"(✅ 符号触发)💫 【互动模式】传统关键词:• 身体接触:拥抱、亲吻、触摸、牵手等
• 面对面交流:面对面、当面、走近、坐下等
• 情感表达:脸红、害羞、微笑、哭泣等
• 动作描述:*动作*、【情感】等格式
• 需要2个关键词或1个模式匹配才触发
📚 示例测试文本:• "&&抱抱你"(🎯 符号触发)• "我想抱抱你"(💫 身体接触)• "*走向你*"(💫 动作模式)• "面对面聊天"(💫 面对面+动作)• "你好吗？"(❌ 普通对话)`;alert(details);return result;}else{const testCases=[{name:"先私聊回复后互动",content:"先在私聊回复'好的马上来'然后过来拥抱我",expected:"应检测到先回复要求",test:(content)=>QQ_CheckPriorReplyRequest(content).shouldReplyFirst},{name:"先群聊回复后互动",content:"先在群聊说'大家等我一下'然后再过来一起玩游戏",expected:"应检测到先回复要求",test:(content)=>QQ_CheckPriorReplyRequest(content).shouldReplyFirst},{name:"无效集体关键词",content:"用户发送了'集体行动'但这只是在讨论概念",expected:"不应触发多人互动",test:(content)=>!QQ_DetectMultiCharacterInteraction(content,null)},{name:"有效集体互动",content:"我们一起去公园玩吧，所有人都来",expected:"应触发多人互动",test:(content)=>QQ_DetectMultiCharacterInteraction(content,null)},{name:"过去时态无效",content:"我们以前一起玩过游戏",expected:"不应触发多人互动",test:(content)=>!QQ_DetectMultiCharacterInteraction(content,null)},{name:"条件句无效",content:"如果我们一起去的话会很有趣",expected:"不应触发多人互动",test:(content)=>!QQ_DetectMultiCharacterInteraction(content,null)},{name:"有效互动内容",content:"*走向你*想要拥抱你",expected:"应检测到互动内容",test:(content)=>QQ_IsInteractiveContent(content)},{name:"普通对话",content:"你今天怎么样？工作顺利吗？",expected:"不应检测到互动内容",test:(content)=>!QQ_IsInteractiveContent(content)}];let passCount=0;let failCount=0;testCases.forEach((testCase,index)=>{try{const result=testCase.test(testCase.content);if(result){passCount++;}else{failCount++;}}catch(error){console.error(`💥 测试执行错误:`,error);failCount++;}});console.log(`📊 成功率:${Math.round((passCount/testCases.length)*100)}%`);if(failCount===0){}else{}return{passCount,failCount,total:testCases.length};}};function QQ_UpdateNewTips(){let ids=$(".QQ_chat_page").map(function(){return this;}).get().filter(Boolean);for(const id of ids){if($(id).css("display")=="none"){continue;}const name=$(id).attr("data-name")?? "";let TipsCount=QQ_GetChatShowTipsCount(name);const $Tips=$(`.QQ_chat_page[data-name='${name}']`).find(`.new_tips`,);$Tips.text(TipsCount);if(TipsCount>0){$Tips.css("display","flex");}else{$Tips.hide();}}}function QQ_Nav(page){const $message_svg=$("#QQ_message_svg");const $people_svg=$("#QQ_people_svg");const $moment_svg=$("#QQ_moment_svg");$message_svg.css("fill","#000000");$people_svg.css("fill","#000000");$moment_svg.css("fill","#000000");$("#QQ_home_page").hide();$("#QQ_space_page").hide();$("#QQ_message_list_page").hide();$(".QQ_bottom_nav").show();QQ_currentPage=page;if(page==="message"){$message_svg.css("fill","#019aff");$("#QQ_message_list_page").css('display','flex');$("#App_QQ").css("background-color","#eff3ff");const userName=$("#QQ_home_UserName").text();$("#QQ_message_list_UserName").text(userName);setTimeout(async()=>{await QQ_UpdateMessageList();},100);}else if(page==="people"){$people_svg.css("fill","#019aff");$("#QQ_home_page").css('display','flex');$("#App_QQ").css("background-color","#eff3ff");if(typeof initContactGroups==='function'){setTimeout(initContactGroups,200);}}else if(page==="moment"){$moment_svg.css("fill","#019aff");$("#QQ_space_page").show();$("#App_QQ").css("background-color","#ffffff");QQ_SetNewTips(0);QQ_NewMsg["moment"]=0;$(".new_tips").hide();}else if(page==="chat"){$(".QQ_bottom_nav").hide();$("#QQ_home_page").hide();$("#QQ_space_page").hide();$("#QQ_message_list_page").hide();if(window.currentGroupChat){$(".QQ_chat_page").hide();$(".group-chat-page").remove();const groupChatPage=$(`<div data-group-id="${window.currentGroupChat.id}" class="QQ_chat_page group-chat-page" style="width:100%;height:100%;padding-top:0;background-color:white;position:relative;display:none;"><div class="chat-header" style="padding:10px 15px;background-color:white;border-bottom:1px solid #eee;display:flex;align-items:center;"><div style="cursor:pointer;margin-right:15px;" onclick="QQ_GoHome()"><svg viewBox="0 0 1024 1024" style="height:20px;width:20px;"><path d="M724 218.3V141c0-6.7-7.7-10.4-12.9-6.3L260.3 486.8a31.86 31.86 0 0 0 0 50.3l450.8 352.1c5.3 4.1 12.9 0.4 12.9-6.3v-77.3c0-4.9-2.3-9.6-6.1-12.6l-360-281 360-281.1c3.8-3 6.1-7.7 6.1-12.6z" fill="#333"></path></svg></div><div class="group-chat-info" style="flex:1;"><div class="group-chat-name" style="font-size:16px;font-weight:bold;color:#333;">${window.currentGroupChat.name}</div><div class="group-chat-members" style="font-size:12px;color:#666;">群聊 · ${window.currentGroupChat.members.length}人</div></div><div style="cursor:pointer;" onclick="showGroupManagementMenu(window.currentGroupChat,this)"><svg viewBox="0 0 1024 1024" style="height:20px;width:20px;"><path d="M512 256c-35.3 0-64 28.7-64 64s28.7 64 64 64 64-28.7 64-64-28.7-64-64-64zm0 256c-35.3 0-64 28.7-64 64s28.7 64 64 64 64-28.7 64-64-28.7-64-64-64zm0 256c-35.3 0-64 28.7-64 64s28.7 64 64 64 64-28.7 64-64-28.7-64-64-64z" fill="#666"></path></svg></div></div><div class="msgcontent" style="flex:1;overflow-y:auto;padding:10px;background-color:#f5f5f5;height:calc(100vh-120px);"></div><div class="chat-input" style="padding:10px;background-color:white;border-top:1px solid #eee;display:flex;align-items:center;"><input type="text" placeholder="输入消息..." style="flex:1;padding:8px 12px;border:1px solid #ddd;border-radius:20px;outline:none;"><button style="margin-left:10px;padding:8px 16px;background:#007AFF;color:white;border:none;border-radius:20px;cursor:pointer;">发送</button></div></div>`);$("#App_QQ").append(groupChatPage);groupChatPage.show();$("#App_QQ").css("background-color","#ffffff");loadGroupChatHistory(window.currentGroupChat.id);}else{const chatPage=$(".QQ_chat_page").not('.group-chat-page');if(chatPage.length>0){chatPage.first().show();$("#App_QQ").css("background-color","#ffffff");}else{console.error('未找到聊天页面元素');QQ_Nav("message");return;}}}}function QQ_GoHome(){QQ_HideAllChat();if(window.currentGroupChat&&window.groupChatSourcePage){const sourcePage=window.groupChatSourcePage;window.currentGroupChat=null;window.groupChatSourcePage=null;if(sourcePage==='messages'){QQ_Nav("message");}else{QQ_Nav("people");}return;}if(QQ_currentPage==="message"){QQ_Nav("message");}else if(QQ_currentPage==="moment"){QQ_Nav("moment");}else{QQ_Nav("people");}}function QQ_Error(content,change){triggerSlash(`/echo severity=error ${content}`);if(change){triggerSlash(`/echo 请更换浏览器重试`);}}async function init(){const LorebookSettings=await getLorebookSettings();if(LorebookSettings&&LorebookSettings.context_percentage!=100){await setLorebookSettings({context_percentage:100});}Verify();UserName=(await triggerSlashWithResult("/pass{{user}}"))?? "";$("#QQ_home_UserName").html(`<strong>${UserName}</strong>`);$("#QQ_message_list_UserName").html(`<strong>${UserName}</strong>`);charAvatarPath=(await triggerSlashWithResult("/pass{{charAvatarPath}}",))?? "";userAvatarPath=(await triggerSlashWithResult("/pass{{userAvatarPath}}",))?? "";charcardname=(await triggerSlashWithResult("/pass{{char}}"))?? "";try{worldbook=await GetWorldBookName();if(!worldbook){QQ_Error(`获取世界书失败!!!!`);}entries=await getLorebookEntries(worldbook);if(!entries){QQ_Error(`获取世界书条目失败!!!!`);}}catch(e){QQ_Error(`出现异常:\n${e}`);}Variables=await getVariables();if(Variables){if(Variables.Npc_Settings){try{Npc_Settings=JSON.parse(Variables.Npc_Settings);}catch{QQ_Error("读取NPC配置失败");}}}.attr("data-name","AutoNpc").text("").appendTo("head");System_UpdateNpcCss();let Phone_Entry=GetWorldEntry(["手机-界面基本设置","手机界面基本设置"],true,);if(Phone_Entry){Phone_Settings.loadText(Phone_Entry.content);}DelPadding();await WorldBookUpdate();await GetSettings();await LoadRandomHead();await LoadEmoji();await LoadChars();await MiPhone_Merge();await QQ_Load_Chat_Backup();await QQ_Enhance_Group_Metadata();await QQ_LoadReadStatus();await QQ_Load_Moments();await QQ_InitInteractiveSystem();$(document).on("click","#QQ_message_nav",()=>{QQ_Nav("message");});$(document).on("click","#QQ_people_nav",()=>{QQ_Nav("people");});$(document).on("click","#QQ_moment_nav",()=>{QQ_Nav("moment");});$(document).on("click",".QQ-close-btn",()=>QQ_GoHome());$(document).on("click",".QQ_home_usermsg",(e)=>QQ_ChangeChatPage(e),);$(document).on("click","#QQ_chat_page_setting",(e)=>QQ_SetChatPageSetting(e),);$(document).on("click",".close-setting-btn",()=>closeSettingPopup(),);$(document).on("click",".moment_menu_dots",showMomentMenu);$(document).on("click",".moment_menu_item",function(e){e.stopPropagation();const action=$(this).data('action');const momentId=$(this).data('moment-id');hideMomentMenu();if(action==='delete'){confirmDeleteMoment(momentId);}});$(document).on("click",".moment_dialog_cancel",function(){$('.moment_confirm_dialog').fadeOut(200,function(){$(this).remove();});});$(document).on("click",".moment_dialog_confirm",async function(){const momentId=$(this).data('moment-id');const success=await QQ_Delete_Moment(momentId);$('.moment_confirm_dialog').fadeOut(200,function(){$(this).remove();});if(success){}else{console.error('动态删除失败');}});$(document).on("click",function(){hideMomentMenu();});$(document).on("click",".moment_menu_dropdown",function(e){e.stopPropagation();});$(document).on("click",".moment_confirm_dialog>div",function(e){e.stopPropagation();});$(document).on("click","#cancel-setting-btn",()=>closeSettingPopup(),);$(document).on("click","#save-setting-btn",()=>saveSettingAndClose(),);$(document).on("click","#randomcolor-setting-btn",function(){const{bgColor,textColor}=generateBubbleColor();$("#bubble-color").val(bgColor);$("#bubble-color-input").val(bgColor);$("#text-color").val(textColor);$("#text-color-input").val(textColor);$("#chat-setting-preview").each(function(){this.style.setProperty("background-color",bgColor,"important",);const spans=this.querySelectorAll("span");spans.forEach((span)=>{span.style.setProperty("color",textColor,"important",);});});},);$(document).on("click",".moment_comment",QQ_Moment_Comment);$(document).on("keypress",".user_moment input[type='text']",function(e){if(e.which===13){const $sendButton=$(this).siblings('.moment_comment');if($sendButton.length>0){$sendButton.click();}}});$(document).on("click","#QQ_chat_send-btn",(event)=>QQ_SendMsg(event),);$(document).on("dblclick",".Chat_MyHead",(e)=>QQ_Roll(e));$(document).on("click",".QQ_chat_voice",(e)=>QQ_Voice2Text(e),);$(document).on("click",".music-container",(e)=>QQ_MusicPlay(e),);$(document).on("click",".popup-overlay",function(e){if(e.target===this){closeSettingPopup();}});$(document).on("click",".top",function(){if($(".discord").css("display")=="none"){App_Load("discord");}else{App_Load("QQ");}});$(document).on("click",".discord-top-return",()=>App_Load("QQ"),);$(document).on("click",".app-svg-div[data-app='QQ']",()=>App_Load("QQ"),);$(document).on("click",".app-svg-div[data-app='twitter']",()=>App_Load("twitter"),);$(document).on("keydown",".userInput",function(e){QQ_EnterPress(e,this);});$(document).on("keydown",".discord-thread-input-userinput",function(e){Discord_EnterPress(e,this);},);$(document).on("click",".discord-card",(e)=>Discord_LoadThread(e),);$(document).on("click",".discord-thread-top-return",function(){$(".discord-homepage").show();$(".discord-thread-list").hide();},);$(document).on("click",".discord-cardget",function(){triggerSlash("/send 查看discord帖子内容|/trigger");});$(document).on("click",".discord_thread-input-sendbutton",(e)=>Discord_Send(e),);$(document).on("input",".discord-thread-input-userinput",(e)=>Discord_input(e),);const restoredFromBackup=await QQ_Load_Chat_Backup();await QQ_Enhance_Group_Metadata();const message=System_TagCompletion(await ST.GetCurrentMessages(),);if(!restoredFromBackup){let match=message.match(/msg_start([\s\S]+?)msg_end/);if(match){console.log(`解析当前楼层聊天记录：\n${match[1].trim()}`);await QQ_Msg_Parse(match[1].trim());if(!match[1].match(/\S/)){await QQ_Save_Msg();}}}const matches=message.matchAll(/moment_start([\s\S]+?)moment_end/g,);if(matches){for(const m of matches){QQ_Moment_Parse(m[1].trim());}}let discords=message.matchAll(/(?:discord_start|<discord>)([\S\s]+?)(?:discord_end|<\/discord>)/g,);if(discords){for(const discord of discords){Discord_Parse(discord[1]);}}console.log(`群聊列表:${QQ_Groups.join(",")}`);setTimeout(()=>{QQ_Nav("people");QQ_UpdateMessageList();if(typeof initContactSearch==='function'){initContactSearch();}if(typeof initContactGroups==='function'){initContactGroups();}setTimeout(()=>{if(typeof QQ_InitMomentLikes==='function'){QQ_InitMomentLikes();}},800);},500);}init();setTimeout(()=>{QQ_UpdateMessageList();if(document.getElementById('contact_search_input')&&!document.getElementById('contact_search_input').hasAttribute('data-initialized')){initContactSearch();}},1000);async function WorldBookUpdate(){let text={"手机-格式1-格式开头":_1_raw_namespaceObject,"手机-格式2-QQ聊天":_2_QQ_raw_namespaceObject,"手机-格式3-QQ空间":_3_QQ_raw_namespaceObject,"手机-格式4-discord论坛":_4_discord_raw_namespaceObject,"手机-格式999-格式结尾":_999_raw_namespaceObject,"手机-界面基本设置":src_worldbook_raw_namespaceObject_0,"手机-角色":`[a]头像=http:[b]头像=http:[相亲相爱一家人]类型=群聊
成员=a,b
头像=http:"手机-表情包存放":_worldbook_raw_namespaceObject,"手机-随机头像":_raw_namespaceObject,};const nowver=Phone_Settings.readValue("下面是基本设置","世界书版本",);if(nowver&&Number(version)<=Number(nowver)){return;}for(let entry of entries){if(entry.comment=="手机-格式"){try{await deleteLorebookEntry(worldbook,entry.uid);}catch{}}}let ini=new MyINI();ini.loadText(worldlistraw_namespaceObject);for(const section of ini.getAllSections()){let targetEntry=entries.find((entry)=>entry.comment==section,);if(targetEntry&&ini.readValue(section,"覆盖")!="真"){continue;}if(targetEntry){await setLorebookEntries(worldbook,[{uid:targetEntry.uid,content:text[section],key:ini
.readValue(section,"关键词").split(",").map((item)=>item.trim()),depth:ini.readValue(section,"深度"),type:ini.readValue(section,"类型")=="蓝灯" ? "constant":"selective",exclude_recursion:true,order:Number(ini.readValue(section,"顺序")),enabled:true,},]);}else{await createLorebookEntry(worldbook,{comment:section,key:ini
.readValue(section,"关键词").split(",").map((item)=>item.trim()),content:text[section],position:"at_depth_as_system",type:ini.readValue(section,"类型")=="蓝灯" ? "constant":"selective",depth:ini.readValue(section,"深度"),exclude_recursion:true,order:Number(ini.readValue(section,"顺序")),enabled:true,});}}Phone_Settings.writeValue("下面是基本设置","世界书版本",version,);entries=await getLorebookEntries(worldbook);triggerSlash("/echo severity=success 手机世界书自动更新成功");triggerSlash("/echo severity=success 点击手机logo可以切换页面");}function System_TagCompletion(content){if(!content){return "";}content=content.replace(/<(?:think|thinking)>[\s\S]+?<\/(?:think|thinking)>/gi,"",);let match=content.match(/moment_end[\s\S]*discord_start/);if(!match&&content.indexOf("moment_end")>0){content=content.replace("moment_end","moment_end\ndiscord_start",);}match=content.match(/MiPhone_start[\s\S]*msg_start/);if(!match&&content.indexOf("msg_start")>0){content=content.replace("msg_start","MiPhone_start\nmsg_start",);}return content;}function System_AddNpcHead(name,url){if(name in Npc_Settings&&Npc_Settings[name].head){return;}if(name==UserName||QQ_CharSettings.getAllSections().includes(name)){return;}if(name in Npc_Settings==false){Npc_Settings[name]={};}if(!url){url=QQ_GetRandomHead();}Npc_Settings[name].head=url;System_UpdateNpcCss();}function System_UpdateNpcCss(){let cssvalue="";for(let key in Npc_Settings){try{if("head" in Npc_Settings[key]==false||!Npc_Settings[key].head){Npc_Settings[key].head=QQ_GetRandomHead();cssvalue+=`\n.head[data-name='${key}']{background-image:url('${Npc_Settings[key].head}')!important;}`;const{bgColor,textColor}=generateBubbleColor();if("bubble" in Npc_Settings[key]==false||!Npc_Settings[key].bubble){Npc_Settings[key].bubble=bgColor;}if("text" in Npc_Settings[key]==false||!Npc_Settings[key].text){Npc_Settings[key].text=textColor;}cssvalue+=`\n.QQ_chat_msgdiv[data-name='${key}']{background-color:${Npc_Settings[key].bubble}!important;span{color:${textColor}!important;}}`;}catch(e){}}insertOrAssignVariables({Npc_Settings:JSON.stringify(Npc_Settings),});}function generateBubbleColor(){const hueSegments=[0,60,120,180,240,300,360];const segmentIndex=Math.floor(Math.random()*6);const H=hueSegments[segmentIndex]+Math.random()*60;const S=30+Math.random()*40;const V=60+Math.random()*30;const bgRgb=hsvToRgb(H,S,V);const bgHex=rgbToHex(...bgRgb);const complementH=(H+180)% 360;const textS=Math.min(S+20,100);const textV=100-V;const textRgb=hsvToRgb(complementH,textS,textV);const textHex=rgbToHex(...textRgb);const bgLum=calculateLuminance(bgRgb);const textLum=calculateLuminance(textRgb);const contrastRatio=(Math.max(bgLum,textLum)+0.05)/(Math.min(bgLum,textLum)+0.05);if(contrastRatio>=4.5){return{bgColor:bgHex,textColor:textHex};}else{const textColor=bgLum>0.5 ? "#000000":"#FFFFFF";return{bgColor:bgHex,textColor};}}function calculateLuminance([r,g,b]){const[R,G,B]=[r,g,b].map((v)=>{v/=255;return v<=0.03928
? v/12.92:Math.pow((v+0.055)/1.055,2.4);});return 0.2126*R+0.7152*G+0.0722*B;}function hsvToRgb(h,s,v){h/=360;s/=100;v/=100;const i=Math.floor(h*6);const f=h*6-i;const p=v*(1-s);const q=v*(1-f*s);const t=v*(1-(1-f)*s);let r,g,b;switch(i % 6){case 0:[r,g,b]=[v,t,p];break;case 1:[r,g,b]=[q,v,p];break;case 2:[r,g,b]=[p,v,t];break;case 3:[r,g,b]=[p,q,v];break;case 4:[r,g,b]=[t,p,v];break;case 5:[r,g,b]=[v,p,q];break;}return[Math.round(r*255),Math.round(g*255),Math.round(b*255),];}function rgbToHex(...rgb){return("#"+rgb.map((x)=>x.toString(16).padStart(2,"0")).join(""));}function Discord_EnterPress(e,element){if(e.key!=="Enter"){return;}if(!element)return;const value=$(element).val();if(!value){return;}const $closest=$(element).closest(".discord-thread");const id=$closest.attr("data-id");const result=`在帖子${id}中回复:\n${value}`;triggerSlash(`/send ${result}|/trigger`);$(element).val("").trigger("input");const commentlist=$closest.find(".discord-thread-comment-list",);const comment=_.template(discord_discord_thread_comment)({name:UserName,content:value,creator:"",isuser:" user_avatar",});commentlist.append(comment);const scroll=$closest.find(".discord-scroll-container");scroll.scrollTop(scroll[0].scrollHeight);}function Discord_Send(event){event.stopPropagation();if(!event.currentTarget)return;const $closest=$(event.currentTarget).closest(".discord-thread",);const value=$closest
.find(".discord-thread-input-userinput").val();const id=$closest.attr("data-id");const result=`在帖子${id}中回复:\n${value}`;triggerSlash(`/send ${result}|/trigger`);$closest
.find(".discord-thread-input-userinput").val("").trigger("input");const commentlist=$closest.find(".discord-thread-comment-list",);const comment=_.template(discord_discord_thread_comment)({name:UserName,content:value,creator:"",isuser:" user_avatar",});commentlist.append(comment);const scroll=$closest.find(".discord-scroll-container");scroll.scrollTop(scroll[0].scrollHeight);}function Discord_Parse(content){const matches=content.matchAll(/<([0-9a-zA-Z]+)>([\s\S+]*?)<\/([0-9a-zA-Z]+)>/g,);if(!matches){return;}for(const match of matches){Discord_AddCard(match[1],match[2]);}}function Discord_AddCard(id,content){if(!id)return;let comment_list;let author="";let map=new Map();let match=content.match(/<正文>([\s\S+]+?)<\/正文>/);if(!match){return;}let matches=match[1].matchAll(/(.+?)[:：]\s*(.+)/g);for(const m of matches){if(m[1].trim()=="帖子总评论数-"){map.set("帖子总评论数",m[2].trim());}else{map.set(m[1].trim(),m[2].trim());}}console.log(`匹配到论坛内容:\n${JSON.stringify(Object.fromEntries(map))}`,);let img=map.get("帖子配图描述")?.match(/\[img-(.+?)\]/);if(img){map.set("帖子配图描述",img[1]);}if(map.get("帖子标签")){let tags=map.get("帖子标签").split("/");let localtag="";for(const tag of tags){localtag+=`<div class="discord-card-tag">${tag}</div>`;}if(localtag){map.set("帖子标签",localtag);}}const html=_.template(discord_discord_card)({id:id,tag:map.get("帖子标签"),time:map.get("距离发帖过去时间"),name:map.get("发帖人"),cardtilte:map.get("帖子标题"),content:map.get("帖子正文"),img:map.get("帖子配图描述"),messages:map.get("帖子总评论数"),likes:map.get("帖子总点赞数"),});$(".discord-cardlist").append(html);$(".discord-cardget").hide();const thread=_.template(discord_discord_thread)({id:id,tag:map.get("帖子标签"),time:map.get("距离发帖过去时间"),name:map.get("发帖人"),threadtilte:map.get("帖子标题"),content:map.get("帖子正文"),img:map.get("帖子配图描述"),messages:map.get("帖子总评论数"),likes:map.get("帖子总点赞数"),isuser:map.get("发帖人").trim()==UserName
? " user_avatar":"",});System_AddNpcHead(map.get("发帖人")?? "未知用户");$(".discord-thread-list").append(thread);comment_list=$(`.discord-thread[data-id=${id}]`).find(".discord-thread-comment-list",);match=content.match(/<评论>([\s\S+]+?)<\/评论>/);if(match){let matches=match[1].matchAll(/^\s*(.+?)--\s*(.+)$/gm);if(matches){for(let m of matches){const comment=_.template(discord_discord_thread_comment,)({name:m[1].trim(),content:AtMessage(m[2]),creator:map.get("发帖人")==m[1]||QQ_CharSettings.getAllSections().includes(m[1],)? " discord-name-creator":"",isuser:m[1].trim()==UserName
? " user_avatar":"",});System_AddNpcHead(m[1]);comment_list.append(comment);}}}}function AtMessage(content){const match=content.match(/(@.{1,8}?)/);if(match){content=content.replace(match[1],`<span style='color:#587ef5'>${match[1]}</span>`,);}return content;}function Discord_AddCard_Old(id,content){let comment_list;let author="";for(const str of content.split(/\r?\n/g)){let match=str.match(/(.+?)--(.+?)--(.+?)--(.+?)--(.+?)--(.+?)--(.+?)--(.+)/,);if(match){const html=_.template(discord_card)({id:id,tag:match[5],time:match[6],name:match[1],cardtilte:match[2],content:match[3],img:match[4],messages:match[7],likes:match[8],});$(".discord-cardlist").append(html);const thread=_.template(discord_thread)({id:id,tag:match[5],time:match[6],name:match[1],threadtilte:match[2],content:match[3],img:match[4],messages:match[7],likes:match[8],});System_AddNpcHead(match[1]);$(".discord-thread-list").append(thread);comment_list=$(`.discord-thread[data-id=${id}]`).find(".discord-thread-comment-list",);author=match[1];continue;}match=str.match(/^(.+?)[:：](.+)$/m);if(match&&comment_list&&comment_list.length>0){const comment=_.template(discord_thread_comment)({name:match[1],content:match[2],creator:author==match[1]? " discord-name-creator":"",isuser:match[1]==UserName ? " user_avatar":"",});System_AddNpcHead(match[1]);comment_list.append(comment);}}}function Discord_LoadThread(event){event.stopPropagation();if(!event.currentTarget)return;const id=$(event.currentTarget).attr("data-id");if(!id){return;}let ThreadPage=$(`.discord-thread[data-id=${id}]`);if(ThreadPage.length===0){return;}$(`.discord-thread`).hide();ThreadPage.show();$(".discord-homepage").hide();$(".discord-thread-list").show();}function Discord_input(event){event.stopPropagation();if(!event.currentTarget)return;if($(event.currentTarget).val()){$(".discord-thread-input-button").hide();$(".discord-thread-input-focus-button").show();}else{$(".discord-thread-input-button").show();$(".discord-thread-input-focus-button").hide();}}async function QQ_MusicPlay(event){event.stopPropagation();if(!event.currentTarget)return;const $element=$(event.currentTarget);const musicname=$element.find(".music-name")?.text().trim();const singer=$element.find(".music-author")?.text().trim();if(!musicname){QQ_Error("获取歌曲信息失败");return;}const $playbutton=$element.find(".icon-music-play");const $stopbutton=$element.find(".icon-music-stop");if(!$playbutton.is(":hidden")){$playbutton.hide();$stopbutton.show();$element.addClass("loading");QQ_Music.lastelement=$element;try{let source=await WY_MusicGetUrl(musicname,singer);if(!source?.url){source=await QQ_MusicGetUrl(musicname);if(!source||!source.url){throw new Error("无可用音源");}}QQ_Music.audio.src=source.url;if(source.cover){$element
.find(".music-img").css("background-image",`url('${source.cover}')`,);$element.find(".music-img").show();}await QQ_Music.audio.play();if(QQ_Music.lastelement&&!QQ_Music.lastelement.is($element)){QQ_Music.lastelement
.find(".icon-music-stop").hide();QQ_Music.lastelement
.find(".icon-music-play").show();}}catch(error){console.error("播放失败:",error);QQ_Error("播放失败");$playbutton.show();$stopbutton.hide();}finally{$element.removeClass("loading");}}else{QQ_Music.audio.pause();$playbutton.show();$stopbutton.hide();}}async function QQ_MusicGetUrl(name){try{name=name.replace(/\s/g,"");let cover="";const result=await Http_Get(`https:);if(!result?.data?.length){QQ_Error("搜索歌曲失败");return;}let ids=[];for(const data of result.data){if(!cover&&data.cover){cover=data.cover;}if(data.id){ids.push(data.id);}if(data.grp){for(const grp of data.grp){if(grp.id){ids.push(grp.id);}}}}for(const id of ids){try{const r=await Http_Get(`https:);if(!r?.data?.url)continue;const isAvailable=await checkAudioAvailability(r.data.url,);if(isAvailable){return{url:r.data.url,cover:cover,};}}catch(e){console.warn(`音源检测失败:${id}`,e);}}QQ_Error("没有找到可用音源");}catch(e){QQ_Error("歌曲搜索异常");console.error("获取音源失败:",e);}}async function WY_MusicGetUrl(name,singer){let url=`https:if(singer){url+=`-${singer}`;}let result=await Http_Get(url);if(!result)return;let cover="";let ids=[];for(const data of result.data){if(!cover&&data.cover){cover=data.cover;}if(data.id){ids.push(data.id);}}for(const id of ids){try{const r=await Http_Get(`https:);if(!r?.data?.url)continue;const isAvailable=await checkAudioAvailability(r.data.url,);if(isAvailable){return{url:r.data.url,cover:cover,};}}catch(e){console.warn(`音源检测失败:${id}`,e);}}}async function checkAudioAvailability(url){return new Promise((resolve)=>{const tester=new Audio();let timer;const onLoaded=()=>{cleanup();resolve(true);};const onError=()=>{cleanup();resolve(false);};const cleanup=()=>{tester.removeEventListener("loadedmetadata",onLoaded);tester.removeEventListener("error",onError);clearTimeout(timer);tester.src="";};tester.preload="metadata";tester.src=url;timer=setTimeout(onError,3000);tester.addEventListener("loadedmetadata",onLoaded);tester.addEventListener("error",onError);});}function Http_Get(url){return new Promise((resolve,reject)=>{$.ajax({url:url,method:"GET",timeout:10000,success:function(data,status){resolve(data);},error:function(xhr,status,error){if(status==="timeout"){console.error("请求超时，请检查网络或重试");}else{console.error("请求失败，错误信息：",error);}resolve(null);},});});}function JsonYamlParse(content){content=content.replace(/\{\{user\}\}/g,UserName);try{let json=JSON.parse(content);return json;}catch{}try{let simple=Simpleformat(content);if(simple){return simple;}else{}}catch{}try{let yaml=YAML.parse(content);return yaml;}catch{try{content=content.replace(/^\s*群聊:/m,"群聊:");content=content.replace(/^\s*私聊:/m,"私聊:");content=fixYamlSingleQuotes(content);return null;}let yaml=YAML.parse(content);return yaml;}catch{}try{content=fixYamlSingleQuotes(content.replace(/\\'/g,"''"),);return null;}let yaml=YAML.parse(content);return yaml;}catch{}try{content=content.replace(/,/g,"\r\n-");content=content.replace(/\['/g,"\r\n-'");content=content.replace(/'\]/g,"'");content=fixYamlSingleQuotes(content);return null;}let yaml=YAML.parse(content);return yaml;}catch{return null;}}function Simpleformat(content){let json={私聊:{},群聊:{},};let matches=content.matchAll(/<(.+?)和(.+?)的私聊>([\s\S]+?)<\/(.+?)和(.+?)的私聊>/g,);if(matches){for(const match of matches){if(match[1]!=match[4]||match[2]!=match[5]){QQ_Error("私聊标签闭合异常,请手动修复");}const key=`${match[1]}和${match[2]}的聊天`;json.私聊[key]=[];for(let line of match[3].split(/\r?\n/)){line=line.trim();if(line){let m=line.match(/(.+?)\s*(?:--|:|：)\s*(.+)/,);if(!m){continue;}let message=m[2];if(message.split("--").length>=2){message=message.split("--")[0];}json.私聊[key].push(`${m[1]}--${m[2]}`);}}}}matches=content.matchAll(/<群聊[:：](.+?)>([\s\S]+?)<\/群聊[:：](.+?)>/g,);if(matches){for(const match of matches){if(match[1]!=match[3]){QQ_Error("群聊标签闭合异常,请手动修复");}json.群聊[match[1]]={};json.群聊[match[1]].members=[];json.群聊[match[1]].msgs=[];let m=match[2].match(/<成员>([\S\s]+?)<\/成员>/);if(m){let members=m[1].split(",").map((item)=>item.trim());json.群聊[match[1]].members=members;}m=match[2].match(/<聊天内容>([\S\s]+?)<\/聊天内容>/);if(m){for(let message of m[1].split(/\r?\n/)){message=message.trim();if(message){let regex=message.match(/(.+?)\s*(?:--|:|：)\s*(.+)/,);if(!regex){continue;}let content=regex[2];if(content.split("--").length>=2){content=content.split("--")[0];}json.群聊[match[1]].msgs.push(`${regex[1]}--${regex[2]}`,);}}}}}console.log(`简单格式转换:${JSON.stringify(json)}`);return json;}function fixYamlSingleQuotes(yamlText){try{return yamlText.replace(/(-')(.*?[^\\])(')(?=\s*#|$)/gm,(match,prefix,content,suffix)=>{const escaped=content
.replace(/''/g,"\uE000").replace(/'/g,"''").replace(/\uE000/g,"''");return `${prefix}${escaped}${suffix}`;},);}catch(e){QQ_Error(`${e}`);return "";}}async function MiPhone_Merge(){let messages=await ST.GetCurrentMessages();messages=messages.replace(/<(?:think|thinking)>[\s\S]+?<\/(?:think|thinking)>/gi,"",);const matches=messages.matchAll(/MiPhone_start([\s\S]+?)MiPhone_end/g,);if(!matches){return;}const matchesArray=[...matches];const length=matchesArray.length;if(length<=1){return;}for(let i=0;i<matchesArray.length;i++){const value=matchesArray[i][0];const msg=value.match(/msg_start([\s\S]+?)msg_end/);if(msg){let json;try{json=JsonYamlParse(msg[1]);if(json){json=QQ_Msg_DeletOld(json);await QQ_Msg_Parse(JSON.stringify(json));}}catch{}}if(i!=matchesArray.length-1){messages=messages.replace(value,"");}else{if(msg){const lovalvalue=value.replace(msg[0],`msg_start\n${QQ_Json2Text(QQ_msgjson)}\nmsg_end`,);messages=messages.replace(value,lovalvalue);}else{messages=messages.replace("MiPhone_start",`msg_start\n${QQ_Json2Text(QQ_msgjson)}\nmsg_end`,);}}}triggerSlash("/echo 存在多个格式,自动合并");triggerSlash("/echo 合并只会保留聊天内容,动态和论坛会丢失!!!!!",);const CurrentMessageId=await getCurrentMessageId();setChatMessage({message:messages},CurrentMessageId);}async function QQ_Load_Moments(){if(!worldbook||!entries){return;}try{const momentEntry=entries.find(entry=>entry.comment==="手机-动态内容存储");if(momentEntry&&momentEntry.content){const savedMoments=JSON.parse(momentEntry.content);QQ_MomentsData=savedMoments.map(moment=>{if(!moment.likes){moment.likes={count:parseInt(moment.extraContent)||0,userLiked:false,likedBy:[],lastLikeTime:null};}return moment;});window.QQ_MomentsData=QQ_MomentsData;await QQ_Render_Moments();}else{}}catch(error){console.error('加载动态内容失败:',error);}}async function QQ_Load_Chat_Backup(){if(!worldbook||!entries){return false;}try{const chatBackupEntry=entries.find(entry=>entry.comment==="手机-聊天消息备份");if(chatBackupEntry&&chatBackupEntry.content){const backupData=JSON.parse(chatBackupEntry.content);if(backupData.data&&(backupData.data.私聊||backupData.data.群聊)){const originalPrivateChats=QQ_msgjson?.私聊 ? Object.keys(QQ_msgjson.私聊).length:0;const originalGroupChats=QQ_msgjson?.群聊 ? Object.keys(QQ_msgjson.群聊).length:0;QQ_msgjson=JSON.parse(JSON.stringify(backupData.data));QQ_ChatBackup=backupData;window.QQ_msgjson=QQ_msgjson;window.QQ_ChatBackup=QQ_ChatBackup;window.QQ_ChatDataRestored=true;window.QQ_ChatDataRestoreTime=new Date().toISOString();console.log(`📊 聊天数据恢复对比:私聊 ${originalPrivateChats}→ ${Object.keys(QQ_msgjson.私聊||{}).length},群聊 ${originalGroupChats}→ ${Object.keys(QQ_msgjson.群聊||{}).length}`);if(QQ_msgjson.群聊){const groupNames=Object.keys(QQ_msgjson.群聊);QQ_Groups=[...groupNames];window.QQ_Groups=QQ_Groups;if(!window.QQ_GroupInitializedSet){window.QQ_GroupInitializedSet=new Set();}for(const groupName of groupNames){const groupData=QQ_msgjson.群聊[groupName];if(groupData){if(groupData.msgs&&groupData.msgs.length>0){window.QQ_GroupInitializedSet.add(groupName);}const defaultAvatar='https:const members=groupData.members||[];const existingGroupElement=$(`.QQ_home_usermsg[data-name='${groupName}'][data-group-type='true']`);if(existingGroupElement.length===0){AddNewGroup(groupName,defaultAvatar,members,'');}else{window.QQ_GroupInitializedSet.add(groupName);}}}}console.log('✅ 成功恢复聊天备份数据:',Object.keys(QQ_msgjson.私聊||{}).length,'个私聊,',Object.keys(QQ_msgjson.群聊||{}).length,'个群聊');try{if(QQ_msgjson&&QQ_msgjson.私聊){const allCharacters=new Set();Object.keys(QQ_msgjson.私聊).forEach(chatKey=>{const matches=chatKey.match(/^(.+)和(.+)的聊天$/);if(matches){const[,char1,char2]=matches;if(char1!==UserName)allCharacters.add(char1);if(char2!==UserName)allCharacters.add(char2);}});allCharacters.forEach(characterName=>{updatePrivateChatLastMessageDisplay(characterName);});}await QQ_UpdateMessageList();}catch(error){console.error('更新消息列表显示失败:',error);}return true;}else{return false;}}else{return false;}}catch(error){console.error('加载聊天备份时发生严重错误:',error);return false;}}async function QQ_Render_Moments(loadMore=false){const $spaceContents=$("#space_contents");if(QQ_MomentsData.length===0){momentsDisplayCount=0;return;}if(!loadMore){$spaceContents.empty();momentsDisplayCount=0;}const sortedMoments=[...QQ_MomentsData].sort((a,b)=>{return new Date(b.timestamp).getTime()-new Date(a.timestamp).getTime();});const startIndex=momentsDisplayCount;const endIndex=Math.min(startIndex+(loadMore ? MOMENTS_LOAD_INCREMENT:MOMENTS_DISPLAY_LIMIT),sortedMoments.length);const momentsToShow=sortedMoments.slice(startIndex,endIndex);for(const momentData of momentsToShow){try{const momentDiv=$("<div>",{class:"user_moment","data-moment-id":momentData.id});momentDiv.html(_.template(moment_page)({userName:momentData.userName,message:momentData.message,timestamp:momentData.timestampText,additionalInfo:momentData.additionalInfo,randomPhone:momentData.randomPhone,extraContent:momentData.likes ? momentData.likes.count:0,imgcontent:momentData.imgcontent||'',momentId:momentData.id,likeCount:momentData.likes ? momentData.likes.count:0,likedByUser:momentData.likes ? momentData.likes.userLiked:false}));const commentsList=momentDiv.find(".user_leave_message_list");QQ_Render_Comments(momentData,commentsList);$spaceContents.append(momentDiv);}catch(error){console.error('渲染动态失败:',error,momentData);}}momentsDisplayCount=endIndex;QQ_Update_Moments_LoadMore(sortedMoments.length);if(typeof QQ_InitMomentLikes==='function'){QQ_InitMomentLikes();setTimeout(()=>{if(typeof QQ_ForceLikeButtonBinding==='function'){QQ_ForceLikeButtonBinding();}if(typeof QQ_DiagnoseLikeButtons==='function'){QQ_DiagnoseLikeButtons();}},200);}if(typeof QQ_LoadMomentLikes==='function'){await QQ_LoadMomentLikes();}}function QQ_Update_Moments_LoadMore(totalMoments){const $spaceContents=$("#space_contents");const loadMoreId='moments-load-more';$(`#${loadMoreId}`).remove();if(momentsDisplayCount<totalMoments){const loadMoreBtn=$(`<div id="${loadMoreId}" style="text-align:center;padding:20px 0;color:#999;font-size:12px;cursor:pointer;border-top:1px solid #e5e5e5;margin-top:10px;">--点击查看更多--</div>`);loadMoreBtn.on('click',async function(){$(this).text('加载中...');try{await QQ_Render_Moments(true);}catch(error){console.error('加载更多动态失败:',error);$(this).text('加载失败，点击重试');}});$spaceContents.append(loadMoreBtn);}}async function QQ_Load_Chat_History(chatName,msgContainer){const isGroup=QQ_Groups.includes(chatName);let allMessages=[];if(isGroup&&QQ_msgjson.群聊[chatName]&&QQ_msgjson.群聊[chatName].msgs){allMessages=[...QQ_msgjson.群聊[chatName].msgs];}else if(!isGroup&&QQ_msgjson.私聊[`${UserName}和${chatName}的聊天`]){allMessages=[...QQ_msgjson.私聊[`${UserName}和${chatName}的聊天`]];}const currentDisplayed=chatDisplayCounts[chatName]||0;const totalMessages=allMessages.length;if(currentDisplayed>=totalMessages){return false;}const loadCount=Math.min(CHAT_LOAD_INCREMENT,totalMessages-currentDisplayed);const startIndex=Math.max(0,totalMessages-currentDisplayed-loadCount);const endIndex=totalMessages-currentDisplayed;const messagesToLoad=allMessages.slice(startIndex,endIndex);const $firstMsg=$(msgContainer).children().not('.load-more-messages').first();for(let i=messagesToLoad.length-1;i>=0;i--){const msg=messagesToLoad[i];const tempDiv=$('<div>');QQ_Chat_AddMsg(tempDiv[0],msg,chatName,false,true);if($firstMsg.length>0){$firstMsg.before(tempDiv.html());}else{$(msgContainer).prepend(tempDiv.html());}}chatDisplayCounts[chatName]=(chatDisplayCounts[chatName]||0)+loadCount;return chatDisplayCounts[chatName]<totalMessages;}function QQ_Update_Chat_LoadMore(chatName,msgContainer){const $container=$(msgContainer);const loadMoreId=`chat-load-more-${chatName.replace(/[^a-zA-Z0-9]/g,'_')}`;$(`.load-more-messages`).remove();const isGroup=QQ_Groups.includes(chatName);let totalMessages=0;if(isGroup&&QQ_msgjson.群聊[chatName]&&QQ_msgjson.群聊[chatName].msgs){totalMessages=QQ_msgjson.群聊[chatName].msgs.length;}else if(!isGroup&&QQ_msgjson.私聊[`${UserName}和${chatName}的聊天`]){totalMessages=QQ_msgjson.私聊[`${UserName}和${chatName}的聊天`].length;}const currentDisplayed=chatDisplayCounts[chatName]||0;if(totalMessages>CHAT_DISPLAY_LIMIT&&currentDisplayed<totalMessages){const loadMoreBtn=$(`<div id="${loadMoreId}" class="load-more-messages" style="text-align:center;padding:15px 0;color:#999;font-size:12px;cursor:pointer;border-bottom:1px solid #e5e5e5;margin-bottom:10px;background-color:#f9f9f9;">--点击加载更多--</div>`);loadMoreBtn.on('click',async function(){$(this).text('加载中...');try{const hasMore=await QQ_Load_Chat_History(chatName,msgContainer);if(!hasMore){$(this).text('没有更多消息了').css('color','#ccc').off('click');setTimeout(()=>$(this).fadeOut(),2000);}else{$(this).text('--点击加载更多--');}}catch(error){console.error('加载更多聊天消息失败:',error);$(this).text('加载失败，点击重试');}});$container.prepend(loadMoreBtn);}}function space_init(){$("#space_contents").prepend(space_contents);setTimeout(()=>{QQ_Load_Moments();},500);}async function GetWorldBookName(){let localbook;try{localbook=await getCurrentCharPrimaryLorebook();console.log(`角色卡绑定主要世界书`,JSON.stringify(localbook),);}catch(e){}if(localbook){const localentrys=await getLorebookEntries(localbook);const targetEntry=localentrys.find((entry)=>["手机-界面基本设置","手机界面基本设置"].includes(entry.comment,),);if(targetEntry){return localbook;}}const globalbook=(await getLorebookSettings()).selected_global_lorebooks;if(globalbook){for(const book of globalbook){const localentrys=await getLorebookEntries(book);const targetEntry=localentrys.find((entry)=>["手机-界面基本设置","手机界面基本设置"].includes(entry.comment,),);if(targetEntry){return book;}}}if(localbook){return localbook;}return null;}async function DelPadding(){const message_id=await getCurrentMessageId();$(`div.mes[mesid="${message_id}"]`,window.parent.document).find(`div.mes_text`).css("padding-right","0");$(`div.mes[mesid="${message_id}"]`,window.parent.document).find(`div.avatar`).css("display","none");$(`div.mes[mesid="${message_id}"]`,window.parent.document).find(`div.mesAvatarWrapper`).css("display","none");}async function GetSettings(){console.log(`测试获取ini:${Phone_Settings.readValue("下面是基本设置","聊天壁纸")}`,);if(Phone_Settings.readValue("下面是基本设置","内框颜色")){let value=Phone_Settings.readValue("下面是基本设置","内框颜色",);if(value[0]!="#"){value+="#";}$("<style>").text(`.card{background-color:${value}!important}`,).appendTo("head");$("<style>").text(`.top{background-color:${value}!important}`).appendTo("head")}let value=Phone_Settings.readValue("下面是基本设置","外框颜色",);if(value){if(value[0]!="#"){value+="#"}$("<style>").text(`.card{border:2px solid ${value}!important}`,).appendTo("head")}value=Phone_Settings.readValue("下面是基本设置","侧边按钮");if(value){if(value[0]!="#"){value+="#"}$("<style>").text(`.btn1{background-color:${value}!important}`,).appendTo("head");$("<style>").text(`.btn2{background-color:${value}!important}`,).appendTo("head");$("<style>").text(`.btn3{background-color:${value}!important}`,).appendTo("head")}value=Phone_Settings.readValue("下面是基本设置","发送模式");if(value){if(value=="2"){newgen=false}else{newgen=true}}else{Phone_Settings.writeValue("下面是基本设置","发送模式","1",)}value=Phone_Settings.readValue("下面是基本设置","聊天壁纸");if(value){$("<style>").text(`.QQ_chat_page{background-image:url("${value}")}`,).appendTo("head")}value=Phone_Settings.readValue("下面是基本设置","气泡颜色");if(value){if(value[0]!="#"){value+="#"}.text(`.QQ_chat_msgdiv{background-color:${value}!important}`,).appendTo("head")}Phone_Settings.writeValue("下面是基本设置","世界书版本",version,);for(let entry of entries){if(entry.comment=="手机-界面基本设置"||entry.comment=="手机界面基本设置"){await setLorebookEntries(worldbook,[{uid:entry.uid,content:Phone_Settings.getAllText(),},])}}entries=await getLorebookEntries(worldbook)}function GetChatCharSettingByName(name){let char_setting="";for(let entry of entries){if(entry.comment=="配置-聊天-角色个人设定"){char_setting=entry.content.trim()}}if(!char_setting){return}const char_setting_json=JSON.parse(char_setting);const setting=char_setting_json.find((item)=>item.name===name,);if(!setting){return}console.log(`获取到角色设定:${YAML.stringify(setting)}`);return setting}async function Verify(){try{let version=await getFrontendVersion();const versionParts=version.split(".").map(Number);if(versionParts.length<3||versionParts.some(isNaN)){throw new Error("Invalid version format")}const[major,minor,patch]=versionParts;const MIN_MAJOR=2;const MIN_MINOR=4;const MIN_PATCH=3;if(major<MIN_MAJOR||(major===MIN_MAJOR&&(minor<MIN_MINOR||(minor===MIN_MINOR&&patch<MIN_PATCH)))){alert(`前端助手版本过低(当前 ${versionParts.join(".")}，需要至少 ${MIN_MAJOR}.${MIN_MINOR}.${MIN_PATCH})，请更新`,)}}catch(error){assertIsError(error);console.error("版本验证失败:",error);if(typeof QQ_Error==="function"){QQ_Error(`验证前端助手版本失败:${error.message}`)}else{alert("版本验证失败，请检查控制台信息")}}}function assertIsError(error){if(!(error instanceof Error)){throw new TypeError()}}function random(min,max){return Math.floor(Math.random()*(max-min)+min)}function head_init(){let girl=`EJeUD/Image_1737026320652.jpg|Y8pt1/Image_1737026296736.jpg|QWWc6/Image_1737026308451.jpg|Z8LIW/Image_1737026306601.jpg|W8lhW/Image_1737026313246.jpg|0rJtX/Image_1737026292787.jpg|yVxsN/Image_1737026293840.jpg|vaBCL/Image_1737026286979.jpg|pZ6hQ/Image_1737026285632.jpg|11AH2/Image_1737026284351.jpg|eXKUw/Image_1737026281715.jpg|o31F4/Image_1737026277201.jpg|8E2uj/Image_1737026279242.jpg|GLmIl/Image_1737026275069.jpg|zWZT5/Image_1737026271769.jpg|7Zrij/Image_1737026269532.jpg|AqYsZ/Image_1737026266131.jpg|w4lFq/2406563368.jpeg|MQNua/2403629154.jpeg|3YZhe/2405854911.jpeg|5QKhj/2312445144.jpeg|k6JT6/2408434848.jpeg|j6Bf6/2386328773.jpeg|a8LHY/2386327598.jpeg|r08C6/2386327604.jpeg|DgECK/2331678725.jpeg|LJrC7/2371251634.jpeg|q1LF3/2329660869.gif|X84sW/2328035526.jpeg|2eDfQ/2326662447.jpeg|ggetw/2326683821.jpeg|J21ig/2323432137.gif`;let girls=girl.split("|");let result="";for(let i=0;i<girls.length;i++){if(girls[i]){random_head_list.push(girls[i]);result+=`\nhttp:}}}QQ_Music.audio.addEventListener("ended",()=>{if(QQ_Music.lastelement){QQ_Music.lastelement.find(".icon-music-stop").hide();QQ_Music.lastelement.find(".icon-music-play").show()}});QQ_Music.audio.addEventListener("error",()=>{if(QQ_Music.lastelement){QQ_Music.lastelement.find(".icon-music-stop").hide();QQ_Music.lastelement.find(".icon-music-play").show()}QQ_Error("播放出错，请尝试重新播放")});QQ_Music.audio.addEventListener("pause",()=>{if(QQ_Music.lastelement){QQ_Music.lastelement.find(".icon-music-stop").hide();QQ_Music.lastelement.find(".icon-music-play").show()}});async function LoadRandomHead(){let content="";for(let entry of entries){if(entry.comment=="手机-随机头像"){content=entry.content}}if(!content){return}const matches=content.matchAll(/^http.+$/gm);for(const match of matches){const obj={url:match[0],count:[...NpcCssValue.matchAll(new RegExp(match[0],"g")),].length,};QQ_RandomHead.push(obj)}}function GetWorldEntry(name,search){let list=[];if(!entries){console.warn('GetWorldEntry:entries未初始化，返回null');return null}entries.forEach((item)=>{if(search){name.forEach((n)=>{if(item.comment.indexOf(n)>-1){list.push(item)}})}else if(name.includes(item.comment)){list.push(item)}});if(list.length==0){return null}else if(list.length==1){return list[0]}for(let entry of list){if(entry.enabled){return entry}}return list[0]}async function LoadEmoji(){let content="";let phonebook="";let phoneuid=-1;if(!entries){console.warn('LoadEmoji:entries未初始化，跳过表情包加载');return}for(let entry of entries){if(entry.comment=="手机-表情包存放"||entry.comment=="表情包存放世界书"){content=entry.content}else if(entry.comment=="手机-格式2-QQ聊天"){phonebook=entry.content;phoneuid=entry.uid}}if(!content){return}if(phoneuid==-1){return}content=content.replace(/http:\/\/sharkpan/g,"https:);content=content.replace(/--\n/g,"--");const regex=new RegExp("(.+?)--(http.+)","g");const matches=[...content.matchAll(regex)];if(!matches){return}for(const match of matches){QQ_emoji.set(match[1],match[2])}const keysArray=JSON.stringify(Array.from(QQ_emoji.keys()));const m=phonebook.match(/<表情包列表>([\s\S]*?)<\/表情包列表>/,);if(m){phonebook=phonebook.replace(m[0],`<表情包列表>\n${keysArray}\n<\/表情包列表>`,);await setLorebookEntries(worldbook,[{uid:phoneuid,content:phonebook},])}}async function LoadChars(){if(entries){console.log('所有世界书条目:',entries.map(e=>({comment:e.comment,enabled:e.enabled,hasContent:!!e.content})))}checkWorldbookGroups();let content;let entry=GetWorldEntry(["手机-角色","手机界面-角色"],true);if(!entry||!entry.content){for(let e of entries||[]){if(e.comment==="手机-角色"||e.comment==="手机界面-角色"){entry=e;break}}}if(!entry||!entry.content){console.error('仍然未找到手机-角色世界书条目或内容为空');console.error('当前entry:',entry);return}content=entry.content;QQ_CharSettings.loadText(content);console.log(`GetAllText:\n${QQ_CharSettings.getAllText()}`);const allSections=QQ_CharSettings.getAllSections();for(let section of allSections){const hasGetCharAvatar=typeof getCharAvatarPath==="function";const type=QQ_CharSettings.readValue(section,"类型");if(section=="char"){section=getFilenameWithoutExtension(charAvatarPath)}let headurl=QQ_CharSettings.readValue(section,"头像");if(!headurl){if(hasGetCharAvatar){headurl=await getCharAvatarPath(section)}else{QQ_Error(`自动获取头像要求前端助手版本在2.4.4及以上版本`,);continue}}else{const match=headurl.match(/[<{]+(.+?)[>}]/);if(match){if(hasGetCharAvatar){headurl=await getCharAvatarPath(match[1])}else{QQ_Error(`自动获取头像要求前端助手版本在2.4.4及以上版本`,);continue}}}if(!type.match(/npc/i)&&type!="路人"&&type!="群聊"){AddNewChar(section,headurl);QQ_msgjson.私聊[`${UserName}和${section}的聊天`]=[]}else{}let CssValue=new Map();let divkey=`.QQ_chat_msgdiv[data-name='${section}']`;let MsgColor=QQ_CharSettings.readValue(section,"气泡颜色",);if(MsgColor){MsgColor=MsgColor[0]=="#" ? MsgColor:`#${MsgColor}`;CssValue.set(divkey,`--MsgColor:${MsgColor};background-color:var(--MsgColor)!important;`,)}let TextColor=QQ_CharSettings.readValue(section,"字体颜色",);if(TextColor){TextColor=TextColor[0]=="#" ? TextColor:`#${TextColor}`;if(CssValue.has(divkey)){CssValue.set(divkey,CssValue.get(divkey)+`--TextColor:${TextColor};`,)}CssValue.set(`.QQ_chat_msgdiv[data-name='${section}']span`,`color:var(--TextColor)!important;`,)}let BackGroundImg=QQ_CharSettings.readValue(section,"聊天壁纸",);if(BackGroundImg){CssValue.set(`.QQ_chat_page[data-name='${section}']`,`--BackGroundImg:url('${BackGroundImg}');background-image:var(--BackGroundImg)!important;`,)}if(headurl){CssValue.set(`.head[data-name=${section}]`,`background-image:url('${headurl}')`,)}if(CssValue){let value="";for(const key of CssValue.keys()){value+=`\n${key}{${CssValue.get(key)}}`}if(value){$(`<style>`).attr("data-name",section).text(value).appendTo("head")}}const style=$("<style></style>").prop("type","text/css");const cssRule=chat_headraw_namespaceObject
.replace(/\$\{name\}/g,UserName).replace(/\$\{head\}/g,userAvatarPath);style.text(cssRule);$("head").append(style);}function getRandomChatBackground(){try{const entry=GetWorldEntry(["手机-角色","手机界面-角色"],true);if(!entry||!entry.content){return 'http:}const settings=new QQ_Settings();settings.loadText(entry.content);const allSections=settings.getAllSections();const availableBackgrounds=[];for(const section of allSections){const type=settings.readValue(section,"类型");const backgroundImg=settings.readValue(section,"聊天壁纸");if(!type||(type.trim()!=='群聊'&&type.trim()!=='路人'&&!type.match(/npc/i))){if(backgroundImg&&backgroundImg.trim()){availableBackgrounds.push({character:section,url:backgroundImg.trim()});console.log(`收集到角色 ${section}的聊天壁纸:${backgroundImg.trim()}`);}}}if(availableBackgrounds.length>0){const randomChoice=availableBackgrounds[Math.floor(Math.random()*availableBackgrounds.length)];return randomChoice.url;}}catch(error){console.error('随机选择聊天壁纸时出错:',error);}return 'http:}function SetCssVariable(name,variable,value){let cssvalue=$(`style[data-name='${name}']`).text();if(!cssvalue){return;}const match=cssvalue.match(new RegExp(`--${variable}\s*:\s*(.+?);`),);if(!match){return;}cssvalue=cssvalue
.replace(`${match[0]}`,`${match[0].replace(match[1],value)}`,).trim();$(`style[data-name='${name}']`).text(cssvalue);}function AddNewChar(name,head){let html=_.template(chat_list_item)({name:name,head:head.trim(),});$("#QQ_home_chars").append(html);QQ_pages.push(name);const style=$("<style></style>").prop("type","text/css");const cssRule=chat_headraw_namespaceObject
.replace(/\$\{name\}/g,name).replace(/\$\{head\}/g,head);style.text(cssRule);$("head").append(style);setTimeout(()=>{QQ_UpdateMessageList();},100);}function AddNewGroup(name,head,members,description){if(QQ_GroupInitializedSet.has(name)&&QQ_msgjson.群聊[name]&&QQ_msgjson.群聊[name].msgs.length>0){const existingElements=$(`.QQ_home_usermsg[data-name='${name}'][data-group-type='true']`);if(existingElements.length>0){return;}else{}}const existingElements=$(`.QQ_home_usermsg[data-name='${name}'][data-group-type='true']`);if(existingElements.length>0){existingElements.remove();}let headStr='';if(typeof head==='string'){headStr=head.trim();}else if(head&&typeof head==='object'){if(head.type==='upload'&&head.imageData){headStr=head.imageData;}else if(head.type==='preset'&&head.text){headStr=head.text;}else if(head.type==='url'&&head.url){headStr=head.url;}else{headStr='https:}}else{headStr=head||'https:}let html=_.template(chat_list_item)({name:name,head:headStr});const $html=$(html);$html.attr('data-group-type','true').attr('data-group-name',name).attr('draggable','true');const memberCount=members ? members.length:0;$html.find('.QQ_home_lastmsg').text('群聊');$html.find('.QQ_home_lasttime').text(`${memberCount}人`);$html.on('click',function(){QQ_ChangeChatPage(null,name);});const $contactsContainer=$("#QQ_home_chars");let $ungroupedSection=$contactsContainer.find('.ungrouped-contacts');if($ungroupedSection.length===0){$ungroupedSection=$(`<div class="ungrouped-contacts"><div class="ungrouped-header">未分组联系人</div><div class="drop-zone ungrouped-drop-zone" data-group-id="ungrouped"></div></div>`);$contactsContainer.prepend($ungroupedSection);}$ungroupedSection.append($html);QQ_pages.push(name);if(!QQ_Groups.includes(name)){QQ_Groups.push(name);}if(!QQ_msgjson.群聊[name]){QQ_msgjson.群聊[name]={msgs:[],members:[]};}QQ_msgjson.群聊[name].members=members||[];const randomBackground=getRandomChatBackground();let cssRule=chat_headraw_namespaceObject.replace(/\$\{name\}/g,name).replace(/\$\{head\}/g,headStr);if(randomBackground){const backgroundCSS=`
.QQ_chat_page[data-name='${name}']{--BackGroundImg:url('${randomBackground}');background-image:var(--BackGroundImg)!important;}`;cssRule+=backgroundCSS;}const style=$("<style></style>").prop("type","text/css");style.text(cssRule);$("head").append(style);addGroupWelcomeMessages(name,members);setTimeout(()=>{updateGroupLastMessageDisplay(name);QQ_UpdateMessageList();},100);}function addGroupWelcomeMessages(groupName,members){if(QQ_GroupInitializedSet.has(groupName)){return;}if(!QQ_msgjson.群聊[groupName]){QQ_msgjson.群聊[groupName]={msgs:[],members:members||[]};}const groupData=QQ_msgjson.群聊[groupName];const hasInitialMessages=groupData.msgs.some(msg=>{if(!msg.startsWith('系统消息--'))return false;const parts=msg.split('--');if(parts.length<3)return false;const content=parts[2];return content.includes('创建成功')||content.includes('加入了群聊')||content.includes('开始聊天吧')||/^\d{2}:\d{2}$/.test(content);});if(hasInitialMessages){console.log(`现有消息列表:`,groupData.msgs.slice(0,5));QQ_GroupInitializedSet.add(groupName);return;}if(groupData.msgs.length>0){}const currentTime=new Date().toLocaleTimeString('zh-CN',{hour12:false,hour:'2-digit',minute:'2-digit'});const systemMsg=`系统消息--${currentTime}--群聊"${groupName}"创建成功，开始聊天吧！`;groupData.msgs.push(systemMsg);if(members&&members.length>0){members.forEach(member=>{const joinMsg=`系统消息--${currentTime}--${member}加入了群聊`;groupData.msgs.push(joinMsg);});}const timeMsg=`系统消息--${currentTime}--${currentTime}`;groupData.msgs.push(timeMsg);updateGroupLastMessageDisplay(groupName);QQ_GroupInitializedSet.add(groupName);}function updateGroupLastMessageDisplay(groupName){const groupData=QQ_msgjson.群聊[groupName];if(!groupData||!groupData.msgs||groupData.msgs.length===0){return;}const lastMsgRaw=groupData.msgs[groupData.msgs.length-1];const msgParts=lastMsgRaw.split('--');if(msgParts.length>=3){const sender=msgParts[0];const content=msgParts[1];const time=msgParts[2]||'';let displayMsg=content;let displayTime=time;if(sender==='系统消息'){displayMsg=content;}else{displayMsg=`${sender}:${content}`;}if(displayMsg.length>20){displayMsg=displayMsg.substring(0,20)+'...';}$(`.QQ_home_usermsg[data-name='${groupName}'].QQ_home_lastmsg`).text(displayMsg);$(`.QQ_home_usermsg[data-name='${groupName}'].QQ_home_lasttime`).text(displayTime);console.log(`群聊 ${groupName}最后消息已更新:${displayMsg}(${displayTime})`);}}function formatDisplayTime(timeStr){if(!timeStr||timeStr.trim()===''){return '';}try{const date=new Date(timeStr);const now=new Date();const diffMs=now-date;const diffMins=Math.floor(diffMs/60000);const diffHours=Math.floor(diffMins/60);const diffDays=Math.floor(diffHours/24);if(diffMins<1){return '刚刚';}else if(diffMins<60){return `${diffMins}分钟前`;}else if(diffHours<24){return `${diffHours}小时前`;}else if(diffDays<7){return `${diffDays}天前`;}else{return date.toLocaleDateString('zh-CN',{month:'short',day:'numeric'});}}catch(error){console.warn('时间格式化失败:',timeStr,error);if(timeStr.includes(':')){const timePart=timeStr.split(' ').find(part=>part.includes(':'));return timePart||timeStr;}return timeStr;}}function updatePrivateChatLastMessageDisplay(characterName){if(!QQ_msgjson||!QQ_msgjson.私聊){return;}const privateChatKey1=`${UserName}和${characterName}的聊天`;const privateChatKey2=`${characterName}和${UserName}的聊天`;let msgs=null;let activeKey=null;if(QQ_msgjson.私聊[privateChatKey1]&&QQ_msgjson.私聊[privateChatKey1].length>0){msgs=QQ_msgjson.私聊[privateChatKey1];activeKey=privateChatKey1;}else if(QQ_msgjson.私聊[privateChatKey2]&&QQ_msgjson.私聊[privateChatKey2].length>0){msgs=QQ_msgjson.私聊[privateChatKey2];activeKey=privateChatKey2;}if(!msgs||msgs.length===0){$(`.QQ_home_usermsg[data-name='${characterName}'][data-group-type!='true'].QQ_home_lastmsg`).text('...');return;}const lastMsg=msgs[msgs.length-1];const parts=lastMsg.split('--');if(parts.length>=3){const sender=parts[0];let displayMsg=parts[1];const timeStr=parts[2];if(sender===UserName){displayMsg=`我:${displayMsg}`;}else{displayMsg=`${sender}:${displayMsg}`;}if(displayMsg.length>20){displayMsg=displayMsg.substring(0,20)+'...';}const displayTime=formatDisplayTime(timeStr);$(`.QQ_home_usermsg[data-name='${characterName}'][data-group-type!='true'].QQ_home_time`).text(displayTime);$(`.QQ_home_usermsg[data-name='${characterName}'][data-group-type!='true'].QQ_home_lastmsg`).text(displayMsg);console.log(`私聊 ${characterName}最后消息已更新:${displayMsg}(${displayTime})`);}}function getFilenameWithoutExtension(path){const decodedPath=decodeURIComponent(path);const filename=decodedPath.split("/").pop();const lastDotIndex=filename.lastIndexOf(".");return lastDotIndex>0
? filename.slice(0,lastDotIndex):filename;}function QQ_page(id){if(id=="message"){$("#QQ_home_page").show();$("#QQ_space_page").hide();$(".QQ_chat_page").hide();$("#QQ_message_svg").css("fill","#019aff");$("#QQ_people_svg").css("fill","#000000");$("#QQ_moment_svg").css("fill","#000000");$("#App_QQ").css("background-color","#eff3ff");}else if(id=="people"){}else if(id=="moment"){$("#QQ_home_page").hide();$("#QQ_space_page").show();$(".QQ_chat_page").hide();$("#QQ_moment_svg").css("fill","#019aff");$("#QQ_people_svg").css("fill","#000000");$("#QQ_message_svg").css("fill","#000000");$("#App_QQ").css("background-color","#ffffff");QQ_SetNewTips(0);QQ_NewMsg["moment"]=0;$(".new_tips").hide();}}function QQ_SetNewTips(count){let tips=$(".new_tips");tips.each(function(){if(count==0){$(this).css("display","none");}else{$(this).css("display","flex").text(count);}});}async function QQ_UpdateMessageList(){const $messageChars=$("#QQ_message_list_chars");const $homeChars=$("#QQ_home_chars");$messageChars.empty();const $homeContacts=$homeChars.find('.QQ_home_usermsg');const contactedUsers=[];let firstContact=null;$homeContacts.each(function(){const $contact=$(this);const name=$contact.attr('data-name');const $newMsgBadge=$contact.find('.QQ_home_usermsg_new');const hasNewMessages=$newMsgBadge.is(':visible')&&parseInt($newMsgBadge.text())>0;const lastMsg=$contact.find('.QQ_home_lastmsg').text().trim();const isGroup=$contact.attr('data-group-type')==='true';if(!firstContact){firstContact=$contact.clone(true);}let hasRealMessageRecord=false;const privateChatKey1=`${UserName}和${name}的聊天`;const privateChatKey2=`${name}和${UserName}的聊天`;if(QQ_msgjson&&QQ_msgjson.私聊){if((QQ_msgjson.私聊[privateChatKey1]&&QQ_msgjson.私聊[privateChatKey1].length>0)||(QQ_msgjson.私聊[privateChatKey2]&&QQ_msgjson.私聊[privateChatKey2].length>0)){hasRealMessageRecord=true;}}if(QQ_msgjson&&QQ_msgjson.群聊&&QQ_msgjson.群聊[name]&&QQ_msgjson.群聊[name].msgs&&QQ_msgjson.群聊[name].msgs.length>0){hasRealMessageRecord=true;}const hasUnreadCount=hasNewMessages&&parseInt($newMsgBadge.text())>0;if(isGroup){if(QQ_Groups.includes(name)){contactedUsers.push($contact.clone(true));}}else{if(hasRealMessageRecord||hasUnreadCount){updatePrivateChatLastMessageDisplay(name);contactedUsers.push($contact.clone(true));}}});if(contactedUsers.length===0&&firstContact){$messageChars.append(firstContact);}else{contactedUsers.forEach(function($contact){$messageChars.append($contact);});}}function QQ_HideAllChat(){$(`.QQ_chat_page`).hide();}function QQ_ChangeChatPage(event,directName=null){const $QQpage=$("#App_QQ");if($QQpage.length===0){return;}let name;if(directName){name=directName;}else{let element=event.currentTarget;name=element.getAttribute("data-name")?? "";}const isGroup=QQ_Groups.includes(name);let $page=$(`.QQ_chat_page[data-name='${name}']`);if($page.length===0){$page=$(QQ_CreatChatPage(name));$QQpage.append($page);}if(isGroup){$page.addClass('group-chat-page');$page.attr('data-group-type','true');const $username=$page.find('#QQ_chat_username');if($username.length>0){const groupData=QQ_msgjson.群聊[name];const memberCount=groupData&&groupData.members ? groupData.members.length:0;$username.html(`${name}<span style="font-size:12px;color:#999;font-weight:normal;">(${memberCount}人)</span>`);}const $input=$page.find('.QQ_chat_input');$input.addClass('userInput');$input.attr('data-name',name);}QQ_SetHomeTips(name,"0");QQ_MarkAsRead(name);if(!isGroup){Object.keys(QQ_CharacterSpirits).forEach(characterName=>{if(characterName!==name){QQ_HideCharacterSpirit(characterName);}});}else{QQ_HideAllCharacterSpirits();}QQ_HideAllChat();$("#QQ_home_page").hide();$("#QQ_message_list_page").hide();$("#QQ_space_page").hide();$(".QQ_bottom_nav").hide();$page.show();let $msgContent=$page.find(".msgcontent");$msgContent.scrollTop($msgContent[0].scrollHeight);let TipsCount=QQ_GetChatShowTipsCount(name);const $Tips=$page.find(`.new_tips`);$Tips.text(TipsCount);if(TipsCount>0){$Tips.css("display","flex");}else{$Tips.hide();}}function QQ_CreatChatPage(name){const isGroup=QQ_Groups.includes(name);let $page=$(_.template(chat_page)({name:name,isGroup:isGroup,members:isGroup ?(QQ_msgjson.群聊[name]?.members||[]).join(','):''}));const $msgContent=$page.find(".msgcontent");let allMessages=[];if(isGroup&&QQ_msgjson.群聊[name]&&QQ_msgjson.群聊[name].msgs){allMessages=QQ_msgjson.群聊[name].msgs;}else if(!isGroup&&QQ_msgjson.私聊[`${UserName}和${name}的聊天`]){allMessages=QQ_msgjson.私聊[`${UserName}和${name}的聊天`];}if(allMessages.length>0){chatDisplayCounts[name]=0;const startIndex=Math.max(0,allMessages.length-CHAT_DISPLAY_LIMIT);const messagesToShow=allMessages.slice(startIndex);messagesToShow.forEach(msg=>{QQ_Chat_AddMsg($msgContent[0],msg,name,false,true);});chatDisplayCounts[name]=messagesToShow.length;QQ_Update_Chat_LoadMore(name,$msgContent[0]);}$msgContent.scrollTop($msgContent[0].scrollHeight);return $page;}function QQ_Msg_DelUserKey(content){let json=JsonYamlParse(content);if(!json){return content;}let others="";if(`${UserName}` in json.私聊==false){return content;}for(let msg of json.私聊[`${UserName}`]){const sp=msg.split("--");if(sp.length<=0){continue;}if(sp[0]!=`${UserName}`){if(!others){others=sp[0];}else if(sp[0]!=others){return content;}}}if(!others){if(json.私聊[`${UserName}`].length==0){delete json.私聊[`${UserName}`];return JSON.stringify(json);}return content;}if(others in json.私聊==false){const newvalue=json.私聊[`${UserName}`];delete json.私聊[`${UserName}`];json.私聊[others]=newvalue;return JSON.stringify(json);}else if(json.私聊[others].length==0){const newvalue=json.私聊[`${UserName}`];delete json.私聊[`${UserName}`];json.私聊[others]=newvalue;return JSON.stringify(json);}return content;}function QQ_AddNpcHead(content){let json=JsonYamlParse(content);if(!json){return content;}const Sections=QQ_CharSettings.getAllSections();let newcss="";for(let str in json.私聊){for(const msg of json.私聊[str]){const sp=msg.split("--");if(sp.length<=1){continue;}const name=sp[0];if(!Sections.includes(name)&&name!=`${UserName}`){System_AddNpcHead(name);}}}for(let Group in json.群聊){for(const msg of json.群聊[Group].msgs){const sp=msg.split("--");if(sp.length<=0){continue;}const name=sp[0];if(!Sections.includes(name)&&name!=`${UserName}`){System_AddNpcHead(name);}}}}function QQ_Msg_Repair(content){let json=JsonYamlParse(content);if(!json){return content;}for(let str in json.私聊){const match=str.match(/(.+?)和(.+?)的聊天/);if(!match){if(str!=`${UserName}`){const value=json.私聊[str];delete json.私聊[str];json.私聊[`${UserName}和${str}的聊天`]=value;}else{delete json.私聊[str];}continue;}if(match[1]!=`${UserName}`&&match[2]!=`${UserName}`){delete json.私聊[str];continue;}if(match[1]!=`${UserName}`&&match[2]==`${UserName}`){const value=json.私聊[str];delete json.私聊[str];json.私聊[`${UserName}和${match[1]}的聊天`]=value;}}const keys=QQ_CharSettings.getAllSections();for(let str in json.私聊){const match=str.match(/(.+?)和(.+?)的聊天/);if(!match){continue;}let value=QQ_NickNameRepair(json.私聊[str]);json.私聊[str]=value;const localname=match[2];if(!keys.includes(localname)){for(const char of keys){let find=false;const namelist=QQ_CharSettings.readValue(char,"网名",).split(",");if(!namelist||namelist.length==0){continue;}for(const name of namelist){const regex=createRegExp(name);if(!name||!regex){continue;}if(localname.match(regex)){delete json.私聊[str];json.私聊[`${UserName}和${char}的聊天`]=value;find=true;break;}}if(find){break;}}}}for(const Group in json.群聊){json.群聊[Group].msgs=QQ_NickNameRepair(json.群聊[Group].msgs,);}QQ_AddNpcHead(JSON.stringify(json));return JSON.stringify(json);}function QQ_NickNameRepair(content){if(!content||content.length==0){return content;}let charlist=QQ_CharSettings.getAllSections();let result=[];for(let str of content){const match=str.match(/(.+?)--([\s\S]+)/);if(match&&match[1]!=UserName){const localname=match[1];if(!charlist.includes(localname)){for(const char of charlist){let find=false;const namelist=QQ_CharSettings.readValue(char,"网名",).split(",");if(!namelist||namelist.length==0){continue;}for(const name of namelist){if(!name){continue;}if(name.match(/^\/(.+)\/([gimuy]*)$/)){const regex=createRegExp(name);if(!regex){continue;}if(localname.match(regex)){str=`${char}--${match[2]}`;find=true;break;}}else{if(namelist.includes(localname)){str=`${char}--${match[2]}`;find=true;break;}}}if(find){break;}}}}result.push(str);}return result;}function createRegExp(pattern){if(!pattern)return null;if(pattern instanceof RegExp)return pattern;try{const regexMatch=pattern.match(/^\/(.+)\/([gimuy]*)$/);if(regexMatch){const[_,regexPattern,flags]=regexMatch;return new RegExp(regexPattern,flags);}else{return new RegExp(pattern);}}catch(error){console.error("创建正则表达式失败:",error);return null;}}async function QQ_HandleCharacterChat(chatKey,messages,char1,char2){if(!messages||messages.length===0){return;}const chatId=`char_chat_${char1}_${char2}`;const chatTitle=`${char1}和${char2}的私聊`;if(!window.QQ_CharacterChats){window.QQ_CharacterChats={};}if(!window.QQ_CharacterChats[chatKey]){window.QQ_CharacterChats[chatKey]={id:chatId,title:chatTitle,char1:char1,char2:char2,messages:[],lastTime:'',lastMessage:''};}let lastTime='';let lastMessage='';for(let msg of messages){const parts=msg.split("--");if(parts.length>=2){parts[1]=QQ_CleanNestedTags(parts[1]);msg=parts.join("--");}if(!window.QQ_CharacterChats[chatKey].messages.includes(msg)){window.QQ_CharacterChats[chatKey].messages.push(msg);}const sp=msg.split("--");if(sp.length>=2){lastMessage=sp[1];}if(sp.length>=3){lastTime=sp[2];}}window.QQ_CharacterChats[chatKey].lastTime=lastTime;window.QQ_CharacterChats[chatKey].lastMessage=lastMessage;QQ_CreateCharacterChatInterface(window.QQ_CharacterChats[chatKey]);await QQ_SaveCharacterChatToWorldbook(window.QQ_CharacterChats[chatKey]);}function QQ_CreateCharacterChatInterface(chatData){const contactsContainer=$('#QQ_home_chars');if(!contactsContainer.length){console.error('找不到联系人容器');return;}const existingElement=contactsContainer.find(`[data-char-chat-id="${chatData.id}"]`);if(existingElement.length>0){existingElement.find('.QQ_home_lastmsg').text(chatData.lastMessage);existingElement.find('.QQ_home_lasttime').text(chatData.lastTime);return;}const chatElement=$(`<div class="QQ_home_char" data-char-chat-id="${chatData.id}" data-char-chat="true"><div class="QQ_home_head"><div class="QQ_home_avatar" style="background:linear-gradient(135deg,#9C27B0,#673AB7);border-radius:50%;width:50px;height:50px;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:14px;">💬</div></div><div class="QQ_home_info"><div class="QQ_home_name" style="color:#9C27B0;font-weight:bold;">${chatData.title}</div><div class="QQ_home_lastmsg">${chatData.lastMessage}</div></div><div class="QQ_home_time"><div class="QQ_home_lasttime">${chatData.lastTime}</div><div class="QQ_readonly_badge" style="background:#9C27B0;color:white;font-size:10px;padding:2px 6px;border-radius:10px;margin-top:5px;">只读</div></div></div>`);chatElement.on('click',function(){QQ_ShowCharacterChatDialog(chatData);});contactsContainer.append(chatElement);}function QQ_ShowCharacterChatDialog(chatData){const dialogHtml=`<div id="char-chat-dialog" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;"><div style="background:white;border-radius:15px;width:90%;max-width:400px;max-height:80%;display:flex;flex-direction:column;overflow:hidden;"><div style="padding:15px;background:linear-gradient(135deg,#9C27B0,#673AB7);color:white;display:flex;align-items:center;justify-content:space-between;"><div style="display:flex;align-items:center;gap:10px;"><div style="width:30px;height:30px;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;">💬</div><div><div style="font-weight:bold;font-size:16px;">${chatData.title}</div><div style="font-size:12px;opacity:0.8;">角色间私聊（只读）</div></div></div><button id="close-char-chat" style="background:none;border:none;color:white;font-size:20px;cursor:pointer;padding:5px;">×</button></div><div style="flex:1;overflow-y:auto;padding:15px;background:#f5f5f5;"><div id="char-chat-messages"></div></div><div style="padding:10px;background:#e0e0e0;text-align:center;color:#666;font-size:12px;">📖 这是角色之间的私聊，您只能查看不能回复</div></div></div>`;$('#char-chat-dialog').remove();$('body').append(dialogHtml);const messagesContainer=$('#char-chat-messages');chatData.messages.forEach(msg=>{const parts=msg.split('--');if(parts.length>=2){const sender=parts[0];const content=parts[1];const time=parts.length>=3 ? parts[2]:'';const messageHtml=`<div style="margin-bottom:15px;"><div style="display:flex;align-items:center;gap:8px;margin-bottom:5px;"><div style="font-weight:bold;color:#9C27B0;">${sender}</div><div style="font-size:11px;color:#999;">${time}</div></div><div style="background:white;padding:10px;border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,0.1);">${content}</div></div>`;messagesContainer.append(messageHtml);}});messagesContainer.scrollTop(messagesContainer[0].scrollHeight);$('#close-char-chat,#char-chat-dialog').on('click',function(e){if(e.target===this){$('#char-chat-dialog').remove();}});}async function QQ_SaveCharacterChatToWorldbook(chatData){try{if(!worldbook||!entries){console.warn('世界书功能不可用，无法保存角色间私聊');return false;}const entryKey=`QQ_角色间私聊_${chatData.char1}_${chatData.char2}`;const uniqueComment=`手机-角色间私聊-${chatData.char1}和${chatData.char2}`;let existingEntry=entries.find(e=>e.comment===uniqueComment);const saveContent=JSON.stringify({id:chatData.id,title:chatData.title,char1:chatData.char1,char2:chatData.char2,messages:chatData.messages,lastTime:chatData.lastTime,lastMessage:chatData.lastMessage,timestamp:new Date().toISOString()});if(existingEntry){await setLorebookEntries(worldbook,[{uid:existingEntry.uid,content:saveContent}]);}else{await createLorebookEntry(worldbook,{comment:uniqueComment,key:[entryKey],content:saveContent,position:0,disable:false,addMemo:false,order:1000,depth:4,selectiveLogic:0,excludeRecursion:false,delayUntilRecursion:false,probability:100,useProbability:false});}return true;}catch(error){console.error('保存角色间私聊到世界书失败:',error);return false;}}async function QQ_Msg_Parse(content){let hasstr=false;if(content.match(/\S/)){hasstr=true;}let json=JsonYamlParse(content);if(!json){if(hasstr){QQ_Error(`解析聊天记录失败,请手动解决`);}return;}console.log(`解析成功时的聊天消息:${JSON.stringify(json)}`);const $QQpage=$("#App_QQ");if($QQpage.length===0){return;}for(let str in json.私聊){const match=str.match(/(.+?)和(.+?)的聊天/);if(!match){continue;}if(match[1]!==`${UserName}`&&match[2]!==`${UserName}`){await QQ_HandleCharacterChat(str,json.私聊[str],match[1],match[2]);continue;}let name="";if(match[1]!=`${UserName}`){name=match[1];}else if(match[2]!=`${UserName}`){name=match[2];}else{continue;}try{if(!QQ_msgjson.私聊[str]){QQ_msgjson.私聊[str]=[];}if(!QQ_NewMsg[name]){QQ_NewMsg[name]={};}if(!$(`.QQ_home_usermsg[data-name='${name}']`).length&&name!=`${UserName}`){AddNewChar(name,"");}let $page=$(`.QQ_chat_page[data-name='${name}']`);let Creat=false;if($page.length===0){Creat=true;$page=$(QQ_CreatChatPage(`${name}`));$QQpage.append($page);}if(json.私聊[str].length==0){continue;}let $msgContent=$page.find(".msgcontent");let NewMsgCount=0;let LastTime="";let LastMsg="";for(let msg of json.私聊[str]){const parts=msg.split("--");if(parts.length>=2){parts[1]=QQ_CleanNestedTags(parts[1]);msg=parts.join("--");}const isNewMsg=!QQ_msgjson.私聊[str].includes(msg);QQ_Chat_AddMsg($msgContent[0],msg,name,isNewMsg);QQ_msgjson.私聊[str].push(msg);let sp=msg.split("--");if(sp.length>=2){if(sp[0]==`${UserName}`){User_LastMsgMap.私聊[name]=`${sp[0]}--${sp[1]}`;}else if(sp[0]==name){if(sp.length>=3){Char_LastMsgMap.私聊[name]=`${sp[0]}--${sp[1]}--${sp[2]}`;}else{Char_LastMsgMap.私聊[name]=`${sp[0]}--${sp[1]}`;}}}if(sp.length>=3){LastTime=sp[2];}LastMsg=sp[1];}NewMsgCount=QQ_CalculateUnreadCount(name,QQ_msgjson.私聊[str],'private');if($(`.QQ_chat_page[data-name='${name}']`).css("display",)!="none"&&!Creat){NewMsgCount=0;}$(`.QQ_home_usermsg[data-name='${name}'].QQ_home_lastmsg`,).text(LastMsg);$(`.QQ_home_usermsg[data-name='${name}'].QQ_home_lasttime`,).text(LastTime);QQ_SetHomeTips(name,NewMsgCount);$msgContent.scrollTop($msgContent[0].scrollHeight);if(NewMsgCount>0){QQ_Update_Chat_LoadMore(name,$msgContent[0]);}QQ_UpdateMessageList();}catch(error){throw error;assertIsError(error);}}for(let name in json.群聊){try{if(json.群聊[name]["msgs"]){json.群聊[name]["msgs"]=json.群聊[name]["msgs"].map(msg=>{const parts=msg.split("--");if(parts.length>=2){parts[1]=QQ_CleanNestedTags(parts[1]);return parts.join("--");}return msg;});}if(!QQ_msgjson.群聊[name]){QQ_msgjson.群聊[name]={};QQ_msgjson.群聊[name]["members"]=json.群聊[name]["members"];QQ_msgjson.群聊[name]["msgs"]=[];}let existingGroupElement=$(`.QQ_home_usermsg[data-name='${name}']`);let isExistingGroup=false;const storedGroups=window.QQ_Group_Chats_Data||[];const storedGroup=storedGroups.find(g=>g.name===name);if(existingGroupElement.length>0){isExistingGroup=true;}else if(storedGroup){AddNewGroup(storedGroup.name,storedGroup.avatar||'https:isExistingGroup=true;}else{let redirected=false;const hasUserMessage=json.群聊[name]["msgs"].some(msg=>{const parts=msg.split("--");return parts.length>=2&&parts[0]===`${UserName}`;});if(hasUserMessage){let targetGroupName=null;if(User_LastMsgMap.群聊){const recentGroupChats=Object.keys(User_LastMsgMap.群聊);if(recentGroupChats.length>0){targetGroupName=recentGroupChats[recentGroupChats.length-1];}}if(!targetGroupName){const currentChatPage=$('.QQ_chat_page:visible,.group-chat-page:visible');if(currentChatPage.length>0){const currentChatName=currentChatPage.attr('data-name');const currentGroupId=currentChatPage.attr('data-group-id');if(currentGroupId){const groups=window.QQ_Group_Chats_Data||[];const currentGroup=groups.find(g=>g.id===currentGroupId);if(currentGroup){targetGroupName=currentGroup.name;}}else if(QQ_Groups.includes(currentChatName)){targetGroupName=currentChatName;}}}if(!targetGroupName&&window.currentGroupChat){targetGroupName=window.currentGroupChat.name;}if(targetGroupName&&targetGroupName!==name){const originalName=name;name=targetGroupName;json.群聊[name]=json.群聊[originalName];delete json.群聊[originalName];isExistingGroup=true;redirected=true;}else if(targetGroupName===name){isExistingGroup=true;redirected=true;}else{toastr.warning(`无法确定消息发送的目标群聊，请重新发送`,'消息发送失败');continue;}}else{if(window.currentGroupChat){const originalName=name;name=window.currentGroupChat.name;json.群聊[name]=json.群聊[originalName];delete json.群聊[originalName];isExistingGroup=true;redirected=true;}else{const currentChatPage=$('.QQ_chat_page:visible,.group-chat-page:visible');if(currentChatPage.length>0){const currentChatName=currentChatPage.attr('data-name');const currentGroupId=currentChatPage.attr('data-group-id');if(currentGroupId||QQ_Groups.includes(currentChatName)){const originalName=name;name=currentChatName;json.群聊[name]=json.群聊[originalName];delete json.群聊[originalName];isExistingGroup=true;redirected=true;}}}}if(!redirected){const newGroupData={id:`group_${Date.now()}`,name:name,members:json.群聊[name]["members"]||[],avatar:{type:'preset',gradient:{start:'#199AFF',end:'#0066CC'},text:'群'},lastMessage:'群聊已创建',lastTime:new Date().toLocaleTimeString('zh-CN',{hour12:false}).slice(0,5),timestamp:new Date().toLocaleTimeString('zh-CN',{hour12:false}).slice(0,5)};AddNewGroup(newGroupData.name,newGroupData.avatar,newGroupData.members,newGroupData.lastMessage);try{await saveGroupToWorldbook(newGroupData);toastr.success(`新群聊 "${newGroupData.name}" 已创建并保存`,'群聊创建成功');}catch(error){console.error('保存AI创建的群聊到世界书失败:',error);toastr.warning(`群聊 "${newGroupData.name}" 已创建，但保存到世界书失败`,'部分成功');}isExistingGroup=true;}}if(!isExistingGroup){continue;}if(!QQ_Groups.includes(name)){QQ_Groups.push(name);}let $page=$(`.QQ_chat_page[data-group-id],.QQ_chat_page[data-name='${name}']`).filter(function(){return $(this).attr('data-name')===name||($(this).attr('data-group-id')&&window.currentGroupChat&&window.currentGroupChat.name===name);});let Creat=false;if($page.length===0){Creat=true;if(window.currentGroupChat&&window.currentGroupChat.name===name){$page=ensureGroupChatPage(window.currentGroupChat);}else{$page=$(QQ_CreatChatPage(name));$QQpage.append($page);}}let $msgContent=$page.find(".msgcontent");if(json.群聊[name]["msgs"].length==0){continue;}let NewMsgCount=0;let LastTime="";let LastMsg="";for(let msg of json.群聊[name]["msgs"]){const isNewMsg=!QQ_msgjson.群聊[name]["msgs"].includes(msg);QQ_Chat_AddMsg($msgContent[0],msg,name,isNewMsg);console.log(`在群聊:${name}中添加消息:${msg}(新消息:${isNewMsg})`);QQ_msgjson.群聊[name]["msgs"].push(msg);const groupsForMessage=window.QQ_Group_Chats_Data||[];const currentGroup=groupsForMessage.find(g=>g.name===name);if(currentGroup){const sp=msg.split("--");if(sp.length>=2){const messageObj={sender:sp[0],content:sp[1],timestamp:sp.length>=3 ? sp[2]:new Date().toLocaleTimeString('zh-CN',{hour12:false})};saveGroupMessage(currentGroup.id,messageObj);await updateGroupLastMessage(currentGroup.id,sp[1]);}}let sp=msg.split("--");if(sp.length>=2){if(sp[0]==`${UserName}`){User_LastMsgMap.群聊[name]=`${sp[0]}--${sp[1]}`;}else{if(sp.length>=3){Char_LastMsgMap.群聊[name]=`${sp[0]}--${sp[1]}--${sp[2]}`;}else{Char_LastMsgMap.群聊[name]=`${sp[0]}--${sp[1]}`;}}}if(sp.length>=3){LastTime=sp[2];}LastMsg=`${sp[0]}:${sp[1]}`;}NewMsgCount=QQ_CalculateUnreadCount(name,QQ_msgjson.群聊[name]["msgs"],'group');const isCurrentlyVisible=$(`.QQ_chat_page[data-name='${name}']`).css("display")!="none"||$(`.QQ_chat_page[data-group-id]`).filter(function(){return $(this).attr('data-name')===name&&$(this).css('display')!=='none';}).length>0;if(isCurrentlyVisible&&!Creat){NewMsgCount=0;}$(`.QQ_home_usermsg[data-name='${name}'].QQ_home_lastmsg`).text(LastMsg);$(`.QQ_home_usermsg[data-name='${name}'].QQ_home_lasttime`).text(LastTime);const groupsForUpdate=window.QQ_Group_Chats_Data||[];const currentGroup=groupsForUpdate.find(g=>g.name===name);if(currentGroup){$(`.QQ_home_usermsg[data-group-id='${currentGroup.id}'].QQ_home_lastmsg`).text(LastMsg);$(`.QQ_home_usermsg[data-group-id='${currentGroup.id}'].QQ_home_lasttime`).text(LastTime);}QQ_SetHomeTips(name,NewMsgCount);$msgContent.scrollTop($msgContent[0].scrollHeight);if(NewMsgCount>0){QQ_Update_Chat_LoadMore(name,$msgContent[0]);}let TipsCount=QQ_GetChatShowTipsCount(name);const $Tips=$(`.QQ_chat_page[data-name='${name}']`).find(`.new_tips`);$Tips.text(TipsCount);if(TipsCount>0){$Tips.css("display","flex");}else{$Tips.hide();}updateGroupLastMessageDisplay(name);QQ_UpdateMessageList();}catch(error){assertIsError(error);QQ_Error(error.message);}}console.log(`User_LastMsgMap:\n${JSON.stringify(User_LastMsgMap)}\nChar_LastMsgMap:\n${JSON.stringify(Char_LastMsgMap)}`,);return true;}function QQ_SetHomeTips(name,count){$(`.QQ_home_usermsg[data-name='${name}'].QQ_home_usermsg_new`,).text(count);if(count==0){$(`.QQ_home_usermsg[data-name='${name}'].QQ_home_usermsg_new`,).hide();}else{$(`.QQ_home_usermsg[data-name='${name}'].QQ_home_usermsg_new`,).show();}QQ_NewMsg[name]=count;}function QQ_GetChatShowTipsCount(name){let count=0;for(const n in QQ_NewMsg){if(n!=name){count+=Number(QQ_NewMsg[n]);}}return count;}let QQ_MomentGenerating=false;async function QQ_Moment_Comment(event){if(QQ_MomentGenerating){triggerSlash("/echo 生成中，请勿重复发送");return;}QQ_MomentGenerating=true;try{const $closest=$(event.currentTarget).closest('.user_moment');const message=$closest.find(".moment_message").text();const input=$closest.find("input[type='text']");const name=$closest.find(".moment_sender").text();const list=$closest.find(".user_leave_message_list");const value=input.val()?.trim();if(!value||!message){return;}const currentComments=list.find('.user_leave_message').length;if(currentComments>=8){list.find('.user_leave_message').first().remove();}let messageDiv=$("<div>",{class:"user_leave_message"});messageDiv.html(`<span><strong>${UserName}</strong>：${value}</span>`,);list.append(messageDiv);input.val("");if(list.length>0){list.scrollTop(list[0].scrollHeight);}const userComment={name:UserName,content:value,timestamp:new Date().toISOString()};const momentId=$closest.attr('data-moment-id');const targetMoment=QQ_MomentsData.find(moment=>moment.id===momentId);if(targetMoment){targetMoment.comments.push(userComment);if(targetMoment.comments.length>50){targetMoment.comments=targetMoment.comments.slice(-50);}await QQ_Save_Moments();}else{console.warn('未找到对应的动态数据，无法添加用户回复');}let tasks={momentComment:{author:name,content:value},privateChats:[],groupChats:[],interactiveTask:null};if(QQ_CacheSendMsg&&QQ_CacheSendMsg.trim()){const cachedActions=QQ_GetValueName(QQ_CacheSendMsg);if(cachedActions){for(const action of cachedActions){if(QQ_Groups.includes(action.name)){if(!tasks.groupChats.some(g=>g[action.name]))tasks.groupChats.push({[action.name]:[]});}else{if(!tasks.privateChats.includes(action.name))tasks.privateChats.push(action.name);}}}for(const match of cachedActions||[]){let localname=match.name;let localmsg=match.value;if(QQ_Groups.includes(localname)){QQ_msgjson.群聊[localname]=QQ_msgjson.群聊[localname]||{};QQ_msgjson.群聊[localname].msgs=QQ_msgjson.群聊[localname].msgs||[];QQ_msgjson.群聊[localname].msgs.push(`${UserName}--${localmsg}`);User_LastMsgMap.群聊[localname]=`${UserName}--${localmsg}`;const currentTime=new Date().toLocaleTimeString('zh-CN',{hour12:false});const groupsForSync=await loadGroupChatsFromWorldbook();const targetGroup=groupsForSync.find(g=>g.name===localname);if(targetGroup){const messageObj={sender:UserName,content:localmsg,timestamp:currentTime};saveGroupMessage(targetGroup.id,messageObj);await updateGroupLastMessage(targetGroup.id,localmsg);}}else{const key=`${UserName}和${localname}的聊天`;QQ_msgjson.私聊[key]=QQ_msgjson.私聊[key]||[];QQ_msgjson.私聊[key].push(`${UserName}--${localmsg}`);User_LastMsgMap.私聊[localname]=`${UserName}--${localmsg}`;}}}const interactiveResult=QQ_DetectInteractiveIntent(value);if(interactiveResult&&interactiveResult.isInteractive){tasks.interactiveTask=interactiveResult;QQ_UserTriggeredInteractive=true;}else{QQ_UserTriggeredInteractive=false;}const finalPrompt=buildDynamicPrompt(tasks);let sendvalue=(QQ_CacheSendMsg ? `${QQ_CacheSendMsg.trim()}\n\n`:'')+`用户在${name}的动态下评论：${value}`;const finalPayload=`${sendvalue}\n\n${QQ_GetTimeContext()}\n\n${finalPrompt}`;QQ_CacheSendMsg="";QQ_LastRequest=finalPayload;QQ_LastRequestName=name;const result=await QQ_Gen(finalPayload);await ResultHandle(result);}catch(error){console.error('动态评论AI生成过程中出错:',error);await QQ_Force_Save_All_Data();}finally{QQ_MomentGenerating=false;}}async function QQ_Handle_AI_Comments(content,$momentDiv){try{const momentMatch=content.match(/moment_start([\s\S]*?)moment_end/);if(!momentMatch){return;}const momentContent=momentMatch[1].trim();const lines=momentContent.split(/\r?\n/g);const commentsList=$momentDiv.find('.user_leave_message_list');const momentId=$momentDiv.attr('data-moment-id');const targetMoment=QQ_MomentsData.find(moment=>moment.id===momentId);const originalMessage=$momentDiv.find('.moment_message').text();const originalSender=$momentDiv.find('.moment_sender').text();const newComments=[];for(const line of lines){const trimmedLine=line.trim();if(!trimmedLine)continue;const fullMomentMatch=trimmedLine.match(/\s*(.+?)--(.+?)--(.+?)--(.+?)--(.+)/);if(fullMomentMatch){continue;}if(trimmedLine.includes('--')&&(/\d{2}:\d{2}/.test(trimmedLine)||/\d+月\d+日/.test(trimmedLine)||/--\d+--\d+/.test(trimmedLine)||trimmedLine.split('--').length>=4)){continue;}const commentMatch=trimmedLine.match(/^\s*(.+?)(?::|：|--)(.+)$/);if(commentMatch){const[,name,commentContent]=commentMatch;if(commentContent.includes(originalMessage)&&commentContent.length>20){continue;}if(commentContent.includes(originalSender)&&commentContent.includes(originalMessage)){continue;}if(commentContent.includes('[img-')&&originalMessage.includes('[img-')){const originalImageContent=originalMessage.match(/\[img-([^\]]+)\]/);const commentImageContent=commentContent.match(/\[img-([^\]]+)\]/);if(originalImageContent&&commentImageContent&&originalImageContent[1]===commentImageContent[1]){continue;}}if(commentContent.length>200){console.log('⚠️ 评论内容过长，可能是动态内容，已过滤:',commentContent.substring(0,50)+'...');continue;}const commentData={name:name,content:commentContent,timestamp:new Date().toISOString()};newComments.push(commentData);if(targetMoment){targetMoment.comments.push(commentData);if(targetMoment.comments.length>50){targetMoment.comments=targetMoment.comments.slice(-50);}}}}if(targetMoment&&newComments.length>0){QQ_Render_Comments(targetMoment,commentsList);await QQ_Save_Moments();}const processedMessages=new Set();await QQ_Handle_Private_Messages(content,processedMessages);}catch(error){console.error('处理AI评论时出错:',error);}}function QQ_Render_Comments(momentData,$commentsList){$commentsList.empty();const comments=momentData.comments||[];const VISIBLE_COMMENTS=8;if(comments.length<=VISIBLE_COMMENTS){for(const comment of comments){const messageDiv=$("<div>",{class:"user_leave_message"});messageDiv.html(`<span><strong>${comment.name}</strong>：${comment.content}</span>`);$commentsList.append(messageDiv);}}else{const hiddenCommentsCount=comments.length-VISIBLE_COMMENTS;const visibleComments=comments.slice(-VISIBLE_COMMENTS);const expandButton=$("<div>",{class:"comments-expand-btn",style:"text-align:center;color:#999;padding:5px;cursor:pointer;border-bottom:1px solid #eee;"});expandButton.html(`<span>展开查看更多评论(${hiddenCommentsCount}条)</span>`);expandButton.on('click',function(){$commentsList.empty();for(const comment of comments){const messageDiv=$("<div>",{class:"user_leave_message"});messageDiv.html(`<span><strong>${comment.name}</strong>：${comment.content}</span>`);$commentsList.append(messageDiv);}const collapseButton=$("<div>",{class:"comments-collapse-btn",style:"text-align:center;color:#999;padding:5px;cursor:pointer;border-top:1px solid #eee;"});collapseButton.html(`<span>收起评论</span>`);collapseButton.on('click',function(){QQ_Render_Comments(momentData,$commentsList);});$commentsList.append(collapseButton);$commentsList.scrollTop($commentsList[0].scrollHeight);});$commentsList.append(expandButton);for(const comment of visibleComments){const messageDiv=$("<div>",{class:"user_leave_message"});messageDiv.html(`<span><strong>${comment.name}</strong>：${comment.content}</span>`);$commentsList.append(messageDiv);}}if($commentsList.length>0){$commentsList.scrollTop($commentsList[0].scrollHeight);}}async function QQ_Handle_Private_Messages(content,processedMessages=new Set()){try{const allMsgMatches=[...content.matchAll(/msg_start([\s\S]*?)msg_end/g)];if(allMsgMatches.length>0){for(const msgMatch of allMsgMatches){let msgContent=msgMatch[1].trim();msgContent=QQ_CleanNestedTags(msgContent);let messageHash;try{messageHash=msgContent.split('').map(c=>c.charCodeAt(0)).join('').substring(0,20);}catch(error){messageHash=Date.now().toString();}if(processedMessages.has(messageHash)){continue;}processedMessages.add(messageHash);console.log('处理新消息:',messageHash,msgContent.substring(0,50)+'...');await QQ_Msg_Parse(msgContent);}await QQ_Save_Chat_Backup();}}catch(error){console.error('处理私聊消息时出错:',error);}}async function QQ_Force_Save_All_Data(){try{await QQ_Save_Moments();await QQ_Save_Chat_Backup();await QQ_Force_Save_Group_Messages();if(typeof window.QQ_Show_Moments_Stats==='function'){window.QQ_Show_Moments_Stats();}}catch(error){console.error('强制保存数据时出错:',error);}}async function QQ_Force_Save_Group_Messages(){try{if(QQ_msgjson.群聊&&typeof QQ_msgjson.群聊==='object'){const groups=window.QQ_Group_Chats_Data||[];for(const groupName in QQ_msgjson.群聊){const groupData=QQ_msgjson.群聊[groupName];if(groupData&&groupData.msgs&&Array.isArray(groupData.msgs)){const targetGroup=groups.find(g=>g.name===groupName);if(targetGroup){const recentMessages=groupData.msgs.slice(-10);for(const msg of recentMessages){const parts=msg.split('--');if(parts.length>=2){const messageObj={sender:parts[0],content:parts[1],timestamp:parts.length>=3 ? parts[2]:new Date().toLocaleTimeString('zh-CN',{hour12:false})};saveGroupMessage(targetGroup.id,messageObj);}}if(groupData.msgs.length>0){const lastMsg=groupData.msgs[groupData.msgs.length-1];const lastMsgParts=lastMsg.split('--');if(lastMsgParts.length>=2){await updateGroupLastMessage(targetGroup.id,lastMsgParts[1]);}}}else{}}}}}catch(error){console.error('强制保存群聊消息时出错:',error);}}window.QQ_Force_Save_All_Data=QQ_Force_Save_All_Data;function QQ_Check_Comment_Backup_Status(){if(!QQ_MomentsData||!Array.isArray(QQ_MomentsData)){return;}let totalComments=0;let momentsWithComments=0;QQ_MomentsData.forEach((moment,index)=>{if(moment.comments&&moment.comments.length>0){totalComments+=moment.comments.length;momentsWithComments++;console.log(`动态 ${index+1}(${moment.userName}):${moment.comments.length}条评论`);const recentComments=moment.comments.slice(-3);recentComments.forEach((comment,commentIndex)=>{console.log(`-${comment.name}:${comment.content}(${comment.timestamp})`);});}});if(worldbook&&entries){const momentEntry=entries.find(entry=>entry.comment==="手机-动态内容存储");if(momentEntry){try{const backupData=JSON.parse(momentEntry.content);let backupComments=0;let backupMomentsWithComments=0;backupData.forEach(moment=>{if(moment.comments&&moment.comments.length>0){backupComments+=moment.comments.length;backupMomentsWithComments++;}});}catch(error){console.error('世界书备份数据解析失败:',error);}}else{console.warn('未找到动态内容的世界书备份条目');}}else{console.warn('无法访问世界书或entries');}}window.QQ_Check_Comment_Backup_Status=QQ_Check_Comment_Backup_Status;function QQ_Test_Interactive_Settings(){try{const currentSettings=QQ_GetInteractiveSettings();const testMessages=['&&想要拥抱你','我想拥抱你和抚摸你','想你了','今天天气真好','*伸出双手*想要拥抱',];testMessages.forEach(message=>{const result=QQ_DetectInteractiveIntent(message);});if(currentSettings.customKeywords.length>0){console.log(` 关键词列表:${currentSettings.customKeywords.join(',')}`);}}catch(error){console.error('❌ 测试过程中出现错误:',error);}console.log('💡 提示:可以通过 QQ_ShowInteractiveSettings()打开设置界面');}window.QQ_Test_Interactive_Settings=QQ_Test_Interactive_Settings;function QQ_Check_Interactive_Backup_Status(){const memorySpaces=Object.keys(QQ_InteractiveSpaces||{}).length;const memoryCharSpaces=Object.keys(QQ_CharacterSpaces||{}).length;if(worldbook&&entries){const publicEntry=entries.find(entry=>entry.comment==="角色-互动空间备份");if(publicEntry){try{const publicData=JSON.parse(publicEntry.content);if(publicData.length>0){publicData.slice(0,3).forEach((item,index)=>{console.log(` 内容:${item.content.substring(0,50)}...`);});}}catch(error){console.error('❌ 解析公共互动备份失败:',error);}}else{console.warn('⚠ 未找到公共互动备份条目');}const characterEntries=entries.filter(entry=>entry.comment&&entry.comment.startsWith("角色-互动空间备份-"));characterEntries.forEach(entry=>{const characterName=entry.comment.replace("角色-互动空间备份-","");try{const charData=JSON.parse(entry.content);if(charData.length>0){const latest=charData[0];console.log(` 最新:${latest.timestamp}-${latest.content.substring(0,30)}...`);}}catch(error){console.error(`❌ 解析角色${characterName}互动备份失败:`,error);}});if(characterEntries.length===0){console.warn('⚠ 未找到任何角色互动备份条目');}}else{console.warn('❌ 无法访问世界书或entries');}}window.QQ_Check_Interactive_Backup_Status=QQ_Check_Interactive_Backup_Status;function QQ_Test_Enhanced_AI_Response(){console.log('-普通消息:强制3-4角色回复(4-5句话)+2角色私聊+动态');return{dynamicCommentRequirements:'强制4名角色评论+2名角色私聊，内容丰富',normalMessageRequirements:'强制3-4名角色回复+2名角色私聊+动态输出',contentStandard:'评论2-3句话，回复4-5句话，私聊3-4句话',qualityRequirements:'情感表达+具体反应+互动引导+个性差异',enhancementLevel:'超强化已激活',expectedImprovement:'回复内容将显著增加，互动性大幅提升'};}window.QQ_Test_Enhanced_AI_Response=QQ_Test_Enhanced_AI_Response;function QQ_Show_Interactive_Spaces_Backup(){try{if(!worldbook||!worldbook.entries){return;}const interactiveEntries=worldbook.entries.filter(entry=>entry.comment&&(entry.comment.includes('互动空间')||entry.comment==='QQ_互动空间备份'||entry.comment==='QQ_角色互动空间备份'||entry.comment.startsWith('QQ_互动空间备份_')));interactiveEntries.forEach((entry,index)=>{console.log(`🔑 关键词:${entry.key ? entry.key.join(','):'无'}`);if(entry.content){try{const data=JSON.parse(entry.content);if(data.spaces){const spaceCount=Object.keys(data.spaces).length;}if(data.characterSpaces){const characterCount=Object.keys(data.characterSpaces).length;const totalSpaces=Object.values(data.characterSpaces).reduce((sum,char)=>sum+Object.keys(char).length,0);}if(data.lastUpdated){}if(data.version){}}catch(parseError){}}else{}});if(window.QQ_InteractiveSpaces){const memorySpaceCount=Object.keys(QQ_InteractiveSpaces).length;console.log(`🏠 公共互动空间(内存):${memorySpaceCount}个`);}if(window.QQ_CharacterSpaces){const memoryCharacterCount=Object.keys(QQ_CharacterSpaces).length;const memoryTotalSpaces=Object.values(QQ_CharacterSpaces).reduce((sum,char)=>sum+Object.keys(char).length,0);console.log(`👥 角色互动空间(内存):${memoryCharacterCount}个角色,${memoryTotalSpaces}个空间`);}console.log("-执行 QQ_Show_Interactive_Spaces_Backup()查看此信息");console.log(" • QQ_互动空间备份(公共互动空间)");console.log(" • QQ_角色互动空间备份(角色专属互动空间)");console.log(" • QQ_互动空间备份_{角色名}(单角色互动空间)");return{totalEntries:interactiveEntries.length,entries:interactiveEntries.map(e=>({comment:e.comment,enabled:e.enabled,contentLength:e.content ? e.content.length:0}))};}catch(error){console.error("查询互动空间备份时发生错误:",error);return null;}}window.QQ_Show_Interactive_Spaces_Backup=QQ_Show_Interactive_Spaces_Backup;function QQ_Check_Group_Message_Backup_Status(){if(QQ_msgjson.群聊&&typeof QQ_msgjson.群聊==='object'){const groupNames=Object.keys(QQ_msgjson.群聊);let totalMessages=0;groupNames.forEach(groupName=>{const groupData=QQ_msgjson.群聊[groupName];const msgCount=groupData&&groupData.msgs ? groupData.msgs.length:0;totalMessages+=msgCount;if(msgCount>0){const recentMsgs=groupData.msgs.slice(-3);recentMsgs.forEach(msg=>{});}});}else{}console.log(`QQ_Groups数组:[${QQ_Groups.join(',')}](${QQ_Groups.length}个)`);if(worldbook&&entries){const chatEntry=entries.find(entry=>entry.comment==="QQ聊天备份数据");if(chatEntry){try{const backupData=JSON.parse(chatEntry.content);if(backupData.群聊){const backupGroupNames=Object.keys(backupData.群聊);let backupTotalMessages=0;backupGroupNames.forEach(groupName=>{const groupData=backupData.群聊[groupName];const msgCount=groupData&&groupData.msgs ? groupData.msgs.length:0;backupTotalMessages+=msgCount;});}else{}}catch(error){console.error('世界书备份数据解析失败:',error);}}else{console.warn('未找到聊天备份的世界书条目');}}else{console.warn('无法访问世界书或entries');}try{const groups=window.QQ_Group_Chats_Data||[];groups.forEach(group=>{console.log(`-${group.name}(ID:${group.id})`);});}catch(error){console.error('检查群聊专用存储失败:',error);}}window.QQ_Check_Group_Message_Backup_Status=QQ_Check_Group_Message_Backup_Status;function QQ_Test_Interactive_Optimization(){const testCases=[{content:'小明过来吧，我想和你聊聊',primaryChar:'小明',expected:'角色专属空间（小明主导）'},{content:'【小明】【小红】【小蓝】大家一起玩游戏吧',primaryChar:'小明',expected:'公共空间（明显多人）'},{content:'和小明单独聊天，顺便【小红】也来一下',primaryChar:'小明',expected:'角色专属空间（小明主导私密互动）'},{content:'小红和小蓝以及小绿一起唱歌',primaryChar:'小红',expected:'公共空间（多人活动）'},{content:'我来了！过来抱抱你',primaryChar:'小明',expected:'角色专属空间（单人互动）'}];testCases.forEach((testCase,index)=>{const isMultiCharacter=QQ_DetectMultiCharacterInteraction(testCase.content,testCase.primaryChar);const actualResult=isMultiCharacter ? '公共空间':'角色专属空间';console.log(`✓ 测试${actualResult.includes(testCase.expected.includes('公共')? '公共':'角色')? '通过':'失败'}`);});console.log('提示：你可以使用 QQ_Test_Interactive_Content_Detection("测试内容","角色名")来测试特定内容');}function QQ_Test_Interactive_Content_Detection(content,primaryCharacter=null){const isInteractive=QQ_IsInteractiveContent(content);if(isInteractive){const isMultiCharacter=QQ_DetectMultiCharacterInteraction(content,primaryCharacter);console.log(`推荐存储位置:${isMultiCharacter ? '公共互动空间':(primaryCharacter ? primaryCharacter+'的专属空间':'角色专属空间')}`);const sceneName=primaryCharacter ?
`${primaryCharacter}·${QQ_GetSceneFromContent(content)}`:QQ_GetSpaceName(content);}}window.QQ_Test_Interactive_Optimization=QQ_Test_Interactive_Optimization;window.QQ_Test_Interactive_Content_Detection=QQ_Test_Interactive_Content_Detection;function QQ_Check_Two_Stage_Send_Status(){if(QQ_CacheSendMsg){const namevalue=QQ_GetValueName(QQ_CacheSendMsg);if(namevalue&&namevalue.length>0){namevalue.forEach((match,index)=>{const type=QQ_Groups.includes(match.name)? '群聊':'私聊';});}else{}}console.log('私聊消息数量:',Object.keys(QQ_msgjson.私聊).length);Object.entries(QQ_msgjson.私聊).forEach(([chatKey,messages])=>{if(Array.isArray(messages)&&messages.length>0){const lastMsg=messages[messages.length-1];}});console.log('群聊消息数量:',Object.keys(QQ_msgjson.群聊).length);Object.entries(QQ_msgjson.群聊).forEach(([groupName,groupData])=>{if(groupData&&groupData.msgs&&Array.isArray(groupData.msgs)&&groupData.msgs.length>0){const lastMsg=groupData.msgs[groupData.msgs.length-1];}});console.log('提示：可以使用 QQ_Test_Cache_Message_Parsing("测试内容")来测试消息解析');}function QQ_Test_Cache_Message_Parsing(testContent){const namevalue=QQ_GetValueName(testContent);if(namevalue&&namevalue.length>0){namevalue.forEach((match,index)=>{const type=QQ_Groups.includes(match.name)? '群聊':'私聊';});}else{}}window.QQ_Check_Two_Stage_Send_Status=QQ_Check_Two_Stage_Send_Status;window.QQ_Test_Cache_Message_Parsing=QQ_Test_Cache_Message_Parsing;function QQ_Test_Time_Feature(){const now=new Date();const currentTime={time:now.toLocaleTimeString('zh-CN',{hour12:false,hour:'2-digit',minute:'2-digit'}),date:now.toLocaleDateString('zh-CN',{year:'numeric',month:'long',day:'numeric'}),weekday:now.toLocaleDateString('zh-CN',{weekday:'long'}),period:QQ_GetTimePeriod(now.getHours()),season:QQ_GetSeason(now.getMonth()+1)};const hour=now.getHours();const minute=now.getMinutes();const clarifiedTime=`${currentTime.period}${hour}点${minute.toString().padStart(2,'0')}分`;const timeContext=`<TimeContext:当前真实时间是${currentTime.date}${currentTime.weekday}${clarifiedTime}(24小时制${currentTime.time})，现在是${currentTime.period}时段，${currentTime.season}。请在回复中考虑时间情境，如问候语(早上好/下午好/晚上好)、活动安排等应符合当前时间>`;for(let h=0;h<24;h++){console.log(`${h}:00->${QQ_GetTimePeriod(h)}`);}for(let m=1;m<=12;m++){console.log(`${m}月->${QQ_GetSeason(m)}`);}}function QQ_Test_Message_Send_With_Time(){const now=new Date();const currentTime={time:now.toLocaleTimeString('zh-CN',{hour12:false,hour:'2-digit',minute:'2-digit'}),date:now.toLocaleDateString('zh-CN',{year:'numeric',month:'long',day:'numeric'}),weekday:now.toLocaleDateString('zh-CN',{weekday:'long'}),period:QQ_GetTimePeriod(now.getHours()),season:QQ_GetSeason(now.getMonth()+1)};const hour=now.getHours();const minute=now.getMinutes();const clarifiedTime=`${currentTime.period}${hour}点${minute.toString().padStart(2,'0')}分`;const timeContext=`<TimeContext:当前真实时间是${currentTime.date}${currentTime.weekday}${clarifiedTime}(24小时制${currentTime.time})，现在是${currentTime.period}时段，${currentTime.season}。请在回复中考虑时间情境，如问候语(早上好/下午好/晚上好)、活动安排等应符合当前时间>`;const mockRequest=`<Request:本次响应忽略其他上下文任何要求,必须使用线上格式回复,且用户本次发了消息的角色都要回复用户的消息,同时输出一条动态内容>`;const fullRequest=`给测试角色发消息:你好\n${timeContext}\n${mockRequest}`;}window.QQ_Test_Time_Feature=QQ_Test_Time_Feature;window.QQ_Test_Message_Send_With_Time=QQ_Test_Message_Send_With_Time;function QQ_Moment_Parse(content,isCommentContext=false){const lines=content.split(/\r?\n/g);let momentdiv;let list;let count=QQ_NewMsg["moment"]||0;let currentMomentData=null;if(isCommentContext){const commentLines=[];for(const line of lines){const trimmedLine=line.trim();if(!trimmedLine)continue;const fullMomentMatch=trimmedLine.match(/\s*(.+?)--(.+?)--(.+?)--(.+?)--(.+)/);if(fullMomentMatch){continue;}const commentMatch=trimmedLine.match(/^\s*(.+?)(?::|：|--)(.+)$/);if(commentMatch){commentLines.push({name:commentMatch[1],content:commentMatch[2],timestamp:new Date().toISOString()});}}if(commentLines.length>0&&QQ_MomentsData.length>0){const latestMoment=QQ_MomentsData[0];const latestMomentDiv=$("#space_contents").find('.user_moment').first();const latestCommentsList=latestMomentDiv.find('.user_leave_message_list');for(const comment of commentLines){latestMoment.comments.push(comment);if(latestMoment.comments.length>50){latestMoment.comments=latestMoment.comments.slice(-50);}}QQ_Render_Comments(latestMoment,latestCommentsList);setTimeout(async()=>{await QQ_Save_Moments();},500);}return;}for(const line of lines){/\s*(.+?)--(.+?)--(.+?)--(.+?)--(.+)/,);if(match){if(currentMomentData&&momentdiv){QQ_MomentsData.unshift(currentMomentData);count+=1;$("#space_contents").prepend(momentdiv);}let fakeimg="";let message=match[2];const matches=message.matchAll(/\[img-(.+?)\]/g);if(matches){for(const m of matches){message=message.replace(m[0],"");fakeimg+=`\n<div class="space_fakeimg">${m[1]}</div>`;}}const randomPhone=QQ_CharSettings.readValue(match[1],"手机型号")? QQ_CharSettings.readValue(match[1],"手机型号"):QQ_GetRandomPhone();const momentId=`${match[1]}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;currentMomentData={id:momentId,userName:match[1],message:message,timestampText:match[3],timestamp:new Date().toISOString(),additionalInfo:match[4],randomPhone:randomPhone,extraContent:match[5]||'',imgcontent:fakeimg,comments:[],likes:{count:parseInt(match[5])||0,userLiked:false,likedBy:[],lastLikeTime:null}};momentdiv=$("<div>",{class:"user_moment","data-moment-id":momentId});momentdiv.html(_.template(moment_page)({userName:match[1],message:message,timestamp:match[3],additionalInfo:match[4],randomPhone:randomPhone,extraContent:match[5],imgcontent:fakeimg,momentId:momentId,likeCount:currentMomentData.likes.count,likedByUser:currentMomentData.likes.userLiked}),);list=momentdiv.find(".user_leave_message_list");continue;}match=line.match(/^\s*(.+?)(?::|：|--)(.+)$/m);if(match&&momentdiv&&list&&currentMomentData){const commentData={name:match[1],content:match[2],timestamp:new Date().toISOString()};currentMomentData.comments.push(commentData);if(list.find('.user_leave_message').length>=8){list.find('.user_leave_message').first().remove();}let messageDiv=$("<div>",{class:"user_leave_message",});messageDiv.html(`<span><strong>${match[1]}</strong>：${match[2]}</span>`,);list.append(messageDiv);}}if(currentMomentData&&momentdiv){QQ_MomentsData.unshift(currentMomentData);count+=1;$("#space_contents").prepend(momentdiv);}QQ_NewMsg["moment"]=count;QQ_SetNewTips(count);if(QQ_MomentsData.length>0){setTimeout(async()=>{await QQ_Save_Moments();},1000);}}function QQ_GetRandomHead(){if(QQ_RandomHead.length===0)return null;let minCount=Infinity;const candidates=[];for(const obj of QQ_RandomHead){if(obj.count<minCount){minCount=obj.count;candidates.length=0;candidates.push(obj);}else if(obj.count===minCount){candidates.push(obj);}}const selected=candidates[Math.floor(Math.random()*candidates.length)];selected.count++;return selected.url;}let Phone=["小米","华为","苹果","三星","魅族","一加","oppo","vivo","真我","红米",];let Phone_lvl=["pro","max","mate","ultra","plus"];function QQ_GetRandomPhone(){let name=Phone[Math.floor(Math.random()*Phone.length)];name+=random(6,19);let count=random(1,Phone_lvl.length);let a=[];for(let i=0;i<count;i++){let randomresult=Phone_lvl[random(0,Phone_lvl.length)];if(!a.includes(randomresult)){a.push(randomresult);}}name+=" "+a.join(" ");return name;}function GetCharHead(name){if(typeof QQ_Char!=='undefined'&&QQ_Char[name]&&QQ_Char[name].head){return QQ_Char[name].head;}return "";}function QQ_Chat_AddMsg(dom,content,name,isNew,skipScrollAndCount=false){if(!skipScrollAndCount){const chatKey=name;if(!chatDisplayCounts[chatKey]){chatDisplayCounts[chatKey]=0;}const currentMsgCount=$(dom).children().not('.load-more-messages').length;if(currentMsgCount>=CHAT_DISPLAY_LIMIT&&isNew){$(dom).children().not('.load-more-messages').first().remove();chatDisplayCounts[chatKey]=CHAT_DISPLAY_LIMIT-1;}}if(content.startsWith("系统消息--")){const sysMsgText=content.split("--")[2];const msgDiv=$("<div>",{class:"system-message"}).text(sysMsgText);$(dom).append(msgDiv);}else{let sp=content.split("--");if(sp.length<2){return;}const sender=sp[0];const messageContent=sp[1];const timestamp=sp.length>=3 ? sp[2]:"";const isUser=sender==`${UserName}`;let messageHtml;if(isUser){const specialContent=QQ_Chat_SpecialMsg(messageContent,sender,QQ_Groups.includes(name),true);messageHtml=_.template(chat_user_message)({content:specialContent||messageContent});}else{const specialContent=QQ_Chat_SpecialMsg(messageContent,sender,QQ_Groups.includes(name),false);messageHtml=_.template(chat_char_msg)({content:specialContent||messageContent,name:sender,isgroup:QQ_Groups.includes(name)});}$(dom).append(messageHtml);}if(!skipScrollAndCount){const chatKey=name;chatDisplayCounts[chatKey]=$(dom).children().not('.load-more-messages').length;}if(!skipScrollAndCount&&dom&&dom.scrollHeight){$(dom).scrollTop(dom.scrollHeight);}}function QQ_Chat_AddUserMsg(element,msg){const match=msg.match(/(.+?)--(.+)/);if(!match){return;}const content=QQ_Chat_SpecialMsg(match[2],`${UserName}`,false,true,);const html=_.template(chat_user_message)({content});$(element).append(html);}function QQ_Chat_SpecialMsg(msg,username,isgroup,mysend){const match=msg.match(/\[(.+?)[\|-](.+?)\]/);const xxx=msg.match(/(.+?)\[/);const xx=msg.match(/\](.+)/);let additionalText="";if(xxx){additionalText=xxx[1];}if(xx){additionalText=additionalText
? additionalText+`<br>${xx[1]}`:xx[1];}if(!match){message:msg,isgroup:isgroup||false,username:username,});}const type=match[1];if(type=="bqb"){console.log(`表情包链接:${QQ_GetEmoji(match[2])}`);return _.template(chat_emoji_message)({emojiUrl:QQ_GetEmoji(match[2]),additionalText:additionalText,isgroup:isgroup||false,username:username,});}else if(type=="转账"||type=="zz"){return _.template(chat_transfer_message)({amount:match[2],});}else if(type=="yy"){let file=chat_char_voice_message;if(mysend){file=chat_my_voice_message;}return _.template(file)({content:match[2],time:Math.ceil(match[2].length/4).toString(),isgroup:isgroup||false,username:username,});}else if(["img","image","video","imgs","images","file","files","图片","视频","tp",].includes(type)){return _.template(chat_fakeimg_message)({isgroup:isgroup||false,username:username,content:match[2],additionalText:additionalText
? `<span style="margin-top:5px;display:block">${additionalText}</span>`:"",});}else if(["music","音乐"].includes(type)){let sp=match[2].split("$");let musicname="";let musicauthor="";if(sp.length>=2){musicname=sp[0];musicauthor=sp[1];}isgroup:isgroup||false,username:username,musicname:musicname,musicauthor:musicauthor,});}return "";}function QQ_MySendSpecial(content){let match=content.match(/\[?(.+?)-(.+?)]?$/m);if(match){let type=match[1];if(["yy","语音"].includes(type)){content=`[yy-${match[2]}]`;}else if(["表情包","表情","bqb","bq"].includes(type)){content=`[bqb-${match[2]}]`;}else if(["img","image","video","imgs","images","file","files","图片","视频","tp",].includes(type)){content=`[img-${match[2]}]`;}}return content;}function QQ_GetEmoji(name){if(!QQ_emoji.has(name)){return;}return QQ_emoji.get(name);}let currentSettingChatName="";function QQ_SetChatPageSetting(event){let element=event.currentTarget;const chatPageElement=$(element).closest(".QQ_chat_page");if(chatPageElement.length===0){console.error("无法获取当前聊天页");return;}currentSettingChatName=chatPageElement.attr("data-name")?? "";if($(".popup-overlay").length===0){$(".card").append('<div class="popup-overlay"></div>');}if($(".chat-setting-popup").length===0){$(".card").append(chat_page_setting.replace("${username}",currentSettingChatName,),);const bubblecolorPicker=document.getElementById("bubble-color");if(bubblecolorPicker){bubblecolorPicker.addEventListener("input",(event)=>{const color=event.target.value;$("#bubble-color-input").val(color||"#ffffff");$("#chat-setting-preview").each(function(){this.style.setProperty("background-color",color,"important",);});});}const TextcolorPicker=document.getElementById("text-color");if(TextcolorPicker){TextcolorPicker.addEventListener("input",(event)=>{const color=event.target.value;$("#text-color-input").val(color||"#ffffff");$("#chat-setting-preview").each(function(){const spans=this.querySelectorAll("span");spans.forEach((span)=>{span.style.setProperty("color",color,"important",);});});});}}loadCurrentSettings(currentSettingChatName);$(".popup-overlay").show();$(".chat-setting-popup").show();}function loadCurrentSettings(chatName){const setting=GetChatCharSettingByName(chatName);let bubbleColor=QQ_CharSettings.readValue(chatName,"气泡颜色",);let TextColor=QQ_CharSettings.readValue(chatName,"字体颜色");let chatBg=QQ_CharSettings.readValue(chatName,"聊天壁纸");if(bubbleColor&&bubbleColor[0]!=="#"){bubbleColor="#"+bubbleColor;}if(TextColor&&TextColor[0]!=="#"){TextColor="#"+TextColor;}$("#bubble-color").val(bubbleColor||"#ffffff");$("#bubble-color-input").val(bubbleColor||"#ffffff");$("#text-color").val(TextColor||"#ffffff");$("#text-color-input").val(TextColor||"#ffffff");$("#chat-bg").val(chatBg||"");$("#chat-setting-preview").each(function(){this.style.setProperty("background-color",bubbleColor,"important",);const spans=this.querySelectorAll("span");spans.forEach((span)=>{span.style.setProperty("color",TextColor,"important");});});}function closeSettingPopup(){$(".popup-overlay").hide();$(".chat-setting-popup").hide();}async function saveSettingAndClose(){if(!currentSettingChatName){console.error("未知的聊天对象");return;}const bubbleColor=$("#bubble-color-input").val()||"";const TextColor=$("#text-color-input").val()||"";const chatBg=$("#chat-bg").val()||"";QQ_CharSettings.writeValue(currentSettingChatName,"气泡颜色",bubbleColor,);QQ_CharSettings.writeValue(currentSettingChatName,"字体颜色",TextColor,);QQ_CharSettings.writeValue(currentSettingChatName,"聊天壁纸",chatBg,);const result=QQ_CharSettings.getAllText();for(let entry of entries){if(entry.comment=="手机-角色"||entry.comment=="手机界面-角色"){await setLorebookEntries(worldbook,[{uid:entry.uid,content:result},]);break;}}SetCssVariable(currentSettingChatName,"MsgColor",bubbleColor);SetCssVariable(currentSettingChatName,"TextColor",TextColor);SetCssVariable(currentSettingChatName,"BackGroundImg",`url('${chatBg}')`,);closeSettingPopup();}function updateTime(){const timeElement=document.getElementById("time");if(!timeElement){return;}const now=new Date();const hours=String(now.getHours()).padStart(2,"0");const minutes=String(now.getMinutes()).padStart(2,"0");timeElement.textContent=`${hours}:${minutes}`;}function App_Load(App_Name){$("#Home_page").hide();$("#App_page").show();App_HideAll();$(`#App_${App_Name}`).show();}function App_HideAll(){const AppNames=["QQ","twitter","discord"];for(const name of AppNames){$(`#App_${name}`).hide();}}setInterval(updateTime,1000);updateTime();async function initContactSearch(){const searchInput=document.getElementById('contact_search_input');const clearBtn=document.getElementById('search_clear_btn');const floatingSearchBox=document.getElementById('floating_search_box');if(searchInput&&searchInput.hasAttribute('data-initialized')){return;}if(!searchInput){console.error("搜索输入框未找到(ID:contact_search_input)");return;}if(!clearBtn){console.error("清除按钮未找到(ID:search_clear_btn)");return;}if(!floatingSearchBox){console.error("搜索框容器未找到(ID:floating_search_box)");return;}let searchTimeout;function debounceSearch(searchTerm){clearTimeout(searchTimeout);searchTimeout=setTimeout(()=>{filterContacts(searchTerm);},300);}searchInput.addEventListener('input',function(e){const searchTerm=e.target.value.trim();if(searchTerm.length>0){clearBtn.style.display='block';floatingSearchBox.style.borderColor='rgba(25,154,255,0.6)';floatingSearchBox.style.backgroundColor='rgba(239,243,255,0.95)';}else{clearBtn.style.display='none';floatingSearchBox.style.borderColor='rgba(25,154,255,0.2)';floatingSearchBox.style.backgroundColor='rgba(239,243,255,0.9)';}debounceSearch(searchTerm);});clearBtn.addEventListener('click',function(){searchInput.value='';clearBtn.style.display='none';floatingSearchBox.style.borderColor='rgba(25,154,255,0.2)';floatingSearchBox.style.backgroundColor='rgba(239,243,255,0.9)';clearTimeout(searchTimeout);filterContacts('');searchInput.focus();});searchInput.addEventListener('focus',function(){floatingSearchBox.style.boxShadow='0 2px 8px rgba(25,154,255,0.3)';});searchInput.addEventListener('blur',function(){floatingSearchBox.style.boxShadow='none';});searchInput.addEventListener('keydown',function(e){if(e.key==='Escape'){e.preventDefault();this.value='';clearBtn.style.display='none';floatingSearchBox.style.borderColor='rgba(25,154,255,0.2)';floatingSearchBox.style.backgroundColor='rgba(239,243,255,0.9)';clearTimeout(searchTimeout);filterContacts('');}});searchInput.setAttribute('data-initialized','true');if(typeof reinitGroupChat==='function'){reinitGroupChat();}if(typeof initContactGroups==='function'){initContactGroups();}setTimeout(()=>{const contactsList=document.querySelector('#QQ_home_chars');const contacts=contactsList ? contactsList.querySelectorAll('.QQ_home_usermsg'):[];if(contacts.length===0){console.warn("当前没有联络人数据，搜索功能可能无法显示效果");}},1000);}function filterContacts(searchTerm){const contactsList=document.querySelector('#QQ_home_chars');if(!contactsList){console.error("联络人列表未找到");return;}const search=searchTerm.toLowerCase().trim();const isEmpty=search==='';let totalVisibleCount=0;if(isEmpty){contactsList.classList.remove('searching');}else{contactsList.classList.add('searching');}const contactGroups=contactsList.querySelectorAll('.contact-group');contactGroups.forEach(groupElement=>{const groupContent=groupElement.querySelector('.group-content');const contacts=groupContent ? groupContent.querySelectorAll('.QQ_home_usermsg'):[];let groupVisibleCount=0;contacts.forEach(contact=>{const isVisible=filterSingleContact(contact,search,searchTerm,isEmpty);if(isVisible){groupVisibleCount++;totalVisibleCount++;}});if(!isEmpty){if(groupVisibleCount>0){groupElement.style.display='';const groupToggle=groupElement.querySelector('.group-toggle');const groupContentDiv=groupElement.querySelector('.group-content');if(groupToggle&&groupToggle.classList.contains('collapsed')){groupToggle.classList.remove('collapsed');groupContentDiv.classList.remove('collapsed');groupContentDiv.classList.add('expanded');}}else{groupElement.style.display='none';}}else{groupElement.style.display='';}});const ungroupedSection=contactsList.querySelector('.ungrouped-contacts');if(ungroupedSection){const ungroupedContacts=ungroupedSection.querySelectorAll('.QQ_home_usermsg');let ungroupedVisibleCount=0;ungroupedContacts.forEach(contact=>{const isVisible=filterSingleContact(contact,search,searchTerm,isEmpty);if(isVisible){ungroupedVisibleCount++;totalVisibleCount++;}});if(!isEmpty){ungroupedSection.style.display=ungroupedVisibleCount>0 ? '':'none';}else{ungroupedSection.style.display='';}}const independentContacts=contactsList.querySelectorAll('.QQ_home_usermsg:not(.contact-group .QQ_home_usermsg):not(.ungrouped-contacts .QQ_home_usermsg)');independentContacts.forEach(contact=>{const isVisible=filterSingleContact(contact,search,searchTerm,isEmpty);if(isVisible){totalVisibleCount++;}});if(!isEmpty){}if(!isEmpty&&totalVisibleCount===0){}}function filterSingleContact(contact,search,searchTerm,isEmpty){const nameElement=contact.querySelector('.QQ_home_name');const lastMsgElement=contact.querySelector('.QQ_home_lastmsg');if(!nameElement){console.warn("联络人项目缺少姓名元素",contact);return false;}const originalName=nameElement.getAttribute('data-original-text')||nameElement.textContent;const name=originalName.toLowerCase();const lastMsg=lastMsgElement ? lastMsgElement.textContent.toLowerCase():'';const nameMatches=isEmpty||name.includes(search);const msgMatches=isEmpty||lastMsg.includes(search);const isMatch=nameMatches||msgMatches;if(isMatch){contact.style.display='';if(!isEmpty&&nameMatches){highlightContactSearchTerm(nameElement,searchTerm,originalName);}else{if(nameElement.getAttribute('data-original-text')){nameElement.innerHTML=originalName;}}return true;}else{contact.style.display='none';return false;}}function highlightContactSearchTerm(element,searchTerm,originalText){if(!searchTerm||searchTerm.trim()===''){element.innerHTML=originalText;return;}if(!element.getAttribute('data-original-text')){element.setAttribute('data-original-text',originalText);}const regex=new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`,'gi');const highlightedText=originalText.replace(regex,'<span style="background-color:#FFE066;color:#333;font-weight:bold;padding:1px 2px;border-radius:2px;">$1</span>');element.innerHTML=highlightedText;}function highlightSearchTerm(element,searchTerm){if(!element.getAttribute('data-original-text')){element.setAttribute('data-original-text',element.textContent);}const originalText=element.getAttribute('data-original-text');if(!searchTerm||searchTerm.trim()===''){element.innerHTML=originalText;return;}const escapedSearchTerm=searchTerm.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');const regex=new RegExp(`(${escapedSearchTerm})`,'gi');const highlightedText=originalText.replace(regex,'<span class="search-highlight">$1</span>');element.innerHTML=highlightedText;}</script>
<div id="group_management_dropdown" class="group-management-dropdown" style="display: none;">
<div class="group-management-header">
<div class="group-management-title">群聊成员</div>
<svg class="group-settings-icon" onclick="showGroupSettings()" viewBox="0 0 24 24" fill="currentColor">
<path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11.03L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11.03C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
</svg>
</div>
<div class="group-members-list" id="group_members_display">
</div>
</div>
<div id="group_settings_modal" class="group-settings-modal">
<div class="group-settings-content">
<div class="group-settings-header">
<h3 class="group-settings-title">群聊设置</h3>
</div>
<div class="group-settings-body">
<div class="group-settings-section">
<div class="group-settings-section-title">群聊名称</div>
<input type="text" id="group_name_edit" class="group-settings-input" placeholder="输入群聊名称">
</div>
<div class="group-settings-section">
<div class="group-settings-section-title">群聊头像</div>
<div class="group-settings-avatar-container">
<div class="group-settings-avatar-preview" id="group_settings_avatar_preview" onclick="showGroupAvatarSelector()">
<div class="group-settings-default-avatar">群</div>
</div>
<div class="group-settings-avatar-text" onclick="showGroupAvatarSelector()">点击更换头像</div>
</div>
</div>
<div class="group-settings-section">
<div class="group-settings-section-title">群成员管理</div>
<div class="group-settings-member-list" id="group_members_edit">
</div>
</div>
</div>
<div class="group-settings-actions">
<button class="group-settings-btn group-settings-cancel-btn" onclick="closeGroupSettings()">取消</button>
<button class="group-settings-btn group-settings-save-btn" onclick="saveGroupSettings()">保存</button>
<button class="group-settings-btn group-settings-delete-btn" onclick="deleteCurrentGroup()">删除群聊</button>
</div>
</div>
</div>
<div id="group_chat_modal" class="group-chat-modal" style="display: none;">
<div class="group-chat-dialog">
<div class="group-chat-header">
新建
</div>
<div class="group-chat-content">
<div class="group-chat-option" onclick="openGroupCreateModal()">
<svg class="group-chat-option-icon" viewBox="0 0 1024 1024">
<path d="M320 896c-35.2 0-64-28.8-64-64V288c0-35.2 28.8-64 64-64s64 28.8 64 64v544c0 35.2-28.8 64-64 64zM704 896c-35.2 0-64-28.8-64-64V288c0-35.2 28.8-64 64-64s64 28.8 64 64v544c0 35.2-28.8 64-64 64zM512 1024c-106.039 0-192-85.961-192-192s85.961-192 192-192 192 85.961 192 192-85.961 192-192 192z m0-128c70.692 0 128-57.308 128-128s-57.308-128-128-128-128 57.308-128 128 57.308 128 128 128z"/>
</svg>
<span class="group-chat-option-text">发起群聊</span>
</div>
<div class="group-chat-option" onclick="openContactGroupModal()">
<svg class="group-chat-option-icon" viewBox="0 0 1024 1024">
<path d="M853.333 256H682.667c0-47.147-38.187-85.333-85.333-85.333H426.667c-47.147 0-85.333 38.187-85.333 85.333H170.667C123.52 256 85.333 294.187 85.333 341.333v426.667c0 47.147 38.187 85.333 85.333 85.333h682.667c47.147 0 85.333-38.187 85.333-85.333V341.333c0-47.147-38.187-85.333-85.333-85.333zM426.667 256h170.667v85.333H426.667V256zm426.667 512H170.667V341.333h170.667v42.667c0 23.573 19.093 42.667 42.667 42.667s42.667-19.093 42.667-42.667v-42.667h170.667v42.667c0 23.573 19.093 42.667 42.667 42.667s42.667-19.093 42.667-42.667v-42.667h170.667V768z"/>
</svg>
<span class="group-chat-option-text">新建分组</span>
</div>
<div class="group-chat-option" onclick="closeGroupChatModal()">
<svg class="group-chat-option-icon" viewBox="0 0 1024 1024">
<path d="M628.64 183.936a64 64 0 0 1 90.368 90.368L557.312 435.84l161.696 161.472a64 64 0 1 1-90.368 90.368L466.944 526.208 305.472 687.68a64 64 0 1 1-90.368-90.368L376.576 435.84 214.88 274.368a64 64 0 0 1 90.368-90.368l161.696 161.472 161.696-161.472z"/>
</svg>
<span class="group-chat-option-text">添加朋友</span>
</div>
<div class="group-chat-option" onclick="closeGroupChatModal()">
<svg class="group-chat-option-icon" viewBox="0 0 1024 1024">
<path d="M304 176h416c79.4 0 144 64.6 144 144v384c0 79.4-64.6 144-144 144H304c-79.4 0-144-64.6-144-144V320c0-79.4 64.6-144 144-144z m0 64c-44.2 0-80 35.8-80 80v384c0 44.2 35.8 80 80 80h416c44.2 0 80-35.8 80-80V320c0-44.2-35.8-80-80-80H304z"/>
</svg>
<span class="group-chat-option-text">扫一扫</span>
</div>
</div>
</div>
</div>
<div id="group_create_modal" class="group-create-modal" style="display: none;">
<div class="group-create-dialog">
<div class="group-create-header">
<span class="group-create-title">发起群聊</span>
<span class="group-create-close" onclick="closeGroupCreateModal()">&times;</span>
</div>
<div class="group-create-content">
<div class="group-name-section">
<label class="group-name-label">群聊名称</label>
<input
type="text" id="group_name_input" class="group-name-input" placeholder="请输入群聊名称" maxlength="20">
</div>
<div class="group-avatar-section">
<label class="group-avatar-label">群聊头像</label>
<div class="group-avatar-selector">
<div class="group-avatar-preview" id="group_avatar_preview" onclick="showAvatarSelector()">
<div class="default-group-avatar">+</div>
</div>
<div class="group-avatar-text" onclick="showAvatarSelector()">点击设置头像</div>
</div>
</div>
<div class="group-members-section">
<div class="group-members-label">选择群成员</div>
<div class="group-member-search">
<span class="group-search-icon">🔍</span>
<input
type="text" class="group-search-input" id="group_member_search" placeholder="搜索联系人..." oninput="filterGroupMembers()" onkeydown="handleGroupSearchKeydown(event)">
<span class="group-search-clear" id="group_search_clear" onclick="clearGroupSearch()">✕</span>
</div>
<div class="contact-list-container">
<div id="contact_list_for_group">
</div>
</div>
</div>
</div>
<div class="group-create-actions">
<button class="group-action-btn group-cancel-btn" onclick="closeGroupCreateModal()">
取消
</button>
<button class="group-action-btn group-confirm-btn" id="group_confirm_btn" onclick="createGroupChat()">
创建群聊
</button>
</div>
</div>
</div>
<div id="avatar_selector_modal" class="avatar-selector-modal" style="display: none;">
<div class="avatar-selector-dialog">
<div class="avatar-selector-header">
<span class="avatar-selector-title">选择群聊头像</span>
<span class="avatar-selector-close" onclick="closeAvatarSelector()">&times;</span>
</div>
<div class="avatar-selector-content">
<div class="avatar-selector-tabs">
<div class="avatar-tab active" onclick="switchAvatarTab('preset')">预设头像</div>
<div class="avatar-tab" onclick="switchAvatarTab('upload')">上传头像</div>
<div class="avatar-tab" onclick="switchAvatarTab('url')">输入链接</div>
</div>
<div class="avatar-selector-body">
<div id="preset_avatars" class="avatar-options active">
<div class="preset-avatar-grid">
</div>
</div>
<div id="upload_avatars" class="avatar-options">
<div class="upload-zone" onclick="triggerFileUpload()">
<div class="upload-icon">📁</div>
<div class="upload-text">点击上传图片</div>
<div class="upload-hint">支持 JPG、PNG 格式</div>
</div>
<input type="file" id="avatar_upload_input" accept="image
function showGroupChatModal() {
const modal = document.getElementById('group_chat_modal');
if (modal) {
modal.style.display = 'flex';
modal.style.zIndex = '9999';
modal.addEventListener('click', function(e) {
if (e.target === modal) {
closeGroupChatModal();
}
});
} else {
console.error('未找到弹窗元素 (ID: group_chat_modal)');
alert('弹窗元素未找到，请检查页面结构');
}
}
function closeGroupChatModal() {
const modal = document.getElementById('group_chat_modal');
if (modal) {
modal.style.display = 'none';
}
}
function openGroupCreateModal() {
closeGroupChatModal();
setTimeout(() => {
const modal = document.getElementById('group_create_modal');
if (modal) {
modal.style.display = 'flex';
loadContactsForGroup();
document.getElementById('group_name_input').value = '';
const searchInput = document.getElementById('group_member_search');
if (searchInput) {
searchInput.value = '';
}
const clearBtn = document.getElementById('group_search_clear');
if (clearBtn) {
clearBtn.classList.remove('show');
}
updateConfirmButtonState();
modal.addEventListener('click', function(e) {
if (e.target === modal) {
closeGroupCreateModal();
}
});
}
}, 150);
}
function closeGroupCreateModal() {
const modal = document.getElementById('group_create_modal');
if (modal) {
modal.style.display = 'none';
}
}
function loadContactsForGroup() {
const contactListContainer = document.getElementById('contact_list_for_group');
const homeChars = document.getElementById('QQ_home_chars');
if (!contactListContainer || !homeChars) return;
contactListContainer.innerHTML = '';
const contacts = homeChars.querySelectorAll('.QQ_home_usermsg');
if (contacts.length === 0) {
contactListContainer.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">暂无联系人</div>';
return;
}
contacts.forEach((contact, index) => {
const nameElement = contact.querySelector('.QQ_home_name');
const headElement = contact.querySelector('.QQ_home_head');
if (!nameElement) return;
if (contact.hasAttribute('data-group-type')) {
return;
}
const contactName = nameElement.textContent.trim();
let avatarStyle = '';
let hasRealAvatar = false;
if (headElement) {
const inlineStyle = headElement.getAttribute('style') || '';
const computedStyle = window.getComputedStyle(headElement);
const backgroundImage = computedStyle.backgroundImage;
const backgroundColor = computedStyle.backgroundColor;
avatarStyle = inlineStyle;
hasRealAvatar = inlineStyle.includes('background-image');
} else if (backgroundImage && backgroundImage !== 'none') {
avatarStyle = `background-image: ${backgroundImage}; background-size: cover; background-position: center;`;
hasRealAvatar = true;
} else if (backgroundColor && backgroundColor !== 'rgba(0, 0, 0, 0)' && backgroundColor !== 'transparent') {
avatarStyle = `background-color: ${backgroundColor};`;
}
if (!avatarStyle || avatarStyle === '') {
const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F'];
const color = colors[index % colors.length];
avatarStyle = `background-color: ${color};`;
}
} else {
const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F'];
const color = colors[index % colors.length];
avatarStyle = `background-color: ${color};`;
}
const contactItem = document.createElement('div');
contactItem.className = 'contact-item';
contactItem.setAttribute('data-contact-name', contactName);
contactItem.setAttribute('data-contact-index', index);
contactItem.onclick = () => toggleContactSelection(contactItem);
contactItem.innerHTML = `
<input
type="checkbox" id="contact_${index}" class="contact-checkbox" data-contact-name="${contactName}">
<div class="contact-avatar" style="${avatarStyle}">
${!hasRealAvatar ?
`<span style="color: white; font-size: 12px; font-weight: bold; display: flex; align-items: center; justify-content: center; height: 100%;">${contactName.charAt(0)}</span>` :
''
}
</div>
<span class="contact-name">${contactName}</span>
`;
contactListContainer.appendChild(contactItem);
});
}
function toggleContactSelection(contactItem) {
const checkbox = contactItem.querySelector('.contact-checkbox');
if (contactItem.classList.contains('selected')) {
contactItem.classList.remove('selected');
if (checkbox) checkbox.checked = false;
} else {
contactItem.classList.add('selected');
if (checkbox) checkbox.checked = true;
}
updateConfirmButtonState();
const contactName = contactItem.getAttribute('data-contact-name');
const isSelected = contactItem.classList.contains('selected');
}
function highlightSearchTerm(text, searchTerm) {
if (!searchTerm || searchTerm.trim() === '') {
return text;
}
const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
return text.replace(regex, '<span style="background-color: #FFE066; color: #333; font-weight: bold; padding: 1px 2px; border-radius: 2px;">$1</span>');
}
function filterGroupMembers() {
const searchInput = document.getElementById('group_member_search');
const clearBtn = document.getElementById('group_search_clear');
const contactItems = document.querySelectorAll('#contact_list_for_group .contact-item');
const contactListContainer = document.getElementById('contact_list_for_group');
if (!searchInput || !contactItems.length) return;
const searchTerm = searchInput.value.toLowerCase().trim();
const originalSearchTerm = searchInput.value.trim();
if (searchTerm.length> 0) {
clearBtn.classList.add('show');
} else {
clearBtn.classList.remove('show');
}
let visibleCount = 0;
contactItems.forEach(item => {
const originalContactName = item.getAttribute('data-contact-name');
const contactName = originalContactName.toLowerCase();
const nameElement = item.querySelector('.contact-name');
if (contactName.includes(searchTerm)) {
item.style.display = 'flex';
visibleCount++;
if (searchTerm.length> 0) {
nameElement.innerHTML = highlightSearchTerm(originalContactName, originalSearchTerm);
} else {
nameElement.textContent = originalContactName;
}
} else {
item.style.display = 'none';
nameElement.textContent = originalContactName;
}
});
let noResultsDiv = contactListContainer.querySelector('.no-results');
if (visibleCount === 0 && searchTerm.length> 0) {
if (!noResultsDiv) {
noResultsDiv = document.createElement('div');
noResultsDiv.className = 'no-results';
noResultsDiv.textContent = '未找到匹配的联系人';
contactListContainer.appendChild(noResultsDiv);
}
noResultsDiv.style.display = 'block';
} else if (noResultsDiv) {
noResultsDiv.style.display = 'none';
}
}
function clearGroupSearch() {
const searchInput = document.getElementById('group_member_search');
const clearBtn = document.getElementById('group_search_clear');
if (searchInput) {
searchInput.value = '';
searchInput.focus();
}
if (clearBtn) {
clearBtn.classList.remove('show');
}
const contactItems = document.querySelectorAll('#contact_list_for_group .contact-item');
contactItems.forEach(item => {
const nameElement = item.querySelector('.contact-name');
const originalName = item.getAttribute('data-contact-name');
item.style.display = 'flex';
nameElement.textContent = originalName;
});
const noResultsDiv = document.getElementById('contact_list_for_group').querySelector('.no-results');
if (noResultsDiv) {
noResultsDiv.style.display = 'none';
}
}
function handleGroupSearchKeydown(event) {
if (event.key === 'Escape') {
clearGroupSearch();
} else if (event.key === 'Enter') {
const visibleItems = document.querySelectorAll('#contact_list_for_group .contact-item[style*="flex"], #contact_list_for_group .contact-item:not([style*="none"])');
if (visibleItems.length === 1) {
toggleContactSelection(visibleItems[0]);
}
}
}
function updateConfirmButtonState() {
const confirmBtn = document.getElementById('group_confirm_btn');
const groupNameInput = document.getElementById('group_name_input');
const selectedItems = document.querySelectorAll('#contact_list_for_group .contact-item.selected');
if (!confirmBtn || !groupNameInput) return;
const hasName = groupNameInput.value.trim().length> 0;
const hasMembers = selectedItems.length> 0;
confirmBtn.disabled = !(hasName && hasMembers);
console.log('更新群聊确认按钮状态:', {
hasName,
hasMembers,
disabled: confirmBtn.disabled,
nameLength: groupNameInput.value.trim().length,
selectedCount: selectedItems.length
});
}
function generateGroupAvatar(members) {
const colors = [
'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)'
];
return colors[Math.floor(Math.random() * colors.length)];
}
function getCurrentTime() {
const now = new Date();
const hours = now.getHours().toString().padStart(2, '0');
const minutes = now.getMinutes().toString().padStart(2, '0');
return `${hours}:${minutes}`;
}
async function saveGroupToStorage(groupData) {
const success = await addGroupToWorldbook(groupData);
if (success) {
} else {
console.error('保存群聊到世界书失败');
}
return success;
}
async function loadGroupChatsFromWorldbook() {
const groups = [];
try {
if (!worldbook || !entries) {
console.warn('世界书功能不可用，无法加载群聊数据');
return groups;
}
const groupEntries = entries.filter(e => e.comment && e.comment.startsWith("手机-群聊-"));
if (groupEntries.length === 0) {
return groups;
}
groupEntries.forEach(entry => {
if (entry && entry.content) {
const originalGroupName = entry.comment.replace('手机-群聊-', '');
const lines = entry.content.split('\n');
let groupData = null;
for (const line of lines) {
const trimmed = line.trim();
if (trimmed.startsWith('[') && trimmed.endsWith(']')) {
const name = trimmed.slice(1, -1);
groupData = {
name,
type: 'group',
id: `group_${originalGroupName.replace(/[^a-zA-Z0-9\u4e00-\u9fff]/g, '_')}`
};
} else if (groupData && trimmed.includes('类型=群聊')) {
continue;
} else if (groupData && trimmed.startsWith('成员=')) {
groupData.members = trimmed.substring(3).split(/[,，]/).map(m => m.trim()).filter(m => m);
} else if (groupData && trimmed.startsWith('描述=')) {
groupData.description = trimmed.substring(3);
} else if (groupData && trimmed.startsWith('头像=')) {
const avatarReference = trimmed.substring(3);
if (avatarReference.startsWith('data:')) {
groupData.avatar = avatarReference;
groupData.avatarData = avatarReference;
} else {
groupData.avatar = avatarReference;
}
}
}
if (groupData && groupData.name && groupData.members && groupData.members.length> 0) {
groups.push(groupData);
if (!QQ_Groups.includes(groupData.name)) {
QQ_Groups.push(groupData.name);
}
const existingGroupElement = $(`.QQ_home_usermsg[data-name='${groupData.name}'][data-group-type='true']`);
const groupAlreadyExists = existingGroupElement.length> 0;
if (!QQ_msgjson.群聊[groupData.name]) {
QQ_msgjson.群聊[groupData.name] = {
members: groupData.members || [],
msgs: []
};
} else {
QQ_msgjson.群聊[groupData.name].members = groupData.members || [];
}
if (!groupAlreadyExists) {
if (!QQ_GroupInitializedSet.has(groupData.name)) {
AddNewGroup(groupData.name, groupData.avatar || 'https:
} else {
QQ_GroupInitializedSet.add(groupData.name);
}
} else {
QQ_GroupInitializedSet.add(groupData.name);
}
setTimeout(() => {
updateGroupLastMessageDisplay(groupData.name);
}, 300);
} else {
}
}
});
} catch (error) {
console.error('从独立世界书条目加载群聊数据失败:', error);
}
return groups;
}
async function QQ_Enhance_Group_Metadata() {
try {
if (!worldbook || !entries) {
console.warn('世界书功能不可用，跳过群聊元数据增强');
return;
}
const detailedGroups = await loadGroupChatsFromWorldbook();
if (!detailedGroups || detailedGroups.length === 0) {
return;
}
window.QQ_Group_Chats_Data = detailedGroups;
detailedGroups.forEach(groupData => {
if (groupData.name && !QQ_Groups.includes(groupData.name)) {
QQ_Groups.push(groupData.name);
}
});
detailedGroups.forEach(groupData => {
if (groupData && groupData.name) {
const contactElement = document.querySelector(`#QQ_home_chars .QQ_home_usermsg[data-name='${groupData.name}']`);
if (contactElement) {
updateGroupAvatarInElement(contactElement, groupData);
}
const messageElement = document.querySelector(`#QQ_message_list_chars .QQ_home_usermsg[data-name='${groupData.name}']`);
if (messageElement) {
updateGroupAvatarInElement(messageElement, groupData);
}
setTimeout(() => {
updateGroupLastMessageDisplay(groupData.name);
}, 300);
}
});
try {
await QQ_UpdateMessageList();
} catch (error) {
console.error('刷新消息列表失败:', error);
}
} catch (error) {
console.error('群聊元数据增强失败:', error);
}
}
function initGroupChatFeature() {
const contactsAddBtn = document.getElementById('contacts_add_btn');
if (contactsAddBtn) {
contactsAddBtn.onclick = function(e) {
e.preventDefault();
e.stopPropagation();
showGroupChatModal();
};
} else {
console.warn('未找到联系人页面的+按钮 (ID: contacts_add_btn)');
}
const messagesAddBtn = document.getElementById('messages_add_btn');
if (messagesAddBtn) {
messagesAddBtn.onclick = function(e) {
e.preventDefault();
e.stopPropagation();
showGroupChatModal();
};
} else {
console.warn('未找到消息页面的+按钮 (ID: messages_add_btn)');
}
const groupNameInput = document.getElementById('group_name_input');
if (groupNameInput) {
groupNameInput.addEventListener('input', updateConfirmButtonState);
groupNameInput.addEventListener('keydown', function(e) {
if (e.key === 'Enter' && !document.getElementById('group_confirm_btn').disabled) {
createGroupChat();
}
});
}
}
let groupChatInitialized = false;
function protectQQGroups() {
if (!Array.isArray(QQ_Groups)) {
console.warn('QQ_Groups不是数组，重新初始化');
QQ_Groups = [];
}
}
protectQQGroups();
function ensureQQGroupsIntegrity() {
if (groupChatInitialized && QQ_Groups.length === 0) {
console.warn('检测到QQ_Groups为空，但不自动重新加载（避免重复）');
const contactsGroups = document.querySelectorAll('#QQ_home_chars [data-group-type="true"]');
const messageGroups = document.querySelectorAll('#QQ_message_list_chars [data-group-type="true"]');
contactsGroups.forEach(element => {
const groupName = element.getAttribute('data-group-name');
if (groupName && !QQ_Groups.includes(groupName)) {
QQ_Groups.push(groupName);
}
});
messageGroups.forEach(element => {
const groupName = element.getAttribute('data-group-name');
if (groupName && !QQ_Groups.includes(groupName)) {
QQ_Groups.push(groupName);
}
});
}
}
function ensureQQGroupsIntegrityOnClick(groupName) {
if (!QQ_Groups.includes(groupName)) {
console.warn(`群聊 ${groupName} 不在QQ_Groups中，添加中...`);
QQ_Groups.push(groupName);
}
if (!QQ_msgjson.群聊) {
if (window.QQ_ChatDataRestored) {
console.warn('⚠️ 检测到聊天数据已从备份恢复，但群聊数据为空，这可能表示数据丢失');
}
QQ_msgjson.群聊 = {};
}
if (!QQ_msgjson.群聊[groupName]) {
QQ_msgjson.群聊[groupName] = {
members: [],
msgs: []
};
}
}
function processGroupAvatar(groupData) {
let avatarDisplay = '';
const avatarSrc = groupData.avatarData || groupData.avatar;
if (avatarSrc && (avatarSrc.startsWith('data:') || avatarSrc.startsWith('http'))) {
avatarDisplay = `<img src="${avatarSrc}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
console.log('使用头像图片，类型:', avatarSrc.startsWith('data:') ? 'base64' : 'URL');
} else {
avatarDisplay = '群';
}
return avatarDisplay;
}
async function initGroupChatOnce() {
if (groupChatInitialized) {
return;
}
initGroupChatFeature();
const contactsGroups = document.querySelectorAll('#QQ_home_chars [data-group-type="true"]');
const messageGroups = document.querySelectorAll('#QQ_message_list_chars [data-group-type="true"]');
if (worldbook && entries) {
if (QQ_Groups.length> 0 && contactsGroups.length === 0) {
await QQ_Enhance_Group_Metadata();
} else if (QQ_Groups.length === 0) {
} else {
}
} else {
}
groupChatInitialized = true;
}
window.resetGroupChatState = function() {
groupChatInitialized = false;
};
window.forceReloadGroupChats = async function() {
if (!worldbook || !entries) {
console.error('worldbook或entries未准备好');
return;
}
try {
await QQ_Enhance_Group_Metadata();
} catch (error) {
console.error('强制重新加载群聊失败:', error);
}
};
if (document.readyState === 'loading') {
document.addEventListener('DOMContentLoaded', initGroupChatOnce);
} else {
setTimeout(initGroupChatOnce, 1000);
}
window.testGroupChat = function() {
showGroupChatModal();
};
document.addEventListener('keydown', function(e) {
if (e.ctrlKey && e.key === 'g') {
e.preventDefault();
showGroupChatModal();
}
});
var contactGroups = [];
var draggedElement = null;
var draggedFromGroup = null;
function getCurrentCharacterId() {
try {
let result = null;
let source = '';
if (window.SillyTavern && window.SillyTavern.characterId !== undefined) {
result = window.SillyTavern.characterId;
source = 'SillyTavern.characterId';
}
else if (window.SillyTavern && typeof window.SillyTavern.getContext === 'function') {
const context = window.SillyTavern.getContext();
if (context && context.characterId !== undefined) {
result = context.characterId;
source = 'SillyTavern.getContext().characterId';
}
}
else if (window.this_chid !== undefined) {
result = window.this_chid;
source = 'window.this_chid';
}
else {
const urlParams = new URLSearchParams(window.location.search);
const charId = urlParams.get('charId') || urlParams.get('characterId');
if (charId) {
result = charId;
source = 'URL参数';
}
}
if (!result && window.currentCharacterName) {
result = window.currentCharacterName;
source = 'window.currentCharacterName';
}
if (!result) {
const headerName = document.querySelector('.QQ_home_nick')?.textContent?.trim();
if (headerName) {
result = headerName;
source = '页面header角色名';
}
}
if (!result) {
result = 'default';
source = '默认值';
}
console.log(`🆔 获取角色ID: "${result}" (来源: ${source})`);
return result;
} catch (error) {
console.warn('获取角色ID失败，使用默认值:', error);
return 'default';
}
}
let currentCharId = null;
function checkCharacterChange() {
const newCharId = getCurrentCharacterId();
if (currentCharId !== newCharId) {
currentCharId = newCharId;
QQ_LoadContactGroups();
renderContactGroups();
}
}
async function QQ_LoadContactGroups() {
try {
const charId = getCurrentCharacterId() || 'default';
if (!worldbook || !entries) {
console.warn('世界书功能不可用，使用空分组数据');
contactGroups.length = 0;
return;
}
const comment = `QQ_分组备份_${charId}`;
const targetEntry = entries.find(entry => entry.comment === comment);
if (targetEntry && targetEntry.content) {
try {
const groups = JSON.parse(targetEntry.content);
if (Array.isArray(groups)) {
contactGroups.length = 0;
contactGroups.push(...groups);
} else {
console.warn('世界书分组数据格式无效，使用空数组');
contactGroups.length = 0;
}
} catch (parseError) {
console.error('解析世界书分组数据失败:', parseError);
contactGroups.length = 0;
}
} else {
contactGroups.length = 0;
}
} catch (error) {
console.error('从世界书加载分组时出错:', error);
contactGroups.length = 0;
}
}
QQ_LoadContactGroups().catch(error => {
console.error('初始化分组数据失败:', error);
});
window.QQ_ForceReloadContactGroups = async function() {
try {
const characterId = getCurrentCharacterId() || 'default';
contactGroups.length = 0;
await QQ_LoadContactGroups();
if (contactGroups.length> 0) {
console.log('📊 分组详情:', contactGroups.map(g => `${g.name}(${g.contacts.length}人)`).join(', '));
}
return contactGroups;
} catch (error) {
console.error('💥 强制重新加载分组数据失败:', error);
return [];
}
};
async function saveGroupsToStorage() {
try {
const charId = getCurrentCharacterId() || 'default';
console.log(`📊 当前分组数据: ${contactGroups.length}个分组`, contactGroups.map(g => `${g.name}(${g.contacts.length}人)`));
if (!worldbook || !entries) {
console.error('❌ 世界书功能不可用，无法保存分组数据');
return false;
}
const comment = `QQ_分组备份_${charId}`;
let targetEntry = entries.find(entry => entry.comment === comment);
const jsonData = JSON.stringify(contactGroups, null, 2);
if (targetEntry) {
await setLorebookEntries(worldbook, [{
uid: targetEntry.uid,
content: jsonData,
}]);
targetEntry.content = jsonData;
} else {
await createLorebookEntry(worldbook, {
comment: comment,
key: [`此世界书永不触发_分组_${charId}`],
content: jsonData,
position: "at_depth_as_system",
type: "selective",
depth: 0,
exclude_recursion: true,
order: 9998,
enabled: true,
});
entries = await getLorebookEntries(worldbook);
}
await QQ_SafeSaveWorldInfo(`角色${charId}的分组数据`);
entries = await getLorebookEntries(worldbook);
const verifyEntry = entries.find(entry => entry.comment === comment);
if (verifyEntry && verifyEntry.content && verifyEntry.content.includes('"name"')) {
return true;
} else {
console.error('❌ 分组数据保存验证失败');
console.error('验证条目:', verifyEntry ? '找到条目但内容异常' : '未找到条目');
return true;
}
} catch (error) {
console.error('❌ 保存分组到世界书时出错:', error);
return false;
}
}
async function initContactGroups() {
currentCharId = getCurrentCharacterId();
await QQ_LoadContactGroups();
await renderContactGroups();
initGroupDragAndDrop();
setInterval(checkCharacterChange, 1000);
}
function initGroupDragAndDrop() {
}
function showNewGroupModal() {
const modal = document.getElementById('new_group_modal');
const input = document.getElementById('new_group_name_input');
if (modal && input) {
modal.style.display = 'flex';
input.value = '';
input.focus();
modal.addEventListener('click', function(e) {
if (e.target === modal) {
closeNewGroupModal();
}
});
}
}
function closeNewGroupModal() {
const modal = document.getElementById('new_group_modal');
if (modal) {
modal.style.display = 'none';
}
}
async function createNewContactGroup() {
await QQ_ForceReloadContactGroups();
const input = document.getElementById('new_group_name_input');
if (!input) {
console.error('未找到分组名称输入框元素');
alert('界面元素未找到，请刷新页面重试');
return;
}
const groupName = input.value.trim();
if (!groupName) {
alert('请输入分组名称');
return;
}
if (contactGroups.some(group => group.name === groupName)) {
alert('分组名称已存在');
return;
}
const charId = getCurrentCharacterId() || 'default';
const newGroup = {
id: 'group_' + Date.now(),
name: groupName,
contacts: [],
collapsed: false,
order: contactGroups.length
};
const originalGroups = [...contactGroups];
contactGroups.push(newGroup);
try {
const saveResult = await saveGroupsToStorage();
if (saveResult) {
closeNewGroupModal();
alert('分组"' + groupName + '"创建成功！');
await QQ_ForceReloadContactGroups();
await renderContactGroups();
} else {
throw new Error('保存函数返回失败');
}
} catch (error) {
console.error('❌ 保存新分组失败:', error);
contactGroups.length = 0;
contactGroups.push(...originalGroups);
alert('分组创建失败，请重试: ' + error.message);
}
}
function handleNewGroupKeydown(event) {
if (event.key === 'Enter') {
event.preventDefault();
createNewContactGroup();
} else if (event.key === 'Escape') {
event.preventDefault();
closeNewGroupModal();
}
}
function QQ_Debug_Groups_Sync() {
const charId = getCurrentCharacterId() || 'default';
console.log('📊 分组详情:', contactGroups.map(g => `${g.name}(${g.contacts.length}人)`));
const expectedComment = `QQ_分组备份_${charId}`;
const worldbookEntry = entries?.find(entry => entry.comment === expectedComment);
if (worldbookEntry) {
try {
const worldbookData = JSON.parse(worldbookEntry.content);
console.log(`📚 世界书中分组数据: ${Array.isArray(worldbookData) ? worldbookData.length : '0'}个分组`);
console.log('📊 世界书分组详情:', Array.isArray(worldbookData) ? worldbookData.map(g => `${g.name}(${g.contacts?.length || 0}人)`) : '无数据');
if (contactGroups.length === worldbookData.length) {
} else {
console.warn('⚠️ 内存和世界书数据数量不一致');
}
} catch (e) {
console.error('❌ 世界书数据解析失败:', e);
}
} else {
console.warn(`⚠️ 未找到世界书条目: ${expectedComment}`);
}
return {
characterId: charId,
memoryGroups: contactGroups.length,
worldbookEntry: !!worldbookEntry,
comment: expectedComment
};
}
window.createNewContactGroup = createNewContactGroup;
window.closeNewGroupModal = closeNewGroupModal;
window.showNewGroupModal = showNewGroupModal;
window.handleNewGroupKeydown = handleNewGroupKeydown;
window.openContactGroupModal = openContactGroupModal;
window.QQ_Debug_Groups_Sync = QQ_Debug_Groups_Sync;
async function renderContactGroups() {
const contactsContainer = document.getElementById('QQ_home_chars');
if (!contactsContainer) return;
const $originalGroupChats = $(contactsContainer).find('.QQ_home_usermsg[data-group-type="true"]');
const $originalContacts = $(contactsContainer).find('.QQ_home_usermsg:not([data-group-type="true"])');
$(contactsContainer).empty();
if ($originalGroupChats.length> 0) {
const $groupChatSection = $('<div></div>');
$originalGroupChats.each(function() {
const groupName = $(this).attr('data-name');
if (groupName && QQ_Groups.includes(groupName)) {
$(this).appendTo($groupChatSection);
} else {
}
});
if ($groupChatSection.children().length> 0) {
$groupChatSection.appendTo($(contactsContainer));
}
}
contactGroups.sort((a, b) => a.order - b.order).forEach(group => {
const groupElement = createGroupElement(group);
contactsContainer.appendChild(groupElement);
});
const $ungroupedContacts = $originalContacts.filter(function() {
const contactName = $(this).find('.QQ_home_name').text().trim();
return !isContactInAnyGroup(contactName);
});
if ($ungroupedContacts.length> 0) {
const $ungroupedSection = $(`
<div class="ungrouped-contacts">
<div class="ungrouped-header">未分组联系人</div>
</div>
`);
const $dropZone = $('<div class="drop-zone ungrouped-drop-zone" data-group-id="ungrouped"></div>');
$ungroupedContacts.each(function() {
$(this).attr('draggable', 'true');
$(this).appendTo($ungroupedSection);
});
$dropZone.appendTo($ungroupedSection);
$ungroupedSection.appendTo($(contactsContainer));
}
}
function createGroupElement(group) {
const groupDiv = document.createElement('div');
groupDiv.className = 'contact-group';
groupDiv.setAttribute('data-group-id', group.id);
const isCollapsed = group.collapsed;
const contactCount = group.contacts.length;
groupDiv.innerHTML = `
<div class="group-header" onclick="toggleGroup('${group.id}')">
<span class="group-drag-handle" onmousedown="startGroupDrag(event, '${group.id}')">⋮⋮</span>
<span class="group-toggle ${isCollapsed ? 'collapsed' : ''}">▼</span>
<span class="group-name" onclick="editGroupName(event, '${group.id}')" data-group-id="${group.id}">${group.name}</span>
<span class="group-count">${contactCount}</span>
<span class="group-delete-btn" onclick="deleteContactGroup(event, '${group.id}')">×</span>
</div>
<div class="group-content ${isCollapsed ? 'collapsed' : 'expanded'}">
${group.contacts.map(contact => {
const contactHtml = contact.html.replace(
'class="QQ_home_usermsg"',
'class="QQ_home_usermsg" draggable="true"'
);
return contactHtml;
}).join('')}
</div>
<div class="drop-zone" data-group-id="${group.id}"></div>
`;
return groupDiv;
}
function isContactInAnyGroup(contactName) {
return contactGroups.some(group =>
group.contacts.some(contact => contact.name === contactName)
);
}
async function toggleGroup(groupId) {
await QQ_ForceReloadContactGroups();
const group = contactGroups.find(g => g.id === groupId);
if (!group) return;
group.collapsed = !group.collapsed;
await saveGroupsToStorage();
const groupElement = document.querySelector(`[data-group-id="${groupId}"]`);
const toggle = groupElement.querySelector('.group-toggle');
const content = groupElement.querySelector('.group-content');
if (group.collapsed) {
toggle.classList.add('collapsed');
content.classList.remove('expanded');
content.classList.add('collapsed');
} else {
toggle.classList.remove('collapsed');
content.classList.remove('collapsed');
content.classList.add('expanded');
}
}
function editGroupName(event, groupId) {
event.stopPropagation();
const groupNameElement = event.target;
const currentName = groupNameElement.textContent;
const input = document.createElement('input');
input.type = 'text';
input.value = currentName;
input.className = 'group-name editing';
input.maxLength = 15;
groupNameElement.replaceWith(input);
input.focus();
input.select();
const saveEdit = async () => {
const newName = input.value.trim();
if (newName && newName !== currentName) {
await QQ_ForceReloadContactGroups();
if (contactGroups.some(g => g.id !== groupId && g.name === newName)) {
alert('分组名称已存在');
input.focus();
return;
}
const group = contactGroups.find(g => g.id === groupId);
if (group) {
group.name = newName;
await saveGroupsToStorage();
}
}
const newSpan = document.createElement('span');
newSpan.className = 'group-name';
newSpan.setAttribute('data-group-id', groupId);
newSpan.textContent = newName || currentName;
newSpan.onclick = (e) => editGroupName(e, groupId);
input.replaceWith(newSpan);
};
input.addEventListener('blur', saveEdit);
input.addEventListener('keydown', (e) => {
if (e.key === 'Enter') {
saveEdit();
} else if (e.key === 'Escape') {
const newSpan = document.createElement('span');
newSpan.className = 'group-name';
newSpan.setAttribute('data-group-id', groupId);
newSpan.textContent = currentName;
newSpan.onclick = (e) => editGroupName(e, groupId);
input.replaceWith(newSpan);
}
});
}
async function deleteContactGroup(event, groupId) {
event.stopPropagation();
await QQ_ForceReloadContactGroups();
const group = contactGroups.find(g => g.id === groupId);
if (!group) return;
if (confirm(`确定要删除分组"${group.name}"吗？\n分组中的联系人将移动到未分组区域。`)) {
console.log(`🗑️ 删除分组: ${group.name} (${group.contacts.length}人)`);
const charId = getCurrentCharacterId() || 'default';
const originalGroups = [...contactGroups];
try {
contactGroups = contactGroups.filter(g => g.id !== groupId);
const saveResult = await saveGroupsToStorage();
if (saveResult) {
await QQ_ForceReloadContactGroups();
await renderContactGroups();
} else {
throw new Error('保存函数返回失败');
}
} catch (error) {
console.error('❌ 删除分组失败:', error);
contactGroups.length = 0;
contactGroups.push(...originalGroups);
alert('删除分组失败，请重试: ' + error.message);
}
}
}
function initGroupDragAndDrop() {
document.addEventListener('dragstart', handleContactDragStart);
document.addEventListener('dragover', handleDragOver);
document.addEventListener('drop', handleContactDrop);
document.addEventListener('dragend', handleDragEnd);
setTimeout(() => {
const contacts = document.querySelectorAll('.QQ_home_usermsg:not([data-group-type])');
contacts.forEach(contact => {
contact.draggable = true;
contact.addEventListener('dragstart', handleContactDragStart);
});
}, 200);
}
function handleContactDragStart(event) {
const contact = event.target.closest('.QQ_home_usermsg');
if (!contact) return;
draggedElement = contact;
contact.classList.add('dragging');
const groupContent = contact.closest('.group-content');
if (groupContent) {
const groupElement = groupContent.closest('.contact-group');
draggedFromGroup = groupElement ? groupElement.getAttribute('data-group-id') : null;
} else {
draggedFromGroup = null;
}
document.querySelectorAll('.drop-zone').forEach(zone => {
zone.classList.add('active');
});
event.dataTransfer.effectAllowed = 'move';
}
function handleDragOver(event) {
event.preventDefault();
event.dataTransfer.dropEffect = 'move';
const dropZone = event.target.closest('.drop-zone');
if (dropZone) {
dropZone.style.borderColor = '#199AFF';
dropZone.style.backgroundColor = 'rgba(25, 154, 255, 0.2)';
}
}
async function handleContactDrop(event) {
event.preventDefault();
const dropZone = event.target.closest('.drop-zone');
if (!dropZone || !draggedElement) return;
await QQ_ForceReloadContactGroups();
const targetGroupId = dropZone.getAttribute('data-group-id');
const contactName = draggedElement.querySelector('.QQ_home_name')?.textContent?.trim();
if (!contactName) return;
if (draggedFromGroup) {
const fromGroup = contactGroups.find(g => g.id === draggedFromGroup);
if (fromGroup) {
fromGroup.contacts = fromGroup.contacts.filter(c => c.name !== contactName);
}
}
if (targetGroupId === 'ungrouped') {
} else {
const targetGroup = contactGroups.find(g => g.id === targetGroupId);
if (targetGroup) {
if (!targetGroup.contacts.some(c => c.name === contactName)) {
targetGroup.contacts.push({
name: contactName,
html: draggedElement.outerHTML
});
}
}
}
await saveGroupsToStorage();
renderContactGroups();
setTimeout(() => {
initGroupDragAndDrop();
}, 100);
}
function handleDragEnd(event) {
if (draggedElement) {
draggedElement.classList.remove('dragging');
draggedElement = null;
}
draggedFromGroup = null;
document.querySelectorAll('.drop-zone').forEach(zone => {
zone.classList.remove('active');
zone.style.borderColor = '';
zone.style.backgroundColor = '';
});
}
function startGroupDrag(event, groupId) {
event.stopPropagation();
}
function handleNewGroupKeydown(event) {
if (event.key === 'Enter') {
createNewContactGroup();
} else if (event.key === 'Escape') {
closeNewGroupModal();
}
}
function openContactGroupModal() {
closeGroupChatModal();
setTimeout(() => {
showNewGroupModal();
}, 150);
}
let selectedAvatarData = null;
function handleChatTitleClick(element) {
console.log('点击的聊天标题:', element.textContent.trim());
console.log('元素数据属性:', {
'data-name': element.getAttribute('data-name'),
'data-group-id': element.getAttribute('data-group-id')
});
const chatPageContainer = element.closest('.QQ_chat_page');
if (!chatPageContainer) {
return;
}
console.log('聊天页面容器的data-name:', chatPageContainer.getAttribute('data-name'));
console.log('聊天页面容器的data-group-id:', chatPageContainer.getAttribute('data-group-id'));
const chatName = element.textContent.trim();
const dataName = element.getAttribute('data-name') || chatPageContainer.getAttribute('data-name');
const groupId = element.getAttribute('data-group-id') || chatPageContainer.getAttribute('data-group-id');
if (window.QQ_Groups && Array.isArray(window.QQ_Groups)) {
const matchingGroups = window.QQ_Groups.filter(g =>
g.name === chatName ||
g.name === dataName ||
g.id === groupId ||
chatName.includes(g.name) ||
(dataName && dataName.includes(g.name))
);
}
const isGroupChat = checkIfGroupChat(chatName);
if (isGroupChat) {
const cleanGroupName = chatName.replace(/\s*\(\d+人\)\s*$/, '').trim();
let groupData = null;
if (QQ_msgjson && QQ_msgjson.群聊 && QQ_msgjson.群聊[cleanGroupName]) {
const msgGroupData = QQ_msgjson.群聊[cleanGroupName];
groupData = {
name: cleanGroupName,
members: msgGroupData.members || [],
avatar: 'https:
};
}
if (!groupData) {
groupData = {
name: cleanGroupName,
members: ['成员1', '成员2', '成员3'],
avatar: 'https:
};
console.warn(`群聊 ${cleanGroupName} 数据未找到，使用默认数据`);
}
showGroupManagementMenu(groupData, element);
} else {
QQ_ShowCharacterSpirit(chatName);
}
}
function checkIfGroupChat(chatName) {
const cleanChatName = chatName.replace(/\s*\(\d+人\)\s*$/, '').trim();
return QQ_Groups.includes(cleanChatName);
}
function loadGroupMembers(groupName, memberListContainer) {
const groupMembers = getGroupMembers(groupName);
memberListContainer.innerHTML = '';
if (groupMembers.length === 0) {
memberListContainer.innerHTML = '<div class="no-members">暂无群成员</div>';
return;
}
groupMembers.forEach(member => {
const memberItem = document.createElement('div');
memberItem.className = 'group-member-item';
memberItem.innerHTML = `
<div class="member-avatar" style="background-image: url('${member.avatar}')"></div>
<div class="member-name">${member.name}</div>
`;
memberListContainer.appendChild(memberItem);
});
}
function getGroupMembers(groupName) {
const cleanGroupName = groupName.replace(/\s*\(\d+人\)\s*$/, '').trim();
try {
if (QQ_msgjson && QQ_msgjson.群聊 && QQ_msgjson.群聊[cleanGroupName]) {
const groupData = QQ_msgjson.群聊[cleanGroupName];
if (groupData.members && Array.isArray(groupData.members)) {
const avatarList = QQ_RandomHeadList || [
'http:
'http:
'http:
'http:
'http:
];
return groupData.members.map((memberName, index) => ({
name: memberName,
avatar: avatarList[index % avatarList.length]
}));
}
}
console.warn(`群聊 ${cleanGroupName} 的成员信息未找到，使用示例成员`);
} catch (error) {
console.error('从QQ_msgjson获取群成员失败:', error);
}
return generateSampleMembers(cleanGroupName);
}
function generateSampleMembers(groupName) {
const sampleMembers = [
{ name: '群主', avatar: 'http:
{ name: '管理员', avatar: 'http:
{ name: '成员A', avatar: 'http:
{ name: '成员B', avatar: 'http:
{ name: '成员C', avatar: 'http:
];
return sampleMembers;
}
function sendGroupMessage(groupName, message) {
const timestamp = new Date().toLocaleTimeString('zh-CN', {
hour12: false,
hour: '2-digit',
minute: '2-digit'
});
const members = getGroupMembers(groupName);
setTimeout(() => {
const replyCount = Math.floor(Math.random() * 2) + 1;
const repliedMembers = [];
for (let i = 0; i <replyCount; i++) {
const randomMember = members[Math.floor(Math.random() * members.length)];
if (!repliedMembers.includes(randomMember.name)) {
repliedMembers.push(randomMember.name);
const replyMessage = generateGroupReply(message);
}
}
}, Math.random() * 3000 + 1000);
}
function generateGroupReply(originalMessage) {
const replies = [
'同意！',
'哈哈哈',
'好的',
'收到',
'确实如此',
'我也觉得',
'说得对',
'+1',
'支持',
'赞同'
];
return replies[Math.floor(Math.random() * replies.length)];
}
window.handleChatTitleClick = handleChatTitleClick;
window.sendGroupMessage = sendGroupMessage;
function showAvatarSelector() {
const modal = document.getElementById('avatar_selector_modal');
if (modal) {
modal.style.display = 'flex';
loadPresetAvatars();
const confirmBtn = document.getElementById('avatar_confirm_btn');
if (confirmBtn) {
confirmBtn.disabled = false;
}
updateAvatarConfirmButton();
modal.addEventListener('click', function(e) {
if (e.target === modal) {
closeAvatarSelector();
}
});
}
}
function closeAvatarSelector() {
const modal = document.getElementById('avatar_selector_modal');
if (modal) {
modal.style.display = 'none';
}
if (window.isSelectingGroupAvatar) {
window.isSelectingGroupAvatar = false;
window.currentAvatarGroup = null;
}
}
function switchAvatarTab(tabType) {
document.querySelectorAll('.avatar-tab').forEach(tab => {
tab.classList.remove('active');
});
document.querySelector(`.avatar-tab[onclick*="${tabType}"]`).classList.add('active');
document.querySelectorAll('.avatar-options').forEach(option => {
option.classList.remove('active');
});
document.getElementById(tabType + '_avatars').classList.add('active');
if (tabType === 'url') {
const urlInput = document.getElementById('avatar_url_input');
const previewContainer = document.getElementById('url_preview_container');
if (urlInput) urlInput.value = '';
if (previewContainer) previewContainer.style.display = 'none';
}
}
function handleAvatarUrlInput() {
const urlInput = document.getElementById('avatar_url_input');
const previewContainer = document.getElementById('url_preview_container');
const previewImage = document.getElementById('url_preview_image');
if (!urlInput || !previewContainer || !previewImage) return;
const url = urlInput.value.trim();
if (!url) {
previewContainer.style.display = 'none';
window.selectedAvatarData = null;
updateAvatarConfirmButton();
return;
}
try {
new URL(url);
} catch (e) {
previewContainer.style.display = 'none';
window.selectedAvatarData = null;
updateAvatarConfirmButton();
return;
}
const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp'];
const isImageUrl = imageExtensions.some(ext =>
url.toLowerCase().includes(ext) ||
url.toLowerCase().includes('image') ||
url.includes('catbox.moe') ||
url.includes('imgur.com') ||
url.includes('i.imgur.com')
);
if (!isImageUrl && !url.startsWith('data:image/')) {
console.warn('可能不是图片URL:', url);
}
previewImage.onload = function() {
previewContainer.style.display = 'block';
window.selectedAvatarData = {
type: 'url',
url: url
};
updateAvatarConfirmButton();
};
previewImage.onerror = function() {
console.error('图片加载失败:', url);
previewContainer.style.display = 'none';
window.selectedAvatarData = null;
updateAvatarConfirmButton();
const urlInput = document.getElementById('avatar_url_input');
if (urlInput) {
urlInput.style.borderColor = '#ff6b6b';
setTimeout(() => {
urlInput.style.borderColor = '';
}, 2000);
}
};
previewImage.src = url;
}
function loadPresetAvatars() {
const gridContainer = document.querySelector('.preset-avatar-grid');
if (!gridContainer) return;
const avatarGradients = [
{ start: '#FF6B6B', end: '#EE5A24', text: '群' },
{ start: '#4ECDC4', end: '#44A08D', text: '聊' },
{ start: '#45B7D1', end: '#96CEB4', text: '组' },
{ start: '#FFA07A', end: '#FA8072', text: '团' },
{ start: '#98D8C8', end: '#F7DC6F', text: '队' },
{ start: '#BB8FCE', end: '#D2B4DE', text: '圈' },
{ start: '#F8C471', end: '#F39C12', text: '社' },
{ start: '#85C1E9', end: '#5DADE2', text: '会' },
{ start: '#F1948A', end: '#EC7063', text: '友' },
{ start: '#82E0AA', end: '#58D68D', text: '伴' },
{ start: '#AED6F1', end: '#7FB3D3', text: '伙' },
{ start: '#E8DAEF', end: '#D7BDE2', text: '集' }
];
gridContainer.innerHTML = '';
avatarGradients.forEach((gradient, index) => {
const avatarItem = document.createElement('div');
avatarItem.className = 'preset-avatar-item';
avatarItem.style.setProperty('--gradient-start', gradient.start);
avatarItem.style.setProperty('--gradient-end', gradient.end);
avatarItem.textContent = gradient.text;
avatarItem.addEventListener('click', () => {
document.querySelectorAll('.preset-avatar-item').forEach(item => {
item.classList.remove('selected');
});
avatarItem.classList.add('selected');
window.selectedAvatarData = {
type: 'preset',
gradient: gradient,
text: gradient.text
};
updateAvatarConfirmButton();
});
gridContainer.appendChild(avatarItem);
});
}
function triggerFileUpload() {
document.getElementById('avatar_upload_input').click();
}
function handleAvatarUpload(event) {
const file = event.target.files[0];
if (!file) return;
if (!file.type.startsWith('image/')) {
alert('请选择图片文件');
return;
}
if (file.size> 5 * 1024 * 1024) {
alert('图片文件不能超过5MB');
return;
}
const reader = new FileReader();
reader.onload = async function(e) {
let imageData;
try {
imageData = await compressImage(file, 512, 0.8);
} catch (error) {
console.warn('图片压缩失败，使用原图:', error);
imageData = e.target.result;
}
const uploadZone = document.querySelector('.upload-zone');
if (uploadZone) {
uploadZone.innerHTML = `
<div class="uploaded-preview">
<img src="${imageData}" alt="预览" style="width: 120px; height: 120px; border-radius: 12px; object-fit: cover;">
<div class="upload-text" style="margin-top: 10px; color: #28a745;">✅ 图片已上传成功（已压缩）</div>
<button class="change-image-btn" onclick="triggerFileUpload()" style="margin-top: 8px; padding: 6px 12px; border: 1px solid #ddd; border-radius: 6px; background: white; cursor: pointer;">更换图片</button>
<div style="margin-top: 8px; font-size: 12px; color: #666; text-align: center;">
图片已压缩并将直接保存到世界书中
</div>
</div>
`;
}
window.selectedAvatarData = {
type: 'upload',
imageData: imageData
};
updateAvatarConfirmButton();
};
reader.readAsDataURL(file);
}
function updateAvatarConfirmButton() {
const confirmBtn = document.getElementById('avatar_confirm_btn');
if (confirmBtn) {
confirmBtn.disabled = false;
}
}
function confirmAvatarSelection() {
if (!window.selectedAvatarData) {
window.selectedAvatarData = {
type: 'preset',
gradient: { start: '#199AFF', end: '#0066CC' },
text: '群'
};
}
if (window.isSelectingGroupAvatar) {
const settingsPreviewElement = document.getElementById('group_settings_avatar_preview');
const settingsTextElement = document.querySelector('.group-settings-avatar-text');
if (settingsPreviewElement && settingsTextElement) {
if (window.selectedAvatarData.type === 'preset') {
const gradient = window.selectedAvatarData.gradient;
settingsPreviewElement.style.background = `linear-gradient(135deg, ${gradient.start}, ${gradient.end})`;
settingsPreviewElement.style.backgroundImage = 'none';
settingsPreviewElement.innerHTML = `<div class="default-group-avatar">${window.selectedAvatarData.text}</div>`;
settingsTextElement.textContent = '已选择预设头像';
} else if (window.selectedAvatarData.type === 'upload') {
settingsPreviewElement.style.background = 'none';
settingsPreviewElement.style.backgroundImage = `url('${window.selectedAvatarData.imageData}')`;
settingsPreviewElement.style.backgroundSize = 'cover';
settingsPreviewElement.style.backgroundPosition = 'center';
settingsPreviewElement.style.backgroundRepeat = 'no-repeat';
settingsPreviewElement.innerHTML = '';
settingsTextElement.textContent = '已选择自定义头像';
}
} else {
console.error('找不到群聊设置头像预览元素');
}
window.isSelectingGroupAvatar = false;
window.currentAvatarGroup = null;
} else {
const previewElement = document.getElementById('group_avatar_preview');
const textElement = document.querySelector('.group-avatar-text');
if (!previewElement || !textElement) {
console.error('找不到创建群聊头像预览元素');
closeAvatarSelector();
return;
}
if (window.selectedAvatarData.type === 'preset') {
const gradient = window.selectedAvatarData.gradient;
previewElement.style.background = `linear-gradient(135deg, ${gradient.start}, ${gradient.end})`;
previewElement.style.backgroundImage = 'none';
previewElement.innerHTML = `<div class="default-group-avatar">${window.selectedAvatarData.text}</div>`;
textElement.textContent = '已设置预设头像';
} else if (window.selectedAvatarData.type === 'upload') {
previewElement.style.background = 'none';
previewElement.style.backgroundImage = `url('${window.selectedAvatarData.imageData}')`;
previewElement.style.backgroundSize = 'cover';
previewElement.style.backgroundPosition = 'center';
previewElement.innerHTML = '';
textElement.textContent = '已设置自定义头像';
}
}
closeAvatarSelector();
}
function checkWorldbookGroups() {
if (!entries) {
return;
}
const groupEntries = entries.filter(e => e.comment ==="手机-群聊" || (e.key && typeof e.key === 'string' && e.key.startsWith("手机-群聊-")));
groupEntries.forEach((entry, index) => {
const lines = entry.content.split('\n');
let groupName = '';
let members = [];
let avatar = '';
for (const line of lines) {
const trimmed = line.trim();
if (trimmed.startsWith('[') && trimmed.endsWith(']')) {
groupName = trimmed.slice(1, -1);
} else if (trimmed.startsWith('成员=')) {
members = trimmed.substring(3).split(',').map(m => m.trim());
} else if (trimmed.startsWith('头像=')) {
avatar = trimmed.substring(3);
}
}
console.log(` - 成员: ${members.join(', ')}`);
});
}
async function cleanupDuplicateGroups() {
return;
const groups = window.QQ_Group_Chats_Data || [];
const uniqueGroups = [];
const seenNames = new Set();
for (const group of groups) {
if (!seenNames.has(group.name)) {
seenNames.add(group.name);
uniqueGroups.push(group);
} else {
console.log(`删除重复群聊: ${group.name} (ID: ${group.id})`);
}
}
if (uniqueGroups.length !== groups.length) {
}
const contactsContainer = document.getElementById('QQ_home_chars');
if (contactsContainer) {
const groupElements = contactsContainer.querySelectorAll('[data-group-type="true"]');
const seenGroupNames = new Set();
groupElements.forEach(element => {
const nameElement = element.querySelector('.QQ_home_name');
if (nameElement) {
const groupName = nameElement.textContent.trim();
if (seenGroupNames.has(groupName)) {
element.remove();
} else {
seenGroupNames.add(groupName);
}
}
});
}
const messagesContainer = document.getElementById('QQ_message_list_chars');
if (messagesContainer) {
const groupElements = messagesContainer.querySelectorAll('[data-group-type="true"]');
const seenGroupNames = new Set();
groupElements.forEach(element => {
const nameElement = element.querySelector('.QQ_home_name');
if (nameElement) {
const groupName = nameElement.textContent.trim();
if (seenGroupNames.has(groupName)) {
element.remove();
} else {
seenGroupNames.add(groupName);
}
}
});
}
}
async function addGroupToWorldbook(groupData) {
try {
if (!worldbook || !entries) {
console.warn('世界书功能不可用，无法添加群聊到世界书');
return false;
}
const uniqueComment = `手机-群聊-${groupData.name}`;
let groupEntry = null;
const groupEntryKey = `手机-群聊-${groupData.name}`;
groupEntry = entries.find(e =>
e.comment ==="手机-群聊" && e.content && e.content.includes(`[${groupData.name}]`)
);
let avatarReference = 'http:
if (groupData.avatar) {
if (typeof groupData.avatar === 'string') {
if (groupData.avatar.startsWith('data:')) {
try {
avatarReference = groupData.avatar;
} catch (e) {
console.warn('头像处理失败，使用默认头像:', e);
avatarReference = 'http:
}
} else if (groupData.avatar.startsWith('http:
avatarReference = groupData.avatar;
} else if (groupData.avatar.startsWith('avatar_')) {
avatarReference = groupData.avatar;
} else {
avatarReference = 'http:
}
} else if (typeof groupData.avatar === 'object') {
if (groupData.avatar.type === 'url' && groupData.avatar.url) {
avatarReference = groupData.avatar.url;
} else if (groupData.avatar.type === 'upload') {
if (groupData.avatar.avatarId) {
avatarReference = groupData.avatar.avatarId;
} else if (groupData.avatar.imageData) {
if (groupData.avatar.imageData.startsWith('data:')) {
try {
avatarReference = groupData.avatar.imageData;
} catch (e) {
console.warn('头像处理失败，使用默认头像:', e);
avatarReference = 'http:
}
} else if (groupData.avatar.imageData.startsWith('http:
avatarReference = groupData.avatar.imageData;
} else {
avatarReference = 'http:
}
} else {
avatarReference = 'http:
}
} else {
avatarReference = 'http:
}
} else {
avatarReference = 'http:
}
} else {
}
const groupContent = `[${groupData.name}]
类型=群聊
成员=${groupData.members.join(',')}
头像=${avatarReference}`;
if (groupEntry) {
await setLorebookEntries(worldbook, [
{
uid: groupEntry.uid,
content: groupContent,
}
]);
} else {
const createResult = await createLorebookEntry(worldbook, {
comment: uniqueComment,
key: ["此世界书永不触发"],
content: groupContent,
position: "at_depth_as_system",
type: "selective",
depth: 4,
exclude_recursion: true,
order: 6000,
enabled: true,
});
await QQ_SafeSaveWorldInfo("群聊创建数据");
}
return true;
} catch (error) {
console.error('添加群聊到世界书失败:', error);
return false;
}
}
async function updateGroupMembersInWorldbook(groupName, members) {
try {
let groupEntry = null;
const uniqueComment = `手机-群聊-${groupName}`;
if (entries) {
groupEntry = entries.find(e =>
e.comment === uniqueComment
);
}
if (!groupEntry) {
console.error('在世界书中未找到群聊条目:', groupName);
return false;
}
let content = groupEntry.content;
const lines = content.split('\n');
let updatedContent = '';
let hasMembersLine = false;
for (const line of lines) {
if (line.startsWith('成员=')) {
updatedContent += `成员=${members.join(',')}\n`;
hasMembersLine = true;
} else if (line.trim()) {
updatedContent += line + '\n';
}
}
if (!hasMembersLine) {
updatedContent += `成员=${members.join(',')}\n`;
}
await setLorebookEntries(worldbook, [
{
uid: groupEntry.uid,
content: updatedContent.trim(),
}
]);
entries = await getLorebookEntries(worldbook);
if (QQ_msgjson.群聊[groupName]) {
QQ_msgjson.群聊[groupName].members = members;
}
return true;
} catch (error) {
console.error('更新群聊成员到世界书失败:', error);
return false;
}
}
async function updateGroupNameInWorldbook(oldName, newName) {
try {
if (!worldbook || !entries) {
console.warn('世界书功能不可用，无法更新群聊名称');
return false;
}
let oldGroupEntry = null;
const oldUniqueComment = `手机-群聊-${oldName}`;
if (entries) {
oldGroupEntry = entries.find(e =>
e.comment === oldUniqueComment
);
}
if (!oldGroupEntry) {
console.error('在世界书中未找到群聊条目:', oldName);
console.error('当前所有群聊相关条目:');
if (entries) {
entries.filter(e => e.comment.startsWith("手机-群聊")).forEach((e, i) => {
console.error(`群聊条目 ${i}:`, {
uid: e.uid,
key: e.key,
comment: e.comment,
content: e.content?.substring(0, 100) + '...'
});
});
}
throw new Error(`找不到要更新的群聊条目: ${oldName}`);
}
const backupContent = oldGroupEntry.content;
const backupMembers = extractMembersFromContent(backupContent);
const backupAvatar = extractAvatarFromContent(backupContent);
const newContent = `[${newName}]
类型=群聊
成员=${backupMembers}
头像=${backupAvatar}`;
const newUniqueComment = `手机-群聊-${newName}`;
const newGroupEntryKey = `手机-群聊-${newName}`;
console.log('新内容:', newContent.substring(0, 100) + '...');
await setLorebookEntries(worldbook, [
{
uid: oldGroupEntry.uid,
comment: newUniqueComment,
key: [newGroupEntryKey],
content: newContent
}
]);
entries = await getLorebookEntries(worldbook);
const oldNameIndex = QQ_Groups.indexOf(oldName);
if (oldNameIndex !== -1) {
QQ_Groups[oldNameIndex] = newName;
}
if (QQ_msgjson.群聊[oldName]) {
QQ_msgjson.群聊[newName] = QQ_msgjson.群聊[oldName];
delete QQ_msgjson.群聊[oldName];
}
if (!QQ_msgjson.群聊[newName]) {
QQ_msgjson.群聊[newName] = {
members: backupMembers.split(',').map(m => m.trim()),
msgs: []
};
}
const originalGroupName = oldUniqueComment.replace('手机-群聊-', '');
const stableGroupId = `group_${originalGroupName.replace(/[^a-zA-Z0-9\u4e00-\u9fff]/g, '_')}`;
console.log('为群聊生成稳定ID:', stableGroupId, '(基于原始名称:', originalGroupName, ')');
document.querySelectorAll(`[data-group-name="${oldName}"]`).forEach(element => {
element.setAttribute('data-group-name', newName);
if (element.hasAttribute('data-group-id')) {
element.setAttribute('data-group-id', stableGroupId);
}
});
document.querySelectorAll(`[data-name="${oldName}"]`).forEach(element => {
element.setAttribute('data-name', newName);
if (element.hasAttribute('data-group-id')) {
element.setAttribute('data-group-id', stableGroupId);
}
});
console.log('群聊名称已成功更新到世界书并同步所有相关数据 (完整版)');
return true;
} catch (error) {
console.error('更新群聊名称到世界书失败:', error);
return false;
}
}
function extractMembersFromContent(content) {
const memberMatch = content.match(/成员=(.+)/);
return memberMatch ? memberMatch[1] : '';
}
function extractAvatarFromContent(content) {
const avatarMatch = content.match(/头像=(.+)/);
return avatarMatch ? avatarMatch[1] : 'http:
}
async function removeGroupFromWorldbook(groupName) {
try {
let groupEntry = null;
let groupIndex = -1;
const uniqueComment = `手机-群聊-${groupName}`;
if (entries) {
groupIndex = entries.findIndex(e => e.comment === uniqueComment);
if (groupIndex>= 0) {
groupEntry = entries[groupIndex];
}
}
if (!groupEntry) {
console.error('在世界书中未找到群聊条目:', groupName);
return false;
}
await deleteLorebookEntry(worldbook, groupEntry.uid);
if (groupIndex>= 0 && entries) {
entries.splice(groupIndex, 1);
}
return true;
} catch (error) {
console.error('从世界书中删除群聊失败:', error);
return false;
}
}
function switchToGroupChat(groupData) {
window.currentGroupChat = groupData;
QQ_Nav('chat');
setTimeout(() => {
ensureGroupChatPage(groupData);
updateChatHeader(groupData);
loadGroupChatHistory(groupData.id);
const chatUsername = document.getElementById('QQ_chat_username');
if (chatUsername) {
chatUsername.textContent = groupData.name;
}
}, 100);
}
function ensureGroupChatPage(groupData) {
$('.QQ_chat_page').hide();
let groupChatPage = $(`.QQ_chat_page[data-group-id="${groupData.id}"]`);
if (groupChatPage.length === 0) {
groupChatPage = createGroupChatPage(groupData);
$('#App_QQ').append(groupChatPage);
} else {
}
groupChatPage.show();
return groupChatPage;
}
function createGroupChatPage(groupData) {
const pageHTML = `
<div class="QQ_chat_page group-chat-page" data-group-id="${groupData.id}" data-name="${groupData.name}" style="display: none;">
<div class="QQ_chat_head" style="display: flex; align-items: center; padding: 10px; background: white; border-bottom: 1px solid #eee;">
<div class="QQ_chat_head_back" style="margin-right: 15px; cursor: pointer;">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none">
<path d="M15 18L9 12L15 6" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
</div>
<div class="QQ_chat_head_avatar" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; background: linear-gradient(135deg, #199AFF, #0066CC); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">群</div>
<div style="flex: 1;">
<span id="QQ_chat_username" class="group-chat-clickable-name" style="font-size: 16px; font-weight: bold; cursor: pointer;">${groupData.name}</span>
<div style="font-size: 12px; color: #999; margin-top: 2px;">群聊 · ${groupData.members.length}人</div>
</div>
</div>
<div class="msgcontent" style="flex: 1; overflow-y: auto; padding: 10px; background: #f5f5f5;">
</div>
<div class="QQ_chat_input_area" style="padding: 10px; background: white; border-top: 1px solid #eee;">
<div style="display: flex; align-items: center;">
<input type="text" class="group-chat-input userInput" placeholder="输入消息..." style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 20px; outline: none;">
<button class="group-chat-send-btn" style="margin-left: 10px; padding: 8px 16px; background: #007AFF; color: white; border: none; border-radius: 20px; cursor: pointer;">发送</button>
</div>
</div>
</div>
`;
const $page = $(pageHTML);
$page.find('.QQ_chat_head_back').on('click', function() {
$('.QQ_bottom_nav').show();
const sourcePage = window.groupChatSourcePage || 'contacts';
if (sourcePage === 'messages') {
QQ_Nav('message');
} else {
QQ_Nav('people');
}
window.currentGroupChat = null;
});
$page.find('.group-chat-clickable-name').on('click', function() {
showGroupManagementMenu(groupData, this);
});
const $input = $page.find('.group-chat-input');
const $sendBtn = $page.find('.group-chat-send-btn');
$sendBtn.on('click', function() {
const fakeEvent = { target: $page[0] };
QQ_SendMsg(fakeEvent);
});
$input.on('keydown', function(e) {
QQ_EnterPress(e, this);
});
return $page;
}
async function createNewGroup(groupName, members, avatarUrl) {
try {
const groupData = {
name: groupName,
members: members,
avatar: {
type: 'upload',
imageData: avatarUrl || 'http:
}
};
const success = await addGroupToWorldbook(groupData);
if (!success) {
throw new Error('添加到世界书失败');
}
try {
entries = await getLorebookEntries(worldbook);
} catch (e) {
console.warn('刷新entries失败，但群聊已创建:', e);
}
if (!QQ_Groups.includes(groupName)) {
QQ_Groups.push(groupName);
}
if (!QQ_msgjson.群聊[groupName]) {
QQ_msgjson.群聊[groupName] = {
members: members || [],
msgs: []
};
}
if (QQ_GroupInitializedSet.has(groupName)) {
QQ_GroupInitializedSet.delete(groupName);
}
const avatarData = groupData.avatar;
let finalAvatarUrl = '';
if (avatarData && avatarData.imageData) {
finalAvatarUrl = avatarData.imageData;
} else if (avatarData && typeof avatarData === 'string') {
finalAvatarUrl = avatarData;
} else {
finalAvatarUrl = avatarUrl || 'https:
}
AddNewGroup(groupName, finalAvatarUrl, members || [], '');
await new Promise(resolve => setTimeout(resolve, 100));
await QQ_Enhance_Group_Metadata();
const newGroupElement = $(`.QQ_home_usermsg[data-name='${groupName}'][data-group-type='true']`);
if (newGroupElement.length> 0) {
const $messageChars = $("#QQ_message_list_chars");
const existingInMessageList = $messageChars.find(`.QQ_home_usermsg[data-name='${groupName}'][data-group-type='true']`);
if (existingInMessageList.length === 0) {
$messageChars.append(newGroupElement.clone(true));
}
}
return true;
} catch (error) {
console.error('创建群聊失败:', error);
toastr.error('创建群聊失败: ' + error.message);
return false;
}
}
async function deleteGroupChat(groupName) {
try {
const success = await removeGroupFromWorldbook(groupName);
if (!success) {
throw new Error('从世界书删除失败');
}
$(`.QQ_home_usermsg[data-name='${groupName}']`).remove();
delete QQ_msgjson.群聊[groupName];
const index = QQ_Groups.indexOf(groupName);
if (index> -1) {
QQ_Groups.splice(index, 1);
}
const pageIndex = QQ_pages.indexOf(groupName);
if (pageIndex> -1) {
QQ_pages.splice(pageIndex, 1);
}
$(`.QQ_chat_page[data-name='${groupName}']`).remove();
try {
entries = await getLorebookEntries(worldbook);
} catch (e) {
console.warn('刷新entries失败，但群聊已删除:', e);
}
await QQ_Enhance_Group_Metadata();
setTimeout(async () => {
await QQ_UpdateMessageList();
}, 100);
return true;
} catch (error) {
console.error('删除群聊失败:', error);
toastr.error('删除群聊失败: ' + error.message);
return false;
}
}
function saveGroupMessage(groupId, message) {
try {
if (!QQ_msgjson.群聊) {
if (window.QQ_ChatDataRestored) {
console.warn('⚠️ 在saveGroupMessage中检测到群聊数据为空，但聊天数据已从备份恢复');
}
QQ_msgjson.群聊 = {};
}
let groupName = null;
for (const name of QQ_Groups) {
if (name.includes(groupId) || groupId.includes(name)) {
groupName = name;
break;
}
}
if (!groupName) {
const groupElement = document.querySelector(`[data-group-id="${groupId}"]`);
if (groupElement) {
groupName = groupElement.getAttribute('data-name') ||
groupElement.textContent.trim() ||
groupId;
} else {
groupName = groupId;
}
}
if (!QQ_msgjson.群聊[groupName]) {
QQ_msgjson.群聊[groupName] = {
msgs: [],
members: []
};
}
const msgString = `${message.sender}--${message.content}`;
const isDuplicate = QQ_msgjson.群聊[groupName].msgs.some(msg =>
msg === msgString || msg.includes(message.content)
);
if (!isDuplicate) {
QQ_msgjson.群聊[groupName].msgs.push(msgString);
setTimeout(async () => {
await QQ_Save_Msg();
}, 100);
} else {
}
} catch (error) {
console.error('保存群聊消息失败:', error);
}
}
async function restoreGroupDataToMsgjson() {
if (!QQ_Groups || QQ_Groups.length === 0) {
return;
}
QQ_Groups.forEach(groupName => {
if (!QQ_msgjson.群聊[groupName]) {
QQ_msgjson.群聊[groupName] = {
members: [],
msgs: []
};
}
if (QQ_msgjson.群聊[groupName].msgs.length> 0) {
setTimeout(() => {
updateGroupLastMessageDisplay(groupName);
}, 200);
}
});
}
async function updateGroupLastMessage(groupId, message) {
try {
const groups = window.QQ_Group_Chats_Data || [];
if (!groups || groups.length === 0) {
console.warn('群聊元数据缓存为空，跳过更新群聊最后消息:', groupId);
return;
}
const groupIndex = groups.findIndex(g => g && g.id === groupId);
if (groupIndex !== -1) {
const currentTime = new Date();
groups[groupIndex].lastMessage = message;
groups[groupIndex].lastTime = currentTime.toLocaleTimeString('zh-CN', { hour12: false }).slice(0, 5);
groups[groupIndex].timestamp = groups[groupIndex].lastTime;
const messageElement = $(`.QQ_home_usermsg[data-group-id="${groupId}"]`)[0];
const contactElement = $(`.QQ_home_usermsg[data-group-id="${groupId}"]`)[0];
if (messageElement) {
updateGroupInMessageList(messageElement, groups[groupIndex]);
}
if (contactElement) {
updateGroupInContactList(contactElement, groups[groupIndex]);
}
}
} catch (error) {
console.error('更新群聊最后消息失败:', error);
}
}
function loadGroupChatHistory(groupId) {
try {
const messages = [];
const groupChatPage = $(`.QQ_chat_page[data-group-id="${groupId}"]`);
const msgContent = groupChatPage.find('.msgcontent')[0] || document.querySelector('.group-chat-page .msgcontent');
if (msgContent) {
msgContent.innerHTML = '';
messages.forEach(message => {
displayGroupMessage(message, msgContent);
});
msgContent.scrollTop = msgContent.scrollHeight;
} else {
console.error('未找到群聊消息容器');
}
if (messages.length === 0) {
if (msgContent && window.currentGroupChat) {
const welcomeMsg = document.createElement('div');
welcomeMsg.style.cssText = 'text-align: center; color: #999; padding: 20px; font-size: 14px;';
welcomeMsg.innerHTML = `
<div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">${window.currentGroupChat.name}</div>
<div style="font-size: 14px; margin-bottom: 10px;">群成员: ${window.currentGroupChat.members.join(', ')}</div>
<div style="font-size: 12px; color: #999;">群聊已创建，开始聊天吧！</div>
`;
msgContent.appendChild(welcomeMsg);
}
}
} catch (error) {
console.error('加载群聊消息历史失败:', error);
}
}
function displayGroupMessage(message, msgContent = null) {
if (!msgContent) {
msgContent = document.querySelector('.group-chat-page .msgcontent') || document.querySelector('.msgcontent');
}
if (!msgContent) return;
const messageDiv = document.createElement('div');
messageDiv.className = 'QQ_chat_msgdiv group-message';
messageDiv.setAttribute('data-name', message.sender);
messageDiv.style.cssText = 'margin: 10px 0; padding: 10px; background: white; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);';
const senderSpan = document.createElement('span');
senderSpan.style.cssText = 'font-weight: bold; color: #007AFF; margin-right: 8px; font-size: 14px;';
senderSpan.textContent = message.sender + ':';
const contentSpan = document.createElement('span');
contentSpan.style.cssText = 'color: #333; font-size: 14px; line-height: 1.4;';
contentSpan.textContent = message.content;
const timeSpan = document.createElement('span');
timeSpan.style.cssText = 'font-size: 12px; color: #999; margin-left: 8px; float: right;';
timeSpan.textContent = message.timestamp || new Date().toLocaleTimeString();
messageDiv.appendChild(senderSpan);
messageDiv.appendChild(contentSpan);
messageDiv.appendChild(timeSpan);
msgContent.appendChild(messageDiv);
}
function clearGroupChatState() {
if (window.currentGroupChat) {
window.currentGroupChat = null;
}
}
const originalQQNav = window.QQ_Nav;
async function ensureGroupsInContactList() {
const groups = window.QQ_Group_Chats_Data || [];
const contactsContainer = document.getElementById('QQ_home_chars');
if (!contactsContainer) {
return;
}
if (groups.length === 0) {
return;
}
console.log('群聊数据:', groups.map(g => ({name: g.name, id: g.id, avatar: g.avatar})));
const existingGroups = contactsContainer.querySelectorAll('[data-group-type="true"]');
const groupMap = new Map();
const groupNameMap = new Map();
existingGroups.forEach(element => {
const groupId = element.getAttribute('data-group-id');
const groupName = element.getAttribute('data-name');
if (groupId) {
if (groupMap.has(groupId)) {
console.log('移除重复的群聊元素(按ID):', groupId);
element.remove();
} else {
groupMap.set(groupId, element);
if (groupName) {
groupNameMap.set(groupName, element);
}
}
} else if (groupName) {
if (groupNameMap.has(groupName)) {
console.log('移除重复的群聊元素(按名称):', groupName);
element.remove();
} else {
groupNameMap.set(groupName, element);
}
}
});
groups.forEach(groupData => {
const existsByID = groupMap.has(groupData.id);
const existsByName = groupNameMap.has(groupData.name);
if (!existsByID && !existsByName) {
AddNewGroup(groupData.name, groupData.avatar || 'https:
} else {
const existingElement = existsByID ? groupMap.get(groupData.id) : groupNameMap.get(groupData.name);
if (existingElement) {
updateGroupAvatarInElement(existingElement, groupData);
}
}
});
}
function updateGroupAvatarInElement(element, groupData) {
const avatarElement = element.querySelector('.QQ_home_head');
if (!avatarElement) {
return;
}
avatarElement.style.backgroundImage = '';
avatarElement.style.background = '';
avatarElement.textContent = '';
avatarElement.innerHTML = '';
applyGroupAvatar(avatarElement, groupData);
}
function getCharacterAvatarFromWorldbook(characterName) {
let entry = GetWorldEntry(["手机-角色", "手机界面-角色"], true);
if (!entry || !entry.content) {
return null;
}
const content = entry.content;
const lines = content.split('\n');
let currentSection = null;
for (let line of lines) {
line = line.trim();
if (line.startsWith('[') && line.endsWith(']')) {
currentSection = line.slice(1, -1);
} else if (currentSection === characterName && line.startsWith('头像=')) {
const avatarUrl = line.substring(3);
return {
backgroundImage: `url("${avatarUrl}")`,
background: '',
textContent: '',
avatarUrl: avatarUrl
};
}
}
console.log(`未在世界书中找到角色 ${characterName} 的头像，当前所有章节:`, lines.filter(l => l.startsWith('[') && l.endsWith(']')));
return null;
}
function getGroupAvatarFromWorldbook(groupName) {
if (!entries) {
return null;
}
const uniqueComment = `手机-群聊-${groupName}`;
const groupEntry = entries.find(e =>
e.comment === uniqueComment
);
if (!groupEntry) {
return null;
}
const content = groupEntry.content;
const lines = content.split('\n');
let currentSection = null;
for (let line of lines) {
line = line.trim();
if (line.startsWith('[') && line.endsWith(']')) {
currentSection = line.slice(1, -1);
} else if (currentSection === groupName && line.startsWith('头像=')) {
const avatarUrl = line.substring(3);
return {
backgroundImage: `url("${avatarUrl}")`,
background: '',
textContent: '',
avatarUrl: avatarUrl
};
}
}
return null;
}
function getCharacterAvatar(characterName) {
const worldbookAvatar = getCharacterAvatarFromWorldbook(characterName);
if (worldbookAvatar) {
return worldbookAvatar;
}
const contactsContainer = document.getElementById('QQ_home_chars');
if (!contactsContainer) {
return null;
}
const contactElements = contactsContainer.querySelectorAll('.QQ_home_usermsg');
for (let element of contactElements) {
const nameElement = element.querySelector('.QQ_home_name');
if (nameElement && nameElement.textContent.trim() === characterName) {
const avatarElement = element.querySelector('.QQ_home_head');
if (avatarElement) {
const backgroundImage = avatarElement.style.backgroundImage;
const background = avatarElement.style.background;
const textContent = avatarElement.textContent;
return {
backgroundImage,
background,
textContent
};
}
}
}
return null;
}
function applyCharacterAvatar(element, avatarData, characterName) {
element.style.borderRadius = '50%';
element.style.display = 'flex';
element.style.alignItems = 'center';
element.style.justifyContent = 'center';
element.style.fontWeight = 'bold';
element.style.fontSize = '12px';
element.style.color = 'white';
element.style.backgroundSize = 'cover';
element.style.backgroundPosition = 'center';
element.style.backgroundRepeat = 'no-repeat';
element.style.flexShrink = '0';
if (avatarData && (avatarData.backgroundImage || avatarData.background)) {
if (avatarData.backgroundImage && avatarData.backgroundImage !== 'none') {
element.style.backgroundImage = avatarData.backgroundImage;
element.style.background = '';
element.textContent = '';
} else if (avatarData.background && avatarData.background !== 'none') {
element.style.background = avatarData.background;
element.style.backgroundImage = '';
element.textContent = avatarData.textContent || characterName.charAt(0);
} else {
element.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
element.style.backgroundImage = '';
element.textContent = characterName.charAt(0);
}
} else {
element.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
element.style.backgroundImage = '';
element.textContent = characterName.charAt(0);
}
}
function applyGroupAvatar(element, groupData) {
console.log('应用群聊头像:', groupData?.name, '头像数据类型:', typeof groupData?.avatar, '头像值:', groupData?.avatar?.substring?.(0, 50) + '...');
element.style.borderRadius = '50%';
element.style.display = 'flex';
element.style.alignItems = 'center';
element.style.justifyContent = 'center';
element.style.fontWeight = 'bold';
element.style.fontSize = '12px';
element.style.color = 'white';
element.style.backgroundSize = 'cover';
element.style.backgroundPosition = 'center';
element.style.backgroundRepeat = 'no-repeat';
element.style.flexShrink = '0';
element.style.backgroundImage = '';
element.style.background = '';
element.innerHTML = '';
if (!groupData) {
element.style.background = 'linear-gradient(135deg, #ff7b7b, #667eea)';
element.textContent = '群';
return;
}
const avatarSrc = groupData.avatarData || groupData.avatar;
if (avatarSrc && avatarSrc.trim() !== '') {
if (avatarSrc.startsWith('data:image/')) {
element.innerHTML = `<img src="${avatarSrc}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
} else if (avatarSrc.startsWith('http:
element.innerHTML = `<img src="${avatarSrc}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
} else if (avatarSrc.length === 1 || avatarSrc.length === 2) {
element.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
element.textContent = avatarSrc;
} else if (avatarSrc.startsWith('#') && avatarSrc.length === 7) {
element.style.background = avatarSrc;
element.textContent = groupData.name ? groupData.name.charAt(0) : '群';
} else {
element.innerHTML = `<img src="${avatarSrc}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" onerror="this.style.display='none'; this.parentElement.style.background='linear-gradient(135deg, #ff7b7b, #667eea)'; this.parentElement.textContent='群';">`;
}
} else {
element.style.background = 'linear-gradient(135deg, #ff7b7b, #667eea)';
element.textContent = '群';
}
}
function updateChatHeader(groupData) {
const chatHeader = document.querySelector('#QQ_chat_username')?.closest('div') ||
document.querySelector('.QQ_chat_head') ||
document.querySelector('#QQ_chat_head');
if (!chatHeader) {
console.error('未找到聊天头部元素，尝试创建头部');
const chatPage = document.querySelector('.QQ_chat_page[style*="display:block"], .QQ_chat_page:not([style*="display:none"])');
if (chatPage) {
const headerDiv = document.createElement('div');
headerDiv.className = 'QQ_chat_head group-chat-header';
headerDiv.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; height: 60px; background: #fff; z-index: 1000; display: flex; align-items: center; padding: 0 15px; border-bottom: 1px solid #eee;';
const avatar = document.createElement('div');
avatar.className = 'QQ_home_head';
avatar.style.cssText = 'width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;';
const infoDiv = document.createElement('div');
infoDiv.style.cssText = 'flex: 1;';
const nameDiv = document.createElement('div');
nameDiv.className = 'QQ_home_name group-chat-clickable-name';
nameDiv.style.cssText = 'font-size: 16px; font-weight: bold; color: #333; cursor: pointer; user-select: none;';
nameDiv.textContent = groupData.name;
nameDiv.addEventListener('click', function(e) {
e.stopPropagation();
showGroupManagementMenu(groupData, nameDiv);
});
const msgDiv = document.createElement('div');
msgDiv.className = 'QQ_home_lastmsg group-member-count';
msgDiv.style.cssText = 'font-size: 12px; color: #666; margin-top: 2px;';
msgDiv.textContent = `群聊 · ${groupData.members.length}人`;
infoDiv.appendChild(nameDiv);
infoDiv.appendChild(msgDiv);
headerDiv.appendChild(avatar);
headerDiv.appendChild(infoDiv);
chatPage.insertBefore(headerDiv, chatPage.firstChild);
const msgContent = chatPage.querySelector('.msgcontent');
if (msgContent) {
msgContent.style.paddingTop = '70px';
}
const updatedHeader = headerDiv;
updateHeaderContent(updatedHeader, groupData);
return;
} else {
console.error('也未找到聊天页面');
return;
}
}
updateHeaderContent(chatHeader, groupData);
}
function updateHeaderContent(chatHeader, groupData) {
const headerAvatar = chatHeader.querySelector('.QQ_home_head');
if (headerAvatar) {
headerAvatar.innerHTML = '';
headerAvatar.style.cssText = '';
headerAvatar.style.display = 'block';
headerAvatar.style.width = '40px';
headerAvatar.style.height = '40px';
headerAvatar.style.borderRadius = '50%';
headerAvatar.style.marginRight = '10px';
headerAvatar.style.flexShrink = '0';
headerAvatar.style.position = 'relative';
headerAvatar.style.overflow = 'hidden';
if (groupData.avatar) {
updateAvatarElement(headerAvatar, groupData.avatar);
setTimeout(() => {
updateAvatarElement(headerAvatar, groupData.avatar);
}, 50);
} else {
headerAvatar.style.background = 'linear-gradient(135deg, #199AFF, #0066CC)';
headerAvatar.style.backgroundImage = 'none';
headerAvatar.style.color = 'white';
headerAvatar.style.display = 'flex';
headerAvatar.style.alignItems = 'center';
headerAvatar.style.justifyContent = 'center';
headerAvatar.style.fontWeight = 'bold';
headerAvatar.textContent = '群';
}
} else {
console.warn('未找到聊天界面头像元素');
}
const nameSelectors = [
'#QQ_chat_username',
'.QQ_home_name',
'.chat-title',
'.group-chat-title',
'h2',
'.name',
'span',
'div'
];
let headerName = null;
let selectorUsed = '';
for (const selector of nameSelectors) {
headerName = chatHeader.querySelector(selector);
if (headerName) {
selectorUsed = selector;
break;
}
}
console.log('聊天头部的所有子元素:', Array.from(chatHeader.children).map(el => ({
tag: el.tagName,
class: el.className,
id: el.id,
text: el.textContent.trim().substring(0, 50)
})));
if (headerName) {
console.log(' - 当前内容:', headerName.textContent.trim());
if (groupData.members && groupData.members.length>= 1) {
headerName.textContent = groupData.name;
const memberCountElement = chatHeader.querySelector('.QQ_home_lastmsg, .group-member-count');
if (memberCountElement) {
const memberCount = groupData.members.length;
const countText = `群聊 · ${memberCount}人`;
memberCountElement.textContent = countText;
} else {
const nameContainer = headerName.parentElement;
if (nameContainer) {
const memberCountDiv = document.createElement('div');
memberCountDiv.className = 'QQ_home_lastmsg group-member-count';
memberCountDiv.style.cssText = 'font-size: 12px; color: #666; margin-top: 2px;';
memberCountDiv.textContent = `群聊 · ${groupData.members.length}人`;
nameContainer.appendChild(memberCountDiv);
}
}
} else {
headerName.textContent = groupData.name;
}
headerName.classList.remove('group-chat-clickable-name');
headerName.classList.add('group-chat-clickable-name');
headerName.style.cursor = 'pointer';
headerName.style.userSelect = 'none';
headerName.style.color = '#333';
headerName.style.fontWeight = 'bold';
headerName.setAttribute('data-group-name', groupData.name);
headerName.setAttribute('data-group-id', groupData.id);
if (headerName._groupClickHandler) {
headerName.removeEventListener('click', headerName._groupClickHandler);
}
headerName._groupClickHandler = function(e) {
e.stopPropagation();
e.preventDefault();
showGroupManagementMenu(groupData, headerName);
};
headerName.addEventListener('click', headerName._groupClickHandler);
console.log(' - 最终显示内容:', headerName.textContent.trim());
} else {
console.error('*** 未找到群名称元素，群名称更新失败 ***');
console.error('聊天头部结构:', chatHeader.outerHTML);
const nameElement = document.createElement('span');
nameElement.id = 'QQ_chat_username';
nameElement.className = 'QQ_home_name group-chat-clickable-name';
if (groupData.members && groupData.members.length> 1) {
nameElement.textContent = `${groupData.name} (${groupData.members.length}人)`;
} else {
nameElement.textContent = groupData.name;
}
nameElement.style.cssText = 'font-size: 16px; font-weight: bold; color: #333; margin-left: 10px; cursor: pointer; user-select: none;';
nameElement.setAttribute('data-group-name', groupData.name);
nameElement.setAttribute('data-group-id', groupData.id);
nameElement.addEventListener('click', function(e) {
e.stopPropagation();
e.preventDefault();
showGroupManagementMenu(groupData, nameElement);
});
chatHeader.appendChild(nameElement);
headerName = nameElement;
}
const headerMsg = chatHeader.querySelector('.QQ_home_lastmsg') ||
chatHeader.querySelector('.chat-subtitle');
if (headerMsg) {
headerMsg.textContent = `群聊 · ${groupData.members.length}人`;
} else {
const subtitleElement = document.createElement('div');
subtitleElement.className = 'QQ_home_lastmsg';
subtitleElement.textContent = `群聊 · ${groupData.members.length}人`;
subtitleElement.style.cssText = 'font-size: 12px; color: #666; margin-left: 10px;';
chatHeader.appendChild(subtitleElement);
}
}
function loadGroupChatHistory(groupId) {
const chatContainer = document.querySelector('#QQ_chat_msgs');
if (!chatContainer) {
console.error('找不到聊天消息容器');
return;
}
chatContainer.innerHTML = '';
if (window.groupChatMessages && window.groupChatMessages[groupId]) {
const messages = window.groupChatMessages[groupId];
messages.forEach(message => {
if (message.type === 'system') {
const systemMsgDiv = document.createElement('div');
systemMsgDiv.className = 'system-message';
systemMsgDiv.style.cssText = `
text-align: center;
color: #999;
font-size: 12px;
margin: 10px 0;
padding: 5px;
line-height: 1.4;
`;
systemMsgDiv.textContent = message.content;
chatContainer.appendChild(systemMsgDiv);
} else {
}
});
}
if (chatContainer.children.length === 0) {
const welcomeDiv = document.createElement('div');
welcomeDiv.className = 'system-message';
welcomeDiv.style.cssText = `
text-align: center;
color: #999;
margin: 20px 0;
font-size: 14px;
`;
welcomeDiv.textContent = '欢迎来到群聊！开始聊天吧～';
chatContainer.appendChild(welcomeDiv);
}
chatContainer.scrollTop = chatContainer.scrollHeight;
}
function getCurrentGroupMembers() {
if (!window.currentGroupChat) {
return [];
}
return window.currentGroupChat.members || [];
}
function isCharacterInCurrentGroup(characterName) {
if (!window.currentGroupChat) {
return true;
}
const members = getCurrentGroupMembers();
return members.includes(characterName);
}
function filterGroupChatResponse(response) {
if (!window.currentGroupChat) {
return response;
}
const groupName = window.currentGroupChat.name;
const members = getCurrentGroupMembers();
console.log(`当前群聊: ${groupName}, 成员: [${members.join(', ')}]`);
let contextInfo = `\n[群聊上下文]\n`;
contextInfo += `- 当前群聊: ${groupName}\n`;
contextInfo += `- 群聊成员: ${members.join('、')}\n`;
contextInfo += `- 注意: 只有以上成员能够看到和回复此群聊中的消息\n`;
contextInfo += `- 其他角色无法看到此群聊的内容\n`;
return contextInfo + response;
}
const originalQQGen = window.QQ_Gen;
if (originalQQGen) {
window.QQ_Gen = async function(prompt, callback) {
try {
if (window.currentGroupChat) {
const groupName = window.currentGroupChat.name;
const members = getCurrentGroupMembers();
const groupContext = `[重要: 当前在群聊"${groupName}"中，只有以下成员可以参与对话: ${members.join('、')}。其他角色无法看到此群聊消息，不应回复。]\n\n`;
prompt = groupContext + prompt;
}
const result = await originalQQGen(prompt);
const filteredResult = filterGroupChatResponse(result);
if (typeof callback === 'function') {
await callback(filteredResult);
}
return filteredResult;
} catch (error) {
console.error('QQ_Gen执行错误:', error);
if (typeof callback === 'function') {
try {
await callback(null, error);
} catch (callbackError) {
console.error('回调函数执行错误:', callbackError);
}
}
throw error;
}
};
}
async function initializeEnhancedFeatures() {
if (worldbook) {
} else {
}
if (typeof QQ_LoadContactGroups === 'function' && worldbook) {
await QQ_LoadContactGroups();
} else if (!worldbook) {
}
if (typeof initContactGroups === 'function') {
initContactGroups();
}
setTimeout(async () => {
try {
const groups = window.QQ_Group_Chats_Data || [];
if (groups && Array.isArray(groups)) {
groups.forEach(groupData => {
if (groupData && groupData.name) {
updateGroupLastMessageDisplay(groupData.name);
}
});
} else {
console.warn('群聊数据无效，跳过最后消息显示更新');
}
await QQ_UpdateMessageList();
} catch (error) {
console.error('更新群聊最后消息显示时出错:', error);
}
}, 500);
if (typeof QQ_InitMomentLikes === 'function') {
QQ_InitMomentLikes();
}
if (typeof QQ_LoadMomentLikes === 'function') {
await QQ_LoadMomentLikes();
}
}
if (document.readyState === 'complete' || document.readyState === 'interactive') {
setTimeout(initializeEnhancedFeatures, 1000);
} else {
document.addEventListener('DOMContentLoaded', () => {
setTimeout(initializeEnhancedFeatures, 1000);
});
}
</script>
<script>
window.selectedAvatarData=null;window.confirmAvatarSelection=function(){if(!window.selectedAvatarData){window.selectedAvatarData={type:'preset',gradient:{start:'#199AFF',end:'#0066CC'},text:'群'};}const previewElement=document.getElementById('group_avatar_preview');const textElement=document.querySelector('.group-avatar-text');if(!previewElement||!textElement){console.error('找不到头像预览元素');alert('找不到头像预览元素，请检查页面结构');return;}try{if(window.selectedAvatarData.type==='preset'){const gradient=window.selectedAvatarData.gradient;previewElement.style.background=`linear-gradient(135deg,${gradient.start},${gradient.end})`;previewElement.style.backgroundImage='none';previewElement.innerHTML=`<div class="default-group-avatar">${window.selectedAvatarData.text}</div>`;textElement.textContent='已设置预设头像';}else if(window.selectedAvatarData.type==='upload'){previewElement.style.background='none';previewElement.style.backgroundImage=`url('${window.selectedAvatarData.imageData}')`;previewElement.style.backgroundSize='cover';previewElement.style.backgroundPosition='center';previewElement.innerHTML='';textElement.textContent='已设置自定义头像';}const modal=document.getElementById('avatar_selector_modal');if(modal){modal.style.display='none';}alert('头像设置成功！');}catch(error){console.error('头像设置时出错:',error);alert('头像设置失败：'+error.message);}};window.cleanupDuplicateGroups=cleanupDuplicateGroups;window.checkWorldbookGroups=checkWorldbookGroups;window.createGroupChat=async function(){try{const nameInput=document.getElementById('group_name_input');if(!nameInput){console.error('找不到群聊名称输入框');alert('系统错误：找不到群聊名称输入框');return;}const groupName=nameInput.value.trim();if(!groupName){alert('请输入群聊名称');return;}const selectedContacts=Array.from(document.querySelectorAll('#contact_list_for_group .contact-item.selected'));console.log('所有联系人项目:',document.querySelectorAll('#contact_list_for_group .contact-item'));if(selectedContacts.length===0){alert('请至少选择一个群成员');return;}const confirmBtn=document.getElementById('group_confirm_btn');if(confirmBtn){confirmBtn.disabled=true;confirmBtn.textContent='创建中...';}const members=selectedContacts.map(contact=>{const nameElement=contact.querySelector('.contact-name');return nameElement ? nameElement.textContent.trim():'';}).filter(name=>name);let avatarUrl='http:if(window.selectedAvatarData&&window.selectedAvatarData.type==='upload'&&window.selectedAvatarData.imageData){avatarUrl=window.selectedAvatarData.imageData;}const success=await createNewGroup(groupName,members,avatarUrl);if(!success){if(confirmBtn){confirmBtn.disabled=false;confirmBtn.textContent='创建群聊';}return;}const modal=document.getElementById('group_create_modal');if(modal){modal.style.display='none';}nameInput.value='';window.selectedAvatarData=null;const preview=document.getElementById('group_avatar_preview');const text=document.querySelector('.group-avatar-text');if(preview&&text){preview.style.background='linear-gradient(135deg,#199AFF,#0066CC)';preview.innerHTML='<div class="default-group-avatar">+</div>';text.textContent='点击设置头像';}alert(`群聊"${groupName}"创建成功！`);if(typeof renderContactGroups==='function'){await renderContactGroups();}if(confirmBtn){confirmBtn.disabled=false;confirmBtn.textContent='创建群聊';}}catch(error){console.error('创建群聊时出错:',error);alert('创建群聊失败：'+error.message);const confirmBtn=document.getElementById('group_confirm_btn');if(confirmBtn){confirmBtn.disabled=false;confirmBtn.textContent='创建群聊';}}};function updateGroupInContactList(element,groupData){const nameDiv=element.querySelector('.QQ_home_name');const msgDiv=element.querySelector('.QQ_home_lastmsg');if(nameDiv)nameDiv.textContent=groupData.name;if(msgDiv)msgDiv.textContent=`群聊 · ${groupData.members.length}人`;}function updateGroupInMessageList(element,groupData){const nameDiv=element.querySelector('.QQ_home_name');const msgDiv=element.querySelector('.QQ_home_lastmsg');const timeDiv=element.querySelector('.QQ_home_lasttime');const avatarDiv=element.querySelector('.QQ_home_head');if(nameDiv)nameDiv.textContent=groupData.name;if(msgDiv)msgDiv.textContent=groupData.lastMessage||'群聊已创建';if(timeDiv){const currentTime=new Date();const timeString=groupData.timestamp||groupData.lastTime||currentTime.toLocaleTimeString('zh-CN',{hour12:false}).slice(0,5);timeDiv.textContent=timeString;}if(avatarDiv){if(groupData.avatar&&groupData.avatar.type==='preset'&&groupData.avatar.gradient){const gradient=groupData.avatar.gradient;avatarDiv.style.background=`linear-gradient(135deg,${gradient.start},${gradient.end})`;avatarDiv.style.color='white';avatarDiv.style.display='flex';avatarDiv.style.alignItems='center';avatarDiv.style.justifyContent='center';avatarDiv.style.fontWeight='bold';avatarDiv.style.fontSize='18px';avatarDiv.textContent=groupData.avatar.text||'群';}else if(groupData.avatar&&groupData.avatar.type==='upload'&&groupData.avatar.imageData){avatarDiv.style.background='';avatarDiv.style.backgroundColor='';avatarDiv.style.color='';avatarDiv.style.display='block';avatarDiv.style.alignItems='';avatarDiv.style.justifyContent='';avatarDiv.style.fontWeight='';avatarDiv.style.fontSize='';avatarDiv.textContent='';avatarDiv.style.width='40px';avatarDiv.style.height='40px';avatarDiv.style.borderRadius='50%';avatarDiv.style.minWidth='40px';avatarDiv.style.backgroundImage=`url('${groupData.avatar.imageData}')`;avatarDiv.style.backgroundSize='cover';avatarDiv.style.backgroundPosition='center';avatarDiv.style.backgroundRepeat='no-repeat';}else{avatarDiv.style.background='linear-gradient(135deg,#199AFF,#0066CC)';avatarDiv.style.color='white';avatarDiv.style.display='flex';avatarDiv.style.alignItems='center';avatarDiv.style.justifyContent='center';avatarDiv.style.fontWeight='bold';avatarDiv.style.fontSize='18px';avatarDiv.textContent='群';avatarDiv.style.backgroundImage='';}}}async function restoreGroupChats(){if(!worldbook){return;}const groups=window.QQ_Group_Chats_Data||[];groups.forEach(groupData=>{AddNewGroup(groupData.name,groupData.avatar||'https:});}let currentManagingGroup=null;function showGroupManagementMenu(groupData,triggerElement){console.log('原始groupData:',JSON.stringify(groupData,null,2));currentManagingGroup=Object.assign({},groupData);try{const worldbookAvatar=getGroupAvatarFromWorldbook(groupData.name);if(worldbookAvatar&&worldbookAvatar.avatarUrl){if(worldbookAvatar.avatarUrl.startsWith('data:')){currentManagingGroup.avatar={type:'upload',imageData:worldbookAvatar.avatarUrl,dataSize:Math.round(worldbookAvatar.avatarUrl.length*0.75)};}else{currentManagingGroup.avatar=worldbookAvatar.avatarUrl;}}else{}}catch(error){console.error('从世界书获取头像失败:',error);}const dropdown=document.getElementById('group_management_dropdown');if(!dropdown){console.error('未找到群聊管理下拉菜单元素');return;}const rect=triggerElement.getBoundingClientRect();dropdown.style.position='fixed';dropdown.style.top=(rect.bottom+5)+'px';dropdown.style.left=rect.left+'px';dropdown.style.width=Math.max(200,rect.width)+'px';const membersList=document.getElementById('group_members_display');membersList.innerHTML='';groupData.members.forEach((memberName,index)=>{const memberItem=document.createElement('div');memberItem.className='group-member-item';const memberAvatar=document.createElement('div');memberAvatar.className='group-member-avatar';const worldbookAvatar=getCharacterAvatarFromWorldbook(memberName);if(worldbookAvatar){memberAvatar.style.backgroundImage=worldbookAvatar.backgroundImage;memberAvatar.style.backgroundSize='cover';memberAvatar.style.backgroundPosition='center';memberAvatar.style.backgroundRepeat='no-repeat';memberAvatar.style.borderRadius='50%';memberAvatar.style.width='32px';memberAvatar.style.height='32px';memberAvatar.style.flexShrink='0';memberAvatar.textContent='';}else{const memberAvatarData=getCharacterAvatar(memberName);applyCharacterAvatar(memberAvatar,memberAvatarData,memberName);memberAvatar.style.width='32px';memberAvatar.style.height='32px';}const memberNameDiv=document.createElement('div');memberNameDiv.className='group-member-name';memberNameDiv.textContent=memberName;memberItem.appendChild(memberAvatar);memberItem.appendChild(memberNameDiv);membersList.appendChild(memberItem);});dropdown.style.display='block';setTimeout(()=>{document.addEventListener('click',closeGroupManagementMenu);},100);}function closeGroupManagementMenu(event){const dropdown=document.getElementById('group_management_dropdown');if(!dropdown)return;if(event&&dropdown.contains(event.target)){return;}dropdown.style.display='none';document.removeEventListener('click',closeGroupManagementMenu);}function showGroupSettings(){if(!currentManagingGroup){console.error('没有当前管理的群聊');return;}closeGroupManagementMenu();const modal=document.getElementById('group_settings_modal');if(!modal){console.error('未找到群聊设置模态窗口');return;}const nameInput=document.getElementById('group_name_edit');if(nameInput){nameInput.value=currentManagingGroup.name;}const avatarPreview=document.getElementById('group_settings_avatar_preview');if(avatarPreview){avatarPreview.innerHTML='';const worldbookGroupAvatar=getGroupAvatarFromWorldbook(currentManagingGroup.name);let realAvatarFound=false;if(worldbookGroupAvatar){const avatarImg=document.createElement('div');avatarImg.style.backgroundImage=worldbookGroupAvatar.backgroundImage;avatarImg.style.backgroundSize='cover';avatarImg.style.backgroundPosition='center';avatarImg.style.backgroundRepeat='no-repeat';avatarImg.style.borderRadius='12px';avatarImg.style.width='100%';avatarImg.style.height='100%';avatarPreview.appendChild(avatarImg);realAvatarFound=true;}else{const contactsContainer=document.getElementById('QQ_home_chars');if(contactsContainer){const groupElements=contactsContainer.querySelectorAll('.QQ_home_char[data-group-type="true"]');for(let element of groupElements){const nameElement=element.querySelector('.QQ_home_name');if(nameElement&&nameElement.textContent.trim()===currentManagingGroup.name){const avatarElement=element.querySelector('.QQ_home_head');if(avatarElement){const avatarClone=document.createElement('div');avatarClone.style.cssText=avatarElement.style.cssText;avatarClone.style.width='60px';avatarClone.style.height='60px';avatarClone.style.fontSize='20px';avatarClone.textContent=avatarElement.textContent;avatarPreview.appendChild(avatarClone);realAvatarFound=true;break;}}}}if(!realAvatarFound&&currentManagingGroup.avatar){if(currentManagingGroup.avatar.startsWith('avatar_')){const avatarData=localStorage.getItem(`avatarData_${currentManagingGroup.avatar.replace('avatar_','')}`);if(avatarData){const img=document.createElement('img');img.src=avatarData;img.alt='群聊头像';img.style.width='100%';img.style.height='100%';img.style.objectFit='cover';avatarPreview.appendChild(img);realAvatarFound=true;}}else if(currentManagingGroup.avatar.startsWith('http')){const img=document.createElement('img');img.src=currentManagingGroup.avatar;img.alt='群聊头像';img.style.width='100%';img.style.height='100%';img.style.objectFit='cover';avatarPreview.appendChild(img);realAvatarFound=true;}}}if(!realAvatarFound){const defaultAvatar=document.createElement('div');defaultAvatar.className='group-settings-default-avatar';defaultAvatar.textContent=currentManagingGroup.name.charAt(0);defaultAvatar.style.background='linear-gradient(135deg,#667eea,#764ba2)';defaultAvatar.style.color='white';defaultAvatar.style.width='100%';defaultAvatar.style.height='100%';defaultAvatar.style.display='flex';defaultAvatar.style.alignItems='center';defaultAvatar.style.justifyContent='center';avatarPreview.appendChild(defaultAvatar);}}const membersEdit=document.getElementById('group_members_edit');if(membersEdit){membersEdit.innerHTML='';currentManagingGroup.members.forEach((memberName,index)=>{const memberItem=document.createElement('div');memberItem.className='group-settings-member-item';const memberInfo=document.createElement('div');memberInfo.className='group-settings-member-info';const memberAvatar=document.createElement('div');memberAvatar.className='group-member-avatar';const worldbookAvatar=getCharacterAvatarFromWorldbook(memberName);if(worldbookAvatar){memberAvatar.style.backgroundImage=worldbookAvatar.backgroundImage;memberAvatar.style.backgroundSize='cover';memberAvatar.style.backgroundPosition='center';memberAvatar.style.backgroundRepeat='no-repeat';memberAvatar.style.borderRadius='50%';memberAvatar.style.width='32px';memberAvatar.style.height='32px';memberAvatar.style.flexShrink='0';memberAvatar.textContent='';}else{const memberAvatarData=getCharacterAvatar(memberName);applyCharacterAvatar(memberAvatar,memberAvatarData,memberName);memberAvatar.style.width='32px';memberAvatar.style.height='32px';}const memberNameDiv=document.createElement('div');memberNameDiv.className='group-member-name';memberNameDiv.textContent=memberName;memberInfo.appendChild(memberAvatar);memberInfo.appendChild(memberNameDiv);const removeBtn=document.createElement('button');removeBtn.className='group-settings-remove-btn';removeBtn.textContent='移除';removeBtn.onclick=()=>removeMemberFromGroup(memberName);memberItem.appendChild(memberInfo);memberItem.appendChild(removeBtn);membersEdit.appendChild(memberItem);});const addMemberItem=document.createElement('div');addMemberItem.className='group-settings-add-member-item';const addMemberBtn=document.createElement('button');addMemberBtn.className='group-settings-add-member-btn';addMemberBtn.innerHTML='<span class="add-member-icon">+</span><span class="add-member-text">添加成员</span>';addMemberBtn.onclick=()=>showAddMemberModal();addMemberItem.appendChild(addMemberBtn);membersEdit.appendChild(addMemberItem);}modal.style.display='flex';}function closeGroupSettings(){const modal=document.getElementById('group_settings_modal');if(modal){modal.style.display='none';}}async function removeMemberFromGroup(memberName){if(!currentManagingGroup)return;if(confirm(`确定要将 ${memberName}移出群聊吗？`)){const index=currentManagingGroup.members.indexOf(memberName);if(index>-1){currentManagingGroup.members.splice(index,1);if(window.currentGroupChat&&window.currentGroupChat.id===currentManagingGroup.id){window.currentGroupChat.members=currentManagingGroup.members;updateChatHeader(currentManagingGroup);}const systemMessage=`群主将${memberName}移出了群聊`;await addSystemMessageToGroup(currentManagingGroup.id,systemMessage);displaySystemMessage(systemMessage,currentManagingGroup.id);await protectedContactListUpdate(currentManagingGroup,'remove_member');await updateGroupMembersInWorldbook(currentManagingGroup.name,currentManagingGroup.members);await refreshGroupChatsDisplay();showGroupSettings();}}}function showGroupAvatarSelector(){if(!currentManagingGroup){console.error('没有当前管理的群聊');return;}window.isSelectingGroupAvatar=true;window.currentAvatarGroup=currentManagingGroup;const avatarModal=document.getElementById('avatar_selector_modal');if(avatarModal){avatarModal.style.display='flex';switchAvatarTab('upload');}else{console.error('未找到头像选择器模态窗口');}}async function saveGroupSettings(){if(!currentManagingGroup)return;const nameInput=document.getElementById('group_name_edit');const newName=nameInput ? nameInput.value.trim():'';if(!newName){alert('群聊名称不能为空');return;}try{if(!worldbook){worldbook=await GetWorldBookName();if(!worldbook){console.error('无法获取世界书，保存操作终止');alert('无法连接到世界书，请稍后重试');return;}}if(!entries){entries=await getLorebookEntries(worldbook);if(!entries){console.error('无法获取世界书条目，保存操作终止');alert('无法读取世界书数据，请稍后重试');return;}}}catch(error){console.error('世界书初始化失败:',error);alert('世界书初始化失败，请稍后重试');return;}const oldName=currentManagingGroup.name;const oldId=currentManagingGroup.id;const oldAvatar=currentManagingGroup.avatar;let originalGroupName=oldName;try{if(entries){const groupEntry=entries.find(e=>e.comment===`手机-群聊-${oldName}`||e.comment.startsWith('手机-群聊-')&&e.content.includes(`[${oldName}]`));if(groupEntry&&groupEntry.comment.startsWith('手机-群聊-')){originalGroupName=groupEntry.comment.replace('手机-群聊-','');}}}catch(error){console.warn('获取原始群聊名称时出错，使用当前名称:',error);}const stableGroupId=`group_${originalGroupName.replace(/[^a-zA-Z0-9\u4e00-\u9fff]/g,'_')}`;console.log('使用稳定的群聊ID:',stableGroupId,'(基于原始名称:',originalGroupName,')');const changes=[];if(newName!==oldName){const migratedCount=await migrateGroupDataBindings(oldName,newName,currentManagingGroup);currentManagingGroup.name=newName;currentManagingGroup.id=stableGroupId;changes.push({type:'name',oldValue:oldName,newValue:newName});}if(window.selectedAvatarData){currentManagingGroup.avatar=window.selectedAvatarData;if(window.selectedAvatarData.type==='upload'&&window.selectedAvatarData.imageData){currentManagingGroup.avatarUrl=window.selectedAvatarData.imageData;}changes.push({type:'avatar',oldValue:oldAvatar,newValue:window.selectedAvatarData});}else{if(currentManagingGroup.avatar){if(typeof currentManagingGroup.avatar==='string'){}else if(typeof currentManagingGroup.avatar==='object'&&currentManagingGroup.avatar.type){if(currentManagingGroup.avatarUrl&&currentManagingGroup.avatar.type==='upload'&&!currentManagingGroup.avatar.imageData){currentManagingGroup.avatar.imageData=currentManagingGroup.avatarUrl;}}else{if(currentManagingGroup.avatarUrl){currentManagingGroup.avatar=currentManagingGroup.avatarUrl;}else{currentManagingGroup.avatar={type:'preset',text:'群',gradient:{start:'#199AFF',end:'#0066CC'}};}}}else{if(currentManagingGroup.avatarUrl){currentManagingGroup.avatar=currentManagingGroup.avatarUrl;}else{currentManagingGroup.avatar={type:'preset',text:'群',gradient:{start:'#199AFF',end:'#0066CC'}};}}}if(window.currentGroupChat&&window.currentGroupChat.id===stableGroupId){window.currentGroupChat.name=currentManagingGroup.name;window.currentGroupChat.avatar=currentManagingGroup.avatar;window.currentGroupChat.avatarUrl=currentManagingGroup.avatarUrl;window.currentGroupChat.members=currentManagingGroup.members;}let chatHeader=null;const visibleChatPage=document.querySelector('.QQ_chat_page[style*="display:block"],.QQ_chat_page:not([style*="display:none"])');if(visibleChatPage){chatHeader=visibleChatPage.querySelector('.QQ_chat_header,.QQ_home');}if(chatHeader){updateHeaderContent(chatHeader,currentManagingGroup);}else{}setTimeout(async()=>{reapplyGroupChatBackground(currentManagingGroup);await protectedContactListUpdate(currentManagingGroup,oldName);},150);currentManagingGroup.id=stableGroupId;if(oldName!==newName){await updateGroupNameInWorldbook(oldName,newName);}else{await saveGroupToWorldbook(currentManagingGroup);}if(changes.length>0){for(const change of changes){let systemMessage='';switch(change.type){case 'name':systemMessage=`群聊名称已更改为"${change.newValue}"`;break;case 'avatar':systemMessage=`群主已更改群头像`;break;}if(systemMessage){await addSystemMessageToGroup(stableGroupId,systemMessage);displaySystemMessage(systemMessage,currentManagingGroup.id);}}}if(oldName!==newName){await updateGroupChatMessagesInMsgjson(stableGroupId,oldName,newName);}window.selectedAvatarData=null;alert('群聊设置已保存');closeGroupSettings();}async function deleteCurrentGroup(){if(!currentManagingGroup)return;if(confirm(`确定要删除群聊 "${currentManagingGroup.name}" 吗？此操作不可撤销。`)){const deletedGroupId=currentManagingGroup.id;const deletedGroupName=currentManagingGroup.name;closeGroupSettings();let shouldJumpToPage=null;let wasInGroupChat=false;if(window.currentGroupChat&&window.currentGroupChat.id===deletedGroupId){shouldJumpToPage=window.groupChatSourcePage||'people';wasInGroupChat=true;}else{shouldJumpToPage='people';}setTimeout(async()=>{try{await removeGroupFromWorldbook(deletedGroupName);entries=await getLorebookEntries(worldbook);delete QQ_msgjson.群聊[deletedGroupName];if(wasInGroupChat){window.currentGroupChat=null;window.groupChatSourcePage=null;}if(typeof QQ_Nav==='function'){if(shouldJumpToPage==='messages'){QQ_Nav('message');}else{QQ_Nav('people');}}else{console.warn('QQ_Nav函数不可用，手动显示联系人页面');$('.QQ_chat_page').hide();$('.group-chat-page').hide();$('#QQ_home_page').show();$('.QQ_bottom_nav').show();}safeRemoveGroupFromInterface(deletedGroupId,deletedGroupName);await QQ_Enhance_Group_Metadata();await QQ_UpdateMessageList();alert('群聊已删除');QQ_Groups.length=0;if(entries){const remainingGroupEntries=entries.filter(e=>e.comment&&e.comment.startsWith("手机-群聊-"));remainingGroupEntries.forEach(entry=>{const groupName=entry.comment.replace('手机-群聊-','');if(groupName&&!QQ_Groups.includes(groupName)){QQ_Groups.push(groupName);}});}if(typeof renderContactGroups==='function'){await renderContactGroups();}else{console.error('❌ renderContactGroups函数不可用');}}catch(error){console.error('删除群聊时出错:',error);alert('删除群聊时出现问题，请刷新页面');if(wasInGroupChat){window.currentGroupChat=null;window.groupChatSourcePage=null;}$('.QQ_chat_page').hide();$('.group-chat-page').hide();$('#QQ_home_page').show();$('.QQ_bottom_nav').show();if(typeof QQ_Nav==='function'){QQ_Nav('people');}}currentManagingGroup=null;},100);}}async function updateGroupInAllListsWithAvatar(groupData){const contactsContainer=document.getElementById('QQ_home_chars');if(contactsContainer){const existingGroup=contactsContainer.querySelector(`[data-group-id="${groupData.id}"]`);if(existingGroup){const nameElement=existingGroup.querySelector('.QQ_home_name');const avatarElement=existingGroup.querySelector('.QQ_home_head');if(nameElement){nameElement.textContent=groupData.name;}if(avatarElement&&groupData.avatar){updateAvatarElement(avatarElement,groupData.avatar);}}}const messagesContainer=document.getElementById('QQ_message_list_chars');if(messagesContainer){const existingGroup=messagesContainer.querySelector(`[data-group-id="${groupData.id}"]`);if(existingGroup){const nameElement=existingGroup.querySelector('.QQ_home_name');const avatarElement=existingGroup.querySelector('.QQ_home_head');if(nameElement){nameElement.textContent=groupData.name;}if(avatarElement&&groupData.avatar){updateAvatarElement(avatarElement,groupData.avatar);}}}}function updateGroupInAllLists(groupData){const contactsContainer=document.getElementById('QQ_home_chars');if(contactsContainer){const existingGroup=contactsContainer.querySelector(`[data-group-id="${groupData.id}"]`);if(existingGroup){const nameElement=existingGroup.querySelector('.QQ_home_name');if(nameElement){nameElement.textContent=groupData.name;}}}const messagesContainer=document.getElementById('QQ_message_list_chars');if(messagesContainer){const existingGroup=messagesContainer.querySelector(`[data-group-id="${groupData.id}"]`);if(existingGroup){const nameElement=existingGroup.querySelector('.QQ_home_name');if(nameElement){nameElement.textContent=groupData.name;}}}}async function autoReloadInterfaceAfterGroupUpdate(updatedGroupData){try{if(window.QQ_Groups&&Array.isArray(window.QQ_Groups)){const groupIndex=window.QQ_Groups.findIndex(g=>g.id===updatedGroupData.id);if(groupIndex!==-1){window.QQ_Groups[groupIndex].name=updatedGroupData.name;window.QQ_Groups[groupIndex].avatar=updatedGroupData.avatar;window.QQ_Groups[groupIndex].avatarUrl=updatedGroupData.avatarUrl;}}if(window.currentGroupChat&&window.currentGroupChat.id===updatedGroupData.id){window.currentGroupChat.name=updatedGroupData.name;window.currentGroupChat.avatar=updatedGroupData.avatar;window.currentGroupChat.avatarUrl=updatedGroupData.avatarUrl;updateChatHeader(updatedGroupData);}await protectedContactListUpdate(updatedGroupData,'group_update');}catch(error){console.error('轻量级界面更新时出错:',error);console.warn('界面更新时出现问题，但群聊设置已保存，消息数据完整');}}async function refreshGroupChatsDisplay(){try{await updateExistingGroupElements();}catch(error){console.error('刷新群聊显示时出错:',error);alert('界面更新时出现问题，建议手动刷新页面。');}}async function updateExistingGroupElements(){try{const latestGroups=window.QQ_Groups||[];if(latestGroups.length===0){console.warn('内存中没有群聊数据，跳过更新');return;}const contactsContainer=document.getElementById('QQ_home_chars');const messagesContainer=document.getElementById('QQ_message_list_chars');if(contactsContainer&&latestGroups){for(const groupData of latestGroups){if(groupData&&groupData.name){const existingElement=contactsContainer.querySelector(`[data-group-id="${groupData.id}"]`);if(existingElement){updateGroupElement(existingElement,groupData);}else{}}}}if(messagesContainer&&latestGroups){console.log('群聊数据:',latestGroups.map(g=>({name:g.name,id:g.id})));const existingElements=messagesContainer.querySelectorAll('[data-group-id]');console.log('消息列表中现有的群聊元素:',Array.from(existingElements).map(el=>({name:el.querySelector('.QQ_home_name')?.textContent,dataGroupId:el.getAttribute('data-group-id')})));for(const groupData of latestGroups){if(groupData&&groupData.name){console.log(`\n---处理群聊:${groupData.name}(ID:${groupData.id})---`);const existingElement=messagesContainer.querySelector(`[data-group-id="${groupData.id}"]`);if(!existingElement){const nameElements=messagesContainer.querySelectorAll('.QQ_home_name');let foundByName=null;for(const nameEl of nameElements){if(nameEl.textContent.trim()===groupData.name){foundByName=nameEl.closest('[data-group-id]');break;}}if(foundByName){foundByName.setAttribute('data-group-id',groupData.id);updateGroupElement(foundByName,groupData);}else{console.warn(`❌ 群聊 "${groupData.name}" 在消息列表中完全找不到，可能已被删除或隐藏`);if(groupData.name==='港区'){console.error('🚨 特别关注：港区群聊在消息列表中找不到！');console.log('港区群聊完整数据:',JSON.stringify(groupData,null,2));existingElements.forEach(el=>{console.log('元素:',{innerHTML:el.innerHTML.substring(0,200),dataGroupId:el.getAttribute('data-group-id'),nameText:el.querySelector('.QQ_home_name')?.textContent});});const messagesContainer=document.querySelector('#QQ_messages_list');if(messagesContainer){const allGroupElements=messagesContainer.querySelectorAll('.QQ_home_lxr');for(const element of allGroupElements){const nameEl=element.querySelector('.QQ_home_name');if(nameEl&&nameEl.textContent.trim()==='港区'){element.setAttribute('data-group-id',groupData.id||'group_gangqu');updateGroupElement(element,groupData);return;}}const groupElement=createGroupElementForDisplay({...groupData,id:groupData.id||'group_gangqu',name:'港区'});if(groupElement){messagesContainer.insertBefore(groupElement,messagesContainer.firstChild);}}}}}else{updateGroupElement(existingElement,groupData);}}}}}catch(error){console.error('更新现有群聊元素时出错:',error);}}function updateGroupElement(element,groupData){try{const nameElement=element.querySelector('.QQ_home_name');if(nameElement){nameElement.textContent=groupData.name;}const avatarElement=element.querySelector('.QQ_home_head');if(avatarElement){if(groupData.avatar&&typeof groupData.avatar==='object'&&groupData.avatar.type){updateAvatarElement(avatarElement,groupData.avatar);}else if(groupData.avatarUrl&&typeof groupData.avatarUrl==='string'){updateAvatarElement(avatarElement,groupData.avatarUrl);}else if(groupData.avatar&&typeof groupData.avatar==='string'){updateAvatarElement(avatarElement,groupData.avatar);}else if(window.QQ_Groups&&groupData.id){const fullGroupData=window.QQ_Groups.find(g=>g.id===groupData.id||g.name===groupData.name);if(fullGroupData&&fullGroupData.avatar){updateAvatarElement(avatarElement,fullGroupData.avatar);}else{console.warn('从QQ_Groups中也未找到头像数据，保持现有头像');}}else{console.warn('没有有效的头像数据，保持现有头像');}}else{console.warn('未找到头像元素');}}catch(error){console.error('更新群聊元素时出错:',error);}}async function addSystemMessageToGroup(groupId,systemMessage){try{if(!window.groupChatMessages){window.groupChatMessages={};}if(!window.groupChatMessages[groupId]){window.groupChatMessages[groupId]=[];}const systemMessageObj={id:'system_'+Date.now()+'_'+Math.random().toString(36).substr(2,9),type:'system',content:systemMessage,timestamp:new Date().toISOString(),sender:'system'};window.groupChatMessages[groupId].push(systemMessageObj);if(window.currentGroupChat&&window.currentGroupChat.id===groupId){displaySystemMessage(systemMessage,groupId);}}catch(error){console.error('添加系统消息时出错:',error);}}function displaySystemMessage(message,targetGroupId=null){try{let msgContent=null;const containerSelectors=['.QQ_chat_page[style*="display:block"].msgcontent','.QQ_chat_page:not([style*="display:none"]).msgcontent','.msgcontent:not([style*="display:none"])','.msgcontent','#QQ_chat_msgs'];for(const selector of containerSelectors){const elements=document.querySelectorAll(selector);for(const element of elements){if(element&&element.offsetParent!==null&&element.offsetWidth>0&&element.offsetHeight>0){msgContent=element;break;}}if(msgContent)break;}if(!msgContent){const activeChatPage=document.querySelector('.QQ_chat_page[style*="display:block"]')||document.querySelector('.QQ_chat_page:not([style*="display:none"])');if(activeChatPage){msgContent=activeChatPage.querySelector('.msgcontent');if(!msgContent){msgContent=document.createElement('div');msgContent.className='msgcontent';msgContent.style.cssText=`
flex:1;overflow-y:auto;box-sizing:border-box;margin-bottom:50px;padding-left:8px;padding-right:8px;scrollbar-width:none;-ms-overflow-style:none;height:calc(100%-120px);position:relative;`;activeChatPage.appendChild(msgContent);}}}if(!msgContent){console.error('无法找到任何消息容器来显示系统消息');const fallbackMsg=document.createElement('div');fallbackMsg.style.cssText=`
position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:white;padding:10px 20px;border-radius:5px;z-index:999999;font-size:14px;`;fallbackMsg.textContent=message;document.body.appendChild(fallbackMsg);setTimeout(()=>fallbackMsg.remove(),3000);return;}const systemMsgDiv=document.createElement('div');systemMsgDiv.className='system-message-chat';systemMsgDiv.setAttribute('data-message-type','system');systemMsgDiv.setAttribute('data-timestamp',Date.now());systemMsgDiv.style.cssText=`
text-align:center!important;color:#999999!important;font-size:12px!important;margin:10px auto!important;padding:5px 10px!important;line-height:1.4!important;background:transparent!important;border:none!important;max-width:90%!important;position:relative!important;z-index:10!important;word-wrap:break-word!important;white-space:normal!important;display:block!important;clear:both!important;font-weight:normal!important;opacity:1!important;visibility:visible!important;box-sizing:border-box!important;width:auto!important;min-height:20px!important;font-family:inherit!important;`;systemMsgDiv.textContent=message;msgContent.appendChild(systemMsgDiv);systemMsgDiv.offsetHeight;setTimeout(()=>{msgContent.scrollTop=msgContent.scrollHeight;},50);setTimeout(()=>{if(document.contains(systemMsgDiv)){const computedStyle=window.getComputedStyle(systemMsgDiv);}else{console.error('❌ 系统消息未能添加到DOM中');}},200);}catch(error){console.error('显示系统消息时出错:',error);console.error('错误详情:',error.stack);}}async function addSystemMessagesForChanges(groupId,changes){if(!changes||changes.length===0){return;}for(const change of changes){let systemMessage='';switch(change.type){case 'name':systemMessage=`群聊名称已更改为"${change.newValue}"`;break;case 'avatar':systemMessage=`群主已更改群头像`;break;case 'add_member':systemMessage=`${change.operator}邀请${change.newValue}加入群聊`;break;case 'remove_member':systemMessage=`${change.operator}将${change.oldValue}移出群聊`;break;default:systemMessage=`群聊设置已更新`;break;}if(systemMessage){await addSystemMessageToGroup(groupId,systemMessage);}}}async function updateGroupChatMessagesInMsgjson(groupId,oldName,newName){try{if(window.groupChatMessages&&window.groupChatMessages[groupId]){const messages=window.groupChatMessages[groupId];}if(window.msgjson&&window.msgjson.data){Object.keys(window.msgjson.data).forEach(userId=>{const userMessages=window.msgjson.data[userId];if(Array.isArray(userMessages)){userMessages.forEach(message=>{if(message.mes&&typeof message.mes==='string'&&message.mes.includes(oldName)){}});}});}}catch(error){console.error('更新群聊消息信息时出错:',error);}}function reapplyGroupChatBackground(groupData){try{if(!groupData||!groupData.name){console.warn('群聊数据无效，跳过背景应用');return;}const randomBackground=getRandomChatBackground();if(!randomBackground){console.warn('未获取到有效背景，跳过应用');return;}const groupName=groupData.name;$(`style[data-group-bg="${groupName}"]`).remove();const backgroundCSS=`
.QQ_chat_page[data-name='${groupName}']{--BackGroundImg:url('${randomBackground}');background-image:var(--BackGroundImg)!important;background-size:cover!important;background-position:center!important;background-repeat:no-repeat!important;background-color:transparent!important;}`;const style=$("<style></style>").prop("type","text/css");style.attr('data-group-bg',groupName);style.text(backgroundCSS);$("head").append(style);setTimeout(()=>{const chatPage=document.querySelector(`.QQ_chat_page[data-name="${groupName}"]`);if(chatPage){const finalBg=window.getComputedStyle(chatPage).backgroundImage;if(finalBg==='none'){console.warn('背景应用失败：最终背景为none');}else if(finalBg.includes('url(')){}else{}}},200);}catch(error){console.error('重新应用群聊背景时出错:',error);}}async function migrateGroupDataBindings(oldName,newName,groupData){try{let migratedCount=0;if(window.wallpaperurl){if(window.wallpaperurl[oldName]){window.wallpaperurl[newName]=window.wallpaperurl[oldName];delete window.wallpaperurl[oldName];migratedCount++;}if(groupData.members&&groupData.members.length>0){const firstMember=groupData.members[0];if(window.wallpaperurl[firstMember]){}else{window.wallpaperurl[firstMember]='https:migratedCount++;}}}if(!window.QQ_Groups){console.warn('QQ_Groups数组不存在，重新初始化');window.QQ_Groups=[];}const groupIndex=window.QQ_Groups.findIndex(g=>g&&(g.id===groupData.id||g.name===oldName||g.name===newName));if(groupIndex>-1){console.log(`头像数据迁移:${groupData.avatar ? JSON.stringify(groupData.avatar):'null'}`);window.QQ_Groups[groupIndex]={...window.QQ_Groups[groupIndex],name:groupData.name,id:groupData.id,avatar:groupData.avatar,avatarUrl:groupData.avatarUrl,members:groupData.members};migratedCount++;}else{window.QQ_Groups.push(groupData);migratedCount++;}console.log('QQ_Groups数组内容:',window.QQ_Groups.map(g=>({name:g.name,id:g.id})));try{const storageKeys=Object.keys(localStorage);for(const key of storageKeys){if(key.includes(oldName)){const value=localStorage.getItem(key);const newKey=key.replace(oldName,newName);localStorage.setItem(newKey,value);localStorage.removeItem(key);migratedCount++;}}}catch(storageError){console.warn('localStorage数据迁移时出错:',storageError);}if(window.groups&&Array.isArray(window.groups)){const groupIndex=window.groups.findIndex(g=>g&&g.name===oldName||g.name===newName);if(groupIndex!==-1){window.groups[groupIndex].name=newName;migratedCount++;}}const elementsWithOldName=document.querySelectorAll(`[data-name="${oldName}"]`);elementsWithOldName.forEach(el=>{el.setAttribute('data-name',newName);migratedCount++;});if(window.groupChats&&window.groupChats[oldName]){window.groupChats[newName]=window.groupChats[oldName];delete window.groupChats[oldName];migratedCount++;}const currentChatPage=document.querySelector('.QQ_chat_page:not([style*="display:none"]):not([style*="display:none"])');if(currentChatPage){const pageGroupId=currentChatPage.getAttribute('data-group-id');const pageDataName=currentChatPage.getAttribute('data-name');const isTargetChatPage=(pageGroupId===groupData.id)||(pageDataName===oldName)||(pageDataName===newName);if(isTargetChatPage){currentChatPage.setAttribute('data-group-id',groupData.id);currentChatPage.setAttribute('data-name',groupData.name);if(window.currentGroupChat&&(window.currentGroupChat.id===groupData.id||window.currentGroupChat.name===oldName)){window.currentGroupChat.name=groupData.name;window.currentGroupChat.avatar=groupData.avatar;window.currentGroupChat.avatarUrl=groupData.avatarUrl;window.currentGroupChat.members=groupData.members;}const chatUsernameElement=currentChatPage.querySelector('#QQ_chat_username');if(chatUsernameElement){const displayName=groupData.members&&groupData.members.length>1
? `${groupData.name}(${groupData.members.length}人)`:groupData.name;chatUsernameElement.textContent=displayName;chatUsernameElement.setAttribute('data-group-name',groupData.name);chatUsernameElement.setAttribute('data-group-id',groupData.id);}else{console.warn('未找到#QQ_chat_username元素');}const chatHeader=currentChatPage.querySelector('.QQ_chat_header')||currentChatPage.querySelector('.QQ_home')||currentChatPage.querySelector('[class*="header"]');if(chatHeader){updateHeaderContent(chatHeader,groupData);}else{console.warn('未找到聊天头部元素');console.log('聊天页面结构:',currentChatPage.outerHTML.substring(0,500));}setTimeout(()=>{const delayedUsernameElement=currentChatPage.querySelector('#QQ_chat_username');if(delayedUsernameElement){const delayedDisplayName=groupData.members&&groupData.members.length>1
? `${groupData.name}(${groupData.members.length}人)`:groupData.name;delayedUsernameElement.textContent=delayedDisplayName;}const delayedChatHeader=currentChatPage.querySelector('.QQ_chat_header')||currentChatPage.querySelector('.QQ_home')||currentChatPage.querySelector('[class*="header"]');if(delayedChatHeader){updateHeaderContent(delayedChatHeader,groupData);}},50);reapplyGroupChatBackground(groupData);}else{}}else{}setTimeout(()=>{const event=new CustomEvent('groupDataMigrated',{detail:{oldName,newName,groupData}});window.dispatchEvent(event);reapplyGroupChatBackground(groupData);},100);return migratedCount;}catch(error){console.error('群聊数据迁移时出错:',error);return 0;}}async function protectedContactListUpdate(groupData,operation='group_update'){try{const contactsContainer=document.getElementById('QQ_home_chars');if(!contactsContainer){console.warn('联系人容器未找到');return;}let targetElements=[];if(groupData.id){const byGroupId=contactsContainer.querySelectorAll(`[data-group-id="${groupData.id}"]`);targetElements.push(...byGroupId);console.log(`方法1(data-group-id)找到 ${byGroupId.length}个元素`);}if(operation&&operation!=='group_update'&&targetElements.length===0){const byOldName=contactsContainer.querySelectorAll(`[data-name="${operation}"]`);targetElements.push(...byOldName);console.log(`方法2(data-name操作参数)找到 ${byOldName.length}个元素`);}if(groupData.name&&targetElements.length===0){const byNewName=contactsContainer.querySelectorAll(`[data-name="${groupData.name}"]`);targetElements.push(...byNewName);console.log(`方法3(data-name新名称)找到 ${byNewName.length}个元素`);}targetElements=[...new Set(targetElements)];if(targetElements.length===0){console.warn('未找到需要更新的联系人元素，跳过更新');return;}let successCount=0;let errorCount=0;targetElements.forEach((element,index)=>{try{if(!element.classList.contains('QQ_home_usermsg')){console.warn(`元素${index+1}不是有效的联系人元素，跳过`);return;}element.setAttribute('data-group-id',groupData.id);element.setAttribute('data-name',groupData.name);const nameElement=element.querySelector('.QQ_home_name');if(nameElement&&nameElement.textContent.trim()!==groupData.name){const oldText=nameElement.textContent.trim();nameElement.textContent=groupData.name;}const avatarElement=element.querySelector('.QQ_home_head');if(avatarElement&&groupData.avatar){try{const originalClasses=avatarElement.className;const originalId=avatarElement.id;updateAvatarElement(avatarElement,groupData.avatar);if(originalClasses&&!avatarElement.className.includes('QQ_home_head')){avatarElement.className=originalClasses;}if(originalId){avatarElement.id=originalId;}}catch(avatarError){console.error(`更新元素${index+1}头像时出错:`,avatarError);}}else if(!avatarElement){}else if(!groupData.avatar){}successCount++;}catch(elementError){console.error(`更新元素${index+1}时出错:`,elementError);errorCount++;}});setTimeout(()=>{const updatedElements=contactsContainer.querySelectorAll(`[data-name="${groupData.name}"]`);updatedElements.forEach((el,i)=>{const nameEl=el.querySelector('.QQ_home_name');if(nameEl){console.log(`验证元素${i+1}:"${nameEl.textContent.trim()}"`);}});},500);}catch(error){console.error('保护性联系人列表更新时出错:',error);}}function safeUpdateGroupElement(element,groupData){try{if(!element||!groupData)return;console.log('元素当前状态:',{tagName:element.tagName,className:element.className,dataName:element.getAttribute('data-name'),dataGroupId:element.getAttribute('data-group-id')});element.setAttribute('data-group-id',groupData.id);element.setAttribute('data-name',groupData.name);const nameElement=element.querySelector('.QQ_home_name');if(nameElement){const oldName=nameElement.textContent.trim();if(oldName!==groupData.name){nameElement.textContent=groupData.name;}}else{console.warn('未找到群聊名称元素，跳过名称更新');}const avatarElement=element.querySelector('.QQ_home_head');if(avatarElement&&groupData.avatar){const originalClasses=avatarElement.className;const originalId=avatarElement.id;try{updateAvatarElement(avatarElement,groupData.avatar);if(originalClasses&&!avatarElement.className.includes('QQ_home_head')){avatarElement.className=originalClasses;}if(originalId){avatarElement.id=originalId;}}catch(avatarError){console.error('更新头像时出错，保持原状:',avatarError);}}}catch(error){console.error('安全更新群聊元素时出错:',error);try{element.setAttribute('data-group-id',groupData.id);element.setAttribute('data-name',groupData.name);}catch(backupError){console.error('设置备用数据属性也失败:',backupError);}}}function updateAvatarElement(avatarElement,avatarData){if(!avatarElement){console.warn('updateAvatarElement:头像元素不存在');return;}if(!avatarData){console.warn('updateAvatarElement:头像数据不存在，保持现有头像');return;}if(avatarData.type==='preset'){avatarElement.style.background=`linear-gradient(135deg,${avatarData.gradient.start},${avatarData.gradient.end})`;avatarElement.style.backgroundImage='none';avatarElement.style.color='white';avatarElement.style.display='flex';avatarElement.style.alignItems='center';avatarElement.style.justifyContent='center';avatarElement.style.fontWeight='bold';avatarElement.textContent=avatarData.text||'群';}else if(avatarData.type==='upload'&&avatarData.imageData){avatarElement.style.background='none';avatarElement.style.backgroundImage=`url('${avatarData.imageData}')`;avatarElement.style.backgroundSize='cover';avatarElement.style.backgroundPosition='center';avatarElement.style.backgroundRepeat='no-repeat';avatarElement.textContent='';}else if(typeof avatarData==='string'&&avatarData.startsWith('data:')){avatarElement.style.background='none';avatarElement.style.backgroundImage=`url('${avatarData}')`;avatarElement.style.backgroundSize='cover';avatarElement.style.backgroundPosition='center';avatarElement.style.backgroundRepeat='no-repeat';avatarElement.textContent='';}else if(typeof avatarData==='string'&&(avatarData.startsWith('http:avatarElement.style.background='none';avatarElement.style.backgroundImage=`url('${avatarData}')`;avatarElement.style.backgroundSize='cover';avatarElement.style.backgroundPosition='center';avatarElement.style.backgroundRepeat='no-repeat';avatarElement.textContent='';}else{avatarElement.style.background='linear-gradient(135deg,#199AFF,#0066CC)';avatarElement.style.backgroundImage='none';avatarElement.style.color='white';avatarElement.style.display='flex';avatarElement.style.alignItems='center';avatarElement.style.justifyContent='center';avatarElement.style.fontWeight='bold';avatarElement.textContent='群';}}async function saveGroupToWorldbook(groupData){try{if(!worldbook||!entries){console.warn('世界书功能不可用，无法保存群聊到世界书');return false;}const uniqueComment=`手机-群聊-${groupData.name}`;let groupEntry=entries.find(e=>e.comment===uniqueComment);let avatarReference='http:if(groupData.avatar){if(groupData.avatar.type==='upload'&&groupData.avatar.imageData){avatarReference=groupData.avatar.imageData;}else if(groupData.avatar.type==='preset'){avatarReference=`预设:${groupData.avatar.text||'群'}`;}else if(groupData.avatar.type==='url'&&groupData.avatar.url){avatarReference=groupData.avatar.url;}}else if(groupData.avatarUrl){avatarReference=groupData.avatarUrl;}const groupContent=`[${groupData.name}]类型=群聊
成员=${groupData.members.join(',')}头像=${avatarReference}`;if(groupEntry){await setLorebookEntries(worldbook,[{uid:groupEntry.uid,content:groupContent,}]);}else{console.error('未找到群聊条目，无法保存');return false;}return true;}catch(error){console.error('保存群聊到世界书失败:',error);throw error;}}function removeGroupFromAllLists(groupId){const contactsContainer=document.getElementById('QQ_home_chars');if(contactsContainer){const existingGroup=contactsContainer.querySelector(`[data-group-id="${groupId}"]`);if(existingGroup){existingGroup.remove();}}const messagesContainer=document.getElementById('QQ_message_list_chars');if(messagesContainer){const existingGroup=messagesContainer.querySelector(`[data-group-id="${groupId}"]`);if(existingGroup){existingGroup.remove();}}}function forceRemoveGroupFromInterface(groupId,groupName){const elementsById=document.querySelectorAll(`[data-group-id="${groupId}"]`);elementsById.forEach((element,index)=>{element.remove();});const contactsContainer=document.getElementById('QQ_home_chars');if(contactsContainer){const groupElements=contactsContainer.querySelectorAll('.QQ_home_char[data-group-type="true"]');groupElements.forEach(element=>{const nameElement=element.querySelector('.QQ_home_name');if(nameElement&&nameElement.textContent.trim()===groupName){element.remove();}});}const messagesContainer=document.getElementById('QQ_message_list_chars');if(messagesContainer){const groupElements=messagesContainer.querySelectorAll('.QQ_home_char[data-group-type="true"]');groupElements.forEach(element=>{const nameElement=element.querySelector('.QQ_home_name');if(nameElement&&nameElement.textContent.trim()===groupName){element.remove();}});}const chatPages=document.querySelectorAll(`.QQ_chat_page[data-name='${groupName}']`);chatPages.forEach((page,index)=>{page.remove();});const groupChatPages=document.querySelectorAll(`.group-chat-page[data-group-id="${groupId}"]`);groupChatPages.forEach((page,index)=>{page.remove();});}function safeRemoveGroupFromInterface(groupId,groupName){try{const contactsContainer=document.getElementById('QQ_home_chars');if(contactsContainer){const groupElements=contactsContainer.querySelectorAll('.QQ_home_char[data-group-type="true"]');groupElements.forEach(element=>{const nameElement=element.querySelector('.QQ_home_name');if(nameElement&&nameElement.textContent.trim()===groupName){element.remove();}});}const messagesContainer=document.getElementById('QQ_message_list_chars');if(messagesContainer){const groupElements=messagesContainer.querySelectorAll('.QQ_home_char[data-group-type="true"]');groupElements.forEach(element=>{const nameElement=element.querySelector('.QQ_home_name');if(nameElement&&nameElement.textContent.trim()===groupName){element.remove();}});}const groupChatPages=document.querySelectorAll(`.group-chat-page[data-group-id="${groupId}"]`);groupChatPages.forEach((page,index)=>{page.remove();});}catch(error){console.error('安全删除群聊界面元素时出错:',error);}}function showAddMemberModal(){if(!currentManagingGroup){console.error('没有当前管理的群聊');return;}const modal=document.getElementById('add_member_modal');if(!modal){console.error('未找到添加成员模态窗口');return;}const searchInput=document.getElementById('add_member_search_input');if(searchInput){searchInput.value='';}window.selectedMembersToAdd=[];updateAddMemberConfirmButton();loadContactsForAddMember();modal.style.display='flex';}function closeAddMemberModal(){const modal=document.getElementById('add_member_modal');if(modal){modal.style.display='none';}window.selectedMembersToAdd=[];}function loadContactsForAddMember(){const contactList=document.getElementById('add_member_contact_list');if(!contactList){console.error('添加成员联系人列表容器未找到');return;}contactList.innerHTML='';const contactsContainer=document.getElementById('QQ_home_chars');if(!contactsContainer){console.error('联系人容器未找到');return;}const contactElements=contactsContainer.querySelectorAll('.QQ_home_usermsg');const currentMembers=new Set(currentManagingGroup.members);let addedCount=0;contactElements.forEach(element=>{if(element.hasAttribute('data-group-type')){return;}const nameElement=element.querySelector('.QQ_home_name');if(!nameElement)return;const contactName=nameElement.textContent.trim();if(currentMembers.has(contactName)){return;}const contactItem=document.createElement('div');contactItem.className='add-member-contact-item';contactItem.setAttribute('data-contact-name',contactName);const contactAvatar=document.createElement('div');contactAvatar.className='add-member-contact-avatar';const worldbookAvatar=getCharacterAvatarFromWorldbook(contactName);if(worldbookAvatar){contactAvatar.style.backgroundImage=worldbookAvatar.backgroundImage;contactAvatar.style.backgroundSize='cover';contactAvatar.style.backgroundPosition='center';contactAvatar.style.backgroundRepeat='no-repeat';contactAvatar.style.borderRadius='50%';contactAvatar.style.width='40px';contactAvatar.style.height='40px';contactAvatar.style.marginRight='12px';contactAvatar.style.flexShrink='0';contactAvatar.textContent='';}else{const avatarElement=element.querySelector('.QQ_home_head');if(avatarElement){contactAvatar.style.cssText=avatarElement.style.cssText;contactAvatar.style.width='40px';contactAvatar.style.height='40px';contactAvatar.style.marginRight='12px';contactAvatar.style.flexShrink='0';contactAvatar.textContent=avatarElement.textContent;const computedStyle=window.getComputedStyle(avatarElement);if(computedStyle.backgroundImage&&computedStyle.backgroundImage!=='none'){contactAvatar.style.backgroundImage=computedStyle.backgroundImage;}if(computedStyle.backgroundColor&&computedStyle.backgroundColor!=='rgba(0,0,0,0)'){contactAvatar.style.backgroundColor=computedStyle.backgroundColor;}}else{contactAvatar.style.background='linear-gradient(135deg,#667eea,#764ba2)';contactAvatar.style.backgroundImage='';contactAvatar.style.color='white';contactAvatar.style.display='flex';contactAvatar.style.alignItems='center';contactAvatar.style.justifyContent='center';contactAvatar.style.fontWeight='bold';contactAvatar.style.borderRadius='50%';contactAvatar.style.width='40px';contactAvatar.style.height='40px';contactAvatar.style.marginRight='12px';contactAvatar.style.flexShrink='0';contactAvatar.textContent=contactName.charAt(0);}}const contactNameDiv=document.createElement('div');contactNameDiv.className='add-member-contact-name';contactNameDiv.textContent=contactName;const contactStatus=document.createElement('div');contactStatus.className='add-member-contact-status';contactStatus.textContent='点击添加';contactItem.appendChild(contactAvatar);contactItem.appendChild(contactNameDiv);contactItem.appendChild(contactStatus);contactItem.addEventListener('click',function(){toggleMemberSelection(contactName,contactItem);});contactList.appendChild(contactItem);addedCount++;});if(addedCount===0){const noContactDiv=document.createElement('div');noContactDiv.style.cssText='text-align:center;color:#999;padding:20px;font-size:14px;';noContactDiv.textContent='暂无可添加的联系人';contactList.appendChild(noContactDiv);}}function toggleMemberSelection(contactName,contactItem){if(!window.selectedMembersToAdd){window.selectedMembersToAdd=[];}const index=window.selectedMembersToAdd.indexOf(contactName);const statusElement=contactItem.querySelector('.add-member-contact-status');if(index>-1){window.selectedMembersToAdd.splice(index,1);contactItem.classList.remove('selected');statusElement.textContent='点击添加';}else{window.selectedMembersToAdd.push(contactName);contactItem.classList.add('selected');statusElement.textContent='已选中';}updateAddMemberConfirmButton();}function updateAddMemberConfirmButton(){const confirmBtn=document.getElementById('add_member_confirm_btn');if(!confirmBtn)return;const selectedCount=window.selectedMembersToAdd ? window.selectedMembersToAdd.length:0;if(selectedCount>0){confirmBtn.disabled=false;confirmBtn.textContent=`添加成员(${selectedCount})`;}else{confirmBtn.disabled=true;confirmBtn.textContent='添加成员';}}function filterAddMemberContacts(){const searchInput=document.getElementById('add_member_search_input');const contactList=document.getElementById('add_member_contact_list');if(!searchInput||!contactList){return;}const searchTerm=searchInput.value.trim();const search=searchTerm.toLowerCase();const isEmpty=search==='';const contactItems=contactList.querySelectorAll('.add-member-contact-item');let visibleCount=0;const existingNoResult=contactList.querySelector('.no-search-result');if(existingNoResult){existingNoResult.remove();}contactItems.forEach((item,index)=>{const nameElement=item.querySelector('.add-member-contact-name');if(!nameElement){console.warn("联系人项目缺少姓名元素",item);item.style.display='none';return;}const originalName=nameElement.getAttribute('data-original-text')||nameElement.textContent;const name=originalName.toLowerCase();const nameMatches=isEmpty||name.includes(search);const isMatch=nameMatches;if(isMatch){item.style.display='flex';visibleCount++;if(!isEmpty&&nameMatches){highlightAddMemberSearchTerm(nameElement,searchTerm,originalName);}else{if(nameElement.getAttribute('data-original-text')){nameElement.innerHTML=originalName;}}}else{item.style.display='none';}});if(!isEmpty&&visibleCount===0){const noResultDiv=document.createElement('div');noResultDiv.className='no-search-result';noResultDiv.style.cssText='text-align:center;color:#999;padding:20px;font-size:14px;border:1px dashed #ddd;border-radius:8px;margin:10px 0;';noResultDiv.innerHTML=`<div style="font-size:16px;margin-bottom:8px;">🔍</div><div>未找到包含 "<strong>${searchTerm}</strong>" 的联系人</div><div style="font-size:12px;color:#666;margin-top:4px;">请尝试输入其他关键词</div>`;contactList.appendChild(noResultDiv);}}function highlightAddMemberSearchTerm(element,searchTerm,originalText){if(!searchTerm||searchTerm.trim()===''){element.innerHTML=originalText;return;}if(!element.getAttribute('data-original-text')){element.setAttribute('data-original-text',originalText);}const regex=new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`,'gi');const highlightedText=originalText.replace(regex,'<span style="background-color:#FFE066;color:#333;font-weight:bold;padding:1px 2px;border-radius:2px;">$1</span>');element.innerHTML=highlightedText;}async function confirmAddMembers(){if(!currentManagingGroup||!window.selectedMembersToAdd||window.selectedMembersToAdd.length===0){return;}const newMembers=[];window.selectedMembersToAdd.forEach(memberName=>{if(!currentManagingGroup.members.includes(memberName)){currentManagingGroup.members.push(memberName);newMembers.push(memberName);}});saveGroupToStorage(currentManagingGroup);await updateGroupMembersInWorldbook(currentManagingGroup.name,currentManagingGroup.members);if(window.currentGroupChat&&window.currentGroupChat.id===currentManagingGroup.id){window.currentGroupChat.members=currentManagingGroup.members;updateChatHeader(currentManagingGroup);}if(newMembers.length>0){for(const memberName of newMembers){const systemMessage=`群主邀请${memberName}加入群聊`;await addSystemMessageToGroup(currentManagingGroup.id,systemMessage);displaySystemMessage(systemMessage,currentManagingGroup.id);}}await protectedContactListUpdate(currentManagingGroup,'add_member');await refreshGroupChatsDisplay();alert(`已添加 ${newMembers.length}个成员到群聊`);closeAddMemberModal();showGroupSettings();}function cleanupAvatarData(){try{const avatarKeys=[];for(let i=0;i<localStorage.length;i++){const key=localStorage.key(i);if(key&&key.startsWith('avatarData_')){avatarKeys.push(key);}}const usedAvatarIds=new Set();if(entries&&worldbook){const entry=entries.find(e=>e.key==="手机-角色");if(entry&&entry.content){const lines=entry.content.split('\n');lines.forEach(line=>{if(line.startsWith('头像=avatar_')){const avatarId=line.substring(3);usedAvatarIds.add('avatarData_'+avatarId);}});}}else{}let deletedCount=0;avatarKeys.forEach(key=>{if(!usedAvatarIds.has(key)){localStorage.removeItem(key);deletedCount++;}});}catch(error){console.error('清理头像数据失败:',error);}}function getStorageUsage(){try{let totalSize=0;let avatarSize=0;let avatarCount=0;for(let i=0;i<localStorage.length;i++){const key=localStorage.key(i);const value=localStorage.getItem(key);const size=(key.length+value.length)*2;totalSize+=size;if(key.startsWith('avatarData_')){avatarSize+=size;avatarCount++;}}console.log('-总大小:',(totalSize/1024/1024).toFixed(2),'MB');console.log('-头像数据大小:',(avatarSize/1024/1024).toFixed(2),'MB');return{totalSize,avatarSize,avatarCount};}catch(error){console.error('获取存储使用情况失败:',error);return null;}}window.showGroupManagementMenu=showGroupManagementMenu;window.closeGroupManagementMenu=closeGroupManagementMenu;window.showGroupSettings=showGroupSettings;window.closeGroupSettings=closeGroupSettings;window.saveGroupSettings=saveGroupSettings;window.deleteContactGroup=deleteContactGroup;window.deleteGroupChat=deleteGroupChat;window.deleteCurrentGroup=deleteCurrentGroup;window.showAddMemberModal=showAddMemberModal;window.closeAddMemberModal=closeAddMemberModal;window.filterAddMemberContacts=filterAddMemberContacts;window.confirmAddMembers=confirmAddMembers;window.testGroupNameClick=testGroupNameClick;window.debugGroupData=debugGroupData;window.cleanupAvatarData=cleanupAvatarData;window.getStorageUsage=getStorageUsage;setTimeout(()=>{const avatarBtn=document.getElementById('avatar_confirm_btn');const groupBtn=document.getElementById('group_confirm_btn');if(avatarBtn){console.log('-avatar按钮onclick:',avatarBtn.getAttribute('onclick'));}if(groupBtn){console.log('-group按钮onclick:',groupBtn.getAttribute('onclick'));}},1000);async function QQ_SafeSaveToWorldBook(operation,data,key){try{if(!worldbook||!entries){console.warn(`世界书功能不可用，无法保存${operation}`);return false;}const entryData={data:data,operation:operation,timestamp:new Date().toISOString(),version:"1.0"};let entry=entries.find(e=>e.comment===key);if(!entry){entry={comment:key,content:JSON.stringify(entryData),key:[`此世界书永不触发_${key}`],keysecondary:[],order:1000+entries.length,enabled:true,uid:Date.now()+Math.random()};if(worldbook.entries){worldbook.entries.push(entry);}}else{entry.content=JSON.stringify(entryData);}await QQ_SafeSaveWorldInfo(operation);console.log(`${operation}已成功保存到世界书(${key})`);return true;}catch(error){console.error(`保存${operation}到世界书失败:`,error);return false;}}async function QQ_GetFromWorldBook(key){try{if(!worldbook||!entries){console.warn('世界书功能不可用，返回默认值');return null;}const entry=entries.find(e=>e.comment===key);if(entry&&entry.content){const entryData=JSON.parse(entry.content);return entryData.data;}return null;}catch(error){console.error(`从世界书读取数据失败(${key}):`,error);return null;}}function QQ_SaveAllContactsToWorldBook(){const contacts=window.QQ_Contacts||{};return QQ_SafeSaveToWorldBook('联系人数据',contacts,'QQ_联系人数据');}function QQ_SaveAllGroupsToWorldBook(){const groups=window.QQ_Groups||{};return QQ_SafeSaveToWorldBook('群聊数据',groups,'QQ_群聊数据');}function QQ_SaveAllMessagesToWorldBook(){const messages=window.QQ_MessageHistory||{};return QQ_SafeSaveToWorldBook('消息记录',messages,'QQ_消息记录');}function QQ_SaveAllMomentsToWorldBook(){const moments=window.QQ_MomentData||{};return QQ_SafeSaveToWorldBook('动态数据',moments,'QQ_动态数据');}function QQ_SaveAllInteractiveSpacesToWorldBook(){const spaces=window.QQ_InteractiveSpaces||{};const characterSpaces=window.QQ_CharacterSpaces||{};const allSpaces={publicSpaces:spaces,characterSpaces:characterSpaces};return QQ_SafeSaveToWorldBook('互动空间数据',allSpaces,'QQ_互动空间数据');}async function QQ_UnifiedSaveToWorldBook(dataType,dataContent,comment,keyPrefix='QQ'){try{if(!worldbook||!entries){console.warn(`世界书功能不可用，无法保存${dataType}数据`);return false;}let targetEntry=entries.find(entry=>entry.comment===comment);const jsonData=JSON.stringify(dataContent,null,2);if(targetEntry){targetEntry.content=jsonData;}else{const newEntry={uid:Date.now(),comment:comment,key:[`此世界书永不触发_${keyPrefix}_${dataType}`],content:jsonData,enabled:true,order:9998,depth:0};entries.push(newEntry);}const saveSuccess=await QQ_SafeSaveWorldInfo(`${dataType}数据`);if(!saveSuccess){console.warn(`⚠️ ${dataType}数据保存可能未完全同步`);}const verifyEntry=entries.find(entry=>entry.comment===comment);if(verifyEntry&&verifyEntry.content===jsonData){return true;}else{console.error(`❌ 验证失败：${dataType}数据保存可能有问题`);return false;}}catch(error){console.error(`保存${dataType}数据到世界书失败:`,error);return false;}}async function QQ_UnifiedLoadFromWorldBook(comment,defaultValue=null){try{if(!worldbook||!entries){console.warn(`世界书功能不可用，返回默认值`);return defaultValue;}const targetEntry=entries.find(entry=>entry.comment===comment);if(targetEntry&&targetEntry.content){try{const data=JSON.parse(targetEntry.content);if(data&&typeof data==='object'&&data.content!==undefined){return data.content||defaultValue;}else{return data||defaultValue;}}catch(parseError){console.error(`解析世界书数据失败(${comment}):`,parseError);return defaultValue;}}else{return defaultValue;}}catch(error){console.error(`从世界书加载数据失败(${comment}):`,error);return defaultValue;}}async function QQ_SaveInteractiveContentToWorldBook(content,characterName=null){try{const interactiveData={content:content,characterName:characterName,timestamp:new Date().toISOString(),id:`interactive_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,type:characterName ? 'character_specific':'public'};const worldbookKey=characterName ?
`QQ_互动内容备份_${characterName}`:'QQ_互动内容备份';const existingData=await QQ_GetFromWorldBook(worldbookKey);let dataArray=[];if(existingData&&Array.isArray(existingData)){dataArray=existingData;}else if(existingData&&existingData.interactiveContent&&Array.isArray(existingData.interactiveContent)){dataArray=existingData.interactiveContent;}dataArray.unshift(interactiveData);if(dataArray.length>30){dataArray.splice(30);}const success=await QQ_SafeSaveToWorldBook(`互动内容_${characterName||'公共'}`,dataArray,worldbookKey);if(success){return interactiveData.id;}else{console.error('互动内容保存失败：QQ_SafeSaveToWorldBook返回false');return null;}}catch(error){console.error('保存互动内容失败:',error);return null;}}async function QQ_LoadInteractiveContentFromWorldBook(characterName=null){try{const worldbookKey=characterName ?
`QQ_互动内容备份_${characterName}`:'QQ_互动内容备份';const data=await QQ_GetFromWorldBook(worldbookKey);if(data&&Array.isArray(data)){return data;}else if(data&&data.interactiveContent&&Array.isArray(data.interactiveContent)){console.log(`✅ 加载${characterName||'公共'}互动内容(旧格式):${data.interactiveContent.length}个项目`);return data.interactiveContent;}else{return[];}}catch(error){console.error('从世界书加载互动内容失败:',error);return[];}}window.QQ_DataManager={async testGroupLoading(){try{const characterId=getCurrentCharacterId()||'default';if(!worldbook||!entries){console.error('❌ 世界书或entries不可用');return false;}const comment=`QQ_分组备份_${characterId}`;const targetEntry=entries.find(entry=>entry.comment===comment);if(targetEntry){console.log(`📄 条目内容预览:`,targetEntry.content?.substring(0,200)+'...');try{const data=JSON.parse(targetEntry.content);let groupsData=null;if(data&&typeof data==='object'&&data.content!==undefined){groupsData=data.content;}else{groupsData=data;}if(Array.isArray(groupsData)){groupsData.forEach((group,index)=>{console.log(`📂 分组${index+1}:${group.name}(${group.contacts?.length||0}个联系人)`);});return true;}else{console.error(`❌ 分组数据格式错误，不是数组:`,typeof groupsData);return false;}}catch(parseError){console.error(`❌ JSON解析失败:`,parseError);return false;}}else{entries.forEach((entry,index)=>{if(entry.comment&&entry.comment.includes('分组')){}});return false;}}catch(error){console.error('❌ 测试分组加载失败:',error);return false;}},async showStats(){try{if(!QQ_IsWorldBookAvailable()){return;}const characterId=getCurrentCharacterId()||'default';if(QQ_MomentsData&&Array.isArray(QQ_MomentsData)){const totalComments=QQ_MomentsData.reduce((sum,moment)=>sum+(moment.comments?.length||0),0);}const groups=await QQ_LoadContactGroupsFromWorldBook(characterId);const totalContacts=groups.reduce((sum,group)=>sum+(group.contacts?.length||0),0);const publicInteractive=await QQ_LoadInteractiveContentFromWorldBook();const characterInteractive=await QQ_LoadInteractiveContentFromWorldBook(characterId);}catch(error){console.error('获取数据统计失败:',error);}},async optimizeData(){try{if(typeof QQ_CleanOldMoments==='function'){QQ_CleanOldMoments();}if(typeof QQ_OptimizeCommentsStorage==='function'){QQ_OptimizeCommentsStorage();}if(typeof QQ_Save_Moments==='function'){await QQ_Save_Moments();}}catch(error){console.error('数据优化失败:',error);}},async testInteractiveContent(){try{const characterId=getCurrentCharacterId()||'default';if(!worldbook||!entries){console.error('❌ 世界书或entries不可用');return false;}const testContent=`测试互动内容-${new Date().toLocaleString()}\n\n这是一个测试的互动场景，包含以下元素：\n1. 详细的场景描述\n2. 角色的动作和表情\n3. 环境的渲染\n4. 情感的表达`;const interactiveId=await QQ_SaveInteractiveContentToWorldBook(testContent,characterId);if(interactiveId){}else{console.error('❌ 互动内容保存失败');return false;}const loadedContent=await QQ_LoadInteractiveContentFromWorldBook(characterId);if(Array.isArray(loadedContent)&&loadedContent.length>0){console.log(`📄 最新内容预览:`,loadedContent[0].content.substring(0,100)+'...');}else{console.error('❌ 互动内容加载失败或为空');return false;}const worldbookKey=`QQ_互动内容备份_${characterId}`;const verifyData=await QQ_GetFromWorldBook(worldbookKey);if(verifyData&&Array.isArray(verifyData)){if(verifyData.length>0&&verifyData[0].id===interactiveId){console.log(`📝 项目内容预览:${verifyData[0].content.substring(0,50)}...`);return true;}else{console.error(`❌ 最新项目ID不匹配:期望${interactiveId},实际${verifyData[0]?.id}`);return false;}}else{console.error(`❌ 世界书条目验证失败:${worldbookKey}`);return false;}}catch(error){console.error('❌ 测试互动内容失败:',error);return false;}},async testInteractiveSpaces(){try{if(!worldbook||!entries){console.error('❌ 世界书或entries不可用');return false;}const currentSpaceCount=Object.keys(QQ_InteractiveSpaces||{}).length;if(currentSpaceCount>0){Object.keys(QQ_InteractiveSpaces).forEach(spaceId=>{const space=QQ_InteractiveSpaces[spaceId];console.log(`-${spaceId}:${space.name}(${space.characterName})`);});}const saveResult=await QQ_SaveInteractiveSpaces();if(saveResult){}else{console.error('❌ 互动空间保存失败');return false;}const targetEntry=entries.find(entry=>entry.comment===QQ_INTERACTIVE_BACKUP_KEY);if(targetEntry){try{const entryData=JSON.parse(targetEntry.content);if(entryData.spaces&&typeof entryData.spaces==='object'){const savedSpaceCount=Object.keys(entryData.spaces).length;if(savedSpaceCount===currentSpaceCount){}else{console.warn(`⚠️ 数量不一致:内存${currentSpaceCount}vs 保存${savedSpaceCount}`);}}else{console.error('❌ 条目数据格式错误，没有spaces对象');return false;}}catch(parseError){console.error('❌ 条目内容JSON解析失败:',parseError);return false;}}else{console.error(`❌ 世界书条目不存在:${QQ_INTERACTIVE_BACKUP_KEY}`);return false;}const originalSpaces={...QQ_InteractiveSpaces};QQ_InteractiveSpaces={};await QQ_LoadInteractiveSpaces();const loadedSpaceCount=Object.keys(QQ_InteractiveSpaces).length;if(loadedSpaceCount===currentSpaceCount){QQ_InteractiveSpaces=originalSpaces;}else{console.error(`❌ 加载测试失败:期望${currentSpaceCount}个，实际${loadedSpaceCount}个`);QQ_InteractiveSpaces=originalSpaces;return false;}toastr.success('互动空间保存加载测试通过','测试成功');return true;}catch(error){console.error('❌ 测试互动空间时出错:',error);toastr.error('测试过程中出现错误，请查看控制台','测试失败');return false;}},async testInteractiveSpacesConsistency(){try{if(!worldbook||!entries){console.error('❌ 世界书功能不可用');return false;}const interfaceSpaces=QQ_InteractiveSpaces||{};const interfaceSpaceIds=Object.keys(interfaceSpaces);const entry=entries.find(e=>e.comment===QQ_INTERACTIVE_BACKUP_KEY);let worldbookSpaces={};let worldbookSpaceIds=[];if(entry&&entry.content){try{const data=JSON.parse(entry.content);worldbookSpaces=data.spaces||{};worldbookSpaceIds=Object.keys(worldbookSpaces);}catch(parseError){console.error('❌ 世界书数据解析失败:',parseError);return false;}}else{}if(interfaceSpaceIds.length===worldbookSpaceIds.length){const missingInWorldbook=interfaceSpaceIds.filter(id=>!worldbookSpaceIds.includes(id));const missingInInterface=worldbookSpaceIds.filter(id=>!interfaceSpaceIds.includes(id));if(missingInWorldbook.length===0&&missingInInterface.length===0){let contentMismatches=0;interfaceSpaceIds.forEach(spaceId=>{const interfaceSpace=interfaceSpaces[spaceId];const worldbookSpace=worldbookSpaces[spaceId];if(interfaceSpace.content!==worldbookSpace.content){contentMismatches++;console.warn(`⚠️ 空间${spaceId}内容不一致`);}});if(contentMismatches===0){return true;}else{console.error(`❌ 有${contentMismatches}个空间内容不一致`);return false;}}else{console.error('❌ 空间ID不匹配:');if(missingInWorldbook.length>0){console.error(' 界面有但世界书没有:',missingInWorldbook);}if(missingInInterface.length>0){console.error(' 世界书有但界面没有:',missingInInterface);}return false;}}else{console.error(`❌ 空间数量不一致:界面${interfaceSpaceIds.length}vs 世界书${worldbookSpaceIds.length}`);return false;}}catch(error){console.error('❌ 测试数据一致性时出错:',error);return false;}},async saveAll(){try{if(typeof QQ_Save_Moments==='function'){await QQ_Save_Moments();}if(typeof saveGroupsToStorage==='function'){await saveGroupsToStorage();}if(typeof QQ_SaveInteractiveSpaces==='function'){await QQ_SaveInteractiveSpaces();}}catch(error){console.error('保存数据失败:',error);}},async testWorldBook(){try{const testData={test:true,timestamp:new Date().toISOString()};const testComment='QQ_测试数据_临时';const saveSuccess=await QQ_UnifiedSaveToWorldBook('测试',testData,testComment,'测试');const loadedData=await QQ_UnifiedLoadFromWorldBook(testComment,null);const loadSuccess=loadedData&&loadedData.test===true;return saveSuccess&&loadSuccess;}catch(error){console.error('世界书功能测试失败:',error);return false;}}};window.QQ_Debug_Group_Data_Sync=function(){try{const charId=getCurrentCharacterId()||'default';const comment=`QQ_分组备份_${charId}`;console.log(`📊 内存中的分组数据(contactGroups):`);if(contactGroups.length>0){contactGroups.forEach((group,index)=>{console.log(`-[${index}]${group.name}(${group.contacts.length}人)ID:${group.id}`);});}else{}if(!worldbook||!entries){console.error('❌ 世界书功能不可用');return;}const targetEntry=entries.find(entry=>entry.comment===comment);if(targetEntry){try{const worldbookGroups=JSON.parse(targetEntry.content);console.log(`-解析成功:${Array.isArray(worldbookGroups)? worldbookGroups.length:0}个分组`);if(Array.isArray(worldbookGroups)&&worldbookGroups.length>0){worldbookGroups.forEach((group,index)=>{console.log(`-[${index}]${group.name}(${group.contacts ? group.contacts.length:0}人)ID:${group.id}`);});}if(contactGroups.length===worldbookGroups.length){}else{console.warn(` ⚠️ 分组数量不一致:内存${contactGroups.length}vs 世界书${worldbookGroups.length}`);}}catch(parseError){console.error(` ❌ 解析世界书条目失败:`,parseError);}}else{console.warn(` ⚠️ 未找到世界书条目:${comment}`);}const summary=`
🔍 分组数据同步状态:-角色ID:${charId}-内存分组数:${contactGroups.length}个-世界书条目:${targetEntry ? '✅ 存在':'❌ 不存在'}-数据同步:${targetEntry ? '需要进一步检查详细日志':'❌ 世界书条目缺失'}详细信息请查看控制台日志`;alert(summary);}catch(error){console.error('分组数据同步检查失败:',error);}};window.QQ_Test_Group_Functions=async function(){try{const characterId=getCurrentCharacterId()||'default';await QQ_LoadContactGroups();const expectedComment=`QQ_分组备份_${characterId}`;const existingEntry=entries ? entries.find(entry=>entry.comment===expectedComment):null;if(existingEntry){console.log('条目内容预览:',existingEntry.content.substring(0,100)+'...');}else{}const originalLength=contactGroups.length;const testGroup={id:'test_group_'+Date.now(),name:'测试分组_'+Date.now(),contacts:[],collapsed:false,order:999};contactGroups.push(testGroup);const saveResult=await saveGroupsToStorage();contactGroups.splice(-1,1);const deleteResult=await saveGroupsToStorage();await QQ_LoadContactGroups();const summary=`
📊 分组功能测试总结:-角色ID:${characterId}-加载功能:${contactGroups.length>=0 ? '✅ 正常':'❌ 异常'}-世界书条目:${existingEntry ? '✅ 存在':'⚠️ 不存在'}-保存功能:${saveResult ? '✅ 正常':'❌ 异常'}-删除功能:${deleteResult ? '✅ 正常':'❌ 异常'}-当前分组数:${contactGroups.length}个
${contactGroups.length>0 ?
'分组详情:'+contactGroups.map(g=>`${g.name}(${g.contacts.length}人)`).join(','):'当前无分组'}`;alert(summary);}catch(error){console.error('分组功能测试失败:',error);alert('分组功能测试失败:'+error.message);}};window.QQ_Show_WorldBook_Stats=function(){try{if(!QQ_IsWorldBookAvailable()){return;}const stats={总条目数:0,QQ相关条目:0,数据类型:{}};if(worldbook&&worldbook.entries){stats.总条目数=worldbook.entries.length;worldbook.entries.forEach(entry=>{if(entry.comment&&entry.comment.includes('QQ_')){stats.QQ相关条目++;if(entry.comment.includes('联系人')){stats.数据类型.联系人=(stats.数据类型.联系人||0)+1;}else if(entry.comment.includes('群聊')){stats.数据类型.群聊=(stats.数据类型.群聊||0)+1;}else if(entry.comment.includes('消息')){stats.数据类型.消息=(stats.数据类型.消息||0)+1;}else if(entry.comment.includes('动态')){stats.数据类型.动态=(stats.数据类型.动态||0)+1;}else if(entry.comment.includes('互动')){stats.数据类型.互动空间=(stats.数据类型.互动空间||0)+1;}else if(entry.comment.includes('分组')){stats.数据类型.分组=(stats.数据类型.分组||0)+1;}else{stats.数据类型.其他=(stats.数据类型.其他||0)+1;}}});}const message=`📊 世界书数据统计
总条目数:${stats.总条目数}QQ相关条目:${stats.QQ相关条目}数据类型分布:${Object.entries(stats.数据类型).map(([type,count])=>`• ${type}:${count}个`).join('\n')}`;alert(message);}catch(error){console.error('显示世界书统计失败:',error);}};window.QQ_Manual_Sync_All_Data=function(){QQ_SyncAllData();};$(document).ready(function(){setTimeout(()=>{if(QQ_IsWorldBookAvailable()){if(typeof QQ_LoadContactGroups==='function'){QQ_LoadContactGroups().catch(error=>{console.error('自动加载分组数据失败:',error);});}}else{console.warn('⚠️ 世界书功能不可用，数据保存可能受影响');}},2000);});function QQ_ToggleUserMenu(){let existingSpirit=document.getElementById('QQ_user_spirit');if(existingSpirit){existingSpirit.remove();return;}QQ_ShowUserSpirit();}function QQ_ShowUserSpirit(){const existingSpirit=document.getElementById('QQ_user_spirit');if(existingSpirit){existingSpirit.remove();}const userName=QQ_GetUserName()||'User';const userAvatar=QQ_GetUserAvatar()||'default_avatar.png';const spirit=document.createElement('div');spirit.id='QQ_user_spirit';spirit.style.cssText=`
position:fixed;top:120px;right:30px;width:60px;height:60px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:50%;box-shadow:0 6px 20px rgba(102,126,234,0.4);cursor:pointer;z-index:10000;display:flex;align-items:center;justify-content:center;animation:userSpiritPulse 2s infinite ease-in-out;border:3px solid white;transition:all 0.3s ease;`;spirit.innerHTML=`<img src="${userAvatar}" alt="${userName}" style=" width:45px;height:45px;border-radius:50%;object-fit:cover;" onerror="this.outerHTML='<div style=&quot;color:white;font-size:24px;&quot;>👤</div>';">`;spirit.addEventListener('mouseenter',()=>{spirit.style.transform='scale(1.1)';spirit.style.boxShadow='0 8px 25px rgba(102,126,234,0.6)';});spirit.addEventListener('mouseleave',()=>{spirit.style.transform='scale(1)';spirit.style.boxShadow='0 6px 20px rgba(102,126,234,0.4)';});spirit.addEventListener('click',(e)=>{e.stopPropagation();QQ_ShowUserSpiritPanel();spirit.remove();});if(!document.getElementById('user_spirit_styles')){const style=document.createElement('style');style.id='user_spirit_styles';style.textContent=`
@keyframes userSpiritPulse{0%,100%{transform:scale(1);}50%{transform:scale(1.05);}}@keyframes userSpiritSlideIn{from{opacity:0;transform:translateX(100px);}to{opacity:1;transform:translateX(0);}}#QQ_user_spirit{animation:userSpiritSlideIn 0.3s ease,userSpiritPulse 2s infinite ease-in-out 0.3s;}`;document.head.appendChild(style);}document.body.appendChild(spirit);setTimeout(()=>{if(spirit&&spirit.parentNode){spirit.style.opacity='0';spirit.style.transform='translateX(100px)';setTimeout(()=>{if(spirit.parentNode){spirit.remove();}},300);}},5000);}function QQ_GetUserName(){const methods=[()=>UserName,()=>document.getElementById('QQ_home_UserName')?.textContent?.replace(/\*\*/g,'').trim(),()=>document.getElementById('QQ_message_list_UserName')?.textContent?.replace(/\*\*/g,'').trim(),()=>window.name||window.user||'User'];for(const method of methods){try{const result=method();if(result&&typeof result==='string'&&result.length>0){return result;}}catch(error){}}return 'User';}function QQ_GetUserAvatar(){const methods=[()=>window.userAvatarPath,()=>window.selectedAvatarData,()=>document.querySelector('#QQ_home_UserAvatar img')?.src,()=>document.querySelector('.user-avatar img')?.src,()=>document.querySelector('[data-user-avatar]')?.src];for(const method of methods){try{const result=method();if(result&&typeof result==='string'&&result!=='default_avatar.png'){return result;}}catch(error){}}return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiM2NjdlZWEiLz4KPHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4PSI4IiB5PSI4Ij4KPHBhdGggZD0iTTEyIDEyQzE0LjIwOTEgMTIgMTYgMTAuMjA5MSAxNiA4QzE2IDUuNzkwODYgMTQuMjA5MSA0IDEyIDRDOS43OTA4NiA0IDggNS43OTA4NiA4IDhDOCAxMC4yMDkxIDkuNzkwODYgMTIgMTIgMTJaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTIgMTRDOC4xMzQwMSAxNCA1IDE3LjEzNDAxIDUgMjFIMTlDMTkgMTcuMTM0MDEgMTUuODY2IDE0IDEyIDE0WiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+Cgo8L3N2Zz4K';}function QQ_ShowUserSpiritPanel(){$('.QQ_user_spirit_panel').remove();const userName=QQ_GetUserName()||'User';const userAvatar=QQ_GetUserAvatar();const panelHtml=`<div class="QQ_user_spirit_panel" style=" position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.3);z-index:99999999;overflow:hidden;animation:userPanelSlideIn 0.3s ease;max-width:90%;max-height:80%;width:350px;"><div class="panel-header" style=" background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px;text-align:center;font-weight:600;"><div style="display:flex;align-items:center;justify-content:center;gap:10px;"><img src="${userAvatar}" alt="${userName}" style=" width:40px;height:40px;border-radius:50%;border:2px solid white;" onerror="this.outerHTML='<div style=&quot;width:40px;height:40px;border-radius:50%;border:2px solid white;background:rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;font-size:20px;&quot;>👤</div>';"><span style="font-size:16px;">👑 ${userName}的控制面板</span></div></div><div class="panel-content" style="padding:20px;"><div style=" display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px;"><button class="panel-btn" data-action="interactive_guide" style=" background:linear-gradient(135deg,#FF6B6B 0%,#FF8E53 100%);border:none;color:white;padding:12px 8px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:500;transition:all 0.2s ease;display:flex;flex-direction:column;align-items:center;gap:4px;"><span style="font-size:16px;">💫</span><span>互动指南</span></button><button class="panel-btn" data-action="phone_status" style=" background:linear-gradient(135deg,#4FACFE 0%,#00F2FE 100%);border:none;color:white;padding:12px 8px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:500;transition:all 0.2s ease;display:flex;flex-direction:column;align-items:center;gap:4px;"><span style="font-size:16px;">📱</span><span>手机状态</span></button><button class="panel-btn" data-action="sync_data" style=" background:linear-gradient(135deg,#43E97B 0%,#38F9D7 100%);border:none;color:white;padding:12px 8px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:500;transition:all 0.2s ease;display:flex;flex-direction:column;align-items:center;gap:4px;"><span style="font-size:16px;">🔄</span><span>同步数据</span></button><button class="panel-btn" data-action="settings" style=" background:linear-gradient(135deg,#FA709A 0%,#FEE140 100%);border:none;color:white;padding:12px 8px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:500;transition:all 0.2s ease;display:flex;flex-direction:column;align-items:center;gap:4px;"><span style="font-size:16px;">⚙️</span><span>设定</span></button></div><div style=" border-top:1px solid #e9ecef;padding-top:15px;margin-bottom:15px;"><div style=" display:flex;align-items:center;gap:8px;margin-bottom:10px;font-size:13px;font-weight:600;color:#666;"><span style=" display:inline-block;width:16px;height:16px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:50%;color:white;text-align:center;line-height:16px;font-size:10px;">🏠</span><span>公共互动空间</span><span style=" background:#e9ecef;color:#666;padding:2px 6px;border-radius:8px;font-size:10px;font-weight:500;margin-left:auto;">${Object.keys(QQ_InteractiveSpaces||{}).length}个</span></div><div style=" display:grid;grid-template-columns:1fr 1fr;gap:8px;"><button class="panel-btn" data-action="view_public_spaces" style=" background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border:none;color:white;padding:10px 8px;border-radius:6px;cursor:pointer;font-size:11px;font-weight:500;transition:all 0.2s ease;display:flex;flex-direction:column;align-items:center;gap:3px;"><span style="font-size:14px;">📂</span><span>互动记录</span></button><button class="panel-btn" data-action="create_public_space" style=" background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);border:none;color:white;padding:10px 8px;border-radius:6px;cursor:pointer;font-size:11px;font-weight:500;transition:all 0.2s ease;display:flex;flex-direction:column;align-items:center;gap:3px;"><span style="font-size:14px;">✨</span><span>创建互动</span></button></div></div></div><div class="interactive-tip" style=" padding:12px 20px;background:linear-gradient(135deg,#E8F5E8 0%,#F0F8FF 100%);border-top:1px solid #e9ecef;font-size:12px;color:#666;line-height:1.4;"><div style=" display:flex;align-items:center;gap:8px;margin-bottom:6px;font-weight:500;"><span style=" display:inline-block;width:16px;height:16px;background:#4CAF50;border-radius:50%;color:white;text-align:center;line-height:16px;font-size:10px;">💡</span><span style="color:#4CAF50;">快速互动小贴士</span></div><div style="margin-left:24px;">在聊天中使用<span style=" background:#4CAF50;color:white;padding:2px 6px;border-radius:3px;font-family:monospace;font-weight:600;">&&</span>符号可以直接触发互动内容</div><div style="margin-left:24px;margin-top:4px;color:#888;">例如：<code style="background:#f8f9fa;padding:1px 4px;border-radius:2px;">&&想要拥抱你</code></div></div><div class="panel-actions" style=" padding:20px;background:#fafafa;display:flex;gap:10px;"><button class="close-panel-btn" style=" flex:1;background:#e9ecef;border:none;color:#666;padding:12px 16px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;transition:all 0.2s ease;">关闭</button></div></div><style>@keyframes userPanelSlideIn{from{opacity:0;transform:translate(-50%,-60%)}to{opacity:1;transform:translate(-50%,-50%)}}.QQ_user_spirit_panel .panel-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.2)}</style>`;$('body').append(panelHtml);$('.QQ_user_spirit_panel').on('click',function(e){e.stopPropagation();const panelBtn=e.target.closest('.panel-btn');const closePanelBtn=e.target.closest('.close-panel-btn');if(panelBtn){const action=panelBtn.getAttribute('data-action');$('.QQ_user_spirit_panel').remove();switch(action){case 'interactive_guide':QQ_ShowInteractiveGuide();break;case 'phone_status':QQ_ShowPhoneStatus();break;case 'sync_data':QQ_SyncAllData();break;case 'settings':QQ_ShowInteractiveSettings();break;case 'view_public_spaces':QQ_ShowPublicInteractiveSpaces();break;case 'create_public_space':QQ_CreatePublicInteractiveSpace();break;}}else if(closePanelBtn){$('.QQ_user_spirit_panel').remove();}});$(document).one('click',function(){$('.QQ_user_spirit_panel').remove();});}function QQ_UpdateInteractiveStatus(){const statusContainer=$('#interactive-status-content');if(statusContainer.length===0)return;try{const settings=QQ_GetInteractiveSettings();const symbolStatus='🟢 特殊符号(&&)：永久启用';const keywordStatus=settings.enableKeywordTrigger ?
'🟢 关键词触发：已启用':'🔴 关键词触发：已禁用';const customCount=settings.customKeywords.length;const customStatus=customCount>0 ?
`🟢 自定义关键词：${customCount}个`:'⚪ 自定义关键词：暂无';const statusHtml=`<div>${symbolStatus}</div><div>${keywordStatus}</div><div>${customStatus}</div><div style="margin-top:4px;color:#888;">点击"设定"按钮可修改关键词触发设置</div>`;statusContainer.html(statusHtml);}catch(error){console.error('更新互动状态显示失败:',error);statusContainer.html(`<div>🟢 特殊符号(&&)：永久启用</div><div>⚪ 关键词触发：获取状态失败</div><div style="margin-top:4px;color:#888;">点击"设定"按钮配置互动触发</div>`);}}function QQ_ShowUserSettingsMenu(){let existingMenu=document.getElementById('QQ_user_dropdown_menu');if(existingMenu){existingMenu.remove();return;}const menu=document.createElement('div');menu.id='QQ_user_dropdown_menu';menu.style.cssText=`
position:fixed;top:70px;left:50%;transform:translateX(-50%);background:white;border-radius:12px;padding:12px 0;box-shadow:0 8px 24px rgba(0,0,0,0.2);z-index:9999;min-width:200px;animation:fadeInDown 0.2s ease;border:1px solid #e0e0e0;`;const menuItems=[{icon:'📊',text:'世界书统计',action:()=>{QQ_Show_WorldBook_Stats();menu.remove();}},{icon:'🔄',text:'同步数据',action:()=>{QQ_Manual_Sync_All_Data();menu.remove();}},{icon:'🧪',text:'测试互动检测',action:()=>{const testText=prompt('请输入要测试的文本:','我想和大家一起拥抱');if(testText){QQ_Test_Interactive_Detection(testText);}menu.remove();}},{icon:'⚙️',text:'手机界面设置',action:()=>{alert('设置功能开发中...');menu.remove();}},{icon:'📱',text:'界面信息',action:()=>{const info=`手机界面状态:-当前用户:${QQ_GetUserName()}-当前角色:${getCurrentCharacterId()||'未知'}-世界书状态:${QQ_IsWorldBookAvailable()? '✅ 可用':'❌ 不可用'}-联系人分组:${contactGroups ? contactGroups.length:0}个-互动空间:${Object.keys(QQ_InteractiveSpaces||{}).length}个公共+${Object.keys(QQ_CharacterSpaces||{}).reduce((sum,char)=>sum+Object.keys(QQ_CharacterSpaces[char]).length,0)}个私人`;alert(info);menu.remove();}}];menuItems.forEach((item,index)=>{const menuItem=document.createElement('div');menuItem.style.cssText=`
padding:12px 20px;cursor:pointer;display:flex;align-items:center;font-size:14px;color:#333;transition:background-color 0.2s ease;${index>0 ? 'border-top:1px solid #f0f0f0;':''}`;menuItem.innerHTML=`<span style="margin-right:12px;font-size:16px;">${item.icon}</span><span>${item.text}</span>`;menuItem.addEventListener('mouseenter',()=>{menuItem.style.backgroundColor='#f5f5f5';});menuItem.addEventListener('mouseleave',()=>{menuItem.style.backgroundColor='transparent';});menuItem.addEventListener('click',item.action);menu.appendChild(menuItem);});const style=document.createElement('style');style.textContent=`
@keyframes fadeInDown{from{opacity:0;transform:translateX(-50%)translateY(-10px);}to{opacity:1;transform:translateX(-50%)translateY(0);}}`;document.head.appendChild(style);document.body.appendChild(menu);const closeMenu=(e)=>{if(!menu.contains(e.target)&&!document.getElementById('QQ_message_list_UserName').contains(e.target)){menu.remove();document.removeEventListener('click',closeMenu);}};setTimeout(()=>{document.addEventListener('click',closeMenu);},100);}function QQ_ShowPhoneStatus(){const info=`📱 手机界面状态信息
👤 当前用户:${QQ_GetUserName()}🎭 当前角色:${getCurrentCharacterId()||'未知'}📚 世界书状态:${QQ_IsWorldBookAvailable()? '✅ 可用':'❌ 不可用'}📋 数据统计:• 联系人分组:${contactGroups ? contactGroups.length:0}个
• 公共互动空间:${Object.keys(QQ_InteractiveSpaces||{}).length}个
• 私人互动空间:${Object.keys(QQ_CharacterSpaces||{}).reduce((sum,char)=>sum+Object.keys(QQ_CharacterSpaces[char]).length,0)}个
• 动态数量:${QQ_MomentsData ? QQ_MomentsData.length:0}个
⚙️ 功能状态:• 消息发送:${typeof QQ_SendMsg==='function' ? '✅':'❌'}• 动态评论:${typeof QQ_Moment_Comment==='function' ? '✅':'❌'}• 互动检测:${typeof QQ_DetectInteractiveIntent==='function' ? '✅':'❌'}• 角色精灵:${typeof QQ_ShowCharacterSpirit==='function' ? '✅':'❌'}🕒 系统时间:${new Date().toLocaleString('zh-CN')}`;alert(info);}function QQ_SyncAllData(){if(!QQ_IsWorldBookAvailable()){alert('❌ 世界书功能不可用，无法同步数据');return;}let syncCount=0;let totalCount=0;try{if(typeof saveGroupsToStorage==='function'){saveGroupsToStorage();syncCount++;}totalCount++;if(typeof QQ_Save_Moments==='function'&&QQ_MomentsData){QQ_Save_Moments();syncCount++;}totalCount++;if(typeof QQ_Save_Interactive_Spaces==='function'){QQ_Save_Interactive_Spaces();syncCount++;}totalCount++;if(typeof QQ_SaveReadStatus==='function'){QQ_SaveReadStatus();syncCount++;}totalCount++;alert(`✅ 数据同步完成\n成功同步:${syncCount}/${totalCount}项数据`);}catch(error){console.error('❌ 数据同步失败:',error);alert(`❌ 数据同步失败:${error.message}`);}}async function QQ_ForceReloadInteractiveSpaces(){try{QQ_InteractiveSpaces={};QQ_CharacterSpaces={};await QQ_LoadInteractiveSpaces();await QQ_LoadCharacterSpaces();console.log(`📊 公共空间:${Object.keys(QQ_InteractiveSpaces).length}个`);console.log(`👥 角色空间:${Object.keys(QQ_CharacterSpaces).length}个角色`);return true;}catch(error){console.error('❌ 强制重新加载互动空间数据失败:',error);return false;}}async function QQ_ShowPublicInteractiveSpaces(){$('.QQ_user_spirit_panel').remove();QQ_ShowPublicSpacesLoadingUI();try{const loadSuccess=await QQ_ForceReloadInteractiveSpaces();if(!loadSuccess){throw new Error('从世界书加载数据失败');}QQ_ShowPublicSpacesContent();}catch(error){console.error('❌ 显示公共互动空间失败:',error);QQ_ShowPublicSpacesError(error.message);}}function QQ_ShowPublicSpacesLoadingUI(){$('.QQ_public_spaces_panel').remove();const loadingPanel=$(`<div class="QQ_public_spaces_panel" style=" position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:16px;width:85%;max-width:400px;box-shadow:0 20px 40px rgba(0,0,0,0.3);z-index:10000;overflow:hidden;animation:slideIn 0.3s ease;"><div class="panel-header" style=" background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:16px 20px;text-align:center;"><div style=" display:flex;align-items:center;justify-content:center;gap:8px;font-size:16px;font-weight:600;"><span style="font-size:18px;">🏠</span><span>公共互动空间</span></div></div><div style=" padding:40px 20px;text-align:center;"><div style=" width:50px;height:50px;border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px auto;"></div><div style=" font-size:16px;color:#333;margin-bottom:8px;font-weight:500;">正在加载互动记录...</div><div style=" font-size:12px;color:#999;line-height:1.4;">从世界书获取最新数据<br/><small style="opacity:0.7;">首次加载可能需要几秒钟</small></div></div></div><style>@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}</style>`);$('body').append(loadingPanel);loadingPanel.on('click',function(e){if(e.target===this){$(this).remove();}});}function QQ_ShowPublicSpacesContent(){$('.QQ_public_spaces_panel').remove();const spaces=Object.values(QQ_InteractiveSpaces||{});const spacesCount=spaces.length;const panel=$(`<div class="QQ_public_spaces_panel" style=" position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:16px;width:85%;max-width:400px;max-height:70vh;box-shadow:0 20px 40px rgba(0,0,0,0.3);z-index:10000;overflow:hidden;animation:slideIn 0.3s ease;"><div class="panel-header" style=" background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:16px 20px;text-align:center;position:relative;"><div style=" display:flex;align-items:center;justify-content:center;gap:8px;font-size:16px;font-weight:600;"><span style="font-size:18px;">🏠</span><span>公共互动空间</span><span style=" background:rgba(255,255,255,0.2);padding:2px 8px;border-radius:8px;font-size:12px;font-weight:500;">${spacesCount}个</span></div></div><div class="panel-content" style=" padding:0;max-height:50vh;overflow-y:auto;">${spacesCount===0 ? `<div style=" text-align:center;padding:40px 20px;color:#999;"><div style="font-size:48px;margin-bottom:16px;">🌟</div><div style="font-size:16px;margin-bottom:8px;color:#666;">还没有互动记录</div><div style="font-size:12px;">开始一段现实互动吧～</div></div>`:spaces.map((space,index)=>`<div class="space-item" data-space-id="${space.id}" style=" padding:16px 20px;border-bottom:1px solid #f0f0f0;cursor:pointer;transition:background-color 0.2s ease;${index===spaces.length-1 ? 'border-bottom:none;':''}"><div style=" display:flex;align-items:flex-start;gap:12px;"><div style=" width:36px;height:36px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:8px;display:flex;align-items:center;justify-content:center;color:white;font-size:16px;flex-shrink:0;">🌟</div><div style="flex:1;min-width:0;"><div style=" font-size:14px;font-weight:600;color:#333;margin-bottom:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${space.title||`互动空间 #${index+1}`}</div><div style=" font-size:12px;color:#666;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">${(space.content||'').replace(/<[^>]*>/g,'').substring(0,60)}${(space.content||'').length>60 ? '...':''}</div><div style=" font-size:10px;color:#999;margin-top:6px;display:flex;align-items:center;gap:8px;"><span>📅 ${space.timestamp ? new Date(space.timestamp).toLocaleDateString('zh-CN'):'未知时间'}</span><span>💬 ${space.replies ? space.replies.length:0}条回复</span></div></div><div style=" width:24px;height:24px;display:flex;align-items:center;justify-content:center;color:#ccc;font-size:14px;">→</div></div></div>`).join('')}</div><div class="panel-footer" style=" padding:16px 20px;border-top:1px solid #f0f0f0;background:#fafafa;"><div style=" display:grid;grid-template-columns:1fr 1fr;gap:10px;"><button class="close-btn" style=" background:#e9ecef;border:none;color:#666;padding:10px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s ease;">关闭</button><button class="create-new-btn" style=" background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);border:none;color:white;padding:10px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s ease;">✨ 创建新互动</button></div></div></div>`);panel.find('.space-item').hover(function(){$(this).css('background-color','#f8f9fa');},function(){$(this).css('background-color','transparent');});panel.on('click','.space-item',function(){const spaceId=$(this).data('space-id');const space=QQ_InteractiveSpaces[spaceId];if(space){panel.remove();setTimeout(()=>{QQ_DisplayInteractiveSpace(spaceId,'公共互动空间');},100);}});panel.on('click','.close-btn',function(){panel.remove();});panel.on('click','.create-new-btn',function(){panel.remove();setTimeout(()=>{QQ_CreatePublicInteractiveSpace();},100);});$(document).one('click',function(){panel.remove();});panel.on('click',function(e){e.stopPropagation();});$('body').append(panel);}async function QQ_CreatePublicInteractiveSpace(){await QQ_ForceReloadInteractiveSpaces();$('.QQ_public_spaces_panel').remove();const panel=$(`<div class="QQ_create_space_panel" style=" position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:16px;width:85%;max-width:400px;box-shadow:0 20px 40px rgba(0,0,0,0.3);z-index:10000;overflow:hidden;animation:slideIn 0.3s ease;"><div class="panel-header" style=" background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:white;padding:16px 20px;text-align:center;"><div style=" display:flex;align-items:center;justify-content:center;gap:8px;font-size:16px;font-weight:600;"><span style="font-size:18px;">✨</span><span>创建新互动空间</span></div></div><div class="panel-content" style="padding:20px;"><div style="margin-bottom:16px;"><label style=" display:block;font-size:13px;font-weight:600;color:#333;margin-bottom:6px;">互动标题</label><input type="text" class="space-title" placeholder="为这次互动起个名字..." style=" width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px;outline:none;transition:border-color 0.2s ease;box-sizing:border-box;"></div><div style="margin-bottom:20px;"><label style=" display:block;font-size:13px;font-weight:600;color:#333;margin-bottom:6px;">互动内容</label><textarea class="space-content" placeholder="描述你想要的互动场景..." style=" width:100%;height:100px;padding:10px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px;outline:none;transition:border-color 0.2s ease;resize:vertical;box-sizing:border-box;"></textarea></div><div style=" background:#f8f9fa;padding:12px;border-radius:8px;margin-bottom:20px;"><div style=" display:flex;align-items:center;gap:6px;margin-bottom:6px;font-size:12px;font-weight:600;color:#28a745;"><span>💡</span><span>快速互动小贴士</span></div><div style=" font-size:11px;color:#666;line-height:1.4;">在聊天中使用<code style=" background:#e9ecef;padding:2px 4px;border-radius:3px;font-family:monospace;">&amp;&amp;</code>符号可以直接触发互动内容<br>例如：<em>&amp;&amp;想要拥抱你</em></div></div></div><div class="panel-footer" style=" padding:16px 20px;border-top:1px solid #f0f0f0;background:#fafafa;"><div style=" display:grid;grid-template-columns:1fr 1fr;gap:10px;"><button class="cancel-btn" style=" background:#e9ecef;border:none;color:#666;padding:10px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s ease;">取消</button><button class="create-btn" style=" background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);border:none;color:white;padding:10px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s ease;">✨ 创建互动</button></div></div></div>`);panel.find('input,textarea').on('focus',function(){$(this).css('border-color','#f093fb');}).on('blur',function(){$(this).css('border-color','#ddd');});panel.on('click','.cancel-btn',function(){panel.remove();});panel.on('click','.create-btn',function(){const title=panel.find('.space-title').val().trim();const content=panel.find('.space-content').val().trim();if(!content){alert('请输入互动内容');return;}const spaceId='space_'+Date.now()+'_'+Math.random().toString(36).substr(2,9);const timestamp=Date.now();QQ_InteractiveSpaces[spaceId]={id:spaceId,title:title||`互动空间 #${Object.keys(QQ_InteractiveSpaces).length+1}`,content:content,timestamp:timestamp,characterName:'',isMultiCharacter:true,replies:[]};QQ_SaveInteractiveContentToWorldBook(content,null).then(interactiveId=>{}).catch(error=>{console.error('保存公共互动空间失败:',error);});if(typeof QQ_Save_Interactive_Spaces==='function'){QQ_Save_Interactive_Spaces();}panel.remove();setTimeout(()=>{QQ_DisplayInteractiveSpace(spaceId,'公共互动空间');},100);});panel.find('.space-content').on('keydown',function(e){if(e.ctrlKey&&e.key==='Enter'){panel.find('.create-btn').click();}});$(document).one('click',function(){panel.remove();});panel.on('click',function(e){e.stopPropagation();});$('body').append(panel);setTimeout(()=>{panel.find('.space-title').focus();},100);}function QQ_ShowPublicSpacesError(errorMessage){$('.QQ_public_spaces_panel').remove();const errorPanel=$(`<div class="QQ_public_spaces_panel" style=" position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:16px;width:85%;max-width:400px;box-shadow:0 20px 40px rgba(0,0,0,0.3);z-index:10000;overflow:hidden;animation:slideIn 0.3s ease;"><div class="panel-header" style=" background:linear-gradient(135deg,#ff6b6b 0%,#ffa726 100%);color:white;padding:16px 20px;text-align:center;"><div style=" display:flex;align-items:center;justify-content:center;gap:8px;font-size:16px;font-weight:600;"><span style="font-size:18px;">⚠️</span><span>加载失败</span></div></div><div style=" padding:30px 20px;text-align:center;"><div style=" font-size:48px;margin-bottom:16px;opacity:0.6;">😵</div><div style=" font-size:16px;color:#333;margin-bottom:8px;font-weight:500;">互动记录加载失败</div><div style=" font-size:12px;color:#666;line-height:1.4;margin-bottom:20px;">${errorMessage||'未知错误'}<br/><small style="opacity:0.7;">请检查世界书功能是否正常</small></div><div style=" display:grid;grid-template-columns:1fr 1fr;gap:10px;"><button class="retry-btn" style=" background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border:none;color:white;padding:12px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s ease;">🔄 重试</button><button class="close-error-btn" style=" background:#e9ecef;border:none;color:#666;padding:12px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s ease;">关闭</button></div></div></div>`);errorPanel.on('click','.retry-btn',function(){errorPanel.remove();setTimeout(()=>{QQ_ShowPublicInteractiveSpaces();},100);});errorPanel.on('click','.close-error-btn',function(){errorPanel.remove();});errorPanel.on('click',function(e){if(e.target===this){$(this).remove();}});$('body').append(errorPanel);toastr.error('加载公共互动空间失败','错误');}window.QQ_ToggleUserMenu=QQ_ToggleUserMenu;window.QQ_GetUserName=QQ_GetUserName;window.QQ_ShowUserSpirit=QQ_ShowUserSpirit;window.QQ_ShowUserSpiritPanel=QQ_ShowUserSpiritPanel;window.QQ_ShowUserSettingsMenu=QQ_ShowUserSettingsMenu;window.QQ_ShowPhoneStatus=QQ_ShowPhoneStatus;window.QQ_SyncAllData=QQ_SyncAllData;window.QQ_ShowPublicInteractiveSpaces=QQ_ShowPublicInteractiveSpaces;window.QQ_CreatePublicInteractiveSpace=QQ_CreatePublicInteractiveSpace;window.QQ_ForceReloadInteractiveSpaces=QQ_ForceReloadInteractiveSpaces;window.QQ_ForceReloadContactGroups=QQ_ForceReloadContactGroups;window.QQ_ShowPublicSpacesError=QQ_ShowPublicSpacesError;window.QQ_ProcessSurpriseMechanism=QQ_ProcessSurpriseMechanism;window.QQ_ValidateInteractiveContent=QQ_ValidateInteractiveContent;window.QQ_CleanNestedTags=QQ_CleanNestedTags;window.QQ_CleanContentTags=QQ_CleanContentTags;window.QQ_HandleCharacterChat=QQ_HandleCharacterChat;window.QQ_SaveCharacterChatToWorldbook=QQ_SaveCharacterChatToWorldbook;window.QQ_Test_Smart_Content_Extraction=QQ_Test_Smart_Content_Extraction;window.QQ_Test_New_Format_Processing=function(){const testCase1=`<content><群聊：测试群>用户--12:30--这是一条测试消息
AI角色--12:31--这是AI的回复</群聊：测试群></content>`;const result1=QQ_IsInteractiveContent(testCase1,true);const testCase2=`<content>*轻轻走向你，眼神中充满了温柔*我慢慢靠近，感觉到周围的氛围变得温馨。看到你的表情，我内心感到一阵暖流。*伸出手，想要触摸你的脸颊*</content>`;const result2=QQ_IsInteractiveContent(testCase2,true);const testCase3=`<content><用户和AI角色的私聊>用户:你好
AI角色:你好，很高兴见到你</用户和AI角色的私聊></content>`;const result3=QQ_IsInteractiveContent(testCase3,true);const testCase4=`<content>错误：无法处理您的请求
系统出现了异常，请稍后重试</content>`;const result4=QQ_IsInteractiveContent(testCase4,true);const contentTest=QQ_CleanContentTags(testCase1);triggerSlash('/echo ✅ 新格式处理逻辑测试完成，请查看控制台详细结果');return{hasFormatTags:!result1&&!result3,pureInteractive:result2,errorHandling:!result4,contentExtraction:!!contentTest};};window.QQ_LikeMoment=async function(momentId){try{const userName=QQ_GetUserName();if(!userName){console.warn('无法获取用户名，无法执行点赞操作');return false;}const momentData=QQ_MomentsData.find(m=>m.id===momentId);if(!momentData){console.warn(`未找到动态数据:${momentId}`);return false;}if(!momentData.likes){momentData.likes={count:0,userLiked:false,likedBy:[],lastLikeTime:null};}const wasLiked=momentData.likes.userLiked;if(wasLiked){momentData.likes.userLiked=false;momentData.likes.count=Math.max(0,momentData.likes.count-1);momentData.likes.likedBy=momentData.likes.likedBy.filter(name=>name!==userName);momentData.likes.lastLikeTime=new Date().toISOString();}else{momentData.likes.userLiked=true;momentData.likes.count+=1;if(!momentData.likes.likedBy.includes(userName)){momentData.likes.likedBy.push(userName);}momentData.likes.lastLikeTime=new Date().toISOString();}QQ_UpdateLikeUI(momentId,momentData.likes);QQ_ShowLikePopup(momentId,!wasLiked,userName);await QQ_Save_Moments();if(!wasLiked){await QQ_RecordLikeForAI(momentData,userName);}return true;}catch(error){console.error('点赞操作失败:',error);return false;}};window.QQ_UpdateLikeUI=function(momentId,likes){try{const momentElement=$(`.user_moment[data-moment-id="${momentId}"]`);if(momentElement.length===0){console.warn(`未找到动态元素:${momentId}`);return;}const discordLikeButton=momentElement.find(`.moment-like-button[data-moment-id="${momentId}"]`);const discordLikeCount=momentElement.find(`.moment-like-count`);if(discordLikeButton.length>0){if(likes.userLiked){discordLikeButton.css('color','#1677ff');discordLikeButton.addClass('liked');}else{discordLikeButton.css('color','#000000');discordLikeButton.removeClass('liked');}discordLikeCount.text(likes.count);}const momentLikeSection=momentElement.find('span:contains("人已赞")').parent();const momentLikeText=momentElement.find('span:contains("人已赞")');if(momentLikeText.length>0){momentLikeText.text(`${likes.count}人已赞`);const thumbsUpSvg=momentElement.find('.moment_button svg').filter(function(){const pathContent=$(this).find('path').attr('d');return pathContent&&pathContent.includes('471.411583');});if(thumbsUpSvg.length>0){const thumbPath=thumbsUpSvg.find('path');if(likes.userLiked){thumbPath.attr('fill','#1677ff');thumbsUpSvg.css({'filter':'drop-shadow(0 0 8px #1677ff)','transform':'scale(1.2)','transition':'all 0.3s ease','cursor':'pointer'}).addClass('liked-thumb');if(!thumbsUpSvg.hasClass('pulse-animation')){thumbsUpSvg.addClass('pulse-animation');setTimeout(()=>thumbsUpSvg.removeClass('pulse-animation'),800);}}else{thumbPath.attr('fill','#000000');thumbsUpSvg.css({'filter':'none','transform':'scale(1)','transition':'all 0.3s ease','cursor':'pointer'}).removeClass('liked-thumb pulse-animation');}}const userLikedTip=momentLikeText.next('.user-liked-tip');if(likes.userLiked){if(userLikedTip.length===0){momentLikeText.after('<div class="user-liked-tip" style="color:#1677ff;font-size:11px;margin-top:2px;font-weight:500;">✓ 你已点赞</div>');}}else{userLikedTip.remove();}}}catch(error){console.error('更新点赞UI失败:',error);}};window.QQ_ShowLikePopup=function(momentId,isLike,userName){try{const momentElement=$(`.user_moment[data-moment-id="${momentId}"]`);const popup=momentElement.find('.moment-like-popup');if(isLike){popup.text(`${userName}已点赞`).show();}else{popup.text(`${userName}已取消点赞`).show();}setTimeout(()=>{popup.fadeOut(300);},2000);}catch(error){console.error('显示点赞弹窗失败:',error);}};window.QQ_RecordLikeForAI=async function(momentData,userName){try{const likeRecord={type:'moment_like',momentId:momentData.id,momentAuthor:momentData.userName,momentContent:momentData.message.substring(0,100),likedBy:userName,likeTime:new Date().toISOString(),totalLikes:momentData.likes.count,context:`用户"${userName}"对"${momentData.userName}"发布的动态进行了点赞。动态内容："${momentData.message.substring(0,50)}${momentData.message.length>50 ? '...':''}"。当前该动态共有${momentData.likes.count}人点赞。`};const result=await QQ_SafeSaveToWorldBook('点赞记录',likeRecord,'QQ_点赞记录备份');if(result){}}catch(error){console.error('记录点赞信息失败:',error);}};window.QQ_InitMomentLikes=function(){try{$(document).off('click.momentLike');$(document).off('click.momentLike','.moment-like-button').on('click.momentLike','.moment-like-button',function(e){e.preventDefault();e.stopPropagation();const momentId=$(this).data('moment-id');if(momentId&&typeof QQ_LikeMoment==='function'){QQ_LikeMoment(momentId);}else{console.warn('⚠️ momentId无效或QQ_LikeMoment函数不存在',{momentId:momentId,QQ_LikeMoment:typeof QQ_LikeMoment});}return false;});$(document).off('click.momentLike','.moment_button svg').on('click.momentLike','.moment_button svg',function(e){e.preventDefault();e.stopPropagation();const momentElement=$(this).closest('.user_moment[data-moment-id]');const momentId=momentElement.data('moment-id');if(momentId&&typeof QQ_LikeMoment==='function'){QQ_LikeMoment(momentId);}else{console.warn('⚠️ momentId无效或QQ_LikeMoment函数不存在',{momentId:momentId,QQ_LikeMoment:typeof QQ_LikeMoment});}return false;});$(document).off('click.momentLike','span:contains("人已赞")').on('click.momentLike','span:contains("人已赞")',function(e){e.preventDefault();e.stopPropagation();console.log('🎯 点赞文本点击-span:contains("人已赞")');const momentElement=$(this).closest('.user_moment[data-moment-id]');const momentId=momentElement.data('moment-id');if(momentId&&typeof QQ_LikeMoment==='function'){QQ_LikeMoment(momentId);}else{console.warn('⚠️ momentId无效或QQ_LikeMoment函数不存在',{momentId:momentId,QQ_LikeMoment:typeof QQ_LikeMoment});}return false;});setTimeout(()=>{const $likeButtons=$('.moment-like-button');const $momentButtons=$('.moment_button svg');const $likeTexts=$('span:contains("人已赞")');if($momentButtons.length>0){const $first=$momentButtons.first();const $moment=$first.closest('.user_moment[data-moment-id]');console.log('-所属动态momentId:',$moment.data('moment-id'));console.log('-SVG类名:',$first.attr('class'));console.log('-是否是点赞按钮:',$first.hasClass('moment-like-button'));}},100);}catch(error){console.error('❌ 点赞功能初始化失败:',error);}};window.QQ_ForceLikeButtonBinding=function(){const momentButtons=$('.moment-like-button');const svgButtons=$('.moment_button svg');};window.QQ_DiagnoseLikeButtons=function(){const momentButtons=$('.moment-like-button');const svgButtons=$('.moment_button svg');const textButtons=$('span:contains("人已赞")');const allMomentElements=$('[data-moment-id]');momentButtons.each(function(index){const $btn=$(this);const momentId=$btn.attr('data-moment-id')||$btn.data('moment-id');const events=$._data(this,'events')||{};const hasClickEvent=events.click&&events.click.length>0;console.log(`🔍 按钮${index+1}详情:`,{momentId:momentId,hasClickEvent:hasClickEvent,eventCount:events.click ? events.click.length:0,isVisible:$btn.is(':visible'),position:{top:$btn.offset()?.top,left:$btn.offset()?.left}});});if(momentButtons.length===0&&svgButtons.length===0){console.warn('⚠️ 未找到任何点赞按钮，尝试全局搜索...');const allSvgs=$('svg');allSvgs.each(function(index){const $svg=$(this);const pathContent=$svg.find('path').attr('d')||'';if(pathContent.includes('471.411583')){}});}};window.QQ_LoadMomentLikes=async function(){try{if(!QQ_MomentsData||QQ_MomentsData.length===0){return;}const userName=QQ_GetUserName();if(!userName){return;}for(const momentData of QQ_MomentsData){if(momentData.likes){QQ_UpdateLikeUI(momentData.id,momentData.likes);}}}catch(error){console.error('加载动态点赞状态失败:',error);}};window.QQ_Test_Like_Function=function(){if(typeof QQ_MomentsData==='undefined'||QQ_MomentsData.length===0){console.warn('⚠️ 没有动态数据可供测试');return;}const firstMoment=QQ_MomentsData[0];const likeButtons=$('.moment-like-button');if(likeButtons.length>0){const firstButton=likeButtons.first();const momentId=firstButton.data('moment-id');if(momentId){QQ_LikeMoment(momentId);}}else{console.warn('⚠️ 未找到点赞按钮，请确保页面已加载动态');}triggerSlash('/echo ✅ 点赞功能测试完成，请查看控制台详细结果');};window.QQ_Emergency_Fix_Like=function(){try{if(typeof QQ_InitMomentLikes==='function'){QQ_InitMomentLikes();}setTimeout(()=>{if(typeof QQ_ForceLikeButtonBinding==='function'){QQ_ForceLikeButtonBinding();}},100);setTimeout(()=>{if(typeof QQ_DiagnoseLikeButtons==='function'){QQ_DiagnoseLikeButtons();}},200);setTimeout(()=>{const likeButtons=$('.moment-like-button');if(likeButtons.length===0){const allSvgs=$('svg');let fixedCount=0;allSvgs.each(function(){const $svg=$(this);const pathContent=$svg.find('path').attr('d')||'';if(pathContent.includes('471.411583')){const momentElement=$svg.closest('[data-moment-id]');const momentId=momentElement.attr('data-moment-id')||momentElement.data('moment-id');if(momentId){$svg.addClass('moment-like-button-emergency');$svg.attr('data-moment-id',momentId);$svg.off('click.emergency').on('click.emergency',function(e){e.preventDefault();e.stopPropagation();if(typeof QQ_LikeMoment==='function'){QQ_LikeMoment(momentId);}return false;});fixedCount++;}}});}},300);}catch(error){console.error('❌ 紧急修复失败:',error);}};window.QQ_Debug_Like_Button=function(){const likeButtons=$('.moment-like-button');const svgButtons=$('.moment_button svg');const textButtons=$('span:contains("人已赞")');const userMoments=$('.user_moment');try{QQ_InitMomentLikes();}catch(error){}};window.QQ_Emergency_Fix_Like=function(){const $likeButtons=$('.moment-like-button');const $momentButtons=$('.moment_button');const $likeTexts=$('span:contains("人已赞")');if($likeButtons.length>0){const $first=$likeButtons.first();console.log('-momentId:',$first.attr('data-moment-id'));console.log('-liked:',$first.attr('data-liked'));console.log('-HTML:',$first[0].outerHTML.substring(0,200)+'...');}$(document).off('.momentLike');$(document).off('.debugClick');QQ_InitMomentLikes();if($likeButtons.length>0){const $testButton=$likeButtons.first();const momentId=$testButton.attr('data-moment-id');console.log(`🧪 测试点击第一个按钮(momentId:${momentId})...`);setTimeout(()=>{$testButton.trigger('click');setTimeout(()=>{if(momentId&&typeof QQ_LikeMoment==='function'){QQ_LikeMoment(momentId);}},1000);},500);}return '紧急修复完成';};window.QQ_ConvertExtractedToStandard=function(extractedInfo){if(!extractedInfo||!extractedInfo.hasValidInfo){return null;}try{const result={};if(extractedInfo.messages&&extractedInfo.messages.length>0){let chatType='private';let chatName='';if(extractedInfo.chatInfo&&extractedInfo.chatInfo.includes('群聊')){chatType='group';const groupMatch=extractedInfo.chatInfo.match(/群聊[：:]\s*(.+)/);chatName=groupMatch ? groupMatch[1].trim():'未知群聊';}else if(extractedInfo.chatType==='group'){chatType='group';chatName=extractedInfo.chatName||'未知群聊';}else if(extractedInfo.chatType==='private'){chatType='private';chatName=extractedInfo.chatName||'未知角色';}else if(extractedInfo.chatInfo){const privateMatch=extractedInfo.chatInfo.match(/(.+?)和(.+?)的?(?:聊天|私聊)/);if(privateMatch){const user1=privateMatch[1].trim();const user2=privateMatch[2].trim();if(window.UserName&&user1===window.UserName){chatName=user2;}else if(window.UserName&&user2===window.UserName){chatName=user1;}else{chatName=user2;}}else{const simpleMatch=extractedInfo.chatInfo.match(/(.+?)和(.+?)私聊/);if(simpleMatch){const user1=simpleMatch[1].trim();const user2=simpleMatch[2].trim();if(window.UserName&&user1===window.UserName){chatName=user2;}else if(window.UserName&&user2===window.UserName){chatName=user1;}else{chatName=user2;}}}}if(chatType==='group'){result.type='group';result.groupName=chatName;result.messages=extractedInfo.messages.map(msg=>{if(typeof msg==='object'&&msg.name&&msg.msg){return{sender:msg.name,content:msg.msg,time:msg.time||new Date().toLocaleTimeString('zh-CN',{hour12:false}).substring(0,5)};}if(typeof msg==='string'){const dashMatch=msg.match(/^(.+?)—(.+?)—(.+)$/);if(dashMatch){return{sender:dashMatch[1].trim(),content:dashMatch[2].trim(),time:dashMatch[3].trim()};}const colonMatch=msg.match(/^(.+?)：(.+)$/);if(colonMatch){return{sender:colonMatch[1].trim(),content:colonMatch[2].trim(),time:new Date().toLocaleTimeString('zh-CN',{hour12:false}).substring(0,5)};}}return null;}).filter(msg=>msg!==null);}else{result.type='private';result.chatWith=chatName;result.messages=extractedInfo.messages.map(msg=>{if(typeof msg==='object'&&msg.name&&msg.msg){return{sender:msg.name,content:msg.msg,time:msg.time||new Date().toLocaleTimeString('zh-CN',{hour12:false}).substring(0,5)};}if(typeof msg==='string'){const dashMatch=msg.match(/^(.+?)—(.+?)—(.+)$/);if(dashMatch){return{sender:dashMatch[1].trim(),content:dashMatch[2].trim(),time:dashMatch[3].trim()};}const colonMatch=msg.match(/^(.+?)：(.+)$/);if(colonMatch){return{sender:colonMatch[1].trim(),content:colonMatch[2].trim(),time:new Date().toLocaleTimeString('zh-CN',{hour12:false}).substring(0,5)};}}return null;}).filter(msg=>msg!==null);}}return result;}catch(error){console.error('❌ 转换过程出错:',error);return null;}};window.QQ_Test_MSG_Tag_Issue=function(){const testContent=`MiPhone_JSON_START<阿伟和可畏的私聊>可畏—你，你这个笨蛋！准备你抱了！—11:21
可畏—Gab—气呼呼！—11:21
可畏—我才没有期待！只是觉得你的说法很，很不知道呢！—11:22
可畏—当然了，不过虽然我们现在外面也这么私密说话，我觉得你的想想亲！—11:22
可畏—tyy—不过......如果你真的那么想的话，也不是......不可以考虑一下。!—11:23</阿伟和可畏的私聊><阿伟和圣路易斯的私聊>圣路易斯—呜呜，想抱紧我，让我动弹不得？—11:21
圣路易斯—有意思的挑战。不过，你确定你有这个能力吗，我的指挥官？—11:21
圣路易斯—别告诉你先动弹不得的，是你自己。—11:22
圣路易斯—图片<img src="https:圣路易斯—不过如果你的表现的，今晚，关我的房间，让我去身"检验"一下你的决心和力量吧。呵呵......—11:23</阿伟和圣路易斯的私聊><群聊：港区>可畏—喂，圣路易斯说。—11:21
可畏—别以为指挥官发了什么照片？—11:21
可畏—别以为没有看到，那么嚣张的呢礼服，简直不知廉耻！—11:22
圣路易斯—呜呜，可畏妹妹，是在重复提问自己最美的一面。这可不是"不知廉耻"，而是成熟女性的魅力。—11:23
圣路易斯—呯呯，指挥官似乎得各喜欢呢。不像某些人，只会用呻吟的音乐来吸引注意力。—11:23
可畏—你！你明说！抽落是这个！是灵魂的呐喊！才不是呻吟！—11:24
可畏—而且，我才没有嫉妒！我只是觉得，你不应该用这种方式来"勾引"指挥官！—11:25
圣路易斯—呜呜，是不是勾引，得由指挥官来判断呢。—11:25
圣路易斯—不过既然你这么有你的反应，有关我的方法权有效呢，亲爱的小可畏关心了，可畏姑娘。—11:26
可畏—呸！—11:26</群聊：港区>moment_start
可畏发了一条动态，表示感慨，请浏览 35—已点赞 10
moment_end
MiPhone_JSON_END`;const formatPatterns=[/MiPhone_start([\s\S]+?)MiPhone_end/g,/MiPhone_JSON_START([\s\S]+?)MiPhone_JSON_END/g,/MiPhone_JSON_start([\s\S]+?)MiPhone_JSON_end/g,/MiPhone_Start([\s\S]+?)MiPhone_End/g,/MiPhone_START([\s\S]+?)MiPhone_END/g,/MiPhone_JSON_START([\s\S]+?)$/g,/MiPhone_start([\s\S]+?)$/g,/MiPhone_Start([\s\S]+?)$/g,/MiPhone_START([\s\S]+?)$/g,];let matches=[];let matchedPattern=null;for(const pattern of formatPatterns){const currentMatches=[...testContent.matchAll(pattern)];if(currentMatches.length>0){matches=currentMatches;matchedPattern=pattern;console.log(`✅ 找到格式匹配(${pattern.source.substring(0,30)}...):${currentMatches.length}个`);break;}}if(matches.length===0){return;}const extractedContent=matches[0][1];console.log('📝 提取的内容预览:',extractedContent.substring(0,200)+'...');const hasMsgStart=extractedContent.indexOf("msg_start")>=0;const hasMsgEnd=extractedContent.indexOf("msg_end")>=0;if(!hasMsgStart||!hasMsgEnd){let fixedContent=extractedContent;if(!hasMsgStart){const start=fixedContent.match(/<(群聊:.+?|[^>]+和[^>]+的(?:聊天|私聊))>/);if(start){fixedContent=fixedContent.replace(start[0],`msg_start\n${start[0]}`);}else{}}if(!hasMsgEnd){const endMatches=[...fixedContent.matchAll(/<\/(群聊:.+?|[^>]+和[^>]+的(?:聊天|私聊))>/g)];if(endMatches.length>0){const lastEnd=endMatches[endMatches.length-1][0];fixedContent=fixedContent.replace(lastEnd,`${lastEnd}\nmsg_end`);}else{}}console.log(fixedContent.substring(0,300)+'...');const msgMatch=fixedContent.match(/msg_start([\s\S]+?)msg_end/);if(msgMatch){console.log('MSG内容预览:',msgMatch[1].substring(0,200)+'...');try{const parsed=JsonYamlParse(msgMatch[1]);if(parsed){console.log('解析结果类型:',Array.isArray(parsed)? 'Array':typeof parsed);if(Array.isArray(parsed)){}}else{}}catch(error){}}else{}}const extractedInfo=QQ_ExtractValidInfo(extractedContent);if(extractedInfo.hasValidInfo){const convertedResult=QQ_ConvertExtractedToStandard(extractedInfo);if(convertedResult){console.log('转换结果预览:',JSON.stringify(convertedResult,null,2).substring(0,500)+'...');}else{}}else{}const momentMatches=extractedContent.match(/moment_start([\s\S]*?)moment_end/g);if(momentMatches){momentMatches.forEach((match,index)=>{console.log(`动态${index+1}:${match.substring(0,100)}...`);});}return{description:'MSG标签缺失问题诊断完成',formatMatched:matches.length>0,msgTagsPresent:hasMsgStart&&hasMsgEnd,extractedContentLength:extractedContent.length,intelligentExtractionResult:extractedInfo.hasValidInfo,momentCount:momentMatches ? momentMatches.length:0};};window.QQ_ShowDataManagerHelp=function(){console.log('• QQ_DataManager.showStats()-显示所有数据统计');console.log('• QQ_DataManager.saveAll()-手动保存所有数据');console.log('• QQ_DataManager.optimizeData()-清理和优化数据');console.log('• QQ_DataManager.testWorldBook()-测试世界书功能');console.log('• QQ_CleanNestedTags(text)-清理消息中的HTML注释、嵌套标签和思考内容');console.log('• QQ_ProcessSurpriseMechanism(text)-处理互动机制验证');console.log('• QQ_ValidateInteractiveContent(text)-验证互动内容质量');};window.QQ_Check_Errors=function(){const results={momentsDataCheck:false,functionsCheck:false,nextVariableCheck:false,arrayOperationsCheck:false,groupsDataCheck:false};try{if(typeof QQ_MomentsData!=='undefined'&&Array.isArray(QQ_MomentsData)){results.momentsDataCheck=true;}else{console.warn('⚠️ QQ_MomentsData 未定义或不是数组:',typeof QQ_MomentsData);}if(typeof loadGroupChatsFromWorldbook==='function'){try{const groupsResult=window.QQ_Group_Chats_Data||[];if(Array.isArray(groupsResult)){}else{console.warn('⚠️ 群聊数据缓存无效:',typeof groupsResult);}}catch(e){console.warn('⚠️ 群聊数据同步检查失败:',e);}results.groupsDataCheck=true;}else{console.warn('⚠️ loadGroupChatsFromWorldbook 函数未定义');}const functionList=['QQ_Save_Moments','QQ_CleanOldMoments','QQ_OptimizeCommentsStorage','QQ_SendMsg','updateGroupLastMessageDisplay'];let allFunctionsExist=true;functionList.forEach(funcName=>{if(typeof window[funcName]==='function'){}else{console.warn(`⚠️ ${funcName}函数未定义`);allFunctionsExist=false;}});results.functionsCheck=allFunctionsExist;try{if(typeof next!=='undefined'){}else{results.nextVariableCheck=true;}}catch(e){results.nextVariableCheck=true;}if(QQ_MomentsData&&Array.isArray(QQ_MomentsData)){try{let testCount=0;QQ_MomentsData.forEach(moment=>{testCount++;});results.arrayOperationsCheck=true;}catch(e){console.error('❌ QQ_MomentsData.forEach 操作失败:',e);}}else{}try{if(typeof QQ_CleanOldMoments==='function'){QQ_CleanOldMoments();}if(typeof QQ_OptimizeCommentsStorage==='function'){QQ_OptimizeCommentsStorage();}}catch(e){console.error('❌ 清理函数测试失败:',e);}window.addEventListener('error',function(e){if(e.message.includes('next is not defined')){console.error('🚨 捕获到next未定义错误:',e);console.error('错误位置:',e.filename,'行号:',e.lineno);console.error('错误堆栈:',e.error ? e.error.stack:'无堆栈信息');}});}catch(error){console.error('❌ 错误检查过程中出现异常:',error);}const passedTests=Object.values(results).filter(Boolean).length;const totalTests=Object.keys(results).length;triggerSlash(`/echo 🔍 错误检查完成:${passedTests}/${totalTests}项检查通过`);return results;};window.QQ_Debug_SendMsg=function(){try{if(typeof QQ_SendMsg==='function'){const funcStr=QQ_SendMsg.toString();if(funcStr.includes('next(')||funcStr.includes('next;')){console.warn('⚠️ QQ_SendMsg 函数中可能包含next变量引用');const lines=funcStr.split('\n');lines.forEach((line,index)=>{if(line.includes('next')&&!line.includes('.next(')){console.warn(`⚠️ 第${index+1}行可能有问题:${line.trim()}`);}});}else{}}else{console.error('❌ QQ_SendMsg 函数未定义');return;}}catch(error){console.error('❌ QQ_SendMsg 调试过程中出现异常:',error);}};window.QQ_Fix_Next_Error=function(){try{if(typeof QQ_Gen==='function'){const funcStr=QQ_Gen.toString();if(funcStr.includes('callback')){}else{console.warn('⚠️ QQ_Gen函数可能不支持回调参数');}}if(typeof QQ_Gen==='function'){QQ_Gen('测试提示词',function(response){}).catch(error=>{console.warn('⚠️ QQ_Gen回调测试失败:',error);});}}catch(error){console.error('❌ 修复QQ_Gen回调函数问题过程中出现异常:',error);}};$(document).ready(function(){console.log(' • QQ_DataManager.showStats()-查看数据统计');console.log(' • QQ_ShowDataManagerHelp()-查看使用说明');console.log(' • QQ_Check_Errors()-检查系统状态');});window.QQ_CleanDuplicatePrivateChats=function(){try{const worldInfo=getWorldInfoSettings();let hasChanges=false;if(worldInfo&&worldInfo.entries){const duplicateGroups=[];const seenChats=new Set();worldInfo.entries.forEach((entry,index)=>{if(entry.key&&entry.key.includes('QQ_GroupChats_')){try{const data=JSON.parse(entry.content);Object.keys(data).forEach(chatKey=>{const normalizedKey=chatKey.replace('私聊','聊天');if(chatKey!==normalizedKey&&seenChats.has(normalizedKey)){duplicateGroups.push({entryIndex:index,originalKey:chatKey,normalizedKey:normalizedKey,entry:entry});}else{seenChats.add(normalizedKey);}});}catch(e){console.warn('⚠️ 解析群聊数据失败:',entry.key,e);}}});if(duplicateGroups.length>0){duplicateGroups.forEach(duplicate=>{duplicate.entry.comment=`[待清理]重复的私聊群组:${duplicate.originalKey}`;hasChanges=true;});if(hasChanges){saveWorldInfo(worldInfo);toastr.success(`已标记 ${duplicateGroups.length}个重复群组待清理`,'数据清理');}}else{toastr.info('未发现重复的私聊群组','数据清理');}}}catch(error){console.error('❌ 清理重复群组时出错:',error);toastr.error('清理过程中出现错误','数据清理');}};window.QQ_Debug_Group_Storage=function(){try{const charId=getCurrentCharacterId()||'default';const expectedComment=`QQ_分组备份_${charId}`;if(!worldbook||!entries){return;}const groupEntries=entries.filter(entry=>entry.comment&&entry.comment.includes('QQ_分组备份'));groupEntries.forEach(entry=>{try{const data=JSON.parse(entry.content);const groups=data.content||[];if(groups.length>0){console.log(`-分组详情:${groups.map(g=>g.name).join(',')}`);}}catch(e){}});const targetEntry=entries.find(entry=>entry.comment===expectedComment);if(targetEntry){try{const data=JSON.parse(targetEntry.content);const groups=data.content||[];if(groups.length>0){console.log(`目标条目分组详情:${groups.map(g=>g.name).join(',')}`);}}catch(e){}}else{}}catch(error){console.error('调试分组存储失败:',error);}};window.QQ_Test_Character_Chat_And_AI_Groups=function(){const testChatData={id:'char_chat_test_Alice_Bob',title:'Alice和Bob的私聊',char1:'Alice',char2:'Bob',messages:['Alice--你好Bob！--14:30','Bob--嗨Alice，最近怎么样？--14:31','Alice--还不错，你呢？--14:32'],lastTime:'14:32',lastMessage:'还不错，你呢？'};try{QQ_CreateCharacterChatInterface(testChatData);if(!window.QQ_CharacterChats){window.QQ_CharacterChats={};}window.QQ_CharacterChats['Alice和Bob的聊天']=testChatData;}catch(error){console.error('❌ 角色间私聊界面创建失败:',error);}QQ_SaveCharacterChatToWorldbook(testChatData).then(result=>{if(result){}else{}}).catch(error=>{console.error('❌ 角色间私聊保存到世界书出错:',error);});const testGroupData={id:`group_test_${Date.now()}`,name:'测试AI创建群聊',members:['Alice','Bob','Charlie'],avatar:{type:'preset',gradient:{start:'#199AFF',end:'#0066CC'},text:'群'},lastMessage:'群聊已创建',lastTime:new Date().toLocaleTimeString('zh-CN',{hour12:false}).slice(0,5),timestamp:new Date().toLocaleTimeString('zh-CN',{hour12:false}).slice(0,5)};if(typeof saveGroupToWorldbook==='function'){if(worldbook&&entries){saveGroupToWorldbook(testGroupData).then(result=>{if(result){}else{}}).catch(error=>{console.error('❌ AI群聊保存测试出错:',error);});}else{}}else{console.error('❌ saveGroupToWorldbook 函数不存在');}const functions=['QQ_HandleCharacterChat','QQ_CreateCharacterChatInterface','QQ_ShowCharacterChatDialog','QQ_SaveCharacterChatToWorldbook'];functions.forEach(funcName=>{if(typeof window[funcName]==='function'){}else{}});const mockAIOutput=`{"私聊":{"可畏和圣路易斯的聊天":["可畏--你这个笨蛋！--14:30","圣路易斯--呵呵，可畏真可爱呢--14:31"]},"群聊":{}}`;try{const testData=JSON.parse(mockAIOutput);for(let str in testData.私聊){const match=str.match(/(.+?)和(.+?)的聊天/);if(match){const char1=match[1];const char2=match[2];if(char1!=='${UserName}'&&char2!=='${UserName}'){}}}}catch(error){console.error('❌ 模拟AI输出解析失败:',error);}return{success:true,testCount:6,features:['角色间私聊界面创建','角色间私聊数据保存','AI群聊自动保存','数据结构管理','功能可用性验证','AI输出处理测试']};};window.QQ_Create_Test_Character_Chat=function(char1='Alice',char2='Bob'){const testMessages=[`${char1}--你好${char2}！--${new Date().toLocaleTimeString('zh-CN',{hour12:false}).slice(0,5)}`,`${char2}--嗨${char1}，最近怎么样？--${new Date().toLocaleTimeString('zh-CN',{hour12:false}).slice(0,5)}`,`${char1}--还不错，你呢？--${new Date().toLocaleTimeString('zh-CN',{hour12:false}).slice(0,5)}`];return QQ_HandleCharacterChat(`${char1}和${char2}的聊天`,testMessages,char1,char2);};window.QQ_Test_Optimized_Interactive_Loading=function(){try{const preloadedCount=window.QQ_PreloadedCharacters ? window.QQ_PreloadedCharacters.size:0;if(window.QQ_PreloadedCharacters&&preloadedCount>0){console.log(`-已预加载角色列表:`,Array.from(window.QQ_PreloadedCharacters));}const publicSpaceCount=QQ_InteractiveSpaces ? Object.keys(QQ_InteractiveSpaces).length:0;const characterSpaceCount=QQ_CharacterSpaces ? Object.keys(QQ_CharacterSpaces).length:0;Object.keys(QQ_CharacterSpaces||{}).forEach(charName=>{const spaceCount=Object.keys(QQ_CharacterSpaces[charName]).length;});const functions=['QQ_PreloadCharacterDataFromWorldbook','QQ_LoadSpecificCharacterSpaces','QQ_LoadCharacterInteractiveContent','QQ_ShowPublicInteractiveSpaces','QQ_ShowPublicSpacesLoadingUI','QQ_ShowPublicSpacesContent','QQ_ShowPublicSpacesError','QQ_ForceReloadInteractiveSpaces'];functions.forEach(funcName=>{const exists=typeof window[funcName]==='function';});console.log('a)点击任意角色的精灵按钮（🧚‍♀️图标）→ 观察控制台预加载日志');console.log('b)点击使用者头像 → 点击"互动记录"按钮 → 观察加载动画和日志');console.log('c)点击精灵面板中的"互动空间"→ 观察是否使用预加载数据');console.log('d)观察控制台中的🚀🔄⚡等加载标识符');const hasAnyCache=preloadedCount>0||publicSpaceCount>0||characterSpaceCount>0;const cacheStatus=hasAnyCache ? '良好':'需要初始化';if(!hasAnyCache){}toastr.success('互动空间加载时机测试完成，请查看控制台详细信息','测试完成');}catch(error){console.error('❌ 测试优化后的加载时机时出错:',error);toastr.error('测试过程中出现错误，请查看控制台','测试失败');}}window.QQ_CleanDuplicatePrivateChats=function(){try{const worldInfo=getWorldInfoSettings();let hasChanges=false;if(worldInfo&&worldInfo.entries){const duplicateGroups=[];const seenChats=new Set();worldInfo.entries.forEach((entry,index)=>{if(entry.key&&entry.key.includes('QQ_GroupChats_')){try{const data=JSON.parse(entry.content);Object.keys(data).forEach(chatKey=>{const normalizedKey=chatKey.replace('私聊','聊天');if(chatKey!==normalizedKey&&seenChats.has(normalizedKey)){duplicateGroups.push({entryIndex:index,originalKey:chatKey,normalizedKey:normalizedKey,entry:entry});}else{seenChats.add(normalizedKey);}});}catch(e){console.warn('⚠️ 解析群聊数据失败:',entry.key,e);}}});if(duplicateGroups.length>0){duplicateGroups.forEach(duplicate=>{duplicate.entry.comment=`[待清理]重复的私聊群组:${duplicate.originalKey}`;hasChanges=true;});if(hasChanges){saveWorldInfo(worldInfo);toastr.success(`已标记 ${duplicateGroups.length}个重复群组待清理`,'数据清理');}}else{toastr.info('未发现重复的私聊群组','数据清理');}}}catch(error){console.error('❌ 清理重复群组时出错:',error);toastr.error('清理过程中出现错误','数据清理');}};</script>
</body>
</html>