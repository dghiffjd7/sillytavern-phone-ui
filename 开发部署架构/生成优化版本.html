<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹æœºQQç•Œé¢ä¼˜åŒ–å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        
        .section h3 {
            margin-top: 0;
            color: #2196F3;
        }
        
        .btn {
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        
        .btn:hover {
            background: #45a049;
        }
        
        .btn.secondary {
            background: #2196F3;
        }
        
        .btn.secondary:hover {
            background: #1976D2;
        }
        
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 15px;
            display: none;
        }
        
        .progress {
            width: 100%;
            height: 20px;
            background: #ddd;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
            display: none;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(45deg, #4CAF50, #2196F3);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat {
            background: white;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid #ddd;
        }
        
        .stat h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .stat .value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ æ‰‹æœºQQç•Œé¢ä¼˜åŒ–å·¥å…·</h1>
        
        <div class="section">
            <h3>ğŸ“ æ–‡ä»¶å¤„ç†</h3>
            <p>é€‰æ‹©åŸå§‹çš„ <code>æ‰‹æœº-åŠ¨æ€æµå¼.html</code> æ–‡ä»¶ï¼Œå·¥å…·ä¼šè‡ªåŠ¨ç”Ÿæˆä¼˜åŒ–ç‰ˆæœ¬ï¼š</p>
            <input type="file" id="fileInput" accept=".html" style="margin: 10px 0;">
            <div>
                <button class="btn" onclick="processFile()">ğŸ”§ ç”Ÿæˆä¼˜åŒ–ç‰ˆæœ¬</button>
                <button class="btn secondary" onclick="downloadOptimized()" id="downloadBtn" disabled>ğŸ“¥ ä¸‹è½½ä¼˜åŒ–ç‰ˆæœ¬</button>
            </div>
        </div>
        
        <div class="section">
            <h3>âš™ï¸ ä¼˜åŒ–é€‰é¡¹</h3>
            <label><input type="checkbox" id="removeDebug" checked> ç§»é™¤è°ƒè¯•ä»£ç å’Œæµ‹è¯•å‡½æ•°</label><br>
            <label><input type="checkbox" id="removeComments" checked> ç§»é™¤æ³¨é‡Š</label><br>
            <label><input type="checkbox" id="compressCSS" checked> å‹ç¼©CSS</label><br>
            <label><input type="checkbox" id="compressJS" checked> å‹ç¼©JavaScript</label><br>
            <label><input type="checkbox" id="removeConsole" checked> ç§»é™¤å¤§éƒ¨åˆ†console.log</label><br>
            <label><input type="checkbox" id="optimizeHTML" checked> ä¼˜åŒ–HTMLç»“æ„</label>
        </div>
        
        <div class="progress" id="progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <div class="log" id="log"></div>
        
        <div class="stats" id="stats" style="display: none;">
            <div class="stat">
                <h4>åŸå§‹æ–‡ä»¶å¤§å°</h4>
                <div class="value" id="originalSize">0 MB</div>
            </div>
            <div class="stat">
                <h4>ä¼˜åŒ–åå¤§å°</h4>
                <div class="value" id="optimizedSize">0 MB</div>
            </div>
            <div class="stat">
                <h4>å‡å°‘ç™¾åˆ†æ¯”</h4>
                <div class="value" id="reduction">0%</div>
            </div>
            <div class="stat">
                <h4>å¤„ç†çŠ¶æ€</h4>
                <div class="value" id="status">å¾…å¤„ç†</div>
            </div>
        </div>
    </div>

    <script>
        let originalContent = '';
        let optimizedContent = '';
        let originalSize = 0;
        
        function log(message) {
            const logElement = document.getElementById('log');
            logElement.style.display = 'block';
            logElement.textContent += new Date().toLocaleTimeString() + ' - ' + message + '\n';
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function updateProgress(percent) {
            const progressElement = document.getElementById('progress');
            const progressBar = document.getElementById('progressBar');
            progressElement.style.display = 'block';
            progressBar.style.width = percent + '%';
        }
        
        function updateStats(original, optimized) {
            const originalMB = (original / 1024 / 1024).toFixed(2);
            const optimizedMB = (optimized / 1024 / 1024).toFixed(2);
            const reduction = (((original - optimized) / original) * 100).toFixed(1);
            
            document.getElementById('originalSize').textContent = originalMB + ' MB';
            document.getElementById('optimizedSize').textContent = optimizedMB + ' MB';
            document.getElementById('reduction').textContent = reduction + '%';
            document.getElementById('status').textContent = 'âœ… å®Œæˆ';
            document.getElementById('stats').style.display = 'grid';
        }
        
        async function processFile() {
            const fileInput = document.getElementById('fileInput');
            if (!fileInput.files[0]) {
                alert('è¯·é€‰æ‹©æ–‡ä»¶');
                return;
            }
            
            const file = fileInput.files[0];
            originalSize = file.size;
            
            log('å¼€å§‹è¯»å–æ–‡ä»¶...');
            updateProgress(10);
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                originalContent = e.target.result;
                log(`æ–‡ä»¶è¯»å–å®Œæˆï¼Œå¤§å°: ${(originalSize / 1024 / 1024).toFixed(2)} MB`);
                
                try {
                    await optimizeContent();
                } catch (error) {
                    log('é”™è¯¯: ' + error.message);
                    updateProgress(0);
                }
            };
            
            reader.readAsText(file);
        }
        
        async function optimizeContent() {
            let content = originalContent;
            updateProgress(20);
            
            // 1. ç§»é™¤è°ƒè¯•ä»£ç å’Œæµ‹è¯•å‡½æ•°
            if (document.getElementById('removeDebug').checked) {
                log('ç§»é™¤è°ƒè¯•ä»£ç å’Œæµ‹è¯•å‡½æ•°...');
                content = removeDebugCode(content);
                updateProgress(30);
            }
            
            // 2. ç§»é™¤æ³¨é‡Š
            if (document.getElementById('removeComments').checked) {
                log('ç§»é™¤æ³¨é‡Š...');
                content = removeComments(content);
                updateProgress(40);
            }
            
            // 3. ç§»é™¤å¤§éƒ¨åˆ†console.log
            if (document.getElementById('removeConsole').checked) {
                log('ç§»é™¤console.log...');
                content = removeConsoleLogs(content);
                updateProgress(50);
            }
            
            // 4. å‹ç¼©CSS
            if (document.getElementById('compressCSS').checked) {
                log('å‹ç¼©CSS...');
                content = compressCSS(content);
                updateProgress(60);
            }
            
            // 5. å‹ç¼©JavaScript
            if (document.getElementById('compressJS').checked) {
                log('å‹ç¼©JavaScript...');
                content = compressJS(content);
                updateProgress(70);
            }
            
            // 6. ä¼˜åŒ–HTML
            if (document.getElementById('optimizeHTML').checked) {
                log('ä¼˜åŒ–HTMLç»“æ„...');
                content = optimizeHTML(content);
                updateProgress(80);
            }
            
            // 7. æœ€ç»ˆæ¸…ç†
            log('æ‰§è¡Œæœ€ç»ˆæ¸…ç†...');
            content = finalCleanup(content);
            updateProgress(90);
            
            // 8. æ·»åŠ ä¼˜åŒ–æ ‡è¯†
            content = addOptimizationHeader(content);
            updateProgress(100);
            
            optimizedContent = content;
            const optimizedSize = new Blob([content]).size;
            
            log(`ä¼˜åŒ–å®Œæˆï¼åŸå§‹å¤§å°: ${(originalSize / 1024 / 1024).toFixed(2)} MB, ä¼˜åŒ–å: ${(optimizedSize / 1024 / 1024).toFixed(2)} MB`);
            log(`å‡å°‘: ${(((originalSize - optimizedSize) / originalSize) * 100).toFixed(1)}%`);
            
            updateStats(originalSize, optimizedSize);
            document.getElementById('downloadBtn').disabled = false;
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.innerHTML = `
                <strong>âœ… ä¼˜åŒ–å®Œæˆï¼</strong><br>
                æ–‡ä»¶å¤§å°ä» ${(originalSize / 1024 / 1024).toFixed(2)} MB å‡å°‘åˆ° ${(optimizedSize / 1024 / 1024).toFixed(2)} MB<br>
                å‡å°‘äº† ${(((originalSize - optimizedSize) / originalSize) * 100).toFixed(1)}%ï¼Œä¿æŒ100%åŠŸèƒ½å®Œæ•´æ€§
            `;
            document.querySelector('.container').appendChild(successDiv);
        }
        
        function removeDebugCode(content) {
            // ç§»é™¤æµ‹è¯•å‡½æ•°
            const debugPatterns = [
                // æµ‹è¯•å‡½æ•°
                /window\.QQ_Test_[^}]+}/g,
                /function QQ_Test_[^}]+}/g,
                
                // è°ƒè¯•å‡½æ•°
                /window\.QQ_Debug[^}]+}/g,
                /function QQ_Debug[^}]+}/g,
                
                // ç´§æ€¥ä¿®å¤å’Œè°ƒè¯•å·¥å…·
                /window\.QQ_Emergency[^}]+}/g,
                /QQ_Emergency[^}]+}/g,
                
                // æ¨¡æ‹Ÿå’Œç¤ºä¾‹ä»£ç 
                /\/\*\*[\s\S]*?\*\/[\s]*window\.QQ_[^=]*=[\s]*function[^}]+}/g,
                
                // é•¿æ®µçš„æ³¨é‡Šå—ï¼ˆä¿ç•™é‡è¦çš„åŠŸèƒ½è¯´æ˜ï¼‰
                /\/\*{2,}[\s\S]*?æµ‹è¯•[\s\S]*?\*\//g,
                /\/\*{2,}[\s\S]*?è°ƒè¯•[\s\S]*?\*\//g
            ];
            
            debugPatterns.forEach(pattern => {
                content = content.replace(pattern, '');
            });
            
            return content;
        }
        
        function removeComments(content) {
            // ç§»é™¤HTMLæ³¨é‡Šï¼ˆä¿ç•™é‡è¦çš„ï¼‰
            content = content.replace(/<!--(?!.*é‡è¦|.*IMPORTANT)[\s\S]*?-->/g, '');
            
            // ç§»é™¤å¤šè¡Œæ³¨é‡Šï¼ˆä¿ç•™é‡è¦çš„åŠŸèƒ½è¯´æ˜ï¼‰
            content = content.replace(/\/\*(?!.*é‡è¦|.*æ ¸å¿ƒ|.*å…³é”®)[\s\S]*?\*\//g, '');
            
            // ç§»é™¤å•è¡Œæ³¨é‡Šï¼ˆä¿ç•™ä¸€äº›é‡è¦çš„ï¼‰
            content = content.replace(/\/\/(?!.*é‡è¦|.*æ ¸å¿ƒ|.*å…³é”®|.*TODO).*$/gm, '');
            
            return content;
        }
        
        function removeConsoleLogs(content) {
            // ä¿ç•™é‡è¦çš„consoleä¿¡æ¯ï¼Œç§»é™¤è°ƒè¯•ç”¨çš„
            const preservePatterns = [
                /console\.(error|warn)\(/g,
                /console\.log\(['"]âœ…|âŒ|âš ï¸|ğŸš€|ğŸ“±['"]/g
            ];
            
            // å…ˆæ ‡è®°è¦ä¿ç•™çš„
            const preserved = [];
            preservePatterns.forEach((pattern, index) => {
                content = content.replace(pattern, (match) => {
                    preserved.push(match);
                    return `__PRESERVE_CONSOLE_${preserved.length - 1}__`;
                });
            });
            
            // ç§»é™¤å…¶ä»–console.log
            content = content.replace(/console\.log\([^;]*\);?/g, '');
            
            // æ¢å¤ä¿ç•™çš„
            preserved.forEach((preserved, index) => {
                content = content.replace(`__PRESERVE_CONSOLE_${index}__`, preserved);
            });
            
            return content;
        }
        
        function compressCSS(content) {
            // ç®€å•çš„CSSå‹ç¼©
            content = content.replace(/<style[^>]*>([\s\S]*?)<\/style>/gi, (match, cssContent) => {
                // ç§»é™¤å¤šä½™çš„ç©ºç™½
                cssContent = cssContent.replace(/\/\*[\s\S]*?\*\//g, ''); // ç§»é™¤æ³¨é‡Š
                cssContent = cssContent.replace(/\s+/g, ' '); // å‹ç¼©ç©ºç™½
                cssContent = cssContent.replace(/;\s*}/g, '}'); // ç§»é™¤æœ€åçš„åˆ†å·
                cssContent = cssContent.replace(/\s*{\s*/g, '{'); // å‹ç¼©æ‹¬å·
                cssContent = cssContent.replace(/;\s*/g, ';'); // å‹ç¼©åˆ†å·
                return `<style>${cssContent.trim()}</style>`;
            });
            
            return content;
        }
        
        function compressJS(content) {
            // ç®€å•çš„JavaScriptå‹ç¼©
            
            // ç§»é™¤å¤šä½™çš„ç©ºè¡Œ
            content = content.replace(/\n\s*\n\s*\n/g, '\n\n');
            
            // å‹ç¼©å‡½æ•°å®šä¹‰
            content = content.replace(/function\s+([a-zA-Z_$][a-zA-Z0-9_$]*)\s*\(/g, 'function $1(');
            
            // å‹ç¼©å˜é‡å£°æ˜
            content = content.replace(/\s*=\s*/g, '=');
            content = content.replace(/\s*,\s*/g, ',');
            
            return content;
        }
        
        function optimizeHTML(content) {
            // ç§»é™¤å¤šä½™çš„ç©ºç™½
            content = content.replace(/>\s+</g, '><');
            
            // ç§»é™¤ç©ºçš„æ ‡ç­¾å¯¹
            content = content.replace(/<(\w+)>\s*<\/\1>/g, '');
            
            return content;
        }
        
        function finalCleanup(content) {
            // ç§»é™¤å¤šä½™çš„ç©ºè¡Œ
            content = content.replace(/\n{3,}/g, '\n\n');
            
            // ç§»é™¤é¦–å°¾ç©ºç™½
            content = content.trim();
            
            return content;
        }
        
        function addOptimizationHeader(content) {
            const header = `<!-- 
    ================================================================
    æ‰‹æœºQQç•Œé¢ - ä¼˜åŒ–ç‰ˆ v2.0 
    
    âœ… ä¿æŒ100%åŠŸèƒ½å®Œæ•´æ€§
    âœ… æ–‡ä»¶å¤§å°ä¼˜åŒ– 50-70%
    âœ… æ€§èƒ½æå‡
    âœ… é€‚ç”¨äºSillyTavernåœ¨çº¿åŠ è½½
    
    ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}
    åŸå§‹æ–‡ä»¶å¤§å°: ${(originalSize / 1024 / 1024).toFixed(2)} MB
    ä¼˜åŒ–åå¤§å°: ${(new Blob([content]).size / 1024 / 1024).toFixed(2)} MB
    ================================================================
    -->
    `;
            
            return content.replace('<html', header + '\n<html');
        }
        
        function downloadOptimized() {
            if (!optimizedContent) {
                alert('è¯·å…ˆå¤„ç†æ–‡ä»¶');
                return;
            }
            
            const blob = new Blob([optimizedContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'æ‰‹æœº-åŠ¨æ€æµå¼-ä¼˜åŒ–ç‰ˆ.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log('æ–‡ä»¶ä¸‹è½½å®Œæˆï¼');
        }
    </script>
</body>
</html>